{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NzkyOTU1", "number": 4203, "title": "fix-NXP-29246-import-MHTLM-in-chrome", "bodyText": "PR created from https://qa.nuxeo.org/jenkins/job/TestAndPush/job/ondemand-testandpush-nalkotob/164/", "createdAt": "2020-07-06T13:56:16Z", "url": "https://github.com/nuxeo/nuxeo/pull/4203", "merged": true, "mergeCommit": {"oid": "4f6acb1c03cd0e2cd812518a6cdcdb7c3ed017a1"}, "closed": true, "closedAt": "2020-08-03T21:42:52Z", "author": {"login": "nuxeojenkins"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyg81HAFqTQ0MzY0MTQ0NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7VJShAFqTQ2MDE5MzE2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNjQxNDQ0", "url": "https://github.com/nuxeo/nuxeo/pull/4203#pullrequestreview-443641444", "createdAt": "2020-07-07T07:45:41Z", "commit": {"oid": "3124739a3bf6bb319aefa39f6ef9066724587958"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNzo0NTo0MlrOGty2GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNzo0NTo0MlrOGty2GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3MjE1Mg==", "bodyText": "is this required for the fix?", "url": "https://github.com/nuxeo/nuxeo/pull/4203#discussion_r450672152", "createdAt": "2020-07-07T07:45:42Z", "author": {"login": "bdelbosc"}, "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -232,7 +232,7 @@ protected Response uploadNoTransaction(@Context HttpServletRequest request,\n         // TODO NXP-18247: should be set to the actual number of bytes uploaded instead of relying on the Content-Length\n         // header which is not necessarily set\n         long uploadedSize = getUploadedSize(request);\n-        boolean isMultipart = contentType != null && contentType.contains(\"multipart\");\n+        boolean isMultipart = contentType != null && contentType.contains(\"multipart/form-data\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3124739a3bf6bb319aefa39f6ef9066724587958"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3124739a3bf6bb319aefa39f6ef9066724587958", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3124739a3bf6bb319aefa39f6ef9066724587958", "committedDate": "2020-07-06T08:41:40Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "1eea115fccb318dadaabb54a514bb84d36eb771e", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1eea115fccb318dadaabb54a514bb84d36eb771e", "committedDate": "2020-07-07T17:47:20Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTI1MjA4", "url": "https://github.com/nuxeo/nuxeo/pull/4203#pullrequestreview-444125208", "createdAt": "2020-07-07T17:57:34Z", "commit": {"oid": "1eea115fccb318dadaabb54a514bb84d36eb771e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo1NzozNFrOGuJnAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzo1NzozNFrOGuJnAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0NTEyMw==", "bodyText": "these are still used. So I keep them.", "url": "https://github.com/nuxeo/nuxeo/pull/4203#discussion_r451045123", "createdAt": "2020-07-07T17:57:34Z", "author": {"login": "NourNuxeo"}, "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -234,24 +234,7 @@ protected Response uploadNoTransaction(@Context HttpServletRequest request,\n         long uploadedSize = getUploadedSize(request);\n         boolean isMultipart = contentType != null && contentType.contains(\"multipart\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1eea115fccb318dadaabb54a514bb84d36eb771e"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTI4NjQ2", "url": "https://github.com/nuxeo/nuxeo/pull/4203#pullrequestreview-444128646", "createdAt": "2020-07-07T18:02:11Z", "commit": {"oid": "1eea115fccb318dadaabb54a514bb84d36eb771e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxODowMjoxMVrOGuJx0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxODowMjoxMVrOGuJx0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTA0Nzg4OQ==", "bodyText": "comment removed in next push", "url": "https://github.com/nuxeo/nuxeo/pull/4203#discussion_r451047889", "createdAt": "2020-07-07T18:02:11Z", "author": {"login": "NourNuxeo"}, "path": "modules/platform/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -1053,6 +1053,21 @@ public void testErrorOnRefreshedTokenError() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void testUploadMHTML() throws Exception {\n+        String batchId = initializeNewBatch();\n+        // typed via mime-type", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1eea115fccb318dadaabb54a514bb84d36eb771e"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1eea115fccb318dadaabb54a514bb84d36eb771e", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1eea115fccb318dadaabb54a514bb84d36eb771e", "committedDate": "2020-07-07T17:47:20Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "1c0dbe02b67469d87468d5f3d97229882476b8ec", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1c0dbe02b67469d87468d5f3d97229882476b8ec", "committedDate": "2020-07-07T18:36:54Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c0dbe02b67469d87468d5f3d97229882476b8ec", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/1c0dbe02b67469d87468d5f3d97229882476b8ec", "committedDate": "2020-07-07T18:36:54Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "5964bb93e423c991e800c0678dfc8f11ce91d070", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5964bb93e423c991e800c0678dfc8f11ce91d070", "committedDate": "2020-07-08T10:28:38Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5964bb93e423c991e800c0678dfc8f11ce91d070", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/5964bb93e423c991e800c0678dfc8f11ce91d070", "committedDate": "2020-07-08T10:28:38Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "3c0e080adde6a270f28c8b6bed233fc2d91961b5", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3c0e080adde6a270f28c8b6bed233fc2d91961b5", "committedDate": "2020-07-09T07:40:59Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c0e080adde6a270f28c8b6bed233fc2d91961b5", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/3c0e080adde6a270f28c8b6bed233fc2d91961b5", "committedDate": "2020-07-09T07:40:59Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "de5f3503e9eb7ba05b405aaea2da1b3b804c6323", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/de5f3503e9eb7ba05b405aaea2da1b3b804c6323", "committedDate": "2020-07-09T08:41:35Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDEyNTYx", "url": "https://github.com/nuxeo/nuxeo/pull/4203#pullrequestreview-445412561", "createdAt": "2020-07-09T08:47:17Z", "commit": {"oid": "de5f3503e9eb7ba05b405aaea2da1b3b804c6323"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODo0NzoxOFrOGvHr8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwODo0NzoxOFrOGvHr8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA2MjE5NA==", "bodyText": "restored in next push. Test works in local", "url": "https://github.com/nuxeo/nuxeo/pull/4203#discussion_r452062194", "createdAt": "2020-07-09T08:47:18Z", "author": {"login": "NourNuxeo"}, "path": "modules/platform/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -224,11 +211,6 @@ private void itCanUseBatchUpload(boolean noDrop) throws IOException {\n         assertEquals(\"Fichier accentu\u00e9 1.txt\", blob.getFilename());\n         assertEquals(\"text/plain\", blob.getMimeType());\n         assertEquals(data1, blob.getString());\n-        blob = (Blob) doc.getPropertyValue(\"mb:blobs/1/content\");\n-        assertNotNull(blob);\n-        assertEquals(\"Fichier accentu\u00e9 2.txt\", blob.getFilename());\n-        assertEquals(mimeType, blob.getMimeType());\n-        assertEquals(data2, blob.getString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de5f3503e9eb7ba05b405aaea2da1b3b804c6323"}, "originalPosition": 92}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de5f3503e9eb7ba05b405aaea2da1b3b804c6323", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/de5f3503e9eb7ba05b405aaea2da1b3b804c6323", "committedDate": "2020-07-09T08:41:35Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "7c70054a517a20394d577361f1bdf31a3efa62c4", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/7c70054a517a20394d577361f1bdf31a3efa62c4", "committedDate": "2020-07-09T08:48:17Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NDMzNjQ5", "url": "https://github.com/nuxeo/nuxeo/pull/4203#pullrequestreview-445433649", "createdAt": "2020-07-09T09:14:36Z", "commit": {"oid": "7c70054a517a20394d577361f1bdf31a3efa62c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOToxNDozNlrOGvIrsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwOToxNDozNlrOGvIrsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjA3ODUxNQ==", "bodyText": "to be removed in next push", "url": "https://github.com/nuxeo/nuxeo/pull/4203#discussion_r452078515", "createdAt": "2020-07-09T09:14:36Z", "author": {"login": "NourNuxeo"}, "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -232,26 +230,8 @@ protected Response uploadNoTransaction(@Context HttpServletRequest request,\n         // TODO NXP-18247: should be set to the actual number of bytes uploaded instead of relying on the Content-Length\n         // header which is not necessarily set\n         long uploadedSize = getUploadedSize(request);\n-        boolean isMultipart = contentType != null && contentType.contains(\"multipart\");\n-\n-        // Handle multipart case: mainly MSIE with jQueryFileupload\n-        if (isMultipart) {\n-            FormData formData = new FormData(request);\n-            Blob blob = formData.getFirstBlob();\n-            if (blob == null) {\n-                throw new NuxeoException(\"Cannot upload in multipart with no blobs\");\n-            }\n-            if (!UPLOAD_TYPE_CHUNKED.equals(uploadType)) {\n-                fileName = blob.getFilename();\n-            }\n-            // Don't change the mime-type if it was forced via the X-File-Type header\n-            if (StringUtils.isBlank(mimeType)) {\n-                mimeType = blob.getMimeType();\n-            }\n-            uploadedSize = blob.getLength();\n-            addBlob(uploadType, batchId, fileIdx, blob, fileName, mimeType, uploadedSize, chunkCount, uploadChunkIndex,\n-                    fileSize);\n-        } else if (Framework.isBooleanPropertyTrue(NginxConstants.X_ACCEL_ENABLED)\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c70054a517a20394d577361f1bdf31a3efa62c4"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c70054a517a20394d577361f1bdf31a3efa62c4", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/7c70054a517a20394d577361f1bdf31a3efa62c4", "committedDate": "2020-07-09T08:48:17Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "b5cc9b3e1a35680fb05e600a8c2f4a52113af3f7", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b5cc9b3e1a35680fb05e600a8c2f4a52113af3f7", "committedDate": "2020-07-15T11:09:37Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MDg5MDUz", "url": "https://github.com/nuxeo/nuxeo/pull/4203#pullrequestreview-449089053", "createdAt": "2020-07-15T15:49:21Z", "commit": {"oid": "b5cc9b3e1a35680fb05e600a8c2f4a52113af3f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNTo0OToyMVrOGyEbHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNTo0OToyMVrOGyEbHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE1NDQ2Mw==", "bodyText": "Javadoc always above the annotations.\nNote sure the JIRA title is needed as the test method explicitly state that it tests a MHTLM upload.", "url": "https://github.com/nuxeo/nuxeo/pull/4203#discussion_r455154463", "createdAt": "2020-07-15T15:49:21Z", "author": {"login": "troger"}, "path": "modules/platform/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -1053,6 +1023,21 @@ public void testErrorOnRefreshedTokenError() throws Exception {\n         }\n     }\n \n+    @Test\n+    /** NXP-29246: Fix import of MHTML file using Chrome */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5cc9b3e1a35680fb05e600a8c2f4a52113af3f7"}, "originalPosition": 209}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5cc9b3e1a35680fb05e600a8c2f4a52113af3f7", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/b5cc9b3e1a35680fb05e600a8c2f4a52113af3f7", "committedDate": "2020-07-15T11:09:37Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "9e5229f8076fd4d068a86ce0658dd57a0e460057", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9e5229f8076fd4d068a86ce0658dd57a0e460057", "committedDate": "2020-07-15T17:06:58Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9e5229f8076fd4d068a86ce0658dd57a0e460057", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/9e5229f8076fd4d068a86ce0658dd57a0e460057", "committedDate": "2020-07-15T17:06:58Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "cfca8399bb2c4f85a0f320a8dc8e15aed984fbf8", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/cfca8399bb2c4f85a0f320a8dc8e15aed984fbf8", "committedDate": "2020-07-15T17:12:41Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNjIwNTcz", "url": "https://github.com/nuxeo/nuxeo/pull/4203#pullrequestreview-451620573", "createdAt": "2020-07-20T13:46:30Z", "commit": {"oid": "cfca8399bb2c4f85a0f320a8dc8e15aed984fbf8"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMzY2MDE2", "url": "https://github.com/nuxeo/nuxeo/pull/4203#pullrequestreview-453366016", "createdAt": "2020-07-22T14:20:54Z", "commit": {"oid": "cfca8399bb2c4f85a0f320a8dc8e15aed984fbf8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNDoyMDo1NFrOG1ktgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNDoyMDo1NFrOG1ktgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgyOTE4NA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return buildResponse(status, result, false);\n          \n          \n            \n                    return buildResponse(status, result);\n          \n      \n    \n    \n  \n\nWe may probably. want to deprecate buildResponse(StatusType, Object, boolean) and buildHTMLResponse(StatusType, String) as they won't be used anymore.", "url": "https://github.com/nuxeo/nuxeo/pull/4203#discussion_r458829184", "createdAt": "2020-07-22T14:20:54Z", "author": {"login": "kevinleturc"}, "path": "modules/platform/rest-api/nuxeo-rest-api-server/src/main/java/org/nuxeo/ecm/restapi/server/jaxrs/BatchUploadObject.java", "diffHunk": "@@ -294,7 +273,7 @@ protected Response uploadNoTransaction(@Context HttpServletRequest request,\n                 }\n             }\n         }\n-        return buildResponse(status, result, isMultipart);\n+        return buildResponse(status, result, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfca8399bb2c4f85a0f320a8dc8e15aed984fbf8"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MzQ0NjA2", "url": "https://github.com/nuxeo/nuxeo/pull/4203#pullrequestreview-457344606", "createdAt": "2020-07-29T09:21:05Z", "commit": {"oid": "cfca8399bb2c4f85a0f320a8dc8e15aed984fbf8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwOToyMTowNVrOG4wDGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwOTozMToxM1rOG4wbMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2MDY2Nw==", "bodyText": "I think we can keep this comment.\nIt's interesting to know that the uploaded size could be checked if implemented.", "url": "https://github.com/nuxeo/nuxeo/pull/4203#discussion_r462160667", "createdAt": "2020-07-29T09:21:05Z", "author": {"login": "ataillefer"}, "path": "modules/platform/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -132,34 +128,25 @@ private void itCanUseBatchUpload(boolean noDrop) throws IOException {\n             assertEquals(batchId, node.get(\"batchId\").asText());\n             assertEquals(\"0\", node.get(\"fileIdx\").asText());\n             assertEquals(\"normal\", node.get(\"uploadType\").asText());\n-            // TODO NXP-18247 when the actual uploaded size is returned\n-            // assertEquals(fileSize1, node.get(\"uploadedSize\").asText());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfca8399bb2c4f85a0f320a8dc8e15aed984fbf8"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2NTc0OQ==", "bodyText": "Why not passing the file size header anymore?", "url": "https://github.com/nuxeo/nuxeo/pull/4203#discussion_r462165749", "createdAt": "2020-07-29T09:29:28Z", "author": {"login": "ataillefer"}, "path": "modules/platform/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -240,42 +227,32 @@ private void itCanUseBatchUpload(boolean noDrop) throws IOException {\n      */\n     @Test\n     public void testObeyFileTypeHeader() throws IOException {\n-        Map<String, String> headers;\n-\n         // Get batch id, used as a session id\n         String batchId = initializeDeprecatedNewBatch();\n \n-        // Upload a file in multipart, first without the X-File-Type header, the second with\n-        String fileName1 = \"No header.txt\";\n+        // Upload a file without the X-File-Type header\n         String data1 = \"File without explicit file type\";\n-        String fileSize1 = String.valueOf(getUTF8Bytes(data1).length);\n-        headers = new HashMap<>();\n-        headers.put(\"X-File-Size\", fileSize1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfca8399bb2c4f85a0f320a8dc8e15aed984fbf8"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2NjgzMg==", "bodyText": "Why not passing the file size header anymore?", "url": "https://github.com/nuxeo/nuxeo/pull/4203#discussion_r462166832", "createdAt": "2020-07-29T09:31:13Z", "author": {"login": "ataillefer"}, "path": "modules/platform/rest-api/nuxeo-rest-api-test/src/test/java/org/nuxeo/ecm/restapi/test/BatchUploadFixture.java", "diffHunk": "@@ -240,42 +227,32 @@ private void itCanUseBatchUpload(boolean noDrop) throws IOException {\n      */\n     @Test\n     public void testObeyFileTypeHeader() throws IOException {\n-        Map<String, String> headers;\n-\n         // Get batch id, used as a session id\n         String batchId = initializeDeprecatedNewBatch();\n \n-        // Upload a file in multipart, first without the X-File-Type header, the second with\n-        String fileName1 = \"No header.txt\";\n+        // Upload a file without the X-File-Type header\n         String data1 = \"File without explicit file type\";\n-        String fileSize1 = String.valueOf(getUTF8Bytes(data1).length);\n-        headers = new HashMap<>();\n-        headers.put(\"X-File-Size\", fileSize1);\n-\n-        try (FormDataMultiPart form = new FormDataMultiPart()) {\n-            BodyPart fdp = new StreamDataBodyPart(fileName1, new ByteArrayInputStream(getUTF8Bytes(data1)));\n-            form.bodyPart(fdp);\n-            try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/\" + batchId + \"/0\", form,\n-                    headers)) {\n-                assertEquals(Status.CREATED.getStatusCode(), response.getStatus());\n-            }\n+        try (CloseableClientResponse response = getResponse(RequestType.POST, \"upload/\" + batchId + \"/0\", data1,\n+                Map.of(\"X-File-Name\", \"No header.txt\"))) {\n+            assertEquals(Status.CREATED.getStatusCode(), response.getStatus());\n+            JsonNode node = mapper.readTree(response.getEntityInputStream());\n+            assertEquals(\"true\", node.get(\"uploaded\").asText());\n+            assertEquals(batchId, node.get(\"batchId\").asText());\n+            assertEquals(\"0\", node.get(\"fileIdx\").asText());\n+            assertEquals(\"normal\", node.get(\"uploadType\").asText());\n         }\n \n-        String mimeType = \"text/plain\";\n-        String fileName2 = \"With header.txt\";\n+        // Upload a file with the X-File-Type header\n         String data2 = \"File with explicit X-File-Type header\";\n-        String fileSize2 = String.valueOf(getUTF8Bytes(data2).length);\n-        headers = new HashMap<>();\n-        headers.put(\"X-File-Size\", fileSize2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfca8399bb2c4f85a0f320a8dc8e15aed984fbf8"}, "originalPosition": 124}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfca8399bb2c4f85a0f320a8dc8e15aed984fbf8", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/cfca8399bb2c4f85a0f320a8dc8e15aed984fbf8", "committedDate": "2020-07-15T17:12:41Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "6add47fcd44f3eb4dd51d2b8e4402006a09d7cec", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6add47fcd44f3eb4dd51d2b8e4402006a09d7cec", "committedDate": "2020-08-03T10:25:47Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6add47fcd44f3eb4dd51d2b8e4402006a09d7cec", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6add47fcd44f3eb4dd51d2b8e4402006a09d7cec", "committedDate": "2020-08-03T10:25:47Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "33b802ca2a6ba937c3f2d064ae7bedf87ef6e89e", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/33b802ca2a6ba937c3f2d064ae7bedf87ef6e89e", "committedDate": "2020-08-03T12:56:56Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "33b802ca2a6ba937c3f2d064ae7bedf87ef6e89e", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/33b802ca2a6ba937c3f2d064ae7bedf87ef6e89e", "committedDate": "2020-08-03T12:56:56Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "f272b9a89563d46eff43d52f049113fd399a01df", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f272b9a89563d46eff43d52f049113fd399a01df", "committedDate": "2020-08-03T12:59:19Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f272b9a89563d46eff43d52f049113fd399a01df", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/f272b9a89563d46eff43d52f049113fd399a01df", "committedDate": "2020-08-03T12:59:19Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "aba3765c12768d113fd3b48ca33effbe668559a2", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/aba3765c12768d113fd3b48ca33effbe668559a2", "committedDate": "2020-08-03T13:14:52Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ba4acfbb078b906c27e2bcf93abd3c2a7616658", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6ba4acfbb078b906c27e2bcf93abd3c2a7616658", "committedDate": "2020-08-03T13:20:48Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aba3765c12768d113fd3b48ca33effbe668559a2", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/aba3765c12768d113fd3b48ca33effbe668559a2", "committedDate": "2020-08-03T13:14:52Z", "message": "NXP-29246: add MHTML mime-type support"}, "afterCommit": {"oid": "6ba4acfbb078b906c27e2bcf93abd3c2a7616658", "author": {"user": {"login": "NourNuxeo", "name": "Nour AL KOTOB"}}, "url": "https://github.com/nuxeo/nuxeo/commit/6ba4acfbb078b906c27e2bcf93abd3c2a7616658", "committedDate": "2020-08-03T13:20:48Z", "message": "NXP-29246: add MHTML mime-type support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMDI4MjU2", "url": "https://github.com/nuxeo/nuxeo/pull/4203#pullrequestreview-460028256", "createdAt": "2020-08-03T13:32:15Z", "commit": {"oid": "6ba4acfbb078b906c27e2bcf93abd3c2a7616658"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMTkzMTY3", "url": "https://github.com/nuxeo/nuxeo/pull/4203#pullrequestreview-460193167", "createdAt": "2020-08-03T17:05:46Z", "commit": {"oid": "6ba4acfbb078b906c27e2bcf93abd3c2a7616658"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4727, "cost": 1, "resetAt": "2021-11-03T18:41:40Z"}}}