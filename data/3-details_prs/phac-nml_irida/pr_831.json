{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2MTA3NjI2", "number": 831, "title": "Admin statistics/ advanced stats", "bodyText": "Description of changes\nWhat did you change in this pull request?  Provide a description of files changed, user interactions changed, etc.  Include how to test your changes.\nAdded advanced statistics which display charts for analyses ran, projects created, samples created, users created.\nRelated issue\nLink to the GitHub issue this pull request addresses using the #issuenum format.  If it completes an issue, use Fixes #issuenum to automatically close the issue.\nChecklist\nThings for the developer to confirm they've done before the PR should be accepted:\n* [ ] CHANGELOG.md (and UPGRADING.md if necessary) updated with information for new change.\n* [ ] Tests added (or description of how to test) for any new features.\n* [ ] User documentation updated for UI or technical changes.", "createdAt": "2020-10-19T16:21:48Z", "url": "https://github.com/phac-nml/irida/pull/831", "merged": true, "mergeCommit": {"oid": "2aeaf0c5b0037283ca56009e8ecd9263ea18c5a4"}, "closed": true, "closedAt": "2020-10-21T20:59:21Z", "author": {"login": "deepsidhu85"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPp_GqAH2gAyNTA2MTA3NjI2OmU4Nzc2YjAwMjZiNDc5MTE3MmRhNzA1OWZhZjk5MzM0NzdkNWM5NzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUz1YRgFqTUxNDE4MDg5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e8776b0026b4791172da7059faf9933477d5c971", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/e8776b0026b4791172da7059faf9933477d5c971", "committedDate": "2020-10-05T20:41:08Z", "message": "Renamed dto files. Added uiadminstatsservice. Advanced statistics are now only retrieved on button click"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0018e240547e013724701bffd125da02d7c2ccf", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/d0018e240547e013724701bffd125da02d7c2ccf", "committedDate": "2020-10-06T15:47:16Z", "message": "Imported @requestparam"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "580537c7a59ef83a2e018414e825103348ab9784", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/580537c7a59ef83a2e018414e825103348ab9784", "committedDate": "2020-10-07T19:54:41Z", "message": "Added advanced stats (hourly, daily, monthly, yearly) for analyses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b32eab676ec5a48c990c0a520c44f2f1881673c", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/7b32eab676ec5a48c990c0a520c44f2f1881673c", "committedDate": "2020-10-07T20:13:18Z", "message": "Added advanced stats (hourly, daily, monthly, yearly) for projects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75566ee27a708e93082953d3a97fc8d6d138ab7b", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/75566ee27a708e93082953d3a97fc8d6d138ab7b", "committedDate": "2020-10-07T23:53:17Z", "message": "Added advanced stats (hourly, daily, monthly, yearly) for samples"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74124b30c7ad9f3349b9dd2534f465107c518d23", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/74124b30c7ad9f3349b9dd2534f465107c518d23", "committedDate": "2020-10-08T14:07:50Z", "message": "Added advanced stats (hourly, daily, monthly, yearly) for users"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea27fe6b025c0237d18725be0e479de0dfa73069", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/ea27fe6b025c0237d18725be0e479de0dfa73069", "committedDate": "2020-10-08T16:47:34Z", "message": "Merged basic statistics branch and fixed merge conflicts. Updated to display statistics for users created in time period"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "736390b765e140bd25af51b31e6aaeb162fd3778", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/736390b765e140bd25af51b31e6aaeb162fd3778", "committedDate": "2020-10-08T18:00:42Z", "message": "Merged basic stats branch and fixed merge conflicts. Updated comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d13fa5ec4f220a5747902c7afa7f8db34135de40", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/d13fa5ec4f220a5747902c7afa7f8db34135de40", "committedDate": "2020-10-08T19:19:25Z", "message": "Merged basic stats branch and fixed merge conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "749637095452661b5af006fcb7297deb16ac8692", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/749637095452661b5af006fcb7297deb16ac8692", "committedDate": "2020-10-08T20:01:09Z", "message": "Merge branch 'admin-statistics/_basic-stats' into admin-statistics/_advanced-stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e8a39efb1d69667359e60ed71758c3ad5653ba1", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/4e8a39efb1d69667359e60ed71758c3ad5653ba1", "committedDate": "2020-10-08T20:33:25Z", "message": "Added styled card and buttons for statistics. Set chart height as a const in adminstatisticscontext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e93ca5197c8884b2978cbacb000563b3f2e4a688", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/e93ca5197c8884b2978cbacb000563b3f2e4a688", "committedDate": "2020-10-09T16:00:21Z", "message": "Merged basic stats branch and fixed merge conflicts."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d0a87a0da1817b32b5c31be5556940d4d382b82", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/2d0a87a0da1817b32b5c31be5556940d4d382b82", "committedDate": "2020-10-15T21:07:28Z", "message": "Merged basic stats branch and fixed merge conflicts."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb123eb566eff46a673cd74bc15659c98825b1f6", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/bb123eb566eff46a673cd74bc15659c98825b1f6", "committedDate": "2020-10-15T21:08:53Z", "message": "Removed variable not used"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4dc6687f34c56b6852f19be1bfb76de0703c075", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/d4dc6687f34c56b6852f19be1bfb76de0703c075", "committedDate": "2020-10-15T21:21:27Z", "message": "Updated logic to get stats for stat type for the default time period (week) when advanced stats are viewed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd11e72c0c069339c7334f1efd123405daa336e4", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/bd11e72c0c069339c7334f1efd123405daa336e4", "committedDate": "2020-10-15T21:35:55Z", "message": "Updated basicstats logic to get default time period stats for the tinycolumn charts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff45e119c22931898aed7998a100a12f3640369f", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/ff45e119c22931898aed7998a100a12f3640369f", "committedDate": "2020-10-16T19:17:53Z", "message": "Merged basic stats branch and fixed merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab44eec9acb1d0a0006147e3951ce501330e63c2", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/ab44eec9acb1d0a0006147e3951ce501330e63c2", "committedDate": "2020-10-19T16:12:14Z", "message": "Merged basic stats branch and fixed merge conflicts. Added enum which stores statistic time periods. Updated method comments. Added analyses, projects, users, and samples count stats to basicstats model that are used by tiny charts on the basic stats page."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e54a1982e00da005c46a3555c439a0cd0bd6d6a8", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/e54a1982e00da005c46a3555c439a0cd0bd6d6a8", "committedDate": "2020-10-19T16:20:11Z", "message": "Merge branch 'admin-statistics/_base' into admin-statistics/_advanced-stats"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExOTY4MjA2", "url": "https://github.com/phac-nml/irida/pull/831#pullrequestreview-511968206", "createdAt": "2020-10-19T16:56:40Z", "commit": {"oid": "e54a1982e00da005c46a3555c439a0cd0bd6d6a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjo1Njo0MFrOHkYMfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjo1Njo0MFrOHkYMfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkwNzE5OQ==", "bodyText": "Comments", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r507907199", "createdAt": "2020-10-19T16:56:40Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/enums/StatisticTimePeriod.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package ca.corefacility.bioinformatics.irida.model.enums;\n+\n+public enum StatisticTimePeriod {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e54a1982e00da005c46a3555c439a0cd0bd6d6a8"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06bf685f3158a23f35de733bead1341113532cd5", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/06bf685f3158a23f35de733bead1341113532cd5", "committedDate": "2020-10-19T18:08:00Z", "message": "Added missing javadoc. Removed duplicate @param"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNjAxMjUx", "url": "https://github.com/phac-nml/irida/pull/831#pullrequestreview-512601251", "createdAt": "2020-10-20T11:23:21Z", "commit": {"oid": "06bf685f3158a23f35de733bead1341113532cd5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMToyMzoyMVrOHk3g6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMToyOToxMVrOHk3trA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMDMzMA==", "bodyText": "Why do you need fully qualified class names?", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508420330", "createdAt": "2020-10-20T11:23:21Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/repositories/analysis/submission/AnalysisSubmissionRepository.java", "diffHunk": "@@ -136,28 +125,72 @@\n \t/**\n \t * Get all {@link ProjectSampleAnalysisOutputInfo} shared with a {@link Project}.\n \t *\n-\t * @param projectId {@link Project} id\n+\t * @param projectId   {@link Project} id\n \t * @param workflowIds Workflow UUIDs of workflow pipelines to get output files for\n \t * @return a list of {@link ProjectSampleAnalysisOutputInfo}\n \t */\n-\tList<ProjectSampleAnalysisOutputInfo> getAllAnalysisOutputInfoSharedWithProject(Long projectId, Set<UUID> workflowIds);\n+\tList<ProjectSampleAnalysisOutputInfo> getAllAnalysisOutputInfoSharedWithProject(Long projectId,\n+\t\t\tSet<UUID> workflowIds);\n \n \t/**\n \t * Get all automated {@link ProjectSampleAnalysisOutputInfo} for a {@link Project}.\n \t *\n-\t * @param projectId {@link Project} id\n+\t * @param projectId   {@link Project} id\n \t * @param workflowIds Workflow UUIDs of workflow pipelines to get output files for\n \t * @return a list of {@link ProjectSampleAnalysisOutputInfo}\n \t */\n \tList<ProjectSampleAnalysisOutputInfo> getAllAutomatedAnalysisOutputInfoForAProject(Long projectId,\n \t\t\tSet<UUID> workflowIds);\n \n \t/**\n-\t * Get a count of all {@link AnalysisSubmission}s ran within time period\n+\t * Get the count of {@link AnalysisSubmission}s run in time period\n \t *\n-\t * @param createdDate the minimum created date for submissions\n-\t * @return a count of {@link User}s\n+\t * @param createdDate The minimum created date for the analysis submission\n+\t * @return A count of {@link AnalysisSubmission}s run in time period.\n \t */\n \t@Query(\"select count(s.id) from AnalysisSubmission s where s.createdDate >= ?1\")\n \tpublic Long countAnalysesRanInTimePeriod(Date createdDate);\n+\n+\t/**\n+\t * Get a list of {@link GenericStatModel}s for analyses run in the last day and grouped by hour\n+\t *\n+\t * @param createdDate The minimum created date for the analysis submission\n+\t * @return A list of {@link GenericStatModel}s\n+\t */\n+\t@Query(\"select new ca.corefacility.bioinformatics.irida.ria.web.admin.dto.statistics.GenericStatModel(function('date_format', s.createdDate, '%H:00'), count(s.id))\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06bf685f3158a23f35de733bead1341113532cd5"}, "originalPosition": 173}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMDc0Mg==", "bodyText": "Much cleaner, thank you.", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508420742", "createdAt": "2020-10-20T11:24:08Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/admin/AdminStatisticsAjaxController.java", "diffHunk": "@@ -22,18 +15,11 @@\n @RequestMapping(\"/ajax/statistics\")\n public class AdminStatisticsAjaxController {\n \n-\tprivate ProjectService projectService;\n-\tprivate UserService userService;\n-\tprivate SampleService sampleService;\n-\tprivate AnalysisSubmissionService analysisSubmissionService;\n+\tprivate UIAdminStatisticsService uiAdminStatisticsService;\n \n \t@Autowired\n-\tpublic AdminStatisticsAjaxController(ProjectService projectService, UserService userService,\n-\t\t\tSampleService sampleService, AnalysisSubmissionService analysisSubmissionService) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06bf685f3158a23f35de733bead1341113532cd5"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMjE2OA==", "bodyText": "These classes seem very similar, is there a way to make one class that can handle all?", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508422168", "createdAt": "2020-10-20T11:26:43Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/admin/dto/statistics/SampleStatsResponse.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.admin.dto.statistics;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06bf685f3158a23f35de733bead1341113532cd5"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQyMzU5Ng==", "bodyText": "Try extending your return objects with AjaxResponse that way you can generically return and AjaxErrorResponse if you need to.", "url": "https://github.com/phac-nml/irida/pull/831#discussion_r508423596", "createdAt": "2020-10-20T11:29:11Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/admin/AdminStatisticsAjaxController.java", "diffHunk": "@@ -44,18 +30,8 @@ public AdminStatisticsAjaxController(ProjectService projectService, UserService\n \t * @return dto with basic usage stats\n \t */\n \t@GetMapping(\"/basic\")\n-\tpublic ResponseEntity<BasicStats> getAdminStatistics(Integer timePeriod) {\n-\t\tDate currDate = new Date();\n-\t\tDate minimumCreatedDate = new DateTime(currDate).minusDays(timePeriod)\n-\t\t\t\t.toDate();\n-\n-\t\tLong analysesRan = analysisSubmissionService.getAnalysesRan(minimumCreatedDate);\n-\t\tLong projectsCreated = projectService.getProjectsCreated(minimumCreatedDate);\n-\t\tLong samplesCreated = sampleService.getSamplesCreated(minimumCreatedDate);\n-\t\tLong usersCreated = userService.getUsersCreatedInTimePeriod(minimumCreatedDate);\n-\t\tLong usersLoggedIn = userService.getUsersLoggedIn(minimumCreatedDate);\n-\n-\t\treturn ResponseEntity.ok(new BasicStats(analysesRan, projectsCreated, samplesCreated, usersCreated, usersLoggedIn));\n+\tpublic ResponseEntity<BasicStats> getAdminStatistics(@RequestParam int timePeriod) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06bf685f3158a23f35de733bead1341113532cd5"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d7b38cc8ff91e129bd1a42729850e14f23871ab", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/0d7b38cc8ff91e129bd1a42729850e14f23871ab", "committedDate": "2020-10-20T14:51:14Z", "message": "Renamed dto and created a statisticsresponse dto which is used to return statistics of any type."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b280de1513c6c2f3f17a5dba79aeef0fd675d96", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/5b280de1513c6c2f3f17a5dba79aeef0fd675d96", "committedDate": "2020-10-20T20:33:17Z", "message": "Added users, projects, analyses, and samples to required-data sql so that the statistics charts for the admin panel have data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "876276163e478cb0846ed143e9724682f9387f16", "author": {"user": {"login": "joshsadam", "name": "Josh Adam"}}, "url": "https://github.com/phac-nml/irida/commit/876276163e478cb0846ed143e9724682f9387f16", "committedDate": "2020-10-21T17:22:19Z", "message": "Removed context to simplify code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1da27a9ae9df205b7664791af394c615750795cd", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/1da27a9ae9df205b7664791af394c615750795cd", "committedDate": "2020-10-21T18:11:42Z", "message": "Added function comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTgwODkx", "url": "https://github.com/phac-nml/irida/pull/831#pullrequestreview-514180891", "createdAt": "2020-10-21T20:59:11Z", "commit": {"oid": "1da27a9ae9df205b7664791af394c615750795cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 146, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}