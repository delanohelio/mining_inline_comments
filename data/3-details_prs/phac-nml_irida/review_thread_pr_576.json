{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1OTU4MzIw", "number": 576, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNjo1Mjo1N1rODZ50xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxOToyNTo1OFrOFH6Bog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDg4MzkwOnYy", "diffSide": "LEFT", "path": "CHANGELOG.md", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNjo1Mjo1N1rOFgjeDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMTowODo1NlrOFgrDzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY3OTg4NA==", "bodyText": "You deleted this but did not move it up.  Be easier to merge later if you move it I think.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r369679884", "createdAt": "2020-01-22T16:52:57Z", "author": {"login": "joshsadam"}, "path": "CHANGELOG.md", "diffHunk": "@@ -122,7 +123,6 @@ Changes\n * [UI]: Fixed bug causing issues with saving Line List templates.\n * [UI]: Fixed bug when selecting all samples on the project samples page would not add them to cart.\n * [Developer]: Updated to latest version of NodeJS LTS (12.13.0) and Yarn (v1.19.1).\n-* [UI]: Add analyses queued and running counts to analyses listing pages, cart page, and pipeline launch page.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "918df31c06629f17764c2eb8a771d307331ccc57"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTgwNDIzNw==", "bodyText": "This should be fixed in the latest development merge. e28ce62", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r369804237", "createdAt": "2020-01-22T21:08:56Z", "author": {"login": "tom114"}, "path": "CHANGELOG.md", "diffHunk": "@@ -122,7 +123,6 @@ Changes\n * [UI]: Fixed bug causing issues with saving Line List templates.\n * [UI]: Fixed bug when selecting all samples on the project samples page would not add them to cart.\n * [Developer]: Updated to latest version of NodeJS LTS (12.13.0) and Yarn (v1.19.1).\n-* [UI]: Add analyses queued and running counts to analyses listing pages, cart page, and pipeline launch page.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY3OTg4NA=="}, "originalCommit": {"oid": "918df31c06629f17764c2eb8a771d307331ccc57"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NDkwMzk2OnYy", "diffSide": "RIGHT", "path": "doc/administrator/upgrades/index.md", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNjo1ODoyMFrOFgjqmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNTowMzo0NFrOFhgfKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4MzA5Ng==", "bodyText": "Too many helps in this sentence.  Try:\nThe intent of this update is to simplify the relationship between samples and metadata records to help with database performance and future developments.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r369683096", "createdAt": "2020-01-22T16:58:20Z", "author": {"login": "joshsadam"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -40,14 +41,93 @@ Note that if this process is not completed correctly for a Remote API, data will\n \n See the section under \"authorization code\" in our documentation for more details about entering the redirect URI at <https://irida.corefacility.ca/documentation/user/administrator/#grant-types>.\n \n-## Updating Galaxy importer clients\n+### Updating Galaxy importer clients\n+{:.no_toc}\n \n Clients for the [Galaxy IRIDA importer](https://github.com/phac-nml/irida-galaxy-importer) must undergo a similar process, but with slightly different values.  The Galaxy importer targets your local IRIDA installation so the redirect URL points at your own IRIDA.  Redirect URLs for Galaxy will be the following:\n \n Your IRIDA server URL + `/galaxy/auth_code`.  Ex: `http://irida.ca/irida/galaxy/auth_code`.\n \n To test this change, try importing some data from Galaxy.  If it works, you've updated everything correctly!\n \n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to help simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "918df31c06629f17764c2eb8a771d307331ccc57"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY3OTU5NQ==", "bodyText": "Done in 87f6f5e", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r370679595", "createdAt": "2020-01-24T15:03:44Z", "author": {"login": "tom114"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -40,14 +41,93 @@ Note that if this process is not completed correctly for a Remote API, data will\n \n See the section under \"authorization code\" in our documentation for more details about entering the redirect URI at <https://irida.corefacility.ca/documentation/user/administrator/#grant-types>.\n \n-## Updating Galaxy importer clients\n+### Updating Galaxy importer clients\n+{:.no_toc}\n \n Clients for the [Galaxy IRIDA importer](https://github.com/phac-nml/irida-galaxy-importer) must undergo a similar process, but with slightly different values.  The Galaxy importer targets your local IRIDA installation so the redirect URL points at your own IRIDA.  Redirect URLs for Galaxy will be the following:\n \n Your IRIDA server URL + `/galaxy/auth_code`.  Ex: `http://irida.ca/irida/galaxy/auth_code`.\n \n To test this change, try importing some data from Galaxy.  If it works, you've updated everything correctly!\n \n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to help simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4MzA5Ng=="}, "originalCommit": {"oid": "918df31c06629f17764c2eb8a771d307331ccc57"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4NTAxNTUyOnYy", "diffSide": "RIGHT", "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/sample/MetadataTemplateField.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNzozMjo1M1rOFgkxpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNTowNDoyN1rOFhggqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcwMTI4Ng==", "bodyText": "Check if orphanRemoval is needed.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r369701286", "createdAt": "2020-01-22T17:32:53Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/sample/MetadataTemplateField.java", "diffHunk": "@@ -34,6 +30,9 @@\n \t@NotNull\n \tprivate String type;\n \n+\t@OneToMany(mappedBy = \"field\", orphanRemoval = true, cascade = CascadeType.ALL)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "918df31c06629f17764c2eb8a771d307331ccc57"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY3OTk3Nw==", "bodyText": "Removed it in 49437e3.  Let the tests run to verify but it shouldn't be needed since we can't modify that set anyway.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r370679977", "createdAt": "2020-01-24T15:04:27Z", "author": {"login": "tom114"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/sample/MetadataTemplateField.java", "diffHunk": "@@ -34,6 +30,9 @@\n \t@NotNull\n \tprivate String type;\n \n+\t@OneToMany(mappedBy = \"field\", orphanRemoval = true, cascade = CascadeType.ALL)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcwMTI4Ng=="}, "originalCommit": {"oid": "918df31c06629f17764c2eb8a771d307331ccc57"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4OTE1OTY3OnYy", "diffSide": "LEFT", "path": "src/main/java/ca/corefacility/bioinformatics/irida/service/impl/sample/MetadataTemplateServiceImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMTowNDo0OVrOFhMkvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNTowMzo1M1rOFhgfcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM1MzM0MQ==", "bodyText": "Can we update this method to be something like convertStringToMetadataMap or something?", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r370353341", "createdAt": "2020-01-23T21:04:49Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/service/impl/sample/MetadataTemplateServiceImpl.java", "diffHunk": "@@ -145,24 +143,32 @@ public MetadataTemplateField saveMetadataField(MetadataTemplateField field) {\n \t\treturn fieldRepository.findAllMetadataFieldsByLabelQuery(query);\n \t}\n \n+\t/**\n+\t * {@inheritDoc}\n+\t */\n \t@Override\n \t@Transactional\n \t@PreAuthorize(\"permitAll()\")\n-\tpublic Map<MetadataTemplateField, MetadataEntry> getMetadataMap(Map<String, MetadataEntry> metadataMap) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e28ce62bf01dc38f961f0889ef325b4a76747d95"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY3OTY2Ng==", "bodyText": "Renamed in\n4c71547", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r370679666", "createdAt": "2020-01-24T15:03:53Z", "author": {"login": "tom114"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/service/impl/sample/MetadataTemplateServiceImpl.java", "diffHunk": "@@ -145,24 +143,32 @@ public MetadataTemplateField saveMetadataField(MetadataTemplateField field) {\n \t\treturn fieldRepository.findAllMetadataFieldsByLabelQuery(query);\n \t}\n \n+\t/**\n+\t * {@inheritDoc}\n+\t */\n \t@Override\n \t@Transactional\n \t@PreAuthorize(\"permitAll()\")\n-\tpublic Map<MetadataTemplateField, MetadataEntry> getMetadataMap(Map<String, MetadataEntry> metadataMap) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM1MzM0MQ=="}, "originalCommit": {"oid": "e28ce62bf01dc38f961f0889ef325b4a76747d95"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MzAyNjc0OnYy", "diffSide": "RIGHT", "path": "doc/administrator/upgrades/index.md", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNVQxNzo1NDozMFrOFhwx_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzowNTozOFrOFiKZOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk0NjU1OQ==", "bodyText": "Perhaps not so important, but I think it would be useful to also include the examples from the table above here too. That is, for sample include at the end (ex: \"sample1\") and so on. I like how that was done for the descriptions of the tables above.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r370946559", "createdAt": "2020-01-25T17:54:30Z", "author": {"login": "apetkau"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -40,14 +41,93 @@ Note that if this process is not completed correctly for a Remote API, data will\n \n See the section under \"authorization code\" in our documentation for more details about entering the redirect URI at <https://irida.corefacility.ca/documentation/user/administrator/#grant-types>.\n \n-## Updating Galaxy importer clients\n+### Updating Galaxy importer clients\n+{:.no_toc}\n \n Clients for the [Galaxy IRIDA importer](https://github.com/phac-nml/irida-galaxy-importer) must undergo a similar process, but with slightly different values.  The Galaxy importer targets your local IRIDA installation so the redirect URL points at your own IRIDA.  Redirect URLs for Galaxy will be the following:\n \n Your IRIDA server URL + `/galaxy/auth_code`.  Ex: `http://irida.ca/irida/galaxy/auth_code`.\n \n To test this change, try importing some data from Galaxy.  If it works, you've updated everything correctly!\n \n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |\n+\n+The tables involved are the following:\n+\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list (ex: \"Salmonella\").\n+* `sample_metadata_entry` - The relationship between the above 3 tables (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+In addition to the above, there is a matching `_AUD` (audit) table for each of these tables which captures any changes to the data and the user & time which the change occurred.  This auditing is managed by [Hibernate Envers](https://hibernate.org/orm/envers/).\n+\n+In general data will be populated into these tables in the following order:\n+\n+1. `sample` entry is created as sequencing data is uploaded,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0Mjg1Nw==", "bodyText": "Added in 7baf075", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r371342857", "createdAt": "2020-01-27T16:26:16Z", "author": {"login": "tom114"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -40,14 +41,93 @@ Note that if this process is not completed correctly for a Remote API, data will\n \n See the section under \"authorization code\" in our documentation for more details about entering the redirect URI at <https://irida.corefacility.ca/documentation/user/administrator/#grant-types>.\n \n-## Updating Galaxy importer clients\n+### Updating Galaxy importer clients\n+{:.no_toc}\n \n Clients for the [Galaxy IRIDA importer](https://github.com/phac-nml/irida-galaxy-importer) must undergo a similar process, but with slightly different values.  The Galaxy importer targets your local IRIDA installation so the redirect URL points at your own IRIDA.  Redirect URLs for Galaxy will be the following:\n \n Your IRIDA server URL + `/galaxy/auth_code`.  Ex: `http://irida.ca/irida/galaxy/auth_code`.\n \n To test this change, try importing some data from Galaxy.  If it works, you've updated everything correctly!\n \n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |\n+\n+The tables involved are the following:\n+\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list (ex: \"Salmonella\").\n+* `sample_metadata_entry` - The relationship between the above 3 tables (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+In addition to the above, there is a matching `_AUD` (audit) table for each of these tables which captures any changes to the data and the user & time which the change occurred.  This auditing is managed by [Hibernate Envers](https://hibernate.org/orm/envers/).\n+\n+In general data will be populated into these tables in the following order:\n+\n+1. `sample` entry is created as sequencing data is uploaded,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk0NjU1OQ=="}, "originalCommit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2NjIwMg==", "bodyText": "Looks good. Thanks \ud83d\udc4d", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r371366202", "createdAt": "2020-01-27T17:05:38Z", "author": {"login": "apetkau"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -40,14 +41,93 @@ Note that if this process is not completed correctly for a Remote API, data will\n \n See the section under \"authorization code\" in our documentation for more details about entering the redirect URI at <https://irida.corefacility.ca/documentation/user/administrator/#grant-types>.\n \n-## Updating Galaxy importer clients\n+### Updating Galaxy importer clients\n+{:.no_toc}\n \n Clients for the [Galaxy IRIDA importer](https://github.com/phac-nml/irida-galaxy-importer) must undergo a similar process, but with slightly different values.  The Galaxy importer targets your local IRIDA installation so the redirect URL points at your own IRIDA.  Redirect URLs for Galaxy will be the following:\n \n Your IRIDA server URL + `/galaxy/auth_code`.  Ex: `http://irida.ca/irida/galaxy/auth_code`.\n \n To test this change, try importing some data from Galaxy.  If it works, you've updated everything correctly!\n \n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |\n+\n+The tables involved are the following:\n+\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list (ex: \"Salmonella\").\n+* `sample_metadata_entry` - The relationship between the above 3 tables (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+In addition to the above, there is a matching `_AUD` (audit) table for each of these tables which captures any changes to the data and the user & time which the change occurred.  This auditing is managed by [Hibernate Envers](https://hibernate.org/orm/envers/).\n+\n+In general data will be populated into these tables in the following order:\n+\n+1. `sample` entry is created as sequencing data is uploaded,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk0NjU1OQ=="}, "originalCommit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MzcxNjA2OnYy", "diffSide": "RIGHT", "path": "src/main/java/ca/corefacility/bioinformatics/irida/pipeline/results/updater/impl/BioHanselSampleUpdater.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQyMjo1NDo0M1rOFh2NNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQyMjo1NDo0M1rOFh2NNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAzNTQ0NQ==", "bodyText": "We are likely going to have to give people instructions on how to make these changes in all the IRIDA plugins as well. See my main comment in the general comments section.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r371035445", "createdAt": "2020-01-26T22:54:43Z", "author": {"login": "apetkau"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/pipeline/results/updater/impl/BioHanselSampleUpdater.java", "diffHunk": "@@ -108,11 +105,11 @@ public void update(Collection<Sample> samples, AnalysisSubmission analysis) thro\n \t\t\t\t\t\t\t\t+ \"'. Please check the format of this file!\");\n \t\t\t\t\t}\n \t\t\t\t});\n-\t\t\t\tMap<MetadataTemplateField, MetadataEntry> metadataMap = metadataTemplateService.getMetadataMap(\n-\t\t\t\t\t\tstringEntries);\n \n-\t\t\t\tsample.mergeMetadata(metadataMap);\n-\t\t\t\tsampleService.updateFields(sample.getId(), ImmutableMap.of(\"metadata\", sample.getMetadata()));\n+\t\t\t\tSet<MetadataEntry> metadataSet = metadataTemplateService.convertMetadataStringsToSet(stringEntries);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MzcxNjk0OnYy", "diffSide": "RIGHT", "path": "doc/administrator/upgrades/index.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQyMjo1Njo0NFrOFh2Nqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjoyNjo1N1rOFiI_jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAzNTU2Mg==", "bodyText": "Just some thoughts, but is it possible this is coming up because we are both syncing metadata AND re-running automated pipelines on synced samples, which may save the same metadata back into the table once it's completed? So, for every synced sample, we get a duplicate metadata entry (one from syncing, one from the automated pipeline)?\nThen, on (perhaps) a subsequent sync, the same metadata gets downloaded and saved (as a new row in the database because it's not pipeline-derived)?\nOr is this something else?", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r371035562", "createdAt": "2020-01-26T22:56:44Z", "author": {"login": "apetkau"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -40,14 +41,93 @@ Note that if this process is not completed correctly for a Remote API, data will\n \n See the section under \"authorization code\" in our documentation for more details about entering the redirect URI at <https://irida.corefacility.ca/documentation/user/administrator/#grant-types>.\n \n-## Updating Galaxy importer clients\n+### Updating Galaxy importer clients\n+{:.no_toc}\n \n Clients for the [Galaxy IRIDA importer](https://github.com/phac-nml/irida-galaxy-importer) must undergo a similar process, but with slightly different values.  The Galaxy importer targets your local IRIDA installation so the redirect URL points at your own IRIDA.  Redirect URLs for Galaxy will be the following:\n \n Your IRIDA server URL + `/galaxy/auth_code`.  Ex: `http://irida.ca/irida/galaxy/auth_code`.\n \n To test this change, try importing some data from Galaxy.  If it works, you've updated everything correctly!\n \n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |\n+\n+The tables involved are the following:\n+\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list (ex: \"Salmonella\").\n+* `sample_metadata_entry` - The relationship between the above 3 tables (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+In addition to the above, there is a matching `_AUD` (audit) table for each of these tables which captures any changes to the data and the user & time which the change occurred.  This auditing is managed by [Hibernate Envers](https://hibernate.org/orm/envers/).\n+\n+In general data will be populated into these tables in the following order:\n+\n+1. `sample` entry is created as sequencing data is uploaded,\n+2. Someone uploads a set of sample metadata, which will first get a `metadata_field`\n+  a. Find an existing `metadata_field` for a column header,\n+  b. Or create a new `metadata_field` for a header,\n+3. `metadata_entry` is created with the appropriate value,\n+4. `sample_metadata_entry` is created linking the above 3 items together.\n+\n+Note items 2, 3, and 4 will generally be done at the same time.  As soon as the metadata values are committed to the database, Envers should create `_AUD` entries for all of the above records.\n+\n+### The problem\n+{:.no_toc}\n+\n+The issue we noticed is that while Envers seemed to create `_AUD` records for all the above tables when metadata is first added to a sample, subsequent updates of those values *may* not create records for the `sample_metadata_entry_AUD` table, though it properly creates records for the `metadata_entry_AUD` and `sample_AUD` tables.  We found this to be most prevalent when data is synchronized from remote IRIDA installations.  Most of these synchronized records were duplicate entries that were saving the same metadata values back to the sample, but creating new rows in the database.  We are still investigating why this issue was occurring.  Due to the complex nature of the above database tables it appears that Envers was failing to properly audit the relationship between those entities/tables.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM0MzI0Ng==", "bodyText": "I'm not sure this is the exact issue, but it may be one of the cases where this appears.  Added info that re-running analysis pipelines may be part of the issue in 7baf075", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r371343246", "createdAt": "2020-01-27T16:26:57Z", "author": {"login": "tom114"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -40,14 +41,93 @@ Note that if this process is not completed correctly for a Remote API, data will\n \n See the section under \"authorization code\" in our documentation for more details about entering the redirect URI at <https://irida.corefacility.ca/documentation/user/administrator/#grant-types>.\n \n-## Updating Galaxy importer clients\n+### Updating Galaxy importer clients\n+{:.no_toc}\n \n Clients for the [Galaxy IRIDA importer](https://github.com/phac-nml/irida-galaxy-importer) must undergo a similar process, but with slightly different values.  The Galaxy importer targets your local IRIDA installation so the redirect URL points at your own IRIDA.  Redirect URLs for Galaxy will be the following:\n \n Your IRIDA server URL + `/galaxy/auth_code`.  Ex: `http://irida.ca/irida/galaxy/auth_code`.\n \n To test this change, try importing some data from Galaxy.  If it works, you've updated everything correctly!\n \n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |\n+\n+The tables involved are the following:\n+\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list (ex: \"Salmonella\").\n+* `sample_metadata_entry` - The relationship between the above 3 tables (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+In addition to the above, there is a matching `_AUD` (audit) table for each of these tables which captures any changes to the data and the user & time which the change occurred.  This auditing is managed by [Hibernate Envers](https://hibernate.org/orm/envers/).\n+\n+In general data will be populated into these tables in the following order:\n+\n+1. `sample` entry is created as sequencing data is uploaded,\n+2. Someone uploads a set of sample metadata, which will first get a `metadata_field`\n+  a. Find an existing `metadata_field` for a column header,\n+  b. Or create a new `metadata_field` for a header,\n+3. `metadata_entry` is created with the appropriate value,\n+4. `sample_metadata_entry` is created linking the above 3 items together.\n+\n+Note items 2, 3, and 4 will generally be done at the same time.  As soon as the metadata values are committed to the database, Envers should create `_AUD` entries for all of the above records.\n+\n+### The problem\n+{:.no_toc}\n+\n+The issue we noticed is that while Envers seemed to create `_AUD` records for all the above tables when metadata is first added to a sample, subsequent updates of those values *may* not create records for the `sample_metadata_entry_AUD` table, though it properly creates records for the `metadata_entry_AUD` and `sample_AUD` tables.  We found this to be most prevalent when data is synchronized from remote IRIDA installations.  Most of these synchronized records were duplicate entries that were saving the same metadata values back to the sample, but creating new rows in the database.  We are still investigating why this issue was occurring.  Due to the complex nature of the above database tables it appears that Envers was failing to properly audit the relationship between those entities/tables.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAzNTU2Mg=="}, "originalCommit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5MzczMTczOnYy", "diffSide": "RIGHT", "path": "src/main/java/ca/corefacility/bioinformatics/irida/service/impl/sample/SampleServiceImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQyMzozNTozMlrOFh2VAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QyMToxODo0MVrOHIhn_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAzNzQ0Mg==", "bodyText": "I suspect the findFirst() here causes issues where we can have many duplicated entries in our database for metadata fields. See comment in general comments.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r371037442", "createdAt": "2020-01-26T23:35:32Z", "author": {"login": "apetkau"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/service/impl/sample/SampleServiceImpl.java", "diffHunk": "@@ -172,6 +180,76 @@ public Sample update(Sample object) {\n \t\treturn super.update(object);\n \t}\n \n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@PreAuthorize(\"hasPermission(#sample, 'canReadSample')\")\n+\t@Override\n+\tpublic Set<MetadataEntry> getMetadataForSample(Sample sample) {\n+\t\treturn metadataEntryRepository.getMetadataForSample(sample);\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@PreAuthorize(\"hasPermission(#s, 'canUpdateSample')\")\n+\t@Transactional\n+\tpublic Sample updateSampleMetadata(Sample s, Set<MetadataEntry> metadataToSet) {\n+\t\tSet<MetadataEntry> currentMetadata = getMetadataForSample(s);\n+\n+\t\tmetadataEntryRepository.deleteAll(currentMetadata);\n+\n+\t\tfor(MetadataEntry e : metadataToSet){\n+\t\t\te.setSample(s);\n+\t\t}\n+\n+\t\tmetadataEntryRepository.saveAll(metadataToSet);\n+\n+\t\ts = read(s.getId());\n+\n+\t\treturn s;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@PreAuthorize(\"hasPermission(#s, 'canUpdateSample')\")\n+\t@Transactional\n+\tpublic Sample mergeSampleMetadata(Sample s, Set<MetadataEntry> metadataToAdd) {\n+\t\tSet<MetadataEntry> currentMetadata = getMetadataForSample(s);\n+\n+\t\t// loop through entry set and see if it already exists\n+\t\tfor (MetadataEntry newMetadataEntry : metadataToAdd) {\n+\t\t\tMetadataTemplateField field = newMetadataEntry.getField();\n+\t\t\tnewMetadataEntry.setSample(s);\n+\n+\t\t\tOptional<MetadataEntry> metadataEntryForField = currentMetadata.stream()\n+\t\t\t\t\t.filter(e -> e.getField()\n+\t\t\t\t\t\t\t.equals(field))\n+\t\t\t\t\t.findFirst();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcwMTU2Nw==", "bodyText": "Added a fix in 000defa which deletes the old metadata entry if the types differ.  We're seeing this sort of thing in a bunch of places with JPA that even if we save a new collection without the old entity, it sometimes stays connected.  The result has generally been to actually delete the old entity before saving the new collection.  This appears to resolve the above issue number 2.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r478701567", "createdAt": "2020-08-27T21:18:41Z", "author": {"login": "tom114"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/service/impl/sample/SampleServiceImpl.java", "diffHunk": "@@ -172,6 +180,76 @@ public Sample update(Sample object) {\n \t\treturn super.update(object);\n \t}\n \n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@PreAuthorize(\"hasPermission(#sample, 'canReadSample')\")\n+\t@Override\n+\tpublic Set<MetadataEntry> getMetadataForSample(Sample sample) {\n+\t\treturn metadataEntryRepository.getMetadataForSample(sample);\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@PreAuthorize(\"hasPermission(#s, 'canUpdateSample')\")\n+\t@Transactional\n+\tpublic Sample updateSampleMetadata(Sample s, Set<MetadataEntry> metadataToSet) {\n+\t\tSet<MetadataEntry> currentMetadata = getMetadataForSample(s);\n+\n+\t\tmetadataEntryRepository.deleteAll(currentMetadata);\n+\n+\t\tfor(MetadataEntry e : metadataToSet){\n+\t\t\te.setSample(s);\n+\t\t}\n+\n+\t\tmetadataEntryRepository.saveAll(metadataToSet);\n+\n+\t\ts = read(s.getId());\n+\n+\t\treturn s;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@PreAuthorize(\"hasPermission(#s, 'canUpdateSample')\")\n+\t@Transactional\n+\tpublic Sample mergeSampleMetadata(Sample s, Set<MetadataEntry> metadataToAdd) {\n+\t\tSet<MetadataEntry> currentMetadata = getMetadataForSample(s);\n+\n+\t\t// loop through entry set and see if it already exists\n+\t\tfor (MetadataEntry newMetadataEntry : metadataToAdd) {\n+\t\t\tMetadataTemplateField field = newMetadataEntry.getField();\n+\t\t\tnewMetadataEntry.setSample(s);\n+\n+\t\t\tOptional<MetadataEntry> metadataEntryForField = currentMetadata.stream()\n+\t\t\t\t\t.filter(e -> e.getField()\n+\t\t\t\t\t\t\t.equals(field))\n+\t\t\t\t\t.findFirst();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAzNzQ0Mg=="}, "originalCommit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5ODUwMzMzOnYy", "diffSide": "RIGHT", "path": "doc/administrator/upgrades/index.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoxNTozMFrOIEEW2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNDowMzo0M1rOIH3E-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNjYwMg==", "bodyText": "You also need the DBI and DBD::mysql packages (assuming you have a MySQL/MariaDB database).", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r541136602", "createdAt": "2020-12-11T18:15:30Z", "author": {"login": "apetkau"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -11,6 +11,145 @@ description: \"Upgrade Notes\"\n \n The majority of IRIDA's upgrade notes can be seen at <https://github.com/phac-nml/irida/blob/master/UPGRADING.md>.  When there are more significant upgrades to the IRIDA system, database, deployment, etc. this page will go further in depth about how to properly back up your system, perform the upgrade, and recover from problems.\n \n+# 21.01\n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |\n+\n+The tables involved are the following:\n+\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list (ex: \"Salmonella\").\n+* `sample_metadata_entry` - The relationship between the above 3 tables (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+In addition to the above, there is a matching `_AUD` (audit) table for each of these tables which captures any changes to the data and the user & time which the change occurred.  This auditing is managed by [Hibernate Envers](https://hibernate.org/orm/envers/).\n+\n+In general data will be populated into these tables in the following order:\n+\n+1. `sample` entry is created as sequencing data is uploaded (ex: \"sample1\"),\n+2. Someone uploads a set of sample metadata, which will first get a `metadata_field` (ex: \"Organism\")\n+  a. Find an existing `metadata_field` for a column header,\n+  b. Or create a new `metadata_field` for a header,\n+3. `metadata_entry` is created with the appropriate value (ex: \"Salmonella\"),\n+4. `sample_metadata_entry` is created linking the above 3 items together (ex: for \"sample1\" the \"Organism\" is \"Salmonella\").\n+\n+Note items 2, 3, and 4 will generally be done at the same time.  As soon as the metadata values are committed to the database, Envers should create `_AUD` entries for all of the above records.\n+\n+### The problem\n+{:.no_toc}\n+\n+The issue we noticed is that while Envers seemed to create `_AUD` records for all the above tables when metadata is first added to a sample, subsequent updates of those values *may* not create records for the `sample_metadata_entry_AUD` table, though it properly creates records for the `metadata_entry_AUD` and `sample_AUD` tables.  We found this to be most prevalent when data is synchronized from remote IRIDA installations, but also occurred in some cases where pipelines were re-run and metadata being re-saved to samples.  Most of these records were duplicate entries that were saving the same metadata values back to the sample, but creating new rows in the database.  We are still investigating why this issue was occurring.  Due to the complex nature of the above database tables it appears that Envers was failing to properly audit the relationship between those entities/tables.\n+\n+Note that we have found **no evidence of missing live data**.  It appears that all metadata records were written to the live database tables as expected.  This issue only appears to effect the `sample_metadata_entry_AUD` table.\n+\n+### The fix\n+{:.no_toc}\n+\n+Solving this issue involved a refactor of the database structure to remove the `sample_metadata_entry` table.  The new database structure is as follows:\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list and its relationship to the `metadata_field` and `sample` (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+This results in a cleaner database structure with less redundancy, and allowed us to refactor IRIDA's codebase to ensure Envers can properly capture any changes to a sample's metadata.  In the long-term this should also allow us to more efficiently build extensions to IRIDA's metadata system.\n+\n+As with most other database updates, we use [Liquibase](https://www.liquibase.org/) to manage this update.  After the 21.01 upgrade is complete, our Liquibase changeset will also remove any \"dangling\" `metadata_entry` records to improve performance and the integrity of metadata in the IRIDA system.\n+\n+### What about old data?\n+{:.no_toc}\n+\n+Since Envers was writing audit records for the `sample_AUD` and `metadata_entry_AUD` tables, we can re-connect many of the disconnected `metadata_entry_AUD` records with their samples.  In places where there is a clear connection between a `metadata_entry_AUD` record and a `sample_AUD` record, we are automatically re-connecting the entries to the appropriate sample and field using Liquibase.  In other cases where the connection is not as clear, we chose not to update the disconnected records in the database to ensure integrity of the existing audit records.  \n+\n+#### Metadata linking script\n+{:.no_toc}\n+\n+In addition to re-linking old data as described above, we've included a small utility script which can be run before the upgrade to generate a report of all disconnected `sample_metadata_entry_AUD` records and their connections to their parent samples where available.  While we do not expect that this report will be needed in the future, we recommend running this utility and saving the report alongside your backups to ensure the history of these samples is maintained.  **This script must be run before you perform the 21.01 update**.\n+\n+This script will output a CSV file of the following data:\n+\n+| `metadata_entry` database id | `metadata_entry` text value | Envers revision number of the entry | User ID of the user that made the change | `sample` database id associated with the metadata | Name of the sample |\n+|---|---|---|---|---|---|\n+\n+You can download this script at <https://github.com/phac-nml/irida/tree/development/src/main/resources/scripts/metadata-mappings>.  This script requires the `Text::CSV` perl package to be installed (available in CPAN and various other package managers).  To run this script:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "365e5f1f441e13723850e0b15ebd13d9b8c40f0e"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTExMzMzNg==", "bodyText": "Added in 6b81bcf", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r545113336", "createdAt": "2020-12-17T14:03:43Z", "author": {"login": "tom114"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -11,6 +11,145 @@ description: \"Upgrade Notes\"\n \n The majority of IRIDA's upgrade notes can be seen at <https://github.com/phac-nml/irida/blob/master/UPGRADING.md>.  When there are more significant upgrades to the IRIDA system, database, deployment, etc. this page will go further in depth about how to properly back up your system, perform the upgrade, and recover from problems.\n \n+# 21.01\n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |\n+\n+The tables involved are the following:\n+\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list (ex: \"Salmonella\").\n+* `sample_metadata_entry` - The relationship between the above 3 tables (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+In addition to the above, there is a matching `_AUD` (audit) table for each of these tables which captures any changes to the data and the user & time which the change occurred.  This auditing is managed by [Hibernate Envers](https://hibernate.org/orm/envers/).\n+\n+In general data will be populated into these tables in the following order:\n+\n+1. `sample` entry is created as sequencing data is uploaded (ex: \"sample1\"),\n+2. Someone uploads a set of sample metadata, which will first get a `metadata_field` (ex: \"Organism\")\n+  a. Find an existing `metadata_field` for a column header,\n+  b. Or create a new `metadata_field` for a header,\n+3. `metadata_entry` is created with the appropriate value (ex: \"Salmonella\"),\n+4. `sample_metadata_entry` is created linking the above 3 items together (ex: for \"sample1\" the \"Organism\" is \"Salmonella\").\n+\n+Note items 2, 3, and 4 will generally be done at the same time.  As soon as the metadata values are committed to the database, Envers should create `_AUD` entries for all of the above records.\n+\n+### The problem\n+{:.no_toc}\n+\n+The issue we noticed is that while Envers seemed to create `_AUD` records for all the above tables when metadata is first added to a sample, subsequent updates of those values *may* not create records for the `sample_metadata_entry_AUD` table, though it properly creates records for the `metadata_entry_AUD` and `sample_AUD` tables.  We found this to be most prevalent when data is synchronized from remote IRIDA installations, but also occurred in some cases where pipelines were re-run and metadata being re-saved to samples.  Most of these records were duplicate entries that were saving the same metadata values back to the sample, but creating new rows in the database.  We are still investigating why this issue was occurring.  Due to the complex nature of the above database tables it appears that Envers was failing to properly audit the relationship between those entities/tables.\n+\n+Note that we have found **no evidence of missing live data**.  It appears that all metadata records were written to the live database tables as expected.  This issue only appears to effect the `sample_metadata_entry_AUD` table.\n+\n+### The fix\n+{:.no_toc}\n+\n+Solving this issue involved a refactor of the database structure to remove the `sample_metadata_entry` table.  The new database structure is as follows:\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list and its relationship to the `metadata_field` and `sample` (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+This results in a cleaner database structure with less redundancy, and allowed us to refactor IRIDA's codebase to ensure Envers can properly capture any changes to a sample's metadata.  In the long-term this should also allow us to more efficiently build extensions to IRIDA's metadata system.\n+\n+As with most other database updates, we use [Liquibase](https://www.liquibase.org/) to manage this update.  After the 21.01 upgrade is complete, our Liquibase changeset will also remove any \"dangling\" `metadata_entry` records to improve performance and the integrity of metadata in the IRIDA system.\n+\n+### What about old data?\n+{:.no_toc}\n+\n+Since Envers was writing audit records for the `sample_AUD` and `metadata_entry_AUD` tables, we can re-connect many of the disconnected `metadata_entry_AUD` records with their samples.  In places where there is a clear connection between a `metadata_entry_AUD` record and a `sample_AUD` record, we are automatically re-connecting the entries to the appropriate sample and field using Liquibase.  In other cases where the connection is not as clear, we chose not to update the disconnected records in the database to ensure integrity of the existing audit records.  \n+\n+#### Metadata linking script\n+{:.no_toc}\n+\n+In addition to re-linking old data as described above, we've included a small utility script which can be run before the upgrade to generate a report of all disconnected `sample_metadata_entry_AUD` records and their connections to their parent samples where available.  While we do not expect that this report will be needed in the future, we recommend running this utility and saving the report alongside your backups to ensure the history of these samples is maintained.  **This script must be run before you perform the 21.01 update**.\n+\n+This script will output a CSV file of the following data:\n+\n+| `metadata_entry` database id | `metadata_entry` text value | Envers revision number of the entry | User ID of the user that made the change | `sample` database id associated with the metadata | Name of the sample |\n+|---|---|---|---|---|---|\n+\n+You can download this script at <https://github.com/phac-nml/irida/tree/development/src/main/resources/scripts/metadata-mappings>.  This script requires the `Text::CSV` perl package to be installed (available in CPAN and various other package managers).  To run this script:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNjYwMg=="}, "originalCommit": {"oid": "365e5f1f441e13723850e0b15ebd13d9b8c40f0e"}, "originalPosition": 78}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM5ODUwNjY3OnYy", "diffSide": "RIGHT", "path": "doc/administrator/upgrades/index.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoxNjoyMlrOIEEYwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoxNjoyMlrOIEEYwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNzA5MA==", "bodyText": "You may want to specify that if [database host] is localhost then someone may have to specify it by IP address (127.0.0.1) instead of localhost otherwise the connection will attempt to use a Unix Socket instead of TCP/IP. This causes issues if the database is running on Ubuntu since Ubuntu's install changes the location of the Unix Socket to use (so you will get an error). See https://metacpan.org/pod/DBD::mysql#host\nAlso, just a small comment, but normally I leave out the $ symbol to make it easier to copy/paste the command.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r541137090", "createdAt": "2020-12-11T18:16:22Z", "author": {"login": "apetkau"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -11,6 +11,145 @@ description: \"Upgrade Notes\"\n \n The majority of IRIDA's upgrade notes can be seen at <https://github.com/phac-nml/irida/blob/master/UPGRADING.md>.  When there are more significant upgrades to the IRIDA system, database, deployment, etc. this page will go further in depth about how to properly back up your system, perform the upgrade, and recover from problems.\n \n+# 21.01\n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |\n+\n+The tables involved are the following:\n+\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list (ex: \"Salmonella\").\n+* `sample_metadata_entry` - The relationship between the above 3 tables (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+In addition to the above, there is a matching `_AUD` (audit) table for each of these tables which captures any changes to the data and the user & time which the change occurred.  This auditing is managed by [Hibernate Envers](https://hibernate.org/orm/envers/).\n+\n+In general data will be populated into these tables in the following order:\n+\n+1. `sample` entry is created as sequencing data is uploaded (ex: \"sample1\"),\n+2. Someone uploads a set of sample metadata, which will first get a `metadata_field` (ex: \"Organism\")\n+  a. Find an existing `metadata_field` for a column header,\n+  b. Or create a new `metadata_field` for a header,\n+3. `metadata_entry` is created with the appropriate value (ex: \"Salmonella\"),\n+4. `sample_metadata_entry` is created linking the above 3 items together (ex: for \"sample1\" the \"Organism\" is \"Salmonella\").\n+\n+Note items 2, 3, and 4 will generally be done at the same time.  As soon as the metadata values are committed to the database, Envers should create `_AUD` entries for all of the above records.\n+\n+### The problem\n+{:.no_toc}\n+\n+The issue we noticed is that while Envers seemed to create `_AUD` records for all the above tables when metadata is first added to a sample, subsequent updates of those values *may* not create records for the `sample_metadata_entry_AUD` table, though it properly creates records for the `metadata_entry_AUD` and `sample_AUD` tables.  We found this to be most prevalent when data is synchronized from remote IRIDA installations, but also occurred in some cases where pipelines were re-run and metadata being re-saved to samples.  Most of these records were duplicate entries that were saving the same metadata values back to the sample, but creating new rows in the database.  We are still investigating why this issue was occurring.  Due to the complex nature of the above database tables it appears that Envers was failing to properly audit the relationship between those entities/tables.\n+\n+Note that we have found **no evidence of missing live data**.  It appears that all metadata records were written to the live database tables as expected.  This issue only appears to effect the `sample_metadata_entry_AUD` table.\n+\n+### The fix\n+{:.no_toc}\n+\n+Solving this issue involved a refactor of the database structure to remove the `sample_metadata_entry` table.  The new database structure is as follows:\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list and its relationship to the `metadata_field` and `sample` (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+This results in a cleaner database structure with less redundancy, and allowed us to refactor IRIDA's codebase to ensure Envers can properly capture any changes to a sample's metadata.  In the long-term this should also allow us to more efficiently build extensions to IRIDA's metadata system.\n+\n+As with most other database updates, we use [Liquibase](https://www.liquibase.org/) to manage this update.  After the 21.01 upgrade is complete, our Liquibase changeset will also remove any \"dangling\" `metadata_entry` records to improve performance and the integrity of metadata in the IRIDA system.\n+\n+### What about old data?\n+{:.no_toc}\n+\n+Since Envers was writing audit records for the `sample_AUD` and `metadata_entry_AUD` tables, we can re-connect many of the disconnected `metadata_entry_AUD` records with their samples.  In places where there is a clear connection between a `metadata_entry_AUD` record and a `sample_AUD` record, we are automatically re-connecting the entries to the appropriate sample and field using Liquibase.  In other cases where the connection is not as clear, we chose not to update the disconnected records in the database to ensure integrity of the existing audit records.  \n+\n+#### Metadata linking script\n+{:.no_toc}\n+\n+In addition to re-linking old data as described above, we've included a small utility script which can be run before the upgrade to generate a report of all disconnected `sample_metadata_entry_AUD` records and their connections to their parent samples where available.  While we do not expect that this report will be needed in the future, we recommend running this utility and saving the report alongside your backups to ensure the history of these samples is maintained.  **This script must be run before you perform the 21.01 update**.\n+\n+This script will output a CSV file of the following data:\n+\n+| `metadata_entry` database id | `metadata_entry` text value | Envers revision number of the entry | User ID of the user that made the change | `sample` database id associated with the metadata | Name of the sample |\n+|---|---|---|---|---|---|\n+\n+You can download this script at <https://github.com/phac-nml/irida/tree/development/src/main/resources/scripts/metadata-mappings>.  This script requires the `Text::CSV` perl package to be installed (available in CPAN and various other package managers).  To run this script:\n+\n+```bash\n+$ perl metadata-mappings.pl -u [database username] -p [database password] -d [irida database name] -h [database host] > [outputfile.csv]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "365e5f1f441e13723850e0b15ebd13d9b8c40f0e"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzODM1MDQyOnYy", "diffSide": "RIGHT", "path": "doc/administrator/upgrades/index.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxOToyNTo1OFrOIJjYmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxOToyNTo1OFrOIJjYmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg4NzgzMw==", "bodyText": "It's funny that you choose to use Organism for this example since it is technically still on the sample. \u00a0I think that update is something that needs to happen ASAP.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r546887833", "createdAt": "2020-12-21T19:25:58Z", "author": {"login": "joshsadam"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -11,6 +11,146 @@ description: \"Upgrade Notes\"\n \n The majority of IRIDA's upgrade notes can be seen at <https://github.com/phac-nml/irida/blob/master/UPGRADING.md>.  When there are more significant upgrades to the IRIDA system, database, deployment, etc. this page will go further in depth about how to properly back up your system, perform the upgrade, and recover from problems.\n \n+# 21.01\n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e872e3e671db946c8189cf2b85e41e5fdd3694bf"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 919, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}