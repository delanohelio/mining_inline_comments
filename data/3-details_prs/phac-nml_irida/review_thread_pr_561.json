{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NzE5MjYw", "number": 561, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMzo1MDowNlrODWQMPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNDo0MjoyMVrODWRHCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NjYwNTQxOnYy", "diffSide": "RIGHT", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/AnalysesAjaxController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMzo1MDowNlrOFa53Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNTo0MDowMFrOFa9IYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc1NTM1NQ==", "bodyText": "Why not make the AnalysisAuditing a component and have the EntityManagerFactory autowired into it?", "url": "https://github.com/phac-nml/irida/pull/561#discussion_r363755355", "createdAt": "2020-01-07T13:50:06Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/AnalysesAjaxController.java", "diffHunk": "@@ -204,11 +208,9 @@ private AnalysisModel createAnalysisModel(AnalysisSubmission submission, Locale\n \t\tString stateString = messageSource.getMessage(\"analysis.state.\" + analysisState.toString(), null, locale);\n \t\tAnalysisStateModel state = new AnalysisStateModel(stateString, analysisState.toString());\n \t\tString workflow = messageSource.getMessage(\"workflow.\" + workflowType + \".title\", null, workflowType, locale);\n-\t\tLong duration = 0L;\n-\t\tif (analysisState.equals(AnalysisState.COMPLETED)) {\n-\t\t\tduration = DateUtilities.getDurationInMilliseconds(submission.getCreatedDate(), submission.getAnalysis()\n-\t\t\t\t\t.getCreatedDate());\n-\t\t}\n+\n+\t\tAnalysisAuditing analysisAudit = new AnalysisAuditing(entityManagerFactory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwODg2NA==", "bodyText": "Removed Entity Manager/Audit Reader and annotated the class as a component in 6766c8e", "url": "https://github.com/phac-nml/irida/pull/561#discussion_r363808864", "createdAt": "2020-01-07T15:40:00Z", "author": {"login": "deepsidhu85"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/AnalysesAjaxController.java", "diffHunk": "@@ -204,11 +208,9 @@ private AnalysisModel createAnalysisModel(AnalysisSubmission submission, Locale\n \t\tString stateString = messageSource.getMessage(\"analysis.state.\" + analysisState.toString(), null, locale);\n \t\tAnalysisStateModel state = new AnalysisStateModel(stateString, analysisState.toString());\n \t\tString workflow = messageSource.getMessage(\"workflow.\" + workflowType + \".title\", null, workflowType, locale);\n-\t\tLong duration = 0L;\n-\t\tif (analysisState.equals(AnalysisState.COMPLETED)) {\n-\t\t\tduration = DateUtilities.getDurationInMilliseconds(submission.getCreatedDate(), submission.getAnalysis()\n-\t\t\t\t\t.getCreatedDate());\n-\t\t}\n+\n+\t\tAnalysisAuditing analysisAudit = new AnalysisAuditing(entityManagerFactory);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc1NTM1NQ=="}, "originalCommit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NjYwOTUxOnYy", "diffSide": "RIGHT", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/auditing/AnalysisAuditing.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMzo1MTozM1rOFa556A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMzo1MTozM1rOFa556A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc1NjAwOA==", "bodyText": "@tom114 can you take a look at this class and add your review to it please?", "url": "https://github.com/phac-nml/irida/pull/561#discussion_r363756008", "createdAt": "2020-01-07T13:51:33Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/auditing/AnalysisAuditing.java", "diffHunk": "@@ -0,0 +1,117 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.analysis.auditing;\n+\n+/*\n+ * This class is used for auditing analysis submissions using\n+ * AuditReader and EntityManagerFactory.\n+ */\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import javax.persistence.EntityManager;\n+import javax.persistence.EntityManagerFactory;\n+\n+import org.hibernate.envers.AuditReader;\n+import org.hibernate.envers.AuditReaderFactory;\n+import org.hibernate.envers.query.AuditEntity;\n+\n+import ca.corefacility.bioinformatics.irida.model.enums.AnalysisState;\n+import ca.corefacility.bioinformatics.irida.model.workflow.submission.AnalysisSubmission;\n+import ca.corefacility.bioinformatics.irida.ria.web.utilities.DateUtilities;\n+\n+public class AnalysisAuditing {\n+\tprivate EntityManagerFactory entityManagerFactory;\n+\n+\tpublic AnalysisAuditing(EntityManagerFactory entityManagerFactory) {\n+\t\tthis.entityManagerFactory=entityManagerFactory;\n+\t}\n+\n+\t/**\n+\t * Gets the running time of an analysis\n+\t *\n+\t * @param submission {@link AnalysisSubmission} The submission {@link AnalysisSubmission}\n+\t * @return {@link Long} Running time of the analysis\n+\t */\n+\tpublic Long getAnalysisRunningTime(AnalysisSubmission submission) {\n+\t\tEntityManager entityManager = entityManagerFactory.createEntityManager();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0Njc1NDA3OnYy", "diffSide": "RIGHT", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/auditing/AnalysisAuditing.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNDo0MTo0NVrOFa7S6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNTo0MDoyMFrOFa9JDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc3ODc5NA==", "bodyText": "Rather than deal with all this AuditReader stuff you should be able to get everything from the AnalysisSubmissionRepository.  It extends RevisionRepository which should have the methods you need to get the history you're grabbing below.  See docs at https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/repository/history/RevisionRepository.html?is-external=true", "url": "https://github.com/phac-nml/irida/pull/561#discussion_r363778794", "createdAt": "2020-01-07T14:41:45Z", "author": {"login": "tom114"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/auditing/AnalysisAuditing.java", "diffHunk": "@@ -0,0 +1,117 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.analysis.auditing;\n+\n+/*\n+ * This class is used for auditing analysis submissions using\n+ * AuditReader and EntityManagerFactory.\n+ */\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import javax.persistence.EntityManager;\n+import javax.persistence.EntityManagerFactory;\n+\n+import org.hibernate.envers.AuditReader;\n+import org.hibernate.envers.AuditReaderFactory;\n+import org.hibernate.envers.query.AuditEntity;\n+\n+import ca.corefacility.bioinformatics.irida.model.enums.AnalysisState;\n+import ca.corefacility.bioinformatics.irida.model.workflow.submission.AnalysisSubmission;\n+import ca.corefacility.bioinformatics.irida.ria.web.utilities.DateUtilities;\n+\n+public class AnalysisAuditing {\n+\tprivate EntityManagerFactory entityManagerFactory;\n+\n+\tpublic AnalysisAuditing(EntityManagerFactory entityManagerFactory) {\n+\t\tthis.entityManagerFactory=entityManagerFactory;\n+\t}\n+\n+\t/**\n+\t * Gets the running time of an analysis\n+\t *\n+\t * @param submission {@link AnalysisSubmission} The submission {@link AnalysisSubmission}\n+\t * @return {@link Long} Running time of the analysis\n+\t */\n+\tpublic Long getAnalysisRunningTime(AnalysisSubmission submission) {\n+\t\tEntityManager entityManager = entityManagerFactory.createEntityManager();\n+\t\tAuditReader audit = AuditReaderFactory.get(entityManager);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwOTAzOA==", "bodyText": "Thanks Tom! Updated in 6766c8e", "url": "https://github.com/phac-nml/irida/pull/561#discussion_r363809038", "createdAt": "2020-01-07T15:40:20Z", "author": {"login": "deepsidhu85"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/auditing/AnalysisAuditing.java", "diffHunk": "@@ -0,0 +1,117 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.analysis.auditing;\n+\n+/*\n+ * This class is used for auditing analysis submissions using\n+ * AuditReader and EntityManagerFactory.\n+ */\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import javax.persistence.EntityManager;\n+import javax.persistence.EntityManagerFactory;\n+\n+import org.hibernate.envers.AuditReader;\n+import org.hibernate.envers.AuditReaderFactory;\n+import org.hibernate.envers.query.AuditEntity;\n+\n+import ca.corefacility.bioinformatics.irida.model.enums.AnalysisState;\n+import ca.corefacility.bioinformatics.irida.model.workflow.submission.AnalysisSubmission;\n+import ca.corefacility.bioinformatics.irida.ria.web.utilities.DateUtilities;\n+\n+public class AnalysisAuditing {\n+\tprivate EntityManagerFactory entityManagerFactory;\n+\n+\tpublic AnalysisAuditing(EntityManagerFactory entityManagerFactory) {\n+\t\tthis.entityManagerFactory=entityManagerFactory;\n+\t}\n+\n+\t/**\n+\t * Gets the running time of an analysis\n+\t *\n+\t * @param submission {@link AnalysisSubmission} The submission {@link AnalysisSubmission}\n+\t * @return {@link Long} Running time of the analysis\n+\t */\n+\tpublic Long getAnalysisRunningTime(AnalysisSubmission submission) {\n+\t\tEntityManager entityManager = entityManagerFactory.createEntityManager();\n+\t\tAuditReader audit = AuditReaderFactory.get(entityManager);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc3ODc5NA=="}, "originalCommit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0Njc1NTk0OnYy", "diffSide": "RIGHT", "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/auditing/AnalysisAuditing.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNDo0MjoyMVrOFa7UAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNDo0MjoyMVrOFa7UAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc3OTA3NA==", "bodyText": "Yeah definitely try to use the AnalysisSubmissionRepository/RevisionRepository.  It'll avoid so much of this stuff.", "url": "https://github.com/phac-nml/irida/pull/561#discussion_r363779074", "createdAt": "2020-01-07T14:42:21Z", "author": {"login": "tom114"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/auditing/AnalysisAuditing.java", "diffHunk": "@@ -0,0 +1,117 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.analysis.auditing;\n+\n+/*\n+ * This class is used for auditing analysis submissions using\n+ * AuditReader and EntityManagerFactory.\n+ */\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import javax.persistence.EntityManager;\n+import javax.persistence.EntityManagerFactory;\n+\n+import org.hibernate.envers.AuditReader;\n+import org.hibernate.envers.AuditReaderFactory;\n+import org.hibernate.envers.query.AuditEntity;\n+\n+import ca.corefacility.bioinformatics.irida.model.enums.AnalysisState;\n+import ca.corefacility.bioinformatics.irida.model.workflow.submission.AnalysisSubmission;\n+import ca.corefacility.bioinformatics.irida.ria.web.utilities.DateUtilities;\n+\n+public class AnalysisAuditing {\n+\tprivate EntityManagerFactory entityManagerFactory;\n+\n+\tpublic AnalysisAuditing(EntityManagerFactory entityManagerFactory) {\n+\t\tthis.entityManagerFactory=entityManagerFactory;\n+\t}\n+\n+\t/**\n+\t * Gets the running time of an analysis\n+\t *\n+\t * @param submission {@link AnalysisSubmission} The submission {@link AnalysisSubmission}\n+\t * @return {@link Long} Running time of the analysis\n+\t */\n+\tpublic Long getAnalysisRunningTime(AnalysisSubmission submission) {\n+\t\tEntityManager entityManager = entityManagerFactory.createEntityManager();\n+\t\tAuditReader audit = AuditReaderFactory.get(entityManager);\n+\t\tArrayList<AnalysisSubmission> uniqueAuditedSubmissions = new ArrayList<>();\n+\t\tif (audit != null ) {\n+\t\t\t// Gets a list of the analysis submission revisions for the submission\n+\t\t\tList<?> auditResultSet = audit.createQuery()\n+\t\t\t\t\t.forRevisionsOfEntity(AnalysisSubmission.class, true, false)\n+\t\t\t\t\t.add(AuditEntity.id()\n+\t\t\t\t\t\t\t.eq(submission.getId()))\n+\t\t\t\t\t.getResultList();\n+\t\t\t// release the db connection\n+\t\t\tentityManager.close();\n+\t\t\tArrayList<String> auditedStates = new ArrayList<>();\n+\n+\t\t\t// Get a unique list of the audited submissions based on the state\n+\t\t\tfor (Object auditResult : auditResultSet) {\n+\t\t\t\tAnalysisSubmission auditedSubmission = (AnalysisSubmission) auditResult;\n+\t\t\t\tif (auditedSubmission != null && !auditedStates.contains(auditedSubmission.getAnalysisState()\n+\t\t\t\t\t\t.toString())) {\n+\t\t\t\t\tauditedStates.add(auditedSubmission.getAnalysisState()\n+\t\t\t\t\t\t\t.toString());\n+\t\t\t\t\tuniqueAuditedSubmissions.add(auditedSubmission);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\t// Get the run time of the analysis from creation till completion/error\n+\t\t\treturn DateUtilities.getDurationInMilliseconds(submission.getCreatedDate(),\n+\t\t\t\t\tuniqueAuditedSubmissions.get(uniqueAuditedSubmissions.size() - 1)\n+\t\t\t\t\t\t\t.getModifiedDate());\n+\t\t}\n+\n+\t\t// Before returning we double check to make sure\n+\t\t// the connection to the db has been released\n+\t\tif(entityManager.isOpen()) {\n+\t\t\tentityManager.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae"}, "originalPosition": 69}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 900, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}