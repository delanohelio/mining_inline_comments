{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNjM5MDU5", "number": 844, "title": "Announcements upgrade database", "bodyText": "Description of changes\n\nUpdated the announcements to include a title and priority\nCreated a script to parse the title from message and populate the new column\n\nRelated issue\nLink to the GitHub issue this pull request addresses using the #issuenum format.  If it completes an issue, use Fixes #issuenum to automatically close the issue.\nRelated to #419\nChecklist\nThings for the developer to confirm they've done before the PR should be accepted:\n\n CHANGELOG.md (and UPGRADING.md if necessary) updated with information for new change.\n Tests added (or description of how to test) for any new features.\n User documentation updated for UI or technical changes.", "createdAt": "2020-10-28T15:33:42Z", "url": "https://github.com/phac-nml/irida/pull/844", "merged": true, "mergeCommit": {"oid": "c21ff6cad79c728de587e14fa2eaf274536f69c8"}, "closed": true, "closedAt": "2020-11-03T16:38:35Z", "author": {"login": "ksierks"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdW-6cPgH2gAyNTExNjM5MDU5OmJkYTZhOTgwZjI3MmE0YTFmZTM5YTg4YmViN2NmYmYxZGQwN2E0MzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY74w0gFqTUyMjY4MDMxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bda6a980f272a4a1fe39a88beb7cfbf1dd07a435", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/bda6a980f272a4a1fe39a88beb7cfbf1dd07a435", "committedDate": "2020-10-28T15:01:31Z", "message": "adding liquibase changes to add new title and priority columns to the announcements table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09c38933065c2f73c8ada70f797482f68931d95a", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/09c38933065c2f73c8ada70f797482f68931d95a", "committedDate": "2020-10-28T15:16:32Z", "message": "adding scripts that populate the new title column in the announcements table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e82ed0098fcc74120f96a3c417f4e313dbb80de2", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/e82ed0098fcc74120f96a3c417f4e313dbb80de2", "committedDate": "2020-10-28T19:41:40Z", "message": "reflecting the new announcement changes in the model object"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MDAwMjk2", "url": "https://github.com/phac-nml/irida/pull/844#pullrequestreview-519000296", "createdAt": "2020-10-28T19:09:55Z", "commit": {"oid": "09c38933065c2f73c8ada70f797482f68931d95a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxOTowOTo1NVrOHp5hOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQyMDozNDoyMlrOHp8X0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY5NjA1Ng==", "bodyText": "Check in the hibernate generated database for these _AUD fields, but I would assume these fields are nullable in the _AUD tables.  The constraints in the liquibase version of the db should match the hibernate version.", "url": "https://github.com/phac-nml/irida/pull/844#discussion_r513696056", "createdAt": "2020-10-28T19:09:55Z", "author": {"login": "tom114"}, "path": "src/main/resources/ca/corefacility/bioinformatics/irida/database/changesets/21.01/announcements_upgrade.xml", "diffHunk": "@@ -0,0 +1,27 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+\n+<databaseChangeLog xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog\"\n+                   xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+                   xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog\n+         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd\">\n+\n+    <changeSet id=\"announcement_upgrade\" author=\"katherine\">\n+        <addColumn tableName=\"announcement\">\n+            <column name=\"title\" type=\"varchar(255)\" />\n+        </addColumn>\n+        <addColumn tableName=\"announcement\">\n+            <column name=\"priority\" type=\"tinyint(1)\">\n+                <constraints nullable=\"false\" />\n+            </column>\n+        </addColumn>\n+\n+        <addColumn tableName=\"announcement_AUD\">\n+            <column name=\"title\" type=\"varchar(255)\" />\n+        </addColumn>\n+        <addColumn tableName=\"announcement_AUD\">\n+            <column name=\"priority\" type=\"tinyint(1)\">\n+                <constraints nullable=\"false\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09c38933065c2f73c8ada70f797482f68931d95a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY5NjM4MA==", "bodyText": "Do we have a default for the priority?  If not I believe when upgrading an existing database this priority may fail.\nI tested and it looks like it defaulted everything to 0, but it would be better not to rely on chance.  I think if you add a value=0 to the column tag it'll definitively set the priority to false.", "url": "https://github.com/phac-nml/irida/pull/844#discussion_r513696380", "createdAt": "2020-10-28T19:10:29Z", "author": {"login": "tom114"}, "path": "src/main/resources/ca/corefacility/bioinformatics/irida/database/changesets/21.01/announcements_upgrade.xml", "diffHunk": "@@ -0,0 +1,27 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+\n+<databaseChangeLog xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog\"\n+                   xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+                   xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog\n+         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd\">\n+\n+    <changeSet id=\"announcement_upgrade\" author=\"katherine\">\n+        <addColumn tableName=\"announcement\">\n+            <column name=\"title\" type=\"varchar(255)\" />\n+        </addColumn>\n+        <addColumn tableName=\"announcement\">\n+            <column name=\"priority\" type=\"tinyint(1)\">\n+                <constraints nullable=\"false\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09c38933065c2f73c8ada70f797482f68931d95a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzY5NzQyMQ==", "bodyText": "Can we get some documentation in these files?  Particularly a big statement at the top about what the scripts are doing.  I can see in previous update scripts in here there isn't much but we should do it in the future.\nWe'll write up a big info section in the UPGRADING.md guide and probably https://irida.corefacility.ca/documentation/administrator/upgrades/ about these but still worthwhile to add something to the files themselves.", "url": "https://github.com/phac-nml/irida/pull/844#discussion_r513697421", "createdAt": "2020-10-28T19:12:34Z", "author": {"login": "tom114"}, "path": "src/main/resources/scripts/announcements/generate_json.py", "diffHunk": "@@ -0,0 +1,59 @@\n+#!/usr/bin/python\n+import argparse\n+from bs4 import BeautifulSoup\n+import json\n+from markdown import markdown\n+import mysql.connector\n+import re\n+\n+def create_json_file(json_file, host, user, password, database):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09c38933065c2f73c8ada70f797482f68931d95a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxNzE4OA==", "bodyText": "This is a bit pedantic, but in most cases we like to use the primitive boolean where we can in the models.  Capital B Boolean sometimes can get us into a weird tri-state since it can also be null.", "url": "https://github.com/phac-nml/irida/pull/844#discussion_r513717188", "createdAt": "2020-10-28T19:48:22Z", "author": {"login": "tom114"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/announcements/Announcement.java", "diffHunk": "@@ -48,10 +48,17 @@\n     @Column(name = \"created_date\", updatable = false)\n     private Date createdDate;\n \n+    @Column(name = \"title\")\n+    private String title;\n+\n     @Column(name = \"message\")\n     @Lob\n     private String message;\n \n+    @Column(name = \"priority\")\n+    @NotNull\n+    private Boolean priority;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e82ed0098fcc74120f96a3c417f4e313dbb80de2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzcxOTcwNA==", "bodyText": "If we're having external libraries we'll need to include install instructions for those libraries, or a script or something to install.  Something like a script to build a virutalenv or something would be good.\nIf at all possible try to use base Python libraries.  I'm guessing this case is being used to render the md to HTML to pull out the title?", "url": "https://github.com/phac-nml/irida/pull/844#discussion_r513719704", "createdAt": "2020-10-28T19:52:42Z", "author": {"login": "tom114"}, "path": "src/main/resources/scripts/announcements/generate_json.py", "diffHunk": "@@ -0,0 +1,59 @@\n+#!/usr/bin/python\n+import argparse\n+from bs4 import BeautifulSoup", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e82ed0098fcc74120f96a3c417f4e313dbb80de2"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzc0MjgwMw==", "bodyText": "This should probably also be not null.  It's a pain because we haven't set the titles yet with your python scripts.  An option would be to set a default value with the value=something tag here.  It could even be as simple as Announcement title not found.  At least that way we can set the not null constraint.", "url": "https://github.com/phac-nml/irida/pull/844#discussion_r513742803", "createdAt": "2020-10-28T20:34:22Z", "author": {"login": "tom114"}, "path": "src/main/resources/ca/corefacility/bioinformatics/irida/database/changesets/21.01/announcements_upgrade.xml", "diffHunk": "@@ -0,0 +1,27 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+\n+<databaseChangeLog xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog\"\n+                   xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+                   xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog\n+         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd\">\n+\n+    <changeSet id=\"announcement_upgrade\" author=\"katherine\">\n+        <addColumn tableName=\"announcement\">\n+            <column name=\"title\" type=\"varchar(255)\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e82ed0098fcc74120f96a3c417f4e313dbb80de2"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e0137610a04374a1b730e8eb9f1a90a991b96be", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/5e0137610a04374a1b730e8eb9f1a90a991b96be", "committedDate": "2020-10-29T17:25:23Z", "message": "setting announcement priority column to default false"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19a454c15f2baadf1a22d9f7da226d04a5197912", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/19a454c15f2baadf1a22d9f7da226d04a5197912", "committedDate": "2020-10-29T18:35:29Z", "message": "adding some documentation to the python scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b1ab44793167beaede37b37b46c11335359f81f", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/3b1ab44793167beaede37b37b46c11335359f81f", "committedDate": "2020-10-29T18:55:14Z", "message": "changing announcement priority data type from Boolean to boolean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8328ac4df67c43e5694c7ebf59f67836d836baf9", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/8328ac4df67c43e5694c7ebf59f67836d836baf9", "committedDate": "2020-10-29T19:03:30Z", "message": "adding default value to title in announcement table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6aae03c16b38cc1e465ff7a86fa8cece6297e0d", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/f6aae03c16b38cc1e465ff7a86fa8cece6297e0d", "committedDate": "2020-10-30T12:32:00Z", "message": "removing third party libraries from python script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "835920ad38513b8a0ec8efcff9a8ac8c1434ec7f", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/835920ad38513b8a0ec8efcff9a8ac8c1434ec7f", "committedDate": "2020-10-30T12:53:59Z", "message": "reverting change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dee5891e98e3ed096e2edda6065051c62087d94d", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/dee5891e98e3ed096e2edda6065051c62087d94d", "committedDate": "2020-10-30T13:47:20Z", "message": "updating regular expression"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNzQ3NjA4", "url": "https://github.com/phac-nml/irida/pull/844#pullrequestreview-520747608", "createdAt": "2020-10-30T14:54:34Z", "commit": {"oid": "dee5891e98e3ed096e2edda6065051c62087d94d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNDo1NDozNFrOHrSxwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNDo1NToyNVrOHrS0CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE1ODQ2NQ==", "bodyText": "Since we've got this funky regex stuff going on in here can you add some inline comments on how this is working?", "url": "https://github.com/phac-nml/irida/pull/844#discussion_r515158465", "createdAt": "2020-10-30T14:54:34Z", "author": {"login": "tom114"}, "path": "src/main/resources/scripts/announcements/generate_json.py", "diffHunk": "@@ -0,0 +1,87 @@\n+#!/usr/bin/python\n+import argparse\n+import json\n+import mysql.connector\n+import re\n+\n+# This script will fetch all the rows from the announcement table, then parse\n+# the title out from the message content and return a json file with the newly\n+# populated title and modified message content.\n+#\n+# Step #1: Run this script to generate a json file with the modified\n+# announcement data.\n+#\n+# Step #2: Please review the json file to make sure the title was parsed\n+# correctly from the message content.\n+#\n+# Step #3: To update the announcement table with the json file run the\n+# update_announcement.py script next.\n+\n+def create_json_file(json_file, host, user, password, database):\n+\n+    json_data = []\n+    json_file = open(json_file,\"w+\")\n+\n+    db = mysql.connector.connect(\n+        host=host,\n+        user=user,\n+        password=password,\n+        database=database\n+    )\n+    cursor = db.cursor()\n+    cursor.execute(\"SELECT id, created_date, created_by_id, title, message, priority FROM announcement\")\n+    result = cursor.fetchall()\n+    cursor.close()\n+    db.close()\n+\n+    for id, created_date, created_by_id, title, message, priority in result:\n+        \n+        if not title:\n+            lines = message.split(\"\\n\",1)\n+\n+            if len(lines) > 0:\n+                first_line = lines[0]\n+                header = re.match(r\"^#+\\s(.+)$\", first_line)\n+                \n+                if header:\n+                    title = header[1]\n+\n+                    if len(lines) > 1:\n+                        message = lines[1]\n+                else:\n+                    if len(lines) > 1:\n+                        lines = lines[1].split(\"\\n\",1)\n+\n+                        if len(lines) > 0:\n+                            second_line = lines[0]\n+                            underline = re.match(r\"^(-|=)+$\", second_line)\n+\n+                            if underline:\n+                                title = first_line\n+\n+                                if len(lines) > 1:\n+                                    message = lines[1]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dee5891e98e3ed096e2edda6065051c62087d94d"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE1OTA0OQ==", "bodyText": "Since this field is not null in the liquibase please add @NotNull here as well please.", "url": "https://github.com/phac-nml/irida/pull/844#discussion_r515159049", "createdAt": "2020-10-30T14:55:25Z", "author": {"login": "tom114"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/announcements/Announcement.java", "diffHunk": "@@ -48,10 +48,17 @@\n     @Column(name = \"created_date\", updatable = false)\n     private Date createdDate;\n \n+    @Column(name = \"title\")\n+    private String title;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dee5891e98e3ed096e2edda6065051c62087d94d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd781b5750cdd53260d15238c2e6a9e398c09c1d", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/bd781b5750cdd53260d15238c2e6a9e398c09c1d", "committedDate": "2020-10-30T16:11:43Z", "message": "making announcement title not null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "649d36421ac3535ab3a16283aac93e9e96130a64", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/649d36421ac3535ab3a16283aac93e9e96130a64", "committedDate": "2020-10-30T16:18:03Z", "message": "adding more commments to python script"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwODQwMzMx", "url": "https://github.com/phac-nml/irida/pull/844#pullrequestreview-520840331", "createdAt": "2020-10-30T16:35:11Z", "commit": {"oid": "649d36421ac3535ab3a16283aac93e9e96130a64"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjozNToxMVrOHrW9VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNjozNToxMVrOHrW9VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTIyNjk2NQ==", "bodyText": "Looks like an accidental addition here", "url": "https://github.com/phac-nml/irida/pull/844#discussion_r515226965", "createdAt": "2020-10-30T16:35:11Z", "author": {"login": "tom114"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/announcements/Announcement.java", "diffHunk": "@@ -31,7 +31,7 @@\n  * An announcement object. Announcements can be created only by admin users, and announcements\n  * are displayed on the dashboard page.\n  */\n-@Entity\n+@Entity.sql", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "649d36421ac3535ab3a16283aac93e9e96130a64"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d57593d3e1ae927a707170237a803d18d7edb1c3", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/d57593d3e1ae927a707170237a803d18d7edb1c3", "committedDate": "2020-10-30T16:40:22Z", "message": "reverting mistake"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTU0MTAw", "url": "https://github.com/phac-nml/irida/pull/844#pullrequestreview-521954100", "createdAt": "2020-11-02T20:03:37Z", "commit": {"oid": "d57593d3e1ae927a707170237a803d18d7edb1c3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDowMzozN1rOHsTxUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDo0MToyOVrOHsU5cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyMzMxNA==", "bodyText": "Unfortunately this isn't part of base python either.  You'll have to add instructions for how to install.  Please be sure to use something like a virtualenv.", "url": "https://github.com/phac-nml/irida/pull/844#discussion_r516223314", "createdAt": "2020-11-02T20:03:37Z", "author": {"login": "tom114"}, "path": "src/main/resources/scripts/announcements/generate_json.py", "diffHunk": "@@ -0,0 +1,95 @@\n+#!/usr/bin/python\n+import argparse\n+import json\n+import mysql.connector", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d57593d3e1ae927a707170237a803d18d7edb1c3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjIyNDc2NQ==", "bodyText": "Typically we've used the defaults as the defaults of our test database.  Use test/test for the defaults for user/password please.", "url": "https://github.com/phac-nml/irida/pull/844#discussion_r516224765", "createdAt": "2020-11-02T20:06:29Z", "author": {"login": "tom114"}, "path": "src/main/resources/scripts/announcements/generate_json.py", "diffHunk": "@@ -0,0 +1,95 @@\n+#!/usr/bin/python\n+import argparse\n+import json\n+import mysql.connector\n+import re\n+\n+# This script will fetch all the rows from the announcement table, then parse\n+# the title out from the message content and return a json file with the newly\n+# populated title and modified message content.\n+#\n+# Step #1: Run this script to generate a json file with the modified\n+# announcement data.\n+#\n+# Step #2: Please review the json file to make sure the title was parsed\n+# correctly from the message content.\n+#\n+# Step #3: To update the announcement table with the json file run the\n+# update_announcement.py script next.\n+\n+def create_json_file(json_file, host, user, password, database):\n+\n+    json_data = []\n+    json_file = open(json_file,\"w+\")\n+\n+    db = mysql.connector.connect(\n+        host=host,\n+        user=user,\n+        password=password,\n+        database=database\n+    )\n+    cursor = db.cursor()\n+    cursor.execute(\"SELECT id, created_date, created_by_id, title, message, priority FROM announcement\")\n+    result = cursor.fetchall()\n+    cursor.close()\n+    db.close()\n+\n+    for id, created_date, created_by_id, title, message, priority in result:\n+        \n+        if not title:\n+            # split the message into two,\n+            # the first line and the rest of the message\n+            lines = message.split(\"\\n\",1)\n+\n+            if len(lines) > 0:\n+                # check if the first line in the message is a header\n+                # by trying to find number signs in front of a word\n+                first_line = lines[0]\n+                header = re.match(r\"^#+\\s(.+)$\", first_line)\n+                \n+                if header:\n+                    title = header[1]\n+\n+                    if len(lines) > 1:\n+                        message = lines[1]\n+                else:\n+                    if len(lines) > 1:\n+                        # split the rest of the message into two again,\n+                        # the first line and the rest of the message\n+                        lines = lines[1].split(\"\\n\",1)\n+\n+                        if len(lines) > 0:\n+                            # check if the second line in the message is a header\n+                            # by trying to find any number of = or - characters\n+                            second_line = lines[0]\n+                            underline = re.match(r\"^(-|=)+$\", second_line)\n+\n+                            if underline:\n+                                title = first_line\n+\n+                                if len(lines) > 1:\n+                                    message = lines[1]\n+\n+            json_data.append({\"id\":id, \"created_date\":created_date, \"created_by_id\":created_by_id, \"title\":title, \"message\":message, \"priority\":priority})\n+\n+    # convert the list to a JSON string\n+    json_string = json.dumps(json_data, indent=2, default=str)\n+    json_file.write(json_string)\n+    json_file.close()\n+\n+\n+def main():\n+    parser = argparse.ArgumentParser()\n+\n+    parser.add_argument( 'json_file', help=\"The output json file of announcement titles to be populated.\")\n+    parser.add_argument( '--host', default='localhost', help=\"The database host name.\", required=False)\n+    parser.add_argument( '--database', default='irida_test', help=\"The database name.\", required=False)\n+    parser.add_argument( '--user', default='root', help=\"The database user name.\", required=False)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d57593d3e1ae927a707170237a803d18d7edb1c3"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0MTc3OQ==", "bodyText": "Kinda a funky oops here.  You select for title, but since we're automatically adding the fake title to the announcements in the liquibase it means that none of them get added to this file.  If you remove this if it works as expected.", "url": "https://github.com/phac-nml/irida/pull/844#discussion_r516241779", "createdAt": "2020-11-02T20:41:29Z", "author": {"login": "tom114"}, "path": "src/main/resources/scripts/announcements/generate_json.py", "diffHunk": "@@ -0,0 +1,95 @@\n+#!/usr/bin/python\n+import argparse\n+import json\n+import mysql.connector\n+import re\n+\n+# This script will fetch all the rows from the announcement table, then parse\n+# the title out from the message content and return a json file with the newly\n+# populated title and modified message content.\n+#\n+# Step #1: Run this script to generate a json file with the modified\n+# announcement data.\n+#\n+# Step #2: Please review the json file to make sure the title was parsed\n+# correctly from the message content.\n+#\n+# Step #3: To update the announcement table with the json file run the\n+# update_announcement.py script next.\n+\n+def create_json_file(json_file, host, user, password, database):\n+\n+    json_data = []\n+    json_file = open(json_file,\"w+\")\n+\n+    db = mysql.connector.connect(\n+        host=host,\n+        user=user,\n+        password=password,\n+        database=database\n+    )\n+    cursor = db.cursor()\n+    cursor.execute(\"SELECT id, created_date, created_by_id, title, message, priority FROM announcement\")\n+    result = cursor.fetchall()\n+    cursor.close()\n+    db.close()\n+\n+    for id, created_date, created_by_id, title, message, priority in result:\n+        \n+        if not title:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d57593d3e1ae927a707170237a803d18d7edb1c3"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e99a12949d8abbde11ffbe791b35846b6d2e104", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/5e99a12949d8abbde11ffbe791b35846b6d2e104", "committedDate": "2020-11-03T13:23:58Z", "message": "title is getting auto populated by liquibase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f79d1ffb165ec9620a3a465b77df392aa29b00e4", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/f79d1ffb165ec9620a3a465b77df392aa29b00e4", "committedDate": "2020-11-03T13:32:13Z", "message": "changing default database credentials on scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a9b7eaab92153dda3da0124fa24c5b7de0e32b4", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/7a9b7eaab92153dda3da0124fa24c5b7de0e32b4", "committedDate": "2020-11-03T14:42:47Z", "message": "adding a readme for how to run the scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "776a1562764fa2036657b8bba02916d1ea9b1b9b", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/776a1562764fa2036657b8bba02916d1ea9b1b9b", "committedDate": "2020-11-03T14:45:25Z", "message": "adding a readme for how to run the scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cad41a5c5b492472a2c327c888a1e58494b59140", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/cad41a5c5b492472a2c327c888a1e58494b59140", "committedDate": "2020-11-03T14:54:14Z", "message": "changing README to be more constistent with Makefile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fdf41fc21506daadb3333d4ac53e97c2f8391d3", "author": {"user": {"login": "ksierks", "name": "Katherine Thiessen"}}, "url": "https://github.com/phac-nml/irida/commit/9fdf41fc21506daadb3333d4ac53e97c2f8391d3", "committedDate": "2020-11-03T15:12:04Z", "message": "pip freeze requirements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNjgwMzE4", "url": "https://github.com/phac-nml/irida/pull/844#pullrequestreview-522680318", "createdAt": "2020-11-03T16:37:49Z", "commit": {"oid": "9fdf41fc21506daadb3333d4ac53e97c2f8391d3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 161, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}