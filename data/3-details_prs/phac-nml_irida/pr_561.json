{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NzE5MjYw", "number": 561, "title": "analysis/_running-time", "bodyText": "Description of changes\nWhat did you change in this pull request?  Provide a description of files changed, user interactions changed, etc.  Include how to test your changes.\nCorrect running time is displayed for analyses in any state.\nRelated issue\nLink to the GitHub issue this pull request addresses using the #issuenum format.  If it completes an issue, use Fixes #issuenum to automatically close the issue.\nChecklist\nThings for the developer to confirm they've done before the PR should be accepted:\n* [ ] CHANGELOG.md (and UPGRADING.md if necessary) updated with information for new change.\n* [ ] Tests added (or description of how to test) for any new features.\n* [ ] User documentation updated for UI or technical changes.", "createdAt": "2020-01-06T21:22:10Z", "url": "https://github.com/phac-nml/irida/pull/561", "merged": true, "mergeCommit": {"oid": "d87174ff7be88a8cdea4893645f04d758992b85f"}, "closed": true, "closedAt": "2020-01-08T20:17:38Z", "author": {"login": "deepsidhu85"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3y7NCgH2gAyMzU5NzE5MjYwOjM3ODRmMzFjYjViNzQ2NmNhZjUzNTMxYjY3ZjEyMGRmZjU1MDZkMGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4ZakUAH2gAyMzU5NzE5MjYwOmQ3OWJkOWUzNDM5N2RkOTc1MWY2YTA1MDU0Y2EwZDdhODdmZWE1NTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3784f31cb5b7466caf53531b67f120dff5506d0d", "author": {"user": null}, "url": "https://github.com/phac-nml/irida/commit/3784f31cb5b7466caf53531b67f120dff5506d0d", "committedDate": "2020-01-06T21:20:41Z", "message": "Correct running time is displayed for analyses in any state rather than just completed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae", "author": {"user": null}, "url": "https://github.com/phac-nml/irida/commit/fea97518cbd6374235b8ace2996fa3aac321e5ae", "committedDate": "2020-01-06T22:08:28Z", "message": "Updated analyses table to use AnalysisAuditing to display the correct duration for all states"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MjQ1NTY4", "url": "https://github.com/phac-nml/irida/pull/561#pullrequestreview-339245568", "createdAt": "2020-01-07T13:50:06Z", "commit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMzo1MDowNlrOFa53Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMzo1MTozM1rOFa556A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc1NTM1NQ==", "bodyText": "Why not make the AnalysisAuditing a component and have the EntityManagerFactory autowired into it?", "url": "https://github.com/phac-nml/irida/pull/561#discussion_r363755355", "createdAt": "2020-01-07T13:50:06Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/AnalysesAjaxController.java", "diffHunk": "@@ -204,11 +208,9 @@ private AnalysisModel createAnalysisModel(AnalysisSubmission submission, Locale\n \t\tString stateString = messageSource.getMessage(\"analysis.state.\" + analysisState.toString(), null, locale);\n \t\tAnalysisStateModel state = new AnalysisStateModel(stateString, analysisState.toString());\n \t\tString workflow = messageSource.getMessage(\"workflow.\" + workflowType + \".title\", null, workflowType, locale);\n-\t\tLong duration = 0L;\n-\t\tif (analysisState.equals(AnalysisState.COMPLETED)) {\n-\t\t\tduration = DateUtilities.getDurationInMilliseconds(submission.getCreatedDate(), submission.getAnalysis()\n-\t\t\t\t\t.getCreatedDate());\n-\t\t}\n+\n+\t\tAnalysisAuditing analysisAudit = new AnalysisAuditing(entityManagerFactory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc1NjAwOA==", "bodyText": "@tom114 can you take a look at this class and add your review to it please?", "url": "https://github.com/phac-nml/irida/pull/561#discussion_r363756008", "createdAt": "2020-01-07T13:51:33Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/auditing/AnalysisAuditing.java", "diffHunk": "@@ -0,0 +1,117 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.analysis.auditing;\n+\n+/*\n+ * This class is used for auditing analysis submissions using\n+ * AuditReader and EntityManagerFactory.\n+ */\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import javax.persistence.EntityManager;\n+import javax.persistence.EntityManagerFactory;\n+\n+import org.hibernate.envers.AuditReader;\n+import org.hibernate.envers.AuditReaderFactory;\n+import org.hibernate.envers.query.AuditEntity;\n+\n+import ca.corefacility.bioinformatics.irida.model.enums.AnalysisState;\n+import ca.corefacility.bioinformatics.irida.model.workflow.submission.AnalysisSubmission;\n+import ca.corefacility.bioinformatics.irida.ria.web.utilities.DateUtilities;\n+\n+public class AnalysisAuditing {\n+\tprivate EntityManagerFactory entityManagerFactory;\n+\n+\tpublic AnalysisAuditing(EntityManagerFactory entityManagerFactory) {\n+\t\tthis.entityManagerFactory=entityManagerFactory;\n+\t}\n+\n+\t/**\n+\t * Gets the running time of an analysis\n+\t *\n+\t * @param submission {@link AnalysisSubmission} The submission {@link AnalysisSubmission}\n+\t * @return {@link Long} Running time of the analysis\n+\t */\n+\tpublic Long getAnalysisRunningTime(AnalysisSubmission submission) {\n+\t\tEntityManager entityManager = entityManagerFactory.createEntityManager();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5Mjc2ODYz", "url": "https://github.com/phac-nml/irida/pull/561#pullrequestreview-339276863", "createdAt": "2020-01-07T14:41:44Z", "commit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNDo0MTo0NVrOFa7S6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNDo0MjoyMVrOFa7UAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc3ODc5NA==", "bodyText": "Rather than deal with all this AuditReader stuff you should be able to get everything from the AnalysisSubmissionRepository.  It extends RevisionRepository which should have the methods you need to get the history you're grabbing below.  See docs at https://docs.spring.io/spring-data/commons/docs/current/api/org/springframework/data/repository/history/RevisionRepository.html?is-external=true", "url": "https://github.com/phac-nml/irida/pull/561#discussion_r363778794", "createdAt": "2020-01-07T14:41:45Z", "author": {"login": "tom114"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/auditing/AnalysisAuditing.java", "diffHunk": "@@ -0,0 +1,117 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.analysis.auditing;\n+\n+/*\n+ * This class is used for auditing analysis submissions using\n+ * AuditReader and EntityManagerFactory.\n+ */\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import javax.persistence.EntityManager;\n+import javax.persistence.EntityManagerFactory;\n+\n+import org.hibernate.envers.AuditReader;\n+import org.hibernate.envers.AuditReaderFactory;\n+import org.hibernate.envers.query.AuditEntity;\n+\n+import ca.corefacility.bioinformatics.irida.model.enums.AnalysisState;\n+import ca.corefacility.bioinformatics.irida.model.workflow.submission.AnalysisSubmission;\n+import ca.corefacility.bioinformatics.irida.ria.web.utilities.DateUtilities;\n+\n+public class AnalysisAuditing {\n+\tprivate EntityManagerFactory entityManagerFactory;\n+\n+\tpublic AnalysisAuditing(EntityManagerFactory entityManagerFactory) {\n+\t\tthis.entityManagerFactory=entityManagerFactory;\n+\t}\n+\n+\t/**\n+\t * Gets the running time of an analysis\n+\t *\n+\t * @param submission {@link AnalysisSubmission} The submission {@link AnalysisSubmission}\n+\t * @return {@link Long} Running time of the analysis\n+\t */\n+\tpublic Long getAnalysisRunningTime(AnalysisSubmission submission) {\n+\t\tEntityManager entityManager = entityManagerFactory.createEntityManager();\n+\t\tAuditReader audit = AuditReaderFactory.get(entityManager);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzc3OTA3NA==", "bodyText": "Yeah definitely try to use the AnalysisSubmissionRepository/RevisionRepository.  It'll avoid so much of this stuff.", "url": "https://github.com/phac-nml/irida/pull/561#discussion_r363779074", "createdAt": "2020-01-07T14:42:21Z", "author": {"login": "tom114"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/auditing/AnalysisAuditing.java", "diffHunk": "@@ -0,0 +1,117 @@\n+package ca.corefacility.bioinformatics.irida.ria.web.analysis.auditing;\n+\n+/*\n+ * This class is used for auditing analysis submissions using\n+ * AuditReader and EntityManagerFactory.\n+ */\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import javax.persistence.EntityManager;\n+import javax.persistence.EntityManagerFactory;\n+\n+import org.hibernate.envers.AuditReader;\n+import org.hibernate.envers.AuditReaderFactory;\n+import org.hibernate.envers.query.AuditEntity;\n+\n+import ca.corefacility.bioinformatics.irida.model.enums.AnalysisState;\n+import ca.corefacility.bioinformatics.irida.model.workflow.submission.AnalysisSubmission;\n+import ca.corefacility.bioinformatics.irida.ria.web.utilities.DateUtilities;\n+\n+public class AnalysisAuditing {\n+\tprivate EntityManagerFactory entityManagerFactory;\n+\n+\tpublic AnalysisAuditing(EntityManagerFactory entityManagerFactory) {\n+\t\tthis.entityManagerFactory=entityManagerFactory;\n+\t}\n+\n+\t/**\n+\t * Gets the running time of an analysis\n+\t *\n+\t * @param submission {@link AnalysisSubmission} The submission {@link AnalysisSubmission}\n+\t * @return {@link Long} Running time of the analysis\n+\t */\n+\tpublic Long getAnalysisRunningTime(AnalysisSubmission submission) {\n+\t\tEntityManager entityManager = entityManagerFactory.createEntityManager();\n+\t\tAuditReader audit = AuditReaderFactory.get(entityManager);\n+\t\tArrayList<AnalysisSubmission> uniqueAuditedSubmissions = new ArrayList<>();\n+\t\tif (audit != null ) {\n+\t\t\t// Gets a list of the analysis submission revisions for the submission\n+\t\t\tList<?> auditResultSet = audit.createQuery()\n+\t\t\t\t\t.forRevisionsOfEntity(AnalysisSubmission.class, true, false)\n+\t\t\t\t\t.add(AuditEntity.id()\n+\t\t\t\t\t\t\t.eq(submission.getId()))\n+\t\t\t\t\t.getResultList();\n+\t\t\t// release the db connection\n+\t\t\tentityManager.close();\n+\t\t\tArrayList<String> auditedStates = new ArrayList<>();\n+\n+\t\t\t// Get a unique list of the audited submissions based on the state\n+\t\t\tfor (Object auditResult : auditResultSet) {\n+\t\t\t\tAnalysisSubmission auditedSubmission = (AnalysisSubmission) auditResult;\n+\t\t\t\tif (auditedSubmission != null && !auditedStates.contains(auditedSubmission.getAnalysisState()\n+\t\t\t\t\t\t.toString())) {\n+\t\t\t\t\tauditedStates.add(auditedSubmission.getAnalysisState()\n+\t\t\t\t\t\t\t.toString());\n+\t\t\t\t\tuniqueAuditedSubmissions.add(auditedSubmission);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t\t// Get the run time of the analysis from creation till completion/error\n+\t\t\treturn DateUtilities.getDurationInMilliseconds(submission.getCreatedDate(),\n+\t\t\t\t\tuniqueAuditedSubmissions.get(uniqueAuditedSubmissions.size() - 1)\n+\t\t\t\t\t\t\t.getModifiedDate());\n+\t\t}\n+\n+\t\t// Before returning we double check to make sure\n+\t\t// the connection to the db has been released\n+\t\tif(entityManager.isOpen()) {\n+\t\t\tentityManager.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fea97518cbd6374235b8ace2996fa3aac321e5ae"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6766c8ecf35d0d185900b8e1958aca1fa9d2d409", "author": {"user": null}, "url": "https://github.com/phac-nml/irida/commit/6766c8ecf35d0d185900b8e1958aca1fa9d2d409", "committedDate": "2020-01-07T15:39:01Z", "message": "Removed audit reader and entity manager and made use of analysisSubmissionRepository revisions extension"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f8ca01216438d8e96e3060286681374e07294d0", "author": {"user": null}, "url": "https://github.com/phac-nml/irida/commit/9f8ca01216438d8e96e3060286681374e07294d0", "committedDate": "2020-01-07T15:53:39Z", "message": "Formatted code and added javadoc comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4153a2d27c9ce6ec56127cc2f79e66900c07722a", "author": {"user": null}, "url": "https://github.com/phac-nml/irida/commit/4153a2d27c9ce6ec56127cc2f79e66900c07722a", "committedDate": "2020-01-07T16:47:49Z", "message": "Changed auditedStates to use a set rather than an arraylist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf9702896523a3c8c0c02f057ac2b8e6972c3c66", "author": {"user": null}, "url": "https://github.com/phac-nml/irida/commit/bf9702896523a3c8c0c02f057ac2b8e6972c3c66", "committedDate": "2020-01-07T17:10:45Z", "message": "Merge branch 'analysis/_base_results' into analysis/_running-time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NTAwNTU3", "url": "https://github.com/phac-nml/irida/pull/561#pullrequestreview-339500557", "createdAt": "2020-01-07T20:53:52Z", "commit": {"oid": "bf9702896523a3c8c0c02f057ac2b8e6972c3c66"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03c8363d1ae37e2b3c2178eaeefa40fa215842e3", "author": {"user": null}, "url": "https://github.com/phac-nml/irida/commit/03c8363d1ae37e2b3c2178eaeefa40fa215842e3", "committedDate": "2020-01-07T21:37:53Z", "message": "Updated method to check if there are uniqueAuditedSubmissions before returning a duration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55bb6a2f85767dd40b223cf06930d12b4bfc7dfe", "author": {"user": null}, "url": "https://github.com/phac-nml/irida/commit/55bb6a2f85767dd40b223cf06930d12b4bfc7dfe", "committedDate": "2020-01-08T17:01:42Z", "message": "Removed unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d79bd9e34397dd9751f6a05054ca0d7a87fea550", "author": {"user": null}, "url": "https://github.com/phac-nml/irida/commit/d79bd9e34397dd9751f6a05054ca0d7a87fea550", "committedDate": "2020-01-08T18:11:20Z", "message": "Added comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 284, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}