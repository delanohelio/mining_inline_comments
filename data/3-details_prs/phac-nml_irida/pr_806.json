{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxOTQ1NTQ2", "number": 806, "title": "cgMLST update for the SISTR Viewer (cgmlst_found_loci field addition)", "bodyText": "Added cgmlst_found_loci field that shows number of alleles that were found in sample as a useful quality control metic. Tested both with results JSON files fromSISTR v1.0.2 and the newest SISTR v1.1.1 containing the cgmlst_found_loci field. Corrected cgmlst_distance declaration to float type (was declared as long integer before)\nDescription of changes\nMostly the SistrResults.java was updated with a new cgmlstFoundAlleles variable and CgMlst.jsx to render the results.\nRelated issue\nIssue #591 is marginally related talking about implementation of Viewers in plugins\nIssue #196 with the TODO tasks list", "createdAt": "2020-09-23T17:58:16Z", "url": "https://github.com/phac-nml/irida/pull/806", "merged": true, "mergeCommit": {"oid": "d5ff9884e55a77b5f3c1bf5422058207c52196cc"}, "closed": true, "closedAt": "2020-10-05T19:13:55Z", "author": {"login": "kbessonov1984"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLu-1YAH2gAyNDkxOTQ1NTQ2OjlmMTk5YWZkODQ1YzQ4M2RkMmY2Y2QxNjFjNWJmZTE0ZTBkOTBiZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOBmSZAH2gAyNDkxOTQ1NTQ2OmI1MDYzOTA1MzE3ODk3MGNkMjRiZWY5YmZiNzMyODQ2ZThjZWU0OTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9f199afd845c483dd2f6cd161c5bfe14e0d90bdf", "author": {"user": {"login": "kbessonov1984", "name": "Kirill Bessonov"}}, "url": "https://github.com/phac-nml/irida/commit/9f199afd845c483dd2f6cd161c5bfe14e0d90bdf", "committedDate": "2020-09-23T16:14:40Z", "message": "two new fields cgmlst_found_loci and percent of the cgmlst_found_loci field that shows number of alleles that were found in sample as a useful QC metic. Tested both with SISTR v1.0.2 and the newest SISTR v1.1.1 containing the cgmlst_found_loci field. Corrected cgmlst_distance declaration to float type (was integer)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "830007ea84fb6e7102c7ca9c5a0c470d629d34f0", "author": {"user": {"login": "kbessonov1984", "name": "Kirill Bessonov"}}, "url": "https://github.com/phac-nml/irida/commit/830007ea84fb6e7102c7ca9c5a0c470d629d34f0", "committedDate": "2020-09-23T19:18:14Z", "message": "Changed number of items in cgMLST SISTR Viewer section from 5 to 7"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "589898bdfdd03da513878579a999863f48fb0184", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/589898bdfdd03da513878579a999863f48fb0184", "committedDate": "2020-09-24T14:55:28Z", "message": "updated pom and changelog versions to 21.01"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "508053e67ddbb365752410d989fb4b46c7a83159", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/508053e67ddbb365752410d989fb4b46c7a83159", "committedDate": "2020-09-24T17:02:36Z", "message": "Merge branch 'doc/snvphyl' into development"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b3a73d35f298793625d903f1b1707c8dde81f67", "author": {"user": {"login": "kbessonov1984", "name": "Kirill Bessonov"}}, "url": "https://github.com/phac-nml/irida/commit/1b3a73d35f298793625d903f1b1707c8dde81f67", "committedDate": "2020-09-26T12:31:48Z", "message": "Updated AnalysisAjaxController.java getSistrAnalysis() to accept calls not only from built-in SISTR workflow but also from IRIDA plugins by checking not AnalysisType but requested viewer for final results rendering (i.e. results page in Analysis view). Checked to make sure this code update works with both built-in and plugin SISTR versions. Removed analysisType.equals(BuiltInAnalysisTypes.SISTR_TYPING) as checking is done based on the results viewer requested only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de06006aaf6f9e26457fe500b1752889bf414bed", "author": {"user": {"login": "kbessonov1984", "name": "Kirill Bessonov"}}, "url": "https://github.com/phac-nml/irida/commit/de06006aaf6f9e26457fe500b1752889bf414bed", "committedDate": "2020-09-28T15:11:49Z", "message": "removed unused import statement import ca.corefacility.bioinformatics.irida.model.workflow.analysis.type.BuiltInAnalysisTypes from AnalysisAjaxController.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5aef4cb6b9421876f84f9c0087c28d4e28a98a2", "author": {"user": {"login": "kbessonov1984", "name": "Kirill Bessonov"}}, "url": "https://github.com/phac-nml/irida/commit/a5aef4cb6b9421876f84f9c0087c28d4e28a98a2", "committedDate": "2020-09-28T16:51:13Z", "message": "Updated CHANGELOG.md with new relaease changes related to SISTRViewer results rendering"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9085c49c621ab094acc6f7424290b313974aa5b7", "author": {"user": {"login": "kbessonov1984", "name": "Kirill Bessonov"}}, "url": "https://github.com/phac-nml/irida/commit/9085c49c621ab094acc6f7424290b313974aa5b7", "committedDate": "2020-09-28T18:24:23Z", "message": "Merge branch 'development' into sistr-viewer-fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0OTYwNjU0", "url": "https://github.com/phac-nml/irida/pull/806#pullrequestreview-494960654", "createdAt": "2020-09-23T18:58:16Z", "commit": {"oid": "9f199afd845c483dd2f6cd161c5bfe14e0d90bdf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxODo1ODoxNlrOHW8tVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNzo0MDowMVrOHZI_Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzgyNTM2NQ==", "bodyText": "Do you know what the consequence of changing this is? I ask because it looks like something that impacts all pages in IRIDA (not just the SISTR page).", "url": "https://github.com/phac-nml/irida/pull/806#discussion_r493825365", "createdAt": "2020-09-23T18:58:16Z", "author": {"login": "apetkau"}, "path": "src/main/webapp/WEB-INF/web.xml", "diffHunk": "@@ -1,11 +1,11 @@\n <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n <web-app xmlns=\"http://java.sun.com/xml/ns/javaee\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n \txsi:schemaLocation=\"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd\"\n-\tversion=\"3.0\" metadata-complete=\"true\">\n+\tversion=\"3.0\" metadata-complete=\"false\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f199afd845c483dd2f6cd161c5bfe14e0d90bdf"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA4MzU0Ng==", "bodyText": "Could you fix up formatting around else (add spaces around }else{).", "url": "https://github.com/phac-nml/irida/pull/806#discussion_r496083546", "createdAt": "2020-09-28T16:32:50Z", "author": {"login": "apetkau"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/AnalysisAjaxController.java", "diffHunk": "@@ -750,10 +749,18 @@ public AnalysisSistrResults getSistrAnalysis(@PathVariable Long id) {\n \t\t}\n \t\tAnalysisType analysisType = iridaWorkflow.getWorkflowDescription()\n \t\t\t\t.getAnalysisType();\n-\t\tif (analysisType.equals(BuiltInAnalysisTypes.SISTR_TYPING)) {\n+\t\tif (analysisTypesService.getViewerForAnalysisType(analysisType).get().equals(\"sistr\")) {\n \t\t\tAnalysis analysis = submission.getAnalysis();\n-\t\t\tPath path = analysis.getAnalysisOutputFile(sistrFileKey)\n-\t\t\t\t\t.getFile();\n+\n+\t\t\tPath path = null;\n+\t\t\tif(analysis.getAnalysisOutputFile(sistrFileKey) != null) {\n+\t\t\t\tpath = analysis.getAnalysisOutputFile(sistrFileKey).getFile();\n+\t\t\t}else{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de06006aaf6f9e26457fe500b1752889bf414bed"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjExOTY0MQ==", "bodyText": "Could you move the entire try-catch block below into this if statement? Since it only applies if there is a SISTR results file available.\nWith the try-catch outside of the if-statement then, if no SISTR output file is found the IRIDA UI won't display anything for the output page.", "url": "https://github.com/phac-nml/irida/pull/806#discussion_r496119641", "createdAt": "2020-09-28T17:32:34Z", "author": {"login": "apetkau"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/AnalysisAjaxController.java", "diffHunk": "@@ -750,10 +749,18 @@ public AnalysisSistrResults getSistrAnalysis(@PathVariable Long id) {\n \t\t}\n \t\tAnalysisType analysisType = iridaWorkflow.getWorkflowDescription()\n \t\t\t\t.getAnalysisType();\n-\t\tif (analysisType.equals(BuiltInAnalysisTypes.SISTR_TYPING)) {\n+\t\tif (analysisTypesService.getViewerForAnalysisType(analysisType).get().equals(\"sistr\")) {\n \t\t\tAnalysis analysis = submission.getAnalysis();\n-\t\t\tPath path = analysis.getAnalysisOutputFile(sistrFileKey)\n-\t\t\t\t\t.getFile();\n+\n+\t\t\tPath path = null;\n+\t\t\tif(analysis.getAnalysisOutputFile(sistrFileKey) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5aef4cb6b9421876f84f9c0087c28d4e28a98a2"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjEyMzcxOQ==", "bodyText": "Could you add a space after the final period \".\" here?", "url": "https://github.com/phac-nml/irida/pull/806#discussion_r496123719", "createdAt": "2020-09-28T17:40:01Z", "author": {"login": "apetkau"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/AnalysisAjaxController.java", "diffHunk": "@@ -750,10 +749,18 @@ public AnalysisSistrResults getSistrAnalysis(@PathVariable Long id) {\n \t\t}\n \t\tAnalysisType analysisType = iridaWorkflow.getWorkflowDescription()\n \t\t\t\t.getAnalysisType();\n-\t\tif (analysisType.equals(BuiltInAnalysisTypes.SISTR_TYPING)) {\n+\t\tif (analysisTypesService.getViewerForAnalysisType(analysisType).get().equals(\"sistr\")) {\n \t\t\tAnalysis analysis = submission.getAnalysis();\n-\t\t\tPath path = analysis.getAnalysisOutputFile(sistrFileKey)\n-\t\t\t\t\t.getFile();\n+\n+\t\t\tPath path = null;\n+\t\t\tif(analysis.getAnalysisOutputFile(sistrFileKey) != null) {\n+\t\t\t\tpath = analysis.getAnalysisOutputFile(sistrFileKey).getFile();\n+\t\t\t}else{\n+\t\t\t\tlogger.error(\"Null response from analysis.getAnalysisOutputFile(sistrFileKey). \" +\n+\t\t\t\t\t\t\"No output file was found for the default sistrFileKey \\\"\"+sistrFileKey + \"\\\".\"+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5aef4cb6b9421876f84f9c0087c28d4e28a98a2"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1260bbcdd7d9b5d6db61120508228f185bbb4b3", "author": {"user": {"login": "kbessonov1984", "name": "Kirill Bessonov"}}, "url": "https://github.com/phac-nml/irida/commit/b1260bbcdd7d9b5d6db61120508228f185bbb4b3", "committedDate": "2020-09-28T20:05:53Z", "message": "Had made changes in pom.xml and cosmetic code appearance changes in AnalysisAjaxController.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NDk0MTY2", "url": "https://github.com/phac-nml/irida/pull/806#pullrequestreview-498494166", "createdAt": "2020-09-29T13:53:11Z", "commit": {"oid": "b1260bbcdd7d9b5d6db61120508228f185bbb4b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NDkxNTQ0", "url": "https://github.com/phac-nml/irida/pull/806#pullrequestreview-499491544", "createdAt": "2020-09-30T14:27:30Z", "commit": {"oid": "b1260bbcdd7d9b5d6db61120508228f185bbb4b3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDoyNzozMFrOHagTvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNDo1MTo0MFrOHahflg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1NDM2Ng==", "bodyText": "Comment for this function please.", "url": "https://github.com/phac-nml/irida/pull/806#discussion_r497554366", "createdAt": "2020-09-30T14:27:30Z", "author": {"login": "tom114"}, "path": "src/main/webapp/resources/js/pages/analysis/components/sistr/CgMlst.jsx", "diffHunk": "@@ -25,19 +25,33 @@ export default function CgMlst({ sistrResults }) {\n       {\n         title: i18n(\"AnalysisSistr.percentMatching\"),\n         desc:\n-          sistrResults.cgmlst_distance !== null\n-            ? `${getPercentage(sistrResults.cgmlst_distance) + \"\"}%`\n-            : \"\"\n+            sistrResults.cgmlst_distance !== null\n+                ? `${getPercentageFromDistance(sistrResults.cgmlst_distance) + \"\"}%`\n+                : \"-\"\n+      },\n+      {\n+        title: i18n(\"AnalysisSistr.allelesFoundGenome\"),\n+        desc: sistrResults.cgmlst_found_loci !== null\n+          ? `${sistrResults.cgmlst_found_loci}/330` + \"\" : \"-\"\n+      },\n+      {\n+        title: i18n(\"AnalysisSistr.allelesFoundGenomePercent\"),\n+        desc: sistrResults.cgmlst_found_loci !== null\n+            ? `${getPercentage(sistrResults.cgmlst_found_loci)+\"\"}%` + \"\" : \"-\"\n       },\n       {\n         title: i18n(\"AnalysisSistr.cgmlstSequenceType\"),\n-        desc: sistrResults.cgmlst_ST !== null ? sistrResults.cgmlst_ST + \"\" : \"\"\n+        desc: sistrResults.cgmlst_ST !== null ? sistrResults.cgmlst_ST + \"\" : \"-\"\n       }\n     ];\n   }\n \n+  function getPercentageFromDistance(str) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1260bbcdd7d9b5d6db61120508228f185bbb4b3"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU3Mjg4NQ==", "bodyText": "I see the 330 magic number around in this file a few times.  Can that get changed to a defined variable at the top of the file or something instead of just 330?", "url": "https://github.com/phac-nml/irida/pull/806#discussion_r497572885", "createdAt": "2020-09-30T14:50:31Z", "author": {"login": "tom114"}, "path": "src/main/webapp/resources/js/pages/analysis/components/sistr/CgMlst.jsx", "diffHunk": "@@ -25,19 +25,33 @@ export default function CgMlst({ sistrResults }) {\n       {\n         title: i18n(\"AnalysisSistr.percentMatching\"),\n         desc:\n-          sistrResults.cgmlst_distance !== null\n-            ? `${getPercentage(sistrResults.cgmlst_distance) + \"\"}%`\n-            : \"\"\n+            sistrResults.cgmlst_distance !== null\n+                ? `${getPercentageFromDistance(sistrResults.cgmlst_distance) + \"\"}%`\n+                : \"-\"\n+      },\n+      {\n+        title: i18n(\"AnalysisSistr.allelesFoundGenome\"),\n+        desc: sistrResults.cgmlst_found_loci !== null\n+          ? `${sistrResults.cgmlst_found_loci}/330` + \"\" : \"-\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1260bbcdd7d9b5d6db61120508228f185bbb4b3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU3Mzc4Mg==", "bodyText": "Same here with the 330.  Also comment on this function please since it's actually doing something specific with the 330.", "url": "https://github.com/phac-nml/irida/pull/806#discussion_r497573782", "createdAt": "2020-09-30T14:51:40Z", "author": {"login": "tom114"}, "path": "src/main/webapp/resources/js/pages/analysis/components/sistr/CgMlst.jsx", "diffHunk": "@@ -25,19 +25,33 @@ export default function CgMlst({ sistrResults }) {\n       {\n         title: i18n(\"AnalysisSistr.percentMatching\"),\n         desc:\n-          sistrResults.cgmlst_distance !== null\n-            ? `${getPercentage(sistrResults.cgmlst_distance) + \"\"}%`\n-            : \"\"\n+            sistrResults.cgmlst_distance !== null\n+                ? `${getPercentageFromDistance(sistrResults.cgmlst_distance) + \"\"}%`\n+                : \"-\"\n+      },\n+      {\n+        title: i18n(\"AnalysisSistr.allelesFoundGenome\"),\n+        desc: sistrResults.cgmlst_found_loci !== null\n+          ? `${sistrResults.cgmlst_found_loci}/330` + \"\" : \"-\"\n+      },\n+      {\n+        title: i18n(\"AnalysisSistr.allelesFoundGenomePercent\"),\n+        desc: sistrResults.cgmlst_found_loci !== null\n+            ? `${getPercentage(sistrResults.cgmlst_found_loci)+\"\"}%` + \"\" : \"-\"\n       },\n       {\n         title: i18n(\"AnalysisSistr.cgmlstSequenceType\"),\n-        desc: sistrResults.cgmlst_ST !== null ? sistrResults.cgmlst_ST + \"\" : \"\"\n+        desc: sistrResults.cgmlst_ST !== null ? sistrResults.cgmlst_ST + \"\" : \"-\"\n       }\n     ];\n   }\n \n+  function getPercentageFromDistance(str) {\n+    return parseFloat((1 - str) * 100).toFixed(2);\n+  }\n+\n   function getPercentage(str) {\n-    return parseFloat((1 - str) * 100).toFixed(1);\n+    return parseFloat((str / 330) * 100).toFixed(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1260bbcdd7d9b5d6db61120508228f185bbb4b3"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b50639053178970cd24bef9bfb732846e8cee490", "author": {"user": {"login": "kbessonov1984", "name": "Kirill Bessonov"}}, "url": "https://github.com/phac-nml/irida/commit/b50639053178970cd24bef9bfb732846e8cee490", "committedDate": "2020-09-30T19:03:54Z", "message": "Modified CgMLST.jsx with definition of the 330 magic number (now a constant) for easier modifictaion. Commented function getPercentageFromDistance(str) function."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 121, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}