{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyODE5MzQ4", "number": 786, "title": "Auto update analysis progress", "bodyText": "##Description of changes\nWhat did you change in this pull request?  Provide a description of files changed, user interactions changed, etc.  Include how to test your changes.\nUpdated analysis results page to auto update the progression of the analysis.\nRelated issue\nLink to the GitHub issue this pull request addresses using the #issuenum format.  If it completes an issue, use Fixes #issuenum to automatically close the issue.\nChecklist\nThings for the developer to confirm they've done before the PR should be accepted:\n\n CHANGELOG.md (and UPGRADING.md if necessary) updated with information for new change.\n* [ ] Tests added (or description of how to test) for any new features.\n* [ ] User documentation updated for UI or technical changes.", "createdAt": "2020-08-24T22:27:02Z", "url": "https://github.com/phac-nml/irida/pull/786", "merged": true, "mergeCommit": {"oid": "0ace10eaaecb5e6543c43ab5b728d22e7e108cc0"}, "closed": true, "closedAt": "2020-08-25T21:24:09Z", "author": {"login": "deepsidhu85"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCKTg9gH2gAyNDcyODE5MzQ4OmMxOTg3YjBlODM4ODk3ZDY5N2IwMzMzZjQyNDcxMDcwOTJiZWIyOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCczoKgFqTQ3NDgwODE4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c1987b0e838897d697b0333f4247107092beb292", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/c1987b0e838897d697b0333f4247107092beb292", "committedDate": "2020-08-24T22:25:27Z", "message": "Updated analysis results page to auto update the progression of the analysis using polling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad227bb2e037c54e6e4f16e7cda701b6d2c65651", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/ad227bb2e037c54e6e4f16e7cda701b6d2c65651", "committedDate": "2020-08-24T22:28:36Z", "message": "Removed unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NTA1OTA3", "url": "https://github.com/phac-nml/irida/pull/786#pullrequestreview-474505907", "createdAt": "2020-08-25T13:55:38Z", "commit": {"oid": "ad227bb2e037c54e6e4f16e7cda701b6d2c65651"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzo1NTozOFrOHGZSpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMzo1NTozOFrOHGZSpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ2Nzg3OA==", "bodyText": "I am wondering if we should not make this into a React hook (the polling portion) or if there is an existing one we can use. \u00a0This seems like common logic.", "url": "https://github.com/phac-nml/irida/pull/786#discussion_r476467878", "createdAt": "2020-08-25T13:55:38Z", "author": {"login": "joshsadam"}, "path": "src/main/webapp/resources/js/contexts/AnalysisContext.js", "diffHunk": "@@ -44,6 +44,30 @@ const AnalysisContext = React.createContext(initialContext);\n function AnalysisProvider(props) {\n   const [analysisContext, setAnalysisContext] = useState(initialContext);\n \n+  // Update the analysis details that\n+  // are required to display the progression\n+  // using polling\n+  useEffect(() => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad227bb2e037c54e6e4f16e7cda701b6d2c65651"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a48aa588b48496b26293670142239f3ee580ef13", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/a48aa588b48496b26293670142239f3ee580ef13", "committedDate": "2020-08-25T16:22:38Z", "message": "Updated AnalysisContext to use custom useInterval hook for polling. Updated useInterval hook to return an id which can be used to clear an interval rather than waiting for a component to unmount"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NzIzMjgz", "url": "https://github.com/phac-nml/irida/pull/786#pullrequestreview-474723283", "createdAt": "2020-08-25T17:56:56Z", "commit": {"oid": "ad227bb2e037c54e6e4f16e7cda701b6d2c65651"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzo1Njo1NlrOHGjjFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzo1Njo1NlrOHGjjFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYzNTkyNg==", "bodyText": "This is happening even if nothing changes? \u00a0 Shouldn't you do a check first to see if an update is needed?", "url": "https://github.com/phac-nml/irida/pull/786#discussion_r476635926", "createdAt": "2020-08-25T17:56:56Z", "author": {"login": "joshsadam"}, "path": "src/main/webapp/resources/js/contexts/AnalysisContext.js", "diffHunk": "@@ -44,6 +44,30 @@ const AnalysisContext = React.createContext(initialContext);\n function AnalysisProvider(props) {\n   const [analysisContext, setAnalysisContext] = useState(initialContext);\n \n+  // Update the analysis details that\n+  // are required to display the progression\n+  // using polling\n+  useEffect(() => {\n+      const interval = setInterval(() => {\n+        getUpdatedDetails(analysisContext.analysis.identifier).then(res => {\n+          setAnalysisContext(analysisContext => {\n+            return {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad227bb2e037c54e6e4f16e7cda701b6d2c65651"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NzU5NzAz", "url": "https://github.com/phac-nml/irida/pull/786#pullrequestreview-474759703", "createdAt": "2020-08-25T18:49:06Z", "commit": {"oid": "ad227bb2e037c54e6e4f16e7cda701b6d2c65651"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxODo0OTowNlrOHGlTUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxODo0OTowNlrOHGlTUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2NDY1OA==", "bodyText": "You should catch an error thrown from the server. \u00a0Stop the polling and show a notice to the user that \"something\" went wrong.", "url": "https://github.com/phac-nml/irida/pull/786#discussion_r476664658", "createdAt": "2020-08-25T18:49:06Z", "author": {"login": "joshsadam"}, "path": "src/main/webapp/resources/js/contexts/AnalysisContext.js", "diffHunk": "@@ -44,6 +44,30 @@ const AnalysisContext = React.createContext(initialContext);\n function AnalysisProvider(props) {\n   const [analysisContext, setAnalysisContext] = useState(initialContext);\n \n+  // Update the analysis details that\n+  // are required to display the progression\n+  // using polling\n+  useEffect(() => {\n+      const interval = setInterval(() => {\n+        getUpdatedDetails(analysisContext.analysis.identifier).then(res => {\n+          setAnalysisContext(analysisContext => {\n+            return {\n+              ...analysisContext,\n+              analysisState: res.analysisState,\n+              isCompleted: res.analysisState === \"COMPLETED\",\n+              isError: res.analysisState.includes(\"ERROR\"),\n+              previousState: res.previousState,\n+              duration: res.duration\n+            };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad227bb2e037c54e6e4f16e7cda701b6d2c65651"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NzYwMjQx", "url": "https://github.com/phac-nml/irida/pull/786#pullrequestreview-474760241", "createdAt": "2020-08-25T18:49:53Z", "commit": {"oid": "ad227bb2e037c54e6e4f16e7cda701b6d2c65651"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxODo0OTo1M1rOHGlVHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxODo0OTo1M1rOHGlVHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2NTExNw==", "bodyText": "Wrap this in a ResponseEntity so you can return an error state if you need to.", "url": "https://github.com/phac-nml/irida/pull/786#discussion_r476665117", "createdAt": "2020-08-25T18:49:53Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/AnalysisAjaxController.java", "diffHunk": "@@ -1148,6 +1149,36 @@ public AnalysisProvenanceResponse getProvenanceByFile(@PathVariable Long submiss\n \t\treturn analysisProvenance;\n \t}\n \n+\t/**\n+\t * Get the updated state and duration of an analysis\n+\t *\n+\t * @param submissionId The analysis submission id\n+\t * @return dto which contains the updated analysis state and duration\n+\t */\n+\t@RequestMapping(value = \"/{submissionId}/updated-progress\")\n+\t@ResponseBody\n+\tpublic UpdatedAnalysisProgress getProvenanceByFile(@PathVariable Long submissionId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad227bb2e037c54e6e4f16e7cda701b6d2c65651"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NzYwODE4", "url": "https://github.com/phac-nml/irida/pull/786#pullrequestreview-474760818", "createdAt": "2020-08-25T18:50:44Z", "commit": {"oid": "ad227bb2e037c54e6e4f16e7cda701b6d2c65651"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxODo1MDo0NFrOHGlXFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxODo1MDo0NFrOHGlXFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY2NTYyMA==", "bodyText": "Because this is a RestController you don't have to annotate methods with ResponseBody", "url": "https://github.com/phac-nml/irida/pull/786#discussion_r476665620", "createdAt": "2020-08-25T18:50:44Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/ria/web/analysis/AnalysisAjaxController.java", "diffHunk": "@@ -1148,6 +1149,36 @@ public AnalysisProvenanceResponse getProvenanceByFile(@PathVariable Long submiss\n \t\treturn analysisProvenance;\n \t}\n \n+\t/**\n+\t * Get the updated state and duration of an analysis\n+\t *\n+\t * @param submissionId The analysis submission id\n+\t * @return dto which contains the updated analysis state and duration\n+\t */\n+\t@RequestMapping(value = \"/{submissionId}/updated-progress\")\n+\t@ResponseBody", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad227bb2e037c54e6e4f16e7cda701b6d2c65651"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c64a856128d212fdda1bcab36dbf56b78cef8399", "author": {"user": {"login": "deepsidhu85", "name": null}}, "url": "https://github.com/phac-nml/irida/commit/c64a856128d212fdda1bcab36dbf56b78cef8399", "committedDate": "2020-08-25T19:47:58Z", "message": "Updated useInterval in AnalysisContext to only update state and/or duration values if they have changed and to catch any server errors. Updated docs. Removed @ResponseBody annotation as the AnalysisAjaxController is a RESTController. Wrapped return value of getUpdatedProgress in a ResponseEntity."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0ODA4MTgw", "url": "https://github.com/phac-nml/irida/pull/786#pullrequestreview-474808180", "createdAt": "2020-08-25T19:58:49Z", "commit": {"oid": "c64a856128d212fdda1bcab36dbf56b78cef8399"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 87, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}