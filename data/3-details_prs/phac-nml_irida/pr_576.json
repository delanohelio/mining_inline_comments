{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1OTU4MzIw", "number": 576, "title": "Metadata entry reformat", "bodyText": "Description of changes\nReformatted the metadata classes and database tables to provide a more stable structure.  This will help improve performance and future development on the metadata system and help Hibernate do a better job of managing the entities and Envers of managing the audit records.\nThe big part here is removing the sample_metadata_entry table and moving its relationships into the metadata_entry table.  This will help reduce redundancy and reduce duplication in the database.\nThis also involved changes to how metadata is accessed.  Everything comes through the service layer now instead of reading/saving directly to the Sample, similar to how the \"Join\" classes are modelled.\nRelated issue\nN/A\nChecklist\nThings for the developer to confirm they've done before the PR should be accepted:\n\n CHANGELOG.md (and UPGRADING.md if necessary) updated with information for new change.\n Tests added (or description of how to test) for any new features.\n User documentation updated for UI or technical changes.", "createdAt": "2020-01-22T16:50:29Z", "url": "https://github.com/phac-nml/irida/pull/576", "merged": true, "mergeCommit": {"oid": "16cf960eaf49319c139180ce702e07910c4542aa"}, "closed": true, "closedAt": "2020-12-29T16:48:33Z", "author": {"login": "tom114"}, "timelineItems": {"totalCount": 97, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABbzNt1pAH2gAyMzY1OTU4MzIwOjU0MDRiZDhlYTQ5ZjcyMjVmNDhmMDViMGFkOTY0MjhhYTQ3ZDJkYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdq8COFgH2gAyMzY1OTU4MzIwOmIyYzY3MGQ3ZWY2MTZiNTc1OWU3NTViZWZkZWVlMDM4YjI4MWU0ZDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5404bd8ea49f7225f48f05b0ad96428aa47d2db5", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/5404bd8ea49f7225f48f05b0ad96428aa47d2db5", "committedDate": "2019-12-23T15:43:54Z", "message": "pulling some files from another branch. this changes the format of the metadata from a map on the sample to a list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d9f864bb88d977b94a47d1f7f5e617b0fc80eee", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/9d9f864bb88d977b94a47d1f7f5e617b0fc80eee", "committedDate": "2019-12-23T18:28:54Z", "message": "got rid of most uses of mergeMetadata with the map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9203547ba1b0cf0cdda5f6fa47da35a6731a9235", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/9203547ba1b0cf0cdda5f6fa47da35a6731a9235", "committedDate": "2019-12-23T20:44:20Z", "message": "setting sample on entry before saving"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "208eb25deeef5a2a05cc30888afb66823df8c181", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/208eb25deeef5a2a05cc30888afb66823df8c181", "committedDate": "2019-12-23T21:38:19Z", "message": "changing sample details page to use metadta set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fab45a823bbc04eacbe2776f3f2de9435b15af77", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/fab45a823bbc04eacbe2776f3f2de9435b15af77", "committedDate": "2019-12-23T21:39:53Z", "message": "updating project sync service to use new metadata functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cdf2cb8c707483cceb99b65ab2e79719adb59d3", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/9cdf2cb8c707483cceb99b65ab2e79719adb59d3", "committedDate": "2019-12-24T14:48:21Z", "message": "rid of all refs to the metadata map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6e6dfac9f5c2d4342d405080ae0105dd55ccb04", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/f6e6dfac9f5c2d4342d405080ae0105dd55ccb04", "committedDate": "2019-12-24T16:16:32Z", "message": "removed refs to metadata map from the services and updaters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ef68c5e799a46be5d0c233ecd86d7815c5fc7c8", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/4ef68c5e799a46be5d0c233ecd86d7815c5fc7c8", "committedDate": "2019-12-24T16:47:47Z", "message": "fixed doc build errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23e28c886db3874f7ee2793df60aa591d7fcc8da", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/23e28c886db3874f7ee2793df60aa591d7fcc8da", "committedDate": "2019-12-24T16:51:00Z", "message": "added mock to sample test to read sample"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e07e39a88a2fcce5fcb880d75532ad155b738b5", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/7e07e39a88a2fcce5fcb880d75532ad155b738b5", "committedDate": "2019-12-30T15:45:02Z", "message": "fixed javadoc errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dade727e22831415533b781a5f82e4996d03dae6", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/dade727e22831415533b781a5f82e4996d03dae6", "committedDate": "2019-12-30T16:07:12Z", "message": "changing all testing entries to the new format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb1807fb0ebefe61f0d3bf2050bc075c4d27260d", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/eb1807fb0ebefe61f0d3bf2050bc075c4d27260d", "committedDate": "2019-12-30T16:41:58Z", "message": "removed unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa50330154e1a86ad719ba279b57079927ad1890", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/aa50330154e1a86ad719ba279b57079927ad1890", "committedDate": "2019-12-30T19:12:42Z", "message": "adding notnulls to metadataentry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76afa7bc88858708bbd5210eb309f2a093ae55d0", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/76afa7bc88858708bbd5210eb309f2a093ae55d0", "committedDate": "2019-12-30T21:41:00Z", "message": "fixed integrity issues in test data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "448b7f126898933d11fde77d2bdc5a845372d457", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/448b7f126898933d11fde77d2bdc5a845372d457", "committedDate": "2020-01-03T19:53:50Z", "message": "updating metadata refactor with more audit records"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e187ee11b1370ce660ec29a93654e5643c4a33b", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/0e187ee11b1370ce660ec29a93654e5643c4a33b", "committedDate": "2020-01-06T17:40:27Z", "message": "moved most sample update ops off the sample and into a service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa8f7e37d3569ee63d15674c301bc4c36f80b659", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/fa8f7e37d3569ee63d15674c301bc4c36f80b659", "committedDate": "2020-01-07T19:38:55Z", "message": "moving sample metadata saving ops to the service instead of on sample itself"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2853a69978505589eabf40701b46821823e5f7fc", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/2853a69978505589eabf40701b46821823e5f7fc", "committedDate": "2020-01-07T19:39:16Z", "message": "using the new objects for getting a sample's metadata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55802c4983d913cf7d8c021d2c04ebbabd12d460", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/55802c4983d913cf7d8c021d2c04ebbabd12d460", "committedDate": "2020-01-08T16:30:35Z", "message": "moved merge metadata tests to sampleservice"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1be6aa5ee8d04575b45362e53b63c43f2a3ecc18", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/1be6aa5ee8d04575b45362e53b63c43f2a3ecc18", "committedDate": "2020-01-08T16:56:43Z", "message": "fixing mock errors with project sync test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35874b27d9b795f54fd43601429f5de7f94f03fd", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/35874b27d9b795f54fd43601429f5de7f94f03fd", "committedDate": "2020-01-08T17:42:23Z", "message": "all unit tests working with new sample updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7922c2f8a4d356b48c5269e744feb191d0c12753", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/7922c2f8a4d356b48c5269e744feb191d0c12753", "committedDate": "2020-01-08T20:03:51Z", "message": "removed metadata from hashcode on sample to avoid lazyinitialization error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ddf975255186de78eeba4ed7e13ba4d9cdac14a", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/1ddf975255186de78eeba4ed7e13ba4d9cdac14a", "committedDate": "2020-01-08T21:01:08Z", "message": "updated javadoc errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d82663139a60818b8b62c9daab71bb9eeea3f03b", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/d82663139a60818b8b62c9daab71bb9eeea3f03b", "committedDate": "2020-01-09T21:23:21Z", "message": "updated liquibase with comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e746bec04762cf50a1d5da14bc03fee79b9c5578", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/e746bec04762cf50a1d5da14bc03fee79b9c5578", "committedDate": "2020-01-10T17:19:42Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48d3b8ca28f8cbfc51e78b84196b8ed8eb611fd7", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/48d3b8ca28f8cbfc51e78b84196b8ed8eb611fd7", "committedDate": "2020-01-10T17:38:32Z", "message": "removing unnecessary constructor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0f5f849a2cc21b46313c5c99b9cbef959971b69", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/a0f5f849a2cc21b46313c5c99b9cbef959971b69", "committedDate": "2020-01-10T18:00:11Z", "message": "removed commented out code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba7964a2d8bbbf12b647b7a54b0b35ff4e4e34a0", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/ba7964a2d8bbbf12b647b7a54b0b35ff4e4e34a0", "committedDate": "2020-01-10T19:02:31Z", "message": "removed unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7e223f46e49a350e013ec0770ffc8c76b2a8c6d", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/b7e223f46e49a350e013ec0770ffc8c76b2a8c6d", "committedDate": "2020-01-14T15:41:03Z", "message": "rolled sync sched task back to dev.  it was mistakenly pushed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bc24075f72b79f62cb324a551f7d9d0ac188874", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/8bc24075f72b79f62cb324a551f7d9d0ac188874", "committedDate": "2020-01-16T21:17:54Z", "message": "fixed formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feaa883dc7ff8b33e58b37bdddd5a518e4b533cd", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/feaa883dc7ff8b33e58b37bdddd5a518e4b533cd", "committedDate": "2020-01-20T20:06:29Z", "message": "added docs for metadata upgrade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7da32bf64f43bfc72a4e53088ce45db78e74ed5b", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/7da32bf64f43bfc72a4e53088ce45db78e74ed5b", "committedDate": "2020-01-20T20:11:13Z", "message": "added script to generate metadata mappings for backup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21025871ee0ec941fc5c1bc9ef85d65d450327d4", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/21025871ee0ec941fc5c1bc9ef85d65d450327d4", "committedDate": "2020-01-20T20:12:57Z", "message": "added changelog entry for metadata updaes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "918df31c06629f17764c2eb8a771d307331ccc57", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/918df31c06629f17764c2eb8a771d307331ccc57", "committedDate": "2020-01-22T16:51:03Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NzQ0NDE5", "url": "https://github.com/phac-nml/irida/pull/576#pullrequestreview-346744419", "createdAt": "2020-01-22T16:52:57Z", "commit": {"oid": "918df31c06629f17764c2eb8a771d307331ccc57"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNjo1Mjo1N1rOFgjeDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNjo1Mjo1N1rOFgjeDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY3OTg4NA==", "bodyText": "You deleted this but did not move it up.  Be easier to merge later if you move it I think.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r369679884", "createdAt": "2020-01-22T16:52:57Z", "author": {"login": "joshsadam"}, "path": "CHANGELOG.md", "diffHunk": "@@ -122,7 +123,6 @@ Changes\n * [UI]: Fixed bug causing issues with saving Line List templates.\n * [UI]: Fixed bug when selecting all samples on the project samples page would not add them to cart.\n * [Developer]: Updated to latest version of NodeJS LTS (12.13.0) and Yarn (v1.19.1).\n-* [UI]: Add analyses queued and running counts to analyses listing pages, cart page, and pipeline launch page.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "918df31c06629f17764c2eb8a771d307331ccc57"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e28ce62bf01dc38f961f0889ef325b4a76747d95", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/e28ce62bf01dc38f961f0889ef325b4a76747d95", "committedDate": "2020-01-22T21:08:21Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NzQ4NjMx", "url": "https://github.com/phac-nml/irida/pull/576#pullrequestreview-346748631", "createdAt": "2020-01-22T16:58:19Z", "commit": {"oid": "918df31c06629f17764c2eb8a771d307331ccc57"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNjo1ODoyMFrOFgjqmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNzozMjo1M1rOFgkxpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4MzA5Ng==", "bodyText": "Too many helps in this sentence.  Try:\nThe intent of this update is to simplify the relationship between samples and metadata records to help with database performance and future developments.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r369683096", "createdAt": "2020-01-22T16:58:20Z", "author": {"login": "joshsadam"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -40,14 +41,93 @@ Note that if this process is not completed correctly for a Remote API, data will\n \n See the section under \"authorization code\" in our documentation for more details about entering the redirect URI at <https://irida.corefacility.ca/documentation/user/administrator/#grant-types>.\n \n-## Updating Galaxy importer clients\n+### Updating Galaxy importer clients\n+{:.no_toc}\n \n Clients for the [Galaxy IRIDA importer](https://github.com/phac-nml/irida-galaxy-importer) must undergo a similar process, but with slightly different values.  The Galaxy importer targets your local IRIDA installation so the redirect URL points at your own IRIDA.  Redirect URLs for Galaxy will be the following:\n \n Your IRIDA server URL + `/galaxy/auth_code`.  Ex: `http://irida.ca/irida/galaxy/auth_code`.\n \n To test this change, try importing some data from Galaxy.  If it works, you've updated everything correctly!\n \n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to help simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "918df31c06629f17764c2eb8a771d307331ccc57"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTcwMTI4Ng==", "bodyText": "Check if orphanRemoval is needed.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r369701286", "createdAt": "2020-01-22T17:32:53Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/model/sample/MetadataTemplateField.java", "diffHunk": "@@ -34,6 +30,9 @@\n \t@NotNull\n \tprivate String type;\n \n+\t@OneToMany(mappedBy = \"field\", orphanRemoval = true, cascade = CascadeType.ALL)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "918df31c06629f17764c2eb8a771d307331ccc57"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NjA1ODQz", "url": "https://github.com/phac-nml/irida/pull/576#pullrequestreview-347605843", "createdAt": "2020-01-23T21:04:49Z", "commit": {"oid": "e28ce62bf01dc38f961f0889ef325b4a76747d95"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMTowNDo0OVrOFhMkvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMTowNDo0OVrOFhMkvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM1MzM0MQ==", "bodyText": "Can we update this method to be something like convertStringToMetadataMap or something?", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r370353341", "createdAt": "2020-01-23T21:04:49Z", "author": {"login": "joshsadam"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/service/impl/sample/MetadataTemplateServiceImpl.java", "diffHunk": "@@ -145,24 +143,32 @@ public MetadataTemplateField saveMetadataField(MetadataTemplateField field) {\n \t\treturn fieldRepository.findAllMetadataFieldsByLabelQuery(query);\n \t}\n \n+\t/**\n+\t * {@inheritDoc}\n+\t */\n \t@Override\n \t@Transactional\n \t@PreAuthorize(\"permitAll()\")\n-\tpublic Map<MetadataTemplateField, MetadataEntry> getMetadataMap(Map<String, MetadataEntry> metadataMap) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e28ce62bf01dc38f961f0889ef325b4a76747d95"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87f6f5ef5ae5b19a580993f75925b68afab5821b", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/87f6f5ef5ae5b19a580993f75925b68afab5821b", "committedDate": "2020-01-24T14:59:14Z", "message": "reworded metadata doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c7154750e1a8fd5c4e26cbe7594c1dee7c13bb1", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/4c7154750e1a8fd5c4e26cbe7594c1dee7c13bb1", "committedDate": "2020-01-24T15:00:28Z", "message": "renamed metadataset method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/49437e37e94e3e8577b3bcba059c2efcc6cffd83", "committedDate": "2020-01-24T15:01:01Z", "message": "removed orphanremoval from metadatafield since we can't modify that set anyway"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MzM3MTkz", "url": "https://github.com/phac-nml/irida/pull/576#pullrequestreview-348337193", "createdAt": "2020-01-25T17:54:30Z", "commit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNVQxNzo1NDozMFrOFhwx_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQyMzozNTozMlrOFh2VAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDk0NjU1OQ==", "bodyText": "Perhaps not so important, but I think it would be useful to also include the examples from the table above here too. That is, for sample include at the end (ex: \"sample1\") and so on. I like how that was done for the descriptions of the tables above.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r370946559", "createdAt": "2020-01-25T17:54:30Z", "author": {"login": "apetkau"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -40,14 +41,93 @@ Note that if this process is not completed correctly for a Remote API, data will\n \n See the section under \"authorization code\" in our documentation for more details about entering the redirect URI at <https://irida.corefacility.ca/documentation/user/administrator/#grant-types>.\n \n-## Updating Galaxy importer clients\n+### Updating Galaxy importer clients\n+{:.no_toc}\n \n Clients for the [Galaxy IRIDA importer](https://github.com/phac-nml/irida-galaxy-importer) must undergo a similar process, but with slightly different values.  The Galaxy importer targets your local IRIDA installation so the redirect URL points at your own IRIDA.  Redirect URLs for Galaxy will be the following:\n \n Your IRIDA server URL + `/galaxy/auth_code`.  Ex: `http://irida.ca/irida/galaxy/auth_code`.\n \n To test this change, try importing some data from Galaxy.  If it works, you've updated everything correctly!\n \n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |\n+\n+The tables involved are the following:\n+\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list (ex: \"Salmonella\").\n+* `sample_metadata_entry` - The relationship between the above 3 tables (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+In addition to the above, there is a matching `_AUD` (audit) table for each of these tables which captures any changes to the data and the user & time which the change occurred.  This auditing is managed by [Hibernate Envers](https://hibernate.org/orm/envers/).\n+\n+In general data will be populated into these tables in the following order:\n+\n+1. `sample` entry is created as sequencing data is uploaded,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAzNTQ0NQ==", "bodyText": "We are likely going to have to give people instructions on how to make these changes in all the IRIDA plugins as well. See my main comment in the general comments section.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r371035445", "createdAt": "2020-01-26T22:54:43Z", "author": {"login": "apetkau"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/pipeline/results/updater/impl/BioHanselSampleUpdater.java", "diffHunk": "@@ -108,11 +105,11 @@ public void update(Collection<Sample> samples, AnalysisSubmission analysis) thro\n \t\t\t\t\t\t\t\t+ \"'. Please check the format of this file!\");\n \t\t\t\t\t}\n \t\t\t\t});\n-\t\t\t\tMap<MetadataTemplateField, MetadataEntry> metadataMap = metadataTemplateService.getMetadataMap(\n-\t\t\t\t\t\tstringEntries);\n \n-\t\t\t\tsample.mergeMetadata(metadataMap);\n-\t\t\t\tsampleService.updateFields(sample.getId(), ImmutableMap.of(\"metadata\", sample.getMetadata()));\n+\t\t\t\tSet<MetadataEntry> metadataSet = metadataTemplateService.convertMetadataStringsToSet(stringEntries);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAzNTU2Mg==", "bodyText": "Just some thoughts, but is it possible this is coming up because we are both syncing metadata AND re-running automated pipelines on synced samples, which may save the same metadata back into the table once it's completed? So, for every synced sample, we get a duplicate metadata entry (one from syncing, one from the automated pipeline)?\nThen, on (perhaps) a subsequent sync, the same metadata gets downloaded and saved (as a new row in the database because it's not pipeline-derived)?\nOr is this something else?", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r371035562", "createdAt": "2020-01-26T22:56:44Z", "author": {"login": "apetkau"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -40,14 +41,93 @@ Note that if this process is not completed correctly for a Remote API, data will\n \n See the section under \"authorization code\" in our documentation for more details about entering the redirect URI at <https://irida.corefacility.ca/documentation/user/administrator/#grant-types>.\n \n-## Updating Galaxy importer clients\n+### Updating Galaxy importer clients\n+{:.no_toc}\n \n Clients for the [Galaxy IRIDA importer](https://github.com/phac-nml/irida-galaxy-importer) must undergo a similar process, but with slightly different values.  The Galaxy importer targets your local IRIDA installation so the redirect URL points at your own IRIDA.  Redirect URLs for Galaxy will be the following:\n \n Your IRIDA server URL + `/galaxy/auth_code`.  Ex: `http://irida.ca/irida/galaxy/auth_code`.\n \n To test this change, try importing some data from Galaxy.  If it works, you've updated everything correctly!\n \n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |\n+\n+The tables involved are the following:\n+\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list (ex: \"Salmonella\").\n+* `sample_metadata_entry` - The relationship between the above 3 tables (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+In addition to the above, there is a matching `_AUD` (audit) table for each of these tables which captures any changes to the data and the user & time which the change occurred.  This auditing is managed by [Hibernate Envers](https://hibernate.org/orm/envers/).\n+\n+In general data will be populated into these tables in the following order:\n+\n+1. `sample` entry is created as sequencing data is uploaded,\n+2. Someone uploads a set of sample metadata, which will first get a `metadata_field`\n+  a. Find an existing `metadata_field` for a column header,\n+  b. Or create a new `metadata_field` for a header,\n+3. `metadata_entry` is created with the appropriate value,\n+4. `sample_metadata_entry` is created linking the above 3 items together.\n+\n+Note items 2, 3, and 4 will generally be done at the same time.  As soon as the metadata values are committed to the database, Envers should create `_AUD` entries for all of the above records.\n+\n+### The problem\n+{:.no_toc}\n+\n+The issue we noticed is that while Envers seemed to create `_AUD` records for all the above tables when metadata is first added to a sample, subsequent updates of those values *may* not create records for the `sample_metadata_entry_AUD` table, though it properly creates records for the `metadata_entry_AUD` and `sample_AUD` tables.  We found this to be most prevalent when data is synchronized from remote IRIDA installations.  Most of these synchronized records were duplicate entries that were saving the same metadata values back to the sample, but creating new rows in the database.  We are still investigating why this issue was occurring.  Due to the complex nature of the above database tables it appears that Envers was failing to properly audit the relationship between those entities/tables.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAzNzQ0Mg==", "bodyText": "I suspect the findFirst() here causes issues where we can have many duplicated entries in our database for metadata fields. See comment in general comments.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r371037442", "createdAt": "2020-01-26T23:35:32Z", "author": {"login": "apetkau"}, "path": "src/main/java/ca/corefacility/bioinformatics/irida/service/impl/sample/SampleServiceImpl.java", "diffHunk": "@@ -172,6 +180,76 @@ public Sample update(Sample object) {\n \t\treturn super.update(object);\n \t}\n \n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@PreAuthorize(\"hasPermission(#sample, 'canReadSample')\")\n+\t@Override\n+\tpublic Set<MetadataEntry> getMetadataForSample(Sample sample) {\n+\t\treturn metadataEntryRepository.getMetadataForSample(sample);\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@PreAuthorize(\"hasPermission(#s, 'canUpdateSample')\")\n+\t@Transactional\n+\tpublic Sample updateSampleMetadata(Sample s, Set<MetadataEntry> metadataToSet) {\n+\t\tSet<MetadataEntry> currentMetadata = getMetadataForSample(s);\n+\n+\t\tmetadataEntryRepository.deleteAll(currentMetadata);\n+\n+\t\tfor(MetadataEntry e : metadataToSet){\n+\t\t\te.setSample(s);\n+\t\t}\n+\n+\t\tmetadataEntryRepository.saveAll(metadataToSet);\n+\n+\t\ts = read(s.getId());\n+\n+\t\treturn s;\n+\t}\n+\n+\t/**\n+\t * {@inheritDoc}\n+\t */\n+\t@PreAuthorize(\"hasPermission(#s, 'canUpdateSample')\")\n+\t@Transactional\n+\tpublic Sample mergeSampleMetadata(Sample s, Set<MetadataEntry> metadataToAdd) {\n+\t\tSet<MetadataEntry> currentMetadata = getMetadataForSample(s);\n+\n+\t\t// loop through entry set and see if it already exists\n+\t\tfor (MetadataEntry newMetadataEntry : metadataToAdd) {\n+\t\t\tMetadataTemplateField field = newMetadataEntry.getField();\n+\t\t\tnewMetadataEntry.setSample(s);\n+\n+\t\t\tOptional<MetadataEntry> metadataEntryForField = currentMetadata.stream()\n+\t\t\t\t\t.filter(e -> e.getField()\n+\t\t\t\t\t\t\t.equals(field))\n+\t\t\t\t\t.findFirst();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49437e37e94e3e8577b3bcba059c2efcc6cffd83"}, "originalPosition": 94}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7baf0759bf4f77a4fe8ed685d76aaff562b46304", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/7baf0759bf4f77a4fe8ed685d76aaff562b46304", "committedDate": "2020-01-27T16:25:19Z", "message": "Doc updates to clarify some metadata issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ff7d554d945d6e108f1ca19c33f20f7024c21c4", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/0ff7d554d945d6e108f1ca19c33f20f7024c21c4", "committedDate": "2020-02-03T20:17:39Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4b4be37e82f76d8ad49a28dd12fdf7e1ed2722a", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/e4b4be37e82f76d8ad49a28dd12fdf7e1ed2722a", "committedDate": "2020-02-03T20:19:12Z", "message": "moving metadata changeset to 20.05"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05d98666c64aec13defe7bc99fc6b71083272ca4", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/05d98666c64aec13defe7bc99fc6b71083272ca4", "committedDate": "2020-02-03T21:11:45Z", "message": "moved upgrade guide info to 20.05 in docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7783205f13f9d70f5f5202125c9d136cfec70c0", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/b7783205f13f9d70f5f5202125c9d136cfec70c0", "committedDate": "2020-02-03T21:24:15Z", "message": "updated plugin version to 1.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45df28fad13ddfa8ae6b4c65f39e58058c3e20e0", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/45df28fad13ddfa8ae6b4c65f39e58058c3e20e0", "committedDate": "2020-02-03T21:54:18Z", "message": "added docs for updating your plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b937b61edcdcfc9030e3e7102106af520cdd491", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/6b937b61edcdcfc9030e3e7102106af520cdd491", "committedDate": "2020-02-03T21:54:35Z", "message": "liquibase changes file added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae1de4c5d9aafd65f0fbd3a757e78fc75e0f00cc", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/ae1de4c5d9aafd65f0fbd3a757e78fc75e0f00cc", "committedDate": "2020-02-04T15:32:26Z", "message": "fixed link to analysis updaters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef7d4102e7f170557ab02d835e3c7ae1abf2b2ef", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/ef7d4102e7f170557ab02d835e3c7ae1abf2b2ef", "committedDate": "2020-02-04T16:36:54Z", "message": "updated plugin framework version in docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "998d29e18743fec3f8854c1f6262343496af363f", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/998d29e18743fec3f8854c1f6262343496af363f", "committedDate": "2020-05-17T02:20:49Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ead89451526a0bee57b6314a7b3864a838010148", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/ead89451526a0bee57b6314a7b3864a838010148", "committedDate": "2020-06-01T14:21:24Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9de975d6c166098cb7b4a6ffa5c1c3246d051f9a", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/9de975d6c166098cb7b4a6ffa5c1c3246d051f9a", "committedDate": "2020-06-01T14:22:05Z", "message": "moved emtadata refactor liquibase to 20.09"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff03381a4ddeebbf363bbeeefd8a72d36fd1d08e", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/ff03381a4ddeebbf363bbeeefd8a72d36fd1d08e", "committedDate": "2020-06-01T15:02:52Z", "message": "Merge branch 'metadata-entry-reformat' into plugin-system-1.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b71f4f66cddc0feee3226d65e6186db32a35e978", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/b71f4f66cddc0feee3226d65e6186db32a35e978", "committedDate": "2020-06-01T15:04:41Z", "message": "moving metadata refactor doc text up to 20.09"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a43958050a87b6cd7135e08ba9a6a043108e988", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/5a43958050a87b6cd7135e08ba9a6a043108e988", "committedDate": "2020-06-01T15:06:23Z", "message": "Merge branch 'metadata-entry-reformat' into plugin-system-1.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2edbfe9118c1da70bf7b8f334216a55c16c8c69c", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/2edbfe9118c1da70bf7b8f334216a55c16c8c69c", "committedDate": "2020-06-01T15:07:48Z", "message": "changed versions to 20.09 in upgrades doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6cefee7817e5de9a0fb8556777f86b492283157", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/e6cefee7817e5de9a0fb8556777f86b492283157", "committedDate": "2020-06-01T15:08:03Z", "message": "Merge branch 'metadata-entry-reformat' into plugin-system-1.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "487067134f1f7bdef53150039ce1e3d72e8ef330", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/487067134f1f7bdef53150039ce1e3d72e8ef330", "committedDate": "2020-06-01T15:13:36Z", "message": "changed plugin version requirements to 20.09"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c123f4d8a1bb810e57b034495fa3ab1294c46e39", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/c123f4d8a1bb810e57b034495fa3ab1294c46e39", "committedDate": "2020-06-04T18:29:29Z", "message": "changing docs to point to 20.09 irida version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97c70f03a9f244d38780e94030ac01e1009ec2c3", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/97c70f03a9f244d38780e94030ac01e1009ec2c3", "committedDate": "2020-06-08T15:05:26Z", "message": "added 20.09 liquibase changes to all changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39a2823113a1991c0e4dc3805c28d991a6466e57", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/39a2823113a1991c0e4dc3805c28d991a6466e57", "committedDate": "2020-06-29T15:06:50Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8708030ef326678b52b06fd629bbf44dfe4a23f8", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/8708030ef326678b52b06fd629bbf44dfe4a23f8", "committedDate": "2020-07-09T18:16:54Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "137612d6c0216c413ff3e30271fe60fb5a68ad6d", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/137612d6c0216c413ff3e30271fe60fb5a68ad6d", "committedDate": "2020-08-27T20:17:35Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "000defa30f2d7a74ba0231c5f1170701b5da9f12", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/000defa30f2d7a74ba0231c5f1170701b5da9f12", "committedDate": "2020-08-27T21:16:55Z", "message": "we must delete the old entry before saving the new collection.  if we\ndon't delete the old entity stays connected"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64f56c53f50a670d12b674c440fa7e449caafdec", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/64f56c53f50a670d12b674c440fa7e449caafdec", "committedDate": "2020-09-02T15:57:05Z", "message": "Merge branch 'metadata-entry-reformat' into plugin-system-1.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7596036432e6e4b1a878e0ffcba0cbc51afa7824", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/7596036432e6e4b1a878e0ffcba0cbc51afa7824", "committedDate": "2020-11-02T21:12:02Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e71acc0b0059c7eb497e4b51d18d1baa4bde7144", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/e71acc0b0059c7eb497e4b51d18d1baa4bde7144", "committedDate": "2020-11-02T21:15:35Z", "message": "changed 20.09 upgrade docs for metadata to 21.01"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcb988daf46e9acbfe2b0310bc328ab1e7bfef56", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/dcb988daf46e9acbfe2b0310bc328ab1e7bfef56", "committedDate": "2020-11-02T21:17:11Z", "message": "changed metadata refactor liquibase to 21.01"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a61c25f51105ee1232031ad4c79627156a7dc04", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/8a61c25f51105ee1232031ad4c79627156a7dc04", "committedDate": "2020-11-02T21:27:09Z", "message": "removed incorrect liquibase mapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8a8dca44089b7cc40cfa099e0bfd78dc40579f6", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/d8a8dca44089b7cc40cfa099e0bfd78dc40579f6", "committedDate": "2020-11-02T21:28:28Z", "message": "Merge branch 'metadata-entry-reformat' into plugin-system-1.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eebe2143efae9f2e7c30eb3ffccd348162639580", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/eebe2143efae9f2e7c30eb3ffccd348162639580", "committedDate": "2020-11-03T14:28:07Z", "message": "missed metadata entry all changes file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3744fd50b291259e6084899a72baa8952f9ab4de", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/3744fd50b291259e6084899a72baa8952f9ab4de", "committedDate": "2020-11-06T20:01:35Z", "message": "updated test to mock a sample update response"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "647efcbbdbc25c864e8f716342940ace61481801", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/647efcbbdbc25c864e8f716342940ace61481801", "committedDate": "2020-11-06T21:24:39Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a5053b4c750896bd223a1e8cbc42e0bc94ad519", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/4a5053b4c750896bd223a1e8cbc42e0bc94ad519", "committedDate": "2020-11-09T14:40:56Z", "message": "Merge branch 'metadata-entry-reformat' into plugin-system-1.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ca62fe0a618ee2817fb6d1f98811597d5ec70fd", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/2ca62fe0a618ee2817fb6d1f98811597d5ec70fd", "committedDate": "2020-11-09T15:14:11Z", "message": "updated plugin update versions to 21.01"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26635c234a6c4a3106fdd865dadfbfcf115ca720", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/26635c234a6c4a3106fdd865dadfbfcf115ca720", "committedDate": "2020-11-09T15:21:10Z", "message": "updated doc pipeline base to 21.01"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b2d40511c2aaf83e56565b91b9f845ac6f2d2fb", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/8b2d40511c2aaf83e56565b91b9f845ac6f2d2fb", "committedDate": "2020-11-09T17:08:02Z", "message": "added info to install 21.01-SNAPSHOT version if working before release"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fd4abe6e2bbbf11cc65861628cc4a59cac2d83a", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/1fd4abe6e2bbbf11cc65861628cc4a59cac2d83a", "committedDate": "2020-11-27T21:19:30Z", "message": "changed wording of a couple plugin system docs lines"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65b5c6c43d3028ab912920933f5ac28e120e05dc", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/65b5c6c43d3028ab912920933f5ac28e120e05dc", "committedDate": "2020-11-30T14:27:36Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "383500536aa31ac0a1aed866dea33f9fdd8b33b5", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/383500536aa31ac0a1aed866dea33f9fdd8b33b5", "committedDate": "2020-11-30T14:28:37Z", "message": "Merge branch 'metadata-entry-reformat' into plugin-system-1.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa050a6679d91d80e9417bdfc5721ec61fd2ebf6", "author": {"user": {"login": "apetkau", "name": "Aaron Petkau"}}, "url": "https://github.com/phac-nml/irida/commit/fa050a6679d91d80e9417bdfc5721ec61fd2ebf6", "committedDate": "2020-11-30T15:39:31Z", "message": "Merge pull request #38 from tom114/plugin-system-1.1\n\nPlugin system 1.1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d458bcacfc2000897a71efb7b349ae26998259cf", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/d458bcacfc2000897a71efb7b349ae26998259cf", "committedDate": "2020-11-30T17:50:25Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77161661d35cefac3b01e2604098551e56509a38", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/77161661d35cefac3b01e2604098551e56509a38", "committedDate": "2020-12-01T16:54:31Z", "message": "reworded some upgrade docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "365e5f1f441e13723850e0b15ebd13d9b8c40f0e", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/365e5f1f441e13723850e0b15ebd13d9b8c40f0e", "committedDate": "2020-12-01T17:01:08Z", "message": "fixed the table rendering to display in the example output of the\nmetadata upgrade report"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNDA5NDM5", "url": "https://github.com/phac-nml/irida/pull/576#pullrequestreview-550409439", "createdAt": "2020-12-11T18:15:30Z", "commit": {"oid": "365e5f1f441e13723850e0b15ebd13d9b8c40f0e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoxNTozMFrOIEEW2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxODoxNjoyMlrOIEEYwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNjYwMg==", "bodyText": "You also need the DBI and DBD::mysql packages (assuming you have a MySQL/MariaDB database).", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r541136602", "createdAt": "2020-12-11T18:15:30Z", "author": {"login": "apetkau"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -11,6 +11,145 @@ description: \"Upgrade Notes\"\n \n The majority of IRIDA's upgrade notes can be seen at <https://github.com/phac-nml/irida/blob/master/UPGRADING.md>.  When there are more significant upgrades to the IRIDA system, database, deployment, etc. this page will go further in depth about how to properly back up your system, perform the upgrade, and recover from problems.\n \n+# 21.01\n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |\n+\n+The tables involved are the following:\n+\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list (ex: \"Salmonella\").\n+* `sample_metadata_entry` - The relationship between the above 3 tables (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+In addition to the above, there is a matching `_AUD` (audit) table for each of these tables which captures any changes to the data and the user & time which the change occurred.  This auditing is managed by [Hibernate Envers](https://hibernate.org/orm/envers/).\n+\n+In general data will be populated into these tables in the following order:\n+\n+1. `sample` entry is created as sequencing data is uploaded (ex: \"sample1\"),\n+2. Someone uploads a set of sample metadata, which will first get a `metadata_field` (ex: \"Organism\")\n+  a. Find an existing `metadata_field` for a column header,\n+  b. Or create a new `metadata_field` for a header,\n+3. `metadata_entry` is created with the appropriate value (ex: \"Salmonella\"),\n+4. `sample_metadata_entry` is created linking the above 3 items together (ex: for \"sample1\" the \"Organism\" is \"Salmonella\").\n+\n+Note items 2, 3, and 4 will generally be done at the same time.  As soon as the metadata values are committed to the database, Envers should create `_AUD` entries for all of the above records.\n+\n+### The problem\n+{:.no_toc}\n+\n+The issue we noticed is that while Envers seemed to create `_AUD` records for all the above tables when metadata is first added to a sample, subsequent updates of those values *may* not create records for the `sample_metadata_entry_AUD` table, though it properly creates records for the `metadata_entry_AUD` and `sample_AUD` tables.  We found this to be most prevalent when data is synchronized from remote IRIDA installations, but also occurred in some cases where pipelines were re-run and metadata being re-saved to samples.  Most of these records were duplicate entries that were saving the same metadata values back to the sample, but creating new rows in the database.  We are still investigating why this issue was occurring.  Due to the complex nature of the above database tables it appears that Envers was failing to properly audit the relationship between those entities/tables.\n+\n+Note that we have found **no evidence of missing live data**.  It appears that all metadata records were written to the live database tables as expected.  This issue only appears to effect the `sample_metadata_entry_AUD` table.\n+\n+### The fix\n+{:.no_toc}\n+\n+Solving this issue involved a refactor of the database structure to remove the `sample_metadata_entry` table.  The new database structure is as follows:\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list and its relationship to the `metadata_field` and `sample` (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+This results in a cleaner database structure with less redundancy, and allowed us to refactor IRIDA's codebase to ensure Envers can properly capture any changes to a sample's metadata.  In the long-term this should also allow us to more efficiently build extensions to IRIDA's metadata system.\n+\n+As with most other database updates, we use [Liquibase](https://www.liquibase.org/) to manage this update.  After the 21.01 upgrade is complete, our Liquibase changeset will also remove any \"dangling\" `metadata_entry` records to improve performance and the integrity of metadata in the IRIDA system.\n+\n+### What about old data?\n+{:.no_toc}\n+\n+Since Envers was writing audit records for the `sample_AUD` and `metadata_entry_AUD` tables, we can re-connect many of the disconnected `metadata_entry_AUD` records with their samples.  In places where there is a clear connection between a `metadata_entry_AUD` record and a `sample_AUD` record, we are automatically re-connecting the entries to the appropriate sample and field using Liquibase.  In other cases where the connection is not as clear, we chose not to update the disconnected records in the database to ensure integrity of the existing audit records.  \n+\n+#### Metadata linking script\n+{:.no_toc}\n+\n+In addition to re-linking old data as described above, we've included a small utility script which can be run before the upgrade to generate a report of all disconnected `sample_metadata_entry_AUD` records and their connections to their parent samples where available.  While we do not expect that this report will be needed in the future, we recommend running this utility and saving the report alongside your backups to ensure the history of these samples is maintained.  **This script must be run before you perform the 21.01 update**.\n+\n+This script will output a CSV file of the following data:\n+\n+| `metadata_entry` database id | `metadata_entry` text value | Envers revision number of the entry | User ID of the user that made the change | `sample` database id associated with the metadata | Name of the sample |\n+|---|---|---|---|---|---|\n+\n+You can download this script at <https://github.com/phac-nml/irida/tree/development/src/main/resources/scripts/metadata-mappings>.  This script requires the `Text::CSV` perl package to be installed (available in CPAN and various other package managers).  To run this script:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "365e5f1f441e13723850e0b15ebd13d9b8c40f0e"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTEzNzA5MA==", "bodyText": "You may want to specify that if [database host] is localhost then someone may have to specify it by IP address (127.0.0.1) instead of localhost otherwise the connection will attempt to use a Unix Socket instead of TCP/IP. This causes issues if the database is running on Ubuntu since Ubuntu's install changes the location of the Unix Socket to use (so you will get an error). See https://metacpan.org/pod/DBD::mysql#host\nAlso, just a small comment, but normally I leave out the $ symbol to make it easier to copy/paste the command.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r541137090", "createdAt": "2020-12-11T18:16:22Z", "author": {"login": "apetkau"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -11,6 +11,145 @@ description: \"Upgrade Notes\"\n \n The majority of IRIDA's upgrade notes can be seen at <https://github.com/phac-nml/irida/blob/master/UPGRADING.md>.  When there are more significant upgrades to the IRIDA system, database, deployment, etc. this page will go further in depth about how to properly back up your system, perform the upgrade, and recover from problems.\n \n+# 21.01\n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |\n+\n+The tables involved are the following:\n+\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list (ex: \"Salmonella\").\n+* `sample_metadata_entry` - The relationship between the above 3 tables (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+In addition to the above, there is a matching `_AUD` (audit) table for each of these tables which captures any changes to the data and the user & time which the change occurred.  This auditing is managed by [Hibernate Envers](https://hibernate.org/orm/envers/).\n+\n+In general data will be populated into these tables in the following order:\n+\n+1. `sample` entry is created as sequencing data is uploaded (ex: \"sample1\"),\n+2. Someone uploads a set of sample metadata, which will first get a `metadata_field` (ex: \"Organism\")\n+  a. Find an existing `metadata_field` for a column header,\n+  b. Or create a new `metadata_field` for a header,\n+3. `metadata_entry` is created with the appropriate value (ex: \"Salmonella\"),\n+4. `sample_metadata_entry` is created linking the above 3 items together (ex: for \"sample1\" the \"Organism\" is \"Salmonella\").\n+\n+Note items 2, 3, and 4 will generally be done at the same time.  As soon as the metadata values are committed to the database, Envers should create `_AUD` entries for all of the above records.\n+\n+### The problem\n+{:.no_toc}\n+\n+The issue we noticed is that while Envers seemed to create `_AUD` records for all the above tables when metadata is first added to a sample, subsequent updates of those values *may* not create records for the `sample_metadata_entry_AUD` table, though it properly creates records for the `metadata_entry_AUD` and `sample_AUD` tables.  We found this to be most prevalent when data is synchronized from remote IRIDA installations, but also occurred in some cases where pipelines were re-run and metadata being re-saved to samples.  Most of these records were duplicate entries that were saving the same metadata values back to the sample, but creating new rows in the database.  We are still investigating why this issue was occurring.  Due to the complex nature of the above database tables it appears that Envers was failing to properly audit the relationship between those entities/tables.\n+\n+Note that we have found **no evidence of missing live data**.  It appears that all metadata records were written to the live database tables as expected.  This issue only appears to effect the `sample_metadata_entry_AUD` table.\n+\n+### The fix\n+{:.no_toc}\n+\n+Solving this issue involved a refactor of the database structure to remove the `sample_metadata_entry` table.  The new database structure is as follows:\n+\n+* `sample` - A record of a sample which contains its name, creation date, and some fixed metadata (ex: \"sample1\").\n+* `metadata_field` - The header of a line-list column.  This table contains the field's name & datatype (ex: \"Organism\").\n+* `metadata_entry` - The value of a cell in the line-list and its relationship to the `metadata_field` and `sample` (ex: for \"sample1\", the \"Organism\" is \"Salmonella\").\n+\n+This results in a cleaner database structure with less redundancy, and allowed us to refactor IRIDA's codebase to ensure Envers can properly capture any changes to a sample's metadata.  In the long-term this should also allow us to more efficiently build extensions to IRIDA's metadata system.\n+\n+As with most other database updates, we use [Liquibase](https://www.liquibase.org/) to manage this update.  After the 21.01 upgrade is complete, our Liquibase changeset will also remove any \"dangling\" `metadata_entry` records to improve performance and the integrity of metadata in the IRIDA system.\n+\n+### What about old data?\n+{:.no_toc}\n+\n+Since Envers was writing audit records for the `sample_AUD` and `metadata_entry_AUD` tables, we can re-connect many of the disconnected `metadata_entry_AUD` records with their samples.  In places where there is a clear connection between a `metadata_entry_AUD` record and a `sample_AUD` record, we are automatically re-connecting the entries to the appropriate sample and field using Liquibase.  In other cases where the connection is not as clear, we chose not to update the disconnected records in the database to ensure integrity of the existing audit records.  \n+\n+#### Metadata linking script\n+{:.no_toc}\n+\n+In addition to re-linking old data as described above, we've included a small utility script which can be run before the upgrade to generate a report of all disconnected `sample_metadata_entry_AUD` records and their connections to their parent samples where available.  While we do not expect that this report will be needed in the future, we recommend running this utility and saving the report alongside your backups to ensure the history of these samples is maintained.  **This script must be run before you perform the 21.01 update**.\n+\n+This script will output a CSV file of the following data:\n+\n+| `metadata_entry` database id | `metadata_entry` text value | Envers revision number of the entry | User ID of the user that made the change | `sample` database id associated with the metadata | Name of the sample |\n+|---|---|---|---|---|---|\n+\n+You can download this script at <https://github.com/phac-nml/irida/tree/development/src/main/resources/scripts/metadata-mappings>.  This script requires the `Text::CSV` perl package to be installed (available in CPAN and various other package managers).  To run this script:\n+\n+```bash\n+$ perl metadata-mappings.pl -u [database username] -p [database password] -d [irida database name] -h [database host] > [outputfile.csv]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "365e5f1f441e13723850e0b15ebd13d9b8c40f0e"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b81bcf1fe29e3397ed190be937243c1cbc4dc5a", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/6b81bcf1fe29e3397ed190be937243c1cbc4dc5a", "committedDate": "2020-12-17T13:49:49Z", "message": "fixed a couple docs entries to be more informative"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9f0ac0d1ad32a35c729d0c94a03e993a5b3ed79", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/d9f0ac0d1ad32a35c729d0c94a03e993a5b3ed79", "committedDate": "2020-12-17T14:12:05Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7252d42b3503f9f0311cfdf7cd606e5e26200d1c", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/7252d42b3503f9f0311cfdf7cd606e5e26200d1c", "committedDate": "2020-12-17T14:21:07Z", "message": "fixed missed merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d582700ff7f05b5204bdfc83dfe3e648a4adfec", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/3d582700ff7f05b5204bdfc83dfe3e648a4adfec", "committedDate": "2020-12-17T20:32:58Z", "message": "removed unused impots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cb27e61a71511ce17cc30418082fdab00aba6ac", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/7cb27e61a71511ce17cc30418082fdab00aba6ac", "committedDate": "2020-12-17T22:08:17Z", "message": "refactored sampledetails to have a map to match development"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e872e3e671db946c8189cf2b85e41e5fdd3694bf", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/e872e3e671db946c8189cf2b85e41e5fdd3694bf", "committedDate": "2020-12-21T14:54:19Z", "message": "added comment for sampledetails mapping method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NjExODMw", "url": "https://github.com/phac-nml/irida/pull/576#pullrequestreview-556611830", "createdAt": "2020-12-21T19:25:58Z", "commit": {"oid": "e872e3e671db946c8189cf2b85e41e5fdd3694bf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxOToyNTo1OFrOIJjYmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxOToyNTo1OFrOIJjYmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njg4NzgzMw==", "bodyText": "It's funny that you choose to use Organism for this example since it is technically still on the sample. \u00a0I think that update is something that needs to happen ASAP.", "url": "https://github.com/phac-nml/irida/pull/576#discussion_r546887833", "createdAt": "2020-12-21T19:25:58Z", "author": {"login": "joshsadam"}, "path": "doc/administrator/upgrades/index.md", "diffHunk": "@@ -11,6 +11,146 @@ description: \"Upgrade Notes\"\n \n The majority of IRIDA's upgrade notes can be seen at <https://github.com/phac-nml/irida/blob/master/UPGRADING.md>.  When there are more significant upgrades to the IRIDA system, database, deployment, etc. this page will go further in depth about how to properly back up your system, perform the upgrade, and recover from problems.\n \n+# 21.01\n+## Sample metadata audit record updates\n+\n+This upgrade contains some changes to how sample-metadata records are stored in IRIDA's database.  The intent of this update is to simplify the relationships between samples and metadata records to help with database performance and future developments.  It will also remove some redundancy in the database structure and remove any \"dangling\" metadata entries which have been removed from a sample, but not fully deleted from the database.\n+\n+While investigating how these updates will be applied to IRIDA databases, we noticed some irregularities in the audit records for some existing metadata.  Because of this we're recommending additional backup procedures be taken before completing this upgrade.  \n+\n+To skip straight to the backup procedure, [click here](#metadata-linking-script) For a full technical description of the issue, keep reading below.\n+\n+### Database structure\n+{:.no_toc}\n+\n+To fully understand this problem, we'll first describe the structure of our metadata system and relevant database tables.  Given the following example of a basic line-list:\n+\n+|         | Organism   |\n+|---------|------------|\n+| sample1 | Salmonella |", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e872e3e671db946c8189cf2b85e41e5fdd3694bf"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NjUwMTky", "url": "https://github.com/phac-nml/irida/pull/576#pullrequestreview-556650192", "createdAt": "2020-12-21T20:39:49Z", "commit": {"oid": "e872e3e671db946c8189cf2b85e41e5fdd3694bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NjUxMTE5", "url": "https://github.com/phac-nml/irida/pull/576#pullrequestreview-556651119", "createdAt": "2020-12-21T20:41:46Z", "commit": {"oid": "e872e3e671db946c8189cf2b85e41e5fdd3694bf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2c670d7ef616b5759e755befdeee038b281e4d4", "author": {"user": {"login": "tom114", "name": "Tom Matthews"}}, "url": "https://github.com/phac-nml/irida/commit/b2c670d7ef616b5759e755befdeee038b281e4d4", "committedDate": "2020-12-29T14:58:47Z", "message": "Merge branch 'development' into metadata-entry-reformat"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 302, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}