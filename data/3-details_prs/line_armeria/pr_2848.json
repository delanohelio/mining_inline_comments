{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMDQ1NjU3", "number": 2848, "title": "Provide a utility that parses gRPC-Web trailers from a response content", "bodyText": "Motivation:\nThe trailers of a gRPC-Web response must be the last message of the response, if a response has a body.\nUsers don't get tailers via RetryRule{WithContent}Builder.onResponseTrailers(...).\nThis could be a problem when they need grpc-status for retrying a gRPC-Web request.\nSlack thread: https://line-armeria.slack.com/archives/C1NGPBUH2/p1592985189001300?thread_ts=1591852559.452400&cid=C1NGPBUH2\nModifications:\n\nAdd a utility method that parses a trailers from the response content.\n\nResult:\nYou can now parse a response trailers from a response body for gRPC-Web using GrpcWebUtil.parseTrailers(response)\nNote:\nI'm not sure this is the best way.\nOn second thought, the problems of trailers in RetryRule could be solved by providing gRPC specific RetryRule such as GrpcRetryRule.", "createdAt": "2020-06-28T11:53:57Z", "url": "https://github.com/line/armeria/pull/2848", "merged": true, "mergeCommit": {"oid": "7827f5753b9dddc9022ab96f4c46a40bdaf49f10"}, "closed": true, "closedAt": "2020-07-01T07:05:10Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvrFl-gH2gAyNDQxMDQ1NjU3OjE5OTZkNzVlNWI0ODEzOGRkMWQwNDA4NzJiNjY4OTNjNDc4YWM3Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwkrx_gFqTQ0MDU5NDQwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1996d75e5b48138dd1d040872b66893c478ac729", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/1996d75e5b48138dd1d040872b66893c478ac729", "committedDate": "2020-06-28T11:52:33Z", "message": "Provide a utility that parses gRPC-Web trailers from a response content\n\nMotivation:\n\nThe trailers of `a gRPC-Web` response must be the last message of the response, if a response has a body.\nThey don't get `tailers` via `RetryRule{WithContent}Builder.onResponseTrailers(...)`.\nThis could be a problem when they need `grpc-status` for retrying a gRPC-Web request.\nSlack thread: https://line-armeria.slack.com/archives/C1NGPBUH2/p1592985189001300?thread_ts=1591852559.452400&cid=C1NGPBUH2\n\nModifications:\n\n- Add a utility method that parses a trailers from the response content.\n\nResult:\n\nYou can now parse a response trailers from a response body for gRPC-Web using `GrpcWebUtil.parseTrailers(response)`\n\nNote:\n\nI'm not sure this is the best way.\nOn second thought, the problems of trailers in RetryRule could be solved by providing gRPC specific RetryRule such as `GrpcRetryRule`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd725dcc33d2c1cb461abd90dd6bd9cfa7325f88", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/dd725dcc33d2c1cb461abd90dd6bd9cfa7325f88", "committedDate": "2020-06-28T11:55:49Z", "message": "Update Javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ae25fb186ee1a101bc763531aa4f1454413be50", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/2ae25fb186ee1a101bc763531aa4f1454413be50", "committedDate": "2020-06-29T04:32:50Z", "message": "Wrap with try...finally"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b26267d3a33704fe24473228be25d8a36251ebf", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/3b26267d3a33704fe24473228be25d8a36251ebf", "committedDate": "2020-06-29T04:34:21Z", "message": "Clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3b947618c0013b79626140ef2b9f680b1c5c8bb", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/c3b947618c0013b79626140ef2b9f680b1c5c8bb", "committedDate": "2020-06-29T12:15:31Z", "message": "Grammer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzExODE5", "url": "https://github.com/line/armeria/pull/2848#pullrequestreview-439711819", "createdAt": "2020-06-30T06:41:56Z", "commit": {"oid": "c3b947618c0013b79626140ef2b9f680b1c5c8bb"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjo0MTo1NlrOGqt5PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNjo0NzozM1rOGquC8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ0NTMwOQ==", "bodyText": "Isn't this public?", "url": "https://github.com/line/armeria/pull/2848#discussion_r447445309", "createdAt": "2020-06-30T06:41:56Z", "author": {"login": "minwoox"}, "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcWebUtil.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.grpc;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.retry.RetryRuleWithContent;\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaders;\n+import com.linecorp.armeria.common.grpc.protocol.GrpcHeaderNames;\n+import com.linecorp.armeria.common.unsafe.PooledHttpData;\n+import com.linecorp.armeria.internal.client.grpc.InternalGrpcWebUtil;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.Unpooled;\n+\n+/**\n+ * Utilities for working with <a href=\"https://grpc.io/docs/languages/web/basics/\">gRPC-Web</a>.\n+ */\n+public final class GrpcWebUtil {\n+\n+    private static final int HEADER_LENGTH = 5;\n+    private static final int RESERVED_MASK = 0x7E;\n+\n+    /**\n+     * Returns a gRPC-Web trailers parsed from the specified response body.\n+     * {@code null} if fail to parse a gRPC-Web trailers.\n+     *\n+     * <p>A gRPC-Web response does not contain a separated trailers according to the\n+     * <a href=\"https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-WEB.md#protocol-differences-vs-grpc-over-http2\">\n+     * gRPC-Web spec</a>:\n+     * <ul>\n+     *   <li>Trailers must be the last message of the response.</li>\n+     *   <li>Trailers may be sent together with response headers, with no message in the body.</li>\n+     * </ul>\n+     * That means the response trailers should be pulled out from {@link AggregatedHttpResponse#headers()}}\n+     * or parsed from {@link AggregatedHttpResponse#content()}.\n+     *\n+     * <p>This method is useful when {@link RetryRuleWithContent} needs {@link GrpcHeaderNames#GRPC_STATUS}\n+     * to decide whether to retry. For example:\n+     * <pre>{@code\n+     * Clients.builder(grpcServerUri)\n+     *        .decorator(RetryingClient.newDecorator(\n+     *                RetryRuleWithContent.onResponse(response -> {\n+     *                    return response.aggregate().thenApply(aggregated -> {\n+     *                        HttpHeaders trailers = GrpcWebUtil.parseTrailers(aggregated.content());\n+     *                        // Retry if the 'grpc-status' is not equal to 0.\n+     *                        return trailers != null && trailers.getInt(GrpcHeaderNames.GRPC_STATUS) != 0;\n+     *                    });\n+     *                })))\n+     *        .build(MyGrpcStub.class);\n+     * }</pre>\n+     */\n+    @Nullable\n+    static HttpHeaders parseTrailers(HttpData response) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3b947618c0013b79626140ef2b9f680b1c5c8bb"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ0NTM3MA==", "bodyText": "rnn for response?", "url": "https://github.com/line/armeria/pull/2848#discussion_r447445370", "createdAt": "2020-06-30T06:42:04Z", "author": {"login": "minwoox"}, "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcWebUtil.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.grpc;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.retry.RetryRuleWithContent;\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaders;\n+import com.linecorp.armeria.common.grpc.protocol.GrpcHeaderNames;\n+import com.linecorp.armeria.common.unsafe.PooledHttpData;\n+import com.linecorp.armeria.internal.client.grpc.InternalGrpcWebUtil;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.Unpooled;\n+\n+/**\n+ * Utilities for working with <a href=\"https://grpc.io/docs/languages/web/basics/\">gRPC-Web</a>.\n+ */\n+public final class GrpcWebUtil {\n+\n+    private static final int HEADER_LENGTH = 5;\n+    private static final int RESERVED_MASK = 0x7E;\n+\n+    /**\n+     * Returns a gRPC-Web trailers parsed from the specified response body.\n+     * {@code null} if fail to parse a gRPC-Web trailers.\n+     *\n+     * <p>A gRPC-Web response does not contain a separated trailers according to the\n+     * <a href=\"https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-WEB.md#protocol-differences-vs-grpc-over-http2\">\n+     * gRPC-Web spec</a>:\n+     * <ul>\n+     *   <li>Trailers must be the last message of the response.</li>\n+     *   <li>Trailers may be sent together with response headers, with no message in the body.</li>\n+     * </ul>\n+     * That means the response trailers should be pulled out from {@link AggregatedHttpResponse#headers()}}\n+     * or parsed from {@link AggregatedHttpResponse#content()}.\n+     *\n+     * <p>This method is useful when {@link RetryRuleWithContent} needs {@link GrpcHeaderNames#GRPC_STATUS}\n+     * to decide whether to retry. For example:\n+     * <pre>{@code\n+     * Clients.builder(grpcServerUri)\n+     *        .decorator(RetryingClient.newDecorator(\n+     *                RetryRuleWithContent.onResponse(response -> {\n+     *                    return response.aggregate().thenApply(aggregated -> {\n+     *                        HttpHeaders trailers = GrpcWebUtil.parseTrailers(aggregated.content());\n+     *                        // Retry if the 'grpc-status' is not equal to 0.\n+     *                        return trailers != null && trailers.getInt(GrpcHeaderNames.GRPC_STATUS) != 0;\n+     *                    });\n+     *                })))\n+     *        .build(MyGrpcStub.class);\n+     * }</pre>\n+     */\n+    @Nullable\n+    static HttpHeaders parseTrailers(HttpData response) {\n+        final ByteBuf buf;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3b947618c0013b79626140ef2b9f680b1c5c8bb"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ0Nzc5Mw==", "bodyText": "Could you leave a comment about what this is for?", "url": "https://github.com/line/armeria/pull/2848#discussion_r447447793", "createdAt": "2020-06-30T06:47:33Z", "author": {"login": "minwoox"}, "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcWebUtil.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.grpc;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.retry.RetryRuleWithContent;\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaders;\n+import com.linecorp.armeria.common.grpc.protocol.GrpcHeaderNames;\n+import com.linecorp.armeria.common.unsafe.PooledHttpData;\n+import com.linecorp.armeria.internal.client.grpc.InternalGrpcWebUtil;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.Unpooled;\n+\n+/**\n+ * Utilities for working with <a href=\"https://grpc.io/docs/languages/web/basics/\">gRPC-Web</a>.\n+ */\n+public final class GrpcWebUtil {\n+\n+    private static final int HEADER_LENGTH = 5;\n+    private static final int RESERVED_MASK = 0x7E;\n+\n+    /**\n+     * Returns a gRPC-Web trailers parsed from the specified response body.\n+     * {@code null} if fail to parse a gRPC-Web trailers.\n+     *\n+     * <p>A gRPC-Web response does not contain a separated trailers according to the\n+     * <a href=\"https://github.com/grpc/grpc/blob/master/doc/PROTOCOL-WEB.md#protocol-differences-vs-grpc-over-http2\">\n+     * gRPC-Web spec</a>:\n+     * <ul>\n+     *   <li>Trailers must be the last message of the response.</li>\n+     *   <li>Trailers may be sent together with response headers, with no message in the body.</li>\n+     * </ul>\n+     * That means the response trailers should be pulled out from {@link AggregatedHttpResponse#headers()}}\n+     * or parsed from {@link AggregatedHttpResponse#content()}.\n+     *\n+     * <p>This method is useful when {@link RetryRuleWithContent} needs {@link GrpcHeaderNames#GRPC_STATUS}\n+     * to decide whether to retry. For example:\n+     * <pre>{@code\n+     * Clients.builder(grpcServerUri)\n+     *        .decorator(RetryingClient.newDecorator(\n+     *                RetryRuleWithContent.onResponse(response -> {\n+     *                    return response.aggregate().thenApply(aggregated -> {\n+     *                        HttpHeaders trailers = GrpcWebUtil.parseTrailers(aggregated.content());\n+     *                        // Retry if the 'grpc-status' is not equal to 0.\n+     *                        return trailers != null && trailers.getInt(GrpcHeaderNames.GRPC_STATUS) != 0;\n+     *                    });\n+     *                })))\n+     *        .build(MyGrpcStub.class);\n+     * }</pre>\n+     */\n+    @Nullable\n+    static HttpHeaders parseTrailers(HttpData response) {\n+        final ByteBuf buf;\n+        if (response instanceof PooledHttpData) {\n+            buf = ((PooledHttpData) response).content();\n+        } else {\n+            buf = Unpooled.wrappedBuffer(response.array());\n+        }\n+        final int readerIndex = buf.readerIndex();\n+\n+        try {\n+            HttpHeaders trailers = null;\n+            while (buf.isReadable(HEADER_LENGTH)) {\n+                final short type = buf.readUnsignedByte();\n+                if ((type & RESERVED_MASK) != 0) {\n+                    // Malformed header\n+                    break;\n+                }\n+\n+                final int length = buf.readInt();\n+                if (type >> 7 == 1) {\n+                    trailers = InternalGrpcWebUtil.parseGrpcWebTrailers(buf);\n+                    break;\n+                } else {\n+                    buf.skipBytes(length);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3b947618c0013b79626140ef2b9f680b1c5c8bb"}, "originalPosition": 93}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59f6ae6c6d0090e3ed943511c026d3534e18456f", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/59f6ae6c6d0090e3ed943511c026d3534e18456f", "committedDate": "2020-06-30T06:59:44Z", "message": "Address comments by @minwoox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a3e8c041c1e9201b38f97dc17a8eead011ac52b", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/3a3e8c041c1e9201b38f97dc17a8eead011ac52b", "committedDate": "2020-06-30T07:01:00Z", "message": "Clean up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzQzNDYx", "url": "https://github.com/line/armeria/pull/2848#pullrequestreview-439743461", "createdAt": "2020-06-30T07:32:10Z", "commit": {"oid": "3a3e8c041c1e9201b38f97dc17a8eead011ac52b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f086c66e78b3d9e421b2421a68e8949b2f2f953f", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/f086c66e78b3d9e421b2421a68e8949b2f2f953f", "committedDate": "2020-07-01T02:32:31Z", "message": "Add @UnstableApi and note"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNTEwMTA3", "url": "https://github.com/line/armeria/pull/2848#pullrequestreview-440510107", "createdAt": "2020-07-01T02:42:30Z", "commit": {"oid": "f086c66e78b3d9e421b2421a68e8949b2f2f953f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f6b4cadfbfd2f590657939c9a5d71805c186476", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/3f6b4cadfbfd2f590657939c9a5d71805c186476", "committedDate": "2020-07-01T05:15:43Z", "message": "Merge branch 'master' into grpc-web-response-trailer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e10a39c1727c5b55c83db5b779533b082af51d4b", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/e10a39c1727c5b55c83db5b779533b082af51d4b", "committedDate": "2020-07-01T05:16:46Z", "message": "Fix compile error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNTk0NDA5", "url": "https://github.com/line/armeria/pull/2848#pullrequestreview-440594409", "createdAt": "2020-07-01T06:58:51Z", "commit": {"oid": "e10a39c1727c5b55c83db5b779533b082af51d4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 312, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}