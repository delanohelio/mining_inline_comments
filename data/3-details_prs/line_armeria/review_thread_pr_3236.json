{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNDA1Njc5", "number": 3236, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMjozODozNFrOFIAEHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMzo1MjoxM1rOFIA04g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzOTMzOTgxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMjozODozNFrOIJsVcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNDoxODo0NVrOIJt1zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ==", "bodyText": "How about checking first that the endpoints are the same?\nfinal boolean isSameEndpoints = contexts.size() == newSelectedEndpoints.size() &&\n                                contexts.keySet().containsAll(newSelectedEndpoints);", "url": "https://github.com/line/armeria/pull/3236#discussion_r547034481", "createdAt": "2020-12-22T02:38:34Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -173,26 +174,34 @@ private void refreshContexts() {\n         try {\n             synchronized (contexts) {\n                 final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n+                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNTIzNQ==", "bodyText": "What happens newSelectedEndpoints has more endpoints?", "url": "https://github.com/line/armeria/pull/3236#discussion_r547035235", "createdAt": "2020-12-22T02:41:37Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -173,26 +174,34 @@ private void refreshContexts() {\n         try {\n             synchronized (contexts) {\n                 final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n+                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ=="}, "originalCommit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNzYwMQ==", "bodyText": "If the problem happens only when weights are changed, I thought we can use the original logic if they are different. For example:\nfinal boolean isSameEndpoints = contexts.size() == newSelectedEndpoints.size() &&\n                                contexts.keySet().containsAll(newSelectedEndpoints);\nif (isSameEndpoints) {\n    refreshEndpoints();\n    return;\n}\n\n// same as before\nMaybe there is something I missed. \ud83e\udd2a", "url": "https://github.com/line/armeria/pull/3236#discussion_r547037601", "createdAt": "2020-12-22T02:50:23Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -173,26 +174,34 @@ private void refreshContexts() {\n         try {\n             synchronized (contexts) {\n                 final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n+                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ=="}, "originalCommit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzODgzOA==", "bodyText": "If newSelectedEndpoints has more endpoints than current endpoints we should add the newly added endpoints.\nSo we should do this as well:\nnewSelectedEndpoints.containsAll(contexts.keySet())\nwhich iterates another for loop.\nMost of the time, the endpoints will be changed so I think it's useless to check if just the weight is changed.\nWe will be going to notice that anyway. \ud83d\ude04", "url": "https://github.com/line/armeria/pull/3236#discussion_r547038838", "createdAt": "2020-12-22T02:55:13Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -173,26 +174,34 @@ private void refreshContexts() {\n         try {\n             synchronized (contexts) {\n                 final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n+                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ=="}, "originalCommit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1MjA3Mg==", "bodyText": "newSelectedEndpoints.containsAll(contexts.keySet())\n\nQuestion: Is this not covered by checking their sizes?\nAnyway, this is not a big deal. Let keep it as it is.", "url": "https://github.com/line/armeria/pull/3236#discussion_r547052072", "createdAt": "2020-12-22T03:50:30Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -173,26 +174,34 @@ private void refreshContexts() {\n         try {\n             synchronized (contexts) {\n                 final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n+                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ=="}, "originalCommit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1OTE0OA==", "bodyText": "Question: Is this not covered by checking their sizes?\n\nOh, I missed that point. \ud83d\ude05\n\nLet keep it as it is.\n\nYeah, let's keep it as it is.", "url": "https://github.com/line/armeria/pull/3236#discussion_r547059148", "createdAt": "2020-12-22T04:18:45Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -173,26 +174,34 @@ private void refreshContexts() {\n         try {\n             synchronized (contexts) {\n                 final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n+                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ=="}, "originalCommit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzOTQ2NDY2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMzo1MjoxM1rOIJtbyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNDoxOTowMVrOIJt2Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1MjQ4OQ==", "bodyText": "Could remove this original local variable to prohibit unwanted access?\nfinal Set<Endpoint> newSelectedEndpoints = new HashSet<>(healthCheckStrategy.getSelectedEndpoints());", "url": "https://github.com/line/armeria/pull/3236#discussion_r547052489", "createdAt": "2020-12-22T03:52:13Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -173,26 +174,34 @@ private void refreshContexts() {\n         try {\n             synchronized (contexts) {\n                 final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n+                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1OTIyMg==", "bodyText": "That's a good suggestion.", "url": "https://github.com/line/armeria/pull/3236#discussion_r547059222", "createdAt": "2020-12-22T04:19:01Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -173,26 +174,34 @@ private void refreshContexts() {\n         try {\n             synchronized (contexts) {\n                 final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n+                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1MjQ4OQ=="}, "originalCommit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1812, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}