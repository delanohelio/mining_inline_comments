{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNzA4NTA4", "number": 2406, "title": "Add more useful methods to `AsyncCloseable`", "bodyText": "Motivation:\nWhen a user closes something asynchronously, it is likely that he or she wants the following functionalities:\n\nGetting notified when it is closed, sometimes even without closing it.\nUsing with try-with-resources.\n\nModifications:\n\nMake AsyncCloseable extend AutoCloseable.\nAdd ListenableAsyncCloseable which has the following methods:\n\nisClosing()\nisClosed()\nwhenClosed()\n\n\nAdd AsyncCloseableSupport which helps a user implement AsyncCloseable or ListenableAsyncCloseable.\nMade the following classes implement `ListenableAsyncCloseable:\n\nClientFactory\nServer\nStartStopSupport\n\n\nMade the following classes implement AsyncCloseable:\n\nHttpChannelPool\nEndpointGroup\n\n\nStopped using Mockito.spy() in StartStopSupportTest because can't\ntest with spies.\nAdded UnmodifiableFuture\nMade EventLoopCheckingFuture a part of public API\nFixed a dead lock in HealthCheckedEndpointGroupTest.delegateUpdateCandidatesWhileCreatingHealthCheckedEndpointGroup()\nFixed a bug where a Server can be started back after close() is called.\nRemoved Completable from all CompletableFuture subtypes we provide.\n\nDeprecated ThriftCompletableFuture\nAdded ThriftFuture\nDeprecated the factory methods in ThriftFutures and added the corresponding factory methods to ThriftFuture or ThriftListenableFuture.\n\n\n\nResult:\n\nClientFactory and Server can be closed asynchronously.\nA user can do something when a ClientFactory closes, which will be\nuseful for #1084 (comment)\nUseful future classes\n\nUnmodifiableFuture\nThriftFuture\nEventLoopCheckingFuture\n\n\nDeprecation:\n\nThriftCompletableFuture in favor of ThriftFuture\nThriftFutures in favor of the factory methods in ThriftFuture or ThriftListenableFuture.", "createdAt": "2020-01-16T15:35:43Z", "url": "https://github.com/line/armeria/pull/2406", "merged": true, "mergeCommit": {"oid": "81e2a1cb5fba412a8b4908f98d0e8d28b67cfeb0"}, "closed": true, "closedAt": "2020-01-20T13:33:57Z", "author": {"login": "trustin"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb693AxABqjI5NTU0ODIwODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8MVu3gH2gAyMzYzNzA4NTA4OjNjYTNlYWQ2ZTMwMGEyMjM0ZmY3MGEyZjE2YmRiNGNhZTBlNWU4MDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f36ac278019cb3b0c2bb66b9e90afc36e8ec458", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/9f36ac278019cb3b0c2bb66b9e90afc36e8ec458", "committedDate": "2020-01-16T17:45:01Z", "message": "More non-blocking thread handling"}, "afterCommit": {"oid": "9abd4883ca58ed507977cc2ef3f735626b0e158b", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/9abd4883ca58ed507977cc2ef3f735626b0e158b", "committedDate": "2020-01-16T17:46:40Z", "message": "More non-blocking thread handling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9abd4883ca58ed507977cc2ef3f735626b0e158b", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/9abd4883ca58ed507977cc2ef3f735626b0e158b", "committedDate": "2020-01-16T17:46:40Z", "message": "More non-blocking thread handling"}, "afterCommit": {"oid": "673bfb71e7c77a7c919de01c442a15dba131d831", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/673bfb71e7c77a7c919de01c442a15dba131d831", "committedDate": "2020-01-16T17:47:09Z", "message": "More non-blocking thread handling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3358382657de2527169cd150b4c01f240be8f4d", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/f3358382657de2527169cd150b4c01f240be8f4d", "committedDate": "2020-01-16T18:11:00Z", "message": "Take periodic thread dump to see what's going on"}, "afterCommit": {"oid": "0823879c0696c012ff216e5965536f5150e8bffa", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/0823879c0696c012ff216e5965536f5150e8bffa", "committedDate": "2020-01-16T18:13:03Z", "message": "Take periodic thread dump to see what's going on"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "334c1c8e8ed1c80c530757a462e95f09b0bc08d1", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/334c1c8e8ed1c80c530757a462e95f09b0bc08d1", "committedDate": "2020-01-16T18:31:44Z", "message": "Increase dump interval"}, "afterCommit": {"oid": "d29554451ccec32a290642051fed59064a3c6a40", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/d29554451ccec32a290642051fed59064a3c6a40", "committedDate": "2020-01-16T18:46:13Z", "message": "Add more useful methods to `AsyncCloseable`\n\nMotivation:\n\nWhen a user closes something asynchronously, it is likely that he or she\nwants the following functionalities:\n\n- Getting notified when it is closed, sometimes even without closing it.\n- Using with `try`-with-resources.\n\nModifications:\n\n- Make `AsyncCloseable` extend `AutoCloseable`.\n- Add `AsyncCloseable.closeFuture()` which allows a user to get the\n  close future without closing.\n- Add `AsyncCloseableSupport` which helps a user implement `AsyncCloseable`.\n- Made the following classes implement `AsyncCloseable`:\n  - `ClientFactory`\n  - `HttpChannelPool`\n  - `Server`\n  - `StartStopSupport`\n- Stopped using `Mockito.spy()` in `StartStopSupportTest` because can't\n  test with spies.\n- Fixed a dead lock in `HealthCheckedEndpointGroupTest.delegateUpdateCandidatesWhileCreatingHealthCheckedEndpointGroup()`\n\nResult:\n\n- `ClientFactory` and `Server` can be closed asynchronously.\n- A user can do something when a `ClientFactory` closes, which will be\n  useful for https://github.com/line/armeria/issues/1084#issuecomment-572481160"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c86298a14675516912954ab871e7e5a0bc8096b", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/3c86298a14675516912954ab871e7e5a0bc8096b", "committedDate": "2020-01-16T18:46:40Z", "message": "Add more useful methods to `AsyncCloseable`\n\nMotivation:\n\nWhen a user closes something asynchronously, it is likely that he or she\nwants the following functionalities:\n\n- Getting notified when it is closed, sometimes even without closing it.\n- Using with `try`-with-resources.\n\nModifications:\n\n- Make `AsyncCloseable` extend `AutoCloseable`.\n- Add `AsyncCloseable.closeFuture()` which allows a user to get the\n  close future without closing.\n- Add `AsyncCloseableSupport` which helps a user implement `AsyncCloseable`.\n- Made the following classes implement `AsyncCloseable`:\n  - `ClientFactory`\n  - `HttpChannelPool`\n  - `Server`\n  - `StartStopSupport`\n- Stopped using `Mockito.spy()` in `StartStopSupportTest` because can't\n  test with spies.\n- Fixed a dead lock in `HealthCheckedEndpointGroupTest.delegateUpdateCandidatesWhileCreatingHealthCheckedEndpointGroup()`\n\nResult:\n\n- `ClientFactory` and `Server` can be closed asynchronously.\n- A user can do something when a `ClientFactory` closes, which will be\n  useful for https://github.com/line/armeria/issues/1084#issuecomment-572481160"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d29554451ccec32a290642051fed59064a3c6a40", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/d29554451ccec32a290642051fed59064a3c6a40", "committedDate": "2020-01-16T18:46:13Z", "message": "Add more useful methods to `AsyncCloseable`\n\nMotivation:\n\nWhen a user closes something asynchronously, it is likely that he or she\nwants the following functionalities:\n\n- Getting notified when it is closed, sometimes even without closing it.\n- Using with `try`-with-resources.\n\nModifications:\n\n- Make `AsyncCloseable` extend `AutoCloseable`.\n- Add `AsyncCloseable.closeFuture()` which allows a user to get the\n  close future without closing.\n- Add `AsyncCloseableSupport` which helps a user implement `AsyncCloseable`.\n- Made the following classes implement `AsyncCloseable`:\n  - `ClientFactory`\n  - `HttpChannelPool`\n  - `Server`\n  - `StartStopSupport`\n- Stopped using `Mockito.spy()` in `StartStopSupportTest` because can't\n  test with spies.\n- Fixed a dead lock in `HealthCheckedEndpointGroupTest.delegateUpdateCandidatesWhileCreatingHealthCheckedEndpointGroup()`\n\nResult:\n\n- `ClientFactory` and `Server` can be closed asynchronously.\n- A user can do something when a `ClientFactory` closes, which will be\n  useful for https://github.com/line/armeria/issues/1084#issuecomment-572481160"}, "afterCommit": {"oid": "3c86298a14675516912954ab871e7e5a0bc8096b", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/3c86298a14675516912954ab871e7e5a0bc8096b", "committedDate": "2020-01-16T18:46:40Z", "message": "Add more useful methods to `AsyncCloseable`\n\nMotivation:\n\nWhen a user closes something asynchronously, it is likely that he or she\nwants the following functionalities:\n\n- Getting notified when it is closed, sometimes even without closing it.\n- Using with `try`-with-resources.\n\nModifications:\n\n- Make `AsyncCloseable` extend `AutoCloseable`.\n- Add `AsyncCloseable.closeFuture()` which allows a user to get the\n  close future without closing.\n- Add `AsyncCloseableSupport` which helps a user implement `AsyncCloseable`.\n- Made the following classes implement `AsyncCloseable`:\n  - `ClientFactory`\n  - `HttpChannelPool`\n  - `Server`\n  - `StartStopSupport`\n- Stopped using `Mockito.spy()` in `StartStopSupportTest` because can't\n  test with spies.\n- Fixed a dead lock in `HealthCheckedEndpointGroupTest.delegateUpdateCandidatesWhileCreatingHealthCheckedEndpointGroup()`\n\nResult:\n\n- `ClientFactory` and `Server` can be closed asynchronously.\n- A user can do something when a `ClientFactory` closes, which will be\n  useful for https://github.com/line/armeria/issues/1084#issuecomment-572481160"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5329f4cb5216bf2a1e7eddc4a0b25e163b883ef8", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/5329f4cb5216bf2a1e7eddc4a0b25e163b883ef8", "committedDate": "2020-01-17T08:04:09Z", "message": "Disallow starting after closing / Return unupdatable future"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NDU3MzIy", "url": "https://github.com/line/armeria/pull/2406#pullrequestreview-344457322", "createdAt": "2020-01-17T09:35:03Z", "commit": {"oid": "5329f4cb5216bf2a1e7eddc4a0b25e163b883ef8"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTozNTowM1rOFezW8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTo0ODo1MVrOFezv2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0MzA1Ng==", "bodyText": "Shouldn't we use CompletableFutures.succesfulAsList(...) (log the cause using defaultValueMapper) because we have to wait for all futures to be complete? never mind this. \ud83d\ude05", "url": "https://github.com/line/armeria/pull/2406#discussion_r367843056", "createdAt": "2020-01-17T09:35:03Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactory.java", "diffHunk": "@@ -96,12 +103,38 @@ static ClientFactoryBuilder builder() {\n      * Closes the default {@link ClientFactory}.\n      */\n     static void closeDefault() {\n-        LoggerFactory.getLogger(ClientFactory.class).debug(\n-                \"Closing the default {}\", ClientFactory.class.getSimpleName());\n-        try {\n-            DefaultClientFactory.DEFAULT.doClose();\n-        } finally {\n-            DefaultClientFactory.INSECURE.doClose();\n+        final Logger logger = LoggerFactory.getLogger(ClientFactory.class);\n+        logger.debug(\"Closing the default client factories\");\n+        final CompletableFuture<Void> closeFuture = CompletableFuture.allOf(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5329f4cb5216bf2a1e7eddc4a0b25e163b883ef8"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0NzAwNw==", "bodyText": "need to change the doc a little bit?\nUnlike {@link AutoCloseable}, -> In addition to the funcationality of closing synchronously with {@link AutoCloseable},", "url": "https://github.com/line/armeria/pull/2406#discussion_r367847007", "createdAt": "2020-01-17T09:43:43Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseable.java", "diffHunk": "@@ -22,12 +22,24 @@\n  * method releases the resources asynchronously, returning the {@link CompletableFuture} which is completed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5329f4cb5216bf2a1e7eddc4a0b25e163b883ef8"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0OTQzNA==", "bodyText": "Not sure if we need this method, but if we do, how about making a static variable for this?", "url": "https://github.com/line/armeria/pull/2406#discussion_r367849434", "createdAt": "2020-01-17T09:48:51Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -0,0 +1,203 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n+import java.util.function.Consumer;\n+\n+/**\n+ * Provides support for implementing {@link AsyncCloseable}.\n+ */\n+public final class AsyncCloseableSupport implements AsyncCloseable {\n+\n+    private static final AtomicIntegerFieldUpdater<AsyncCloseableSupport> closingUpdater =\n+            AtomicIntegerFieldUpdater.newUpdater(AsyncCloseableSupport.class, \"closing\");\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} that will be completed immediately on {@link #close()} or\n+     * {@link #closeAsync()}. This method is useful when you don't have any resources to release.\n+     * <pre>{@code\n+     * > public class MyClass {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of();\n+     * >\n+     * >     public void doSomething() {\n+     * >         if (closeableSupport.isClosing()) {\n+     * >             throw new IllegalStateException(\"Closed already\");\n+     * >         }\n+     * >         ...\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     */\n+    public static AsyncCloseableSupport of() {\n+        return of(f -> f.complete(null));\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} which calls the specified {@link Consumer} on\n+     * {@link #close()} or {@link #closeAsync()}.\n+     * <pre>{@code\n+     * > class MyClass implements AutoCloseable {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of(f -> {\n+     * >         // Release resources here.\n+     * >         ...\n+     * >         f.complete(null);\n+     * >     });\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     *\n+     * @param closeAction the {@link Consumer} which performs the task that release the resources and\n+     *                    completes the given {@link CompletableFuture}.\n+     */\n+    public static AsyncCloseableSupport of(Consumer<CompletableFuture<?>> closeAction) {\n+        return new AsyncCloseableSupport(requireNonNull(closeAction, \"closeAction\"));\n+    }\n+\n+    /**\n+     * Returns the {@link AsyncCloseableSupport} which has been closed already.\n+     */\n+    public static AsyncCloseableSupport closed() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5329f4cb5216bf2a1e7eddc4a0b25e163b883ef8"}, "originalPosition": 108}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ceadfb714cc7d8cf9dee8e948edf16718c4fe69", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/1ceadfb714cc7d8cf9dee8e948edf16718c4fe69", "committedDate": "2020-01-17T11:09:08Z", "message": "Address the comments from @minwoox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e390778e8f731da65dfadc951e1b4c4c95c2faef", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e390778e8f731da65dfadc951e1b4c4c95c2faef", "committedDate": "2020-01-18T03:00:52Z", "message": "Make `EndpointGroup` extend `AsyncCloseable`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46f9967b7d499faf43a756320295c6a087ac244b", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/46f9967b7d499faf43a756320295c6a087ac244b", "committedDate": "2020-01-17T11:38:04Z", "message": "WIP - Making `EndpointGroup` extend `AsyncCloseable`"}, "afterCommit": {"oid": "e390778e8f731da65dfadc951e1b4c4c95c2faef", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e390778e8f731da65dfadc951e1b4c4c95c2faef", "committedDate": "2020-01-18T03:00:52Z", "message": "Make `EndpointGroup` extend `AsyncCloseable`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/930446cc6fc74ac65bd62bea43a246c28b06ad6d", "committedDate": "2020-01-18T03:35:22Z", "message": "UnupdatableCompletableFuture -> UnmodifiableFuture"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0OTM1NzI2", "url": "https://github.com/line/armeria/pull/2406#pullrequestreview-344935726", "createdAt": "2020-01-18T09:49:04Z", "commit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwOTo0OTowNFrOFfKQgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNDowMDowN1rOFfTDdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIxODI0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * > public class MyClass {\n          \n          \n            \n                 * > public class MyClass implements AsyncCloseable {", "url": "https://github.com/line/armeria/pull/2406#discussion_r368218242", "createdAt": "2020-01-18T09:49:04Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -0,0 +1,211 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n+import java.util.function.Consumer;\n+\n+import com.linecorp.armeria.internal.UnmodifiableFuture;\n+\n+/**\n+ * Provides support for implementing {@link AsyncCloseable}.\n+ */\n+public final class AsyncCloseableSupport implements AsyncCloseable {\n+\n+    private static final AtomicIntegerFieldUpdater<AsyncCloseableSupport> closingUpdater =\n+            AtomicIntegerFieldUpdater.newUpdater(AsyncCloseableSupport.class, \"closing\");\n+\n+    private static final AsyncCloseableSupport CLOSED;\n+\n+    static {\n+        CLOSED = of();\n+        CLOSED.closeAsync();\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} that will be completed immediately on {@link #close()} or\n+     * {@link #closeAsync()}. This method is useful when you don't have any resources to release.\n+     * <pre>{@code\n+     * > public class MyClass {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1NDQ4NA==", "bodyText": "nit: Use singleton EMPTY_FUTURES like HttpClientFactory?", "url": "https://github.com/line/armeria/pull/2406#discussion_r368354484", "createdAt": "2020-01-20T03:05:02Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientFactory.java", "diffHunk": "@@ -162,20 +165,55 @@ public Object newClient(ClientBuilderParams params) {\n         return null;\n     }\n \n+    @Override\n+    public CompletableFuture<?> closeFuture() {\n+        return closeable.closeFuture();\n+    }\n+\n+    @Override\n+    public CompletableFuture<?> closeAsync() {\n+        return closeAsync(true);\n+    }\n+\n+    CompletableFuture<?> closeAsync(boolean checkDefault) {\n+        if (checkDefault && checkDefault()) {\n+            return closeFuture();\n+        }\n+        return closeable.closeAsync();\n+    }\n+\n+    private void closeAsync(CompletableFuture<?> future) {\n+        final CompletableFuture<?>[] delegateCloseFutures =\n+                clientFactoriesToClose.stream()\n+                                      .map(ClientFactory::closeAsync)\n+                                      .toArray(CompletableFuture[]::new);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1ODE1Nw==", "bodyText": "nit: Don't we need to add the breaking-change label? \ud83e\uddd0", "url": "https://github.com/line/armeria/pull/2406#discussion_r368358157", "createdAt": "2020-01-20T03:29:03Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseable.java", "diffHunk": "@@ -18,16 +18,28 @@\n import java.util.concurrent.CompletableFuture;\n \n /**\n- * An object that may hold resources until it is closed. Unlike {@link AutoCloseable}, the {@link #closeAsync()}\n- * method releases the resources asynchronously, returning the {@link CompletableFuture} which is completed\n- * after the resources are released.\n+ * An object that may hold resources until it is closed. In addition to {@link AutoCloseable#close()},\n+ * this interface provides {@link #closeAsync()} which releases the resources asynchronously, returning\n+ * a {@link CompletableFuture} which is completed after the resources are released.\n  */\n-@FunctionalInterface\n-public interface AsyncCloseable {\n+public interface AsyncCloseable extends AutoCloseable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM2MDYwNQ==", "bodyText": "nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static AsyncCloseableSupport of(Consumer<CompletableFuture<?>> closeAction) {\n          \n          \n            \n                public static AsyncCloseableSupport of(Consumer<? super CompletableFuture<?>> closeAction) {", "url": "https://github.com/line/armeria/pull/2406#discussion_r368360605", "createdAt": "2020-01-20T03:46:48Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -0,0 +1,211 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n+import java.util.function.Consumer;\n+\n+import com.linecorp.armeria.internal.UnmodifiableFuture;\n+\n+/**\n+ * Provides support for implementing {@link AsyncCloseable}.\n+ */\n+public final class AsyncCloseableSupport implements AsyncCloseable {\n+\n+    private static final AtomicIntegerFieldUpdater<AsyncCloseableSupport> closingUpdater =\n+            AtomicIntegerFieldUpdater.newUpdater(AsyncCloseableSupport.class, \"closing\");\n+\n+    private static final AsyncCloseableSupport CLOSED;\n+\n+    static {\n+        CLOSED = of();\n+        CLOSED.closeAsync();\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} that will be completed immediately on {@link #close()} or\n+     * {@link #closeAsync()}. This method is useful when you don't have any resources to release.\n+     * <pre>{@code\n+     * > public class MyClass {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of();\n+     * >\n+     * >     public void doSomething() {\n+     * >         if (closeableSupport.isClosing()) {\n+     * >             throw new IllegalStateException(\"Closed already\");\n+     * >         }\n+     * >         ...\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     */\n+    public static AsyncCloseableSupport of() {\n+        return of(f -> f.complete(null));\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} which calls the specified {@link Consumer} on\n+     * {@link #close()} or {@link #closeAsync()}.\n+     * <pre>{@code\n+     * > class MyClass implements AutoCloseable {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of(f -> {\n+     * >         // Release resources here.\n+     * >         ...\n+     * >         f.complete(null);\n+     * >     });\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     *\n+     * @param closeAction the {@link Consumer} which performs the task that release the resources and\n+     *                    completes the given {@link CompletableFuture}.\n+     */\n+    public static AsyncCloseableSupport of(Consumer<CompletableFuture<?>> closeAction) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM2MjM1OA==", "bodyText": "nit: requireNonNull(future)?", "url": "https://github.com/line/armeria/pull/2406#discussion_r368362358", "createdAt": "2020-01-20T04:00:07Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/internal/UnmodifiableFuture.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.util.Exceptions;\n+\n+/**\n+ * A {@link CompletableFuture} which prevents the caller from completing it.\n+ */\n+public final class UnmodifiableFuture<T> extends CompletableFuture<T> {\n+\n+    private static final UnmodifiableFuture<?> NIL;\n+\n+    static {\n+        NIL = new UnmodifiableFuture<>();\n+        NIL.doComplete(null);\n+    }\n+\n+    public static <U> UnmodifiableFuture<U> completedFuture(@Nullable U value) {\n+        if (value == null) {\n+            @SuppressWarnings(\"unchecked\")\n+            final UnmodifiableFuture<U> cast = (UnmodifiableFuture<U>) NIL;\n+            return cast;\n+        }\n+\n+        final UnmodifiableFuture<U> future = new UnmodifiableFuture<>();\n+        future.doComplete(value);\n+        return future;\n+    }\n+\n+    public static <U> UnmodifiableFuture<U> exceptionallyCompletedFuture(Throwable cause) {\n+        requireNonNull(cause, \"cause\");\n+        final UnmodifiableFuture<U> future = new UnmodifiableFuture<>();\n+        future.doCompleteExceptionally(cause);\n+        return future;\n+    }\n+\n+    public static <U> UnmodifiableFuture<U> wrap(CompletableFuture<U> future) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MDkzNDk0", "url": "https://github.com/line/armeria/pull/2406#pullrequestreview-345093494", "createdAt": "2020-01-20T06:05:47Z", "commit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNjowNTo0OFrOFfUMWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNjoxMDozM1rOFfUP3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4MTAxOA==", "bodyText": "Can you add a comment why we don't use join() here? I think this is basically only called from a shutdown hook ever, so interruption probably doesn't matter so much but not sure.", "url": "https://github.com/line/armeria/pull/2406#discussion_r368381018", "createdAt": "2020-01-20T06:05:48Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactory.java", "diffHunk": "@@ -96,12 +103,38 @@ static ClientFactoryBuilder builder() {\n      * Closes the default {@link ClientFactory}.\n      */\n     static void closeDefault() {\n-        LoggerFactory.getLogger(ClientFactory.class).debug(\n-                \"Closing the default {}\", ClientFactory.class.getSimpleName());\n-        try {\n-            DefaultClientFactory.DEFAULT.doClose();\n-        } finally {\n-            DefaultClientFactory.INSECURE.doClose();\n+        final Logger logger = LoggerFactory.getLogger(ClientFactory.class);\n+        logger.debug(\"Closing the default client factories\");\n+        final CompletableFuture<Void> closeFuture = CompletableFuture.allOf(\n+                DefaultClientFactory.DEFAULT.closeAsync(false),\n+                DefaultClientFactory.INSECURE.closeAsync(false)).handle((unused1, cause) -> {\n+            if (cause == null) {\n+                logger.debug(\"Closed the default client factories\");\n+            } else {\n+                logger.warn(\"Failed to close the default client factories:\", Exceptions.peel(cause));\n+            }\n+            return null;\n+        });\n+\n+        if (!(Thread.currentThread() instanceof NonBlocking)) {\n+            boolean interrupted = false;\n+            try {\n+                for (;;) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4MTkxNg==", "bodyText": "Having two similar names with same return type is making me scratch my head a little. It looks like future is a way of closing out of these three\n\n(Implicitly implied) Blocking close\nAsync close\nFuture close\n\nI know this matches our general pattern, but shall we consider renaming all fooFuture to whenFoo? ctx.log().whenComplete().thenAccept() reads like English and seems quite nice to me.", "url": "https://github.com/line/armeria/pull/2406#discussion_r368381916", "createdAt": "2020-01-20T06:10:33Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseable.java", "diffHunk": "@@ -18,16 +18,28 @@\n import java.util.concurrent.CompletableFuture;\n \n /**\n- * An object that may hold resources until it is closed. Unlike {@link AutoCloseable}, the {@link #closeAsync()}\n- * method releases the resources asynchronously, returning the {@link CompletableFuture} which is completed\n- * after the resources are released.\n+ * An object that may hold resources until it is closed. In addition to {@link AutoCloseable#close()},\n+ * this interface provides {@link #closeAsync()} which releases the resources asynchronously, returning\n+ * a {@link CompletableFuture} which is completed after the resources are released.\n  */\n-@FunctionalInterface\n-public interface AsyncCloseable {\n+public interface AsyncCloseable extends AutoCloseable {\n     /**\n-     * Releases the resources held by this object asynchronously.\n+     * Returns the {@link CompletableFuture} which is completed after the resources are released. Note that\n+     * you must use {@link #close()} or {@link #closeAsync()} to release the resources actually. This method\n+     * merely returns the {@link CompletableFuture}.\n+     */\n+    CompletableFuture<?> closeFuture();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c2834ed45ad98e4bcace17cacc4628611ba8b2c", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/0c2834ed45ad98e4bcace17cacc4628611ba8b2c", "committedDate": "2020-01-20T08:01:33Z", "message": "Address the comments from @minwoox, @ikhoon, @anuraaga\n\n- Added `ListenableAsyncCloseable`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05fc9441f8cf3f7d3a4aeef4e76fad36382bde3c", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/05fc9441f8cf3f7d3a4aeef4e76fad36382bde3c", "committedDate": "2020-01-20T08:03:30Z", "message": "Made UnmodifiableFuture an EventLoopCheckingCompletableFuture"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "493e868e28bcaa51861f0a166a03ec6eb28a0ba8", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/493e868e28bcaa51861f0a166a03ec6eb28a0ba8", "committedDate": "2020-01-20T08:13:05Z", "message": "Make `UnmodifiableFuture` a part of the public API\n\n.. because it's so useful"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MTU2ODIx", "url": "https://github.com/line/armeria/pull/2406#pullrequestreview-345156821", "createdAt": "2020-01-20T09:00:58Z", "commit": {"oid": "0c2834ed45ad98e4bcace17cacc4628611ba8b2c"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwOTowMDo1OFrOFfXM8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwOToyNDoxNFrOFfX23Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQzMDMyMA==", "bodyText": "nit: This one should be ListenableAsyncCloseable as well.", "url": "https://github.com/line/armeria/pull/2406#discussion_r368430320", "createdAt": "2020-01-20T09:00:58Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -80,27 +77,24 @@ public static AsyncCloseableSupport of() {\n      * Returns a new {@link AsyncCloseableSupport} which calls the specified {@link Consumer} on\n      * {@link #close()} or {@link #closeAsync()}.\n      * <pre>{@code\n-     * > class MyClass implements AutoCloseable {\n-     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of(f -> {\n+     * > class MyClass implements AsyncCloseable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c2834ed45ad98e4bcace17cacc4628611ba8b2c"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQzMTY1Mw==", "bodyText": "nit: unmodifiable?", "url": "https://github.com/line/armeria/pull/2406#discussion_r368431653", "createdAt": "2020-01-20T09:03:51Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n+import java.util.function.Consumer;\n+\n+/**\n+ * Provides support for implementing {@link AsyncCloseable} or {@link ListenableAsyncCloseable}.\n+ */\n+public final class AsyncCloseableSupport implements ListenableAsyncCloseable {\n+\n+    private static final AtomicIntegerFieldUpdater<AsyncCloseableSupport> closingUpdater =\n+            AtomicIntegerFieldUpdater.newUpdater(AsyncCloseableSupport.class, \"closing\");\n+\n+    private static final AsyncCloseableSupport CLOSED;\n+\n+    static {\n+        CLOSED = of();\n+        CLOSED.closeAsync();\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} that will be completed immediately on {@link #close()} or\n+     * {@link #closeAsync()}. This method is useful when you don't have any resources to release.\n+     * <pre>{@code\n+     * > public class MyClass implements ListenableAsyncCloseable {\n+     * >     final AsyncCloseableSupport closeable = AsyncCloseableSupport.of();\n+     * >\n+     * >     public void doSomething() {\n+     * >         if (closeable.isClosing()) {\n+     * >             throw new IllegalStateException(\"Closed already\");\n+     * >         }\n+     * >         ...\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public boolean isClosing() { return closeable.isClosing(); }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> whenClosed() { return closeable.whenClosed(); }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() { return closeable.closeAsync(); }\n+     * >\n+     * >     @Override\n+     * >     public void close() { closeable.close(); }\n+     * > }\n+     * }</pre>\n+     */\n+    public static AsyncCloseableSupport of() {\n+        return of(f -> f.complete(null));\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} which calls the specified {@link Consumer} on\n+     * {@link #close()} or {@link #closeAsync()}.\n+     * <pre>{@code\n+     * > class MyClass implements AsyncCloseable {\n+     * >     final AsyncCloseableSupport closeable = AsyncCloseableSupport.of(f -> {\n+     * >         // Release resources here.\n+     * >         ...\n+     * >         f.complete(null);\n+     * >     });\n+     * >\n+     * >     @Override\n+     * >     public boolean isClosing() { return closeable.isClosing(); }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> whenClosed() { return closeable.whenClosed(); }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() { return closeable.closeAsync(); }\n+     * >\n+     * >     @Override\n+     * >     public void close() { closeable.close(); }\n+     * > }\n+     * }</pre>\n+     *\n+     * @param closeAction the {@link Consumer} which performs the task that release the resources and\n+     *                    completes the given {@link CompletableFuture}.\n+     */\n+    public static AsyncCloseableSupport of(Consumer<CompletableFuture<?>> closeAction) {\n+        return new AsyncCloseableSupport(requireNonNull(closeAction, \"closeAction\"));\n+    }\n+\n+    /**\n+     * Returns the {@link AsyncCloseableSupport} which has been closed already.\n+     */\n+    public static AsyncCloseableSupport closed() {\n+        return CLOSED;\n+    }\n+\n+    private final Consumer<CompletableFuture<?>> closeAction;\n+    private final CompletableFuture<?> closeFuture = new CompletableFuture<>();\n+    private final UnmodifiableFuture<?> unupdatableCloseFuture =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "493e868e28bcaa51861f0a166a03ec6eb28a0ba8"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ0MTA1Mw==", "bodyText": "Shouldn't this return CompletableFuture?", "url": "https://github.com/line/armeria/pull/2406#discussion_r368441053", "createdAt": "2020-01-20T09:24:14Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/UnmodifiableFuture.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.internal.eventloop.EventLoopCheckingCompletableFuture;\n+\n+/**\n+ * A {@link CompletableFuture} which prevents the caller from completing it. An attempt to call any of\n+ * the following methods will trigger an {@link UnsupportedOperationException}:\n+ * <ul>\n+ *   <li>{@link #complete(Object)}</li>\n+ *   <li>{@link #completeExceptionally(Throwable)}</li>\n+ *   <li>{@link #obtrudeValue(Object)}</li>\n+ *   <li>{@link #obtrudeException(Throwable)}</li>\n+ * </ul>\n+ * Also, {@link #cancel(boolean)} will do nothing but returning whether cancelled or not.\n+ */\n+public final class UnmodifiableFuture<T> extends EventLoopCheckingCompletableFuture<T> {\n+\n+    private static final UnmodifiableFuture<?> NIL;\n+\n+    static {\n+        NIL = new UnmodifiableFuture<>();\n+        NIL.doComplete(null);\n+    }\n+\n+    /**\n+     * Returns an {@link UnmodifiableFuture} which has been completed with the specified {@code value}.\n+     */\n+    public static <U> UnmodifiableFuture<U> completedFuture(@Nullable U value) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "493e868e28bcaa51861f0a166a03ec6eb28a0ba8"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "181f009dad3715e4f2d0707f8ea538c82bfb0150", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/181f009dad3715e4f2d0707f8ea538c82bfb0150", "committedDate": "2020-01-20T09:43:21Z", "message": "Address the comments from @minwoox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b6dcdddb2abfb3b718c316f1ab77812d36cdd5e", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/4b6dcdddb2abfb3b718c316f1ab77812d36cdd5e", "committedDate": "2020-01-20T09:50:42Z", "message": "Make `EventLoopCheckingCompletableFuture` public"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9108a377c3f348ff40c1415b598e27af89bb57b1", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/9108a377c3f348ff40c1415b598e27af89bb57b1", "committedDate": "2020-01-20T09:53:02Z", "message": "Merge branch 'master' into richer_async_closeable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c72cb5f7c7c723033e154a72bc7c3b799301475", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/0c72cb5f7c7c723033e154a72bc7c3b799301475", "committedDate": "2020-01-20T09:55:27Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb4f648d32829a29716a84a1dae8fb55d10a2dc0", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/eb4f648d32829a29716a84a1dae8fb55d10a2dc0", "committedDate": "2020-01-20T09:57:26Z", "message": "More Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55b2d8deec88ad8d10a349ec7a5cb57aedf1ba9a", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/55b2d8deec88ad8d10a349ec7a5cb57aedf1ba9a", "committedDate": "2020-01-20T10:02:56Z", "message": "EventLoopCheckingCompletableFuture -> EventLoopCheckingFuture"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MTk3Mjkz", "url": "https://github.com/line/armeria/pull/2406#pullrequestreview-345197293", "createdAt": "2020-01-20T10:05:36Z", "commit": {"oid": "55b2d8deec88ad8d10a349ec7a5cb57aedf1ba9a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b13ea8b0c094299bca39576abf706688fd168ff", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/2b13ea8b0c094299bca39576abf706688fd168ff", "committedDate": "2020-01-20T13:05:02Z", "message": "Remove `Completable` from all `CompletableFuture` subclasses for brevity, as suggested by @minwoox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d96d6e692f70787a9b08a477df5a30d6e3c4a3ab", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/d96d6e692f70787a9b08a477df5a30d6e3c4a3ab", "committedDate": "2020-01-20T13:10:11Z", "message": "2020"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ca3ead6e300a2234ff70a2f16bdb4cae0e5e804", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/3ca3ead6e300a2234ff70a2f16bdb4cae0e5e804", "committedDate": "2020-01-20T13:12:59Z", "message": "No public"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 871, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}