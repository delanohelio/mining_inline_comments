{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NDQ2MTEy", "number": 2709, "title": "Fix a bug where a response cause is not propagated when retrying a fa\u2026", "bodyText": "\u2026iled request with content\nMotivation:\nRetryRule is combined with RetryRuleWithContent, sometimes a response cause could not be propagated\nbecause of the following problems:\n\n\nWhen converting RetryRuleWithContent to RetryRule, a response cause got from\nHttpResponse.whenComplete() without aggregation.\nIf HttpResponse.abort() is not invoked yet, RetryRule could not use the response cause.\n\n\nHttpResponse was aborted before subscription, then the response could not be duplicated.\nFor example, a request was failed with UnprocessedRequestException; then, the response was aborted already.\n\n\nModifications:\n\nDon't duplicate response content if a response has a cause before evaluating a response.\nMake RetryRuleWithContent take cause as a parameter.\nSet response cause before closing or aborting a response.\n\nResult:\nA RetryRule could be retried with a response cause even though it is combined with RetryRuleWithContent.", "createdAt": "2020-05-13T15:37:18Z", "url": "https://github.com/line/armeria/pull/2709", "merged": true, "mergeCommit": {"oid": "ac3440be28a34d436e4382257d46bbf2cbdbca8a"}, "closed": true, "closedAt": "2020-05-14T06:15:18Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg6v1YAH2gAyNDE3NDQ2MTEyOjc2YzMwODg2Y2FlYTZlNjFmYWUzZjRhZDM3NjQ3YTgyMzVmMDU1YzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchHRLggFqTQxMTQ5MTA4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/76c30886caea6e61fae3f4ad37647a8235f055c6", "committedDate": "2020-05-13T15:38:24Z", "message": "Fix a bug where a response cause is not propagated when retrying a failed request with content\n\nMotivation:\n\n`RetryRule` is combined with `RetryRuleWithContent`, sometimes a response cause could not be propagated\nbecause of the following problems:\n\n1) When converting `RetryRuleWithContent` to `RetryRule`, a response cause got from\n   `HttpResponse.whenComplete()` without aggregation.\n   If `HttpResponse.abort()` is not invoked yet, `RetryRule` could not use the response cause.\n\n2) `HttpResponse` was aborted before subscription, then the response could not be duplicated.\n   For example, a request was failed with `UnprocessedRequestException`; then, the response was aborted already.\n\nModifications:\n\n* Pull a response cause from `RequestContext.log()` when RetryRule is\n  combined with `RetryRuleWithContent`.\n* Don't duplicate response content if a response has a cause before evaluating a response.\n\nResult:\n\nA `RetryRule` could be retried with a response cause even though it is combined with `RetryRuleWithContent`."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a707b4103cdcd1871490dfd120cce81077eab60", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/0a707b4103cdcd1871490dfd120cce81077eab60", "committedDate": "2020-05-13T15:36:27Z", "message": "Fix a bug where a response cause is not propagated when retrying a failed request with content\n\nMotivation:\n\n`RetryRule` is combined with `RetryRuleWithContent`, sometimes a response cause could not be propagated\nbecause of the following problems:\n\n1) When converting `RetryRuleWithContent` to `RetryRule`, a response cause got from\n   `HttpResponse.whenComplete()` without aggregation.\n   If `HttpResponse.abort()` is not invoked yet, `RetryRule` could not use the response cause.\n\n2) `HttpResponse` was aborted before subscription, then the response could not be duplicated.\n   For example, a request was failed with `UnprocessedRequestException`; then, the response was aborted already.\n\nModifications:\n\n* Pull a response cause from `RequestContext.log()` when RetryRule is\n  combined with `RetryRuleWithContent`.\n* Don't duplicate response content if a response has a cause before evaluating a response.\n\nResult:\n\nA `RetryRule` could be retried with a response cause even though it is combined with `RetryRuleWithContent`."}, "afterCommit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/76c30886caea6e61fae3f4ad37647a8235f055c6", "committedDate": "2020-05-13T15:38:24Z", "message": "Fix a bug where a response cause is not propagated when retrying a failed request with content\n\nMotivation:\n\n`RetryRule` is combined with `RetryRuleWithContent`, sometimes a response cause could not be propagated\nbecause of the following problems:\n\n1) When converting `RetryRuleWithContent` to `RetryRule`, a response cause got from\n   `HttpResponse.whenComplete()` without aggregation.\n   If `HttpResponse.abort()` is not invoked yet, `RetryRule` could not use the response cause.\n\n2) `HttpResponse` was aborted before subscription, then the response could not be duplicated.\n   For example, a request was failed with `UnprocessedRequestException`; then, the response was aborted already.\n\nModifications:\n\n* Pull a response cause from `RequestContext.log()` when RetryRule is\n  combined with `RetryRuleWithContent`.\n* Don't duplicate response content if a response has a cause before evaluating a response.\n\nResult:\n\nA `RetryRule` could be retried with a response cause even though it is combined with `RetryRuleWithContent`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDA0Mzkz", "url": "https://github.com/line/armeria/pull/2709#pullrequestreview-411404393", "createdAt": "2020-05-14T01:24:49Z", "commit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMToyNDo0OVrOGVI7_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMToyNzowOFrOGVI-eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxOTcxMA==", "bodyText": "fromRetryRuleWithContent?", "url": "https://github.com/line/armeria/pull/2709#discussion_r424819710", "createdAt": "2020-05-14T01:24:49Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryRuleUtil.java", "diffHunk": "@@ -60,18 +60,19 @@ static RetryRule fromRetryStrategy(RetryStrategy strategy) {\n         });\n     }\n \n+    static <T extends Response> RetryRule fromRetryWithContent(RetryRuleWithContent<T> retryRule) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMDM0Ng==", "bodyText": "Could cache this in the constructor?", "url": "https://github.com/line/armeria/pull/2709#discussion_r424820346", "createdAt": "2020-05-14T01:27:08Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "diffHunk": "@@ -282,14 +284,18 @@ private void doExecute0(ClientRequestContext ctx, HttpRequestDuplicator rootReqD\n                                                                     duplicated, duplicator::abort));\n                     }\n                 } else {\n-                    final Throwable responseCause =\n-                            log.isAvailable(RequestLogProperty.RESPONSE_CAUSE) ? log.responseCause() : null;\n+                    final RetryRule retryRule;\n+                    if (needsContentInStrategy) {\n+                        retryRule = RetryRuleUtil.fromRetryWithContent(retryRuleWithContent());\n+                    } else {\n+                        retryRule = retryRule();\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDA3NTk4", "url": "https://github.com/line/armeria/pull/2709#pullrequestreview-411407598", "createdAt": "2020-05-14T01:35:42Z", "commit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMTozNTo0MlrOGVJG0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMTozNTo1NlrOGVJHDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMjQ4MQ==", "bodyText": "What if an exception is raised when subscribing to HttpResponse?\nShouldn't we use always use duplicator if needsContentInStrategy is true?", "url": "https://github.com/line/armeria/pull/2709#discussion_r424822481", "createdAt": "2020-05-14T01:35:42Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "diffHunk": "@@ -269,7 +269,9 @@ private void doExecute0(ClientRequestContext ctx, HttpRequestDuplicator rootReqD\n \n         derivedCtx.log().whenAvailable(RequestLogProperty.RESPONSE_HEADERS).thenAccept(log -> {\n             try {\n-                if (needsContentInStrategy) {\n+                final Throwable responseCause =\n+                        log.isAvailable(RequestLogProperty.RESPONSE_CAUSE) ? log.responseCause() : null;\n+                if (needsContentInStrategy && responseCause == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMjU0Mw==", "bodyText": "needsContentInStrategy -> needsContentInRule", "url": "https://github.com/line/armeria/pull/2709#discussion_r424822543", "createdAt": "2020-05-14T01:35:56Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "diffHunk": "@@ -269,7 +269,9 @@ private void doExecute0(ClientRequestContext ctx, HttpRequestDuplicator rootReqD\n \n         derivedCtx.log().whenAvailable(RequestLogProperty.RESPONSE_HEADERS).thenAccept(log -> {\n             try {\n-                if (needsContentInStrategy) {\n+                final Throwable responseCause =\n+                        log.isAvailable(RequestLogProperty.RESPONSE_CAUSE) ? log.responseCause() : null;\n+                if (needsContentInStrategy && responseCause == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54b52318b64d1113769486e652e481fa7d377151", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/54b52318b64d1113769486e652e481fa7d377151", "committedDate": "2020-05-14T01:54:11Z", "message": "Fix broken test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "040c494d998bca441ef4081ed2232a745b3c985d", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/040c494d998bca441ef4081ed2232a745b3c985d", "committedDate": "2020-05-14T02:39:17Z", "message": "Address comments @minwoox / Handle RpcResponse cause"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47562b0cd9c62f6502c6d94c81f41616621280f0", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/47562b0cd9c62f6502c6d94c81f41616621280f0", "committedDate": "2020-05-14T03:45:41Z", "message": "Addresss comments by @minwoox, @trustin\n\n* Make RetryRuleWithContent take `cause` as a parameter.\n* Set response cause before closing or aborting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "387a899172041f741dc02a4c94bdd1b0f42caed8", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/387a899172041f741dc02a4c94bdd1b0f42caed8", "committedDate": "2020-05-14T04:02:13Z", "message": "Oops..."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDU1NTMw", "url": "https://github.com/line/armeria/pull/2709#pullrequestreview-411455530", "createdAt": "2020-05-14T04:24:39Z", "commit": {"oid": "387a899172041f741dc02a4c94bdd1b0f42caed8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNDoyNDozOVrOGVLmDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNDoyNDozOVrOGVLmDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2MzI0NQ==", "bodyText": "nit: Could merge into the above line.", "url": "https://github.com/line/armeria/pull/2709#discussion_r424863245", "createdAt": "2020-05-14T04:24:39Z", "author": {"login": "minwoox"}, "path": "benchmarks/src/jmh/java/com/linecorp/armeria/core/client/retry/WithDuplicator.java", "diffHunk": "@@ -29,11 +29,11 @@\n \n     @Override\n     protected WebClient newClient() {\n-        final RetryRuleWithContent<HttpResponse> retryStrategy =\n-                (ctx, response) -> response.aggregate().handle((unused1, unused2) -> null);\n+        final RetryRuleWithContent<HttpResponse> rule =\n+                (ctx, response, cause) -> response.aggregate().handle((unused1, unused2) -> null);\n \n         return WebClient.builder(baseUrl())\n-                        .decorator(RetryingClient.builder(retryStrategy)\n+                        .decorator(RetryingClient.builder(rule)\n                                                  .newDecorator())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "387a899172041f741dc02a4c94bdd1b0f42caed8"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68dc9f0be99915b5ce670653caac74027fd339b5", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/68dc9f0be99915b5ce670653caac74027fd339b5", "committedDate": "2020-05-14T04:32:42Z", "message": "Address comments @minwoox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "716c1c92f70bcf030372687e3b69dd8d719480b6", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/716c1c92f70bcf030372687e3b69dd8d719480b6", "committedDate": "2020-05-14T05:48:49Z", "message": "Add newDecorator(RetryRuleWithContent...)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDkxMDgz", "url": "https://github.com/line/armeria/pull/2709#pullrequestreview-411491083", "createdAt": "2020-05-14T06:13:41Z", "commit": {"oid": "716c1c92f70bcf030372687e3b69dd8d719480b6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 480, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}