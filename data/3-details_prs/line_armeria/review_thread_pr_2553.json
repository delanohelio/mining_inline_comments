{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MTQ3NDg1", "number": 2553, "reviewThreads": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzoyMjo0OVrODla4NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMjo0Njo1M1rODmh0gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTY0Mjc3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzoyMjo0OVrOFyTQ-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNTo0NDo0NlrOFytweg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4ODc2MQ==", "bodyText": "Maybe handleLateSubscriber()?", "url": "https://github.com/line/armeria/pull/2553#discussion_r388288761", "createdAt": "2020-03-05T13:22:49Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -145,16 +149,23 @@ static void failLateSubscriber(SubscriptionImpl subscription, Subscriber<?> late\n         final Throwable cause = abortedOrLate(oldSubscriber);\n \n         if (subscription.needsDirectInvocation()) {\n-            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-            lateSubscriber.onError(cause);\n+            lateSubscriber(lateSubscriber, cause);\n         } else {\n             subscription.executor().execute(() -> {\n-                lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-                lateSubscriber.onError(cause);\n+                lateSubscriber(lateSubscriber, cause);\n             });\n         }\n     }\n \n+    private static void lateSubscriber(Subscriber<?> lateSubscriber, Throwable cause) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcyMjgxMA==", "bodyText": "Fixed. \ud83d\ude04", "url": "https://github.com/line/armeria/pull/2553#discussion_r388722810", "createdAt": "2020-03-06T05:44:46Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -145,16 +149,23 @@ static void failLateSubscriber(SubscriptionImpl subscription, Subscriber<?> late\n         final Throwable cause = abortedOrLate(oldSubscriber);\n \n         if (subscription.needsDirectInvocation()) {\n-            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-            lateSubscriber.onError(cause);\n+            lateSubscriber(lateSubscriber, cause);\n         } else {\n             subscription.executor().execute(() -> {\n-                lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-                lateSubscriber.onError(cause);\n+                lateSubscriber(lateSubscriber, cause);\n             });\n         }\n     }\n \n+    private static void lateSubscriber(Subscriber<?> lateSubscriber, Throwable cause) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4ODc2MQ=="}, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTY0NTg4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzoyMzo0NVrOFyTS1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzowMDowOVrOFy34ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4OTIzNw==", "bodyText": "Global comment: Should we catch a Throwable?", "url": "https://github.com/line/armeria/pull/2553#discussion_r388289237", "createdAt": "2020-03-05T13:23:45Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -145,16 +149,23 @@ static void failLateSubscriber(SubscriptionImpl subscription, Subscriber<?> late\n         final Throwable cause = abortedOrLate(oldSubscriber);\n \n         if (subscription.needsDirectInvocation()) {\n-            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-            lateSubscriber.onError(cause);\n+            lateSubscriber(lateSubscriber, cause);\n         } else {\n             subscription.executor().execute(() -> {\n-                lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-                lateSubscriber.onError(cause);\n+                lateSubscriber(lateSubscriber, cause);\n             });\n         }\n     }\n \n+    private static void lateSubscriber(Subscriber<?> lateSubscriber, Throwable cause) {\n+        try {\n+            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n+            lateSubscriber.onError(cause);\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxNDI4MQ==", "bodyText": "reactive-streams/reactive-streams-jvm#107 (comment)\nI think they are guiding not to catch the fatal ones. \ud83e\udd14", "url": "https://github.com/line/armeria/pull/2553#discussion_r388714281", "createdAt": "2020-03-06T05:02:35Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -145,16 +149,23 @@ static void failLateSubscriber(SubscriptionImpl subscription, Subscriber<?> late\n         final Throwable cause = abortedOrLate(oldSubscriber);\n \n         if (subscription.needsDirectInvocation()) {\n-            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-            lateSubscriber.onError(cause);\n+            lateSubscriber(lateSubscriber, cause);\n         } else {\n             subscription.executor().execute(() -> {\n-                lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-                lateSubscriber.onError(cause);\n+                lateSubscriber(lateSubscriber, cause);\n             });\n         }\n     }\n \n+    private static void lateSubscriber(Subscriber<?> lateSubscriber, Throwable cause) {\n+        try {\n+            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n+            lateSubscriber.onError(cause);\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4OTIzNw=="}, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc2OTU0OA==", "bodyText": "I think there are Error that aren't fatal, so better to catch Throwable and we may need a propagateIfFatal like in zipkin\n// Taken from RxJava throwIfFatal, which was taken from scala\n  public static void propagateIfFatal(Throwable t) {\n    if (t instanceof VirtualMachineError) {\n      throw (VirtualMachineError) t;\n    } else if (t instanceof ThreadDeath) {\n      throw (ThreadDeath) t;\n    } else if (t instanceof LinkageError) {\n      throw (LinkageError) t;\n    }\n  }", "url": "https://github.com/line/armeria/pull/2553#discussion_r388769548", "createdAt": "2020-03-06T08:30:02Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -145,16 +149,23 @@ static void failLateSubscriber(SubscriptionImpl subscription, Subscriber<?> late\n         final Throwable cause = abortedOrLate(oldSubscriber);\n \n         if (subscription.needsDirectInvocation()) {\n-            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-            lateSubscriber.onError(cause);\n+            lateSubscriber(lateSubscriber, cause);\n         } else {\n             subscription.executor().execute(() -> {\n-                lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-                lateSubscriber.onError(cause);\n+                lateSubscriber(lateSubscriber, cause);\n             });\n         }\n     }\n \n+    private static void lateSubscriber(Subscriber<?> lateSubscriber, Throwable cause) {\n+        try {\n+            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n+            lateSubscriber.onError(cause);\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4OTIzNw=="}, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc5ODA0Mg==", "bodyText": "Ah, let me add this method to Exceptions. Thanks!", "url": "https://github.com/line/armeria/pull/2553#discussion_r388798042", "createdAt": "2020-03-06T09:32:57Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -145,16 +149,23 @@ static void failLateSubscriber(SubscriptionImpl subscription, Subscriber<?> late\n         final Throwable cause = abortedOrLate(oldSubscriber);\n \n         if (subscription.needsDirectInvocation()) {\n-            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-            lateSubscriber.onError(cause);\n+            lateSubscriber(lateSubscriber, cause);\n         } else {\n             subscription.executor().execute(() -> {\n-                lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-                lateSubscriber.onError(cause);\n+                lateSubscriber(lateSubscriber, cause);\n             });\n         }\n     }\n \n+    private static void lateSubscriber(Subscriber<?> lateSubscriber, Throwable cause) {\n+        try {\n+            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n+            lateSubscriber.onError(cause);\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4OTIzNw=="}, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg3OTQyMA==", "bodyText": "I think we don't have to follow the Reactive Streams TCK, just FYI, which also regards InterruptedException as fatal.\nhttps://github.com/reactive-streams/reactive-streams-jvm/blob/master/tck/src/main/java/org/reactivestreams/tck/flow/support/NonFatal.java#L35\nIt is copied from Scala code.\nhttps://github.com/scala/scala/blob/v2.13.1/src/library/scala/util/control/NonFatal.scala#L41", "url": "https://github.com/line/armeria/pull/2553#discussion_r388879420", "createdAt": "2020-03-06T12:38:03Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -145,16 +149,23 @@ static void failLateSubscriber(SubscriptionImpl subscription, Subscriber<?> late\n         final Throwable cause = abortedOrLate(oldSubscriber);\n \n         if (subscription.needsDirectInvocation()) {\n-            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-            lateSubscriber.onError(cause);\n+            lateSubscriber(lateSubscriber, cause);\n         } else {\n             subscription.executor().execute(() -> {\n-                lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-                lateSubscriber.onError(cause);\n+                lateSubscriber(lateSubscriber, cause);\n             });\n         }\n     }\n \n+    private static void lateSubscriber(Subscriber<?> lateSubscriber, Throwable cause) {\n+        try {\n+            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n+            lateSubscriber.onError(cause);\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4OTIzNw=="}, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg4ODY5OQ==", "bodyText": "Ah yes, I saw it from ReactiveX/RxJava#748 (comment)\nand I think they intentionally omit that. But I didn't think about it deeply. \ud83d\ude06", "url": "https://github.com/line/armeria/pull/2553#discussion_r388888699", "createdAt": "2020-03-06T13:00:09Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -145,16 +149,23 @@ static void failLateSubscriber(SubscriptionImpl subscription, Subscriber<?> late\n         final Throwable cause = abortedOrLate(oldSubscriber);\n \n         if (subscription.needsDirectInvocation()) {\n-            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-            lateSubscriber.onError(cause);\n+            lateSubscriber(lateSubscriber, cause);\n         } else {\n             subscription.executor().execute(() -> {\n-                lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n-                lateSubscriber.onError(cause);\n+                lateSubscriber(lateSubscriber, cause);\n             });\n         }\n     }\n \n+    private static void lateSubscriber(Subscriber<?> lateSubscriber, Throwable cause) {\n+        try {\n+            lateSubscriber.onSubscribe(NoopSubscription.INSTANCE);\n+            lateSubscriber.onError(cause);\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4OTIzNw=="}, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTY1NDkyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/stream/DeferredStreamMessage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzoyNjoyOVrOFyTYgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNTo0Njo1OVrOFytyQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5MDY4OQ==", "bodyText": "Probably OK without 0?", "url": "https://github.com/line/armeria/pull/2553#discussion_r388290689", "createdAt": "2020-03-05T13:26:29Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DeferredStreamMessage.java", "diffHunk": "@@ -228,110 +232,124 @@ private void doCancel() {\n \n     @Override\n     SubscriptionImpl subscribe(SubscriptionImpl subscription) {\n-        if (!subscriptionUpdater.compareAndSet(this, null, subscription)) {\n-            final SubscriptionImpl oldSubscription = this.subscription;\n+        if (!downstreamSubscriptionUpdater.compareAndSet(this, null, subscription)) {\n+            final SubscriptionImpl oldSubscription = downstreamSubscription;\n             assert oldSubscription != null;\n             return oldSubscription;\n         }\n \n         final Subscriber<Object> subscriber = subscription.subscriber();\n         if (subscription.needsDirectInvocation()) {\n-            subscriber.onSubscribe(subscription);\n-            safeOnSubscribeToDelegate();\n+            subscribe0(subscription, subscriber);\n         } else {\n             subscription.executor().execute(() -> {\n-                subscriber.onSubscribe(subscription);\n-                safeOnSubscribeToDelegate();\n+                subscribe0(subscription, subscriber);\n             });\n         }\n \n         return subscription;\n     }\n \n-    private void safeOnSubscribeToDelegate() {\n-        if (delegate == null || subscription == null) {\n+    private void subscribe0(SubscriptionImpl subscription, Subscriber<Object> subscriber) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 242}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcyMzI2Nw==", "bodyText": "Ah yes. Thanks!", "url": "https://github.com/line/armeria/pull/2553#discussion_r388723267", "createdAt": "2020-03-06T05:46:59Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DeferredStreamMessage.java", "diffHunk": "@@ -228,110 +232,124 @@ private void doCancel() {\n \n     @Override\n     SubscriptionImpl subscribe(SubscriptionImpl subscription) {\n-        if (!subscriptionUpdater.compareAndSet(this, null, subscription)) {\n-            final SubscriptionImpl oldSubscription = this.subscription;\n+        if (!downstreamSubscriptionUpdater.compareAndSet(this, null, subscription)) {\n+            final SubscriptionImpl oldSubscription = downstreamSubscription;\n             assert oldSubscription != null;\n             return oldSubscription;\n         }\n \n         final Subscriber<Object> subscriber = subscription.subscriber();\n         if (subscription.needsDirectInvocation()) {\n-            subscriber.onSubscribe(subscription);\n-            safeOnSubscribeToDelegate();\n+            subscribe0(subscription, subscriber);\n         } else {\n             subscription.executor().execute(() -> {\n-                subscriber.onSubscribe(subscription);\n-                safeOnSubscribeToDelegate();\n+                subscribe0(subscription, subscriber);\n             });\n         }\n \n         return subscription;\n     }\n \n-    private void safeOnSubscribeToDelegate() {\n-        if (delegate == null || subscription == null) {\n+    private void subscribe0(SubscriptionImpl subscription, Subscriber<Object> subscriber) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5MDY4OQ=="}, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 242}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTY2NTc2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/stream/DeferredStreamMessage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzoyOTo0NlrOFyTfSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNDo0OToyOVrOFytFdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5MjQyNQ==", "bodyText": "Could you explain why we need to pass them? Can't we access them via downstreamSubscription, since ForwardingSubscriber is not a static class?", "url": "https://github.com/line/armeria/pull/2553#discussion_r388292425", "createdAt": "2020-03-05T13:29:46Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DeferredStreamMessage.java", "diffHunk": "@@ -228,110 +232,124 @@ private void doCancel() {\n \n     @Override\n     SubscriptionImpl subscribe(SubscriptionImpl subscription) {\n-        if (!subscriptionUpdater.compareAndSet(this, null, subscription)) {\n-            final SubscriptionImpl oldSubscription = this.subscription;\n+        if (!downstreamSubscriptionUpdater.compareAndSet(this, null, subscription)) {\n+            final SubscriptionImpl oldSubscription = downstreamSubscription;\n             assert oldSubscription != null;\n             return oldSubscription;\n         }\n \n         final Subscriber<Object> subscriber = subscription.subscriber();\n         if (subscription.needsDirectInvocation()) {\n-            subscriber.onSubscribe(subscription);\n-            safeOnSubscribeToDelegate();\n+            subscribe0(subscription, subscriber);\n         } else {\n             subscription.executor().execute(() -> {\n-                subscriber.onSubscribe(subscription);\n-                safeOnSubscribeToDelegate();\n+                subscribe0(subscription, subscriber);\n             });\n         }\n \n         return subscription;\n     }\n \n-    private void safeOnSubscribeToDelegate() {\n-        if (delegate == null || subscription == null) {\n+    private void subscribe0(SubscriptionImpl subscription, Subscriber<Object> subscriber) {\n+        try {\n+            subscriber.onSubscribe(subscription);\n+        } catch (Exception e) {\n+            abort(e);\n+            return;\n+        }\n+        safeOnSubscribeToUpstream();\n+    }\n+\n+    private void safeOnSubscribeToUpstream() {\n+        final StreamMessage<T> upstream = this.upstream;\n+        final SubscriptionImpl downstreamSubscription = this.downstreamSubscription;\n+        if (upstream == null || downstreamSubscription == null) {\n             return;\n         }\n \n-        if (!subscribedToDelegateUpdater.compareAndSet(this, 0, 1)) {\n+        if (!subscribedToUpstreamUpdater.compareAndSet(this, 0, 1)) {\n             return;\n         }\n \n         final Builder<SubscriptionOption> builder = ImmutableList.builder();\n-        if (subscription.withPooledObjects()) {\n+        if (downstreamSubscription.withPooledObjects()) {\n             builder.add(SubscriptionOption.WITH_POOLED_OBJECTS);\n         }\n-        if (subscription.notifyCancellation()) {\n+        if (downstreamSubscription.notifyCancellation()) {\n             builder.add(SubscriptionOption.NOTIFY_CANCELLATION);\n         }\n \n-        delegate.subscribe(new ForwardingSubscriber(),\n-                           subscription.executor(),\n+        upstream.subscribe(new ForwardingSubscriber(downstreamSubscription.subscriber()),\n+                           downstreamSubscription.executor(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 277}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMTc5OA==", "bodyText": "We always have the reference of the downstreamSubscription at this time and it is a volatile field. Before I made this change, we always access this volatile field when we call methods on the subscriber. But now we don't have to. \ud83d\ude04", "url": "https://github.com/line/armeria/pull/2553#discussion_r388711798", "createdAt": "2020-03-06T04:49:29Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DeferredStreamMessage.java", "diffHunk": "@@ -228,110 +232,124 @@ private void doCancel() {\n \n     @Override\n     SubscriptionImpl subscribe(SubscriptionImpl subscription) {\n-        if (!subscriptionUpdater.compareAndSet(this, null, subscription)) {\n-            final SubscriptionImpl oldSubscription = this.subscription;\n+        if (!downstreamSubscriptionUpdater.compareAndSet(this, null, subscription)) {\n+            final SubscriptionImpl oldSubscription = downstreamSubscription;\n             assert oldSubscription != null;\n             return oldSubscription;\n         }\n \n         final Subscriber<Object> subscriber = subscription.subscriber();\n         if (subscription.needsDirectInvocation()) {\n-            subscriber.onSubscribe(subscription);\n-            safeOnSubscribeToDelegate();\n+            subscribe0(subscription, subscriber);\n         } else {\n             subscription.executor().execute(() -> {\n-                subscriber.onSubscribe(subscription);\n-                safeOnSubscribeToDelegate();\n+                subscribe0(subscription, subscriber);\n             });\n         }\n \n         return subscription;\n     }\n \n-    private void safeOnSubscribeToDelegate() {\n-        if (delegate == null || subscription == null) {\n+    private void subscribe0(SubscriptionImpl subscription, Subscriber<Object> subscriber) {\n+        try {\n+            subscriber.onSubscribe(subscription);\n+        } catch (Exception e) {\n+            abort(e);\n+            return;\n+        }\n+        safeOnSubscribeToUpstream();\n+    }\n+\n+    private void safeOnSubscribeToUpstream() {\n+        final StreamMessage<T> upstream = this.upstream;\n+        final SubscriptionImpl downstreamSubscription = this.downstreamSubscription;\n+        if (upstream == null || downstreamSubscription == null) {\n             return;\n         }\n \n-        if (!subscribedToDelegateUpdater.compareAndSet(this, 0, 1)) {\n+        if (!subscribedToUpstreamUpdater.compareAndSet(this, 0, 1)) {\n             return;\n         }\n \n         final Builder<SubscriptionOption> builder = ImmutableList.builder();\n-        if (subscription.withPooledObjects()) {\n+        if (downstreamSubscription.withPooledObjects()) {\n             builder.add(SubscriptionOption.WITH_POOLED_OBJECTS);\n         }\n-        if (subscription.notifyCancellation()) {\n+        if (downstreamSubscription.notifyCancellation()) {\n             builder.add(SubscriptionOption.NOTIFY_CANCELLATION);\n         }\n \n-        delegate.subscribe(new ForwardingSubscriber(),\n-                           subscription.executor(),\n+        upstream.subscribe(new ForwardingSubscriber(downstreamSubscription.subscriber()),\n+                           downstreamSubscription.executor(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5MjQyNQ=="}, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 277}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTY2NjgwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/stream/FixedStreamMessage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzozMDowN1rOFyTf8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwNDo0OTo0NFrOFytFrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5MjU5NQ==", "bodyText": "Ditto - 0 could be removed?", "url": "https://github.com/line/armeria/pull/2553#discussion_r388292595", "createdAt": "2020-03-05T13:30:07Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/FixedStreamMessage.java", "diffHunk": "@@ -112,14 +112,23 @@ final SubscriptionImpl subscribe(SubscriptionImpl subscription) {\n \n         final Subscriber<Object> subscriber = subscription.subscriber();\n         if (subscription.needsDirectInvocation()) {\n-            subscriber.onSubscribe(subscription);\n+            subscribe0(subscription, subscriber);\n         } else {\n-            subscription.executor().execute(() -> subscriber.onSubscribe(subscription));\n+            subscription.executor().execute(() -> subscribe0(subscription, subscriber));\n         }\n \n         return subscription;\n     }\n \n+    private void subscribe0(SubscriptionImpl subscription, Subscriber<Object> subscriber) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMTg1Mg==", "bodyText": "I will. \ud83d\ude04", "url": "https://github.com/line/armeria/pull/2553#discussion_r388711852", "createdAt": "2020-03-06T04:49:44Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/FixedStreamMessage.java", "diffHunk": "@@ -112,14 +112,23 @@ final SubscriptionImpl subscribe(SubscriptionImpl subscription) {\n \n         final Subscriber<Object> subscriber = subscription.subscriber();\n         if (subscription.needsDirectInvocation()) {\n-            subscriber.onSubscribe(subscription);\n+            subscribe0(subscription, subscriber);\n         } else {\n-            subscription.executor().execute(() -> subscriber.onSubscribe(subscription));\n+            subscription.executor().execute(() -> subscribe0(subscription, subscriber));\n         }\n \n         return subscription;\n     }\n \n+    private void subscribe0(SubscriptionImpl subscription, Subscriber<Object> subscriber) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5MjU5NQ=="}, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNTY4MDMwOnYy", "diffSide": "RIGHT", "path": "core/src/test/java/com/linecorp/armeria/common/stream/SubscriberThrowingExceptionTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMzozNDowNFrOFyToKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwODo1ODoyNVrOFze-hQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5NDY5Nw==", "bodyText": "I wonder if we should move the tests to StreamMessageVerification.", "url": "https://github.com/line/armeria/pull/2553#discussion_r388294697", "createdAt": "2020-03-05T13:34:04Z", "author": {"login": "trustin"}, "path": "core/src/test/java/com/linecorp/armeria/common/stream/SubscriberThrowingExceptionTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.stream;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.assertj.core.api.Assertions.catchThrowable;\n+\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n+import org.reactivestreams.Subscriber;\n+import org.reactivestreams.Subscription;\n+\n+import com.linecorp.armeria.internal.testing.AnticipatedException;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.UnpooledByteBufAllocator;\n+import io.netty.util.concurrent.ImmediateEventExecutor;\n+\n+class SubscriberThrowingExceptionTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODcxMzcwNA==", "bodyText": "Currently, they don't have the TCK for this case and this is violating the spec, so the test will fail if they have, I think. \ud83e\udd14\nSo it's like more for our implementation.", "url": "https://github.com/line/armeria/pull/2553#discussion_r388713704", "createdAt": "2020-03-06T04:59:47Z", "author": {"login": "minwoox"}, "path": "core/src/test/java/com/linecorp/armeria/common/stream/SubscriberThrowingExceptionTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.stream;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.assertj.core.api.Assertions.catchThrowable;\n+\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n+import org.reactivestreams.Subscriber;\n+import org.reactivestreams.Subscription;\n+\n+import com.linecorp.armeria.internal.testing.AnticipatedException;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.UnpooledByteBufAllocator;\n+import io.netty.util.concurrent.ImmediateEventExecutor;\n+\n+class SubscriberThrowingExceptionTest {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5NDY5Nw=="}, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUyOTIyMQ==", "bodyText": "StreamMessageVerification is our class, so we can perhaps test the failure scenarios there?", "url": "https://github.com/line/armeria/pull/2553#discussion_r389529221", "createdAt": "2020-03-09T08:58:25Z", "author": {"login": "trustin"}, "path": "core/src/test/java/com/linecorp/armeria/common/stream/SubscriberThrowingExceptionTest.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.stream;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.assertj.core.api.Assertions.catchThrowable;\n+\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n+import org.reactivestreams.Subscriber;\n+import org.reactivestreams.Subscription;\n+\n+import com.linecorp.armeria.internal.testing.AnticipatedException;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.UnpooledByteBufAllocator;\n+import io.netty.util.concurrent.ImmediateEventExecutor;\n+\n+class SubscriberThrowingExceptionTest {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI5NDY5Nw=="}, "originalCommit": {"oid": "d0857ce69c2294ef360824b1cb7090a47b0a3cb7"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwODc0MzM1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwODozNDoyNFrOFywt_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwODozNDoyNFrOFywt_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3MTMyNw==", "bodyText": "I think we should complete completionFuture with this error instead of treating this as a success scenario.", "url": "https://github.com/line/armeria/pull/2553#discussion_r388771327", "createdAt": "2020-03-06T08:34:24Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -291,6 +295,9 @@ void notifySubscriber(SubscriptionImpl subscription, CompletableFuture<?> comple\n             if (cause == null) {\n                 try {\n                     subscriber.onComplete();\n+                } catch (Exception e) {\n+                    logger.warn(\"Subscriber.onComplete() should not raise an exception. subscriber: {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e131ab1f81c276b8bc595b29bb722c58cbdf00fd"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwODc0NDAzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "isResolved": true, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQwODozNDo0NFrOFywudw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwOToxNjoxN1rOFzfe-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3MTQ0Nw==", "bodyText": "We can probably create an exception that wraps cause and complete the future with it for this case so the exception isn't lost.", "url": "https://github.com/line/armeria/pull/2553#discussion_r388771447", "createdAt": "2020-03-06T08:34:44Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -299,6 +306,9 @@ void notifySubscriber(SubscriptionImpl subscription, CompletableFuture<?> comple\n                     if (subscription.notifyCancellation || !(cause instanceof CancelledSubscriptionException)) {\n                         subscriber.onError(cause);\n                     }\n+                } catch (Exception e) {\n+                    logger.warn(\"Subscriber.onError() should not raise an exception. subscriber: {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e131ab1f81c276b8bc595b29bb722c58cbdf00fd"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc5NTIyNw==", "bodyText": "Ah that's a good point. Let me fix this.", "url": "https://github.com/line/armeria/pull/2553#discussion_r388795227", "createdAt": "2020-03-06T09:27:45Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -299,6 +306,9 @@ void notifySubscriber(SubscriptionImpl subscription, CompletableFuture<?> comple\n                     if (subscription.notifyCancellation || !(cause instanceof CancelledSubscriptionException)) {\n                         subscriber.onError(cause);\n                     }\n+                } catch (Exception e) {\n+                    logger.warn(\"Subscriber.onError() should not raise an exception. subscriber: {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3MTQ0Nw=="}, "originalCommit": {"oid": "e131ab1f81c276b8bc595b29bb722c58cbdf00fd"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg0MDI2Nw==", "bodyText": "So you mean we have to define a new sort of composite exception which has the cause and e here, in this case?", "url": "https://github.com/line/armeria/pull/2553#discussion_r388840267", "createdAt": "2020-03-06T10:59:19Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -299,6 +306,9 @@ void notifySubscriber(SubscriptionImpl subscription, CompletableFuture<?> comple\n                     if (subscription.notifyCancellation || !(cause instanceof CancelledSubscriptionException)) {\n                         subscriber.onError(cause);\n                     }\n+                } catch (Exception e) {\n+                    logger.warn(\"Subscriber.onError() should not raise an exception. subscriber: {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3MTQ0Nw=="}, "originalCommit": {"oid": "e131ab1f81c276b8bc595b29bb722c58cbdf00fd"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1Mjg4OQ==", "bodyText": "sort of this one?", "url": "https://github.com/line/armeria/pull/2553#discussion_r388852889", "createdAt": "2020-03-06T11:29:31Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -299,6 +306,9 @@ void notifySubscriber(SubscriptionImpl subscription, CompletableFuture<?> comple\n                     if (subscription.notifyCancellation || !(cause instanceof CancelledSubscriptionException)) {\n                         subscriber.onError(cause);\n                     }\n+                } catch (Exception e) {\n+                    logger.warn(\"Subscriber.onError() should not raise an exception. subscriber: {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3MTQ0Nw=="}, "originalCommit": {"oid": "e131ab1f81c276b8bc595b29bb722c58cbdf00fd"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg1NzQ0NQ==", "bodyText": "Yeah I was thinking something like that :)", "url": "https://github.com/line/armeria/pull/2553#discussion_r388857445", "createdAt": "2020-03-06T11:41:12Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -299,6 +306,9 @@ void notifySubscriber(SubscriptionImpl subscription, CompletableFuture<?> comple\n                     if (subscription.notifyCancellation || !(cause instanceof CancelledSubscriptionException)) {\n                         subscriber.onError(cause);\n                     }\n+                } catch (Exception e) {\n+                    logger.warn(\"Subscriber.onError() should not raise an exception. subscriber: {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3MTQ0Nw=="}, "originalCommit": {"oid": "e131ab1f81c276b8bc595b29bb722c58cbdf00fd"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODg5MDM2OA==", "bodyText": "Just copied the code from them because it seems they implemented well. \ud83d\ude04", "url": "https://github.com/line/armeria/pull/2553#discussion_r388890368", "createdAt": "2020-03-06T13:04:03Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -299,6 +306,9 @@ void notifySubscriber(SubscriptionImpl subscription, CompletableFuture<?> comple\n                     if (subscription.notifyCancellation || !(cause instanceof CancelledSubscriptionException)) {\n                         subscriber.onError(cause);\n                     }\n+                } catch (Exception e) {\n+                    logger.warn(\"Subscriber.onError() should not raise an exception. subscriber: {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3MTQ0Nw=="}, "originalCommit": {"oid": "e131ab1f81c276b8bc595b29bb722c58cbdf00fd"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUyOTg1Mg==", "bodyText": "Can't we just use Throwable.addSuppressed()?", "url": "https://github.com/line/armeria/pull/2553#discussion_r389529852", "createdAt": "2020-03-09T08:59:43Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -299,6 +306,9 @@ void notifySubscriber(SubscriptionImpl subscription, CompletableFuture<?> comple\n                     if (subscription.notifyCancellation || !(cause instanceof CancelledSubscriptionException)) {\n                         subscriber.onError(cause);\n                     }\n+                } catch (Exception e) {\n+                    logger.warn(\"Subscriber.onError() should not raise an exception. subscriber: {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3MTQ0Nw=="}, "originalCommit": {"oid": "e131ab1f81c276b8bc595b29bb722c58cbdf00fd"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUzMTIwOA==", "bodyText": "What should we do if we catch a fatal exception? Perhaps add the less fatal one using addSuppressed() and throw?", "url": "https://github.com/line/armeria/pull/2553#discussion_r389531208", "createdAt": "2020-03-09T09:02:48Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -299,6 +306,9 @@ void notifySubscriber(SubscriptionImpl subscription, CompletableFuture<?> comple\n                     if (subscription.notifyCancellation || !(cause instanceof CancelledSubscriptionException)) {\n                         subscriber.onError(cause);\n                     }\n+                } catch (Exception e) {\n+                    logger.warn(\"Subscriber.onError() should not raise an exception. subscriber: {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3MTQ0Nw=="}, "originalCommit": {"oid": "e131ab1f81c276b8bc595b29bb722c58cbdf00fd"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUzNzUyOQ==", "bodyText": "Never mind. It looks OK.", "url": "https://github.com/line/armeria/pull/2553#discussion_r389537529", "createdAt": "2020-03-09T09:16:17Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -299,6 +306,9 @@ void notifySubscriber(SubscriptionImpl subscription, CompletableFuture<?> comple\n                     if (subscription.notifyCancellation || !(cause instanceof CancelledSubscriptionException)) {\n                         subscriber.onError(cause);\n                     }\n+                } catch (Exception e) {\n+                    logger.warn(\"Subscriber.onError() should not raise an exception. subscriber: {}\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc3MTQ0Nw=="}, "originalCommit": {"oid": "e131ab1f81c276b8bc595b29bb722c58cbdf00fd"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMzkyMDY4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/Exceptions.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwOToyMTo1N1rOFzfprA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwOToyNDoxNVrOFzfuTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0MDI2OA==", "bodyText": "What about OutOfMemoryError?", "url": "https://github.com/line/armeria/pull/2553#discussion_r389540268", "createdAt": "2020-03-09T09:21:57Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/Exceptions.java", "diffHunk": "@@ -222,6 +222,38 @@ public static boolean isStreamCancelling(Throwable cause) {\n         return null; // Never reaches here.\n     }\n \n+    // This is copied from\n+    // https://github.com/ReactiveX/RxJava/blob/v3.0.0/src/main/java/io/reactivex/rxjava3/exceptions/Exceptions.java\n+\n+    /**\n+     * Throws a particular {@code Throwable} only if it belongs to a set of \"fatal\" error varieties. These\n+     * varieties are as follows:\n+     * <ul>\n+     * <li>{@code VirtualMachineError}</li>\n+     * <li>{@code ThreadDeath}</li>\n+     * <li>{@code LinkageError}</li>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0MTQ1NQ==", "bodyText": "Ah, it extends VirtualMachineError. \ud83d\ude05", "url": "https://github.com/line/armeria/pull/2553#discussion_r389541455", "createdAt": "2020-03-09T09:24:15Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/Exceptions.java", "diffHunk": "@@ -222,6 +222,38 @@ public static boolean isStreamCancelling(Throwable cause) {\n         return null; // Never reaches here.\n     }\n \n+    // This is copied from\n+    // https://github.com/ReactiveX/RxJava/blob/v3.0.0/src/main/java/io/reactivex/rxjava3/exceptions/Exceptions.java\n+\n+    /**\n+     * Throws a particular {@code Throwable} only if it belongs to a set of \"fatal\" error varieties. These\n+     * varieties are as follows:\n+     * <ul>\n+     * <li>{@code VirtualMachineError}</li>\n+     * <li>{@code ThreadDeath}</li>\n+     * <li>{@code LinkageError}</li>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0MDI2OA=="}, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMzkzMDI5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwOToyNDo0N1rOFzfvZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwOTozOTowMVrOFzgMhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0MTczMw==", "bodyText": "2020", "url": "https://github.com/line/armeria/pull/2553#discussion_r389541733", "createdAt": "2020-03-09T09:24:47Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ * Copyright 2016 LINE Corporation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0OTE4OQ==", "bodyText": "\ud83d\ude05", "url": "https://github.com/line/armeria/pull/2553#discussion_r389549189", "createdAt": "2020-03-09T09:39:01Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ * Copyright 2016 LINE Corporation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0MTczMw=="}, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMzkzMjI0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwOToyNToyM1rOFzfwmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwOTozOToxOVrOFzgNFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0MjA0MQ==", "bodyText": "Could you update NOTICE.txt and licenses/ directory?", "url": "https://github.com/line/armeria/pull/2553#discussion_r389542041", "createdAt": "2020-03-09T09:25:23Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ * Copyright 2016 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/*\n+ * Copyright (c) 2016-present, RxJava Contributors.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0OTMzNA==", "bodyText": "Oops, I thought we already had it.", "url": "https://github.com/line/armeria/pull/2553#discussion_r389549334", "createdAt": "2020-03-09T09:39:19Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ * Copyright 2016 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/*\n+ * Copyright (c) 2016-present, RxJava Contributors.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU0MjA0MQ=="}, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNDM0Mzk2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/stream/DeferredStreamMessage.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMTozNjoyN1rOFzjprg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMToyNDozNFrOFz-i2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYwNTgwNg==", "bodyText": "This seems dead code.", "url": "https://github.com/line/armeria/pull/2553#discussion_r389605806", "createdAt": "2020-03-09T11:36:27Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DeferredStreamMessage.java", "diffHunk": "@@ -43,21 +45,23 @@\n @UnstableApi\n public class DeferredStreamMessage<T> extends AbstractStreamMessage<T> {\n \n+    private static final Logger logger = LoggerFactory.getLogger(DeferredStreamMessage.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA0NjQyNg==", "bodyText": "Oops Thanks! Fixed. \ud83d\ude09", "url": "https://github.com/line/armeria/pull/2553#discussion_r390046426", "createdAt": "2020-03-10T01:24:34Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DeferredStreamMessage.java", "diffHunk": "@@ -43,21 +45,23 @@\n @UnstableApi\n public class DeferredStreamMessage<T> extends AbstractStreamMessage<T> {\n \n+    private static final Logger logger = LoggerFactory.getLogger(DeferredStreamMessage.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYwNTgwNg=="}, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNDM2MDI5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/stream/DeferredStreamMessage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMTo0MTo1OFrOFzjzIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMTo0MTo1OFrOFzjzIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYwODIyNA==", "bodyText": "nit: not related to this PR\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final Builder<SubscriptionOption> builder = ImmutableList.builder();\n          \n          \n            \n                    final ImmutableList.Builder<SubscriptionOption> builder = ImmutableList.builder();", "url": "https://github.com/line/armeria/pull/2553#discussion_r389608224", "createdAt": "2020-03-09T11:41:58Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DeferredStreamMessage.java", "diffHunk": "@@ -228,110 +232,124 @@ private void doCancel() {\n \n     @Override\n     SubscriptionImpl subscribe(SubscriptionImpl subscription) {\n-        if (!subscriptionUpdater.compareAndSet(this, null, subscription)) {\n-            final SubscriptionImpl oldSubscription = this.subscription;\n+        if (!downstreamSubscriptionUpdater.compareAndSet(this, null, subscription)) {\n+            final SubscriptionImpl oldSubscription = downstreamSubscription;\n             assert oldSubscription != null;\n             return oldSubscription;\n         }\n \n         final Subscriber<Object> subscriber = subscription.subscriber();\n         if (subscription.needsDirectInvocation()) {\n-            subscriber.onSubscribe(subscription);\n-            safeOnSubscribeToDelegate();\n+            subscribe(subscription, subscriber);\n         } else {\n             subscription.executor().execute(() -> {\n-                subscriber.onSubscribe(subscription);\n-                safeOnSubscribeToDelegate();\n+                subscribe(subscription, subscriber);\n             });\n         }\n \n         return subscription;\n     }\n \n-    private void safeOnSubscribeToDelegate() {\n-        if (delegate == null || subscription == null) {\n+    private void subscribe(SubscriptionImpl subscription, Subscriber<Object> subscriber) {\n+        try {\n+            subscriber.onSubscribe(subscription);\n+        } catch (Exception e) {\n+            abort(e);\n+            return;\n+        }\n+        safeOnSubscribeToUpstream();\n+    }\n+\n+    private void safeOnSubscribeToUpstream() {\n+        final StreamMessage<T> upstream = this.upstream;\n+        final SubscriptionImpl downstreamSubscription = this.downstreamSubscription;\n+        if (upstream == null || downstreamSubscription == null) {\n             return;\n         }\n \n-        if (!subscribedToDelegateUpdater.compareAndSet(this, 0, 1)) {\n+        if (!subscribedToUpstreamUpdater.compareAndSet(this, 0, 1)) {\n             return;\n         }\n \n         final Builder<SubscriptionOption> builder = ImmutableList.builder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 264}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNDM4ODkwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMTo1MjoxOFrOFzkEaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMToyNDo1M1rOFz-jFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxMjY0OQ==", "bodyText": "Join two lines?", "url": "https://github.com/line/armeria/pull/2553#discussion_r389612649", "createdAt": "2020-03-09T11:52:18Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ * Copyright 2016 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/*\n+ * Copyright (c) 2016-present, RxJava Contributors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.io.PrintStream;\n+import java.io.PrintWriter;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.IdentityHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+/**\n+ * Represents an exception that is a composite of one or more other exceptions. A {@code CompositeException}\n+ * does not modify the structure of any exception it wraps, but at print-time it iterates through the list of\n+ * Throwables contained in the composite in order to print them all.\n+ *\n+ * <p>Its invariant is to contain an immutable, ordered (by insertion order), unique list of non-composite\n+ * exceptions. You can retrieve individual exceptions in this list with {@link #getExceptions()}.\n+ *\n+ * <p>The {@link #printStackTrace()} implementation handles the StackTrace in a customized way instead of using\n+ * {@code getCause()} so that it can avoid circular references.\n+ *\n+ * <p>If you invoke {@link #getCause()}, it will lazily create the causal chain but will stop if it finds any\n+ * Throwable in the chain that it has already seen.\n+ */\n+public final class CompositeException extends RuntimeException {\n+\n+    // Forked from RxJava 3.0.0 at e793bc1d1a29dca18be795cf4a7628e2d44a4234\n+\n+    private static final long serialVersionUID = 3026362227162912146L;\n+\n+    private final List<Throwable> exceptions;\n+    private final String message;\n+\n+    @Nullable\n+    private Throwable cause;\n+\n+    /**\n+     * Constructs a CompositeException with the given array of Throwables as the\n+     * list of suppressed exceptions.\n+     * @param exceptions the Throwables to have as initially suppressed exceptions\n+     *\n+     * @throws IllegalArgumentException if <code>exceptions</code> is empty.\n+     */\n+    public CompositeException(Throwable... exceptions) {\n+        this(ImmutableList.copyOf(requireNonNull(exceptions, \"exceptions\")));\n+    }\n+\n+    /**\n+     * Constructs a CompositeException with the given array of Throwables as the\n+     * list of suppressed exceptions.\n+     * @param errors the Throwables to have as initially suppressed exceptions\n+     *\n+     * @throws IllegalArgumentException if <code>errors</code> is empty.\n+     */\n+    public CompositeException(Iterable<? extends Throwable> errors) {\n+        requireNonNull(errors, \"errors\");\n+        final Set<Throwable> deDupedExceptions = new LinkedHashSet<>();\n+        for (Throwable ex : errors) {\n+            if (ex instanceof CompositeException) {\n+                deDupedExceptions.addAll(((CompositeException) ex).getExceptions());\n+            } else if (ex != null) {\n+                deDupedExceptions.add(ex);\n+            } else {\n+                deDupedExceptions.add(new NullPointerException(\"Throwable was null!\"));\n+            }\n+        }\n+        if (deDupedExceptions.isEmpty()) {\n+            throw new IllegalArgumentException(\"errors is empty\");\n+        }\n+        final List<Throwable> localExceptions = new ArrayList<>(deDupedExceptions);\n+        exceptions = Collections.unmodifiableList(localExceptions);\n+        message = exceptions.size() + \" exceptions occurred. \";\n+    }\n+\n+    /**\n+     * Retrieves the list of exceptions that make up the {@code CompositeException}.\n+     *\n+     * @return the exceptions that make up the {@code CompositeException},\n+     *         as a {@link List} of {@link Throwable}s\n+     */\n+    public List<Throwable> getExceptions() {\n+        return exceptions;\n+    }\n+\n+    @Override\n+    public String getMessage() {\n+        return message;\n+    }\n+\n+    @Override\n+    public synchronized Throwable getCause() { // NOPMD\n+        if (cause == null) {\n+            final String separator = System.getProperty(\"line.separator\");\n+            if (exceptions.size() > 1) {\n+                final Map<Throwable, Boolean> seenCauses = new IdentityHashMap<>();\n+\n+                final StringBuilder aggregateMessage = new StringBuilder();\n+                aggregateMessage.append(\"Multiple exceptions (\").append(exceptions.size()).append(')').append(\n+                        separator);\n+\n+                for (Throwable inner : exceptions) {\n+                    int depth = 0;\n+                    while (inner != null) {\n+                        for (int i = 0; i < depth; i++) {\n+                            aggregateMessage.append(\"  \");\n+                        }\n+                        aggregateMessage.append(\"|-- \");\n+                        aggregateMessage.append(inner.getClass().getCanonicalName()).append(\": \");\n+                        final String innerMessage = inner.getMessage();\n+                        if (innerMessage != null && innerMessage.contains(separator)) {\n+                            aggregateMessage.append(separator);\n+                            for (String line : innerMessage.split(separator)) {\n+                                for (int i = 0; i < depth + 2; i++) {\n+                                    aggregateMessage.append(\"  \");\n+                                }\n+                                aggregateMessage.append(line).append(separator);\n+                            }\n+                        } else {\n+                            aggregateMessage.append(innerMessage);\n+                            aggregateMessage.append(separator);\n+                        }\n+\n+                        for (int i = 0; i < depth + 2; i++) {\n+                            aggregateMessage.append(\"  \");\n+                        }\n+                        final StackTraceElement[] st = inner.getStackTrace();\n+                        if (st.length > 0) {\n+                            aggregateMessage.append(\"at \").append(st[0]).append(separator);\n+                        }\n+\n+                        if (!seenCauses.containsKey(inner)) {\n+                            seenCauses.put(inner, true);\n+\n+                            inner = inner.getCause();\n+                            depth++;\n+                        } else {\n+                            inner = inner.getCause();\n+                            if (inner != null) {\n+                                for (int i = 0; i < depth + 2; i++) {\n+                                    aggregateMessage.append(\"  \");\n+                                }\n+                                aggregateMessage.append(\"|-- \");\n+                                aggregateMessage.append(\"(cause not expanded again) \");\n+                                aggregateMessage.append(inner.getClass().getCanonicalName()).append(\": \");\n+                                aggregateMessage.append(inner.getMessage());\n+                                aggregateMessage.append(separator);\n+                            }\n+                            break;\n+                        }\n+                    }\n+                }\n+\n+                cause = new ExceptionOverview(aggregateMessage.toString().trim());\n+            } else {\n+                cause = exceptions.get(0);\n+            }\n+        }\n+        return cause;\n+    }\n+\n+    /**\n+     * All of the following {@code printStackTrace} functionality is derived from JDK {@link Throwable}\n+     * {@code printStackTrace}. In particular, the {@code PrintStreamOrWriter} abstraction is copied wholesale.\n+     *\n+     * <p>Changes from the official JDK implementation:<ul>\n+     * <li>no infinite loop detection</li>\n+     * <li>smaller critical section holding {@link PrintStream} lock</li>\n+     * <li>explicit knowledge about the exceptions {@link List} that this loops through</li>\n+     * </ul>\n+     */\n+    @Override\n+    public void printStackTrace() {\n+        printStackTrace(System.err);\n+    }\n+\n+    @Override\n+    public void printStackTrace(PrintStream s) {\n+        printStackTrace(new WrappedPrintStream(s));\n+    }\n+\n+    @Override\n+    public void printStackTrace(PrintWriter s) {\n+        printStackTrace(new WrappedPrintWriter(s));\n+    }\n+\n+    /**\n+     * Special handling for printing out a {@code CompositeException}.\n+     * Loops through all inner exceptions and prints them out.\n+     *\n+     * @param s\n+     *            stream to print to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 229}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA0NjQ4Nw==", "bodyText": "All fixed. \ud83d\ude09", "url": "https://github.com/line/armeria/pull/2553#discussion_r390046487", "createdAt": "2020-03-10T01:24:53Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ * Copyright 2016 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/*\n+ * Copyright (c) 2016-present, RxJava Contributors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.io.PrintStream;\n+import java.io.PrintWriter;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.IdentityHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+/**\n+ * Represents an exception that is a composite of one or more other exceptions. A {@code CompositeException}\n+ * does not modify the structure of any exception it wraps, but at print-time it iterates through the list of\n+ * Throwables contained in the composite in order to print them all.\n+ *\n+ * <p>Its invariant is to contain an immutable, ordered (by insertion order), unique list of non-composite\n+ * exceptions. You can retrieve individual exceptions in this list with {@link #getExceptions()}.\n+ *\n+ * <p>The {@link #printStackTrace()} implementation handles the StackTrace in a customized way instead of using\n+ * {@code getCause()} so that it can avoid circular references.\n+ *\n+ * <p>If you invoke {@link #getCause()}, it will lazily create the causal chain but will stop if it finds any\n+ * Throwable in the chain that it has already seen.\n+ */\n+public final class CompositeException extends RuntimeException {\n+\n+    // Forked from RxJava 3.0.0 at e793bc1d1a29dca18be795cf4a7628e2d44a4234\n+\n+    private static final long serialVersionUID = 3026362227162912146L;\n+\n+    private final List<Throwable> exceptions;\n+    private final String message;\n+\n+    @Nullable\n+    private Throwable cause;\n+\n+    /**\n+     * Constructs a CompositeException with the given array of Throwables as the\n+     * list of suppressed exceptions.\n+     * @param exceptions the Throwables to have as initially suppressed exceptions\n+     *\n+     * @throws IllegalArgumentException if <code>exceptions</code> is empty.\n+     */\n+    public CompositeException(Throwable... exceptions) {\n+        this(ImmutableList.copyOf(requireNonNull(exceptions, \"exceptions\")));\n+    }\n+\n+    /**\n+     * Constructs a CompositeException with the given array of Throwables as the\n+     * list of suppressed exceptions.\n+     * @param errors the Throwables to have as initially suppressed exceptions\n+     *\n+     * @throws IllegalArgumentException if <code>errors</code> is empty.\n+     */\n+    public CompositeException(Iterable<? extends Throwable> errors) {\n+        requireNonNull(errors, \"errors\");\n+        final Set<Throwable> deDupedExceptions = new LinkedHashSet<>();\n+        for (Throwable ex : errors) {\n+            if (ex instanceof CompositeException) {\n+                deDupedExceptions.addAll(((CompositeException) ex).getExceptions());\n+            } else if (ex != null) {\n+                deDupedExceptions.add(ex);\n+            } else {\n+                deDupedExceptions.add(new NullPointerException(\"Throwable was null!\"));\n+            }\n+        }\n+        if (deDupedExceptions.isEmpty()) {\n+            throw new IllegalArgumentException(\"errors is empty\");\n+        }\n+        final List<Throwable> localExceptions = new ArrayList<>(deDupedExceptions);\n+        exceptions = Collections.unmodifiableList(localExceptions);\n+        message = exceptions.size() + \" exceptions occurred. \";\n+    }\n+\n+    /**\n+     * Retrieves the list of exceptions that make up the {@code CompositeException}.\n+     *\n+     * @return the exceptions that make up the {@code CompositeException},\n+     *         as a {@link List} of {@link Throwable}s\n+     */\n+    public List<Throwable> getExceptions() {\n+        return exceptions;\n+    }\n+\n+    @Override\n+    public String getMessage() {\n+        return message;\n+    }\n+\n+    @Override\n+    public synchronized Throwable getCause() { // NOPMD\n+        if (cause == null) {\n+            final String separator = System.getProperty(\"line.separator\");\n+            if (exceptions.size() > 1) {\n+                final Map<Throwable, Boolean> seenCauses = new IdentityHashMap<>();\n+\n+                final StringBuilder aggregateMessage = new StringBuilder();\n+                aggregateMessage.append(\"Multiple exceptions (\").append(exceptions.size()).append(')').append(\n+                        separator);\n+\n+                for (Throwable inner : exceptions) {\n+                    int depth = 0;\n+                    while (inner != null) {\n+                        for (int i = 0; i < depth; i++) {\n+                            aggregateMessage.append(\"  \");\n+                        }\n+                        aggregateMessage.append(\"|-- \");\n+                        aggregateMessage.append(inner.getClass().getCanonicalName()).append(\": \");\n+                        final String innerMessage = inner.getMessage();\n+                        if (innerMessage != null && innerMessage.contains(separator)) {\n+                            aggregateMessage.append(separator);\n+                            for (String line : innerMessage.split(separator)) {\n+                                for (int i = 0; i < depth + 2; i++) {\n+                                    aggregateMessage.append(\"  \");\n+                                }\n+                                aggregateMessage.append(line).append(separator);\n+                            }\n+                        } else {\n+                            aggregateMessage.append(innerMessage);\n+                            aggregateMessage.append(separator);\n+                        }\n+\n+                        for (int i = 0; i < depth + 2; i++) {\n+                            aggregateMessage.append(\"  \");\n+                        }\n+                        final StackTraceElement[] st = inner.getStackTrace();\n+                        if (st.length > 0) {\n+                            aggregateMessage.append(\"at \").append(st[0]).append(separator);\n+                        }\n+\n+                        if (!seenCauses.containsKey(inner)) {\n+                            seenCauses.put(inner, true);\n+\n+                            inner = inner.getCause();\n+                            depth++;\n+                        } else {\n+                            inner = inner.getCause();\n+                            if (inner != null) {\n+                                for (int i = 0; i < depth + 2; i++) {\n+                                    aggregateMessage.append(\"  \");\n+                                }\n+                                aggregateMessage.append(\"|-- \");\n+                                aggregateMessage.append(\"(cause not expanded again) \");\n+                                aggregateMessage.append(inner.getClass().getCanonicalName()).append(\": \");\n+                                aggregateMessage.append(inner.getMessage());\n+                                aggregateMessage.append(separator);\n+                            }\n+                            break;\n+                        }\n+                    }\n+                }\n+\n+                cause = new ExceptionOverview(aggregateMessage.toString().trim());\n+            } else {\n+                cause = exceptions.get(0);\n+            }\n+        }\n+        return cause;\n+    }\n+\n+    /**\n+     * All of the following {@code printStackTrace} functionality is derived from JDK {@link Throwable}\n+     * {@code printStackTrace}. In particular, the {@code PrintStreamOrWriter} abstraction is copied wholesale.\n+     *\n+     * <p>Changes from the official JDK implementation:<ul>\n+     * <li>no infinite loop detection</li>\n+     * <li>smaller critical section holding {@link PrintStream} lock</li>\n+     * <li>explicit knowledge about the exceptions {@link List} that this loops through</li>\n+     * </ul>\n+     */\n+    @Override\n+    public void printStackTrace() {\n+        printStackTrace(System.err);\n+    }\n+\n+    @Override\n+    public void printStackTrace(PrintStream s) {\n+        printStackTrace(new WrappedPrintStream(s));\n+    }\n+\n+    @Override\n+    public void printStackTrace(PrintWriter s) {\n+        printStackTrace(new WrappedPrintWriter(s));\n+    }\n+\n+    /**\n+     * Special handling for printing out a {@code CompositeException}.\n+     * Loops through all inner exceptions and prints them out.\n+     *\n+     * @param s\n+     *            stream to print to", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxMjY0OQ=="}, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 229}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNDQwMDczOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMTo1NjoyN1rOFzkLVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMjoyMDowNFrOFzkztg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxNDQyMg==", "bodyText": "Could replace with?:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final List<Throwable> localExceptions = new ArrayList<>(deDupedExceptions);\n          \n          \n            \n                    exceptions = Collections.unmodifiableList(localExceptions);\n          \n          \n            \n                    exceptions = ImmutableList.copyOf(deDupedExceptions);", "url": "https://github.com/line/armeria/pull/2553#discussion_r389614422", "createdAt": "2020-03-09T11:56:27Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ * Copyright 2016 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/*\n+ * Copyright (c) 2016-present, RxJava Contributors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.io.PrintStream;\n+import java.io.PrintWriter;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.IdentityHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+/**\n+ * Represents an exception that is a composite of one or more other exceptions. A {@code CompositeException}\n+ * does not modify the structure of any exception it wraps, but at print-time it iterates through the list of\n+ * Throwables contained in the composite in order to print them all.\n+ *\n+ * <p>Its invariant is to contain an immutable, ordered (by insertion order), unique list of non-composite\n+ * exceptions. You can retrieve individual exceptions in this list with {@link #getExceptions()}.\n+ *\n+ * <p>The {@link #printStackTrace()} implementation handles the StackTrace in a customized way instead of using\n+ * {@code getCause()} so that it can avoid circular references.\n+ *\n+ * <p>If you invoke {@link #getCause()}, it will lazily create the causal chain but will stop if it finds any\n+ * Throwable in the chain that it has already seen.\n+ */\n+public final class CompositeException extends RuntimeException {\n+\n+    // Forked from RxJava 3.0.0 at e793bc1d1a29dca18be795cf4a7628e2d44a4234\n+\n+    private static final long serialVersionUID = 3026362227162912146L;\n+\n+    private final List<Throwable> exceptions;\n+    private final String message;\n+\n+    @Nullable\n+    private Throwable cause;\n+\n+    /**\n+     * Constructs a CompositeException with the given array of Throwables as the\n+     * list of suppressed exceptions.\n+     * @param exceptions the Throwables to have as initially suppressed exceptions\n+     *\n+     * @throws IllegalArgumentException if <code>exceptions</code> is empty.\n+     */\n+    public CompositeException(Throwable... exceptions) {\n+        this(ImmutableList.copyOf(requireNonNull(exceptions, \"exceptions\")));\n+    }\n+\n+    /**\n+     * Constructs a CompositeException with the given array of Throwables as the\n+     * list of suppressed exceptions.\n+     * @param errors the Throwables to have as initially suppressed exceptions\n+     *\n+     * @throws IllegalArgumentException if <code>errors</code> is empty.\n+     */\n+    public CompositeException(Iterable<? extends Throwable> errors) {\n+        requireNonNull(errors, \"errors\");\n+        final Set<Throwable> deDupedExceptions = new LinkedHashSet<>();\n+        for (Throwable ex : errors) {\n+            if (ex instanceof CompositeException) {\n+                deDupedExceptions.addAll(((CompositeException) ex).getExceptions());\n+            } else if (ex != null) {\n+                deDupedExceptions.add(ex);\n+            } else {\n+                deDupedExceptions.add(new NullPointerException(\"Throwable was null!\"));\n+            }\n+        }\n+        if (deDupedExceptions.isEmpty()) {\n+            throw new IllegalArgumentException(\"errors is empty\");\n+        }\n+        final List<Throwable> localExceptions = new ArrayList<>(deDupedExceptions);\n+        exceptions = Collections.unmodifiableList(localExceptions);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYyNDc1OA==", "bodyText": "Just copied the code from RxJava in this class. So I didn't change it. But, Yes, I will make a change for this.", "url": "https://github.com/line/armeria/pull/2553#discussion_r389624758", "createdAt": "2020-03-09T12:20:04Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "diffHunk": "@@ -0,0 +1,317 @@\n+/*\n+ * Copyright 2016 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/*\n+ * Copyright (c) 2016-present, RxJava Contributors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.io.PrintStream;\n+import java.io.PrintWriter;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.IdentityHashMap;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+/**\n+ * Represents an exception that is a composite of one or more other exceptions. A {@code CompositeException}\n+ * does not modify the structure of any exception it wraps, but at print-time it iterates through the list of\n+ * Throwables contained in the composite in order to print them all.\n+ *\n+ * <p>Its invariant is to contain an immutable, ordered (by insertion order), unique list of non-composite\n+ * exceptions. You can retrieve individual exceptions in this list with {@link #getExceptions()}.\n+ *\n+ * <p>The {@link #printStackTrace()} implementation handles the StackTrace in a customized way instead of using\n+ * {@code getCause()} so that it can avoid circular references.\n+ *\n+ * <p>If you invoke {@link #getCause()}, it will lazily create the causal chain but will stop if it finds any\n+ * Throwable in the chain that it has already seen.\n+ */\n+public final class CompositeException extends RuntimeException {\n+\n+    // Forked from RxJava 3.0.0 at e793bc1d1a29dca18be795cf4a7628e2d44a4234\n+\n+    private static final long serialVersionUID = 3026362227162912146L;\n+\n+    private final List<Throwable> exceptions;\n+    private final String message;\n+\n+    @Nullable\n+    private Throwable cause;\n+\n+    /**\n+     * Constructs a CompositeException with the given array of Throwables as the\n+     * list of suppressed exceptions.\n+     * @param exceptions the Throwables to have as initially suppressed exceptions\n+     *\n+     * @throws IllegalArgumentException if <code>exceptions</code> is empty.\n+     */\n+    public CompositeException(Throwable... exceptions) {\n+        this(ImmutableList.copyOf(requireNonNull(exceptions, \"exceptions\")));\n+    }\n+\n+    /**\n+     * Constructs a CompositeException with the given array of Throwables as the\n+     * list of suppressed exceptions.\n+     * @param errors the Throwables to have as initially suppressed exceptions\n+     *\n+     * @throws IllegalArgumentException if <code>errors</code> is empty.\n+     */\n+    public CompositeException(Iterable<? extends Throwable> errors) {\n+        requireNonNull(errors, \"errors\");\n+        final Set<Throwable> deDupedExceptions = new LinkedHashSet<>();\n+        for (Throwable ex : errors) {\n+            if (ex instanceof CompositeException) {\n+                deDupedExceptions.addAll(((CompositeException) ex).getExceptions());\n+            } else if (ex != null) {\n+                deDupedExceptions.add(ex);\n+            } else {\n+                deDupedExceptions.add(new NullPointerException(\"Throwable was null!\"));\n+            }\n+        }\n+        if (deDupedExceptions.isEmpty()) {\n+            throw new IllegalArgumentException(\"errors is empty\");\n+        }\n+        final List<Throwable> localExceptions = new ArrayList<>(deDupedExceptions);\n+        exceptions = Collections.unmodifiableList(localExceptions);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxNDQyMg=="}, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNDQxMDMzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/Exceptions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMTo1OToyOFrOFzkQ7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMTo1OToyOFrOFzkQ7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxNTg1Mw==", "bodyText": "nit: Merge two lines?", "url": "https://github.com/line/armeria/pull/2553#discussion_r389615853", "createdAt": "2020-03-09T11:59:28Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/Exceptions.java", "diffHunk": "@@ -222,6 +222,38 @@ public static boolean isStreamCancelling(Throwable cause) {\n         return null; // Never reaches here.\n     }\n \n+    // This is copied from\n+    // https://github.com/ReactiveX/RxJava/blob/v3.0.0/src/main/java/io/reactivex/rxjava3/exceptions/Exceptions.java\n+\n+    /**\n+     * Throws a particular {@code Throwable} only if it belongs to a set of \"fatal\" error varieties. These\n+     * varieties are as follows:\n+     * <ul>\n+     * <li>{@code VirtualMachineError}</li>\n+     * <li>{@code ThreadDeath}</li>\n+     * <li>{@code LinkageError}</li>\n+     * </ul>\n+     * This can be useful if you are writing an operator that calls user-supplied code, and you want to\n+     * notify subscribers of errors encountered in that code by calling their {@code onError} methods, but only\n+     * if the errors are not so catastrophic that such a call would be futile, in which case you simply want to\n+     * rethrow the error.\n+     *\n+     * @param t\n+     *         the {@code Throwable} to test and perhaps throw", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNDQyNTYyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/Exceptions.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxMjowNDo1NlrOFzkZ7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMTo1MjozNFrOFz-9HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxODE1Ng==", "bodyText": "I'm not strong. I think we don't need to check null here. Because a user might not expect NPE here.", "url": "https://github.com/line/armeria/pull/2553#discussion_r389618156", "createdAt": "2020-03-09T12:04:56Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/Exceptions.java", "diffHunk": "@@ -222,6 +222,38 @@ public static boolean isStreamCancelling(Throwable cause) {\n         return null; // Never reaches here.\n     }\n \n+    // This is copied from\n+    // https://github.com/ReactiveX/RxJava/blob/v3.0.0/src/main/java/io/reactivex/rxjava3/exceptions/Exceptions.java\n+\n+    /**\n+     * Throws a particular {@code Throwable} only if it belongs to a set of \"fatal\" error varieties. These\n+     * varieties are as follows:\n+     * <ul>\n+     * <li>{@code VirtualMachineError}</li>\n+     * <li>{@code ThreadDeath}</li>\n+     * <li>{@code LinkageError}</li>\n+     * </ul>\n+     * This can be useful if you are writing an operator that calls user-supplied code, and you want to\n+     * notify subscribers of errors encountered in that code by calling their {@code onError} methods, but only\n+     * if the errors are not so catastrophic that such a call would be futile, in which case you simply want to\n+     * rethrow the error.\n+     *\n+     * @param t\n+     *         the {@code Throwable} to test and perhaps throw\n+     * @see <a href=\"https://github.com/ReactiveX/RxJava/issues/748#issuecomment-32471495\">\n+     *     RxJava: StackOverflowError is swallowed (Issue #748)</a>\n+     */\n+    public static void throwIfFatal(Throwable t) {\n+        requireNonNull(t, \"t\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYyNTMwNg==", "bodyText": "When we provide a public API, we always don't want a user to call the API with null. But we always have a null check. \ud83d\ude04", "url": "https://github.com/line/armeria/pull/2553#discussion_r389625306", "createdAt": "2020-03-09T12:21:19Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/Exceptions.java", "diffHunk": "@@ -222,6 +222,38 @@ public static boolean isStreamCancelling(Throwable cause) {\n         return null; // Never reaches here.\n     }\n \n+    // This is copied from\n+    // https://github.com/ReactiveX/RxJava/blob/v3.0.0/src/main/java/io/reactivex/rxjava3/exceptions/Exceptions.java\n+\n+    /**\n+     * Throws a particular {@code Throwable} only if it belongs to a set of \"fatal\" error varieties. These\n+     * varieties are as follows:\n+     * <ul>\n+     * <li>{@code VirtualMachineError}</li>\n+     * <li>{@code ThreadDeath}</li>\n+     * <li>{@code LinkageError}</li>\n+     * </ul>\n+     * This can be useful if you are writing an operator that calls user-supplied code, and you want to\n+     * notify subscribers of errors encountered in that code by calling their {@code onError} methods, but only\n+     * if the errors are not so catastrophic that such a call would be futile, in which case you simply want to\n+     * rethrow the error.\n+     *\n+     * @param t\n+     *         the {@code Throwable} to test and perhaps throw\n+     * @see <a href=\"https://github.com/ReactiveX/RxJava/issues/748#issuecomment-32471495\">\n+     *     RxJava: StackOverflowError is swallowed (Issue #748)</a>\n+     */\n+    public static void throwIfFatal(Throwable t) {\n+        requireNonNull(t, \"t\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxODE1Ng=="}, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA1MzE0OQ==", "bodyText": "OK, that is a good point, let keep it.", "url": "https://github.com/line/armeria/pull/2553#discussion_r390053149", "createdAt": "2020-03-10T01:52:34Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/Exceptions.java", "diffHunk": "@@ -222,6 +222,38 @@ public static boolean isStreamCancelling(Throwable cause) {\n         return null; // Never reaches here.\n     }\n \n+    // This is copied from\n+    // https://github.com/ReactiveX/RxJava/blob/v3.0.0/src/main/java/io/reactivex/rxjava3/exceptions/Exceptions.java\n+\n+    /**\n+     * Throws a particular {@code Throwable} only if it belongs to a set of \"fatal\" error varieties. These\n+     * varieties are as follows:\n+     * <ul>\n+     * <li>{@code VirtualMachineError}</li>\n+     * <li>{@code ThreadDeath}</li>\n+     * <li>{@code LinkageError}</li>\n+     * </ul>\n+     * This can be useful if you are writing an operator that calls user-supplied code, and you want to\n+     * notify subscribers of errors encountered in that code by calling their {@code onError} methods, but only\n+     * if the errors are not so catastrophic that such a call would be futile, in which case you simply want to\n+     * rethrow the error.\n+     *\n+     * @param t\n+     *         the {@code Throwable} to test and perhaps throw\n+     * @see <a href=\"https://github.com/ReactiveX/RxJava/issues/748#issuecomment-32471495\">\n+     *     RxJava: StackOverflowError is swallowed (Issue #748)</a>\n+     */\n+    public static void throwIfFatal(Throwable t) {\n+        requireNonNull(t, \"t\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYxODE1Ng=="}, "originalCommit": {"oid": "f3a464142074ed2f92f3c60f192ffd32549448ea"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNzI2NTk0OnYy", "diffSide": "RIGHT", "path": "NOTICE.txt", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMjo0Njo1M1rOFz_x9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwMjo0NzoxMVrOFz_yKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjY3Ng==", "bodyText": "Revert?", "url": "https://github.com/line/armeria/pull/2553#discussion_r390066676", "createdAt": "2020-03-10T02:46:53Z", "author": {"login": "trustin"}, "path": "NOTICE.txt", "diffHunk": "@@ -277,10 +282,10 @@ This product depends on Retrofit, distributed by Square:\n   * License: licenses/LICENSE.retrofit.al20.txt (Apache License v2.0)\n   * Homepage: https://square.github.io/retrofit/\n \n-  This product depends on RxJava, distributed by RxJava Contributors:\n+This product depends on RxJava, distributed by RxJava Contributors:\n \n-    * License: licenses/LICENSE.rxjava.al20.txt (Apache License v2.0)\n-    * Homepage: https://github.com/ReactiveX/RxJava\n+  * License: licenses/LICENSE.rxjava.al20.txt (Apache License v2.0)\n+  * Homepage: https://github.com/ReactiveX/RxJava", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e2d5861207a3bec461e8ef4c47d4bd56785d696"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjcyOA==", "bodyText": "Never mind. I misread the diff. \ud83d\ude05", "url": "https://github.com/line/armeria/pull/2553#discussion_r390066728", "createdAt": "2020-03-10T02:47:11Z", "author": {"login": "trustin"}, "path": "NOTICE.txt", "diffHunk": "@@ -277,10 +282,10 @@ This product depends on Retrofit, distributed by Square:\n   * License: licenses/LICENSE.retrofit.al20.txt (Apache License v2.0)\n   * Homepage: https://square.github.io/retrofit/\n \n-  This product depends on RxJava, distributed by RxJava Contributors:\n+This product depends on RxJava, distributed by RxJava Contributors:\n \n-    * License: licenses/LICENSE.rxjava.al20.txt (Apache License v2.0)\n-    * Homepage: https://github.com/ReactiveX/RxJava\n+  * License: licenses/LICENSE.rxjava.al20.txt (Apache License v2.0)\n+  * Homepage: https://github.com/ReactiveX/RxJava", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA2NjY3Ng=="}, "originalCommit": {"oid": "3e2d5861207a3bec461e8ef4c47d4bd56785d696"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2737, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}