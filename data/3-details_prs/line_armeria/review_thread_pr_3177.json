{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxNDU3OTUy", "number": 3177, "reviewThreads": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOTozMTo0N1rOE5WUdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNzozODoxMFrOE9GPOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NTY5OTc0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/server/DefaultRoutingContext.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOTozMTo0N1rOHzv86Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwOTo1Njo0NlrOH5rjxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyNTA2NQ==", "bodyText": "How about selectLocale(Iterable<Locale>) ?", "url": "https://github.com/line/armeria/pull/3177#discussion_r524025065", "createdAt": "2020-11-16T09:31:47Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/DefaultRoutingContext.java", "diffHunk": "@@ -133,6 +144,17 @@ public MediaType contentType() {\n         return acceptTypes;\n     }\n \n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        return acceptLanguages.get();\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Locale getLocale(Collection<Locale> supportedLocales) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA3MTcyMA==", "bodyText": "Agreed, I actually thought about this, but forgot about. I mostly put it there, because of the closeness to the media type parser.\nIt might even be preferable to have the Accept in HttpRequest as well, and just let HttpRoutingContext use that method, but that's a large change imho.\nOn the selectLocale(Iterable), yes, much better name and signature.", "url": "https://github.com/line/armeria/pull/3177#discussion_r524071720", "createdAt": "2020-11-16T10:13:15Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/server/DefaultRoutingContext.java", "diffHunk": "@@ -133,6 +144,17 @@ public MediaType contentType() {\n         return acceptTypes;\n     }\n \n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        return acceptLanguages.get();\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Locale getLocale(Collection<Locale> supportedLocales) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyNTA2NQ=="}, "originalCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA3NDcyNg==", "bodyText": "Alright, then let's move these methods to HttpRequest. Accept support would be even nicer, but it's up to you as always. It'd be nice if we could file an issue at least, so we can follow-up later.", "url": "https://github.com/line/armeria/pull/3177#discussion_r524074726", "createdAt": "2020-11-16T10:15:49Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/DefaultRoutingContext.java", "diffHunk": "@@ -133,6 +144,17 @@ public MediaType contentType() {\n         return acceptTypes;\n     }\n \n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        return acceptLanguages.get();\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Locale getLocale(Collection<Locale> supportedLocales) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyNTA2NQ=="}, "originalCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDExODU0MQ==", "bodyText": "Sorry, but I don't have enough time to try to figure out routing internals right now. I'm putting it in HttpHeadersBase if that's ok, as that's where contentType() parsing is done, and adding a default method in HttpRequest (same as for contentType()). I tried putting the logic in HttpRequest, but unless I want to put a lot of logic into an interface, that will add a lot of duplicated logic as there are about 10 classes implementing that interface.\nBtw, no on the Iterable unfortunately. Locale.filter() needs a Collection.", "url": "https://github.com/line/armeria/pull/3177#discussion_r524118541", "createdAt": "2020-11-16T10:55:42Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/server/DefaultRoutingContext.java", "diffHunk": "@@ -133,6 +144,17 @@ public MediaType contentType() {\n         return acceptTypes;\n     }\n \n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        return acceptLanguages.get();\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Locale getLocale(Collection<Locale> supportedLocales) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyNTA2NQ=="}, "originalCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MTMyMw==", "bodyText": "Btw, no on the Iterable unfortunately. Locale.filter() needs a Collection.\n\nThen, how about copy the supportedLocales if it is not an instance Collection.\nFor example:\nLocale selectLocale(Iterable<Locale> supportedLocales) {\n    Collection<Locale> locales;\n\tif (!supportedLocales instanceof Collection) {\n\t\tlocales = supportedLocales;\n    } else {\n\t\tlocales = ImmutableList.copyOf(supportedLocales);\n    }\n}", "url": "https://github.com/line/armeria/pull/3177#discussion_r528681323", "createdAt": "2020-11-23T12:52:37Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/DefaultRoutingContext.java", "diffHunk": "@@ -133,6 +144,17 @@ public MediaType contentType() {\n         return acceptTypes;\n     }\n \n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        return acceptLanguages.get();\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Locale getLocale(Collection<Locale> supportedLocales) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyNTA2NQ=="}, "originalCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0NDU1MQ==", "bodyText": "I somehow missed this comment. Going through all comments again.", "url": "https://github.com/line/armeria/pull/3177#discussion_r530244551", "createdAt": "2020-11-25T09:56:46Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/server/DefaultRoutingContext.java", "diffHunk": "@@ -133,6 +144,17 @@ public MediaType contentType() {\n         return acceptTypes;\n     }\n \n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        return acceptLanguages.get();\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Locale getLocale(Collection<Locale> supportedLocales) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyNTA2NQ=="}, "originalCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NTc0MjY4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/server/RoutingContext.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOTozODoxMVrOHzwY0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzo0NTo0OVrOH2QWag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAzMjIwOA==", "bodyText": "I'm curious if we should return Locale.ROOT instead of null. What do you think?", "url": "https://github.com/line/armeria/pull/3177#discussion_r524032208", "createdAt": "2020-11-16T09:38:11Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/RoutingContext.java", "diffHunk": "@@ -81,6 +84,23 @@\n      */\n     List<MediaType> acceptTypes();\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    List<LanguageRange> acceptLanguages();\n+\n+    /**\n+     * This matches the {@link Locale}s supported by the server to\n+     * the @{link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match\n+     * according to client preference.\n+     * @param supportedLocales a list of locales supported by the server.\n+     * @return The best matching locale or null if no locale matches.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA3OTczOQ==", "bodyText": "If the nullability is the issue, I'd prefer Optional<Locale>, because I don't really see what ROOT would represent, except that nothing was found. It can't really be used to select what texts to show to the user. My completely made up statistics says that in 99.9% of the cases when this fails, the one calling the method will fall back to a specific Locale that they support and hope that the user can read it anyway.\nI imagine the code looking something like\nselectLocale(supportedLanguages)\n    ?: Locale.US\nOptional.ofNullable(selectLocale(supportedLanguages))\n    .orElse(Locale.US)\nif the method returns Locale.ROOT, the check would be the (imho) less clear:\nOptional.of(selectLocale(supportedLanguages))\n    .filter((locale) -> !locale.equals(Locale.ROOT))\n    .orElse(Locale.US)", "url": "https://github.com/line/armeria/pull/3177#discussion_r524079739", "createdAt": "2020-11-16T10:20:29Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/server/RoutingContext.java", "diffHunk": "@@ -81,6 +84,23 @@\n      */\n     List<MediaType> acceptTypes();\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    List<LanguageRange> acceptLanguages();\n+\n+    /**\n+     * This matches the {@link Locale}s supported by the server to\n+     * the @{link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match\n+     * according to client preference.\n+     * @param supportedLocales a list of locales supported by the server.\n+     * @return The best matching locale or null if no locale matches.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAzMjIwOA=="}, "originalCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY1MzAzNA==", "bodyText": "I see. Returning null sounds better.", "url": "https://github.com/line/armeria/pull/3177#discussion_r526653034", "createdAt": "2020-11-19T07:45:49Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/RoutingContext.java", "diffHunk": "@@ -81,6 +84,23 @@\n      */\n     List<MediaType> acceptTypes();\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    List<LanguageRange> acceptLanguages();\n+\n+    /**\n+     * This matches the {@link Locale}s supported by the server to\n+     * the @{link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match\n+     * according to client preference.\n+     * @param supportedLocales a list of locales supported by the server.\n+     * @return The best matching locale or null if no locale matches.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAzMjIwOA=="}, "originalCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTc1NTUwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/AbstractHttpHeadersBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNToxOToyNFrOH2NJcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwOTo0NzozNlrOH2Ux_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMDU2MA==", "bodyText": "Shouldn't we put this into DefaultRequestHeadersBuilder because it's a request header?", "url": "https://github.com/line/armeria/pull/3177#discussion_r526600560", "createdAt": "2020-11-19T05:19:24Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/AbstractHttpHeadersBuilder.java", "diffHunk": "@@ -39,6 +44,18 @@ final HttpHeadersBase newSetters(HttpHeadersBase parent, boolean shallowCopy) {\n         return new HttpHeadersBase(parent, shallowCopy);\n     }\n \n+    @Nullable\n+    public final List<LanguageRange> acceptLanguages() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcyNTYzMA==", "bodyText": "Moved to HttpHeadersBase as per uri() and path() and made package", "url": "https://github.com/line/armeria/pull/3177#discussion_r526725630", "createdAt": "2020-11-19T09:47:36Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/AbstractHttpHeadersBuilder.java", "diffHunk": "@@ -39,6 +44,18 @@ final HttpHeadersBase newSetters(HttpHeadersBase parent, boolean shallowCopy) {\n         return new HttpHeadersBase(parent, shallowCopy);\n     }\n \n+    @Nullable\n+    public final List<LanguageRange> acceptLanguages() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMDU2MA=="}, "originalCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTc1NzEzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeaderGetters.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNToyMDowM1rOH2NKTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwOTo0NDowNlrOH2UoGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMDc4Mg==", "bodyText": "ditto\nShouldn't we put this into RequestHeaderGetters?", "url": "https://github.com/line/armeria/pull/3177#discussion_r526600782", "createdAt": "2020-11-19T05:20:03Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeaderGetters.java", "diffHunk": "@@ -49,6 +52,27 @@\n     @Nullable\n     MediaType contentType();\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    List<LanguageRange> acceptLanguages();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcyMzA5OQ==", "bodyText": "Done", "url": "https://github.com/line/armeria/pull/3177#discussion_r526723099", "createdAt": "2020-11-19T09:44:06Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeaderGetters.java", "diffHunk": "@@ -49,6 +52,27 @@\n     @Nullable\n     MediaType contentType();\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    List<LanguageRange> acceptLanguages();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMDc4Mg=="}, "originalCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTc2MDI4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNToyMToyNVrOH2NL_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwOTo0NTowNFrOH2Uq0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMTIxNA==", "bodyText": "Let's put:\nrequireNonNull(supportedLocales, \"supportedLocales\");", "url": "https://github.com/line/armeria/pull/3177#discussion_r526601214", "createdAt": "2020-11-19T05:21:25Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -254,6 +263,33 @@ final void contentType(MediaType contentType) {\n         set(HttpHeaderNames.CONTENT_TYPE, contentType.toString());\n     }\n \n+    @Nullable\n+    @Override\n+    public Locale selectLocale(Collection<Locale> supportedLocales) {\n+        return acceptLanguages()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcyMzc5NQ==", "bodyText": "Done", "url": "https://github.com/line/armeria/pull/3177#discussion_r526723795", "createdAt": "2020-11-19T09:45:04Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -254,6 +263,33 @@ final void contentType(MediaType contentType) {\n         set(HttpHeaderNames.CONTENT_TYPE, contentType.toString());\n     }\n \n+    @Nullable\n+    @Override\n+    public Locale selectLocale(Collection<Locale> supportedLocales) {\n+        return acceptLanguages()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMTIxNA=="}, "originalCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTc2MDU4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNToyMTo0MVrOH2NMOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwOTo0NjozNlrOH2UvDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMTI3NQ==", "bodyText": "nit: (it) -> it", "url": "https://github.com/line/armeria/pull/3177#discussion_r526601275", "createdAt": "2020-11-19T05:21:41Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -254,6 +263,33 @@ final void contentType(MediaType contentType) {\n         set(HttpHeaderNames.CONTENT_TYPE, contentType.toString());\n     }\n \n+    @Nullable\n+    @Override\n+    public Locale selectLocale(Collection<Locale> supportedLocales) {\n+        return acceptLanguages()\n+                .stream()\n+                .flatMap((it) -> Locale.filter(ImmutableList.of(it), supportedLocales).stream())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjcyNDg3Nw==", "bodyText": "fixed. I'm starting to forget my Java :\\", "url": "https://github.com/line/armeria/pull/3177#discussion_r526724877", "createdAt": "2020-11-19T09:46:36Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -254,6 +263,33 @@ final void contentType(MediaType contentType) {\n         set(HttpHeaderNames.CONTENT_TYPE, contentType.toString());\n     }\n \n+    @Nullable\n+    @Override\n+    public Locale selectLocale(Collection<Locale> supportedLocales) {\n+        return acceptLanguages()\n+                .stream()\n+                .flatMap((it) -> Locale.filter(ImmutableList.of(it), supportedLocales).stream())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMTI3NQ=="}, "originalCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjkyODc2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxMjo1NVrOH2YIIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxMjo1NVrOH2YIIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4MDQ0OQ==", "bodyText": "Could do just:\nfinal HttpHeadersBase getters = getters();\nif (getters != null) {\n    return getters.selectLocale(supportedLocales);\n}\nreturn null;", "url": "https://github.com/line/armeria/pull/3177#discussion_r526780449", "createdAt": "2020-11-19T11:12:55Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,35 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return DefaultRequestHeaders.ACCEPT_LANGUAGE_WILDCARD;\n+    }\n+\n+    public RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptLanguages) {\n+        requireNonNull(acceptLanguages, \"acceptLanguages\");\n+        final String acceptLanguagesValue = acceptLanguages\n+                .stream()\n+                .map(LanguageRange::toString)\n+                .collect(Collectors.joining(\", \"));\n+        set(\n+                HttpHeaderNames.ACCEPT_LANGUAGE,\n+                acceptLanguagesValue\n+        );\n+        return self();\n+    }\n+\n+    @Nullable\n+    public Locale selectLocale(Collection<Locale> supportedLocales) {\n+        final HttpHeadersBase getters = getters();\n+        if (getters instanceof RequestHeaderGetters) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjkzMTIwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxMzozNlrOH2YJqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxMzozNlrOH2YJqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4MDg0MA==", "bodyText": "Let's merge these into one line because this is Java. \ud83e\udd23\nset(HttpHeaderNames.ACCEPT_LANGUAGE, acceptLanguagesValue);", "url": "https://github.com/line/armeria/pull/3177#discussion_r526780840", "createdAt": "2020-11-19T11:13:36Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,35 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return DefaultRequestHeaders.ACCEPT_LANGUAGE_WILDCARD;\n+    }\n+\n+    public RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptLanguages) {\n+        requireNonNull(acceptLanguages, \"acceptLanguages\");\n+        final String acceptLanguagesValue = acceptLanguages\n+                .stream()\n+                .map(LanguageRange::toString)\n+                .collect(Collectors.joining(\", \"));\n+        set(\n+                HttpHeaderNames.ACCEPT_LANGUAGE,\n+                acceptLanguagesValue\n+        );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjkzMTk0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxMzo0NlrOH2YKFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxMzo0NlrOH2YKFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4MDk1MA==", "bodyText": "missing @Override", "url": "https://github.com/line/armeria/pull/3177#discussion_r526780950", "createdAt": "2020-11-19T11:13:46Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,35 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return DefaultRequestHeaders.ACCEPT_LANGUAGE_WILDCARD;\n+    }\n+\n+    public RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptLanguages) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjkzMjMzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxMzo1MVrOH2YKWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxMzo1MVrOH2YKWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4MTAxOQ==", "bodyText": "missing @Override", "url": "https://github.com/line/armeria/pull/3177#discussion_r526781019", "createdAt": "2020-11-19T11:13:51Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,35 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return DefaultRequestHeaders.ACCEPT_LANGUAGE_WILDCARD;\n+    }\n+\n+    public RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptLanguages) {\n+        requireNonNull(acceptLanguages, \"acceptLanguages\");\n+        final String acceptLanguagesValue = acceptLanguages\n+                .stream()\n+                .map(LanguageRange::toString)\n+                .collect(Collectors.joining(\", \"));\n+        set(\n+                HttpHeaderNames.ACCEPT_LANGUAGE,\n+                acceptLanguagesValue\n+        );\n+        return self();\n+    }\n+\n+    @Nullable\n+    public Locale selectLocale(Collection<Locale> supportedLocales) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjkzNjAyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxNDo0N1rOH2YMmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwOTowNzoxMlrOH3G5mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4MTU5NQ==", "bodyText": "nit: HttpHeadersBase.ACCEPT_LANGUAGE_WILDCARD;", "url": "https://github.com/line/armeria/pull/3177#discussion_r526781595", "createdAt": "2020-11-19T11:14:47Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,35 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return DefaultRequestHeaders.ACCEPT_LANGUAGE_WILDCARD;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU0Njc3OA==", "bodyText": "Removed DefaultRequestHeaders.ACCEPT_LANGUAGE_WILDCARD completely and returns null.", "url": "https://github.com/line/armeria/pull/3177#discussion_r527546778", "createdAt": "2020-11-20T09:07:12Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,35 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return DefaultRequestHeaders.ACCEPT_LANGUAGE_WILDCARD;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4MTU5NQ=="}, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjk0OTc1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxODoxNFrOH2YVAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxODoxNFrOH2YVAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4Mzc0NQ==", "bodyText": "nit: {@link ...", "url": "https://github.com/line/armeria/pull/3177#discussion_r526783745", "createdAt": "2020-11-19T11:18:14Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "diffHunk": "@@ -318,6 +321,31 @@ default MediaType contentType() {\n         return headers().contentType();\n     }\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    default List<LanguageRange> acceptLanguages() {\n+        return headers().acceptLanguages();\n+    }\n+\n+    /**\n+     * This matches the {@link Locale}s supported by the server to\n+     * the @{link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjk1ODc2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxOToyOVrOH2Ya8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxOToyOVrOH2Ya8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4NTI2NQ==", "bodyText": "I think we can remove @see", "url": "https://github.com/line/armeria/pull/3177#discussion_r526785265", "createdAt": "2020-11-19T11:19:29Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "diffHunk": "@@ -318,6 +321,31 @@ default MediaType contentType() {\n         return headers().contentType();\n     }\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    default List<LanguageRange> acceptLanguages() {\n+        return headers().acceptLanguages();\n+    }\n+\n+    /**\n+     * This matches the {@link Locale}s supported by the server to\n+     * the @{link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match\n+     * according to client preference. It does this via <s>Basic Filter</s>ing each\n+     * {@link LanguageRange} and picking the first match. This is the \"classic\"\n+     * algorithm described in @see", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMzI3OTA2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeaderGetters.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMjoyOTo0N1rOH2bkWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMjoyOTo0N1rOH2bkWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzNjgyNQ==", "bodyText": "{@link", "url": "https://github.com/line/armeria/pull/3177#discussion_r526836825", "createdAt": "2020-11-19T12:29:47Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeaderGetters.java", "diffHunk": "@@ -62,4 +66,25 @@\n      */\n     @Nullable\n     String authority();\n+\n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    List<LanguageRange> acceptLanguages();\n+\n+    /**\n+     * This matches the {@link Locale}s supported by the server to\n+     * the @{link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMzI5NTE3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMjozMjoyM1rOH2bubg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwOTowODo1MlrOH3HB8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzOTQwNg==", "bodyText": "Should this be exposed somewhere?", "url": "https://github.com/line/armeria/pull/3177#discussion_r526839406", "createdAt": "2020-11-19T12:32:23Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -55,6 +62,9 @@\n     private static final String[] PROHIBITED_VALUE_CHAR_NAMES;\n     private static final char LAST_PROHIBITED_VALUE_CHAR;\n \n+    static final List<LanguageRange> ACCEPT_LANGUAGE_WILDCARD =\n+            ImmutableList.copyOf(LanguageRange.parse(\"*\"));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1OTc3MA==", "bodyText": "That's a good question. If JDK doesn't provide this constant, how about adding armeria.common.util.LanguageRanges class that provides it, as well as other common ones?", "url": "https://github.com/line/armeria/pull/3177#discussion_r527259770", "createdAt": "2020-11-19T22:56:51Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -55,6 +62,9 @@\n     private static final String[] PROHIBITED_VALUE_CHAR_NAMES;\n     private static final char LAST_PROHIBITED_VALUE_CHAR;\n \n+    static final List<LanguageRange> ACCEPT_LANGUAGE_WILDCARD =\n+            ImmutableList.copyOf(LanguageRange.parse(\"*\"));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzOTQwNg=="}, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ5NzcxNg==", "bodyText": "I cannot find any LanguageRange with \"*\", and the sun.util.Locale.LocaleMatcher that contains e.g. the actual implementation of the LanguageRange.parse() does not use a constant.\nI can add that class, but it will be for just the single LanguageRange, as the problem is that a LanguageRange contains both the Locale and a weight. It might be that there are certain combinations of Locale and weight that are common, but I believe they would be very localized to certain countries. It may be that even USA and UK does not share any LanguageRanges at all.\nI have no opinion on where to put that constant, so what do you want? Btw, if  the acceptLanguages()-method is made to return null instead of accept all, I don't see a need for Armeria to define this constant.", "url": "https://github.com/line/armeria/pull/3177#discussion_r527497716", "createdAt": "2020-11-20T07:50:46Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -55,6 +62,9 @@\n     private static final String[] PROHIBITED_VALUE_CHAR_NAMES;\n     private static final char LAST_PROHIBITED_VALUE_CHAR;\n \n+    static final List<LanguageRange> ACCEPT_LANGUAGE_WILDCARD =\n+            ImmutableList.copyOf(LanguageRange.parse(\"*\"));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzOTQwNg=="}, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU0ODkxNQ==", "bodyText": "I cannot find any LanguageRange with \"*\", and the sun.util.Locale.LocaleMatcher that contains e.g. the actual implementation of the LanguageRange.parse() does not use a constant.\nI can add that class, but it will be for just the single LanguageRange, as the problem is that a LanguageRange contains both the Locale and a weight. It might be that there are certain combinations of Locale and weight that are common, but I believe they would be very localized to certain countries. It may be that even USA and UK does not share any LanguageRanges at all.\nI have no opinion on where to put that constant, so what do you want? Btw, if the acceptLanguages()-method is made to return null instead of accept all, I don't see a need for Armeria to define this constant.\n\nRemoved the LanguageRange constant completely as I'm returning null from acceptLanguages() instead. After thinking about it again, that was the better solution imho.", "url": "https://github.com/line/armeria/pull/3177#discussion_r527548915", "createdAt": "2020-11-20T09:08:52Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -55,6 +62,9 @@\n     private static final String[] PROHIBITED_VALUE_CHAR_NAMES;\n     private static final char LAST_PROHIBITED_VALUE_CHAR;\n \n+    static final List<LanguageRange> ACCEPT_LANGUAGE_WILDCARD =\n+            ImmutableList.copyOf(LanguageRange.parse(\"*\"));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzOTQwNg=="}, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNTkzNzEwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeaders.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo1Mjo0NlrOH21RRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1ODoxNVrOH3GThQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NzkyNA==", "bodyText": "Could we use @Nullable like method and uri to reduce memory footprint?", "url": "https://github.com/line/armeria/pull/3177#discussion_r527257924", "createdAt": "2020-11-19T22:52:46Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeaders.java", "diffHunk": "@@ -16,16 +16,25 @@\n package com.linecorp.armeria.common;\n \n import java.net.URI;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Locale.LanguageRange;\n+import java.util.function.Supplier;\n \n import javax.annotation.Nullable;\n \n+import com.google.common.base.Suppliers;\n+\n @SuppressWarnings({ \"checkstyle:EqualsHashCode\", \"EqualsAndHashcode\" })\n final class DefaultRequestHeaders extends DefaultHttpHeaders implements RequestHeaders {\n \n     @Nullable\n     private HttpMethod method;\n     @Nullable\n     private URI uri;\n+    private final Supplier<List<LanguageRange>> acceptLanguage =\n+            Suppliers.memoize(super::acceptLanguages);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNzAyOQ==", "bodyText": "Fixed", "url": "https://github.com/line/armeria/pull/3177#discussion_r527537029", "createdAt": "2020-11-20T08:58:15Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeaders.java", "diffHunk": "@@ -16,16 +16,25 @@\n package com.linecorp.armeria.common;\n \n import java.net.URI;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Locale.LanguageRange;\n+import java.util.function.Supplier;\n \n import javax.annotation.Nullable;\n \n+import com.google.common.base.Suppliers;\n+\n @SuppressWarnings({ \"checkstyle:EqualsHashCode\", \"EqualsAndHashcode\" })\n final class DefaultRequestHeaders extends DefaultHttpHeaders implements RequestHeaders {\n \n     @Nullable\n     private HttpMethod method;\n     @Nullable\n     private URI uri;\n+    private final Supplier<List<LanguageRange>> acceptLanguage =\n+            Suppliers.memoize(super::acceptLanguages);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NzkyNA=="}, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNTk0MDc2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo1NDoxNFrOH21Tpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1NTowMFrOH3GMkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1ODUzNA==", "bodyText": "Should we distinguish the lack of accept-language header from accept-language: *? \ud83e\udd14", "url": "https://github.com/line/armeria/pull/3177#discussion_r527258534", "createdAt": "2020-11-19T22:54:14Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,31 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return HttpHeadersBase.ACCEPT_LANGUAGE_WILDCARD;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNTI0OQ==", "bodyText": "I changed it according to your suggestion/question to return null on parse error, so while not it's possible to differ from accept-language: * and lack of accept-language header, it's not impossible to differ between no valid header and no header at all. Tbh, I think that's ok, as I can't see any real value to the server side to differ between the two cases. If there is a case, it could be solved by checking for the existence of the header.", "url": "https://github.com/line/armeria/pull/3177#discussion_r527535249", "createdAt": "2020-11-20T08:55:00Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,31 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return HttpHeadersBase.ACCEPT_LANGUAGE_WILDCARD;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1ODUzNA=="}, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNTk0NDY1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo1NToyM1rOH21V1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwNzozMzo0NlrOH3DeSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1OTA5Mg==", "bodyText": "Could accept Iterable<LanguageRange>?", "url": "https://github.com/line/armeria/pull/3177#discussion_r527259092", "createdAt": "2020-11-19T22:55:23Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,31 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return HttpHeadersBase.ACCEPT_LANGUAGE_WILDCARD;\n+    }\n+\n+    @Override\n+    public RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptLanguages) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ5MDYzNQ==", "bodyText": "Fixed.", "url": "https://github.com/line/armeria/pull/3177#discussion_r527490635", "createdAt": "2020-11-20T07:33:46Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,31 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return HttpHeadersBase.ACCEPT_LANGUAGE_WILDCARD;\n+    }\n+\n+    @Override\n+    public RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptLanguages) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1OTA5Mg=="}, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNTk1NjUzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo1OToyNlrOH21c5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo1OToyNlrOH21c5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MDkwMA==", "bodyText": "This matches -> Matches", "url": "https://github.com/line/armeria/pull/3177#discussion_r527260900", "createdAt": "2020-11-19T22:59:26Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "diffHunk": "@@ -318,6 +321,31 @@ default MediaType contentType() {\n         return headers().contentType();\n     }\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    default List<LanguageRange> acceptLanguages() {\n+        return headers().acceptLanguages();\n+    }\n+\n+    /**\n+     * This matches the {@link Locale}s supported by the server to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNTk2MTkwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeadersBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMzowMDo1M1rOH21gTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMzowMDo1M1rOH21gTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MTc3NA==", "bodyText": "Iterable could be more useful.", "url": "https://github.com/line/armeria/pull/3177#discussion_r527261774", "createdAt": "2020-11-19T23:00:53Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeadersBuilder.java", "diffHunk": "@@ -90,6 +92,13 @@ default RequestHeadersBuilder authority(Endpoint endpoint) {\n         return authority(endpoint.authority());\n     }\n \n+    /**\n+     * Sets the {@code \"accept-language\"} header.\n+     * @param acceptedLanguages the accepted languages.\n+     * @return {@code this}\n+     */\n+    RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptedLanguages);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwNTk3ODY1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMzowNzowM1rOH21qbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwODo1Nzo0MlrOH3GSYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2NDM2Ng==", "bodyText": "What should we do when we see a bad header? Raise an exception or silently ignore? Other methods, such as contentType(), ignore bad values. When all header values are invalid, should we treat it as ACCEPT_LANGUAGE_WILDCARD?", "url": "https://github.com/line/armeria/pull/3177#discussion_r527264366", "createdAt": "2020-11-19T23:07:03Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,6 +184,32 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        return acceptLanguages()\n+                .stream()\n+                .flatMap(it -> Locale.filter(ImmutableList.of(it), supportedLocales).stream())\n+                .findFirst()\n+                .orElse(null);\n+    }\n+\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            // No 'Accept-Language' header means accepting everything.\n+            return ACCEPT_LANGUAGE_WILDCARD;\n+        }\n+\n+        final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+        for (String acceptHeader : acceptHeaders) {\n+            acceptLanguages.addAll(LanguageRange.parse(acceptHeader));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ5NjcyMg==", "bodyText": "I have just let the exception fall through, mostly by accident. I know for an annoying fact that e.g. Jersey lets the exception even raises the exception itself. I think the behaviour should be the same as contentType(), ie swallow the exception.\nFixed.", "url": "https://github.com/line/armeria/pull/3177#discussion_r527496722", "createdAt": "2020-11-20T07:48:37Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,6 +184,32 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        return acceptLanguages()\n+                .stream()\n+                .flatMap(it -> Locale.filter(ImmutableList.of(it), supportedLocales).stream())\n+                .findFirst()\n+                .orElse(null);\n+    }\n+\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            // No 'Accept-Language' header means accepting everything.\n+            return ACCEPT_LANGUAGE_WILDCARD;\n+        }\n+\n+        final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+        for (String acceptHeader : acceptHeaders) {\n+            acceptLanguages.addAll(LanguageRange.parse(acceptHeader));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2NDM2Ng=="}, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzNjczNw==", "bodyText": "Added test as well.", "url": "https://github.com/line/armeria/pull/3177#discussion_r527536737", "createdAt": "2020-11-20T08:57:42Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,6 +184,32 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        return acceptLanguages()\n+                .stream()\n+                .flatMap(it -> Locale.filter(ImmutableList.of(it), supportedLocales).stream())\n+                .findFirst()\n+                .orElse(null);\n+    }\n+\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            // No 'Accept-Language' header means accepting everything.\n+            return ACCEPT_LANGUAGE_WILDCARD;\n+        }\n+\n+        final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+        for (String acceptHeader : acceptHeaders) {\n+            acceptLanguages.addAll(LanguageRange.parse(acceptHeader));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2NDM2Ng=="}, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNTYzODc2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeadersBuilder.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMjo1NDoyMFrOH4MM_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwOTo0MzozOVrOH5q_RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MjIzOA==", "bodyText": "Is it better to add varargs version? \ud83e\uddd0", "url": "https://github.com/line/armeria/pull/3177#discussion_r528682238", "createdAt": "2020-11-23T12:54:20Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeadersBuilder.java", "diffHunk": "@@ -90,6 +91,13 @@ default RequestHeadersBuilder authority(Endpoint endpoint) {\n         return authority(endpoint.authority());\n     }\n \n+    /**\n+     * Sets the {@code \"accept-language\"} header.\n+     * @param acceptedLanguages the accepted languages.\n+     * @return {@code this}\n+     */\n+    RequestHeadersBuilder acceptLanguages(Iterable<LanguageRange> acceptedLanguages);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcwNjY0Nw==", "bodyText": "I wouldn't want that, but YMMV. I have a list of languages that I support that I check against. I can ofc add another one, but imho that would be api bloat. It's not that hard to do Arrays.asList()/ImmutableList.of(), but unrolling a list is not as fun.", "url": "https://github.com/line/armeria/pull/3177#discussion_r528706647", "createdAt": "2020-11-23T13:35:21Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeadersBuilder.java", "diffHunk": "@@ -90,6 +91,13 @@ default RequestHeadersBuilder authority(Endpoint endpoint) {\n         return authority(endpoint.authority());\n     }\n \n+    /**\n+     * Sets the {@code \"accept-language\"} header.\n+     * @param acceptedLanguages the accepted languages.\n+     * @return {@code this}\n+     */\n+    RequestHeadersBuilder acceptLanguages(Iterable<LanguageRange> acceptedLanguages);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MjIzOA=="}, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIyMDc4NA==", "bodyText": "Agreed. We can easily add varags later if users want.", "url": "https://github.com/line/armeria/pull/3177#discussion_r529220784", "createdAt": "2020-11-24T05:58:31Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeadersBuilder.java", "diffHunk": "@@ -90,6 +91,13 @@ default RequestHeadersBuilder authority(Endpoint endpoint) {\n         return authority(endpoint.authority());\n     }\n \n+    /**\n+     * Sets the {@code \"accept-language\"} header.\n+     * @param acceptedLanguages the accepted languages.\n+     * @return {@code this}\n+     */\n+    RequestHeadersBuilder acceptLanguages(Iterable<LanguageRange> acceptedLanguages);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MjIzOA=="}, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE2MDE1NA==", "bodyText": "How about adding now for consistency? \ud83d\ude4f You can use ImmutableList.of().", "url": "https://github.com/line/armeria/pull/3177#discussion_r530160154", "createdAt": "2020-11-25T07:36:53Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeadersBuilder.java", "diffHunk": "@@ -90,6 +91,13 @@ default RequestHeadersBuilder authority(Endpoint endpoint) {\n         return authority(endpoint.authority());\n     }\n \n+    /**\n+     * Sets the {@code \"accept-language\"} header.\n+     * @param acceptedLanguages the accepted languages.\n+     * @return {@code this}\n+     */\n+    RequestHeadersBuilder acceptLanguages(Iterable<LanguageRange> acceptedLanguages);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MjIzOA=="}, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIzNTIwNQ==", "bodyText": "sigh github... When I see the comment in context it was clear.. I'll fix", "url": "https://github.com/line/armeria/pull/3177#discussion_r530235205", "createdAt": "2020-11-25T09:43:39Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeadersBuilder.java", "diffHunk": "@@ -90,6 +91,13 @@ default RequestHeadersBuilder authority(Endpoint endpoint) {\n         return authority(endpoint.authority());\n     }\n \n+    /**\n+     * Sets the {@code \"accept-language\"} header.\n+     * @param acceptedLanguages the accepted languages.\n+     * @return {@code this}\n+     */\n+    RequestHeadersBuilder acceptLanguages(Iterable<LanguageRange> acceptedLanguages);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MjIzOA=="}, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNTY0NDcwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeaderGetters.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMjo1NTo0NFrOH4MQeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMzozNzoyMlrOH4NxRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MzEzMA==", "bodyText": "nit: Indent \ud83d\ude09\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 *     or if there is no header.\n          \n          \n            \n                 *         or if there is no header.", "url": "https://github.com/line/armeria/pull/3177#discussion_r528683130", "createdAt": "2020-11-23T12:55:44Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeaderGetters.java", "diffHunk": "@@ -62,4 +66,29 @@\n      */\n     @Nullable\n     String authority();\n+\n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client preferences.\n+     * @return All {@link LanguageRange}s of all matching headers or {@code null} if there is a parsing error\n+     *     or if there is no header.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcwNzkxMQ==", "bodyText": "oh.. it's 8. I'll fix", "url": "https://github.com/line/armeria/pull/3177#discussion_r528707911", "createdAt": "2020-11-23T13:37:22Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeaderGetters.java", "diffHunk": "@@ -62,4 +66,29 @@\n      */\n     @Nullable\n     String authority();\n+\n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client preferences.\n+     * @return All {@link LanguageRange}s of all matching headers or {@code null} if there is a parsing error\n+     *     or if there is no header.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MzEzMA=="}, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNTY0ODI5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeaderGetters.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMjo1Njo0M1rOH4MSvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMjo1Njo0M1rOH4MSvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MzcwOA==", "bodyText": "nit:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return The best matching locale or null if no locale matches.\n          \n          \n            \n                 * @return the best matching {@link Locale} or {@code null} if no locale matches.", "url": "https://github.com/line/armeria/pull/3177#discussion_r528683708", "createdAt": "2020-11-23T12:56:43Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeaderGetters.java", "diffHunk": "@@ -62,4 +66,29 @@\n      */\n     @Nullable\n     String authority();\n+\n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client preferences.\n+     * @return All {@link LanguageRange}s of all matching headers or {@code null} if there is a parsing error\n+     *     or if there is no header.\n+     */\n+    @Nullable\n+    List<LanguageRange> acceptLanguages();\n+\n+    /**\n+     * Matches the {@link Locale}s supported by the server to\n+     * the {@link HttpHeaderNames#ACCEPT_LANGUAGE} and returns the best match\n+     * according to client preference. It does this via <s>Basic Filter</s>ing each\n+     * {@link LanguageRange} and picking the first match. This is the \"classic\"\n+     * algorithm described in\n+     * <a href=\"https://tools.ietf.org/html/rfc2616#section-14.4\">RFC2616 Accept-Language (obsoleted)</a>\n+     * and also referenced in <a href=\"https://tools.ietf.org/html/rfc7231#section-5.3.5\">RFC7231 Accept-Language</a>.\n+     * <p/>\n+     * See also {@link Locale#lookup} for another algorithm.\n+     * @param supportedLocales a {@link Collection} of locales supported by the server.\n+     * @return The best matching locale or null if no locale matches.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNTY1MjM2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMjo1Nzo0OFrOH4MVTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMjo1Nzo0OFrOH4MVTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4NDM2NQ==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/3177#discussion_r528684365", "createdAt": "2020-11-23T12:57:48Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "diffHunk": "@@ -318,6 +321,31 @@ default MediaType contentType() {\n         return headers().contentType();\n     }\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    default List<LanguageRange> acceptLanguages() {\n+        return headers().acceptLanguages();\n+    }\n+\n+    /**\n+     * Matches the {@link Locale}s supported by the server to\n+     * the {@link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match\n+     * according to client preference. It does this via <s>Basic Filter</s>ing each\n+     * {@link LanguageRange} and picking the first match. This is the \"classic\"\n+     * algorithm described in\n+     * <a href=\"https://tools.ietf.org/html/rfc2616#section-14.4\">RFC2616 Accept-Language (obsoleted)</a>\n+     * and also referenced in <a href=\"https://tools.ietf.org/html/rfc7231#section-5.3.5\">RFC7231 Accept-Language</a>.\n+     * @param supportedLocales a {@link Collection} of locales supported by the server.\n+     * @return The best matching locale or null if no locale matches.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNTY5MTc0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMzowODo0NlrOH4MtkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwNjowMjowMlrOH4tJLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY5MDU3Ng==", "bodyText": "nit: Revert?", "url": "https://github.com/line/armeria/pull/3177#discussion_r528690576", "createdAt": "2020-11-23T13:08:46Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,11 +181,46 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        final List<LanguageRange> languageRanges = acceptLanguages();\n+        if (languageRanges == null) {\n+            return null;\n+        }\n+        return languageRanges\n+                .stream()\n+                .flatMap(it -> Locale.filter(ImmutableList.of(it), supportedLocales).stream())\n+                .findFirst()\n+                .orElse(null);\n+    }\n+\n+    @Nullable\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            return null;\n+        }\n+\n+        try {\n+            final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+            for (String acceptHeader : acceptHeaders) {\n+                acceptLanguages.addAll(LanguageRange.parse(acceptHeader));\n+            }\n+            acceptLanguages.sort(comparingDouble(LanguageRange::getWeight).reversed());\n+\n+            return ImmutableList.copyOf(acceptLanguages);\n+        } catch (IllegalArgumentException e) {\n+            // If any port of any of the headers is ill-formed\n+            return null;\n+        }\n+    }\n+\n     HttpMethod method() {\n         final String methodStr = get(HttpHeaderNames.METHOD);\n         checkState(methodStr != null, \":method header does not exist.\");\n         return HttpMethod.isSupported(methodStr) ? HttpMethod.valueOf(methodStr)\n-                                                 : HttpMethod.UNKNOWN;\n+                : HttpMethod.UNKNOWN;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcxMDE1Ng==", "bodyText": "I haven't changed it in 34b738e!? (latest pushed) Something wrong with Github?", "url": "https://github.com/line/armeria/pull/3177#discussion_r528710156", "createdAt": "2020-11-23T13:41:03Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,11 +181,46 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        final List<LanguageRange> languageRanges = acceptLanguages();\n+        if (languageRanges == null) {\n+            return null;\n+        }\n+        return languageRanges\n+                .stream()\n+                .flatMap(it -> Locale.filter(ImmutableList.of(it), supportedLocales).stream())\n+                .findFirst()\n+                .orElse(null);\n+    }\n+\n+    @Nullable\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            return null;\n+        }\n+\n+        try {\n+            final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+            for (String acceptHeader : acceptHeaders) {\n+                acceptLanguages.addAll(LanguageRange.parse(acceptHeader));\n+            }\n+            acceptLanguages.sort(comparingDouble(LanguageRange::getWeight).reversed());\n+\n+            return ImmutableList.copyOf(acceptLanguages);\n+        } catch (IllegalArgumentException e) {\n+            // If any port of any of the headers is ill-formed\n+            return null;\n+        }\n+    }\n+\n     HttpMethod method() {\n         final String methodStr = get(HttpHeaderNames.METHOD);\n         checkState(methodStr != null, \":method header does not exist.\");\n         return HttpMethod.isSupported(methodStr) ? HttpMethod.valueOf(methodStr)\n-                                                 : HttpMethod.UNKNOWN;\n+                : HttpMethod.UNKNOWN;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY5MDU3Ng=="}, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIyMTkzMw==", "bodyText": "Maybe your IDE automatically formats the part unexpectedly.\nI can see the diff here.\nLet me fix the indent. :-)", "url": "https://github.com/line/armeria/pull/3177#discussion_r529221933", "createdAt": "2020-11-24T06:02:02Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,11 +181,46 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        final List<LanguageRange> languageRanges = acceptLanguages();\n+        if (languageRanges == null) {\n+            return null;\n+        }\n+        return languageRanges\n+                .stream()\n+                .flatMap(it -> Locale.filter(ImmutableList.of(it), supportedLocales).stream())\n+                .findFirst()\n+                .orElse(null);\n+    }\n+\n+    @Nullable\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            return null;\n+        }\n+\n+        try {\n+            final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+            for (String acceptHeader : acceptHeaders) {\n+                acceptLanguages.addAll(LanguageRange.parse(acceptHeader));\n+            }\n+            acceptLanguages.sort(comparingDouble(LanguageRange::getWeight).reversed());\n+\n+            return ImmutableList.copyOf(acceptLanguages);\n+        } catch (IllegalArgumentException e) {\n+            // If any port of any of the headers is ill-formed\n+            return null;\n+        }\n+    }\n+\n     HttpMethod method() {\n         final String methodStr = get(HttpHeaderNames.METHOD);\n         checkState(methodStr != null, \":method header does not exist.\");\n         return HttpMethod.isSupported(methodStr) ? HttpMethod.valueOf(methodStr)\n-                                                 : HttpMethod.UNKNOWN;\n+                : HttpMethod.UNKNOWN;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY5MDU3Ng=="}, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxNTcwNDQxOnYy", "diffSide": "RIGHT", "path": "core/src/test/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilderTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMzoxMTo1NVrOH4M08A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxNDowMjo1OVrOH4OwIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY5MjQ2NA==", "bodyText": "Global comment: Could you use assertThat of Assert4J? We prefer Assert4J when asserting in tests.\nhttps://armeria.dev/community/developer-guide#use-assert4j-instead-of-junits-assertion-api", "url": "https://github.com/line/armeria/pull/3177#discussion_r528692464", "createdAt": "2020-11-23T13:11:55Z", "author": {"login": "ikhoon"}, "path": "core/src/test/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilderTest.java", "diffHunk": "@@ -142,6 +148,120 @@ void schemeFromSessionProtocol() {\n                 .isInstanceOf(IllegalArgumentException.class);\n     }\n \n+    @Test\n+    void testAcceptLanguageMultiHeader() {\n+        final RequestHeaders headers = RequestHeaders\n+                .builder()\n+                .path(\"/\")\n+                .method(HttpMethod.GET)\n+                .add(HttpHeaderNames.ACCEPT_LANGUAGE,\n+                        \"de-us ;q=0.9, *;q=0.8\",\n+                        \"en;q=0.95, en-US;q=0.98\"\n+                )\n+                .build();\n+        final List<LanguageRange> acceptLanguages = headers.acceptLanguages();\n+        assertEquals(\n+                ImmutableList.of(\n+                        new LanguageRange(\"en-US\", 0.98),\n+                        new LanguageRange(\"en\", 0.95),\n+                        new LanguageRange(\"de-us\", 0.9),\n+                        new LanguageRange(\"*\", 0.8)\n+                ),\n+                acceptLanguages\n+        );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODcyNDAwMA==", "bodyText": "Oops. Fixed.", "url": "https://github.com/line/armeria/pull/3177#discussion_r528724000", "createdAt": "2020-11-23T14:02:59Z", "author": {"login": "tobias-"}, "path": "core/src/test/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilderTest.java", "diffHunk": "@@ -142,6 +148,120 @@ void schemeFromSessionProtocol() {\n                 .isInstanceOf(IllegalArgumentException.class);\n     }\n \n+    @Test\n+    void testAcceptLanguageMultiHeader() {\n+        final RequestHeaders headers = RequestHeaders\n+                .builder()\n+                .path(\"/\")\n+                .method(HttpMethod.GET)\n+                .add(HttpHeaderNames.ACCEPT_LANGUAGE,\n+                        \"de-us ;q=0.9, *;q=0.8\",\n+                        \"en;q=0.95, en-US;q=0.98\"\n+                )\n+                .build();\n+        final List<LanguageRange> acceptLanguages = headers.acceptLanguages();\n+        assertEquals(\n+                ImmutableList.of(\n+                        new LanguageRange(\"en-US\", 0.98),\n+                        new LanguageRange(\"en\", 0.95),\n+                        new LanguageRange(\"de-us\", 0.9),\n+                        new LanguageRange(\"*\", 0.8)\n+                ),\n+                acceptLanguages\n+        );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY5MjQ2NA=="}, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDk5MzIxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNzozMjo0N1rOH5mS_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwOTozNjoyNlrOH5qsSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE1ODMzMg==", "bodyText": "What would be the sensible behavior when acceptLanguages is empty? \ud83e\udd14", "url": "https://github.com/line/armeria/pull/3177#discussion_r530158332", "createdAt": "2020-11-25T07:32:47Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +120,29 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    @Nullable\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        return getters != null ? getters.acceptLanguages() : null;\n+    }\n+\n+    @Override\n+    public RequestHeadersBuilder acceptLanguages(Iterable<LanguageRange> acceptLanguages) {\n+        requireNonNull(acceptLanguages, \"acceptLanguages\");\n+        final String acceptLanguagesValue = Streams\n+                .stream(acceptLanguages)\n+                .map(it -> (it.getWeight() == 1.0d) ? it.getRange() : it.getRange() + \";q=\" + it.getWeight())\n+                .collect(Collectors.joining(\", \"));\n+        set(HttpHeaderNames.ACCEPT_LANGUAGE, acceptLanguagesValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIxNjM1MQ==", "bodyText": "No idea tbh.I'm inclined to say Preconditions.checkArgument(!acceptLanguages.isEmpty, \"acceptLanguages cannot be empty\"). How do you feel about that @trustin ?", "url": "https://github.com/line/armeria/pull/3177#discussion_r530216351", "createdAt": "2020-11-25T09:16:20Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +120,29 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    @Nullable\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        return getters != null ? getters.acceptLanguages() : null;\n+    }\n+\n+    @Override\n+    public RequestHeadersBuilder acceptLanguages(Iterable<LanguageRange> acceptLanguages) {\n+        requireNonNull(acceptLanguages, \"acceptLanguages\");\n+        final String acceptLanguagesValue = Streams\n+                .stream(acceptLanguages)\n+                .map(it -> (it.getWeight() == 1.0d) ? it.getRange() : it.getRange() + \";q=\" + it.getWeight())\n+                .collect(Collectors.joining(\", \"));\n+        set(HttpHeaderNames.ACCEPT_LANGUAGE, acceptLanguagesValue);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE1ODMzMg=="}, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIzMDM0NQ==", "bodyText": "SGTM", "url": "https://github.com/line/armeria/pull/3177#discussion_r530230345", "createdAt": "2020-11-25T09:36:26Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +120,29 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    @Nullable\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        return getters != null ? getters.acceptLanguages() : null;\n+    }\n+\n+    @Override\n+    public RequestHeadersBuilder acceptLanguages(Iterable<LanguageRange> acceptLanguages) {\n+        requireNonNull(acceptLanguages, \"acceptLanguages\");\n+        final String acceptLanguagesValue = Streams\n+                .stream(acceptLanguages)\n+                .map(it -> (it.getWeight() == 1.0d) ? it.getRange() : it.getRange() + \";q=\" + it.getWeight())\n+                .collect(Collectors.joining(\", \"));\n+        set(HttpHeaderNames.ACCEPT_LANGUAGE, acceptLanguagesValue);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE1ODMzMg=="}, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDk5Nzk5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNzozNDoyNlrOH5mV0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwOTozODoxOFrOH5qxFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE1OTA1OA==", "bodyText": "I still think we should accept Iterable<Locale> for users. We could convert it into a Collection when it's not.\n\nDitto for RequestHeaders\n\n\nWould you mind adding selectLocale(Locale...) as well? I know you don't really like it but all our methods provide a varargs version \ud83d\ude05 You can use ImmutableList.of().", "url": "https://github.com/line/armeria/pull/3177#discussion_r530159058", "createdAt": "2020-11-25T07:34:26Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "diffHunk": "@@ -318,6 +321,32 @@ default MediaType contentType() {\n         return headers().contentType();\n     }\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    @Nullable\n+    default List<LanguageRange> acceptLanguages() {\n+        return headers().acceptLanguages();\n+    }\n+\n+    /**\n+     * Matches the {@link Locale}s supported by the server to\n+     * the {@link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match\n+     * according to client preference. It does this via <s>Basic Filter</s>ing each\n+     * {@link LanguageRange} and picking the first match. This is the \"classic\"\n+     * algorithm described in\n+     * <a href=\"https://tools.ietf.org/html/rfc2616#section-14.4\">RFC2616 Accept-Language (obsoleted)</a>\n+     * and also referenced in <a href=\"https://tools.ietf.org/html/rfc7231#section-5.3.5\">RFC7231 Accept-Language</a>.\n+     * @param supportedLocales a {@link Collection} of locales supported by the server.\n+     * @return The best matching {@link Locale} or {@code null} if no {@link Locale} matches.\n+     */\n+    @Nullable\n+    default Locale selectLocale(Collection<Locale> supportedLocales) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIzMTU3NQ==", "bodyText": "Like I said, I misinterpreted that comment as a question not a very polite order \ud83d\ude04", "url": "https://github.com/line/armeria/pull/3177#discussion_r530231575", "createdAt": "2020-11-25T09:38:18Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "diffHunk": "@@ -318,6 +321,32 @@ default MediaType contentType() {\n         return headers().contentType();\n     }\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    @Nullable\n+    default List<LanguageRange> acceptLanguages() {\n+        return headers().acceptLanguages();\n+    }\n+\n+    /**\n+     * Matches the {@link Locale}s supported by the server to\n+     * the {@link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match\n+     * according to client preference. It does this via <s>Basic Filter</s>ing each\n+     * {@link LanguageRange} and picking the first match. This is the \"classic\"\n+     * algorithm described in\n+     * <a href=\"https://tools.ietf.org/html/rfc2616#section-14.4\">RFC2616 Accept-Language (obsoleted)</a>\n+     * and also referenced in <a href=\"https://tools.ietf.org/html/rfc7231#section-5.3.5\">RFC7231 Accept-Language</a>.\n+     * @param supportedLocales a {@link Collection} of locales supported by the server.\n+     * @return The best matching {@link Locale} or {@code null} if no {@link Locale} matches.\n+     */\n+    @Nullable\n+    default Locale selectLocale(Collection<Locale> supportedLocales) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE1OTA1OA=="}, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNTAwNzk1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNzozODoxMFrOH5mb_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMzozMTo0OVrOH5zj5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE2MDYzOQ==", "bodyText": "How about checking supportedLocales is empty before calling acceptLanguages()? If it's empty we don't need to parse the header.", "url": "https://github.com/line/armeria/pull/3177#discussion_r530160639", "createdAt": "2020-11-25T07:38:10Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,6 +181,41 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            return null;\n+        }\n+\n+        try {\n+            final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+            for (String acceptHeader : acceptHeaders) {\n+                acceptLanguages.addAll(LanguageRange.parse(acceptHeader));\n+            }\n+            acceptLanguages.sort(comparingDouble(LanguageRange::getWeight).reversed());\n+\n+            return ImmutableList.copyOf(acceptLanguages);\n+        } catch (IllegalArgumentException e) {\n+            // If any port of any of the headers is ill-formed\n+            return null;\n+        }\n+    }\n+\n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        final List<LanguageRange> languageRanges = acceptLanguages();\n+        if (languageRanges == null || supportedLocales.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwNDMzMg==", "bodyText": "Will do", "url": "https://github.com/line/armeria/pull/3177#discussion_r530204332", "createdAt": "2020-11-25T08:57:45Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,6 +181,41 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            return null;\n+        }\n+\n+        try {\n+            final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+            for (String acceptHeader : acceptHeaders) {\n+                acceptLanguages.addAll(LanguageRange.parse(acceptHeader));\n+            }\n+            acceptLanguages.sort(comparingDouble(LanguageRange::getWeight).reversed());\n+\n+            return ImmutableList.copyOf(acceptLanguages);\n+        } catch (IllegalArgumentException e) {\n+            // If any port of any of the headers is ill-formed\n+            return null;\n+        }\n+    }\n+\n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        final List<LanguageRange> languageRanges = acceptLanguages();\n+        if (languageRanges == null || supportedLocales.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE2MDYzOQ=="}, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIxNTUxOA==", "bodyText": "I don't understand the following? If you mean I should add Locale.... If so, absolutely. It was just a cultural misunderstanding. I sincerely thought it was a question where @ikhoon wanted my opinion, not a light version of \"please do it this way\". \ud83d\ude06\n\nHow about adding now for consistency? \ud83d\ude4f You can use ImmutableList.of().", "url": "https://github.com/line/armeria/pull/3177#discussion_r530215518", "createdAt": "2020-11-25T09:15:07Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,6 +181,41 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            return null;\n+        }\n+\n+        try {\n+            final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+            for (String acceptHeader : acceptHeaders) {\n+                acceptLanguages.addAll(LanguageRange.parse(acceptHeader));\n+            }\n+            acceptLanguages.sort(comparingDouble(LanguageRange::getWeight).reversed());\n+\n+            return ImmutableList.copyOf(acceptLanguages);\n+        } catch (IllegalArgumentException e) {\n+            // If any port of any of the headers is ill-formed\n+            return null;\n+        }\n+    }\n+\n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        final List<LanguageRange> languageRanges = acceptLanguages();\n+        if (languageRanges == null || supportedLocales.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE2MDYzOQ=="}, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIxNjkxNA==", "bodyText": "I'm not @ikhoon, so I'm not 100% sure, but I guess he thought he'll just add it later by himself since he is such a nice guy who doesn't want to waste your time doing a tedious job. \ud83d\ude09", "url": "https://github.com/line/armeria/pull/3177#discussion_r530216914", "createdAt": "2020-11-25T09:17:10Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,6 +181,41 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            return null;\n+        }\n+\n+        try {\n+            final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+            for (String acceptHeader : acceptHeaders) {\n+                acceptLanguages.addAll(LanguageRange.parse(acceptHeader));\n+            }\n+            acceptLanguages.sort(comparingDouble(LanguageRange::getWeight).reversed());\n+\n+            return ImmutableList.copyOf(acceptLanguages);\n+        } catch (IllegalArgumentException e) {\n+            // If any port of any of the headers is ill-formed\n+            return null;\n+        }\n+    }\n+\n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        final List<LanguageRange> languageRanges = acceptLanguages();\n+        if (languageRanges == null || supportedLocales.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE2MDYzOQ=="}, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0ODY4Mg==", "bodyText": "I also somehow missed his reply >_<. Sorry ikhoon.", "url": "https://github.com/line/armeria/pull/3177#discussion_r530248682", "createdAt": "2020-11-25T10:02:41Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,6 +181,41 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            return null;\n+        }\n+\n+        try {\n+            final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+            for (String acceptHeader : acceptHeaders) {\n+                acceptLanguages.addAll(LanguageRange.parse(acceptHeader));\n+            }\n+            acceptLanguages.sort(comparingDouble(LanguageRange::getWeight).reversed());\n+\n+            return ImmutableList.copyOf(acceptLanguages);\n+        } catch (IllegalArgumentException e) {\n+            // If any port of any of the headers is ill-formed\n+            return null;\n+        }\n+    }\n+\n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        final List<LanguageRange> languageRanges = acceptLanguages();\n+        if (languageRanges == null || supportedLocales.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE2MDYzOQ=="}, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM3NTY1Mg==", "bodyText": "I also somehow missed his reply >_<. Sorry ikhoon.\n\nNo problem. \ud83e\udd23\ud83e\udd23\ud83e\udd23", "url": "https://github.com/line/armeria/pull/3177#discussion_r530375652", "createdAt": "2020-11-25T13:31:49Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,6 +181,41 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            return null;\n+        }\n+\n+        try {\n+            final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+            for (String acceptHeader : acceptHeaders) {\n+                acceptLanguages.addAll(LanguageRange.parse(acceptHeader));\n+            }\n+            acceptLanguages.sort(comparingDouble(LanguageRange::getWeight).reversed());\n+\n+            return ImmutableList.copyOf(acceptLanguages);\n+        } catch (IllegalArgumentException e) {\n+            // If any port of any of the headers is ill-formed\n+            return null;\n+        }\n+    }\n+\n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        final List<LanguageRange> languageRanges = acceptLanguages();\n+        if (languageRanges == null || supportedLocales.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE2MDYzOQ=="}, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 52}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2038, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}