{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MTE2NTc3", "number": 3099, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMTo1NToyNVrOErJHwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMTo1NToyNVrOErJHwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNjczNjY1OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMTo1NToyNVrOHdvpaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNTozNzoyOVrOHekm6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk1MTQwMA==", "bodyText": "Is there any chance where onReady() is called multiple times? e.g. invokeHalfClosed() is called after setListener().", "url": "https://github.com/line/armeria/pull/3099#discussion_r500951400", "createdAt": "2020-10-07T11:55:25Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java", "diffHunk": "@@ -431,6 +431,7 @@ private void invokeHalfClose() {\n         try (SafeCloseable ignored = ctx.push()) {\n             assert listener != null;\n             listener.onHalfClose();\n+            listener.onReady();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ad8ddaa1ae10a86f470be9cd90c5a92801c3a42"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk1ODk3Mw==", "bodyText": "I missed pushing my last work. (27fc00c)\nI do not fully understand the listener's life cycle. I relied on the upstream gRPC server implementation. Based on the upstream gRPC server, the listener.onReady() is called two times if it is an unary stream listener.\n\nWhen a stream is activated\nonHalfClose() is invoked\n\n\n\nonHalfClose in StreamingServerCallListener does not call onReady.\nhttps://github.com/grpc/grpc-java/blob/9b73e2365da502a466b01544f102cd487e374428/stub/src/main/java/io/grpc/stub/ServerCalls.java#L263-L267\n\n      @Override\n      public void onHalfClose() {\n        halfClosed = true;\n        requestObserver.onCompleted();\n      }\n\nonHalfClose in UnaryServerCallListener calls onReady.\nhttps://github.com/grpc/grpc-java/blob/9b73e2365da502a466b01544f102cd487e374428/stub/src/main/java/io/grpc/stub/ServerCalls.java#L170-L190\n\n      public void onHalfClose() {\n        if (!canInvoke) {\n          return;\n        }\n        if (request == null) {\n          // Safe to close the call, because the application has not yet been invoked\n          call.close(\n              Status.INTERNAL.withDescription(MISSING_REQUEST),\n              new Metadata());\n          return;\n        }\n\n\n        method.invoke(request, responseObserver);\n        request = null;\n        responseObserver.freeze();\n        if (wasReady) {\n          // Since we are calling invoke in halfClose we have missed the onReady\n          // event from the transport so recover it here.\n          onReady();\n        }\n      }", "url": "https://github.com/line/armeria/pull/3099#discussion_r500958973", "createdAt": "2020-10-07T12:09:08Z", "author": {"login": "ikhoon"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java", "diffHunk": "@@ -431,6 +431,7 @@ private void invokeHalfClose() {\n         try (SafeCloseable ignored = ctx.push()) {\n             assert listener != null;\n             listener.onHalfClose();\n+            listener.onReady();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk1MTQwMA=="}, "originalCommit": {"oid": "5ad8ddaa1ae10a86f470be9cd90c5a92801c3a42"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4Mzc4MA==", "bodyText": "I see. So it's meant to be invoked multiple times whenever something's ready. Thanks for explanation!", "url": "https://github.com/line/armeria/pull/3099#discussion_r501583780", "createdAt": "2020-10-08T09:39:06Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java", "diffHunk": "@@ -431,6 +431,7 @@ private void invokeHalfClose() {\n         try (SafeCloseable ignored = ctx.push()) {\n             assert listener != null;\n             listener.onHalfClose();\n+            listener.onReady();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk1MTQwMA=="}, "originalCommit": {"oid": "5ad8ddaa1ae10a86f470be9cd90c5a92801c3a42"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4NDYzNw==", "bodyText": "Yes. :-)", "url": "https://github.com/line/armeria/pull/3099#discussion_r501584637", "createdAt": "2020-10-08T09:40:25Z", "author": {"login": "ikhoon"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java", "diffHunk": "@@ -431,6 +431,7 @@ private void invokeHalfClose() {\n         try (SafeCloseable ignored = ctx.push()) {\n             assert listener != null;\n             listener.onHalfClose();\n+            listener.onReady();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk1MTQwMA=="}, "originalCommit": {"oid": "5ad8ddaa1ae10a86f470be9cd90c5a92801c3a42"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgxOTExMg==", "bodyText": "FYI, the Javadoc for Listener.onReady()\n     * This indicates that the call may now be capable of sending additional messages (via\n     * {@link #sendMessage}) without requiring excessive buffering internally. This event is\n     * just a suggestion and the application is free to ignore it, however doing so may\n\nhttps://github.com/grpc/grpc-java/blob/18e7e2ddca1323bcdfec4649d7a1dd91a68f8223/api/src/main/java/io/grpc/ServerCall.java#L86-L88", "url": "https://github.com/line/armeria/pull/3099#discussion_r501819112", "createdAt": "2020-10-08T15:37:29Z", "author": {"login": "ikhoon"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java", "diffHunk": "@@ -431,6 +431,7 @@ private void invokeHalfClose() {\n         try (SafeCloseable ignored = ctx.push()) {\n             assert listener != null;\n             listener.onHalfClose();\n+            listener.onReady();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk1MTQwMA=="}, "originalCommit": {"oid": "5ad8ddaa1ae10a86f470be9cd90c5a92801c3a42"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1924, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}