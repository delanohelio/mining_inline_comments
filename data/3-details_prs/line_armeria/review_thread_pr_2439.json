{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5ODg5OTgx", "number": 2439, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwMjowNjozMlrODcgSQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNTo0ODoyOVrODchkkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMjE1NjgyOnYy", "diffSide": "RIGHT", "path": "thrift/src/main/java/com/linecorp/armeria/common/thrift/ThriftJacksonSerializers.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwMjowNjozMlrOFkk84g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNjoxMTo0NlrOFknLTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg5ODQ2Ng==", "bodyText": "nit: Could be private?", "url": "https://github.com/line/armeria/pull/2439#discussion_r373898466", "createdAt": "2020-02-03T02:06:32Z", "author": {"login": "ikhoon"}, "path": "thrift/src/main/java/com/linecorp/armeria/common/thrift/ThriftJacksonSerializers.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.function.Consumer;\n+\n+import javax.annotation.Nullable;\n+\n+import org.apache.thrift.TApplicationException;\n+import org.apache.thrift.TBase;\n+import org.apache.thrift.TException;\n+import org.apache.thrift.protocol.TMessage;\n+import org.apache.thrift.protocol.TProtocol;\n+import org.apache.thrift.transport.TMemoryBuffer;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.BeanDescription;\n+import com.fasterxml.jackson.databind.JavaType;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializationConfig;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.ser.Serializers;\n+import com.fasterxml.jackson.databind.ser.std.StdSerializer;\n+\n+import com.linecorp.armeria.common.thrift.text.TTextProtocol;\n+\n+final class ThriftJacksonSerializers extends Serializers.Base implements Serializable {\n+\n+    private static final long serialVersionUID = -285900387635271875L;\n+\n+    @Override\n+    public JsonSerializer<?> findSerializer(SerializationConfig config, JavaType type,\n+                                            BeanDescription beanDesc) {\n+\n+        final Class<?> rawType = type.getRawClass();\n+        if (TMessage.class.isAssignableFrom(rawType)) {\n+            return new TMessageJsonSerializer();\n+        }\n+        if (TBase.class.isAssignableFrom(rawType)) {\n+            return new TBaseJsonSerializer();\n+        }\n+        if (TApplicationException.class.isAssignableFrom(rawType)) {\n+            return new TApplicationExceptionJsonSerializer();\n+        }\n+        if (ThriftCall.class.isAssignableFrom(rawType)) {\n+            return new ThriftCallJsonSerializer();\n+        }\n+        if (ThriftReply.class.isAssignableFrom(rawType)) {\n+            return new ThriftReplyJsonSerializer();\n+        }\n+        return super.findSerializer(config, type, beanDesc);\n+    }\n+\n+    static void serializeTMessage(TMessage value, JsonGenerator gen) throws IOException {\n+        gen.writeStartObject();\n+\n+        gen.writeStringField(\"name\", value.name);\n+        gen.writeNumberField(\"type\", value.type);\n+        gen.writeNumberField(\"seqid\", value.seqid);\n+\n+        gen.writeEndObject();\n+    }\n+\n+    @SuppressWarnings(\"rawtypes\")\n+    static void serializeTBase(@Nullable TBase value, JsonGenerator gen) throws IOException {\n+        if (value == null) {\n+            gen.writeNull();\n+            return;\n+        }\n+\n+        gen.writeRawValue(serializeTBaseLike(protocol -> {\n+            try {\n+                value.write(protocol);\n+            } catch (TException ex) {\n+                throw new IllegalArgumentException(ex);\n+            }\n+        }));\n+    }\n+\n+    static void serializeTApplicationException(@Nullable TApplicationException value, JsonGenerator gen)\n+            throws IOException {\n+        if (value == null) {\n+            gen.writeNull();\n+            return;\n+        }\n+\n+        gen.writeRawValue(serializeTBaseLike(protocol -> {\n+            try {\n+                value.write(protocol);\n+            } catch (TException ex) {\n+                throw new IllegalArgumentException(ex);\n+            }\n+        }));\n+    }\n+\n+    static String serializeTBaseLike(Consumer<TProtocol> writer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ef1fbd9299716e88469a27551028f327b37949a"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzNDkyNA==", "bodyText": "Ah, yeah. Thanks for pointing out.", "url": "https://github.com/line/armeria/pull/2439#discussion_r373934924", "createdAt": "2020-02-03T06:11:46Z", "author": {"login": "trustin"}, "path": "thrift/src/main/java/com/linecorp/armeria/common/thrift/ThriftJacksonSerializers.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.function.Consumer;\n+\n+import javax.annotation.Nullable;\n+\n+import org.apache.thrift.TApplicationException;\n+import org.apache.thrift.TBase;\n+import org.apache.thrift.TException;\n+import org.apache.thrift.protocol.TMessage;\n+import org.apache.thrift.protocol.TProtocol;\n+import org.apache.thrift.transport.TMemoryBuffer;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.databind.BeanDescription;\n+import com.fasterxml.jackson.databind.JavaType;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.SerializationConfig;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.ser.Serializers;\n+import com.fasterxml.jackson.databind.ser.std.StdSerializer;\n+\n+import com.linecorp.armeria.common.thrift.text.TTextProtocol;\n+\n+final class ThriftJacksonSerializers extends Serializers.Base implements Serializable {\n+\n+    private static final long serialVersionUID = -285900387635271875L;\n+\n+    @Override\n+    public JsonSerializer<?> findSerializer(SerializationConfig config, JavaType type,\n+                                            BeanDescription beanDesc) {\n+\n+        final Class<?> rawType = type.getRawClass();\n+        if (TMessage.class.isAssignableFrom(rawType)) {\n+            return new TMessageJsonSerializer();\n+        }\n+        if (TBase.class.isAssignableFrom(rawType)) {\n+            return new TBaseJsonSerializer();\n+        }\n+        if (TApplicationException.class.isAssignableFrom(rawType)) {\n+            return new TApplicationExceptionJsonSerializer();\n+        }\n+        if (ThriftCall.class.isAssignableFrom(rawType)) {\n+            return new ThriftCallJsonSerializer();\n+        }\n+        if (ThriftReply.class.isAssignableFrom(rawType)) {\n+            return new ThriftReplyJsonSerializer();\n+        }\n+        return super.findSerializer(config, type, beanDesc);\n+    }\n+\n+    static void serializeTMessage(TMessage value, JsonGenerator gen) throws IOException {\n+        gen.writeStartObject();\n+\n+        gen.writeStringField(\"name\", value.name);\n+        gen.writeNumberField(\"type\", value.type);\n+        gen.writeNumberField(\"seqid\", value.seqid);\n+\n+        gen.writeEndObject();\n+    }\n+\n+    @SuppressWarnings(\"rawtypes\")\n+    static void serializeTBase(@Nullable TBase value, JsonGenerator gen) throws IOException {\n+        if (value == null) {\n+            gen.writeNull();\n+            return;\n+        }\n+\n+        gen.writeRawValue(serializeTBaseLike(protocol -> {\n+            try {\n+                value.write(protocol);\n+            } catch (TException ex) {\n+                throw new IllegalArgumentException(ex);\n+            }\n+        }));\n+    }\n+\n+    static void serializeTApplicationException(@Nullable TApplicationException value, JsonGenerator gen)\n+            throws IOException {\n+        if (value == null) {\n+            gen.writeNull();\n+            return;\n+        }\n+\n+        gen.writeRawValue(serializeTBaseLike(protocol -> {\n+            try {\n+                value.write(protocol);\n+            } catch (TException ex) {\n+                throw new IllegalArgumentException(ex);\n+            }\n+        }));\n+    }\n+\n+    static String serializeTBaseLike(Consumer<TProtocol> writer) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg5ODQ2Ng=="}, "originalCommit": {"oid": "6ef1fbd9299716e88469a27551028f327b37949a"}, "originalPosition": 111}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMjM0MDY3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/client/encoding/GzipStreamDecoderFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNToyMzo1MFrOFkmpfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNjoxMTowNlrOFknKog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkyNjI2OA==", "bodyText": "Maybe use enum singleton pattern for simple singletons like these", "url": "https://github.com/line/armeria/pull/2439#discussion_r373926268", "createdAt": "2020-02-03T05:23:50Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/client/encoding/GzipStreamDecoderFactory.java", "diffHunk": "@@ -22,7 +22,11 @@\n /**\n  * A {@link StreamDecoderFactory} which supports the 'gzip' encoding.\n  */\n-public class GzipStreamDecoderFactory implements StreamDecoderFactory {\n+final class GzipStreamDecoderFactory implements StreamDecoderFactory {\n+\n+    static final GzipStreamDecoderFactory INSTANCE = new GzipStreamDecoderFactory();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ef1fbd9299716e88469a27551028f327b37949a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzNDc1NA==", "bodyText": "Good idea. Merged the two classes into one enum class.", "url": "https://github.com/line/armeria/pull/2439#discussion_r373934754", "createdAt": "2020-02-03T06:11:06Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/encoding/GzipStreamDecoderFactory.java", "diffHunk": "@@ -22,7 +22,11 @@\n /**\n  * A {@link StreamDecoderFactory} which supports the 'gzip' encoding.\n  */\n-public class GzipStreamDecoderFactory implements StreamDecoderFactory {\n+final class GzipStreamDecoderFactory implements StreamDecoderFactory {\n+\n+    static final GzipStreamDecoderFactory INSTANCE = new GzipStreamDecoderFactory();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkyNjI2OA=="}, "originalCommit": {"oid": "6ef1fbd9299716e88469a27551028f327b37949a"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMjM0NTcxOnYy", "diffSide": "RIGHT", "path": "spring/boot-autoconfigure/src/main/java/com/linecorp/armeria/spring/MeterIdPrefixFunctionFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNToyODoxOVrOFkmsUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNjoxMToyN1rOFknK8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkyNjk5NA==", "bodyText": "This stopped being a singleton - probably not a big issue but just to make sure", "url": "https://github.com/line/armeria/pull/2439#discussion_r373926994", "createdAt": "2020-02-03T05:28:19Z", "author": {"login": "anuraaga"}, "path": "spring/boot-autoconfigure/src/main/java/com/linecorp/armeria/spring/MeterIdPrefixFunctionFactory.java", "diffHunk": "@@ -27,10 +27,20 @@\n \n     /**\n      * The default {@link MeterIdPrefixFunctionFactory} instance.\n+     *\n+     * @deprecated Use {@link #ofDefault()}.\n      */\n-    MeterIdPrefixFunctionFactory DEFAULT = (type, serviceName) ->\n-            MeterIdPrefixFunction.ofDefault(\"armeria.\" + requireNonNull(type, \"type\"))\n-                                 .withTags(\"service\", requireNonNull(serviceName, \"serviceName\"));\n+    @Deprecated\n+    MeterIdPrefixFunctionFactory DEFAULT = ofDefault();\n+\n+    /**\n+     * Returns the default {@link MeterIdPrefixFunctionFactory} instance.\n+     */\n+    static MeterIdPrefixFunctionFactory ofDefault() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ef1fbd9299716e88469a27551028f327b37949a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzNDgzMg==", "bodyText": "Extracted into a separate singleton.", "url": "https://github.com/line/armeria/pull/2439#discussion_r373934832", "createdAt": "2020-02-03T06:11:27Z", "author": {"login": "trustin"}, "path": "spring/boot-autoconfigure/src/main/java/com/linecorp/armeria/spring/MeterIdPrefixFunctionFactory.java", "diffHunk": "@@ -27,10 +27,20 @@\n \n     /**\n      * The default {@link MeterIdPrefixFunctionFactory} instance.\n+     *\n+     * @deprecated Use {@link #ofDefault()}.\n      */\n-    MeterIdPrefixFunctionFactory DEFAULT = (type, serviceName) ->\n-            MeterIdPrefixFunction.ofDefault(\"armeria.\" + requireNonNull(type, \"type\"))\n-                                 .withTags(\"service\", requireNonNull(serviceName, \"serviceName\"));\n+    @Deprecated\n+    MeterIdPrefixFunctionFactory DEFAULT = ofDefault();\n+\n+    /**\n+     * Returns the default {@link MeterIdPrefixFunctionFactory} instance.\n+     */\n+    static MeterIdPrefixFunctionFactory ofDefault() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkyNjk5NA=="}, "originalCommit": {"oid": "6ef1fbd9299716e88469a27551028f327b37949a"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMjM2NzU1OnYy", "diffSide": "RIGHT", "path": "zookeeper/src/main/java/com/linecorp/armeria/server/zookeeper/ZooKeeperUpdatingListener.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNTo0ODoyOVrOFkm5eQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwNTo0ODoyOVrOFkm5eQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzkzMDM2MQ==", "bodyText": "The following sentence explains deregistration and I think this reads better as just which registers the current..., it's the main point of the class.", "url": "https://github.com/line/armeria/pull/2439#discussion_r373930361", "createdAt": "2020-02-03T05:48:29Z", "author": {"login": "anuraaga"}, "path": "zookeeper/src/main/java/com/linecorp/armeria/server/zookeeper/ZooKeeperUpdatingListener.java", "diffHunk": "@@ -25,15 +25,20 @@\n import org.apache.zookeeper.CreateMode;\n \n import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.zookeeper.ZooKeeperEndpointGroup;\n import com.linecorp.armeria.common.zookeeper.NodeValueCodec;\n import com.linecorp.armeria.internal.zookeeper.ZooKeeperDefaults;\n import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerListener;\n import com.linecorp.armeria.server.ServerListenerAdapter;\n import com.linecorp.armeria.server.ServerPort;\n \n /**\n- * A ZooKeeper Server Listener. When you add this listener, server will be automatically registered\n- * into the ZooKeeper.\n+ * A {@link ServerListener} which (de)registers the current {@link Server} to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ef1fbd9299716e88469a27551028f327b37949a"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2960, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}