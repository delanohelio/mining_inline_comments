{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MTAzMDEz", "number": 2592, "title": "Change CountingSampler to accept float instead of double", "bodyText": "Motivation:\nCountingSampler is currently using double for probability, while Brave (where this class was originally forked from) is using float. This causes issues when passing in floats like 0.01f, which is converted to double as 0.009999999776482582. This causes percent to be 0.\nModification:\n\nChange CountingSampler to accept a float.\n\nResult:\nWhen passing in the probability of 0.01f, the percentage is correctly calculated as 1.", "createdAt": "2020-03-16T09:34:41Z", "url": "https://github.com/line/armeria/pull/2592", "merged": true, "mergeCommit": {"oid": "329535045acf038e093532b173f86b0856f089f7"}, "closed": true, "closedAt": "2020-03-16T10:44:48Z", "author": {"login": "KarboniteKream"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOKxrWAH2gAyMzg5MTAzMDEzOjk1NGMwYzYzZDQ1MWI5NjhlNjA4MjJjYWQwNjdhMDk4YTFlODMwNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOLM3lAFqTM3NTA2MDcxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "954c0c63d451b968e60822cad067a098a1e83055", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/954c0c63d451b968e60822cad067a098a1e83055", "committedDate": "2020-03-16T09:34:20Z", "message": "Change CountingSampler to accept float instead of double"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDQ1MDQ5", "url": "https://github.com/line/armeria/pull/2592#pullrequestreview-375045049", "createdAt": "2020-03-16T09:41:13Z", "commit": {"oid": "954c0c63d451b968e60822cad067a098a1e83055"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1228cadb5131a8f28dcb4f5e2e675890ce622fcb", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/1228cadb5131a8f28dcb4f5e2e675890ce622fcb", "committedDate": "2020-03-16T09:42:06Z", "message": "More tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDQ3NjI3", "url": "https://github.com/line/armeria/pull/2592#pullrequestreview-375047627", "createdAt": "2020-03-16T09:44:48Z", "commit": {"oid": "1228cadb5131a8f28dcb4f5e2e675890ce622fcb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOTo0NDo0OFrOF2sM7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOTo0NDo0OFrOF2sM7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg5MTYyOA==", "bodyText": "Isn't this 1?", "url": "https://github.com/line/armeria/pull/2592#discussion_r392891628", "createdAt": "2020-03-16T09:44:48Z", "author": {"login": "minwoox"}, "path": "core/src/test/java/com/linecorp/armeria/common/util/CountingSamplerTest.java", "diffHunk": "@@ -36,22 +36,29 @@\n \n public class CountingSamplerTest {\n     @Test\n-    public void testSamplingRateMinimumLimit() throws Exception {\n-        assertThatThrownBy(() -> CountingSampler.create(-1.99)).isInstanceOf(IllegalArgumentException.class);\n+    public void testSamplingRateMinimumLimit() {\n+        assertThatThrownBy(() -> CountingSampler.create(-1.99f)).isInstanceOf(IllegalArgumentException.class);\n     }\n \n     @Test\n-    public void testSamplingRateMaximumLimit() throws Exception {\n-        assertThatThrownBy(() -> CountingSampler.create(1.01)).isInstanceOf(IllegalArgumentException.class);\n+    public void testSamplingRateMaximumLimit() {\n+        assertThatThrownBy(() -> CountingSampler.create(1.01f)).isInstanceOf(IllegalArgumentException.class);\n     }\n \n     @Test\n-    public void testNeverSampledSampler() throws Exception {\n-        assertThat(CountingSampler.create(0.0)).isSameAs(Sampler.never());\n+    public void testSamplingRatePercentageRounding() {\n+        assertThat(CountingSampler.create(0.01f)).isInstanceOfSatisfying(CountingSampler.class, sampler -> {\n+            assertThat(sampler.sampleDecisions.cardinality()).isEqualTo(10);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1228cadb5131a8f28dcb4f5e2e675890ce622fcb"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "956ddb8d33c94cc826be18d7f2f263df477deec4", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/956ddb8d33c94cc826be18d7f2f263df477deec4", "committedDate": "2020-03-16T09:46:26Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDQ5Nzk2", "url": "https://github.com/line/armeria/pull/2592#pullrequestreview-375049796", "createdAt": "2020-03-16T09:47:57Z", "commit": {"oid": "956ddb8d33c94cc826be18d7f2f263df477deec4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOTo0Nzo1N1rOF2sTyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOTo0Nzo1N1rOF2sTyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg5MzM4NA==", "bodyText": "nit: you could just do isOne().", "url": "https://github.com/line/armeria/pull/2592#discussion_r392893384", "createdAt": "2020-03-16T09:47:57Z", "author": {"login": "minwoox"}, "path": "core/src/test/java/com/linecorp/armeria/common/util/CountingSamplerTest.java", "diffHunk": "@@ -36,22 +36,29 @@\n \n public class CountingSamplerTest {\n     @Test\n-    public void testSamplingRateMinimumLimit() throws Exception {\n-        assertThatThrownBy(() -> CountingSampler.create(-1.99)).isInstanceOf(IllegalArgumentException.class);\n+    public void testSamplingRateMinimumLimit() {\n+        assertThatThrownBy(() -> CountingSampler.create(-1.99f)).isInstanceOf(IllegalArgumentException.class);\n     }\n \n     @Test\n-    public void testSamplingRateMaximumLimit() throws Exception {\n-        assertThatThrownBy(() -> CountingSampler.create(1.01)).isInstanceOf(IllegalArgumentException.class);\n+    public void testSamplingRateMaximumLimit() {\n+        assertThatThrownBy(() -> CountingSampler.create(1.01f)).isInstanceOf(IllegalArgumentException.class);\n     }\n \n     @Test\n-    public void testNeverSampledSampler() throws Exception {\n-        assertThat(CountingSampler.create(0.0)).isSameAs(Sampler.never());\n+    public void testSamplingRatePercentageRounding() {\n+        assertThat(CountingSampler.create(0.01f)).isInstanceOfSatisfying(CountingSampler.class, sampler -> {\n+            assertThat(sampler.sampleDecisions.cardinality()).isEqualTo(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "956ddb8d33c94cc826be18d7f2f263df477deec4"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "147e6fb18a866413ff1461bab51ddba95aee97a1", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/147e6fb18a866413ff1461bab51ddba95aee97a1", "committedDate": "2020-03-16T09:53:50Z", "message": "Address comment by @minwoox"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDU2MjUw", "url": "https://github.com/line/armeria/pull/2592#pullrequestreview-375056250", "createdAt": "2020-03-16T09:57:26Z", "commit": {"oid": "147e6fb18a866413ff1461bab51ddba95aee97a1"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a94e2b4323593db80c981ee2a39c0bed24c69fea", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/a94e2b4323593db80c981ee2a39c0bed24c69fea", "committedDate": "2020-03-16T09:59:37Z", "message": "Add more tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MDYwNzE1", "url": "https://github.com/line/armeria/pull/2592#pullrequestreview-375060715", "createdAt": "2020-03-16T10:04:02Z", "commit": {"oid": "a94e2b4323593db80c981ee2a39c0bed24c69fea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 693, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}