{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMjA3ODg0", "number": 2849, "title": "Make the build not fail when `defaultUseHttp2Preface=false`", "bodyText": "Motivation:\nWe see some build failures when com.linecorp.armeria.defaultUseHttp2Preface=false\nflag is set.\nModifications:\n\nFix various test failures when useHttp2Preface is false.\nFix a bug where unfinishedResponses becomes a negative value when\nuseHttp2Preface is false.\nMiscellaneous:\n\nJavadoc updates in Flags\n\n\n\nResult:\n\nClient-side idle connection timeout works as expected when\nuseHttp2Preface is false.\nBetter documentation.", "createdAt": "2020-06-29T05:39:11Z", "url": "https://github.com/line/armeria/pull/2849", "merged": true, "mergeCommit": {"oid": "a6c575e2a675b1590ae53d9481495e101f511bfb"}, "closed": true, "closedAt": "2020-06-30T04:33:46Z", "author": {"login": "trustin"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcv6YVoAH2gAyNDQxMjA3ODg0OmI2ODA0ODFhYzY4NmFiNTcwNzU1ZGY5M2Y3MDE1YzZlZGQ3NWFiMzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwLwbdAH2gAyNDQxMjA3ODg0OjQ5MTk4NWEyYzZhYjNhNzdjNzE1ZTYzOWMyYzUzZTZiZDc1MzIzMWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b680481ac686ab570755df93f7015c6edd75ab38", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/b680481ac686ab570755df93f7015c6edd75ab38", "committedDate": "2020-06-29T05:41:36Z", "message": "Use an upgrade request for cleartext HTTP/2 connections\n\nMotivation:\n\nBy default, Armeria client currently sends an HTTP/2 connection preface\nimmediately for a cleartext HTTP/2 connection.\n\n- Although this works for most HTTP servers, it sometimes does not.\n- HTTP/2 RFC recommends sending an `OPTIONS * HTTP/1.1` request with\n  `Upgrade: h2c` header for cleartext HTTP/2 connections.\n\nModifications:\n\n- Disable `Flags.defaultUseHttp2Preface` by default.\n- Fix a bug where `unfinishedResponses` becomes a negative value when\n  `useHttp2Preface` is `false`.\n\nResult:\n\n- Better compatibility with HTTP/1 servers.\n- Faithful to HTTP/2 RFC recommendations\n- Client-side idle connection timeout works as expected when\n  `useHttp2Preface` is `false`.\n- Closes #1891"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d3b68347c8cc48ea4335318a0e30b4b13d3b08e", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/8d3b68347c8cc48ea4335318a0e30b4b13d3b08e", "committedDate": "2020-06-29T05:36:19Z", "message": "Use an upgrade request for cleartext HTTP/2 connections\n\nMotivation:\n\nBy default, Armeria client currently sends an HTTP/2 connection preface\nimmediately for a cleartext HTTP/2 connection.\n\n- Although this works for most HTTP servers, it sometimes does not.\n- HTTP/2 RFC recommends sending an `OPTIONS * HTTP/1.1` request with\n  `Upgrade: h2c` header for cleartext HTTP/2 connections.\n\nModifications:\n\n- Disable `Flags.defaultUseHttp2Preface` by default.\n- Fix a bug where `unfinishedResponses` becomes a negative value when\n  `useHttp2Preface` is `false`.\n\nResult:\n\n- Better compatibility with HTTP/1 servers.\n- Faithful to HTTP/2 RFC recommendations\n- Client-side idle connection timeout works as expected when\n  `useHttp2Preface` is `false`.\n- Closes #1891"}, "afterCommit": {"oid": "b680481ac686ab570755df93f7015c6edd75ab38", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/b680481ac686ab570755df93f7015c6edd75ab38", "committedDate": "2020-06-29T05:41:36Z", "message": "Use an upgrade request for cleartext HTTP/2 connections\n\nMotivation:\n\nBy default, Armeria client currently sends an HTTP/2 connection preface\nimmediately for a cleartext HTTP/2 connection.\n\n- Although this works for most HTTP servers, it sometimes does not.\n- HTTP/2 RFC recommends sending an `OPTIONS * HTTP/1.1` request with\n  `Upgrade: h2c` header for cleartext HTTP/2 connections.\n\nModifications:\n\n- Disable `Flags.defaultUseHttp2Preface` by default.\n- Fix a bug where `unfinishedResponses` becomes a negative value when\n  `useHttp2Preface` is `false`.\n\nResult:\n\n- Better compatibility with HTTP/1 servers.\n- Faithful to HTTP/2 RFC recommendations\n- Client-side idle connection timeout works as expected when\n  `useHttp2Preface` is `false`.\n- Closes #1891"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4OTAzOTk4", "url": "https://github.com/line/armeria/pull/2849#pullrequestreview-438903998", "createdAt": "2020-06-29T05:56:30Z", "commit": {"oid": "b680481ac686ab570755df93f7015c6edd75ab38"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e41dc4bef86b946cc00db799a5eeceebf76aae5d", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e41dc4bef86b946cc00db799a5eeceebf76aae5d", "committedDate": "2020-06-29T09:49:26Z", "message": "Enable HTTP/2 preface for `BraveClientIntegrationTest`\n\n.. because `MockWebServer` doesn't support upgrade requests."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "855b3884e41ab1e8b0eaa07f94c305529fc40127", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/855b3884e41ab1e8b0eaa07f94c305529fc40127", "committedDate": "2020-06-29T09:06:54Z", "message": "Enable HTTP/2 preface for `BraveClientIntegrationTest`\n\n.. because `MockWebServer` doesn't support upgrade requests."}, "afterCommit": {"oid": "e41dc4bef86b946cc00db799a5eeceebf76aae5d", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e41dc4bef86b946cc00db799a5eeceebf76aae5d", "committedDate": "2020-06-29T09:49:26Z", "message": "Enable HTTP/2 preface for `BraveClientIntegrationTest`\n\n.. because `MockWebServer` doesn't support upgrade requests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f40c807348e52597b07cb05368c9d399b063ca7", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/2f40c807348e52597b07cb05368c9d399b063ca7", "committedDate": "2020-06-29T11:30:16Z", "message": "Work around the issues with `com.sun.net.httpserver`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f218bf7975993ec5980f1811a28708586dc463d", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/4f218bf7975993ec5980f1811a28708586dc463d", "committedDate": "2020-06-29T12:49:58Z", "message": "Revert the default value"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b8763366207306baf2167e8b5f01b2b1b9baa86c", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/b8763366207306baf2167e8b5f01b2b1b9baa86c", "committedDate": "2020-06-29T12:51:33Z", "message": "Revert Eureka client test"}, "afterCommit": {"oid": "4f218bf7975993ec5980f1811a28708586dc463d", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/4f218bf7975993ec5980f1811a28708586dc463d", "committedDate": "2020-06-29T12:49:58Z", "message": "Revert the default value"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MTY0MDU3", "url": "https://github.com/line/armeria/pull/2849#pullrequestreview-439164057", "createdAt": "2020-06-29T13:51:18Z", "commit": {"oid": "4f218bf7975993ec5980f1811a28708586dc463d"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMzo1MToxOFrOGqR8WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMzo1NToyN1rOGqSH5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4NzM1Mg==", "bodyText": "sends preface?", "url": "https://github.com/line/armeria/pull/2849#discussion_r446987352", "createdAt": "2020-06-29T13:51:18Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -724,7 +744,14 @@ public static int defaultHttp1MaxChunkSize() {\n \n     /**\n      * Returns the default value of the {@link ClientFactoryBuilder#useHttp2Preface(boolean)} option.\n-     * Note that this value has effect only if a user did not specify it.\n+     * If enabled, the HTTP/2 connection preface immediately for a cleartext HTTP/2 connection, reducing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f218bf7975993ec5980f1811a28708586dc463d"}, "originalPosition": 221}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4ODU0Nw==", "bodyText": "Thanks!", "url": "https://github.com/line/armeria/pull/2849#discussion_r446988547", "createdAt": "2020-06-29T13:52:57Z", "author": {"login": "minwoox"}, "path": "eureka/src/test/java/com/linecorp/armeria/client/eureka/ArmeriaEurekaClientTest.java", "diffHunk": "@@ -63,17 +63,32 @@\n \n     @Override\n     protected EurekaHttpClient getEurekaHttpClient(URI serviceURI) {\n-        return new EurekaHttpClientWrapper(WebClient.of(serviceURI));\n+        return new EurekaHttpClientWrapper(WebClient.of(toH1C(serviceURI)));\n     }\n \n     @Override\n     protected EurekaHttpClient getEurekaClientWithBasicAuthentication(String userName, String password) {\n-        final WebClient webClient = WebClient.builder(getHttpServer().getServiceURI())\n+        final WebClient webClient = WebClient.builder(toH1C(getHttpServer().getServiceURI()))\n                                              .auth(BasicToken.of(userName, password))\n                                              .build();\n         return new EurekaHttpClientWrapper(webClient);\n     }\n \n+    private static String toH1C(URI serviceURI) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f218bf7975993ec5980f1811a28708586dc463d"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk5MDMxMQ==", "bodyText": "Let's move this comment one line down. \ud83d\ude04", "url": "https://github.com/line/armeria/pull/2849#discussion_r446990311", "createdAt": "2020-06-29T13:55:27Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java", "diffHunk": "@@ -441,6 +441,7 @@ public void onComplete() {}\n             }, ctx.channel().eventLoop());\n \n             // NB: No need to set the response timeout because we have session creation timeout.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f218bf7975993ec5980f1811a28708586dc463d"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52be092d6545e75a9a96f3c285dc4c69eccb8c3c", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/52be092d6545e75a9a96f3c285dc4c69eccb8c3c", "committedDate": "2020-06-30T01:30:03Z", "message": "Address the comment from @minwoox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "611784d30ec576cc59a4988ad8f81857c3b1a044", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/611784d30ec576cc59a4988ad8f81857c3b1a044", "committedDate": "2020-06-30T01:30:37Z", "message": "Address the 2nd comment from @minwoox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "491985a2c6ab3a77c715e639c2c53e6bd753231f", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/491985a2c6ab3a77c715e639c2c53e6bd753231f", "committedDate": "2020-06-30T01:56:18Z", "message": "Merge branch 'master' into use_upgrade_request"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 317, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}