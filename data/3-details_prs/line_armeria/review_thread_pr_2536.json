{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwMTY1MDAw", "number": 2536, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMToxNzoyMVrODjCapQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTo0MTowNFrODjboDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MDY2MzQxOnYy", "diffSide": "RIGHT", "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMToxNzoyMVrOFunsWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwMDozNDo1MFrOFvBaWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQyOTE0Nw==", "bodyText": "when serving the request from the response side. I'm thinking we ignore header mutations..", "url": "https://github.com/line/armeria/pull/2536#discussion_r384429147", "createdAt": "2020-02-26T11:17:21Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "diffHunk": "@@ -89,7 +89,9 @@ public String header(String name) {\n \n         @Override\n         public void header(String name, String value) {\n-            headersBuilder.set(name, value);\n+            if (headersBuilder != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39792112c2ed187d0329f3874cb71c1ed5092eec"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDg1MDUyMg==", "bodyText": "we could before, just htis will make that more explicit openzipkin/brave#1103", "url": "https://github.com/line/armeria/pull/2536#discussion_r384850522", "createdAt": "2020-02-27T00:34:50Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "diffHunk": "@@ -89,7 +89,9 @@ public String header(String name) {\n \n         @Override\n         public void header(String name, String value) {\n-            headersBuilder.set(name, value);\n+            if (headersBuilder != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQyOTE0Nw=="}, "originalCommit": {"oid": "39792112c2ed187d0329f3874cb71c1ed5092eec"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MDY2NTI1OnYy", "diffSide": "RIGHT", "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMToxNzo1MFrOFuntXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNTo1Njo0OVrOFvGDUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQyOTQwNQ==", "bodyText": "is being lazy here (and in server) over-optimization from POV of armeria?", "url": "https://github.com/line/armeria/pull/2536#discussion_r384429405", "createdAt": "2020-02-26T11:17:50Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "diffHunk": "@@ -113,6 +115,7 @@ public long startTimestamp() {\n     @SuppressWarnings(\"ClassNameSameAsAncestorName\")\n     private static final class HttpClientResponse extends brave.http.HttpClientResponse {\n         private final RequestLog log;\n+        private brave.http.HttpClientRequest request;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39792112c2ed187d0329f3874cb71c1ed5092eec"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyNjU0NA==", "bodyText": "Think it's good.", "url": "https://github.com/line/armeria/pull/2536#discussion_r384926544", "createdAt": "2020-02-27T05:56:49Z", "author": {"login": "anuraaga"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "diffHunk": "@@ -113,6 +115,7 @@ public long startTimestamp() {\n     @SuppressWarnings(\"ClassNameSameAsAncestorName\")\n     private static final class HttpClientResponse extends brave.http.HttpClientResponse {\n         private final RequestLog log;\n+        private brave.http.HttpClientRequest request;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQyOTQwNQ=="}, "originalCommit": {"oid": "39792112c2ed187d0329f3874cb71c1ed5092eec"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MzgzODE2OnYy", "diffSide": "RIGHT", "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNTo1Njo0MlrOFvGDLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNjoyOTowN1rOFvGirw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyNjUwOQ==", "bodyText": "I was sort of expecting this to accept HttpClientRequest as a parameter and passed in when initializing here\nhttps://github.com/line/armeria/blob/master/brave/src/main/java/com/linecorp/armeria/client/brave/BraveClient.java#L162\nI guess it does mean mutations would be present but is it a problem either way?\nBut anyways, reexposing, with the lazy instantiation, seems fine to me too.", "url": "https://github.com/line/armeria/pull/2536#discussion_r384926509", "createdAt": "2020-02-27T05:56:42Z", "author": {"login": "anuraaga"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "diffHunk": "@@ -113,6 +115,7 @@ public long startTimestamp() {\n     @SuppressWarnings(\"ClassNameSameAsAncestorName\")\n     private static final class HttpClientResponse extends brave.http.HttpClientResponse {\n         private final RequestLog log;\n+        private brave.http.HttpClientRequest request;\n \n         HttpClientResponse(RequestLog log) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39792112c2ed187d0329f3874cb71c1ed5092eec"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMTk3OQ==", "bodyText": "this is part of me not knowing the lifecycle. I'm not sure if the instance could be different by the time we reach response time. is that something we cam know?", "url": "https://github.com/line/armeria/pull/2536#discussion_r384931979", "createdAt": "2020-02-27T06:18:59Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "diffHunk": "@@ -113,6 +115,7 @@ public long startTimestamp() {\n     @SuppressWarnings(\"ClassNameSameAsAncestorName\")\n     private static final class HttpClientResponse extends brave.http.HttpClientResponse {\n         private final RequestLog log;\n+        private brave.http.HttpClientRequest request;\n \n         HttpClientResponse(RequestLog log) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyNjUwOQ=="}, "originalCommit": {"oid": "39792112c2ed187d0329f3874cb71c1ed5092eec"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzMjYzMA==", "bodyText": "Instance is the same. In other words, the only difference between passing the originally created HttpClientRequest here or recreating it here is the value of headersBuilder, everything else should be exactly the same since it's the same ClientRequestContext.", "url": "https://github.com/line/armeria/pull/2536#discussion_r384932630", "createdAt": "2020-02-27T06:21:28Z", "author": {"login": "anuraaga"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "diffHunk": "@@ -113,6 +115,7 @@ public long startTimestamp() {\n     @SuppressWarnings(\"ClassNameSameAsAncestorName\")\n     private static final class HttpClientResponse extends brave.http.HttpClientResponse {\n         private final RequestLog log;\n+        private brave.http.HttpClientRequest request;\n \n         HttpClientResponse(RequestLog log) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyNjUwOQ=="}, "originalCommit": {"oid": "39792112c2ed187d0329f3874cb71c1ed5092eec"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkzNDU3NQ==", "bodyText": "ok in that case, let's reuse it. thanks!", "url": "https://github.com/line/armeria/pull/2536#discussion_r384934575", "createdAt": "2020-02-27T06:29:07Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "diffHunk": "@@ -113,6 +115,7 @@ public long startTimestamp() {\n     @SuppressWarnings(\"ClassNameSameAsAncestorName\")\n     private static final class HttpClientResponse extends brave.http.HttpClientResponse {\n         private final RequestLog log;\n+        private brave.http.HttpClientRequest request;\n \n         HttpClientResponse(RequestLog log) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDkyNjUwOQ=="}, "originalCommit": {"oid": "39792112c2ed187d0329f3874cb71c1ed5092eec"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NDY4Njg0OnYy", "diffSide": "RIGHT", "path": "brave/src/main/java/com/linecorp/armeria/client/brave/BraveClient.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTowNDo1M1rOFvOEug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMzoyNDowOVrOFvod7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1Nzk3OA==", "bodyText": "Unrelated to this PR so just food for thought / another PR but just noticed it - since we pass the span to the handler, do we need to push the context (e.g. mount the scope)?", "url": "https://github.com/line/armeria/pull/2536#discussion_r385057978", "createdAt": "2020-02-27T11:04:53Z", "author": {"login": "anuraaga"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/BraveClient.java", "diffHunk": "@@ -159,9 +160,9 @@ public HttpResponse execute(ClientRequestContext ctx, HttpRequest req) throws Ex\n                 }\n             }\n \n-            final HttpClientResponse response = ClientRequestContextAdapter.asHttpClientResponse(log);\n+            final HttpClientResponse response = ClientRequestContextAdapter.asHttpClientResponse(log, request);\n             try (SafeCloseable ignored = ctx.push()) {\n-                handler.handleReceive(response, log.responseCause(), span);\n+                handler.handleReceive(response, response.error(), span);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzMDg4NQ==", "bodyText": "brave 5.11 doesn't mount the scope anymore intentionally, to improve performance (as scope handlers dangling off a thread local can cost a bit). instead the parsers get an arg for the context. the old implementation of the parser will indeed scope, but as handleSend/handleReceive are callbacks (iotw cul-de-sacs, not interceptors which would surround user code), we don't have any use case for scoping anymore internally.", "url": "https://github.com/line/armeria/pull/2536#discussion_r385430885", "createdAt": "2020-02-27T23:32:12Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/BraveClient.java", "diffHunk": "@@ -159,9 +160,9 @@ public HttpResponse execute(ClientRequestContext ctx, HttpRequest req) throws Ex\n                 }\n             }\n \n-            final HttpClientResponse response = ClientRequestContextAdapter.asHttpClientResponse(log);\n+            final HttpClientResponse response = ClientRequestContextAdapter.asHttpClientResponse(log, request);\n             try (SafeCloseable ignored = ctx.push()) {\n-                handler.handleReceive(response, log.responseCause(), span);\n+                handler.handleReceive(response, response.error(), span);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1Nzk3OA=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ2OTkzMw==", "bodyText": "Cool - yeah I think that means we can remove the request context push around the callbacks too that is there to allow brave to scope off the threadlocal but if it's not doing that it should be unnecessary.", "url": "https://github.com/line/armeria/pull/2536#discussion_r385469933", "createdAt": "2020-02-28T01:51:32Z", "author": {"login": "anuraaga"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/BraveClient.java", "diffHunk": "@@ -159,9 +160,9 @@ public HttpResponse execute(ClientRequestContext ctx, HttpRequest req) throws Ex\n                 }\n             }\n \n-            final HttpClientResponse response = ClientRequestContextAdapter.asHttpClientResponse(log);\n+            final HttpClientResponse response = ClientRequestContextAdapter.asHttpClientResponse(log, request);\n             try (SafeCloseable ignored = ctx.push()) {\n-                handler.handleReceive(response, log.responseCause(), span);\n+                handler.handleReceive(response, response.error(), span);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1Nzk3OA=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5MDQxMw==", "bodyText": "great idea", "url": "https://github.com/line/armeria/pull/2536#discussion_r385490413", "createdAt": "2020-02-28T03:24:09Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/BraveClient.java", "diffHunk": "@@ -159,9 +160,9 @@ public HttpResponse execute(ClientRequestContext ctx, HttpRequest req) throws Ex\n                 }\n             }\n \n-            final HttpClientResponse response = ClientRequestContextAdapter.asHttpClientResponse(log);\n+            final HttpClientResponse response = ClientRequestContextAdapter.asHttpClientResponse(log, request);\n             try (SafeCloseable ignored = ctx.push()) {\n-                handler.handleReceive(response, log.responseCause(), span);\n+                handler.handleReceive(response, response.error(), span);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1Nzk3OA=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NDY5MDgzOnYy", "diffSide": "RIGHT", "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTowNjowNFrOFvOHEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMzoyOToyNFrOFvkyJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1ODU3Ng==", "bodyText": "I think we can revert the headers related changes now that we just serve the same request object", "url": "https://github.com/line/armeria/pull/2536#discussion_r385058576", "createdAt": "2020-02-27T11:06:04Z", "author": {"login": "anuraaga"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "diffHunk": "@@ -44,9 +44,9 @@\n     @SuppressWarnings(\"ClassNameSameAsAncestorName\")\n     private static final class HttpClientRequest extends brave.http.HttpClientRequest {\n         private final ClientRequestContext ctx;\n-        private final RequestHeadersBuilder headersBuilder;\n+        @Nullable private final RequestHeadersBuilder headersBuilder;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzMDA1Mg==", "bodyText": "agreed", "url": "https://github.com/line/armeria/pull/2536#discussion_r385430052", "createdAt": "2020-02-27T23:29:24Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ClientRequestContextAdapter.java", "diffHunk": "@@ -44,9 +44,9 @@\n     @SuppressWarnings(\"ClassNameSameAsAncestorName\")\n     private static final class HttpClientRequest extends brave.http.HttpClientRequest {\n         private final ClientRequestContext ctx;\n-        private final RequestHeadersBuilder headersBuilder;\n+        @Nullable private final RequestHeadersBuilder headersBuilder;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1ODU3Ng=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NDY5MjY5OnYy", "diffSide": "RIGHT", "path": "brave/src/main/java/com/linecorp/armeria/server/brave/BraveService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTowNjo0NlrOFvOIIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTowNjo0NlrOFvOIIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1ODg0OQ==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/2536#discussion_r385058849", "createdAt": "2020-02-27T11:06:46Z", "author": {"login": "anuraaga"}, "path": "brave/src/main/java/com/linecorp/armeria/server/brave/BraveService.java", "diffHunk": "@@ -98,9 +100,9 @@ public HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) throws Exc\n                 // If the client timed-out the request, we will have never sent any response data at all.\n             }\n \n-            final HttpServerResponse response = ServiceRequestContextAdapter.asHttpServerResponse(log);\n+            final HttpServerResponse response = ServiceRequestContextAdapter.asHttpServerResponse(log, request);\n             try (SafeCloseable ignored = ctx.push()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NDY5NzA1OnYy", "diffSide": "RIGHT", "path": "brave/src/test/java/com/linecorp/armeria/server/brave/BraveServiceTest.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTowODoyM1rOFvOK5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNDowODo0NlrOFvo_Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1OTU1OQ==", "bodyText": "I guess neither 3 nor 1 mean much to me. We probably should add a comment explaining what this is actually asserting semantically.", "url": "https://github.com/line/armeria/pull/2536#discussion_r385059559", "createdAt": "2020-02-27T11:08:23Z", "author": {"login": "anuraaga"}, "path": "brave/src/test/java/com/linecorp/armeria/server/brave/BraveServiceTest.java", "diffHunk": "@@ -148,7 +148,7 @@ void scopeDecorator() throws Exception {\n \n         // check service name\n         assertThat(span.localServiceName()).isEqualTo(TEST_SERVICE);\n-        assertThat(scopeDecoratorCallingCounter.get()).isEqualTo(3);\n+        assertThat(scopeDecoratorCallingCounter.get()).isEqualTo(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA2Mzg2Nw==", "bodyText": "Or we can remove if it's too strongly tied to implementation details to be helpful.", "url": "https://github.com/line/armeria/pull/2536#discussion_r385063867", "createdAt": "2020-02-27T11:17:20Z", "author": {"login": "anuraaga"}, "path": "brave/src/test/java/com/linecorp/armeria/server/brave/BraveServiceTest.java", "diffHunk": "@@ -148,7 +148,7 @@ void scopeDecorator() throws Exception {\n \n         // check service name\n         assertThat(span.localServiceName()).isEqualTo(TEST_SERVICE);\n-        assertThat(scopeDecoratorCallingCounter.get()).isEqualTo(3);\n+        assertThat(scopeDecoratorCallingCounter.get()).isEqualTo(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1OTU1OQ=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQyOTkyNg==", "bodyText": "yeah good point.. the reduction by two is not scoping during parsing :) I'll make a comment that the presence of 1 is for downstream handlers. usually I check some interceptor can read the context vs counting, though in this case counting was a good thing as it shows the better performance we should expect", "url": "https://github.com/line/armeria/pull/2536#discussion_r385429926", "createdAt": "2020-02-27T23:28:58Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/test/java/com/linecorp/armeria/server/brave/BraveServiceTest.java", "diffHunk": "@@ -148,7 +148,7 @@ void scopeDecorator() throws Exception {\n \n         // check service name\n         assertThat(span.localServiceName()).isEqualTo(TEST_SERVICE);\n-        assertThat(scopeDecoratorCallingCounter.get()).isEqualTo(3);\n+        assertThat(scopeDecoratorCallingCounter.get()).isEqualTo(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1OTU1OQ=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5NjE1Mg==", "bodyText": "Maybe .isGreaterThanZero() then?", "url": "https://github.com/line/armeria/pull/2536#discussion_r385496152", "createdAt": "2020-02-28T03:53:49Z", "author": {"login": "trustin"}, "path": "brave/src/test/java/com/linecorp/armeria/server/brave/BraveServiceTest.java", "diffHunk": "@@ -148,7 +148,7 @@ void scopeDecorator() throws Exception {\n \n         // check service name\n         assertThat(span.localServiceName()).isEqualTo(TEST_SERVICE);\n-        assertThat(scopeDecoratorCallingCounter.get()).isEqualTo(3);\n+        assertThat(scopeDecoratorCallingCounter.get()).isEqualTo(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1OTU1OQ=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5ODg5NA==", "bodyText": "added isOne as incrementing would be a bug unless intentional", "url": "https://github.com/line/armeria/pull/2536#discussion_r385498894", "createdAt": "2020-02-28T04:08:46Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/test/java/com/linecorp/armeria/server/brave/BraveServiceTest.java", "diffHunk": "@@ -148,7 +148,7 @@ void scopeDecorator() throws Exception {\n \n         // check service name\n         assertThat(span.localServiceName()).isEqualTo(TEST_SERVICE);\n-        assertThat(scopeDecoratorCallingCounter.get()).isEqualTo(3);\n+        assertThat(scopeDecoratorCallingCounter.get()).isEqualTo(1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA1OTU1OQ=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NDc3ODYxOnYy", "diffSide": "RIGHT", "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ArmeriaHttpClientParser.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTozNjowMFrOFvO74g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwMzo1ODoyMVrOFvo3xQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3MjA5OA==", "bodyText": "nit: span could be renamed back to customizer or spanCustomizer?", "url": "https://github.com/line/armeria/pull/2536#discussion_r385072098", "createdAt": "2020-02-27T11:36:00Z", "author": {"login": "trustin"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ArmeriaHttpClientParser.java", "diffHunk": "@@ -53,8 +55,10 @@ static ArmeriaHttpClientParser get() {\n     private ArmeriaHttpClientParser() {}\n \n     @Override\n-    public <T> void request(HttpAdapter<T, ?> rawAdapter, T req, SpanCustomizer customizer) {\n-        super.request(rawAdapter, req, customizer);\n+    public void parse(brave.http.HttpRequest request, TraceContext context, SpanCustomizer span) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4MTQwMA==", "bodyText": "Personally good with span, Span, MutableSpan, and SpanCustomizer are basically the same concept.", "url": "https://github.com/line/armeria/pull/2536#discussion_r385081400", "createdAt": "2020-02-27T11:57:04Z", "author": {"login": "anuraaga"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ArmeriaHttpClientParser.java", "diffHunk": "@@ -53,8 +55,10 @@ static ArmeriaHttpClientParser get() {\n     private ArmeriaHttpClientParser() {}\n \n     @Override\n-    public <T> void request(HttpAdapter<T, ?> rawAdapter, T req, SpanCustomizer customizer) {\n-        super.request(rawAdapter, req, customizer);\n+    public void parse(brave.http.HttpRequest request, TraceContext context, SpanCustomizer span) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3MjA5OA=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5NTg3OQ==", "bodyText": "OK. No need to rename, then. :-)", "url": "https://github.com/line/armeria/pull/2536#discussion_r385495879", "createdAt": "2020-02-28T03:52:23Z", "author": {"login": "trustin"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ArmeriaHttpClientParser.java", "diffHunk": "@@ -53,8 +55,10 @@ static ArmeriaHttpClientParser get() {\n     private ArmeriaHttpClientParser() {}\n \n     @Override\n-    public <T> void request(HttpAdapter<T, ?> rawAdapter, T req, SpanCustomizer customizer) {\n-        super.request(rawAdapter, req, customizer);\n+    public void parse(brave.http.HttpRequest request, TraceContext context, SpanCustomizer span) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3MjA5OA=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5NzAyOQ==", "bodyText": "yeah we fixed the name to span upstream. naming parameter based on type was laborious", "url": "https://github.com/line/armeria/pull/2536#discussion_r385497029", "createdAt": "2020-02-28T03:58:21Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ArmeriaHttpClientParser.java", "diffHunk": "@@ -53,8 +55,10 @@ static ArmeriaHttpClientParser get() {\n     private ArmeriaHttpClientParser() {}\n \n     @Override\n-    public <T> void request(HttpAdapter<T, ?> rawAdapter, T req, SpanCustomizer customizer) {\n-        super.request(rawAdapter, req, customizer);\n+    public void parse(brave.http.HttpRequest request, TraceContext context, SpanCustomizer span) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3MjA5OA=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NDc4MDcyOnYy", "diffSide": "RIGHT", "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ArmeriaHttpClientParser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTozNjozOVrOFvO9Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTozNjozOVrOFvO9Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3MjQwNg==", "bodyText": "nit: res -> unwrapped?", "url": "https://github.com/line/armeria/pull/2536#discussion_r385072406", "createdAt": "2020-02-27T11:36:39Z", "author": {"login": "trustin"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/ArmeriaHttpClientParser.java", "diffHunk": "@@ -66,39 +70,41 @@ private ArmeriaHttpClientParser() {}\n             return;\n         }\n \n-        customizer.tag(SpanTags.TAG_HTTP_HOST, httpReq.authority())\n-                  .tag(SpanTags.TAG_HTTP_URL, httpReq.uri().toString());\n+        span.tag(SpanTags.TAG_HTTP_HOST, httpReq.authority())\n+            .tag(SpanTags.TAG_HTTP_URL, httpReq.uri().toString());\n     }\n \n     @Override\n-    public <T> void response(HttpAdapter<?, T> rawAdapter, T res, Throwable error, SpanCustomizer customizer) {\n-        super.response(rawAdapter, res, error, customizer);\n+    public void parse(HttpResponse response, TraceContext context, SpanCustomizer span) {\n+        HttpResponseParser.DEFAULT.parse(response, context, span);\n+\n+        final Object res = response.unwrap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NDc4ODYxOnYy", "diffSide": "RIGHT", "path": "brave/src/main/java/com/linecorp/armeria/server/brave/ArmeriaHttpServerParser.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTozOToxOVrOFvPBtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTozOToxOVrOFvPBtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3MzU5MA==", "bodyText": "nit: req -> unwrapped", "url": "https://github.com/line/armeria/pull/2536#discussion_r385073590", "createdAt": "2020-02-27T11:39:19Z", "author": {"login": "trustin"}, "path": "brave/src/main/java/com/linecorp/armeria/server/brave/ArmeriaHttpServerParser.java", "diffHunk": "@@ -51,23 +53,27 @@ private ArmeriaHttpServerParser() {\n     }\n \n     @Override\n-    public <T> void request(HttpAdapter<T, ?> rawAdapter, T req, SpanCustomizer customizer) {\n-        super.request(rawAdapter, req, customizer);\n+    public void parse(brave.http.HttpRequest request, TraceContext context, SpanCustomizer span) {\n+        HttpRequestParser.DEFAULT.parse(request, context, span);\n+\n+        final Object req = request.unwrap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NDc4OTMwOnYy", "diffSide": "RIGHT", "path": "brave/src/main/java/com/linecorp/armeria/server/brave/ArmeriaHttpServerParser.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTozOTozM1rOFvPCJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNDowODoxM1rOFvo-qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3MzcwMw==", "bodyText": "nit: span -> customizer or spanCustomizer", "url": "https://github.com/line/armeria/pull/2536#discussion_r385073703", "createdAt": "2020-02-27T11:39:33Z", "author": {"login": "trustin"}, "path": "brave/src/main/java/com/linecorp/armeria/server/brave/ArmeriaHttpServerParser.java", "diffHunk": "@@ -51,23 +53,27 @@ private ArmeriaHttpServerParser() {\n     }\n \n     @Override\n-    public <T> void request(HttpAdapter<T, ?> rawAdapter, T req, SpanCustomizer customizer) {\n-        super.request(rawAdapter, req, customizer);\n+    public void parse(brave.http.HttpRequest request, TraceContext context, SpanCustomizer span) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5NzUyOA==", "bodyText": "choosing not to unless you think this is very important", "url": "https://github.com/line/armeria/pull/2536#discussion_r385497528", "createdAt": "2020-02-28T04:01:15Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/main/java/com/linecorp/armeria/server/brave/ArmeriaHttpServerParser.java", "diffHunk": "@@ -51,23 +53,27 @@ private ArmeriaHttpServerParser() {\n     }\n \n     @Override\n-    public <T> void request(HttpAdapter<T, ?> rawAdapter, T req, SpanCustomizer customizer) {\n-        super.request(rawAdapter, req, customizer);\n+    public void parse(brave.http.HttpRequest request, TraceContext context, SpanCustomizer span) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3MzcwMw=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5ODc5Mw==", "bodyText": "ditto on opting out, but if you really really want it to I can change it", "url": "https://github.com/line/armeria/pull/2536#discussion_r385498793", "createdAt": "2020-02-28T04:08:13Z", "author": {"login": "codefromthecrypt"}, "path": "brave/src/main/java/com/linecorp/armeria/server/brave/ArmeriaHttpServerParser.java", "diffHunk": "@@ -51,23 +53,27 @@ private ArmeriaHttpServerParser() {\n     }\n \n     @Override\n-    public <T> void request(HttpAdapter<T, ?> rawAdapter, T req, SpanCustomizer customizer) {\n-        super.request(rawAdapter, req, customizer);\n+    public void parse(brave.http.HttpRequest request, TraceContext context, SpanCustomizer span) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3MzcwMw=="}, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NDc5MDkyOnYy", "diffSide": "RIGHT", "path": "brave/src/main/java/com/linecorp/armeria/server/brave/BraveService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTo0MDowOVrOFvPDIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTo0MDowOVrOFvPDIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3Mzk1Mw==", "bodyText": "request -> braveReq to avoid confusion?", "url": "https://github.com/line/armeria/pull/2536#discussion_r385073953", "createdAt": "2020-02-27T11:40:09Z", "author": {"login": "trustin"}, "path": "brave/src/main/java/com/linecorp/armeria/server/brave/BraveService.java", "diffHunk": "@@ -75,7 +76,8 @@ private BraveService(HttpService delegate, HttpTracing httpTracing) {\n \n     @Override\n     public HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) throws Exception {\n-        final Span span = handler.handleReceive(ServiceRequestContextAdapter.asHttpServerRequest(ctx));\n+        final HttpServerRequest request = ServiceRequestContextAdapter.asHttpServerRequest(ctx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NDc5MzczOnYy", "diffSide": "RIGHT", "path": "brave/src/main/java/com/linecorp/armeria/client/brave/BraveClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTo0MTowNFrOFvPExQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMTo0MTowNFrOFvPExQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA3NDM3Mw==", "bodyText": "nit: request -> braveReq and response -> braveRes to avoid confusion", "url": "https://github.com/line/armeria/pull/2536#discussion_r385074373", "createdAt": "2020-02-27T11:41:04Z", "author": {"login": "trustin"}, "path": "brave/src/main/java/com/linecorp/armeria/client/brave/BraveClient.java", "diffHunk": "@@ -159,9 +160,9 @@ public HttpResponse execute(ClientRequestContext ctx, HttpRequest req) throws Ex\n                 }\n             }\n \n-            final HttpClientResponse response = ClientRequestContextAdapter.asHttpClientResponse(log);\n+            final HttpClientResponse response = ClientRequestContextAdapter.asHttpClientResponse(log, request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62f20f696adce1ae0d2163aef14125588738efc3"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2697, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}