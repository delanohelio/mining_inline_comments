{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNzI2Njcy", "number": 2687, "title": "Fix a bug where two threads access MPSC queue", "bodyText": "Motivation:\nWe use MPSC queue in DefaultStreamMessage. If more than one thread consumes the MPSC queue,\nthe index of the queue is not correctly updated so a thread might spin forever in peek() as we've seen in #2683.\nThis bug was introduced from 0.98.4 #2539 by me. \ud83d\ude22\nModifications:\n\nFix to consume the MPSC queue only by the subscription thread.\n\nResult:\n\nYou no longer see the spinning thread in StreamMessage.", "createdAt": "2020-05-04T04:01:36Z", "url": "https://github.com/line/armeria/pull/2687", "merged": true, "mergeCommit": {"oid": "948f38c550a51f695647182160cec52bea550d6c"}, "closed": true, "closedAt": "2020-05-06T02:46:19Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcd3V_WgH2gAyNDEyNzI2NjcyOmExMGQ3MzNmNzAxZTI0Zjk4MTg2MWFiY2NjNmNiM2QwN2UxZTVmMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcefhWvAFqTQwNjI3NTA4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a10d733f701e24f981861abccc6cb3d07e1e5f35", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/a10d733f701e24f981861abccc6cb3d07e1e5f35", "committedDate": "2020-05-04T03:58:41Z", "message": "Fix a bug where two threads access MPSC queue\nMotivation:\nWe use MPSC queue in `DefaultStreamMessage`. If more than one thread consume the MPSC queue,\nthe index of the queue is not correctly updated so a thread might spin forever in `peek()` as we've seen in #2683.\nThis bug was introduced from 0.98.4 #2539 by me. :cry\n\nModifications:\n- Fix to consume the MPSC queue only by the subscription thread.\n\nResult:\n- You no longer see spinning thread in `StreamMessage`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NzAyMTI0", "url": "https://github.com/line/armeria/pull/2687#pullrequestreview-404702124", "createdAt": "2020-05-04T04:15:11Z", "commit": {"oid": "a10d733f701e24f981861abccc6cb3d07e1e5f35"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwNDoxNToxMVrOGPyXuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQwNDoxNToxMVrOGPyXuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTIwNzA5Ng==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!wroteAny && o instanceof AbstractStreamMessage.CloseEvent) {\n          \n          \n            \n                    if (!wroteAny && o instanceof CloseEvent) {", "url": "https://github.com/line/armeria/pull/2687#discussion_r419207096", "createdAt": "2020-05-04T04:15:11Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -174,25 +174,33 @@ private void abort0(Throwable cause) {\n             }\n         }\n         assert subscription != null;\n+        final SubscriptionImpl abortedSubscription = subscription;\n \n         if (setState(State.OPEN, State.CLEANUP)) {\n-            notifySubscriberOfCloseEvent(subscription, newCloseEvent(cause));\n+            notifySubscriberOfCloseEvent(abortedSubscription, newCloseEvent(cause));\n             return;\n         }\n \n         if (setState(State.CLOSED, State.CLEANUP)) {\n             // close() or close(cause) has been called before cancel() or abort() is called.\n-\n-            final Object o = queue.peek();\n-            // If there's no data pushed (i.e empty stream), notify subscriber with the event pushed by\n-            // close() or close(cause).\n-            if (!wroteAny && o instanceof CloseEvent) {\n-                notifySubscriberOfCloseEvent(subscription, (CloseEvent) queue.remove());\n-                return;\n+            if (abortedSubscription.needsDirectInvocation()) {\n+                abort0(cause, abortedSubscription);\n+            } else {\n+                abortedSubscription.executor().execute(() -> abort0(cause, abortedSubscription));\n             }\n+        }\n+    }\n \n-            notifySubscriberOfCloseEvent(subscription, newCloseEvent(cause));\n+    private void abort0(Throwable cause, SubscriptionImpl subscription) {\n+        final Object o = queue.peek();\n+        // If there's no data pushed (i.e empty stream), notify subscriber with the event pushed by\n+        // close() or close(cause).\n+        if (!wroteAny && o instanceof AbstractStreamMessage.CloseEvent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a10d733f701e24f981861abccc6cb3d07e1e5f35"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bad66086a92e9116ff80d460de8a0bc9f94c9d28", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/bad66086a92e9116ff80d460de8a0bc9f94c9d28", "committedDate": "2020-05-04T05:18:32Z", "message": "Address the comment by @ikhoon"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0OTE5OTE2", "url": "https://github.com/line/armeria/pull/2687#pullrequestreview-404919916", "createdAt": "2020-05-04T11:57:19Z", "commit": {"oid": "bad66086a92e9116ff80d460de8a0bc9f94c9d28"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2Mjc1MDg4", "url": "https://github.com/line/armeria/pull/2687#pullrequestreview-406275088", "createdAt": "2020-05-06T02:47:19Z", "commit": {"oid": "bad66086a92e9116ff80d460de8a0bc9f94c9d28"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 443, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}