{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MTE2NTc3", "number": 3099, "title": "Fix a bug where reactive-grpc fails to send stream responses", "bodyText": "Motivation:\nReactive gRPC starts to subscribe to upstream messages when onReady signal is delivered.\nhttps://github.com/salesforce/reactive-grpc/blob/ce3b3b20e8192c5e6b38b2ed596531242d9708c0/common/reactive-grpc-common/src/main/java/com/salesforce/reactivegrpc/common/AbstractSubscriberAndProducer.java#L91-L97\nUpstream gRPC-Java server invokes the signal - onReady when an HTTP headers is received.\nhttps://github.com/grpc/grpc-java/blob/9b73e2365da502a466b01544f102cd487e374428/core/src/main/java/io/grpc/internal/AbstractStream.java#L280-L287\nHowever, ArmeriaServerCall invokes listener.onReady() only when a response is written completely.\n\n  \n    \n      armeria/grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java\n    \n    \n        Lines 254 to 262\n      in\n      2bc23e6\n    \n    \n    \n    \n\n        \n          \n           res.whenConsumed().thenRun(() -> { \n        \n\n        \n          \n               if (pendingMessagesUpdater.decrementAndGet(this) == 0) { \n        \n\n        \n          \n                   if (blockingExecutor != null) { \n        \n\n        \n          \n                       blockingExecutor.execute(this::invokeOnReady); \n        \n\n        \n          \n                   } else { \n        \n\n        \n          \n                       invokeOnReady(); \n        \n\n        \n          \n                   } \n        \n\n        \n          \n               } \n        \n\n        \n          \n           }); \n        \n    \n  \n\n\nThis is a deadlock because:\n\nArmeriaServerCall waits a message and calls onReady().\nReactive gRPC waits onReady() signal and send a message.\n\nModifications:\n\nInvoke listener.onReady() as soon as it is set and onHalfClose() is invoked\n\nResult:\n\nArmeria gRPC server now invokes ServerCall.Listener.onReady() properly.\nYou no longer see UNKNOWN error code while sending stream messages with Reactive gRPC stub.\nFixes #3090", "createdAt": "2020-10-07T09:36:37Z", "url": "https://github.com/line/armeria/pull/3099", "merged": true, "mergeCommit": {"oid": "6e24e7817f8be94ab21ddba7879e9f84ca840229"}, "closed": true, "closedAt": "2020-10-16T07:20:25Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQI4J6AH2gAyNDk5MTE2NTc3OjVhZDhkZGFhMWFlMTBhODZmNDcwYmU5Y2Q5MGM1YTkyODAxYzNhNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSdhuEgFqTUwODM2OTkwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5ad8ddaa1ae10a86f470be9cd90c5a92801c3a42", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/5ad8ddaa1ae10a86f470be9cd90c5a92801c3a42", "committedDate": "2020-10-07T08:40:36Z", "message": "Fix a bug where reactive-grpc fails to send stream responses\n\nMotivation:\n\nReactive gRPC starts to subscribe upstream messages when `onReady` signal is delivered.\nhttps://github.com/salesforce/reactive-grpc/blob/master/common/reactive-grpc-common/src/main/java/com/salesforce/reactivegrpc/common/AbstractSubscriberAndProducer.java#L91-L97\nUpstream gRPC-Java server invokes `onReady` when an HTTP header is recevied.\nHowever, `ArmeriaServerCall` invokes `listener.onReady()` only when a response is written completely.\nhttps://github.com/line/armeria/blob/2bc23e60cea9f6adc1415c8d08a34baf2b90ce80/grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java#L254-L262\n\nThis is a deadlock because:\n- `ArmeriaServerCall` waits a message and calls `onReady()`.\n- Reactive gRPC waits `onReady()` signal and send a message.\n\nModifications:\n\n- Invoke `listener.onReady()` as soon as it is set and `onHalfClose()` is invoked\n\nResult:\n\n- Armeria gRPC server now invokes `ServerCall.Listener.onReady()` properly.\n- You no longer see `UNKNOWN` error code while sending stream messages with Reactive gRPC stub."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNzk3Njk2", "url": "https://github.com/line/armeria/pull/3099#pullrequestreview-503797696", "createdAt": "2020-10-07T11:53:57Z", "commit": {"oid": "5ad8ddaa1ae10a86f470be9cd90c5a92801c3a42"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNzk4Nzc1", "url": "https://github.com/line/armeria/pull/3099#pullrequestreview-503798775", "createdAt": "2020-10-07T11:55:25Z", "commit": {"oid": "5ad8ddaa1ae10a86f470be9cd90c5a92801c3a42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMTo1NToyNVrOHdvpaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxMTo1NToyNVrOHdvpaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk1MTQwMA==", "bodyText": "Is there any chance where onReady() is called multiple times? e.g. invokeHalfClosed() is called after setListener().", "url": "https://github.com/line/armeria/pull/3099#discussion_r500951400", "createdAt": "2020-10-07T11:55:25Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java", "diffHunk": "@@ -431,6 +431,7 @@ private void invokeHalfClose() {\n         try (SafeCloseable ignored = ctx.push()) {\n             assert listener != null;\n             listener.onHalfClose();\n+            listener.onReady();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ad8ddaa1ae10a86f470be9cd90c5a92801c3a42"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0ff6981f8f1a4dd07d9b660a7c0b354f14ab005b", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/0ff6981f8f1a4dd07d9b660a7c0b354f14ab005b", "committedDate": "2020-10-07T11:59:22Z", "message": "Add missed code"}, "afterCommit": {"oid": "f2b538e353b91bbf3d5ccc76bd08054670a73309", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/f2b538e353b91bbf3d5ccc76bd08054670a73309", "committedDate": "2020-10-07T12:24:59Z", "message": "Add missed code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f2b538e353b91bbf3d5ccc76bd08054670a73309", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/f2b538e353b91bbf3d5ccc76bd08054670a73309", "committedDate": "2020-10-07T12:24:59Z", "message": "Add missed code"}, "afterCommit": {"oid": "742281d48346ffa654d6cae173e3ec9088413d13", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/742281d48346ffa654d6cae173e3ec9088413d13", "committedDate": "2020-10-07T12:26:52Z", "message": "Add missed code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27fc00cea76937a1f2d8e7610f664622ecf8b91c", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/27fc00cea76937a1f2d8e7610f664622ecf8b91c", "committedDate": "2020-10-07T12:29:59Z", "message": "Add missed code"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "742281d48346ffa654d6cae173e3ec9088413d13", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/742281d48346ffa654d6cae173e3ec9088413d13", "committedDate": "2020-10-07T12:26:52Z", "message": "Add missed code"}, "afterCommit": {"oid": "27fc00cea76937a1f2d8e7610f664622ecf8b91c", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/27fc00cea76937a1f2d8e7610f664622ecf8b91c", "committedDate": "2020-10-07T12:29:59Z", "message": "Add missed code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29be1f39f1c185890466e0fdc9ba4efaad7d4943", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/29be1f39f1c185890466e0fdc9ba4efaad7d4943", "committedDate": "2020-10-07T16:02:28Z", "message": "Update comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MTIyNDg2", "url": "https://github.com/line/armeria/pull/3099#pullrequestreview-507122486", "createdAt": "2020-10-13T07:00:50Z", "commit": {"oid": "29be1f39f1c185890466e0fdc9ba4efaad7d4943"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MzY5OTA4", "url": "https://github.com/line/armeria/pull/3099#pullrequestreview-508369908", "createdAt": "2020-10-14T13:51:57Z", "commit": {"oid": "29be1f39f1c185890466e0fdc9ba4efaad7d4943"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4714, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}