{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MTMwMzMy", "number": 2706, "title": "Implement TTEXT_NAMED_ENUM serialization format", "bodyText": "Summary\nThis PR implements support to serialize TEnum as strings in TTextProtocol.\nDetails\n\nAdd TTEXT_NAMED_ENUM serialization format\nAdd a useNamedEnums flag to ThriftJacksonModule and pass it all the way down to TTextProtocol\n\nKeep default/existing constructors where applicable to avoid breaking changes (and some tests assume default constructors)\n\n\nAdd another instance to TTextProtocolFactory and ThriftProtocolFactories\nUpdate writeI32() in TTextProtocol to determine whether the field is an enum or not, and serialize it accordingly\n\nNotes\n\nI'm not too happy with the name writeEnumsAsString, perhaps you have a better suggestion\nPlease suggest a better way to allow passing the flag through ThriftProtocolFactories", "createdAt": "2020-05-13T05:41:36Z", "url": "https://github.com/line/armeria/pull/2706", "merged": true, "mergeCommit": {"oid": "664fa26dff11d023ce3a148c434a723b104702be"}, "closed": true, "closedAt": "2020-05-14T04:42:27Z", "author": {"login": "KarboniteKream"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgyFsiAH2gAyNDE3MTMwMzMyOjZmNThhZTk0ZmRlNDU3OTlkOWQ3NGIzY2RmM2M0ZGVmODA5ZGVlZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchEDgbAFqTQxMTQyMzg2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6f58ae94fde45799d9d74b3cdf3c4def809deeed", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/6f58ae94fde45799d9d74b3cdf3c4def809deeed", "committedDate": "2020-05-13T05:33:08Z", "message": "Allow TTEXT to serialize enums as strings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNjAzODMw", "url": "https://github.com/line/armeria/pull/2706#pullrequestreview-410603830", "createdAt": "2020-05-13T05:47:29Z", "commit": {"oid": "6f58ae94fde45799d9d74b3cdf3c4def809deeed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNTo0NzoyOVrOGUiQsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNTo0NzoyOVrOGUiQsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE4NjAzNA==", "bodyText": "This is to avoid an unnecessary call to getCurrentFieldClassIfIs(). I can remove it if you consider the impact insignificant", "url": "https://github.com/line/armeria/pull/2706#discussion_r424186034", "createdAt": "2020-05-13T05:47:29Z", "author": {"login": "KarboniteKream"}, "path": "thrift/src/main/java/com/linecorp/armeria/common/thrift/text/TTextProtocol.java", "diffHunk": "@@ -337,7 +344,25 @@ public void writeI16(short i16) throws TException {\n \n     @Override\n     public void writeI32(int i32) throws TException {\n-        writeNameOrValue(TypedParser.INTEGER, i32);\n+        if (!writeEnumsAsString) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f58ae94fde45799d9d74b3cdf3c4def809deeed"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNjE4ODY0", "url": "https://github.com/line/armeria/pull/2706#pullrequestreview-410618864", "createdAt": "2020-05-13T06:23:47Z", "commit": {"oid": "6f58ae94fde45799d9d74b3cdf3c4def809deeed"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNjoyMzo0N1rOGUjApg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwNjoyNDo0NVrOGUjCQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE5ODMxMA==", "bodyText": "This doesn't sound right to me because writeEnumsAsString is only useful for TEXT protocol. How about reverting this and let a user refer to TEXT_ENUM directly?", "url": "https://github.com/line/armeria/pull/2706#discussion_r424198310", "createdAt": "2020-05-13T06:23:47Z", "author": {"login": "trustin"}, "path": "thrift/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -70,14 +70,28 @@ public String toString() {\n     /**\n      * {@link TProtocolFactory} for the Thrift TText protocol.\n      */\n-    public static final TProtocolFactory TEXT = TTextProtocolFactory.get();\n+    public static final TProtocolFactory TEXT = TTextProtocolFactory.get(false);\n+\n+    /**\n+     * {@link TProtocolFactory} for the Thrift TText protocol that serializes enums as strings.\n+     */\n+    public static final TProtocolFactory TEXT_ENUM = TTextProtocolFactory.get(true);\n \n     /**\n      * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n      *\n      * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n      */\n     public static TProtocolFactory get(SerializationFormat serializationFormat) {\n+        return get(serializationFormat, false);\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n+     */\n+    public static TProtocolFactory get(SerializationFormat serializationFormat, boolean writeEnumsAsString) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f58ae94fde45799d9d74b3cdf3c4def809deeed"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDE5ODcyMw==", "bodyText": "How about keeping the old method as well for backward compatibility?", "url": "https://github.com/line/armeria/pull/2706#discussion_r424198723", "createdAt": "2020-05-13T06:24:45Z", "author": {"login": "trustin"}, "path": "thrift/src/main/java/com/linecorp/armeria/common/thrift/text/TTextProtocolFactory.java", "diffHunk": "@@ -26,20 +26,25 @@\n \n     private static final long serialVersionUID = -7323272088544581160L;\n \n-    private static final TTextProtocolFactory INSTANCE = new TTextProtocolFactory();\n+    private static final TTextProtocolFactory INSTANCE_ORDINAL = new TTextProtocolFactory(false);\n+    private static final TTextProtocolFactory INSTANCE_STRING = new TTextProtocolFactory(true);\n+\n+    private final boolean writeEnumsAsString;\n \n     /**\n      * Returns the singleton {@link TTextProtocolFactory} instance.\n      */\n-    public static TTextProtocolFactory get() {\n-        return INSTANCE;\n+    public static TTextProtocolFactory get(boolean writeEnumsAsString) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f58ae94fde45799d9d74b3cdf3c4def809deeed"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39eb181e95677f90d0991ca5949dc040890c224c", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/39eb181e95677f90d0991ca5949dc040890c224c", "committedDate": "2020-05-13T08:27:56Z", "message": "Address comments by @trustin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b291c120dff2cacff6d731b9aaccf51c52bff563", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/b291c120dff2cacff6d731b9aaccf51c52bff563", "committedDate": "2020-05-13T09:29:37Z", "message": "Add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4accc394b0ec1df421c3ead158bcfbbef28cf7a", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/d4accc394b0ec1df421c3ead158bcfbbef28cf7a", "committedDate": "2020-05-13T12:02:14Z", "message": "Simplify the test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9798deabe337307ed1615a0efc7e42468efe113a", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/9798deabe337307ed1615a0efc7e42468efe113a", "committedDate": "2020-05-13T12:08:45Z", "message": "Keep old constructor of TTextProtocol"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a8eb5f83c52b0a9dda2e39244b444a7ad1aaf58", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/8a8eb5f83c52b0a9dda2e39244b444a7ad1aaf58", "committedDate": "2020-05-14T01:45:45Z", "message": "Update ThriftJacksonModule.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d0407b101e7703373fa8b89f347bc315501b25a", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/0d0407b101e7703373fa8b89f347bc315501b25a", "committedDate": "2020-05-14T01:47:33Z", "message": "Update TTextProtocol.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDEyMDEw", "url": "https://github.com/line/armeria/pull/2706#pullrequestreview-411412010", "createdAt": "2020-05-14T01:50:28Z", "commit": {"oid": "0d0407b101e7703373fa8b89f347bc315501b25a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDE5NDk0", "url": "https://github.com/line/armeria/pull/2706#pullrequestreview-411419494", "createdAt": "2020-05-14T02:14:41Z", "commit": {"oid": "0d0407b101e7703373fa8b89f347bc315501b25a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDIwMDkx", "url": "https://github.com/line/armeria/pull/2706#pullrequestreview-411420091", "createdAt": "2020-05-14T02:16:40Z", "commit": {"oid": "0d0407b101e7703373fa8b89f347bc315501b25a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMjoxNjo0MFrOGVJvUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMjoxNjo0MFrOGVJvUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgzMjg1MQ==", "bodyText": "This is a breaking change. How about reviving the original get() method?\nget() {\n   return get(false)\n}", "url": "https://github.com/line/armeria/pull/2706#discussion_r424832851", "createdAt": "2020-05-14T02:16:40Z", "author": {"login": "ikhoon"}, "path": "thrift/src/main/java/com/linecorp/armeria/common/thrift/text/TTextProtocolFactory.java", "diffHunk": "@@ -26,24 +26,36 @@\n \n     private static final long serialVersionUID = -7323272088544581160L;\n \n-    private static final TTextProtocolFactory INSTANCE = new TTextProtocolFactory();\n+    private static final TTextProtocolFactory INSTANCE = new TTextProtocolFactory(false);\n+    private static final TTextProtocolFactory INSTANCE_NAMED_ENUMS = new TTextProtocolFactory(true);\n+\n+    private final boolean useNamedEnums;\n \n     /**\n      * Returns the singleton {@link TTextProtocolFactory} instance.\n      */\n-    public static TTextProtocolFactory get() {\n-        return INSTANCE;\n+    public static TTextProtocolFactory get(boolean useNamedEnums) {\n+        return useNamedEnums ? INSTANCE_NAMED_ENUMS : INSTANCE;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d0407b101e7703373fa8b89f347bc315501b25a"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78b0e7806648178a05e1a86d310ec74913df21b4", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/78b0e7806648178a05e1a86d310ec74913df21b4", "committedDate": "2020-05-14T02:24:03Z", "message": "Restore the original get() method"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f327693447552809afb23b0aeb644c5123eb9380", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/f327693447552809afb23b0aeb644c5123eb9380", "committedDate": "2020-05-14T02:22:23Z", "message": "Restore the original get() method"}, "afterCommit": {"oid": "78b0e7806648178a05e1a86d310ec74913df21b4", "author": {"user": {"login": "KarboniteKream", "name": "Klemen Ko\u0161ir"}}, "url": "https://github.com/line/armeria/commit/78b0e7806648178a05e1a86d310ec74913df21b4", "committedDate": "2020-05-14T02:24:03Z", "message": "Restore the original get() method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDIzODYx", "url": "https://github.com/line/armeria/pull/2706#pullrequestreview-411423861", "createdAt": "2020-05-14T02:29:02Z", "commit": {"oid": "78b0e7806648178a05e1a86d310ec74913df21b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 476, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}