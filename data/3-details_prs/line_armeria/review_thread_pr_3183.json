{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMTk3ODkw", "number": 3183, "reviewThreads": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNzoyMTozM1rOE54Tcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0OTowOFrOE9FcRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MTI2NzcwOnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNzoyMTozM1rOH0nNGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNzoyNTo0OFrOH0nUGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzMDMzMQ==", "bodyText": "How about using SPI instead of this, like others?", "url": "https://github.com/line/armeria/pull/3183#discussion_r524930331", "createdAt": "2020-11-17T07:21:33Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -77,59 +83,53 @@ public String toString() {\n      */\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Users can add new entries at runtime using\n+     * {@link #registerThriftProtocolFactory(SerializationFormat, TProtocolFactory)}.\n+     */\n+    private static final ConcurrentMap<SerializationFormat, TProtocolFactory> knownProtocolFactories =\n+            new ConcurrentHashMap<>();\n+\n+    /**\n+     * Registers a new Thrift protocol. This operation cannot be undone.\n+     *\n+     * @param serializationFormat the handle for this new protocol\n+     * @param protocolFactory a factory to instantiate this protocol\n+     */\n+    public static void registerThriftProtocolFactory(\n+            SerializationFormat serializationFormat, TProtocolFactory protocolFactory) {\n+        knownProtocolFactories.put(serializationFormat, protocolFactory);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2215112a4ef1562e3a2393608dfa61a840758ec3"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzMjEyMg==", "bodyText": "e.g.\npublic interface ThriftProtocolFactoryProvider {\n    ...\n}\n\npublic interface ThriftProtocolFactory {\n    SerializationFormat serializationFormat();\n    TProtocolFactory protocolFactory(); // Or delegate all methods internally, because protocolFactory.protocolFactory() doesn't look nice.\n}", "url": "https://github.com/line/armeria/pull/3183#discussion_r524932122", "createdAt": "2020-11-17T07:25:48Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -77,59 +83,53 @@ public String toString() {\n      */\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Users can add new entries at runtime using\n+     * {@link #registerThriftProtocolFactory(SerializationFormat, TProtocolFactory)}.\n+     */\n+    private static final ConcurrentMap<SerializationFormat, TProtocolFactory> knownProtocolFactories =\n+            new ConcurrentHashMap<>();\n+\n+    /**\n+     * Registers a new Thrift protocol. This operation cannot be undone.\n+     *\n+     * @param serializationFormat the handle for this new protocol\n+     * @param protocolFactory a factory to instantiate this protocol\n+     */\n+    public static void registerThriftProtocolFactory(\n+            SerializationFormat serializationFormat, TProtocolFactory protocolFactory) {\n+        knownProtocolFactories.put(serializationFormat, protocolFactory);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzMDMzMQ=="}, "originalCommit": {"oid": "2215112a4ef1562e3a2393608dfa61a840758ec3"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MTI3NTAyOnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNzoyNDoyNlrOH0nRng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzozOToxM1rOH2QJ7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzMTQ4Ng==", "bodyText": "How about values() that returns Set<ThriftProtocolFactory>? ThriftProtocolFactory could provide some common properties including SerializationFormat and TProtocolFactory (or just methods that delegates to TProtocolFactory).", "url": "https://github.com/line/armeria/pull/3183#discussion_r524931486", "createdAt": "2020-11-17T07:24:26Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -77,59 +83,53 @@ public String toString() {\n      */\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Users can add new entries at runtime using\n+     * {@link #registerThriftProtocolFactory(SerializationFormat, TProtocolFactory)}.\n+     */\n+    private static final ConcurrentMap<SerializationFormat, TProtocolFactory> knownProtocolFactories =\n+            new ConcurrentHashMap<>();\n+\n+    /**\n+     * Registers a new Thrift protocol. This operation cannot be undone.\n+     *\n+     * @param serializationFormat the handle for this new protocol\n+     * @param protocolFactory a factory to instantiate this protocol\n+     */\n+    public static void registerThriftProtocolFactory(\n+            SerializationFormat serializationFormat, TProtocolFactory protocolFactory) {\n+        knownProtocolFactories.put(serializationFormat, protocolFactory);\n+    }\n+\n+    static {\n+        registerThriftProtocolFactory(ThriftSerializationFormats.BINARY, BINARY);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.COMPACT, COMPACT);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.JSON, JSON);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.TEXT, TEXT);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.TEXT_NAMED_ENUM, TEXT_NAMED_ENUM);\n+    }\n+\n     /**\n      * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n      *\n-     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n      */\n     public static TProtocolFactory get(SerializationFormat serializationFormat) {\n         requireNonNull(serializationFormat, \"serializationFormat\");\n-\n-        if (serializationFormat == ThriftSerializationFormats.BINARY) {\n-            return BINARY;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.COMPACT) {\n-            return COMPACT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.JSON) {\n-            return JSON;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT) {\n-            return TEXT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT_NAMED_ENUM) {\n-            return TEXT_NAMED_ENUM;\n-        }\n-\n-        throw new IllegalArgumentException(\"non-Thrift serializationFormat: \" + serializationFormat);\n+        return Optional.ofNullable(knownProtocolFactories.get(serializationFormat))\n+                .orElseThrow(() -> new IllegalArgumentException(\n+                        \"Unsupported Thrift serializationFormat: \" + serializationFormat));\n     }\n \n     /**\n-     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory}.\n+     * Retrieves all registered Thrift serialization formats.\n      *\n-     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} is not known by this class\n+     * @return an unmodifiable view of the registered Thrift serialization formats set.\n      */\n-    public static SerializationFormat toSerializationFormat(TProtocolFactory protoFactory) {\n-        requireNonNull(protoFactory, \"protoFactory\");\n-\n-        if (protoFactory instanceof TBinaryProtocol.Factory) {\n-            return ThriftSerializationFormats.BINARY;\n-        } else if (protoFactory instanceof TCompactProtocol.Factory) {\n-            return ThriftSerializationFormats.COMPACT;\n-        } else if (protoFactory instanceof TJSONProtocol.Factory) {\n-            return ThriftSerializationFormats.JSON;\n-        } else if (protoFactory instanceof TTextProtocolFactory) {\n-            final TTextProtocolFactory factory = (TTextProtocolFactory) protoFactory;\n-            return factory.usesNamedEnums() ? ThriftSerializationFormats.TEXT_NAMED_ENUM\n-                                            : ThriftSerializationFormats.TEXT;\n-        } else {\n-            throw new IllegalArgumentException(\n-                    \"unsupported TProtocolFactory: \" + protoFactory.getClass().getName());\n-        }\n+    public static Set<SerializationFormat> getThriftSerializationFormats() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2215112a4ef1562e3a2393608dfa61a840758ec3"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2NDgyMw==", "bodyText": "I don't see any use for it at the moment", "url": "https://github.com/line/armeria/pull/3183#discussion_r524964823", "createdAt": "2020-11-17T08:24:05Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -77,59 +83,53 @@ public String toString() {\n      */\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Users can add new entries at runtime using\n+     * {@link #registerThriftProtocolFactory(SerializationFormat, TProtocolFactory)}.\n+     */\n+    private static final ConcurrentMap<SerializationFormat, TProtocolFactory> knownProtocolFactories =\n+            new ConcurrentHashMap<>();\n+\n+    /**\n+     * Registers a new Thrift protocol. This operation cannot be undone.\n+     *\n+     * @param serializationFormat the handle for this new protocol\n+     * @param protocolFactory a factory to instantiate this protocol\n+     */\n+    public static void registerThriftProtocolFactory(\n+            SerializationFormat serializationFormat, TProtocolFactory protocolFactory) {\n+        knownProtocolFactories.put(serializationFormat, protocolFactory);\n+    }\n+\n+    static {\n+        registerThriftProtocolFactory(ThriftSerializationFormats.BINARY, BINARY);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.COMPACT, COMPACT);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.JSON, JSON);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.TEXT, TEXT);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.TEXT_NAMED_ENUM, TEXT_NAMED_ENUM);\n+    }\n+\n     /**\n      * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n      *\n-     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n      */\n     public static TProtocolFactory get(SerializationFormat serializationFormat) {\n         requireNonNull(serializationFormat, \"serializationFormat\");\n-\n-        if (serializationFormat == ThriftSerializationFormats.BINARY) {\n-            return BINARY;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.COMPACT) {\n-            return COMPACT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.JSON) {\n-            return JSON;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT) {\n-            return TEXT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT_NAMED_ENUM) {\n-            return TEXT_NAMED_ENUM;\n-        }\n-\n-        throw new IllegalArgumentException(\"non-Thrift serializationFormat: \" + serializationFormat);\n+        return Optional.ofNullable(knownProtocolFactories.get(serializationFormat))\n+                .orElseThrow(() -> new IllegalArgumentException(\n+                        \"Unsupported Thrift serializationFormat: \" + serializationFormat));\n     }\n \n     /**\n-     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory}.\n+     * Retrieves all registered Thrift serialization formats.\n      *\n-     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} is not known by this class\n+     * @return an unmodifiable view of the registered Thrift serialization formats set.\n      */\n-    public static SerializationFormat toSerializationFormat(TProtocolFactory protoFactory) {\n-        requireNonNull(protoFactory, \"protoFactory\");\n-\n-        if (protoFactory instanceof TBinaryProtocol.Factory) {\n-            return ThriftSerializationFormats.BINARY;\n-        } else if (protoFactory instanceof TCompactProtocol.Factory) {\n-            return ThriftSerializationFormats.COMPACT;\n-        } else if (protoFactory instanceof TJSONProtocol.Factory) {\n-            return ThriftSerializationFormats.JSON;\n-        } else if (protoFactory instanceof TTextProtocolFactory) {\n-            final TTextProtocolFactory factory = (TTextProtocolFactory) protoFactory;\n-            return factory.usesNamedEnums() ? ThriftSerializationFormats.TEXT_NAMED_ENUM\n-                                            : ThriftSerializationFormats.TEXT;\n-        } else {\n-            throw new IllegalArgumentException(\n-                    \"unsupported TProtocolFactory: \" + protoFactory.getClass().getName());\n-        }\n+    public static Set<SerializationFormat> getThriftSerializationFormats() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzMTQ4Ng=="}, "originalCommit": {"oid": "2215112a4ef1562e3a2393608dfa61a840758ec3"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0OTgzNw==", "bodyText": "OK. Then how about making ThriftSerializationFormats.values() return what this method returns, and then hiding this method from the public API?", "url": "https://github.com/line/armeria/pull/3183#discussion_r526649837", "createdAt": "2020-11-19T07:39:13Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -77,59 +83,53 @@ public String toString() {\n      */\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Users can add new entries at runtime using\n+     * {@link #registerThriftProtocolFactory(SerializationFormat, TProtocolFactory)}.\n+     */\n+    private static final ConcurrentMap<SerializationFormat, TProtocolFactory> knownProtocolFactories =\n+            new ConcurrentHashMap<>();\n+\n+    /**\n+     * Registers a new Thrift protocol. This operation cannot be undone.\n+     *\n+     * @param serializationFormat the handle for this new protocol\n+     * @param protocolFactory a factory to instantiate this protocol\n+     */\n+    public static void registerThriftProtocolFactory(\n+            SerializationFormat serializationFormat, TProtocolFactory protocolFactory) {\n+        knownProtocolFactories.put(serializationFormat, protocolFactory);\n+    }\n+\n+    static {\n+        registerThriftProtocolFactory(ThriftSerializationFormats.BINARY, BINARY);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.COMPACT, COMPACT);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.JSON, JSON);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.TEXT, TEXT);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.TEXT_NAMED_ENUM, TEXT_NAMED_ENUM);\n+    }\n+\n     /**\n      * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n      *\n-     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n      */\n     public static TProtocolFactory get(SerializationFormat serializationFormat) {\n         requireNonNull(serializationFormat, \"serializationFormat\");\n-\n-        if (serializationFormat == ThriftSerializationFormats.BINARY) {\n-            return BINARY;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.COMPACT) {\n-            return COMPACT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.JSON) {\n-            return JSON;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT) {\n-            return TEXT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT_NAMED_ENUM) {\n-            return TEXT_NAMED_ENUM;\n-        }\n-\n-        throw new IllegalArgumentException(\"non-Thrift serializationFormat: \" + serializationFormat);\n+        return Optional.ofNullable(knownProtocolFactories.get(serializationFormat))\n+                .orElseThrow(() -> new IllegalArgumentException(\n+                        \"Unsupported Thrift serializationFormat: \" + serializationFormat));\n     }\n \n     /**\n-     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory}.\n+     * Retrieves all registered Thrift serialization formats.\n      *\n-     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} is not known by this class\n+     * @return an unmodifiable view of the registered Thrift serialization formats set.\n      */\n-    public static SerializationFormat toSerializationFormat(TProtocolFactory protoFactory) {\n-        requireNonNull(protoFactory, \"protoFactory\");\n-\n-        if (protoFactory instanceof TBinaryProtocol.Factory) {\n-            return ThriftSerializationFormats.BINARY;\n-        } else if (protoFactory instanceof TCompactProtocol.Factory) {\n-            return ThriftSerializationFormats.COMPACT;\n-        } else if (protoFactory instanceof TJSONProtocol.Factory) {\n-            return ThriftSerializationFormats.JSON;\n-        } else if (protoFactory instanceof TTextProtocolFactory) {\n-            final TTextProtocolFactory factory = (TTextProtocolFactory) protoFactory;\n-            return factory.usesNamedEnums() ? ThriftSerializationFormats.TEXT_NAMED_ENUM\n-                                            : ThriftSerializationFormats.TEXT;\n-        } else {\n-            throw new IllegalArgumentException(\n-                    \"unsupported TProtocolFactory: \" + protoFactory.getClass().getName());\n-        }\n+    public static Set<SerializationFormat> getThriftSerializationFormats() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzMTQ4Ng=="}, "originalCommit": {"oid": "2215112a4ef1562e3a2393608dfa61a840758ec3"}, "originalPosition": 104}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjA3Mjk2OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzozNDoxNVrOH2QA-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzozNDoxNVrOH2QA-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0NzU0NQ==", "bodyText": "How about renaming ThriftSerializationFormat to Entry, like we did in SerializationFormatProvider?", "url": "https://github.com/line/armeria/pull/3183#discussion_r526647545", "createdAt": "2020-11-19T07:34:15Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+@FunctionalInterface\n+public interface ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    final class ThriftSerializationFormat {\n+        private final SerializationFormat serializationFormat;\n+        private final TProtocolFactory tProtocolFactory;\n+\n+        public ThriftSerializationFormat(SerializationFormat serializationFormat,\n+                                         TProtocolFactory tProtocolFactory) {\n+            this.serializationFormat = requireNonNull(serializationFormat, \"serializationFormat\");\n+            this.tProtocolFactory = requireNonNull(tProtocolFactory, \"tProtocolFactory\");\n+        }\n+\n+        public SerializationFormat getSerializationFormat() {\n+            return serializationFormat;\n+        }\n+\n+        public TProtocolFactory getTProtocolFactory() {\n+            return tProtocolFactory;\n+        }\n+    }\n+\n+    /**\n+     * Accessed configured {@link ThriftSerializationFormat}s for this SPI provider.\n+     *\n+     * @return an immutable view\n+     */\n+    Set<ThriftSerializationFormat> thriftSerializationFormats();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjA3OTU5OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzozNjoyMFrOH2QExg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQxMzo0MjoxMlrOH3uo3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0ODUxOA==", "bodyText": "How about just modifying this class class to make values() return all discovered Thrift serialization formats?", "url": "https://github.com/line/armeria/pull/3183#discussion_r526648518", "createdAt": "2020-11-19T07:36:20Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -15,16 +15,10 @@\n  */\n package com.linecorp.armeria.common.thrift;\n \n-import static java.util.Objects.requireNonNull;\n-\n-import java.util.Set;\n-\n-import com.google.common.collect.ImmutableSet;\n-\n import com.linecorp.armeria.common.SerializationFormat;\n \n /**\n- * Thrift-related {@link SerializationFormat} instances.\n+ * Out-of-the box supported Thrift-related {@link SerializationFormat} instances.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODE5Nzg1NA==", "bodyText": "Understood. It makes more sense.", "url": "https://github.com/line/armeria/pull/3183#discussion_r528197854", "createdAt": "2020-11-21T13:42:12Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -15,16 +15,10 @@\n  */\n package com.linecorp.armeria.common.thrift;\n \n-import static java.util.Objects.requireNonNull;\n-\n-import java.util.Set;\n-\n-import com.google.common.collect.ImmutableSet;\n-\n import com.linecorp.armeria.common.SerializationFormat;\n \n /**\n- * Thrift-related {@link SerializationFormat} instances.\n+ * Out-of-the box supported Thrift-related {@link SerializationFormat} instances.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0ODUxOA=="}, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjA5NDAyOnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzo0MDo1MVrOH2QNPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo1MTo1MlrOH5lTkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY1MDY4NA==", "bodyText": "This doesn't need to be visible to other classes than subclasses. How about making this class protected and ThriftProtocolFactoryProvider a public abstract class, like we did in SerializationFormatProvider?", "url": "https://github.com/line/armeria/pull/3183#discussion_r526650684", "createdAt": "2020-11-19T07:40:51Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+@FunctionalInterface\n+public interface ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    final class ThriftSerializationFormat {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODE5NTc2MA==", "bodyText": "Subclasses and classes in same package (like SerializationFormat uses SerializationFormatProvider.Entry). ;)\nI used interface to make the test class inherit multiple providers.\nHowever, let me change to follow the existing pattern.", "url": "https://github.com/line/armeria/pull/3183#discussion_r528195760", "createdAt": "2020-11-21T13:20:44Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+@FunctionalInterface\n+public interface ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    final class ThriftSerializationFormat {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY1MDY4NA=="}, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE0MjA5Ng==", "bodyText": "Thanks!", "url": "https://github.com/line/armeria/pull/3183#discussion_r530142096", "createdAt": "2020-11-25T06:51:52Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+@FunctionalInterface\n+public interface ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    final class ThriftSerializationFormat {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY1MDY4NA=="}, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMjA5OTQyOnYy", "diffSide": "LEFT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzo0MjozMlrOH2QQRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMVQxNDoyNToyNlrOH3u49Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY1MTQ2Mg==", "bodyText": "Could we revive these methods? values() could pull the values from getThriftSerializationFormats() you added.", "url": "https://github.com/line/armeria/pull/3183#discussion_r526651462", "createdAt": "2020-11-19T07:42:32Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,22 +49,5 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n-\n-    /**\n-     * Returns the set of all known Thrift serialization formats.\n-     */\n-    public static Set<SerializationFormat> values() {\n-        return THRIFT_FORMATS;\n-    }\n-\n-    /**\n-     * Returns whether the specified {@link SerializationFormat} is Thrift.\n-     */\n-    public static boolean isThrift(SerializationFormat format) {\n-        return values().contains(requireNonNull(format, \"format\"));\n-    }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODE5Njg5NA==", "bodyText": "What you suggest is to have the link SerializationFormat -> TProtocolFactory in this class rather than ThriftProtocolFactories right? We certainly don't need to access it from both", "url": "https://github.com/line/armeria/pull/3183#discussion_r528196894", "createdAt": "2020-11-21T13:32:22Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,22 +49,5 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n-\n-    /**\n-     * Returns the set of all known Thrift serialization formats.\n-     */\n-    public static Set<SerializationFormat> values() {\n-        return THRIFT_FORMATS;\n-    }\n-\n-    /**\n-     * Returns whether the specified {@link SerializationFormat} is Thrift.\n-     */\n-    public static boolean isThrift(SerializationFormat format) {\n-        return values().contains(requireNonNull(format, \"format\"));\n-    }\n-", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY1MTQ2Mg=="}, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODIwMTk3Mw==", "bodyText": "Understood your intent and fixed. \ud83d\udc4d", "url": "https://github.com/line/armeria/pull/3183#discussion_r528201973", "createdAt": "2020-11-21T14:25:26Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,22 +49,5 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n-\n-    /**\n-     * Returns the set of all known Thrift serialization formats.\n-     */\n-    public static Set<SerializationFormat> values() {\n-        return THRIFT_FORMATS;\n-    }\n-\n-    /**\n-     * Returns whether the specified {@link SerializationFormat} is Thrift.\n-     */\n-    public static boolean isThrift(SerializationFormat format) {\n-        return values().contains(requireNonNull(format, \"format\"));\n-    }\n-", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY1MTQ2Mg=="}, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxODQ4OTkzOnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/DefaultThriftProtocolFactoryProvider.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjowMDowOVrOH4nZeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMjowNzowNFrOH5gXCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyNzgwMQ==", "bodyText": "How about making this static final field?", "url": "https://github.com/line/armeria/pull/3183#discussion_r529127801", "createdAt": "2020-11-24T02:00:09Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/DefaultThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import java.util.Set;\n+\n+import com.google.common.collect.ImmutableSet;\n+\n+/**\n+ * Default registered {@link ThriftProtocolFactoryProvider}.\n+ * It is not overridable but you may provide and register another implementation.\n+ */\n+public final class DefaultThriftProtocolFactoryProvider extends ThriftProtocolFactoryProvider {\n+    @Override\n+    protected Set<Entry> entries() {\n+        return ImmutableSet.of(\n+                new Entry(\n+                        ThriftSerializationFormats.BINARY, ThriftProtocolFactories.BINARY),\n+                new Entry(\n+                        ThriftSerializationFormats.COMPACT, ThriftProtocolFactories.COMPACT),\n+                new Entry(\n+                        ThriftSerializationFormats.JSON, ThriftProtocolFactories.JSON),\n+                new Entry(\n+                        ThriftSerializationFormats.TEXT, ThriftProtocolFactories.TEXT),\n+                new Entry(\n+                        ThriftSerializationFormats.TEXT_NAMED_ENUM, ThriftProtocolFactories.TEXT_NAMED_ENUM)\n+        );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwMzQyMg==", "bodyText": "as I understand it, it's read only once in the JVM lifecycle, so it doesn't make sense to cache it.", "url": "https://github.com/line/armeria/pull/3183#discussion_r529203422", "createdAt": "2020-11-24T04:58:46Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/DefaultThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import java.util.Set;\n+\n+import com.google.common.collect.ImmutableSet;\n+\n+/**\n+ * Default registered {@link ThriftProtocolFactoryProvider}.\n+ * It is not overridable but you may provide and register another implementation.\n+ */\n+public final class DefaultThriftProtocolFactoryProvider extends ThriftProtocolFactoryProvider {\n+    @Override\n+    protected Set<Entry> entries() {\n+        return ImmutableSet.of(\n+                new Entry(\n+                        ThriftSerializationFormats.BINARY, ThriftProtocolFactories.BINARY),\n+                new Entry(\n+                        ThriftSerializationFormats.COMPACT, ThriftProtocolFactories.COMPACT),\n+                new Entry(\n+                        ThriftSerializationFormats.JSON, ThriftProtocolFactories.JSON),\n+                new Entry(\n+                        ThriftSerializationFormats.TEXT, ThriftProtocolFactories.TEXT),\n+                new Entry(\n+                        ThriftSerializationFormats.TEXT_NAMED_ENUM, ThriftProtocolFactories.TEXT_NAMED_ENUM)\n+        );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyNzgwMQ=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQ0NzkxOQ==", "bodyText": "I thought this method could be called by users because this is a public API. Anyway, it makes sense to not cache.", "url": "https://github.com/line/armeria/pull/3183#discussion_r529447919", "createdAt": "2020-11-24T10:52:21Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/DefaultThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import java.util.Set;\n+\n+import com.google.common.collect.ImmutableSet;\n+\n+/**\n+ * Default registered {@link ThriftProtocolFactoryProvider}.\n+ * It is not overridable but you may provide and register another implementation.\n+ */\n+public final class DefaultThriftProtocolFactoryProvider extends ThriftProtocolFactoryProvider {\n+    @Override\n+    protected Set<Entry> entries() {\n+        return ImmutableSet.of(\n+                new Entry(\n+                        ThriftSerializationFormats.BINARY, ThriftProtocolFactories.BINARY),\n+                new Entry(\n+                        ThriftSerializationFormats.COMPACT, ThriftProtocolFactories.COMPACT),\n+                new Entry(\n+                        ThriftSerializationFormats.JSON, ThriftProtocolFactories.JSON),\n+                new Entry(\n+                        ThriftSerializationFormats.TEXT, ThriftProtocolFactories.TEXT),\n+                new Entry(\n+                        ThriftSerializationFormats.TEXT_NAMED_ENUM, ThriftProtocolFactories.TEXT_NAMED_ENUM)\n+        );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyNzgwMQ=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU2NzUzMA==", "bodyText": "This is a protected method (not public API)", "url": "https://github.com/line/armeria/pull/3183#discussion_r529567530", "createdAt": "2020-11-24T14:02:40Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/DefaultThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import java.util.Set;\n+\n+import com.google.common.collect.ImmutableSet;\n+\n+/**\n+ * Default registered {@link ThriftProtocolFactoryProvider}.\n+ * It is not overridable but you may provide and register another implementation.\n+ */\n+public final class DefaultThriftProtocolFactoryProvider extends ThriftProtocolFactoryProvider {\n+    @Override\n+    protected Set<Entry> entries() {\n+        return ImmutableSet.of(\n+                new Entry(\n+                        ThriftSerializationFormats.BINARY, ThriftProtocolFactories.BINARY),\n+                new Entry(\n+                        ThriftSerializationFormats.COMPACT, ThriftProtocolFactories.COMPACT),\n+                new Entry(\n+                        ThriftSerializationFormats.JSON, ThriftProtocolFactories.JSON),\n+                new Entry(\n+                        ThriftSerializationFormats.TEXT, ThriftProtocolFactories.TEXT),\n+                new Entry(\n+                        ThriftSerializationFormats.TEXT_NAMED_ENUM, ThriftProtocolFactories.TEXT_NAMED_ENUM)\n+        );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyNzgwMQ=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2MTA2Nw==", "bodyText": "Oops... I misused the term. \ud83d\ude05 What I meant was a user-accessible API.", "url": "https://github.com/line/armeria/pull/3183#discussion_r530061067", "createdAt": "2020-11-25T02:07:04Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/DefaultThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import java.util.Set;\n+\n+import com.google.common.collect.ImmutableSet;\n+\n+/**\n+ * Default registered {@link ThriftProtocolFactoryProvider}.\n+ * It is not overridable but you may provide and register another implementation.\n+ */\n+public final class DefaultThriftProtocolFactoryProvider extends ThriftProtocolFactoryProvider {\n+    @Override\n+    protected Set<Entry> entries() {\n+        return ImmutableSet.of(\n+                new Entry(\n+                        ThriftSerializationFormats.BINARY, ThriftProtocolFactories.BINARY),\n+                new Entry(\n+                        ThriftSerializationFormats.COMPACT, ThriftProtocolFactories.COMPACT),\n+                new Entry(\n+                        ThriftSerializationFormats.JSON, ThriftProtocolFactories.JSON),\n+                new Entry(\n+                        ThriftSerializationFormats.TEXT, ThriftProtocolFactories.TEXT),\n+                new Entry(\n+                        ThriftSerializationFormats.TEXT_NAMED_ENUM, ThriftProtocolFactories.TEXT_NAMED_ENUM)\n+        );", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyNzgwMQ=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxODQ5MzY0OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjowMDo0OFrOH4ncCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwNjoyOToyOFrOH4trFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyODQ1OA==", "bodyText": "Some nits \ud83d\ude09:\n\nJavadoc?\nRemove get prefix?\nAdd toString()?", "url": "https://github.com/line/armeria/pull/3183#discussion_r529128458", "createdAt": "2020-11-24T02:00:48Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        private final SerializationFormat serializationFormat;\n+        private final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {\n+            this.serializationFormat = requireNonNull(serializationFormat, \"serializationFormat\");\n+            this.tProtocolFactory = requireNonNull(tProtocolFactory, \"tProtocolFactory\");\n+        }\n+\n+        public SerializationFormat getSerializationFormat() {\n+            return serializationFormat;\n+        }\n+\n+        public TProtocolFactory getTProtocolFactory() {\n+            return tProtocolFactory;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwNDAwNA==", "bodyText": "Javadoc seems not required for getters, but I guess we can add it\n\ud83d\udc4d Let me follow the convention in this project then\nokay", "url": "https://github.com/line/armeria/pull/3183#discussion_r529204004", "createdAt": "2020-11-24T05:00:40Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        private final SerializationFormat serializationFormat;\n+        private final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {\n+            this.serializationFormat = requireNonNull(serializationFormat, \"serializationFormat\");\n+            this.tProtocolFactory = requireNonNull(tProtocolFactory, \"tProtocolFactory\");\n+        }\n+\n+        public SerializationFormat getSerializationFormat() {\n+            return serializationFormat;\n+        }\n+\n+        public TProtocolFactory getTProtocolFactory() {\n+            return tProtocolFactory;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyODQ1OA=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIwNzY0MA==", "bodyText": "made the fields package-protected like in the existing example (SerializationFormatProvider)", "url": "https://github.com/line/armeria/pull/3183#discussion_r529207640", "createdAt": "2020-11-24T05:14:05Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        private final SerializationFormat serializationFormat;\n+        private final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {\n+            this.serializationFormat = requireNonNull(serializationFormat, \"serializationFormat\");\n+            this.tProtocolFactory = requireNonNull(tProtocolFactory, \"tProtocolFactory\");\n+        }\n+\n+        public SerializationFormat getSerializationFormat() {\n+            return serializationFormat;\n+        }\n+\n+        public TProtocolFactory getTProtocolFactory() {\n+            return tProtocolFactory;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyODQ1OA=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIzMDYxNQ==", "bodyText": "made the fields package-protected like in the existing example (SerializationFormatProvider)\n\nThat sounds good.", "url": "https://github.com/line/armeria/pull/3183#discussion_r529230615", "createdAt": "2020-11-24T06:29:28Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        private final SerializationFormat serializationFormat;\n+        private final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {\n+            this.serializationFormat = requireNonNull(serializationFormat, \"serializationFormat\");\n+            this.tProtocolFactory = requireNonNull(tProtocolFactory, \"tProtocolFactory\");\n+        }\n+\n+        public SerializationFormat getSerializationFormat() {\n+            return serializationFormat;\n+        }\n+\n+        public TProtocolFactory getTProtocolFactory() {\n+            return tProtocolFactory;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyODQ1OA=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxODUxMTE4OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjowNDoxMVrOH4noWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwNjo0ODoxOVrOH4uESw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEzMTYxMQ==", "bodyText": "Should this method return an immutable Set?", "url": "https://github.com/line/armeria/pull/3183#discussion_r529131611", "createdAt": "2020-11-24T02:04:11Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        private final SerializationFormat serializationFormat;\n+        private final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {\n+            this.serializationFormat = requireNonNull(serializationFormat, \"serializationFormat\");\n+            this.tProtocolFactory = requireNonNull(tProtocolFactory, \"tProtocolFactory\");\n+        }\n+\n+        public SerializationFormat getSerializationFormat() {\n+            return serializationFormat;\n+        }\n+\n+        public TProtocolFactory getTProtocolFactory() {\n+            return tProtocolFactory;\n+        }\n+    }\n+\n+    /**\n+     * Accessed configured {@link Entry}s for this SPI provider.\n+     *\n+     * @return an immutable view", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIzNzA2Nw==", "bodyText": "it does :P let me update the doc", "url": "https://github.com/line/armeria/pull/3183#discussion_r529237067", "createdAt": "2020-11-24T06:48:19Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        private final SerializationFormat serializationFormat;\n+        private final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {\n+            this.serializationFormat = requireNonNull(serializationFormat, \"serializationFormat\");\n+            this.tProtocolFactory = requireNonNull(tProtocolFactory, \"tProtocolFactory\");\n+        }\n+\n+        public SerializationFormat getSerializationFormat() {\n+            return serializationFormat;\n+        }\n+\n+        public TProtocolFactory getTProtocolFactory() {\n+            return tProtocolFactory;\n+        }\n+    }\n+\n+    /**\n+     * Accessed configured {@link Entry}s for this SPI provider.\n+     *\n+     * @return an immutable view", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEzMTYxMQ=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxODU2NDQwOnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjoxNDowOFrOH4oM5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwODoyNTo1NFrOH4xBtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0MDk2Ng==", "bodyText": "nit: null checking with if condition? The Optional seems to only be in a stack by escape analysis, however, we always try to avoid creating additional objects if possible.", "url": "https://github.com/line/armeria/pull/3183#discussion_r529140966", "createdAt": "2020-11-24T02:14:08Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +63,44 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(Entry::getSerializationFormat,\n+                                        Entry::getTProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory get(SerializationFormat serializationFormat) {\n+        requireNonNull(serializationFormat, \"serializationFormat\");\n+        return Optional.ofNullable(knownProtocolFactories.get(serializationFormat))\n+                       .orElseThrow(() -> new IllegalArgumentException(\n+                               \"Unsupported Thrift serializationFormat: \" + serializationFormat));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4NTU1Ng==", "bodyText": "I suppose it's mostly a matter of taste. changed.", "url": "https://github.com/line/armeria/pull/3183#discussion_r529285556", "createdAt": "2020-11-24T08:25:54Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +63,44 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(Entry::getSerializationFormat,\n+                                        Entry::getTProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory get(SerializationFormat serializationFormat) {\n+        requireNonNull(serializationFormat, \"serializationFormat\");\n+        return Optional.ofNullable(knownProtocolFactories.get(serializationFormat))\n+                       .orElseThrow(() -> new IllegalArgumentException(\n+                               \"Unsupported Thrift serializationFormat: \" + serializationFormat));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0MDk2Ng=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxODU3NzU3OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjoxNjozOFrOH4oWFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwODoyNjo1NlrOH4xEYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0MzMxNw==", "bodyText": "Make it singleton and use it?", "url": "https://github.com/line/armeria/pull/3183#discussion_r529143317", "createdAt": "2020-11-24T02:16:38Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +63,44 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(Entry::getSerializationFormat,\n+                                        Entry::getTProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory get(SerializationFormat serializationFormat) {\n+        requireNonNull(serializationFormat, \"serializationFormat\");\n+        return Optional.ofNullable(knownProtocolFactories.get(serializationFormat))\n+                       .orElseThrow(() -> new IllegalArgumentException(\n+                               \"Unsupported Thrift serializationFormat: \" + serializationFormat));\n+    }\n \n     /**\n-     * Returns the set of all known Thrift serialization formats.\n+     * Retrieves all registered Thrift serialization formats.\n+     *\n+     * @return an view of the registered Thrift serialization formats.\n      */\n     public static Set<SerializationFormat> values() {\n-        return THRIFT_FORMATS;\n+        return knownProtocolFactories.keySet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4NjI0MQ==", "bodyText": "ImmutableMap already caches its keySet as a field.", "url": "https://github.com/line/armeria/pull/3183#discussion_r529286241", "createdAt": "2020-11-24T08:26:56Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +63,44 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(Entry::getSerializationFormat,\n+                                        Entry::getTProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory get(SerializationFormat serializationFormat) {\n+        requireNonNull(serializationFormat, \"serializationFormat\");\n+        return Optional.ofNullable(knownProtocolFactories.get(serializationFormat))\n+                       .orElseThrow(() -> new IllegalArgumentException(\n+                               \"Unsupported Thrift serializationFormat: \" + serializationFormat));\n+    }\n \n     /**\n-     * Returns the set of all known Thrift serialization formats.\n+     * Retrieves all registered Thrift serialization formats.\n+     *\n+     * @return an view of the registered Thrift serialization formats.\n      */\n     public static Set<SerializationFormat> values() {\n-        return THRIFT_FORMATS;\n+        return knownProtocolFactories.keySet();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0MzMxNw=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxODU4Mjg5OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjoxNzo0MFrOH4oZ6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxMDo0MDowMVrOH46B_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0NDI5OQ==", "bodyText": "How about renaming to tProtocolFactory instead of get?", "url": "https://github.com/line/armeria/pull/3183#discussion_r529144299", "createdAt": "2020-11-24T02:17:40Z", "author": {"login": "minwoox"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +63,44 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(Entry::getSerializationFormat,\n+                                        Entry::getTProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory get(SerializationFormat serializationFormat) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4NzYxNw==", "bodyText": "I wanted to keep the same name as in ThriftProtocolFactories and I cannot rename as I should keep binary compatibility.", "url": "https://github.com/line/armeria/pull/3183#discussion_r529287617", "createdAt": "2020-11-24T08:29:04Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +63,44 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(Entry::getSerializationFormat,\n+                                        Entry::getTProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory get(SerializationFormat serializationFormat) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0NDI5OQ=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMwMDMyMQ==", "bodyText": "It's deprecated and I think it's okay to use a new name for this method.\nIt was ThriftProtocolFactories.get(serializationFormat) so it's obvious that the return value will be a TProtocolFactory.\nBut now it is ThriftSerializationFormats so I thought using the specific name would be better in this case. But not so strong on this. It's your choice. \ud83d\ude04", "url": "https://github.com/line/armeria/pull/3183#discussion_r529300321", "createdAt": "2020-11-24T08:49:09Z", "author": {"login": "minwoox"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +63,44 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(Entry::getSerializationFormat,\n+                                        Entry::getTProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory get(SerializationFormat serializationFormat) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0NDI5OQ=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTQzMzA4NQ==", "bodyText": "fair enough. let me rename the new method then", "url": "https://github.com/line/armeria/pull/3183#discussion_r529433085", "createdAt": "2020-11-24T10:40:01Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +63,44 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(Entry::getSerializationFormat,\n+                                        Entry::getTProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory get(SerializationFormat serializationFormat) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0NDI5OQ=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMxODU4ODYwOnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjoxODo0N1rOH4od3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwODo0OTozNlrOH4x8ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0NTMwOQ==", "bodyText": "Question: Is there any reason that you made this as an abstract class instead of an interface like other providers?", "url": "https://github.com/line/armeria/pull/3183#discussion_r529145309", "createdAt": "2020-11-24T02:18:47Z", "author": {"login": "minwoox"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI4ODI4Nw==", "bodyText": "Because @trustin pointed out that the nested class and the accessor should have restricted visibility.", "url": "https://github.com/line/armeria/pull/3183#discussion_r529288287", "createdAt": "2020-11-24T08:30:03Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0NTMwOQ=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTMwMDYxOA==", "bodyText": "I missed that. \ud83d\ude04", "url": "https://github.com/line/armeria/pull/3183#discussion_r529300618", "createdAt": "2020-11-24T08:49:36Z", "author": {"login": "minwoox"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0NTMwOQ=="}, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDg0MTcxOnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/DefaultThriftProtocolFactoryProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjozNDoyOFrOH5k7yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQyMjo1NDo0N1rOH6ou4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzNjAxMA==", "bodyText": "Could we move to com.linecorp.armeria.internal.common.thrift? This class doesn't need to be part of public API.", "url": "https://github.com/line/armeria/pull/3183#discussion_r530136010", "createdAt": "2020-11-25T06:34:28Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/DefaultThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI0NjgxOQ==", "bodyText": "sounds good", "url": "https://github.com/line/armeria/pull/3183#discussion_r531246819", "createdAt": "2020-11-26T22:54:47Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/DefaultThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzNjAxMA=="}, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDg1MjgxOnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjozOToxMlrOH5lCEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNDoxMToyMlrOH6wc8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzNzYxOA==", "bodyText": "public -> protected?", "url": "https://github.com/line/armeria/pull/3183#discussion_r530137618", "createdAt": "2020-11-25T06:39:12Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        final SerializationFormat serializationFormat;\n+        final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI0NjgwMA==", "bodyText": "I did so first but got a (misguided?) warning since this class is final. Anyways, I guess that public is fine here.", "url": "https://github.com/line/armeria/pull/3183#discussion_r531246800", "createdAt": "2020-11-26T22:54:38Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        final SerializationFormat serializationFormat;\n+        final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzNzYxOA=="}, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM3MzI5Ng==", "bodyText": "I see. No problem with that!", "url": "https://github.com/line/armeria/pull/3183#discussion_r531373296", "createdAt": "2020-11-27T04:11:22Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        final SerializationFormat serializationFormat;\n+        final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzNzYxOA=="}, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDg1Mzg4OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjozOTozNVrOH5lCmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjozOTozNVrOH5lCmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzNzc1NQ==", "bodyText": "Accessed -> Returns the", "url": "https://github.com/line/armeria/pull/3183#discussion_r530137755", "createdAt": "2020-11-25T06:39:35Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        final SerializationFormat serializationFormat;\n+        final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {\n+            this.serializationFormat = requireNonNull(serializationFormat, \"serializationFormat\");\n+            this.tProtocolFactory = requireNonNull(tProtocolFactory, \"tProtocolFactory\");\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return MoreObjects.toStringHelper(this)\n+                              .add(\"serializationFormat\", serializationFormat)\n+                              .add(\"tProtocolFactory\", tProtocolFactory)\n+                              .toString();\n+        }\n+    }\n+\n+    /**\n+     * Accessed configured {@link Entry}s for this SPI provider.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDg1NDE3OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjozOTo0OFrOH5lC0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjozOTo0OFrOH5lC0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzNzgwOA==", "bodyText": "use -> Use", "url": "https://github.com/line/armeria/pull/3183#discussion_r530137808", "createdAt": "2020-11-25T06:39:48Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -78,44 +78,28 @@ public String toString() {\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n     /**\n-     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     * Alias for {@link ThriftSerializationFormats#tProtocolFactory(SerializationFormat)}.\n      *\n-     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n+     * @param serializationFormat a known serialization format\n+     * @return the protocol factory linked to the input serializationFormat\n+     * @deprecated use {@link ThriftSerializationFormats#tProtocolFactory(SerializationFormat)}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDg1ODc2OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0MTozN1rOH5lFVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0MTozN1rOH5lFVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzODQ1NA==", "bodyText": "How about just toProtocolFactory() or protocolFactory()? That 't' looks somewhat awkward.", "url": "https://github.com/line/armeria/pull/3183#discussion_r530138454", "createdAt": "2020-11-25T06:41:37Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +62,43 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(e -> e.serializationFormat, e -> e.tProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory tProtocolFactory(SerializationFormat serializationFormat) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDg2MDQ5OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/server/thrift/THttpServiceBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0MjoxNlrOH5lGSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0MjoxNlrOH5lGSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzODY5OA==", "bodyText": "return -> returned", "url": "https://github.com/line/armeria/pull/3183#discussion_r530138698", "createdAt": "2020-11-25T06:42:16Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/server/thrift/THttpServiceBuilder.java", "diffHunk": "@@ -121,11 +123,11 @@ public THttpServiceBuilder otherSerializationFormats(SerializationFormat otherSe\n     }\n \n     /**\n-     * Adds other {@link SerializationFormat} to the builder. Current supported {@link SerializationFormat}s are\n-     * {@link ThriftSerializationFormats#values()}. If nothing is specified then all the\n-     * {@link SerializationFormat#values()}s are added.\n+     * Adds other {@link SerializationFormat}s to the builder. If nothing is specified then all\n+     * {@link SerializationFormat}s return by {@link ThriftSerializationFormats#values()}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDg2NTU1OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0NDozMFrOH5lJOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0NDozMFrOH5lJOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzOTQ0OQ==", "bodyText": "How about this:\nProvides Thrift-related {@link SerializationFormat} instances and their {@link TProtocolFactory}s.\n\n.. because whether this class registers anything is implementation detail.", "url": "https://github.com/line/armeria/pull/3183#discussion_r530139449", "createdAt": "2020-11-25T06:44:30Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -15,16 +15,23 @@\n  */\n package com.linecorp.armeria.common.thrift;\n \n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n import static java.util.Objects.requireNonNull;\n \n+import java.util.List;\n+import java.util.Map;\n+import java.util.ServiceLoader;\n import java.util.Set;\n \n-import com.google.common.collect.ImmutableSet;\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.google.common.collect.ImmutableList;\n \n import com.linecorp.armeria.common.SerializationFormat;\n \n /**\n- * Thrift-related {@link SerializationFormat} instances.\n+ * Registered Thrift-related {@link SerializationFormat} instances.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDg2OTI2OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0NTo0M1rOH5lLHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNDoyNDo1MVrOH6wm7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzOTkzNQ==", "bodyText": "Holds -> Provides ?", "url": "https://github.com/line/armeria/pull/3183#discussion_r530139935", "createdAt": "2020-11-25T06:45:43Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -27,7 +27,7 @@\n import com.linecorp.armeria.common.thrift.text.TTextProtocolFactory;\n \n /**\n- * Provides a set of the known {@link TProtocolFactory} instances.\n+ * Holds a few known {@link TProtocolFactory} instances.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI0MzkzNA==", "bodyText": "Umm, why? This class doesn't provide anything", "url": "https://github.com/line/armeria/pull/3183#discussion_r531243934", "createdAt": "2020-11-26T22:39:47Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -27,7 +27,7 @@\n import com.linecorp.armeria.common.thrift.text.TTextProtocolFactory;\n \n /**\n- * Provides a set of the known {@link TProtocolFactory} instances.\n+ * Holds a few known {@link TProtocolFactory} instances.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzOTkzNQ=="}, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM3Mjg4MQ==", "bodyText": "Hmm, doesn't it provide TProtocolFactory instances as static fields?", "url": "https://github.com/line/armeria/pull/3183#discussion_r531372881", "createdAt": "2020-11-27T04:09:09Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -27,7 +27,7 @@\n import com.linecorp.armeria.common.thrift.text.TTextProtocolFactory;\n \n /**\n- * Provides a set of the known {@link TProtocolFactory} instances.\n+ * Holds a few known {@link TProtocolFactory} instances.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzOTkzNQ=="}, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM3NTg1NA==", "bodyText": "Let me change this to move forward for today's release.", "url": "https://github.com/line/armeria/pull/3183#discussion_r531375854", "createdAt": "2020-11-27T04:24:51Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -27,7 +27,7 @@\n import com.linecorp.armeria.common.thrift.text.TTextProtocolFactory;\n \n /**\n- * Provides a set of the known {@link TProtocolFactory} instances.\n+ * Holds a few known {@link TProtocolFactory} instances.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzOTkzNQ=="}, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDg3NzQ4OnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0OTowOFrOH5lPrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwNDowODoyMlrOH6waxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE0MTEwMA==", "bodyText": "How about reimplementing this method in ThriftSerializationFormats using a bidi map? e.g.\nSerializationFormat serfmt = ThriftSerializationFormats.of(protoFactory);", "url": "https://github.com/line/armeria/pull/3183#discussion_r530141100", "createdAt": "2020-11-25T06:49:08Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -78,44 +78,28 @@ public String toString() {\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n     /**\n-     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     * Alias for {@link ThriftSerializationFormats#tProtocolFactory(SerializationFormat)}.\n      *\n-     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n+     * @param serializationFormat a known serialization format\n+     * @return the protocol factory linked to the input serializationFormat\n+     * @deprecated use {@link ThriftSerializationFormats#tProtocolFactory(SerializationFormat)}.\n      */\n+    @Deprecated\n     public static TProtocolFactory get(SerializationFormat serializationFormat) {\n-        requireNonNull(serializationFormat, \"serializationFormat\");\n-\n-        if (serializationFormat == ThriftSerializationFormats.BINARY) {\n-            return BINARY;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.COMPACT) {\n-            return COMPACT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.JSON) {\n-            return JSON;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT) {\n-            return TEXT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT_NAMED_ENUM) {\n-            return TEXT_NAMED_ENUM;\n-        }\n-\n-        throw new IllegalArgumentException(\"non-Thrift serializationFormat: \" + serializationFormat);\n+        return ThriftSerializationFormats.tProtocolFactory(serializationFormat);\n     }\n \n     /**\n-     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory}.\n+     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory},\n+     * as if it were registered by {@link DefaultThriftProtocolFactoryProvider}.\n+     * Consider having your own {@link TProtocolFactory} to {@link SerializationFormat} mapping if necessary.\n      *\n-     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} is not known by this class\n+     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} did not match anything\n+     * @deprecated this method cannot reliably work with custom protocol factories\n      */\n+    @Deprecated\n     public static SerializationFormat toSerializationFormat(TProtocolFactory protoFactory) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTI0MzcxNw==", "bodyText": "I'm afraid this doesn't help since most TProtocolFactory implementations don't have a stable equals. Anyways, what's the use case for generic reverse lookup?", "url": "https://github.com/line/armeria/pull/3183#discussion_r531243717", "createdAt": "2020-11-26T22:38:40Z", "author": {"login": "mauhiz"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -78,44 +78,28 @@ public String toString() {\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n     /**\n-     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     * Alias for {@link ThriftSerializationFormats#tProtocolFactory(SerializationFormat)}.\n      *\n-     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n+     * @param serializationFormat a known serialization format\n+     * @return the protocol factory linked to the input serializationFormat\n+     * @deprecated use {@link ThriftSerializationFormats#tProtocolFactory(SerializationFormat)}.\n      */\n+    @Deprecated\n     public static TProtocolFactory get(SerializationFormat serializationFormat) {\n-        requireNonNull(serializationFormat, \"serializationFormat\");\n-\n-        if (serializationFormat == ThriftSerializationFormats.BINARY) {\n-            return BINARY;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.COMPACT) {\n-            return COMPACT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.JSON) {\n-            return JSON;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT) {\n-            return TEXT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT_NAMED_ENUM) {\n-            return TEXT_NAMED_ENUM;\n-        }\n-\n-        throw new IllegalArgumentException(\"non-Thrift serializationFormat: \" + serializationFormat);\n+        return ThriftSerializationFormats.tProtocolFactory(serializationFormat);\n     }\n \n     /**\n-     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory}.\n+     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory},\n+     * as if it were registered by {@link DefaultThriftProtocolFactoryProvider}.\n+     * Consider having your own {@link TProtocolFactory} to {@link SerializationFormat} mapping if necessary.\n      *\n-     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} is not known by this class\n+     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} did not match anything\n+     * @deprecated this method cannot reliably work with custom protocol factories\n      */\n+    @Deprecated\n     public static SerializationFormat toSerializationFormat(TProtocolFactory protoFactory) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE0MTEwMA=="}, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM3Mjc0MQ==", "bodyText": "I agree. Fine with deprecation without replacement.", "url": "https://github.com/line/armeria/pull/3183#discussion_r531372741", "createdAt": "2020-11-27T04:08:22Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -78,44 +78,28 @@ public String toString() {\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n     /**\n-     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     * Alias for {@link ThriftSerializationFormats#tProtocolFactory(SerializationFormat)}.\n      *\n-     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n+     * @param serializationFormat a known serialization format\n+     * @return the protocol factory linked to the input serializationFormat\n+     * @deprecated use {@link ThriftSerializationFormats#tProtocolFactory(SerializationFormat)}.\n      */\n+    @Deprecated\n     public static TProtocolFactory get(SerializationFormat serializationFormat) {\n-        requireNonNull(serializationFormat, \"serializationFormat\");\n-\n-        if (serializationFormat == ThriftSerializationFormats.BINARY) {\n-            return BINARY;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.COMPACT) {\n-            return COMPACT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.JSON) {\n-            return JSON;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT) {\n-            return TEXT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT_NAMED_ENUM) {\n-            return TEXT_NAMED_ENUM;\n-        }\n-\n-        throw new IllegalArgumentException(\"non-Thrift serializationFormat: \" + serializationFormat);\n+        return ThriftSerializationFormats.tProtocolFactory(serializationFormat);\n     }\n \n     /**\n-     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory}.\n+     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory},\n+     * as if it were registered by {@link DefaultThriftProtocolFactoryProvider}.\n+     * Consider having your own {@link TProtocolFactory} to {@link SerializationFormat} mapping if necessary.\n      *\n-     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} is not known by this class\n+     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} did not match anything\n+     * @deprecated this method cannot reliably work with custom protocol factories\n      */\n+    @Deprecated\n     public static SerializationFormat toSerializationFormat(TProtocolFactory protoFactory) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE0MTEwMA=="}, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 60}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2050, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}