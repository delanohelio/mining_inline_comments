{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNDE3MDE2", "number": 2852, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDowNDoyMlrOEJrMGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDowNDoyMlrOEJrMGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NTgwMjQ4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNDowNDoyMlrOGqShVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMjoyNToyM1rOGqpSnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk5NjgyMQ==", "bodyText": "question: which one releases the msg?", "url": "https://github.com/line/armeria/pull/2852#discussion_r446996821", "createdAt": "2020-06-29T14:04:22Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java", "diffHunk": "@@ -467,28 +467,51 @@ public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exc\n \n         @Override\n         public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n-            boolean handled = false;\n             if (msg instanceof HttpResponse) {\n                 // The server rejected the upgrade request and sent its response in HTTP/1.\n                 assert upgradeEvt == UPGRADE_REJECTED;\n-                final String connection = ((HttpResponse) msg).headers().get(HttpHeaderNames.CONNECTION);\n-                needsToClose = connection != null && Ascii.equalsIgnoreCase(\"close\", connection);\n-                handled = true;\n+                final HttpResponse res = (HttpResponse) msg;\n+                upgradeRejectionCause = \"Upgrade request rejected with: \" + res.headers();\n+                // We can persist connection only when:\n+                // - The response has 'Connection: keep-alive' header on HTTP/1.0.\n+                // - The response has no 'Connection: close' header on HTTP/1.1.\n+                // and:\n+                // - The response has 'Content-Length' or 'Transfer-Encoding: chunked',\n+                //   i.e. possible to determine the end of the response.\n+                //\n+                // See: https://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.1.2.1\n+                //      https://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html#sec4.4\n+                needsToClose = !(HttpUtil.isKeepAlive(res) &&\n+                                 (HttpUtil.isContentLengthSet(res) ||\n+                                  HttpUtil.isTransferEncodingChunked(res)));\n+                if (needsToClose) {\n+                    // No need to wait till the end of the response.\n+                    // Close the connection immediately and finish the upgrade process.\n+                    onUpgradeResponse(ctx, false);\n+                }\n+\n+                ReferenceCountUtil.release(msg);\n+                return;\n+            }\n+\n+            // We're not going to reuse the connection,\n+            // so we just discard everything received.\n+            if (needsToClose) {\n+                ReferenceCountUtil.release(msg);\n+                return;\n             }\n \n+            // We're not going to close but reuse the connection,\n+            // so we wait until the end of the rejecting response.\n             if (msg instanceof HttpContent) {\n                 if (msg instanceof LastHttpContent) {\n-                    // Received the rejecting response completely.\n                     onUpgradeResponse(ctx, false);\n                 }\n-                handled = true;\n-            }\n-\n-            if (!handled) {\n-                ctx.fireChannelRead(msg);\n-            } else {\n                 ReferenceCountUtil.release(msg);\n+                return;\n             }\n+\n+            ctx.fireChannelRead(msg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ead31ac24357eb35a4b335b3b294f24ddea0d5e9"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM1NjMzMA==", "bodyText": "The other handlers in the pipeline, or if it reaches at the end of the pipeline, it will be released by the pipeline.", "url": "https://github.com/line/armeria/pull/2852#discussion_r447356330", "createdAt": "2020-06-30T01:37:28Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java", "diffHunk": "@@ -467,28 +467,51 @@ public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exc\n \n         @Override\n         public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n-            boolean handled = false;\n             if (msg instanceof HttpResponse) {\n                 // The server rejected the upgrade request and sent its response in HTTP/1.\n                 assert upgradeEvt == UPGRADE_REJECTED;\n-                final String connection = ((HttpResponse) msg).headers().get(HttpHeaderNames.CONNECTION);\n-                needsToClose = connection != null && Ascii.equalsIgnoreCase(\"close\", connection);\n-                handled = true;\n+                final HttpResponse res = (HttpResponse) msg;\n+                upgradeRejectionCause = \"Upgrade request rejected with: \" + res.headers();\n+                // We can persist connection only when:\n+                // - The response has 'Connection: keep-alive' header on HTTP/1.0.\n+                // - The response has no 'Connection: close' header on HTTP/1.1.\n+                // and:\n+                // - The response has 'Content-Length' or 'Transfer-Encoding: chunked',\n+                //   i.e. possible to determine the end of the response.\n+                //\n+                // See: https://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.1.2.1\n+                //      https://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html#sec4.4\n+                needsToClose = !(HttpUtil.isKeepAlive(res) &&\n+                                 (HttpUtil.isContentLengthSet(res) ||\n+                                  HttpUtil.isTransferEncodingChunked(res)));\n+                if (needsToClose) {\n+                    // No need to wait till the end of the response.\n+                    // Close the connection immediately and finish the upgrade process.\n+                    onUpgradeResponse(ctx, false);\n+                }\n+\n+                ReferenceCountUtil.release(msg);\n+                return;\n+            }\n+\n+            // We're not going to reuse the connection,\n+            // so we just discard everything received.\n+            if (needsToClose) {\n+                ReferenceCountUtil.release(msg);\n+                return;\n             }\n \n+            // We're not going to close but reuse the connection,\n+            // so we wait until the end of the rejecting response.\n             if (msg instanceof HttpContent) {\n                 if (msg instanceof LastHttpContent) {\n-                    // Received the rejecting response completely.\n                     onUpgradeResponse(ctx, false);\n                 }\n-                handled = true;\n-            }\n-\n-            if (!handled) {\n-                ctx.fireChannelRead(msg);\n-            } else {\n                 ReferenceCountUtil.release(msg);\n+                return;\n             }\n+\n+            ctx.fireChannelRead(msg);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk5NjgyMQ=="}, "originalCommit": {"oid": "ead31ac24357eb35a4b335b3b294f24ddea0d5e9"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM2OTg4NA==", "bodyText": "Thanks for the explanation. \ud83d\ude04", "url": "https://github.com/line/armeria/pull/2852#discussion_r447369884", "createdAt": "2020-06-30T02:25:23Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java", "diffHunk": "@@ -467,28 +467,51 @@ public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exc\n \n         @Override\n         public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n-            boolean handled = false;\n             if (msg instanceof HttpResponse) {\n                 // The server rejected the upgrade request and sent its response in HTTP/1.\n                 assert upgradeEvt == UPGRADE_REJECTED;\n-                final String connection = ((HttpResponse) msg).headers().get(HttpHeaderNames.CONNECTION);\n-                needsToClose = connection != null && Ascii.equalsIgnoreCase(\"close\", connection);\n-                handled = true;\n+                final HttpResponse res = (HttpResponse) msg;\n+                upgradeRejectionCause = \"Upgrade request rejected with: \" + res.headers();\n+                // We can persist connection only when:\n+                // - The response has 'Connection: keep-alive' header on HTTP/1.0.\n+                // - The response has no 'Connection: close' header on HTTP/1.1.\n+                // and:\n+                // - The response has 'Content-Length' or 'Transfer-Encoding: chunked',\n+                //   i.e. possible to determine the end of the response.\n+                //\n+                // See: https://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html#sec8.1.2.1\n+                //      https://www.w3.org/Protocols/rfc2616/rfc2616-sec4.html#sec4.4\n+                needsToClose = !(HttpUtil.isKeepAlive(res) &&\n+                                 (HttpUtil.isContentLengthSet(res) ||\n+                                  HttpUtil.isTransferEncodingChunked(res)));\n+                if (needsToClose) {\n+                    // No need to wait till the end of the response.\n+                    // Close the connection immediately and finish the upgrade process.\n+                    onUpgradeResponse(ctx, false);\n+                }\n+\n+                ReferenceCountUtil.release(msg);\n+                return;\n+            }\n+\n+            // We're not going to reuse the connection,\n+            // so we just discard everything received.\n+            if (needsToClose) {\n+                ReferenceCountUtil.release(msg);\n+                return;\n             }\n \n+            // We're not going to close but reuse the connection,\n+            // so we wait until the end of the rejecting response.\n             if (msg instanceof HttpContent) {\n                 if (msg instanceof LastHttpContent) {\n-                    // Received the rejecting response completely.\n                     onUpgradeResponse(ctx, false);\n                 }\n-                handled = true;\n-            }\n-\n-            if (!handled) {\n-                ctx.fireChannelRead(msg);\n-            } else {\n                 ReferenceCountUtil.release(msg);\n+                return;\n             }\n+\n+            ctx.fireChannelRead(msg);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk5NjgyMQ=="}, "originalCommit": {"oid": "ead31ac24357eb35a4b335b3b294f24ddea0d5e9"}, "originalPosition": 117}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2454, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}