{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzODQwMTYy", "number": 2665, "title": "Make DNS resolver handle timeout correctly when querying AAAA & A\u2026", "bodyText": "\u2026 records at same time\nIf one of the DNS query timeouts when resolver sends A/AAAA queries together, the resolver will have IllegalStateException internally and return DnsTimeoutException. The resolver should return resolved one instead of return error.\nModifications:\n\nReturn DNS timeout exception only when all the queries are not completed yet.\nMake result follow the preferred order\n\nResult:\n\nFixes #2664", "createdAt": "2020-04-15T15:43:17Z", "url": "https://github.com/line/armeria/pull/2665", "merged": true, "mergeCommit": {"oid": "7e1e3cbabf4714dd891a25deb762c57a615b0e07"}, "closed": true, "closedAt": "2020-04-16T11:35:16Z", "author": {"login": "kojilin"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcX6DCSgH2gAyNDAzODQwMTYyOjBlZWZmY2RjOGQ1MzdjMDNlOTk4ZDRiN2Q4YzFmYWRhNWZjZTVjYzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYI-GUAFqTM5NDQzOTUxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0eeffcdc8d537c03e998d4b7d8c1fada5fce5cc5", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/0eeffcdc8d537c03e998d4b7d8c1fada5fce5cc5", "committedDate": "2020-04-15T15:44:09Z", "message": "Make DNS Resolver can handle timeout correctly when querying AAAA & A record at same time\n\nIf one of the dns query timeout when resolver send A/AAAA queries, resolver will have IllegalStateException internally and return DnsTimeoutException. Resolver should return correct one instead of return error.\n\nModifications:\n* Using tryFailure instead of cancel when timeout, and let callback decide the exception type.\n* Make result follow the preferred order"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b8ee82b8a29e4f504dae7709fd6857a14b0bab05", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/b8ee82b8a29e4f504dae7709fd6857a14b0bab05", "committedDate": "2020-04-15T15:42:22Z", "message": "Make DNS Resolver can handle timeout correctly when querying AAAA & A record at same time\n\nIf one of the dns query timeout when resolver send A/AAAA queries, resolver will have IllegalStateException internally and return DnsTimeoutException. Resolver should return correct one instead of return error.\n\nModifications:\n* Using tryFailure instead of cancel when timeout, and let callback decide the exception type.\n* Make result follow the preferred order"}, "afterCommit": {"oid": "0eeffcdc8d537c03e998d4b7d8c1fada5fce5cc5", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/0eeffcdc8d537c03e998d4b7d8c1fada5fce5cc5", "committedDate": "2020-04-15T15:44:09Z", "message": "Make DNS Resolver can handle timeout correctly when querying AAAA & A record at same time\n\nIf one of the dns query timeout when resolver send A/AAAA queries, resolver will have IllegalStateException internally and return DnsTimeoutException. Resolver should return correct one instead of return error.\n\nModifications:\n* Using tryFailure instead of cancel when timeout, and let callback decide the exception type.\n* Make result follow the preferred order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35963f486fe4645d3d2931db9e2c13ca74e65131", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/35963f486fe4645d3d2931db9e2c13ca74e65131", "committedDate": "2020-04-16T01:15:44Z", "message": "Using multiple dns server to enlarge netty timeout."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MjQwMTE0", "url": "https://github.com/line/armeria/pull/2665#pullrequestreview-394240114", "createdAt": "2020-04-16T01:28:17Z", "commit": {"oid": "35963f486fe4645d3d2931db9e2c13ca74e65131"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMToyODoxN1rOGGRQUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMToyODoxN1rOGGRQUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzM0NQ==", "bodyText": "We should cancel the promise to stop sending DNS queries internally. https://github.com/netty/netty/pull/10171/files#diff-6107a6de600a6f941beb29f082976653R357\nIs there any reason that DnsTimeoutException shouldn't be propagated to the caller?", "url": "https://github.com/line/armeria/pull/2665#discussion_r409227345", "createdAt": "2020-04-16T01:28:17Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/internal/client/DefaultDnsNameResolver.java", "diffHunk": "@@ -140,9 +148,8 @@ private void configureTimeout(List<DnsQuestion> questions, String logPrefix,\n             final DnsTimeoutException exception = new DnsTimeoutException(\n                     '[' + logPrefix + \"] \" + questions + \" are timed out after \" +\n                     queryTimeoutMillis + \" milliseconds.\");\n-            result.setFailure(exception);\n             promises.forEach(promise -> {\n-                promise.cancel(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35963f486fe4645d3d2931db9e2c13ca74e65131"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "def295079ba06926218c11b41c77c06f38b42f10", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/def295079ba06926218c11b41c77c06f38b42f10", "committedDate": "2020-04-16T01:50:10Z", "message": "Using cancel mechanism to cancel dns query correctly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92cf4c82566360b8539fe3d81fb730ffe453c37c", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/92cf4c82566360b8539fe3d81fb730ffe453c37c", "committedDate": "2020-04-16T01:59:07Z", "message": "nit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MjczMzA1", "url": "https://github.com/line/armeria/pull/2665#pullrequestreview-394273305", "createdAt": "2020-04-16T03:23:22Z", "commit": {"oid": "92cf4c82566360b8539fe3d81fb730ffe453c37c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzoyMzoyMlrOGGTI-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzoyNDo1OVrOGGTKpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1ODIzMg==", "bodyText": "Thanks for this!", "url": "https://github.com/line/armeria/pull/2665#discussion_r409258232", "createdAt": "2020-04-16T03:23:22Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/internal/client/DefaultDnsNameResolver.java", "diffHunk": "@@ -96,12 +89,22 @@ public void operationComplete(Future<List<DnsRecord>> future) throws Exception {\n \n                 if (--remaining == 0) {\n                     if (!records.isEmpty()) {\n+                        if (records.size() > 1) {\n+                            final List<DnsRecordType> preferredOrder =\n+                                    questions.stream().map(DnsRecord::type).collect(toImmutableList());\n+                            records.sort(Comparator.comparingInt(\n+                                    record -> preferredOrder.indexOf(record.type())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92cf4c82566360b8539fe3d81fb730ffe453c37c"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI1ODY2Mg==", "bodyText": "Then how about just using try(Success|failure)? Becuase we can't be sure that the CancellationException is triggered by our side. (i.e. DnsNameResolver could cancel it internally)", "url": "https://github.com/line/armeria/pull/2665#discussion_r409258662", "createdAt": "2020-04-16T03:24:59Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/internal/client/DefaultDnsNameResolver.java", "diffHunk": "@@ -140,9 +148,8 @@ private void configureTimeout(List<DnsQuestion> questions, String logPrefix,\n             final DnsTimeoutException exception = new DnsTimeoutException(\n                     '[' + logPrefix + \"] \" + questions + \" are timed out after \" +\n                     queryTimeoutMillis + \" milliseconds.\");\n-            result.setFailure(exception);\n             promises.forEach(promise -> {\n-                promise.cancel(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTIyNzM0NQ=="}, "originalCommit": {"oid": "35963f486fe4645d3d2931db9e2c13ca74e65131"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mjc3MDM4", "url": "https://github.com/line/armeria/pull/2665#pullrequestreview-394277038", "createdAt": "2020-04-16T03:37:34Z", "commit": {"oid": "92cf4c82566360b8539fe3d81fb730ffe453c37c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzozNzozNFrOGGTWug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwMzozNzozNFrOGGTWug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTI2MTc1NA==", "bodyText": "I think we always have a fixed set of types, so since this is an internal class we could pass them to the constructor and only do this once. Can also use Ordering.explicit", "url": "https://github.com/line/armeria/pull/2665#discussion_r409261754", "createdAt": "2020-04-16T03:37:34Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/internal/client/DefaultDnsNameResolver.java", "diffHunk": "@@ -96,12 +89,22 @@ public void operationComplete(Future<List<DnsRecord>> future) throws Exception {\n \n                 if (--remaining == 0) {\n                     if (!records.isEmpty()) {\n+                        if (records.size() > 1) {\n+                            final List<DnsRecordType> preferredOrder =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92cf4c82566360b8539fe3d81fb730ffe453c37c"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "539d487865180e5fba88fabc114c6b949064f9a4", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/539d487865180e5fba88fabc114c6b949064f9a4", "committedDate": "2020-04-16T04:18:12Z", "message": "Follow the suggestion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "363bad0b1950dd565494f8c94e07ea90ece26580", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/363bad0b1950dd565494f8c94e07ea90ece26580", "committedDate": "2020-04-16T04:34:40Z", "message": "Reduce explicit representation of Guava Ordering."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MjkyNDAw", "url": "https://github.com/line/armeria/pull/2665#pullrequestreview-394292400", "createdAt": "2020-04-16T04:36:21Z", "commit": {"oid": "363bad0b1950dd565494f8c94e07ea90ece26580"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4274a77ff280e9d99f0fedadf512f62eb6846708", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/4274a77ff280e9d99f0fedadf512f62eb6846708", "committedDate": "2020-04-16T04:48:36Z", "message": "nit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MzUyODE0", "url": "https://github.com/line/armeria/pull/2665#pullrequestreview-394352814", "createdAt": "2020-04-16T07:09:09Z", "commit": {"oid": "4274a77ff280e9d99f0fedadf512f62eb6846708"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mzk5Nzky", "url": "https://github.com/line/armeria/pull/2665#pullrequestreview-394399792", "createdAt": "2020-04-16T08:17:19Z", "commit": {"oid": "4274a77ff280e9d99f0fedadf512f62eb6846708"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDM5NTE1", "url": "https://github.com/line/armeria/pull/2665#pullrequestreview-394439515", "createdAt": "2020-04-16T09:07:20Z", "commit": {"oid": "4274a77ff280e9d99f0fedadf512f62eb6846708"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 390, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}