{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2NTkzNDc4", "number": 3060, "title": "Handle request timeout correctly for HTTP", "bodyText": "Sorry about the delay and thanks for your patience \ud83d\ude4f\nMotivation\nMore details: #3055 (comment)\nThis PR attempts to suppress warning logs when a server-side initiated 408 request\ntimeout message is sent to client side.\nI wasn't able to reproduce this behavior with http2 (I'm guessing http2 would rely\non RST_STREAM for this kind of behavior), so I've only handled this for http1.\nModifications\n\nAdd a check for Connection: close, status code: 408 in client/Http1ResponseDecoder\nwhen reading headers.", "createdAt": "2020-09-14T13:04:34Z", "url": "https://github.com/line/armeria/pull/3060", "merged": true, "mergeCommit": {"oid": "002e24970fb71cbf7bb27697f95367499a19588c"}, "closed": true, "closedAt": "2021-04-30T09:33:08Z", "author": {"login": "jrhee17"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJd2oEABqjM3NzM3MDk0NzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeSIenDAFqTY0OTA0NDUwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e555f756c1cfe1629debcc6ce48537190ff0dadf", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/e555f756c1cfe1629debcc6ce48537190ff0dadf", "committedDate": "2020-09-16T14:16:29Z", "message": "handle http1 request timeout response"}, "afterCommit": {"oid": "4cdc7da88721c1dc3345d323b0f10ecc336034ec", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/4cdc7da88721c1dc3345d323b0f10ecc336034ec", "committedDate": "2020-09-16T15:09:14Z", "message": "handle http1 request timeout response"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1d5728d0ff7c65fb311c5872b2ee40812060408", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/e1d5728d0ff7c65fb311c5872b2ee40812060408", "committedDate": "2020-09-16T15:25:33Z", "message": "also handle really missing res case"}, "afterCommit": {"oid": "fdb2ba09c3da08ab7688d5247d2f6b5d01bb0cfe", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/fdb2ba09c3da08ab7688d5247d2f6b5d01bb0cfe", "committedDate": "2021-04-17T00:49:32Z", "message": "also handle really missing res case"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fdb2ba09c3da08ab7688d5247d2f6b5d01bb0cfe", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/fdb2ba09c3da08ab7688d5247d2f6b5d01bb0cfe", "committedDate": "2021-04-17T00:49:32Z", "message": "also handle really missing res case"}, "afterCommit": {"oid": "35716c2c3fdf3e298241f796f0ddf3f32e0483b0", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/35716c2c3fdf3e298241f796f0ddf3f32e0483b0", "committedDate": "2021-04-28T15:42:39Z", "message": "handle warning log for request timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53d322c46a198a540c368ccc8bcb610648fafdbb", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/53d322c46a198a540c368ccc8bcb610648fafdbb", "committedDate": "2021-04-28T21:15:53Z", "message": "handle warning log for request timeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35716c2c3fdf3e298241f796f0ddf3f32e0483b0", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/35716c2c3fdf3e298241f796f0ddf3f32e0483b0", "committedDate": "2021-04-28T15:42:39Z", "message": "handle warning log for request timeout"}, "afterCommit": {"oid": "53d322c46a198a540c368ccc8bcb610648fafdbb", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/53d322c46a198a540c368ccc8bcb610648fafdbb", "committedDate": "2021-04-28T21:15:53Z", "message": "handle warning log for request timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjQ4OTMyMTc5", "url": "https://github.com/line/armeria/pull/3060#pullrequestreview-648932179", "createdAt": "2021-04-30T07:01:10Z", "commit": {"oid": "53d322c46a198a540c368ccc8bcb610648fafdbb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0zMFQwNzowMToxMFrOJSw2og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0zMFQwNzowMjoxOFrOJSw5Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzY1NDU2Mg==", "bodyText": "Revert?\n\n  \n    \n      \n        Suggested change", "url": "https://github.com/line/armeria/pull/3060#discussion_r623654562", "createdAt": "2021-04-30T07:01:10Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/Http1ResponseDecoder.java", "diffHunk": "@@ -154,6 +154,7 @@ public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception\n             switch (state) {\n                 case NEED_HEADERS:\n                     if (msg instanceof HttpResponse) {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53d322c46a198a540c368ccc8bcb610648fafdbb"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzY1NTE3MA==", "bodyText": "A little bit of Javadoc would be nice, with a link to the related GH issue.", "url": "https://github.com/line/armeria/pull/3060#discussion_r623655170", "createdAt": "2021-04-30T07:02:18Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtil.java", "diffHunk": "@@ -1124,5 +1125,10 @@ public static String authorityHeader(String host, int port, int defaultPort) {\n         }\n     }\n \n+    public static boolean isRequestTimeoutResponse(HttpResponse httpResponse) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53d322c46a198a540c368ccc8bcb610648fafdbb"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae4bd57d912451e422f49e60bc91cc35ac7e9345", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/ae4bd57d912451e422f49e60bc91cc35ac7e9345", "committedDate": "2021-04-30T07:07:46Z", "message": "Merge branch 'master' into pr-3060@jrhee17+bugfix/handle-request-timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjQ4OTU2MzE3", "url": "https://github.com/line/armeria/pull/3060#pullrequestreview-648956317", "createdAt": "2021-04-30T07:33:32Z", "commit": {"oid": "ae4bd57d912451e422f49e60bc91cc35ac7e9345"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0zMFQwNzozMzozMlrOJSyI-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0zMFQwNzo0MzowMlrOJSyc_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzY3NTY0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    if (res == null && ArmeriaHttpUtil.isRequestTimeoutResponse((HttpResponse) msg)) {\n          \n          \n            \n                                    if (res == null && ArmeriaHttpUtil.isRequestTimeoutResponse(nettyRes) {", "url": "https://github.com/line/armeria/pull/3060#discussion_r623675642", "createdAt": "2021-04-30T07:33:32Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/Http1ResponseDecoder.java", "diffHunk": "@@ -166,6 +167,10 @@ public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception\n                         }\n \n                         final HttpResponseWrapper res = getResponse(resId);\n+                        if (res == null && ArmeriaHttpUtil.isRequestTimeoutResponse((HttpResponse) msg)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4bd57d912451e422f49e60bc91cc35ac7e9345"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzY4MDc2Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class Http1ResponseDecoderTest {\n          \n          \n            \n            class Http1ResponseDecoderTest {", "url": "https://github.com/line/armeria/pull/3060#discussion_r623680767", "createdAt": "2021-04-30T07:43:02Z", "author": {"login": "ikhoon"}, "path": "core/src/test/java/com/linecorp/armeria/client/Http1ResponseDecoderTest.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import io.netty.channel.embedded.EmbeddedChannel;\n+import io.netty.handler.codec.http.DefaultHttpHeaders;\n+import io.netty.handler.codec.http.DefaultHttpResponse;\n+import io.netty.handler.codec.http.HttpHeaderNames;\n+import io.netty.handler.codec.http.HttpHeaders;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.netty.handler.codec.http.HttpVersion;\n+\n+public class Http1ResponseDecoderTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae4bd57d912451e422f49e60bc91cc35ac7e9345"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a1facc528dd7c5f854387d0d00c160ec2382552", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/9a1facc528dd7c5f854387d0d00c160ec2382552", "committedDate": "2021-04-30T09:19:10Z", "message": "remove public for junit5, add javadoc, remove newline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b958f5af23eb69c58b6602db5e3a1626017edaea", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/b958f5af23eb69c58b6602db5e3a1626017edaea", "committedDate": "2021-04-30T09:20:53Z", "message": "revert another newline delete, fix grammar"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjQ5MDM4Mzk2", "url": "https://github.com/line/armeria/pull/3060#pullrequestreview-649038396", "createdAt": "2021-04-30T09:23:55Z", "commit": {"oid": "b958f5af23eb69c58b6602db5e3a1626017edaea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0zMFQwOToyMzo1NVrOJS2ESw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0zMFQwOToyMzo1NVrOJS2ESw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzczOTk3OQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/line/armeria/pull/3060#discussion_r623739979", "createdAt": "2021-04-30T09:23:55Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtil.java", "diffHunk": "@@ -1124,5 +1125,14 @@ public static String authorityHeader(String host, int port, int defaultPort) {\n         }\n     }\n \n+    /**\n+     * A 408 request timeout response can be received even without a request.\n+     * More details can be found at https://github.com/line/armeria/issues/3055.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b958f5af23eb69c58b6602db5e3a1626017edaea"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjQ5MDM4OTgz", "url": "https://github.com/line/armeria/pull/3060#pullrequestreview-649038983", "createdAt": "2021-04-30T09:24:36Z", "commit": {"oid": "b958f5af23eb69c58b6602db5e3a1626017edaea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0zMFQwOToyNDozNlrOJS2GRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0zMFQwOToyNDozNlrOJS2GRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMzc0MDQ4NQ==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * A 408 request timeout response can be received even without a request.\n          \n          \n            \n                 * A 408 Request Timeout response can be received even without a request.", "url": "https://github.com/line/armeria/pull/3060#discussion_r623740485", "createdAt": "2021-04-30T09:24:36Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtil.java", "diffHunk": "@@ -1124,5 +1125,14 @@ public static String authorityHeader(String host, int port, int defaultPort) {\n         }\n     }\n \n+    /**\n+     * A 408 request timeout response can be received even without a request.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b958f5af23eb69c58b6602db5e3a1626017edaea"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c0e186ed206e7c877a11b06617a11382fd61332", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/2c0e186ed206e7c877a11b06617a11382fd61332", "committedDate": "2021-04-30T09:28:38Z", "message": "capitalization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjQ5MDQ0NTA3", "url": "https://github.com/line/armeria/pull/3060#pullrequestreview-649044507", "createdAt": "2021-04-30T09:31:43Z", "commit": {"oid": "2c0e186ed206e7c877a11b06617a11382fd61332"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4655, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}