{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMDQxNjI3", "number": 3182, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMDoxMDoxN1rOE5ylfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNjoyODoxMFrOE65Nrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDMzMDg3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMDoxMDoxN1rOH0eouQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMDoxMDoxN1rOH0eouQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc4OTk0NQ==", "bodyText": "useIoUring to follow the convention?", "url": "https://github.com/line/armeria/pull/3182#discussion_r524789945", "createdAt": "2020-11-17T00:10:17Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -168,6 +169,8 @@\n     private static final boolean HAS_WSLENV = System.getenv(\"WSLENV\") != null;\n     private static final boolean USE_EPOLL = getBoolean(\"useEpoll\", isEpollAvailable(),\n                                                         value -> isEpollAvailable() || !value);\n+    private static final boolean USE_IOURING = getBoolean(\"useIOUring\", false,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d6bd978f0fefd2f65fe7f4d135e64b7c9c26593"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDY1MDY0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoxNDoxOVrOH0hsXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoxNDoxOVrOH0hsXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0MDAyOA==", "bodyText": "Better removing default?", "url": "https://github.com/line/armeria/pull/3182#discussion_r524840028", "createdAt": "2020-11-17T02:14:19Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -482,11 +533,26 @@ public static String requestContextStorageProvider() {\n      *\n      * <p>This flag is enabled by default for supported platforms. Specify the\n      * {@code -Dcom.linecorp.armeria.useEpoll=false} JVM option to disable it.\n+     *\n+     * @deprecated Use {@link #defaultTransportType()} and {@code -Dcom.linecorp.armeria.transportType=epoll}.\n      */\n+    @Deprecated\n     public static boolean useEpoll() {\n         return USE_EPOLL;\n     }\n \n+    /**\n+     * Returns the {@link TransportType} that will be used for socket I/O in Armeria.\n+     *\n+     * <p>The default value of this flag is {@link #DEFAULT_TRANSPORT_TYPE_SPEC}, which retains\n+     * the transport type of socket I/O API which Armeria will be used.\n+     * Specify the {@code -Dcom.linecorp.armeria.transportType=<nio|epoll|io_uring>} JVM option to override\n+     * the default.</p>\n+     */\n+    public static TransportType defaultTransportType() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bbf81a1e35b489d3ad465fa3362626198e1ba2"}, "originalPosition": 118}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDY1NDQ4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoxNjoxMlrOH0huiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoxNjoxMlrOH0huiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0MDU4NQ==", "bodyText": "How about removing _SPEC? It's just transport name.", "url": "https://github.com/line/armeria/pull/3182#discussion_r524840585", "createdAt": "2020-11-17T02:16:12Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -169,6 +171,22 @@\n     private static final boolean HAS_WSLENV = System.getenv(\"WSLENV\") != null;\n     private static final boolean USE_EPOLL = getBoolean(\"useEpoll\", isEpollAvailable(),\n                                                         value -> isEpollAvailable() || !value);\n+\n+    private static final String DEFAULT_TRANSPORT_TYPE_SPEC = USE_EPOLL ? \"epoll\" : \"nio\";\n+    private static final String TRANSPORT_TYPE_SPEC = getNormalized(\"transportType\",\n+                                                                    DEFAULT_TRANSPORT_TYPE_SPEC,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bbf81a1e35b489d3ad465fa3362626198e1ba2"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDY1ODkyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoxODozMFrOH0hxEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoxODozMFrOH0hxEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0MTIzMg==", "bodyText": "... this flag is {@code \"epoll\"} in Linux and {@code \"nio\"} for other operations systems.\nSpecify ...\n\n('... which retains' doesn't seem to add anything new, so I think we can remove it.)", "url": "https://github.com/line/armeria/pull/3182#discussion_r524841232", "createdAt": "2020-11-17T02:18:30Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -482,11 +533,26 @@ public static String requestContextStorageProvider() {\n      *\n      * <p>This flag is enabled by default for supported platforms. Specify the\n      * {@code -Dcom.linecorp.armeria.useEpoll=false} JVM option to disable it.\n+     *\n+     * @deprecated Use {@link #defaultTransportType()} and {@code -Dcom.linecorp.armeria.transportType=epoll}.\n      */\n+    @Deprecated\n     public static boolean useEpoll() {\n         return USE_EPOLL;\n     }\n \n+    /**\n+     * Returns the {@link TransportType} that will be used for socket I/O in Armeria.\n+     *\n+     * <p>The default value of this flag is {@link #DEFAULT_TRANSPORT_TYPE_SPEC}, which retains", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bbf81a1e35b489d3ad465fa3362626198e1ba2"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MDY5MTc2OnYy", "diffSide": "RIGHT", "path": "core/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjozNDoxNVrOH0iD9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjozNDoxNVrOH0iD9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0NjA3MA==", "bodyText": "Is it better to use optionalImplementation?", "url": "https://github.com/line/armeria/pull/3182#discussion_r524846070", "createdAt": "2020-11-17T02:34:15Z", "author": {"login": "ikhoon"}, "path": "core/build.gradle", "diffHunk": "@@ -113,6 +113,7 @@ dependencies {\n     implementation \"io.netty:netty-transport-native-epoll:${managedVersions['io.netty:netty-transport-native-epoll']}:linux-x86_64\"\n     implementation 'io.netty:netty-tcnative-boringssl-static'\n     implementation 'io.netty:netty-handler-proxy'\n+    implementation \"io.netty.incubator:netty-incubator-transport-native-io_uring:${managedVersions['io.netty.incubator:netty-incubator-transport-native-io_uring']}:linux-x86_64\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bbf81a1e35b489d3ad465fa3362626198e1ba2"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTMxMTQzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMTozOToyNlrOH2JMFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMTozOToyNlrOH2JMFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUzNTcwMw==", "bodyText": "can remove this line?", "url": "https://github.com/line/armeria/pull/3182#discussion_r526535703", "createdAt": "2020-11-19T01:39:26Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -384,9 +410,30 @@\n                     logger.info(\"/dev/epoll not available: ?\");\n                 }\n             }\n-        } else if (USE_EPOLL) {\n-            logger.info(\"Using /dev/epoll\");\n         }\n+        TransportType type = null;\n+        switch (TRANSPORT_TYPE_NAME) {\n+            case \"io_uring\":\n+                if (isIoUringAvailable()) {\n+                    logger.info(\"Using io_uring\");\n+                    type = TransportType.IO_URING;\n+                }\n+                // fallthrough\n+            case \"epoll\":\n+                if (isEpollAvailable() && type == null) {\n+                    logger.info(\"Using /dev/epoll\");\n+                    type = TransportType.EPOLL;\n+                }\n+                // fallthrough\n+            case \"nio\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTM1MjY1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMTo1ODoyM1rOH2JkFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNjoyNTo1MVrOH2ObFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU0MTg0NA==", "bodyText": "Shouldn't we access this IOUring class using reflection in case the dependency is not on the classpath when a user uses it?", "url": "https://github.com/line/armeria/pull/3182#discussion_r526541844", "createdAt": "2020-11-19T01:58:23Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -373,6 +391,14 @@\n     private static final boolean VALIDATE_HEADERS = getBoolean(\"validateHeaders\", true);\n \n     static {\n+        if (!isIoUringAvailable()) {\n+            final Throwable cause = IOUring.unavailabilityCause();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYyMTQ2Mw==", "bodyText": "How about just adding it as a required dependency? It shouldn't be that large I guess. (120KB)", "url": "https://github.com/line/armeria/pull/3182#discussion_r526621463", "createdAt": "2020-11-19T06:25:51Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -373,6 +391,14 @@\n     private static final boolean VALIDATE_HEADERS = getBoolean(\"validateHeaders\", true);\n \n     static {\n+        if (!isIoUringAvailable()) {\n+            final Throwable cause = IOUring.unavailabilityCause();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU0MTg0NA=="}, "originalCommit": {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwMTkwMjU1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/TransportType.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNjoyODoxMFrOH2OeIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNjoyODoxMFrOH2OeIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYyMjI0Mg==", "bodyText": "Could we remove this method now that we can just use Flags.transportType()?", "url": "https://github.com/line/armeria/pull/3182#discussion_r526622242", "createdAt": "2020-11-19T06:28:10Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/TransportType.java", "diffHunk": "@@ -76,11 +84,7 @@\n      * Returns the available {@link TransportType}.\n      */\n     public static TransportType detectTransportType() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2044, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}