{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MjEzNTg3", "number": 2898, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNToyNToxM1rOEOh_Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwOTo0MzoxMlrOEQFDgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzNjcyMzU4OnYy", "diffSide": "RIGHT", "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNToyNToxM1rOGxuxgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwODozMzo1MFrOGxz9RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc5OTc0Nw==", "bodyText": "You don't need to set service tag. :-)\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java\n    \n    \n        Lines 108 to 111\n      in\n      7f3295f\n    \n    \n    \n    \n\n        \n          \n           final String serviceName = log.serviceName(); \n        \n\n        \n          \n           if (serviceName != null) { \n        \n\n        \n          \n               tagListBuilder.add(Tag.of(\"service\", serviceName)); \n        \n\n        \n          \n           }", "url": "https://github.com/line/armeria/pull/2898#discussion_r454799747", "createdAt": "2020-07-15T05:25:13Z", "author": {"login": "ikhoon"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "diffHunk": "@@ -147,6 +148,11 @@ public static void configureServerWithArmeriaSettings(ServerBuilder server, Arme\n                     DropwizardSupport.addExposition(settings, server, meterRegistry);\n                 }\n             }\n+\n+            server.decorator(MetricCollectingService.newDecorator(\n+                    MeterIdPrefixFunction.ofDefault(\"armeria.server\")\n+                                         .andThen((registry, log, meterIdPrefix) -> meterIdPrefix.withTags(\n+                                                 \"service\", log.serviceName()))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgwMzEyOA==", "bodyText": "I think we should remove the following method to avoid duplicate collecting.\n\n  \n    \n      armeria/spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java\n    \n    \n        Lines 339 to 349\n      in\n      8c9c81f\n    \n    \n    \n    \n\n        \n          \n           private static HttpService setupMetricCollectingService( \n        \n\n        \n          \n                   HttpService service, AbstractServiceRegistrationBean<?, ?, ?, ?> bean, \n        \n\n        \n          \n                   @Nullable MeterIdPrefixFunctionFactory meterIdPrefixFunctionFactory) { \n        \n\n        \n          \n               requireNonNull(service, \"service\"); \n        \n\n        \n          \n               requireNonNull(bean, \"bean\"); \n        \n\n        \n          \n            \n        \n\n        \n          \n               if (meterIdPrefixFunctionFactory == null) { \n        \n\n        \n          \n                   return service; \n        \n\n        \n          \n               } \n        \n\n        \n          \n               return service.decorate(metricCollectingServiceDecorator(bean, meterIdPrefixFunctionFactory)); \n        \n\n        \n          \n           }", "url": "https://github.com/line/armeria/pull/2898#discussion_r454803128", "createdAt": "2020-07-15T05:36:55Z", "author": {"login": "ikhoon"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "diffHunk": "@@ -147,6 +148,11 @@ public static void configureServerWithArmeriaSettings(ServerBuilder server, Arme\n                     DropwizardSupport.addExposition(settings, server, meterRegistry);\n                 }\n             }\n+\n+            server.decorator(MetricCollectingService.newDecorator(\n+                    MeterIdPrefixFunction.ofDefault(\"armeria.server\")\n+                                         .andThen((registry, log, meterIdPrefix) -> meterIdPrefix.withTags(\n+                                                 \"service\", log.serviceName()))));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc5OTc0Nw=="}, "originalCommit": {"oid": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg4NDY3Ng==", "bodyText": "Oops, I missed this comment. \ud83d\ude04", "url": "https://github.com/line/armeria/pull/2898#discussion_r454884676", "createdAt": "2020-07-15T08:33:50Z", "author": {"login": "minwoox"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "diffHunk": "@@ -147,6 +148,11 @@ public static void configureServerWithArmeriaSettings(ServerBuilder server, Arme\n                     DropwizardSupport.addExposition(settings, server, meterRegistry);\n                 }\n             }\n+\n+            server.decorator(MetricCollectingService.newDecorator(\n+                    MeterIdPrefixFunction.ofDefault(\"armeria.server\")\n+                                         .andThen((registry, log, meterIdPrefix) -> meterIdPrefix.withTags(\n+                                                 \"service\", log.serviceName()))));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc5OTc0Nw=="}, "originalCommit": {"oid": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1Mjk1NDkwOnYy", "diffSide": "RIGHT", "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwOTo0MzoxMlrOG0DDkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwOTo0MzoxMlrOG0DDkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIyOTIwMw==", "bodyText": "Could you remove this method?", "url": "https://github.com/line/armeria/pull/2898#discussion_r457229203", "createdAt": "2020-07-20T09:43:12Z", "author": {"login": "minwoox"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "diffHunk": "@@ -336,18 +328,6 @@ public static void configureAnnotatedServices(\n         }\n     }\n \n-    private static HttpService setupMetricCollectingService(\n-            HttpService service, AbstractServiceRegistrationBean<?, ?, ?, ?> bean,\n-            @Nullable MeterIdPrefixFunctionFactory meterIdPrefixFunctionFactory) {\n-        requireNonNull(service, \"service\");\n-        requireNonNull(bean, \"bean\");\n-\n-        if (meterIdPrefixFunctionFactory == null) {\n-            return service;\n-        }\n-        return service.decorate(metricCollectingServiceDecorator(bean, meterIdPrefixFunctionFactory));\n-    }\n-\n     private static Function<? super HttpService, MetricCollectingService> metricCollectingServiceDecorator(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a6d0f4f70a45e863081fa501ac77b3dbf13a34a"}, "originalPosition": 106}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2094, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}