{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MTM2NDEz", "number": 2993, "title": "Fix leaks in tests of DynamicBehaviorHandler and others", "bodyText": "Motivation:\nDynamicBehaviorHandler could cause unexpected leak problem base on the following scenario:\n\nTests related to socks are finished successfully.\nThe socks decoder tries to pass the remain ByteBufs to a next handler.\nA test that is not related to socks changes a handler logic via DYNAMIC_HANDLER.setXXX().\nThe data produced in 2) is passed to the handler made in 3).\nThe new handler produces ClassCastException when receiving unexpected messages.\n\njava.lang.ClassCastException:\n  class io.netty.buffer.AdvancedLeakAwareByteBuf cannot be cast to\n  class io.netty.handler.codec.http.HttpRequest (io.netty.buffer.AdvancedLeakAwareByteBuf and io.netty.handler.codec.http.HttpRequest are in unnamed module of loader 'app')\n at com.linecorp.armeria.client.proxy.ProxyClientIntegrationTest.lambda$testHttpProxyUpgradeRequestFailure$0(ProxyClientIntegrationTest.java:387)\nModifications:\n\nRename DynamicBehaviorHandler to SimpleChannelHandler and remove @Sharable\nAdd SimpleChannelHandlerFactory for creating a ChannelHandler easily.\nCreate ChannelHandler for every connection instead of mutating DYNAMIC_BEHAVIOR in proxy tests.\nMiscellaneous\n\nClose ClientFatorys where they are not closed in test cases.\n\n\n\nResult:\n\nClean up various leaks in test cases", "createdAt": "2020-08-13T04:19:17Z", "url": "https://github.com/line/armeria/pull/2993", "merged": true, "mergeCommit": {"oid": "a5ed77316f77cf2bba4e670ac213da2216dddba8"}, "closed": true, "closedAt": "2020-08-13T08:20:58Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-YKJ6AH2gAyNDY3MTM2NDEzOjI3MWI0ZGM2NTNhNTY0MjUxNjAwZTEyODU4ZWNmMWQwNzI2MWE1NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-bo_oAFqTQ2NjU0NDYyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "271b4dc653a564251600e12858ecf1d07261a548", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/271b4dc653a564251600e12858ecf1d07261a548", "committedDate": "2020-08-13T04:18:12Z", "message": "Fix leaks in tests of DynamicBehaviorHandler and others\n\nMotivation:\n\nDynamicBehaviorHandler could cause unexpected leak problem base on the following scenario:\n1. Tests related to socks are finished successfully.\n2. The socks decoder tries to pass the remain `ByteBuf`s to a next handler.\n3. A test that is not related to socks changes a handler logic via DYNAMIC_HANDLER.setXXX().\n4. The data produced in 2) is passed to the handler made in 3).\n5. The new handler produces ClassCastException when receiving unexpected messages.\n\n```java\njava.lang.ClassCastException:\n  class io.netty.buffer.AdvancedLeakAwareByteBuf cannot be cast to\n  class io.netty.handler.codec.http.HttpRequest (io.netty.buffer.AdvancedLeakAwareByteBuf and io.netty.handler.codec.http.HttpRequest are in unnamed module of loader 'app')\n at com.linecorp.armeria.client.proxy.ProxyClientIntegrationTest.lambda$testHttpProxyUpgradeRequestFailure$0(ProxyClientIntegrationTest.java:387)\n```\n\nModifications:\n\n- Rename DynamicBehaviorHandler to SimpleChannelHandler and remove `@Shareable`\n- Add `SimpleChannelHandlerFactory` for creating a ChannelHandler easily.\n- Create `ChannelHandler` for every connection instead of mutating `DYNAMIC_BEHAVIOR` in proxy tests.\n- Miscellaneous\n  - Close `ClientFatory`s where they are not closed in test cases.\n\nResult:\n\n- Clean up various leaks in test cases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NDM0NzMy", "url": "https://github.com/line/armeria/pull/2993#pullrequestreview-466434732", "createdAt": "2020-08-13T04:24:42Z", "commit": {"oid": "271b4dc653a564251600e12858ecf1d07261a548"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNDoyNDo0MlrOG_7hjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QwNDoyNDo0MlrOG_7hjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY4ODcxNg==", "bodyText": "Can't use closeAsync?", "url": "https://github.com/line/armeria/pull/2993#discussion_r469688716", "createdAt": "2020-08-13T04:24:42Z", "author": {"login": "minwoox"}, "path": "spring/boot2-autoconfigure/src/test/java/com/linecorp/armeria/spring/LocalArmeriaPortHttpsTest.java", "diffHunk": "@@ -66,6 +69,11 @@ private String newUrl(String scheme) {\n         return scheme + \"://127.0.0.1:\" + port;\n     }\n \n+    @AfterClass\n+    public static void closeClientFactory() {\n+        CompletableFuture.runAsync(clientFactory::close);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "271b4dc653a564251600e12858ecf1d07261a548"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39aced01c08d368bc9a915e70b2cdc8901cbafcd", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/39aced01c08d368bc9a915e70b2cdc8901cbafcd", "committedDate": "2020-08-13T04:49:22Z", "message": "Use 'clientFactory.closeAsync()' where possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0470d345401eee686848bb26d4c3973ccca0d220", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/0470d345401eee686848bb26d4c3973ccca0d220", "committedDate": "2020-08-13T04:56:46Z", "message": "Revert changed in HttpClientMaxConcurrentStreamTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a40b4265188a18b1bc0275f4b6df69406e48f160", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/a40b4265188a18b1bc0275f4b6df69406e48f160", "committedDate": "2020-08-13T05:55:29Z", "message": "Add default handler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5166954f7f2abb9fd468ef2040204b507513c21f", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/5166954f7f2abb9fd468ef2040204b507513c21f", "committedDate": "2020-08-13T07:29:21Z", "message": "Make SimpleChannelHandler public"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NTQ0NjIz", "url": "https://github.com/line/armeria/pull/2993#pullrequestreview-466544623", "createdAt": "2020-08-13T08:21:36Z", "commit": {"oid": "5166954f7f2abb9fd468ef2040204b507513c21f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 60, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}