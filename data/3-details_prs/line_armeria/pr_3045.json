{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NTg3NzI4", "number": 3045, "title": "Fix a bug where Armeria client closes a connection when receiving an HTTP2 stream initiated by server", "bodyText": "Motivation:\nArmeria client does not support HTTP2 PUSH_PROMISE that initiates a stream from the server.\nArmeria client just ignores PUSH_PROMISE frame.\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/client/Http2ResponseDecoder.java\n    \n    \n        Lines 287 to 288\n      in\n      744098d\n    \n    \n    \n    \n\n        \n          \n           public void onPushPromiseRead(ChannelHandlerContext ctx, int streamId, int promisedStreamId, \n        \n\n        \n          \n                                         Http2Headers headers, int padding) {} \n        \n    \n  \n\n\nIt is incorrect behavior on a recipient that wants to reject PUSH_PROMISE.\nFrom the HTTP2 spec, the recipient should return RST_STREAM to reject PUSH_PROMISE.\nhttps://tools.ietf.org/html/rfc7540#section-6.6\n\nRecipients of PUSH_PROMISE frames can choose to reject promised\nstreams by returning a RST_STREAM referencing the promised stream\nidentifier back to the sender of the PUSH_PROMISE.\n\nA server does not receive RST_STREAM on PUSH_PROMISE, so the server starts sending HEADERS and DATA using the promised stream ID.\nHowever, Armeria client regards the promised stream ID as an unknown stream ID and closes the connection.\nModifications:\n\nSet 0 to SETTINGS_ENABLE_PUSH for the initial settings.\n\nResult:\n\nArmeria client tells the server that it doesn't expect PUSH_PROMISE.", "createdAt": "2020-09-03T12:13:39Z", "url": "https://github.com/line/armeria/pull/3045", "merged": true, "mergeCommit": {"oid": "6ffb3614472e00f2af3d9db03b4d1df82f53eaaf"}, "closed": true, "closedAt": "2020-09-11T08:03:57Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFPhvOgH2gAyNDc4NTg3NzI4OmI2NDZiMGNjMWJkNTEwZTQ0MGRhNWE5ZGZlYjc5NWU3OTZiZmVjNjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHZCYcAH2gAyNDc4NTg3NzI4OjgyNGNjNjg0NGJmZDlhNmMxMTU5NjdiN2NkOGRmYjMwMTk3ZGI1Y2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b646b0cc1bd510e440da5a9dfeb795e796bfec63", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/b646b0cc1bd510e440da5a9dfeb795e796bfec63", "committedDate": "2020-09-03T12:12:17Z", "message": "Fix a bug where Armeria client closes a connection when receiving an HTTP2 stream initiated by server.\n\nMotivation:\n\nArmeria client does not support HTTP2 `PUSH_PROMISE` that initiates a stream from the server.\nArmeria client just ignores `PUSH_PROMISE` frame.\nhttps://github.com/line/armeria/blob/744098d4ed83a65c6668fd863afebae14f5e2a1c/core/src/main/java/com/linecorp/armeria/client/Http2ResponseDecoder.java#L287-L288\nIt is not correct behavior on a recipient that wants to reject `PUSH_PROMISE`.\nFrom the HTTP2 spec, the recipient should return `RST_STREAM` to reject `PUSH_PROMISE`.\n\n> Recipients of PUSH_PROMISE frames can choose to reject promised\n  streams by returning a RST_STREAM referencing the promised stream\n  identifier back to the sender of the PUSH_PROMISE.\n\nA server, which does not receive `RST_STREAM` on `PUSH_PROMISE`, sends HEADERS and DATA using the promised stream ID.\nHowever, Armeria client regards the promised stream ID is an unknown stream and closes the connection.\n\nModifications:\n\n- Send a `RST_STREAM` referencing the promised stream ID when receiving `PUSH_PROMISED`\n\nResult:\n\n- Armeria client rejects `PUSH_PROMISE` frame correctly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96f07da4d4c8131da29e956121f3b5384f62de35", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/96f07da4d4c8131da29e956121f3b5384f62de35", "committedDate": "2020-09-03T12:17:20Z", "message": "Add final"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f0a24d71bcf0940bd4f837801335a4f37b841de", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/4f0a24d71bcf0940bd4f837801335a4f37b841de", "committedDate": "2020-09-04T01:45:34Z", "message": "Clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01c13a776f638a9c4e604c6afd439c37c1715442", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/01c13a776f638a9c4e604c6afd439c37c1715442", "committedDate": "2020-09-07T03:11:07Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMjE4ODg2", "url": "https://github.com/line/armeria/pull/3045#pullrequestreview-483218886", "createdAt": "2020-09-07T03:17:00Z", "commit": {"oid": "01c13a776f638a9c4e604c6afd439c37c1715442"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15219b252f19d12a3cf499c3ef6a540ebf36972f", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/15219b252f19d12a3cf499c3ef6a540ebf36972f", "committedDate": "2020-09-09T08:23:19Z", "message": "Fix flaky test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2864e58c6628258d1bf75d44844ba0f5a6318d64", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/2864e58c6628258d1bf75d44844ba0f5a6318d64", "committedDate": "2020-09-09T11:45:24Z", "message": "Address comments by @minwoox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "355dca260f126126b264dee0006239100bf1634f", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/355dca260f126126b264dee0006239100bf1634f", "committedDate": "2020-09-09T12:18:59Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b7e9f68271acdda9a0daa74b6d201f7118858d5", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/0b7e9f68271acdda9a0daa74b6d201f7118858d5", "committedDate": "2020-09-09T15:19:32Z", "message": "Fix broken tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faf6c6f6495e8e200a55483355c8ecceb9d134e8", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/faf6c6f6495e8e200a55483355c8ecceb9d134e8", "committedDate": "2020-09-09T15:20:58Z", "message": "Indent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NTA2NzYz", "url": "https://github.com/line/armeria/pull/3045#pullrequestreview-485506763", "createdAt": "2020-09-10T01:34:18Z", "commit": {"oid": "faf6c6f6495e8e200a55483355c8ecceb9d134e8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMTozNDoxOFrOHPfvSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwMTozNDoxOFrOHPfvSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAxMDY5Ng==", "bodyText": "I'm a bit confused that these lines are not covered by tests. Is this a bug? \ud83d\ude05", "url": "https://github.com/line/armeria/pull/3045#discussion_r486010696", "createdAt": "2020-09-10T01:34:18Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/Http2ResponseDecoder.java", "diffHunk": "@@ -285,7 +285,10 @@ public void onRstStreamRead(ChannelHandlerContext ctx, int streamId, long errorC\n \n     @Override\n     public void onPushPromiseRead(ChannelHandlerContext ctx, int streamId, int promisedStreamId,\n-                                  Http2Headers headers, int padding) {}\n+                                  Http2Headers headers, int padding) {\n+        encoder.writeRstStream(ctx, promisedStreamId, Http2Error.REFUSED_STREAM.code(), ctx.newPromise());\n+        ctx.flush();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faf6c6f6495e8e200a55483355c8ecceb9d134e8"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "824cc6844bfd9a6c115967b7cd8dfb30197db5ca", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/824cc6844bfd9a6c115967b7cd8dfb30197db5ca", "committedDate": "2020-09-10T04:24:56Z", "message": "Revert RST_STREAM in onPushPromiseRead"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4630, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}