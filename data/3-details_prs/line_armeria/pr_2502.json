{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MjIyMTk2", "number": 2502, "title": "Add not to bind on the specific port(s) from Spring Boot (Actuator)", "bodyText": "Motivation:\n\nRelated #2408\n\nModifications:\n\nCopy ArmeriaSetting to boot-actuator-autoconfigure\nIf management.server.port is set, protect all services under /internal/ and actuator services on other ports.\nIf management.server.port is set, support @LocalManagementPort\nAdd test\n\nResult:\n\nFixes: #2408", "createdAt": "2020-02-17T16:21:44Z", "url": "https://github.com/line/armeria/pull/2502", "merged": true, "mergeCommit": {"oid": "9716098cffceb38e607913caceb695a6c22e99a9"}, "closed": true, "closedAt": "2020-06-04T06:23:24Z", "author": {"login": "heowc"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFPmtxAH2gAyMzc2MjIyMTk2OmI1MTBhNjdkOGNjYzNjMWRkZDA3MWJkODRjM2JkMDk0MTIxODdlYjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnqJaEgH2gAyMzc2MjIyMTk2OjI1NGI0NjM0NmJjODY5MTkzMzllY2E5MTBmNGRhOWYzNzM0N2M3Nzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b510a67d8ccc3c1ddd071bd84c3bd09412187eb7", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/b510a67d8ccc3c1ddd071bd84c3bd09412187eb7", "committedDate": "2020-02-17T16:06:34Z", "message": "Add not to bind on the specific port(s) from spring boot (actuator)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNjg3Mzkz", "url": "https://github.com/line/armeria/pull/2502#pullrequestreview-361687393", "createdAt": "2020-02-20T07:46:37Z", "commit": {"oid": "86ebe6f6ea13a5bbc070a3bc516a227784cf2d04"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNzo0NjozOFrOFsJCEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwNzo0NjozOFrOFsJCEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTgyOTY0OQ==", "bodyText": "Question: Is it possible to use management.server.port instead?", "url": "https://github.com/line/armeria/pull/2502#discussion_r381829649", "createdAt": "2020-02-20T07:46:38Z", "author": {"login": "trustin"}, "path": "spring/boot-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaSettings.java", "diffHunk": "@@ -61,6 +61,9 @@\n  *     mime-types: text/*, application/json\n  *     excluded-user-agents: some-user-agent, another-user-agent\n  *     min-response-size: 1KB\n+ *   security:\n+ *     enabled: true\n+ *     ports: 8080", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86ebe6f6ea13a5bbc070a3bc516a227784cf2d04"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "86ebe6f6ea13a5bbc070a3bc516a227784cf2d04", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/86ebe6f6ea13a5bbc070a3bc516a227784cf2d04", "committedDate": "2020-02-19T14:02:52Z", "message": "Fix test"}, "afterCommit": {"oid": "c65134ed5beb53e8fcc4b2003f278f72dfb8546f", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/c65134ed5beb53e8fcc4b2003f278f72dfb8546f", "committedDate": "2020-02-18T15:15:42Z", "message": "Fix checkstyle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4a8afa0887abc04f1ae46310bb484465d60fd5c", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/d4a8afa0887abc04f1ae46310bb484465d60fd5c", "committedDate": "2020-02-24T14:59:39Z", "message": "Add port binding to `management.server.port`"}, "afterCommit": {"oid": "b510a67d8ccc3c1ddd071bd84c3bd09412187eb7", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/b510a67d8ccc3c1ddd071bd84c3bd09412187eb7", "committedDate": "2020-02-17T16:06:34Z", "message": "Add not to bind on the specific port(s) from spring boot (actuator)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b7954317af2c19465972eccdf0788352ceda69f0", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/b7954317af2c19465972eccdf0788352ceda69f0", "committedDate": "2020-02-25T15:48:00Z", "message": "Update the project version to 0.98.4-SNAPSHOT"}, "afterCommit": {"oid": "b510a67d8ccc3c1ddd071bd84c3bd09412187eb7", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/b510a67d8ccc3c1ddd071bd84c3bd09412187eb7", "committedDate": "2020-02-17T16:06:34Z", "message": "Add not to bind on the specific port(s) from spring boot (actuator)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f52afeb4af4631d626f8d45cd9742a37922425d6", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/f52afeb4af4631d626f8d45cd9742a37922425d6", "committedDate": "2020-02-25T15:49:19Z", "message": "Merge branch 'master' into secure_spring_actuator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da2dfa1e235ed9dc5e8e9b9b218df77b79c9fa60", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/da2dfa1e235ed9dc5e8e9b9b218df77b79c9fa60", "committedDate": "2020-02-25T15:56:34Z", "message": "Add not to bind on the specific port(s) from spring boot (actuator)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ada5459a098550ed4a0d62b967d2fc840c9e176c", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/ada5459a098550ed4a0d62b967d2fc840c9e176c", "committedDate": "2020-02-26T12:55:04Z", "message": "Add `SecurityInternalService`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1016fd0761a0ecf2d76823cc633a490bce2e68f", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/e1016fd0761a0ecf2d76823cc633a490bce2e68f", "committedDate": "2020-02-27T14:38:55Z", "message": "Replace all tests in 'spring-boot-auticonfigure' with JUnit5"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29eb21893762db3f293d2642026a165d6f11492b", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/29eb21893762db3f293d2642026a165d6f11492b", "committedDate": "2020-02-27T15:05:02Z", "message": "Fix comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "981ab03630c7127d61848343b3165584819c6865", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/981ab03630c7127d61848343b3165584819c6865", "committedDate": "2020-02-27T15:01:14Z", "message": "Fix comment"}, "afterCommit": {"oid": "e1016fd0761a0ecf2d76823cc633a490bce2e68f", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/e1016fd0761a0ecf2d76823cc633a490bce2e68f", "committedDate": "2020-02-27T14:38:55Z", "message": "Replace all tests in 'spring-boot-auticonfigure' with JUnit5"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NzQ3Mjcz", "url": "https://github.com/line/armeria/pull/2502#pullrequestreview-365747273", "createdAt": "2020-02-27T15:16:35Z", "commit": {"oid": "29eb21893762db3f293d2642026a165d6f11492b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNToxNjozNlrOFvVXOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNToxNjozNlrOFvVXOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE3NzQwMA==", "bodyText": "I changed all test cases in boot-autoconfigure to JUnit5. The test ran twice, showing unintended failures in certain situations.", "url": "https://github.com/line/armeria/pull/2502#discussion_r385177400", "createdAt": "2020-02-27T15:16:36Z", "author": {"login": "heowc"}, "path": "spring/boot-autoconfigure/build.gradle", "diffHunk": "@@ -15,5 +15,7 @@ dependencies {\n     testImplementation project(':grpc')\n     testImplementation project(':thrift')\n     testImplementation 'org.springframework.boot:spring-boot-starter-actuator'\n-    testImplementation 'org.springframework.boot:spring-boot-starter-test'\n+    testImplementation ('org.springframework.boot:spring-boot-starter-test') {\n+        exclude group: 'org.junit.vintage', module: 'junit-vintage-engine'\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29eb21893762db3f293d2642026a165d6f11492b"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50a5fc186534da8c06d6bce46a7d432683ead09b", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/50a5fc186534da8c06d6bce46a7d432683ead09b", "committedDate": "2020-03-01T07:01:23Z", "message": "Rename to `InternalSecurityService`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b59aa6a36dddbabdca506c34f83eaa1f46ab0416", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/b59aa6a36dddbabdca506c34f83eaa1f46ab0416", "committedDate": "2020-03-05T16:27:15Z", "message": "Revert \"Replace all tests in 'spring-boot-auticonfigure' with JUnit5\"\n\nThis reverts commit e1016fd0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aab20619405b047df0dd0fe20007c372d2b11802", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/aab20619405b047df0dd0fe20007c372d2b11802", "committedDate": "2020-03-05T16:41:49Z", "message": "Replace to JUnit4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b32d88e3443e42f86eea83635af66504a90397ff", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/b32d88e3443e42f86eea83635af66504a90397ff", "committedDate": "2020-05-09T07:36:26Z", "message": "Merge branch 'master' into secure_spring_actuator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5045b8e71dd491f9c2b0de77ea3e2ecf75db65d6", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/5045b8e71dd491f9c2b0de77ea3e2ecf75db65d6", "committedDate": "2020-05-12T14:16:39Z", "message": "Merge remote-tracking branch 'armeria/master' into secure_spring_actuator\n\n# Conflicts:\n#\tspring/boot-webflux-autoconfigure/build.gradle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "975cfc89a1576996fdedc14d98c5bf59299253e3", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/975cfc89a1576996fdedc14d98c5bf59299253e3", "committedDate": "2020-05-12T15:15:27Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9594a93eb3cb4edebb692d097f4b47513b26b7d", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/e9594a93eb3cb4edebb692d097f4b47513b26b7d", "committedDate": "2020-05-13T15:13:42Z", "message": "Merge remote-tracking branch 'armeria/master' into secure_spring_actuator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bce8cb36b4ea68b7bc666a35d7e3f3789b0c8402", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/bce8cb36b4ea68b7bc666a35d7e3f3789b0c8402", "committedDate": "2020-05-13T15:17:45Z", "message": "Support `@LocalManagementPort` / Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ddcf35cb374de1abf4e3d36b460d9547bb66dcc", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/1ddcf35cb374de1abf4e3d36b460d9547bb66dcc", "committedDate": "2020-05-13T15:19:52Z", "message": "Fix method order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12b46d4d06afcbb32b772f521cf358a93358ae23", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/12b46d4d06afcbb32b772f521cf358a93358ae23", "committedDate": "2020-05-17T07:32:07Z", "message": "Merge remote-tracking branch 'armeria/master' into secure_spring_actuator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "324064d471497bf251c1a691b9c33372747f2620", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/324064d471497bf251c1a691b9c33372747f2620", "committedDate": "2020-05-17T12:38:22Z", "message": "Add internal port(8001) & test code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NjI1Nzg4", "url": "https://github.com/line/armeria/pull/2502#pullrequestreview-416625788", "createdAt": "2020-05-22T03:28:39Z", "commit": {"oid": "37c34a20111065f1debb4827a82c6c4392738495"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMzoyODozOVrOGZJkZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMzoyODozOVrOGZJkZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAyNDM1OQ==", "bodyText": "I fetched Spring Actuator related fields to solve what I mentioned. I am not sure if this is a good way. what do you think?", "url": "https://github.com/line/armeria/pull/2502#discussion_r429024359", "createdAt": "2020-05-22T03:28:39Z", "author": {"login": "heowc"}, "path": "spring/boot-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaSecurityAutoConfiguration.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.spring;\n+\n+import static com.linecorp.armeria.internal.spring.ArmeriaConfigurationUtil.configurePorts;\n+\n+import java.net.InetSocketAddress;\n+import java.util.Optional;\n+\n+import javax.annotation.Nullable;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.context.properties.EnableConfigurationProperties;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.core.env.ConfigurableEnvironment;\n+import org.springframework.core.env.PropertySource;\n+import org.springframework.util.SocketUtils;\n+\n+import com.google.common.base.Strings;\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.server.DecoratingServiceBindingBuilder;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.spring.ArmeriaSettings.Port;\n+\n+/**\n+ * Spring Boot {@link Configuration} that provides Armeria integration.\n+ */\n+@Configuration\n+@EnableConfigurationProperties(ArmeriaSettings.class)\n+public class ArmeriaSecurityAutoConfiguration {\n+\n+    private static final Port DEFAULT_SECURITY_PORT = new Port().setPort(8001)\n+                                                                .setProtocol(SessionProtocol.HTTP);\n+\n+    @Bean\n+    ArmeriaServerConfigurator secureArmeriaServerConfig(ArmeriaSettings settings,\n+                                                        ConfigurableEnvironment environment,\n+                                                        @Value(\"${management.server.port:#{null}}\")\n+                                                        Integer actuatorPort,\n+                                                        @Value(\"${management.endpoints.web.base-path:#{null}}\")\n+                                                        String actuatorBasePath) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37c34a20111065f1debb4827a82c6c4392738495"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NjMxMzE2", "url": "https://github.com/line/armeria/pull/2502#pullrequestreview-416631316", "createdAt": "2020-05-22T03:51:50Z", "commit": {"oid": "37c34a20111065f1debb4827a82c6c4392738495"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMzo1MTo1MFrOGZJ2ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwMzo1MjoxOFrOGZJ25A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAyODk4Nw==", "bodyText": "Question: Should we expose this option or always enable it when a different management port was specified?", "url": "https://github.com/line/armeria/pull/2502#discussion_r429028987", "createdAt": "2020-05-22T03:51:50Z", "author": {"login": "trustin"}, "path": "spring/boot-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaSettings.java", "diffHunk": "@@ -61,6 +61,8 @@\n  *     mime-types: text/*, application/json\n  *     excluded-user-agents: some-user-agent, another-user-agent\n  *     min-response-size: 1KB\n+ *   security:\n+ *     enabled: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37c34a20111065f1debb4827a82c6c4392738495"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAyOTA5Mg==", "bodyText": "Missing newline", "url": "https://github.com/line/armeria/pull/2502#discussion_r429029092", "createdAt": "2020-05-22T03:52:18Z", "author": {"login": "trustin"}, "path": "spring/boot-autoconfigure/src/test/resources/config/application-secureTest.yml", "diffHunk": "@@ -0,0 +1,5 @@\n+armeria:\n+  ports:\n+    - port: 0\n+  security:\n+    enabled: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37c34a20111065f1debb4827a82c6c4392738495"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NjgxODA2", "url": "https://github.com/line/armeria/pull/2502#pullrequestreview-416681806", "createdAt": "2020-05-22T06:42:17Z", "commit": {"oid": "ab928676f4ca45d2e96b94fb4ed01fbfa6da6006"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNjo0MjoxN1rOGZMWKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNjo0MjoxN1rOGZMWKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA2OTg2NQ==", "bodyText": "Question: Where is the 8001 from? Spring uses it?", "url": "https://github.com/line/armeria/pull/2502#discussion_r429069865", "createdAt": "2020-05-22T06:42:17Z", "author": {"login": "minwoox"}, "path": "spring/boot-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaSecurityAutoConfiguration.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.spring;\n+\n+import static com.linecorp.armeria.internal.spring.ArmeriaConfigurationUtil.configurePorts;\n+\n+import java.net.InetSocketAddress;\n+import java.util.Optional;\n+\n+import javax.annotation.Nullable;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.boot.context.properties.EnableConfigurationProperties;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.core.env.ConfigurableEnvironment;\n+import org.springframework.core.env.PropertySource;\n+import org.springframework.util.SocketUtils;\n+\n+import com.google.common.base.Strings;\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.server.DecoratingServiceBindingBuilder;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.spring.ArmeriaSettings.Port;\n+\n+/**\n+ * Spring Boot {@link Configuration} that provides Armeria integration.\n+ */\n+@Configuration\n+@EnableConfigurationProperties(ArmeriaSettings.class)\n+public class ArmeriaSecurityAutoConfiguration {\n+\n+    private static final Port DEFAULT_SECURITY_PORT = new Port().setPort(8001)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab928676f4ca45d2e96b94fb4ed01fbfa6da6006"}, "originalPosition": 50}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab928676f4ca45d2e96b94fb4ed01fbfa6da6006", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/ab928676f4ca45d2e96b94fb4ed01fbfa6da6006", "committedDate": "2020-05-22T05:21:41Z", "message": "Fix"}, "afterCommit": {"oid": "324064d471497bf251c1a691b9c33372747f2620", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/324064d471497bf251c1a691b9c33372747f2620", "committedDate": "2020-05-17T12:38:22Z", "message": "Add internal port(8001) & test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bbc8fdaacc3e0df2b41b52f52385a82c71fb92e", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/9bbc8fdaacc3e0df2b41b52f52385a82c71fb92e", "committedDate": "2020-05-30T07:57:49Z", "message": "Remove property (`armeria.security.enabled`) & binding default port(8001)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ce24215966f0a05b5fd5a5429ad6c2e952b6baf", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/2ce24215966f0a05b5fd5a5429ad6c2e952b6baf", "committedDate": "2020-05-30T07:59:06Z", "message": "Merge remote-tracking branch 'armeria/master' into secure_spring_actuator\n\n# Conflicts:\n#\tspring/boot-actuator-autoconfigure/build.gradle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNjQ1MzQw", "url": "https://github.com/line/armeria/pull/2502#pullrequestreview-421645340", "createdAt": "2020-06-01T07:31:03Z", "commit": {"oid": "2ce24215966f0a05b5fd5a5429ad6c2e952b6baf"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzozMTowM1rOGdBTJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwNzozMToxOFrOGdBTcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4MzE3Mg==", "bodyText": "nit: Could just use int?", "url": "https://github.com/line/armeria/pull/2502#discussion_r433083172", "createdAt": "2020-06-01T07:31:03Z", "author": {"login": "trustin"}, "path": "spring/boot-actuator-autoconfigure/src/test/java/com/linecorp/armeria/spring/actuate/ArmeriaSpringActuatorAutoConfigurationTest.java", "diffHunk": "@@ -305,4 +288,52 @@ public void testOptions() {\n             assertThat(res.status()).isNotEqualTo(HttpStatus.METHOD_NOT_ALLOWED);\n         }\n     }\n+\n+    @Nested\n+    @SpringBootTest(classes = org.springframework.boot.test.context.TestConfiguration.class)\n+    @ActiveProfiles({ \"local\", \"secureTest\" })\n+    @DirtiesContext\n+    @EnableAutoConfiguration\n+    @ImportAutoConfiguration(ArmeriaSpringActuatorAutoConfiguration.class)\n+    @Timeout(10)\n+    class ArmeriaSpringActuatorAutoConfigurationSecureTest {\n+\n+        @SpringBootApplication\n+        class TestConfiguration {}\n+\n+        @LocalManagementPort\n+        private Integer actuatorPort;\n+        @Inject\n+        private Server server;\n+        @Inject\n+        private ArmeriaSettings settings;\n+\n+        @Test\n+        void normal() throws Exception {\n+            server.activePorts().values().stream()\n+                  .map(p -> p.localAddress().getPort())\n+                  .forEach(port -> {\n+                      final Integer statusCode = actuatorPort.equals(port) ? 200 : 404;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ce24215966f0a05b5fd5a5429ad6c2e952b6baf"}, "originalPosition": 245}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4MzI1MQ==", "bodyText": "Ditto - int should work?", "url": "https://github.com/line/armeria/pull/2502#discussion_r433083251", "createdAt": "2020-06-01T07:31:18Z", "author": {"login": "trustin"}, "path": "spring/boot-actuator-autoconfigure/src/test/java/com/linecorp/armeria/spring/actuate/ArmeriaSpringActuatorAutoConfigurationTest.java", "diffHunk": "@@ -305,4 +288,52 @@ public void testOptions() {\n             assertThat(res.status()).isNotEqualTo(HttpStatus.METHOD_NOT_ALLOWED);\n         }\n     }\n+\n+    @Nested\n+    @SpringBootTest(classes = org.springframework.boot.test.context.TestConfiguration.class)\n+    @ActiveProfiles({ \"local\", \"secureTest\" })\n+    @DirtiesContext\n+    @EnableAutoConfiguration\n+    @ImportAutoConfiguration(ArmeriaSpringActuatorAutoConfiguration.class)\n+    @Timeout(10)\n+    class ArmeriaSpringActuatorAutoConfigurationSecureTest {\n+\n+        @SpringBootApplication\n+        class TestConfiguration {}\n+\n+        @LocalManagementPort\n+        private Integer actuatorPort;\n+        @Inject\n+        private Server server;\n+        @Inject\n+        private ArmeriaSettings settings;\n+\n+        @Test\n+        void normal() throws Exception {\n+            server.activePorts().values().stream()\n+                  .map(p -> p.localAddress().getPort())\n+                  .forEach(port -> {\n+                      final Integer statusCode = actuatorPort.equals(port) ? 200 : 404;\n+                      assertStatus(port, \"/actuator\", statusCode);\n+                      assertStatus(port, \"/actuator/health\", statusCode);\n+                      assertStatus(port, \"/actuator/loggers/\" + TEST_LOGGER_NAME, statusCode);\n+                      assertStatus(port, \"/actuator/prometheus\", statusCode);\n+                      assertStatus(port, settings.getDocsPath(), statusCode);\n+                      assertStatus(port, settings.getHealthCheckPath(), statusCode);\n+                      assertStatus(port, settings.getMetricsPath(), statusCode);\n+                  });\n+        }\n+    }\n+\n+    private static void assertStatus(Integer port, String url, Integer statusCode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ce24215966f0a05b5fd5a5429ad6c2e952b6baf"}, "originalPosition": 257}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb9cf10ff7900e0b399e285f378a1ecd02944cfb", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/cb9cf10ff7900e0b399e285f378a1ecd02944cfb", "committedDate": "2020-06-01T07:52:17Z", "message": "Address comments by @trustin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMzA0MTE0", "url": "https://github.com/line/armeria/pull/2502#pullrequestreview-422304114", "createdAt": "2020-06-02T02:37:43Z", "commit": {"oid": "cb9cf10ff7900e0b399e285f378a1ecd02944cfb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMjozNzo0M1rOGdgL4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwMjozNzo0M1rOGdgL4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzU4OTIxOA==", "bodyText": "What happens if the management port number is not 0?", "url": "https://github.com/line/armeria/pull/2502#discussion_r433589218", "createdAt": "2020-06-02T02:37:43Z", "author": {"login": "minwoox"}, "path": "spring/boot-actuator-autoconfigure/src/main/java/com/linecorp/armeria/spring/actuate/ArmeriaSpringActuatorAutoConfiguration.java", "diffHunk": "@@ -196,6 +215,70 @@ ArmeriaServerConfigurator actuatorServerConfigurator(\n         };\n     }\n \n+    @Bean\n+    @ConditionalOnProperty(\"management.server.port\")\n+    ArmeriaServerConfigurator secureActuatorServerConfigurator(WebEndpointProperties properties,\n+                                                               ManagementServerProperties serverProperties,\n+                                                               ConfigurableEnvironment environment,\n+                                                               ArmeriaSettings armeriaSettings) {\n+        return sb -> {\n+            final Port port = obtainManagementServerPort(serverProperties.getPort());\n+            if (port != null) {\n+                configurePorts(sb, ImmutableList.of(port));\n+                addLocalManagementPortPropertyAlias(environment, port);\n+                configureSecureDecorator(sb, port, properties.getBasePath(), armeriaSettings);\n+            }\n+        };\n+    }\n+\n+    @Nullable\n+    private static Port obtainManagementServerPort(@Nullable Integer port) {\n+        return Optional.ofNullable(port)\n+                       .filter(it -> it.equals(0))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb9cf10ff7900e0b399e285f378a1ecd02944cfb"}, "originalPosition": 94}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a0811d0ae406b71fcc3b744bee2a66560899a35", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/3a0811d0ae406b71fcc3b744bee2a66560899a35", "committedDate": "2020-06-02T13:17:53Z", "message": "Fix `obtainManagementServerPort(...)`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5cbb56447a04d81d89b8b74e194f7fc3b9e6048", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/d5cbb56447a04d81d89b8b74e194f7fc3b9e6048", "committedDate": "2020-06-02T13:39:36Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMjI3MTI5", "url": "https://github.com/line/armeria/pull/2502#pullrequestreview-423227129", "createdAt": "2020-06-03T05:26:07Z", "commit": {"oid": "d5cbb56447a04d81d89b8b74e194f7fc3b9e6048"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMzkxNTk3", "url": "https://github.com/line/armeria/pull/2502#pullrequestreview-423391597", "createdAt": "2020-06-03T09:46:22Z", "commit": {"oid": "d5cbb56447a04d81d89b8b74e194f7fc3b9e6048"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOTo0NjoyM1rOGeUYZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwOTo0NjoyM1rOGeUYZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQ0NDM4OA==", "bodyText": "Question: Don't we need to support HTTPS? The upstream seems to support TLS/SSL configuration.\nhttps://docs.spring.io/spring-boot/docs/current/reference/html/production-ready-features.html#production-ready-management-specific-ssl\nIf that is worthy to handle, I think you can do it in the following PR. \ud83d\ude09", "url": "https://github.com/line/armeria/pull/2502#discussion_r434444388", "createdAt": "2020-06-03T09:46:23Z", "author": {"login": "ikhoon"}, "path": "spring/boot-actuator-autoconfigure/src/main/java/com/linecorp/armeria/spring/actuate/ArmeriaSpringActuatorAutoConfiguration.java", "diffHunk": "@@ -196,6 +215,67 @@ ArmeriaServerConfigurator actuatorServerConfigurator(\n         };\n     }\n \n+    @Bean\n+    @ConditionalOnProperty(\"management.server.port\")\n+    ArmeriaServerConfigurator secureActuatorServerConfigurator(WebEndpointProperties properties,\n+                                                               ManagementServerProperties serverProperties,\n+                                                               ConfigurableEnvironment environment,\n+                                                               ArmeriaSettings armeriaSettings) {\n+        return sb -> {\n+            final Port port = obtainManagementServerPort(serverProperties.getPort());\n+            configurePorts(sb, ImmutableList.of(port));\n+            addLocalManagementPortPropertyAlias(environment, port);\n+            configureSecureDecorator(sb, port, properties.getBasePath(), armeriaSettings);\n+        };\n+    }\n+\n+    private static Port obtainManagementServerPort(Integer port) {\n+        int actualPort = requireNonNull(port, \"port\");\n+        if (actualPort == 0) {\n+            actualPort = SocketUtils.findAvailableTcpPort();\n+        }\n+        return new Port().setPort(actualPort).setProtocol(SessionProtocol.HTTP);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5cbb56447a04d81d89b8b74e194f7fc3b9e6048"}, "originalPosition": 94}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "254b46346bc86919339eca910f4da9f37347c779", "author": {"user": {"login": "heowc", "name": "WonChul Heo"}}, "url": "https://github.com/line/armeria/commit/254b46346bc86919339eca910f4da9f37347c779", "committedDate": "2020-06-03T14:15:25Z", "message": "Disable if port is less than 0"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1013, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}