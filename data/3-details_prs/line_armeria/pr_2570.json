{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NTYzNTk2", "number": 2570, "title": "Add all HTTP methods to route when the method is empty", "bodyText": "Motivation:\nCheck out this code:\nsb.decorator((delegate, ctx, req) -> {\n    System.err.println(2);\n    return delegate.serve(ctx, req);\n});\nsb.routeDecorator().pathPrefix(\"/\").build((delegate, ctx, req) -> {\n    System.err.println(1);\n    return delegate.serve(ctx, req);\n});\nsb.decoratorUnder(\"/\", (delegate, ctx, req) -> {\n    System.err.println(3);\n    return delegate.serve(ctx, req);\n});\nThe executed order of decorators are a little messed becuase routeDecorator() has all HttpMethods set, but others don't.\nIf we set HttpMethods.knownMethods() when there's no method set for a route, the execution order of decorator will be the order they inserted.\nModifications:\n\nAdd HttpMethod.knownMethods() to the Route if it's empty.\n\nHowever, the logger name and metric don't include it because it's verbose.\n\n\n\nResult:\n\nRight decoration order.", "createdAt": "2020-03-11T09:05:12Z", "url": "https://github.com/line/armeria/pull/2570", "merged": true, "mergeCommit": {"oid": "cf243d1ec9d8186c18f536e443784c1626034220"}, "closed": true, "closedAt": "2020-03-11T13:41:31Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMjWfagH2gAyMzg2NTYzNTk2OjE4ZGEwMTBmNGE3ZGFlODIwNGM1NjMyYTI4MTdiYmMxOTc5MGRjNGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMlO5eAFqTM3MjY2NzY0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "18da010f4a7dae8204c5632a2817bbc19790dc4a", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/18da010f4a7dae8204c5632a2817bbc19790dc4a", "committedDate": "2020-03-11T09:04:25Z", "message": "Add all HTTP methods to route when the method is empty\nMotivation:\nCheck out this code:\n```java\nsb.decorator((delegate, ctx, req) -> {\n    System.err.println(2);\n    return delegate.serve(ctx, req);\n});\nsb.routeDecorator().pathPrefix(\"/\").build((delegate, ctx, req) -> {\n    System.err.println(1);\n    return delegate.serve(ctx, req);\n});\nsb.decoratorUnder(\"/\", (delegate, ctx, req) -> {\n    System.err.println(3);\n    return delegate.serve(ctx, req);\n});\n```\nThe executed order of decorators are a little messed becuase `routeDecorator()` has all `HttpMethod`s set, but others don't.\nIf we set `HttpMethods.knownMethods()` when there's no method set for a route, the execution order of decorator will be the order they inserted.\n\nModifications:\n- Add `HttpMethod.knownMethods()` to the `Route` if it's empty.\n  - However, the logger name and metric don't include it because it's verbose.\n\nResult:\n- Right decoration order."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNTg2MDM5", "url": "https://github.com/line/armeria/pull/2570#pullrequestreview-372586039", "createdAt": "2020-03-11T09:19:58Z", "commit": {"oid": "18da010f4a7dae8204c5632a2817bbc19790dc4a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwOToxOTo1OVrOF0uunA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwOToxOTo1OVrOF0uunA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDgzNTg2OA==", "bodyText": "(Maybe) don't we need to update methods.isEmpty() condition in apply(RoutingContext routingCtx)?\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/server/DefaultRoute.java\n    \n    \n         Line 99\n      in\n      3bc7bbd\n    \n    \n    \n    \n\n        \n          \n           if (!methods.isEmpty() && !methods.contains(routingCtx.method())) {", "url": "https://github.com/line/armeria/pull/2570#discussion_r390835868", "createdAt": "2020-03-11T09:19:59Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/DefaultRoute.java", "diffHunk": "@@ -244,7 +244,9 @@ private static String generateLoggerName(String prefix, Set<HttpMethod> methods,\n                                              List<RoutingPredicate<HttpHeaders>> headerPredicates) {\n         final StringJoiner name = new StringJoiner(\".\");\n         name.add(prefix);\n-        if (!methods.isEmpty()) {\n+\n+        // Skip if the methods is empty or it's knownMethods because it's verbose.\n+        if (!methods.isEmpty() && methods != HttpMethod.knownMethods()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18da010f4a7dae8204c5632a2817bbc19790dc4a"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35385c1e9484e6b4df1b1683e1708da988ce6a3e", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/35385c1e9484e6b4df1b1683e1708da988ce6a3e", "committedDate": "2020-03-11T09:33:15Z", "message": "Address comments by @trustin and @ikhoon"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNjA1NDM4", "url": "https://github.com/line/armeria/pull/2570#pullrequestreview-372605438", "createdAt": "2020-03-11T09:46:57Z", "commit": {"oid": "35385c1e9484e6b4df1b1683e1708da988ce6a3e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwOTo0Njo1N1rOF0vq2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwOTo0Njo1N1rOF0vq2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg1MTI5MA==", "bodyText": "You have to check null first.", "url": "https://github.com/line/armeria/pull/2570#discussion_r390851290", "createdAt": "2020-03-11T09:46:57Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/DefaultRoute.java", "diffHunk": "@@ -58,6 +59,7 @@\n                  List<RoutingPredicate<QueryParams>> paramPredicates,\n                  List<RoutingPredicate<HttpHeaders>> headerPredicates) {\n         this.pathMapping = requireNonNull(pathMapping, \"pathMapping\");\n+        checkArgument(!methods.isEmpty(), \"methods is empty.\");\n         this.methods = Sets.immutableEnumSet(requireNonNull(methods, \"methods\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35385c1e9484e6b4df1b1683e1708da988ce6a3e"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d6677e83a5cd9be7bb8d30188883efc648d4f10", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/5d6677e83a5cd9be7bb8d30188883efc648d4f10", "committedDate": "2020-03-11T09:52:53Z", "message": "Fix`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37afd0bbb69c77d6c8d70ab794011c12d194ea27", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/37afd0bbb69c77d6c8d70ab794011c12d194ea27", "committedDate": "2020-03-11T10:02:20Z", "message": "Use Sets.immutableEnumSet"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6c8b53732a72cc8b0b5525ceef089c8b649d4b1", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/e6c8b53732a72cc8b0b5525ceef089c8b649d4b1", "committedDate": "2020-03-11T10:03:28Z", "message": "Add null check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNjMwODM4", "url": "https://github.com/line/armeria/pull/2570#pullrequestreview-372630838", "createdAt": "2020-03-11T10:22:17Z", "commit": {"oid": "e6c8b53732a72cc8b0b5525ceef089c8b649d4b1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNjY3NjQw", "url": "https://github.com/line/armeria/pull/2570#pullrequestreview-372667640", "createdAt": "2020-03-11T11:15:56Z", "commit": {"oid": "e6c8b53732a72cc8b0b5525ceef089c8b649d4b1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 679, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}