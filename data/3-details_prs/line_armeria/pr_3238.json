{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNjYyMzA5", "number": 3238, "title": "Attempt re-registration when Eureka heart beat fails with 404 Not Found", "bodyText": "If instance  no longer registered with Eureka,  try to re-registration.", "createdAt": "2020-12-18T16:55:08Z", "url": "https://github.com/line/armeria/pull/3238", "merged": true, "mergeCommit": {"oid": "4c27df18a8576e482e5ed8e5508c3d2b8304d64b"}, "closed": true, "closedAt": "2021-01-27T09:48:06Z", "author": {"login": "eisig"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdpNUUCgFqTU1ODM0NjIwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdzAlAyABqjQyNDE3MDg0MzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MzQ2MjA4", "url": "https://github.com/line/armeria/pull/3238#pullrequestreview-558346208", "createdAt": "2020-12-24T05:38:45Z", "commit": {"oid": "244c327266d772b78a57310abf4305b524c3906e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNTozODo0NVrOIK_Vag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNTozODo0NVrOIK_Vag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM5NDM0Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                      logger.debug(\"Successfully send a heart beat to Eureka: {}\", client.uri());\n          \n          \n            \n            logger.debug(\"Sent a heart beat to Eureka: {}\", client.uri());", "url": "https://github.com/line/armeria/pull/3238#discussion_r548394346", "createdAt": "2020-12-24T05:38:45Z", "author": {"login": "minwoox"}, "path": "eureka/src/main/java/com/linecorp/armeria/server/eureka/EurekaUpdatingListener.java", "diffHunk": "@@ -328,26 +330,36 @@ public void run() {\n             client.sendHeartBeat(appName, instanceId, instanceInfo, null)\n                   .aggregate()\n                   .handle((res, cause) -> {\n-                      try (HttpData content = res.content()) {\n-                          if (closed) {\n-                              return null;\n-                          }\n+                      if (closed) {\n+                          return null;\n+                      }\n \n-                          // The information of this instance is removed from the registry when the heart beats\n-                          // fail consecutive three times, so we don't retry.\n+                      if (cause != null) {\n+                          logger.warn(\"Failed to send a heart beat to Eureka: {}\", client.uri(), cause);\n+                      } else if (res.headers().status() != HttpStatus.OK) {\n+\n+                          // The information of this instance is removed from the registry when\n+                          // the heart beats fail consecutive three times, so we try to re-registration.\n                           // See https://github.com/Netflix/eureka/wiki/Understanding-eureka-client-server-communication#renew\n-                          if (cause != null) {\n-                              logger.warn(\"Failed to send a heart beat to Eureka: {}\", client.uri(), cause);\n-                          } else if (res.headers().status() != HttpStatus.OK) {\n+                          if (res.headers().status() == HttpStatus.NOT_FOUND) {\n+                              logger.warn(\"Instance {}/{} no longer registered with Eureka.\" +\n+                                          \" Attempting re-registration.\",\n+                                          appName, instanceId);\n+                              register(instanceInfo);\n+                              return null;\n+                          } else {\n                               logger.warn(\"Failed to send a heart beat to Eureka: {}, \" +\n                                           \"(status: {}, content: {})\",\n-                                          client.uri(), res.headers().status(), content.toStringUtf8());\n+                                          client.uri(), res.headers().status(), res.contentUtf8());\n                           }\n-                          heartBeatFuture = eventLoop.schedule(\n-                                  this, instanceInfo.getLeaseInfo().getRenewalIntervalInSecs(),\n-                                  TimeUnit.SECONDS);\n-                          return null;\n+                      } else {\n+                          logger.debug(\"Successfully send a heart beat to Eureka: {}\", client.uri());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "244c327266d772b78a57310abf4305b524c3906e"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4OTg1OTk5", "url": "https://github.com/line/armeria/pull/3238#pullrequestreview-558985999", "createdAt": "2020-12-28T03:42:30Z", "commit": {"oid": "244c327266d772b78a57310abf4305b524c3906e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwMzo0MjozMFrOILwxGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwMzo0MjozMFrOILwxGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTIwNDI1MA==", "bodyText": "nit: How about introducing res.headers().status() as a local variable and cleaning up if else condition?\nif (cause != null) {\n   // leave warn message with the cause\n} else {\n   final HttpStatus status = res.status();\n   if (status == HttpStatus.OK) {\n        // leave some debug message \n   } else if (status == HttpStatus.NOT_FOUND) {\n        // re-register\n   } else {\n       // leave warn message\n   }\n}", "url": "https://github.com/line/armeria/pull/3238#discussion_r549204250", "createdAt": "2020-12-28T03:42:30Z", "author": {"login": "ikhoon"}, "path": "eureka/src/main/java/com/linecorp/armeria/server/eureka/EurekaUpdatingListener.java", "diffHunk": "@@ -328,26 +330,36 @@ public void run() {\n             client.sendHeartBeat(appName, instanceId, instanceInfo, null)\n                   .aggregate()\n                   .handle((res, cause) -> {\n-                      try (HttpData content = res.content()) {\n-                          if (closed) {\n-                              return null;\n-                          }\n+                      if (closed) {\n+                          return null;\n+                      }\n \n-                          // The information of this instance is removed from the registry when the heart beats\n-                          // fail consecutive three times, so we don't retry.\n+                      if (cause != null) {\n+                          logger.warn(\"Failed to send a heart beat to Eureka: {}\", client.uri(), cause);\n+                      } else if (res.headers().status() != HttpStatus.OK) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "244c327266d772b78a57310abf4305b524c3906e"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwNzc1MDMx", "url": "https://github.com/line/armeria/pull/3238#pullrequestreview-560775031", "createdAt": "2021-01-04T04:28:41Z", "commit": {"oid": "a92c97cc71105792411bba30f7d73bbaa50aba09"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNDoyODo0MVrOINlRaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwNDozOTowM1rOINlYjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTExMzA2Nw==", "bodyText": "Could you check the indentation of this class again, please?", "url": "https://github.com/line/armeria/pull/3238#discussion_r551113067", "createdAt": "2021-01-04T04:28:41Z", "author": {"login": "minwoox"}, "path": "eureka/src/main/java/com/linecorp/armeria/server/eureka/EurekaUpdatingListener.java", "diffHunk": "@@ -328,26 +330,37 @@ public void run() {\n             client.sendHeartBeat(appName, instanceId, instanceInfo, null)\n                   .aggregate()\n                   .handle((res, cause) -> {\n-                      try (HttpData content = res.content()) {\n-                          if (closed) {\n-                              return null;\n-                          }\n+                      if (closed) {\n+                          return null;\n+                      }\n \n-                          // The information of this instance is removed from the registry when the heart beats\n-                          // fail consecutive three times, so we don't retry.\n-                          // See https://github.com/Netflix/eureka/wiki/Understanding-eureka-client-server-communication#renew\n-                          if (cause != null) {\n-                              logger.warn(\"Failed to send a heart beat to Eureka: {}\", client.uri(), cause);\n-                          } else if (res.headers().status() != HttpStatus.OK) {\n+                      if (cause != null) {\n+                          logger.warn(\"Failed to send a heart beat to Eureka: {}\", client.uri(), cause);\n+                      } else {\n+                          final HttpStatus status = res.status();\n+\n+                          if (status == HttpStatus.OK) {\n+                              logger.debug(\"Sent a heart beat to Eureka: {}\", client.uri());\n+                          } else if (status == HttpStatus.NOT_FOUND) {\n+                              // The information of this instance is removed from the registry when\n+                              // the heart beats fail consecutive three times, so we try to re-registration.\n+                              // See https://github.com/Netflix/eureka/wiki/Understanding-eureka-client-server-communication#renew\n+                              logger.warn(\"Instance {}/{} no longer registered with Eureka.\" +\n+                                      \" Attempting re-registration.\",\n+                                  appName, instanceId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92c97cc71105792411bba30f7d73bbaa50aba09"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTExNDg5NA==", "bodyText": "nit: heart?", "url": "https://github.com/line/armeria/pull/3238#discussion_r551114894", "createdAt": "2021-01-04T04:39:03Z", "author": {"login": "minwoox"}, "path": "eureka/src/test/java/com/linecorp/armeria/server/eureka/EurekaUpdatingListenerTest.java", "diffHunk": "@@ -134,6 +139,41 @@ void registerHeartBeatAndDeregisterAreSent() throws IOException {\n         assertThat(deregisterHeaders.path()).isEqualTo(\"/apps/application0/i-00000000\");\n     }\n \n+    @Test\n+    void reRegisterIfInstanceNoLongerRegistered() throws IOException {\n+        final EurekaUpdatingListener listener =\n+            EurekaUpdatingListener.builder(eurekaServer.httpUri())\n+                .instanceId(INSTANCE_ID)\n+                .renewalIntervalMillis(2000)\n+                .leaseDurationMillis(10000)\n+                .appName(APP_NAME)\n+                .build();\n+        final int previousRegisterCount = registerCounter.get();\n+        final Server application = Server.builder()\n+            .http(0)\n+            .https(0)\n+            .tlsSelfSigned()\n+            .service(\"/\", (ctx, req) -> HttpResponse.of(HttpStatus.OK))\n+            .service(\"/health\", HealthCheckService.of())\n+            .serverListener(listener)\n+            .build();\n+        application.start().join();\n+        await().until(() -> registerContentCaptor.get() != null);\n+        assertThat(registerCounter.get()).isEqualTo(previousRegisterCount + 1);\n+\n+        // remove instance from the registry\n+        registerContentCaptor.set(null);\n+        await().until(() -> registerContentCaptor.get() != null);\n+        assertThat(registerCounter.get()).isEqualTo(previousRegisterCount + 2);\n+\n+        // heat beats are sent, and not cause re-registration", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92c97cc71105792411bba30f7d73bbaa50aba09"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNjA3NDc3", "url": "https://github.com/line/armeria/pull/3238#pullrequestreview-561607477", "createdAt": "2021-01-05T08:49:49Z", "commit": {"oid": "49109872fa3fbc354d308f3be9b77e9548676232"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwODo0OTo0OVrOIOOvog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQwODo0OTo0OVrOIOOvog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTc5MjU0Ng==", "bodyText": "Could you wrap this entire block with try-finally and call res.content().close() in the finally block when res is not null, so that we do not leak anything?", "url": "https://github.com/line/armeria/pull/3238#discussion_r551792546", "createdAt": "2021-01-05T08:49:49Z", "author": {"login": "trustin"}, "path": "eureka/src/main/java/com/linecorp/armeria/server/eureka/EurekaUpdatingListener.java", "diffHunk": "@@ -328,26 +330,37 @@ public void run() {\n             client.sendHeartBeat(appName, instanceId, instanceInfo, null)\n                   .aggregate()\n                   .handle((res, cause) -> {\n-                      try (HttpData content = res.content()) {\n-                          if (closed) {\n-                              return null;\n-                          }\n+                      if (closed) {\n+                          return null;\n+                      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49109872fa3fbc354d308f3be9b77e9548676232"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNjI1NzY5", "url": "https://github.com/line/armeria/pull/3238#pullrequestreview-561625769", "createdAt": "2021-01-05T09:16:41Z", "commit": {"oid": "49109872fa3fbc354d308f3be9b77e9548676232"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY0MTkyOTU5", "url": "https://github.com/line/armeria/pull/3238#pullrequestreview-564192959", "createdAt": "2021-01-08T11:31:57Z", "commit": {"oid": "49109872fa3fbc354d308f3be9b77e9548676232"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQxMTozMTo1OFrOIQO7cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wOFQxMTozMTo1OFrOIQO7cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mzg5MjcyMg==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                      client.uri(), res.headers().status(), res.contentUtf8());\n          \n          \n            \n                                                      client.uri(), res.status(), res.contentUtf8());", "url": "https://github.com/line/armeria/pull/3238#discussion_r553892722", "createdAt": "2021-01-08T11:31:58Z", "author": {"login": "ikhoon"}, "path": "eureka/src/main/java/com/linecorp/armeria/server/eureka/EurekaUpdatingListener.java", "diffHunk": "@@ -328,26 +330,37 @@ public void run() {\n             client.sendHeartBeat(appName, instanceId, instanceInfo, null)\n                   .aggregate()\n                   .handle((res, cause) -> {\n-                      try (HttpData content = res.content()) {\n-                          if (closed) {\n-                              return null;\n-                          }\n+                      if (closed) {\n+                          return null;\n+                      }\n \n-                          // The information of this instance is removed from the registry when the heart beats\n-                          // fail consecutive three times, so we don't retry.\n-                          // See https://github.com/Netflix/eureka/wiki/Understanding-eureka-client-server-communication#renew\n-                          if (cause != null) {\n-                              logger.warn(\"Failed to send a heart beat to Eureka: {}\", client.uri(), cause);\n-                          } else if (res.headers().status() != HttpStatus.OK) {\n+                      if (cause != null) {\n+                          logger.warn(\"Failed to send a heart beat to Eureka: {}\", client.uri(), cause);\n+                      } else {\n+                          final HttpStatus status = res.status();\n+\n+                          if (status == HttpStatus.OK) {\n+                              logger.debug(\"Sent a heart beat to Eureka: {}\", client.uri());\n+                          } else if (status == HttpStatus.NOT_FOUND) {\n+                              // The information of this instance is removed from the registry when\n+                              // the heart beats fail consecutive three times, so we try to re-registration.\n+                              // See https://github.com/Netflix/eureka/wiki/Understanding-eureka-client-server-communication#renew\n+                              logger.warn(\"Instance {}/{} no longer registered with Eureka.\" +\n+                                          \" Attempting re-registration.\",\n+                                          appName, instanceId);\n+                              register(instanceInfo);\n+                              return null;\n+                          } else {\n                               logger.warn(\"Failed to send a heart beat to Eureka: {}, \" +\n                                           \"(status: {}, content: {})\",\n-                                          client.uri(), res.headers().status(), content.toStringUtf8());\n+                                          client.uri(), res.headers().status(), res.contentUtf8());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49109872fa3fbc354d308f3be9b77e9548676232"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fb11fb463fc3e311a54658ffa2929144337766c", "author": {"user": {"login": "eisig", "name": null}}, "url": "https://github.com/line/armeria/commit/3fb11fb463fc3e311a54658ffa2929144337766c", "committedDate": "2021-01-23T16:35:51Z", "message": "Attempting re-registration when eureka server return 404"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ff388f244d53924eddd1a3988062726bb0f1958", "author": {"user": {"login": "eisig", "name": null}}, "url": "https://github.com/line/armeria/commit/0ff388f244d53924eddd1a3988062726bb0f1958", "committedDate": "2021-01-23T16:35:51Z", "message": "fix: eureka heat beat may not shedule with connection error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd6b6fee3b6240aaa6e02c2124fd445c38b20953", "author": {"user": {"login": "eisig", "name": null}}, "url": "https://github.com/line/armeria/commit/dd6b6fee3b6240aaa6e02c2124fd445c38b20953", "committedDate": "2021-01-23T16:35:51Z", "message": "Add test for eureka re-registration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "021aea6a19fc8f2fd6cf38207dfca8e4da839502", "author": {"user": {"login": "eisig", "name": null}}, "url": "https://github.com/line/armeria/commit/021aea6a19fc8f2fd6cf38207dfca8e4da839502", "committedDate": "2021-01-23T16:35:51Z", "message": "clean tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "079ea255fc519b1d22d0e48af9b16c8268b52ef0", "author": {"user": {"login": "eisig", "name": null}}, "url": "https://github.com/line/armeria/commit/079ea255fc519b1d22d0e48af9b16c8268b52ef0", "committedDate": "2021-01-23T16:35:51Z", "message": "Fix indentation and world spelling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "692e2a780cb63ab60c9512ec821ba20be7a57478", "author": {"user": {"login": "eisig", "name": null}}, "url": "https://github.com/line/armeria/commit/692e2a780cb63ab60c9512ec821ba20be7a57478", "committedDate": "2021-01-23T16:35:51Z", "message": "Update eureka/src/main/java/com/linecorp/armeria/server/eureka/EurekaUpdatingListener.java\n\nCo-authored-by: Ikhun Um <ih.pert@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e31e2c0036041633c0cd7e0e12bdb18accb34f49", "author": {"user": {"login": "eisig", "name": null}}, "url": "https://github.com/line/armeria/commit/e31e2c0036041633c0cd7e0e12bdb18accb34f49", "committedDate": "2021-01-23T16:38:23Z", "message": "Fix conflicts"}, "afterCommit": {"oid": "692e2a780cb63ab60c9512ec821ba20be7a57478", "author": {"user": {"login": "eisig", "name": null}}, "url": "https://github.com/line/armeria/commit/692e2a780cb63ab60c9512ec821ba20be7a57478", "committedDate": "2021-01-23T16:35:51Z", "message": "Update eureka/src/main/java/com/linecorp/armeria/server/eureka/EurekaUpdatingListener.java\n\nCo-authored-by: Ikhun Um <ih.pert@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4565, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}