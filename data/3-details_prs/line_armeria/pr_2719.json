{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MTIzNDQ4", "number": 2719, "title": "Support gRPC Scala using ScalaPB", "bodyText": "Motivation:\nAs a part of better interop with other JVM languages(#1078),\nit would be nice if Armeria Grpc server and client support ScalaPB.\nModifications:\n\nAdd GrpcJsonMashaller and GrpcJsonMashallerBuilder for customizing JSON marshaller.\nAdd DefaultJsonMarshaller that wraps MessageMarshaller with GrpcJsonMarshaller.\nAdd ScalaPBJsonMarshaller for marshalling scalapb.GeneratedMessage.\nAdd GrpcScalaDocServicePlugin for supporting DocService.\nAdd grpc-scala exmaple.\nBreaking\n\nGrpcServiceBuilder.jsonMarshallerCustomizer(Consumer) has been removed in favor of jsonMarshallerFactory(Function).\n// Before:\nGrpcService.builder()\n            ...\n           .jsonMarshallerCustomizer(builder -> {\n               builder.preservingProtoFieldNames(true);\n            })\n            .build()\n// After:\nGrpcService.builder()\n           ...\n           .jsonMarshallerFactory(serviceDescriptor -> {\n               return GrpcJsonMarshaller.builder()\n                                        .jsonMarshallerCustomizer(builder -> {\n                                             builder.preservingProtoFieldNames(true);\n                                        })\n                                        .build(serviceDescriptor);\n           })\n           .build();\n\nGrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER has been removed in favor of GRPC_JSON_MARSHALLER_FACTORY.\n// Before:\nClients.builder(grpcServerUri)\n       ...\n       .option(GrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER.newValue(builder -> { \n             builder.preservingProtoFieldNames(true);\n        })\n       .build();\n// After:\nClients.builder(grpcServerUri)\n       ...\n       .option(GrpcClientOptions.GRPC_JSON_MARSHALLER_FACTORY.newValue(serviceDescriptor -> {\n           return GrpcJsonMarshaller.builder()\n                                    .jsonMarshallerCustomizer(builder -> {\n                                        builder.preservingProtoFieldNames(true);\n                                    })\n                                    .build(serviceDescriptor);\n       }))\n       .build();\n\n\n\n\nResult:\nYou can now run the gRPC server/client stubs generated by ScalaPB with Armeria.\nPlease refer to https://github.com/line/armeria/tree/master/examples/grpc-scala for the fully working example.\nTODO: Package and publish GrpcScalaDocServicePlugin and ScalaPBJsonMarshaller to maven central. I think we can add them to armeria-contrib later. \ud83e\udd14", "createdAt": "2020-05-17T14:44:07Z", "url": "https://github.com/line/armeria/pull/2719", "merged": true, "mergeCommit": {"oid": "163eaeecb43a88ee5fa9e0e04fefb801651c02cb"}, "closed": true, "closedAt": "2020-06-25T09:56:18Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciMc0pgBqjMzNDQ2MjQ4Njk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcurjBPAH2gAyNDE5MTIzNDQ4OmI5Yzg4ZjZmZWI3ZjliOGQwZmI1YTYwNGUxZDc2ZmJmZGJiODE4YzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c0dea5c125cf3dd8ffdce9b134fb4a08fd48d7e5", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/c0dea5c125cf3dd8ffdce9b134fb4a08fd48d7e5", "committedDate": "2020-05-17T14:30:34Z", "message": "Support gRPC Scala using ScalaPB\n\nMotivation:\n\nAs a part of better interop with other JVM languages(#1078),\nit would be nice if Armeria Grpc server and client support [ScalaPB](https://scalapb.github.io/).\n\nMotifications:\n\n- Introduce new interface `GrpcMessageMashaller`. A user can customize\n `GrpcMessageMashaller` by setting it to GrpcServerBuilder or GrpcClientOptions.\n  I'm not sure this approach is a right direction. \ud83e\uddd0\n- Add ScalaPBMessageMashaller.\n  Note, It is hard to support releasing artifect with mupliple Scala version\n  Do we need to move this code to Armeria contrib?\n\nResult:\n\nYou can now use the gRPC server/client stubs generated by ScalaPB"}, "afterCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/a546f575049e458a23d436d25538ce61f96210ba", "committedDate": "2020-05-17T14:49:10Z", "message": "Support gRPC Scala using ScalaPB\n\nMotivation:\n\nAs a part of better interop with other JVM languages(#1078),\nit would be nice if Armeria Grpc server and client support [ScalaPB](https://scalapb.github.io/).\n\nNotifications:\n\n- Rename the original `GrpcMessageMashaller` to `GrpcMessageMashallingHandler`.\n- Introduce a new interface `GrpcMessageMashaller`. A user can customize\n `GrpcMessageMashaller` by setting it to GrpcServerBuilder or GrpcClientOptions.\n  I'm not sure this approach is the right direction. \ud83e\uddd0\n- Add ScalaPBMessageMashaller.\n  Note, It is hard to support releasing an artifact with multiple Scala versions in Gradle.\n  Do we need to move this code to Armeria `contrib`?\n\nResult:\n\nYou can now use the gRPC server/client stubs generated by ScalaPB"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMjI4MTM0", "url": "https://github.com/line/armeria/pull/2719#pullrequestreview-413228134", "createdAt": "2020-05-18T01:42:37Z", "commit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo0MjozN1rOGWlV_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1MzowM1rOGWlc_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzMzY5NQ==", "bodyText": "Missing space before {", "url": "https://github.com/line/armeria/pull/2719#discussion_r426333695", "createdAt": "2020-05-18T01:42:37Z", "author": {"login": "trustin"}, "path": "benchmarks/build.gradle", "diffHunk": "@@ -79,3 +78,12 @@ jmh {\n         }\n     }\n }\n+\n+// Workaround a bug where the conflict of output path between 'benchmarks.jmh' and 'benchmarks.test' in IDEA\n+project.afterEvaluate {\n+    idea {\n+        module{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDQxNQ==", "bodyText": "to the specified -> with the specified", "url": "https://github.com/line/armeria/pull/2719#discussion_r426334415", "createdAt": "2020-05-18T01:46:53Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "diffHunk": "@@ -76,11 +83,27 @@\n     public static final ClientOption<Boolean> UNSAFE_WRAP_RESPONSE_BUFFERS =\n             ClientOption.define(\"GRPC_UNSAFE_WRAP_RESPONSE_BUFFERS\", false);\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDU1MA==", "bodyText": "Note that JSON_MAR... option will be ignored if this option is set.", "url": "https://github.com/line/armeria/pull/2719#discussion_r426334550", "createdAt": "2020-05-18T01:47:38Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "diffHunk": "@@ -76,11 +83,27 @@\n     public static final ClientOption<Boolean> UNSAFE_WRAP_RESPONSE_BUFFERS =\n             ClientOption.define(\"GRPC_UNSAFE_WRAP_RESPONSE_BUFFERS\", false);\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n+     * {@link GrpcMessageMarshaller}.\n+     *\n+     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n+     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n+     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     *\n+     * Note that this option is configured, {@link #JSON_MARSHALLER_CUSTOMIZER} option will be ignored.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDY2Mw==", "bodyText": "Note that this option will be ignored if GRPC_MESSAGE... is set.", "url": "https://github.com/line/armeria/pull/2719#discussion_r426334663", "createdAt": "2020-05-18T01:48:15Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "diffHunk": "@@ -76,11 +83,27 @@\n     public static final ClientOption<Boolean> UNSAFE_WRAP_RESPONSE_BUFFERS =\n             ClientOption.define(\"GRPC_UNSAFE_WRAP_RESPONSE_BUFFERS\", false);\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n+     * {@link GrpcMessageMarshaller}.\n+     *\n+     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n+     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n+     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     *\n+     * Note that this option is configured, {@link #JSON_MARSHALLER_CUSTOMIZER} option will be ignored.\n+     */\n+    public static final ClientOption<GrpcMessageMarshaller> GRPC_MESSAGE_MARSHALLER =\n+            ClientOption.define(\"GRPC_MESSAGE_MARSHALLER\", NoopGrpcMessageMarshaller.get());\n+\n     /**\n      * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n      * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n      * using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n+     *\n+     * Note that a {@link #GRPC_MESSAGE_MARSHALLER} is configured, this option will be ignored.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDc2Mw==", "bodyText": "Maybe better using null instead of NoopGrpcMessageMarshaller?", "url": "https://github.com/line/armeria/pull/2719#discussion_r426334763", "createdAt": "2020-05-18T01:48:57Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaChannel.java", "diffHunk": "@@ -62,23 +68,31 @@\n     private final MeterRegistry meterRegistry;\n     private final SessionProtocol sessionProtocol;\n     private final SerializationFormat serializationFormat;\n-    @Nullable\n-    private final MessageMarshaller jsonMarshaller;\n+    private final GrpcMessageMarshaller messageMarshaller;\n     private final String advertisedEncodingsHeader;\n \n     ArmeriaChannel(ClientBuilderParams params,\n                    HttpClient httpClient,\n                    MeterRegistry meterRegistry,\n                    SessionProtocol sessionProtocol,\n                    SerializationFormat serializationFormat,\n+                   GrpcMessageMarshaller messageMarshaller,\n                    @Nullable MessageMarshaller jsonMarshaller) {\n         this.params = params;\n         this.httpClient = httpClient;\n         this.meterRegistry = meterRegistry;\n         this.sessionProtocol = sessionProtocol;\n         this.serializationFormat = serializationFormat;\n-        this.jsonMarshaller = jsonMarshaller;\n-\n+        if (messageMarshaller != NoopGrpcMessageMarshaller.get()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTIwNw==", "bodyText": "Prototype or Protobuf?\nfinal?", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335207", "createdAt": "2020-05-18T01:51:21Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/PrototypeMessageMarshaller.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common.grpc;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.Nullable;\n+\n+import org.curioswitch.common.protobuf.json.MessageMarshaller;\n+\n+import com.google.protobuf.CodedInputStream;\n+import com.google.protobuf.CodedOutputStream;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.google.protobuf.Message;\n+import com.google.protobuf.UnsafeByteOperations;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+import com.linecorp.armeria.common.grpc.GrpcSerializationFormats;\n+\n+import io.grpc.MethodDescriptor.Marshaller;\n+import io.grpc.MethodDescriptor.PrototypeMarshaller;\n+import io.grpc.Status;\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufInputStream;\n+import io.netty.buffer.ByteBufOutputStream;\n+\n+/**\n+ * A {@link GrpcMessageMarshaller} for {@link PrototypeMarshaller} that provides optimized code paths\n+ * for a {@link Message}.\n+ */\n+public class PrototypeMessageMarshaller implements GrpcMessageMarshaller {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTI2Mw==", "bodyText": "Revert?", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335263", "createdAt": "2020-05-18T01:51:43Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/FramedGrpcService.java", "diffHunk": "@@ -129,8 +139,8 @@\n         advertisedEncodingsHeader = String.join(\",\", decompressorRegistry.getAdvertisedMessageEncodings());\n \n         defaultHeaders = supportedSerializationFormats\n-                .stream()\n-                .map(format -> {\n+                                 .stream()\n+                                 .map(format -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTMxNQ==", "bodyText": "serializes and deserialzes", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335315", "createdAt": "2020-05-18T01:52:04Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -261,14 +268,36 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n         return this;\n     }\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTM1Ng==", "bodyText": "with the specified", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335356", "createdAt": "2020-05-18T01:52:19Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -261,14 +268,36 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n         return this;\n     }\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTQ0MQ==", "bodyText": "Note that this method will throw ... if ... is set.", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335441", "createdAt": "2020-05-18T01:52:47Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -261,14 +268,36 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n         return this;\n     }\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n+     * {@link GrpcMessageMarshaller}.\n+     *\n+     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n+     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n+     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     *\n+     * Note that a {@link #jsonMarshallerCustomizer(Consumer)} is configured,\n+     * this method will throw an {@link IllegalStateException}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTQ4NA==", "bodyText": "Note that this method will ... if ... is set.", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335484", "createdAt": "2020-05-18T01:53:03Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -261,14 +268,36 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n         return this;\n     }\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n+     * {@link GrpcMessageMarshaller}.\n+     *\n+     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n+     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n+     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     *\n+     * Note that a {@link #jsonMarshallerCustomizer(Consumer)} is configured,\n+     * this method will throw an {@link IllegalStateException}.\n+     */\n+    public GrpcServiceBuilder messageMarshaller(GrpcMessageMarshaller messageMarshaller) {\n+        checkState(!isJsonMarshallerCustomizerSet, \"jsonMarshallerCustomizer has been set already.\");\n+        this.messageMarshaller = requireNonNull(messageMarshaller, \"messageMarshaller\");\n+        return this;\n+    }\n+\n     /**\n      * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n      * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n      * using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n+     *\n+     * Note that a {@link #messageMarshaller(GrpcMessageMarshaller)} is configured,\n+     * this method will throw an {@link IllegalStateException}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMjU5MTAy", "url": "https://github.com/line/armeria/pull/2719#pullrequestreview-413259102", "createdAt": "2020-05-18T04:05:06Z", "commit": {"oid": "133edd3d713989fa07145f10995a67e09542518a"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "committedDate": "2020-06-13T13:45:04Z", "message": "Support gRPC Scala using ScalaPB #2719\n\nMotivation:\n\nAs a part of better interop with other JVM languages(#1078),\nit would be nice if Armeria Grpc server and client support [ScalaPB](https://scalapb.github.io/).\n\nModifications:\n\n- Rename the original `GrpcMessageMashaller` to `GrpcMessageMashallingHandler`.\n- Introduce a new interface `GrpcMessageMashaller`. A user can customize\n `GrpcMessageMashaller` by setting it to GrpcServerBuilder or GrpcClientOptions.\n  I'm not sure this approach is a right direction. \ud83e\uddd0\n  Related: #2416\n- Add ScalaPBMessageMashaller.\n  Note, It is hard to support releasing an artifact with multiple Scala versions in Gradle.\n  Do we need to move this code to Armeria `contrib`?\n\nResult:\n\nYou can now use the gRPC server/client stubs generated by ScalaPB"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "133edd3d713989fa07145f10995a67e09542518a", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/133edd3d713989fa07145f10995a67e09542518a", "committedDate": "2020-05-18T02:42:19Z", "message": "Fix Javadoc"}, "afterCommit": {"oid": "122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/122c47ee6d71e8b31422e4aa2e73e897e5136ebd", "committedDate": "2020-06-13T13:45:04Z", "message": "Support gRPC Scala using ScalaPB #2719\n\nMotivation:\n\nAs a part of better interop with other JVM languages(#1078),\nit would be nice if Armeria Grpc server and client support [ScalaPB](https://scalapb.github.io/).\n\nModifications:\n\n- Rename the original `GrpcMessageMashaller` to `GrpcMessageMashallingHandler`.\n- Introduce a new interface `GrpcMessageMashaller`. A user can customize\n `GrpcMessageMashaller` by setting it to GrpcServerBuilder or GrpcClientOptions.\n  I'm not sure this approach is a right direction. \ud83e\uddd0\n  Related: #2416\n- Add ScalaPBMessageMashaller.\n  Note, It is hard to support releasing an artifact with multiple Scala versions in Gradle.\n  Do we need to move this code to Armeria `contrib`?\n\nResult:\n\nYou can now use the gRPC server/client stubs generated by ScalaPB"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "212ff87f0173e7765bef9718115a90ec465610a8", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/212ff87f0173e7765bef9718115a90ec465610a8", "committedDate": "2020-06-13T13:52:13Z", "message": "Clean up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNDQ2ODg1", "url": "https://github.com/line/armeria/pull/2719#pullrequestreview-431446885", "createdAt": "2020-06-16T12:23:26Z", "commit": {"oid": "212ff87f0173e7765bef9718115a90ec465610a8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjoyMzoyN1rOGkYxFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjozMjo1OVrOGkZGPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwNzcwMA==", "bodyText": "Probably better not using static import? current() seems confusing.", "url": "https://github.com/line/armeria/pull/2719#discussion_r440807700", "createdAt": "2020-06-16T12:23:27Z", "author": {"login": "trustin"}, "path": "gradle/scripts/lib/java-rpc-proto.gradle", "diffHunk": "@@ -41,22 +44,38 @@ configure(projectsWithFlags('java')) {\n                             artifact = \"io.grpc:protoc-gen-grpc-kotlin:${managedVersions['io.grpc:protoc-gen-grpc-kotlin']}\"\n                         }\n                     }\n+\n+                    def isWindow = current() == WINDOWS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "212ff87f0173e7765bef9718115a90ec465610a8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgxMzExOA==", "bodyText": "This makes me think GRPC_JSON_MARSHALLER and JSON_MARSHALLER_CUSTOMIZER are not orthogonal. Should we merge these two options into one, e.g. GRPC_JSON_MARSHALLER_FACTORY (Function<Class<?>, GrpcJsonMarshaller>)? The default value of the new option could be something like:\nclientType -> GrpcJsonMarshaller.of(clientType)\nwhere GrpcJsonMarshaller.of() calls something like new DefaultJsonMarshaller(GrpcJsonUtil.jsonMarshaller(stubMethods(clientType)).\nIf a user wants to customize the marshaller, the user could specify an alternative factory like this:\nclientType -> GrpcJsonMarshaller.builder(clientType)\n                                ...\n                                .build()\nFor ScalaPB and others, it could be _ -> ScalaPBJsonMarshaller().\nWhat do you think, @ikhoon and @anuraaga ?", "url": "https://github.com/line/armeria/pull/2719#discussion_r440813118", "createdAt": "2020-06-16T12:32:59Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/GrpcClientFactory.java", "diffHunk": "@@ -95,13 +98,14 @@ public Object newClient(ClientBuilderParams params) {\n \n         final HttpClient httpClient = newHttpClient(params);\n \n-        // TODO(ikhoon): Support gjson with Kotlin coroutine stub once\n-        //               https://github.com/grpc/grpc-kotlin/pull/63 is released\n-        final MessageMarshaller jsonMarshaller =\n-                GrpcSerializationFormats.isJson(serializationFormat) ?\n-                GrpcJsonUtil.jsonMarshaller(\n-                        stubMethods(clientType),\n-                        options.get(GrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER)) : null;\n+        GrpcJsonMarshaller jsonMarshaller = null;\n+        if (GrpcSerializationFormats.isJson(serializationFormat)) {\n+            jsonMarshaller = options.get(GrpcClientOptions.GRPC_JSON_MARSHALLER);\n+            if (jsonMarshaller == NoopJsonMarshaller.get()) {\n+                jsonMarshaller = new DefaultJsonMarshaller(GrpcJsonUtil.jsonMarshaller(\n+                        stubMethods(clientType), options.get(GrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "212ff87f0173e7765bef9718115a90ec465610a8"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc6fddd35fea5d7140c79dc268e2f94ddb02c789", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/dc6fddd35fea5d7140c79dc268e2f94ddb02c789", "committedDate": "2020-06-23T09:00:21Z", "message": "Merge branch 'master' into grpc-scala"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "361e29d19815e6fd9d8abd5b5092c690a91e789d", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/361e29d19815e6fd9d8abd5b5092c690a91e789d", "committedDate": "2020-06-24T07:21:05Z", "message": "Address comments by @trustin / Add a fatory and builder of GrpcJsonMashaller"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2Mzg4Njk1", "url": "https://github.com/line/armeria/pull/2719#pullrequestreview-436388695", "createdAt": "2020-06-24T07:24:46Z", "commit": {"oid": "361e29d19815e6fd9d8abd5b5092c690a91e789d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNzoyNDo0NlrOGoGFyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNzozNTo0NVrOGoGa4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5NjAwOA==", "bodyText": "I haven't seen this before, what is it working around?", "url": "https://github.com/line/armeria/pull/2719#discussion_r444696008", "createdAt": "2020-06-24T07:24:46Z", "author": {"login": "anuraaga"}, "path": "benchmarks/build.gradle", "diffHunk": "@@ -80,3 +79,12 @@ jmh {\n         }\n     }\n }\n+\n+// Workaround a bug where the conflict of output path between 'benchmarks.jmh' and 'benchmarks.test' in IDEA", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "361e29d19815e6fd9d8abd5b5092c690a91e789d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMTMwOA==", "bodyText": "Is this used?", "url": "https://github.com/line/armeria/pull/2719#discussion_r444701308", "createdAt": "2020-06-24T07:35:31Z", "author": {"login": "anuraaga"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common.grpc;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+\n+import com.linecorp.armeria.common.grpc.GrpcJsonMarshaller;\n+\n+import io.grpc.MethodDescriptor.Marshaller;\n+\n+public final class NoopJsonMarshaller implements GrpcJsonMarshaller {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "361e29d19815e6fd9d8abd5b5092c690a91e789d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMTQxMA==", "bodyText": "I don't know if we need this class, but if we do we want to return default instance, not null.", "url": "https://github.com/line/armeria/pull/2719#discussion_r444701410", "createdAt": "2020-06-24T07:35:45Z", "author": {"login": "anuraaga"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common.grpc;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+\n+import com.linecorp.armeria.common.grpc.GrpcJsonMarshaller;\n+\n+import io.grpc.MethodDescriptor.Marshaller;\n+\n+public final class NoopJsonMarshaller implements GrpcJsonMarshaller {\n+\n+    private static final NoopJsonMarshaller INSTANCE = new NoopJsonMarshaller();\n+\n+    public static NoopJsonMarshaller get() {\n+        return INSTANCE;\n+    }\n+\n+    private NoopJsonMarshaller() {}\n+\n+    @Override\n+    public <T> void serializeMessage(Marshaller<T> marshaller, T message, OutputStream os) throws IOException {}\n+\n+    @Override\n+    public <T> T deserializeMessage(Marshaller<T> marshaller, InputStream is) throws IOException {\n+        return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "361e29d19815e6fd9d8abd5b5092c690a91e789d"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9186521c583bbf28258e8cc2dffa204ccbbf5a4", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/a9186521c583bbf28258e8cc2dffa204ccbbf5a4", "committedDate": "2020-06-24T07:40:09Z", "message": "Clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7c6c703bc9f8728e39edc41485e1b356a2805be", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/c7c6c703bc9f8728e39edc41485e1b356a2805be", "committedDate": "2020-06-24T07:51:46Z", "message": "Remove blank"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NDExNjIz", "url": "https://github.com/line/armeria/pull/2719#pullrequestreview-436411623", "createdAt": "2020-06-24T07:59:27Z", "commit": {"oid": "c7c6c703bc9f8728e39edc41485e1b356a2805be"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NDQ5NzU3", "url": "https://github.com/line/armeria/pull/2719#pullrequestreview-436449757", "createdAt": "2020-06-24T08:50:54Z", "commit": {"oid": "c7c6c703bc9f8728e39edc41485e1b356a2805be"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2ac49deaff5841ec09139c48aebd4f9a7de8b40", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/c2ac49deaff5841ec09139c48aebd4f9a7de8b40", "committedDate": "2020-06-24T09:02:59Z", "message": "Update code example in GrpcClientOptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e517a423b3e3b072b8b42f589a4cace4806fbbf", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/1e517a423b3e3b072b8b42f589a4cace4806fbbf", "committedDate": "2020-06-24T09:07:39Z", "message": "Fix option name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2NDU1OTk4", "url": "https://github.com/line/armeria/pull/2719#pullrequestreview-436455998", "createdAt": "2020-06-24T08:58:48Z", "commit": {"oid": "c7c6c703bc9f8728e39edc41485e1b356a2805be"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwODo1ODo0OVrOGoJRrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwMjoyNjo1M1rOGopTag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc0ODIwNQ==", "bodyText": "two empty lines?", "url": "https://github.com/line/armeria/pull/2719#discussion_r444748205", "createdAt": "2020-06-24T08:58:49Z", "author": {"login": "minwoox"}, "path": "examples/grpc-scala/src/main/scala/example/armeria/grpc/scala/HelloServiceImpl.scala", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.grpc.scala\n+\n+import java.util.concurrent.{ScheduledExecutorService, TimeUnit}\n+\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import example.armeria.grpc.scala.HelloServiceImpl.{blockingContextAwareExecutionContext, contextAwareScheduler, toMessage}\n+import example.armeria.grpc.scala.hello.{HelloReply, HelloRequest, HelloServiceGrpc}\n+import io.grpc.stub.StreamObserver\n+import monix.execution\n+import monix.execution.Ack.Continue\n+import monix.execution.Scheduler\n+import monix.reactive.Observable\n+\n+import scala.collection.mutable\n+import scala.concurrent.duration._\n+import scala.concurrent.{ExecutionContext, Future, Promise}\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7c6c703bc9f8728e39edc41485e1b356a2805be"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI3MjkzOA==", "bodyText": "rnn?", "url": "https://github.com/line/armeria/pull/2719#discussion_r445272938", "createdAt": "2020-06-25T02:26:53Z", "author": {"login": "minwoox"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -264,14 +268,34 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n     }\n \n     /**\n-     * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n-     * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n-     * using the field name from the proto definition, by setting\n-     * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n+     * Sets the factory that creates a {@link GrpcJsonMarshaller} that serializes and deserializes request or\n+     * response messages to and from JSON depending on the {@link SerializationFormat}. The returned\n+     * {@link GrpcJsonMarshaller} from the factory replaces the built-in {@link GrpcJsonMarshaller}.\n+     *\n+     * <p>This is commonly used to:\n+     * <ul>\n+     *   <li>Switch from the default of using lowerCamelCase for field names to using the field name from\n+     *       the proto definition, by setting\n+     *       {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)} via\n+     *       {@link GrpcJsonMarshallerBuilder#jsonMarshallerCustomizer(Consumer)}.\n+     *       <pre>{@code\n+     *       GrpcService.builder()\n+     *            .jsonMarshallerFactory(serviceDescriptor -> {\n+     *                return GrpcJsonMarshaller.builder()\n+     *                                         .jsonMarshallerCustomizer(builder -> {\n+     *                                             builder.preservingProtoFieldNames(true);\n+     *                                         })\n+     *                                         .build(serviceDescriptor);\n+     *            })\n+     *            .build();\n+     *       }</pre></li>\n+     *   <li>Set a customer marshaller for non-{@link Message} types such as {@code scalapb.GeneratedMessage}\n+     *       for Scala and {@code pbandk.Message} for Kotlin.</li>\n+     * </ul>\n      */\n-    public GrpcServiceBuilder jsonMarshallerCustomizer(\n-            Consumer<MessageMarshaller.Builder> jsonMarshallerCustomizer) {\n-        this.jsonMarshallerCustomizer = requireNonNull(jsonMarshallerCustomizer, \"jsonMarshallerCustomizer\");\n+    public GrpcServiceBuilder jsonMarshallerFactory(\n+            Function<? super ServiceDescriptor, ? extends GrpcJsonMarshaller> jsonMarshallerFactory) {\n+        this.jsonMarshallerFactory = jsonMarshallerFactory;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e517a423b3e3b072b8b42f589a4cace4806fbbf"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e076723d130f43133af3d780968a26762e0c8eb", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/3e076723d130f43133af3d780968a26762e0c8eb", "committedDate": "2020-06-25T04:14:06Z", "message": "Address comments by @minwoox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9c88f6feb7f9b8d0fb5a604e1d76fbfdbb818c4", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/b9c88f6feb7f9b8d0fb5a604e1d76fbfdbb818c4", "committedDate": "2020-06-25T09:50:46Z", "message": "Fix indent"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 503, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}