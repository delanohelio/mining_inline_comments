{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NDU5MDYy", "number": 2377, "title": "Return ClientRequestContext.root() when invoking ServiceRequest\u2026", "bodyText": "\u2026Context.current()\nMotivation:\nIt makes sense that returning ClientRequestContext.root() if the client call is made by a service  when invoking ServiceRequestContext.current() and its family methods.\nModification:\n\nReturn ClientRequestContext.root() if it exists when calling ServiceRequestContext.current() and currentOrNull().\n\nIt still throws an exception if the ClientRequestContext does not have the root.\n\n\n\nResult:\n\nMore flexible API.", "createdAt": "2020-01-06T09:20:40Z", "url": "https://github.com/line/armeria/pull/2377", "merged": true, "mergeCommit": {"oid": "df090609747e4bbc0bfbbd1165bcdb085b703d34"}, "closed": true, "closedAt": "2020-01-06T13:23:02Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3ojSzgH2gAyMzU5NDU5MDYyOjE5ZGIwNTliNTk1ZjU4MGFmNTM1MTUxMmEyN2NkOGNjYTM4MGIzYTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb3qQCxAH2gAyMzU5NDU5MDYyOmMyNzg4NWEzOTQ2MzExY2IxMTBjNTZhNjk1NThlMzcxY2FlNGI2Y2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "19db059b595f580af5351512a27cd8cca380b3a9", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/19db059b595f580af5351512a27cd8cca380b3a9", "committedDate": "2020-01-06T09:15:31Z", "message": "Return ClientRequestContext.root() when invoking ServiceRequestContext.current()\nMotivation:\nIt makes sense that returning `ClientRequestContext.root()` if the client call is made by a service  when invoking `ServiceRequestContext.current()` and its family methods.\n\nModification:\n- Return `ClientRequestContext.root()` if it exists when calling `ServiceRequestContext.current()` and `currentOrNull()`.\n  - It still throw an exception if the `ClientRequestContext` does not have the root.\n\nResult:\n- More flexible API."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTM5MTU2", "url": "https://github.com/line/armeria/pull/2377#pullrequestreview-338539156", "createdAt": "2020-01-06T09:24:43Z", "commit": {"oid": "19db059b595f580af5351512a27cd8cca380b3a9"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwOToyNDo0M1rOFaY0tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwOToyNDo1N1rOFaY1BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIxNDAwNA==", "bodyText": "Space after :?", "url": "https://github.com/line/armeria/pull/2377#discussion_r363214004", "createdAt": "2020-01-06T09:24:43Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/ServiceRequestContext.java", "diffHunk": "@@ -61,33 +60,54 @@\n \n     /**\n      * Returns the server-side context of the {@link Request} that is being handled in the current thread.\n+     * If the context is a {@link ClientRequestContext}, {@link ClientRequestContext#root()} is returned.\n      *\n      * @throws IllegalStateException if the context is unavailable in the current thread or\n-     *                               the current context is not a {@link ServiceRequestContext}.\n+     *                               the current context is a {@link ClientRequestContext} and\n+     *                               {@link ClientRequestContext#root()} is {@code null}\n      */\n     static ServiceRequestContext current() {\n         final RequestContext ctx = RequestContext.current();\n-        checkState(ctx instanceof ServiceRequestContext,\n-                   \"The current context is not a server-side context: %s\", ctx);\n-        return (ServiceRequestContext) ctx;\n+        if (ctx instanceof ServiceRequestContext) {\n+            return (ServiceRequestContext) ctx;\n+        }\n+\n+        final ServiceRequestContext root = ((ClientRequestContext) ctx).root();\n+        if (root != null) {\n+            return root;\n+        }\n+\n+        throw new IllegalStateException(\n+                \"The current context is not a server-side context and does not have a root \" +\n+                \"which means that the context is not invoked by a server request. ctx:\" + ctx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19db059b595f580af5351512a27cd8cca380b3a9"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIxNDA4NQ==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/2377#discussion_r363214085", "createdAt": "2020-01-06T09:24:57Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/ServiceRequestContext.java", "diffHunk": "@@ -61,33 +60,54 @@\n \n     /**\n      * Returns the server-side context of the {@link Request} that is being handled in the current thread.\n+     * If the context is a {@link ClientRequestContext}, {@link ClientRequestContext#root()} is returned.\n      *\n      * @throws IllegalStateException if the context is unavailable in the current thread or\n-     *                               the current context is not a {@link ServiceRequestContext}.\n+     *                               the current context is a {@link ClientRequestContext} and\n+     *                               {@link ClientRequestContext#root()} is {@code null}\n      */\n     static ServiceRequestContext current() {\n         final RequestContext ctx = RequestContext.current();\n-        checkState(ctx instanceof ServiceRequestContext,\n-                   \"The current context is not a server-side context: %s\", ctx);\n-        return (ServiceRequestContext) ctx;\n+        if (ctx instanceof ServiceRequestContext) {\n+            return (ServiceRequestContext) ctx;\n+        }\n+\n+        final ServiceRequestContext root = ((ClientRequestContext) ctx).root();\n+        if (root != null) {\n+            return root;\n+        }\n+\n+        throw new IllegalStateException(\n+                \"The current context is not a server-side context and does not have a root \" +\n+                \"which means that the context is not invoked by a server request. ctx:\" + ctx);\n     }\n \n     /**\n      * Returns the server-side context of the {@link Request} that is being handled in the current thread.\n+     * If the context is a {@link ClientRequestContext}, {@link ClientRequestContext#root()} is returned.\n      *\n      * @return the {@link ServiceRequestContext} available in the current thread,\n      *         or {@code null} if unavailable.\n-     * @throws IllegalStateException if the current context is not a {@link ServiceRequestContext}.\n      */\n     @Nullable\n     static ServiceRequestContext currentOrNull() {\n         final RequestContext ctx = RequestContext.currentOrNull();\n         if (ctx == null) {\n             return null;\n         }\n-        checkState(ctx instanceof ServiceRequestContext,\n-                   \"The current context is not a server-side context: %s\", ctx);\n-        return (ServiceRequestContext) ctx;\n+\n+        if (ctx instanceof ServiceRequestContext) {\n+            return (ServiceRequestContext) ctx;\n+        }\n+\n+        final ServiceRequestContext root = ((ClientRequestContext) ctx).root();\n+        if (root != null) {\n+            return root;\n+        }\n+\n+        throw new IllegalStateException(\n+                \"The current context is not a server-side context and does not have a root \" +\n+                \"which means that the context is not invoked by a server request. ctx:\" + ctx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19db059b595f580af5351512a27cd8cca380b3a9"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70e7de6b7666c94ebe72391fa7bccad3b6dd274d", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/70e7de6b7666c94ebe72391fa7bccad3b6dd274d", "committedDate": "2020-01-06T09:35:44Z", "message": "Add space"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTU2ODgz", "url": "https://github.com/line/armeria/pull/2377#pullrequestreview-338556883", "createdAt": "2020-01-06T10:01:30Z", "commit": {"oid": "70e7de6b7666c94ebe72391fa7bccad3b6dd274d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxMDowMTozMVrOFaZp8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxMDowMjozM1rOFaZrfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIyNzYzMg==", "bodyText": "I think we can add readability and some documentation by asserting ClientRequestContext.current and RequestContext.current too.", "url": "https://github.com/line/armeria/pull/2377#discussion_r363227632", "createdAt": "2020-01-06T10:01:31Z", "author": {"login": "anuraaga"}, "path": "core/src/test/java/com/linecorp/armeria/server/ServiceRequestContextTest.java", "diffHunk": "@@ -67,6 +72,11 @@ void currentOrNull() {\n         try (SafeCloseable unused = ctx.push()) {\n             assertThat(onEnterExitStack).hasSize(1);\n             assertThat(ServiceRequestContext.currentOrNull()).isSameAs(ctx);\n+            try (SafeCloseable unused1 = clientRequestContext().push()) {\n+                assertThat(onEnterExitStack).hasSize(2);\n+                assertThat(ServiceRequestContext.currentOrNull()).isSameAs(ctx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70e7de6b7666c94ebe72391fa7bccad3b6dd274d"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIyODAzMQ==", "bodyText": "I think these tests are too loose, and especially with the double-stack, the new test code is not testing anything interesting - we only assert that any context is mounted and mapped, but it may not necessarily be the right context. c == ctx ? \"foo\" : \"bar\"? Or add/read attributes? Not sure which is less tedious.", "url": "https://github.com/line/armeria/pull/2377#discussion_r363228031", "createdAt": "2020-01-06T10:02:33Z", "author": {"login": "anuraaga"}, "path": "core/src/test/java/com/linecorp/armeria/server/ServiceRequestContextTest.java", "diffHunk": "@@ -87,6 +97,12 @@ void mapCurrent() {\n             assertThat(onEnterExitStack).hasSize(1);\n             assertThat(ServiceRequestContext.mapCurrent(c -> \"foo\", () -> \"bar\")).isEqualTo(\"foo\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70e7de6b7666c94ebe72391fa7bccad3b6dd274d"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cecb5108d202ef4b7ac4231060d73955de1531d5", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/cecb5108d202ef4b7ac4231060d73955de1531d5", "committedDate": "2020-01-06T10:27:37Z", "message": "Address comments by @anuraaga"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTc2MTU2", "url": "https://github.com/line/armeria/pull/2377#pullrequestreview-338576156", "createdAt": "2020-01-06T10:43:13Z", "commit": {"oid": "cecb5108d202ef4b7ac4231060d73955de1531d5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxMDo0MzoxM1rOFaakUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxMDo0MzoxM1rOFaakUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI0MjU3Ng==", "bodyText": "nit: The Javadoc said the current context is a {@link ClientRequestContext} and. Don't we need to synchronize this too or revert the Javadoc?", "url": "https://github.com/line/armeria/pull/2377#discussion_r363242576", "createdAt": "2020-01-06T10:43:13Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/ServiceRequestContext.java", "diffHunk": "@@ -61,33 +60,54 @@\n \n     /**\n      * Returns the server-side context of the {@link Request} that is being handled in the current thread.\n+     * If the context is a {@link ClientRequestContext}, {@link ClientRequestContext#root()} is returned.\n      *\n      * @throws IllegalStateException if the context is unavailable in the current thread or\n-     *                               the current context is not a {@link ServiceRequestContext}.\n+     *                               the current context is a {@link ClientRequestContext} and\n+     *                               {@link ClientRequestContext#root()} is {@code null}\n      */\n     static ServiceRequestContext current() {\n         final RequestContext ctx = RequestContext.current();\n-        checkState(ctx instanceof ServiceRequestContext,\n-                   \"The current context is not a server-side context: %s\", ctx);\n-        return (ServiceRequestContext) ctx;\n+        if (ctx instanceof ServiceRequestContext) {\n+            return (ServiceRequestContext) ctx;\n+        }\n+\n+        final ServiceRequestContext root = ((ClientRequestContext) ctx).root();\n+        if (root != null) {\n+            return root;\n+        }\n+\n+        throw new IllegalStateException(\n+                \"The current context is not a server-side context and does not have a root \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cecb5108d202ef4b7ac4231060d73955de1531d5"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a54559b9112e091295291e014a3c606f8e8a651", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/8a54559b9112e091295291e014a3c606f8e8a651", "committedDate": "2020-01-06T11:08:55Z", "message": "Address the comment by @ikhoon"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c27885a3946311cb110c56a69558e371cae4b6ca", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/c27885a3946311cb110c56a69558e371cae4b6ca", "committedDate": "2020-01-06T11:14:18Z", "message": "Revert \"Address the comment by @ikhoon\"\n\nThis reverts commit 8a54559b9112e091295291e014a3c606f8e8a651."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 828, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}