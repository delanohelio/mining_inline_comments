{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NTg4MTEz", "number": 2381, "title": "Remove `EndpointGroupRegistry`, allow specifying `EndpointGroup`", "bodyText": "\u2026when building a client.\nRelated: #1084\nMotivation:\nUsing a 'string' as a way to specify a target endpoint group makes it hard to build a clear dependency between an EndpointGroup and a Client.\nModifications:\n\n(Breaking) Remove EndpointGroupRegistry\nChange the input parameter from Endpoint to EndpointGroup wherever applicable, to allow a user to specify an EndpointGroup when building a client, e.g. Clients.newClient(SessionProtocol, EndpointGroup).\nClientBuilderParams now provides all properties to required for creating a derived Client.\n\n(Breaking) ClientFactory.newClient(ClientBuilderParams) replaced all other newClient() methods.\n\nA user was never supposed to use these methods but Clients.newClient() or Clients.builder() anyway.\n\n\nAdd various public validation methods to ClientFactory, which is used by other ClientFactory implementations and DefaultClientBuilderParams.\n\n\n(Breaking) Endpoint now always refers to a single host.\n\n'group:groupName' notation is not used anymore.\nRemove Endpoint.ofGroup()\nRemove Endpoint.isGroup()\nRemove Endpoint.groupName()\nRemove Endpoint.resolve()\n\n\nEndpointGroup is now an EndpointGroupSelector.\n\n(Breaking) ClientRequestContext.endpointSelector() has been replaced with endpointGroup().\nWhen creating most EndpointGroups, a user can specify an EndpointSelectionStrategy, which is weighted round-robin by default.\nAdd EndpointGroup.selectionStrategy()\nAdd EndpointGroup.of() which requires an EndpointSelectionStrategy\n\n\n(Breaking) Overhaul armeria-retrofit\n\nAdd ArmeriaRetrofit which provides the factory methods for Retrofit and ArmeriaRetrofitBuilder\nA user can now specify a WebClient instead of specifying ClientOptions.\nA user now has much more control over how a WebClient for a non-base URL is created.\n\n\nMiscellaneous:\n\nAdd Clients.isUndefinedUri()\nAdd EmptyEndpointGroupException\n(Deprecation) EndpointSelectionStrategy.ROUND_ROBIN and WEIGHT_ROUND_ROBIN in favor or unweightedRoundRobin() and weightRoundRobin()\n(Deprecation) Some PropertiesEndpointGroup.of() in favor of PropertiesEndpointGroupBuilder.\n(Deprecation) ZooKeeperEndpointGroup constructors in favor of ZooKeeperEndpointGroup.of() and ZooKeeperEndpointGroupBuilder.\n(Breaking) StaticEndpointGroup is not public anymore.\n\n\n\nResult:\n\nMuch cleaner API\nNo group name clashes\nLots of breaking changes if a user was using EndpointGroupRegistry\nextensively.", "createdAt": "2020-01-06T15:22:49Z", "url": "https://github.com/line/armeria/pull/2381", "merged": true, "mergeCommit": {"oid": "c714ec18169945e9655a2a95f08d84b6a18f8fb1"}, "closed": true, "closedAt": "2020-01-13T09:20:57Z", "author": {"login": "trustin"}, "timelineItems": {"totalCount": 41, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3t4SDAH2gAyMzU5NTg4MTEzOjkxY2ExMjI3NjliM2UxZDI4YmY5NWQ0MjNkODc3ZTVhMTA1YTMwYWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb54w0QgFqTM0MTcwODcyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "91ca122769b3e1d28bf95d423d877e5a105a30ac", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/91ca122769b3e1d28bf95d423d877e5a105a30ac", "committedDate": "2020-01-06T15:27:58Z", "message": "Remove `EndpointGroupRegistry` and allow specifying `EndpointGroup` when building a client.\n\nMotivation:\n\nSee #1084\n\nModifications:\n\n- Remove `EndpointGroupRegistry`\n- Make `Endpoint` always refer to a specific host\n- Change the input parameter `Endpoint` to `EndpointGroup` wherever\n  possible, to allow a user to specify an `EndpointGroup` when building\n  a client.\n- `EndpointGroup` now always has its own `EndpointGroupSelector`.\n  - `ClientRequestContext.endpointSelector()` has been replaced with\n    `endpointGroup()`.\n\nResult:\n\n- Much cleaner API\n- No group name clashes\n- Lots of breaking changes if a user was using `EndpointGroupRegistry`\n  extensively.\n\nTo-dos:\n\n- `ClientFactory` internally requires a URI even if an `EndpointGroup`\n  is specified. We need to clean this up.\n- Retrofit `@Url` annotation support\n- Overall Javadoc clean-up, Checkstyle, ..."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5b3ab05368dad79749f4cd41093e66e7a6e5be2", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/f5b3ab05368dad79749f4cd41093e66e7a6e5be2", "committedDate": "2020-01-06T15:16:11Z", "message": "Remove `EndpointGroupRegistry` and allow specifying `EndpointGroup` when building a client.\n\nMotivation:\n\nSee #1084\n\nModifications:\n\n- Remove `EndpointGroupRegistry`\n- Make `Endpoint` always refer to a specific host\n- Change the input parameter `Endpoint` to `EndpointGroup` wherever\n  possible, to allow a user to specify an `EndpointGroup` when building\n  a client.\n- `EndpointGroup` now always has its own `EndpointGroupSelector`.\n  - `ClientRequestContext.endpointSelector()` has been replaced with\n    `endpointGroup()`.\n\nResult:\n\n- Much cleaner API\n- No group name clashes\n- Lots of breaking changes if a user was using `EndpointGroupRegistry`\n  extensively.\n\nTo-dos:\n\n- `ClientFactory` internally requires a URI even if an `EndpointGroup`\n  is specified. We need to clean this up.\n- Retrofit `@Url` annotation support\n- Overall Javadoc clean-up, Checkstyle, ..."}, "afterCommit": {"oid": "91ca122769b3e1d28bf95d423d877e5a105a30ac", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/91ca122769b3e1d28bf95d423d877e5a105a30ac", "committedDate": "2020-01-06T15:27:58Z", "message": "Remove `EndpointGroupRegistry` and allow specifying `EndpointGroup` when building a client.\n\nMotivation:\n\nSee #1084\n\nModifications:\n\n- Remove `EndpointGroupRegistry`\n- Make `Endpoint` always refer to a specific host\n- Change the input parameter `Endpoint` to `EndpointGroup` wherever\n  possible, to allow a user to specify an `EndpointGroup` when building\n  a client.\n- `EndpointGroup` now always has its own `EndpointGroupSelector`.\n  - `ClientRequestContext.endpointSelector()` has been replaced with\n    `endpointGroup()`.\n\nResult:\n\n- Much cleaner API\n- No group name clashes\n- Lots of breaking changes if a user was using `EndpointGroupRegistry`\n  extensively.\n\nTo-dos:\n\n- `ClientFactory` internally requires a URI even if an `EndpointGroup`\n  is specified. We need to clean this up.\n- Retrofit `@Url` annotation support\n- Overall Javadoc clean-up, Checkstyle, ..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "875f242cf1f330c81239f210186012d5f1e02c56", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/875f242cf1f330c81239f210186012d5f1e02c56", "committedDate": "2020-01-07T03:04:45Z", "message": "Use static factory methods for `EndpointSelectionStrategy` / Update docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b18b73bc00be71ee085bc3b082a261cf18fb7ac", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/0b18b73bc00be71ee085bc3b082a261cf18fb7ac", "committedDate": "2020-01-07T07:48:41Z", "message": "Add more properties to `ClientBuilderParams` / Simplify `ClientFactory`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf70322f7bc0df6df67a3f257186fa65d245dfd0", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/bf70322f7bc0df6df67a3f257186fa65d245dfd0", "committedDate": "2020-01-07T08:06:50Z", "message": "Merge branch 'master' into endpoint_group_meets_strategy"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a258f8b373cb7e5d13ff3b46a797c43b25b5aeee", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/a258f8b373cb7e5d13ff3b46a797c43b25b5aeee", "committedDate": "2020-01-07T09:09:55Z", "message": "WIP"}, "afterCommit": {"oid": "cc9b8c5fe20f8f226185b7ef6d10b99ac22e98ed", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/cc9b8c5fe20f8f226185b7ef6d10b99ac22e98ed", "committedDate": "2020-01-07T10:49:40Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e49fb072faefff551288b87ea734e366e4891279", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e49fb072faefff551288b87ea734e366e4891279", "committedDate": "2020-01-07T13:43:36Z", "message": "Make `armeria-retrofit` work again."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc9b8c5fe20f8f226185b7ef6d10b99ac22e98ed", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/cc9b8c5fe20f8f226185b7ef6d10b99ac22e98ed", "committedDate": "2020-01-07T10:49:40Z", "message": "WIP"}, "afterCommit": {"oid": "e49fb072faefff551288b87ea734e366e4891279", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e49fb072faefff551288b87ea734e366e4891279", "committedDate": "2020-01-07T13:43:36Z", "message": "Make `armeria-retrofit` work again."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e55aa3891f2a733c926b6f165007efec0a62d6d", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/9e55aa3891f2a733c926b6f165007efec0a62d6d", "committedDate": "2020-01-07T13:50:22Z", "message": "Fix large stream test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NjMxNTAx", "url": "https://github.com/line/armeria/pull/2381#pullrequestreview-339631501", "createdAt": "2020-01-08T03:35:04Z", "commit": {"oid": "9e55aa3891f2a733c926b6f165007efec0a62d6d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwMzozNTowNFrOFbL9NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwMzozNTowNFrOFbL9NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA1MTc2NQ==", "bodyText": "nit: Can revert? \ud83d\ude09", "url": "https://github.com/line/armeria/pull/2381#discussion_r364051765", "createdAt": "2020-01-08T03:35:04Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientBuilder.java", "diffHunk": "@@ -94,41 +96,41 @@ public ClientBuilder(URI uri) {\n      * Creates a new {@link ClientBuilder} that builds the client that connects to the specified\n      * {@link Endpoint} with the {@code scheme}.\n      *\n-     * @deprecated Use {@link Clients#builder(String, Endpoint)}.\n+     * @deprecated Use {@link Clients#builder(String, EndpointGroup)}.\n      */\n     @Deprecated\n-    public ClientBuilder(String scheme, Endpoint endpoint) {\n-        this(Scheme.parse(requireNonNull(scheme, \"scheme\")), requireNonNull(endpoint, \"endpoint\"));\n+    public ClientBuilder(String scheme, Endpoint endpointGroup) {\n+        this(Scheme.parse(requireNonNull(scheme, \"scheme\")), requireNonNull(endpointGroup, \"endpoint\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e55aa3891f2a733c926b6f165007efec0a62d6d"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e116a7ccdb2993a1364d5529fb72132aba094808", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e116a7ccdb2993a1364d5529fb72132aba094808", "committedDate": "2020-01-08T05:18:18Z", "message": "Revert bad changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NjU1Mjcy", "url": "https://github.com/line/armeria/pull/2381#pullrequestreview-339655272", "createdAt": "2020-01-08T05:42:04Z", "commit": {"oid": "e116a7ccdb2993a1364d5529fb72132aba094808"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwNTo0MjowNFrOFbNJHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwNTo0MjowNFrOFbNJHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA3MTE5Nw==", "bodyText": "I'm not quite understanding, why do we need to map URL to endpoint group instead of just accepting a single endpoint group used for the retrofit client, similar to the normal web client?", "url": "https://github.com/line/armeria/pull/2381#discussion_r364071197", "createdAt": "2020-01-08T05:42:04Z", "author": {"login": "anuraaga"}, "path": "retrofit2/src/main/java/com/linecorp/armeria/client/retrofit2/ArmeriaRetrofitBuilder.java", "diffHunk": "@@ -77,91 +84,47 @@\n     private static final String SLASH = \"/\";\n \n     private final Retrofit.Builder retrofitBuilder;\n-    private final ClientFactory clientFactory;\n-    @Nullable\n-    private String baseUrl;\n+    private final ImmutableMap.Builder<String, EndpointGroup> endpointGroups = ImmutableMap.builder();\n+\n     private boolean streaming;\n     private Executor callbackExecutor = CommonPools.blockingTaskExecutor();\n-    private BiFunction<String, ? super ClientOptionsBuilder, ClientOptionsBuilder> configurator =\n-            DEFAULT_CONFIGURATOR;\n \n-    /**\n-     * Creates a {@link ArmeriaRetrofitBuilder} with the default {@link ClientFactory}.\n-     */\n-    public ArmeriaRetrofitBuilder() {\n-        this(ClientFactory.ofDefault());\n-    }\n+    private Function<? super HttpUrl, ? extends EndpointGroup> endpointGroupMapping =\n+            url -> Endpoint.of(url.host(), url.port());\n \n-    /**\n-     * Creates a {@link ArmeriaRetrofitBuilder} with the specified {@link ClientFactory}.\n-     */\n-    public ArmeriaRetrofitBuilder(ClientFactory clientFactory) {\n-        this.clientFactory = requireNonNull(clientFactory, \"clientFactory\");\n-        retrofitBuilder = new Retrofit.Builder();\n-    }\n+    // FIXME(trustin): Do some caching.\n+    private BiFunction<? super EndpointGroup, ? super HttpUrl, ? extends WebClient> webClientMapping =\n+            (endpointGroup, url) -> WebClient.of(url.isHttps() ? SessionProtocol.HTTPS : SessionProtocol.HTTP,\n+                                                 endpointGroup);\n \n-    /**\n-     * Sets the API base URL.\n-     *\n-     * @see Builder#baseUrl(String)\n-     */\n-    public ArmeriaRetrofitBuilder baseUrl(String baseUrl) {\n-        return baseUrl(URI.create(requireNonNull(baseUrl, \"baseUrl\")));\n+    ArmeriaRetrofitBuilder(HttpUrl baseUrl) {\n+        retrofitBuilder = new Retrofit.Builder().baseUrl(baseUrl);\n     }\n \n-    /**\n-     * Sets the API base URL.\n-     *\n-     * @see Builder#baseUrl(String)\n-     */\n-    public ArmeriaRetrofitBuilder baseUrl(URI baseUrl) {\n-        requireNonNull(baseUrl, \"baseUrl\");\n-        checkArgument(SessionProtocol.find(baseUrl.getScheme()) != null,\n-                      \"baseUrl must have an HTTP scheme: %s\", baseUrl);\n-        final String path = baseUrl.getPath();\n-        if (!path.isEmpty() && !SLASH.equals(path.substring(path.length() - 1))) {\n-            throw new IllegalArgumentException(\"baseUrl must end with /: \" + baseUrl);\n-        }\n-        this.baseUrl = baseUrl.toString();\n+    public ArmeriaRetrofitBuilder endpointGroup(\n+            Function<? super HttpUrl, ? extends EndpointGroup> endpointGroupMapping) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e116a7ccdb2993a1364d5529fb72132aba094808"}, "originalPosition": 108}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e81590e0821219d647896a734340bf8f4a333c86", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e81590e0821219d647896a734340bf8f4a333c86", "committedDate": "2020-01-08T07:43:06Z", "message": "Checkstyle / Javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fdf2cfc954cae69520de577e76252a2858f989b", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/8fdf2cfc954cae69520de577e76252a2858f989b", "committedDate": "2020-01-08T08:08:52Z", "message": "Fix site error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d49f25836b8460fd9e3a92a2f9fbc797c77adb07", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/d49f25836b8460fd9e3a92a2f9fbc797c77adb07", "committedDate": "2020-01-08T08:34:45Z", "message": "Merge branch 'master' into endpoint_group_meets_strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d94fca209ae06a0baff72d46a97c7c12f0634624", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/d94fca209ae06a0baff72d46a97c7c12f0634624", "committedDate": "2020-01-08T15:29:49Z", "message": "(Maybe) Address the comments from @anuraaga\n\n- A user can now specify the base `WebClient` when building `Retrofit`\n  with `ArmeriaRetrofit`.\n- Removed `ArmeriaRetrofitBuilder.endpointGroup()`\n- Replaced `ArmeriaRetrofitBuilder.webClient()` with\n  `nonBaseWebClientFactory()`.\n  - The biggest difference is that it is used only for non-base URLs."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "189c3e2a837d1a2f4d4768bc15f4c0498a3d60d2", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/189c3e2a837d1a2f4d4768bc15f4c0498a3d60d2", "committedDate": "2020-01-08T09:26:15Z", "message": "WIP"}, "afterCommit": {"oid": "d94fca209ae06a0baff72d46a97c7c12f0634624", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/d94fca209ae06a0baff72d46a97c7c12f0634624", "committedDate": "2020-01-08T15:29:49Z", "message": "(Maybe) Address the comments from @anuraaga\n\n- A user can now specify the base `WebClient` when building `Retrofit`\n  with `ArmeriaRetrofit`.\n- Removed `ArmeriaRetrofitBuilder.endpointGroup()`\n- Replaced `ArmeriaRetrofitBuilder.webClient()` with\n  `nonBaseWebClientFactory()`.\n  - The biggest difference is that it is used only for non-base URLs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d0f543aa9a3aaeb3cb387a3dee1a72c88ba4e38", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/8d0f543aa9a3aaeb3cb387a3dee1a72c88ba4e38", "committedDate": "2020-01-08T15:41:49Z", "message": "Fix benchmark"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb4160f1319b12653e0113d6e54bc5211f1975f6", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/eb4160f1319b12653e0113d6e54bc5211f1975f6", "committedDate": "2020-01-09T05:39:34Z", "message": "Merge branch 'master' into endpoint_group_meets_strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e9410b21a3fbc3793432b3ec887126bc1a11a74", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/0e9410b21a3fbc3793432b3ec887126bc1a11a74", "committedDate": "2020-01-09T06:29:47Z", "message": "Clean-up / EndpointGroup extends EndpointSelector"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMzEyMTQ5", "url": "https://github.com/line/armeria/pull/2381#pullrequestreview-340312149", "createdAt": "2020-01-09T06:35:03Z", "commit": {"oid": "0e9410b21a3fbc3793432b3ec887126bc1a11a74"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwNjozNTowM1rOFbsCeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwNzoxMzozOVrOFbsksg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU3NzQwMQ==", "bodyText": "How about expected: an absolute path starting with /? Actually I misunderstood at first and in a quick search found a couple other places that use the word absolute path to refer to an absolute url (starting with host)\nhttp://www.geeksengine.com/article/absolute-relative-path.html\nhttps://www.coffeecup.com/help/articles/absolute-vs-relative-pathslinks/", "url": "https://github.com/line/armeria/pull/2381#discussion_r364577401", "createdAt": "2020-01-09T06:35:03Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientBuilder.java", "diffHunk": "@@ -143,17 +145,18 @@ public ClientBuilder factory(ClientFactory factory) {\n      * Sets the {@code path} of the client.\n      */\n     public ClientBuilder path(String path) {\n-        ensureEndpoint();\n-\n-        this.path = requireNonNull(path, \"path\");\n+        ensureEndpointGroup();\n+        requireNonNull(path, \"path\");\n+        checkArgument(path.startsWith(\"/\"), \"path: %s (expected: an absolute path)\", path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e9410b21a3fbc3793432b3ec887126bc1a11a74"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU3NzY5Mg==", "bodyText": "Maybe overkill but had a thought there is probably a compile-time way of ensuring this (UriClientBuilder vs EndpointClientBuilder interfaces)", "url": "https://github.com/line/armeria/pull/2381#discussion_r364577692", "createdAt": "2020-01-09T06:36:24Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientBuilder.java", "diffHunk": "@@ -173,24 +176,29 @@ public ClientBuilder serializationFormat(SerializationFormat format) {\n     public <T> T build(Class<T> clientType) {\n         requireNonNull(clientType, \"clientType\");\n \n+        final Object client;\n         if (uri != null) {\n-            return factory.newClient(uri, clientType, buildOptions());\n-        } else if (path != null) {\n-            return factory.newClient(scheme(), endpoint, path, clientType, buildOptions());\n+            client = factory.newClient(ClientBuilderParams.of(factory, uri, clientType, buildOptions()));\n         } else {\n-            return factory.newClient(scheme(), endpoint, clientType, buildOptions());\n+            assert endpointGroup != null;\n+            client = factory.newClient(ClientBuilderParams.of(factory, scheme(), endpointGroup,\n+                                                              path, clientType, buildOptions()));\n         }\n+\n+        @SuppressWarnings(\"unchecked\")\n+        final T cast = (T) client;\n+        return cast;\n     }\n \n     private Scheme scheme() {\n         return scheme == null ? Scheme.of(format, protocol) : scheme;\n     }\n \n-    private void ensureEndpoint() {\n-        if (endpoint == null) {\n+    private void ensureEndpointGroup() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e9410b21a3fbc3793432b3ec887126bc1a11a74"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU4MTQxMw==", "bodyText": "So I guess here if the request is to an absolute URI, there's no way to make it use an endpoint group. This seems fine to me since endpoint groups are generally well known anyways and users can have a client for each. Why do we support endpoint group resolution of @Url for retrofit, but not here?", "url": "https://github.com/line/armeria/pull/2381#discussion_r364581413", "createdAt": "2020-01-09T06:53:07Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultWebClient.java", "diffHunk": "@@ -69,7 +67,7 @@ public HttpResponse execute(HttpRequest req) {\n             return execute(endpoint, newReq);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e9410b21a3fbc3793432b3ec887126bc1a11a74"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU4MjUxNA==", "bodyText": "Nice cleanup :)", "url": "https://github.com/line/armeria/pull/2381#discussion_r364582514", "createdAt": "2020-01-09T06:57:56Z", "author": {"login": "anuraaga"}, "path": "core/src/test/java/com/linecorp/armeria/client/HttpClientIntegrationTest.java", "diffHunk": "@@ -420,20 +418,14 @@ void testUnresolvedEndpointWithAlternateAuthority() throws Exception {\n     }\n \n     private static void testEndpointWithAlternateAuthority(EndpointGroup group) {\n-        final String groupName = \"testEndpointWithAlternateAuthority\";\n-        EndpointGroupRegistry.register(groupName, group, EndpointSelectionStrategy.ROUND_ROBIN);\n-        try {\n-            final WebClient client = WebClient.builder(\"http://group:\" + groupName)\n-                                              .setHttpHeader(HttpHeaderNames.AUTHORITY,\n-                                                             \"255.255.255.255.xip.io\")\n-                                              .build();\n-\n-            final AggregatedHttpResponse res = client.get(\"/hello/world\").aggregate().join();\n-            assertThat(res.status()).isEqualTo(HttpStatus.OK);\n-            assertThat(res.contentUtf8()).isEqualTo(\"success\");\n-        } finally {\n-            EndpointGroupRegistry.unregister(groupName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e9410b21a3fbc3793432b3ec887126bc1a11a74"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU4NTIzNw==", "bodyText": "Since normal usage doesn't need to worry about this, I guess it's ok. But doesn't it seem like too advanced functionality? The asymmetry vs WebClient (the one I pointed to above) seems unnatural too - if we really want this functionality, we could move it to a ClientOption so it applies to both?\nAnd while it doesn't actually solve the asymmetry problem by itself, I'm wondering whether we could just let the EndpointSelector layer take care of it, it seems simpler to reason about and don't even need to worry about a client cache\nclass HostAwareEndpointGroup implements EndpointGroup {\n  public Endpoint select(ClientRequestContext ctx) {\n    switch (ctx.request().authority()) {\n      case \"group-bar\":\n        return groupBarEndpointGroup.select(ctx);\n      ...", "url": "https://github.com/line/armeria/pull/2381#discussion_r364585237", "createdAt": "2020-01-09T07:09:33Z", "author": {"login": "anuraaga"}, "path": "retrofit2/src/main/java/com/linecorp/armeria/client/retrofit2/ArmeriaRetrofitBuilder.java", "diffHunk": "@@ -41,127 +39,118 @@\n import retrofit2.Callback;\n import retrofit2.Converter;\n import retrofit2.Retrofit;\n-import retrofit2.Retrofit.Builder;\n import retrofit2.http.Streaming;\n \n /**\n- * A helper class for creating a new {@link Retrofit} instance with {@link ArmeriaCallFactory}.\n- * For example,\n- *\n- * <pre>{@code\n- * Retrofit retrofit = new ArmeriaRetrofitBuilder()\n- *     .baseUrl(\"http://localhost:8080/\")\n- *     .build();\n- *\n- * MyApi api = retrofit.create(MyApi.class);\n- * Response<User> user = api.getUser().execute();\n- * }</pre>\n- *\n- * <p>{@link ArmeriaRetrofitBuilder} even supports {@link EndpointGroup}, so you can create {@link Retrofit}\n- * like below,\n+ * A builder that creates a {@link Retrofit} which uses {@link WebClient} for sending requests.\n  *\n- * <pre>{@code\n- * EndpointGroupRegistry.register(\"foo\",\n- *                                new StaticEndpointGroup(Endpoint.of(\"127.0.0.1\", 8080)),\n- *                                ROUND_ROBIN);\n- *\n- * Retrofit retrofit = new ArmeriaRetrofitBuilder()\n- *     .baseUrl(\"http://group:foo/\")\n- *     .build();\n- * }</pre>\n+ * @see ArmeriaRetrofit\n  */\n public final class ArmeriaRetrofitBuilder {\n \n-    private static final BiFunction<String, ? super ClientOptionsBuilder, ClientOptionsBuilder>\n-            DEFAULT_CONFIGURATOR = (url, optionsBuilder) -> optionsBuilder;\n-    private static final String SLASH = \"/\";\n-\n     private final Retrofit.Builder retrofitBuilder;\n-    private final ClientFactory clientFactory;\n-    @Nullable\n-    private String baseUrl;\n+    private final String baseWebClientHost;\n+    private final int baseWebClientPort;\n+    private final WebClient baseWebClient;\n+\n     private boolean streaming;\n     private Executor callbackExecutor = CommonPools.blockingTaskExecutor();\n-    private BiFunction<String, ? super ClientOptionsBuilder, ClientOptionsBuilder> configurator =\n-            DEFAULT_CONFIGURATOR;\n+    private BiFunction<? super SessionProtocol, ? super HttpUrl, ? extends WebClient> nonBaseClientFactory;\n \n-    /**\n-     * Creates a {@link ArmeriaRetrofitBuilder} with the default {@link ClientFactory}.\n-     */\n-    public ArmeriaRetrofitBuilder() {\n-        this(ClientFactory.ofDefault());\n-    }\n+    ArmeriaRetrofitBuilder(WebClient webClient) {\n+        final URI uri = webClient.uri();\n+        final SessionProtocol protocol = webClient.scheme().sessionProtocol();\n \n-    /**\n-     * Creates a {@link ArmeriaRetrofitBuilder} with the specified {@link ClientFactory}.\n-     */\n-    public ArmeriaRetrofitBuilder(ClientFactory clientFactory) {\n-        this.clientFactory = requireNonNull(clientFactory, \"clientFactory\");\n-        retrofitBuilder = new Retrofit.Builder();\n-    }\n+        // Build a baseUrl that will pass Retrofit's validation.\n+        final HttpUrl baseUrl = HttpUrl.get((protocol.isTls() ? \"https\" : \"http\") +\n+                                            uri.toString().substring(protocol.uriText().length()));\n \n-    /**\n-     * Sets the API base URL.\n-     *\n-     * @see Builder#baseUrl(String)\n-     */\n-    public ArmeriaRetrofitBuilder baseUrl(String baseUrl) {\n-        return baseUrl(URI.create(requireNonNull(baseUrl, \"baseUrl\")));\n-    }\n+        retrofitBuilder = new Retrofit.Builder().baseUrl(baseUrl);\n+        baseWebClientHost = baseUrl.host();\n+        baseWebClientPort = baseUrl.port();\n \n-    /**\n-     * Sets the API base URL.\n-     *\n-     * @see Builder#baseUrl(String)\n-     */\n-    public ArmeriaRetrofitBuilder baseUrl(URI baseUrl) {\n-        requireNonNull(baseUrl, \"baseUrl\");\n-        checkArgument(SessionProtocol.find(baseUrl.getScheme()) != null,\n-                      \"baseUrl must have an HTTP scheme: %s\", baseUrl);\n-        final String path = baseUrl.getPath();\n-        if (!path.isEmpty() && !SLASH.equals(path.substring(path.length() - 1))) {\n-            throw new IllegalArgumentException(\"baseUrl must end with /: \" + baseUrl);\n-        }\n-        this.baseUrl = baseUrl.toString();\n-        return this;\n-    }\n+        // Re-create the base client without a path, because Retrofit will always provide a full path.\n+        baseWebClient = WebClient.builder(protocol,\n+                                          webClient.endpointGroup())\n+                                 .factory(webClient.factory())\n+                                 .options(webClient.options())\n+                                 .build();\n \n-    /**\n-     * Sets the {@link ClientOptions} that customizes the underlying {@link WebClient}.\n-     * This method can be useful if you already have an Armeria client and want to reuse its configuration,\n-     * such as using the same decorators.\n-     * <pre>{@code\n-     * WebClient myClient = ...;\n-     * // Use the same settings and decorators with `myClient` when sending requests.\n-     * builder.clientOptions(myClient.options());\n-     * }</pre>\n-     */\n-    public ArmeriaRetrofitBuilder clientOptions(ClientOptions clientOptions) {\n-        requireNonNull(clientOptions, \"clientOptions\");\n-        return withClientOptions((uri, b) -> b.options(clientOptions));\n+        nonBaseClientFactory = (p, url) -> WebClient.builder(p, Endpoint.of(url.host(), url.port()))\n+                                                    .factory(baseWebClient.factory())\n+                                                    .options(baseWebClient.options())\n+                                                    .build();\n     }\n \n     /**\n-     * Sets the {@link BiFunction} that customizes the underlying {@link WebClient}.\n+     * Specifies the {@link BiFunction} that creates a new non-base {@link WebClient}, which is used for\n+     * sending requests to other authorities than that of base URL. If not specified, the non-base\n+     * {@link WebClient} will have the same options with the base {@link WebClient}, which was specified\n+     * with {@link ArmeriaRetrofit#of(WebClient)} or {@link ArmeriaRetrofit#builder(WebClient)}.\n+     *\n+     * <p>To avoid the overhead of repetitive instantiation of {@link WebClient}s, the {@link WebClient}s\n+     * returned by the specified {@link BiFunction} will be cached for each combination of:\n+     * <ul>\n+     *   <li>Whether the connection is secured (HTTPS or HTTPS)</li>\n+     *   <li>Host name</li>\n+     *   <li>Port number</li>\n+     * </ul></p>\n+     *\n+     * <p>You can use this method to create a customized non-base {@link WebClient}, for example to send\n+     * an additional header, override the timeout, enforce HTTP/1 or even override the target host:\n      * <pre>{@code\n-     * builder.withClientOptions((uri, b) -> {\n-     *     if (uri.startsWith(\"https://foo.com/\")) {\n-     *         return b.setHttpHeader(HttpHeaders.AUTHORIZATION,\n-     *                                \"bearer my-access-token\")\n-     *                 .responseTimeout(Duration.ofSeconds(3));\n-     *     } else {\n-     *         return b;\n-     *     }\n-     * });\n-     * }</pre>\n+     * EndpointGroup groupFoo = EndpointGroup.of(Endpoint.of(\"node-1.foo.com\"),\n+     *                                           Endpoint.of(\"node-2.foo.com\"));\n+     * EndpointGroup groupBar = EndpointGroup.of(Endpoint.of(\"node-1.bar.com\"),\n+     *                                           Endpoint.of(\"node-2.bar.com\"));\n+     *\n+     * WebClient defaultWebClient = WebClient.of(SessionProtocol.HTTP, groupFoo);\n+     *\n+     * ArmeriaRetrofit.builder(defaultWebClient)\n+     *                .nonBaseClientFactory((protocol, url) -> {\n+     *                    // Enforce HTTP/1.\n+     *                    final SessionProtocol actualProtocol =\n+     *                            protocol.isTls() ? SessionProtocol.H1 : SessionProtocol.H1C;\n+     *\n+     *                    final EndpointGroup actualEndpointGroup;\n+     *                    if (\"group-bar\".equals(url.host())) {\n+     *                        // Client-side load-balancing:\n+     *                        // - Make the request go to 'node-1.bar.com' or 'node-2.bar.com'\n+     *                        //   if the target host is 'group-bar'.\n+     *                        actualEndpointGroup = groupBar;\n+     *                    } else {\n+     *                        // Use the given host and port otherwise.\n+     *                        actualEndpointGroup = Endpoint.of(url.host(), url.port());\n+     *                    }\n      *\n-     * @param configurator a {@link BiFunction} whose first argument is the the URI of the server endpoint and\n-     *                     whose second argument is the {@link ClientOptionsBuilder} with default options of\n-     *                     the new derived client\n+     *                    return WebClient.builder(actualProtocol, actualEndpointGroup)\n+     *                                    // Derive most settings from 'defaultWebClient'.\n+     *                                    .factory(defaultWebClient.factory())\n+     *                                    .options(defaultWebClient.options())\n+     *                                    // Set a custom header.\n+     *                                    .setHttpHeader(HttpHeaderNames.AUTHORIZATION,\n+     *                                                   \"bearer my-access-token\")\n+     *                                    // Override the timeout.\n+     *                                    .responseTimeout(Duration.ofSeconds(30))\n+     *                                    .build();\n+     *                })\n+     *                .build();\n+     * }</pre></p>\n+     *\n+     * <p>Note that the specified {@link BiFunction} is not used for sending requests to the base URL's\n+     * authority. The default {@link WebClient} specified with {@link ArmeriaRetrofit#of(WebClient)} or\n+     * {@link ArmeriaRetrofit#builder(WebClient)} will be used instead for such requests:\n+     * <pre>{@code\n+     * // No need to use 'nonBaseClientFactory()' method.\n+     * ArmeriaRetrofit.of(WebClient.builder(\"http://example.com/\")\n+     *                             .setHttpHeader(HttpHeaderNames.AUTHORIZATION,\n+     *                                            \"bearer my-access-token\")\n+     *                             .build());\n+     * }</pre></p>\n      */\n-    public ArmeriaRetrofitBuilder withClientOptions(\n-            BiFunction<String, ? super ClientOptionsBuilder, ClientOptionsBuilder> configurator) {\n-        this.configurator = requireNonNull(configurator, \"configurator\");\n+    public ArmeriaRetrofitBuilder nonBaseClientFactory(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e9410b21a3fbc3793432b3ec887126bc1a11a74"}, "originalPosition": 242}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU4NjE2Mg==", "bodyText": "If this is the cache key, I guess it should only be these three fields that are passed to the callback, not HttpUrl - it's possible to create a broken callback if inspecting other fields of HttpUrl.", "url": "https://github.com/line/armeria/pull/2381#discussion_r364586162", "createdAt": "2020-01-09T07:13:39Z", "author": {"login": "anuraaga"}, "path": "retrofit2/src/main/java/com/linecorp/armeria/client/retrofit2/ArmeriaRetrofitBuilder.java", "diffHunk": "@@ -41,127 +39,118 @@\n import retrofit2.Callback;\n import retrofit2.Converter;\n import retrofit2.Retrofit;\n-import retrofit2.Retrofit.Builder;\n import retrofit2.http.Streaming;\n \n /**\n- * A helper class for creating a new {@link Retrofit} instance with {@link ArmeriaCallFactory}.\n- * For example,\n- *\n- * <pre>{@code\n- * Retrofit retrofit = new ArmeriaRetrofitBuilder()\n- *     .baseUrl(\"http://localhost:8080/\")\n- *     .build();\n- *\n- * MyApi api = retrofit.create(MyApi.class);\n- * Response<User> user = api.getUser().execute();\n- * }</pre>\n- *\n- * <p>{@link ArmeriaRetrofitBuilder} even supports {@link EndpointGroup}, so you can create {@link Retrofit}\n- * like below,\n+ * A builder that creates a {@link Retrofit} which uses {@link WebClient} for sending requests.\n  *\n- * <pre>{@code\n- * EndpointGroupRegistry.register(\"foo\",\n- *                                new StaticEndpointGroup(Endpoint.of(\"127.0.0.1\", 8080)),\n- *                                ROUND_ROBIN);\n- *\n- * Retrofit retrofit = new ArmeriaRetrofitBuilder()\n- *     .baseUrl(\"http://group:foo/\")\n- *     .build();\n- * }</pre>\n+ * @see ArmeriaRetrofit\n  */\n public final class ArmeriaRetrofitBuilder {\n \n-    private static final BiFunction<String, ? super ClientOptionsBuilder, ClientOptionsBuilder>\n-            DEFAULT_CONFIGURATOR = (url, optionsBuilder) -> optionsBuilder;\n-    private static final String SLASH = \"/\";\n-\n     private final Retrofit.Builder retrofitBuilder;\n-    private final ClientFactory clientFactory;\n-    @Nullable\n-    private String baseUrl;\n+    private final String baseWebClientHost;\n+    private final int baseWebClientPort;\n+    private final WebClient baseWebClient;\n+\n     private boolean streaming;\n     private Executor callbackExecutor = CommonPools.blockingTaskExecutor();\n-    private BiFunction<String, ? super ClientOptionsBuilder, ClientOptionsBuilder> configurator =\n-            DEFAULT_CONFIGURATOR;\n+    private BiFunction<? super SessionProtocol, ? super HttpUrl, ? extends WebClient> nonBaseClientFactory;\n \n-    /**\n-     * Creates a {@link ArmeriaRetrofitBuilder} with the default {@link ClientFactory}.\n-     */\n-    public ArmeriaRetrofitBuilder() {\n-        this(ClientFactory.ofDefault());\n-    }\n+    ArmeriaRetrofitBuilder(WebClient webClient) {\n+        final URI uri = webClient.uri();\n+        final SessionProtocol protocol = webClient.scheme().sessionProtocol();\n \n-    /**\n-     * Creates a {@link ArmeriaRetrofitBuilder} with the specified {@link ClientFactory}.\n-     */\n-    public ArmeriaRetrofitBuilder(ClientFactory clientFactory) {\n-        this.clientFactory = requireNonNull(clientFactory, \"clientFactory\");\n-        retrofitBuilder = new Retrofit.Builder();\n-    }\n+        // Build a baseUrl that will pass Retrofit's validation.\n+        final HttpUrl baseUrl = HttpUrl.get((protocol.isTls() ? \"https\" : \"http\") +\n+                                            uri.toString().substring(protocol.uriText().length()));\n \n-    /**\n-     * Sets the API base URL.\n-     *\n-     * @see Builder#baseUrl(String)\n-     */\n-    public ArmeriaRetrofitBuilder baseUrl(String baseUrl) {\n-        return baseUrl(URI.create(requireNonNull(baseUrl, \"baseUrl\")));\n-    }\n+        retrofitBuilder = new Retrofit.Builder().baseUrl(baseUrl);\n+        baseWebClientHost = baseUrl.host();\n+        baseWebClientPort = baseUrl.port();\n \n-    /**\n-     * Sets the API base URL.\n-     *\n-     * @see Builder#baseUrl(String)\n-     */\n-    public ArmeriaRetrofitBuilder baseUrl(URI baseUrl) {\n-        requireNonNull(baseUrl, \"baseUrl\");\n-        checkArgument(SessionProtocol.find(baseUrl.getScheme()) != null,\n-                      \"baseUrl must have an HTTP scheme: %s\", baseUrl);\n-        final String path = baseUrl.getPath();\n-        if (!path.isEmpty() && !SLASH.equals(path.substring(path.length() - 1))) {\n-            throw new IllegalArgumentException(\"baseUrl must end with /: \" + baseUrl);\n-        }\n-        this.baseUrl = baseUrl.toString();\n-        return this;\n-    }\n+        // Re-create the base client without a path, because Retrofit will always provide a full path.\n+        baseWebClient = WebClient.builder(protocol,\n+                                          webClient.endpointGroup())\n+                                 .factory(webClient.factory())\n+                                 .options(webClient.options())\n+                                 .build();\n \n-    /**\n-     * Sets the {@link ClientOptions} that customizes the underlying {@link WebClient}.\n-     * This method can be useful if you already have an Armeria client and want to reuse its configuration,\n-     * such as using the same decorators.\n-     * <pre>{@code\n-     * WebClient myClient = ...;\n-     * // Use the same settings and decorators with `myClient` when sending requests.\n-     * builder.clientOptions(myClient.options());\n-     * }</pre>\n-     */\n-    public ArmeriaRetrofitBuilder clientOptions(ClientOptions clientOptions) {\n-        requireNonNull(clientOptions, \"clientOptions\");\n-        return withClientOptions((uri, b) -> b.options(clientOptions));\n+        nonBaseClientFactory = (p, url) -> WebClient.builder(p, Endpoint.of(url.host(), url.port()))\n+                                                    .factory(baseWebClient.factory())\n+                                                    .options(baseWebClient.options())\n+                                                    .build();\n     }\n \n     /**\n-     * Sets the {@link BiFunction} that customizes the underlying {@link WebClient}.\n+     * Specifies the {@link BiFunction} that creates a new non-base {@link WebClient}, which is used for\n+     * sending requests to other authorities than that of base URL. If not specified, the non-base\n+     * {@link WebClient} will have the same options with the base {@link WebClient}, which was specified\n+     * with {@link ArmeriaRetrofit#of(WebClient)} or {@link ArmeriaRetrofit#builder(WebClient)}.\n+     *\n+     * <p>To avoid the overhead of repetitive instantiation of {@link WebClient}s, the {@link WebClient}s\n+     * returned by the specified {@link BiFunction} will be cached for each combination of:\n+     * <ul>\n+     *   <li>Whether the connection is secured (HTTPS or HTTPS)</li>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e9410b21a3fbc3793432b3ec887126bc1a11a74"}, "originalPosition": 169}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af0d9ce97bd14d9712164c4fe6ff39d76b4cb6ab", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/af0d9ce97bd14d9712164c4fe6ff39d76b4cb6ab", "committedDate": "2020-01-09T07:48:13Z", "message": "Absolute path starting with '/'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NzE2NTMz", "url": "https://github.com/line/armeria/pull/2381#pullrequestreview-339716533", "createdAt": "2020-01-08T08:50:26Z", "commit": {"oid": "d49f25836b8460fd9e3a92a2f9fbc797c77adb07"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwODo1MDoyNlrOFbQDXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwOToxODo1OFrOFbQxiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExODg3Ng==", "bodyText": "nit: delegate().newClient( -> newClient(", "url": "https://github.com/line/armeria/pull/2381#discussion_r364118876", "createdAt": "2020-01-08T08:50:26Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/DecoratingClientFactory.java", "diffHunk": "@@ -49,10 +49,28 @@ protected DecoratingClientFactory(ClientFactory delegate) {\n     /**\n      * Returns the delegate {@link ClientFactory}.\n      */\n-    protected ClientFactory delegate() {\n+    protected final ClientFactory delegate() {\n         return delegate;\n     }\n \n+    /**\n+     * Creates a new {@link HttpClient} which uses the same {@link SessionProtocol}, {@link EndpointGroup} and\n+     * {@link ClientOptions} with the specified {@link ClientBuilderParams}. Note that {@code path} and\n+     * {@link SerializationFormat} are always {@code \"/\"} and {@link SerializationFormat#NONE}.\n+     */\n+    protected final HttpClient newHttpClientDelegate(ClientBuilderParams params) {\n+        final URI uri = params.uri();\n+        if (Clients.isUndefinedUri(uri)) {\n+            return (HttpClient) delegate().newClient(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d49f25836b8460fd9e3a92a2f9fbc797c77adb07"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExODkyNg==", "bodyText": "ditto", "url": "https://github.com/line/armeria/pull/2381#discussion_r364118926", "createdAt": "2020-01-08T08:50:34Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/DecoratingClientFactory.java", "diffHunk": "@@ -49,10 +49,28 @@ protected DecoratingClientFactory(ClientFactory delegate) {\n     /**\n      * Returns the delegate {@link ClientFactory}.\n      */\n-    protected ClientFactory delegate() {\n+    protected final ClientFactory delegate() {\n         return delegate;\n     }\n \n+    /**\n+     * Creates a new {@link HttpClient} which uses the same {@link SessionProtocol}, {@link EndpointGroup} and\n+     * {@link ClientOptions} with the specified {@link ClientBuilderParams}. Note that {@code path} and\n+     * {@link SerializationFormat} are always {@code \"/\"} and {@link SerializationFormat#NONE}.\n+     */\n+    protected final HttpClient newHttpClientDelegate(ClientBuilderParams params) {\n+        final URI uri = params.uri();\n+        if (Clients.isUndefinedUri(uri)) {\n+            return (HttpClient) delegate().newClient(\n+                    ClientBuilderParams.of(delegate(), uri, HttpClient.class, params.options()));\n+        }\n+\n+        final Scheme newScheme = Scheme.of(SerializationFormat.NONE, params.scheme().sessionProtocol());\n+        return (HttpClient) delegate().newClient(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d49f25836b8460fd9e3a92a2f9fbc797c77adb07"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEyMTIwNA==", "bodyText": "Perhaps, it's good to check the path is absolute by checking the first character?", "url": "https://github.com/line/armeria/pull/2381#discussion_r364121204", "createdAt": "2020-01-08T08:56:05Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientBuilderParams.java", "diffHunk": "@@ -43,16 +54,80 @@\n     public DefaultClientBuilderParams(ClientFactory factory, URI uri, Class<?> type,\n                                       ClientOptions options) {\n         this.factory = requireNonNull(factory, \"factory\");\n-        this.uri = requireNonNull(uri, \"uri\");\n+        this.uri = factory.validateUri(uri);\n+        this.type = requireNonNull(type, \"type\");\n+        this.options = requireNonNull(options, \"options\");\n+\n+        scheme = factory.validateScheme(Scheme.parse(uri.getScheme()));\n+        endpointGroup = Endpoint.parse(uri.getRawAuthority());\n+\n+        final StringBuilder buf = TemporaryThreadLocals.get().stringBuilder();\n+        buf.append(nullOrEmptyToSlash(uri.getRawPath()));\n+        if (uri.getRawQuery() != null) {\n+            buf.append('?').append(uri.getRawQuery());\n+        }\n+        if (uri.getRawFragment() != null) {\n+            buf.append('#').append(uri.getRawFragment());\n+        }\n+        absolutePathRef = buf.toString();\n+    }\n+\n+    DefaultClientBuilderParams(ClientFactory factory, Scheme scheme, EndpointGroup endpointGroup,\n+                               @Nullable String absolutePathRef,\n+                               Class<?> type, ClientOptions options) {\n+        this.factory = requireNonNull(factory, \"factory\");\n+        this.scheme = factory.validateScheme(scheme);\n+        this.endpointGroup = requireNonNull(endpointGroup, \"endpointGroup\");\n         this.type = requireNonNull(type, \"type\");\n         this.options = requireNonNull(options, \"options\");\n+\n+        final String schemeStr;\n+        if (scheme.serializationFormat() == SerializationFormat.NONE) {\n+            schemeStr = scheme.sessionProtocol().uriText();\n+        } else {\n+            schemeStr = scheme.uriText();\n+        }\n+\n+        final String normalizedAbsolutePathRef = nullOrEmptyToSlash(absolutePathRef);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d49f25836b8460fd9e3a92a2f9fbc797c77adb07"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDEzMDY5Nw==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/line/armeria/pull/2381#discussion_r364130697", "createdAt": "2020-01-08T09:18:58Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/Endpoint.java", "diffHunk": "@@ -165,93 +148,55 @@ private static Endpoint create(String host, int port) {\n         IPv6_ONLY\n     }\n \n-    @Nullable\n-    private final String groupName;\n-    @Nullable\n     private final String host;\n     @Nullable\n     private final String ipAddr;\n     private final int port;\n     private final int weight;\n     private final List<Endpoint> endpoints;\n-    @Nullable // null if this endpoint is a group.\n     private final HostType hostType;\n     @Nullable\n     private String authority;\n \n-    private Endpoint(String groupName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d49f25836b8460fd9e3a92a2f9fbc797c77adb07"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcdd37e3208ef18f9b63b9f41f38f939da95fb98", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/bcdd37e3208ef18f9b63b9f41f38f939da95fb98", "committedDate": "2020-01-09T08:56:42Z", "message": "Move endpoint remapping to `WebClient` / Pass `Endpoint` instead of `HttpUrl`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18652c2e7ff3bd20b894042dd647ea9d672d6483", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/18652c2e7ff3bd20b894042dd647ea9d672d6483", "committedDate": "2020-01-09T09:06:47Z", "message": "Address the comments from @minwoox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9683e9ee8e29349f51f90937f8e2c37fba3613ab", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/9683e9ee8e29349f51f90937f8e2c37fba3613ab", "committedDate": "2020-01-09T09:12:27Z", "message": "Address more comments from @minwoox / more validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "324d6a1b62a186a7908c37e70790e63e35b20b50", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/324d6a1b62a186a7908c37e70790e63e35b20b50", "committedDate": "2020-01-09T09:17:47Z", "message": "Address more and more comments from @minwoox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5b443d36a6f12e063ebd7c5b33c43143d5c9f39", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/d5b443d36a6f12e063ebd7c5b33c43143d5c9f39", "committedDate": "2020-01-09T09:24:17Z", "message": "Fix failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a7f541a8e9e2a44a361cb3dfd168fc51f646bd6", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/3a7f541a8e9e2a44a361cb3dfd168fc51f646bd6", "committedDate": "2020-01-09T09:26:47Z", "message": "Add delegate() again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1", "committedDate": "2020-01-09T09:30:49Z", "message": "Fix more failures"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwOTY0NjY5", "url": "https://github.com/line/armeria/pull/2381#pullrequestreview-340964669", "createdAt": "2020-01-10T05:48:59Z", "commit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNTo0ODo1OVrOFcKy7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNTo1MDozMVrOFcKz6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA4MTMyNQ==", "bodyText": "Looks nice", "url": "https://github.com/line/armeria/pull/2381#discussion_r365081325", "createdAt": "2020-01-10T05:48:59Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/client/WebClientOptions.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.client.endpoint.EndpointGroup;\n+\n+/**\n+ * {@link ClientOption}s to control {@link WebClient}-specific behavior.\n+ */\n+public final class WebClientOptions {\n+\n+    /**\n+     * A {@link Function} that remaps an {@link Endpoint} or an absolute URL's authority into", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA4MTU3Nw==", "bodyText": "I think it's fine to be roundRobin and weightedRoundRobin, I don't know if I commonly hear the word unweighted round robin", "url": "https://github.com/line/armeria/pull/2381#discussion_r365081577", "createdAt": "2020-01-10T05:50:31Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/EndpointSelectionStrategy.java", "diffHunk": "@@ -26,13 +26,37 @@\n \n     /**\n      * Simple round-robin strategy.\n+     *\n+     * @deprecated Use {@link #unweightedRoundRobin()}.\n      */\n-    EndpointSelectionStrategy ROUND_ROBIN = new RoundRobinStrategy();\n+    @Deprecated\n+    EndpointSelectionStrategy ROUND_ROBIN = RoundRobinStrategy.INSTANCE;\n \n     /**\n      * Weighted round-robin strategy.\n+     *\n+     * @deprecated Use {@link #weightedRoundRobin()}.\n      */\n-    EndpointSelectionStrategy WEIGHTED_ROUND_ROBIN = new WeightedRoundRobinStrategy();\n+    @Deprecated\n+    EndpointSelectionStrategy WEIGHTED_ROUND_ROBIN = WeightedRoundRobinStrategy.INSTANCE;\n+\n+    /**\n+     * Returns a weighted round-robin strategy.\n+     *\n+     * @see #unweightedRoundRobin()\n+     */\n+    static EndpointSelectionStrategy weightedRoundRobin() {\n+        return WeightedRoundRobinStrategy.INSTANCE;\n+    }\n+\n+    /**\n+     * Returns an unweighted round-robin strategy, which ignores {@link Endpoint#weight()}.\n+     *\n+     * @see #weightedRoundRobin()\n+     */\n+    static EndpointSelectionStrategy unweightedRoundRobin() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMDA3NzUz", "url": "https://github.com/line/armeria/pull/2381#pullrequestreview-341007753", "createdAt": "2020-01-10T08:19:08Z", "commit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwODoxOTowOFrOFcM3kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwOTowNzo0NFrOFcN82w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTExNTI4MA==", "bodyText": "So are we doing this or not? \ud83d\ude04", "url": "https://github.com/line/armeria/pull/2381#discussion_r365115280", "createdAt": "2020-01-10T08:19:08Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientBuilder.java", "diffHunk": "@@ -173,24 +176,29 @@ public ClientBuilder serializationFormat(SerializationFormat format) {\n     public <T> T build(Class<T> clientType) {\n         requireNonNull(clientType, \"clientType\");\n \n+        final Object client;\n         if (uri != null) {\n-            return factory.newClient(uri, clientType, buildOptions());\n-        } else if (path != null) {\n-            return factory.newClient(scheme(), endpoint, path, clientType, buildOptions());\n+            client = factory.newClient(ClientBuilderParams.of(factory, uri, clientType, buildOptions()));\n         } else {\n-            return factory.newClient(scheme(), endpoint, clientType, buildOptions());\n+            assert endpointGroup != null;\n+            client = factory.newClient(ClientBuilderParams.of(factory, scheme(), endpointGroup,\n+                                                              path, clientType, buildOptions()));\n         }\n+\n+        @SuppressWarnings(\"unchecked\")\n+        final T cast = (T) client;\n+        return cast;\n     }\n \n     private Scheme scheme() {\n         return scheme == null ? Scheme.of(format, protocol) : scheme;\n     }\n \n-    private void ensureEndpoint() {\n-        if (endpoint == null) {\n+    private void ensureEndpointGroup() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU3NzY5Mg=="}, "originalCommit": {"oid": "0e9410b21a3fbc3793432b3ec887126bc1a11a74"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTExNTk5NQ==", "bodyText": "nit: Returns the endpoint URI of the client.", "url": "https://github.com/line/armeria/pull/2381#discussion_r365115995", "createdAt": "2020-01-10T08:21:22Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientBuilderParams.java", "diffHunk": "@@ -37,13 +42,41 @@ static ClientBuilderParams of(ClientFactory factory, URI uri, Class<?> type,\n         return new DefaultClientBuilderParams(factory, uri, type, options);\n     }\n \n+    /**\n+     * Returns a newly created {@link ClientBuilderParams} from the specified properties.\n+     */\n+    static ClientBuilderParams of(ClientFactory factory, Scheme scheme, EndpointGroup endpointGroup,\n+                                  @Nullable String path, Class<?> type, ClientOptions options) {\n+        requireNonNull(factory, \"factory\");\n+        requireNonNull(scheme, \"scheme\");\n+        requireNonNull(endpointGroup, \"endpointGroup\");\n+        requireNonNull(type, \"type\");\n+        requireNonNull(options, \"options\");\n+        return new DefaultClientBuilderParams(factory, scheme, endpointGroup, path, type, options);\n+    }\n+\n     /**\n      * Returns the {@link ClientFactory} who created the client.\n      */\n     ClientFactory factory();\n \n     /**\n-     * Returns the endpoint URI of the client.\n+     * Returns the {@link Scheme} of the client.\n+     */\n+    Scheme scheme();\n+\n+    /**\n+     * Returns the {@link EndpointGroup} of the client.\n+     */\n+    EndpointGroup endpointGroup();\n+\n+    /**\n+     * Returns the {@link String} that consists of path, query string and fragment.\n+     */\n+    String absolutePathRef(); // Name inspired by https://stackoverflow.com/a/47545070/55808\n+\n+    /**\n+     * Returns the URI of endpoint URI of the client.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEyMzAyNA==", "bodyText": "nit: endpointGroup because the name of the getter is also endpointGroup?", "url": "https://github.com/line/armeria/pull/2381#discussion_r365123024", "createdAt": "2020-01-10T08:41:41Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientBuilderParams.java", "diffHunk": "@@ -72,7 +154,9 @@ public ClientOptions options() {\n     public String toString() {\n         return MoreObjects.toStringHelper(this)\n                           .add(\"factory\", factory)\n-                          .add(\"uri\", uri)\n+                          .add(\"scheme\", scheme)\n+                          .add(\"endpoint\", endpointGroup)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEyNDEwMg==", "bodyText": "nit: validated \ud83d\ude06", "url": "https://github.com/line/armeria/pull/2381#discussion_r365124102", "createdAt": "2020-01-10T08:44:24Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientFactory.java", "diffHunk": "@@ -142,23 +136,18 @@ public ClientFactoryOptions options() {\n     }\n \n     @Override\n-    public <T> T newClient(URI uri, Class<T> clientType, ClientOptions options) {\n-        final Scheme scheme = validateScheme(uri);\n-        uri = normalizeUri(uri, scheme);\n-        return clientFactories.get(scheme).newClient(uri, clientType, options);\n-    }\n-\n-    @Override\n-    public <T> T newClient(Scheme scheme, Endpoint endpoint, @Nullable String path, Class<T> clientType,\n-                           ClientOptions options) {\n-        final Scheme validatedScheme = validateScheme(scheme);\n-        return clientFactories.get(validatedScheme)\n-                              .newClient(validatedScheme, endpoint, path, clientType, options);\n+    public Object newClient(ClientBuilderParams params) {\n+        validateParams(params);\n+        final Scheme scheme = params.scheme();\n+        // `factory` must be non-null because we validates params.scheme() with validateParams().", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEyNTc3Mw==", "bodyText": "Can ClientBuilderParams have a type parameter for the client type so that wrong ClientBuilderParams cannot be passed as a parameter? \ud83e\udd14", "url": "https://github.com/line/armeria/pull/2381#discussion_r365125773", "createdAt": "2020-01-10T08:48:36Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactory.java", "diffHunk": "@@ -153,86 +156,10 @@ static void disableShutdownHook() {\n     ClientFactoryOptions options();\n \n     /**\n-     * Creates a new client that connects to the specified {@code uri}.\n-     *\n-     * @param uri the URI of the server endpoint\n-     * @param clientType the type of the new client\n-     * @param options the {@link ClientOptionValue}s\n-     */\n-    <T> T newClient(String uri, Class<T> clientType, ClientOptionValue<?>... options);\n-\n-    /**\n-     * Creates a new client that connects to the specified {@code uri}.\n-     *\n-     * @param uri the URI of the server endpoint\n-     * @param clientType the type of the new client\n-     * @param options the {@link ClientOptions}\n-     */\n-    <T> T newClient(String uri, Class<T> clientType, ClientOptions options);\n-\n-    /**\n-     * Creates a new client that connects to the specified {@link URI}.\n-     *\n-     * @param uri the URI of the server endpoint\n-     * @param clientType the type of the new client\n-     * @param options the {@link ClientOptionValue}s\n-     */\n-    <T> T newClient(URI uri, Class<T> clientType, ClientOptionValue<?>... options);\n-\n-    /**\n-     * Creates a new client that connects to the specified {@link URI}.\n-     *\n-     * @param uri the URI of the server endpoint\n-     * @param clientType the type of the new client\n-     * @param options the {@link ClientOptions}\n-     */\n-    <T> T newClient(URI uri, Class<T> clientType, ClientOptions options);\n-\n-    /**\n-     * Creates a new client that connects to the specified {@link Endpoint} with the {@link Scheme}.\n-     *\n-     * @param scheme the {@link Scheme} for the {@code endpoint}\n-     * @param endpoint the server {@link Endpoint}\n-     * @param clientType the type of the new client\n-     * @param options the {@link ClientOptionValue}s\n+     * Creates a new client with the specified {@link ClientBuilderParams}. The client instance returned\n+     * by this method must be an instance of {@link ClientBuilderParams#clientType()}.\n      */\n-    <T> T newClient(Scheme scheme, Endpoint endpoint, Class<T> clientType, ClientOptionValue<?>... options);\n-\n-    /**\n-     * Creates a new client that connects to the specified {@link Endpoint} with the {@link Scheme}.\n-     *\n-     * @param scheme the {@link Scheme} for the {@code endpoint}\n-     * @param endpoint the server {@link Endpoint}\n-     * @param clientType the type of the new client\n-     * @param options the {@link ClientOptions}\n-     */\n-    <T> T newClient(Scheme scheme, Endpoint endpoint, Class<T> clientType, ClientOptions options);\n-\n-    /**\n-     * Creates a new client that connects to the specified {@link Endpoint} with the {@link Scheme}\n-     * and {@code path}.\n-     *\n-     * @param scheme the {@link Scheme} for the {@code endpoint}\n-     * @param endpoint the server {@link Endpoint}\n-     * @param path the service {@code path}\n-     * @param clientType the type of the new client\n-     * @param options the {@link ClientOptionValue}s\n-     */\n-    <T> T newClient(Scheme scheme, Endpoint endpoint, @Nullable String path, Class<T> clientType,\n-                    ClientOptionValue<?>... options);\n-\n-    /**\n-     * Creates a new client that connects to the specified {@link Endpoint} with the {@link Scheme}\n-     * and {@code path}.\n-     *\n-     * @param scheme the {@link Scheme} for the {@code endpoint}\n-     * @param endpoint the server {@link Endpoint}\n-     * @param path the service {@code path}\n-     * @param clientType the type of the new client\n-     * @param options the {@link ClientOptions}\n-     */\n-    <T> T newClient(Scheme scheme, Endpoint endpoint, @Nullable String path, Class<T> clientType,\n-                    ClientOptions options);\n+    Object newClient(ClientBuilderParams params);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEzMDQ4OA==", "bodyText": "Can we just set this to ClientOptions.DEFAULT_OPTIONS so that we don't have to call this method?", "url": "https://github.com/line/armeria/pull/2381#discussion_r365130488", "createdAt": "2020-01-10T09:00:39Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultWebClient.java", "diffHunk": "@@ -40,9 +41,29 @@\n \n     static final WebClient DEFAULT = new WebClientBuilder().build();\n \n-    DefaultWebClient(ClientBuilderParams params, HttpClient delegate,\n-                     MeterRegistry meterRegistry, SessionProtocol sessionProtocol, Endpoint endpoint) {\n-        super(params, delegate, meterRegistry, sessionProtocol, endpoint);\n+    private final Function<? super Endpoint, ? extends EndpointGroup> endpointRemapper;\n+\n+    DefaultWebClient(ClientBuilderParams params, HttpClient delegate, MeterRegistry meterRegistry) {\n+        super(fillDefaultOptions(params), delegate, meterRegistry);\n+        endpointRemapper = options().get(WebClientOptions.ENDPOINT_REMAPPER);\n+    }\n+\n+    private static ClientBuilderParams fillDefaultOptions(ClientBuilderParams params) {\n+        final ClientOptions options = params.options();\n+        if (options.getOrNull(WebClientOptions.ENDPOINT_REMAPPER) != null) {\n+            return params;\n+        }\n+\n+        final ClientOptionsBuilder optionsBuilder = options.toBuilder();\n+        optionsBuilder.option(WebClientOptions.ENDPOINT_REMAPPER, Function.identity());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEzMjkwNA==", "bodyText": "\ud83d\ude06", "url": "https://github.com/line/armeria/pull/2381#discussion_r365132904", "createdAt": "2020-01-10T09:07:23Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/EmptyEndpointGroupException.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright 2016 LINE Corporation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTEzMzAxOQ==", "bodyText": "nit: two dots.", "url": "https://github.com/line/armeria/pull/2381#discussion_r365133019", "createdAt": "2020-01-10T09:07:44Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/EmptyEndpointGroupException.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Copyright 2016 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.endpoint;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.Flags;\n+\n+/**\n+ * An {@link EndpointGroupException} raised when the resolution of an {@link EndpointGroup} fails\n+ * because there are no {@link Endpoint}s in the {@link EndpointGroup}..", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71c0aa59d7f43205e94708142f7b7635ce3514c0", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/71c0aa59d7f43205e94708142f7b7635ce3514c0", "committedDate": "2020-01-10T13:00:43Z", "message": "unweighted -> nil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0af2342b4d092370ea042735382519e1000e5d7", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/f0af2342b4d092370ea042735382519e1000e5d7", "committedDate": "2020-01-10T13:03:45Z", "message": "Address minor comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ac785f79ca6492b547bddc4b3f732649dee1011", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/6ac785f79ca6492b547bddc4b3f732649dee1011", "committedDate": "2020-01-10T13:59:16Z", "message": "Clean-up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ba76251a3da8c28a04efcebd526bc6a6e18a17c", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/5ba76251a3da8c28a04efcebd526bc6a6e18a17c", "committedDate": "2020-01-11T03:08:10Z", "message": "Apply endpointRemapper to all clients"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3218ab04b311890f7831080a69e3ca363219bb4", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/f3218ab04b311890f7831080a69e3ca363219bb4", "committedDate": "2020-01-11T03:16:53Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwOTYxOTM0", "url": "https://github.com/line/armeria/pull/2381#pullrequestreview-340961934", "createdAt": "2020-01-10T05:36:00Z", "commit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwNTozNjowMFrOFcKqAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QwMDoxMjo1NVrOFcr10Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA3OTA0Mw==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/line/armeria/pull/2381#discussion_r365079043", "createdAt": "2020-01-10T05:36:00Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientBuilderParams.java", "diffHunk": "@@ -37,13 +42,41 @@ static ClientBuilderParams of(ClientFactory factory, URI uri, Class<?> type,\n         return new DefaultClientBuilderParams(factory, uri, type, options);\n     }\n \n+    /**\n+     * Returns a newly created {@link ClientBuilderParams} from the specified properties.\n+     */\n+    static ClientBuilderParams of(ClientFactory factory, Scheme scheme, EndpointGroup endpointGroup,\n+                                  @Nullable String path, Class<?> type, ClientOptions options) {\n+        requireNonNull(factory, \"factory\");\n+        requireNonNull(scheme, \"scheme\");\n+        requireNonNull(endpointGroup, \"endpointGroup\");\n+        requireNonNull(type, \"type\");\n+        requireNonNull(options, \"options\");\n+        return new DefaultClientBuilderParams(factory, scheme, endpointGroup, path, type, options);\n+    }\n+\n     /**\n      * Returns the {@link ClientFactory} who created the client.\n      */\n     ClientFactory factory();\n \n     /**\n-     * Returns the endpoint URI of the client.\n+     * Returns the {@link Scheme} of the client.\n+     */\n+    Scheme scheme();\n+\n+    /**\n+     * Returns the {@link EndpointGroup} of the client.\n+     */\n+    EndpointGroup endpointGroup();\n+\n+    /**\n+     * Returns the {@link String} that consists of path, query string and fragment.\n+     */\n+    String absolutePathRef(); // Name inspired by https://stackoverflow.com/a/47545070/55808", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTA4MjA2Nw==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public boolean init(EndpointGroup endpoint) {\n          \n          \n            \n                public boolean init(EndpointGroup endpointGroup) {", "url": "https://github.com/line/armeria/pull/2381#discussion_r365082067", "createdAt": "2020-01-10T05:53:16Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -203,31 +200,23 @@ private static ServiceRequestContext serviceRequestContext() {\n      *         {@code false} if the initialization has failed and this context's {@link RequestLog} has been\n      *         completed with the cause of the failure.\n      */\n-    public boolean init(Endpoint endpoint) {\n+    public boolean init(EndpointGroup endpoint) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf5e41b63c44bf548f82a0b27bfa4c72c1744a1"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTYyMjczNw==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns a {@link EmptyEndpointGroupException} which may be a singleton or a new instance, depending on\n          \n          \n            \n                 * Returns an {@link EmptyEndpointGroupException} which may be a singleton or a new instance, depending on", "url": "https://github.com/line/armeria/pull/2381#discussion_r365622737", "createdAt": "2020-01-13T00:12:55Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/EmptyEndpointGroupException.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.endpoint;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.Flags;\n+\n+/**\n+ * An {@link EndpointGroupException} raised when the resolution of an {@link EndpointGroup} fails\n+ * because there are no {@link Endpoint}s in the {@link EndpointGroup}.\n+ */\n+public final class EmptyEndpointGroupException extends EndpointGroupException {\n+\n+    private static final long serialVersionUID = 7595286618131200852L;\n+\n+    static final EmptyEndpointGroupException INSTANCE = new EmptyEndpointGroupException(false);\n+\n+    /**\n+     * Returns a {@link EmptyEndpointGroupException} which may be a singleton or a new instance, depending on", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3218ab04b311890f7831080a69e3ca363219bb4"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "919f0082b4e80148d5ccc14c34bc82a58d5f80a4", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/919f0082b4e80148d5ccc14c34bc82a58d5f80a4", "committedDate": "2020-01-13T02:49:12Z", "message": "Address the comments from @ikhoon"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjg2MDk3", "url": "https://github.com/line/armeria/pull/2381#pullrequestreview-341686097", "createdAt": "2020-01-13T08:28:29Z", "commit": {"oid": "919f0082b4e80148d5ccc14c34bc82a58d5f80a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNzA4NzI1", "url": "https://github.com/line/armeria/pull/2381#pullrequestreview-341708725", "createdAt": "2020-01-13T09:16:37Z", "commit": {"oid": "919f0082b4e80148d5ccc14c34bc82a58d5f80a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 834, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}