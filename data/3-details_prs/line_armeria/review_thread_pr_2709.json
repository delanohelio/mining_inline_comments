{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NDQ2MTEy", "number": 2709, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMToyNDo0OVrOD8SnbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNDoyNDozOVrOD8UUiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTQ2MTU3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryRuleUtil.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMToyNDo0OVrOGVI7_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMToyNDo0OVrOGVI7_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgxOTcxMA==", "bodyText": "fromRetryRuleWithContent?", "url": "https://github.com/line/armeria/pull/2709#discussion_r424819710", "createdAt": "2020-05-14T01:24:49Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryRuleUtil.java", "diffHunk": "@@ -60,18 +60,19 @@ static RetryRule fromRetryStrategy(RetryStrategy strategy) {\n         });\n     }\n \n+    static <T extends Response> RetryRule fromRetryWithContent(RetryRuleWithContent<T> retryRule) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTQ2NTU3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMToyNzowOFrOGVI-eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMjo0MDoxNlrOGVKGkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMDM0Ng==", "bodyText": "Could cache this in the constructor?", "url": "https://github.com/line/armeria/pull/2709#discussion_r424820346", "createdAt": "2020-05-14T01:27:08Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "diffHunk": "@@ -282,14 +284,18 @@ private void doExecute0(ClientRequestContext ctx, HttpRequestDuplicator rootReqD\n                                                                     duplicated, duplicator::abort));\n                     }\n                 } else {\n-                    final Throwable responseCause =\n-                            log.isAvailable(RequestLogProperty.RESPONSE_CAUSE) ? log.responseCause() : null;\n+                    final RetryRule retryRule;\n+                    if (needsContentInStrategy) {\n+                        retryRule = RetryRuleUtil.fromRetryWithContent(retryRuleWithContent());\n+                    } else {\n+                        retryRule = retryRule();\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgzODgwMg==", "bodyText": "SGTM \ud83d\udc4d", "url": "https://github.com/line/armeria/pull/2709#discussion_r424838802", "createdAt": "2020-05-14T02:40:16Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "diffHunk": "@@ -282,14 +284,18 @@ private void doExecute0(ClientRequestContext ctx, HttpRequestDuplicator rootReqD\n                                                                     duplicated, duplicator::abort));\n                     }\n                 } else {\n-                    final Throwable responseCause =\n-                            log.isAvailable(RequestLogProperty.RESPONSE_CAUSE) ? log.responseCause() : null;\n+                    final RetryRule retryRule;\n+                    if (needsContentInStrategy) {\n+                        retryRule = RetryRuleUtil.fromRetryWithContent(retryRuleWithContent());\n+                    } else {\n+                        retryRule = retryRule();\n+                    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMDM0Ng=="}, "originalCommit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTQ3OTM2OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMTozNTo0MlrOGVJG0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMzo1MTozM1rOGVLIkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMjQ4MQ==", "bodyText": "What if an exception is raised when subscribing to HttpResponse?\nShouldn't we use always use duplicator if needsContentInStrategy is true?", "url": "https://github.com/line/armeria/pull/2709#discussion_r424822481", "createdAt": "2020-05-14T01:35:42Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "diffHunk": "@@ -269,7 +269,9 @@ private void doExecute0(ClientRequestContext ctx, HttpRequestDuplicator rootReqD\n \n         derivedCtx.log().whenAvailable(RequestLogProperty.RESPONSE_HEADERS).thenAccept(log -> {\n             try {\n-                if (needsContentInStrategy) {\n+                final Throwable responseCause =\n+                        log.isAvailable(RequestLogProperty.RESPONSE_CAUSE) ? log.responseCause() : null;\n+                if (needsContentInStrategy && responseCause == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg1NTY5OA==", "bodyText": "As mentioned in the PR description, HttpResponse was aborted before subscription, then the response could not be duplicated. So HttpResponse is duplicated if responseCause is not null.", "url": "https://github.com/line/armeria/pull/2709#discussion_r424855698", "createdAt": "2020-05-14T03:51:33Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "diffHunk": "@@ -269,7 +269,9 @@ private void doExecute0(ClientRequestContext ctx, HttpRequestDuplicator rootReqD\n \n         derivedCtx.log().whenAvailable(RequestLogProperty.RESPONSE_HEADERS).thenAccept(log -> {\n             try {\n-                if (needsContentInStrategy) {\n+                final Throwable responseCause =\n+                        log.isAvailable(RequestLogProperty.RESPONSE_CAUSE) ? log.responseCause() : null;\n+                if (needsContentInStrategy && responseCause == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMjQ4MQ=="}, "originalCommit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTQ3OTcxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMTozNTo1NlrOGVJHDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMTozNTo1NlrOGVJHDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDgyMjU0Mw==", "bodyText": "needsContentInStrategy -> needsContentInRule", "url": "https://github.com/line/armeria/pull/2709#discussion_r424822543", "createdAt": "2020-05-14T01:35:56Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "diffHunk": "@@ -269,7 +269,9 @@ private void doExecute0(ClientRequestContext ctx, HttpRequestDuplicator rootReqD\n \n         derivedCtx.log().whenAvailable(RequestLogProperty.RESPONSE_HEADERS).thenAccept(log -> {\n             try {\n-                if (needsContentInStrategy) {\n+                final Throwable responseCause =\n+                        log.isAvailable(RequestLogProperty.RESPONSE_CAUSE) ? log.responseCause() : null;\n+                if (needsContentInStrategy && responseCause == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76c30886caea6e61fae3f4ad37647a8235f055c6"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NTc0MDg4OnYy", "diffSide": "RIGHT", "path": "benchmarks/src/jmh/java/com/linecorp/armeria/core/client/retry/WithDuplicator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNDoyNDozOVrOGVLmDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwNDoyNDozOVrOGVLmDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg2MzI0NQ==", "bodyText": "nit: Could merge into the above line.", "url": "https://github.com/line/armeria/pull/2709#discussion_r424863245", "createdAt": "2020-05-14T04:24:39Z", "author": {"login": "minwoox"}, "path": "benchmarks/src/jmh/java/com/linecorp/armeria/core/client/retry/WithDuplicator.java", "diffHunk": "@@ -29,11 +29,11 @@\n \n     @Override\n     protected WebClient newClient() {\n-        final RetryRuleWithContent<HttpResponse> retryStrategy =\n-                (ctx, response) -> response.aggregate().handle((unused1, unused2) -> null);\n+        final RetryRuleWithContent<HttpResponse> rule =\n+                (ctx, response, cause) -> response.aggregate().handle((unused1, unused2) -> null);\n \n         return WebClient.builder(baseUrl())\n-                        .decorator(RetryingClient.builder(retryStrategy)\n+                        .decorator(RetryingClient.builder(rule)\n                                                  .newDecorator())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "387a899172041f741dc02a4c94bdd1b0f42caed8"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2604, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}