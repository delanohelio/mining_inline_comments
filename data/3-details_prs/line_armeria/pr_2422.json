{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MzY4Nzgy", "number": 2422, "title": "Add content previewing client and service decorators", "bodyText": "Motivation:\nRelated #2189\nWe currently, store HttpDatas to the ContentPreviewer right before writing to the socket to preview the content.\nHowever, this makes the server decompress twice when there's an EncodingService and a user wants to preview decompressed content.\nIt's also, not the way we do for these kinds of things which are intercepting the requests and responses to manipulate or supplement some more logic.\nWe use decorators for that.\nModifications:\n\nAdd ContentPreviewingClient, ContentPreviewingService and their builders.\n\nResult:\n\nClose #2189\n(Breaking)\n\nThe methods in ServerBuilder, VirtualHostBuilder, ServiceBindingBuilder, ClientBuilder and ClientOptionsBuilder for setting content preview are gone.\nYou should use ContentPreviewingClient and ContentPreviewingService decorators instead.", "createdAt": "2020-01-29T04:51:31Z", "url": "https://github.com/line/armeria/pull/2422", "merged": true, "mergeCommit": {"oid": "de2990fef898b0a7de6743a60bd14d9eefcbff9e"}, "closed": true, "closedAt": "2020-01-31T12:32:20Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb--aL6gH2gAyMzY4MzY4NzgyOjYzNGYxMDA5ZTNmYWQ2NDRlNmRhYzBlOGM0ZTIxODYyNTU0ODMyN2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_uEV4AFqTM1MTQ2NTg1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "634f1009e3fad644e6dac0e8c4e218625548327b", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/634f1009e3fad644e6dac0e8c4e218625548327b", "committedDate": "2020-01-29T04:40:57Z", "message": "Add content previewing client and service decorators\nMotivation:\nRelated #2189\n\nWe currently, store `HttpData`s to the `ContentPreviewer` right before writing to the socket to preview the content.\nHowever, this makes the server decompress twice when there's a `EncodingService` and a user wants to preview decompressed content.\nIt's also, not the way we do for this kinds of thing which is intercepting the requests and responses and manipulating.\nWe use decorators for that.\n\nModifications:\n- Add `ContentPreviewingClient` and `ContentPreviewingService`\n\nResult:\n- Close #2189"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec6b0b42aacc6465bbb520e07cebc48c5c3e4014", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/ec6b0b42aacc6465bbb520e07cebc48c5c3e4014", "committedDate": "2020-01-29T05:45:27Z", "message": "Repeat test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODg1NzYy", "url": "https://github.com/line/armeria/pull/2422#pullrequestreview-349885762", "createdAt": "2020-01-29T06:32:34Z", "commit": {"oid": "ec6b0b42aacc6465bbb520e07cebc48c5c3e4014"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjozMjozNFrOFi92Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNjo0MjoxMFrOFi9-xQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwOTIyNw==", "bodyText": "Indent", "url": "https://github.com/line/armeria/pull/2422#discussion_r372209227", "createdAt": "2020-01-29T06:32:34Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/ContentPreviewer.java", "diffHunk": "@@ -86,6 +86,13 @@ static ContentPreviewer disabled() {\n         return ContentPreviewerAdapter.NOOP;\n     }\n \n+    /**\n+     * Returns whether this {@link ContentPreviewer} is {@link #disabled()} or not.\n+      */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec6b0b42aacc6465bbb520e07cebc48c5c3e4014"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwOTI3OQ==", "bodyText": "I think it's more idiomatic to return false here and have NOOP override with return true", "url": "https://github.com/line/armeria/pull/2422#discussion_r372209279", "createdAt": "2020-01-29T06:32:51Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/ContentPreviewer.java", "diffHunk": "@@ -86,6 +86,13 @@ static ContentPreviewer disabled() {\n         return ContentPreviewerAdapter.NOOP;\n     }\n \n+    /**\n+     * Returns whether this {@link ContentPreviewer} is {@link #disabled()} or not.\n+      */\n+    default boolean isDisabled() {\n+        return this == ContentPreviewerAdapter.NOOP;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec6b0b42aacc6465bbb520e07cebc48c5c3e4014"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwOTk2NQ==", "bodyText": "Remove requireNonNull for both they're @Nullable", "url": "https://github.com/line/armeria/pull/2422#discussion_r372209965", "createdAt": "2020-01-29T06:35:44Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/internal/logging/ContentPreviewerConfigurator.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.logging;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.FilteredHttpRequest;\n+import com.linecorp.armeria.common.FilteredHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpHeaders;\n+import com.linecorp.armeria.common.HttpObject;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.common.logging.ContentPreviewer;\n+import com.linecorp.armeria.common.logging.ContentPreviewerFactory;\n+import com.linecorp.armeria.internal.ArmeriaHttpUtil;\n+\n+/**\n+ * A configurator to set up request and response content previewers.\n+ */\n+public final class ContentPreviewerConfigurator {\n+\n+    @Nullable\n+    private final ContentPreviewerFactory requestContentPreviewerFactory;\n+\n+    @Nullable\n+    private final ContentPreviewerFactory responseContentPreviewerFactory;\n+\n+    /**\n+     * Creates a new instance.\n+     */\n+    public ContentPreviewerConfigurator(@Nullable ContentPreviewerFactory requestContentPreviewerFactory,\n+                                        @Nullable ContentPreviewerFactory responseContentPreviewerFactory) {\n+        assert requestContentPreviewerFactory != null || responseContentPreviewerFactory != null;\n+        this.requestContentPreviewerFactory =\n+                requireNonNull(requestContentPreviewerFactory, \"requestContentPreviewerFactory\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec6b0b42aacc6465bbb520e07cebc48c5c3e4014"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMDc2Nw==", "bodyText": "Do we have some validation to make sure ResponseHeaders are first published object? I wonder if we are replacing a downstream HTTP protocol exception with a NPE here. I think it doesn't hurt much to just add the null check here to not worry.", "url": "https://github.com/line/armeria/pull/2422#discussion_r372210767", "createdAt": "2020-01-29T06:39:24Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/internal/logging/ContentPreviewerConfigurator.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.logging;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.FilteredHttpRequest;\n+import com.linecorp.armeria.common.FilteredHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpHeaders;\n+import com.linecorp.armeria.common.HttpObject;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.common.logging.ContentPreviewer;\n+import com.linecorp.armeria.common.logging.ContentPreviewerFactory;\n+import com.linecorp.armeria.internal.ArmeriaHttpUtil;\n+\n+/**\n+ * A configurator to set up request and response content previewers.\n+ */\n+public final class ContentPreviewerConfigurator {\n+\n+    @Nullable\n+    private final ContentPreviewerFactory requestContentPreviewerFactory;\n+\n+    @Nullable\n+    private final ContentPreviewerFactory responseContentPreviewerFactory;\n+\n+    /**\n+     * Creates a new instance.\n+     */\n+    public ContentPreviewerConfigurator(@Nullable ContentPreviewerFactory requestContentPreviewerFactory,\n+                                        @Nullable ContentPreviewerFactory responseContentPreviewerFactory) {\n+        assert requestContentPreviewerFactory != null || responseContentPreviewerFactory != null;\n+        this.requestContentPreviewerFactory =\n+                requireNonNull(requestContentPreviewerFactory, \"requestContentPreviewerFactory\");\n+        this.responseContentPreviewerFactory =\n+                requireNonNull(responseContentPreviewerFactory, \"responseContentPreviewerFactory\");\n+    }\n+\n+    /**\n+     * Sets up the request {@link ContentPreviewer} when {@code requestContentPreviewerFactory}\n+     * is non-null and {@link ContentPreviewerFactory#get(RequestContext, HttpHeaders)} returns a\n+     * {@link ContentPreviewer} instance that is not {@link ContentPreviewer#isDisabled()}.\n+     */\n+    public HttpRequest maybeSetUpRequestContentPreviewer(RequestContext ctx, HttpRequest req) {\n+        requireNonNull(ctx, \"ctx\");\n+        requireNonNull(req, \"req\");\n+        if (requestContentPreviewerFactory == null) {\n+            return req;\n+        }\n+\n+        final RequestHeaders headers = req.headers();\n+        final ContentPreviewer requestContentPreviewer = requestContentPreviewerFactory.get(ctx, headers);\n+        if (requestContentPreviewer.isDisabled()) {\n+            return req;\n+        }\n+\n+        ctx.logBuilder().requestContentPreviewer(requestContentPreviewer);\n+        requestContentPreviewer.onHeaders(headers);\n+        return new FilteredHttpRequest(req) {\n+            @Override\n+            protected HttpObject filter(HttpObject obj) {\n+                if (obj instanceof HttpData) {\n+                    requestContentPreviewer.onData((HttpData) obj);\n+                }\n+                return obj;\n+            }\n+        };\n+    }\n+\n+    /**\n+     * Sets up the response {@link ContentPreviewer} when {@code responseContentPreviewerFactory}\n+     * is non-null.\n+     */\n+    public HttpResponse maybeSetUpResponseContentPreviewer(RequestContext ctx, HttpResponse res) {\n+        requireNonNull(ctx, \"ctx\");\n+        requireNonNull(res, \"res\");\n+        if (responseContentPreviewerFactory == null) {\n+            return res;\n+        }\n+\n+        return new FilteredHttpResponse(res) {\n+            @Nullable\n+            ContentPreviewer responseContentPreviewer;\n+\n+            @Override\n+            protected HttpObject filter(HttpObject obj) {\n+                if (obj instanceof ResponseHeaders) {\n+                    final ResponseHeaders headers = (ResponseHeaders) obj;\n+\n+                    // Skip informational headers.\n+                    final String status = headers.get(HttpHeaderNames.STATUS);\n+                    if (ArmeriaHttpUtil.isInformational(status)) {\n+                        return obj;\n+                    }\n+\n+                    responseContentPreviewer = responseContentPreviewerFactory.get(ctx, headers);\n+                    ctx.logBuilder().responseContentPreviewer(responseContentPreviewer);\n+                    responseContentPreviewer.onHeaders(headers);\n+                } else if (obj instanceof HttpData) {\n+                    assert responseContentPreviewer != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec6b0b42aacc6465bbb520e07cebc48c5c3e4014"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIxMTM5Nw==", "bodyText": "Though actually can we just go ahead and remove @Nullable throughout PR and use ContentPreviewerFactory.disabled() instead?", "url": "https://github.com/line/armeria/pull/2422#discussion_r372211397", "createdAt": "2020-01-29T06:42:10Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/internal/logging/ContentPreviewerConfigurator.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.logging;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.FilteredHttpRequest;\n+import com.linecorp.armeria.common.FilteredHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpHeaders;\n+import com.linecorp.armeria.common.HttpObject;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.common.logging.ContentPreviewer;\n+import com.linecorp.armeria.common.logging.ContentPreviewerFactory;\n+import com.linecorp.armeria.internal.ArmeriaHttpUtil;\n+\n+/**\n+ * A configurator to set up request and response content previewers.\n+ */\n+public final class ContentPreviewerConfigurator {\n+\n+    @Nullable\n+    private final ContentPreviewerFactory requestContentPreviewerFactory;\n+\n+    @Nullable\n+    private final ContentPreviewerFactory responseContentPreviewerFactory;\n+\n+    /**\n+     * Creates a new instance.\n+     */\n+    public ContentPreviewerConfigurator(@Nullable ContentPreviewerFactory requestContentPreviewerFactory,\n+                                        @Nullable ContentPreviewerFactory responseContentPreviewerFactory) {\n+        assert requestContentPreviewerFactory != null || responseContentPreviewerFactory != null;\n+        this.requestContentPreviewerFactory =\n+                requireNonNull(requestContentPreviewerFactory, \"requestContentPreviewerFactory\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIwOTk2NQ=="}, "originalCommit": {"oid": "ec6b0b42aacc6465bbb520e07cebc48c5c3e4014"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bedfeba6f3dad8bba23f70ec5d4ff240208e14d", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/8bedfeba6f3dad8bba23f70ec5d4ff240208e14d", "committedDate": "2020-01-29T09:17:37Z", "message": "Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22c321a2b3d29acf9a3037f98101d91881d74b08", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/22c321a2b3d29acf9a3037f98101d91881d74b08", "committedDate": "2020-01-29T09:24:14Z", "message": "Remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbd93bf3a5680f4d5d7cc1ac9a13513d4f39c5e7", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/bbd93bf3a5680f4d5d7cc1ac9a13513d4f39c5e7", "committedDate": "2020-01-29T11:24:37Z", "message": "Address comments by @anuraaga"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85b6cc6c029866ab2d892597a10f20a71da4e033", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/85b6cc6c029866ab2d892597a10f20a71da4e033", "committedDate": "2020-01-30T03:43:52Z", "message": "Add deferredFlags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "166d6026e6950815fe9ccccc2dd3a5b6528248d1", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/166d6026e6950815fe9ccccc2dd3a5b6528248d1", "committedDate": "2020-01-30T07:34:19Z", "message": "Merge branch 'master' into add_content_preview_decorator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/6f0dee43ce1456816c3fad8a578e615128ea7aba", "committedDate": "2020-01-30T08:12:36Z", "message": "Fix doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNjU5MjEz", "url": "https://github.com/line/armeria/pull/2422#pullrequestreview-350659213", "createdAt": "2020-01-30T08:51:36Z", "commit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "state": "COMMENTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwODo1MTozNlrOFjjRmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwOTowNjo0MVrOFjjr1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgyMjQyNg==", "bodyText": "nit: The two lines could be merged?", "url": "https://github.com/line/armeria/pull/2422#discussion_r372822426", "createdAt": "2020-01-30T08:51:36Z", "author": {"login": "trustin"}, "path": "benchmarks/src/jmh/java/com/linecorp/armeria/server/RoutersBenchmark.java", "diffHunk": "@@ -46,20 +45,17 @@\n     static {\n         SERVICES = ImmutableList.of(\n                 new ServiceConfig(Route.builder().exact(\"/grpc.package.Service/Method1\").build(),\n-                                  SERVICE, 0, 0, false, ContentPreviewerFactory.disabled(),\n-                                  ContentPreviewerFactory.disabled(), AccessLogWriter.disabled(), false),\n+                                  SERVICE, 0, 0, false,\n+                                  AccessLogWriter.disabled(), false),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgyMjUwNw==", "bodyText": "nit: The two lines could be merged?", "url": "https://github.com/line/armeria/pull/2422#discussion_r372822507", "createdAt": "2020-01-30T08:51:48Z", "author": {"login": "trustin"}, "path": "benchmarks/src/jmh/java/com/linecorp/armeria/server/RoutersBenchmark.java", "diffHunk": "@@ -46,20 +45,17 @@\n     static {\n         SERVICES = ImmutableList.of(\n                 new ServiceConfig(Route.builder().exact(\"/grpc.package.Service/Method1\").build(),\n-                                  SERVICE, 0, 0, false, ContentPreviewerFactory.disabled(),\n-                                  ContentPreviewerFactory.disabled(), AccessLogWriter.disabled(), false),\n+                                  SERVICE, 0, 0, false,\n+                                  AccessLogWriter.disabled(), false),\n                 new ServiceConfig(Route.builder().exact(\"/grpc.package.Service/Method2\").build(),\n-                                  SERVICE, 0, 0, false, ContentPreviewerFactory.disabled(),\n-                                  ContentPreviewerFactory.disabled(), AccessLogWriter.disabled(), false)\n+                                  SERVICE, 0, 0, false,\n+                                  AccessLogWriter.disabled(), false)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgyMzE3Nw==", "bodyText": "Missing period after set", "url": "https://github.com/line/armeria/pull/2422#discussion_r372823177", "createdAt": "2020-01-30T08:53:22Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/logging/ContentPreviewingClientBuilder.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.logging;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.client.HttpClient;\n+import com.linecorp.armeria.common.logging.ContentPreviewingDecoratorBuilder;\n+\n+/**\n+ * Builds a new {@link ContentPreviewingClient} or its decorator function.\n+ */\n+public final class ContentPreviewingClientBuilder\n+        extends ContentPreviewingDecoratorBuilder<ContentPreviewingClientBuilder> {\n+\n+    /**\n+     * Returns a newly-created {@link ContentPreviewingClient} based on the properties of this builder.\n+     */\n+    public ContentPreviewingClient build(HttpClient delegate) {\n+        checkState(requestContentPreviewerFactory() != null || responseContentPreviewerFactory() != null,\n+                   \"requestContentPreviewerFactory or responseContentPreviewerFactory must be set\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgyNTAwMA==", "bodyText": "Shouldn't we use covariant return types instead of type parameter?", "url": "https://github.com/line/armeria/pull/2422#discussion_r372825000", "createdAt": "2020-01-30T08:57:04Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/ContentPreviewingDecoratorBuilder.java", "diffHunk": "@@ -0,0 +1,127 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.logging;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.nio.charset.Charset;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.internal.ArmeriaHttpUtil;\n+\n+/**\n+ * Builds a new content previewing decorator or its decorator function.\n+ *\n+ * @param <T> the type of this builder\n+ */\n+public abstract class ContentPreviewingDecoratorBuilder<T extends ContentPreviewingDecoratorBuilder<T>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgyNTI3MQ==", "bodyText": "How about moving this field next to flags?", "url": "https://github.com/line/armeria/pull/2422#discussion_r372825271", "createdAt": "2020-01-30T08:57:42Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -86,17 +89,14 @@\n     @Nullable\n     private UnmodifiableFuture<RequestLog> completedFuture;\n \n-    private volatile boolean requestContentDeferred;\n-    private volatile boolean responseContentDeferred;\n+    private volatile int deferredFlags;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgyNTY0OQ==", "bodyText": "How about moving this method after updateAvailability()?", "url": "https://github.com/line/armeria/pull/2422#discussion_r372825649", "createdAt": "2020-01-30T08:58:35Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -336,6 +322,21 @@ public RequestContext context() {\n         return partiallyCompletedFuture;\n     }\n \n+    private void updateDeferredFlags(RequestLogProperty property) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgyNTc1NQ==", "bodyText": "How about renaming to updateFlags for consistency?", "url": "https://github.com/line/armeria/pull/2422#discussion_r372825755", "createdAt": "2020-01-30T08:58:47Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -336,6 +322,21 @@ public RequestContext context() {\n         return partiallyCompletedFuture;\n     }\n \n+    private void updateDeferredFlags(RequestLogProperty property) {\n+        final int flag = property.flag();\n+        for (;;) {\n+            final int oldFlags = deferredFlags;\n+            final int newFlags = oldFlags | flag;\n+            if (oldFlags == newFlags) {\n+                break;\n+            }\n+\n+            if (deferredFlagsUpdater.compareAndSet(this, oldFlags, newFlags)) {\n+                break;\n+            }\n+        }\n+    }\n+\n     private void updateAvailability(RequestLogProperty property) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgyNjMyOA==", "bodyText": "> -> !=", "url": "https://github.com/line/armeria/pull/2422#discussion_r372826328", "createdAt": "2020-01-30T09:00:04Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -1140,8 +1135,8 @@ private void endResponse0(@Nullable Throwable responseCause) {\n \n     private void endResponse0(@Nullable Throwable responseCause, long responseEndTimeNanos) {\n         final int flags;\n-        if (responseCause == null && responseContentDeferred) {\n-            flags = RequestLogProperty.FLAGS_RESPONSE_COMPLETE_WITHOUT_CONTENT;\n+        if (responseCause == null && deferredFlags > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "originalPosition": 203}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgyNjUxMQ==", "bodyText": "2 volatile reads - please extract into a single local variable.", "url": "https://github.com/line/armeria/pull/2422#discussion_r372826511", "createdAt": "2020-01-30T09:00:30Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -1140,8 +1135,8 @@ private void endResponse0(@Nullable Throwable responseCause) {\n \n     private void endResponse0(@Nullable Throwable responseCause, long responseEndTimeNanos) {\n         final int flags;\n-        if (responseCause == null && responseContentDeferred) {\n-            flags = RequestLogProperty.FLAGS_RESPONSE_COMPLETE_WITHOUT_CONTENT;\n+        if (responseCause == null && deferredFlags > 0) {\n+            flags = RequestLogProperty.FLAGS_RESPONSE_COMPLETE & ~deferredFlags;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "originalPosition": 204}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgyNzI2MQ==", "bodyText": "How about: Note that a {@link Service} or a {@link Client} must be decorated with ... to enable the content preview.", "url": "https://github.com/line/armeria/pull/2422#discussion_r372827261", "createdAt": "2020-01-30T09:02:17Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/RequestLog.java", "diffHunk": "@@ -166,19 +165,12 @@ default long totalDurationNanos() {\n     /**\n      * Returns the preview of response content of the {@link Response}.\n      * Note that the content preview needs to be enabled when configuring a {@link Server} or a {@link Client}\n-     * to use this functionality.\n+     * by {@link ContentPreviewingService} or {@link ContentPreviewingClient} decorators respectively.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgyODgyNA==", "bodyText": "How about using whenComplete() to promote a good practice?", "url": "https://github.com/line/armeria/pull/2422#discussion_r372828824", "createdAt": "2020-01-30T09:05:56Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/logging/ContentPreviewingService.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.logging;\n+\n+import java.util.function.Function;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.Response;\n+import com.linecorp.armeria.common.logging.ContentPreviewerFactory;\n+import com.linecorp.armeria.common.logging.RequestLog;\n+import com.linecorp.armeria.common.logging.RequestLogAccess;\n+import com.linecorp.armeria.internal.logging.ContentPreviewerConfigurator;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+import com.linecorp.armeria.server.SimpleDecoratingHttpService;\n+\n+/**\n+ * Decorates an {@link HttpService} to preview the content of {@link Request}s and {@link Response}s.\n+ *\n+ * <p>Note that this decorator just sets {@link RequestLog#requestContentPreview()} and\n+ * {@link RequestLog#responseContentPreview()}. You can get the previews using {@link RequestLogAccess}.\n+ *\n+ * <pre>{@code\n+ * RequestLogAccess logAccess = ctx.log();\n+ * logAccess.whenAvailable(RequestLogProperty.REQUEST_CONTENT_PREVIEW,\n+ *                         RequestLogProperty.RESPONSE_CONTENT_PREVIEW).thenApply(...);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjgyOTE0Mw==", "bodyText": "to to -> to", "url": "https://github.com/line/armeria/pull/2422#discussion_r372829143", "createdAt": "2020-01-30T09:06:41Z", "author": {"login": "trustin"}, "path": "core/src/test/java/com/linecorp/armeria/client/HttpResponseDecoderTest.java", "diffHunk": "@@ -69,7 +70,7 @@ void confirmResponseStartAndEndInTheSameThread(SessionProtocol protocol)\n         // This increases the execution duration of 'endResponse0' of the DefaultRequestLog,\n         // which means that we have more chance to reproduce the bug if two threads are racing\n         // for notifying RESPONSE_END to listeners.\n-        builder.contentPreview(100);\n+        builder.decorator(ContentPreviewingClient.builder().contentPreview(100).newDecorator());\n         // In order to use a different thread to to subscribe to the response.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f0dee43ce1456816c3fad8a578e615128ea7aba"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e291a71aec0305f25aacc8cf25ae15d27a8ffd3a", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/e291a71aec0305f25aacc8cf25ae15d27a8ffd3a", "committedDate": "2020-01-30T09:37:38Z", "message": "Address comments by @trustin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c6e13a6667eaff20ff8f48ffb696ed8f8eed685", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/9c6e13a6667eaff20ff8f48ffb696ed8f8eed685", "committedDate": "2020-01-30T11:01:07Z", "message": "Change return type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMjU5NzY5", "url": "https://github.com/line/armeria/pull/2422#pullrequestreview-351259769", "createdAt": "2020-01-31T02:11:15Z", "commit": {"oid": "9c6e13a6667eaff20ff8f48ffb696ed8f8eed685"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwMjoxMToxNVrOFj_sfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwMjoxMzowN1rOFj_t8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4ODA2Mg==", "bodyText": "deferredFlags doesn't need to be read when requestCause is not null.", "url": "https://github.com/line/armeria/pull/2422#discussion_r373288062", "createdAt": "2020-01-31T02:11:15Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -845,8 +844,9 @@ private void endRequest0(@Nullable Throwable requestCause) {\n \n     private void endRequest0(@Nullable Throwable requestCause, long requestEndTimeNanos) {\n         final int flags;\n-        if (requestCause == null && requestContentDeferred) {\n-            flags = RequestLogProperty.FLAGS_REQUEST_COMPLETE_WITHOUT_CONTENT;\n+        final int deferredFlags = this.deferredFlags;\n+        if (requestCause == null && deferredFlags != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c6e13a6667eaff20ff8f48ffb696ed8f8eed685"}, "originalPosition": 249}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI4ODQzMw==", "bodyText": "Please merge master and use whenComplete().", "url": "https://github.com/line/armeria/pull/2422#discussion_r373288433", "createdAt": "2020-01-31T02:13:07Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/logging/ContentPreviewerConfigurator.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.logging;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import org.reactivestreams.Subscriber;\n+\n+import com.linecorp.armeria.common.FilteredHttpRequest;\n+import com.linecorp.armeria.common.FilteredHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpHeaders;\n+import com.linecorp.armeria.common.HttpObject;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.common.logging.ContentPreviewer;\n+import com.linecorp.armeria.common.logging.ContentPreviewerFactory;\n+import com.linecorp.armeria.common.logging.RequestLogBuilder;\n+import com.linecorp.armeria.internal.ArmeriaHttpUtil;\n+\n+/**\n+ * A configurator to set up request and response content previewers.\n+ */\n+public final class ContentPreviewerConfigurator {\n+\n+    @Nullable\n+    private final ContentPreviewerFactory requestContentPreviewerFactory;\n+\n+    @Nullable\n+    private final ContentPreviewerFactory responseContentPreviewerFactory;\n+\n+    /**\n+     * Creates a new instance.\n+     */\n+    public ContentPreviewerConfigurator(@Nullable ContentPreviewerFactory requestContentPreviewerFactory,\n+                                        @Nullable ContentPreviewerFactory responseContentPreviewerFactory) {\n+        assert requestContentPreviewerFactory != null || responseContentPreviewerFactory != null;\n+        this.requestContentPreviewerFactory = requestContentPreviewerFactory;\n+        this.responseContentPreviewerFactory = responseContentPreviewerFactory;\n+    }\n+\n+    /**\n+     * Sets up the request {@link ContentPreviewer} when {@code requestContentPreviewerFactory}\n+     * is non-null and {@link ContentPreviewerFactory#get(RequestContext, HttpHeaders)} returns a\n+     * {@link ContentPreviewer} instance that is not {@link ContentPreviewer#isDisabled()}.\n+     */\n+    public HttpRequest maybeSetUpRequestContentPreviewer(RequestContext ctx, HttpRequest req) {\n+        requireNonNull(ctx, \"ctx\");\n+        requireNonNull(req, \"req\");\n+        if (requestContentPreviewerFactory == null) {\n+            return req;\n+        }\n+\n+        final RequestHeaders headers = req.headers();\n+        final ContentPreviewer requestContentPreviewer = requestContentPreviewerFactory.get(ctx, headers);\n+        if (requestContentPreviewer.isDisabled()) {\n+            return req;\n+        }\n+\n+        final RequestLogBuilder logBuilder = ctx.logBuilder();\n+        logBuilder.deferRequestContentPreview();\n+        requestContentPreviewer.onHeaders(headers);\n+        req.completionFuture().handle((unused, unused1) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c6e13a6667eaff20ff8f48ffb696ed8f8eed685"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5587e426777056c79598cdbea8847ac62a16be2a", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/5587e426777056c79598cdbea8847ac62a16be2a", "committedDate": "2020-01-31T02:37:30Z", "message": "Add logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0569cf2af4351ff5624291cfde76928e3088f48", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/c0569cf2af4351ff5624291cfde76928e3088f48", "committedDate": "2020-01-31T02:39:36Z", "message": "Merge branch 'master' into add_content_preview_decorator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMjY3ODYw", "url": "https://github.com/line/armeria/pull/2422#pullrequestreview-351267860", "createdAt": "2020-01-31T02:47:44Z", "commit": {"oid": "5587e426777056c79598cdbea8847ac62a16be2a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwMjo0Nzo0NFrOFkAHfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwMjo0ODo0N1rOFkAIbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI5NDk3NQ==", "bodyText": "Probably better logging only once?\n{}. -> {} ? (The resulting log message would be: SomePreview. looking like . is part of the preview)\nYou try -> You tried\nDo you configure .. -> Did you apply .. ?", "url": "https://github.com/line/armeria/pull/2422#discussion_r373294975", "createdAt": "2020-01-31T02:47:44Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -780,6 +785,11 @@ public String requestContentPreview() {\n     @Override\n     public void requestContentPreview(@Nullable String requestContentPreview) {\n         if (isAvailable(RequestLogProperty.REQUEST_CONTENT_PREVIEW)) {\n+            if (requestContentPreview != null) {\n+                logger.warn(\"You try to set the request content preview twice: {}. \" +\n+                            \" Do you configure content previewing decorator more than once?\",\n+                            requestContentPreview);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5587e426777056c79598cdbea8847ac62a16be2a"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI5NTIxNA==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/2422#discussion_r373295214", "createdAt": "2020-01-31T02:48:47Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -1066,6 +1075,11 @@ public String responseContentPreview() {\n     @Override\n     public void responseContentPreview(@Nullable String responseContentPreview) {\n         if (isAvailable(RequestLogProperty.RESPONSE_CONTENT_PREVIEW)) {\n+            if (responseContentPreview != null) {\n+                logger.warn(\"You try to set the response content preview twice: {}. \" +\n+                            \" Do you configure content previewing decorator more than once?\",\n+                            responseContentPreview);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5587e426777056c79598cdbea8847ac62a16be2a"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a38d6dc98c664d40317b803412e7f76eee2bdd5", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/9a38d6dc98c664d40317b803412e7f76eee2bdd5", "committedDate": "2020-01-31T03:01:28Z", "message": "Fix warning message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMjcyMzA0", "url": "https://github.com/line/armeria/pull/2422#pullrequestreview-351272304", "createdAt": "2020-01-31T03:07:37Z", "commit": {"oid": "9a38d6dc98c664d40317b803412e7f76eee2bdd5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMzA5NDQ0", "url": "https://github.com/line/armeria/pull/2422#pullrequestreview-351309444", "createdAt": "2020-01-31T06:14:31Z", "commit": {"oid": "9a38d6dc98c664d40317b803412e7f76eee2bdd5"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwNjoxNDozMVrOFkCORw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwNjoyMTowOFrOFkCToA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMyOTQ3OQ==", "bodyText": "Do you think we should check state here too? It might give a user earlier feedback", "url": "https://github.com/line/armeria/pull/2422#discussion_r373329479", "createdAt": "2020-01-31T06:14:31Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/client/logging/ContentPreviewingClientBuilder.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.logging;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+\n+import java.nio.charset.Charset;\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.client.HttpClient;\n+import com.linecorp.armeria.common.logging.ContentPreviewerFactory;\n+import com.linecorp.armeria.common.logging.ContentPreviewingDecoratorBuilder;\n+\n+/**\n+ * Builds a new {@link ContentPreviewingClient} or its decorator function.\n+ */\n+public final class ContentPreviewingClientBuilder extends ContentPreviewingDecoratorBuilder {\n+\n+    @Override\n+    public ContentPreviewingClientBuilder contentPreview(int length) {\n+        return (ContentPreviewingClientBuilder) super.contentPreview(length);\n+    }\n+\n+    @Override\n+    public ContentPreviewingClientBuilder contentPreview(int length, Charset defaultCharset) {\n+        return (ContentPreviewingClientBuilder) super.contentPreview(length, defaultCharset);\n+    }\n+\n+    @Override\n+    public ContentPreviewingClientBuilder contentPreviewerFactory(ContentPreviewerFactory factory) {\n+        return (ContentPreviewingClientBuilder) super.contentPreviewerFactory(factory);\n+    }\n+\n+    @Override\n+    public ContentPreviewingClientBuilder requestContentPreviewerFactory(\n+            ContentPreviewerFactory requestContentPreviewerFactory) {\n+        return (ContentPreviewingClientBuilder)\n+                super.requestContentPreviewerFactory(requestContentPreviewerFactory);\n+    }\n+\n+    @Override\n+    public ContentPreviewingClientBuilder responseContentPreviewerFactory(\n+            ContentPreviewerFactory responseContentPreviewerFactory) {\n+        return (ContentPreviewingClientBuilder)\n+                super.responseContentPreviewerFactory(responseContentPreviewerFactory);\n+    }\n+\n+    /**\n+     * Returns a newly-created {@link ContentPreviewingClient} based on the properties of this builder.\n+     */\n+    public ContentPreviewingClient build(HttpClient delegate) {\n+        checkState(requestContentPreviewerFactory() != null || responseContentPreviewerFactory() != null,\n+                   \"requestContentPreviewerFactory or responseContentPreviewerFactory must be set.\");\n+        return new ContentPreviewingClient(delegate, requestContentPreviewerFactory(),\n+                                           responseContentPreviewerFactory());\n+    }\n+\n+    /**\n+     * Returns a newly-created decorator that decorates an {@link HttpClient} with a new\n+     * {@link ContentPreviewingClient} based on the properties of this builder.\n+     */\n+    public Function<? super HttpClient, ContentPreviewingClient> newDecorator() {\n+        return this::build;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a38d6dc98c664d40317b803412e7f76eee2bdd5"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzMzMDg0OA==", "bodyText": "What is this testing? Or mostly for documentation of ordering semantics?", "url": "https://github.com/line/armeria/pull/2422#discussion_r373330848", "createdAt": "2020-01-31T06:21:08Z", "author": {"login": "anuraaga"}, "path": "core/src/test/java/com/linecorp/armeria/client/logging/ContentPreviewingClientTest.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.logging;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.ByteArrayInputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.function.Function;\n+import java.util.zip.GZIPInputStream;\n+\n+import org.junit.jupiter.api.RepeatedTest;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import com.google.common.io.ByteStreams;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.client.ClientRequestContextCaptor;\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.HttpClient;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.encoding.DecodingClient;\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.common.logging.ContentPreviewer;\n+import com.linecorp.armeria.common.logging.ContentPreviewerFactory;\n+import com.linecorp.armeria.common.logging.RequestLog;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.encoding.EncodingService;\n+import com.linecorp.armeria.testing.junit.server.ServerExtension;\n+\n+class ContentPreviewingClientTest {\n+\n+    @RegisterExtension\n+    static final ServerExtension server = new ServerExtension() {\n+        @Override\n+        protected void configure(ServerBuilder sb) throws Exception {\n+            sb.service(\"/\", (ctx, req) -> HttpResponse.from(\n+                    req.aggregate()\n+                       .thenApply(aggregated -> {\n+                           final ResponseHeaders responseHeaders =\n+                                   ResponseHeaders.of(HttpStatus.OK,\n+                                                      HttpHeaderNames.CONTENT_TYPE, MediaType.PLAIN_TEXT_UTF_8);\n+                           return HttpResponse.of(responseHeaders,\n+                                                  HttpData.ofUtf8(\"Hello \" + aggregated.contentUtf8() + '!'));\n+                       })));\n+            sb.decorator(delegate -> new EncodingService(delegate, unused -> true, 1));\n+        }\n+    };\n+\n+    @RepeatedTest(10)\n+    void decodedContentPreview() {\n+        final WebClient client = WebClient.builder(server.uri(\"/\"))\n+                                          .decorator(DecodingClient.newDecorator())\n+                                          .decorator(ContentPreviewingClient.builder()\n+                                                                            .contentPreview(100)\n+                                                                            .newDecorator())\n+                                          .build();\n+        final RequestHeaders headers = RequestHeaders.of(HttpMethod.POST, \"/\",\n+                                                         HttpHeaderNames.CONTENT_TYPE, \"text/plain\");\n+\n+        final ClientRequestContext context;\n+        try (ClientRequestContextCaptor captor = Clients.newContextCaptor()) {\n+            final AggregatedHttpResponse res = client.execute(headers, \"Armeria\").aggregate().join();\n+            assertThat(res.contentUtf8()).isEqualTo(\"Hello Armeria!\");\n+            assertThat(res.headers().get(HttpHeaderNames.CONTENT_ENCODING)).isEqualTo(\"gzip\");\n+            context = captor.get();\n+        }\n+\n+        final RequestLog requestLog = context.log().whenComplete().join();\n+        assertThat(requestLog.requestContentPreview()).isEqualTo(\"Armeria\");\n+        assertThat(requestLog.responseContentPreview()).isEqualTo(\"Hello Armeria!\");\n+    }\n+\n+    @Test\n+    void contentPreviewIsDecodedInPreviewer() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a38d6dc98c664d40317b803412e7f76eee2bdd5"}, "originalPosition": 98}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06639a017b9d73caf9b91907de54b3956a7846b5", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/06639a017b9d73caf9b91907de54b3956a7846b5", "committedDate": "2020-01-31T07:28:05Z", "message": "Add checkState"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "757caeacd0d2c6e14972e2e94739f5e2bd892b4e", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/757caeacd0d2c6e14972e2e94739f5e2bd892b4e", "committedDate": "2020-01-31T08:36:33Z", "message": "Add comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMzU3NTg1", "url": "https://github.com/line/armeria/pull/2422#pullrequestreview-351357585", "createdAt": "2020-01-31T08:42:20Z", "commit": {"oid": "757caeacd0d2c6e14972e2e94739f5e2bd892b4e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93af158328f2fef9d75db60e769d3796c6c01ca9", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/93af158328f2fef9d75db60e769d3796c6c01ca9", "committedDate": "2020-01-31T09:03:17Z", "message": "Remove unused"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNDI4MjA5", "url": "https://github.com/line/armeria/pull/2422#pullrequestreview-351428209", "createdAt": "2020-01-31T10:53:23Z", "commit": {"oid": "93af158328f2fef9d75db60e769d3796c6c01ca9"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMToxMzowMFrOFkIWdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMTo0NToyNFrOFkJC7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQyOTg3OA==", "bodyText": "nit: Could join two lines?", "url": "https://github.com/line/armeria/pull/2422#discussion_r373429878", "createdAt": "2020-01-31T11:13:00Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/ServiceConfig.java", "diffHunk": "@@ -60,32 +56,24 @@\n      */\n     ServiceConfig(Route route, HttpService service,\n                   long requestTimeoutMillis, long maxRequestLength, boolean verboseResponses,\n-                  ContentPreviewerFactory requestContentPreviewerFactory,\n-                  ContentPreviewerFactory responseContentPreviewerFactory, AccessLogWriter accessLogWriter,\n+                  AccessLogWriter accessLogWriter,\n                   boolean shutdownAccessLogWriterOnStop) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93af158328f2fef9d75db60e769d3796c6c01ca9"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQzOTExMg==", "bodyText": "Don't we need a package-private default constructor?", "url": "https://github.com/line/armeria/pull/2422#discussion_r373439112", "createdAt": "2020-01-31T11:38:36Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/logging/ContentPreviewingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.logging;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+\n+import java.nio.charset.Charset;\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.logging.ContentPreviewerFactory;\n+import com.linecorp.armeria.common.logging.ContentPreviewingDecoratorBuilder;\n+import com.linecorp.armeria.server.HttpService;\n+\n+/**\n+ * Builds a new {@link ContentPreviewingService} or its decorator function.\n+ */\n+public final class ContentPreviewingServiceBuilder extends ContentPreviewingDecoratorBuilder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93af158328f2fef9d75db60e769d3796c6c01ca9"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQzOTUzNw==", "bodyText": "Don't we need a package-private default constructor?", "url": "https://github.com/line/armeria/pull/2422#discussion_r373439537", "createdAt": "2020-01-31T11:40:02Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/logging/ContentPreviewingClientBuilder.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.logging;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+\n+import java.nio.charset.Charset;\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.client.HttpClient;\n+import com.linecorp.armeria.common.logging.ContentPreviewerFactory;\n+import com.linecorp.armeria.common.logging.ContentPreviewingDecoratorBuilder;\n+\n+/**\n+ * Builds a new {@link ContentPreviewingClient} or its decorator function.\n+ */\n+public final class ContentPreviewingClientBuilder extends ContentPreviewingDecoratorBuilder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93af158328f2fef9d75db60e769d3796c6c01ca9"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ0MTI2Mg==", "bodyText": "nit: requireNonNull(defaulCharset, \"defaultCharset\");?", "url": "https://github.com/line/armeria/pull/2422#discussion_r373441262", "createdAt": "2020-01-31T11:45:24Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/ContentPreviewingDecoratorBuilder.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.logging;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.nio.charset.Charset;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.internal.ArmeriaHttpUtil;\n+\n+/**\n+ * Builds a new content previewing decorator or its decorator function.\n+ */\n+public abstract class ContentPreviewingDecoratorBuilder {\n+\n+    @Nullable\n+    private ContentPreviewerFactory requestContentPreviewerFactory;\n+\n+    @Nullable\n+    private ContentPreviewerFactory responseContentPreviewerFactory;\n+\n+    /**\n+     * Creates a new instance.\n+     */\n+    protected ContentPreviewingDecoratorBuilder() {}\n+\n+    /**\n+     * Sets the {@link ContentPreviewerFactory} for creating a {@link ContentPreviewer} which produces the\n+     * preview with the maximum {@code length} limit for a request and a response.\n+     * The previewer is enabled only if the content type of a request/response meets\n+     * any of the following conditions:\n+     * <ul>\n+     *     <li>when it matches {@code text/*} or {@code application/x-www-form-urlencoded}</li>\n+     *     <li>when its charset has been specified</li>\n+     *     <li>when its subtype is {@code \"xml\"} or {@code \"json\"}</li>\n+     *     <li>when its subtype ends with {@code \"+xml\"} or {@code \"+json\"}</li>\n+     * </ul>\n+     * @param length the maximum length of the preview.\n+     */\n+    public ContentPreviewingDecoratorBuilder contentPreview(int length) {\n+        return contentPreview(length, ArmeriaHttpUtil.HTTP_DEFAULT_CONTENT_CHARSET);\n+    }\n+\n+    /**\n+     * Sets the {@link ContentPreviewerFactory} for creating a {@link ContentPreviewer} which produces the\n+     * preview with the maximum {@code length} limit for a request and a response.\n+     * The previewer is enabled only if the content type of a request/response meets\n+     * any of the following conditions:\n+     * <ul>\n+     *     <li>when it matches {@code text/*} or {@code application/x-www-form-urlencoded}</li>\n+     *     <li>when its charset has been specified</li>\n+     *     <li>when its subtype is {@code \"xml\"} or {@code \"json\"}</li>\n+     *     <li>when its subtype ends with {@code \"+xml\"} or {@code \"+json\"}</li>\n+     * </ul>\n+     * @param length the maximum length of the preview\n+     * @param defaultCharset the default charset used when a charset is not specified in the\n+     *                       {@code \"content-type\"} header\n+     */\n+    public ContentPreviewingDecoratorBuilder contentPreview(int length, Charset defaultCharset) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93af158328f2fef9d75db60e769d3796c6c01ca9"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87ce23853bbfece7476039b76952ddb000acc5d7", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/87ce23853bbfece7476039b76952ddb000acc5d7", "committedDate": "2020-01-31T12:10:55Z", "message": "Address comments by @ikhoon"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNDY1ODU3", "url": "https://github.com/line/armeria/pull/2422#pullrequestreview-351465857", "createdAt": "2020-01-31T12:12:32Z", "commit": {"oid": "87ce23853bbfece7476039b76952ddb000acc5d7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 912, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}