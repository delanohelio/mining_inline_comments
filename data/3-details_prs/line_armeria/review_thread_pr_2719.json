{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MTIzNDQ4", "number": 2719, "reviewThreads": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo0MjozN1rOD9N9Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwMjoyNjo1M1rOEIlz2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTE4MzY3OnYy", "diffSide": "RIGHT", "path": "benchmarks/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo0MjozN1rOGWlV_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo0MjozN1rOGWlV_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzMzY5NQ==", "bodyText": "Missing space before {", "url": "https://github.com/line/armeria/pull/2719#discussion_r426333695", "createdAt": "2020-05-18T01:42:37Z", "author": {"login": "trustin"}, "path": "benchmarks/build.gradle", "diffHunk": "@@ -79,3 +78,12 @@ jmh {\n         }\n     }\n }\n+\n+// Workaround a bug where the conflict of output path between 'benchmarks.jmh' and 'benchmarks.test' in IDEA\n+project.afterEvaluate {\n+    idea {\n+        module{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTE4ODY0OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo0Njo1M1rOGWlYzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo0Njo1M1rOGWlYzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDQxNQ==", "bodyText": "to the specified -> with the specified", "url": "https://github.com/line/armeria/pull/2719#discussion_r426334415", "createdAt": "2020-05-18T01:46:53Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "diffHunk": "@@ -76,11 +83,27 @@\n     public static final ClientOption<Boolean> UNSAFE_WRAP_RESPONSE_BUFFERS =\n             ClientOption.define(\"GRPC_UNSAFE_WRAP_RESPONSE_BUFFERS\", false);\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTE4OTU5OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo0NzozOFrOGWlZVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo0NzozOFrOGWlZVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDU1MA==", "bodyText": "Note that JSON_MAR... option will be ignored if this option is set.", "url": "https://github.com/line/armeria/pull/2719#discussion_r426334550", "createdAt": "2020-05-18T01:47:38Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "diffHunk": "@@ -76,11 +83,27 @@\n     public static final ClientOption<Boolean> UNSAFE_WRAP_RESPONSE_BUFFERS =\n             ClientOption.define(\"GRPC_UNSAFE_WRAP_RESPONSE_BUFFERS\", false);\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n+     * {@link GrpcMessageMarshaller}.\n+     *\n+     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n+     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n+     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     *\n+     * Note that this option is configured, {@link #JSON_MARSHALLER_CUSTOMIZER} option will be ignored.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTE5MDM1OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo0ODoxNVrOGWlZxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo0ODoxNVrOGWlZxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDY2Mw==", "bodyText": "Note that this option will be ignored if GRPC_MESSAGE... is set.", "url": "https://github.com/line/armeria/pull/2719#discussion_r426334663", "createdAt": "2020-05-18T01:48:15Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "diffHunk": "@@ -76,11 +83,27 @@\n     public static final ClientOption<Boolean> UNSAFE_WRAP_RESPONSE_BUFFERS =\n             ClientOption.define(\"GRPC_UNSAFE_WRAP_RESPONSE_BUFFERS\", false);\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n+     * {@link GrpcMessageMarshaller}.\n+     *\n+     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n+     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n+     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     *\n+     * Note that this option is configured, {@link #JSON_MARSHALLER_CUSTOMIZER} option will be ignored.\n+     */\n+    public static final ClientOption<GrpcMessageMarshaller> GRPC_MESSAGE_MARSHALLER =\n+            ClientOption.define(\"GRPC_MESSAGE_MARSHALLER\", NoopGrpcMessageMarshaller.get());\n+\n     /**\n      * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n      * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n      * using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n+     *\n+     * Note that a {@link #GRPC_MESSAGE_MARSHALLER} is configured, this option will be ignored.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTE5MDk2OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaChannel.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo0ODo1N1rOGWlaKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMjozMjoxOVrOGWl3EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDc2Mw==", "bodyText": "Maybe better using null instead of NoopGrpcMessageMarshaller?", "url": "https://github.com/line/armeria/pull/2719#discussion_r426334763", "createdAt": "2020-05-18T01:48:57Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaChannel.java", "diffHunk": "@@ -62,23 +68,31 @@\n     private final MeterRegistry meterRegistry;\n     private final SessionProtocol sessionProtocol;\n     private final SerializationFormat serializationFormat;\n-    @Nullable\n-    private final MessageMarshaller jsonMarshaller;\n+    private final GrpcMessageMarshaller messageMarshaller;\n     private final String advertisedEncodingsHeader;\n \n     ArmeriaChannel(ClientBuilderParams params,\n                    HttpClient httpClient,\n                    MeterRegistry meterRegistry,\n                    SessionProtocol sessionProtocol,\n                    SerializationFormat serializationFormat,\n+                   GrpcMessageMarshaller messageMarshaller,\n                    @Nullable MessageMarshaller jsonMarshaller) {\n         this.params = params;\n         this.httpClient = httpClient;\n         this.meterRegistry = meterRegistry;\n         this.sessionProtocol = sessionProtocol;\n         this.serializationFormat = serializationFormat;\n-        this.jsonMarshaller = jsonMarshaller;\n-\n+        if (messageMarshaller != NoopGrpcMessageMarshaller.get()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzODEyNA==", "bodyText": "I tried at first, but I realized a ClientOption does not take null as a default value.\n// Will throw NullPointerException\nClientOption.define(\"GRPC_MESSAGE_MARSHALLER\", null);\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/common/util/AbstractOption.java\n    \n    \n        Lines 113 to 118\n      in\n      56c58ff\n    \n    \n    \n    \n\n        \n          \n           T define(Class<?> type, String name, V defaultValue, \n        \n\n        \n          \n                    Factory<T, U, V> optionFactory, Function<V, V> validator, BiFunction<U, U, U> mergeFunction) { \n        \n\n        \n          \n            \n        \n\n        \n          \n               requireNonNull(type, \"type\"); \n        \n\n        \n          \n               requireNonNull(name, \"name\"); \n        \n\n        \n          \n               requireNonNull(defaultValue, \"defaultValue\"); \n        \n    \n  \n\n\nProbably better to make it accept null?", "url": "https://github.com/line/armeria/pull/2719#discussion_r426338124", "createdAt": "2020-05-18T02:09:11Z", "author": {"login": "ikhoon"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaChannel.java", "diffHunk": "@@ -62,23 +68,31 @@\n     private final MeterRegistry meterRegistry;\n     private final SessionProtocol sessionProtocol;\n     private final SerializationFormat serializationFormat;\n-    @Nullable\n-    private final MessageMarshaller jsonMarshaller;\n+    private final GrpcMessageMarshaller messageMarshaller;\n     private final String advertisedEncodingsHeader;\n \n     ArmeriaChannel(ClientBuilderParams params,\n                    HttpClient httpClient,\n                    MeterRegistry meterRegistry,\n                    SessionProtocol sessionProtocol,\n                    SerializationFormat serializationFormat,\n+                   GrpcMessageMarshaller messageMarshaller,\n                    @Nullable MessageMarshaller jsonMarshaller) {\n         this.params = params;\n         this.httpClient = httpClient;\n         this.meterRegistry = meterRegistry;\n         this.sessionProtocol = sessionProtocol;\n         this.serializationFormat = serializationFormat;\n-        this.jsonMarshaller = jsonMarshaller;\n-\n+        if (messageMarshaller != NoopGrpcMessageMarshaller.get()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDc2Mw=="}, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM0MDE3NA==", "bodyText": "That's a good point. If we accept null, we will have to add @Nullable to the getter methods which doesn't sound like a good idea. Let's leave this as it is. \ud83d\ude05", "url": "https://github.com/line/armeria/pull/2719#discussion_r426340174", "createdAt": "2020-05-18T02:21:27Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaChannel.java", "diffHunk": "@@ -62,23 +68,31 @@\n     private final MeterRegistry meterRegistry;\n     private final SessionProtocol sessionProtocol;\n     private final SerializationFormat serializationFormat;\n-    @Nullable\n-    private final MessageMarshaller jsonMarshaller;\n+    private final GrpcMessageMarshaller messageMarshaller;\n     private final String advertisedEncodingsHeader;\n \n     ArmeriaChannel(ClientBuilderParams params,\n                    HttpClient httpClient,\n                    MeterRegistry meterRegistry,\n                    SessionProtocol sessionProtocol,\n                    SerializationFormat serializationFormat,\n+                   GrpcMessageMarshaller messageMarshaller,\n                    @Nullable MessageMarshaller jsonMarshaller) {\n         this.params = params;\n         this.httpClient = httpClient;\n         this.meterRegistry = meterRegistry;\n         this.sessionProtocol = sessionProtocol;\n         this.serializationFormat = serializationFormat;\n-        this.jsonMarshaller = jsonMarshaller;\n-\n+        if (messageMarshaller != NoopGrpcMessageMarshaller.get()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDc2Mw=="}, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjM0MjE2MQ==", "bodyText": "Agreed!", "url": "https://github.com/line/armeria/pull/2719#discussion_r426342161", "createdAt": "2020-05-18T02:32:19Z", "author": {"login": "ikhoon"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaChannel.java", "diffHunk": "@@ -62,23 +68,31 @@\n     private final MeterRegistry meterRegistry;\n     private final SessionProtocol sessionProtocol;\n     private final SerializationFormat serializationFormat;\n-    @Nullable\n-    private final MessageMarshaller jsonMarshaller;\n+    private final GrpcMessageMarshaller messageMarshaller;\n     private final String advertisedEncodingsHeader;\n \n     ArmeriaChannel(ClientBuilderParams params,\n                    HttpClient httpClient,\n                    MeterRegistry meterRegistry,\n                    SessionProtocol sessionProtocol,\n                    SerializationFormat serializationFormat,\n+                   GrpcMessageMarshaller messageMarshaller,\n                    @Nullable MessageMarshaller jsonMarshaller) {\n         this.params = params;\n         this.httpClient = httpClient;\n         this.meterRegistry = meterRegistry;\n         this.sessionProtocol = sessionProtocol;\n         this.serializationFormat = serializationFormat;\n-        this.jsonMarshaller = jsonMarshaller;\n-\n+        if (messageMarshaller != NoopGrpcMessageMarshaller.get()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNDc2Mw=="}, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTE5Mzk2OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/PrototypeMessageMarshaller.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1MToyMVrOGWlb5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1MToyMVrOGWlb5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTIwNw==", "bodyText": "Prototype or Protobuf?\nfinal?", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335207", "createdAt": "2020-05-18T01:51:21Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/PrototypeMessageMarshaller.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common.grpc;\n+\n+import java.io.IOException;\n+\n+import javax.annotation.Nullable;\n+\n+import org.curioswitch.common.protobuf.json.MessageMarshaller;\n+\n+import com.google.protobuf.CodedInputStream;\n+import com.google.protobuf.CodedOutputStream;\n+import com.google.protobuf.InvalidProtocolBufferException;\n+import com.google.protobuf.Message;\n+import com.google.protobuf.UnsafeByteOperations;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+import com.linecorp.armeria.common.grpc.GrpcSerializationFormats;\n+\n+import io.grpc.MethodDescriptor.Marshaller;\n+import io.grpc.MethodDescriptor.PrototypeMarshaller;\n+import io.grpc.Status;\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufInputStream;\n+import io.netty.buffer.ByteBufOutputStream;\n+\n+/**\n+ * A {@link GrpcMessageMarshaller} for {@link PrototypeMarshaller} that provides optimized code paths\n+ * for a {@link Message}.\n+ */\n+public class PrototypeMessageMarshaller implements GrpcMessageMarshaller {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTE5NDM2OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/FramedGrpcService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1MTo0M1rOGWlcHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1ODoyNFrOGWlgoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTI2Mw==", "bodyText": "Revert?", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335263", "createdAt": "2020-05-18T01:51:43Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/FramedGrpcService.java", "diffHunk": "@@ -129,8 +139,8 @@\n         advertisedEncodingsHeader = String.join(\",\", decompressorRegistry.getAdvertisedMessageEncodings());\n \n         defaultHeaders = supportedSerializationFormats\n-                .stream()\n-                .map(format -> {\n+                                 .stream()\n+                                 .map(format -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNjQxNg==", "bodyText": "Oops...", "url": "https://github.com/line/armeria/pull/2719#discussion_r426336416", "createdAt": "2020-05-18T01:58:24Z", "author": {"login": "ikhoon"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/FramedGrpcService.java", "diffHunk": "@@ -129,8 +139,8 @@\n         advertisedEncodingsHeader = String.join(\",\", decompressorRegistry.getAdvertisedMessageEncodings());\n \n         defaultHeaders = supportedSerializationFormats\n-                .stream()\n-                .map(format -> {\n+                                 .stream()\n+                                 .map(format -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTI2Mw=="}, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTE5NDY4OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1MjowNFrOGWlcUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1MjowNFrOGWlcUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTMxNQ==", "bodyText": "serializes and deserialzes", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335315", "createdAt": "2020-05-18T01:52:04Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -261,14 +268,36 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n         return this;\n     }\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTE5NDkyOnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1MjoxOVrOGWlcfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1MjoxOVrOGWlcfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTM1Ng==", "bodyText": "with the specified", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335356", "createdAt": "2020-05-18T01:52:19Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -261,14 +268,36 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n         return this;\n     }\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTE5NTU3OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1Mjo0N1rOGWlc0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1Mjo0N1rOGWlc0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTQ0MQ==", "bodyText": "Note that this method will throw ... if ... is set.", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335441", "createdAt": "2020-05-18T01:52:47Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -261,14 +268,36 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n         return this;\n     }\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n+     * {@link GrpcMessageMarshaller}.\n+     *\n+     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n+     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n+     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     *\n+     * Note that a {@link #jsonMarshallerCustomizer(Consumer)} is configured,\n+     * this method will throw an {@link IllegalStateException}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTE5NTg1OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1MzowM1rOGWlc_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwMTo1MzowM1rOGWlc_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMzNTQ4NA==", "bodyText": "Note that this method will ... if ... is set.", "url": "https://github.com/line/armeria/pull/2719#discussion_r426335484", "createdAt": "2020-05-18T01:53:03Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -261,14 +268,36 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n         return this;\n     }\n \n+    /**\n+     * Sets a {@link GrpcMessageMarshaller} that serialize and deserialize request or response messages\n+     * to and from {@link ByteBuf}. This replaces the built-in {@link GrpcMessageMarshaller} to the specified\n+     * {@link GrpcMessageMarshaller}.\n+     *\n+     * This is commonly used to optimize code paths for a subclass of {@link Marshaller} or enable to handle\n+     * {@link GrpcSerializationFormats#JSON} and {@link GrpcSerializationFormats#JSON_WEB} formats by\n+     * marshalling a message to and from JSON depending on {@link SerializationFormat}.\n+     *\n+     * Note that a {@link #jsonMarshallerCustomizer(Consumer)} is configured,\n+     * this method will throw an {@link IllegalStateException}.\n+     */\n+    public GrpcServiceBuilder messageMarshaller(GrpcMessageMarshaller messageMarshaller) {\n+        checkState(!isJsonMarshallerCustomizerSet, \"jsonMarshallerCustomizer has been set already.\");\n+        this.messageMarshaller = requireNonNull(messageMarshaller, \"messageMarshaller\");\n+        return this;\n+    }\n+\n     /**\n      * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n      * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n      * using the field name from the proto definition, by setting\n      * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n+     *\n+     * Note that a {@link #messageMarshaller(GrpcMessageMarshaller)} is configured,\n+     * this method will throw an {@link IllegalStateException}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a546f575049e458a23d436d25538ce61f96210ba"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NjM1NTM3OnYy", "diffSide": "RIGHT", "path": "gradle/scripts/lib/java-rpc-proto.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjoyMzoyN1rOGkYxFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjoyMzoyN1rOGkYxFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgwNzcwMA==", "bodyText": "Probably better not using static import? current() seems confusing.", "url": "https://github.com/line/armeria/pull/2719#discussion_r440807700", "createdAt": "2020-06-16T12:23:27Z", "author": {"login": "trustin"}, "path": "gradle/scripts/lib/java-rpc-proto.gradle", "diffHunk": "@@ -41,22 +44,38 @@ configure(projectsWithFlags('java')) {\n                             artifact = \"io.grpc:protoc-gen-grpc-kotlin:${managedVersions['io.grpc:protoc-gen-grpc-kotlin']}\"\n                         }\n                     }\n+\n+                    def isWindow = current() == WINDOWS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "212ff87f0173e7765bef9718115a90ec465610a8"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NjM4ODg5OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/GrpcClientFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjozMjo1OVrOGkZGPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjo0Mjo1OVrOGkZdQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgxMzExOA==", "bodyText": "This makes me think GRPC_JSON_MARSHALLER and JSON_MARSHALLER_CUSTOMIZER are not orthogonal. Should we merge these two options into one, e.g. GRPC_JSON_MARSHALLER_FACTORY (Function<Class<?>, GrpcJsonMarshaller>)? The default value of the new option could be something like:\nclientType -> GrpcJsonMarshaller.of(clientType)\nwhere GrpcJsonMarshaller.of() calls something like new DefaultJsonMarshaller(GrpcJsonUtil.jsonMarshaller(stubMethods(clientType)).\nIf a user wants to customize the marshaller, the user could specify an alternative factory like this:\nclientType -> GrpcJsonMarshaller.builder(clientType)\n                                ...\n                                .build()\nFor ScalaPB and others, it could be _ -> ScalaPBJsonMarshaller().\nWhat do you think, @ikhoon and @anuraaga ?", "url": "https://github.com/line/armeria/pull/2719#discussion_r440813118", "createdAt": "2020-06-16T12:32:59Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/GrpcClientFactory.java", "diffHunk": "@@ -95,13 +98,14 @@ public Object newClient(ClientBuilderParams params) {\n \n         final HttpClient httpClient = newHttpClient(params);\n \n-        // TODO(ikhoon): Support gjson with Kotlin coroutine stub once\n-        //               https://github.com/grpc/grpc-kotlin/pull/63 is released\n-        final MessageMarshaller jsonMarshaller =\n-                GrpcSerializationFormats.isJson(serializationFormat) ?\n-                GrpcJsonUtil.jsonMarshaller(\n-                        stubMethods(clientType),\n-                        options.get(GrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER)) : null;\n+        GrpcJsonMarshaller jsonMarshaller = null;\n+        if (GrpcSerializationFormats.isJson(serializationFormat)) {\n+            jsonMarshaller = options.get(GrpcClientOptions.GRPC_JSON_MARSHALLER);\n+            if (jsonMarshaller == NoopJsonMarshaller.get()) {\n+                jsonMarshaller = new DefaultJsonMarshaller(GrpcJsonUtil.jsonMarshaller(\n+                        stubMethods(clientType), options.get(GrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "212ff87f0173e7765bef9718115a90ec465610a8"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgxOTAxMA==", "bodyText": "That was my most considering part - JSON marshaller and JSON marshaller customizer. I want to merge the extension points into one.\nGRPC_JSON_MARSHALLER_FACTORY looks good to me. \ud83d\udc4d", "url": "https://github.com/line/armeria/pull/2719#discussion_r440819010", "createdAt": "2020-06-16T12:42:59Z", "author": {"login": "ikhoon"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/GrpcClientFactory.java", "diffHunk": "@@ -95,13 +98,14 @@ public Object newClient(ClientBuilderParams params) {\n \n         final HttpClient httpClient = newHttpClient(params);\n \n-        // TODO(ikhoon): Support gjson with Kotlin coroutine stub once\n-        //               https://github.com/grpc/grpc-kotlin/pull/63 is released\n-        final MessageMarshaller jsonMarshaller =\n-                GrpcSerializationFormats.isJson(serializationFormat) ?\n-                GrpcJsonUtil.jsonMarshaller(\n-                        stubMethods(clientType),\n-                        options.get(GrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER)) : null;\n+        GrpcJsonMarshaller jsonMarshaller = null;\n+        if (GrpcSerializationFormats.isJson(serializationFormat)) {\n+            jsonMarshaller = options.get(GrpcClientOptions.GRPC_JSON_MARSHALLER);\n+            if (jsonMarshaller == NoopJsonMarshaller.get()) {\n+                jsonMarshaller = new DefaultJsonMarshaller(GrpcJsonUtil.jsonMarshaller(\n+                        stubMethods(clientType), options.get(GrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgxMzExOA=="}, "originalCommit": {"oid": "212ff87f0173e7765bef9718115a90ec465610a8"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDg1MTc1OnYy", "diffSide": "RIGHT", "path": "benchmarks/build.gradle", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNzoyNDo0NlrOGoGFyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNzo0NTozNlrOGoGugA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5NjAwOA==", "bodyText": "I haven't seen this before, what is it working around?", "url": "https://github.com/line/armeria/pull/2719#discussion_r444696008", "createdAt": "2020-06-24T07:24:46Z", "author": {"login": "anuraaga"}, "path": "benchmarks/build.gradle", "diffHunk": "@@ -80,3 +79,12 @@ jmh {\n         }\n     }\n }\n+\n+// Workaround a bug where the conflict of output path between 'benchmarks.jmh' and 'benchmarks.test' in IDEA", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "361e29d19815e6fd9d8abd5b5092c690a91e789d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwNjQzMg==", "bodyText": "I think, maybe, this is caused by plugin scala.\nIf I remove this block I will get the following message from the IntelliJ.", "url": "https://github.com/line/armeria/pull/2719#discussion_r444706432", "createdAt": "2020-06-24T07:45:36Z", "author": {"login": "ikhoon"}, "path": "benchmarks/build.gradle", "diffHunk": "@@ -80,3 +79,12 @@ jmh {\n         }\n     }\n }\n+\n+// Workaround a bug where the conflict of output path between 'benchmarks.jmh' and 'benchmarks.test' in IDEA", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY5NjAwOA=="}, "originalCommit": {"oid": "361e29d19815e6fd9d8abd5b5092c690a91e789d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDg4NDk2OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNzozNTozMVrOGoGafA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNzo0NzowOFrOGoGxlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMTMwOA==", "bodyText": "Is this used?", "url": "https://github.com/line/armeria/pull/2719#discussion_r444701308", "createdAt": "2020-06-24T07:35:31Z", "author": {"login": "anuraaga"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common.grpc;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+\n+import com.linecorp.armeria.common.grpc.GrpcJsonMarshaller;\n+\n+import io.grpc.MethodDescriptor.Marshaller;\n+\n+public final class NoopJsonMarshaller implements GrpcJsonMarshaller {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "361e29d19815e6fd9d8abd5b5092c690a91e789d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwNzIyMQ==", "bodyText": "Oops.. this is cruft. It was removed now.", "url": "https://github.com/line/armeria/pull/2719#discussion_r444707221", "createdAt": "2020-06-24T07:47:08Z", "author": {"login": "ikhoon"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common.grpc;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+\n+import com.linecorp.armeria.common.grpc.GrpcJsonMarshaller;\n+\n+import io.grpc.MethodDescriptor.Marshaller;\n+\n+public final class NoopJsonMarshaller implements GrpcJsonMarshaller {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMTMwOA=="}, "originalCommit": {"oid": "361e29d19815e6fd9d8abd5b5092c690a91e789d"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDg4NTYzOnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNzozNTo0NVrOGoGa4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNzozNTo0NVrOGoGa4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDcwMTQxMA==", "bodyText": "I don't know if we need this class, but if we do we want to return default instance, not null.", "url": "https://github.com/line/armeria/pull/2719#discussion_r444701410", "createdAt": "2020-06-24T07:35:45Z", "author": {"login": "anuraaga"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/NoopJsonMarshaller.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.common.grpc;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.OutputStream;\n+\n+import com.linecorp.armeria.common.grpc.GrpcJsonMarshaller;\n+\n+import io.grpc.MethodDescriptor.Marshaller;\n+\n+public final class NoopJsonMarshaller implements GrpcJsonMarshaller {\n+\n+    private static final NoopJsonMarshaller INSTANCE = new NoopJsonMarshaller();\n+\n+    public static NoopJsonMarshaller get() {\n+        return INSTANCE;\n+    }\n+\n+    private NoopJsonMarshaller() {}\n+\n+    @Override\n+    public <T> void serializeMessage(Marshaller<T> marshaller, T message, OutputStream os) throws IOException {}\n+\n+    @Override\n+    public <T> T deserializeMessage(Marshaller<T> marshaller, InputStream is) throws IOException {\n+        return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "361e29d19815e6fd9d8abd5b5092c690a91e789d"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MTE3MzUwOnYy", "diffSide": "RIGHT", "path": "examples/grpc-scala/src/main/scala/example/armeria/grpc/scala/HelloServiceImpl.scala", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwODo1ODo0OVrOGoJRrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwODo1ODo0OVrOGoJRrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDc0ODIwNQ==", "bodyText": "two empty lines?", "url": "https://github.com/line/armeria/pull/2719#discussion_r444748205", "createdAt": "2020-06-24T08:58:49Z", "author": {"login": "minwoox"}, "path": "examples/grpc-scala/src/main/scala/example/armeria/grpc/scala/HelloServiceImpl.scala", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.grpc.scala\n+\n+import java.util.concurrent.{ScheduledExecutorService, TimeUnit}\n+\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import example.armeria.grpc.scala.HelloServiceImpl.{blockingContextAwareExecutionContext, contextAwareScheduler, toMessage}\n+import example.armeria.grpc.scala.hello.{HelloReply, HelloRequest, HelloServiceGrpc}\n+import io.grpc.stub.StreamObserver\n+import monix.execution\n+import monix.execution.Ack.Continue\n+import monix.execution.Scheduler\n+import monix.reactive.Observable\n+\n+import scala.collection.mutable\n+import scala.concurrent.duration._\n+import scala.concurrent.{ExecutionContext, Future, Promise}\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7c6c703bc9f8728e39edc41485e1b356a2805be"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3NDQzNTQ0OnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwMjoyNjo1M1rOGopTag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwMjoyNjo1M1rOGopTag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI3MjkzOA==", "bodyText": "rnn?", "url": "https://github.com/line/armeria/pull/2719#discussion_r445272938", "createdAt": "2020-06-25T02:26:53Z", "author": {"login": "minwoox"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -264,14 +268,34 @@ public GrpcServiceBuilder unsafeWrapRequestBuffers(boolean unsafeWrapRequestBuff\n     }\n \n     /**\n-     * Sets a {@link Consumer} that can customize the JSON marshaller used when handling JSON payloads in the\n-     * service. This is commonly used to switch from the default of using lowerCamelCase for field names to\n-     * using the field name from the proto definition, by setting\n-     * {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)}.\n+     * Sets the factory that creates a {@link GrpcJsonMarshaller} that serializes and deserializes request or\n+     * response messages to and from JSON depending on the {@link SerializationFormat}. The returned\n+     * {@link GrpcJsonMarshaller} from the factory replaces the built-in {@link GrpcJsonMarshaller}.\n+     *\n+     * <p>This is commonly used to:\n+     * <ul>\n+     *   <li>Switch from the default of using lowerCamelCase for field names to using the field name from\n+     *       the proto definition, by setting\n+     *       {@link MessageMarshaller.Builder#preservingProtoFieldNames(boolean)} via\n+     *       {@link GrpcJsonMarshallerBuilder#jsonMarshallerCustomizer(Consumer)}.\n+     *       <pre>{@code\n+     *       GrpcService.builder()\n+     *            .jsonMarshallerFactory(serviceDescriptor -> {\n+     *                return GrpcJsonMarshaller.builder()\n+     *                                         .jsonMarshallerCustomizer(builder -> {\n+     *                                             builder.preservingProtoFieldNames(true);\n+     *                                         })\n+     *                                         .build(serviceDescriptor);\n+     *            })\n+     *            .build();\n+     *       }</pre></li>\n+     *   <li>Set a customer marshaller for non-{@link Message} types such as {@code scalapb.GeneratedMessage}\n+     *       for Scala and {@code pbandk.Message} for Kotlin.</li>\n+     * </ul>\n      */\n-    public GrpcServiceBuilder jsonMarshallerCustomizer(\n-            Consumer<MessageMarshaller.Builder> jsonMarshallerCustomizer) {\n-        this.jsonMarshallerCustomizer = requireNonNull(jsonMarshallerCustomizer, \"jsonMarshallerCustomizer\");\n+    public GrpcServiceBuilder jsonMarshallerFactory(\n+            Function<? super ServiceDescriptor, ? extends GrpcJsonMarshaller> jsonMarshallerFactory) {\n+        this.jsonMarshallerFactory = jsonMarshallerFactory;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e517a423b3e3b072b8b42f589a4cace4806fbbf"}, "originalPosition": 74}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2617, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}