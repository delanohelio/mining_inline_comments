{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MzUzMTA4", "number": 2778, "title": "Fix flaky test `ServerMaxConnectionAgeTest.http1MaxConnectionAge`", "bodyText": "Motivation:\nhttps://ci.appveyor.com/project/line/armeria/builds/33334589/job/7hj0jwt7lkhavc2h#L5\nServerMaxConnectionAgeTest > http1MaxConnectionAge() FAILED\n    java.lang.AssertionError:\n    Expecting:\n      <1365L>\n    to be close to:\n      <1000L>\n    by less than 35% but difference was 36.5%.\n    (a difference of exactly 35% being considered valid)\n        at com.linecorp.armeria.server.ServerMaxConnectionAgeTest.http1MaxConnectionAge(ServerMaxConnectionAgeTest.java:132)\nModifications:\n\nMeasure the connection close time in the ConnectionPoolListener for a more accurate time.\n\nResult:\nLess Flaky \ud83d\ude4f", "createdAt": "2020-06-05T10:05:27Z", "url": "https://github.com/line/armeria/pull/2778", "merged": true, "mergeCommit": {"oid": "92069a6a109c14b897bff4295a75b21554d27e2c"}, "closed": true, "closedAt": "2020-06-05T11:21:01Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoPpUzAH2gAyNDI4MzUzMTA4OjRlNTYzZjhkYTg1OTRmYTYyYjc2YzM2YTBmZWMyZGE0YmYyYzVlNjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoQ2G3AFqTQyNTIxMjY3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4e563f8da8594fa62b76c36a0fec2da4bf2c5e63", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/4e563f8da8594fa62b76c36a0fec2da4bf2c5e63", "committedDate": "2020-06-05T09:56:46Z", "message": "Fix flaky test `ServerMaxConnectionAgeTest.http1MaxConnectionAge`\n\nMotivation:\n\nhttps://ci.appveyor.com/project/line/armeria/builds/33334589/job/7hj0jwt7lkhavc2h#L5\n```java\nServerMaxConnectionAgeTest > http1MaxConnectionAge() FAILED\n    java.lang.AssertionError:\n    Expecting:\n      <1365L>\n    to be close to:\n      <1000L>\n    by less than 35% but difference was 36.5%.\n    (a difference of exactly 35% being considered valid)\n        at com.linecorp.armeria.server.ServerMaxConnectionAgeTest.http1MaxConnectionAge(ServerMaxConnectionAgeTest.java:132)\n```\n\nModifications:\n\n- Measure the connection close time in the `ConnectionPoolListener` for a more accurate time.\n\nResult:\nLess Flaky \ud83d\ude4f"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MTY5OTc1", "url": "https://github.com/line/armeria/pull/2778#pullrequestreview-425169975", "createdAt": "2020-06-05T10:09:08Z", "commit": {"oid": "4e563f8da8594fa62b76c36a0fec2da4bf2c5e63"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MjEwMDc1", "url": "https://github.com/line/armeria/pull/2778#pullrequestreview-425210075", "createdAt": "2020-06-05T11:15:51Z", "commit": {"oid": "4e563f8da8594fa62b76c36a0fec2da4bf2c5e63"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMToxNTo1MVrOGfqdCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMToxNTo1MVrOGfqdCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTg1NDYwMg==", "bodyText": "A space before :", "url": "https://github.com/line/armeria/pull/2778#discussion_r435854602", "createdAt": "2020-06-05T11:15:51Z", "author": {"login": "trustin"}, "path": "core/src/test/java/com/linecorp/armeria/server/ServerMaxConnectionAgeTest.java", "diffHunk": "@@ -115,25 +115,48 @@ public void connectionClosed(SessionProtocol protocol, InetSocketAddress remoteA\n \n     @Test\n     void http1MaxConnectionAge() throws InterruptedException {\n-        final AtomicInteger oldClosed = new AtomicInteger();\n-        final WebClient client = newWebClient(server.uri(SessionProtocol.H1C));\n+        final Stopwatch stopwatch = Stopwatch.createUnstarted();\n+        final List<Long> elapsedTimes = new ArrayList<>();\n+        final int maxClosedConnection = 5;\n+        final ConnectionPoolListener connectionPoolListener = new ConnectionPoolListener() {\n+            @Override\n+            public void connectionOpen(SessionProtocol protocol, InetSocketAddress remoteAddr,\n+                                       InetSocketAddress localAddr, AttributeMap attrs) throws Exception {\n+                opened.incrementAndGet();\n+            }\n \n-        final Stopwatch stopwatch = Stopwatch.createStarted();\n-        while (closed.get() < 5) {\n-            final AggregatedHttpResponse agg = client.get(\"/\").aggregate().join();\n-            assertThat(agg.status()).isEqualTo(OK);\n+            @Override\n+            public void connectionClosed(SessionProtocol protocol, InetSocketAddress remoteAddr,\n+                                         InetSocketAddress localAddr, AttributeMap attrs) throws Exception {\n+                final int numClosed = closed.incrementAndGet();\n+                if (numClosed == 1) {\n+                    stopwatch.start();\n+                } else if (numClosed <= maxClosedConnection) {\n+                    elapsedTimes.add(stopwatch.elapsed().toMillis());\n+                    stopwatch.reset().start();\n+                }\n+            }\n+        };\n \n+        final ClientFactory clientFactory = ClientFactory.builder()\n+                                                         .connectionPoolListener(connectionPoolListener)\n+                                                         .idleTimeoutMillis(0)\n+                                                         .build();\n+        final WebClient client = WebClient.builder(server.uri(SessionProtocol.H1C))\n+                                          .factory(clientFactory)\n+                                          .responseTimeoutMillis(0)\n+                                          .build();\n+\n+        while (closed.get() < maxClosedConnection) {\n+            assertThat(client.get(\"/\").aggregate().join().status()).isEqualTo(OK);\n             final int closed = this.closed.get();\n             assertThat(opened).hasValueBetween(closed, closed + 1);\n+        }\n \n-            // When a connection is disconnected, check the time from the previous disconnection.\n-            if (this.closed.get() > oldClosed.get()) {\n-                assertThat(stopwatch.elapsed().toMillis())\n-                        .isCloseTo(MAX_CONNECTION_AGE, withinPercentage(35));\n-                oldClosed.set(this.closed.get());\n-                stopwatch.reset().start();\n-            }\n+        for (long elapsed: elapsedTimes) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e563f8da8594fa62b76c36a0fec2da4bf2c5e63"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cde2d39ae8110292bc82dcfecacc4cc86cf5315", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/5cde2d39ae8110292bc82dcfecacc4cc86cf5315", "committedDate": "2020-06-05T11:20:32Z", "message": "Update ServerMaxConnectionAgeTest.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MjEyNjc0", "url": "https://github.com/line/armeria/pull/2778#pullrequestreview-425212674", "createdAt": "2020-06-05T11:20:38Z", "commit": {"oid": "5cde2d39ae8110292bc82dcfecacc4cc86cf5315"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 175, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}