{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5MjUwNDA0", "number": 3001, "title": "Upgrade gRPC-Kotlin to 0.1.5", "bodyText": "Motivation:\nCoroutineContextServerInterceptor is newly introduced in gRPC-Kotlin 0.1.5.\nArmeria gRPC server can inject the current RequestContext to Coroutine Context using it.\nThe issue that inHalfClose unexpectly calls ServerCall.close() seems resolved by grpc/grpc-kotlin#157.\nI cannot reproduce it anymore.\nModifications:\n\nAdd ArmeriaCoroutineContextInterceptor that is working only for gRPC-Kotlin stub.\nRemove inHalfClose flag in ArmeriaServerCall\n\nResults:\n\nYou can now get the current RequestContext from the Coroutine Context of gRPC-Kotlin by default.", "createdAt": "2020-08-18T07:02:25Z", "url": "https://github.com/line/armeria/pull/3001", "merged": true, "mergeCommit": {"oid": "8a1281f1d2b827f516247b8f9eb6210f2a047efa"}, "closed": true, "closedAt": "2020-08-19T13:01:41Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdABfE2gH2gAyNDY5MjUwNDA0OjVmMmU4ZmYzOTI3NWY5Zjg4MGE1YTdiNzBkMGU3OTc2YjVhYWI4ZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAR2MegH2gAyNDY5MjUwNDA0Ojc0NmZhZDI4N2U1YmJkNjJkYmVlOGIyYjNmODNmMjc4YTgzZTQ5ZWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5f2e8ff39275f9f880a5a7b70d0e7976b5aab8f6", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/5f2e8ff39275f9f880a5a7b70d0e7976b5aab8f6", "committedDate": "2020-08-18T07:01:05Z", "message": "Upgrade gRPC-Kotlin to 0.1.5\n\nMotivation:\n\n`CoroutineContextServerInterceptor` is newly introduced in gRPC-Kotlin [0.1.5](https://github.com/grpc/grpc-kotlin/releases/tag/v0.1.5).\nArmeria gRPC server can inject the current `RequestContext` to Coroutine Context using it.\n\nThe issue that `inHalfClose` unexpectly calls `ServerCall.close()` seems resolved by https://github.com/grpc/grpc-kotlin/pull/157.\nI cannot reproduce it anymore.\n\nModifications:\n\n- Add `ArmeriaCoroutineContextInterceptor` that is working only for gRPC-Kotlin stub.\n- Remove `inHalfClose` flag in ArmeriaServerCall\n\nResults:\n\n- You can now get the current `RequestContext` from the Coroutine Context of gRPC-Kotlin by default."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "751bc8b04217a556e85e8117aec59e3c39a9e26f", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/751bc8b04217a556e85e8117aec59e3c39a9e26f", "committedDate": "2020-08-18T07:08:15Z", "message": "Remove TODO"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d36dff45059cd285caa0680d86cbf2ff2492d2f", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/2d36dff45059cd285caa0680d86cbf2ff2492d2f", "committedDate": "2020-08-18T09:26:29Z", "message": "Address comments by @okue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MTYzNzIw", "url": "https://github.com/line/armeria/pull/3001#pullrequestreview-469163720", "createdAt": "2020-08-18T09:44:25Z", "commit": {"oid": "2d36dff45059cd285caa0680d86cbf2ff2492d2f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwOTo0NDoyNVrOHCL17w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwOTo0NDoyNVrOHCL17w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1MzIzMQ==", "bodyText": "nit: We can make this as final\nprivate static final boolean USE_COROUTINE_CONTEXT_INTERCEPTOR;\n\nstatic {\n    boolean useCoroutineContextInterceptor = false;\n    try {\n        Class.forName(\"io.grpc.kotlin.CoroutineContextServerInterceptor\", false,\n                      GrpcServiceBuilder.class.getClassLoader());\n        useCoroutineContextInterceptor = true;\n    } catch (Throwable ignored) {\n    }\n    USE_COROUTINE_CONTEXT_INTERCEPTOR = useCoroutineContextInterceptor;\n}", "url": "https://github.com/line/armeria/pull/3001#discussion_r472053231", "createdAt": "2020-08-18T09:44:25Z", "author": {"login": "minwoox"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -67,6 +68,18 @@\n     private static final Set<SerializationFormat> DEFAULT_SUPPORTED_SERIALIZATION_FORMATS =\n             GrpcSerializationFormats.values();\n \n+    private static boolean useCoroutineContextInterceptor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d36dff45059cd285caa0680d86cbf2ff2492d2f"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4d7378524e43a4b601152fa1f5b8c327d5c8e7b", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/d4d7378524e43a4b601152fa1f5b8c327d5c8e7b", "committedDate": "2020-08-18T10:01:08Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e02557cbeed4b65bfd55bcdbf9f56e198fc77dd5", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/e02557cbeed4b65bfd55bcdbf9f56e198fc77dd5", "committedDate": "2020-08-18T10:03:20Z", "message": "Use final"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NTMxNzM4", "url": "https://github.com/line/armeria/pull/3001#pullrequestreview-469531738", "createdAt": "2020-08-18T14:48:13Z", "commit": {"oid": "e02557cbeed4b65bfd55bcdbf9f56e198fc77dd5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NTQyMzY5", "url": "https://github.com/line/armeria/pull/3001#pullrequestreview-469542369", "createdAt": "2020-08-18T14:58:35Z", "commit": {"oid": "e02557cbeed4b65bfd55bcdbf9f56e198fc77dd5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDo1ODozNVrOHCYqhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNDo1ODozNVrOHCYqhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjI2MzMwMg==", "bodyText": "How about logging whether coroutine context interceptor is available? e.g.\nlogger.debug(\"{}: {}\", className, useCoroutineContextInterceptor ? \"available\" : \"unavailable\");", "url": "https://github.com/line/armeria/pull/3001#discussion_r472263302", "createdAt": "2020-08-18T14:58:35Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -67,6 +68,20 @@\n     private static final Set<SerializationFormat> DEFAULT_SUPPORTED_SERIALIZATION_FORMATS =\n             GrpcSerializationFormats.values();\n \n+    private static final boolean USE_COROUTINE_CONTEXT_INTERCEPTOR;\n+\n+    static {\n+        boolean useCoroutineContextInterceptor;\n+        try {\n+            Class.forName(\"io.grpc.kotlin.CoroutineContextServerInterceptor\", false,\n+                          GrpcServiceBuilder.class.getClassLoader());\n+            useCoroutineContextInterceptor = true;\n+        } catch (Throwable ignored) {\n+            useCoroutineContextInterceptor = false;\n+        }\n+        USE_COROUTINE_CONTEXT_INTERCEPTOR = useCoroutineContextInterceptor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e02557cbeed4b65bfd55bcdbf9f56e198fc77dd5"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "746fad287e5bbd62dbee8b2b3f83f278a83e49ea", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/746fad287e5bbd62dbee8b2b3f83f278a83e49ea", "committedDate": "2020-08-19T02:04:49Z", "message": "Address comments by @trustin"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 77, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}