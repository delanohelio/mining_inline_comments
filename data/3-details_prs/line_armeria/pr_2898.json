{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MjEzNTg3", "number": 2898, "title": "Decorate all services with MetricCollectingService when integrates with Spring Boot", "bodyText": "Fixes #2873", "createdAt": "2020-07-15T02:58:46Z", "url": "https://github.com/line/armeria/pull/2898", "merged": true, "mergeCommit": {"oid": "8abaadcaeaf62ed8faea5251eea982f917cbaab8"}, "closed": true, "closedAt": "2020-07-21T06:15:49Z", "author": {"login": "imasahiro"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1CIqAAH2gAyNDQ5MjEzNTg3OjZkY2M5MzVlYTQ3MDVhYzM4YTVkYjU4ZWMyOTEyMjk3YzZmZjZjOGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc26_4sAH2gAyNDQ5MjEzNTg3OjBjZDIyNGY4M2ViMjdjZmRkMzIzOTM0NjE5ZTIyZTJlOThiYmMwM2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "committedDate": "2020-07-15T03:33:20Z", "message": "Attach missing MetricCollectingService decorator globally if ArmeriaSettings.enableMetrics is true"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2443ff4a2696398854ccaa91deeecb8a2803749b", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/2443ff4a2696398854ccaa91deeecb8a2803749b", "committedDate": "2020-07-15T02:56:13Z", "message": "Attach missing MetricCollectingService decorator globally if ArmeriaSettings.enableMetrics is true"}, "afterCommit": {"oid": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "committedDate": "2020-07-15T03:33:20Z", "message": "Attach missing MetricCollectingService decorator globally if ArmeriaSettings.enableMetrics is true"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NjM3Njc3", "url": "https://github.com/line/armeria/pull/2898#pullrequestreview-448637677", "createdAt": "2020-07-15T05:25:12Z", "commit": {"oid": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNToyNToxM1rOGxuxgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNToyNToxM1rOGxuxgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc5OTc0Nw==", "bodyText": "You don't need to set service tag. :-)\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java\n    \n    \n        Lines 108 to 111\n      in\n      7f3295f\n    \n    \n    \n    \n\n        \n          \n           final String serviceName = log.serviceName(); \n        \n\n        \n          \n           if (serviceName != null) { \n        \n\n        \n          \n               tagListBuilder.add(Tag.of(\"service\", serviceName)); \n        \n\n        \n          \n           }", "url": "https://github.com/line/armeria/pull/2898#discussion_r454799747", "createdAt": "2020-07-15T05:25:13Z", "author": {"login": "ikhoon"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "diffHunk": "@@ -147,6 +148,11 @@ public static void configureServerWithArmeriaSettings(ServerBuilder server, Arme\n                     DropwizardSupport.addExposition(settings, server, meterRegistry);\n                 }\n             }\n+\n+            server.decorator(MetricCollectingService.newDecorator(\n+                    MeterIdPrefixFunction.ofDefault(\"armeria.server\")\n+                                         .andThen((registry, log, meterIdPrefix) -> meterIdPrefix.withTags(\n+                                                 \"service\", log.serviceName()))));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "503584210c8534bf614e7ab41c33c7eb167e8107", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/503584210c8534bf614e7ab41c33c7eb167e8107", "committedDate": "2020-07-15T06:08:41Z", "message": "Remove `service` tag"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NTE3MDMx", "url": "https://github.com/line/armeria/pull/2898#pullrequestreview-449517031", "createdAt": "2020-07-16T05:30:04Z", "commit": {"oid": "503584210c8534bf614e7ab41c33c7eb167e8107"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5NTIyNDM5", "url": "https://github.com/line/armeria/pull/2898#pullrequestreview-449522439", "createdAt": "2020-07-16T05:46:17Z", "commit": {"oid": "503584210c8534bf614e7ab41c33c7eb167e8107"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14eaf4e977bf9e22e5b20deb8ed6e954f5191b59", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/14eaf4e977bf9e22e5b20deb8ed6e954f5191b59", "committedDate": "2020-07-16T12:01:06Z", "message": "Remove setupMetricCollectingService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a6d0f4f70a45e863081fa501ac77b3dbf13a34a", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/4a6d0f4f70a45e863081fa501ac77b3dbf13a34a", "committedDate": "2020-07-20T09:40:35Z", "message": "Remove MeterIdPrefixFUnctionFactory from Server bean dependency graph"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNDU0MDAz", "url": "https://github.com/line/armeria/pull/2898#pullrequestreview-451454003", "createdAt": "2020-07-20T09:43:12Z", "commit": {"oid": "4a6d0f4f70a45e863081fa501ac77b3dbf13a34a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwOTo0MzoxMlrOG0DDkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQwOTo0MzoxMlrOG0DDkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIyOTIwMw==", "bodyText": "Could you remove this method?", "url": "https://github.com/line/armeria/pull/2898#discussion_r457229203", "createdAt": "2020-07-20T09:43:12Z", "author": {"login": "minwoox"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "diffHunk": "@@ -336,18 +328,6 @@ public static void configureAnnotatedServices(\n         }\n     }\n \n-    private static HttpService setupMetricCollectingService(\n-            HttpService service, AbstractServiceRegistrationBean<?, ?, ?, ?> bean,\n-            @Nullable MeterIdPrefixFunctionFactory meterIdPrefixFunctionFactory) {\n-        requireNonNull(service, \"service\");\n-        requireNonNull(bean, \"bean\");\n-\n-        if (meterIdPrefixFunctionFactory == null) {\n-            return service;\n-        }\n-        return service.decorate(metricCollectingServiceDecorator(bean, meterIdPrefixFunctionFactory));\n-    }\n-\n     private static Function<? super HttpService, MetricCollectingService> metricCollectingServiceDecorator(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a6d0f4f70a45e863081fa501ac77b3dbf13a34a"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNDU1MjM3", "url": "https://github.com/line/armeria/pull/2898#pullrequestreview-451455237", "createdAt": "2020-07-20T09:44:57Z", "commit": {"oid": "4a6d0f4f70a45e863081fa501ac77b3dbf13a34a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fff23a0caaf80ef658ebb132b24e6731e4034cd", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/9fff23a0caaf80ef658ebb132b24e6731e4034cd", "committedDate": "2020-07-20T09:45:01Z", "message": "more cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cd224f83eb27cfdd323934619e22e2e98bbc03b", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/0cd224f83eb27cfdd323934619e22e2e98bbc03b", "committedDate": "2020-07-21T00:22:16Z", "message": "cleanup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4904, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}