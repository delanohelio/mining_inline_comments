{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyOTU3MjQ1", "number": 2398, "title": "Don't fail to start server when version info can't be found.", "bodyText": "I had a report of this stack trace\nException in thread \"main\" java.lang.NullPointerException\n    at com.linecorp.armeria.server.Server.setupVersionMetrics(Server.java:319)\n    at com.linecorp.armeria.server.Server.<init>(Server.java:128)\n    at com.linecorp.armeria.server.ServerBuilder.build(ServerBuilder.java:1543)\n\nCurrently we always export version information into the meter registry based on a classpath resource. While the resource should almost always be present, it's conceivable that some scenario will not have the files (old fat jar methods are notorious for only having one copy of service files in the jar) and the server should still start up.\nI also modified\n\nCache property loading\nReturn immutable map", "createdAt": "2020-01-15T04:59:01Z", "url": "https://github.com/line/armeria/pull/2398", "merged": true, "mergeCommit": {"oid": "20ab637380d903d85ca5537afcb952c79342d371"}, "closed": true, "closedAt": "2020-01-16T03:01:26Z", "author": {"login": "anuraaga"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6eRJWgH2gAyMzYyOTU3MjQ1OjA3NjE0NDFjMmVhZWVjNmMwZDQ1M2NjZDA0ZWY1Y2MxNTU2MTlmNmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6xLq_AFqTM0MzY0OTQ3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0761441c2eaeec6c0d453ccd04ef5cc155619f6d", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/0761441c2eaeec6c0d453ccd04ef5cc155619f6d", "committedDate": "2020-01-15T04:58:25Z", "message": "Don't fail to start server when version info can't be found."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMDAzNzEx", "url": "https://github.com/line/armeria/pull/2398#pullrequestreview-343003711", "createdAt": "2020-01-15T06:07:49Z", "commit": {"oid": "0761441c2eaeec6c0d453ccd04ef5cc155619f6d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwNjowNzo0OVrOFduGjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwNjowNzo0OVrOFduGjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwODM2Ng==", "bodyText": "jar -> JAR?", "url": "https://github.com/line/armeria/pull/2398#discussion_r366708366", "createdAt": "2020-01-15T06:07:49Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/Version.java", "diffHunk": "@@ -89,61 +99,76 @@\n     public static Map<String, Version> identify(ClassLoader classLoader) {\n         requireNonNull(classLoader, \"classLoader\");\n \n-        // Collect all properties.\n-        final Properties props = new Properties();\n-        try {\n-            final Enumeration<URL> resources = classLoader.getResources(PROP_RESOURCE_PATH);\n-            while (resources.hasMoreElements()) {\n-                final URL url = resources.nextElement();\n-                final InputStream in = url.openStream();\n-                try {\n-                    props.load(in);\n-                } finally {\n-                    Closeables.closeQuietly(in);\n+        return VERSIONS.computeIfAbsent(classLoader, cl -> {\n+            boolean foundProperties = false;\n+\n+            // Collect all properties.\n+            final Properties props = new Properties();\n+            try {\n+                final Enumeration<URL> resources = cl.getResources(PROP_RESOURCE_PATH);\n+                while (resources.hasMoreElements()) {\n+                    foundProperties = true;\n+                    final URL url = resources.nextElement();\n+                    final InputStream in = url.openStream();\n+                    try {\n+                        props.load(in);\n+                    } finally {\n+                        Closeables.closeQuietly(in);\n+                    }\n                 }\n+            } catch (Exception ignore) {\n+                // Not critical. Just ignore.\n             }\n-        } catch (Exception ignore) {\n-            // Not critical. Just ignore.\n-        }\n \n-        // Collect all artifactIds.\n-        final Set<String> artifactIds = new HashSet<>();\n-        for (Object o: props.keySet()) {\n-            final String k = (String) o;\n-\n-            final int dotIndex = k.indexOf('.');\n-            if (dotIndex <= 0) {\n-                continue;\n+            if (!foundProperties) {\n+                logger.info(\n+                        \"Could not find any property files at \" +\n+                        \"META-INF/com.linecorp.armeria.versions.properties. \" +\n+                        \"This usually indicates an issue with your application packaging, for example using \" +\n+                        \"a fat-jar method that only keeps one copy of any file. For maximum functionality, \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0761441c2eaeec6c0d453ccd04ef5cc155619f6d"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMDAzOTE3", "url": "https://github.com/line/armeria/pull/2398#pullrequestreview-343003917", "createdAt": "2020-01-15T06:08:37Z", "commit": {"oid": "0761441c2eaeec6c0d453ccd04ef5cc155619f6d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwNjowODozN1rOFduHTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwNjowODozN1rOFduHTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwODU1Ng==", "bodyText": "Should we fall back to the values like UNKNOWN?", "url": "https://github.com/line/armeria/pull/2398#discussion_r366708556", "createdAt": "2020-01-15T06:08:37Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/Server.java", "diffHunk": "@@ -317,21 +317,23 @@ public int numConnections() {\n     @VisibleForTesting\n     void setupVersionMetrics() {\n         final MeterRegistry meterRegistry = config().meterRegistry();\n-        final Map<String, Version> map = Version.identify(getClass().getClassLoader());\n+        final Map<String, Version> map = Version.identify(Server.class.getClassLoader());\n         final Version versionInfo = map.get(\"armeria\");\n-        final String version = versionInfo.artifactVersion();\n-        final String commit = versionInfo.longCommitHash();\n-        final String repositoryStatus = versionInfo.repositoryStatus();\n-        final List<Tag> tags = ImmutableList.of(Tag.of(\"version\", version),\n-                                                Tag.of(\"commit\", commit),\n-                                                Tag.of(Flags.useLegacyMeterNames() ? \"repoStatus\"\n-                                                                                   : \"repo.status\",\n-                                                       repositoryStatus));\n-        Gauge.builder(\"armeria.build.info\", () -> 1)\n-             .tags(tags)\n-             .description(\"A metric with a constant '1' value labeled by version and commit hash\" +\n-                          \" from which Armeria was built.\")\n-             .register(meterRegistry);\n+        if (versionInfo != null) {\n+            final String version = versionInfo.artifactVersion();\n+            final String commit = versionInfo.longCommitHash();\n+            final String repositoryStatus = versionInfo.repositoryStatus();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0761441c2eaeec6c0d453ccd04ef5cc155619f6d"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMDAzOTgw", "url": "https://github.com/line/armeria/pull/2398#pullrequestreview-343003980", "createdAt": "2020-01-15T06:08:54Z", "commit": {"oid": "0761441c2eaeec6c0d453ccd04ef5cc155619f6d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMDA5MzU1", "url": "https://github.com/line/armeria/pull/2398#pullrequestreview-343009355", "createdAt": "2020-01-15T06:30:11Z", "commit": {"oid": "0761441c2eaeec6c0d453ccd04ef5cc155619f6d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwNjozMDoxMVrOFduYEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwNjozMDoxMVrOFduYEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcxMjg0OA==", "bodyText": "nit: space between o:", "url": "https://github.com/line/armeria/pull/2398#discussion_r366712848", "createdAt": "2020-01-15T06:30:11Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/Version.java", "diffHunk": "@@ -89,61 +99,76 @@\n     public static Map<String, Version> identify(ClassLoader classLoader) {\n         requireNonNull(classLoader, \"classLoader\");\n \n-        // Collect all properties.\n-        final Properties props = new Properties();\n-        try {\n-            final Enumeration<URL> resources = classLoader.getResources(PROP_RESOURCE_PATH);\n-            while (resources.hasMoreElements()) {\n-                final URL url = resources.nextElement();\n-                final InputStream in = url.openStream();\n-                try {\n-                    props.load(in);\n-                } finally {\n-                    Closeables.closeQuietly(in);\n+        return VERSIONS.computeIfAbsent(classLoader, cl -> {\n+            boolean foundProperties = false;\n+\n+            // Collect all properties.\n+            final Properties props = new Properties();\n+            try {\n+                final Enumeration<URL> resources = cl.getResources(PROP_RESOURCE_PATH);\n+                while (resources.hasMoreElements()) {\n+                    foundProperties = true;\n+                    final URL url = resources.nextElement();\n+                    final InputStream in = url.openStream();\n+                    try {\n+                        props.load(in);\n+                    } finally {\n+                        Closeables.closeQuietly(in);\n+                    }\n                 }\n+            } catch (Exception ignore) {\n+                // Not critical. Just ignore.\n             }\n-        } catch (Exception ignore) {\n-            // Not critical. Just ignore.\n-        }\n \n-        // Collect all artifactIds.\n-        final Set<String> artifactIds = new HashSet<>();\n-        for (Object o: props.keySet()) {\n-            final String k = (String) o;\n-\n-            final int dotIndex = k.indexOf('.');\n-            if (dotIndex <= 0) {\n-                continue;\n+            if (!foundProperties) {\n+                logger.info(\n+                        \"Could not find any property files at \" +\n+                        \"META-INF/com.linecorp.armeria.versions.properties. \" +\n+                        \"This usually indicates an issue with your application packaging, for example using \" +\n+                        \"a fat-jar method that only keeps one copy of any file. For maximum functionality, \" +\n+                        \"it is recommended to fix your packaging to include these files.\");\n+                return ImmutableMap.of();\n             }\n \n-            final String artifactId = k.substring(0, dotIndex);\n+            // Collect all artifactIds.\n+            final Set<String> artifactIds = new HashSet<>();\n+            for (Object o: props.keySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0761441c2eaeec6c0d453ccd04ef5cc155619f6d"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcd094d15a26baf9732a2f0e815336fe4334bb1a", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/fcd094d15a26baf9732a2f0e815336fe4334bb1a", "committedDate": "2020-01-15T09:17:25Z", "message": "Add method to return default when not found."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15ba002a86c44da6e34db46a57da753bf0a1e0c5", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/15ba002a86c44da6e34db46a57da753bf0a1e0c5", "committedDate": "2020-01-15T09:18:31Z", "message": "Cleanups"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMDg0OTg4", "url": "https://github.com/line/armeria/pull/2398#pullrequestreview-343084988", "createdAt": "2020-01-15T09:31:18Z", "commit": {"oid": "15ba002a86c44da6e34db46a57da753bf0a1e0c5"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwOTozMToxOFrOFdx_MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwOTozMjowMFrOFdyAYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njc3MjAxNw==", "bodyText": "nit: make it singleton?", "url": "https://github.com/line/armeria/pull/2398#discussion_r366772017", "createdAt": "2020-01-15T09:31:18Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/Version.java", "diffHunk": "@@ -71,6 +78,36 @@\n     private static final String PROP_LONG_COMMIT_HASH = \".longCommitHash\";\n     private static final String PROP_REPO_STATUS = \".repoStatus\";\n \n+    private static final Map<ClassLoader, Map<String, Version>> VERSIONS =\n+            new MapMaker().weakKeys().makeMap();\n+\n+    /**\n+     * Returns the version information for the Armeria artifact named {@code artifactId}. If information for\n+     * the artifact can't be found, a default value is returned with arbitrary {@code unknown} values.\n+     */\n+    public static Version get(String artifactId) {\n+        return get(artifactId, Version.class.getClassLoader());\n+    }\n+\n+    /**\n+     * Returns the version information for the Armeria artifact named {@code artifactId} using the specified\n+     * {@link ClassLoader}. If information for the artifact can't be found, a default value is returned\n+     * with arbitrary {@code unknown} values.\n+     */\n+    public static Version get(String artifactId, ClassLoader classLoader) {\n+        final Version version = identify(classLoader).get(artifactId);\n+        if (version != null) {\n+            return version;\n+        }\n+        return new Version(\n+                artifactId,\n+                \"unknown\",\n+                0,\n+                \"unknown\",\n+                \"unknown\",\n+                \"unknown\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15ba002a86c44da6e34db46a57da753bf0a1e0c5"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njc3MjMyMQ==", "bodyText": "Nice! \ud83d\udc4d", "url": "https://github.com/line/armeria/pull/2398#discussion_r366772321", "createdAt": "2020-01-15T09:32:00Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/Version.java", "diffHunk": "@@ -71,6 +78,36 @@\n     private static final String PROP_LONG_COMMIT_HASH = \".longCommitHash\";\n     private static final String PROP_REPO_STATUS = \".repoStatus\";\n \n+    private static final Map<ClassLoader, Map<String, Version>> VERSIONS =\n+            new MapMaker().weakKeys().makeMap();\n+\n+    /**\n+     * Returns the version information for the Armeria artifact named {@code artifactId}. If information for\n+     * the artifact can't be found, a default value is returned with arbitrary {@code unknown} values.\n+     */\n+    public static Version get(String artifactId) {\n+        return get(artifactId, Version.class.getClassLoader());\n+    }\n+\n+    /**\n+     * Returns the version information for the Armeria artifact named {@code artifactId} using the specified\n+     * {@link ClassLoader}. If information for the artifact can't be found, a default value is returned\n+     * with arbitrary {@code unknown} values.\n+     */\n+    public static Version get(String artifactId, ClassLoader classLoader) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15ba002a86c44da6e34db46a57da753bf0a1e0c5"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c69b9eb823dc3490fe8d878adcbb5c03c9869bf1", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/c69b9eb823dc3490fe8d878adcbb5c03c9869bf1", "committedDate": "2020-01-15T09:49:31Z", "message": "identify -> getAll"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjQ5NDcx", "url": "https://github.com/line/armeria/pull/2398#pullrequestreview-343649471", "createdAt": "2020-01-16T03:00:38Z", "commit": {"oid": "c69b9eb823dc3490fe8d878adcbb5c03c9869bf1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 858, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}