{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NjAzMjg2", "number": 2571, "title": "Revamp `RequestContext.set{Request,Response}Timeout()`", "bodyText": "\u2026ions.\nMotivation:\nThe new timeout API was introduced in Armeria 0.98.0 and set*Timeout{Millis} has been deprecated. #2343\nHowever, we got some internal inquiries about how to replace the setTimeout{Millis}.\nIt is hard to implement with the existing API.\nOn the other hand, some of the users are confused about the new timeout API.\nSee #2535 for the detail discussion.\nI think we need to clean and revamp the timeout API before 1.0\nModifications:\n\nUndeprecate set*Timeout{Millis}\nDeprecate set*TimeoutAt{Millis} without a replacement\nDeprecate set*TimeoutAfter{Millis} in favor of setTimeout{Millis}(TimeoutMode.FROM_NOW, ...)\nDeprecate extend*Timeout{Millis} in favor of setTimeout{Millis}(TimeoutMode.EXTEND, ...)\nAdd TimeoutMode enum\nMigrate deprecated API\nUse default method to deduplicate code\n\nResult:\n\nset*Timeout{Millis} is revived.\nYou can now schedule a timeout with TimeoutMode.\nFixes #2535", "createdAt": "2020-03-11T10:26:36Z", "url": "https://github.com/line/armeria/pull/2571", "merged": true, "mergeCommit": {"oid": "46eff82ddbf52af751fb31debc2273638ae6a5f9"}, "closed": true, "closedAt": "2020-03-18T02:03:37Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMj_y-AH2gAyMzg2NjAzMjg2OjM1YjY0NzgxN2VmZGUyNmZkYzE4NWMxMmZkYzQzZjJiZTY2YmRlN2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOtSGNgH2gAyMzg2NjAzMjg2Ojk5YTI3YjQ4NWRiOTFkNzY3NjgxZGM4ZTcwNzIwZjc5OThjNTk4YjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "35b647817efde26fdc185c12fdc43f2be66bde7c", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/35b647817efde26fdc185c12fdc43f2be66bde7c", "committedDate": "2020-03-11T09:49:32Z", "message": "Revamp `set{Request,Response}Timeout()` in RequestContext implementations.\n\nMotivation:\n\nWe were introduced the new timeout API in Armeria 0.98.0 and `set*Timeout{Millis}` has been deprecated.\nHowever, we got some internal inquiries about how to replace the setTimeout{Millis}.\nIt is hard to implement with the existing API.\nOn the other hand, some of the users are confused about the new timeout API.\nSee #2343 for detail discussion.\nI think we need to clean and revamp the timeout API before 1.0\n\nModifications:\n\n- Undeprecate `set*Timeout{Millis}`\n- Deprecate `set*TimeoutAt{Millis}` without a replacement\n- Deprecate `set*TimeoutAfter{Millis}` in favor of `setTimeout{Millis}(TimeoutMode.FROM_NOW, ...)\n- Deprecate `extend*Timeout{Millis}` in favor of `setTimeout{Millis}(TimeoutMode.EXTEND, ...)\n- Add TimeoutMode enum\n- Migrate deprecated API\n- Use default method to deduplicate code\n\nResult:\n\n- `set*Timeout{Millis}` is revived.\n- You can now schedule a timeout with `TimeoutMode`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "783d9c98b36d7f80b86903589c73a604f8dc4f1a", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/783d9c98b36d7f80b86903589c73a604f8dc4f1a", "committedDate": "2020-03-12T03:30:23Z", "message": "Change timeout tolerance to 100"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjg5NjIz", "url": "https://github.com/line/armeria/pull/2571#pullrequestreview-373289623", "createdAt": "2020-03-12T05:39:26Z", "commit": {"oid": "783d9c98b36d7f80b86903589c73a604f8dc4f1a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTozOToyNlrOF1Rz_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwNTozOToyNlrOF1Rz_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMDY4Nw==", "bodyText": "Any thoughts on my comment here?\n#2535 (comment)\nIt prevents having adjective (from) and verb (extend) in the same enum which looks weird.", "url": "https://github.com/line/armeria/pull/2571#discussion_r391410687", "createdAt": "2020-03-12T05:39:26Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/TimeoutMode.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.util;\n+\n+import com.linecorp.armeria.common.Request;\n+\n+/**\n+ * The timeout mode.\n+ */\n+public enum TimeoutMode {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "783d9c98b36d7f80b86903589c73a604f8dc4f1a"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNDYyMjM2", "url": "https://github.com/line/armeria/pull/2571#pullrequestreview-373462236", "createdAt": "2020-03-12T11:07:29Z", "commit": {"oid": "783d9c98b36d7f80b86903589c73a604f8dc4f1a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMTowNzozMFrOF1aNcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMToxMjoyOFrOF1aXGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU0ODI3NQ==", "bodyText": "Perhaps the sensible default would be TimeoutMode.FROM_NOW?", "url": "https://github.com/line/armeria/pull/2571#discussion_r391548275", "createdAt": "2020-03-12T11:07:30Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientRequestContext.java", "diffHunk": "@@ -444,17 +485,57 @@ ClientRequestContext newDerivedContext(RequestId id, @Nullable HttpRequest req,\n      * @param responseTimeoutMillis the amount of time allowed in milliseconds from\n      *                              the beginning of the response\n      *\n-     * @deprecated Use {@link #extendResponseTimeoutMillis(long)}, {@link #setResponseTimeoutAfterMillis(long)},\n-     *             {@link #setResponseTimeoutAtMillis(long)} or {@link #clearResponseTimeout()}\n      */\n-    @Deprecated\n-    void setResponseTimeoutMillis(long responseTimeoutMillis);\n+    default void setResponseTimeoutMillis(long responseTimeoutMillis) {\n+        setResponseTimeoutMillis(TimeoutMode.FROM_START, responseTimeoutMillis);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "783d9c98b36d7f80b86903589c73a604f8dc4f1a"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1MDU2MA==", "bodyText": "How about FROM_OLD_TIMEOUT or FROM_PREV_TIMEOUT instead of EXTEND then? Or we could make the two verbs, like SET_FROM_NOW and SET_FROM_START. I think the latter sounds better.", "url": "https://github.com/line/armeria/pull/2571#discussion_r391550560", "createdAt": "2020-03-12T11:12:04Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/TimeoutMode.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.util;\n+\n+import com.linecorp.armeria.common.Request;\n+\n+/**\n+ * The timeout mode.\n+ */\n+public enum TimeoutMode {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQxMDY4Nw=="}, "originalCommit": {"oid": "783d9c98b36d7f80b86903589c73a604f8dc4f1a"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1MDc0Nw==", "bodyText": "Could use switch-case", "url": "https://github.com/line/armeria/pull/2571#discussion_r391550747", "createdAt": "2020-03-12T11:12:28Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/common/TimeoutScheduler.java", "diffHunk": "@@ -61,6 +66,16 @@ public void clearTimeout() {\n         }\n     }\n \n+    public void setTimeoutMillis(TimeoutMode mode, long timeoutMillis) {\n+        if (mode == FROM_NOW) {\n+            setTimeoutAfterMillis(timeoutMillis);\n+        } else if (mode == FROM_START) {\n+            setTimeoutMillis(timeoutMillis);\n+        } else if (mode == EXTEND) {\n+            extendTimeoutMillis(timeoutMillis);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "783d9c98b36d7f80b86903589c73a604f8dc4f1a"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6de3a0c8f26fadcefdd8e9b583b59c201a604964", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/6de3a0c8f26fadcefdd8e9b583b59c201a604964", "committedDate": "2020-03-12T11:46:36Z", "message": "Address comment by @trustin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2608fe1388912d923d1dbea754266c71de90b9e", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/a2608fe1388912d923d1dbea754266c71de90b9e", "committedDate": "2020-03-13T04:11:25Z", "message": "Address comments by @trustin / use switch case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83a4fdae315c0ba93609f6d17539a0dd5881d744", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/83a4fdae315c0ba93609f6d17539a0dd5881d744", "committedDate": "2020-03-13T04:13:04Z", "message": "Merge branch 'master' into revamp-settimeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5f2c5ae807424d5c0e67fbbc4e6e3269fc5fab8", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/b5f2c5ae807424d5c0e67fbbc4e6e3269fc5fab8", "committedDate": "2020-03-13T06:42:38Z", "message": "Change enum name and fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NzYxNzYy", "url": "https://github.com/line/armeria/pull/2571#pullrequestreview-375761762", "createdAt": "2020-03-17T06:11:31Z", "commit": {"oid": "b5f2c5ae807424d5c0e67fbbc4e6e3269fc5fab8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1NzYyOTgz", "url": "https://github.com/line/armeria/pull/2571#pullrequestreview-375762983", "createdAt": "2020-03-17T06:15:10Z", "commit": {"oid": "b5f2c5ae807424d5c0e67fbbc4e6e3269fc5fab8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "162a58bed6d1fb4ed6c37290ef736e102a31cd01", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/162a58bed6d1fb4ed6c37290ef736e102a31cd01", "committedDate": "2020-03-17T06:22:51Z", "message": "Merge branch 'master' into revamp-settimeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTA0NTQ4", "url": "https://github.com/line/armeria/pull/2571#pullrequestreview-376504548", "createdAt": "2020-03-18T01:16:05Z", "commit": {"oid": "162a58bed6d1fb4ed6c37290ef736e102a31cd01"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToxNjowNVrOF3zQ5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMToxNzoyMlrOF3zR7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NTkwOQ==", "bodyText": "this could be private", "url": "https://github.com/line/armeria/pull/2571#discussion_r394055909", "createdAt": "2020-03-18T01:16:05Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/internal/common/TimeoutScheduler.java", "diffHunk": "@@ -61,6 +63,20 @@ public void clearTimeout() {\n         }\n     }\n \n+    public void setTimeoutMillis(TimeoutMode mode, long timeoutMillis) {\n+        switch (mode) {\n+            case SET_FROM_NOW:\n+                setTimeoutAfterMillis(timeoutMillis);\n+                break;\n+            case SET_FROM_START:\n+                setTimeoutMillis(timeoutMillis);\n+                break;\n+            case EXTEND:\n+                extendTimeoutMillis(timeoutMillis);\n+                break;\n+        }\n+    }\n+\n     public void setTimeoutMillis(long timeoutMillis) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "162a58bed6d1fb4ed6c37290ef736e102a31cd01"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1NjE3NA==", "bodyText": "nit: null check", "url": "https://github.com/line/armeria/pull/2571#discussion_r394056174", "createdAt": "2020-03-18T01:17:22Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -439,45 +439,16 @@ public void clearResponseTimeout() {\n     }\n \n     @Override\n-    public void setResponseTimeoutMillis(long responseTimeoutMillis) {\n-        timeoutScheduler.setTimeoutMillis(responseTimeoutMillis);\n-    }\n-\n-    @Override\n-    public void setResponseTimeout(Duration responseTimeout) {\n-        setResponseTimeoutMillis(requireNonNull(responseTimeout, \"responseTimeout\").toMillis());\n-    }\n-\n-    @Override\n-    public void extendResponseTimeoutMillis(long adjustmentMillis) {\n-        timeoutScheduler.extendTimeoutMillis(adjustmentMillis);\n-    }\n-\n-    @Override\n-    public void extendResponseTimeout(Duration adjustment) {\n-        extendResponseTimeoutMillis(requireNonNull(adjustment, \"adjustment\").toMillis());\n-    }\n-\n-    @Override\n-    public void setResponseTimeoutAfterMillis(long responseTimeoutMillis) {\n-        timeoutScheduler.setTimeoutAfterMillis(responseTimeoutMillis);\n-    }\n-\n-    @Override\n-    public void setResponseTimeoutAfter(Duration responseTimeout) {\n-        setResponseTimeoutAfterMillis(requireNonNull(responseTimeout, \"responseTimeout\").toMillis());\n+    public void setResponseTimeoutMillis(TimeoutMode mode, long responseTimeoutMillis) {\n+        timeoutScheduler.setTimeoutMillis(mode, responseTimeoutMillis);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "162a58bed6d1fb4ed6c37290ef736e102a31cd01"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49899e477ca53c92d67aff802de81e4ab9234a93", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/49899e477ca53c92d67aff802de81e4ab9234a93", "committedDate": "2020-03-18T01:45:49Z", "message": "Update DefaultClientRequestContext.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99a27b485db91d767681dc8e70720f7998c598b3", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/99a27b485db91d767681dc8e70720f7998c598b3", "committedDate": "2020-03-18T01:46:31Z", "message": "Update TimeoutScheduler.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 682, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}