{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMjE2OTc3", "number": 2736, "title": "Allow retrying when an `EndpointGroup` is empty.", "bodyText": "Related: #1910\nMotivation:\nA client request to an empty EndpointGroup fails immediately with an\nEmptyEndpointGroupException, even if there is a Retrying(Rpc)Client\nin the decorator chain. As a result, a user cannot recover from the case\nof an empty EndpointGroup.\nModifications:\n\nChange the contract of EndpointSelector.select() to return null\nwhen there's no Endpoint to select instead of throwing an\nEmptyEndpointGroupException.\nMake DefaultClientRequestContext handle the case where\nEndpointGroup.select() returns null so that init() does not treat\nit as failure.\nMake AbstractRetryingClient handle the case where\nEndpointGroup.select() returns null so that it can continue retrying.\nModify the signature of ClientFactory.acquireEventLoop() and\nEventLoopScheduler.acquire() so that it's possible to acquire an\nEventLoop even when Endpoint is not determined yet.\n\nResult:\n\nA user can retry even when the current EndpointGroup is empty.\n(Breaking) EndpointSelector.select() (and thus EndpointGroup.select()\nas well) now returns null instead of throwing an EmptyEndpointGroupException.\n(Breaking) The method signature of ClientFactory.acquireEventLoop() and\nEventLoopScheduler.acquire() has been changed.", "createdAt": "2020-05-21T08:17:02Z", "url": "https://github.com/line/armeria/pull/2736", "merged": true, "mergeCommit": {"oid": "ce5c20200de7dc36799f5420f5c7df20749d74e9"}, "closed": true, "closedAt": "2020-05-22T09:40:17Z", "author": {"login": "trustin"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjZHi7AH2gAyNDIxMjE2OTc3OmE4NjUyNDQ5NWZjODUxYzNhYzU4YzlmYTFiYWRiZjJmYWUwNTdmYTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjtQOggFqTQxNjcwNzQ0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a86524495fc851c3ac58c9fa1badbf2fae057fa2", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/a86524495fc851c3ac58c9fa1badbf2fae057fa2", "committedDate": "2020-05-21T08:09:18Z", "message": "Allow retrying when an `EndpointGroup` is empty.\n\nRelated: #1910\n\nMotivation:\n\nA client request to an empty `EndpointGroup` fails immediately with an\n`EmptyEndpointGroupException`, even if there is a `Retrying(Rpc)Client`\nin the decorator chain. As a result, a user cannot recover from the case\nof an empty `EndpointGroup`.\n\nModifications:\n\n- Make `DefaultClientRequestContext` handle `EmptyEndpointGroupException`\n  specially so that `init()` does not treat is as failure.\n- Make `AbstractRetryingClient` handle `EmptyEndpointGroupException`\n  specially so that it can continue retrying.\n- Modify the signature of `ClientFactory.acquireEventLoop()` and\n  `EventLoopScheduler.acquire()` so that it's possible to acquire an\n  `EventLoop` even when `Endpoint` is not determined yet.\n\nResult:\n\n- A user can retry even when the current `EndpointGroup` is empty.\n\nDiscussion items:\n\n- Should we make `EndpointGroup.select()` return `null` instead of\n  throwing an `EmptyEndpointGroupException`? i.e. Instantiate\n  `EmptyEndpointGroupException` only when setting `responseCause`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTYzODQy", "url": "https://github.com/line/armeria/pull/2736#pullrequestreview-415963842", "createdAt": "2020-05-21T08:21:07Z", "commit": {"oid": "a86524495fc851c3ac58c9fa1badbf2fae057fa2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwODoyMTowN1rOGYqZDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwODoyMTowN1rOGYqZDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUxMzU1MA==", "bodyText": "Unrelated with this PR, but this removes a deprecation warning during compilation. The comment block seems not relevant anymore.", "url": "https://github.com/line/armeria/pull/2736#discussion_r428513550", "createdAt": "2020-05-21T08:21:07Z", "author": {"login": "trustin"}, "path": "brave/src/main/java/com/linecorp/armeria/server/brave/ServiceRequestContextAdapter.java", "diffHunk": "@@ -70,13 +68,6 @@ public String method() {\n             return ctx.method().name();\n         }\n \n-        /**\n-         * Original implementation is calling {@link HttpServerAdapter#url(Object)} which needs {@link\n-         * RequestLog#scheme()}, but because {@link RequestLog#scheme()} is not always available, we need to\n-         * use {@link RequestContext#path()} directly.\n-         *\n-         * @see brave.http.HttpServerRequest#path()\n-         */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a86524495fc851c3ac58c9fa1badbf2fae057fa2"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTYzOTcw", "url": "https://github.com/line/armeria/pull/2736#pullrequestreview-415963970", "createdAt": "2020-05-21T08:21:19Z", "commit": {"oid": "a86524495fc851c3ac58c9fa1badbf2fae057fa2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwODoyMToxOVrOGYqZaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwODoyMToxOVrOGYqZaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUxMzY0MA==", "bodyText": "Unrelated with this PR - just fixed indentation", "url": "https://github.com/line/armeria/pull/2736#discussion_r428513640", "createdAt": "2020-05-21T08:21:19Z", "author": {"login": "trustin"}, "path": "brave/src/main/java/com/linecorp/armeria/server/brave/ServiceRequestContextAdapter.java", "diffHunk": "@@ -56,8 +55,7 @@\n          */\n         @Override\n         public boolean parseClientIpAndPort(Span span) {\n-            return parseClientIpFromXForwardedFor(span) ||\n-                SpanTags.updateRemoteEndpoint(span, ctx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a86524495fc851c3ac58c9fa1badbf2fae057fa2"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTY0MDk0", "url": "https://github.com/line/armeria/pull/2736#pullrequestreview-415964094", "createdAt": "2020-05-21T08:21:32Z", "commit": {"oid": "a86524495fc851c3ac58c9fa1badbf2fae057fa2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwODoyMTozMlrOGYqZvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwODoyMTozMlrOGYqZvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUxMzcyNQ==", "bodyText": "Unrelated with this PR - just fixed indentation", "url": "https://github.com/line/armeria/pull/2736#discussion_r428513725", "createdAt": "2020-05-21T08:21:32Z", "author": {"login": "trustin"}, "path": "brave/src/main/java/com/linecorp/armeria/server/brave/ServiceRequestContextAdapter.java", "diffHunk": "@@ -118,8 +109,8 @@ public long startTimestamp() {\n         }\n     }\n \n-    static brave.http.HttpServerResponse asHttpServerResponse(RequestLog log,\n-        brave.http.HttpServerRequest request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a86524495fc851c3ac58c9fa1badbf2fae057fa2"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MDIwNjYz", "url": "https://github.com/line/armeria/pull/2736#pullrequestreview-416020663", "createdAt": "2020-05-21T09:55:24Z", "commit": {"oid": "a86524495fc851c3ac58c9fa1badbf2fae057fa2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOTo1NToyNVrOGYtEIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOTo1NToyNVrOGYtEIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU1NzM0Nw==", "bodyText": "Is the write to stderr here on purpose or a leftover after a debugging session?", "url": "https://github.com/line/armeria/pull/2736#discussion_r428557347", "createdAt": "2020-05-21T09:55:25Z", "author": {"login": "andrey-tpt"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpClientDelegate.java", "diffHunk": "@@ -62,12 +58,22 @@\n     public HttpResponse execute(ClientRequestContext ctx, HttpRequest req) throws Exception {\n         final Endpoint endpoint = ctx.endpoint();\n         if (endpoint == null) {\n-            // Note that this response will be ignored because:\n-            // - `ClientRequestContext.endpoint()` returns `null` only when the context initialization failed.\n-            // - `ClientUtil.initContextAndExecuteWithFallback()` will use the fallback response rather than\n-            //   what we return here.\n-            req.abort(CONTEXT_INITIALIZATION_FAILED);\n-            return HttpResponse.ofFailure(CONTEXT_INITIALIZATION_FAILED);\n+            // It is possible that we reach here even when `EndpointGroup` is not empty,\n+            // because `endpoint` can be `null` for the following two cases:\n+            // - `EndpointGroup.select()` raised an `EmptyEndpointGroupException`.\n+            // - Other exception was raised while context initialization.\n+            //\n+            // Because all the clean-up is done by `DefaultClientRequestContext.failEarly()`\n+            // when context initialization fails with an exception other than `EmptyEndpointGroupException`,\n+            // we can assume that the exception and response created here will be exposed only\n+            // when context initialization failed due to an `EmptyEndpointGroupException`.\n+            //\n+            // See `DefaultClientRequestContext.init()` for more information.\n+            System.err.println(\"!!!!!!\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a86524495fc851c3ac58c9fa1badbf2fae057fa2"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3ca645301cd1b3d0765e26ca02008d4097cce1e", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e3ca645301cd1b3d0765e26ca02008d4097cce1e", "committedDate": "2020-05-21T11:33:58Z", "message": "Remove the cruft"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NjM1NTQ5", "url": "https://github.com/line/armeria/pull/2736#pullrequestreview-416635549", "createdAt": "2020-05-22T04:08:51Z", "commit": {"oid": "e3ca645301cd1b3d0765e26ca02008d4097cce1e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNDowODo1MVrOGZKEEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNDoxMDoxMlrOGZKFUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAzMjQ2Ng==", "bodyText": "Maybe, is this a breaking change? Need a breaking-changes label?", "url": "https://github.com/line/armeria/pull/2736#discussion_r429032466", "createdAt": "2020-05-22T04:08:51Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactory.java", "diffHunk": "@@ -161,8 +162,15 @@ static void disableShutdownHook() {\n      * Acquires an {@link EventLoop} that is expected to handle a connection to the specified {@link Endpoint}.\n      * The caller must release the returned {@link EventLoop} back by calling {@link ReleasableHolder#release()}\n      * so that {@link ClientFactory} utilizes {@link EventLoop}s efficiently.\n+     *\n+     * @param sessionProtocol the {@link SessionProtocol} of the connection\n+     * @param endpointGroup the {@link EndpointGroup} where {@code endpoint} belongs to.\n+     * @param endpoint the {@link Endpoint} where a request is being sent.\n+     *                 {@code null} if the {@link Endpoint} is not known yet.\n      */\n-    ReleasableHolder<EventLoop> acquireEventLoop(Endpoint endpoint, SessionProtocol sessionProtocol);\n+    ReleasableHolder<EventLoop> acquireEventLoop(SessionProtocol sessionProtocol,\n+                                                 EndpointGroup endpointGroup,\n+                                                 @Nullable Endpoint endpoint);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3ca645301cd1b3d0765e26ca02008d4097cce1e"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTAzMjc4NA==", "bodyText": "Ditto.", "url": "https://github.com/line/armeria/pull/2736#discussion_r429032784", "createdAt": "2020-05-22T04:10:12Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientRequestContext.java", "diffHunk": "@@ -252,7 +250,7 @@ default ClientRequestContext newDerivedContext(RequestId id,\n      * <p>Note that this method does not copy the {@link RequestLog} properties to the derived context.\n      */\n     ClientRequestContext newDerivedContext(RequestId id, @Nullable HttpRequest req, @Nullable RpcRequest rpcReq,\n-                                           Endpoint endpoint);\n+                                           @Nullable Endpoint endpoint);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e3ca645301cd1b3d0765e26ca02008d4097cce1e"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8772cec63eb8cc31f1e14ec374ecc9567d09148", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/a8772cec63eb8cc31f1e14ec374ecc9567d09148", "committedDate": "2020-05-22T06:11:34Z", "message": "Merge branch 'master' into null_endpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3e67b3882f50d0b0d75d237cb9b0cc59b48453a", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/d3e67b3882f50d0b0d75d237cb9b0cc59b48453a", "committedDate": "2020-05-22T06:58:30Z", "message": "Make `EndpointSelector.select()` return `null`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a61a4009a880107f783ba63ba2ed2b698b226b77", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/a61a4009a880107f783ba63ba2ed2b698b226b77", "committedDate": "2020-05-22T07:08:03Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2Njk3Nzcz", "url": "https://github.com/line/armeria/pull/2736#pullrequestreview-416697773", "createdAt": "2020-05-22T07:18:14Z", "commit": {"oid": "a61a4009a880107f783ba63ba2ed2b698b226b77"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzA3NDQw", "url": "https://github.com/line/armeria/pull/2736#pullrequestreview-416707440", "createdAt": "2020-05-22T07:36:54Z", "commit": {"oid": "a61a4009a880107f783ba63ba2ed2b698b226b77"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 546, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}