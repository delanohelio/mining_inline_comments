{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2MzA3OTY5", "number": 3251, "title": "Fix a bug where NPE is raised when retrying a gRPC request", "bodyText": "Motivation:\nWhen creating a derived context, we check whether the RpcRequest is null or not\nif ctx.rpcRequest() is not null in the consturctor of DefaultClientRequestContext.\nprivate DefaultClientRequestContext(...) {\n    if (ctx.rpcRequest() != null) {\n        assert rpcRequest != null;\n    }\n    ...\n}\n\nHowever, the assertion can be false.\nThe rpcRequest of the derived context is set later after the derived context is created so we don't know the timing.\nAlso, we call:\nctx.logBuilder().defer(RequestLogProperty.REQUEST_CONTENT,\n                       RequestLogProperty.RESPONSE_CONTENT);\nthat guarantees the rpcRequest of the derived context is set later when the request content of the parent context is set.\nSo we can completely remove the assertion.\nModification:\n\nRemove the assertion in DefaultClientRequestContext.\n\nResult:\n\nClose #3248\nYou will no longer see NPE when retrying a gRPC request.", "createdAt": "2020-12-29T03:22:12Z", "url": "https://github.com/line/armeria/pull/3251", "merged": true, "mergeCommit": {"oid": "4688818879a8cd57267ea2485bdae2e7b27fa389"}, "closed": true, "closedAt": "2021-01-05T07:44:37Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqxzITgH2gAyNTQ2MzA3OTY5OjA5YTUxZGZlZjAwYWE2YmI3MWM4ODg1NmUzMGVkZWNmYzk2ZGI0MzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtGA_CAFqTU2MTU3MTMzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "09a51dfef00aa6bb71c88856e30edecfc96db430", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/09a51dfef00aa6bb71c88856e30edecfc96db430", "committedDate": "2020-12-29T03:03:15Z", "message": "Fix a bug where NPE is raised when retrying a gRPC request\nMotivation:\nWhen creating a derived context, we check whether the `RpcRequest` is `null` or not\nif `ctx.rpcRequest()` is not `null` in the consturctor of `DefaultClientRequestContext`.\n```\nprivate DefaultClientRequestContext(...) {\n    if (ctx.rpcRequest() != null) {\n        assert rpcRequest != null;\n    }\n    ...\n}\n```\nHowever, the assertion can be false.\nThe `rpcRequest` of the derived context is set later after the derived context is created so we don't know the timing.\nAlso, we call:\n```java\nctx.logBuilder().defer(RequestLogProperty.REQUEST_CONTENT,\n                       RequestLogProperty.RESPONSE_CONTENT);\n```\nthat guarantees the `rpcRequest` of the derived context is set later when the request content of the parent context is set.\nSo we can completely remove the assertion.\n\nModification:\n- Remove the assertion in `DefaultClientRequestContext`.\n\nResult:\n- Close #3248\n- You will no longer see NPE when retrying a aRPC request."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e727a5cf2bb9a146b8ee03b032fd6ec00b871959", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/e727a5cf2bb9a146b8ee03b032fd6ec00b871959", "committedDate": "2020-12-29T03:24:40Z", "message": "Add license"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MzY1NjU2", "url": "https://github.com/line/armeria/pull/3251#pullrequestreview-559365656", "createdAt": "2020-12-29T03:23:09Z", "commit": {"oid": "09a51dfef00aa6bb71c88856e30edecfc96db430"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwMzoyMzowOVrOIMGHzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwMzoyNDoxMlrOIMGIfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1NDEyNw==", "bodyText": "These just changed to use thenAccept instead of thenApply.", "url": "https://github.com/line/armeria/pull/3251#discussion_r549554127", "createdAt": "2020-12-29T03:23:09Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -276,45 +276,39 @@ protected static ClientRequestContext newDerivedContext(ClientRequestContext ctx\n         if (parentLog.isAvailable(RequestLogProperty.NAME)) {\n             final String serviceName = partial.serviceName();\n             final String name = partial.name();\n-            if (name != null) {\n-                if (serviceName != null) {\n-                    logBuilder.name(serviceName, name);\n-                } else {\n-                    logBuilder.name(name);\n-                }\n+            if (serviceName != null) {\n+                logBuilder.name(serviceName, name);\n+            } else {\n+                logBuilder.name(name);\n             }\n         }\n \n         final RequestLogBuilder parentLogBuilder = ctx.logBuilder();\n         if (parentLogBuilder.isDeferred(RequestLogProperty.REQUEST_CONTENT)) {\n             logBuilder.defer(RequestLogProperty.REQUEST_CONTENT);\n         }\n-        parentLog.whenAvailable(RequestLogProperty.REQUEST_CONTENT).thenApply(requestLog -> {\n-            logBuilder.requestContent(requestLog.requestContent(), requestLog.rawRequestContent());\n-            return null;\n-        });\n+        parentLog.whenAvailable(RequestLogProperty.REQUEST_CONTENT)\n+                 .thenAccept(requestLog -> logBuilder.requestContent(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09a51dfef00aa6bb71c88856e30edecfc96db430"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU1NDMwMQ==", "bodyText": "This is not a bug.\nBut it does not break anything and I think it's better to call after calling updateRpcRequest .", "url": "https://github.com/line/armeria/pull/3251#discussion_r549554301", "createdAt": "2020-12-29T03:24:12Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -908,11 +909,10 @@ public void requestContent(@Nullable Object requestContent, @Nullable Object raw\n \n         this.requestContent = requestContent;\n         this.rawRequestContent = rawRequestContent;\n-        updateFlags(RequestLogProperty.REQUEST_CONTENT);\n-\n         if (requestContent instanceof RpcRequest && ctx.rpcRequest() == null) {\n             ctx.updateRpcRequest((RpcRequest) requestContent);\n         }\n+        updateFlags(RequestLogProperty.REQUEST_CONTENT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09a51dfef00aa6bb71c88856e30edecfc96db430"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MzcxOTky", "url": "https://github.com/line/armeria/pull/3251#pullrequestreview-559371992", "createdAt": "2020-12-29T04:12:47Z", "commit": {"oid": "e727a5cf2bb9a146b8ee03b032fd6ec00b871959"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwNDoxMjo0N1rOIMGkdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwNDoxMjo0N1rOIMGkdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU2MTQ2Mw==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/line/armeria/pull/3251#discussion_r549561463", "createdAt": "2020-12-29T04:12:47Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/AbstractRetryingClient.java", "diffHunk": "@@ -276,45 +276,39 @@ protected static ClientRequestContext newDerivedContext(ClientRequestContext ctx\n         if (parentLog.isAvailable(RequestLogProperty.NAME)) {\n             final String serviceName = partial.serviceName();\n             final String name = partial.name();\n-            if (name != null) {\n-                if (serviceName != null) {\n-                    logBuilder.name(serviceName, name);\n-                } else {\n-                    logBuilder.name(name);\n-                }\n+            if (serviceName != null) {\n+                logBuilder.name(serviceName, name);\n+            } else {\n+                logBuilder.name(name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e727a5cf2bb9a146b8ee03b032fd6ec00b871959"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MzgxOTYz", "url": "https://github.com/line/armeria/pull/3251#pullrequestreview-559381963", "createdAt": "2020-12-29T05:22:23Z", "commit": {"oid": "e727a5cf2bb9a146b8ee03b032fd6ec00b871959"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NDA0MTc4", "url": "https://github.com/line/armeria/pull/3251#pullrequestreview-559404178", "createdAt": "2020-12-29T07:12:34Z", "commit": {"oid": "e727a5cf2bb9a146b8ee03b032fd6ec00b871959"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwNzoxMjozNFrOIMImqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOVQwNzoxMjozNFrOIMImqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU5NDc5NQ==", "bodyText": "How about adding some comment about why we don't check nullness of rpcReq here unlike req?", "url": "https://github.com/line/armeria/pull/3251#discussion_r549594795", "createdAt": "2020-12-29T07:12:34Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -357,9 +357,6 @@ private DefaultClientRequestContext(DefaultClientRequestContext ctx,\n         if (ctx.request() != null) {\n             requireNonNull(req, \"req\");\n         }\n-        if (ctx.rpcRequest() != null) {\n-            requireNonNull(rpcReq, \"rpcReq\");\n-        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e727a5cf2bb9a146b8ee03b032fd6ec00b871959"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f78b6ff692305ac453184417f41d161b954f9a6", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/4f78b6ff692305ac453184417f41d161b954f9a6", "committedDate": "2020-12-29T12:25:23Z", "message": "Add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90776d43ba9ee48560e2ce1140e79a27ed53ca1b", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/90776d43ba9ee48560e2ce1140e79a27ed53ca1b", "committedDate": "2020-12-29T13:06:41Z", "message": "Add links"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxNTcxMzMw", "url": "https://github.com/line/armeria/pull/3251#pullrequestreview-561571330", "createdAt": "2021-01-05T07:44:20Z", "commit": {"oid": "90776d43ba9ee48560e2ce1140e79a27ed53ca1b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4586, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}