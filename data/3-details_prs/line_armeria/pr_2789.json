{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNTQ5NzY3", "number": 2789, "title": "Fix lack of service context when annotated service method has request\u2026", "bodyText": "\u2026 data\nCurrently when there is no request content, annotated service will use service context to trigger response converter.\nBut if we have body, it will trigger future.thenApply, so we may trigger response converter without context.", "createdAt": "2020-06-09T05:40:18Z", "url": "https://github.com/line/armeria/pull/2789", "merged": true, "mergeCommit": {"oid": "c735ed98095e6e8b222459522eec0113ee7e4a8c"}, "closed": true, "closedAt": "2020-06-19T06:29:54Z", "author": {"login": "kojilin"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpedIggFqTQyNjgwNDc1NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsE1foAFqTQzMjEzNDcwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODA0NzU1", "url": "https://github.com/line/armeria/pull/2789#pullrequestreview-426804755", "createdAt": "2020-06-09T05:45:57Z", "commit": {"oid": "cb9e8bf27f5252860d9972ca7ed83f4eb9f48d31"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNTo0NTo1N1rOGg5lIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNTo0NTo1N1rOGg5lIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1MTAwOQ==", "bodyText": "I think we couldn't just call it with async method but push the context in it.", "url": "https://github.com/line/armeria/pull/2789#discussion_r437151009", "createdAt": "2020-06-09T05:45:57Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedService.java", "diffHunk": "@@ -248,10 +248,11 @@ public HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) throws Exc\n                                                                      exceptionHandler),\n                             ctx.blockingTaskExecutor());\n                 } else {\n-                    return f.thenApply(\n+                    return f.thenApplyAsync(\n                             msg -> new ExceptionFilteredHttpResponse(ctx, req,\n                                                                      (HttpResponse) invoke(ctx, req, msg),\n-                                                                     exceptionHandler));\n+                                                                     exceptionHandler),\n+                            ctx.contextAwareExecutor());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb9e8bf27f5252860d9972ca7ed83f4eb9f48d31"}, "originalPosition": 10}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6b1b6927f2fa7f6d66451b010e8314eb17ec35b", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/a6b1b6927f2fa7f6d66451b010e8314eb17ec35b", "committedDate": "2020-06-09T06:12:21Z", "message": "Fix test first and re-consider."}, "afterCommit": {"oid": "1ae937c1c35854139e87d8a60705cb36bf795625", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/1ae937c1c35854139e87d8a60705cb36bf795625", "committedDate": "2020-06-09T06:13:23Z", "message": "Fix test first and re-consider."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MDE3MjAz", "url": "https://github.com/line/armeria/pull/2789#pullrequestreview-428017203", "createdAt": "2020-06-10T12:49:31Z", "commit": {"oid": "f8efca10b9378c85c89f41e522e8f23f9fc309a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMwNTA0OTIz", "url": "https://github.com/line/armeria/pull/2789#pullrequestreview-430504923", "createdAt": "2020-06-15T10:12:02Z", "commit": {"oid": "fbffe904ad141f705aaaec109fe120f43bb2968e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDoxMjowMlrOGjr2mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDoxMjowMlrOGjr2mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3MTgzMg==", "bodyText": "Question: Do we need to push context here?\nCompositeResponseConverterFunction#convertResponse() pushed context already.\nDoes this seem to be caused when the users use RxJava?\nThen how about pushing context in ObservableResponseConverterFunction?", "url": "https://github.com/line/armeria/pull/2789#discussion_r440071832", "createdAt": "2020-06-15T10:12:02Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedService.java", "diffHunk": "@@ -328,10 +330,11 @@ private HttpResponse convertResponse(ServiceRequestContext ctx, HttpRequest req,\n                     ((CompletionStage<?>) result)\n                             .thenApply(object -> convertResponse(ctx, req, newHeaders, object,\n                                                                  newTrailers))\n-                            .exceptionally(cause -> exceptionHandler.handleException(ctx, req, cause)));\n+                            .exceptionally(\n+                                    cause -> handleExceptionWithContext(exceptionHandler, ctx, req, cause)));\n         }\n \n-        try {\n+        try (SafeCloseable ignored = ctx.push()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fbffe904ad141f705aaaec109fe120f43bb2968e"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df4efd59e6e4e6c40698a6ad5167c17842773acd", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/df4efd59e6e4e6c40698a6ad5167c17842773acd", "committedDate": "2020-06-16T00:24:28Z", "message": "Fix lack of service context when annotated service method has request data\n\nCurrently when there is no request content, annotated service will use service context to trigger response converter.\nBut if we have body, it will trigger `future.thenApply`, so we may trigger response converter without context."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31403525ecb677fb2197d135beadf7a74a718384", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/31403525ecb677fb2197d135beadf7a74a718384", "committedDate": "2020-06-16T00:24:28Z", "message": "Fix test first and re-consider."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "233ff86aa265719b7731dff3051cbe34a24a1d4a", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/233ff86aa265719b7731dff3051cbe34a24a1d4a", "committedDate": "2020-06-16T00:24:28Z", "message": "Follow comment and adding flowable/observable test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbb2b65722c1e0379026c432cce1f0c320ed93ee", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/dbb2b65722c1e0379026c432cce1f0c320ed93ee", "committedDate": "2020-06-16T00:24:28Z", "message": "push ctx when calling exception handler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64065cd18aa0d2aa1dbb367e9af64b694d72bf16", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/64065cd18aa0d2aa1dbb367e9af64b694d72bf16", "committedDate": "2020-06-16T00:24:28Z", "message": "small tweak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b81783aa60073278907c3ab3810dc95c3e06350c", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/b81783aa60073278907c3ab3810dc95c3e06350c", "committedDate": "2020-06-16T00:56:01Z", "message": "Add test for conveter"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fbffe904ad141f705aaaec109fe120f43bb2968e", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/fbffe904ad141f705aaaec109fe120f43bb2968e", "committedDate": "2020-06-13T05:58:05Z", "message": "small tweak"}, "afterCommit": {"oid": "b81783aa60073278907c3ab3810dc95c3e06350c", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/b81783aa60073278907c3ab3810dc95c3e06350c", "committedDate": "2020-06-16T00:56:01Z", "message": "Add test for conveter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDg0Mjkz", "url": "https://github.com/line/armeria/pull/2789#pullrequestreview-432084293", "createdAt": "2020-06-17T06:08:49Z", "commit": {"oid": "b81783aa60073278907c3ab3810dc95c3e06350c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTM0NzA4", "url": "https://github.com/line/armeria/pull/2789#pullrequestreview-432134708", "createdAt": "2020-06-17T07:36:48Z", "commit": {"oid": "b81783aa60073278907c3ab3810dc95c3e06350c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 194, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}