{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4OTI5OTcx", "number": 2366, "title": "Warn when pushing a wrong context using ContextFuture", "bodyText": "Motivation:\nRelated #2173\nIn that case, which is trying to push a wrong context when the current thread had an unrelated context already, the RequestContextAwareCompletableFuture just swallows the exception and a user has no way what is going wrong.\nModification:\n\nLeave a warning log every time a wrong context is pushed to let the user something is going wrong.\n\nResult:\n\nYou can now easily get noticed when pushing the wrong context.\nClose #2173", "createdAt": "2020-01-03T09:50:20Z", "url": "https://github.com/line/armeria/pull/2366", "merged": true, "mergeCommit": {"oid": "c423b3097047947aa5f7da6d91f9c27c7f96403d"}, "closed": true, "closedAt": "2020-01-07T05:06:47Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2rPRHAH2gAyMzU4OTI5OTcxOjZjOTM4ZDMwNGY2ZGI5MmIyZDg1NzEyZWNkNjE2ODJlZjM4NzZlMWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb35fYpAFqTMzOTAzMTE3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6c938d304f6db92b2d85712ecd61682ef3876e1a", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/6c938d304f6db92b2d85712ecd61682ef3876e1a", "committedDate": "2020-01-03T09:49:26Z", "message": "Warn when pushing a wrong context using RequestContextAwareCompletableFuture\nMotivation:\nRelated #2173\n\nIn that case, which is trying to push a wrong context when the current thread had an unrelated context already, the `RequestContextAwareCompletableFuture` just swallows the exception and a user has no way what is going wrong.\n\nModification:\n- Leave a warning log every time a wrong context is pushed to let the user something is going wrong.\n\nResult:\n- You can now easily get noticed when pushing a wrong context.\n- Close #2173"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MDA5MTg3", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-338009187", "createdAt": "2020-01-03T09:52:47Z", "commit": {"oid": "6c938d304f6db92b2d85712ecd61682ef3876e1a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QwOTo1Mjo0N1rOFZ8t1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QwOTo1Mjo0N1rOFZ8t1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1MzQ5NA==", "bodyText": "This is not called because in exceptionally, pushing with a wrong context happens as well.\nI'm wondering we should mitigate this by not pushing the context in exceptionally. \ud83e\udd14", "url": "https://github.com/line/armeria/pull/2366#discussion_r362753494", "createdAt": "2020-01-03T09:52:47Z", "author": {"login": "minwoox"}, "path": "core/src/test/java/com/linecorp/armeria/internal/ContextFutureCallbackArgumentsProvider.java", "diffHunk": "@@ -0,0 +1,263 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.function.BiConsumer;\n+import java.util.stream.Stream;\n+\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.ArgumentsProvider;\n+\n+import com.google.common.util.concurrent.MoreExecutors;\n+\n+public class ContextFutureCallbackArgumentsProvider implements ArgumentsProvider {\n+\n+    @Override\n+    public Stream<? extends Arguments> provideArguments(ExtensionContext context) throws Exception {\n+        final Arguments thenApply = Arguments.of(\n+                (BiConsumer<CompletableFuture<?>, AtomicBoolean>) (future, called) -> {\n+                    future.thenApply(res -> {\n+                        called.set(true);\n+                        return null;\n+                    }).exceptionally(cause -> {\n+                        called.set(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c938d304f6db92b2d85712ecd61682ef3876e1a"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MDEyNjgz", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-338012683", "createdAt": "2020-01-03T10:02:38Z", "commit": {"oid": "6c938d304f6db92b2d85712ecd61682ef3876e1a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxMDowMjozOFrOFZ84ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxMDowNDoxMFrOFZ86RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1NjI1NA==", "bodyText": "Could we make it much shorter? It will increase the amount of our logs by large margin.", "url": "https://github.com/line/armeria/pull/2366#discussion_r362756254", "createdAt": "2020-01-03T10:02:38Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -545,7 +545,10 @@ public String toString() {\n             return strVal;\n         }\n \n-        final StringBuilder buf = new StringBuilder(96);\n+        final StringBuilder buf = new StringBuilder(117);\n+        buf.append('[')\n+           .append(ClientRequestContext.class.getSimpleName())\n+           .append(']');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c938d304f6db92b2d85712ecd61682ef3876e1a"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1NjQ3Mg==", "bodyText": "Could extract into a new method and deduplicate", "url": "https://github.com/line/armeria/pull/2366#discussion_r362756472", "createdAt": "2020-01-03T10:03:27Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/AbstractRequestContextAwareCompletableFuture.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.function.BiConsumer;\n+import java.util.function.BiFunction;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+/**\n+ * A base class for {@link CompletableFuture} which pushing {@link RequestContext} into the thread-local\n+ * when executes callbacks.\n+ */\n+public abstract class AbstractRequestContextAwareCompletableFuture<T> extends CompletableFuture<T> {\n+\n+    private static final Logger logger =\n+            LoggerFactory.getLogger(AbstractRequestContextAwareCompletableFuture.class);\n+\n+    private final RequestContext ctx;\n+\n+    protected AbstractRequestContextAwareCompletableFuture(RequestContext ctx) {\n+        this.ctx = ctx;\n+    }\n+\n+    protected RequestContext ctx() {\n+        return ctx;\n+    }\n+\n+    protected Runnable makeContextAwareLoggingException(Runnable runnable) {\n+        requireNonNull(runnable, \"runnable\");\n+        return () -> {\n+            try (SafeCloseable ignored = ctx.push()) {\n+                runnable.run();\n+            } catch (Throwable th) {\n+                logger.warn(\"An error occurred when pushing a context\", th);\n+                throw th;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c938d304f6db92b2d85712ecd61682ef3876e1a"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjc1NjY3Nw==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/2366#discussion_r362756677", "createdAt": "2020-01-03T10:04:10Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/DefaultServiceRequestContext.java", "diffHunk": "@@ -584,7 +584,10 @@ public String toString() {\n             return strVal;\n         }\n \n-        final StringBuilder buf = new StringBuilder(96);\n+        final StringBuilder buf = new StringBuilder(119);\n+        buf.append('[')\n+           .append(ServiceRequestContext.class.getSimpleName())\n+           .append(']');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c938d304f6db92b2d85712ecd61682ef3876e1a"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef3ee2105f2fa1e7a9b4ad9425e41ef6fe75114e", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/ef3ee2105f2fa1e7a9b4ad9425e41ef6fe75114e", "committedDate": "2020-01-03T16:36:54Z", "message": "Address comments by @trustin`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3780cf8cca46aa8bec4df98ed17ec5efe05e6332", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/3780cf8cca46aa8bec4df98ed17ec5efe05e6332", "committedDate": "2020-01-04T09:47:10Z", "message": "Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MzgxNjk1", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-338381695", "createdAt": "2020-01-05T05:37:36Z", "commit": {"oid": "3780cf8cca46aa8bec4df98ed17ec5efe05e6332"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQwNTozNzozNlrOFaQFUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQwNTozNzozNlrOFaQFUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA3MDgwMA==", "bodyText": "Ah here's where I first saw the pattern - see my comment here #2371 (comment)\nUsing return instead of throw doesn't seem to improve verbosity but makes the code much less readable.", "url": "https://github.com/line/armeria/pull/2366#discussion_r363070800", "createdAt": "2020-01-05T05:37:36Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientRequestContext.java", "diffHunk": "@@ -351,10 +352,7 @@ default SafeCloseable push(boolean runCallbacks) {\n \n         // Put the oldCtx back before throwing an exception.\n         RequestContextThreadLocal.set(oldCtx);\n-        throw new IllegalStateException(\n-                \"Trying to call object wrapped with context \" + this + \", but context is currently \" +\n-                \"set to \" + oldCtx + \". This means the callback was called from \" +\n-                \"unexpected thread or forgetting to close previous context.\");\n+        return throwIllegalContextPushing(this, oldCtx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3780cf8cca46aa8bec4df98ed17ec5efe05e6332"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MzgxNzg4", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-338381788", "createdAt": "2020-01-05T05:40:54Z", "commit": {"oid": "3780cf8cca46aa8bec4df98ed17ec5efe05e6332"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edf840debf98c182523d5450b00c01db1a9231ed", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/edf840debf98c182523d5450b00c01db1a9231ed", "committedDate": "2020-01-06T01:48:00Z", "message": "Address the comment by @anuraaga"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDM4Nzky", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-338438792", "createdAt": "2020-01-06T01:37:38Z", "commit": {"oid": "3780cf8cca46aa8bec4df98ed17ec5efe05e6332"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwMTozNzozOFrOFaT7mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwMTozNzozOFrOFaT7mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEzMzg0OA==", "bodyText": "I'm not an expert here. So...\nQuestion: Is there any chance the runnable throws an exception?\nIf throws, I think we need to update the message like:\nAn error occurred when pushing a context and executing the 'Runnable'\nOr should we catch only the throwIllegalContextPushing?", "url": "https://github.com/line/armeria/pull/2366#discussion_r363133848", "createdAt": "2020-01-06T01:37:38Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/internal/AbstractRequestContextAwareCompletableFuture.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+import java.util.function.BiConsumer;\n+import java.util.function.BiFunction;\n+import java.util.function.Consumer;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+/**\n+ * A base class for {@link CompletableFuture} which pushing {@link RequestContext} into the thread-local\n+ * when executes callbacks.\n+ */\n+public abstract class AbstractRequestContextAwareCompletableFuture<T> extends CompletableFuture<T> {\n+\n+    private static final Logger logger =\n+            LoggerFactory.getLogger(AbstractRequestContextAwareCompletableFuture.class);\n+\n+    private final RequestContext ctx;\n+\n+    protected AbstractRequestContextAwareCompletableFuture(RequestContext ctx) {\n+        this.ctx = ctx;\n+    }\n+\n+    protected RequestContext ctx() {\n+        return ctx;\n+    }\n+\n+    protected Runnable makeContextAwareLoggingException(Runnable runnable) {\n+        requireNonNull(runnable, \"runnable\");\n+        return () -> {\n+            makeContextAwareLoggingException0(runnable);\n+        };\n+    }\n+\n+    protected <I> Consumer<I> makeContextAwareLoggingException(Consumer<I> action) {\n+        requireNonNull(action, \"action\");\n+        return t -> makeContextAwareLoggingException0(() -> action.accept(t));\n+    }\n+\n+    protected <I, U> BiConsumer<I, U> makeContextAwareLoggingException(BiConsumer<I, U> action) {\n+        requireNonNull(action, \"action\");\n+        return (t, u) -> makeContextAwareLoggingException0(() -> action.accept(t, u));\n+    }\n+\n+    protected <V> Supplier<V> makeContextAwareLoggingException(Supplier<? extends V> action) {\n+        requireNonNull(action, \"action\");\n+        return () -> makeContextAwareLoggingException0(action);\n+    }\n+\n+    protected <I, R> Function<I, R> makeContextAwareLoggingException(Function<I, R> function) {\n+        requireNonNull(function, \"function\");\n+        return t -> makeContextAwareLoggingException0(() -> function.apply(t));\n+    }\n+\n+    protected <I, U, V> BiFunction<I, U, V> makeContextAwareLoggingException(BiFunction<I, U, V> function) {\n+        requireNonNull(function, \"function\");\n+        return (t, u) -> makeContextAwareLoggingException0(() -> function.apply(t, u));\n+    }\n+\n+    private void makeContextAwareLoggingException0(Runnable runnable) {\n+        try (SafeCloseable ignored = ctx.push()) {\n+            runnable.run();\n+        } catch (Throwable th) {\n+            logger.warn(\"An error occurred when pushing a context\", th);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3780cf8cca46aa8bec4df98ed17ec5efe05e6332"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35bbeb553d5156519b9b2c0db0fc284b0295668c", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/35bbeb553d5156519b9b2c0db0fc284b0295668c", "committedDate": "2020-01-06T03:37:23Z", "message": "Address comments by @trustin and @ikhoon"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDYyOTQ5", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-338462949", "createdAt": "2020-01-06T04:22:02Z", "commit": {"oid": "35bbeb553d5156519b9b2c0db0fc284b0295668c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNDoyMjowMlrOFaVLFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNDoyMjowMlrOFaVLFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1NDE5Nw==", "bodyText": "We should not log exceptions raised by .run()\nfinal SafeCloseable handle;\ntry {\n    handle = ctx.push();\n} catch (Throwable t) {\n    logger.warn(...);\n    Exceptions.throwUnsafely(t);\n    return;\n}\n\ntry {\n    action.run();\n} finally {\n    handle.close();\n}", "url": "https://github.com/line/armeria/pull/2366#discussion_r363154197", "createdAt": "2020-01-06T04:22:02Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/AbstractRequestContextAwareCompletableFuture.java", "diffHunk": "@@ -67,35 +67,35 @@ protected Runnable makeContextAwareLoggingException(Runnable runnable) {\n         return (t, u) -> makeContextAwareLoggingException0(() -> action.accept(t, u));\n     }\n \n-    protected <V> Supplier<V> makeContextAwareLoggingException(Supplier<? extends V> action) {\n-        requireNonNull(action, \"action\");\n-        return () -> makeContextAwareLoggingException0(action);\n+    protected <V> Supplier<V> makeContextAwareLoggingException(Supplier<? extends V> supplier) {\n+        requireNonNull(supplier, \"supplier\");\n+        return () -> makeContextAwareLoggingException0(supplier);\n     }\n \n-    protected <I, R> Function<I, R> makeContextAwareLoggingException(Function<I, R> function) {\n-        requireNonNull(function, \"function\");\n-        return t -> makeContextAwareLoggingException0(() -> function.apply(t));\n+    protected <I, R> Function<I, R> makeContextAwareLoggingException(Function<I, R> fn) {\n+        requireNonNull(fn, \"fn\");\n+        return t -> makeContextAwareLoggingException0(() -> fn.apply(t));\n     }\n \n-    protected <I, U, V> BiFunction<I, U, V> makeContextAwareLoggingException(BiFunction<I, U, V> function) {\n-        requireNonNull(function, \"function\");\n-        return (t, u) -> makeContextAwareLoggingException0(() -> function.apply(t, u));\n+    protected <I, U, V> BiFunction<I, U, V> makeContextAwareLoggingException(BiFunction<I, U, V> fn) {\n+        requireNonNull(fn, \"fn\");\n+        return (t, u) -> makeContextAwareLoggingException0(() -> fn.apply(t, u));\n     }\n \n-    private void makeContextAwareLoggingException0(Runnable runnable) {\n+    private void makeContextAwareLoggingException0(Runnable action) {\n         try (SafeCloseable ignored = ctx.push()) {\n-            runnable.run();\n+            action.run();\n         } catch (Throwable th) {\n-            logger.warn(\"An error occurred when pushing a context\", th);\n+            logger.warn(\"An error occurred when pushing a context and executing the action\", th);\n             throw th;\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35bbeb553d5156519b9b2c0db0fc284b0295668c"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDYzMDAx", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-338463001", "createdAt": "2020-01-06T04:22:19Z", "commit": {"oid": "35bbeb553d5156519b9b2c0db0fc284b0295668c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNDoyMjoyMFrOFaVLNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNDoyMjoyMFrOFaVLNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1NDIzMA==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/2366#discussion_r363154230", "createdAt": "2020-01-06T04:22:20Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/AbstractRequestContextAwareCompletableFuture.java", "diffHunk": "@@ -67,35 +67,35 @@ protected Runnable makeContextAwareLoggingException(Runnable runnable) {\n         return (t, u) -> makeContextAwareLoggingException0(() -> action.accept(t, u));\n     }\n \n-    protected <V> Supplier<V> makeContextAwareLoggingException(Supplier<? extends V> action) {\n-        requireNonNull(action, \"action\");\n-        return () -> makeContextAwareLoggingException0(action);\n+    protected <V> Supplier<V> makeContextAwareLoggingException(Supplier<? extends V> supplier) {\n+        requireNonNull(supplier, \"supplier\");\n+        return () -> makeContextAwareLoggingException0(supplier);\n     }\n \n-    protected <I, R> Function<I, R> makeContextAwareLoggingException(Function<I, R> function) {\n-        requireNonNull(function, \"function\");\n-        return t -> makeContextAwareLoggingException0(() -> function.apply(t));\n+    protected <I, R> Function<I, R> makeContextAwareLoggingException(Function<I, R> fn) {\n+        requireNonNull(fn, \"fn\");\n+        return t -> makeContextAwareLoggingException0(() -> fn.apply(t));\n     }\n \n-    protected <I, U, V> BiFunction<I, U, V> makeContextAwareLoggingException(BiFunction<I, U, V> function) {\n-        requireNonNull(function, \"function\");\n-        return (t, u) -> makeContextAwareLoggingException0(() -> function.apply(t, u));\n+    protected <I, U, V> BiFunction<I, U, V> makeContextAwareLoggingException(BiFunction<I, U, V> fn) {\n+        requireNonNull(fn, \"fn\");\n+        return (t, u) -> makeContextAwareLoggingException0(() -> fn.apply(t, u));\n     }\n \n-    private void makeContextAwareLoggingException0(Runnable runnable) {\n+    private void makeContextAwareLoggingException0(Runnable action) {\n         try (SafeCloseable ignored = ctx.push()) {\n-            runnable.run();\n+            action.run();\n         } catch (Throwable th) {\n-            logger.warn(\"An error occurred when pushing a context\", th);\n+            logger.warn(\"An error occurred when pushing a context and executing the action\", th);\n             throw th;\n         }\n     }\n \n-    private <V> V makeContextAwareLoggingException0(Supplier<? extends V> action) {\n+    private <V> V makeContextAwareLoggingException0(Supplier<? extends V> fn) {\n         try (SafeCloseable ignored = ctx.push()) {\n-            return action.get();\n+            return fn.get();\n         } catch (Throwable th) {\n-            logger.warn(\"An error occurred when pushing a context\", th);\n+            logger.warn(\"An error occurred when pushing a context and executing the fn\", th);\n             throw th;\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35bbeb553d5156519b9b2c0db0fc284b0295668c"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDYzMTk4", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-338463198", "createdAt": "2020-01-06T04:23:33Z", "commit": {"oid": "35bbeb553d5156519b9b2c0db0fc284b0295668c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNDoyMzozNFrOFaVLxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNDoyMzozNFrOFaVLxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1NDM3Mw==", "bodyText": "Could you make it a top-level class and make it part of common package?", "url": "https://github.com/line/armeria/pull/2366#discussion_r363154373", "createdAt": "2020-01-06T04:23:34Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/RequestContextUtil.java", "diffHunk": "@@ -87,5 +87,20 @@ public static SafeCloseable pushWithRootAndOldCtx(ClientRequestContext currentCt\n         }\n     }\n \n+    /**\n+     * An {@link IllegalStateException} which is raised when pushing a context from the unexpected thread\n+     * or forgetting to close the previous context.\n+     */\n+    public static final class IllegalContextPushingException extends IllegalStateException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35bbeb553d5156519b9b2c0db0fc284b0295668c"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDYzNTI4", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-338463528", "createdAt": "2020-01-06T04:25:59Z", "commit": {"oid": "35bbeb553d5156519b9b2c0db0fc284b0295668c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNDoyNTo1OVrOFaVM0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNDoyNTo1OVrOFaVM0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1NDY0MA==", "bodyText": "Now that we have a dedicated exception type, we could add getters for the two contexts? We could also simplify the exception message and add more details to the class Javadoc.", "url": "https://github.com/line/armeria/pull/2366#discussion_r363154640", "createdAt": "2020-01-06T04:25:59Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/RequestContextUtil.java", "diffHunk": "@@ -87,5 +87,20 @@ public static SafeCloseable pushWithRootAndOldCtx(ClientRequestContext currentCt\n         }\n     }\n \n+    /**\n+     * An {@link IllegalStateException} which is raised when pushing a context from the unexpected thread\n+     * or forgetting to close the previous context.\n+     */\n+    public static final class IllegalContextPushingException extends IllegalStateException {\n+\n+        private static final long serialVersionUID = 5431942355463120798L;\n+\n+        public IllegalContextPushingException(RequestContext newCtx, RequestContext oldCtx) {\n+            super(\"Trying to call object wrapped with context \" + newCtx + \", but context is currently \" +\n+                  \"set to \" + oldCtx + \". This means the callback was called from \" +\n+                  \"unexpected thread or forgetting to close previous context.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35bbeb553d5156519b9b2c0db0fc284b0295668c"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDY4MTI2", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-338468126", "createdAt": "2020-01-06T04:58:13Z", "commit": {"oid": "35bbeb553d5156519b9b2c0db0fc284b0295668c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNDo1ODoxM1rOFaVcDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNDo1ODoxM1rOFaVcDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE1ODU0MQ==", "bodyText": "This type looks good but just to clarify, I was just expecting the old factory method to return IllegalStateException instead of throwing it ;)", "url": "https://github.com/line/armeria/pull/2366#discussion_r363158541", "createdAt": "2020-01-06T04:58:13Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/internal/RequestContextUtil.java", "diffHunk": "@@ -87,5 +87,20 @@ public static SafeCloseable pushWithRootAndOldCtx(ClientRequestContext currentCt\n         }\n     }\n \n+    /**\n+     * An {@link IllegalStateException} which is raised when pushing a context from the unexpected thread\n+     * or forgetting to close the previous context.\n+     */\n+    public static final class IllegalContextPushingException extends IllegalStateException {\n+\n+        private static final long serialVersionUID = 5431942355463120798L;\n+\n+        public IllegalContextPushingException(RequestContext newCtx, RequestContext oldCtx) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35bbeb553d5156519b9b2c0db0fc284b0295668c"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20a07aead0331a839ada3a569770f9c535b3f9f0", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/20a07aead0331a839ada3a569770f9c535b3f9f0", "committedDate": "2020-01-06T08:06:08Z", "message": "Address comment by @anuraaga and @trustin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTEwOTk5", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-338510999", "createdAt": "2020-01-06T08:11:23Z", "commit": {"oid": "20a07aead0331a839ada3a569770f9c535b3f9f0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwODoxMToyM1rOFaXhPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwODoxMToyM1rOFaXhPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE5MjYzOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    throw new IllegalStateException(\n          \n          \n            \n                    return new IllegalStateException(", "url": "https://github.com/line/armeria/pull/2366#discussion_r363192638", "createdAt": "2020-01-06T08:11:23Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/internal/RequestContextUtil.java", "diffHunk": "@@ -87,5 +87,19 @@ public static SafeCloseable pushWithRootAndOldCtx(ClientRequestContext currentCt\n         }\n     }\n \n+    /**\n+     * Returns an {@link IllegalStateException} which is raised when pushing a context from\n+     * the unexpected thread or forgetting to close the previous context.\n+     */\n+    public static IllegalStateException newIllegalContextPushingException(\n+            RequestContext newCtx, RequestContext oldCtx) {\n+        requireNonNull(newCtx, \"newCtx\");\n+        requireNonNull(oldCtx, \"oldCtx\");\n+        throw new IllegalStateException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20a07aead0331a839ada3a569770f9c535b3f9f0"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5eab119f51ec149538d52e2b596e04eb0a61dda6", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/5eab119f51ec149538d52e2b596e04eb0a61dda6", "committedDate": "2020-01-06T08:13:47Z", "message": "Fix to return"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "114d89c400dd7efe9cbf2efa1b75d3998c15e214", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/114d89c400dd7efe9cbf2efa1b75d3998c15e214", "committedDate": "2020-01-06T13:26:44Z", "message": "Merge branch 'master' into context_aware_mismatch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NjQwNzk2", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-338640796", "createdAt": "2020-01-06T13:28:14Z", "commit": {"oid": "114d89c400dd7efe9cbf2efa1b75d3998c15e214"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bf10791c050d37316994f83d58dbf20d4532a3a", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/1bf10791c050d37316994f83d58dbf20d4532a3a", "committedDate": "2020-01-06T13:55:36Z", "message": "Fix check style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MDMxMTc3", "url": "https://github.com/line/armeria/pull/2366#pullrequestreview-339031177", "createdAt": "2020-01-07T04:59:38Z", "commit": {"oid": "1bf10791c050d37316994f83d58dbf20d4532a3a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 780, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}