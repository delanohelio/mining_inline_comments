{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMjYyNTA1", "number": 2850, "title": "Return the Host header value from `RequestHeaders.authority()` if `:a\u2026", "bodyText": "\u2026uthority` is null\nMotivation:\nCurrently, we translate Host header to :authority header when the protocol of a request is HTTP/1.1.\nHowever, it's not expected behavior and a user still wants to get the Host header.\nhttps://tools.ietf.org/html/rfc7540#section-8.1.3\nSo we should not translate header but just use the Host header value from RequestHeaders.authority()\nwhen :authority header value is null in order to provide a unified getter for the authority.\nModifications:\n\nReturn the Host header value from RequestHeaders.authority() when :authority header value is null.\nAdd Host header if HTTP/1.1 headers does not have.\n\nResult:\n\nClose #2846\nYou can now get Host header from Armeria server if the request is made using HTTP/1.1", "createdAt": "2020-06-29T07:47:55Z", "url": "https://github.com/line/armeria/pull/2850", "merged": true, "mergeCommit": {"oid": "aca35ec33424de5ea4fc985dead36508a56d1fc7"}, "closed": true, "closedAt": "2020-06-30T01:33:30Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcv8Kw3gH2gAyNDQxMjYyNTA1OjU0YjQzNmRkOTE0ZGJlODI5M2UyNmFiZTljOGVmMDJmZmMxN2M5ZDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwBUH-AH2gAyNDQxMjYyNTA1OmRjNDY5MzhiNTk1NzE1M2M3MjMzNWI0NzkwZGM3NDU0ZjI2YWIzN2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "54b436dd914dbe8293e26abe9c8ef02ffc17c9d7", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/54b436dd914dbe8293e26abe9c8ef02ffc17c9d7", "committedDate": "2020-06-29T07:46:35Z", "message": "Return the Host header value from `RequestHeaders.authority()` if `:authority` is null\nMotivation:\nCurrently, we translate `Host` header to `:authority` header when the protocol of a ruquest is HTTP/1.1.\nHowever, it's not an expected behavior and a user still wants to get the `Host` header.\nhttps://tools.ietf.org/html/rfc7540#section-8.1.3\n\nSo we should not translate header but just use the `Host` header value from `RequestHeaders.authority()`\nwhen `:authority` header value is null in order to provide a unified getter for the authority.\n\nModifications:\n- Return the `Host` header value from `RequestHeaders.authority()` when `:authority` header value is null.\n- Add `Host` header if HTTP/1.1 headers does not have.\n\nResult:\n- Close #2846\n- You can now get `Host` header from Armeria server if the request is made using HTTP/1.1"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4OTYxNjA0", "url": "https://github.com/line/armeria/pull/2850#pullrequestreview-438961604", "createdAt": "2020-06-29T07:48:57Z", "commit": {"oid": "54b436dd914dbe8293e26abe9c8ef02ffc17c9d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNzo0ODo1N1rOGqIpNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwNzo0ODo1N1rOGqIpNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjgzNDk5OA==", "bodyText": "Could just call .remove() without .contains()", "url": "https://github.com/line/armeria/pull/2850#discussion_r446834998", "createdAt": "2020-06-29T07:48:57Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -269,9 +271,12 @@ private void autoFillSchemeAndAuthority() {\n         final RequestHeaders headers = req.headers();\n         final String authority = endpoint != null ? endpoint.authority() : \"UNKNOWN\";\n         if (headers.scheme() == null || !authority.equals(headers.authority())) {\n-            unsafeUpdateRequest(req.withHeaders(headers.toBuilder()\n-                                                       .authority(authority)\n-                                                       .scheme(sessionProtocol())));\n+            final RequestHeadersBuilder headersBuilder =\n+                    headers.toBuilder().authority(authority).scheme(sessionProtocol());\n+            if (headersBuilder.contains(HttpHeaderNames.HOST)) {\n+                headersBuilder.remove(HttpHeaderNames.HOST);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b436dd914dbe8293e26abe9c8ef02ffc17c9d7"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32f4ea6ac70396e04e8cdbb365aaf2445f39366b", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/32f4ea6ac70396e04e8cdbb365aaf2445f39366b", "committedDate": "2020-06-29T07:53:54Z", "message": "Address the comment by @trustin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4OTczNzYy", "url": "https://github.com/line/armeria/pull/2850#pullrequestreview-438973762", "createdAt": "2020-06-29T08:06:54Z", "commit": {"oid": "32f4ea6ac70396e04e8cdbb365aaf2445f39366b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwODowNjo1NFrOGqJP-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQwODowNjo1NFrOGqJP-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0NDkyMQ==", "bodyText": "TODO(minwoox)?", "url": "https://github.com/line/armeria/pull/2850#discussion_r446844921", "createdAt": "2020-06-29T08:06:54Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/common/ArmeriaHttpUtil.java", "diffHunk": "@@ -676,6 +672,18 @@ public static void toArmeria(io.netty.handler.codec.http.HttpHeaders inHeaders,\n         }\n     }\n \n+    // Use Netty's validation logic once https://github.com/netty/netty/pull/10380 is merged.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32f4ea6ac70396e04e8cdbb365aaf2445f39366b"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4OTczODg5", "url": "https://github.com/line/armeria/pull/2850#pullrequestreview-438973889", "createdAt": "2020-06-29T08:07:06Z", "commit": {"oid": "32f4ea6ac70396e04e8cdbb365aaf2445f39366b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7650fa95fbcca3bd646c9e61d9fd8e138a3f64ce", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/7650fa95fbcca3bd646c9e61d9fd8e138a3f64ce", "committedDate": "2020-06-29T08:34:34Z", "message": "Add TODO"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MDAxMDE4", "url": "https://github.com/line/armeria/pull/2850#pullrequestreview-439001018", "createdAt": "2020-06-29T08:44:41Z", "commit": {"oid": "7650fa95fbcca3bd646c9e61d9fd8e138a3f64ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc46938b5957153c72335b4790dc7454f26ab37f", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/dc46938b5957153c72335b4790dc7454f26ab37f", "committedDate": "2020-06-29T13:46:20Z", "message": "Merge branch 'master' into fix_authority"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 320, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}