{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1ODM4MDEw", "number": 2496, "title": "Client-side proxy support", "bodyText": "Fixes: #2321\nClient-side proxy support for SOCKS4, SOCKS5, CONNECT Protocol\nMotivation\nAdd support for client-side proxy.\nModification\n\nAdd a ProxyConfig class which serves as a base class for proxy configurations.\nAdd a ClientFactory.proxyConfig method which accepts a ProxyConfig object containing proxy related configuration.\nAdd a DisabledProxyConfig which represents the default -- don't apply client-side proxy\n\nMisc\n\nI will be adding relative documentation after code review is complete as the api may change\nI have decided to add regular HTTP proxy, HaProxy in a separate issue to avoid having a PR that is too big.,\nI am slightly concerned that server side also has a PROXY SessionProtocol which may mislead users to think server side will support all of the implemented client-side proxies. I would like some opinions about this.", "createdAt": "2020-02-16T15:23:21Z", "url": "https://github.com/line/armeria/pull/2496", "merged": true, "mergeCommit": {"oid": "54c0ddbb55d78940a071141a9c59ada311cf4c01"}, "closed": true, "closedAt": "2020-03-16T06:06:56Z", "author": {"login": "jrhee17"}, "timelineItems": {"totalCount": 61, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGqCW8gBqjMwNjIzODQzMjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOFdEhAH2gAyMzc1ODM4MDEwOmZkZDU1OTgxOGEyNTk1MGFmY2ViNmNmNjkxMzFmNTVkMTBiNjUzMTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "061df632a5fb40efdd2a7b8237281eeb827c802e", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/061df632a5fb40efdd2a7b8237281eeb827c802e", "committedDate": "2020-02-22T01:26:15Z", "message": "try to get ci to pass round #2"}, "afterCommit": {"oid": "bd6e22f0f0a720a9b2883ab8887e4f6484744a8a", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/bd6e22f0f0a720a9b2883ab8887e4f6484744a8a", "committedDate": "2020-02-22T01:28:04Z", "message": "try to get ci to pass"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df9ed289af4ba41bebb320e3adf8a8884f6fcbf2", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/df9ed289af4ba41bebb320e3adf8a8884f6fcbf2", "committedDate": "2020-02-22T01:40:26Z", "message": "Exclude default options when merging two `Client*Options` (#2516)\n\nMotivation:\r\nAfter Armeria 0.98.0, `WebClientBuilder` and `ClientBuilder` can set `ClientOptions` and `ClientFactory` easily.\r\nUnfortunately, the `factory` set to the client gets overridden by `ClientOption.FACTORY` of `options`\r\neven though a user did not specify the factory in `ClientOption`.\r\n\r\n```java\r\nWebClient.builder()\r\n         .fatory(factory) // Set custom factory\r\n         .options(options) // The custom factory gets overridden by ClientFactory.ofDefault()\r\n         .build();\r\nClients.builder(uri)\r\n       .factory(factory)\r\n       .options(options)\r\n       .build();\r\n```\r\nBecuase the `ClientOption` has `ClientOption.FACTORY` by default.\r\nIt confuses users who use the client builders.\r\n\r\nModifications:\r\n* Do not set `DEFAULT` options when building `Client*Options`\r\n* Make `AbstractOptions` implement `Iterable`\r\n* `Client*Options.get*` has a priority in order of own and `DEFAULT`\r\n* Breaking\r\n  * `asMap()` in `ClientOptions` and `ClientFactoryOptions` does not return default options anymore.\r\n  * `ClientOption.DEFAULT` has been removed in favor of `ClientOption.of()`\r\n\r\nResult:\r\n`AbstractOption`s set by users don't get overridden by default options.\r\nFixes: #2493"}, "afterCommit": {"oid": "8b96a3df8a0826ea4a6d4ac0cf32482f4880b526", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/8b96a3df8a0826ea4a6d4ac0cf32482f4880b526", "committedDate": "2020-02-22T01:43:29Z", "message": "basic test case with socks proxy"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b96a3df8a0826ea4a6d4ac0cf32482f4880b526", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/8b96a3df8a0826ea4a6d4ac0cf32482f4880b526", "committedDate": "2020-02-22T01:43:29Z", "message": "basic test case with socks proxy"}, "afterCommit": {"oid": "614795ed6f5b8c61365830efb9e2a73d88b78423", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/614795ed6f5b8c61365830efb9e2a73d88b78423", "committedDate": "2020-02-22T01:58:39Z", "message": "basic test case with socks proxy"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "614795ed6f5b8c61365830efb9e2a73d88b78423", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/614795ed6f5b8c61365830efb9e2a73d88b78423", "committedDate": "2020-02-22T01:58:39Z", "message": "basic test case with socks proxy"}, "afterCommit": {"oid": "f4b032aaa377b42bb0fa17d9c3a4fc5231980d25", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/f4b032aaa377b42bb0fa17d9c3a4fc5231980d25", "committedDate": "2020-02-22T02:17:00Z", "message": " basic test case with socks proxy"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b31a0d6a5342f75a91b7d0dbeae55271cf4e8bb", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/0b31a0d6a5342f75a91b7d0dbeae55271cf4e8bb", "committedDate": "2020-02-22T15:18:53Z", "message": "add sanity test for validating test server"}, "afterCommit": {"oid": "3c50944c603192eee06d7783ddb802ccf0dcd38e", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/3c50944c603192eee06d7783ddb802ccf0dcd38e", "committedDate": "2020-02-22T15:50:28Z", "message": "add sanity test for validating test server"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c50944c603192eee06d7783ddb802ccf0dcd38e", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/3c50944c603192eee06d7783ddb802ccf0dcd38e", "committedDate": "2020-02-22T15:50:28Z", "message": "add sanity test for validating test server"}, "afterCommit": {"oid": "0189a93b433c78267e65bfbb06a458ea81cb818a", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/0189a93b433c78267e65bfbb06a458ea81cb818a", "committedDate": "2020-02-22T16:13:53Z", "message": "add sanity test for validating test server"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0189a93b433c78267e65bfbb06a458ea81cb818a", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/0189a93b433c78267e65bfbb06a458ea81cb818a", "committedDate": "2020-02-22T16:13:53Z", "message": "add sanity test for validating test server"}, "afterCommit": {"oid": "26ce01041123153d9587eadfc6a3f004c671754d", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/26ce01041123153d9587eadfc6a3f004c671754d", "committedDate": "2020-02-22T16:20:03Z", "message": "add sanity test for validating test server"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTQ1MDgy", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-363145082", "createdAt": "2020-02-24T01:54:39Z", "commit": {"oid": "665a6b6092c1d94214dd4ad03445a566268f1daa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwMTo1NDozOVrOFtUVdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwMTo1NDozOVrOFtUVdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA2MzQxMg==", "bodyText": "Just curious if it's good to expose Netty proxy handler directly to the user.\nEspecially if we start to support Forward Proxy, we may need to add one more netty handler in the middle. Then the proxy handler is not suitable for that case. It's better to provide proxy setting from armeria?\nJFYI my investigation kojilin@6cbd1e4#diff-fd04617458eb8556240b7e1a48959f8bR349", "url": "https://github.com/line/armeria/pull/2496#discussion_r383063412", "createdAt": "2020-02-24T01:54:39Z", "author": {"login": "kojilin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryOptions.java", "diffHunk": "@@ -398,6 +403,13 @@ public MeterRegistry meterRegistry() {\n         return get(ClientFactoryOption.METER_REGISTRY);\n     }\n \n+    /**\n+     * TODO: add javadoc comment.\n+     */\n+    public Optional<? extends ProxyHandler> getProxyHandler() {\n+        return get(ClientFactoryOption.PROXY_HANDLER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "665a6b6092c1d94214dd4ad03445a566268f1daa"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTQ1MzUw", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-363145350", "createdAt": "2020-02-24T01:56:43Z", "commit": {"oid": "665a6b6092c1d94214dd4ad03445a566268f1daa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwMTo1Njo0M1rOFtUWkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwMTo1Njo0M1rOFtUWkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA2MzY5Ng==", "bodyText": "Maybe 1 more HttpProxyHandler for CONNECT?", "url": "https://github.com/line/armeria/pull/2496#discussion_r383063696", "createdAt": "2020-02-24T01:56:43Z", "author": {"login": "kojilin"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -118,6 +124,14 @@ protected void initChannel(Channel ch) throws Exception {\n                                                       .get(ChannelOption.CONNECT_TIMEOUT_MILLIS);\n     }\n \n+    private static void addSocksProxyHandlerIfPossible(\n+            ChannelPipeline pipeline, Optional<? extends ProxyHandler> proxyHandler) {\n+        if (proxyHandler.isPresent() && (proxyHandler.get() instanceof Socks4ProxyHandler ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "665a6b6092c1d94214dd4ad03445a566268f1daa"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f77364484ceffbc44bc24c08f0acdac16d6bfa41", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/f77364484ceffbc44bc24c08f0acdac16d6bfa41", "committedDate": "2020-02-27T16:09:05Z", "message": " basic test case with socks proxy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be23d88cc370c3d388d9e4c5ffee4e2abb2218c2", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/be23d88cc370c3d388d9e4c5ffee4e2abb2218c2", "committedDate": "2020-02-27T16:09:05Z", "message": "add sanity test for validating test server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad20348d1df5e9ab8046398422e781b723fd23e8", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/ad20348d1df5e9ab8046398422e781b723fd23e8", "committedDate": "2020-02-27T16:09:05Z", "message": "cleanup tests, warning logs before next iteration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7700370bded735b2730663249e9c4afc30219cf", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/e7700370bded735b2730663249e9c4afc30219cf", "committedDate": "2020-02-27T16:11:13Z", "message": "allow to configure ProxyHandler directly from clientFactory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ada5ac4e96b7988fb1e10098e3cd9689bc45554", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/1ada5ac4e96b7988fb1e10098e3cd9689bc45554", "committedDate": "2020-02-27T16:11:13Z", "message": "add test for socks5 proxy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ade0005f4ac931293646b4817027195184871a7", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/9ade0005f4ac931293646b4817027195184871a7", "committedDate": "2020-02-27T23:02:59Z", "message": "try supporting http proxy"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b3d0684fe731b8a36d7d8a6677181ca180b0641", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/0b3d0684fe731b8a36d7d8a6677181ca180b0641", "committedDate": "2020-02-27T15:52:14Z", "message": "try supporting http proxy"}, "afterCommit": {"oid": "9ade0005f4ac931293646b4817027195184871a7", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/9ade0005f4ac931293646b4817027195184871a7", "committedDate": "2020-02-27T23:02:59Z", "message": "try supporting http proxy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe5c73e61d4f0f2ea2529b06d74b78f42075a6c4", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/fe5c73e61d4f0f2ea2529b06d74b78f42075a6c4", "committedDate": "2020-03-01T08:05:06Z", "message": "modify optional to supplier, add tests for h2c/http"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea702b8fee6ffcbb170ef123848a909969abe4b8", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/ea702b8fee6ffcbb170ef123848a909969abe4b8", "committedDate": "2020-03-01T09:26:04Z", "message": "introduce a very basic version of Proxy object"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f0db7b6d49278fbf059b33e860d43b6ac3e8b92", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/0f0db7b6d49278fbf059b33e860d43b6ac3e8b92", "committedDate": "2020-03-01T08:56:31Z", "message": "introduce a very basic version of Proxy object"}, "afterCommit": {"oid": "ea702b8fee6ffcbb170ef123848a909969abe4b8", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/ea702b8fee6ffcbb170ef123848a909969abe4b8", "committedDate": "2020-03-01T09:26:04Z", "message": "introduce a very basic version of Proxy object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f54fc3bcd8d2cbe86293ab66e5988e6c40dee36", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/9f54fc3bcd8d2cbe86293ab66e5988e6c40dee36", "committedDate": "2020-03-01T10:20:16Z", "message": "hide proxy type, use default connectTimeout"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42a5b19618708efc8036bd94ab52266071d7e3d8", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/42a5b19618708efc8036bd94ab52266071d7e3d8", "committedDate": "2020-03-01T10:17:42Z", "message": "hide proxy type, use default connectTimeout"}, "afterCommit": {"oid": "9f54fc3bcd8d2cbe86293ab66e5988e6c40dee36", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/9f54fc3bcd8d2cbe86293ab66e5988e6c40dee36", "committedDate": "2020-03-01T10:20:16Z", "message": "hide proxy type, use default connectTimeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc7d6ef1dadcae9cd0a4b4a539c5e185c048ab20", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/cc7d6ef1dadcae9cd0a4b4a539c5e185c048ab20", "committedDate": "2020-03-01T13:34:09Z", "message": "add username, password support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "650fc5218c675a24e5a3e0124f60c7c2a8e4e382", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/650fc5218c675a24e5a3e0124f60c7c2a8e4e382", "committedDate": "2020-03-02T15:24:29Z", "message": "the Proxy object only has relevant public accessors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e363317322aa4b1e8abc1d5ffcafeac95970528e", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/e363317322aa4b1e8abc1d5ffcafeac95970528e", "committedDate": "2020-03-03T16:51:10Z", "message": "poc for https proxy"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ed883af276926c4f0bad1b78381a6df4c65f846", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/5ed883af276926c4f0bad1b78381a6df4c65f846", "committedDate": "2020-03-03T16:42:00Z", "message": "poc for https proxy - can be reverted"}, "afterCommit": {"oid": "e363317322aa4b1e8abc1d5ffcafeac95970528e", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/e363317322aa4b1e8abc1d5ffcafeac95970528e", "committedDate": "2020-03-03T16:51:10Z", "message": "poc for https proxy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/92d4407ca387e9237c671c45daf3b499b5e6f944", "committedDate": "2020-03-05T14:07:41Z", "message": "add javadocs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NjA3MDEy", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-369607012", "createdAt": "2020-03-05T14:21:59Z", "commit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "state": "COMMENTED", "comments": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDoyMTo1OVrOFyVXYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNDozMjo1MlrOFyVzPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyMzE3MQ==", "bodyText": "proxy() for consistency", "url": "https://github.com/line/armeria/pull/2496#discussion_r388323171", "createdAt": "2020-03-05T14:21:59Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryOptions.java", "diffHunk": "@@ -257,4 +257,11 @@ public ConnectionPoolListener connectionPoolListener() {\n     public MeterRegistry meterRegistry() {\n         return get(ClientFactoryOption.METER_REGISTRY);\n     }\n+\n+    /**\n+     * The {@link Proxy} which contains the proxy configuration.\n+     */\n+    public Proxy getProxy() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyMzM1MQ==", "bodyText": "configureProxy ?", "url": "https://github.com/line/armeria/pull/2496#discussion_r388323351", "createdAt": "2020-03-05T14:22:16Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -118,6 +125,40 @@ protected void initChannel(Channel ch) throws Exception {\n                                                       .get(ChannelOption.CONNECT_TIMEOUT_MILLIS);\n     }\n \n+    private void applyProxy(Channel ch, Proxy proxy, SslContext sslCtx) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyMzc5NQ==", "bodyText": "\"{} Ignoring unknown proxy type: {}\", ch, proxy.proxyType() ?", "url": "https://github.com/line/armeria/pull/2496#discussion_r388323795", "createdAt": "2020-03-05T14:23:01Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -118,6 +125,40 @@ protected void initChannel(Channel ch) throws Exception {\n                                                       .get(ChannelOption.CONNECT_TIMEOUT_MILLIS);\n     }\n \n+    private void applyProxy(Channel ch, Proxy proxy, SslContext sslCtx) {\n+        final ProxyHandler proxyHandler;\n+        switch (proxy.proxyType()) {\n+            case NONE:\n+                return;\n+            case SOCKS4:\n+                proxyHandler = new Socks4ProxyHandler(proxy.proxyAddress(), proxy.userName());\n+                break;\n+            case SOCKS5:\n+                proxyHandler = new Socks5ProxyHandler(\n+                        proxy.proxyAddress(), proxy.userName(), ((Socks5Proxy) proxy).password());\n+                break;\n+            case CONNECT:\n+                final String username = proxy.userName();\n+                final String password = ((ConnectProxy) proxy).password();\n+                if (username == null || password == null) {\n+                    proxyHandler = new HttpProxyHandler(proxy.proxyAddress());\n+                } else {\n+                    proxyHandler = new HttpProxyHandler(proxy.proxyAddress(), username, password);\n+                }\n+                break;\n+            default:\n+                logger.warn(\"Unknown proxy type not applied: {}.\", proxy.proxyType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyNDQ4OA==", "bodyText": "final\nProbably ProxyConfig is better?\nPlease implement toString() for this class and its subclasses.", "url": "https://github.com/line/armeria/pull/2496#discussion_r388324488", "createdAt": "2020-03-05T14:24:02Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/Proxy.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.ProxyBuilder.ConnectProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks4ProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks5ProxyBuilder;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public class Proxy {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyNDgxMg==", "bodyText": "Could we also add a static singleton factory method ofDefault() and none()?", "url": "https://github.com/line/armeria/pull/2496#discussion_r388324812", "createdAt": "2020-03-05T14:24:32Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/Proxy.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.ProxyBuilder.ConnectProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks4ProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks5ProxyBuilder;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public class Proxy {\n+\n+    private static final long USE_DEFAULT_TIMEOUT_MILLIS = -1;\n+    static final Proxy DEFAULT =\n+            new Proxy(ProxyType.NONE, new InetSocketAddress(0), USE_DEFAULT_TIMEOUT_MILLIS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyNTAyMA==", "bodyText": "type()", "url": "https://github.com/line/armeria/pull/2496#discussion_r388325020", "createdAt": "2020-03-05T14:24:52Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/Proxy.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.ProxyBuilder.ConnectProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks4ProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks5ProxyBuilder;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public class Proxy {\n+\n+    private static final long USE_DEFAULT_TIMEOUT_MILLIS = -1;\n+    static final Proxy DEFAULT =\n+            new Proxy(ProxyType.NONE, new InetSocketAddress(0), USE_DEFAULT_TIMEOUT_MILLIS);\n+\n+    private final ProxyType proxyType;\n+    private final InetSocketAddress proxyAddress;\n+    private final long connectTimeoutMillis;\n+\n+    @Nullable\n+    private String userName;\n+\n+    Proxy(ProxyType proxyType, InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        this.proxyType = proxyType;\n+        this.proxyAddress = proxyAddress;\n+        this.connectTimeoutMillis = connectTimeoutMillis;\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyBuilder socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static Socks4ProxyBuilder socks4(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new Socks4ProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks5ProxyBuilder socks5(InetSocketAddress proxyAddress) {\n+        return new Socks5ProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static Socks5ProxyBuilder socks5(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new Socks5ProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static ConnectProxyBuilder connect(InetSocketAddress proxyAddress) {\n+        return new ConnectProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static ConnectProxyBuilder connect(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new ConnectProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    ProxyType proxyType() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyNTIzNQ==", "bodyText": "Please move to the top level.", "url": "https://github.com/line/armeria/pull/2496#discussion_r388325235", "createdAt": "2020-03-05T14:25:12Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/Proxy.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.ProxyBuilder.ConnectProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks4ProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks5ProxyBuilder;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public class Proxy {\n+\n+    private static final long USE_DEFAULT_TIMEOUT_MILLIS = -1;\n+    static final Proxy DEFAULT =\n+            new Proxy(ProxyType.NONE, new InetSocketAddress(0), USE_DEFAULT_TIMEOUT_MILLIS);\n+\n+    private final ProxyType proxyType;\n+    private final InetSocketAddress proxyAddress;\n+    private final long connectTimeoutMillis;\n+\n+    @Nullable\n+    private String userName;\n+\n+    Proxy(ProxyType proxyType, InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        this.proxyType = proxyType;\n+        this.proxyAddress = proxyAddress;\n+        this.connectTimeoutMillis = connectTimeoutMillis;\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyBuilder socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static Socks4ProxyBuilder socks4(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new Socks4ProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks5ProxyBuilder socks5(InetSocketAddress proxyAddress) {\n+        return new Socks5ProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static Socks5ProxyBuilder socks5(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new Socks5ProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static ConnectProxyBuilder connect(InetSocketAddress proxyAddress) {\n+        return new ConnectProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static ConnectProxyBuilder connect(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new ConnectProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    ProxyType proxyType() {\n+        return proxyType;\n+    }\n+\n+    /**\n+     * The proxy address.\n+     */\n+    public InetSocketAddress proxyAddress() {\n+        return proxyAddress;\n+    }\n+\n+    /**\n+     * The connect timeout.\n+     */\n+    public long connectTimeoutMillis() {\n+        return connectTimeoutMillis;\n+    }\n+\n+    /**\n+     * The userName.\n+     */\n+    @Nullable\n+    public String userName() {\n+        return userName;\n+    }\n+\n+    void setUserName(@Nullable String userName) {\n+        this.userName = userName;\n+    }\n+\n+    enum ProxyType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 136}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyNTcxMQ==", "bodyText": "These subtypes could be moved to the top level.", "url": "https://github.com/line/armeria/pull/2496#discussion_r388325711", "createdAt": "2020-03-05T14:25:54Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/Proxy.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.ProxyBuilder.ConnectProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks4ProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks5ProxyBuilder;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public class Proxy {\n+\n+    private static final long USE_DEFAULT_TIMEOUT_MILLIS = -1;\n+    static final Proxy DEFAULT =\n+            new Proxy(ProxyType.NONE, new InetSocketAddress(0), USE_DEFAULT_TIMEOUT_MILLIS);\n+\n+    private final ProxyType proxyType;\n+    private final InetSocketAddress proxyAddress;\n+    private final long connectTimeoutMillis;\n+\n+    @Nullable\n+    private String userName;\n+\n+    Proxy(ProxyType proxyType, InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        this.proxyType = proxyType;\n+        this.proxyAddress = proxyAddress;\n+        this.connectTimeoutMillis = connectTimeoutMillis;\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyBuilder socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static Socks4ProxyBuilder socks4(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new Socks4ProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks5ProxyBuilder socks5(InetSocketAddress proxyAddress) {\n+        return new Socks5ProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static Socks5ProxyBuilder socks5(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new Socks5ProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static ConnectProxyBuilder connect(InetSocketAddress proxyAddress) {\n+        return new ConnectProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static ConnectProxyBuilder connect(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new ConnectProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    ProxyType proxyType() {\n+        return proxyType;\n+    }\n+\n+    /**\n+     * The proxy address.\n+     */\n+    public InetSocketAddress proxyAddress() {\n+        return proxyAddress;\n+    }\n+\n+    /**\n+     * The connect timeout.\n+     */\n+    public long connectTimeoutMillis() {\n+        return connectTimeoutMillis;\n+    }\n+\n+    /**\n+     * The userName.\n+     */\n+    @Nullable\n+    public String userName() {\n+        return userName;\n+    }\n+\n+    void setUserName(@Nullable String userName) {\n+        this.userName = userName;\n+    }\n+\n+    enum ProxyType {\n+        NONE,\n+        SOCKS4,\n+        SOCKS5,\n+        CONNECT,\n+    }\n+\n+    /**\n+     * Contains SOCKS4 proxy configuration used in {@link ClientFactory}.\n+     */\n+    public static class Socks4Proxy extends Proxy {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyNjM4NA==", "bodyText": "instance members should appear after the static factory methods.", "url": "https://github.com/line/armeria/pull/2496#discussion_r388326384", "createdAt": "2020-03-05T14:26:58Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/Proxy.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.ProxyBuilder.ConnectProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks4ProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks5ProxyBuilder;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public class Proxy {\n+\n+    private static final long USE_DEFAULT_TIMEOUT_MILLIS = -1;\n+    static final Proxy DEFAULT =\n+            new Proxy(ProxyType.NONE, new InetSocketAddress(0), USE_DEFAULT_TIMEOUT_MILLIS);\n+\n+    private final ProxyType proxyType;\n+    private final InetSocketAddress proxyAddress;\n+    private final long connectTimeoutMillis;\n+\n+    @Nullable\n+    private String userName;\n+\n+    Proxy(ProxyType proxyType, InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        this.proxyType = proxyType;\n+        this.proxyAddress = proxyAddress;\n+        this.connectTimeoutMillis = connectTimeoutMillis;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyNjY4NQ==", "bodyText": "Global comment: userName -> username", "url": "https://github.com/line/armeria/pull/2496#discussion_r388326685", "createdAt": "2020-03-05T14:27:23Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ProxyBuilder.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.Proxy.ConnectProxy;\n+import com.linecorp.armeria.client.Proxy.Socks4Proxy;\n+import com.linecorp.armeria.client.Proxy.Socks5Proxy;\n+\n+abstract class ProxyBuilder {\n+    @Nullable\n+    private String userName;\n+    @Nullable\n+    private String password;\n+\n+    private final InetSocketAddress proxyAddress;\n+    private final long connectTimeoutMillis;\n+    private boolean useSsl;\n+\n+    private ProxyBuilder(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        this.proxyAddress = proxyAddress;\n+        this.connectTimeoutMillis = connectTimeoutMillis;\n+    }\n+\n+    @Nullable\n+    protected String getUserName() {\n+        return userName;\n+    }\n+\n+    protected void setUserName(@Nullable String userName) {\n+        this.userName = userName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyNzE5NQ==", "bodyText": "AbstractProxyBuilder?", "url": "https://github.com/line/armeria/pull/2496#discussion_r388327195", "createdAt": "2020-03-05T14:28:11Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ProxyBuilder.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.Proxy.ConnectProxy;\n+import com.linecorp.armeria.client.Proxy.Socks4Proxy;\n+import com.linecorp.armeria.client.Proxy.Socks5Proxy;\n+\n+abstract class ProxyBuilder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyNzg3NQ==", "bodyText": "How about just splitting into username() and password()?", "url": "https://github.com/line/armeria/pull/2496#discussion_r388327875", "createdAt": "2020-03-05T14:29:10Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ProxyBuilder.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.Proxy.ConnectProxy;\n+import com.linecorp.armeria.client.Proxy.Socks4Proxy;\n+import com.linecorp.armeria.client.Proxy.Socks5Proxy;\n+\n+abstract class ProxyBuilder {\n+    @Nullable\n+    private String userName;\n+    @Nullable\n+    private String password;\n+\n+    private final InetSocketAddress proxyAddress;\n+    private final long connectTimeoutMillis;\n+    private boolean useSsl;\n+\n+    private ProxyBuilder(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        this.proxyAddress = proxyAddress;\n+        this.connectTimeoutMillis = connectTimeoutMillis;\n+    }\n+\n+    @Nullable\n+    protected String getUserName() {\n+        return userName;\n+    }\n+\n+    protected void setUserName(@Nullable String userName) {\n+        this.userName = userName;\n+    }\n+\n+    @Nullable\n+    protected String getPassword() {\n+        return password;\n+    }\n+\n+    protected void setPassword(@Nullable String password) {\n+        this.password = password;\n+    }\n+\n+    protected InetSocketAddress getProxyAddress() {\n+        return proxyAddress;\n+    }\n+\n+    protected long getConnectTimeoutMillis() {\n+        return connectTimeoutMillis;\n+    }\n+\n+    protected void setUseSsl(boolean useSsl) {\n+        this.useSsl = useSsl;\n+    }\n+\n+    protected boolean getUseSsl() {\n+        return useSsl;\n+    }\n+\n+    /**\n+     * Build the proxy object.\n+     */\n+    public abstract Proxy build();\n+\n+    /**\n+     * A {@code ProxyBuilder} which builds a SOCKS4 protocol configuration.\n+     */\n+    public static final class Socks4ProxyBuilder extends ProxyBuilder {\n+        Socks4ProxyBuilder(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+            super(proxyAddress, connectTimeoutMillis);\n+        }\n+\n+        /**\n+         * Set the proxy userName.\n+         */\n+        public Socks4ProxyBuilder userName(String userName) {\n+            setUserName(userName);\n+            return this;\n+        }\n+\n+        @Override\n+        public Socks4Proxy build() {\n+            final Socks4Proxy socks4Proxy =\n+                    new Socks4Proxy(getProxyAddress(), getConnectTimeoutMillis());\n+            socks4Proxy.setUserName(getUserName());\n+            return socks4Proxy;\n+        }\n+    }\n+\n+    /**\n+     * A {@code ProxyBuilder} which builds a SOCKS4 protocol configuration.\n+     */\n+    public static final class Socks5ProxyBuilder extends ProxyBuilder {\n+        Socks5ProxyBuilder(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+            super(proxyAddress, connectTimeoutMillis);\n+        }\n+\n+        /**\n+         * Set the proxy userName.\n+         */\n+        public Socks5ProxyBuilder userName(String userName) {\n+            setUserName(userName);\n+            return this;\n+        }\n+\n+        /**\n+         * Set the proxy password.\n+         */\n+        public Socks5ProxyBuilder password(String password) {\n+            setPassword(password);\n+            return this;\n+        }\n+\n+        @Override\n+        public Socks5Proxy build() {\n+            final Socks5Proxy socks5Proxy =\n+                    new Socks5Proxy(getProxyAddress(), getConnectTimeoutMillis());\n+            socks5Proxy.setUserName(getUserName());\n+            socks5Proxy.setPassword(getPassword());\n+            return socks5Proxy;\n+        }\n+    }\n+\n+    /**\n+     * A {@code ProxyBuilder} which builds a SOCKS4 protocol configuration.\n+     */\n+    public static final class ConnectProxyBuilder extends ProxyBuilder {\n+        ConnectProxyBuilder(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+            super(proxyAddress, connectTimeoutMillis);\n+        }\n+\n+        /**\n+         * Set the proxy userName and password.\n+         */\n+        public ConnectProxyBuilder auth(String userName, String password) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 153}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyODkxOA==", "bodyText": "if connect timeout is optional, we can remove the factory methods with connectTimeoutMillis and add connectTimeout(Duration) and connectTimeoutMillis(long) to the builder class.", "url": "https://github.com/line/armeria/pull/2496#discussion_r388328918", "createdAt": "2020-03-05T14:30:42Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/Proxy.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.ProxyBuilder.ConnectProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks4ProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks5ProxyBuilder;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public class Proxy {\n+\n+    private static final long USE_DEFAULT_TIMEOUT_MILLIS = -1;\n+    static final Proxy DEFAULT =\n+            new Proxy(ProxyType.NONE, new InetSocketAddress(0), USE_DEFAULT_TIMEOUT_MILLIS);\n+\n+    private final ProxyType proxyType;\n+    private final InetSocketAddress proxyAddress;\n+    private final long connectTimeoutMillis;\n+\n+    @Nullable\n+    private String userName;\n+\n+    Proxy(ProxyType proxyType, InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        this.proxyType = proxyType;\n+        this.proxyAddress = proxyAddress;\n+        this.connectTimeoutMillis = connectTimeoutMillis;\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyBuilder socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static Socks4ProxyBuilder socks4(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new Socks4ProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks5ProxyBuilder socks5(InetSocketAddress proxyAddress) {\n+        return new Socks5ProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static Socks5ProxyBuilder socks5(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new Socks5ProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static ConnectProxyBuilder connect(InetSocketAddress proxyAddress) {\n+        return new ConnectProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static ConnectProxyBuilder connect(InetSocketAddress proxyAddress, long connectTimeoutMillis) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMyOTU0Ng==", "bodyText": "Make all non-builder classes purely immutable.", "url": "https://github.com/line/armeria/pull/2496#discussion_r388329546", "createdAt": "2020-03-05T14:31:43Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/Proxy.java", "diffHunk": "@@ -0,0 +1,209 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.ProxyBuilder.ConnectProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks4ProxyBuilder;\n+import com.linecorp.armeria.client.ProxyBuilder.Socks5ProxyBuilder;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public class Proxy {\n+\n+    private static final long USE_DEFAULT_TIMEOUT_MILLIS = -1;\n+    static final Proxy DEFAULT =\n+            new Proxy(ProxyType.NONE, new InetSocketAddress(0), USE_DEFAULT_TIMEOUT_MILLIS);\n+\n+    private final ProxyType proxyType;\n+    private final InetSocketAddress proxyAddress;\n+    private final long connectTimeoutMillis;\n+\n+    @Nullable\n+    private String userName;\n+\n+    Proxy(ProxyType proxyType, InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        this.proxyType = proxyType;\n+        this.proxyAddress = proxyAddress;\n+        this.connectTimeoutMillis = connectTimeoutMillis;\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyBuilder socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static Socks4ProxyBuilder socks4(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new Socks4ProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks5ProxyBuilder socks5(InetSocketAddress proxyAddress) {\n+        return new Socks5ProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static Socks5ProxyBuilder socks5(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new Socks5ProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static ConnectProxyBuilder connect(InetSocketAddress proxyAddress) {\n+        return new ConnectProxyBuilder(requireNonNull(proxyAddress), USE_DEFAULT_TIMEOUT_MILLIS);\n+    }\n+\n+    /**\n+     * Creates a {@code Proxy} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param connectTimeoutMillis The connection timeout for connecting to the proxy server.\n+     */\n+    public static ConnectProxyBuilder connect(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+        checkArgument(connectTimeoutMillis >= 0);\n+        return new ConnectProxyBuilder(requireNonNull(proxyAddress), connectTimeoutMillis);\n+    }\n+\n+    ProxyType proxyType() {\n+        return proxyType;\n+    }\n+\n+    /**\n+     * The proxy address.\n+     */\n+    public InetSocketAddress proxyAddress() {\n+        return proxyAddress;\n+    }\n+\n+    /**\n+     * The connect timeout.\n+     */\n+    public long connectTimeoutMillis() {\n+        return connectTimeoutMillis;\n+    }\n+\n+    /**\n+     * The userName.\n+     */\n+    @Nullable\n+    public String userName() {\n+        return userName;\n+    }\n+\n+    void setUserName(@Nullable String userName) {\n+        this.userName = userName;\n+    }\n+\n+    enum ProxyType {\n+        NONE,\n+        SOCKS4,\n+        SOCKS5,\n+        CONNECT,\n+    }\n+\n+    /**\n+     * Contains SOCKS4 proxy configuration used in {@link ClientFactory}.\n+     */\n+    public static class Socks4Proxy extends Proxy {\n+        Socks4Proxy(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+            super(ProxyType.SOCKS4, proxyAddress, connectTimeoutMillis);\n+        }\n+    }\n+\n+    /**\n+     * Contains SOCKS5 proxy configuration used in {@link ClientFactory}.\n+     */\n+    public static class Socks5Proxy extends Proxy {\n+        @Nullable\n+        private String password;\n+\n+        Socks5Proxy(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+            super(ProxyType.SOCKS5, proxyAddress, connectTimeoutMillis);\n+        }\n+\n+        /**\n+         * The configured password.\n+         */\n+        @Nullable\n+        public String password() {\n+            return password;\n+        }\n+\n+        void setPassword(@Nullable String password) {\n+            this.password = password;\n+        }\n+    }\n+\n+    /**\n+     * Contains CONNECT proxy configuration used in {@link ClientFactory}.\n+     */\n+    public static class ConnectProxy extends Proxy {\n+        @Nullable\n+        private String password;\n+\n+        private boolean useSsl;\n+\n+        ConnectProxy(InetSocketAddress proxyAddress, long connectTimeoutMillis) {\n+            super(ProxyType.CONNECT, proxyAddress, connectTimeoutMillis);\n+        }\n+\n+        /**\n+         * The configured password.\n+         */\n+        @Nullable\n+        public String password() {\n+            return password;\n+        }\n+\n+        void setPassword(@Nullable String password) {\n+            this.password = password;\n+        }\n+\n+        void setUseSsl(boolean useSsl) {\n+            this.useSsl = useSsl;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 203}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODMzMDMwMw==", "bodyText": "This seems unused but I guess you have a plan. \ud83d\ude09", "url": "https://github.com/line/armeria/pull/2496#discussion_r388330303", "createdAt": "2020-03-05T14:32:52Z", "author": {"login": "trustin"}, "path": "testing-internal/src/main/java/com/linecorp/armeria/internal/testing/DynamicBehaviorHandler.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.testing;\n+\n+import javax.annotation.Nullable;\n+\n+import io.netty.channel.ChannelDuplexHandler;\n+import io.netty.channel.ChannelHandler.Sharable;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelPromise;\n+\n+@Sharable\n+public class DynamicBehaviorHandler extends ChannelDuplexHandler {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92d4407ca387e9237c671c45daf3b499b5e6f944"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c7c0626a40e6260567eff67abd4a1c6e35f9723", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/7c7c0626a40e6260567eff67abd4a1c6e35f9723", "committedDate": "2020-03-05T15:10:29Z", "message": "use clientFactory timeout instead of a dedicated proxy parameter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e16cd070b3cccfeff7e24c645059496268f59cbd", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/e16cd070b3cccfeff7e24c645059496268f59cbd", "committedDate": "2020-03-06T15:55:49Z", "message": "move inner classes to upper level and rename proxy to proxyConfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bcd2f3522ffc30998317d6a13f9b5ab89fbbc93", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/8bcd2f3522ffc30998317d6a13f9b5ab89fbbc93", "committedDate": "2020-03-06T16:50:13Z", "message": "rename proxy to proxyConfig, userName to username"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4496d65b067bdcb7e42155296c909e451c314f2b", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/4496d65b067bdcb7e42155296c909e451c314f2b", "committedDate": "2020-03-07T11:51:43Z", "message": "clean up javadoc, add noop proxy config type"}, "afterCommit": {"oid": "a4503e6229ab73c3c8b875dc33e4a5ad737ba514", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/a4503e6229ab73c3c8b875dc33e4a5ad737ba514", "committedDate": "2020-03-07T11:55:36Z", "message": "clean up javadoc, add noop proxy config type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4503e6229ab73c3c8b875dc33e4a5ad737ba514", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/a4503e6229ab73c3c8b875dc33e4a5ad737ba514", "committedDate": "2020-03-07T11:55:36Z", "message": "clean up javadoc, add noop proxy config type"}, "afterCommit": {"oid": "9499aa21920be0723e6c52e66e78b0dbdbb27c28", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/9499aa21920be0723e6c52e66e78b0dbdbb27c28", "committedDate": "2020-03-07T12:07:05Z", "message": "clean up javadoc, add noop proxy config type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9499aa21920be0723e6c52e66e78b0dbdbb27c28", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/9499aa21920be0723e6c52e66e78b0dbdbb27c28", "committedDate": "2020-03-07T12:07:05Z", "message": "clean up javadoc, add noop proxy config type"}, "afterCommit": {"oid": "9bd10c2ca790ea504e140175257f9fa3cd0d9839", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/9bd10c2ca790ea504e140175257f9fa3cd0d9839", "committedDate": "2020-03-07T12:11:27Z", "message": "clean up javadoc, add noop proxy config type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9bd10c2ca790ea504e140175257f9fa3cd0d9839", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/9bd10c2ca790ea504e140175257f9fa3cd0d9839", "committedDate": "2020-03-07T12:11:27Z", "message": "clean up javadoc, add noop proxy config type"}, "afterCommit": {"oid": "5c79ac09cb59f0e6e463b32ffe4cd2e2f362010c", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/5c79ac09cb59f0e6e463b32ffe4cd2e2f362010c", "committedDate": "2020-03-07T12:24:42Z", "message": "clean up javadoc, add noop proxy config type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d07e63a98b669a83303d05bc406c15203417c995", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/d07e63a98b669a83303d05bc406c15203417c995", "committedDate": "2020-03-07T12:53:46Z", "message": "clean up javadoc, add noop proxy config type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c79ac09cb59f0e6e463b32ffe4cd2e2f362010c", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/5c79ac09cb59f0e6e463b32ffe4cd2e2f362010c", "committedDate": "2020-03-07T12:24:42Z", "message": "clean up javadoc, add noop proxy config type"}, "afterCommit": {"oid": "d07e63a98b669a83303d05bc406c15203417c995", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/d07e63a98b669a83303d05bc406c15203417c995", "committedDate": "2020-03-07T12:53:46Z", "message": "clean up javadoc, add noop proxy config type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/488b63c211d63f50cf415a276fda2f21c2dfd421", "committedDate": "2020-03-08T01:53:31Z", "message": "rename ProxyBuilder to ProxyConfigBuilder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "951de14ac713d1314494a15f1ca8c729cc50dc77", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/951de14ac713d1314494a15f1ca8c729cc50dc77", "committedDate": "2020-03-08T01:32:35Z", "message": "rename ProxyBuilder to ProxyConfigBuilder"}, "afterCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/488b63c211d63f50cf415a276fda2f21c2dfd421", "committedDate": "2020-03-08T01:53:31Z", "message": "rename ProxyBuilder to ProxyConfigBuilder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwOTEzNDUz", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-370913453", "createdAt": "2020-03-09T04:34:42Z", "commit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNDozNDo0MlrOFzauvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwNTozNzowNlrOFzbYxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ1OTY0Nw==", "bodyText": "This Noop config seems weird a little bit for me.\nBecause this is not an action or behavior but a configuration.\nHow about removing this and using nullable as a default?", "url": "https://github.com/line/armeria/pull/2496#discussion_r389459647", "createdAt": "2020-03-09T04:34:42Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/NoopProxyConfig.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+/**\n+ * Represents client-side proxy is disabled.\n+ */\n+public class NoopProxyConfig extends ProxyConfig {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ1OTcwNQ==", "bodyText": "nit: This and others :-)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return new Socks4ProxyConfigBuilder(requireNonNull(proxyAddress));\n          \n          \n            \n                    return new Socks4ProxyConfigBuilder(requireNonNull(proxyAddress, \"proxyAddress\"));", "url": "https://github.com/line/armeria/pull/2496#discussion_r389459705", "createdAt": "2020-03-09T04:35:07Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.linecorp.armeria.client.proxy.NoopProxyConfig.NOOP_PROXY_CONFIG;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public abstract class ProxyConfig {\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyConfigBuilder socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyConfigBuilder(requireNonNull(proxyAddress));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ2OTk0OQ==", "bodyText": "Could be package-private?", "url": "https://github.com/line/armeria/pull/2496#discussion_r389469949", "createdAt": "2020-03-09T05:34:35Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/AbstractProxyConfigBuilder.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+abstract class AbstractProxyConfigBuilder {\n+\n+    private final InetSocketAddress proxyAddress;\n+    @Nullable\n+    private String username;\n+    @Nullable\n+    private String password;\n+\n+    protected AbstractProxyConfigBuilder(InetSocketAddress proxyAddress) {\n+        this.proxyAddress = proxyAddress;\n+    }\n+\n+    protected InetSocketAddress getProxyAddress() {\n+        return proxyAddress;\n+    }\n+\n+    @Nullable\n+    protected String getUsername() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ2OTk2OQ==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/2496#discussion_r389469969", "createdAt": "2020-03-09T05:34:43Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/AbstractProxyConfigBuilder.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+abstract class AbstractProxyConfigBuilder {\n+\n+    private final InetSocketAddress proxyAddress;\n+    @Nullable\n+    private String username;\n+    @Nullable\n+    private String password;\n+\n+    protected AbstractProxyConfigBuilder(InetSocketAddress proxyAddress) {\n+        this.proxyAddress = proxyAddress;\n+    }\n+\n+    protected InetSocketAddress getProxyAddress() {\n+        return proxyAddress;\n+    }\n+\n+    @Nullable\n+    protected String getUsername() {\n+        return username;\n+    }\n+\n+    protected void setUsername(@Nullable String username) {\n+        this.username = username;\n+    }\n+\n+    @Nullable\n+    protected String getPassword() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ2OTk4NA==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/2496#discussion_r389469984", "createdAt": "2020-03-09T05:34:51Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/AbstractProxyConfigBuilder.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+abstract class AbstractProxyConfigBuilder {\n+\n+    private final InetSocketAddress proxyAddress;\n+    @Nullable\n+    private String username;\n+    @Nullable\n+    private String password;\n+\n+    protected AbstractProxyConfigBuilder(InetSocketAddress proxyAddress) {\n+        this.proxyAddress = proxyAddress;\n+    }\n+\n+    protected InetSocketAddress getProxyAddress() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ3MDQwNQ==", "bodyText": "I think Armeria would not use this builder API design. You might want to start with builder()... to build ProxyConfig pattern.\nProxyConfig.builder()\n           .socks4(...)\n           .username(...)\n           .build()\nOr How about making factory methods as we did in Backoff?\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/client/retry/Backoff.java\n    \n    \n        Lines 50 to 62\n      in\n      bd28eb2\n    \n    \n    \n    \n\n        \n          \n               /** \n        \n\n        \n          \n                * Returns a {@link Backoff} that waits a fixed delay between attempts. \n        \n\n        \n          \n                */ \n        \n\n        \n          \n               static Backoff fixed(long delayMillis) { \n        \n\n        \n          \n                   return new FixedBackoff(delayMillis); \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               /** \n        \n\n        \n          \n                * Returns a {@link Backoff} that waits an exponentially-increasing amount of time between attempts. \n        \n\n        \n          \n                */ \n        \n\n        \n          \n               static Backoff exponential(long initialDelayMillis, long maxDelayMillis) { \n        \n\n        \n          \n                   return exponential(initialDelayMillis, maxDelayMillis, 2.0); \n        \n\n        \n          \n               }", "url": "https://github.com/line/armeria/pull/2496#discussion_r389470405", "createdAt": "2020-03-09T05:37:06Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.linecorp.armeria.client.proxy.NoopProxyConfig.NOOP_PROXY_CONFIG;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public abstract class ProxyConfig {\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyConfigBuilder socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyConfigBuilder(requireNonNull(proxyAddress));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ1OTcwNQ=="}, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwOTY5MzYy", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-370969362", "createdAt": "2020-03-09T08:02:01Z", "commit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwODowMjowMVrOFzdm1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwODoyNDowNFrOFzeFYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUwNjc3Mg==", "bodyText": "useTls", "url": "https://github.com/line/armeria/pull/2496#discussion_r389506772", "createdAt": "2020-03-09T08:02:01Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+/**\n+ * Contains CONNECT proxy related configuration.\n+ */\n+public class ConnectProxyConfig extends ProxyConfig {\n+\n+    @Nullable\n+    private final String password;\n+\n+    private final boolean useSsl;\n+\n+    ConnectProxyConfig(InetSocketAddress proxyAddress, @Nullable String username,\n+                       @Nullable String password, boolean useSsl) {\n+        super(proxyAddress, username);\n+        this.password = password;\n+        this.useSsl = useSsl;\n+    }\n+\n+    /**\n+     * The configured password.\n+     */\n+    @Nullable\n+    public String password() {\n+        return password;\n+    }\n+\n+    /**\n+     * Whether ssl is enabled.\n+     */\n+    public boolean useSsl() {\n+        return useSsl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUwNjgyMQ==", "bodyText": "useTls", "url": "https://github.com/line/armeria/pull/2496#discussion_r389506821", "createdAt": "2020-03-09T08:02:10Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfigBuilder.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+\n+/**\n+ * A {@link ProxyConfig} builder for the CONNECT protocol.\n+ */\n+public final class ConnectProxyConfigBuilder extends AbstractProxyConfigBuilder {\n+\n+    private boolean useSsl;\n+\n+    ConnectProxyConfigBuilder(InetSocketAddress proxyAddress) {\n+        super(proxyAddress);\n+    }\n+\n+    /**\n+     * Sets the proxy username and password.\n+     */\n+    public ConnectProxyConfigBuilder auth(String username, String password) {\n+        setUsername(requireNonNull(username));\n+        setPassword(requireNonNull(password));\n+        return this;\n+    }\n+\n+    /**\n+     * Signifies whether to use ssl to connect to the proxy.\n+     * If enabled, the ssl configurations for the {@link ClientFactory} will also be applied to the proxy.\n+     */\n+    public ConnectProxyConfigBuilder useSsl(boolean useSsl) {\n+        this.useSsl = useSsl;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUxMTgzNw==", "bodyText": "How about DisabledProxyConfig ?\nMissing final", "url": "https://github.com/line/armeria/pull/2496#discussion_r389511837", "createdAt": "2020-03-09T08:16:28Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/NoopProxyConfig.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+/**\n+ * Represents client-side proxy is disabled.\n+ */\n+public class NoopProxyConfig extends ProxyConfig {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ1OTY0Nw=="}, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUxMTk1NQ==", "bodyText": "Why do we need username here?", "url": "https://github.com/line/armeria/pull/2496#discussion_r389511955", "createdAt": "2020-03-09T08:16:49Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/NoopProxyConfig.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+/**\n+ * Represents client-side proxy is disabled.\n+ */\n+public class NoopProxyConfig extends ProxyConfig {\n+\n+    static final NoopProxyConfig NOOP_PROXY_CONFIG =\n+            new NoopProxyConfig(new InetSocketAddress(0), null);\n+\n+    NoopProxyConfig(InetSocketAddress proxyAddress, @Nullable String username) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUxMjQ5Mw==", "bodyText": "How about builderForSocks4, etc?", "url": "https://github.com/line/armeria/pull/2496#discussion_r389512493", "createdAt": "2020-03-09T08:18:27Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.linecorp.armeria.client.proxy.NoopProxyConfig.NOOP_PROXY_CONFIG;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public abstract class ProxyConfig {\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyConfigBuilder socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyConfigBuilder(requireNonNull(proxyAddress));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ1OTcwNQ=="}, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUxMjU4NQ==", "bodyText": "disabled()", "url": "https://github.com/line/armeria/pull/2496#discussion_r389512585", "createdAt": "2020-03-09T08:18:40Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.linecorp.armeria.client.proxy.NoopProxyConfig.NOOP_PROXY_CONFIG;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public abstract class ProxyConfig {\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyConfigBuilder socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyConfigBuilder(requireNonNull(proxyAddress));\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks5ProxyConfigBuilder socks5(InetSocketAddress proxyAddress) {\n+        return new Socks5ProxyConfigBuilder(requireNonNull(proxyAddress));\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static ConnectProxyConfigBuilder connect(InetSocketAddress proxyAddress) {\n+        return new ConnectProxyConfigBuilder(requireNonNull(proxyAddress));\n+    }\n+\n+    /**\n+     * Returns a {@code ProxyConfig} which signifies that proxy is disabled.\n+     */\n+    public static ProxyConfig noop() {\n+        return NOOP_PROXY_CONFIG;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUxMjk3NQ==", "bodyText": "These fields are non-existent when disabled or when we add a config with different authentication mechanism such as SASL. Could you push them down to the subtypes and make this class an interface?", "url": "https://github.com/line/armeria/pull/2496#discussion_r389512975", "createdAt": "2020-03-09T08:19:46Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.linecorp.armeria.client.proxy.NoopProxyConfig.NOOP_PROXY_CONFIG;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public abstract class ProxyConfig {\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyConfigBuilder socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyConfigBuilder(requireNonNull(proxyAddress));\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks5ProxyConfigBuilder socks5(InetSocketAddress proxyAddress) {\n+        return new Socks5ProxyConfigBuilder(requireNonNull(proxyAddress));\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static ConnectProxyConfigBuilder connect(InetSocketAddress proxyAddress) {\n+        return new ConnectProxyConfigBuilder(requireNonNull(proxyAddress));\n+    }\n+\n+    /**\n+     * Returns a {@code ProxyConfig} which signifies that proxy is disabled.\n+     */\n+    public static ProxyConfig noop() {\n+        return NOOP_PROXY_CONFIG;\n+    }\n+\n+    private final InetSocketAddress proxyAddress;\n+\n+    @Nullable\n+    private final String username;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUxMzA4OA==", "bodyText": "Missing final", "url": "https://github.com/line/armeria/pull/2496#discussion_r389513088", "createdAt": "2020-03-09T08:20:10Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/Socks5ProxyConfig.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+/**\n+ * Contains SOCKS5 proxy related configuration.\n+ */\n+public class Socks5ProxyConfig extends ProxyConfig {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUxMzQ1Mw==", "bodyText": "Missing final", "url": "https://github.com/line/armeria/pull/2496#discussion_r389513453", "createdAt": "2020-03-09T08:21:03Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+/**\n+ * Contains CONNECT proxy related configuration.\n+ */\n+public class ConnectProxyConfig extends ProxyConfig {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUxNDU5Mw==", "bodyText": "Alternatively, we could give up builder API and just add various factory methods:\npublic static Socks4ProxyConfig socks4(address);\npublic static Socks4ProxyConfig socks4(address, username);\npublic static Socks5ProxyConfig socks5(address);\npublic static Socks5ProxyConfig socks5(address, username, password);\npublic static ConnectProxyConfig connect(address);\npublic static ConnectProxyConfig connect(address, HttpHeaders?);", "url": "https://github.com/line/armeria/pull/2496#discussion_r389514593", "createdAt": "2020-03-09T08:24:04Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.linecorp.armeria.client.proxy.NoopProxyConfig.NOOP_PROXY_CONFIG;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public abstract class ProxyConfig {\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyConfigBuilder socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyConfigBuilder(requireNonNull(proxyAddress));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQ1OTcwNQ=="}, "originalCommit": {"oid": "488b63c211d63f50cf415a276fda2f21c2dfd421"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da68a913426228965dc8d70f07e52729f6bfe2f2", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/da68a913426228965dc8d70f07e52729f6bfe2f2", "committedDate": "2020-03-09T15:34:22Z", "message": "remove proxyConfigBuilder, noop to disabled, push down common var"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNjkwNTI1", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-371690525", "createdAt": "2020-03-10T05:33:15Z", "commit": {"oid": "da68a913426228965dc8d70f07e52729f6bfe2f2"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwNTozMzoxNVrOF0CAWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQwNTozNTo0NlrOF0CCkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMzEyOA==", "bodyText": "Returns the ...", "url": "https://github.com/line/armeria/pull/2496#discussion_r390103128", "createdAt": "2020-03-10T05:33:15Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java", "diffHunk": "@@ -25,18 +27,41 @@\n /**\n  * Contains CONNECT proxy related configuration.\n  */\n-public class ConnectProxyConfig extends ProxyConfig {\n+public final class ConnectProxyConfig extends ProxyConfig {\n+\n+    private final InetSocketAddress proxyAddress;\n+\n+    @Nullable\n+    private final String username;\n \n     @Nullable\n     private final String password;\n \n-    private final boolean useSsl;\n+    private final boolean useTls;\n \n     ConnectProxyConfig(InetSocketAddress proxyAddress, @Nullable String username,\n-                       @Nullable String password, boolean useSsl) {\n-        super(proxyAddress, username);\n+                       @Nullable String password, boolean useTls) {\n+        checkArgument((username == null && password == null) || (username != null && password != null),\n+                      \"Username and password must either both be null or non-null.\");\n+        this.proxyAddress = proxyAddress;\n+        this.username = username;\n         this.password = password;\n-        this.useSsl = useSsl;\n+        this.useTls = useTls;\n+    }\n+\n+    /**\n+     * The configured proxy address.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da68a913426228965dc8d70f07e52729f6bfe2f2"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMzE3Mg==", "bodyText": "Returns whether TLS is enabled", "url": "https://github.com/line/armeria/pull/2496#discussion_r390103172", "createdAt": "2020-03-10T05:33:29Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java", "diffHunk": "@@ -50,17 +75,17 @@ public String password() {\n     /**\n      * Whether ssl is enabled.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da68a913426228965dc8d70f07e52729f6bfe2f2"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMzIyMA==", "bodyText": "Returns the ...", "url": "https://github.com/line/armeria/pull/2496#discussion_r390103220", "createdAt": "2020-03-10T05:33:38Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java", "diffHunk": "@@ -25,18 +27,41 @@\n /**\n  * Contains CONNECT proxy related configuration.\n  */\n-public class ConnectProxyConfig extends ProxyConfig {\n+public final class ConnectProxyConfig extends ProxyConfig {\n+\n+    private final InetSocketAddress proxyAddress;\n+\n+    @Nullable\n+    private final String username;\n \n     @Nullable\n     private final String password;\n \n-    private final boolean useSsl;\n+    private final boolean useTls;\n \n     ConnectProxyConfig(InetSocketAddress proxyAddress, @Nullable String username,\n-                       @Nullable String password, boolean useSsl) {\n-        super(proxyAddress, username);\n+                       @Nullable String password, boolean useTls) {\n+        checkArgument((username == null && password == null) || (username != null && password != null),\n+                      \"Username and password must either both be null or non-null.\");\n+        this.proxyAddress = proxyAddress;\n+        this.username = username;\n         this.password = password;\n-        this.useSsl = useSsl;\n+        this.useTls = useTls;\n+    }\n+\n+    /**\n+     * The configured proxy address.\n+     */\n+    public InetSocketAddress proxyAddress() {\n+        return proxyAddress;\n+    }\n+\n+    /**\n+     * The configured username.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da68a913426228965dc8d70f07e52729f6bfe2f2"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMzMyNg==", "bodyText": "Please move down.", "url": "https://github.com/line/armeria/pull/2496#discussion_r390103326", "createdAt": "2020-03-10T05:34:07Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -16,83 +16,86 @@\n \n package com.linecorp.armeria.client.proxy;\n \n-import static com.linecorp.armeria.client.proxy.NoopProxyConfig.NOOP_PROXY_CONFIG;\n+import static com.linecorp.armeria.client.proxy.DisabledProxyConfig.DISABLED_PROXY_CONFIG;\n import static java.util.Objects.requireNonNull;\n \n import java.net.InetSocketAddress;\n \n import javax.annotation.Nullable;\n \n-import com.google.common.base.MoreObjects;\n-\n import com.linecorp.armeria.client.ClientFactory;\n \n /**\n  * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n  */\n public abstract class ProxyConfig {\n \n+    ProxyConfig() {\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da68a913426228965dc8d70f07e52729f6bfe2f2"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMzUyNg==", "bodyText": "Perhaps better making username non-null, given that we have the version that does not require username?", "url": "https://github.com/line/armeria/pull/2496#discussion_r390103526", "createdAt": "2020-03-10T05:35:03Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -16,83 +16,86 @@\n \n package com.linecorp.armeria.client.proxy;\n \n-import static com.linecorp.armeria.client.proxy.NoopProxyConfig.NOOP_PROXY_CONFIG;\n+import static com.linecorp.armeria.client.proxy.DisabledProxyConfig.DISABLED_PROXY_CONFIG;\n import static java.util.Objects.requireNonNull;\n \n import java.net.InetSocketAddress;\n \n import javax.annotation.Nullable;\n \n-import com.google.common.base.MoreObjects;\n-\n import com.linecorp.armeria.client.ClientFactory;\n \n /**\n  * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n  */\n public abstract class ProxyConfig {\n \n+    ProxyConfig() {\n+    }\n+\n     /**\n      * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n      * @param proxyAddress The proxy address.\n      */\n-    public static Socks4ProxyConfigBuilder socks4(InetSocketAddress proxyAddress) {\n-        return new Socks4ProxyConfigBuilder(requireNonNull(proxyAddress));\n+    public static Socks4ProxyConfig socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), null);\n     }\n \n     /**\n-     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n      * @param proxyAddress The proxy address.\n+     * @param username The user name.\n      */\n-    public static Socks5ProxyConfigBuilder socks5(InetSocketAddress proxyAddress) {\n-        return new Socks5ProxyConfigBuilder(requireNonNull(proxyAddress));\n+    public static Socks4ProxyConfig socks4(InetSocketAddress proxyAddress, @Nullable String username) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da68a913426228965dc8d70f07e52729f6bfe2f2"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMzYzNQ==", "bodyText": "Ditto - username and password could be non-null.", "url": "https://github.com/line/armeria/pull/2496#discussion_r390103635", "createdAt": "2020-03-10T05:35:30Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -16,83 +16,86 @@\n \n package com.linecorp.armeria.client.proxy;\n \n-import static com.linecorp.armeria.client.proxy.NoopProxyConfig.NOOP_PROXY_CONFIG;\n+import static com.linecorp.armeria.client.proxy.DisabledProxyConfig.DISABLED_PROXY_CONFIG;\n import static java.util.Objects.requireNonNull;\n \n import java.net.InetSocketAddress;\n \n import javax.annotation.Nullable;\n \n-import com.google.common.base.MoreObjects;\n-\n import com.linecorp.armeria.client.ClientFactory;\n \n /**\n  * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n  */\n public abstract class ProxyConfig {\n \n+    ProxyConfig() {\n+    }\n+\n     /**\n      * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n      * @param proxyAddress The proxy address.\n      */\n-    public static Socks4ProxyConfigBuilder socks4(InetSocketAddress proxyAddress) {\n-        return new Socks4ProxyConfigBuilder(requireNonNull(proxyAddress));\n+    public static Socks4ProxyConfig socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), null);\n     }\n \n     /**\n-     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n      * @param proxyAddress The proxy address.\n+     * @param username The user name.\n      */\n-    public static Socks5ProxyConfigBuilder socks5(InetSocketAddress proxyAddress) {\n-        return new Socks5ProxyConfigBuilder(requireNonNull(proxyAddress));\n+    public static Socks4ProxyConfig socks4(InetSocketAddress proxyAddress, @Nullable String username) {\n+        return new Socks4ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), username);\n     }\n \n     /**\n-     * Creates a {@code ProxyConfig} configuration for CONNECT protocol.\n+     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n      * @param proxyAddress The proxy address.\n      */\n-    public static ConnectProxyConfigBuilder connect(InetSocketAddress proxyAddress) {\n-        return new ConnectProxyConfigBuilder(requireNonNull(proxyAddress));\n+    public static Socks5ProxyConfig socks5(InetSocketAddress proxyAddress) {\n+        return new Socks5ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), null, null);\n     }\n \n     /**\n-     * Returns a {@code ProxyConfig} which signifies that proxy is disabled.\n+     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param username The user name.\n+     * @param password The password.\n      */\n-    public static ProxyConfig noop() {\n-        return NOOP_PROXY_CONFIG;\n-    }\n-\n-    private final InetSocketAddress proxyAddress;\n-\n-    @Nullable\n-    private final String username;\n-\n-    ProxyConfig(InetSocketAddress proxyAddress, @Nullable String username) {\n-        this.proxyAddress = proxyAddress;\n-        this.username = username;\n+    public static Socks5ProxyConfig socks5(\n+            InetSocketAddress proxyAddress, @Nullable String username, @Nullable String password) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da68a913426228965dc8d70f07e52729f6bfe2f2"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDEwMzY5Ng==", "bodyText": "Ditto - username and password could be non-null.", "url": "https://github.com/line/armeria/pull/2496#discussion_r390103696", "createdAt": "2020-03-10T05:35:46Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -16,83 +16,86 @@\n \n package com.linecorp.armeria.client.proxy;\n \n-import static com.linecorp.armeria.client.proxy.NoopProxyConfig.NOOP_PROXY_CONFIG;\n+import static com.linecorp.armeria.client.proxy.DisabledProxyConfig.DISABLED_PROXY_CONFIG;\n import static java.util.Objects.requireNonNull;\n \n import java.net.InetSocketAddress;\n \n import javax.annotation.Nullable;\n \n-import com.google.common.base.MoreObjects;\n-\n import com.linecorp.armeria.client.ClientFactory;\n \n /**\n  * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n  */\n public abstract class ProxyConfig {\n \n+    ProxyConfig() {\n+    }\n+\n     /**\n      * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n      * @param proxyAddress The proxy address.\n      */\n-    public static Socks4ProxyConfigBuilder socks4(InetSocketAddress proxyAddress) {\n-        return new Socks4ProxyConfigBuilder(requireNonNull(proxyAddress));\n+    public static Socks4ProxyConfig socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), null);\n     }\n \n     /**\n-     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n      * @param proxyAddress The proxy address.\n+     * @param username The user name.\n      */\n-    public static Socks5ProxyConfigBuilder socks5(InetSocketAddress proxyAddress) {\n-        return new Socks5ProxyConfigBuilder(requireNonNull(proxyAddress));\n+    public static Socks4ProxyConfig socks4(InetSocketAddress proxyAddress, @Nullable String username) {\n+        return new Socks4ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), username);\n     }\n \n     /**\n-     * Creates a {@code ProxyConfig} configuration for CONNECT protocol.\n+     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n      * @param proxyAddress The proxy address.\n      */\n-    public static ConnectProxyConfigBuilder connect(InetSocketAddress proxyAddress) {\n-        return new ConnectProxyConfigBuilder(requireNonNull(proxyAddress));\n+    public static Socks5ProxyConfig socks5(InetSocketAddress proxyAddress) {\n+        return new Socks5ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), null, null);\n     }\n \n     /**\n-     * Returns a {@code ProxyConfig} which signifies that proxy is disabled.\n+     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param username The user name.\n+     * @param password The password.\n      */\n-    public static ProxyConfig noop() {\n-        return NOOP_PROXY_CONFIG;\n-    }\n-\n-    private final InetSocketAddress proxyAddress;\n-\n-    @Nullable\n-    private final String username;\n-\n-    ProxyConfig(InetSocketAddress proxyAddress, @Nullable String username) {\n-        this.proxyAddress = proxyAddress;\n-        this.username = username;\n+    public static Socks5ProxyConfig socks5(\n+            InetSocketAddress proxyAddress, @Nullable String username, @Nullable String password) {\n+        return new Socks5ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), username, password);\n     }\n \n     /**\n-     * The proxy address.\n+     * Creates a {@code ProxyConfig} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n      */\n-    public InetSocketAddress proxyAddress() {\n-        return proxyAddress;\n+    public static ConnectProxyConfig connect(InetSocketAddress proxyAddress) {\n+        return new ConnectProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), null, null, false);\n     }\n \n     /**\n-     * The configured username.\n+     * Creates a {@code ProxyConfig} configuration for CONNECT protocol.\n+     * Username and password must both be null, or both be non-null.\n+     * @param proxyAddress The proxy address.\n+     * @param username The user name.\n+     * @param password The password.\n+     * @param useTls Whether to use TLS to connect to the proxy.\n      */\n-    @Nullable\n-    public String username() {\n-        return username;\n+    public static ConnectProxyConfig connect(\n+            InetSocketAddress proxyAddress, @Nullable String username, @Nullable String password,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da68a913426228965dc8d70f07e52729f6bfe2f2"}, "originalPosition": 105}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/d702870da5d3fa3609097f5daa97959fb6b645c2", "committedDate": "2020-03-10T13:53:05Z", "message": "move validation to factory method, start javadoc with verb"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "88d53471906b91781250fef3f56edac8133ea1d9", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/88d53471906b91781250fef3f56edac8133ea1d9", "committedDate": "2020-03-10T13:48:57Z", "message": "move validation to factory method, start javadoc with verb"}, "afterCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/d702870da5d3fa3609097f5daa97959fb6b645c2", "committedDate": "2020-03-10T13:53:05Z", "message": "move validation to factory method, start javadoc with verb"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTc2ODAx", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-371976801", "createdAt": "2020-03-10T14:00:18Z", "commit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDowMDoxOFrOF0QDEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDowMjoyMVrOF0QImQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMzMzIwMQ==", "bodyText": "netty-handler-proxy could be declared at implementation configuration? I know we need to move some other netty modules from api to implementation, but I thought this may be a good baby step.", "url": "https://github.com/line/armeria/pull/2496#discussion_r390333201", "createdAt": "2020-03-10T14:00:18Z", "author": {"login": "trustin"}, "path": "core/build.gradle", "diffHunk": "@@ -106,7 +106,7 @@ dependencies {\n     optionalApi 'io.prometheus:simpleclient_common'\n \n     // Netty\n-    [ 'netty-transport', 'netty-codec-http2', 'netty-codec-haproxy', 'netty-resolver-dns' ].each {\n+    [ 'netty-transport', 'netty-codec-http2', 'netty-codec-haproxy', 'netty-resolver-dns', 'netty-handler-proxy' ].each {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMzNDAxNQ==", "bodyText": "Could remove Contains and related from all ProxyConfig classes, i.e. CONNECT proxy configuration.", "url": "https://github.com/line/armeria/pull/2496#discussion_r390334015", "createdAt": "2020-03-10T14:01:30Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ConnectProxyConfig.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+/**\n+ * Contains CONNECT proxy related configuration.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMzNDYxNw==", "bodyText": "Base configuration for proxy settings used by {@link ClientFactory}", "url": "https://github.com/line/armeria/pull/2496#discussion_r390334617", "createdAt": "2020-03-10T14:02:21Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.linecorp.armeria.client.proxy.DisabledProxyConfig.DISABLED_PROXY_CONFIG;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMDQ4OTU0", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-372048954", "createdAt": "2020-03-10T15:14:17Z", "commit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNToxNDoxN1rOF0TiJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTozMzoyN1rOF0Ub8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM5MDMxMA==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                      .add(\"password\", password())\n          \n          \n            \n                                      .add(\"password\", \"****\")", "url": "https://github.com/line/armeria/pull/2496#discussion_r390390310", "createdAt": "2020-03-10T15:14:17Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/Socks5ProxyConfig.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.MoreObjects;\n+\n+/**\n+ * Contains SOCKS5 proxy related configuration.\n+ */\n+public final class Socks5ProxyConfig extends ProxyConfig {\n+\n+    private final InetSocketAddress proxyAddress;\n+\n+    @Nullable\n+    private final String username;\n+\n+    @Nullable\n+    private final String password;\n+\n+    Socks5ProxyConfig(InetSocketAddress proxyAddress, @Nullable String username,\n+                      @Nullable String password) {\n+        this.proxyAddress = proxyAddress;\n+        this.username = username;\n+        this.password = password;\n+    }\n+\n+    /**\n+     * Returns the configured proxy address.\n+     */\n+    public InetSocketAddress proxyAddress() {\n+        return proxyAddress;\n+    }\n+\n+    /**\n+     * Returns the configured username.\n+     */\n+    @Nullable\n+    public String username() {\n+        return username;\n+    }\n+\n+    /**\n+     * Returns the configured password.\n+     */\n+    @Nullable\n+    public String password() {\n+        return password;\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return MoreObjects.toStringHelper(this)\n+                          .add(\"proxyAddress\", proxyAddress())\n+                          .add(\"username\", username())\n+                          .add(\"password\", password())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQwNTEwNg==", "bodyText": "Just test code but how about?\nif (msg instanceof DefaultSocks4CommandRequest) {\n    ctx.channel().eventLoop().schedule(() -> ctx.fireChannelRead(msg), 50, TimeUnit.MILLISECONDS);\n} else {\n    ctx.fireChannelRead(msg);\n}", "url": "https://github.com/line/armeria/pull/2496#discussion_r390405106", "createdAt": "2020-03-10T15:33:27Z", "author": {"login": "ikhoon"}, "path": "core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,523 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.linecorp.armeria.common.HttpStatus.OK;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.awaitility.Awaitility.await;\n+\n+import java.net.ConnectException;\n+import java.net.InetSocketAddress;\n+import java.net.ServerSocket;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+\n+import javax.annotation.Nullable;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+import com.linecorp.armeria.client.UnprocessedRequestException;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.logging.LoggingClient;\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.ClosedSessionException;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.testing.DynamicBehaviorHandler;\n+import com.linecorp.armeria.internal.testing.NettyServerExtension;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.testing.junit.server.SelfSignedCertificateExtension;\n+import com.linecorp.armeria.testing.junit.server.ServerExtension;\n+\n+import io.netty.bootstrap.Bootstrap;\n+import io.netty.buffer.ByteBuf;\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelFuture;\n+import io.netty.channel.ChannelFutureListener;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelInboundHandlerAdapter;\n+import io.netty.channel.ChannelInitializer;\n+import io.netty.channel.SimpleChannelInboundHandler;\n+import io.netty.channel.socket.nio.NioSocketChannel;\n+import io.netty.handler.codec.http.DefaultFullHttpResponse;\n+import io.netty.handler.codec.http.FullHttpRequest;\n+import io.netty.handler.codec.http.HttpObjectAggregator;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.netty.handler.codec.http.HttpServerCodec;\n+import io.netty.handler.codec.http.HttpVersion;\n+import io.netty.handler.codec.socksx.SocksPortUnificationServerHandler;\n+import io.netty.handler.codec.socksx.v4.DefaultSocks4CommandRequest;\n+import io.netty.handler.codec.socksx.v4.DefaultSocks4CommandResponse;\n+import io.netty.handler.codec.socksx.v4.Socks4CommandStatus;\n+import io.netty.handler.codec.socksx.v4.Socks4Message;\n+import io.netty.handler.codec.socksx.v5.DefaultSocks5CommandRequest;\n+import io.netty.handler.codec.socksx.v5.DefaultSocks5CommandResponse;\n+import io.netty.handler.codec.socksx.v5.DefaultSocks5InitialRequest;\n+import io.netty.handler.codec.socksx.v5.DefaultSocks5InitialResponse;\n+import io.netty.handler.codec.socksx.v5.Socks5AddressType;\n+import io.netty.handler.codec.socksx.v5.Socks5AuthMethod;\n+import io.netty.handler.codec.socksx.v5.Socks5CommandRequestDecoder;\n+import io.netty.handler.codec.socksx.v5.Socks5CommandStatus;\n+import io.netty.handler.codec.socksx.v5.Socks5Message;\n+import io.netty.handler.logging.LoggingHandler;\n+import io.netty.handler.ssl.SslContext;\n+import io.netty.handler.ssl.SslContextBuilder;\n+import io.netty.util.ReferenceCountUtil;\n+\n+public class ProxyClientIntegrationTest {\n+    private static final String PROXY_PATH = \"/proxy\";\n+    private static final String SUCCESS_RESPONSE = \"success\";\n+\n+    private static final DynamicBehaviorHandler SOCKS_DYNAMIC_HANDLER = new DynamicBehaviorHandler();\n+\n+    @RegisterExtension\n+    @Order(0)\n+    static final SelfSignedCertificateExtension ssc = new SelfSignedCertificateExtension();\n+\n+    @RegisterExtension\n+    @Order(1)\n+    static ServerExtension backendServer = new ServerExtension() {\n+        @Override\n+        protected void configure(ServerBuilder sb) throws Exception {\n+            sb.port(0, SessionProtocol.HTTP);\n+            sb.service(PROXY_PATH, (ctx, req) -> HttpResponse.of(SUCCESS_RESPONSE));\n+        }\n+    };\n+\n+    @RegisterExtension\n+    @Order(2)\n+    static NettyServerExtension socksProxyServer = new NettyServerExtension() {\n+        @Override\n+        protected void configure(Channel ch) throws Exception {\n+            ch.pipeline().addLast(new LoggingHandler(getClass()));\n+            ch.pipeline().addLast(new SocksPortUnificationServerHandler());\n+            ch.pipeline().addLast(SOCKS_DYNAMIC_HANDLER);\n+            ch.pipeline().addLast(new Socks4ProxyServerHandler());\n+            ch.pipeline().addLast(new Socks5ProxyServerHandler());\n+            ch.pipeline().addLast(new IntermediaryProxyServerHandler(\"socks\"));\n+        }\n+    };\n+\n+    @RegisterExtension\n+    @Order(3)\n+    static NettyServerExtension httpProxyServer = new NettyServerExtension() {\n+        @Override\n+        protected void configure(Channel ch) throws Exception {\n+            ch.pipeline().addLast(new LoggingHandler(getClass()));\n+            ch.pipeline().addLast(new HttpServerCodec());\n+            ch.pipeline().addLast(new HttpObjectAggregator(1024));\n+            ch.pipeline().addLast(new HttpProxyServerHandler());\n+            ch.pipeline().addLast(new IntermediaryProxyServerHandler(\"http\"));\n+        }\n+    };\n+\n+    @RegisterExtension\n+    @Order(4)\n+    static NettyServerExtension httpsProxyServer = new NettyServerExtension() {\n+        @Override\n+        protected void configure(Channel ch) throws Exception {\n+            final SslContext sslContext = SslContextBuilder\n+                    .forServer(ssc.privateKey(), ssc.certificate()).build();\n+            ch.pipeline().addLast(new LoggingHandler(getClass()));\n+            ch.pipeline().addLast(sslContext.newHandler(ch.alloc()));\n+            ch.pipeline().addLast(new LoggingHandler(getClass()));\n+            ch.pipeline().addLast(new HttpServerCodec());\n+            ch.pipeline().addLast(new HttpObjectAggregator(1024));\n+            ch.pipeline().addLast(new HttpProxyServerHandler());\n+            ch.pipeline().addLast(new IntermediaryProxyServerHandler(\"http\"));\n+        }\n+    };\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        SOCKS_DYNAMIC_HANDLER.reset();\n+    }\n+\n+    @Test\n+    void testDisabledProxyBasicCase() throws Exception {\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(ProxyConfig.disabled()).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testSocks4BasicCase() throws Exception {\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testSocks5BasicCase() throws Exception {\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks5(socksProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testHttpProxyBasicCase() throws Exception {\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.connect(httpProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testHttpsProxyBasicCase() throws Exception {\n+        final ClientFactory clientFactory =\n+                ClientFactory.builder().tlsNoVerify().proxyConfig(\n+                        ProxyConfig.connect(httpsProxyServer.address(), true)).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testProxyWithH2C() throws Exception {\n+        final int numRequests = 5;\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H2C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+\n+        final List<CompletableFuture<AggregatedHttpResponse>> responseFutures = new ArrayList<>();\n+        for (int i = 0; i < numRequests; i++) {\n+            responseFutures.add(webClient.get(PROXY_PATH).aggregate());\n+        }\n+        await().until(() -> responseFutures.stream().allMatch(CompletableFuture::isDone));\n+        assertThat(responseFutures.stream().map(CompletableFuture::join))\n+                .allMatch(response -> response.contentUtf8().equals(SUCCESS_RESPONSE));\n+    }\n+\n+    @Test\n+    void testProxyWithUserName() throws Exception {\n+        final String username = \"username\";\n+        SOCKS_DYNAMIC_HANDLER.setChannelReadCustomizer((ctx, msg) -> {\n+            if (msg instanceof DefaultSocks4CommandRequest) {\n+                assertThat(username.equals(((DefaultSocks4CommandRequest) msg).userId()));\n+            }\n+            ctx.fireChannelRead(msg);\n+        });\n+\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address(), username)).build();\n+\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testProxy_protocolUpgrade_notSharableExceptionNotThrown() throws Exception {\n+        SOCKS_DYNAMIC_HANDLER.setWriteCustomizer((ctx, msg, promise) -> {\n+            ctx.write(new DefaultSocks4CommandResponse(Socks4CommandStatus.REJECTED_OR_FAILED), promise);\n+        });\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.HTTP, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        assertThatThrownBy(responseFuture::join).isInstanceOf(CompletionException.class)\n+                                                .hasCauseInstanceOf(ClosedSessionException.class);\n+    }\n+\n+    @Test\n+    void testProxy_connectionFailure_throwsException() throws Exception {\n+        final int unusedPort;\n+        try (ServerSocket ss = new ServerSocket(0)) {\n+            unusedPort = ss.getLocalPort();\n+        }\n+\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(new InetSocketAddress(\"127.0.0.1\", unusedPort))).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+\n+        assertThatThrownBy(responseFuture::join).isInstanceOf(CompletionException.class)\n+                                                .hasMessageContaining(\"Connection refused\")\n+                                                .hasCauseInstanceOf(UnprocessedRequestException.class)\n+                                                .hasRootCauseInstanceOf(ConnectException.class);\n+    }\n+\n+    @Test\n+    void testProxy_connectionTimeoutFailure_throwsException() throws Exception {\n+        SOCKS_DYNAMIC_HANDLER.setChannelReadCustomizer((ctx, msg) -> {\n+            if (msg instanceof DefaultSocks4CommandRequest) {\n+                Thread.sleep(50);\n+            }\n+            ctx.fireChannelRead(msg);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 324}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTAwOTU5", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-372100959", "createdAt": "2020-03-10T16:08:32Z", "commit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjowODozMlrOF0WDCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNjoyNjowNlrOF0W0RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQzMTQ5Nw==", "bodyText": "nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public interface ThrowingTriConsumer<A,B,C> {\n          \n          \n            \n                public interface ThrowingTriConsumer<A, B, C> {", "url": "https://github.com/line/armeria/pull/2496#discussion_r390431497", "createdAt": "2020-03-10T16:08:32Z", "author": {"login": "ikhoon"}, "path": "testing-internal/src/main/java/com/linecorp/armeria/internal/testing/DynamicBehaviorHandler.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.testing;\n+\n+import javax.annotation.Nullable;\n+\n+import io.netty.channel.ChannelDuplexHandler;\n+import io.netty.channel.ChannelHandler.Sharable;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelPromise;\n+\n+@Sharable\n+public class DynamicBehaviorHandler extends ChannelDuplexHandler {\n+\n+    @Nullable\n+    private volatile ThrowingBiConsumer<ChannelHandlerContext, Object> channelReadCustomizer;\n+    @Nullable\n+    private volatile ThrowingTriConsumer<ChannelHandlerContext, Object, ChannelPromise> writeCustomizer;\n+\n+    public void reset() {\n+        channelReadCustomizer = null;\n+        writeCustomizer = null;\n+    }\n+\n+    public void setChannelReadCustomizer(\n+            ThrowingBiConsumer<ChannelHandlerContext, Object> channelReadCustomizer) {\n+        this.channelReadCustomizer = channelReadCustomizer;\n+    }\n+\n+    public void setWriteCustomizer(\n+            ThrowingTriConsumer<ChannelHandlerContext, Object, ChannelPromise> writeCustomizer) {\n+        this.writeCustomizer = writeCustomizer;\n+    }\n+\n+    @Override\n+    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n+        final ThrowingBiConsumer<ChannelHandlerContext, Object> customizerRef = channelReadCustomizer;\n+        if (customizerRef != null) {\n+            customizerRef.accept(ctx, msg);\n+        } else {\n+            super.channelRead(ctx, msg);\n+        }\n+    }\n+\n+    @Override\n+    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {\n+        final ThrowingTriConsumer<ChannelHandlerContext, Object, ChannelPromise>\n+                customizerRef = writeCustomizer;\n+        if (customizerRef != null) {\n+            customizerRef.accept(ctx, msg, promise);\n+        } else {\n+            super.write(ctx, msg, promise);\n+        }\n+    }\n+\n+    @FunctionalInterface\n+    public interface ThrowingTriConsumer<A,B,C> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQzMTYxOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public interface ThrowingBiConsumer<A,B> {\n          \n          \n            \n                public interface ThrowingBiConsumer<A, B> {", "url": "https://github.com/line/armeria/pull/2496#discussion_r390431618", "createdAt": "2020-03-10T16:08:41Z", "author": {"login": "ikhoon"}, "path": "testing-internal/src/main/java/com/linecorp/armeria/internal/testing/DynamicBehaviorHandler.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.testing;\n+\n+import javax.annotation.Nullable;\n+\n+import io.netty.channel.ChannelDuplexHandler;\n+import io.netty.channel.ChannelHandler.Sharable;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelPromise;\n+\n+@Sharable\n+public class DynamicBehaviorHandler extends ChannelDuplexHandler {\n+\n+    @Nullable\n+    private volatile ThrowingBiConsumer<ChannelHandlerContext, Object> channelReadCustomizer;\n+    @Nullable\n+    private volatile ThrowingTriConsumer<ChannelHandlerContext, Object, ChannelPromise> writeCustomizer;\n+\n+    public void reset() {\n+        channelReadCustomizer = null;\n+        writeCustomizer = null;\n+    }\n+\n+    public void setChannelReadCustomizer(\n+            ThrowingBiConsumer<ChannelHandlerContext, Object> channelReadCustomizer) {\n+        this.channelReadCustomizer = channelReadCustomizer;\n+    }\n+\n+    public void setWriteCustomizer(\n+            ThrowingTriConsumer<ChannelHandlerContext, Object, ChannelPromise> writeCustomizer) {\n+        this.writeCustomizer = writeCustomizer;\n+    }\n+\n+    @Override\n+    public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n+        final ThrowingBiConsumer<ChannelHandlerContext, Object> customizerRef = channelReadCustomizer;\n+        if (customizerRef != null) {\n+            customizerRef.accept(ctx, msg);\n+        } else {\n+            super.channelRead(ctx, msg);\n+        }\n+    }\n+\n+    @Override\n+    public void write(ChannelHandlerContext ctx, Object msg, ChannelPromise promise) throws Exception {\n+        final ThrowingTriConsumer<ChannelHandlerContext, Object, ChannelPromise>\n+                customizerRef = writeCustomizer;\n+        if (customizerRef != null) {\n+            customizerRef.accept(ctx, msg, promise);\n+        } else {\n+            super.write(ctx, msg, promise);\n+        }\n+    }\n+\n+    @FunctionalInterface\n+    public interface ThrowingTriConsumer<A,B,C> {\n+        void accept(A a, B b, C c) throws Exception;\n+    }\n+\n+    @FunctionalInterface\n+    public interface ThrowingBiConsumer<A,B> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQzNDA3NA==", "bodyText": "Could be final?", "url": "https://github.com/line/armeria/pull/2496#discussion_r390434074", "createdAt": "2020-03-10T16:12:04Z", "author": {"login": "ikhoon"}, "path": "testing-internal/src/main/java/com/linecorp/armeria/internal/testing/NettyServerExtension.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.testing;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+\n+import com.linecorp.armeria.testing.junit.common.AbstractAllOrEachExtension;\n+\n+import io.netty.bootstrap.ServerBootstrap;\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelInitializer;\n+import io.netty.channel.EventLoopGroup;\n+import io.netty.channel.nio.NioEventLoopGroup;\n+import io.netty.channel.socket.nio.NioServerSocketChannel;\n+\n+public abstract class NettyServerExtension extends AbstractAllOrEachExtension {\n+\n+    private final EventLoopGroup bossGroup;\n+    private final EventLoopGroup workerGroup;\n+    @Nullable\n+    private Channel channel;\n+\n+    protected NettyServerExtension() {\n+        bossGroup = new NioEventLoopGroup(1);\n+        workerGroup = new NioEventLoopGroup(1);\n+    }\n+\n+    public InetSocketAddress address() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQzNjkxMw==", "bodyText": "nit: writeToBackendAndFlush() seems to be better for this method name. \ud83d\ude00", "url": "https://github.com/line/armeria/pull/2496#discussion_r390436913", "createdAt": "2020-03-10T16:16:06Z", "author": {"login": "ikhoon"}, "path": "core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,523 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.linecorp.armeria.common.HttpStatus.OK;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.awaitility.Awaitility.await;\n+\n+import java.net.ConnectException;\n+import java.net.InetSocketAddress;\n+import java.net.ServerSocket;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+\n+import javax.annotation.Nullable;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+import com.linecorp.armeria.client.UnprocessedRequestException;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.logging.LoggingClient;\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.ClosedSessionException;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.testing.DynamicBehaviorHandler;\n+import com.linecorp.armeria.internal.testing.NettyServerExtension;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.testing.junit.server.SelfSignedCertificateExtension;\n+import com.linecorp.armeria.testing.junit.server.ServerExtension;\n+\n+import io.netty.bootstrap.Bootstrap;\n+import io.netty.buffer.ByteBuf;\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelFuture;\n+import io.netty.channel.ChannelFutureListener;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelInboundHandlerAdapter;\n+import io.netty.channel.ChannelInitializer;\n+import io.netty.channel.SimpleChannelInboundHandler;\n+import io.netty.channel.socket.nio.NioSocketChannel;\n+import io.netty.handler.codec.http.DefaultFullHttpResponse;\n+import io.netty.handler.codec.http.FullHttpRequest;\n+import io.netty.handler.codec.http.HttpObjectAggregator;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.netty.handler.codec.http.HttpServerCodec;\n+import io.netty.handler.codec.http.HttpVersion;\n+import io.netty.handler.codec.socksx.SocksPortUnificationServerHandler;\n+import io.netty.handler.codec.socksx.v4.DefaultSocks4CommandRequest;\n+import io.netty.handler.codec.socksx.v4.DefaultSocks4CommandResponse;\n+import io.netty.handler.codec.socksx.v4.Socks4CommandStatus;\n+import io.netty.handler.codec.socksx.v4.Socks4Message;\n+import io.netty.handler.codec.socksx.v5.DefaultSocks5CommandRequest;\n+import io.netty.handler.codec.socksx.v5.DefaultSocks5CommandResponse;\n+import io.netty.handler.codec.socksx.v5.DefaultSocks5InitialRequest;\n+import io.netty.handler.codec.socksx.v5.DefaultSocks5InitialResponse;\n+import io.netty.handler.codec.socksx.v5.Socks5AddressType;\n+import io.netty.handler.codec.socksx.v5.Socks5AuthMethod;\n+import io.netty.handler.codec.socksx.v5.Socks5CommandRequestDecoder;\n+import io.netty.handler.codec.socksx.v5.Socks5CommandStatus;\n+import io.netty.handler.codec.socksx.v5.Socks5Message;\n+import io.netty.handler.logging.LoggingHandler;\n+import io.netty.handler.ssl.SslContext;\n+import io.netty.handler.ssl.SslContextBuilder;\n+import io.netty.util.ReferenceCountUtil;\n+\n+public class ProxyClientIntegrationTest {\n+    private static final String PROXY_PATH = \"/proxy\";\n+    private static final String SUCCESS_RESPONSE = \"success\";\n+\n+    private static final DynamicBehaviorHandler SOCKS_DYNAMIC_HANDLER = new DynamicBehaviorHandler();\n+\n+    @RegisterExtension\n+    @Order(0)\n+    static final SelfSignedCertificateExtension ssc = new SelfSignedCertificateExtension();\n+\n+    @RegisterExtension\n+    @Order(1)\n+    static ServerExtension backendServer = new ServerExtension() {\n+        @Override\n+        protected void configure(ServerBuilder sb) throws Exception {\n+            sb.port(0, SessionProtocol.HTTP);\n+            sb.service(PROXY_PATH, (ctx, req) -> HttpResponse.of(SUCCESS_RESPONSE));\n+        }\n+    };\n+\n+    @RegisterExtension\n+    @Order(2)\n+    static NettyServerExtension socksProxyServer = new NettyServerExtension() {\n+        @Override\n+        protected void configure(Channel ch) throws Exception {\n+            ch.pipeline().addLast(new LoggingHandler(getClass()));\n+            ch.pipeline().addLast(new SocksPortUnificationServerHandler());\n+            ch.pipeline().addLast(SOCKS_DYNAMIC_HANDLER);\n+            ch.pipeline().addLast(new Socks4ProxyServerHandler());\n+            ch.pipeline().addLast(new Socks5ProxyServerHandler());\n+            ch.pipeline().addLast(new IntermediaryProxyServerHandler(\"socks\"));\n+        }\n+    };\n+\n+    @RegisterExtension\n+    @Order(3)\n+    static NettyServerExtension httpProxyServer = new NettyServerExtension() {\n+        @Override\n+        protected void configure(Channel ch) throws Exception {\n+            ch.pipeline().addLast(new LoggingHandler(getClass()));\n+            ch.pipeline().addLast(new HttpServerCodec());\n+            ch.pipeline().addLast(new HttpObjectAggregator(1024));\n+            ch.pipeline().addLast(new HttpProxyServerHandler());\n+            ch.pipeline().addLast(new IntermediaryProxyServerHandler(\"http\"));\n+        }\n+    };\n+\n+    @RegisterExtension\n+    @Order(4)\n+    static NettyServerExtension httpsProxyServer = new NettyServerExtension() {\n+        @Override\n+        protected void configure(Channel ch) throws Exception {\n+            final SslContext sslContext = SslContextBuilder\n+                    .forServer(ssc.privateKey(), ssc.certificate()).build();\n+            ch.pipeline().addLast(new LoggingHandler(getClass()));\n+            ch.pipeline().addLast(sslContext.newHandler(ch.alloc()));\n+            ch.pipeline().addLast(new LoggingHandler(getClass()));\n+            ch.pipeline().addLast(new HttpServerCodec());\n+            ch.pipeline().addLast(new HttpObjectAggregator(1024));\n+            ch.pipeline().addLast(new HttpProxyServerHandler());\n+            ch.pipeline().addLast(new IntermediaryProxyServerHandler(\"http\"));\n+        }\n+    };\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        SOCKS_DYNAMIC_HANDLER.reset();\n+    }\n+\n+    @Test\n+    void testDisabledProxyBasicCase() throws Exception {\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(ProxyConfig.disabled()).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testSocks4BasicCase() throws Exception {\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testSocks5BasicCase() throws Exception {\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks5(socksProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testHttpProxyBasicCase() throws Exception {\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.connect(httpProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testHttpsProxyBasicCase() throws Exception {\n+        final ClientFactory clientFactory =\n+                ClientFactory.builder().tlsNoVerify().proxyConfig(\n+                        ProxyConfig.connect(httpsProxyServer.address(), true)).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testProxyWithH2C() throws Exception {\n+        final int numRequests = 5;\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H2C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+\n+        final List<CompletableFuture<AggregatedHttpResponse>> responseFutures = new ArrayList<>();\n+        for (int i = 0; i < numRequests; i++) {\n+            responseFutures.add(webClient.get(PROXY_PATH).aggregate());\n+        }\n+        await().until(() -> responseFutures.stream().allMatch(CompletableFuture::isDone));\n+        assertThat(responseFutures.stream().map(CompletableFuture::join))\n+                .allMatch(response -> response.contentUtf8().equals(SUCCESS_RESPONSE));\n+    }\n+\n+    @Test\n+    void testProxyWithUserName() throws Exception {\n+        final String username = \"username\";\n+        SOCKS_DYNAMIC_HANDLER.setChannelReadCustomizer((ctx, msg) -> {\n+            if (msg instanceof DefaultSocks4CommandRequest) {\n+                assertThat(username.equals(((DefaultSocks4CommandRequest) msg).userId()));\n+            }\n+            ctx.fireChannelRead(msg);\n+        });\n+\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address(), username)).build();\n+\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testProxy_protocolUpgrade_notSharableExceptionNotThrown() throws Exception {\n+        SOCKS_DYNAMIC_HANDLER.setWriteCustomizer((ctx, msg, promise) -> {\n+            ctx.write(new DefaultSocks4CommandResponse(Socks4CommandStatus.REJECTED_OR_FAILED), promise);\n+        });\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.HTTP, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        assertThatThrownBy(responseFuture::join).isInstanceOf(CompletionException.class)\n+                                                .hasCauseInstanceOf(ClosedSessionException.class);\n+    }\n+\n+    @Test\n+    void testProxy_connectionFailure_throwsException() throws Exception {\n+        final int unusedPort;\n+        try (ServerSocket ss = new ServerSocket(0)) {\n+            unusedPort = ss.getLocalPort();\n+        }\n+\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(new InetSocketAddress(\"127.0.0.1\", unusedPort))).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+\n+        assertThatThrownBy(responseFuture::join).isInstanceOf(CompletionException.class)\n+                                                .hasMessageContaining(\"Connection refused\")\n+                                                .hasCauseInstanceOf(UnprocessedRequestException.class)\n+                                                .hasRootCauseInstanceOf(ConnectException.class);\n+    }\n+\n+    @Test\n+    void testProxy_connectionTimeoutFailure_throwsException() throws Exception {\n+        SOCKS_DYNAMIC_HANDLER.setChannelReadCustomizer((ctx, msg) -> {\n+            if (msg instanceof DefaultSocks4CommandRequest) {\n+                Thread.sleep(50);\n+            }\n+            ctx.fireChannelRead(msg);\n+        });\n+\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address())).connectTimeoutMillis(1).build();\n+\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+\n+        assertThatThrownBy(responseFuture::join).isInstanceOf(CompletionException.class)\n+                                                .hasCauseInstanceOf(ClosedSessionException.class);\n+    }\n+\n+    @Test\n+    void testProxy_responseFailure_throwsException() throws Exception {\n+        SOCKS_DYNAMIC_HANDLER.setWriteCustomizer((ctx, msg, promise) -> {\n+            ctx.write(new DefaultSocks4CommandResponse(Socks4CommandStatus.REJECTED_OR_FAILED), promise);\n+        });\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+\n+        assertThatThrownBy(responseFuture::join).isInstanceOf(CompletionException.class)\n+                                                .hasCauseInstanceOf(ClosedSessionException.class);\n+    }\n+\n+    static class ProxySuccessEvent {\n+        private final InetSocketAddress backendAddress;\n+        private final Object response;\n+\n+        ProxySuccessEvent(InetSocketAddress backendAddress, Object response) {\n+            this.backendAddress = backendAddress;\n+            this.response = response;\n+        }\n+\n+        public Object getResponse() {\n+            return response;\n+        }\n+\n+        public InetSocketAddress getBackendAddress() {\n+            return backendAddress;\n+        }\n+    }\n+\n+    private static class Socks5ProxyServerHandler extends SimpleChannelInboundHandler<Socks5Message> {\n+        @Override\n+        protected void channelRead0(ChannelHandlerContext ctx, Socks5Message msg) throws Exception {\n+            if (msg instanceof DefaultSocks5InitialRequest) {\n+                ctx.pipeline().addBefore(ctx.name(), Socks5CommandRequestDecoder.class.getName(),\n+                                         new Socks5CommandRequestDecoder());\n+                ctx.writeAndFlush(new DefaultSocks5InitialResponse(Socks5AuthMethod.NO_AUTH));\n+            } else if (msg instanceof DefaultSocks5CommandRequest) {\n+                final DefaultSocks5CommandRequest req = (DefaultSocks5CommandRequest) msg;\n+                ctx.pipeline().remove(Socks5CommandRequestDecoder.class);\n+                ctx.fireUserEventTriggered(new ProxySuccessEvent(\n+                        new InetSocketAddress(req.dstAddr(), req.dstPort()),\n+                        new DefaultSocks5CommandResponse(Socks5CommandStatus.SUCCESS,\n+                                                         Socks5AddressType.IPv4)));\n+            } else {\n+                throw new IllegalStateException(\"unexpected msg: \" + msg);\n+            }\n+        }\n+    }\n+\n+    private static class Socks4ProxyServerHandler extends SimpleChannelInboundHandler<Socks4Message> {\n+        @Override\n+        protected void channelRead0(ChannelHandlerContext ctx, Socks4Message msg) throws Exception {\n+            if (msg instanceof DefaultSocks4CommandRequest) {\n+                final DefaultSocks4CommandRequest req = (DefaultSocks4CommandRequest) msg;\n+                final DefaultSocks4CommandResponse response;\n+                response = new DefaultSocks4CommandResponse(Socks4CommandStatus.SUCCESS);\n+                ctx.fireUserEventTriggered(new ProxySuccessEvent(\n+                        new InetSocketAddress(req.dstAddr(), req.dstPort()), response));\n+            } else {\n+                throw new IllegalStateException(\"unexpected msg: \" + msg);\n+            }\n+        }\n+    }\n+\n+    private static class HttpProxyServerHandler extends SimpleChannelInboundHandler<FullHttpRequest> {\n+        @Override\n+        protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest msg) throws Exception {\n+            final String uri = msg.uri();\n+            final String[] split = uri.split(\":\");\n+            checkArgument(split.length == 2, \"invalid destination url\");\n+\n+            ctx.fireUserEventTriggered(new ProxySuccessEvent(\n+                    new InetSocketAddress(split[0], Integer.parseInt(split[1])),\n+                    new DefaultFullHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK)));\n+        }\n+    }\n+\n+    private static final class IntermediaryProxyServerHandler extends ChannelInboundHandlerAdapter {\n+        private final ConcurrentLinkedDeque<ByteBuf> received = new ConcurrentLinkedDeque<>();\n+        @Nullable\n+        private Channel backend;\n+        private final String proxyType;\n+\n+        private IntermediaryProxyServerHandler(String proxyType) {\n+            this.proxyType = proxyType;\n+        }\n+\n+        @Override\n+        public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {\n+            if (evt instanceof ProxySuccessEvent) {\n+                connectBackend(ctx, ((ProxySuccessEvent) evt).getBackendAddress()).addListener(f -> {\n+                    if (f.isSuccess()) {\n+                        ctx.writeAndFlush(((ProxySuccessEvent) evt).getResponse());\n+                        if (\"http\".equals(proxyType)) {\n+                            ctx.pipeline().remove(HttpObjectAggregator.class);\n+                            ctx.pipeline().remove(HttpServerCodec.class);\n+                        }\n+                    } else {\n+                        ctx.close();\n+                    }\n+                });\n+            }\n+        }\n+\n+        @Override\n+        public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n+            if (msg instanceof ByteBuf) {\n+                final ByteBuf backendMessage = ReferenceCountUtil.retain((ByteBuf) msg);\n+                received.add(backendMessage);\n+                flush();\n+            } else {\n+                throw new IllegalStateException(\"unexpected msg: \" + msg);\n+            }\n+        }\n+\n+        @Override\n+        public void channelInactive(ChannelHandlerContext ctx) throws Exception {\n+            if (backend != null) {\n+                backend.close();\n+            }\n+            super.channelInactive(ctx);\n+        }\n+\n+        private ChannelFuture connectBackend(\n+                final ChannelHandlerContext ctx, InetSocketAddress backendAddress) {\n+            final ChannelHandlerContext clientCtx = ctx;\n+            final Bootstrap b = new Bootstrap();\n+            b.group(ctx.channel().eventLoop());\n+            b.channel(NioSocketChannel.class);\n+            b.handler(new ChannelInitializer<Channel>() {\n+                @Override\n+                protected void initChannel(Channel ch) throws Exception {\n+                    ch.pipeline().addLast(new LoggingHandler());\n+                    ch.pipeline().addLast(new ChannelInboundHandlerAdapter() {\n+                        @Override\n+                        public void channelRead(ChannelHandlerContext ctx, Object msg)\n+                                throws Exception {\n+                            clientCtx.writeAndFlush(msg);\n+                        }\n+\n+                        @Override\n+                        public void channelInactive(ChannelHandlerContext ctx) throws Exception {\n+                            clientCtx.close();\n+                            super.channelInactive(ctx);\n+                        }\n+                    });\n+                }\n+            });\n+            return b.connect(backendAddress).addListener((ChannelFutureListener) f -> {\n+                if (!f.isSuccess()) {\n+                    clientCtx.close();\n+                    return;\n+                }\n+                backend = f.channel();\n+                flush();\n+            });\n+        }\n+\n+        private void flush() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 506}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ0NDEwMQ==", "bodyText": "nit: Indent for readability\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n          \n          \n            \n                            ProxyConfig.socks4(socksProxyServer.address(), username)).build();\n          \n          \n            \n                    final ClientFactory clientFactory =\n          \n          \n            \n                            ClientFactory.builder()\n          \n          \n            \n                                         .proxyConfig(ProxyConfig.socks4(socksProxyServer.address(), username))\n          \n          \n            \n                                         .build();", "url": "https://github.com/line/armeria/pull/2496#discussion_r390444101", "createdAt": "2020-03-10T16:26:06Z", "author": {"login": "ikhoon"}, "path": "core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java", "diffHunk": "@@ -0,0 +1,523 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.linecorp.armeria.common.HttpStatus.OK;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.awaitility.Awaitility.await;\n+\n+import java.net.ConnectException;\n+import java.net.InetSocketAddress;\n+import java.net.ServerSocket;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ConcurrentLinkedDeque;\n+\n+import javax.annotation.Nullable;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Order;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+import com.linecorp.armeria.client.UnprocessedRequestException;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.logging.LoggingClient;\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.ClosedSessionException;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.testing.DynamicBehaviorHandler;\n+import com.linecorp.armeria.internal.testing.NettyServerExtension;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.testing.junit.server.SelfSignedCertificateExtension;\n+import com.linecorp.armeria.testing.junit.server.ServerExtension;\n+\n+import io.netty.bootstrap.Bootstrap;\n+import io.netty.buffer.ByteBuf;\n+import io.netty.channel.Channel;\n+import io.netty.channel.ChannelFuture;\n+import io.netty.channel.ChannelFutureListener;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelInboundHandlerAdapter;\n+import io.netty.channel.ChannelInitializer;\n+import io.netty.channel.SimpleChannelInboundHandler;\n+import io.netty.channel.socket.nio.NioSocketChannel;\n+import io.netty.handler.codec.http.DefaultFullHttpResponse;\n+import io.netty.handler.codec.http.FullHttpRequest;\n+import io.netty.handler.codec.http.HttpObjectAggregator;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.netty.handler.codec.http.HttpServerCodec;\n+import io.netty.handler.codec.http.HttpVersion;\n+import io.netty.handler.codec.socksx.SocksPortUnificationServerHandler;\n+import io.netty.handler.codec.socksx.v4.DefaultSocks4CommandRequest;\n+import io.netty.handler.codec.socksx.v4.DefaultSocks4CommandResponse;\n+import io.netty.handler.codec.socksx.v4.Socks4CommandStatus;\n+import io.netty.handler.codec.socksx.v4.Socks4Message;\n+import io.netty.handler.codec.socksx.v5.DefaultSocks5CommandRequest;\n+import io.netty.handler.codec.socksx.v5.DefaultSocks5CommandResponse;\n+import io.netty.handler.codec.socksx.v5.DefaultSocks5InitialRequest;\n+import io.netty.handler.codec.socksx.v5.DefaultSocks5InitialResponse;\n+import io.netty.handler.codec.socksx.v5.Socks5AddressType;\n+import io.netty.handler.codec.socksx.v5.Socks5AuthMethod;\n+import io.netty.handler.codec.socksx.v5.Socks5CommandRequestDecoder;\n+import io.netty.handler.codec.socksx.v5.Socks5CommandStatus;\n+import io.netty.handler.codec.socksx.v5.Socks5Message;\n+import io.netty.handler.logging.LoggingHandler;\n+import io.netty.handler.ssl.SslContext;\n+import io.netty.handler.ssl.SslContextBuilder;\n+import io.netty.util.ReferenceCountUtil;\n+\n+public class ProxyClientIntegrationTest {\n+    private static final String PROXY_PATH = \"/proxy\";\n+    private static final String SUCCESS_RESPONSE = \"success\";\n+\n+    private static final DynamicBehaviorHandler SOCKS_DYNAMIC_HANDLER = new DynamicBehaviorHandler();\n+\n+    @RegisterExtension\n+    @Order(0)\n+    static final SelfSignedCertificateExtension ssc = new SelfSignedCertificateExtension();\n+\n+    @RegisterExtension\n+    @Order(1)\n+    static ServerExtension backendServer = new ServerExtension() {\n+        @Override\n+        protected void configure(ServerBuilder sb) throws Exception {\n+            sb.port(0, SessionProtocol.HTTP);\n+            sb.service(PROXY_PATH, (ctx, req) -> HttpResponse.of(SUCCESS_RESPONSE));\n+        }\n+    };\n+\n+    @RegisterExtension\n+    @Order(2)\n+    static NettyServerExtension socksProxyServer = new NettyServerExtension() {\n+        @Override\n+        protected void configure(Channel ch) throws Exception {\n+            ch.pipeline().addLast(new LoggingHandler(getClass()));\n+            ch.pipeline().addLast(new SocksPortUnificationServerHandler());\n+            ch.pipeline().addLast(SOCKS_DYNAMIC_HANDLER);\n+            ch.pipeline().addLast(new Socks4ProxyServerHandler());\n+            ch.pipeline().addLast(new Socks5ProxyServerHandler());\n+            ch.pipeline().addLast(new IntermediaryProxyServerHandler(\"socks\"));\n+        }\n+    };\n+\n+    @RegisterExtension\n+    @Order(3)\n+    static NettyServerExtension httpProxyServer = new NettyServerExtension() {\n+        @Override\n+        protected void configure(Channel ch) throws Exception {\n+            ch.pipeline().addLast(new LoggingHandler(getClass()));\n+            ch.pipeline().addLast(new HttpServerCodec());\n+            ch.pipeline().addLast(new HttpObjectAggregator(1024));\n+            ch.pipeline().addLast(new HttpProxyServerHandler());\n+            ch.pipeline().addLast(new IntermediaryProxyServerHandler(\"http\"));\n+        }\n+    };\n+\n+    @RegisterExtension\n+    @Order(4)\n+    static NettyServerExtension httpsProxyServer = new NettyServerExtension() {\n+        @Override\n+        protected void configure(Channel ch) throws Exception {\n+            final SslContext sslContext = SslContextBuilder\n+                    .forServer(ssc.privateKey(), ssc.certificate()).build();\n+            ch.pipeline().addLast(new LoggingHandler(getClass()));\n+            ch.pipeline().addLast(sslContext.newHandler(ch.alloc()));\n+            ch.pipeline().addLast(new LoggingHandler(getClass()));\n+            ch.pipeline().addLast(new HttpServerCodec());\n+            ch.pipeline().addLast(new HttpObjectAggregator(1024));\n+            ch.pipeline().addLast(new HttpProxyServerHandler());\n+            ch.pipeline().addLast(new IntermediaryProxyServerHandler(\"http\"));\n+        }\n+    };\n+\n+    @BeforeEach\n+    void beforeEach() {\n+        SOCKS_DYNAMIC_HANDLER.reset();\n+    }\n+\n+    @Test\n+    void testDisabledProxyBasicCase() throws Exception {\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(ProxyConfig.disabled()).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testSocks4BasicCase() throws Exception {\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testSocks5BasicCase() throws Exception {\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks5(socksProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testHttpProxyBasicCase() throws Exception {\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.connect(httpProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testHttpsProxyBasicCase() throws Exception {\n+        final ClientFactory clientFactory =\n+                ClientFactory.builder().tlsNoVerify().proxyConfig(\n+                        ProxyConfig.connect(httpsProxyServer.address(), true)).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H1C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+        final CompletableFuture<AggregatedHttpResponse> responseFuture =\n+                webClient.get(PROXY_PATH).aggregate();\n+        final AggregatedHttpResponse response = responseFuture.join();\n+        assertThat(response.status()).isEqualByComparingTo(OK);\n+        assertThat(response.contentUtf8()).isEqualTo(SUCCESS_RESPONSE);\n+    }\n+\n+    @Test\n+    void testProxyWithH2C() throws Exception {\n+        final int numRequests = 5;\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address())).build();\n+        final WebClient webClient = WebClient.builder(SessionProtocol.H2C, backendServer.httpEndpoint())\n+                                             .factory(clientFactory)\n+                                             .decorator(LoggingClient.newDecorator())\n+                                             .build();\n+\n+        final List<CompletableFuture<AggregatedHttpResponse>> responseFutures = new ArrayList<>();\n+        for (int i = 0; i < numRequests; i++) {\n+            responseFutures.add(webClient.get(PROXY_PATH).aggregate());\n+        }\n+        await().until(() -> responseFutures.stream().allMatch(CompletableFuture::isDone));\n+        assertThat(responseFutures.stream().map(CompletableFuture::join))\n+                .allMatch(response -> response.contentUtf8().equals(SUCCESS_RESPONSE));\n+    }\n+\n+    @Test\n+    void testProxyWithUserName() throws Exception {\n+        final String username = \"username\";\n+        SOCKS_DYNAMIC_HANDLER.setChannelReadCustomizer((ctx, msg) -> {\n+            if (msg instanceof DefaultSocks4CommandRequest) {\n+                assertThat(username.equals(((DefaultSocks4CommandRequest) msg).userId()));\n+            }\n+            ctx.fireChannelRead(msg);\n+        });\n+\n+        final ClientFactory clientFactory = ClientFactory.builder().proxyConfig(\n+                ProxyConfig.socks4(socksProxyServer.address(), username)).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 266}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTM1ODA2", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-371935806", "createdAt": "2020-03-10T13:12:15Z", "commit": {"oid": "da68a913426228965dc8d70f07e52729f6bfe2f2"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzoxMjoxNVrOF0OGyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwMjoyNDowNFrOF0nOww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMwMTM4Ng==", "bodyText": "Could just add isDisabled method to ProxyConfig and returns true in DisabledProxyConfig.", "url": "https://github.com/line/armeria/pull/2496#discussion_r390301386", "createdAt": "2020-03-10T13:12:15Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -118,6 +128,41 @@ protected void initChannel(Channel ch) throws Exception {\n                                                       .get(ChannelOption.CONNECT_TIMEOUT_MILLIS);\n     }\n \n+    private void configureProxy(Channel ch, ProxyConfig proxyConfig, SslContext sslCtx) {\n+        if (proxyConfig instanceof DisabledProxyConfig) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da68a913426228965dc8d70f07e52729f6bfe2f2"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcxMjUwMg==", "bodyText": "Let's remove public here then.", "url": "https://github.com/line/armeria/pull/2496#discussion_r390712502", "createdAt": "2020-03-11T02:21:54Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/DisabledProxyConfig.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import com.google.common.base.MoreObjects;\n+\n+/**\n+ * Represents client-side proxy is disabled.\n+ */\n+public final class DisabledProxyConfig extends ProxyConfig {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcxMjY5Nw==", "bodyText": "Let's add an empty line before the parameter description.", "url": "https://github.com/line/armeria/pull/2496#discussion_r390712697", "createdAt": "2020-03-11T02:22:45Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.linecorp.armeria.client.proxy.DisabledProxyConfig.DISABLED_PROXY_CONFIG;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public abstract class ProxyConfig {\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDcxMzAyNw==", "bodyText": "This class doesn't have any implementation. How about making this as an interface?", "url": "https://github.com/line/armeria/pull/2496#discussion_r390713027", "createdAt": "2020-03-11T02:24:04Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.linecorp.armeria.client.proxy.DisabledProxyConfig.DISABLED_PROXY_CONFIG;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+\n+/**\n+ * Contains base configuration for proxy related settings used in {@link ClientFactory}.\n+ */\n+public abstract class ProxyConfig {\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyConfig socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), null);\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param username The username.\n+     */\n+    public static Socks4ProxyConfig socks4(InetSocketAddress proxyAddress, String username) {\n+        return new Socks4ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"),\n+                                     requireNonNull(username, \"username\"));\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks5ProxyConfig socks5(InetSocketAddress proxyAddress) {\n+        return new Socks5ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), null, null);\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param username The username.\n+     * @param password The password.\n+     */\n+    public static Socks5ProxyConfig socks5(\n+            InetSocketAddress proxyAddress, String username, String password) {\n+        return new Socks5ProxyConfig(\n+                requireNonNull(proxyAddress, \"proxyAddress\"), requireNonNull(username, \"username\"),\n+                requireNonNull(password, \"password\"));\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static ConnectProxyConfig connect(InetSocketAddress proxyAddress) {\n+        return new ConnectProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), null, null, false);\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param useTls Whether to use TLS to connect to the proxy.\n+     */\n+    public static ConnectProxyConfig connect(\n+            InetSocketAddress proxyAddress, boolean useTls) {\n+        return new ConnectProxyConfig(\n+                requireNonNull(proxyAddress, \"proxyAddress\"), null, null, useTls);\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for CONNECT protocol.\n+     * @param proxyAddress The proxy address.\n+     * @param username The username.\n+     * @param password The password.\n+     * @param useTls Whether to use TLS to connect to the proxy.\n+     */\n+    public static ConnectProxyConfig connect(\n+            InetSocketAddress proxyAddress, String username, String password, boolean useTls) {\n+        return new ConnectProxyConfig(\n+                requireNonNull(proxyAddress, \"proxyAddress\"), requireNonNull(username, \"username\"),\n+                requireNonNull(password, \"password\"), useTls);\n+    }\n+\n+    /**\n+     * Returns a {@code ProxyConfig} which signifies that proxy is disabled.\n+     */\n+    public static ProxyConfig disabled() {\n+        return DISABLED_PROXY_CONFIG;\n+    }\n+\n+    ProxyConfig() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d702870da5d3fa3609097f5daa97959fb6b645c2"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f34fee642f55e1e6948ad91fa83e2213067983d2", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/f34fee642f55e1e6948ad91fa83e2213067983d2", "committedDate": "2020-03-11T14:50:04Z", "message": "improve javadocs, better styling for test, mask password"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89f8dfd6faa469d4016804a2414bb21ff2ab759b", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/89f8dfd6faa469d4016804a2414bb21ff2ab759b", "committedDate": "2020-03-11T14:50:31Z", "message": "try re-introducing proxyType"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9fb28b5ae6635dc0fef077026abbcb9508ea4179", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/9fb28b5ae6635dc0fef077026abbcb9508ea4179", "committedDate": "2020-03-11T14:37:23Z", "message": "try re-introducing proxyType"}, "afterCommit": {"oid": "89f8dfd6faa469d4016804a2414bb21ff2ab759b", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/89f8dfd6faa469d4016804a2414bb21ff2ab759b", "committedDate": "2020-03-11T14:50:31Z", "message": "try re-introducing proxyType"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjMxODYw", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-373231860", "createdAt": "2020-03-12T01:50:05Z", "commit": {"oid": "89f8dfd6faa469d4016804a2414bb21ff2ab759b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwMTo1MDowNVrOF1O0rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwMTo1MDowNVrOF1O0rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM2MTcxMA==", "bodyText": "nit but global comment:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param proxyAddress The proxy address.\n          \n          \n            \n                 * @param proxyAddress the proxy address", "url": "https://github.com/line/armeria/pull/2496#discussion_r391361710", "createdAt": "2020-03-12T01:50:05Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.linecorp.armeria.client.proxy.DisabledProxyConfig.DISABLED_PROXY_CONFIG;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+\n+/**\n+ * Base configuration for proxy settings used by {@link ClientFactory}.\n+ */\n+public abstract class ProxyConfig {\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n+     *\n+     * @param proxyAddress The proxy address.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89f8dfd6faa469d4016804a2414bb21ff2ab759b"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjM0MTc3", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-373234177", "createdAt": "2020-03-12T01:59:11Z", "commit": {"oid": "89f8dfd6faa469d4016804a2414bb21ff2ab759b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwMTo1OToxMVrOF1O8kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwMTo1OToxMVrOF1O8kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM2MzczMA==", "bodyText": "How about always returning **** regardless of whether the value is null or not? Since it can hide that the password is null.", "url": "https://github.com/line/armeria/pull/2496#discussion_r391363730", "createdAt": "2020-03-12T01:59:11Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.proxy;\n+\n+import static com.linecorp.armeria.client.proxy.DisabledProxyConfig.DISABLED_PROXY_CONFIG;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.InetSocketAddress;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.ClientFactory;\n+\n+/**\n+ * Base configuration for proxy settings used by {@link ClientFactory}.\n+ */\n+public abstract class ProxyConfig {\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n+     *\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks4ProxyConfig socks4(InetSocketAddress proxyAddress) {\n+        return new Socks4ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), null);\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS4 protocol.\n+     *\n+     * @param proxyAddress The proxy address.\n+     * @param username The username.\n+     */\n+    public static Socks4ProxyConfig socks4(InetSocketAddress proxyAddress, String username) {\n+        return new Socks4ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"),\n+                                     requireNonNull(username, \"username\"));\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n+     *\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static Socks5ProxyConfig socks5(InetSocketAddress proxyAddress) {\n+        return new Socks5ProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), null, null);\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for SOCKS5 protocol.\n+     *\n+     * @param proxyAddress The proxy address.\n+     * @param username The username.\n+     * @param password The password.\n+     */\n+    public static Socks5ProxyConfig socks5(\n+            InetSocketAddress proxyAddress, String username, String password) {\n+        return new Socks5ProxyConfig(\n+                requireNonNull(proxyAddress, \"proxyAddress\"), requireNonNull(username, \"username\"),\n+                requireNonNull(password, \"password\"));\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for CONNECT protocol.\n+     *\n+     * @param proxyAddress The proxy address.\n+     */\n+    public static ConnectProxyConfig connect(InetSocketAddress proxyAddress) {\n+        return new ConnectProxyConfig(requireNonNull(proxyAddress, \"proxyAddress\"), null, null, false);\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for CONNECT protocol.\n+     *\n+     * @param proxyAddress The proxy address.\n+     * @param useTls Whether to use TLS to connect to the proxy.\n+     */\n+    public static ConnectProxyConfig connect(\n+            InetSocketAddress proxyAddress, boolean useTls) {\n+        return new ConnectProxyConfig(\n+                requireNonNull(proxyAddress, \"proxyAddress\"), null, null, useTls);\n+    }\n+\n+    /**\n+     * Creates a {@code ProxyConfig} configuration for CONNECT protocol.\n+     *\n+     * @param proxyAddress The proxy address.\n+     * @param username The username.\n+     * @param password The password.\n+     * @param useTls Whether to use TLS to connect to the proxy.\n+     */\n+    public static ConnectProxyConfig connect(\n+            InetSocketAddress proxyAddress, String username, String password, boolean useTls) {\n+        return new ConnectProxyConfig(\n+                requireNonNull(proxyAddress, \"proxyAddress\"), requireNonNull(username, \"username\"),\n+                requireNonNull(password, \"password\"), useTls);\n+    }\n+\n+    /**\n+     * Returns a {@code ProxyConfig} which signifies that proxy is disabled.\n+     */\n+    public static ProxyConfig disabled() {\n+        return DISABLED_PROXY_CONFIG;\n+    }\n+\n+    @Nullable\n+    static String maskedStr(@Nullable String value) {\n+        return value == null ? null : \"****\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89f8dfd6faa469d4016804a2414bb21ff2ab759b"}, "originalPosition": 121}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNDY2Nzc0", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-373466774", "createdAt": "2020-03-12T11:15:03Z", "commit": {"oid": "89f8dfd6faa469d4016804a2414bb21ff2ab759b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMToxNTowM1rOF1ab5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMToxNTowM1rOF1ab5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU1MTk3Mg==", "bodyText": "How about renaming to ProxyConfig.direct() and DirectProxyConfig, given that JDK uses DIRECT?", "url": "https://github.com/line/armeria/pull/2496#discussion_r391551972", "createdAt": "2020-03-12T11:15:03Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryOption.java", "diffHunk": "@@ -214,6 +215,12 @@\n     public static final ClientFactoryOption<MeterRegistry> METER_REGISTRY =\n             define(\"METER_REGISTRY\", Metrics.globalRegistry);\n \n+    /**\n+     * The {@link ProxyConfig} which contains proxy related configuration.\n+     */\n+    public static final ClientFactoryOption<ProxyConfig> PROXY_CONFIG =\n+            define(\"PROXY_CONFIG\", ProxyConfig.disabled());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89f8dfd6faa469d4016804a2414bb21ff2ab759b"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46fda6ab55c268d2fb24c1ea37bd5e707ddcf5cb", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/46fda6ab55c268d2fb24c1ea37bd5e707ddcf5cb", "committedDate": "2020-03-12T14:07:18Z", "message": "rename disabled to direct, mask pw unconditionally, javadoc param style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MDAxMTQx", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-374001141", "createdAt": "2020-03-13T01:51:02Z", "commit": {"oid": "46fda6ab55c268d2fb24c1ea37bd5e707ddcf5cb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMTo1MTowMlrOF11LxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMTo1MTowMlrOF11LxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk5MDIxMg==", "bodyText": "How about reviving this and using omitNullValues() for ToStringHelper? Showing **** for a non-existent password may give a user a misconception that authentication is enabled.", "url": "https://github.com/line/armeria/pull/2496#discussion_r391990212", "createdAt": "2020-03-13T01:51:02Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/proxy/ProxyConfig.java", "diffHunk": "@@ -110,15 +108,10 @@ public static ConnectProxyConfig connect(\n     }\n \n     /**\n-     * Returns a {@code ProxyConfig} which signifies that proxy is disabled.\n+     * Returns a {@code ProxyConfig} which signifies that a proxy is absent.\n      */\n-    public static ProxyConfig disabled() {\n-        return DISABLED_PROXY_CONFIG;\n-    }\n-\n-    @Nullable\n-    static String maskedStr(@Nullable String value) {\n-        return value == null ? null : \"****\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46fda6ab55c268d2fb24c1ea37bd5e707ddcf5cb"}, "originalPosition": 105}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e10a1d8d74afc3280ad707c9968270f0abadfe90", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/e10a1d8d74afc3280ad707c9968270f0abadfe90", "committedDate": "2020-03-14T00:31:33Z", "message": "mask password if username, password is null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1025d187aa7aca902ae09eab628bc5f0e96eb73", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/f1025d187aa7aca902ae09eab628bc5f0e96eb73", "committedDate": "2020-03-14T08:10:27Z", "message": "Update ProxyConfig.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NzA2NjIw", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-374706620", "createdAt": "2020-03-14T08:11:39Z", "commit": {"oid": "f1025d187aa7aca902ae09eab628bc5f0e96eb73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NjgxODI3", "url": "https://github.com/line/armeria/pull/2496#pullrequestreview-374681827", "createdAt": "2020-03-14T00:45:10Z", "commit": {"oid": "e10a1d8d74afc3280ad707c9968270f0abadfe90"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwMDo0NToxMVrOF2WvMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwMDo0NToxMVrOF2WvMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUzOTk1NA==", "bodyText": "nit: proxyConfig.proxyType() ?", "url": "https://github.com/line/armeria/pull/2496#discussion_r392539954", "createdAt": "2020-03-14T00:45:11Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpChannelPool.java", "diffHunk": "@@ -118,6 +127,43 @@ protected void initChannel(Channel ch) throws Exception {\n                                                       .get(ChannelOption.CONNECT_TIMEOUT_MILLIS);\n     }\n \n+    private void configureProxy(Channel ch, ProxyConfig proxyConfig, SslContext sslCtx) {\n+        final ProxyHandler proxyHandler;\n+        switch (proxyConfig.proxyType()) {\n+            case DIRECT:\n+                return;\n+            case SOCKS4:\n+                final Socks4ProxyConfig socks4ProxyConfig = (Socks4ProxyConfig) proxyConfig;\n+                proxyHandler = new Socks4ProxyHandler(socks4ProxyConfig.proxyAddress(),\n+                                                      socks4ProxyConfig.username());\n+                break;\n+            case SOCKS5:\n+                final Socks5ProxyConfig socks5ProxyConfig = (Socks5ProxyConfig) proxyConfig;\n+                proxyHandler = new Socks5ProxyHandler(\n+                        socks5ProxyConfig.proxyAddress(), socks5ProxyConfig.username(),\n+                        socks5ProxyConfig.password());\n+                break;\n+            case CONNECT:\n+                final ConnectProxyConfig connectProxyConfig = (ConnectProxyConfig) proxyConfig;\n+                final String username = connectProxyConfig.username();\n+                final String password = connectProxyConfig.password();\n+                if (username == null || password == null) {\n+                    proxyHandler = new HttpProxyHandler(connectProxyConfig.proxyAddress());\n+                } else {\n+                    proxyHandler = new HttpProxyHandler(connectProxyConfig.proxyAddress(), username, password);\n+                }\n+                if (connectProxyConfig.useTls()) {\n+                    ch.pipeline().addLast(sslCtx.newHandler(ch.alloc()));\n+                }\n+                break;\n+            default:\n+                logger.warn(\"{} Ignoring unknown proxy type: {}\", ch, proxyConfig.getClass().getSimpleName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e10a1d8d74afc3280ad707c9968270f0abadfe90"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdd559818a25950afceb6cf69131f55d10b65315", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/fdd559818a25950afceb6cf69131f55d10b65315", "committedDate": "2020-03-16T03:22:18Z", "message": "log proxyType on unknown proxy type"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1001, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}