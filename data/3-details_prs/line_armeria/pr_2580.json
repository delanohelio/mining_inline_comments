{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3NjcxNzAw", "number": 2580, "title": "Specify why on `Closed{Session,Stream}Exception`", "bodyText": "Motivation:\nIt is sometimes hard to know why a connection or a stream has been\nclosed or reset.\nModifications:\n\nAllow a user specify a message or a cause when creating a\nClosed{Session,Stream}Exception.\nSpecify a message or a cause when creating Closed{Session,Stream}Exception\nwhen applicable.\nRemoved redundant instantiation of ClosedSessionExceptions.\nFixed a bug where ClosedSessionException is raised when\nClosedStreamException is expected.\n\nResult:\n\nMore information when diagnosing a Closed{Session,Stream}Exception\nFixed a bug where ClosedSessionException is raised when\nClosedStreamException is expected.", "createdAt": "2020-03-13T09:18:17Z", "url": "https://github.com/line/armeria/pull/2580", "merged": true, "mergeCommit": {"oid": "c0d0f01863ea9436aa63c8484263235c0438939c"}, "closed": true, "closedAt": "2020-03-13T12:08:12Z", "author": {"login": "trustin"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNMudJAH2gAyMzg3NjcxNzAwOmI1ODliZTA2NzgzZGY4ZTljNTVlNWFhZjY5OTQ0MjQxOTkzZDc2ZDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNNtUlAH2gAyMzg3NjcxNzAwOmE3ZmZhNWM5YzYzNzMyMzQ1MWEyYWQ0MzI1YTYxZWVlN2QzYzk4ZmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b589be06783df8e9c55e5aaf69944241993d76d9", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/b589be06783df8e9c55e5aaf69944241993d76d9", "committedDate": "2020-03-13T09:16:42Z", "message": "Specify why on `Closed{Session,Stream}Exception`\n\nMotivation:\n\nIt is sometimes hard to know why a connection or a stream has been\nclosed or reset.\n\nModifications:\n\n- Allow a user specify a message or a cause when creating a\n  `Closed{Session,Stream}Exception`.\n- Specify a message or a cause when creating `Closed{Session,Stream}Exception`\n  when applicable.\n- Removed redundant instantiation of `ClosedSessionException`s.\n- Fixed a bug where `ClosedSessionException` is raised when\n  `ClosedStreamException` is expected.\n\nResult:\n\n- More information when diagnosing a `Closed{Session,Stream}Exception`\n- Fixed a bug where `ClosedSessionException` is raised when\n  `ClosedStreamException` is expected."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b40ef7e9c724f687cd25b9195d645627911233f", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/9b40ef7e9c724f687cd25b9195d645627911233f", "committedDate": "2020-03-13T09:30:25Z", "message": "Miscellaneous: Use `toString()` instead of `getMessage()` to show the cause type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MTU3MTIw", "url": "https://github.com/line/armeria/pull/2580#pullrequestreview-374157120", "createdAt": "2020-03-13T09:33:13Z", "commit": {"oid": "9b40ef7e9c724f687cd25b9195d645627911233f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwOTozNjozNVrOF19EGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwOTozNjozNVrOF19EGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExOTMyMA==", "bodyText": "Is there any chance that the previousCause is not suppressible?", "url": "https://github.com/line/armeria/pull/2580#discussion_r392119320", "createdAt": "2020-03-13T09:36:35Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java", "diffHunk": "@@ -322,34 +324,53 @@ public void channelInactive(ChannelHandlerContext ctx) throws Exception {\n             channelPool.connect(channel.remoteAddress(), H1C, sessionPromise);\n         } else {\n             // Fail all pending responses.\n-            final Throwable throwable;\n-            if (ctx.channel().hasAttr(PENDING_EXCEPTION)) {\n-                throwable = ctx.channel().attr(PENDING_EXCEPTION).get();\n+            final HttpResponseDecoder responseDecoder = this.responseDecoder;\n+            final Throwable pendingException;\n+            if (responseDecoder != null && responseDecoder.hasUnfinishedResponses()) {\n+                pendingException = getPendingException(ctx);\n+                responseDecoder.failUnfinishedResponses(pendingException);\n             } else {\n-                throwable = ClosedSessionException.get();\n+                pendingException = null;\n             }\n-            failUnfinishedResponses(throwable);\n+\n             // Cancel the timeout and reject the sessionPromise just in case the connection has been closed\n             // even before the session protocol negotiation is done.\n             sessionTimeoutFuture.cancel(false);\n-            sessionPromise.tryFailure(throwable);\n+            if (!sessionPromise.isDone()) {\n+                sessionPromise.tryFailure(pendingException != null ? pendingException\n+                                                                   : getPendingException(ctx));\n+            }\n         }\n     }\n \n     @Override\n     public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {\n+        setPendingException(ctx, new ClosedSessionException(cause));\n         Exceptions.logIfUnexpected(logger, channel, protocol(), cause);\n-        if (channel.isActive()) {\n+        if (!(cause instanceof IOException)) {\n             ctx.close();\n+        } else {\n+            // Netty will close the connection automatically on an IOException.\n         }\n     }\n \n-    private void failUnfinishedResponses(Throwable e) {\n-        final HttpResponseDecoder responseDecoder = this.responseDecoder;\n-        if (responseDecoder == null) {\n-            return;\n+    private static Throwable getPendingException(ChannelHandlerContext ctx) {\n+        if (ctx.channel().hasAttr(PENDING_EXCEPTION)) {\n+            return ctx.channel().attr(PENDING_EXCEPTION).get();\n         }\n \n-        responseDecoder.failUnfinishedResponses(e);\n+        return ClosedSessionException.get();\n+    }\n+\n+    static void setPendingException(ChannelHandlerContext ctx, Throwable cause) {\n+        final Attribute<Throwable> attr = ctx.channel().attr(PENDING_EXCEPTION);\n+        final Throwable previousCause = attr.get();\n+        if (previousCause == null) {\n+            attr.set(cause);\n+        } else if (previousCause != cause) {\n+            previousCause.addSuppressed(cause);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b40ef7e9c724f687cd25b9195d645627911233f"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MTg0MjYw", "url": "https://github.com/line/armeria/pull/2580#pullrequestreview-374184260", "createdAt": "2020-03-13T10:14:53Z", "commit": {"oid": "9b40ef7e9c724f687cd25b9195d645627911233f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MTg0OTUz", "url": "https://github.com/line/armeria/pull/2580#pullrequestreview-374184953", "createdAt": "2020-03-13T10:16:06Z", "commit": {"oid": "9b40ef7e9c724f687cd25b9195d645627911233f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de02516c8ccb8adcf8cb3479b35de371c49867cf", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/de02516c8ccb8adcf8cb3479b35de371c49867cf", "committedDate": "2020-03-13T10:20:13Z", "message": "No need to log when exception is propagated / Do not suppress but log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7ffa5c9c637323451a2ad4325a61eee7d3c98fc", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/a7ffa5c9c637323451a2ad4325a61eee7d3c98fc", "committedDate": "2020-03-13T10:25:22Z", "message": "Fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 686, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}