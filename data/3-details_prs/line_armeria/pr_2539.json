{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwODA4Mzgy", "number": 2539, "title": "Fix StreamMessage to handle abort() correctly", "bodyText": "Motivation:\nLet's see following example:\nStreamMessageAndWriter<Object> stream = new DefaultStreamMessage<>();\nstream.write(data);\nstream.close();\nstream.subscribe(mySubscriber);\nstream.abort();\nIn this case, onError() or onComplete(), which onNext(data) is called previously, should be called. But, currently, just onComplete() is invoked.\nModifications:\n\nIf StreamMessage.abort() or cancel() is called, the StreamMessage handles the subscriber with the event and ignores the close() call.\n\nHowever, onComplete() will be still invoked when no element was written.\n\n\n\nResult:\n\nYou now get AbortedStreamException error when the stream is aborted after closed and anything was written to the stream.", "createdAt": "2020-02-27T11:57:50Z", "url": "https://github.com/line/armeria/pull/2539", "merged": true, "mergeCommit": {"oid": "d9eb7ffc4e22e0017c6e33ec1275036247b4a0d0"}, "closed": true, "closedAt": "2020-02-28T11:06:49Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIZ24hgH2gAyMzgwODA4MzgyOjI5YTk5ZTcxNjczM2UzMzE3N2FlMDFmNzQzMTNhYzhlNDlmNWFhMTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIppaWgH2gAyMzgwODA4MzgyOjk2NzhiZmNmODA4Yjc2Zjg3ZjIwZDM3NTVmMDg0MGFkZGFkZDRlMGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "29a99e716733e33177ae01f74313ac8e49f5aa16", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/29a99e716733e33177ae01f74313ac8e49f5aa16", "committedDate": "2020-02-27T11:45:03Z", "message": "Fix StreamMessage to handle abort() correctly\nMotivation:\nLet's see following example:\n```java\nStreamMessageAndWriter<Object> stream = new DefaultStreamMessage<>();\nstream.write(data);\nstream.close();\nstream.subscribe(mySubscriber);\nstream.abort();\n```\nIn this case, `onError()` or `onComplete()`, which `onNext(data)` is called previousle, should be called. But, currently, just `onComplete()` is invoked.\n\nModifications:\n- If `StreamMessage.abort()` or `cancel()` is called, the `StreamMessage` handles the subscriber with the event and ignores the `close()` call.\n\nResult:\n- You now get `AbortedStreamException` error when the stream is aborted after closed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjI1Mjk3", "url": "https://github.com/line/armeria/pull/2539#pullrequestreview-365625297", "createdAt": "2020-02-27T12:01:45Z", "commit": {"oid": "29a99e716733e33177ae01f74313ac8e49f5aa16"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjowMTo0NVrOFvPojg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjowMTo0NVrOFvPojg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4MzUzNA==", "bodyText": "The request is not subscribed but aborted in HttpServerHandler so the cause is changed.\nShould I change not to log this exception when the request is not subscribed? \ud83e\udd14", "url": "https://github.com/line/armeria/pull/2539#discussion_r385083534", "createdAt": "2020-02-27T12:01:45Z", "author": {"login": "minwoox"}, "path": "core/src/test/java/com/linecorp/armeria/server/HttpServerHandlerTest.java", "diffHunk": "@@ -103,6 +104,6 @@ void httpResponseExceptionIsNotLoggedAsRequestCause() {\n         await().untilAsserted(() -> {\n             assertThat(logHolder.get().requestHeaders().path()).isEqualTo(\"/httpResponseException\");\n         });\n-        assertThat(logHolder.get().requestCause()).isNull();\n+        assertThat(logHolder.get().requestCause()).isInstanceOf(AbortedStreamException.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29a99e716733e33177ae01f74313ac8e49f5aa16"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjI2NDM0", "url": "https://github.com/line/armeria/pull/2539#pullrequestreview-365626434", "createdAt": "2020-02-27T12:03:43Z", "commit": {"oid": "29a99e716733e33177ae01f74313ac8e49f5aa16"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjowMzo0NFrOFvPsCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjowMzo0NFrOFvPsCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4NDQyNQ==", "bodyText": "So the concept now is that, whatever the event which changes to the CLEANUP state, will notify to the subscriber with it.", "url": "https://github.com/line/armeria/pull/2539#discussion_r385084425", "createdAt": "2020-02-27T12:03:44Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -361,8 +384,9 @@ private boolean notifyAwaitDemandFuture() {\n     }\n \n     private void handleCloseEvent(SubscriptionImpl subscription, CloseEvent o) {\n-        setState(State.OPEN, State.CLEANUP);\n-        notifySubscriberOfCloseEvent(subscription, o);\n+        if (setState(State.CLOSED, State.CLEANUP)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29a99e716733e33177ae01f74313ac8e49f5aa16"}, "originalPosition": 65}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjI1MjMx", "url": "https://github.com/line/armeria/pull/2539#pullrequestreview-365625231", "createdAt": "2020-02-27T12:01:37Z", "commit": {"oid": "29a99e716733e33177ae01f74313ac8e49f5aa16"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjowMTozN1rOFvPoUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjowODo0MlrOFvP09A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4MzQ3NQ==", "bodyText": "Question mark?", "url": "https://github.com/line/armeria/pull/2539#discussion_r385083475", "createdAt": "2020-02-27T12:01:37Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -216,13 +240,12 @@ private void cancelOrAbort(Throwable cause) {\n \n         switch (state) {\n             case CLOSED:\n-                // close() has been called before cancel(). There's no need to push a CloseEvent,\n-                // but we need to ensure the completionFuture is notified and any pending objects\n-                // are removed.\n+                // close() has been called before cancel() or abort() is called.\n+                // We just push the new CloseEvent so that SUCCESSFUL_CLOSE, which was pushed by close(), is\n+                // ignored and cancel() or abort() call works?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29a99e716733e33177ae01f74313ac8e49f5aa16"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4NDcxOQ==", "bodyText": "cause could be instantiated only when necessary.", "url": "https://github.com/line/armeria/pull/2539#discussion_r385084719", "createdAt": "2020-02-27T12:04:24Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -402,6 +426,41 @@ private boolean setState(State oldState, State newState) {\n     }\n \n     private void cleanup() {\n-        cleanupQueue(subscription, queue);\n+        final Throwable cause = ClosedStreamException.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29a99e716733e33177ae01f74313ac8e49f5aa16"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4NjcwOA==", "bodyText": "// Just skip SUCCESSFUL_CLOSE because being in cleanup() means one of the following:\n// - All elements have been consumed already\n// - cancel() or abort() has been invoked after successful close().", "url": "https://github.com/line/armeria/pull/2539#discussion_r385086708", "createdAt": "2020-02-27T12:08:42Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -402,6 +426,41 @@ private boolean setState(State oldState, State newState) {\n     }\n \n     private void cleanup() {\n-        cleanupQueue(subscription, queue);\n+        final Throwable cause = ClosedStreamException.get();\n+        for (;;) {\n+            final Object e = queue.poll();\n+            if (e == null) {\n+                break;\n+            }\n+\n+            try {\n+                // Just skip SUCCESSFUL_CLOSE because cancel() or abort() is called so\n+                // we need to handle the subscriber with the event.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29a99e716733e33177ae01f74313ac8e49f5aa16"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94f83c268ed1058de89b594dff2812e72a416162", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/94f83c268ed1058de89b594dff2812e72a416162", "committedDate": "2020-02-27T12:22:00Z", "message": "Address comments by @trustin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c6160b002bcc0e4acca8a7d75978fa7df6028e5", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/8c6160b002bcc0e4acca8a7d75978fa7df6028e5", "committedDate": "2020-02-27T12:29:11Z", "message": "Lazy init cause"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a15371d5807b349c7c6202feb782cbab38d468f2", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/a15371d5807b349c7c6202feb782cbab38d468f2", "committedDate": "2020-02-27T12:31:40Z", "message": "Fix indent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06871eabb2a67fd8e9334f779fcf315a270a1d65", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/06871eabb2a67fd8e9334f779fcf315a270a1d65", "committedDate": "2020-02-27T12:35:12Z", "message": "Add continue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjQ1MDI1", "url": "https://github.com/line/armeria/pull/2539#pullrequestreview-365645025", "createdAt": "2020-02-27T12:36:13Z", "commit": {"oid": "06871eabb2a67fd8e9334f779fcf315a270a1d65"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjozNjoxNFrOFvQk4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjozNjoxNFrOFvQk4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5ODk3OQ==", "bodyText": "There was a bug here. we should continue here. \ud83d\ude31", "url": "https://github.com/line/armeria/pull/2539#discussion_r385098979", "createdAt": "2020-02-27T12:36:14Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -171,36 +170,6 @@ T prepareObjectForNotification(SubscriptionImpl subscription, T o) {\n         return o;\n     }\n \n-    /**\n-     * Helper method for the common case of cleaning up all elements in a queue when shutting down the stream.\n-     */\n-    void cleanupQueue(SubscriptionImpl subscription, Queue<Object> queue) {\n-        final Throwable cause = ClosedStreamException.get();\n-        for (;;) {\n-            final Object e = queue.poll();\n-            if (e == null) {\n-                break;\n-            }\n-\n-            try {\n-                if (e instanceof CloseEvent) {\n-                    notifySubscriberOfCloseEvent(subscription, (CloseEvent) e);\n-                    continue;\n-                }\n-\n-                if (e instanceof CompletableFuture) {\n-                    ((CompletableFuture<?>) e).completeExceptionally(cause);\n-                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06871eabb2a67fd8e9334f779fcf315a270a1d65"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NzI5NzY4", "url": "https://github.com/line/armeria/pull/2539#pullrequestreview-365729768", "createdAt": "2020-02-27T14:34:25Z", "commit": {"oid": "06871eabb2a67fd8e9334f779fcf315a270a1d65"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a02e9cac4426a5fcda9b1201ba18ecceae20ccc", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/1a02e9cac4426a5fcda9b1201ba18ecceae20ccc", "committedDate": "2020-02-28T05:43:42Z", "message": "call onComplete when stream message is empty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "869836191c85920c28bc055a80a26362336299a9", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/869836191c85920c28bc055a80a26362336299a9", "committedDate": "2020-02-28T05:47:00Z", "message": "Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTc1NjIz", "url": "https://github.com/line/armeria/pull/2539#pullrequestreview-366175623", "createdAt": "2020-02-28T06:01:53Z", "commit": {"oid": "869836191c85920c28bc055a80a26362336299a9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNjowMTo1M1rOFvqUJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNjowMjozMlrOFvqUnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUyMDY3OQ==", "bodyText": "Could be private?", "url": "https://github.com/line/armeria/pull/2539#discussion_r385520679", "createdAt": "2020-02-28T06:01:53Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -194,44 +215,56 @@ private void doRequest(long n) {\n \n     @Override\n     void cancel() {\n-        cancelOrAbort(CancelledSubscriptionException.get());\n+        if (setState(State.OPEN, State.CLEANUP) || setState(State.CLOSED, State.CLEANUP)) {\n+            // It the state was CLOSED, close() or close(cause) has been called before cancel() or abort()\n+            // is called. We just ignore the previously pushed event and deal with CANCELLED_CLOSE.\n+            final SubscriptionImpl subscription = this.subscription;\n+            assert subscription != null;\n+            notifySubscriberOfCloseEvent(subscription, CANCELLED_CLOSE);\n+        }\n     }\n \n-    @Override\n     void notifySubscriberOfCloseEvent(SubscriptionImpl subscription, CloseEvent event) {\n-        // Always called from the subscriber thread.\n+        if (subscription.needsDirectInvocation()) {\n+            notifySubscriberOfCloseEvent0(subscription, event);\n+        } else {\n+            subscription.executor().execute(() -> notifySubscriberOfCloseEvent0(subscription, event));\n+        }\n+    }\n+\n+    void notifySubscriberOfCloseEvent0(SubscriptionImpl subscription, CloseEvent event) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "869836191c85920c28bc055a80a26362336299a9"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUyMDc5Nw==", "bodyText": "Could be private?", "url": "https://github.com/line/armeria/pull/2539#discussion_r385520797", "createdAt": "2020-02-28T06:02:32Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -194,44 +215,56 @@ private void doRequest(long n) {\n \n     @Override\n     void cancel() {\n-        cancelOrAbort(CancelledSubscriptionException.get());\n+        if (setState(State.OPEN, State.CLEANUP) || setState(State.CLOSED, State.CLEANUP)) {\n+            // It the state was CLOSED, close() or close(cause) has been called before cancel() or abort()\n+            // is called. We just ignore the previously pushed event and deal with CANCELLED_CLOSE.\n+            final SubscriptionImpl subscription = this.subscription;\n+            assert subscription != null;\n+            notifySubscriberOfCloseEvent(subscription, CANCELLED_CLOSE);\n+        }\n     }\n \n-    @Override\n     void notifySubscriberOfCloseEvent(SubscriptionImpl subscription, CloseEvent event) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "869836191c85920c28bc055a80a26362336299a9"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9678bfcf808b76f87f20d3755f0840addadd4e0e", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/9678bfcf808b76f87f20d3755f0840addadd4e0e", "committedDate": "2020-02-28T06:08:49Z", "message": "Add private"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 623, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}