{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MTgyNTg1", "number": 2983, "title": "Support Kotlin suspending functions for annotated services", "bodyText": "Motivation:\nCurrently, to implement annotated services, Kotlin users have to write mono or future many times redundantly.\nIt'd be nice if Kotlin users can implement annotated service with suspend functions.\nModifications:\n\nModify AnnotatedService\n\ncheck if the method matched with the incoming request is a suspend function\nand invokes a suspend function with a configured coroutine context\n\n\nAdd CoroutineContextService and CoroutineContextProvider so that users can configures a context easily\n\nResult:\n\nWe can implement annotated services with suspending functions, and can configure coroutine contexts via the CoroutineContextService decorator.\nCoroutines are dispatched to context-aware event loop by default.\nIf useBlockingTaskExecutor is set to true or methods are annotated with @Blocking, coroutines are dispatched to context-aware blocking executor.\n\nserverBuilder\n    .annotatedService(object {\n        @Get(\"/foo\")\n        suspend fun foo(): HttpResponse {\n            // context aware by default\n            ServiceRequestContext.current()\n            ...\n        }\n    })\n    .decorator(CoroutineContextService.newDecorator { ctx ->\n        CoroutineName(ctx.config().defaultServiceName() ?: \"none\")\n    })", "createdAt": "2020-08-09T17:59:03Z", "url": "https://github.com/line/armeria/pull/2983", "merged": true, "mergeCommit": {"oid": "833077b818140669d5b6c051e1d0a544c5bdcf05"}, "closed": true, "closedAt": "2020-08-19T13:02:58Z", "author": {"login": "okue"}, "timelineItems": {"totalCount": 46, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9ZKO8AFqTQ2MzkzNjMzNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAW30dgFqTQ3MDIxMjE0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzOTM2MzM0", "url": "https://github.com/line/armeria/pull/2983#pullrequestreview-463936334", "createdAt": "2020-08-10T02:53:50Z", "commit": {"oid": "a1b35b2839994c83ec99c8c8e9f927b3019390ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMjo1Mzo1MFrOG-AKlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwMjo1Mzo1MFrOG-AKlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzY2NzYwNg==", "bodyText": "Hello, @okue.\nThis looks good and Kotlin users could use Armeria well with the Coroutine after this PR is merged.\nHowever, this will bring additional dependencies to the users who don't use Kotlin.\nSo, we have to make a dedicated module for this purpose.\nThen, if the dependency is in the class path, we can enable Coroutine support.\nThis is one of the approaches we do for checking the dependencies:\nhttps://github.com/line/armeria/blob/master/spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java#L127\nThis is an example to call a method using MethodHandles\nhttps://github.com/line/armeria/blob/master/spring/boot2-actuator-autoconfigure/src/main/java/com/linecorp/armeria/spring/actuate/WebOperationService.java#L96\nPlease note that the method handle is initialized only once, so that we don't do expensive operations every time we call invoke.", "url": "https://github.com/line/armeria/pull/2983#discussion_r467667606", "createdAt": "2020-08-10T02:53:50Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedService.java", "diffHunk": "@@ -300,7 +304,14 @@ private Object invoke(ServiceRequestContext ctx, HttpRequest req,\n         try (SafeCloseable ignored = ctx.push()) {\n             final ResolverContext resolverContext = new ResolverContext(ctx, req, aggregatedRequest);\n             final Object[] arguments = AnnotatedValueResolver.toArguments(resolvers, resolverContext);\n-            return method.invoke(object, arguments);\n+            if (CoroutineUtil.isSuspendingFunction(method)) {\n+                return CoroutineUtil.invokeSuspendingFunction(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1b35b2839994c83ec99c8c8e9f927b3019390ad"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a1b35b2839994c83ec99c8c8e9f927b3019390ad", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/a1b35b2839994c83ec99c8c8e9f927b3019390ad", "committedDate": "2020-08-09T16:52:41Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "b007fae05d167bd8b58111d9fb4f04791876331e", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/b007fae05d167bd8b58111d9fb4f04791876331e", "committedDate": "2020-08-10T04:33:08Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b007fae05d167bd8b58111d9fb4f04791876331e", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/b007fae05d167bd8b58111d9fb4f04791876331e", "committedDate": "2020-08-10T04:33:08Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "c8262197c805f150aafb07033e5e6920e0e63709", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/c8262197c805f150aafb07033e5e6920e0e63709", "committedDate": "2020-08-10T04:42:35Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c8262197c805f150aafb07033e5e6920e0e63709", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/c8262197c805f150aafb07033e5e6920e0e63709", "committedDate": "2020-08-10T04:42:35Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "fac72b04c62496a2441b8210c751f49631c6d5c9", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/fac72b04c62496a2441b8210c751f49631c6d5c9", "committedDate": "2020-08-10T05:34:34Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fac72b04c62496a2441b8210c751f49631c6d5c9", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/fac72b04c62496a2441b8210c751f49631c6d5c9", "committedDate": "2020-08-10T05:34:34Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "df0f86b5c2b59c9a238c3c69eb3eae37c29aeed1", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/df0f86b5c2b59c9a238c3c69eb3eae37c29aeed1", "committedDate": "2020-08-10T05:47:50Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df0f86b5c2b59c9a238c3c69eb3eae37c29aeed1", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/df0f86b5c2b59c9a238c3c69eb3eae37c29aeed1", "committedDate": "2020-08-10T05:47:50Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "de44af21a7293efd6673324b7eb612584cac735a", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/de44af21a7293efd6673324b7eb612584cac735a", "committedDate": "2020-08-10T06:14:12Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de44af21a7293efd6673324b7eb612584cac735a", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/de44af21a7293efd6673324b7eb612584cac735a", "committedDate": "2020-08-10T06:14:12Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "002e3f274b4d4eec65e8f54d51c61503be6e630a", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/002e3f274b4d4eec65e8f54d51c61503be6e630a", "committedDate": "2020-08-10T07:00:30Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "002e3f274b4d4eec65e8f54d51c61503be6e630a", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/002e3f274b4d4eec65e8f54d51c61503be6e630a", "committedDate": "2020-08-10T07:00:30Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "9bd3c0d84f61caba286386723bc4c1951dc7eb69", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/9bd3c0d84f61caba286386723bc4c1951dc7eb69", "committedDate": "2020-08-10T08:10:13Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9bd3c0d84f61caba286386723bc4c1951dc7eb69", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/9bd3c0d84f61caba286386723bc4c1951dc7eb69", "committedDate": "2020-08-10T08:10:13Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "d7d956edbc52d5754bf499e95030a6c3984f1481", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/d7d956edbc52d5754bf499e95030a6c3984f1481", "committedDate": "2020-08-10T08:34:59Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d7d956edbc52d5754bf499e95030a6c3984f1481", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/d7d956edbc52d5754bf499e95030a6c3984f1481", "committedDate": "2020-08-10T08:34:59Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "0e3a970b763e8935e0bb2dba8c8779264b84dbdf", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/0e3a970b763e8935e0bb2dba8c8779264b84dbdf", "committedDate": "2020-08-10T08:58:50Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e3a970b763e8935e0bb2dba8c8779264b84dbdf", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/0e3a970b763e8935e0bb2dba8c8779264b84dbdf", "committedDate": "2020-08-10T08:58:50Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "73111e817c557d5911e018cb37a8bd0ebfea0279", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/73111e817c557d5911e018cb37a8bd0ebfea0279", "committedDate": "2020-08-10T09:18:15Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "73111e817c557d5911e018cb37a8bd0ebfea0279", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/73111e817c557d5911e018cb37a8bd0ebfea0279", "committedDate": "2020-08-10T09:18:15Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "af49092239514fb84746c26738ab681c0ba158bf", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/af49092239514fb84746c26738ab681c0ba158bf", "committedDate": "2020-08-10T09:46:40Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "af49092239514fb84746c26738ab681c0ba158bf", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/af49092239514fb84746c26738ab681c0ba158bf", "committedDate": "2020-08-10T09:46:40Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "64e2f4a147f45bd178b8f4c33ef5a6198762c9e4", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/64e2f4a147f45bd178b8f4c33ef5a6198762c9e4", "committedDate": "2020-08-10T10:19:24Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64e2f4a147f45bd178b8f4c33ef5a6198762c9e4", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/64e2f4a147f45bd178b8f4c33ef5a6198762c9e4", "committedDate": "2020-08-10T10:19:24Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "726e515421ba0a191a6da4f795a108b8acd82ee9", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/726e515421ba0a191a6da4f795a108b8acd82ee9", "committedDate": "2020-08-10T14:57:48Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "726e515421ba0a191a6da4f795a108b8acd82ee9", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/726e515421ba0a191a6da4f795a108b8acd82ee9", "committedDate": "2020-08-10T14:57:48Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "37b87aa8295260a25255f37ee3b084d4503df1c3", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/37b87aa8295260a25255f37ee3b084d4503df1c3", "committedDate": "2020-08-10T16:04:53Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72af8215e42202830e1f8443bcd13f97b147f83d", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/72af8215e42202830e1f8443bcd13f97b147f83d", "committedDate": "2020-08-10T16:13:29Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "37b87aa8295260a25255f37ee3b084d4503df1c3", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/37b87aa8295260a25255f37ee3b084d4503df1c3", "committedDate": "2020-08-10T16:04:53Z", "message": "Support kotlin coroutines for AnnotatedService"}, "afterCommit": {"oid": "72af8215e42202830e1f8443bcd13f97b147f83d", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/72af8215e42202830e1f8443bcd13f97b147f83d", "committedDate": "2020-08-10T16:13:29Z", "message": "Support kotlin coroutines for AnnotatedService"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0NzM3ODY0", "url": "https://github.com/line/armeria/pull/2983#pullrequestreview-464737864", "createdAt": "2020-08-11T04:20:40Z", "commit": {"oid": "72af8215e42202830e1f8443bcd13f97b147f83d"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNDoyMDo0MVrOG-n1XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQwNDo1MDoxM1rOG-oRLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMxNzUzMw==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final Boolean isKotlinSuspendingMethod;\n          \n          \n            \n                private final boolean isKotlinSuspendingMethod;", "url": "https://github.com/line/armeria/pull/2983#discussion_r468317533", "createdAt": "2020-08-11T04:20:41Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedService.java", "diffHunk": "@@ -97,6 +99,7 @@\n \n     private final Object object;\n     private final Method method;\n+    private final Boolean isKotlinSuspendingMethod;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72af8215e42202830e1f8443bcd13f97b147f83d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyMTM2MA==", "bodyText": "nit: requireNonNull(provider, \"provider\")", "url": "https://github.com/line/armeria/pull/2983#discussion_r468321360", "createdAt": "2020-08-11T04:36:55Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/kotlin/CoroutineContextService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.kotlin;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+import com.linecorp.armeria.server.SimpleDecoratingHttpService;\n+\n+/**\n+ * Decorates an {@link HttpService} to configure the coroutine context which is used as an initial context\n+ * of annotated services' suspending functions.\n+ *\n+ * <p>Example:\n+ * <pre>{@code\n+ * > serverBuilder\n+ * >     .annotatedService(object {\n+ * >         @Get(\"/users/{uid}\")\n+ * >         suspend fun foo(@Param(\"uid\") uid: String): HttpResponse {\n+ * >             ...\n+ * >         }\n+ * >     })\n+ * >     .decorator(CoroutineContextService.newDecorator { ctx ->\n+ * >         ctx.eventLoop().asCoroutineDispatcher() +\n+ * >             CoroutineName(ctx.config().defaultServiceName() ?: \"none\")\n+ * >     })\n+ * }\n+ * </pre>\n+ */\n+public class CoroutineContextService extends SimpleDecoratingHttpService {\n+\n+    /**\n+     * Returns a new {@link HttpService} decorator that injects into annotated services the coroutine context\n+     * provided by the specified {@code provider}.\n+     */\n+    public static Function<? super HttpService, CoroutineContextService> newDecorator(\n+            CoroutineContextProvider provider) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72af8215e42202830e1f8443bcd13f97b147f83d"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyMTk3OQ==", "bodyText": "nit: requireNonNull", "url": "https://github.com/line/armeria/pull/2983#discussion_r468321979", "createdAt": "2020-08-11T04:39:37Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/kotlin/CoroutineContextUtil.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.kotlin;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.internal.server.annotation.AnnotatedService;\n+\n+import io.netty.util.AttributeKey;\n+import kotlin.coroutines.CoroutineContext;\n+\n+/**\n+ * Configures a coroutine context for annotated services and Kotlin suspending functions.\n+ *\n+ * @see CoroutineContextService\n+ */\n+public final class CoroutineContextUtil {\n+\n+    /**\n+     * {@link AnnotatedService} uses a coroutine context associated with this attribute\n+     * when calling suspending functions.\n+     */\n+    public static final AttributeKey<CoroutineContext> COROUTINE_CONTEXT_KEY =\n+            AttributeKey.valueOf(CoroutineContextUtil.class, \"COROUTINE_CONTEXT_KEY\");\n+\n+    /**\n+     * Associates the given coroutine context with {@code COROUTINE_CONTEXT_KEY} attribute in the context.\n+     */\n+    public static void setCoroutineContext(RequestContext ctx, CoroutineContext coroutineContext) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72af8215e42202830e1f8443bcd13f97b147f83d"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyMzY1MA==", "bodyText": "Add check for the returned value? such as\nrequiredNonNull(provider.provide(ctx), \"provider returned null\")", "url": "https://github.com/line/armeria/pull/2983#discussion_r468323650", "createdAt": "2020-08-11T04:46:09Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/kotlin/CoroutineContextService.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.kotlin;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+import com.linecorp.armeria.server.SimpleDecoratingHttpService;\n+\n+/**\n+ * Decorates an {@link HttpService} to configure the coroutine context which is used as an initial context\n+ * of annotated services' suspending functions.\n+ *\n+ * <p>Example:\n+ * <pre>{@code\n+ * > serverBuilder\n+ * >     .annotatedService(object {\n+ * >         @Get(\"/users/{uid}\")\n+ * >         suspend fun foo(@Param(\"uid\") uid: String): HttpResponse {\n+ * >             ...\n+ * >         }\n+ * >     })\n+ * >     .decorator(CoroutineContextService.newDecorator { ctx ->\n+ * >         ctx.eventLoop().asCoroutineDispatcher() +\n+ * >             CoroutineName(ctx.config().defaultServiceName() ?: \"none\")\n+ * >     })\n+ * }\n+ * </pre>\n+ */\n+public class CoroutineContextService extends SimpleDecoratingHttpService {\n+\n+    /**\n+     * Returns a new {@link HttpService} decorator that injects into annotated services the coroutine context\n+     * provided by the specified {@code provider}.\n+     */\n+    public static Function<? super HttpService, CoroutineContextService> newDecorator(\n+            CoroutineContextProvider provider) {\n+        return delegate -> new CoroutineContextService(delegate, provider);\n+    }\n+\n+    private final CoroutineContextProvider provider;\n+\n+    CoroutineContextService(HttpService delegate, CoroutineContextProvider provider) {\n+        super(delegate);\n+        this.provider = provider;\n+    }\n+\n+    @Override\n+    public HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) throws Exception {\n+        CoroutineContextUtil.setCoroutineContext(ctx, provider.provide(ctx));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72af8215e42202830e1f8443bcd13f97b147f83d"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODMyNDY1NQ==", "bodyText": "ditto", "url": "https://github.com/line/armeria/pull/2983#discussion_r468324655", "createdAt": "2020-08-11T04:50:13Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/kotlin/CoroutineContextUtil.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.kotlin;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.internal.server.annotation.AnnotatedService;\n+\n+import io.netty.util.AttributeKey;\n+import kotlin.coroutines.CoroutineContext;\n+\n+/**\n+ * Configures a coroutine context for annotated services and Kotlin suspending functions.\n+ *\n+ * @see CoroutineContextService\n+ */\n+public final class CoroutineContextUtil {\n+\n+    /**\n+     * {@link AnnotatedService} uses a coroutine context associated with this attribute\n+     * when calling suspending functions.\n+     */\n+    public static final AttributeKey<CoroutineContext> COROUTINE_CONTEXT_KEY =\n+            AttributeKey.valueOf(CoroutineContextUtil.class, \"COROUTINE_CONTEXT_KEY\");\n+\n+    /**\n+     * Associates the given coroutine context with {@code COROUTINE_CONTEXT_KEY} attribute in the context.\n+     */\n+    public static void setCoroutineContext(RequestContext ctx, CoroutineContext coroutineContext) {\n+        ctx.setAttr(COROUTINE_CONTEXT_KEY, coroutineContext);\n+    }\n+\n+    /**\n+     * Returns the coroutine context mapped to {@code COROUTINE_CONTEXT_KEY} in the context.\n+     */\n+    @Nullable\n+    public static CoroutineContext getCoroutineContext(RequestContext ctx) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72af8215e42202830e1f8443bcd13f97b147f83d"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c23b2965c59683ea51e2da9d52e7acec9f99481", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/1c23b2965c59683ea51e2da9d52e7acec9f99481", "committedDate": "2020-08-11T12:09:32Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64f6d76cd5a9197ea3a3559947d82e60d9ace136", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/64f6d76cd5a9197ea3a3559947d82e60d9ace136", "committedDate": "2020-08-11T12:59:42Z", "message": "Modify packages"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4fa5876b2ca2cca51f6765f1a8063393382b9b3", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/a4fa5876b2ca2cca51f6765f1a8063393382b9b3", "committedDate": "2020-08-11T12:25:09Z", "message": "Modify packages"}, "afterCommit": {"oid": "64f6d76cd5a9197ea3a3559947d82e60d9ace136", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/64f6d76cd5a9197ea3a3559947d82e60d9ace136", "committedDate": "2020-08-11T12:59:42Z", "message": "Modify packages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "864aa9958469c619f5a82887d84570dfef3aab73", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/864aa9958469c619f5a82887d84570dfef3aab73", "committedDate": "2020-08-11T17:00:32Z", "message": "Separate kotlin dependencies from :core"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9204a243fa0a83e4736b023976cf613a43e1f5ca", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/9204a243fa0a83e4736b023976cf613a43e1f5ca", "committedDate": "2020-08-11T18:30:44Z", "message": "Add ktlint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NTczMTQz", "url": "https://github.com/line/armeria/pull/2983#pullrequestreview-465573143", "createdAt": "2020-08-12T03:52:55Z", "commit": {"oid": "9204a243fa0a83e4736b023976cf613a43e1f5ca"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwMzo1Mjo1NVrOG_Q2jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwMzo1NTo0M1rOG_Q5Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk4OTU4MQ==", "bodyText": "Could be private?", "url": "https://github.com/line/armeria/pull/2983#discussion_r468989581", "createdAt": "2020-08-12T03:52:55Z", "author": {"login": "trustin"}, "path": "kotlin/src/main/java/com/linecorp/armeria/common/kotlin/CoroutineContextUtil.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.kotlin;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.internal.server.annotation.AnnotatedService;\n+import com.linecorp.armeria.server.kotlin.CoroutineContextService;\n+\n+import io.netty.util.AttributeKey;\n+import kotlin.coroutines.CoroutineContext;\n+\n+/**\n+ * Configures a coroutine context for annotated services and Kotlin suspending functions.\n+ *\n+ * @see CoroutineContextService\n+ */\n+public final class CoroutineContextUtil {\n+\n+    /**\n+     * {@link AnnotatedService} uses a coroutine context associated with this attribute\n+     * when calling suspending functions.\n+     */\n+    public static final AttributeKey<CoroutineContext> COROUTINE_CONTEXT_KEY =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9204a243fa0a83e4736b023976cf613a43e1f5ca"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk4OTY5Mg==", "bodyText": "How about CoroutineContexts unless there's a class with the same name in Kotlin?", "url": "https://github.com/line/armeria/pull/2983#discussion_r468989692", "createdAt": "2020-08-12T03:53:25Z", "author": {"login": "trustin"}, "path": "kotlin/src/main/java/com/linecorp/armeria/common/kotlin/CoroutineContextUtil.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.kotlin;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.internal.server.annotation.AnnotatedService;\n+import com.linecorp.armeria.server.kotlin.CoroutineContextService;\n+\n+import io.netty.util.AttributeKey;\n+import kotlin.coroutines.CoroutineContext;\n+\n+/**\n+ * Configures a coroutine context for annotated services and Kotlin suspending functions.\n+ *\n+ * @see CoroutineContextService\n+ */\n+public final class CoroutineContextUtil {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9204a243fa0a83e4736b023976cf613a43e1f5ca"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk4OTkzOA==", "bodyText": "Update Javadoc?", "url": "https://github.com/line/armeria/pull/2983#discussion_r468989938", "createdAt": "2020-08-12T03:54:26Z", "author": {"login": "trustin"}, "path": "kotlin/src/main/java/com/linecorp/armeria/common/kotlin/package-info.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+/**\n+ * Various classes used internally. Anything in this package can be changed or removed at any time.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9204a243fa0a83e4736b023976cf613a43e1f5ca"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5MDE2Mg==", "bodyText": "Update Javadoc?", "url": "https://github.com/line/armeria/pull/2983#discussion_r468990162", "createdAt": "2020-08-12T03:55:18Z", "author": {"login": "trustin"}, "path": "kotlin/src/main/java/com/linecorp/armeria/server/kotlin/package-info.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+/**\n+ * Various classes used internally. Anything in this package can be changed or removed at any time.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9204a243fa0a83e4736b023976cf613a43e1f5ca"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODk5MDI4Mg==", "bodyText": "'is not a'", "url": "https://github.com/line/armeria/pull/2983#discussion_r468990282", "createdAt": "2020-08-12T03:55:43Z", "author": {"login": "trustin"}, "path": "kotlin/src/main/kotlin/com/linecorp/armeria/internal/common/kotlin/CoroutineUtil.kt", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+@file:JvmName(\"CoroutineUtil\")\n+\n+package com.linecorp.armeria.internal.common.kotlin\n+\n+import com.linecorp.armeria.common.RequestContext\n+import com.linecorp.armeria.common.kotlin.CoroutineContextUtil\n+import kotlinx.coroutines.Dispatchers\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.future.future\n+import java.lang.reflect.Method\n+import java.util.concurrent.CompletableFuture\n+import kotlin.coroutines.EmptyCoroutineContext\n+import kotlin.reflect.full.callSuspend\n+import kotlin.reflect.jvm.kotlinFunction\n+\n+/**\n+ * Invokes a suspending function and returns [CompletableFuture].\n+ */\n+fun callKotlinSuspendingMethod(\n+    method: Method,\n+    obj: Any,\n+    args: Array<Any>,\n+    ctx: RequestContext\n+): CompletableFuture<Any?> {\n+    val kFunction = checkNotNull(method.kotlinFunction) { \"method is not suspending function\" }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9204a243fa0a83e4736b023976cf613a43e1f5ca"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6248200de40fd93423cac265aa3ba32670de20a8", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/6248200de40fd93423cac265aa3ba32670de20a8", "committedDate": "2020-08-12T08:08:05Z", "message": "address a comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1ODg0Njky", "url": "https://github.com/line/armeria/pull/2983#pullrequestreview-465884692", "createdAt": "2020-08-12T12:52:07Z", "commit": {"oid": "967ca03e4790b2641dc83a5f11d30be1f4f56d6f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMjo1MjowN1rOG_f3EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMjo1MjowN1rOG_f3EA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIzNTQ3Mg==", "bodyText": "Question: Is it possible to cache executorService.asCoroutineDispatcher()?", "url": "https://github.com/line/armeria/pull/2983#discussion_r469235472", "createdAt": "2020-08-12T12:52:07Z", "author": {"login": "trustin"}, "path": "kotlin/src/main/kotlin/com/linecorp/armeria/internal/common/kotlin/CoroutineUtil.kt", "diffHunk": "@@ -36,11 +37,12 @@ fun callKotlinSuspendingMethod(\n     method: Method,\n     obj: Any,\n     args: Array<Any>,\n+    executorService: ExecutorService,\n     ctx: RequestContext\n ): CompletableFuture<Any?> {\n     val kFunction = checkNotNull(method.kotlinFunction) { \"method is not a suspending function\" }\n-    val coroutineContext = CoroutineContexts.getCoroutineContext(ctx)\n-    val newContext = Dispatchers.Unconfined + (coroutineContext ?: EmptyCoroutineContext)\n+    val coroutineContext = CoroutineContexts.getCoroutineContext(ctx) ?: EmptyCoroutineContext\n+    val newContext = executorService.asCoroutineDispatcher() + coroutineContext", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "967ca03e4790b2641dc83a5f11d30be1f4f56d6f"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18714e7a83471f26c0b6b6130b2772ae58bca930", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/18714e7a83471f26c0b6b6130b2772ae58bca930", "committedDate": "2020-08-12T14:04:03Z", "message": "Use eventLoop as coroutine dispatcher"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "967ca03e4790b2641dc83a5f11d30be1f4f56d6f", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/967ca03e4790b2641dc83a5f11d30be1f4f56d6f", "committedDate": "2020-08-12T12:07:13Z", "message": "Use eventLoop as coroutine dispatcher"}, "afterCommit": {"oid": "18714e7a83471f26c0b6b6130b2772ae58bca930", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/18714e7a83471f26c0b6b6130b2772ae58bca930", "committedDate": "2020-08-12T14:04:03Z", "message": "Use eventLoop as coroutine dispatcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c29d1edfcf6dd931eebe36495142a0ead249664a", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/c29d1edfcf6dd931eebe36495142a0ead249664a", "committedDate": "2020-08-13T01:36:03Z", "message": "Add example annotated-http-service-kotlin"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "054dcb3132737c77d72b0130a704676998e7824d", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/054dcb3132737c77d72b0130a704676998e7824d", "committedDate": "2020-08-12T17:05:05Z", "message": "Add example annotated-http-service-kotlin"}, "afterCommit": {"oid": "c29d1edfcf6dd931eebe36495142a0ead249664a", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/c29d1edfcf6dd931eebe36495142a0ead249664a", "committedDate": "2020-08-13T01:36:03Z", "message": "Add example annotated-http-service-kotlin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NjAwODQ5", "url": "https://github.com/line/armeria/pull/2983#pullrequestreview-467600849", "createdAt": "2020-08-14T14:03:46Z", "commit": {"oid": "c29d1edfcf6dd931eebe36495142a0ead249664a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNDowMzo0NlrOHA1ytg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNDowMzo0NlrOHA1ytg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY0MzM4Mg==", "bodyText": "Out of curiosity: Does ServiceRequestContext.current() work?", "url": "https://github.com/line/armeria/pull/2983#discussion_r470643382", "createdAt": "2020-08-14T14:03:46Z", "author": {"login": "trustin"}, "path": "examples/annotated-http-service-kotlin/src/main/kotlin/example/armeria/server/annotated/kotlin/ContextAwareService.kt", "diffHunk": "@@ -0,0 +1,57 @@\n+package example.armeria.server.annotated.kotlin\n+\n+import com.linecorp.armeria.common.RequestContext\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import com.linecorp.armeria.server.annotation.Get\n+import com.linecorp.armeria.server.annotation.Param\n+import com.linecorp.armeria.server.annotation.ProducesJson\n+import kotlinx.coroutines.asCoroutineDispatcher\n+import kotlinx.coroutines.withContext\n+import org.slf4j.LoggerFactory\n+import java.util.concurrent.Executors\n+\n+class ContextAwareService {\n+\n+    @Get(\"/foo\")\n+    @ProducesJson\n+    suspend fun foo(@Param(\"name\") name: String, @Param(\"id\") id: Int): FooResponse {\n+        log.info(\"Hello $name\")\n+        // Make sure that current thread is request context aware\n+        RequestContext.current<ServiceRequestContext>()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c29d1edfcf6dd931eebe36495142a0ead249664a"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NjAxNDA3", "url": "https://github.com/line/armeria/pull/2983#pullrequestreview-467601407", "createdAt": "2020-08-14T14:04:32Z", "commit": {"oid": "c29d1edfcf6dd931eebe36495142a0ead249664a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNDowNDozM1rOHA10UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNDowNDozM1rOHA10UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY0Mzc5Mg==", "bodyText": "Would it be better naming these methods as get() and set()?", "url": "https://github.com/line/armeria/pull/2983#discussion_r470643792", "createdAt": "2020-08-14T14:04:33Z", "author": {"login": "trustin"}, "path": "kotlin/src/main/java/com/linecorp/armeria/common/kotlin/CoroutineContexts.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.kotlin;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.internal.server.annotation.AnnotatedService;\n+import com.linecorp.armeria.server.kotlin.CoroutineContextService;\n+\n+import io.netty.util.AttributeKey;\n+import kotlin.coroutines.CoroutineContext;\n+\n+/**\n+ * Configures a coroutine context for annotated services and Kotlin suspending functions.\n+ *\n+ * @see CoroutineContextService\n+ */\n+public final class CoroutineContexts {\n+\n+    /**\n+     * {@link AnnotatedService} uses a coroutine context associated with this attribute\n+     * when calling suspending functions.\n+     */\n+    private static final AttributeKey<CoroutineContext> COROUTINE_CONTEXT_KEY =\n+            AttributeKey.valueOf(CoroutineContexts.class, \"COROUTINE_CONTEXT_KEY\");\n+\n+    /**\n+     * Associates the given coroutine context with {@code COROUTINE_CONTEXT_KEY} attribute in the context.\n+     */\n+    public static void setCoroutineContext(RequestContext ctx, CoroutineContext coroutineContext) {\n+        requireNonNull(ctx, \"ctx\");\n+        requireNonNull(coroutineContext, \"coroutineContext\");\n+        ctx.setAttr(COROUTINE_CONTEXT_KEY, coroutineContext);\n+    }\n+\n+    /**\n+     * Returns the coroutine context mapped to {@code COROUTINE_CONTEXT_KEY} in the context.\n+     */\n+    @Nullable\n+    public static CoroutineContext getCoroutineContext(RequestContext ctx) {\n+        requireNonNull(ctx, \"ctx\");\n+        return ctx.attr(COROUTINE_CONTEXT_KEY);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c29d1edfcf6dd931eebe36495142a0ead249664a"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NjAxODcy", "url": "https://github.com/line/armeria/pull/2983#pullrequestreview-467601872", "createdAt": "2020-08-14T14:05:05Z", "commit": {"oid": "c29d1edfcf6dd931eebe36495142a0ead249664a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNDowNTowNVrOHA11sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNDowNTowNVrOHA11sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY0NDE0Nw==", "bodyText": "Could you add final to all classes if possible?", "url": "https://github.com/line/armeria/pull/2983#discussion_r470644147", "createdAt": "2020-08-14T14:05:05Z", "author": {"login": "trustin"}, "path": "kotlin/src/main/java/com/linecorp/armeria/server/kotlin/CoroutineContextService.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.kotlin;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.function.Function;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.kotlin.CoroutineContextProvider;\n+import com.linecorp.armeria.common.kotlin.CoroutineContexts;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+import com.linecorp.armeria.server.SimpleDecoratingHttpService;\n+\n+/**\n+ * Decorates an {@link HttpService} to configure the coroutine context which is used as an initial context\n+ * of annotated services' suspending functions.\n+ *\n+ * <p>Example:\n+ * <pre>{@code\n+ * > serverBuilder\n+ * >     .annotatedService(object {\n+ * >         @Get(\"/users/{uid}\")\n+ * >         suspend fun foo(@Param(\"uid\") uid: String): HttpResponse {\n+ * >             ...\n+ * >         }\n+ * >     })\n+ * >     .decorator(CoroutineContextService.newDecorator { ctx ->\n+ * >         ctx.eventLoop().asCoroutineDispatcher() +\n+ * >             CoroutineName(ctx.config().defaultServiceName() ?: \"none\")\n+ * >     })\n+ * }\n+ * </pre>\n+ */\n+public class CoroutineContextService extends SimpleDecoratingHttpService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c29d1edfcf6dd931eebe36495142a0ead249664a"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11c6e3bbea332061f0f6afcf07dbcd826c235644", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/11c6e3bbea332061f0f6afcf07dbcd826c235644", "committedDate": "2020-08-14T20:31:18Z", "message": "address a comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ae6f69eacb467d64cb7cdcfa05689a2c9a87ddb", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/2ae6f69eacb467d64cb7cdcfa05689a2c9a87ddb", "committedDate": "2020-08-15T07:21:27Z", "message": "address a comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3OTU1MTU4", "url": "https://github.com/line/armeria/pull/2983#pullrequestreview-467955158", "createdAt": "2020-08-15T07:39:10Z", "commit": {"oid": "2ae6f69eacb467d64cb7cdcfa05689a2c9a87ddb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQwNzozOToxMVrOHBIhjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQwNzozOToxMVrOHBIhjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk1MDI4NA==", "bodyText": "Does a user need to do this? Can't Armeria make sure the function is run with a request context dispatcher?", "url": "https://github.com/line/armeria/pull/2983#discussion_r470950284", "createdAt": "2020-08-15T07:39:11Z", "author": {"login": "anuraaga"}, "path": "examples/annotated-http-service-kotlin/src/main/kotlin/example/armeria/server/annotated/kotlin/ContextAwareService.kt", "diffHunk": "@@ -0,0 +1,56 @@\n+package example.armeria.server.annotated.kotlin\n+\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import com.linecorp.armeria.server.annotation.Get\n+import com.linecorp.armeria.server.annotation.Param\n+import com.linecorp.armeria.server.annotation.ProducesJson\n+import kotlinx.coroutines.asCoroutineDispatcher\n+import kotlinx.coroutines.withContext\n+import org.slf4j.LoggerFactory\n+import java.util.concurrent.Executors\n+\n+class ContextAwareService {\n+\n+    @Get(\"/foo\")\n+    @ProducesJson\n+    suspend fun foo(@Param(\"name\") name: String, @Param(\"id\") id: Int): FooResponse {\n+        log.info(\"Hello $name\")\n+        // Make sure that current thread is request context aware\n+        ServiceRequestContext.current()\n+\n+        // Propagate armeria request context\n+        withContext(ArmeriaRequestContext()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ae6f69eacb467d64cb7cdcfa05689a2c9a87ddb"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4OTcyMDAz", "url": "https://github.com/line/armeria/pull/2983#pullrequestreview-468972003", "createdAt": "2020-08-18T03:49:24Z", "commit": {"oid": "2ae6f69eacb467d64cb7cdcfa05689a2c9a87ddb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab52890d185c02d12a776094e179d8590f989cee", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/ab52890d185c02d12a776094e179d8590f989cee", "committedDate": "2020-08-18T06:57:25Z", "message": "add tests for KotlinUtil"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "984e67faaa2ef0ef38e396ecd855ee2511fa5dbe", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/984e67faaa2ef0ef38e396ecd855ee2511fa5dbe", "committedDate": "2020-08-18T06:35:54Z", "message": "add tests for KotlinUtil"}, "afterCommit": {"oid": "ab52890d185c02d12a776094e179d8590f989cee", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/ab52890d185c02d12a776094e179d8590f989cee", "committedDate": "2020-08-18T06:57:25Z", "message": "add tests for KotlinUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e763ac806a07851726b219b3bad4393f63fe9244", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/e763ac806a07851726b219b3bad4393f63fe9244", "committedDate": "2020-08-18T16:16:09Z", "message": "update comment of CoroutineContextService.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae5427ae8c66a39fcb5193c59aaa2863c7306d09", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/ae5427ae8c66a39fcb5193c59aaa2863c7306d09", "committedDate": "2020-08-18T16:56:25Z", "message": "update KotlinUtil.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/1f0af0868c6ac8aae005f27fbfe030960d235be5", "committedDate": "2020-08-18T16:56:55Z", "message": "add comment to annotated-http-service-kotlin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5OTc0MDQ3", "url": "https://github.com/line/armeria/pull/2983#pullrequestreview-469974047", "createdAt": "2020-08-19T01:11:38Z", "commit": {"oid": "ab52890d185c02d12a776094e179d8590f989cee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMTA1NzIw", "url": "https://github.com/line/armeria/pull/2983#pullrequestreview-470105720", "createdAt": "2020-08-19T03:51:12Z", "commit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMzo1MToxM1rOHCwiSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwNDoxODoxNlrOHCxjbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY1NDQwOA==", "bodyText": "Could introduce a local variable for parameters.get(0)? Then it can be used at https://github.com/line/armeria/pull/2983/files#diff-f13d04b42f9611da57e897603ce21ff8R220", "url": "https://github.com/line/armeria/pull/2983#discussion_r472654408", "createdAt": "2020-08-19T03:51:13Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedValueResolver.java", "diffHunk": "@@ -208,23 +211,23 @@ static AnnotatedValueResolver ofBeanField(Field field, Set<String> pathParams,\n             // @Param\n             // void setter(@Header String name) { ... }\n             //\n-            if (isAnnotationPresent(parameters[0])) {\n+            if (isAnnotationPresent(parameters.get(0))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY1NzkxNA==", "bodyText": "How about introducing a local variable for the size of parameters and reuse it here and later.", "url": "https://github.com/line/armeria/pull/2983#discussion_r472657914", "createdAt": "2020-08-19T03:56:54Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedValueResolver.java", "diffHunk": "@@ -174,8 +174,11 @@ static AnnotatedValueResolver ofBeanField(Field field, Set<String> pathParams,\n                                                    List<RequestObjectResolver> objectResolvers,\n                                                    boolean implicitRequestObjectAnnotation,\n                                                    boolean isServiceMethod) {\n-        final Parameter[] parameters = constructorOrMethod.getParameters();\n-        if (parameters.length == 0) {\n+        final ImmutableList<Parameter> parameters =\n+                Arrays.stream(constructorOrMethod.getParameters())\n+                      .filter(it -> !KotlinUtil.isContinuation(it.getType()))\n+                      .collect(toImmutableList());\n+        if (parameters.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2MzIyMw==", "bodyText": "nit: Check IS_KOTLIN_REFLECTION_PRESENT first because it looks cheaper. \ud83d\ude09", "url": "https://github.com/line/armeria/pull/2983#discussion_r472663223", "createdAt": "2020-08-19T04:05:42Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/KotlinUtil.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import java.lang.annotation.Annotation;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.MethodType;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+\n+@SuppressWarnings(\"unchecked\")\n+final class KotlinUtil {\n+\n+    private static final boolean IS_KOTLIN_REFLECTION_PRESENT;\n+\n+    @Nullable\n+    private static final Class<? extends Annotation> METADATA_CLASS;\n+\n+    @Nullable\n+    private static final MethodHandle CALL_KOTLIN_SUSPENDING_METHOD;\n+\n+    @Nullable\n+    private static final Method IS_SUSPENDING_FUNCTION;\n+\n+    @Nullable\n+    private static final Method IS_CONTINUATION;\n+\n+    @Nullable\n+    private static final Method IS_RETURN_TYPE_UNIT;\n+\n+    static {\n+        MethodHandle callKotlinSuspendingMethod = null;\n+        try {\n+            final Class<?> coroutineUtilClass =\n+                    getClass(\"com.linecorp.armeria.internal.common.kotlin.CoroutineUtil\");\n+\n+            callKotlinSuspendingMethod = MethodHandles.lookup().findStatic(\n+                    coroutineUtilClass, \"callKotlinSuspendingMethod\",\n+                    MethodType.methodType(\n+                            CompletableFuture.class,\n+                            ImmutableList.of(Method.class, Object.class,\n+                                             Object[].class, ExecutorService.class,\n+                                             RequestContext.class))\n+            );\n+        } catch (ClassNotFoundException | NoSuchMethodException | IllegalAccessException e) {\n+            // ignore\n+        } finally {\n+            CALL_KOTLIN_SUSPENDING_METHOD = callKotlinSuspendingMethod;\n+        }\n+\n+        Method isContinuation = null;\n+        Method isSuspendingFunction = null;\n+        Method isReturnTypeUnit = null;\n+        try {\n+            final Class<?> kotlinUtilClass =\n+                    getClass(\"com.linecorp.armeria.internal.common.kotlin.KotlinUtil\");\n+\n+            isContinuation = kotlinUtilClass.getMethod(\"isContinuation\", Class.class);\n+            isSuspendingFunction = kotlinUtilClass.getMethod(\"isSuspendingFunction\", Method.class);\n+            isReturnTypeUnit = kotlinUtilClass.getMethod(\"isReturnTypeUnit\", Method.class);\n+        } catch (ClassNotFoundException | NoSuchMethodException e) {\n+            // ignore\n+        } finally {\n+            IS_CONTINUATION = isContinuation;\n+            IS_SUSPENDING_FUNCTION = isSuspendingFunction;\n+            IS_RETURN_TYPE_UNIT = isReturnTypeUnit;\n+        }\n+\n+        boolean isKotlinReflectionPresent = false;\n+        try {\n+            getClass(\"kotlin.reflect.full.KClasses\");\n+            isKotlinReflectionPresent = true;\n+        } catch (ClassNotFoundException e) {\n+            // ignore\n+        } finally {\n+            IS_KOTLIN_REFLECTION_PRESENT = isKotlinReflectionPresent;\n+        }\n+\n+        Class<? extends Annotation> metadataClass = null;\n+        try {\n+            metadataClass = (Class<? extends Annotation>) getClass(\"kotlin.Metadata\");\n+        } catch (ClassNotFoundException e) {\n+            // ignore\n+        } finally {\n+            METADATA_CLASS = metadataClass;\n+        }\n+    }\n+\n+    /**\n+     * Returns a method which invokes Kotlin suspending functions.\n+     */\n+    @Nullable\n+    static MethodHandle getCallKotlinSuspendingMethod() {\n+        return CALL_KOTLIN_SUSPENDING_METHOD;\n+    }\n+\n+    /**\n+     * Returns true if a method is written in Kotlin.\n+     */\n+    static boolean isKotlinMethod(Method method) {\n+        return METADATA_CLASS != null &&\n+               method.getDeclaringClass().getAnnotation(METADATA_CLASS) != null;\n+    }\n+\n+    /**\n+     * Returns true if a method is a suspending function.\n+     */\n+    static boolean isSuspendingFunction(Method method) {\n+        try {\n+            return isKotlinMethod(method) &&\n+                   IS_KOTLIN_REFLECTION_PRESENT &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NDM5Mw==", "bodyText": "Is it possible to return boolean? The returned value of IS_CONTINUATION is casted to boolean.", "url": "https://github.com/line/armeria/pull/2983#discussion_r472664393", "createdAt": "2020-08-19T04:07:41Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/KotlinUtil.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import java.lang.annotation.Annotation;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.MethodType;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+\n+@SuppressWarnings(\"unchecked\")\n+final class KotlinUtil {\n+\n+    private static final boolean IS_KOTLIN_REFLECTION_PRESENT;\n+\n+    @Nullable\n+    private static final Class<? extends Annotation> METADATA_CLASS;\n+\n+    @Nullable\n+    private static final MethodHandle CALL_KOTLIN_SUSPENDING_METHOD;\n+\n+    @Nullable\n+    private static final Method IS_SUSPENDING_FUNCTION;\n+\n+    @Nullable\n+    private static final Method IS_CONTINUATION;\n+\n+    @Nullable\n+    private static final Method IS_RETURN_TYPE_UNIT;\n+\n+    static {\n+        MethodHandle callKotlinSuspendingMethod = null;\n+        try {\n+            final Class<?> coroutineUtilClass =\n+                    getClass(\"com.linecorp.armeria.internal.common.kotlin.CoroutineUtil\");\n+\n+            callKotlinSuspendingMethod = MethodHandles.lookup().findStatic(\n+                    coroutineUtilClass, \"callKotlinSuspendingMethod\",\n+                    MethodType.methodType(\n+                            CompletableFuture.class,\n+                            ImmutableList.of(Method.class, Object.class,\n+                                             Object[].class, ExecutorService.class,\n+                                             RequestContext.class))\n+            );\n+        } catch (ClassNotFoundException | NoSuchMethodException | IllegalAccessException e) {\n+            // ignore\n+        } finally {\n+            CALL_KOTLIN_SUSPENDING_METHOD = callKotlinSuspendingMethod;\n+        }\n+\n+        Method isContinuation = null;\n+        Method isSuspendingFunction = null;\n+        Method isReturnTypeUnit = null;\n+        try {\n+            final Class<?> kotlinUtilClass =\n+                    getClass(\"com.linecorp.armeria.internal.common.kotlin.KotlinUtil\");\n+\n+            isContinuation = kotlinUtilClass.getMethod(\"isContinuation\", Class.class);\n+            isSuspendingFunction = kotlinUtilClass.getMethod(\"isSuspendingFunction\", Method.class);\n+            isReturnTypeUnit = kotlinUtilClass.getMethod(\"isReturnTypeUnit\", Method.class);\n+        } catch (ClassNotFoundException | NoSuchMethodException e) {\n+            // ignore\n+        } finally {\n+            IS_CONTINUATION = isContinuation;\n+            IS_SUSPENDING_FUNCTION = isSuspendingFunction;\n+            IS_RETURN_TYPE_UNIT = isReturnTypeUnit;\n+        }\n+\n+        boolean isKotlinReflectionPresent = false;\n+        try {\n+            getClass(\"kotlin.reflect.full.KClasses\");\n+            isKotlinReflectionPresent = true;\n+        } catch (ClassNotFoundException e) {\n+            // ignore\n+        } finally {\n+            IS_KOTLIN_REFLECTION_PRESENT = isKotlinReflectionPresent;\n+        }\n+\n+        Class<? extends Annotation> metadataClass = null;\n+        try {\n+            metadataClass = (Class<? extends Annotation>) getClass(\"kotlin.Metadata\");\n+        } catch (ClassNotFoundException e) {\n+            // ignore\n+        } finally {\n+            METADATA_CLASS = metadataClass;\n+        }\n+    }\n+\n+    /**\n+     * Returns a method which invokes Kotlin suspending functions.\n+     */\n+    @Nullable\n+    static MethodHandle getCallKotlinSuspendingMethod() {\n+        return CALL_KOTLIN_SUSPENDING_METHOD;\n+    }\n+\n+    /**\n+     * Returns true if a method is written in Kotlin.\n+     */\n+    static boolean isKotlinMethod(Method method) {\n+        return METADATA_CLASS != null &&\n+               method.getDeclaringClass().getAnnotation(METADATA_CLASS) != null;\n+    }\n+\n+    /**\n+     * Returns true if a method is a suspending function.\n+     */\n+    static boolean isSuspendingFunction(Method method) {\n+        try {\n+            return isKotlinMethod(method) &&\n+                   IS_KOTLIN_REFLECTION_PRESENT &&\n+                   IS_SUSPENDING_FUNCTION != null &&\n+                   (Boolean) IS_SUSPENDING_FUNCTION.invoke(null, method);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NTAyMg==", "bodyText": "nit: Merge two lines?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private KotlinUtil() {\n          \n          \n            \n                }\n          \n          \n            \n                private KotlinUtil() {}", "url": "https://github.com/line/armeria/pull/2983#discussion_r472665022", "createdAt": "2020-08-19T04:08:42Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/KotlinUtil.java", "diffHunk": "@@ -0,0 +1,172 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import java.lang.annotation.Annotation;\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.lang.invoke.MethodType;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutorService;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.common.RequestContext;\n+\n+@SuppressWarnings(\"unchecked\")\n+final class KotlinUtil {\n+\n+    private static final boolean IS_KOTLIN_REFLECTION_PRESENT;\n+\n+    @Nullable\n+    private static final Class<? extends Annotation> METADATA_CLASS;\n+\n+    @Nullable\n+    private static final MethodHandle CALL_KOTLIN_SUSPENDING_METHOD;\n+\n+    @Nullable\n+    private static final Method IS_SUSPENDING_FUNCTION;\n+\n+    @Nullable\n+    private static final Method IS_CONTINUATION;\n+\n+    @Nullable\n+    private static final Method IS_RETURN_TYPE_UNIT;\n+\n+    static {\n+        MethodHandle callKotlinSuspendingMethod = null;\n+        try {\n+            final Class<?> coroutineUtilClass =\n+                    getClass(\"com.linecorp.armeria.internal.common.kotlin.CoroutineUtil\");\n+\n+            callKotlinSuspendingMethod = MethodHandles.lookup().findStatic(\n+                    coroutineUtilClass, \"callKotlinSuspendingMethod\",\n+                    MethodType.methodType(\n+                            CompletableFuture.class,\n+                            ImmutableList.of(Method.class, Object.class,\n+                                             Object[].class, ExecutorService.class,\n+                                             RequestContext.class))\n+            );\n+        } catch (ClassNotFoundException | NoSuchMethodException | IllegalAccessException e) {\n+            // ignore\n+        } finally {\n+            CALL_KOTLIN_SUSPENDING_METHOD = callKotlinSuspendingMethod;\n+        }\n+\n+        Method isContinuation = null;\n+        Method isSuspendingFunction = null;\n+        Method isReturnTypeUnit = null;\n+        try {\n+            final Class<?> kotlinUtilClass =\n+                    getClass(\"com.linecorp.armeria.internal.common.kotlin.KotlinUtil\");\n+\n+            isContinuation = kotlinUtilClass.getMethod(\"isContinuation\", Class.class);\n+            isSuspendingFunction = kotlinUtilClass.getMethod(\"isSuspendingFunction\", Method.class);\n+            isReturnTypeUnit = kotlinUtilClass.getMethod(\"isReturnTypeUnit\", Method.class);\n+        } catch (ClassNotFoundException | NoSuchMethodException e) {\n+            // ignore\n+        } finally {\n+            IS_CONTINUATION = isContinuation;\n+            IS_SUSPENDING_FUNCTION = isSuspendingFunction;\n+            IS_RETURN_TYPE_UNIT = isReturnTypeUnit;\n+        }\n+\n+        boolean isKotlinReflectionPresent = false;\n+        try {\n+            getClass(\"kotlin.reflect.full.KClasses\");\n+            isKotlinReflectionPresent = true;\n+        } catch (ClassNotFoundException e) {\n+            // ignore\n+        } finally {\n+            IS_KOTLIN_REFLECTION_PRESENT = isKotlinReflectionPresent;\n+        }\n+\n+        Class<? extends Annotation> metadataClass = null;\n+        try {\n+            metadataClass = (Class<? extends Annotation>) getClass(\"kotlin.Metadata\");\n+        } catch (ClassNotFoundException e) {\n+            // ignore\n+        } finally {\n+            METADATA_CLASS = metadataClass;\n+        }\n+    }\n+\n+    /**\n+     * Returns a method which invokes Kotlin suspending functions.\n+     */\n+    @Nullable\n+    static MethodHandle getCallKotlinSuspendingMethod() {\n+        return CALL_KOTLIN_SUSPENDING_METHOD;\n+    }\n+\n+    /**\n+     * Returns true if a method is written in Kotlin.\n+     */\n+    static boolean isKotlinMethod(Method method) {\n+        return METADATA_CLASS != null &&\n+               method.getDeclaringClass().getAnnotation(METADATA_CLASS) != null;\n+    }\n+\n+    /**\n+     * Returns true if a method is a suspending function.\n+     */\n+    static boolean isSuspendingFunction(Method method) {\n+        try {\n+            return isKotlinMethod(method) &&\n+                   IS_KOTLIN_REFLECTION_PRESENT &&\n+                   IS_SUSPENDING_FUNCTION != null &&\n+                   (Boolean) IS_SUSPENDING_FUNCTION.invoke(null, method);\n+        } catch (Exception e) {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Returns true if a class is kotlin.coroutines.Continuation.\n+     */\n+    static boolean isContinuation(Class<?> type) {\n+        try {\n+            return IS_CONTINUATION != null &&\n+                   (boolean) IS_CONTINUATION.invoke(null, type);\n+        } catch (Exception e) {\n+            return false;\n+        }\n+    }\n+\n+    /**\n+     * Returns true if a method is suspending function and it returns kotlin.Unit.\n+     */\n+    static boolean isSuspendingAndReturnTypeUnit(Method method) {\n+        try {\n+            return isSuspendingFunction(method) &&\n+                   IS_RETURN_TYPE_UNIT != null &&\n+                   (boolean) IS_RETURN_TYPE_UNIT.invoke(null, method);\n+        } catch (Exception e) {\n+            return false;\n+        }\n+    }\n+\n+    private static Class<?> getClass(String name) throws ClassNotFoundException {\n+        return Class.forName(name, true, KotlinUtil.class.getClassLoader());\n+    }\n+\n+    private KotlinUtil() {\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NTI1OQ==", "bodyText": "Cruft?", "url": "https://github.com/line/armeria/pull/2983#discussion_r472665259", "createdAt": "2020-08-19T04:09:05Z", "author": {"login": "ikhoon"}, "path": "core/src/test/java/com/linecorp/armeria/internal/server/annotation/KotlinUtilTest.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.lang.reflect.Method;\n+\n+import org.junit.jupiter.api.Test;\n+\n+/**\n+ * Without kotlin dependencies, all functions return false or null safely.\n+ */\n+class KotlinUtilTest {\n+\n+    @Test\n+    void getCallKotlinSuspendingMethod() {\n+        assertThat(KotlinUtil.getCallKotlinSuspendingMethod()).isNull();\n+    }\n+\n+    @Test\n+    void isContinuation() {\n+        assertThat(KotlinUtil.isContinuation(String.class)).isFalse();\n+    }\n+\n+    @Test\n+    void isKotlinMethod() throws NoSuchMethodException {\n+        final Method testMethod = KotlinUtilTest.class.getDeclaredMethod(\"testMethod\");\n+        assertThat(KotlinUtil.isKotlinMethod(testMethod)).isFalse();\n+    }\n+\n+    @Test\n+    void isSuspendingFunction() throws NoSuchMethodException {\n+        final Method testMethod = KotlinUtilTest.class.getDeclaredMethod(\"testMethod\");\n+        assertThat(KotlinUtil.isSuspendingFunction(testMethod)).isFalse();\n+    }\n+\n+    @Test\n+    void isSuspendingAndReturnTypeUnit() throws NoSuchMethodException {\n+        final Method testMethod = KotlinUtilTest.class.getDeclaredMethod(\"testMethod\");\n+        assertThat(KotlinUtil.isSuspendingAndReturnTypeUnit(testMethod)).isFalse();\n+    }\n+\n+    void testMethod() {\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY2NjUyMw==", "bodyText": "Could be simplified?\nreturn requestContext?.push()", "url": "https://github.com/line/armeria/pull/2983#discussion_r472666523", "createdAt": "2020-08-19T04:10:58Z", "author": {"login": "ikhoon"}, "path": "examples/annotated-http-service-kotlin/src/main/kotlin/example/armeria/server/annotated/kotlin/ArmeriaRequestContext.kt", "diffHunk": "@@ -0,0 +1,26 @@\n+package example.armeria.server.annotated.kotlin\n+\n+import com.linecorp.armeria.common.util.SafeCloseable\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import kotlinx.coroutines.ThreadContextElement\n+import kotlin.coroutines.AbstractCoroutineContextElement\n+import kotlin.coroutines.CoroutineContext\n+\n+/**\n+ * Propagates [ServiceRequestContext] over coroutines.\n+ */\n+class ArmeriaRequestContext(\n+    private val requestContext: ServiceRequestContext? = ServiceRequestContext.currentOrNull()\n+) : ThreadContextElement<SafeCloseable?>, AbstractCoroutineContextElement(Key) {\n+\n+    companion object Key : CoroutineContext.Key<ArmeriaRequestContext>\n+\n+    override fun updateThreadContext(context: CoroutineContext): SafeCloseable? {\n+        if (requestContext == null) return null\n+        return requestContext.push()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY3MDUyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class KotlinUtilWithKotlinDependenciesTest {\n          \n          \n            \n            class KotlinUtilWithKotlinDependenciesTest {", "url": "https://github.com/line/armeria/pull/2983#discussion_r472670526", "createdAt": "2020-08-19T04:17:20Z", "author": {"login": "ikhoon"}, "path": "kotlin/src/test/java/com/linecorp/armeria/internal/server/annotation/KotlinUtilWithKotlinDependenciesTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.server.ExampleService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+import kotlin.coroutines.Continuation;\n+\n+public class KotlinUtilWithKotlinDependenciesTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY3MDYxNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public KotlinUtilWithKotlinDependenciesTest() throws NoSuchMethodException {\n          \n          \n            \n                KotlinUtilWithKotlinDependenciesTest() throws NoSuchMethodException {", "url": "https://github.com/line/armeria/pull/2983#discussion_r472670615", "createdAt": "2020-08-19T04:17:30Z", "author": {"login": "ikhoon"}, "path": "kotlin/src/test/java/com/linecorp/armeria/internal/server/annotation/KotlinUtilWithKotlinDependenciesTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.server.ExampleService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+import kotlin.coroutines.Continuation;\n+\n+public class KotlinUtilWithKotlinDependenciesTest {\n+    final ExampleService exampleService;\n+    final Method normal;\n+    final Method suspendingUnit;\n+    final Method suspendingInt;\n+\n+    public KotlinUtilWithKotlinDependenciesTest() throws NoSuchMethodException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY3MDkxMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(res.get()).isEqualTo(null);\n          \n          \n            \n                    assertThat(res.get()).isNull();", "url": "https://github.com/line/armeria/pull/2983#discussion_r472670911", "createdAt": "2020-08-19T04:17:59Z", "author": {"login": "ikhoon"}, "path": "kotlin/src/test/java/com/linecorp/armeria/internal/server/annotation/KotlinUtilWithKotlinDependenciesTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.server.ExampleService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+import kotlin.coroutines.Continuation;\n+\n+public class KotlinUtilWithKotlinDependenciesTest {\n+    final ExampleService exampleService;\n+    final Method normal;\n+    final Method suspendingUnit;\n+    final Method suspendingInt;\n+\n+    public KotlinUtilWithKotlinDependenciesTest() throws NoSuchMethodException {\n+        exampleService = new ExampleService();\n+        normal = ExampleService.class.getDeclaredMethod(\"normal\");\n+        suspendingUnit = ExampleService.class.getDeclaredMethod(\"suspendingUnit\", Continuation.class);\n+        suspendingInt = ExampleService.class.getDeclaredMethod(\"suspendingInt\", Continuation.class);\n+    }\n+\n+    @Test\n+    void getCallKotlinSuspendingMethod() {\n+        assertThat(KotlinUtil.getCallKotlinSuspendingMethod()).isNotNull();\n+    }\n+\n+    @Test\n+    void invokeSuspendingInt() throws Throwable {\n+        final MethodHandle callSuspendingMethod = KotlinUtil.getCallKotlinSuspendingMethod();\n+\n+        final RequestContext ctx = getRequestContext();\n+        final CompletableFuture<?> res =\n+                (CompletableFuture<?>) callSuspendingMethod.invoke(suspendingInt, exampleService,\n+                                                                   new Object[0], ctx.eventLoop(), ctx);\n+        assertThat(res.get()).isEqualTo(1);\n+    }\n+\n+    @Test\n+    void invokeSuspendingUnit() throws Throwable {\n+        final MethodHandle callSuspendingMethod = KotlinUtil.getCallKotlinSuspendingMethod();\n+\n+        final RequestContext ctx = getRequestContext();\n+        final CompletableFuture<?> res =\n+                (CompletableFuture<?>) callSuspendingMethod.invoke(suspendingUnit, exampleService,\n+                                                                   new Object[0], ctx.eventLoop(), ctx);\n+        assertThat(res.get()).isEqualTo(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjY3MTA4Ng==", "bodyText": "Could be static?", "url": "https://github.com/line/armeria/pull/2983#discussion_r472671086", "createdAt": "2020-08-19T04:18:16Z", "author": {"login": "ikhoon"}, "path": "kotlin/src/test/java/com/linecorp/armeria/internal/server/annotation/KotlinUtilWithKotlinDependenciesTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.lang.reflect.Method;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.RequestContext;\n+import com.linecorp.armeria.server.ExampleService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+import kotlin.coroutines.Continuation;\n+\n+public class KotlinUtilWithKotlinDependenciesTest {\n+    final ExampleService exampleService;\n+    final Method normal;\n+    final Method suspendingUnit;\n+    final Method suspendingInt;\n+\n+    public KotlinUtilWithKotlinDependenciesTest() throws NoSuchMethodException {\n+        exampleService = new ExampleService();\n+        normal = ExampleService.class.getDeclaredMethod(\"normal\");\n+        suspendingUnit = ExampleService.class.getDeclaredMethod(\"suspendingUnit\", Continuation.class);\n+        suspendingInt = ExampleService.class.getDeclaredMethod(\"suspendingInt\", Continuation.class);\n+    }\n+\n+    @Test\n+    void getCallKotlinSuspendingMethod() {\n+        assertThat(KotlinUtil.getCallKotlinSuspendingMethod()).isNotNull();\n+    }\n+\n+    @Test\n+    void invokeSuspendingInt() throws Throwable {\n+        final MethodHandle callSuspendingMethod = KotlinUtil.getCallKotlinSuspendingMethod();\n+\n+        final RequestContext ctx = getRequestContext();\n+        final CompletableFuture<?> res =\n+                (CompletableFuture<?>) callSuspendingMethod.invoke(suspendingInt, exampleService,\n+                                                                   new Object[0], ctx.eventLoop(), ctx);\n+        assertThat(res.get()).isEqualTo(1);\n+    }\n+\n+    @Test\n+    void invokeSuspendingUnit() throws Throwable {\n+        final MethodHandle callSuspendingMethod = KotlinUtil.getCallKotlinSuspendingMethod();\n+\n+        final RequestContext ctx = getRequestContext();\n+        final CompletableFuture<?> res =\n+                (CompletableFuture<?>) callSuspendingMethod.invoke(suspendingUnit, exampleService,\n+                                                                   new Object[0], ctx.eventLoop(), ctx);\n+        assertThat(res.get()).isEqualTo(null);\n+    }\n+\n+    @Test\n+    void isContinuation() {\n+        assertThat(KotlinUtil.isContinuation(String.class)).isFalse();\n+        assertThat(KotlinUtil.isContinuation(Continuation.class)).isTrue();\n+    }\n+\n+    @Test\n+    void isKotlinMethod() {\n+        assertThat(KotlinUtil.isKotlinMethod(normal)).isTrue();\n+        assertThat(KotlinUtil.isKotlinMethod(suspendingInt)).isTrue();\n+        assertThat(KotlinUtil.isKotlinMethod(suspendingUnit)).isTrue();\n+    }\n+\n+    @Test\n+    void isSuspendingFunction() {\n+        assertThat(KotlinUtil.isSuspendingFunction(normal)).isFalse();\n+        assertThat(KotlinUtil.isSuspendingFunction(suspendingInt)).isTrue();\n+        assertThat(KotlinUtil.isSuspendingFunction(suspendingUnit)).isTrue();\n+    }\n+\n+    @Test\n+    void isSuspendingAndReturnTypeUnit() {\n+        assertThat(KotlinUtil.isSuspendingAndReturnTypeUnit(normal)).isFalse();\n+        assertThat(KotlinUtil.isSuspendingAndReturnTypeUnit(suspendingInt)).isFalse();\n+        assertThat(KotlinUtil.isSuspendingAndReturnTypeUnit(suspendingUnit)).isTrue();\n+    }\n+\n+    private RequestContext getRequestContext() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f0af0868c6ac8aae005f27fbfe030960d235be5"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6772bff524122753a82d4208794ce0c55247284", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/a6772bff524122753a82d4208794ce0c55247284", "committedDate": "2020-08-19T05:15:04Z", "message": "address a comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMjEyMTQx", "url": "https://github.com/line/armeria/pull/2983#pullrequestreview-470212141", "createdAt": "2020-08-19T07:56:07Z", "commit": {"oid": "a6772bff524122753a82d4208794ce0c55247284"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 42, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}