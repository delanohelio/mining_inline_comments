{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NDMzMTYz", "number": 2376, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNzo1NjozN1rODV6EOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNzo1NjozN1rODV6EOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0Mjk4MDQwOnYy", "diffSide": "RIGHT", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNzo1NjozN1rOFaXTtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwNzo1NjozN1rOFaXTtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE4OTE3Mw==", "bodyText": "Cool check :)", "url": "https://github.com/line/armeria/pull/2376#discussion_r363189173", "createdAt": "2020-01-06T07:56:37Z", "author": {"login": "anuraaga"}, "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientFactory.java", "diffHunk": "@@ -101,61 +102,78 @@\n         final SerializationFormat serializationFormat = scheme.serializationFormat();\n         final Class<?> stubClass = clientType.getEnclosingClass();\n         if (stubClass == null) {\n-            throw new IllegalArgumentException(\"Client type not a gRPC client stub class, \" +\n-                                               \"should be something like ServiceNameGrpc.ServiceNameXXStub: \" +\n-                                               clientType);\n-        }\n-        final Method newStubMethod;\n-        final Method newBlockingStubMethod;\n-        final Method newFutureStubMethod;\n-        try {\n-            newStubMethod = stubClass.getDeclaredMethod(\"newStub\", Channel.class);\n-            newBlockingStubMethod = stubClass.getDeclaredMethod(\"newBlockingStub\", Channel.class);\n-            newFutureStubMethod = stubClass.getDeclaredMethod(\"newFutureStub\", Channel.class);\n-        } catch (NoSuchMethodException e) {\n-            throw new IllegalArgumentException(\"Client type not a gRPC client stub class, \" +\n-                                               \"should be something like ServiceNameGrpc.ServiceNameXXStub: \" +\n-                                               clientType, e);\n-        }\n-        final Method createClientMethod;\n-        if (newStubMethod.getReturnType() == clientType) {\n-            createClientMethod = newStubMethod;\n-        } else if (newBlockingStubMethod.getReturnType() == clientType) {\n-            createClientMethod = newBlockingStubMethod;\n-        } else if (newFutureStubMethod.getReturnType() == clientType) {\n-            createClientMethod = newFutureStubMethod;\n-        } else {\n-            throw new IllegalArgumentException(\"Client type not a gRPC client stub class, \" +\n-                                               \"should be something like ServiceNameGrpc.ServiceNameXXStub: \" +\n-                                               clientType);\n+            throw newUnknownClientTypeException(clientType);\n         }\n \n-        final HttpClient httpClient = newHttpClient(uri, scheme, options);\n+        final Method stubFactoryMethod = findStubFactoryMethod(clientType, stubClass);\n \n         final MessageMarshaller jsonMarshaller =\n                 GrpcSerializationFormats.isJson(serializationFormat) ?\n                 GrpcJsonUtil.jsonMarshaller(\n                         stubMethods(stubClass),\n                         options.getOrElse(GrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER, NO_OP)) : null;\n+\n         final ArmeriaChannel channel = new ArmeriaChannel(\n                 ClientBuilderParams.of(this,\n                                        Strings.isNullOrEmpty(uri.getPath()) ? rootPathUri(uri) : uri,\n                                        clientType, options),\n-                httpClient,\n+                newHttpClient(uri, scheme, options),\n                 meterRegistry(),\n                 scheme.sessionProtocol(),\n                 endpoint,\n                 serializationFormat,\n                 jsonMarshaller);\n \n         try {\n-            // Verified createClientMethod.getReturnType == clientType\n+            // Verified stubFactoryMethod.getReturnType() == clientType in findStubFactoryMethod().\n             @SuppressWarnings(\"unchecked\")\n-            final T stub = (T) createClientMethod.invoke(null, channel);\n+            final T stub = (T) stubFactoryMethod.invoke(null, channel);\n             return stub;\n         } catch (IllegalAccessException | InvocationTargetException e) {\n-            throw new IllegalStateException(\"Could not create stub through reflection.\", e);\n+            throw new IllegalStateException(\"Could not create a gRPC stub through reflection.\", e);\n+        }\n+    }\n+\n+    private static <T> Method findStubFactoryMethod(Class<T> clientType, Class<?> stubClass) {\n+        Method newStubMethod = null;\n+        for (Method method : stubClass.getDeclaredMethods()) {\n+            final int methodModifiers = method.getModifiers();\n+            if (!(Modifier.isPublic(methodModifiers) && Modifier.isStatic(methodModifiers))) {\n+                // Must be public and static.\n+                continue;\n+            }\n+\n+            final String methodName = method.getName();\n+            if (!(methodName.startsWith(\"new\") && methodName.endsWith(\"Stub\"))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ca6d5ee3aff694355e165e15763c2b9e88ef180"}, "originalPosition": 86}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2876, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}