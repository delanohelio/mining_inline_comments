{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MDM4Mzc2", "number": 3197, "title": "Provide a way to customize gRPC Status mapping rule", "bodyText": "Motivation:\nWhen an exception is raised, the exception is converted to gRPC Status by:\n\nGrpcStatus.fromThrowable() provided by Armeria\n\n  \n    \n      armeria/grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/GrpcStatus.java\n    \n    \n        Lines 76 to 80\n      in\n      ca2c25f\n    \n    \n    \n    \n\n        \n          \n               /** \n        \n\n        \n          \n                * Converts the {@link Throwable} to a {@link Status}, taking into account exceptions specific to Armeria as \n        \n\n        \n          \n                * well and the protocol package. \n        \n\n        \n          \n                */ \n        \n\n        \n          \n               public static Status fromThrowable(Throwable t) { \n        \n    \n  \n\n\nStatus.fromThrowable() provided by gRPC-Java\nhttps://github.com/grpc/grpc-java/blob/3811ef3d22f90ae8da8200964d178cbd829ee9f8/api/src/main/java/io/grpc/Status.java#L390-L396\n\nHowever, there are no extension points that allow users to map an exception to gRPC status.\nModifications:\n\nAdd addExceptionMapping() and exceptionMapping() to GrpcServiceBuilder for mapping an exception to a gRPC status.\nGrpcService.builder()\n           .addExceptionMapping(AccessDeniedException.class, Status.UNAUTHENTICATED);\n\nSort exception mappings in descending exception hierarchy. A more specific type/subtype has a higher priority.\nCheck the exception mapping rules when a gRPC call is closed with an exception or a status containing an exception.\nFix a bug where ArmeriaClientCall.onNext() throws an exception.\n\nIt should return normally as per Reactive Streams specification 2.13\n\n\n\nResult:\n\nYou can now  GrpcServiceBuilder.addExceptionMapping() or GrpcServiceBuilder.exceptionMapping() for a custom gRPC exception mapping rule.\nFixes: #3191", "createdAt": "2020-11-26T12:15:17Z", "url": "https://github.com/line/armeria/pull/3197", "merged": true, "mergeCommit": {"oid": "0f29584729b3794883231dc746ea6f76c8125b9f"}, "closed": true, "closedAt": "2020-11-30T12:19:45Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgjOtEgFqTUzOTc4NDIzMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhg-fIgFqTU0MDY4MDMzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5Nzg0MjMz", "url": "https://github.com/line/armeria/pull/3197#pullrequestreview-539784233", "createdAt": "2020-11-27T08:25:33Z", "commit": {"oid": "9ae6d1d81fe734b0a52445e5a67d685f4893a721"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwODoyNTozM1rOH608MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yN1QwODoyNTozM1rOH608MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ0NjgzMw==", "bodyText": "Should we iterate and use isAssignableFrom() instead?", "url": "https://github.com/line/armeria/pull/3197#discussion_r531446833", "createdAt": "2020-11-27T08:25:33Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/GrpcStatusUtil.java", "diffHunk": "@@ -80,6 +85,13 @@\n     public static Status fromThrowable(Throwable t) {\n         t = unwrap(requireNonNull(t, \"t\"));\n \n+        if (!exceptionMappings.isEmpty()) {\n+            final Status status = exceptionMappings.get(t.getClass());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ae6d1d81fe734b0a52445e5a67d685f4893a721"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dde9d6d1369ffaaef0a9c40153cc0f3c7badaf87", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/dde9d6d1369ffaaef0a9c40153cc0f3c7badaf87", "committedDate": "2020-11-28T13:28:00Z", "message": "Provide a way to customize gRPC Status mapping rule\n\nMotivation:\n\nWhen an exception is raised, the exception is converted to gRPC Status by:\n- `GrpcStatus.fromThrowable()` provided by Armeria\n  https://github.com/line/armeria/blob/ca2c25fde0d5a2ae7f4d99a4e511ef307e1fa5fa/grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/GrpcStatus.java#L76-L80\n- `Status.fromThrowable()` provided by gRPC-Java\n  https://github.com/grpc/grpc-java/blob/3811ef3d22f90ae8da8200964d178cbd829ee9f8/api/src/main/java/io/grpc/Status.java#L390-L396\n\nHowever, there is no extension point that allows users to map an exception to gRPC status.\n\nModifications:\n\n- Add `registerException()` that maps an excepiton class to gRPC status.\n  ```\n  import com.linecorp.armeria.common.grpc.GrpcStatus;\n\n  GrpcStatus.registerException(AccessDeniedException.class, Status.UNAUTHENTICATED);\n  ```\n- Rename `internal.GrpcStatus` to `internal.GrpcStatusUtil` for avoiding naming conflicts.\n\nResult:\n\n- You can now override the default gRPC mapping rule using `GrpcStatus.registerException()`.\n- Fixes: #3191"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ae6d1d81fe734b0a52445e5a67d685f4893a721", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/9ae6d1d81fe734b0a52445e5a67d685f4893a721", "committedDate": "2020-11-27T03:31:31Z", "message": "Fix checkstyle"}, "afterCommit": {"oid": "dde9d6d1369ffaaef0a9c40153cc0f3c7badaf87", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/dde9d6d1369ffaaef0a9c40153cc0f3c7badaf87", "committedDate": "2020-11-28T13:28:00Z", "message": "Provide a way to customize gRPC Status mapping rule\n\nMotivation:\n\nWhen an exception is raised, the exception is converted to gRPC Status by:\n- `GrpcStatus.fromThrowable()` provided by Armeria\n  https://github.com/line/armeria/blob/ca2c25fde0d5a2ae7f4d99a4e511ef307e1fa5fa/grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/GrpcStatus.java#L76-L80\n- `Status.fromThrowable()` provided by gRPC-Java\n  https://github.com/grpc/grpc-java/blob/3811ef3d22f90ae8da8200964d178cbd829ee9f8/api/src/main/java/io/grpc/Status.java#L390-L396\n\nHowever, there is no extension point that allows users to map an exception to gRPC status.\n\nModifications:\n\n- Add `registerException()` that maps an excepiton class to gRPC status.\n  ```\n  import com.linecorp.armeria.common.grpc.GrpcStatus;\n\n  GrpcStatus.registerException(AccessDeniedException.class, Status.UNAUTHENTICATED);\n  ```\n- Rename `internal.GrpcStatus` to `internal.GrpcStatusUtil` for avoiding naming conflicts.\n\nResult:\n\n- You can now override the default gRPC mapping rule using `GrpcStatus.registerException()`.\n- Fixes: #3191"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15b17e4cdb2d8a2e13c57d68c4a2c375f427ca91", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/15b17e4cdb2d8a2e13c57d68c4a2c375f427ca91", "committedDate": "2020-11-28T13:46:59Z", "message": "Clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a325470025712ca249a970fe18e5f3e52d357d00", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/a325470025712ca249a970fe18e5f3e52d357d00", "committedDate": "2020-11-28T13:55:01Z", "message": "indent"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62554adddeb895f010ded3b979aa68be5b8d674f", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/62554adddeb895f010ded3b979aa68be5b8d674f", "committedDate": "2020-11-28T13:53:54Z", "message": "indent"}, "afterCommit": {"oid": "a325470025712ca249a970fe18e5f3e52d357d00", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/a325470025712ca249a970fe18e5f3e52d357d00", "committedDate": "2020-11-28T13:55:01Z", "message": "indent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cd81a0ad30b7782f003cca101ff89dc87aa7a89", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/8cd81a0ad30b7782f003cca101ff89dc87aa7a89", "committedDate": "2020-11-28T14:05:37Z", "message": "Remove unsed imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24b552d2445b0bd8907b8c7d6965121b0fe53e34", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/24b552d2445b0bd8907b8c7d6965121b0fe53e34", "committedDate": "2020-11-28T16:32:44Z", "message": "Add gRPC client interceptor test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bab87d0b2549fe9f779d8b60e11e6665cab1e43", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/6bab87d0b2549fe9f779d8b60e11e6665cab1e43", "committedDate": "2020-11-28T16:50:10Z", "message": "Merge branch 'master' into grpc-status-mapping"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzkxNjkw", "url": "https://github.com/line/armeria/pull/3197#pullrequestreview-540391690", "createdAt": "2020-11-28T16:54:32Z", "commit": {"oid": "6bab87d0b2549fe9f779d8b60e11e6665cab1e43"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQxNjo1NDozM1rOH7aaAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQxNjo1NDozM1rOH7aaAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA2MDY3Mg==", "bodyText": "This is a bug fix. onNext() of Subscriber should return normally.\nhttps://github.com/reactive-streams/reactive-streams-jvm#2.13", "url": "https://github.com/line/armeria/pull/3197#discussion_r532060672", "createdAt": "2020-11-28T16:54:33Z", "author": {"login": "ikhoon"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaClientCall.java", "diffHunk": "@@ -390,8 +397,9 @@ public void onNext(DeframedMessage message) {\n                 listener.onMessage(msg);\n             }\n         } catch (Throwable t) {\n-            req.close(GrpcStatus.fromThrowable(t).asException());\n-            throw t instanceof RuntimeException ? (RuntimeException) t : new RuntimeException(t);\n+            final Status status = GrpcStatus.fromThrowable(exceptionMappings, t);\n+            req.close(status.asException());\n+            close(status, new Metadata());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bab87d0b2549fe9f779d8b60e11e6665cab1e43"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e927d31ce46c2ee2b299f6f81764ebe4c63656cd", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/e927d31ce46c2ee2b299f6f81764ebe4c63656cd", "committedDate": "2020-11-30T04:40:05Z", "message": "Address comments by @trusin / Add GrpcStatusFunction and remove client-side option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f286520d2cbbc12ce13e07371fbc8a61120f900", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/4f286520d2cbbc12ce13e07371fbc8a61120f900", "committedDate": "2020-11-30T04:48:01Z", "message": "Clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1daa571c9a97d14ac82a31fd5c94242ad4c2eee1", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/1daa571c9a97d14ac82a31fd5c94242ad4c2eee1", "committedDate": "2020-11-30T04:51:23Z", "message": "Use Map.Entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42226fd0802a086a505c9eb660a25cb042d1e5da", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/42226fd0802a086a505c9eb660a25cb042d1e5da", "committedDate": "2020-11-30T04:58:53Z", "message": "Move toGrpcStatusFunction to GrpcServiceBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fb939219c57f0f22003afa217bcc844a866fb57", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/8fb939219c57f0f22003afa217bcc844a866fb57", "committedDate": "2020-11-30T05:00:13Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNjEwMjkz", "url": "https://github.com/line/armeria/pull/3197#pullrequestreview-540610293", "createdAt": "2020-11-30T05:39:32Z", "commit": {"oid": "8fb939219c57f0f22003afa217bcc844a866fb57"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNTozOTozM1rOH7siyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNTo0MDo0MlrOH7skFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM1NzgzMg==", "bodyText": "statusFunction?", "url": "https://github.com/line/armeria/pull/3197#discussion_r532357832", "createdAt": "2020-11-30T05:39:33Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/HttpStreamDeframerHandler.java", "diffHunk": "@@ -39,16 +40,21 @@\n \n     private final DecompressorRegistry decompressorRegistry;\n     private final TransportStatusListener transportStatusListener;\n+    @Nullable\n+    private final GrpcStatusFunction exceptionHandler;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fb939219c57f0f22003afa217bcc844a866fb57"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM1ODE2NQ==", "bodyText": "How about adding close(Throwable, Metadata) to deduplicate the convertThrowableToStatus() calls?", "url": "https://github.com/line/armeria/pull/3197#discussion_r532358165", "createdAt": "2020-11-30T05:40:42Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java", "diffHunk": "@@ -441,7 +449,7 @@ private void invokeOnMessage(I request) {\n             listener.onMessage(request);\n         } catch (Throwable t) {\n             upstream.cancel();\n-            close(GrpcStatus.fromThrowable(t), new Metadata());\n+            close(convertThrowableToStatus(t), new Metadata());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fb939219c57f0f22003afa217bcc844a866fb57"}, "originalPosition": 116}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b10e4b66f9f24484c365937e0d7b38857f1fa9d", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/9b10e4b66f9f24484c365937e0d7b38857f1fa9d", "committedDate": "2020-11-30T06:20:56Z", "message": "Address comments by @trustin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "722118d8270bcf744b674f1ad48963201a6d6405", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/722118d8270bcf744b674f1ad48963201a6d6405", "committedDate": "2020-11-30T06:26:49Z", "message": "clean up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNjUwMDEx", "url": "https://github.com/line/armeria/pull/3197#pullrequestreview-540650011", "createdAt": "2020-11-30T07:27:48Z", "commit": {"oid": "722118d8270bcf744b674f1ad48963201a6d6405"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzoyNzo0OFrOH7uj4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzoyNzo0OFrOH7uj4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjM5MDg4Mw==", "bodyText": "Could we introduce a local variable? Otherwise a user cannot do this:\nbuilder.addExceptionMapping(...);\nGrpcService a = builder.build();\nbuilder.addExceptionMapping(...);\nGrpcService b = builder.build();", "url": "https://github.com/line/armeria/pull/3197#discussion_r532390883", "createdAt": "2020-11-30T07:27:48Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -467,6 +566,10 @@ public GrpcService build() {\n             handlerRegistry = registryBuilder.build();\n         }\n \n+        if (exceptionMappings != null) {\n+            statusFunction = toGrpcStatusFunction(exceptionMappings);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "722118d8270bcf744b674f1ad48963201a6d6405"}, "originalPosition": 146}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8630c3ecc744a614eb3d4ac88dc572836a7e72c7", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/8630c3ecc744a614eb3d4ac88dc572836a7e72c7", "committedDate": "2020-11-30T07:30:41Z", "message": "Add a local variable for GrpcStatusFunction"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNjY0NTEx", "url": "https://github.com/line/armeria/pull/3197#pullrequestreview-540664511", "createdAt": "2020-11-30T07:56:07Z", "commit": {"oid": "8630c3ecc744a614eb3d4ac88dc572836a7e72c7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzo1NjowOFrOH7vRZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwNzo1NjowOFrOH7vRZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQwMjUzNA==", "bodyText": "nit: is used?\nOr, I think we can just remove this line. \ud83e\udd14", "url": "https://github.com/line/armeria/pull/3197#discussion_r532402534", "createdAt": "2020-11-30T07:56:08Z", "author": {"login": "minwoox"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -442,6 +456,91 @@ public GrpcServiceBuilder useClientTimeoutHeader(boolean useClientTimeoutHeader)\n         return this;\n     }\n \n+    /**\n+     * Sets the specified {@link GrpcStatusFunction} that maps a {@link Throwable} to a gRPC {@link Status}.\n+     * The mapping function are used to handle a {@link Throwable} when it is raised.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8630c3ecc744a614eb3d4ac88dc572836a7e72c7"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0cf02652539fcbde1b9a1a3e45a5424606bf009", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e0cf02652539fcbde1b9a1a3e45a5424606bf009", "committedDate": "2020-11-30T08:21:21Z", "message": "Update GrpcServiceBuilder.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNjgwMzMz", "url": "https://github.com/line/armeria/pull/3197#pullrequestreview-540680333", "createdAt": "2020-11-30T08:21:57Z", "commit": {"oid": "e0cf02652539fcbde1b9a1a3e45a5424606bf009"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4863, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}