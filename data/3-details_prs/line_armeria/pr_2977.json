{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzOTI4NDY3", "number": 2977, "title": "Fix a bug where different tags of WebClient are registered to Prometh\u2026", "bodyText": "\u2026eus registry\nMotivation:\nAfter Armeria introduces serviceName #2780,\nMetricCollecting{Service, Client} register a service name as a tag if the RequestLog.serviceName is not null.\nThe nullable serviceName could a problem when a key is registered with different tags.\nFor example, a gRPC client that send requests using com.example.Foo stub,\nMetricCollectingClient recodes metrics such as foo_pending_acquisition_duration_seconds\nwith tags of http_status, method and service whose value is com.example.Foo.\nHowever, a WebClient sends requests, it only records the metrics with  http_status and method tags.\nThis could cause problems at Micrometer's Prometheus registry.\nPrometheus requires that all meters with the same name have the same set of tag keys.\nThere is already an existing meter named 'armeria_client_pending_acquisition_duration_seconds' containing tag keys [http_status, method].\nThe meter you are attempting to register has keys [http_status, method, service].\n\nModifications:\n\nAdd 'none' to the value of service tag if RequestLog.serviceName() is null.\nRemove @Nullable annotation from RequestLog.name() and Request.fullName().\nThey do not return null values always.\n\nResult:\nA Prometheus registry does not throw an IAE, when you register a metric prefix key to the heterogeneous clients.", "createdAt": "2020-08-06T10:10:04Z", "url": "https://github.com/line/armeria/pull/2977", "merged": true, "mergeCommit": {"oid": "03becb62cd04991ca1488f6a3b9bcd228aeb09d7"}, "closed": true, "closedAt": "2020-08-07T10:42:37Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8MqwZAH2gAyNDYzOTI4NDY3OjZkODY1ZWM1YzE5MTFmOTI1YWY3ZjhhMDhmMWExMzc1NzAxYmM5ZGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8iDEqAFqTQ2MzIxMzI0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6d865ec5c1911f925af7f8a08f1a1375701bc9da", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/6d865ec5c1911f925af7f8a08f1a1375701bc9da", "committedDate": "2020-08-06T09:47:06Z", "message": "Fix a bug where different tags of WebClient are registered to Prometheus registry\n\nMotivation:\n\nAfter Armeria introduces serviceName #2780,\nMetricCollecting{Service, Client} is register a service name as a tag if the `RequestLog.serviceName` is not null.\nThe nullable `serviceName` could a problem when a key is registed with different tags.\n\nFor example, a gRPC client that send requests using `com.example.Foo` stub,\nMetricCollectingClient recodes metrics such as `foo_pending_acquisition_duration_seconds`\nwith tags of `http_status`, `method` and `service` whose value is `com.example.Foo`.\nHowever, a WebClient sends requests, it only records the metrics with  `http_status` and `method` tags.\n\nThis could cause problems at Micrometer's Prometheus registry.\n```\nPrometheus requires that all meters with the same name have the same set of tag keys.\nThere is already an existing meter named 'armeria_client_pending_acquisition_duration_seconds' containing tag keys [http_status, method].\nThe meter you are attempting to register has keys [http_status, method, service].\n```\n\nModifications:\n- Add 'none' to the value of `service` tag if `RequestLog.serviceName()` is null.\n\nResult:\n\nA Prometheous registry does not throw an IAE, when you register a metric prefix key to the heterogeneous clients."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMzg4MzU0", "url": "https://github.com/line/armeria/pull/2977#pullrequestreview-462388354", "createdAt": "2020-08-06T10:14:50Z", "commit": {"oid": "6d865ec5c1911f925af7f8a08f1a1375701bc9da"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMDoxNDo1MFrOG8tXvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMDoxNDo1MFrOG8tXvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxMTEwMw==", "bodyText": "Could use firstNonNull", "url": "https://github.com/line/armeria/pull/2977#discussion_r466311103", "createdAt": "2020-08-06T10:14:50Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java", "diffHunk": "@@ -105,10 +105,12 @@ private void buildTags(ImmutableList.Builder<Tag> tagListBuilder, RequestOnlyLog\n                     methodName = requestHeaders.method().name();\n                 }\n                 tagListBuilder.add(Tag.of(\"method\", methodName));\n-                final String serviceName = log.serviceName();\n-                if (serviceName != null) {\n-                    tagListBuilder.add(Tag.of(\"service\", serviceName));\n+\n+                String serviceName = log.serviceName();\n+                if (serviceName == null) {\n+                    serviceName = \"none\";\n                 }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d865ec5c1911f925af7f8a08f1a1375701bc9da"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b432b883543b58e04f105a9325d960a48b50f6a9", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/b432b883543b58e04f105a9325d960a48b50f6a9", "committedDate": "2020-08-06T10:18:17Z", "message": "Address comments by @trustin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "937301e47264a6ec8f4dbd0d01f625da88ed4cea", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/937301e47264a6ec8f4dbd0d01f625da88ed4cea", "committedDate": "2020-08-06T10:21:08Z", "message": "Remove missed `@Nullable`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e809183635588aab46b8db458360676adedc6187", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/e809183635588aab46b8db458360676adedc6187", "committedDate": "2020-08-06T10:44:37Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyOTQxMzky", "url": "https://github.com/line/armeria/pull/2977#pullrequestreview-462941392", "createdAt": "2020-08-06T23:23:45Z", "commit": {"oid": "e809183635588aab46b8db458360676adedc6187"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afaf0fc8f8407b426491664b30061c329a1a1f56", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/afaf0fc8f8407b426491664b30061c329a1a1f56", "committedDate": "2020-08-07T02:22:34Z", "message": "Fix broken tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMTM1MDY5", "url": "https://github.com/line/armeria/pull/2977#pullrequestreview-463135069", "createdAt": "2020-08-07T08:36:39Z", "commit": {"oid": "afaf0fc8f8407b426491664b30061c329a1a1f56"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMjEzMjQx", "url": "https://github.com/line/armeria/pull/2977#pullrequestreview-463213241", "createdAt": "2020-08-07T10:41:40Z", "commit": {"oid": "afaf0fc8f8407b426491664b30061c329a1a1f56"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 17, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}