{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyOTYyMDI3", "number": 2399, "title": "Add examples for context propagation using kotlin coroutine", "bodyText": "his changeset adds the examples for context propagation using kotlin coroutines.", "createdAt": "2020-01-15T05:20:18Z", "url": "https://github.com/line/armeria/pull/2399", "merged": true, "mergeCommit": {"oid": "e839f8acb952e3482bb4997b7c0f9d62e81ce751"}, "closed": true, "closedAt": "2020-01-16T07:04:20Z", "author": {"login": "kojilin"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6e2VPAFqTM0Mjk5MzY0MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6xddqAFqTM0MzY1MzgxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyOTkzNjQw", "url": "https://github.com/line/armeria/pull/2399#pullrequestreview-342993640", "createdAt": "2020-01-15T05:21:47Z", "commit": {"oid": "2ef731e514ca70fc662793b82203e5c68cefa70d"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwNToyMTo0N1rOFdtl1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwNTozODowNFrOFdtw3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY5OTk5MQ==", "bodyText": "Remove", "url": "https://github.com/line/armeria/pull/2399#discussion_r366699991", "createdAt": "2020-01-15T05:21:47Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/build.gradle", "diffHunk": "@@ -0,0 +1,25 @@\n+plugins {\n+    id 'application'\n+    id \"org.jetbrains.kotlin.jvm\"\n+}\n+\n+dependencies {\n+    implementation project(':core')\n+\n+    implementation 'io.reactivex.rxjava2:rxjava'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef731e514ca70fc662793b82203e5c68cefa70d"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMDAwMQ==", "bodyText": "Remove", "url": "https://github.com/line/armeria/pull/2399#discussion_r366700001", "createdAt": "2020-01-15T05:21:51Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/build.gradle", "diffHunk": "@@ -0,0 +1,25 @@\n+plugins {\n+    id 'application'\n+    id \"org.jetbrains.kotlin.jvm\"\n+}\n+\n+dependencies {\n+    implementation project(':core')\n+\n+    implementation 'io.reactivex.rxjava2:rxjava'\n+    implementation 'org.jetbrains.kotlin:kotlin-stdlib-jdk8'\n+    implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-core'\n+    implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-jdk8'\n+    implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-rx2'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef731e514ca70fc662793b82203e5c68cefa70d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMDEwMQ==", "bodyText": "Do you need : ServiceRequestContext? Or is it just more idiomatic in kotlin?", "url": "https://github.com/line/armeria/pull/2399#discussion_r366700101", "createdAt": "2020-01-15T05:22:26Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/src/main/kotlin/example/armeria/contextpropagation/manual/Main.kt", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.contextpropagation.manual\n+\n+import com.linecorp.armeria.client.WebClient\n+import com.linecorp.armeria.common.HttpResponse\n+import com.linecorp.armeria.common.HttpStatus\n+import com.linecorp.armeria.server.Server\n+import com.linecorp.armeria.server.ServiceRequestContext\n+\n+fun main(args: Array<String>) {\n+    val backend = Server.builder()\n+        .service(\"/square/{num}\") { ctx: ServiceRequestContext, _ ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef731e514ca70fc662793b82203e5c68cefa70d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMDIyOQ==", "bodyText": "We're not bothering being safe about this check this in other examples, probably fine not to here (or otherwise we could update the other examples", "url": "https://github.com/line/armeria/pull/2399#discussion_r366700229", "createdAt": "2020-01-15T05:23:18Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/src/main/kotlin/example/armeria/contextpropagation/manual/Main.kt", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.contextpropagation.manual\n+\n+import com.linecorp.armeria.client.WebClient\n+import com.linecorp.armeria.common.HttpResponse\n+import com.linecorp.armeria.common.HttpStatus\n+import com.linecorp.armeria.server.Server\n+import com.linecorp.armeria.server.ServiceRequestContext\n+\n+fun main(args: Array<String>) {\n+    val backend = Server.builder()\n+        .service(\"/square/{num}\") { ctx: ServiceRequestContext, _ ->\n+            val num = try {\n+                ctx.pathParam(\"num\")?.toLong()\n+            } catch (e: NumberFormatException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef731e514ca70fc662793b82203e5c68cefa70d"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMDMzNQ==", "bodyText": "Do you need Runnable?", "url": "https://github.com/line/armeria/pull/2399#discussion_r366700335", "createdAt": "2020-01-15T05:23:51Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/src/main/kotlin/example/armeria/contextpropagation/manual/Main.kt", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.contextpropagation.manual\n+\n+import com.linecorp.armeria.client.WebClient\n+import com.linecorp.armeria.common.HttpResponse\n+import com.linecorp.armeria.common.HttpStatus\n+import com.linecorp.armeria.server.Server\n+import com.linecorp.armeria.server.ServiceRequestContext\n+\n+fun main(args: Array<String>) {\n+    val backend = Server.builder()\n+        .service(\"/square/{num}\") { ctx: ServiceRequestContext, _ ->\n+            val num = try {\n+                ctx.pathParam(\"num\")?.toLong()\n+            } catch (e: NumberFormatException) {\n+                return@service HttpResponse.of(HttpStatus.BAD_REQUEST)\n+            }\n+            if (num != null) {\n+                HttpResponse.of((num * num).toString())\n+            } else {\n+                HttpResponse.of(HttpStatus.BAD_REQUEST)\n+            }\n+        }\n+        .http(8081)\n+        .build()\n+    val backendClient = WebClient.of(\"http://localhost:8081\")\n+    val frontend = Server.builder()\n+        .http(8080)\n+        .serviceUnder(\"/\", MainService(backendClient))\n+        .build()\n+    Runtime.getRuntime().addShutdownHook(Thread(Runnable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef731e514ca70fc662793b82203e5c68cefa70d"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMDUxMg==", "bodyText": "I think we should be able to use Armeria's code style at least for the imports (we do in grpc-kotlin example)", "url": "https://github.com/line/armeria/pull/2399#discussion_r366700512", "createdAt": "2020-01-15T05:25:07Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/src/main/kotlin/example/armeria/contextpropagation/manual/MainService.kt", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.contextpropagation.manual\n+\n+import com.google.common.base.Splitter", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef731e514ca70fc662793b82203e5c68cefa70d"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMDg0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private suspend fun fetchFromRequest(req: HttpRequest): List<Long> {\n          \n          \n            \n                private suspend fun fetchFromRequest(req: HttpRequest): List<Long> {\n          \n          \n            \n                  // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n          \n          \n            \n                  require(ServiceRequestContext.current() === ctx)\n          \n          \n            \n                  require(ctx.eventLoop().inEventLoop())", "url": "https://github.com/line/armeria/pull/2399#discussion_r366700840", "createdAt": "2020-01-15T05:27:15Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/src/main/kotlin/example/armeria/contextpropagation/manual/MainService.kt", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.contextpropagation.manual\n+\n+import com.google.common.base.Splitter\n+import com.google.common.collect.ImmutableList\n+import com.google.common.collect.Iterables\n+import com.google.common.util.concurrent.Uninterruptibles.sleepUninterruptibly\n+import com.linecorp.armeria.client.WebClient\n+import com.linecorp.armeria.common.AggregatedHttpResponse\n+import com.linecorp.armeria.common.HttpRequest\n+import com.linecorp.armeria.common.HttpResponse\n+import com.linecorp.armeria.server.HttpService\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.asCoroutineDispatcher\n+import kotlinx.coroutines.async\n+import kotlinx.coroutines.awaitAll\n+import kotlinx.coroutines.future.asDeferred\n+import kotlinx.coroutines.future.await\n+import kotlinx.coroutines.future.future\n+import kotlinx.coroutines.withContext\n+import java.time.Duration\n+import java.util.function.Function\n+import java.util.stream.Collectors\n+\n+class MainService(private val backendClient: WebClient) : HttpService {\n+    override fun serve(ctx: ServiceRequestContext, req: HttpRequest): HttpResponse {\n+        val ctxExecutor = ctx.contextAwareExecutor()\n+        val response = GlobalScope.future(ctxExecutor.asCoroutineDispatcher()) {\n+            val numsFromRequest = async { fetchFromRequest(req) }\n+            val numsFromDb = async { fetchFromFakeDb(ctx) }\n+            val nums = awaitAll(numsFromRequest, numsFromDb).flatten()\n+            val backendResponses = awaitAll(\n+                *nums.map { num ->\n+                    // The context is mounted in a thread-local, meaning it is available to all logic such\n+                    // as tracing.\n+                    require(ServiceRequestContext.current() === ctx)\n+                    require(ctx.eventLoop().inEventLoop())\n+                    backendClient.get(\"/square/$num\").aggregate().asDeferred()\n+                }.toTypedArray()\n+            ).toList()\n+            // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+            require(ServiceRequestContext.current() === ctx)\n+            require(ctx.eventLoop().inEventLoop())\n+            HttpResponse.of(\n+                backendResponses.stream()\n+                    .map(Function { obj: AggregatedHttpResponse -> obj.contentUtf8() })\n+                    .collect(Collectors.joining(\"\\n\"))\n+            )\n+        }\n+        return HttpResponse.from(response)\n+    }\n+\n+    private suspend fun fetchFromRequest(req: HttpRequest): List<Long> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef731e514ca70fc662793b82203e5c68cefa70d"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMDk4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    val nums = mutableListOf<Long>()\n          \n          \n            \n                    // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n          \n          \n            \n                    require(ServiceRequestContext.current() === ctx)\n          \n          \n            \n                    require(ctx.eventLoop().inEventLoop())\n          \n          \n            \n                    val nums = mutableListOf<Long>()", "url": "https://github.com/line/armeria/pull/2399#discussion_r366700986", "createdAt": "2020-01-15T05:28:10Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/src/main/kotlin/example/armeria/contextpropagation/manual/MainService.kt", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.contextpropagation.manual\n+\n+import com.google.common.base.Splitter\n+import com.google.common.collect.ImmutableList\n+import com.google.common.collect.Iterables\n+import com.google.common.util.concurrent.Uninterruptibles.sleepUninterruptibly\n+import com.linecorp.armeria.client.WebClient\n+import com.linecorp.armeria.common.AggregatedHttpResponse\n+import com.linecorp.armeria.common.HttpRequest\n+import com.linecorp.armeria.common.HttpResponse\n+import com.linecorp.armeria.server.HttpService\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.asCoroutineDispatcher\n+import kotlinx.coroutines.async\n+import kotlinx.coroutines.awaitAll\n+import kotlinx.coroutines.future.asDeferred\n+import kotlinx.coroutines.future.await\n+import kotlinx.coroutines.future.future\n+import kotlinx.coroutines.withContext\n+import java.time.Duration\n+import java.util.function.Function\n+import java.util.stream.Collectors\n+\n+class MainService(private val backendClient: WebClient) : HttpService {\n+    override fun serve(ctx: ServiceRequestContext, req: HttpRequest): HttpResponse {\n+        val ctxExecutor = ctx.contextAwareExecutor()\n+        val response = GlobalScope.future(ctxExecutor.asCoroutineDispatcher()) {\n+            val numsFromRequest = async { fetchFromRequest(req) }\n+            val numsFromDb = async { fetchFromFakeDb(ctx) }\n+            val nums = awaitAll(numsFromRequest, numsFromDb).flatten()\n+            val backendResponses = awaitAll(\n+                *nums.map { num ->\n+                    // The context is mounted in a thread-local, meaning it is available to all logic such\n+                    // as tracing.\n+                    require(ServiceRequestContext.current() === ctx)\n+                    require(ctx.eventLoop().inEventLoop())\n+                    backendClient.get(\"/square/$num\").aggregate().asDeferred()\n+                }.toTypedArray()\n+            ).toList()\n+            // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+            require(ServiceRequestContext.current() === ctx)\n+            require(ctx.eventLoop().inEventLoop())\n+            HttpResponse.of(\n+                backendResponses.stream()\n+                    .map(Function { obj: AggregatedHttpResponse -> obj.contentUtf8() })\n+                    .collect(Collectors.joining(\"\\n\"))\n+            )\n+        }\n+        return HttpResponse.from(response)\n+    }\n+\n+    private suspend fun fetchFromRequest(req: HttpRequest): List<Long> {\n+        val aggregatedHttpRequest = req.aggregate().await()\n+        val nums = mutableListOf<Long>()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef731e514ca70fc662793b82203e5c68cefa70d"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcwMjgxMg==", "bodyText": "Doesn't Kotlin have method reference too? obj::contentUtf8?", "url": "https://github.com/line/armeria/pull/2399#discussion_r366702812", "createdAt": "2020-01-15T05:38:04Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/src/main/kotlin/example/armeria/contextpropagation/manual/MainService.kt", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.contextpropagation.manual\n+\n+import com.google.common.base.Splitter\n+import com.google.common.collect.ImmutableList\n+import com.google.common.collect.Iterables\n+import com.google.common.util.concurrent.Uninterruptibles.sleepUninterruptibly\n+import com.linecorp.armeria.client.WebClient\n+import com.linecorp.armeria.common.AggregatedHttpResponse\n+import com.linecorp.armeria.common.HttpRequest\n+import com.linecorp.armeria.common.HttpResponse\n+import com.linecorp.armeria.server.HttpService\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.asCoroutineDispatcher\n+import kotlinx.coroutines.async\n+import kotlinx.coroutines.awaitAll\n+import kotlinx.coroutines.future.asDeferred\n+import kotlinx.coroutines.future.await\n+import kotlinx.coroutines.future.future\n+import kotlinx.coroutines.withContext\n+import java.time.Duration\n+import java.util.function.Function\n+import java.util.stream.Collectors\n+\n+class MainService(private val backendClient: WebClient) : HttpService {\n+    override fun serve(ctx: ServiceRequestContext, req: HttpRequest): HttpResponse {\n+        val ctxExecutor = ctx.contextAwareExecutor()\n+        val response = GlobalScope.future(ctxExecutor.asCoroutineDispatcher()) {\n+            val numsFromRequest = async { fetchFromRequest(req) }\n+            val numsFromDb = async { fetchFromFakeDb(ctx) }\n+            val nums = awaitAll(numsFromRequest, numsFromDb).flatten()\n+            val backendResponses = awaitAll(\n+                *nums.map { num ->\n+                    // The context is mounted in a thread-local, meaning it is available to all logic such\n+                    // as tracing.\n+                    require(ServiceRequestContext.current() === ctx)\n+                    require(ctx.eventLoop().inEventLoop())\n+                    backendClient.get(\"/square/$num\").aggregate().asDeferred()\n+                }.toTypedArray()\n+            ).toList()\n+            // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+            require(ServiceRequestContext.current() === ctx)\n+            require(ctx.eventLoop().inEventLoop())\n+            HttpResponse.of(\n+                backendResponses.stream()\n+                    .map(Function { obj: AggregatedHttpResponse -> obj.contentUtf8() })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef731e514ca70fc662793b82203e5c68cefa70d"}, "originalPosition": 62}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ef731e514ca70fc662793b82203e5c68cefa70d", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/2ef731e514ca70fc662793b82203e5c68cefa70d", "committedDate": "2020-01-15T05:16:30Z", "message": "Add examples for context propagation using kotlin coroutine\n\nhis changeset adds the examples for context propagation using kotlin coroutines."}, "afterCommit": {"oid": "f3359ca8d479e3c9b3df7c04e13eeb006356a475", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/f3359ca8d479e3c9b3df7c04e13eeb006356a475", "committedDate": "2020-01-15T05:57:10Z", "message": "Add examples for context propagation using kotlin coroutine\n\nhis changeset adds the examples for context propagation using kotlin coroutines."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51fe81d6469451d2bd4f4b25d21cd2cbccc00930", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/51fe81d6469451d2bd4f4b25d21cd2cbccc00930", "committedDate": "2020-01-15T06:12:30Z", "message": "Add examples for context propagation using kotlin coroutine\n\nhis changeset adds the examples for context propagation using kotlin coroutines."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3359ca8d479e3c9b3df7c04e13eeb006356a475", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/f3359ca8d479e3c9b3df7c04e13eeb006356a475", "committedDate": "2020-01-15T05:57:10Z", "message": "Add examples for context propagation using kotlin coroutine\n\nhis changeset adds the examples for context propagation using kotlin coroutines."}, "afterCommit": {"oid": "51fe81d6469451d2bd4f4b25d21cd2cbccc00930", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/51fe81d6469451d2bd4f4b25d21cd2cbccc00930", "committedDate": "2020-01-15T06:12:30Z", "message": "Add examples for context propagation using kotlin coroutine\n\nhis changeset adds the examples for context propagation using kotlin coroutines."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1347547769ad01554b6c6769bc1615076c683c39", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/1347547769ad01554b6c6769bc1615076c683c39", "committedDate": "2020-01-15T06:27:15Z", "message": "correcting as pointed out.\n\n* Remove unused dependencies\n* Manually change the order of import\n* Remove explicit type at lambda\n* Using method references\n* Add more context checking"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de98420c0bdd9a71360d837dd476abb3d4b87f6c", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/de98420c0bdd9a71360d837dd476abb3d4b87f6c", "committedDate": "2020-01-15T06:23:03Z", "message": "correcting as pointed out.\n\n* Remove unused dependencies\n* Manually change the order of import\n* Remove explicit type at lambda\n* Using method references\n* Add more context checking"}, "afterCommit": {"oid": "1347547769ad01554b6c6769bc1615076c683c39", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/1347547769ad01554b6c6769bc1615076c683c39", "committedDate": "2020-01-15T06:27:15Z", "message": "correcting as pointed out.\n\n* Remove unused dependencies\n* Manually change the order of import\n* Remove explicit type at lambda\n* Using method references\n* Add more context checking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMDIyNTIy", "url": "https://github.com/line/armeria/pull/2399#pullrequestreview-343022522", "createdAt": "2020-01-15T07:15:59Z", "commit": {"oid": "1347547769ad01554b6c6769bc1615076c683c39"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMDIwOTQ4", "url": "https://github.com/line/armeria/pull/2399#pullrequestreview-343020948", "createdAt": "2020-01-15T07:10:45Z", "commit": {"oid": "1347547769ad01554b6c6769bc1615076c683c39"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwNzoxMDo0NlrOFdu8Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwNzoxNToxNVrOFdvArg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcyMjE0Mg==", "bodyText": "Can we write this file in kotlin since it's a kotlin project?", "url": "https://github.com/line/armeria/pull/2399#discussion_r366722142", "createdAt": "2020-01-15T07:10:46Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/build.gradle", "diffHunk": "@@ -0,0 +1,23 @@\n+plugins {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1347547769ad01554b6c6769bc1615076c683c39"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcyMjM1NA==", "bodyText": "I think this is required in our build because of the way we run tests. Maybe we should apply in top level build file instead?", "url": "https://github.com/line/armeria/pull/2399#discussion_r366722354", "createdAt": "2020-01-15T07:11:36Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/build.gradle", "diffHunk": "@@ -0,0 +1,23 @@\n+plugins {\n+    id 'application'\n+    id \"org.jetbrains.kotlin.jvm\"\n+}\n+\n+dependencies {\n+    implementation project(':core')\n+\n+    implementation 'org.jetbrains.kotlin:kotlin-stdlib-jdk8'\n+    implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-core'\n+    implementation 'org.jetbrains.kotlinx:kotlinx-coroutines-jdk8'\n+}\n+\n+application {\n+    mainClassName = 'example.armeria.contextpropagation.kotlin.Main'\n+}\n+\n+compileKotlin {\n+    kotlinOptions.jvmTarget = \"1.8\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1347547769ad01554b6c6769bc1615076c683c39"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcyMjY1OA==", "bodyText": "Can we check context / event loop after await too? I guess that's the equivalent of a callback in future style and it would be incorrect if the context was wrong here and we needed to make another backend call.", "url": "https://github.com/line/armeria/pull/2399#discussion_r366722658", "createdAt": "2020-01-15T07:12:53Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/src/main/kotlin/example/armeria/contextpropagation/manual/MainService.kt", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.contextpropagation.manual\n+\n+import com.linecorp.armeria.client.WebClient\n+import com.linecorp.armeria.common.AggregatedHttpResponse\n+import com.linecorp.armeria.common.HttpRequest\n+import com.linecorp.armeria.common.HttpResponse\n+import com.linecorp.armeria.server.HttpService\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import com.google.common.base.Splitter\n+import com.google.common.collect.ImmutableList\n+import com.google.common.collect.Iterables\n+import com.google.common.util.concurrent.Uninterruptibles.sleepUninterruptibly\n+import java.time.Duration\n+import java.util.stream.Collectors\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.asCoroutineDispatcher\n+import kotlinx.coroutines.async\n+import kotlinx.coroutines.awaitAll\n+import kotlinx.coroutines.future.asDeferred\n+import kotlinx.coroutines.future.await\n+import kotlinx.coroutines.future.future\n+import kotlinx.coroutines.withContext\n+\n+class MainService(private val backendClient: WebClient) : HttpService {\n+    override fun serve(ctx: ServiceRequestContext, req: HttpRequest): HttpResponse {\n+        val ctxExecutor = ctx.contextAwareExecutor()\n+        val response = GlobalScope.future(ctxExecutor.asCoroutineDispatcher()) {\n+            val numsFromRequest = async { fetchFromRequest(ctx, req) }\n+            val numsFromDb = async { fetchFromFakeDb(ctx) }\n+            val nums = awaitAll(numsFromRequest, numsFromDb).flatten()\n+\n+            val backendResponses =\n+                awaitAll(\n+                    *nums.map { num ->\n+                        // The context is mounted in a thread-local, meaning it is available to all logic such\n+                        // as tracing.\n+                        require(ServiceRequestContext.current() === ctx)\n+                        require(ctx.eventLoop().inEventLoop())\n+                        backendClient.get(\"/square/$num\").aggregate().asDeferred()\n+                    }.toTypedArray()\n+                ).toList()\n+            // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+            require(ServiceRequestContext.current() === ctx)\n+            require(ctx.eventLoop().inEventLoop())\n+            HttpResponse.of(\n+                backendResponses.stream()\n+                    .map(AggregatedHttpResponse::contentUtf8)\n+                    .collect(Collectors.joining(\"\\n\"))\n+            )\n+        }\n+        return HttpResponse.from(response)\n+    }\n+\n+    private suspend fun fetchFromRequest(ctx: ServiceRequestContext, req: HttpRequest): List<Long> {\n+        // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+        require(ServiceRequestContext.current() === ctx)\n+        require(ctx.eventLoop().inEventLoop())\n+        val aggregatedHttpRequest = req.aggregate().await()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1347547769ad01554b6c6769bc1615076c683c39"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjcyMzI0Ng==", "bodyText": "What do you think about withContext vs CompletableFuture.supplyAsync().await()? I'm a bit worried about using a suspending function inside this block which I think would change threads and possibly break something like a transaction. I guess suspension should generally be prevented for uses of blocking executor, do you know if there's a simpler way to do that?", "url": "https://github.com/line/armeria/pull/2399#discussion_r366723246", "createdAt": "2020-01-15T07:15:15Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/src/main/kotlin/example/armeria/contextpropagation/manual/MainService.kt", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.contextpropagation.manual\n+\n+import com.linecorp.armeria.client.WebClient\n+import com.linecorp.armeria.common.AggregatedHttpResponse\n+import com.linecorp.armeria.common.HttpRequest\n+import com.linecorp.armeria.common.HttpResponse\n+import com.linecorp.armeria.server.HttpService\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import com.google.common.base.Splitter\n+import com.google.common.collect.ImmutableList\n+import com.google.common.collect.Iterables\n+import com.google.common.util.concurrent.Uninterruptibles.sleepUninterruptibly\n+import java.time.Duration\n+import java.util.stream.Collectors\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.asCoroutineDispatcher\n+import kotlinx.coroutines.async\n+import kotlinx.coroutines.awaitAll\n+import kotlinx.coroutines.future.asDeferred\n+import kotlinx.coroutines.future.await\n+import kotlinx.coroutines.future.future\n+import kotlinx.coroutines.withContext\n+\n+class MainService(private val backendClient: WebClient) : HttpService {\n+    override fun serve(ctx: ServiceRequestContext, req: HttpRequest): HttpResponse {\n+        val ctxExecutor = ctx.contextAwareExecutor()\n+        val response = GlobalScope.future(ctxExecutor.asCoroutineDispatcher()) {\n+            val numsFromRequest = async { fetchFromRequest(ctx, req) }\n+            val numsFromDb = async { fetchFromFakeDb(ctx) }\n+            val nums = awaitAll(numsFromRequest, numsFromDb).flatten()\n+\n+            val backendResponses =\n+                awaitAll(\n+                    *nums.map { num ->\n+                        // The context is mounted in a thread-local, meaning it is available to all logic such\n+                        // as tracing.\n+                        require(ServiceRequestContext.current() === ctx)\n+                        require(ctx.eventLoop().inEventLoop())\n+                        backendClient.get(\"/square/$num\").aggregate().asDeferred()\n+                    }.toTypedArray()\n+                ).toList()\n+            // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+            require(ServiceRequestContext.current() === ctx)\n+            require(ctx.eventLoop().inEventLoop())\n+            HttpResponse.of(\n+                backendResponses.stream()\n+                    .map(AggregatedHttpResponse::contentUtf8)\n+                    .collect(Collectors.joining(\"\\n\"))\n+            )\n+        }\n+        return HttpResponse.from(response)\n+    }\n+\n+    private suspend fun fetchFromRequest(ctx: ServiceRequestContext, req: HttpRequest): List<Long> {\n+        // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+        require(ServiceRequestContext.current() === ctx)\n+        require(ctx.eventLoop().inEventLoop())\n+        val aggregatedHttpRequest = req.aggregate().await()\n+        val nums = mutableListOf<Long>()\n+        for (token in Iterables.concat(\n+            NUM_SPLITTER.split(aggregatedHttpRequest.path().substring(1)),\n+            NUM_SPLITTER.split(aggregatedHttpRequest.contentUtf8())\n+        )) {\n+            nums.add(token.toLong())\n+        }\n+        return nums\n+    }\n+\n+    private suspend fun fetchFromFakeDb(ctx: ServiceRequestContext): List<Long> {\n+        // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+        require(ServiceRequestContext.current() === ctx)\n+        require(ctx.eventLoop().inEventLoop())\n+        // This logic mimics using a blocking method, which would usually be something like a MySQL\n+        // database query using JDBC.\n+        return withContext(ctx.blockingTaskExecutor().asCoroutineDispatcher()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1347547769ad01554b6c6769bc1615076c683c39"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMDQ1OTU5", "url": "https://github.com/line/armeria/pull/2399#pullrequestreview-343045959", "createdAt": "2020-01-15T08:19:19Z", "commit": {"oid": "1347547769ad01554b6c6769bc1615076c683c39"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwODoxOToxOVrOFdwIkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQwODoxOToxOVrOFdwIkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njc0MTY0OQ==", "bodyText": "nit: Could you add empty lines for improving readability?", "url": "https://github.com/line/armeria/pull/2399#discussion_r366741649", "createdAt": "2020-01-15T08:19:19Z", "author": {"login": "ikhoon"}, "path": "examples/context-propagation/kotlin/src/main/kotlin/example/armeria/contextpropagation/manual/Main.kt", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.contextpropagation.manual\n+\n+import com.linecorp.armeria.client.WebClient\n+import com.linecorp.armeria.common.HttpResponse\n+import com.linecorp.armeria.common.HttpStatus\n+import com.linecorp.armeria.server.Server\n+\n+fun main(args: Array<String>) {\n+    val backend = Server.builder()\n+        .service(\"/square/{num}\") { ctx, _ ->\n+            val num = ctx.pathParam(\"num\")?.toLong()\n+            if (num != null) {\n+                HttpResponse.of((num * num).toString())\n+            } else {\n+                HttpResponse.of(HttpStatus.BAD_REQUEST)\n+            }\n+        }\n+        .http(8081)\n+        .build()\n+    val backendClient = WebClient.of(\"http://localhost:8081\")\n+    val frontend = Server.builder()\n+        .http(8080)\n+        .serviceUnder(\"/\", MainService(backendClient))\n+        .build()\n+    Runtime.getRuntime().addShutdownHook(Thread {\n+        backend.stop().join()\n+        frontend.stop().join()\n+    })\n+    backend.start().join()\n+    frontend.start().join()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1347547769ad01554b6c6769bc1615076c683c39"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e40f6fe9919f49d1649b0d0f0762b5ec095cb6d", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/7e40f6fe9919f49d1649b0d0f0762b5ec095cb6d", "committedDate": "2020-01-15T09:18:03Z", "message": "Fix as pointed out.\n\n* Move kotlin target jvm version to top level build.gradle\n* Change gradle to gradle.kts\n* Rename package\n* Put some blank lines for readability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df41f1c27f3e4b2d57c62ddcdd060c5e2608c91e", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/df41f1c27f3e4b2d57c62ddcdd060c5e2608c91e", "committedDate": "2020-01-15T09:59:03Z", "message": "Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMTA0MTMw", "url": "https://github.com/line/armeria/pull/2399#pullrequestreview-343104130", "createdAt": "2020-01-15T10:01:37Z", "commit": {"oid": "df41f1c27f3e4b2d57c62ddcdd060c5e2608c91e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxMDowMTozOFrOFdy6rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxMDowMTo1MlrOFdy7NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njc4NzI0Nw==", "bodyText": "Maybe this type came automatically from intellij", "url": "https://github.com/line/armeria/pull/2399#discussion_r366787247", "createdAt": "2020-01-15T10:01:38Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/src/main/kotlin/example/armeria/contextpropagation/kotlin/MainService.kt", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.contextpropagation.kotlin\n+\n+import com.linecorp.armeria.client.WebClient\n+import com.linecorp.armeria.common.AggregatedHttpResponse\n+import com.linecorp.armeria.common.HttpRequest\n+import com.linecorp.armeria.common.HttpResponse\n+import com.linecorp.armeria.server.HttpService\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import com.google.common.base.Splitter\n+import com.google.common.collect.Iterables\n+import com.google.common.util.concurrent.Uninterruptibles\n+import java.time.Duration\n+import java.util.concurrent.CompletableFuture\n+import java.util.function.Supplier\n+import java.util.stream.Collectors\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.asCoroutineDispatcher\n+import kotlinx.coroutines.async\n+import kotlinx.coroutines.awaitAll\n+import kotlinx.coroutines.future.asDeferred\n+import kotlinx.coroutines.future.await\n+import kotlinx.coroutines.future.future\n+\n+class MainService(private val backendClient: WebClient) : HttpService {\n+    override fun serve(ctx: ServiceRequestContext, req: HttpRequest): HttpResponse {\n+        val ctxExecutor = ctx.contextAwareExecutor()\n+        val response = GlobalScope.future(ctxExecutor.asCoroutineDispatcher()) {\n+\n+            val numsFromRequest = async { fetchFromRequest(ctx, req) }\n+            val numsFromDb = async { fetchFromFakeDb(ctx) }\n+            val nums = awaitAll(numsFromRequest, numsFromDb).flatten()\n+\n+            // The context is kept after resume.\n+            require(ServiceRequestContext.current() === ctx)\n+            require(ctx.eventLoop().inEventLoop())\n+\n+            val backendResponses =\n+                awaitAll(\n+                    *nums.map { num ->\n+                        // The context is mounted in a thread-local, meaning it is available to all logic such\n+                        // as tracing.\n+                        require(ServiceRequestContext.current() === ctx)\n+                        require(ctx.eventLoop().inEventLoop())\n+\n+                        backendClient.get(\"/square/$num\").aggregate().asDeferred()\n+                    }.toTypedArray()\n+                ).toList()\n+\n+            // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+            require(ServiceRequestContext.current() === ctx)\n+            require(ctx.eventLoop().inEventLoop())\n+\n+            HttpResponse.of(\n+                backendResponses.stream()\n+                    .map(AggregatedHttpResponse::contentUtf8)\n+                    .collect(Collectors.joining(\"\\n\"))\n+            )\n+        }\n+        return HttpResponse.from(response)\n+    }\n+\n+    private suspend fun fetchFromRequest(ctx: ServiceRequestContext, req: HttpRequest): List<Long> {\n+        // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+        require(ServiceRequestContext.current() === ctx)\n+        require(ctx.eventLoop().inEventLoop())\n+\n+        val aggregatedHttpRequest = req.aggregate().await()\n+\n+        // The context is kept after resume.\n+        require(ServiceRequestContext.current() === ctx)\n+        require(ctx.eventLoop().inEventLoop())\n+\n+        val nums = mutableListOf<Long>()\n+        for (token in Iterables.concat(\n+            NUM_SPLITTER.split(aggregatedHttpRequest.path().substring(1)),\n+            NUM_SPLITTER.split(aggregatedHttpRequest.contentUtf8())\n+        )) {\n+            nums.add(token.toLong())\n+        }\n+        return nums\n+    }\n+\n+    private suspend fun fetchFromFakeDb(ctx: ServiceRequestContext): List<Long> {\n+        // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+        require(ServiceRequestContext.current() === ctx)\n+        require(ctx.eventLoop().inEventLoop())\n+\n+        // This logic mimics using a blocking method, which would usually be something like a MySQL\n+        // database query using JDBC.\n+        return CompletableFuture.supplyAsync(\n+            Supplier<List<Long>> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df41f1c27f3e4b2d57c62ddcdd060c5e2608c91e"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njc4NzM4MA==", "bodyText": "Static import was lost (not a big deal) and spaces around parens (bigger deal)", "url": "https://github.com/line/armeria/pull/2399#discussion_r366787380", "createdAt": "2020-01-15T10:01:52Z", "author": {"login": "anuraaga"}, "path": "examples/context-propagation/kotlin/src/main/kotlin/example/armeria/contextpropagation/kotlin/MainService.kt", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package example.armeria.contextpropagation.kotlin\n+\n+import com.linecorp.armeria.client.WebClient\n+import com.linecorp.armeria.common.AggregatedHttpResponse\n+import com.linecorp.armeria.common.HttpRequest\n+import com.linecorp.armeria.common.HttpResponse\n+import com.linecorp.armeria.server.HttpService\n+import com.linecorp.armeria.server.ServiceRequestContext\n+import com.google.common.base.Splitter\n+import com.google.common.collect.Iterables\n+import com.google.common.util.concurrent.Uninterruptibles\n+import java.time.Duration\n+import java.util.concurrent.CompletableFuture\n+import java.util.function.Supplier\n+import java.util.stream.Collectors\n+import kotlinx.coroutines.GlobalScope\n+import kotlinx.coroutines.asCoroutineDispatcher\n+import kotlinx.coroutines.async\n+import kotlinx.coroutines.awaitAll\n+import kotlinx.coroutines.future.asDeferred\n+import kotlinx.coroutines.future.await\n+import kotlinx.coroutines.future.future\n+\n+class MainService(private val backendClient: WebClient) : HttpService {\n+    override fun serve(ctx: ServiceRequestContext, req: HttpRequest): HttpResponse {\n+        val ctxExecutor = ctx.contextAwareExecutor()\n+        val response = GlobalScope.future(ctxExecutor.asCoroutineDispatcher()) {\n+\n+            val numsFromRequest = async { fetchFromRequest(ctx, req) }\n+            val numsFromDb = async { fetchFromFakeDb(ctx) }\n+            val nums = awaitAll(numsFromRequest, numsFromDb).flatten()\n+\n+            // The context is kept after resume.\n+            require(ServiceRequestContext.current() === ctx)\n+            require(ctx.eventLoop().inEventLoop())\n+\n+            val backendResponses =\n+                awaitAll(\n+                    *nums.map { num ->\n+                        // The context is mounted in a thread-local, meaning it is available to all logic such\n+                        // as tracing.\n+                        require(ServiceRequestContext.current() === ctx)\n+                        require(ctx.eventLoop().inEventLoop())\n+\n+                        backendClient.get(\"/square/$num\").aggregate().asDeferred()\n+                    }.toTypedArray()\n+                ).toList()\n+\n+            // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+            require(ServiceRequestContext.current() === ctx)\n+            require(ctx.eventLoop().inEventLoop())\n+\n+            HttpResponse.of(\n+                backendResponses.stream()\n+                    .map(AggregatedHttpResponse::contentUtf8)\n+                    .collect(Collectors.joining(\"\\n\"))\n+            )\n+        }\n+        return HttpResponse.from(response)\n+    }\n+\n+    private suspend fun fetchFromRequest(ctx: ServiceRequestContext, req: HttpRequest): List<Long> {\n+        // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+        require(ServiceRequestContext.current() === ctx)\n+        require(ctx.eventLoop().inEventLoop())\n+\n+        val aggregatedHttpRequest = req.aggregate().await()\n+\n+        // The context is kept after resume.\n+        require(ServiceRequestContext.current() === ctx)\n+        require(ctx.eventLoop().inEventLoop())\n+\n+        val nums = mutableListOf<Long>()\n+        for (token in Iterables.concat(\n+            NUM_SPLITTER.split(aggregatedHttpRequest.path().substring(1)),\n+            NUM_SPLITTER.split(aggregatedHttpRequest.contentUtf8())\n+        )) {\n+            nums.add(token.toLong())\n+        }\n+        return nums\n+    }\n+\n+    private suspend fun fetchFromFakeDb(ctx: ServiceRequestContext): List<Long> {\n+        // The context is mounted in a thread-local, meaning it is available to all logic such as tracing.\n+        require(ServiceRequestContext.current() === ctx)\n+        require(ctx.eventLoop().inEventLoop())\n+\n+        // This logic mimics using a blocking method, which would usually be something like a MySQL\n+        // database query using JDBC.\n+        return CompletableFuture.supplyAsync(\n+            Supplier<List<Long>> {\n+                // The context is mounted in a thread-local, meaning it is available to all logic such\n+                // as tracing.\n+                require(ServiceRequestContext.current() === ctx)\n+                require(!ctx.eventLoop().inEventLoop())\n+\n+                Uninterruptibles.sleepUninterruptibly( Duration.ofMillis( 50 ) )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df41f1c27f3e4b2d57c62ddcdd060c5e2608c91e"}, "originalPosition": 113}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "144b2f75e70cd0f6e98845af4bb2ada7e8bd22ce", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/144b2f75e70cd0f6e98845af4bb2ada7e8bd22ce", "committedDate": "2020-01-15T10:09:39Z", "message": "Fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e26935023b7b30a834b5d144b7c25384cbeb7cca", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/e26935023b7b30a834b5d144b7c25384cbeb7cca", "committedDate": "2020-01-15T10:06:07Z", "message": "Fix"}, "afterCommit": {"oid": "144b2f75e70cd0f6e98845af4bb2ada7e8bd22ce", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/144b2f75e70cd0f6e98845af4bb2ada7e8bd22ce", "committedDate": "2020-01-15T10:09:39Z", "message": "Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjUzODE1", "url": "https://github.com/line/armeria/pull/2399#pullrequestreview-343653815", "createdAt": "2020-01-16T03:20:04Z", "commit": {"oid": "144b2f75e70cd0f6e98845af4bb2ada7e8bd22ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 863, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}