{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNjY4NjI5", "number": 2448, "title": "Introduce Pooled* versions of APIs which delegate to the stand\u2026", "bodyText": "\u2026ard ones while assuring all operations use pooled objects.\nCurrently APIs that use unsafe patterns, exposing reference counted objects, are mixed with the normal API. Because they're dangerous, we should hide them as much as possible, so this makes using the unsafe API explicit by requiring using the unsafe API entry points. Unsafe API users also get a QOL increase at the same time by adding the ability to use this API with try/resources.\nSee #1938 for prior discussion.", "createdAt": "2020-02-04T06:30:56Z", "url": "https://github.com/line/armeria/pull/2448", "merged": true, "mergeCommit": {"oid": "ee9652dfbb6b6d31b52d72e28c8e51cb793557d6"}, "closed": true, "closedAt": "2020-06-19T14:45:29Z", "author": {"login": "anuraaga"}, "timelineItems": {"totalCount": 63, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcA7fkpAH2gAyMzcwNjY4NjI5OmY0NjIyMDJkMTI4ZDFkMjMxYWYyNTQxYmRmOTJhM2E1NTVhZDIzOWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwNeEDgFqTQzOTY1MjI0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f462202d128d1d231af2541bdf92a3a555ad239b", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/f462202d128d1d231af2541bdf92a3a555ad239b", "committedDate": "2020-02-04T06:24:58Z", "message": "Introduce Pooled* versions of client APIs which delegate to the standard ones while assuring all operations use pooled objects."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MTg1MDE2", "url": "https://github.com/line/armeria/pull/2448#pullrequestreview-354185016", "createdAt": "2020-02-06T03:42:45Z", "commit": {"oid": "f462202d128d1d231af2541bdf92a3a555ad239b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwMzo0Mjo0NVrOFmOeEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwMzo0Mjo0NVrOFmOeEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYyNzI4MQ==", "bodyText": "It's now internal.common.", "url": "https://github.com/line/armeria/pull/2448#discussion_r375627281", "createdAt": "2020-02-06T03:42:45Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/HttpRequestAggregator.java", "diffHunk": "@@ -14,22 +14,27 @@\n  * under the License.\n  */\n \n-package com.linecorp.armeria.common;\n+package com.linecorp.armeria.internal;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f462202d128d1d231af2541bdf92a3a555ad239b"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d65399566217e46c91c1a627c3e699c2822ddc8", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/7d65399566217e46c91c1a627c3e699c2822ddc8", "committedDate": "2020-02-11T09:25:30Z", "message": "Merge branch 'master' of github.com:line/armeria into pooled-web-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35ccbef756d019fbd5f8630fd112b5bdb5fc4b5f", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/35ccbef756d019fbd5f8630fd112b5bdb5fc4b5f", "committedDate": "2020-02-11T09:46:47Z", "message": "Merge more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d39238ecdb683b3112131ee2d912792d7e64b7ae", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/d39238ecdb683b3112131ee2d912792d7e64b7ae", "committedDate": "2020-02-11T10:15:46Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "564a1aced7d87c61d75c1585b3ae3f0667999ae2", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/564a1aced7d87c61d75c1585b3ae3f0667999ae2", "committedDate": "2020-02-13T07:10:01Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f020cad1645e01abfb61bcd9bac95e7ba182d243", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/f020cad1645e01abfb61bcd9bac95e7ba182d243", "committedDate": "2020-02-13T07:19:45Z", "message": "Type safety"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9195c8a7fb87c454190ce7a0baa857de97232363", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/9195c8a7fb87c454190ce7a0baa857de97232363", "committedDate": "2020-02-13T08:05:47Z", "message": "Style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4263c0b43f96b5c51efa9d171e9762c9b64c46b4", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/4263c0b43f96b5c51efa9d171e9762c9b64c46b4", "committedDate": "2020-02-13T08:05:58Z", "message": "Style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16506df7e3d312542fcfa28adc816dd258ba748e", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/16506df7e3d312542fcfa28adc816dd258ba748e", "committedDate": "2020-03-03T10:24:44Z", "message": "Start tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "300991f12028f8799a86427f5eb26a400485f2e3", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/300991f12028f8799a86427f5eb26a400485f2e3", "committedDate": "2020-03-03T10:25:29Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "805207fb3e820ac871cde570d65e8fb32620bb30", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/805207fb3e820ac871cde570d65e8fb32620bb30", "committedDate": "2020-03-03T10:26:38Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd1433d09e57e1e49b5396291ed00d69cf603ab2", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/dd1433d09e57e1e49b5396291ed00d69cf603ab2", "committedDate": "2020-03-03T10:29:58Z", "message": "WIP"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTc2NjMy", "url": "https://github.com/line/armeria/pull/2448#pullrequestreview-376576632", "createdAt": "2020-03-18T05:40:57Z", "commit": {"oid": "dd1433d09e57e1e49b5396291ed00d69cf603ab2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNTo0MDo1N1rOF32-Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNTo0MDo1N1rOF32-Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDExNjYxNA==", "bodyText": "I think from is more suitable for our API style. What do you think? \ud83d\ude00\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static PooledHttpData convert(HttpData data) {\n          \n          \n            \n                static PooledHttpData from(HttpData data) {", "url": "https://github.com/line/armeria/pull/2448#discussion_r394116614", "createdAt": "2020-03-18T05:40:57Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/ByteBufHttpData.java", "diffHunk": "@@ -20,30 +20,53 @@\n \n import java.io.InputStream;\n import java.nio.charset.Charset;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n \n import com.google.common.base.MoreObjects;\n \n import com.linecorp.armeria.common.AbstractHttpData;\n import com.linecorp.armeria.common.HttpData;\n-import com.linecorp.armeria.common.util.UnstableApi;\n \n import io.netty.buffer.ByteBuf;\n-import io.netty.buffer.ByteBufHolder;\n import io.netty.buffer.ByteBufInputStream;\n import io.netty.buffer.ByteBufUtil;\n+import io.netty.buffer.EmptyByteBuf;\n import io.netty.buffer.Unpooled;\n+import io.netty.buffer.UnpooledByteBufAllocator;\n \n /**\n  * An {@link HttpData} that is backed by a {@link ByteBuf} for optimizing certain internal use cases. Not for\n  * general use.\n+ *\n+ * @deprecated Use {@link PooledHttpData}.\n  */\n-@UnstableApi\n-public final class ByteBufHttpData extends AbstractHttpData implements ByteBufHolder {\n+@Deprecated\n+public final class ByteBufHttpData extends AbstractHttpData implements PooledHttpData {\n+\n+    private static final AtomicIntegerFieldUpdater<ByteBufHttpData>\n+            closedUpdater = AtomicIntegerFieldUpdater.newUpdater(ByteBufHttpData.class, \"closed\");\n+\n+    static final ByteBufHttpData EMPTY = new ByteBufHttpData(\n+            new EmptyByteBuf(UnpooledByteBufAllocator.DEFAULT), false);\n+\n+    /**\n+     * Converts non-pooled {@link HttpData} into {@link PooledHttpData}.\n+     */\n+    static PooledHttpData convert(HttpData data) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd1433d09e57e1e49b5396291ed00d69cf603ab2"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f66ab225e140fa078d46ade3c8ae6e351229400f", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/f66ab225e140fa078d46ade3c8ae6e351229400f", "committedDate": "2020-04-27T08:24:58Z", "message": "Merge branch 'master' of github.com:line/armeria into pooled-web-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27e774c45d15ec73b9768513b582b4178e835aab", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/27e774c45d15ec73b9768513b582b4178e835aab", "committedDate": "2020-04-27T09:17:16Z", "message": "Add pooled request implementations and decorator."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60f19b3e39f44df0b141de69f8725bad177c76a1", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/60f19b3e39f44df0b141de69f8725bad177c76a1", "committedDate": "2020-05-05T05:36:55Z", "message": "Don't throw if user hasn't downcasted pooled responses it shoould still work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b774d4bf7c0cfa7d0a4862737dc158b93e1b578", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/6b774d4bf7c0cfa7d0a4862737dc158b93e1b578", "committedDate": "2020-05-05T06:08:46Z", "message": "Reorganize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "969d04b32e0cf812f03dfeaf3bd2ae50124d8a4d", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/969d04b32e0cf812f03dfeaf3bd2ae50124d8a4d", "committedDate": "2020-05-05T06:08:50Z", "message": "Merge branch 'master' of github.com:line/armeria into pooled-web-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28bd91f758325229ba41b58766e26307de1f398c", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/28bd91f758325229ba41b58766e26307de1f398c", "committedDate": "2020-05-05T07:52:00Z", "message": "Refactoring and add server side too."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/4a787f4bd228ff125b0b8fdc15ddebcbbebe801e", "committedDate": "2020-05-05T07:54:35Z", "message": "Remove unused unpooled."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MzE3NDMz", "url": "https://github.com/line/armeria/pull/2448#pullrequestreview-406317433", "createdAt": "2020-05-06T05:48:50Z", "commit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNTo0ODo1MFrOGREzbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNTo1MjozNFrOGRE3Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1NzY3Nw==", "bodyText": "Could we add a little bit more information about pooling?", "url": "https://github.com/line/armeria/pull/2448#discussion_r420557677", "createdAt": "2020-05-06T05:48:50Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/client/PooledHttpClient.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.client;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.HttpClient;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.util.Unwrappable;\n+import com.linecorp.armeria.unsafe.common.PooledHttpRequest;\n+import com.linecorp.armeria.unsafe.common.PooledHttpResponse;\n+\n+/**\n+ * Sends an {@link HttpRequest} to a remote {@link Endpoint}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1ODY3NQ==", "bodyText": "nit: probably OK to remove this?", "url": "https://github.com/line/armeria/pull/2448#discussion_r420558675", "createdAt": "2020-05-06T05:52:34Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/common/PooledHttpData.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.common;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+import com.linecorp.armeria.unsafe.client.PooledWebClient;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufHolder;\n+import io.netty.buffer.Unpooled;\n+\n+/**\n+ * A {@link HttpData} that is backed by a pooled {@link ByteBuf} for optimizing certain internal use cases. Not\n+ * for general use.\n+ *\n+ * <h3>What are pooled buffers?</h3>\n+ *\n+ * <p>The buffer backing a {@link PooledHttpData} is a pooled buffer - this means that it does not use normal\n+ * Java garbage collection, and instead uses manual memory management using a reference count, similar to\n+ * some constructs in languages like C++. Manual memory management is more fragile and not idiomatic in Java -\n+ * you should only use this class in performance-sensitive situations and after being ready to deal with these\n+ * very hard-to-debug issues.\n+ *\n+ * <p>You may interact with {@link PooledHttpData} when using objects that return pooled objects, such as\n+ * {@link PooledWebClient}. If you don't use such objects, you will never see a {@link PooledHttpData} and don't\n+ * need to read further.\n+ *\n+ * <h3>Impact of pooled buffers</h3>\n+ *\n+ * <p>Any time you receive a {@link PooledHttpData} it will have a single reference that must be released -\n+ * failure to release the reference will result in a memory leak and poor performance. You must make sure to do\n+ * this by calling {@link PooledHttpData#close()}, usually in a try-with-resources structure to avoid side\n+ * effects.\n+ *\n+ * <p>For example, <pre>{@code\n+ *\n+ * HttpResponse response = client.get(\"/\");\n+ * response.aggregateWithPooledObjects(ctx.alloc(), ctx.executor())\n+ *     .thenApply(aggResp -> {\n+ *         // try-with-resources here ensures the content is released if it is a ByteBufHttpData, or otherwise\n+ *         // is a no-op if it is not.\n+ *         try (HttpData content = aggResp.content()) {\n+ *             if (!aggResp.status().equals(HttpStatus.OK)) {\n+ *                 throw new IllegalStateException(\"Bad response\");\n+ *             }\n+ *             try {\n+ *                 return OBJECT_MAPPER.readValue(content.toInputStream(), Foo.class);\n+ *             } catch (IOException e) {\n+ *                 throw new IllegalArgumentException(\"Bad JSON: \" + content.toStringUtf8());\n+ *             }\n+ *         }\n+ *     });\n+ *\n+ * }</pre>\n+ *\n+ * <p>In this example, it is the initial {@code try (HttpData content = ...} that ensures the data is released.\n+ * Calls to methods on {@link HttpData} will all work and can be called any number of times within this block.\n+ * If called after the block, or a manual call to {@link PooledHttpData#close}, these methods will fail or\n+ * corrupt data.\n+ *\n+ * <h3>Even more advanced usage</h3>\n+ *\n+ * <p>In some cases, you may want to access the {@link ByteBuf} held by this {@link PooledHttpData}. This will\n+ * generally be used with a fallback to wrapping an unpooled {@link PooledHttpData}, e.g., <pre>{@code\n+ *\n+ * final ByteBuf buf;\n+ * if (data instanceof ByteBufHolder) {\n+ *     buf = ((ByteBufHolder) data).content();\n+ * } else {\n+ *     buf = Unpooled.wrappedBuffer(data.array());\n+ * }\n+ *\n+ * }</pre>\n+ *\n+ * <p>Using a {@link ByteBuf} directly is very advanced and can open up much more complicated management of\n+ * reference count. You should only ever do this if you are very comfortable with Netty.\n+ *\n+ * <p>It is recommended to also read through <a href=\"https://netty.io/wiki/reference-counted-objects.html\">\n+ * Reference counted objects</a> for more information on pooled objects.\n+ */\n+public interface PooledHttpData extends HttpData, ByteBufHolder, SafeCloseable {\n+\n+    /**\n+     * Converts non-pooled {@link HttpData} into {@link PooledHttpData}.\n+     */\n+    static PooledHttpData of(HttpData data) {\n+        requireNonNull(data, \"obj\");\n+        if (data instanceof PooledHttpData) {\n+            return (PooledHttpData) data;\n+        }\n+\n+        return new ByteBufHttpData(Unpooled.wrappedBuffer(data.array()), data.isEndOfStream());\n+    }\n+\n+    /**\n+     * Converts the specified Netty {@link ByteBuf} into an {@link PooledHttpData}. The buffer is not copied;\n+     * any changes made to it will be visible to {@link PooledHttpData}. The ownership of the buffer is\n+     * transferred to the {@link HttpData}. If you still need to use it after calling this method, make sure to\n+     * call {@link ByteBuf#retain()} first.\n+     *\n+     * @return a new {@link HttpData}. {@link #empty()} if the readable bytes of {@code buf} is 0.\n+     */\n+    static PooledHttpData wrap(ByteBuf buf) {\n+        requireNonNull(buf, \"buf\");\n+        if (!buf.isReadable()) {\n+            return ByteBufHttpData.EMPTY;\n+        }\n+        return new ByteBufHttpData(buf, false);\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 130}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MzE2MjQ5", "url": "https://github.com/line/armeria/pull/2448#pullrequestreview-406316249", "createdAt": "2020-05-06T05:44:46Z", "commit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNTo0NDo0NlrOGREveQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNjozMTowOFrOGRFmOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1NjY2NQ==", "bodyText": "Can remove Unwrappable.", "url": "https://github.com/line/armeria/pull/2448#discussion_r420556665", "createdAt": "2020-05-06T05:44:46Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/client/PooledHttpClient.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.client;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.HttpClient;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.util.Unwrappable;\n+import com.linecorp.armeria.unsafe.common.PooledHttpRequest;\n+import com.linecorp.armeria.unsafe.common.PooledHttpResponse;\n+\n+/**\n+ * Sends an {@link HttpRequest} to a remote {@link Endpoint}.\n+ */\n+public interface PooledHttpClient extends HttpClient, Unwrappable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1ODk1Mg==", "bodyText": "nit: two space before options", "url": "https://github.com/line/armeria/pull/2448#discussion_r420558952", "createdAt": "2020-05-06T05:53:29Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/common/DefaultPooledHttpRequest.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.common;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.reactivestreams.Subscriber;\n+\n+import com.google.common.collect.ObjectArrays;\n+\n+import com.linecorp.armeria.common.FilteredHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpObject;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.stream.SubscriptionOption;\n+\n+import io.netty.util.concurrent.EventExecutor;\n+\n+final class DefaultPooledHttpRequest extends FilteredHttpRequest implements PooledHttpRequest {\n+\n+    DefaultPooledHttpRequest(HttpRequest delegate) {\n+        super(delegate, true);\n+    }\n+\n+    @Override\n+    protected HttpObject filter(HttpObject obj) {\n+        if (!(obj instanceof HttpData)) {\n+            return obj;\n+        }\n+        return PooledHttpData.of((HttpData) obj);\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber) {\n+        subscribe(subscriber, SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber, SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            super.subscribe(subscriber,  options);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1OTQzMA==", "bodyText": "Could be static?\nI realized that we have containsWithPooledObjects in StreamMessageUtil. How about using it?", "url": "https://github.com/line/armeria/pull/2448#discussion_r420559430", "createdAt": "2020-05-06T05:55:02Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/common/DefaultPooledHttpRequest.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.common;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.reactivestreams.Subscriber;\n+\n+import com.google.common.collect.ObjectArrays;\n+\n+import com.linecorp.armeria.common.FilteredHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpObject;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.stream.SubscriptionOption;\n+\n+import io.netty.util.concurrent.EventExecutor;\n+\n+final class DefaultPooledHttpRequest extends FilteredHttpRequest implements PooledHttpRequest {\n+\n+    DefaultPooledHttpRequest(HttpRequest delegate) {\n+        super(delegate, true);\n+    }\n+\n+    @Override\n+    protected HttpObject filter(HttpObject obj) {\n+        if (!(obj instanceof HttpData)) {\n+            return obj;\n+        }\n+        return PooledHttpData.of((HttpData) obj);\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber) {\n+        subscribe(subscriber, SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber, SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            super.subscribe(subscriber,  options);\n+        } else {\n+            super.subscribe(subscriber, withPooled(options));\n+        }\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber, EventExecutor executor) {\n+        subscribe(subscriber, executor, SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber, EventExecutor executor,\n+                          SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            super.subscribe(subscriber, executor, options);\n+        } else {\n+            super.subscribe(subscriber, executor, withPooled(options));\n+        }\n+    }\n+\n+    @Override\n+    public CompletableFuture<List<HttpObject>> drainAll() {\n+        return drainAll(SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public CompletableFuture<List<HttpObject>> drainAll(SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            return super.drainAll(options);\n+        }\n+        return super.drainAll(withPooled(options));\n+    }\n+\n+    @Override\n+    public CompletableFuture<List<HttpObject>> drainAll(EventExecutor executor) {\n+        return drainAll(executor, SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public CompletableFuture<List<HttpObject>> drainAll(EventExecutor executor, SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            return super.drainAll(executor, options);\n+        }\n+        return super.drainAll(executor, withPooled(options));\n+    }\n+\n+    private boolean hasPooledObjects(SubscriptionOption... options) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU1OTQ2Mw==", "bodyText": "Could be static?", "url": "https://github.com/line/armeria/pull/2448#discussion_r420559463", "createdAt": "2020-05-06T05:55:08Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/common/DefaultPooledHttpRequest.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.common;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.reactivestreams.Subscriber;\n+\n+import com.google.common.collect.ObjectArrays;\n+\n+import com.linecorp.armeria.common.FilteredHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpObject;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.stream.SubscriptionOption;\n+\n+import io.netty.util.concurrent.EventExecutor;\n+\n+final class DefaultPooledHttpRequest extends FilteredHttpRequest implements PooledHttpRequest {\n+\n+    DefaultPooledHttpRequest(HttpRequest delegate) {\n+        super(delegate, true);\n+    }\n+\n+    @Override\n+    protected HttpObject filter(HttpObject obj) {\n+        if (!(obj instanceof HttpData)) {\n+            return obj;\n+        }\n+        return PooledHttpData.of((HttpData) obj);\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber) {\n+        subscribe(subscriber, SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber, SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            super.subscribe(subscriber,  options);\n+        } else {\n+            super.subscribe(subscriber, withPooled(options));\n+        }\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber, EventExecutor executor) {\n+        subscribe(subscriber, executor, SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber, EventExecutor executor,\n+                          SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            super.subscribe(subscriber, executor, options);\n+        } else {\n+            super.subscribe(subscriber, executor, withPooled(options));\n+        }\n+    }\n+\n+    @Override\n+    public CompletableFuture<List<HttpObject>> drainAll() {\n+        return drainAll(SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public CompletableFuture<List<HttpObject>> drainAll(SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            return super.drainAll(options);\n+        }\n+        return super.drainAll(withPooled(options));\n+    }\n+\n+    @Override\n+    public CompletableFuture<List<HttpObject>> drainAll(EventExecutor executor) {\n+        return drainAll(executor, SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public CompletableFuture<List<HttpObject>> drainAll(EventExecutor executor, SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            return super.drainAll(executor, options);\n+        }\n+        return super.drainAll(executor, withPooled(options));\n+    }\n+\n+    private boolean hasPooledObjects(SubscriptionOption... options) {\n+        for (SubscriptionOption option : options) {\n+            if (option == SubscriptionOption.WITH_POOLED_OBJECTS) {\n+                return true;\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private SubscriptionOption[] withPooled(SubscriptionOption[] options) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2MDY5Mw==", "bodyText": "Can we move this to StreamMessageUtil so DefaultHttpRequest share this method?", "url": "https://github.com/line/armeria/pull/2448#discussion_r420560693", "createdAt": "2020-05-06T05:59:16Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/common/DefaultPooledHttpResponse.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.common;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.reactivestreams.Subscriber;\n+\n+import com.google.common.collect.ObjectArrays;\n+\n+import com.linecorp.armeria.common.FilteredHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpObject;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.stream.SubscriptionOption;\n+\n+import io.netty.util.concurrent.EventExecutor;\n+\n+final class DefaultPooledHttpResponse extends FilteredHttpResponse implements PooledHttpResponse {\n+\n+    DefaultPooledHttpResponse(HttpResponse delegate) {\n+        super(delegate, true);\n+    }\n+\n+    @Override\n+    protected HttpObject filter(HttpObject obj) {\n+        if (!(obj instanceof HttpData)) {\n+            return obj;\n+        }\n+        return PooledHttpData.of((HttpData) obj);\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber) {\n+        subscribe(subscriber, SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber, SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            super.subscribe(subscriber,  options);\n+        } else {\n+            super.subscribe(subscriber, withPooled(options));\n+        }\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber, EventExecutor executor) {\n+        subscribe(subscriber, executor, SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public void subscribe(Subscriber<? super HttpObject> subscriber, EventExecutor executor,\n+                          SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            super.subscribe(subscriber, executor, options);\n+        } else {\n+            super.subscribe(subscriber, executor, withPooled(options));\n+        }\n+    }\n+\n+    @Override\n+    public CompletableFuture<List<HttpObject>> drainAll() {\n+        return drainAll(SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public CompletableFuture<List<HttpObject>> drainAll(SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            return super.drainAll(options);\n+        }\n+        return super.drainAll(withPooled(options));\n+    }\n+\n+    @Override\n+    public CompletableFuture<List<HttpObject>> drainAll(EventExecutor executor) {\n+        return drainAll(executor, SubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    @Override\n+    public CompletableFuture<List<HttpObject>> drainAll(EventExecutor executor, SubscriptionOption... options) {\n+        if (hasPooledObjects(options)) {\n+            return super.drainAll(executor, options);\n+        }\n+        return super.drainAll(executor, withPooled(options));\n+    }\n+\n+    private boolean hasPooledObjects(SubscriptionOption... options) {\n+        for (SubscriptionOption option : options) {\n+            if (option == SubscriptionOption.WITH_POOLED_OBJECTS) {\n+                return true;\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private SubscriptionOption[] withPooled(SubscriptionOption[] options) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2MjIwNw==", "bodyText": "Shouldn't we add @Override to all methods here?", "url": "https://github.com/line/armeria/pull/2448#discussion_r420562207", "createdAt": "2020-05-06T06:04:09Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/client/PooledWebClient.java", "diffHunk": "@@ -0,0 +1,208 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.client;\n+\n+import java.nio.charset.Charset;\n+\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import com.linecorp.armeria.unsafe.common.PooledHttpData;\n+import com.linecorp.armeria.unsafe.common.PooledHttpResponse;\n+\n+/**\n+ * An asynchronous web client which will return pooled buffers in its responses where possible. Before using\n+ * this class, please review the notes in {@link PooledHttpData}. Usage of this class is very advanced and while\n+ * it may unlock significant performance, has even more of a chance of introducing difficult to debug issues in\n+ * an application. If you are not comfortable with this, use {@link WebClient}.\n+ */\n+public interface PooledWebClient extends WebClient {\n+\n+    /**\n+     * Creates a {@link PooledWebClient} that delegates to the provided {@link WebClient} for issuing requests.\n+     */\n+    static PooledWebClient of(WebClient delegate) {\n+        return new DefaultPooledWebClient(delegate);\n+    }\n+\n+    /**\n+     * Sends the specified HTTP request.\n+     */\n+    PooledHttpResponse execute(HttpRequest req);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2Njc1Nw==", "bodyText": "Can remove this?", "url": "https://github.com/line/armeria/pull/2448#discussion_r420566757", "createdAt": "2020-05-06T06:19:06Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/common/PooledAggregatedHttpRequest.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.common;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+/**\n+ * An {@link AggregatedHttpRequest} using pooled buffers for the content. Make sure to call\n+ * {@link AutoCloseable#close()} on this response or the {@code content} to release pooled resources.\n+ */\n+public interface PooledAggregatedHttpRequest extends AggregatedHttpRequest, SafeCloseable {\n+\n+    /**\n+     * Returns a {@link PooledAggregatedHttpRequest} that wraps the {@link AggregatedHttpRequest}, ensuring all\n+     * published data is a {@link PooledHttpData}.\n+     */\n+    static PooledAggregatedHttpRequest of(AggregatedHttpRequest delegate) {\n+        requireNonNull(delegate, \"delegate\");\n+        if (delegate instanceof PooledAggregatedHttpRequest) {\n+            return (PooledAggregatedHttpRequest) delegate;\n+        }\n+        return new DefaultPooledAggregatedHttpRequest(delegate);\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2NjkyMA==", "bodyText": "ditto", "url": "https://github.com/line/armeria/pull/2448#discussion_r420566920", "createdAt": "2020-05-06T06:19:39Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/common/PooledAggregatedHttpResponse.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.common;\n+\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+/**\n+ * An {@link AggregatedHttpResponse} using pooled buffers for the content. Make sure to call\n+ * {@link AutoCloseable#close()} on this response or the {@code content} to release pooled resources.\n+ */\n+public interface PooledAggregatedHttpResponse extends AggregatedHttpResponse, SafeCloseable {\n+\n+    /**\n+     * {@inheritDoc}\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2NzE2Mw==", "bodyText": "nit: An {@link HttpData}", "url": "https://github.com/line/armeria/pull/2448#discussion_r420567163", "createdAt": "2020-05-06T06:20:25Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/common/PooledHttpData.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.common;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+import com.linecorp.armeria.unsafe.client.PooledWebClient;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufHolder;\n+import io.netty.buffer.Unpooled;\n+\n+/**\n+ * A {@link HttpData} that is backed by a pooled {@link ByteBuf} for optimizing certain internal use cases. Not", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2ODA3MQ==", "bodyText": "nit: a {@link PooledHttpData}", "url": "https://github.com/line/armeria/pull/2448#discussion_r420568071", "createdAt": "2020-05-06T06:23:21Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/common/PooledHttpData.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.common;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+import com.linecorp.armeria.unsafe.client.PooledWebClient;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufHolder;\n+import io.netty.buffer.Unpooled;\n+\n+/**\n+ * A {@link HttpData} that is backed by a pooled {@link ByteBuf} for optimizing certain internal use cases. Not\n+ * for general use.\n+ *\n+ * <h3>What are pooled buffers?</h3>\n+ *\n+ * <p>The buffer backing a {@link PooledHttpData} is a pooled buffer - this means that it does not use normal\n+ * Java garbage collection, and instead uses manual memory management using a reference count, similar to\n+ * some constructs in languages like C++. Manual memory management is more fragile and not idiomatic in Java -\n+ * you should only use this class in performance-sensitive situations and after being ready to deal with these\n+ * very hard-to-debug issues.\n+ *\n+ * <p>You may interact with {@link PooledHttpData} when using objects that return pooled objects, such as\n+ * {@link PooledWebClient}. If you don't use such objects, you will never see a {@link PooledHttpData} and don't\n+ * need to read further.\n+ *\n+ * <h3>Impact of pooled buffers</h3>\n+ *\n+ * <p>Any time you receive a {@link PooledHttpData} it will have a single reference that must be released -\n+ * failure to release the reference will result in a memory leak and poor performance. You must make sure to do\n+ * this by calling {@link PooledHttpData#close()}, usually in a try-with-resources structure to avoid side\n+ * effects.\n+ *\n+ * <p>For example, <pre>{@code\n+ *\n+ * HttpResponse response = client.get(\"/\");\n+ * response.aggregateWithPooledObjects(ctx.alloc(), ctx.executor())\n+ *     .thenApply(aggResp -> {\n+ *         // try-with-resources here ensures the content is released if it is a ByteBufHttpData, or otherwise\n+ *         // is a no-op if it is not.\n+ *         try (HttpData content = aggResp.content()) {\n+ *             if (!aggResp.status().equals(HttpStatus.OK)) {\n+ *                 throw new IllegalStateException(\"Bad response\");\n+ *             }\n+ *             try {\n+ *                 return OBJECT_MAPPER.readValue(content.toInputStream(), Foo.class);\n+ *             } catch (IOException e) {\n+ *                 throw new IllegalArgumentException(\"Bad JSON: \" + content.toStringUtf8());\n+ *             }\n+ *         }\n+ *     });\n+ *\n+ * }</pre>\n+ *\n+ * <p>In this example, it is the initial {@code try (HttpData content = ...} that ensures the data is released.\n+ * Calls to methods on {@link HttpData} will all work and can be called any number of times within this block.\n+ * If called after the block, or a manual call to {@link PooledHttpData#close}, these methods will fail or\n+ * corrupt data.\n+ *\n+ * <h3>Even more advanced usage</h3>\n+ *\n+ * <p>In some cases, you may want to access the {@link ByteBuf} held by this {@link PooledHttpData}. This will\n+ * generally be used with a fallback to wrapping an unpooled {@link PooledHttpData}, e.g., <pre>{@code\n+ *\n+ * final ByteBuf buf;\n+ * if (data instanceof ByteBufHolder) {\n+ *     buf = ((ByteBufHolder) data).content();\n+ * } else {\n+ *     buf = Unpooled.wrappedBuffer(data.array());\n+ * }\n+ *\n+ * }</pre>\n+ *\n+ * <p>Using a {@link ByteBuf} directly is very advanced and can open up much more complicated management of\n+ * reference count. You should only ever do this if you are very comfortable with Netty.\n+ *\n+ * <p>It is recommended to also read through <a href=\"https://netty.io/wiki/reference-counted-objects.html\">\n+ * Reference counted objects</a> for more information on pooled objects.\n+ */\n+public interface PooledHttpData extends HttpData, ByteBufHolder, SafeCloseable {\n+\n+    /**\n+     * Converts non-pooled {@link HttpData} into {@link PooledHttpData}.\n+     */\n+    static PooledHttpData of(HttpData data) {\n+        requireNonNull(data, \"obj\");\n+        if (data instanceof PooledHttpData) {\n+            return (PooledHttpData) data;\n+        }\n+\n+        return new ByteBufHttpData(Unpooled.wrappedBuffer(data.array()), data.isEndOfStream());\n+    }\n+\n+    /**\n+     * Converts the specified Netty {@link ByteBuf} into an {@link PooledHttpData}. The buffer is not copied;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU2ODQyMw==", "bodyText": "Should we use HTTP instead of HTTP/2 because the client might use HTTP/1.1?", "url": "https://github.com/line/armeria/pull/2448#discussion_r420568423", "createdAt": "2020-05-06T06:24:32Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/common/PooledHttpRequest.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.common;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.stream.SubscriptionOption;\n+import com.linecorp.armeria.common.util.EventLoopCheckingFuture;\n+import com.linecorp.armeria.internal.common.HttpRequestAggregator;\n+\n+import io.netty.buffer.ByteBufAllocator;\n+import io.netty.buffer.PooledByteBufAllocator;\n+import io.netty.util.concurrent.EventExecutor;\n+\n+/**\n+ * A streamed HTTP/2 {@link Request} which returns pooled buffers.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3MDU2Mg==", "bodyText": "How about changing the order of methods parameters? execute(delegate(), ctx, req)) looks natural to me", "url": "https://github.com/line/armeria/pull/2448#discussion_r420570562", "createdAt": "2020-05-06T06:30:49Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/client/SimplePooledDecoratingHttpClient.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.client;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.client.HttpClient;\n+import com.linecorp.armeria.client.SimpleDecoratingHttpClient;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.unsafe.common.PooledHttpData;\n+import com.linecorp.armeria.unsafe.common.PooledHttpRequest;\n+import com.linecorp.armeria.unsafe.common.PooledHttpResponse;\n+\n+/**\n+ * Decorates an {@link HttpClient}, ensuring {@link HttpData} are all {@link PooledHttpData}.\n+ */\n+public abstract class SimplePooledDecoratingHttpClient extends SimpleDecoratingHttpClient\n+        implements PooledHttpClient {\n+\n+    /**\n+     * Creates a new instance that decorates the specified {@link HttpClient}.\n+     */\n+    protected SimplePooledDecoratingHttpClient(HttpClient delegate) {\n+        super(PooledHttpClient.of(delegate));\n+    }\n+\n+    @Override\n+    public final HttpResponse execute(ClientRequestContext ctx, HttpRequest req) throws Exception {\n+        return execute(ctx, PooledHttpRequest.of(req), delegate());\n+    }\n+\n+    @Override\n+    public PooledHttpResponse execute(ClientRequestContext ctx, PooledHttpRequest req) throws Exception {\n+        return PooledHttpResponse.of(execute(ctx, req, delegate()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3MDY4Mg==", "bodyText": "ditto", "url": "https://github.com/line/armeria/pull/2448#discussion_r420570682", "createdAt": "2020-05-06T06:31:08Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/unsafe/server/SimplePooledDecoratingHttpService.java", "diffHunk": "@@ -0,0 +1,64 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.unsafe.server;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+import com.linecorp.armeria.server.SimpleDecoratingHttpService;\n+import com.linecorp.armeria.unsafe.common.PooledHttpData;\n+import com.linecorp.armeria.unsafe.common.PooledHttpRequest;\n+import com.linecorp.armeria.unsafe.common.PooledHttpResponse;\n+\n+/**\n+ * An {@link HttpService} that decorates another {@link HttpService} publishing {@link PooledHttpData}.\n+ *\n+ * @see SimpleDecoratingHttpService\n+ */\n+public abstract class SimplePooledDecoratingHttpService extends SimpleDecoratingHttpService\n+        implements PooledHttpService {\n+\n+    private final PooledHttpService pooledDelegate;\n+\n+    /**\n+     * Creates a new instance that decorates the specified {@link HttpService}.\n+     */\n+    protected SimplePooledDecoratingHttpService(HttpService delegate) {\n+        super(delegate);\n+        pooledDelegate = PooledHttpService.of(delegate);\n+    }\n+\n+    @Override\n+    public final HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) throws Exception {\n+        return serve(ctx, PooledHttpRequest.of(req), pooledDelegate);\n+    }\n+\n+    @Override\n+    public PooledHttpResponse serve(ServiceRequestContext ctx, PooledHttpRequest req) throws Exception {\n+        return PooledHttpResponse.of(serve(ctx, req, delegate()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a787f4bd228ff125b0b8fdc15ddebcbbebe801e"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee91fd50b56cc65fd4ec0225f16f4a4169b047e5", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/ee91fd50b56cc65fd4ec0225f16f4a4169b047e5", "committedDate": "2020-05-08T08:31:11Z", "message": "More links to the 'pooled docs'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e99ae736012b8fea28da9b9b24e0d56c5fca480", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/0e99ae736012b8fea28da9b9b24e0d56c5fca480", "committedDate": "2020-05-08T08:37:30Z", "message": "Move stuff around"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed8c5e3c92a6edede2804b611b2ed99080a13232", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/ed8c5e3c92a6edede2804b611b2ed99080a13232", "committedDate": "2020-05-08T09:07:10Z", "message": "Cleanups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e1af6cab1f527680f403b896eee13581f080cb3", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/8e1af6cab1f527680f403b896eee13581f080cb3", "committedDate": "2020-05-08T09:12:46Z", "message": "Header order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "748273f8f6ddaccf13f6a677c5f425e5d9b2f272", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/748273f8f6ddaccf13f6a677c5f425e5d9b2f272", "committedDate": "2020-05-08T09:17:41Z", "message": "Header order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa3135f2591839a39671231ab922d7f781d29edd", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/fa3135f2591839a39671231ab922d7f781d29edd", "committedDate": "2020-05-08T09:22:13Z", "message": "Header order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d139c6302cfd64691fb73ce1d479bfbf5c4d4595", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/d139c6302cfd64691fb73ce1d479bfbf5c4d4595", "committedDate": "2020-05-10T09:16:51Z", "message": "[WIP] Pass unpooled request to normal HttpService. Add unit tests for service classes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcfd911875e7376ef764c99e87ea82bacb14b196", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/bcfd911875e7376ef764c99e87ea82bacb14b196", "committedDate": "2020-05-23T04:28:31Z", "message": "Merge branch 'master' of github.com:line/armeria into pooled-web-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9072985c553aba3411c0ae4452aeb9231c0aedb3", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/9072985c553aba3411c0ae4452aeb9231c0aedb3", "committedDate": "2020-05-23T05:26:12Z", "message": "Client unpooled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/37069c746ed4b49c0054214a67b43b2f7fb34810", "committedDate": "2020-05-24T06:55:27Z", "message": "Fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5216239a2c61bc9325c40cddbbbe0c95a5c1943d", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/5216239a2c61bc9325c40cddbbbe0c95a5c1943d", "committedDate": "2020-05-24T13:53:09Z", "message": "Client test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODExMTU2", "url": "https://github.com/line/armeria/pull/2448#pullrequestreview-419811156", "createdAt": "2020-05-28T06:29:50Z", "commit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNjoyOTo1MFrOGbnUEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwNjo0NTowN1rOGbnrjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYwODg1MA==", "bodyText": "nit: How about moving this check to the constructor?", "url": "https://github.com/line/armeria/pull/2448#discussion_r431608850", "createdAt": "2020-05-28T06:29:50Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/unsafe/DefaultPooledHttpClient.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.unsafe;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.client.HttpClient;\n+import com.linecorp.armeria.common.unsafe.PooledHttpRequest;\n+import com.linecorp.armeria.common.unsafe.PooledHttpResponse;\n+import com.linecorp.armeria.common.util.AbstractUnwrappable;\n+\n+final class DefaultPooledHttpClient extends AbstractUnwrappable<HttpClient> implements PooledHttpClient {\n+\n+    DefaultPooledHttpClient(HttpClient delegate) {\n+        super(delegate);\n+    }\n+\n+    @Override\n+    public PooledHttpResponse execute(ClientRequestContext ctx, PooledHttpRequest req) throws Exception {\n+        // Always a wrapped non-pooled client, make sure it gets a normal request.\n+        assert !(delegate() instanceof PooledHttpClient);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYxMTE0Mg==", "bodyText": "OK to remove?", "url": "https://github.com/line/armeria/pull/2448#discussion_r431611142", "createdAt": "2020-05-28T06:35:45Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/PooledAggregatedHttpRequest.java", "diffHunk": "@@ -0,0 +1,50 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.unsafe;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+/**\n+ * An {@link AggregatedHttpRequest} using pooled buffers for the content. Make sure to call\n+ * {@link AutoCloseable#close()} on this response or the {@code content} to release pooled resources.\n+ */\n+public interface PooledAggregatedHttpRequest extends AggregatedHttpRequest, SafeCloseable {\n+\n+    /**\n+     * Returns a {@link PooledAggregatedHttpRequest} that wraps the {@link AggregatedHttpRequest}, ensuring all\n+     * published data is a {@link PooledHttpData}.\n+     */\n+    static PooledAggregatedHttpRequest of(AggregatedHttpRequest delegate) {\n+        requireNonNull(delegate, \"delegate\");\n+        if (delegate instanceof PooledAggregatedHttpRequest) {\n+            return (PooledAggregatedHttpRequest) delegate;\n+        }\n+        return new DefaultPooledAggregatedHttpRequest(delegate);\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYxMTYyMg==", "bodyText": "Perhaps OK to remove this?", "url": "https://github.com/line/armeria/pull/2448#discussion_r431611622", "createdAt": "2020-05-28T06:37:00Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/AggregatedHttpMessage.java", "diffHunk": "@@ -20,12 +20,15 @@\n \n import javax.annotation.Nullable;\n \n+import com.linecorp.armeria.common.util.UnstableApi;\n+\n /**\n  * A complete HTTP message whose content is readily available as a single {@link HttpData}. It can be an\n  * HTTP request or an HTTP response depending on what header values it contains. For example, having a\n  * {@link HttpHeaderNames#STATUS} header could mean it is an HTTP response.\n  */\n-interface AggregatedHttpMessage {\n+@UnstableApi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYxMjcyMg==", "bodyText": "No need to use @inheritDoc if you don't add anything to Javadoc", "url": "https://github.com/line/armeria/pull/2448#discussion_r431612722", "createdAt": "2020-05-28T06:39:54Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/PooledAggregatedHttpResponse.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.unsafe;\n+\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+/**\n+ * An {@link AggregatedHttpResponse} using pooled buffers for the content. Make sure to call\n+ * {@link AutoCloseable#close()} on this response or the {@code content} to release pooled resources.\n+ */\n+public interface PooledAggregatedHttpResponse extends AggregatedHttpResponse, SafeCloseable {\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    PooledHttpData content();\n+\n+    /**\n+     * {@inheritDoc}\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYxMzIxOA==", "bodyText": "This example needs an update because HttpData is not Closeable anymore.", "url": "https://github.com/line/armeria/pull/2448#discussion_r431613218", "createdAt": "2020-05-28T06:41:11Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/PooledHttpData.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.unsafe;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import com.linecorp.armeria.client.unsafe.PooledWebClient;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufHolder;\n+import io.netty.buffer.Unpooled;\n+\n+/**\n+ * An {@link HttpData} that is backed by a pooled {@link ByteBuf} for optimizing certain internal use cases. Not\n+ * for general use.\n+ *\n+ * <h3>What are pooled buffers?</h3>\n+ *\n+ * <p>The buffer backing a {@link PooledHttpData} is a pooled buffer - this means that it does not use normal\n+ * Java garbage collection, and instead uses manual memory management using a reference count, similar to\n+ * some constructs in languages like C++. Manual memory management is more fragile and not idiomatic in Java -\n+ * you should only use this class in performance-sensitive situations and after being ready to deal with these\n+ * very hard-to-debug issues.\n+ *\n+ * <p>You may interact with {@link PooledHttpData} when using objects that return pooled objects, such as\n+ * {@link PooledWebClient}. If you don't use such objects, you will never see a {@link PooledHttpData} and don't\n+ * need to read further.\n+ *\n+ * <h3>Impact of pooled buffers</h3>\n+ *\n+ * <p>Any time you receive a {@link PooledHttpData} it will have a single reference that must be released -\n+ * failure to release the reference will result in a memory leak and poor performance. You must make sure to do\n+ * this by calling {@link PooledHttpData#close()}, usually in a try-with-resources structure to avoid side\n+ * effects.\n+ *\n+ * <p>For example, <pre>{@code\n+ *\n+ * HttpResponse response = client.get(\"/\");\n+ * response.aggregateWithPooledObjects(ctx.alloc(), ctx.executor())\n+ *     .thenApply(aggResp -> {\n+ *         // try-with-resources here ensures the content is released if it is a ByteBufHttpData, or otherwise\n+ *         // is a no-op if it is not.\n+ *         try (HttpData content = aggResp.content()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYxMzUxOA==", "bodyText": "toUnpooled or asUnpooled?", "url": "https://github.com/line/armeria/pull/2448#discussion_r431613518", "createdAt": "2020-05-28T06:41:57Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/PooledHttpRequest.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.unsafe;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.stream.SubscriptionOption;\n+import com.linecorp.armeria.common.util.EventLoopCheckingFuture;\n+import com.linecorp.armeria.internal.common.HttpRequestAggregator;\n+\n+import io.netty.buffer.ByteBufAllocator;\n+import io.netty.buffer.PooledByteBufAllocator;\n+import io.netty.util.concurrent.EventExecutor;\n+\n+/**\n+ * A streamed HTTP/2 {@link Request} which returns pooled buffers.\n+ */\n+public interface PooledHttpRequest extends HttpRequest {\n+\n+    /**\n+     * Returns a {@link PooledHttpRequest} that wraps the {@link HttpRequest}, ensuring all published data\n+     * is a {@link PooledHttpData}.\n+     */\n+    static PooledHttpRequest of(HttpRequest delegate) {\n+        requireNonNull(delegate, \"delegate\");\n+        if (delegate instanceof PooledHttpRequest) {\n+            return (PooledHttpRequest) delegate;\n+        }\n+        return new DefaultPooledHttpRequest(delegate);\n+    }\n+\n+    /**\n+     * Aggregates this request. The returned {@link CompletableFuture} will be notified when the content and\n+     * the trailers of the response are received fully.\n+     */\n+    default CompletableFuture<PooledAggregatedHttpRequest> aggregateWithPooledObjects() {\n+        return aggregateWithPooledObjects(defaultSubscriberExecutor());\n+    }\n+\n+    /**\n+     * Aggregates this request. The returned {@link CompletableFuture} will be notified when the content and\n+     * the trailers of the request are received fully.\n+     */\n+    default CompletableFuture<PooledAggregatedHttpRequest> aggregateWithPooledObjects(ByteBufAllocator alloc) {\n+        requireNonNull(alloc);\n+        return aggregateWithPooledObjects(defaultSubscriberExecutor(), alloc);\n+    }\n+\n+    /**\n+     * Aggregates this request. The returned {@link CompletableFuture} will be notified when the content and\n+     * the trailers of the request are received fully.\n+     */\n+    default CompletableFuture<PooledAggregatedHttpRequest> aggregateWithPooledObjects(EventExecutor executor) {\n+        requireNonNull(executor);\n+        return aggregateWithPooledObjects(executor, PooledByteBufAllocator.DEFAULT);\n+    }\n+\n+    /**\n+     * Aggregates this request. The returned {@link CompletableFuture} will be notified when the content and\n+     * the trailers of the request are received fully.\n+     */\n+    default CompletableFuture<PooledAggregatedHttpRequest> aggregateWithPooledObjects(\n+            EventExecutor executor, ByteBufAllocator alloc) {\n+        final CompletableFuture<AggregatedHttpRequest> future = new EventLoopCheckingFuture<>();\n+        final HttpRequestAggregator aggregator = new HttpRequestAggregator(this, future, alloc);\n+        subscribe(aggregator, executor, SubscriptionOption.WITH_POOLED_OBJECTS);\n+        return future.thenApply(DefaultPooledAggregatedHttpRequest::new);\n+    }\n+\n+    /**\n+     * Aggregate this request without pooled objects. When operating on {@link PooledHttpRequest}, this should\n+     * be avoided.\n+     *\n+     * @deprecated Use {@link #aggregateWithPooledObjects()}.\n+     */\n+    @Override\n+    @Deprecated\n+    default CompletableFuture<AggregatedHttpRequest> aggregate() {\n+        return HttpRequest.super.aggregate();\n+    }\n+\n+    /**\n+     * Aggregate this request without pooled objects. When operating on {@link PooledHttpRequest}, this should\n+     * be avoided.\n+     *\n+     * @deprecated Use {@link #aggregateWithPooledObjects(EventExecutor)}.\n+     */\n+    @Override\n+    @Deprecated\n+    default CompletableFuture<AggregatedHttpRequest> aggregate(EventExecutor executor) {\n+        return HttpRequest.super.aggregate(executor);\n+    }\n+\n+    /**\n+     * Converts this {@link PooledHttpRequest} to an unpooled {@link HttpRequest}. Only one of this\n+     * {@link PooledHttpRequest} or the returned {@link HttpRequest} can be subscribed to, if both are attempted\n+     * to be used, it will cause an error or bad behavior.\n+     */\n+    HttpRequest toUnpooled();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYxNDAyNA==", "bodyText": "Question: Should we add withEndOfStream(boolean) which returns this if endOfStream did not change?", "url": "https://github.com/line/armeria/pull/2448#discussion_r431614024", "createdAt": "2020-05-28T06:43:12Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/file/StreamingHttpFile.java", "diffHunk": "@@ -223,7 +224,7 @@ private void doRead(HttpResponseWriter res, T in, long offset, long end,\n \n                     final HttpFileBuilder builder =\n                             HttpFile.builder(array != null ? HttpData.wrap(array)\n-                                                           : new ByteBufHttpData(buf, true),\n+                                                           : PooledHttpData.wrap(buf).withEndOfStream(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYxNDM0Ng==", "bodyText": "nit: Should we check this in the constructor?", "url": "https://github.com/line/armeria/pull/2448#discussion_r431614346", "createdAt": "2020-05-28T06:43:56Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/unsafe/DefaultPooledHttpService.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.unsafe;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.unsafe.PooledHttpRequest;\n+import com.linecorp.armeria.common.unsafe.PooledHttpResponse;\n+import com.linecorp.armeria.common.util.AbstractUnwrappable;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.Route;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+final class DefaultPooledHttpService extends AbstractUnwrappable<HttpService> implements PooledHttpService {\n+\n+    DefaultPooledHttpService(HttpService delegate) {\n+        super(delegate);\n+    }\n+\n+    @Override\n+    public PooledHttpResponse serve(ServiceRequestContext ctx, PooledHttpRequest req) throws Exception {\n+        // Always a wrapped non-pooled service, make sure it gets a normal request.\n+        assert !(delegate() instanceof PooledHttpService);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYxNDc4MA==", "bodyText": "Could use aggregate() instead of aggregateWithPooledObjects?", "url": "https://github.com/line/armeria/pull/2448#discussion_r431614780", "createdAt": "2020-05-28T06:44:58Z", "author": {"login": "trustin"}, "path": "core/src/test/java/com/linecorp/armeria/internal/common/DefaultHttpRequestTest.java", "diffHunk": "@@ -53,19 +54,19 @@\n     void abortedAggregation(boolean executorSpecified, boolean withPooledObjects, Throwable abortCause) {\n         final Thread mainThread = Thread.currentThread();\n         final DefaultHttpRequest req = new DefaultHttpRequest(RequestHeaders.of(HttpMethod.GET, \"/foo\"));\n-        final CompletableFuture<AggregatedHttpRequest> future;\n+        final CompletableFuture<? extends AggregatedHttpRequest> future;\n \n         // Practically same execution, but we need to test the both case due to code duplication.\n         if (executorSpecified) {\n             if (withPooledObjects) {\n-                future = req.aggregateWithPooledObjects(\n+                future = PooledHttpRequest.of(req).aggregateWithPooledObjects(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYxNDg2MA==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/2448#discussion_r431614860", "createdAt": "2020-05-28T06:45:07Z", "author": {"login": "trustin"}, "path": "core/src/test/java/com/linecorp/armeria/internal/common/DefaultHttpRequestTest.java", "diffHunk": "@@ -53,19 +54,19 @@\n     void abortedAggregation(boolean executorSpecified, boolean withPooledObjects, Throwable abortCause) {\n         final Thread mainThread = Thread.currentThread();\n         final DefaultHttpRequest req = new DefaultHttpRequest(RequestHeaders.of(HttpMethod.GET, \"/foo\"));\n-        final CompletableFuture<AggregatedHttpRequest> future;\n+        final CompletableFuture<? extends AggregatedHttpRequest> future;\n \n         // Practically same execution, but we need to test the both case due to code duplication.\n         if (executorSpecified) {\n             if (withPooledObjects) {\n-                future = req.aggregateWithPooledObjects(\n+                future = PooledHttpRequest.of(req).aggregateWithPooledObjects(\n                         CommonPools.workerGroup().next(), PooledByteBufAllocator.DEFAULT);\n             } else {\n                 future = req.aggregate(CommonPools.workerGroup().next());\n             }\n         } else {\n             if (withPooledObjects) {\n-                future = req.aggregateWithPooledObjects(PooledByteBufAllocator.DEFAULT);\n+                future = PooledHttpRequest.of(req).aggregateWithPooledObjects(PooledByteBufAllocator.DEFAULT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9991b46b959cc2dc4a078b3af8c18f06c3115721", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/9991b46b959cc2dc4a078b3af8c18f06c3115721", "committedDate": "2020-05-30T06:04:42Z", "message": "Merge branch 'master' of github.com:line/armeria into pooled-web-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7ef9615675dbc0c303837bdc3ad9e6657a6b552", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/f7ef9615675dbc0c303837bdc3ad9e6657a6b552", "committedDate": "2020-05-30T06:17:42Z", "message": "Cleanups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c95c7375ca818bb6fe190f7a1d44f01e23e57687", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/c95c7375ca818bb6fe190f7a1d44f01e23e57687", "committedDate": "2020-05-30T11:11:16Z", "message": "Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e43356ed4a5f9dc69edfb8da56c500bf2144c89d", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/e43356ed4a5f9dc69edfb8da56c500bf2144c89d", "committedDate": "2020-06-06T07:57:38Z", "message": "subscribeWithPooledObjects and split up internal subscription options"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f80f2f077f4dfb51edf2ddb917aa054b5d98bb55", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/f80f2f077f4dfb51edf2ddb917aa054b5d98bb55", "committedDate": "2020-06-06T08:00:10Z", "message": "Reenable reactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99eded6caf2a97a98a27ec97ed2fab7a5a140113", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/99eded6caf2a97a98a27ec97ed2fab7a5a140113", "committedDate": "2020-06-07T03:01:32Z", "message": "Merge branch 'master' of github.com:line/armeria into pooled-web-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1285a9a97896dfaf25a2104cd2e54a8bc7c1446", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/e1285a9a97896dfaf25a2104cd2e54a8bc7c1446", "committedDate": "2020-06-07T05:29:27Z", "message": "More tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "780644df80fea41f113f733540f0d35200ea55dd", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/780644df80fea41f113f733540f0d35200ea55dd", "committedDate": "2020-06-07T06:39:14Z", "message": "Clenaups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97746c36dcaf474be33ea44d358f50944c80b17c", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/97746c36dcaf474be33ea44d358f50944c80b17c", "committedDate": "2020-06-07T08:38:23Z", "message": "Merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2619fd2799e0bfa44d4d85023573ee9aac87c4e7", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/2619fd2799e0bfa44d4d85023573ee9aac87c4e7", "committedDate": "2020-06-08T01:12:48Z", "message": "Fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MjQzMDI5", "url": "https://github.com/line/armeria/pull/2448#pullrequestreview-426243029", "createdAt": "2020-06-08T13:34:32Z", "commit": {"oid": "2619fd2799e0bfa44d4d85023573ee9aac87c4e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzozNDozMlrOGgeWfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzozNDozMlrOGgeWfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwNDg5NQ==", "bodyText": "This is not normal behavior, however a IllegalReferenceCountException could be raised by:\nfinal ByteBuf byteBuf = Unpooled.wrappedBuffer(\"hello\".getBytes());\nfinal PooledHttpData pooledHttpData1 = PooledHttpData.wrap(byteBuf);\npooledHttpData1.close();\nfinal PooledHttpData polledHttpData2 = pooledHttpData1.withEndOfStream(true);\n// io.netty.util.IllegalReferenceCountException: refCnt: 0, decrement: 1\npolledHttpData2.close();\nSince this method does not copy the ByteBufHttpData.closed.", "url": "https://github.com/line/armeria/pull/2448#discussion_r436704895", "createdAt": "2020-06-08T13:34:32Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/ByteBufHttpData.java", "diffHunk": "@@ -169,11 +181,22 @@ public String toString() {\n \n     @Override\n     public InputStream toInputStream() {\n-        return new ByteBufInputStream(buf.retainedDuplicate(), true);\n+        return new ByteBufInputStream(buf.duplicate(), false);\n     }\n \n     @Override\n-    public ByteBufHttpData withEndOfStream() {\n-        return new ByteBufHttpData(buf, true);\n+    public ByteBufHttpData withEndOfStream(boolean endOfStream) {\n+        if (endOfStream == this.endOfStream) {\n+            return this;\n+        }\n+        return new ByteBufHttpData(buf, endOfStream);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2619fd2799e0bfa44d4d85023573ee9aac87c4e7"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODMyMDgw", "url": "https://github.com/line/armeria/pull/2448#pullrequestreview-426832080", "createdAt": "2020-06-09T06:45:49Z", "commit": {"oid": "2619fd2799e0bfa44d4d85023573ee9aac87c4e7"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNjo0NTo0OVrOGg66JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNzoxODoxMlrOGg70kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE3Mjc3Mw==", "bodyText": "This opens two extension points, which can be confusing. How about keeping only the first one and letting a user wrap the response?", "url": "https://github.com/line/armeria/pull/2448#discussion_r437172773", "createdAt": "2020-06-09T06:45:49Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/unsafe/SimplePooledDecoratingHttpClient.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.unsafe;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.client.HttpClient;\n+import com.linecorp.armeria.client.SimpleDecoratingHttpClient;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.unsafe.PooledHttpData;\n+import com.linecorp.armeria.common.unsafe.PooledHttpRequest;\n+import com.linecorp.armeria.common.unsafe.PooledHttpResponse;\n+\n+/**\n+ * Decorates an {@link HttpClient}, ensuring {@link HttpData} are all {@link PooledHttpData}.\n+ */\n+public abstract class SimplePooledDecoratingHttpClient extends SimpleDecoratingHttpClient\n+        implements PooledHttpClient {\n+\n+    /**\n+     * Creates a new instance that decorates the specified {@link HttpClient}.\n+     */\n+    protected SimplePooledDecoratingHttpClient(HttpClient delegate) {\n+        super(PooledHttpClient.of(delegate));\n+    }\n+\n+    @Override\n+    public final HttpResponse execute(ClientRequestContext ctx, HttpRequest req) throws Exception {\n+        return execute(delegate(), ctx, PooledHttpRequest.of(req));\n+    }\n+\n+    @Override\n+    public PooledHttpResponse execute(ClientRequestContext ctx, PooledHttpRequest req) throws Exception {\n+        return PooledHttpResponse.of(execute(delegate(), ctx, req));\n+    }\n+\n+    /**\n+     * Execute the {@code req} with the given {@code ctx}.\n+     *\n+     * @see SimpleDecoratingHttpClient#execute(ClientRequestContext, HttpRequest)\n+     */\n+    protected abstract HttpResponse execute(\n+            PooledHttpClient client, ClientRequestContext ctx, PooledHttpRequest req)\n+            throws Exception;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2619fd2799e0bfa44d4d85023573ee9aac87c4e7"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE3MzI3OA==", "bodyText": "Thanks!", "url": "https://github.com/line/armeria/pull/2448#discussion_r437173278", "createdAt": "2020-06-09T06:47:08Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/StreamWriter.java", "diffHunk": "@@ -34,14 +34,14 @@\n  * <h3 id=\"reference-counted\">Life cycle of reference-counted objects</h3>\n  *\n  * <p>When the following methods are given with a {@link ReferenceCounted} object, such as {@link ByteBuf} and\n- * {@link ByteBufHttpData}, or the {@link Supplier} that provides such an object:\n+ * {@link PooledHttpData}, or the {@link Supplier} that provides such an object:\n  *\n  * <ul>\n  *   <li>{@link #tryWrite(Object)}</li>\n  *   <li>{@link #tryWrite(Supplier)}</li>\n  *   <li>{@link #write(Object)}</li>\n  *   <li>{@link #write(Supplier)}</li>\n- *   <li>{@link #close(Object)}</li>\n+ *   <li>{@link #close(Throwable)}</li>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2619fd2799e0bfa44d4d85023573ee9aac87c4e7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE3Mzk2OQ==", "bodyText": "How about following what we did for ClientOption ?", "url": "https://github.com/line/armeria/pull/2448#discussion_r437173969", "createdAt": "2020-06-09T06:48:43Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/SubscriptionOption.java", "diffHunk": "@@ -19,27 +19,22 @@\n import org.reactivestreams.Subscriber;\n import org.reactivestreams.Subscription;\n \n-import io.netty.buffer.ByteBuf;\n-import io.netty.buffer.ByteBufHolder;\n+import com.linecorp.armeria.internal.stream.InternalSubscriptionOption;\n+\n import io.netty.util.concurrent.EventExecutor;\n \n /**\n- * Options used when subscribing to a {@link StreamMessage}.\n+ * Options used when subscribing to a {@link StreamMessage}. This class is sealed to Armeria and can only be\n+ * implemented here.\n  *\n  * @see StreamMessage#subscribe(Subscriber, SubscriptionOption...)\n  * @see StreamMessage#subscribe(Subscriber, EventExecutor, SubscriptionOption...)\n  */\n-public enum SubscriptionOption {\n-\n-    /**\n-     * To receive the pooled {@link ByteBuf} and {@link ByteBufHolder} as is, without making a copy.\n-     * If you don't know what this means, do not specify this when you subscribe the {@link StreamMessage}.\n-     */\n-    WITH_POOLED_OBJECTS,\n+public interface SubscriptionOption {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2619fd2799e0bfa44d4d85023573ee9aac87c4e7"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE3NDU0MQ==", "bodyText": "How about adding some Javadoc about this (i.e. refCnt not increased)?", "url": "https://github.com/line/armeria/pull/2448#discussion_r437174541", "createdAt": "2020-06-09T06:50:06Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/ByteBufHttpData.java", "diffHunk": "@@ -169,11 +181,22 @@ public String toString() {\n \n     @Override\n     public InputStream toInputStream() {\n-        return new ByteBufInputStream(buf.retainedDuplicate(), true);\n+        return new ByteBufInputStream(buf.duplicate(), false);\n     }\n \n     @Override\n-    public ByteBufHttpData withEndOfStream() {\n-        return new ByteBufHttpData(buf, true);\n+    public ByteBufHttpData withEndOfStream(boolean endOfStream) {\n+        if (endOfStream == this.endOfStream) {\n+            return this;\n+        }\n+        return new ByteBufHttpData(buf, endOfStream);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwNDg5NQ=="}, "originalCommit": {"oid": "2619fd2799e0bfa44d4d85023573ee9aac87c4e7"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE3Njk1NA==", "bodyText": "Shouldn't this be subscribeWithPooledObjects?", "url": "https://github.com/line/armeria/pull/2448#discussion_r437176954", "createdAt": "2020-06-09T06:55:32Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/PooledHttpStreamMessage.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.unsafe;\n+\n+import static com.linecorp.armeria.common.unsafe.UnsafeStreamUtil.withPooledObjects;\n+\n+import org.reactivestreams.Subscriber;\n+import org.reactivestreams.Subscription;\n+\n+import com.linecorp.armeria.common.HttpObject;\n+import com.linecorp.armeria.common.stream.AbortedStreamException;\n+import com.linecorp.armeria.common.stream.CancelledSubscriptionException;\n+import com.linecorp.armeria.common.stream.StreamMessage;\n+import com.linecorp.armeria.common.stream.SubscriptionOption;\n+import com.linecorp.armeria.internal.stream.InternalSubscriptionOption;\n+\n+import io.netty.util.concurrent.EventExecutor;\n+\n+/**\n+ * A {@link StreamMessage} of {@link HttpObject} which exposes unsafe APIs for subscribing to pooled objects\n+ * from the stream.\n+ */\n+public interface PooledHttpStreamMessage extends StreamMessage<HttpObject> {\n+\n+    /**\n+     * Requests to start streaming data to the specified {@link Subscriber}. If there is a problem subscribing,\n+     * {@link Subscriber#onError(Throwable)} will be invoked with one of the following exceptions:\n+     * <ul>\n+     *   <li>{@link IllegalStateException} if other {@link Subscriber} subscribed to this stream already.</li>\n+     *   <li>{@link AbortedStreamException} if this stream has been {@linkplain #abort() aborted}.</li>\n+     *   <li>{@link CancelledSubscriptionException} if this stream has been\n+     *       {@linkplain Subscription#cancel() cancelled} and {@link SubscriptionOption#NOTIFY_CANCELLATION} is\n+     *       specified when subscribed.</li>\n+     *   <li>Other exceptions that occurred due to an error while retrieving the elements.</li>\n+     * </ul>\n+     */\n+    default void subscribeWithPooledObjects(Subscriber<? super HttpObject> subscriber) {\n+        subscribeWithPooledObjects(subscriber, defaultSubscriberExecutor());\n+    }\n+\n+    /**\n+     * Requests to start streaming data to the specified {@link Subscriber}. If there is a problem subscribing,\n+     * {@link Subscriber#onError(Throwable)} will be invoked with one of the following exceptions:\n+     * <ul>\n+     *   <li>{@link IllegalStateException} if other {@link Subscriber} subscribed to this stream already.</li>\n+     *   <li>{@link AbortedStreamException} if this stream has been {@linkplain #abort() aborted}.</li>\n+     *   <li>{@link CancelledSubscriptionException} if this stream has been\n+     *       {@linkplain Subscription#cancel() cancelled} and {@link SubscriptionOption#NOTIFY_CANCELLATION} is\n+     *       specified when subscribed.</li>\n+     *   <li>Other exceptions that occurred due to an error while retrieving the elements.</li>\n+     * </ul>\n+     *\n+     * @param options {@link SubscriptionOption}s to subscribe with\n+     */\n+    default void subscribeWithPooledObjects(\n+            Subscriber<? super HttpObject> subscriber, SubscriptionOption... options) {\n+        subscribeWithPooledObjects(subscriber, defaultSubscriberExecutor(), options);\n+    }\n+\n+    /**\n+     * Requests to start streaming data to the specified {@link Subscriber}. If there is a problem subscribing,\n+     * {@link Subscriber#onError(Throwable)} will be invoked with one of the following exceptions:\n+     * <ul>\n+     *   <li>{@link IllegalStateException} if other {@link Subscriber} subscribed to this stream already.</li>\n+     *   <li>{@link AbortedStreamException} if this stream has been {@linkplain #abort() aborted}.</li>\n+     *   <li>{@link CancelledSubscriptionException} if this stream has been\n+     *       {@linkplain Subscription#cancel() cancelled} and {@link SubscriptionOption#NOTIFY_CANCELLATION} is\n+     *       specified when subscribed.</li>\n+     *   <li>Other exceptions that occurred due to an error while retrieving the elements.</li>\n+     * </ul>\n+     *\n+     * @param executor the executor to subscribe\n+     */\n+    default void subscribeWithPooledObjects(Subscriber<? super HttpObject> subscriber, EventExecutor executor) {\n+        subscribe(subscriber, executor, InternalSubscriptionOption.WITH_POOLED_OBJECTS);\n+    }\n+\n+    /**\n+     * Requests to start streaming data to the specified {@link Subscriber}. If there is a problem subscribing,\n+     * {@link Subscriber#onError(Throwable)} will be invoked with one of the following exceptions:\n+     * <ul>\n+     *   <li>{@link IllegalStateException} if other {@link Subscriber} subscribed to this stream already.</li>\n+     *   <li>{@link AbortedStreamException} if this stream has been {@linkplain #abort() aborted}.</li>\n+     *   <li>{@link CancelledSubscriptionException} if this stream has been\n+     *       {@linkplain Subscription#cancel() cancelled} and {@link SubscriptionOption#NOTIFY_CANCELLATION} is\n+     *       specified when subscribed.</li>\n+     *   <li>Other exceptions that occurred due to an error while retrieving the elements.</li>\n+     * </ul>\n+     *\n+     * @param executor the executor to subscribe\n+     * @param options {@link SubscriptionOption}s to subscribe with\n+     */\n+    default void subscribeWithPooledObjects(\n+            Subscriber<? super HttpObject> subscriber, EventExecutor executor, SubscriptionOption... options) {\n+        subscribe(subscriber, executor, withPooledObjects(options));\n+    }\n+\n+    /**\n+     * Requests to start streaming data to the specified {@link Subscriber} without pooled objects. When\n+     * operating on {@link PooledHttpStreamMessage} this should be avoided.\n+     *\n+     * @deprecated Use {@link #subscribeWithPooledObjects(Subscriber)}.\n+     */\n+    @Override\n+    @Deprecated\n+    default void subscribe(Subscriber<? super HttpObject> subscriber) {\n+        StreamMessage.super.subscribe(subscriber);\n+    }\n+\n+    /**\n+     * Requests to start streaming data to the specified {@link Subscriber} without pooled objects. When\n+     * operating on {@link PooledHttpStreamMessage} this should be avoided.\n+     *\n+     * @deprecated Use {@link #subscribe(Subscriber, SubscriptionOption...)}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2619fd2799e0bfa44d4d85023573ee9aac87c4e7"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE3OTMzNg==", "bodyText": "Ditto - two extension points that may be confusing", "url": "https://github.com/line/armeria/pull/2448#discussion_r437179336", "createdAt": "2020-06-09T07:00:39Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/unsafe/SimplePooledDecoratingHttpService.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.unsafe;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.unsafe.PooledHttpData;\n+import com.linecorp.armeria.common.unsafe.PooledHttpRequest;\n+import com.linecorp.armeria.common.unsafe.PooledHttpResponse;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+import com.linecorp.armeria.server.SimpleDecoratingHttpService;\n+\n+/**\n+ * An {@link HttpService} that decorates another {@link HttpService} publishing {@link PooledHttpData}.\n+ *\n+ * @see SimpleDecoratingHttpService\n+ * @see PooledHttpData\n+ */\n+public abstract class SimplePooledDecoratingHttpService extends SimpleDecoratingHttpService\n+        implements PooledHttpService {\n+\n+    /**\n+     * Creates a new instance that decorates the specified {@link HttpService}.\n+     */\n+    protected SimplePooledDecoratingHttpService(HttpService delegate) {\n+        super(PooledHttpService.of(delegate));\n+    }\n+\n+    @Override\n+    public final HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) throws Exception {\n+        return serve(ctx, PooledHttpRequest.of(req));\n+    }\n+\n+    @Override\n+    public PooledHttpResponse serve(ServiceRequestContext ctx, PooledHttpRequest req) throws Exception {\n+        return PooledHttpResponse.of(serve(delegate(), ctx, req));\n+    }\n+\n+    /**\n+     * Execute the {@code req} with the given {@code ctx}.\n+     *\n+     * @see SimpleDecoratingHttpService#serve(ServiceRequestContext, HttpRequest)\n+     */\n+    protected abstract HttpResponse serve(\n+            PooledHttpService delegate, ServiceRequestContext ctx, PooledHttpRequest req)\n+            throws Exception;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2619fd2799e0bfa44d4d85023573ee9aac87c4e7"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE4NjUxNQ==", "bodyText": "This looks funny, just sayin' \ud83d\ude06", "url": "https://github.com/line/armeria/pull/2448#discussion_r437186515", "createdAt": "2020-06-09T07:15:46Z", "author": {"login": "trustin"}, "path": "thrift/src/main/java/com/linecorp/armeria/internal/client/thrift/THttpClientDelegate.java", "diffHunk": "@@ -139,21 +141,24 @@ public RpcResponse execute(ClientRequestContext ctx, RpcRequest call) throws Exc\n                                   .authority(endpoint != null ? endpoint.authority() : \"UNKNOWN\")\n                                   .contentType(mediaType)\n                                   .build(),\n-                    new ByteBufHttpData(buf, true));\n+                    PooledHttpData.wrap(buf).withEndOfStream());\n \n             ctx.updateRequest(httpReq);\n             ctx.logBuilder().deferResponseContent();\n \n-            final CompletableFuture<AggregatedHttpResponse> future =\n-                    delegate().execute(ctx, httpReq).aggregateWithPooledObjects(ctx.eventLoop(), ctx.alloc());\n+            assert delegate() instanceof PooledHttpClient;\n+            final PooledHttpClient client = delegate();\n+            final CompletableFuture<PooledAggregatedHttpResponse> future =\n+                    client.execute(ctx, PooledHttpRequest.of(httpReq))\n+                          .aggregateWithPooledObjects(ctx.eventLoop(), ctx.alloc());\n \n             future.handle((res, cause) -> {\n                 if (cause != null) {\n                     handlePreDecodeException(ctx, reply, func, Exceptions.peel(cause));\n                     return null;\n                 }\n \n-                try {\n+                try (SafeCloseable unused = res) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2619fd2799e0bfa44d4d85023573ee9aac87c4e7"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE4NzczMQ==", "bodyText": "This makes me wonder which is better - req.toPooled() vs. PooledHttpRequest.of(req). Should we make our users mention the type explicitly just because it's an advanced API? \ud83e\udd14", "url": "https://github.com/line/armeria/pull/2448#discussion_r437187731", "createdAt": "2020-06-09T07:18:12Z", "author": {"login": "trustin"}, "path": "thrift/src/main/java/com/linecorp/armeria/server/thrift/THttpService.java", "diffHunk": "@@ -352,20 +353,20 @@ public HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) throws Exc\n         final HttpResponse res = HttpResponse.from(responseFuture);\n         ctx.logBuilder().serializationFormat(serializationFormat);\n         ctx.logBuilder().deferRequestContent();\n-        req.aggregateWithPooledObjects(ctx.eventLoop(), ctx.alloc()).handle((aReq, cause) -> {\n-            if (cause != null) {\n-                final HttpResponse errorRes;\n-                if (ctx.config().verboseResponses()) {\n-                    errorRes = HttpResponse.of(HttpStatus.INTERNAL_SERVER_ERROR,\n-                                               MediaType.PLAIN_TEXT_UTF_8,\n-                                               Exceptions.traceText(cause));\n-                } else {\n-                    errorRes = HttpResponse.of(HttpStatus.INTERNAL_SERVER_ERROR);\n-                }\n-                responseFuture.complete(errorRes);\n-                return null;\n-            }\n-\n+        PooledHttpRequest.of(req).aggregateWithPooledObjects(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2619fd2799e0bfa44d4d85023573ee9aac87c4e7"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4232c3c9798ff552275151d155b0897cfdd61c53", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/4232c3c9798ff552275151d155b0897cfdd61c53", "committedDate": "2020-06-13T07:51:19Z", "message": "Cleanups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d967f8b0b21cc6226f9405474f7518d5794e6d4", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/6d967f8b0b21cc6226f9405474f7518d5794e6d4", "committedDate": "2020-06-13T07:51:32Z", "message": "Merge branch 'pooled-web-client' of github.com:anuraaga/armeria into pooled-web-client"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c810fcee73e26e30517dbb51728fbdaaf5b91d2", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/9c810fcee73e26e30517dbb51728fbdaaf5b91d2", "committedDate": "2020-06-13T07:54:48Z", "message": "Only one extension point in HttpService too"}, "afterCommit": {"oid": "52eb8c0ee51fa1e39525201d44bac6b61d770eed", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/52eb8c0ee51fa1e39525201d44bac6b61d770eed", "committedDate": "2020-06-13T07:57:10Z", "message": "Only one extension point in HttpService too"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/b68f514f6b46fcc2b3a4e6dffd082130687253aa", "committedDate": "2020-06-13T08:00:05Z", "message": "Only one extension point in HttpService too"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52eb8c0ee51fa1e39525201d44bac6b61d770eed", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/52eb8c0ee51fa1e39525201d44bac6b61d770eed", "committedDate": "2020-06-13T07:57:10Z", "message": "Only one extension point in HttpService too"}, "afterCommit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/b68f514f6b46fcc2b3a4e6dffd082130687253aa", "committedDate": "2020-06-13T08:00:05Z", "message": "Only one extension point in HttpService too"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTAwMjgz", "url": "https://github.com/line/armeria/pull/2448#pullrequestreview-432100283", "createdAt": "2020-06-17T06:41:53Z", "commit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjo0MTo1M1rOGk3siQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjo0MTo1M1rOGk3siQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMxNDQ0MQ==", "bodyText": "Could you explain this change? retainedDuplicate() generates less garbage.", "url": "https://github.com/line/armeria/pull/2448#discussion_r441314441", "createdAt": "2020-06-17T06:41:53Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/ByteBufHttpData.java", "diffHunk": "@@ -169,11 +181,22 @@ public String toString() {\n \n     @Override\n     public InputStream toInputStream() {\n-        return new ByteBufInputStream(buf.retainedDuplicate(), true);\n+        return new ByteBufInputStream(buf.duplicate(), false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTAwNTUx", "url": "https://github.com/line/armeria/pull/2448#pullrequestreview-432100551", "createdAt": "2020-06-17T06:42:22Z", "commit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyOTg1NDEx", "url": "https://github.com/line/armeria/pull/2448#pullrequestreview-432985411", "createdAt": "2020-06-18T06:48:42Z", "commit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNjo0ODo0MlrOGlhwfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwNzozMDoyNlrOGli-hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAwMzU4Mg==", "bodyText": "Shouldn't we do something\nassert as(PooledHttpClient.class) == null;?", "url": "https://github.com/line/armeria/pull/2448#discussion_r442003582", "createdAt": "2020-06-18T06:48:42Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/unsafe/DefaultPooledHttpClient.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.unsafe;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.client.HttpClient;\n+import com.linecorp.armeria.common.unsafe.PooledHttpRequest;\n+import com.linecorp.armeria.common.unsafe.PooledHttpResponse;\n+import com.linecorp.armeria.common.util.AbstractUnwrappable;\n+\n+final class DefaultPooledHttpClient extends AbstractUnwrappable<HttpClient> implements PooledHttpClient {\n+\n+    DefaultPooledHttpClient(HttpClient delegate) {\n+        super(delegate);\n+    }\n+\n+    @Override\n+    public PooledHttpResponse execute(ClientRequestContext ctx, PooledHttpRequest req) throws Exception {\n+        // Always a wrapped non-pooled client, make sure it gets a normal request.\n+        assert !(delegate() instanceof PooledHttpClient);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTYwODg1MA=="}, "originalCommit": {"oid": "37069c746ed4b49c0054214a67b43b2f7fb34810"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAwOTA5Ng==", "bodyText": "question: Shoudln't it better to make this return PooledHttpResponse?", "url": "https://github.com/line/armeria/pull/2448#discussion_r442009096", "createdAt": "2020-06-18T07:00:46Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/unsafe/SimplePooledDecoratingHttpClient.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.unsafe;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.client.HttpClient;\n+import com.linecorp.armeria.client.SimpleDecoratingHttpClient;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.unsafe.PooledHttpData;\n+import com.linecorp.armeria.common.unsafe.PooledHttpRequest;\n+import com.linecorp.armeria.common.unsafe.PooledHttpResponse;\n+\n+/**\n+ * Decorates an {@link HttpClient}, ensuring {@link HttpData} are all {@link PooledHttpData}.\n+ */\n+public abstract class SimplePooledDecoratingHttpClient extends SimpleDecoratingHttpClient\n+        implements PooledHttpClient {\n+\n+    /**\n+     * Creates a new instance that decorates the specified {@link HttpClient}.\n+     */\n+    protected SimplePooledDecoratingHttpClient(HttpClient delegate) {\n+        super(PooledHttpClient.of(delegate));\n+    }\n+\n+    @Override\n+    public final HttpResponse execute(ClientRequestContext ctx, HttpRequest req) throws Exception {\n+        return execute(delegate(), ctx, PooledHttpRequest.of(req));\n+    }\n+\n+    @Override\n+    public final PooledHttpResponse execute(ClientRequestContext ctx, PooledHttpRequest req) throws Exception {\n+        return PooledHttpResponse.of(execute(delegate(), ctx, req));\n+    }\n+\n+    /**\n+     * Execute the {@code req} with the given {@code ctx}.\n+     *\n+     * @see SimpleDecoratingHttpClient#execute(ClientRequestContext, HttpRequest)\n+     */\n+    protected abstract HttpResponse execute(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAxNzkxNw==", "bodyText": "nit: #close} -> #close()}", "url": "https://github.com/line/armeria/pull/2448#discussion_r442017917", "createdAt": "2020-06-18T07:19:30Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/PooledHttpData.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.unsafe;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import com.linecorp.armeria.client.unsafe.PooledWebClient;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufHolder;\n+import io.netty.buffer.Unpooled;\n+\n+/**\n+ * An {@link HttpData} that is backed by a pooled {@link ByteBuf} for optimizing certain internal use cases. Not\n+ * for general use.\n+ *\n+ * <h3>What are pooled buffers?</h3>\n+ *\n+ * <p>The buffer backing a {@link PooledHttpData} is a pooled buffer - this means that it does not use normal\n+ * Java garbage collection, and instead uses manual memory management using a reference count, similar to\n+ * some constructs in languages like C++. Manual memory management is more fragile and not idiomatic in Java -\n+ * you should only use this class in performance-sensitive situations and after being ready to deal with these\n+ * very hard-to-debug issues.\n+ *\n+ * <p>You may interact with {@link PooledHttpData} when using objects that return pooled objects, such as\n+ * {@link PooledWebClient}. If you don't use such objects, you will never see a {@link PooledHttpData} and don't\n+ * need to read further.\n+ *\n+ * <h3>Impact of pooled buffers</h3>\n+ *\n+ * <p>Any time you receive a {@link PooledHttpData} it will have a single reference that must be released -\n+ * failure to release the reference will result in a memory leak and poor performance. You must make sure to do\n+ * this by calling {@link PooledHttpData#close()}, usually in a try-with-resources structure to avoid side\n+ * effects.\n+ *\n+ * <p>For example, <pre>{@code\n+ *\n+ * HttpResponse response = client.get(\"/\");\n+ * response.aggregateWithPooledObjects(ctx.alloc(), ctx.executor())\n+ *     .thenApply(aggResp -> {\n+ *         // try-with-resources here ensures the content is released if it is a ByteBufHttpData, or otherwise\n+ *         // is a no-op if it is not.\n+ *         try (PooledHttpData content = aggResp.content()) {\n+ *             if (!aggResp.status().equals(HttpStatus.OK)) {\n+ *                 throw new IllegalStateException(\"Bad response\");\n+ *             }\n+ *             try {\n+ *                 return OBJECT_MAPPER.readValue(content.toInputStream(), Foo.class);\n+ *             } catch (IOException e) {\n+ *                 throw new IllegalArgumentException(\"Bad JSON: \" + content.toStringUtf8());\n+ *             }\n+ *         }\n+ *     });\n+ *\n+ * }</pre>\n+ *\n+ * <p>In this example, it is the initial {@code try (HttpData content = ...} that ensures the data is released.\n+ * Calls to methods on {@link HttpData} will all work and can be called any number of times within this block.\n+ * If called after the block, or a manual call to {@link PooledHttpData#close}, these methods will fail or", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAxODA4MA==", "bodyText": "nit: HttpData -> PooledHttpData", "url": "https://github.com/line/armeria/pull/2448#discussion_r442018080", "createdAt": "2020-06-18T07:19:49Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/PooledHttpData.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.unsafe;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import com.linecorp.armeria.client.unsafe.PooledWebClient;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufHolder;\n+import io.netty.buffer.Unpooled;\n+\n+/**\n+ * An {@link HttpData} that is backed by a pooled {@link ByteBuf} for optimizing certain internal use cases. Not\n+ * for general use.\n+ *\n+ * <h3>What are pooled buffers?</h3>\n+ *\n+ * <p>The buffer backing a {@link PooledHttpData} is a pooled buffer - this means that it does not use normal\n+ * Java garbage collection, and instead uses manual memory management using a reference count, similar to\n+ * some constructs in languages like C++. Manual memory management is more fragile and not idiomatic in Java -\n+ * you should only use this class in performance-sensitive situations and after being ready to deal with these\n+ * very hard-to-debug issues.\n+ *\n+ * <p>You may interact with {@link PooledHttpData} when using objects that return pooled objects, such as\n+ * {@link PooledWebClient}. If you don't use such objects, you will never see a {@link PooledHttpData} and don't\n+ * need to read further.\n+ *\n+ * <h3>Impact of pooled buffers</h3>\n+ *\n+ * <p>Any time you receive a {@link PooledHttpData} it will have a single reference that must be released -\n+ * failure to release the reference will result in a memory leak and poor performance. You must make sure to do\n+ * this by calling {@link PooledHttpData#close()}, usually in a try-with-resources structure to avoid side\n+ * effects.\n+ *\n+ * <p>For example, <pre>{@code\n+ *\n+ * HttpResponse response = client.get(\"/\");\n+ * response.aggregateWithPooledObjects(ctx.alloc(), ctx.executor())\n+ *     .thenApply(aggResp -> {\n+ *         // try-with-resources here ensures the content is released if it is a ByteBufHttpData, or otherwise\n+ *         // is a no-op if it is not.\n+ *         try (PooledHttpData content = aggResp.content()) {\n+ *             if (!aggResp.status().equals(HttpStatus.OK)) {\n+ *                 throw new IllegalStateException(\"Bad response\");\n+ *             }\n+ *             try {\n+ *                 return OBJECT_MAPPER.readValue(content.toInputStream(), Foo.class);\n+ *             } catch (IOException e) {\n+ *                 throw new IllegalArgumentException(\"Bad JSON: \" + content.toStringUtf8());\n+ *             }\n+ *         }\n+ *     });\n+ *\n+ * }</pre>\n+ *\n+ * <p>In this example, it is the initial {@code try (HttpData content = ...} that ensures the data is released.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAyMTIxNQ==", "bodyText": "nit: on this request", "url": "https://github.com/line/armeria/pull/2448#discussion_r442021215", "createdAt": "2020-06-18T07:25:56Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/PooledAggregatedHttpRequest.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.unsafe;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+/**\n+ * An {@link AggregatedHttpRequest} using pooled buffers for the content. Make sure to call\n+ * {@link AutoCloseable#close()} on this response or the {@code content} to release pooled resources.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjAyMzU1OA==", "bodyText": "nit: response -> request", "url": "https://github.com/line/armeria/pull/2448#discussion_r442023558", "createdAt": "2020-06-18T07:30:26Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/PooledHttpRequest.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.unsafe;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.Request;\n+import com.linecorp.armeria.common.util.EventLoopCheckingFuture;\n+import com.linecorp.armeria.internal.common.HttpRequestAggregator;\n+\n+import io.netty.buffer.ByteBufAllocator;\n+import io.netty.buffer.PooledByteBufAllocator;\n+import io.netty.util.concurrent.EventExecutor;\n+\n+/**\n+ * A streamed HTTP/2 {@link Request} which returns pooled buffers.\n+ */\n+public interface PooledHttpRequest extends HttpRequest, PooledHttpStreamMessage {\n+\n+    /**\n+     * Returns a {@link PooledHttpRequest} that wraps the {@link HttpRequest}, ensuring all published data\n+     * is a {@link PooledHttpData}.\n+     */\n+    static PooledHttpRequest of(HttpRequest delegate) {\n+        requireNonNull(delegate, \"delegate\");\n+        if (delegate instanceof PooledHttpRequest) {\n+            return (PooledHttpRequest) delegate;\n+        }\n+        return new DefaultPooledHttpRequest(delegate);\n+    }\n+\n+    /**\n+     * Aggregates this request. The returned {@link CompletableFuture} will be notified when the content and\n+     * the trailers of the response are received fully.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDQwMDQw", "url": "https://github.com/line/armeria/pull/2448#pullrequestreview-433040040", "createdAt": "2020-06-18T08:09:34Z", "commit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODowOTozNVrOGlkUHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwOTo0ODozN1rOGln_HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA0NTQ3MQ==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Execute the {@code req} with the given {@code ctx}.\n          \n          \n            \n                 * Executes the {@code req} with the given {@code ctx}.", "url": "https://github.com/line/armeria/pull/2448#discussion_r442045471", "createdAt": "2020-06-18T08:09:35Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/unsafe/SimplePooledDecoratingHttpClient.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.client.unsafe;\n+\n+import com.linecorp.armeria.client.ClientRequestContext;\n+import com.linecorp.armeria.client.HttpClient;\n+import com.linecorp.armeria.client.SimpleDecoratingHttpClient;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.unsafe.PooledHttpData;\n+import com.linecorp.armeria.common.unsafe.PooledHttpRequest;\n+import com.linecorp.armeria.common.unsafe.PooledHttpResponse;\n+\n+/**\n+ * Decorates an {@link HttpClient}, ensuring {@link HttpData} are all {@link PooledHttpData}.\n+ */\n+public abstract class SimplePooledDecoratingHttpClient extends SimpleDecoratingHttpClient\n+        implements PooledHttpClient {\n+\n+    /**\n+     * Creates a new instance that decorates the specified {@link HttpClient}.\n+     */\n+    protected SimplePooledDecoratingHttpClient(HttpClient delegate) {\n+        super(PooledHttpClient.of(delegate));\n+    }\n+\n+    @Override\n+    public final HttpResponse execute(ClientRequestContext ctx, HttpRequest req) throws Exception {\n+        return execute(delegate(), ctx, PooledHttpRequest.of(req));\n+    }\n+\n+    @Override\n+    public final PooledHttpResponse execute(ClientRequestContext ctx, PooledHttpRequest req) throws Exception {\n+        return PooledHttpResponse.of(execute(delegate(), ctx, req));\n+    }\n+\n+    /**\n+     * Execute the {@code req} with the given {@code ctx}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjEwNTYyOQ==", "bodyText": "nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Execute the {@code req} with the given {@code ctx}.\n          \n          \n            \n                 * Executes the {@code req} with the given {@code ctx}.", "url": "https://github.com/line/armeria/pull/2448#discussion_r442105629", "createdAt": "2020-06-18T09:48:37Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/unsafe/SimplePooledDecoratingHttpService.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.unsafe;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.unsafe.PooledHttpData;\n+import com.linecorp.armeria.common.unsafe.PooledHttpRequest;\n+import com.linecorp.armeria.common.unsafe.PooledHttpResponse;\n+import com.linecorp.armeria.server.HttpService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+import com.linecorp.armeria.server.SimpleDecoratingHttpService;\n+\n+/**\n+ * An {@link HttpService} that decorates another {@link HttpService} publishing {@link PooledHttpData}.\n+ *\n+ * @see SimpleDecoratingHttpService\n+ * @see PooledHttpData\n+ */\n+public abstract class SimplePooledDecoratingHttpService extends SimpleDecoratingHttpService\n+        implements PooledHttpService {\n+\n+    /**\n+     * Creates a new instance that decorates the specified {@link HttpService}.\n+     */\n+    protected SimplePooledDecoratingHttpService(HttpService delegate) {\n+        super(PooledHttpService.of(delegate));\n+    }\n+\n+    @Override\n+    public final HttpResponse serve(ServiceRequestContext ctx, HttpRequest req) throws Exception {\n+        return serve(ctx, PooledHttpRequest.of(req));\n+    }\n+\n+    @Override\n+    public final PooledHttpResponse serve(ServiceRequestContext ctx, PooledHttpRequest req) throws Exception {\n+        return PooledHttpResponse.of(serve(delegate(), ctx, req));\n+    }\n+\n+    /**\n+     * Execute the {@code req} with the given {@code ctx}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b68f514f6b46fcc2b3a4e6dffd082130687253aa"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97276d47a70c998833a0d0cbec85a1fd2fd73b5c", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/97276d47a70c998833a0d0cbec85a1fd2fd73b5c", "committedDate": "2020-06-19T05:15:32Z", "message": "Cleanups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06b92f07eca9555ce0007c40f7a6a9a23dbfc9f1", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/06b92f07eca9555ce0007c40f7a6a9a23dbfc9f1", "committedDate": "2020-06-19T07:26:57Z", "message": "Merge branch 'master' of github.com:line/armeria into pooled-web-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2da74a31b95f4fcc6b914617b561a7d6e566881e", "author": {"user": {"login": "anuraaga", "name": "Anuraag Agrawal"}}, "url": "https://github.com/line/armeria/commit/2da74a31b95f4fcc6b914617b561a7d6e566881e", "committedDate": "2020-06-19T07:51:10Z", "message": "Allow repeating eventExecutorAndAlloc test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7f3ffc212494a977561606e95a15b94856a587d", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/b7f3ffc212494a977561606e95a15b94856a587d", "committedDate": "2020-06-19T12:44:35Z", "message": "Merge branch 'master' into pooled-web-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "235c777a0402f3ebe7321a147849775cd6ca9917", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/235c777a0402f3ebe7321a147849775cd6ca9917", "committedDate": "2020-06-19T12:58:19Z", "message": "Fix compilation errors and deprecation warnings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ef5bc1290b9f6e51c2cbb8f1519a89511d98eaa", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/4ef5bc1290b9f6e51c2cbb8f1519a89511d98eaa", "committedDate": "2020-06-19T13:35:22Z", "message": "Do not check the event loop thread in the test\n\n.. because the future might be complete already and thus the callback\nmight be invoked from the main thread rather than an event loop thread."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjUyMjQw", "url": "https://github.com/line/armeria/pull/2448#pullrequestreview-439652240", "createdAt": "2020-06-30T03:56:03Z", "commit": {"oid": "4ef5bc1290b9f6e51c2cbb8f1519a89511d98eaa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMzo1NjowM1rOGqqvCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwMzo1NjowM1rOGqqvCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzM5MzU0Ng==", "bodyText": "this line drifted I think", "url": "https://github.com/line/armeria/pull/2448#discussion_r447393546", "createdAt": "2020-06-30T03:56:03Z", "author": {"login": "codefromthecrypt"}, "path": "core/src/main/java/com/linecorp/armeria/common/unsafe/PooledHttpData.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.unsafe;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import com.linecorp.armeria.client.unsafe.PooledWebClient;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.util.SafeCloseable;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufHolder;\n+import io.netty.buffer.Unpooled;\n+\n+/**\n+ * An {@link HttpData} that is backed by a pooled {@link ByteBuf} for optimizing certain internal use cases. Not\n+ * for general use.\n+ *\n+ * <h3>What are pooled buffers?</h3>\n+ *\n+ * <p>The buffer backing a {@link PooledHttpData} is a pooled buffer - this means that it does not use normal\n+ * Java garbage collection, and instead uses manual memory management using a reference count, similar to\n+ * some constructs in languages like C++. Manual memory management is more fragile and not idiomatic in Java -\n+ * you should only use this class in performance-sensitive situations and after being ready to deal with these\n+ * very hard-to-debug issues.\n+ *\n+ * <p>You may interact with {@link PooledHttpData} when using objects that return pooled objects, such as\n+ * {@link PooledWebClient}. If you don't use such objects, you will never see a {@link PooledHttpData} and don't\n+ * need to read further.\n+ *\n+ * <h3>Impact of pooled buffers</h3>\n+ *\n+ * <p>Any time you receive a {@link PooledHttpData} it will have a single reference that must be released -\n+ * failure to release the reference will result in a memory leak and poor performance. You must make sure to do\n+ * this by calling {@link PooledHttpData#close()}, usually in a try-with-resources structure to avoid side\n+ * effects.\n+ *\n+ * <p>For example, <pre>{@code\n+ *\n+ * HttpResponse response = client.get(\"/\");\n+ * response.aggregateWithPooledObjects(ctx.alloc(), ctx.executor())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ef5bc1290b9f6e51c2cbb8f1519a89511d98eaa"}, "originalPosition": 55}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 952, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}