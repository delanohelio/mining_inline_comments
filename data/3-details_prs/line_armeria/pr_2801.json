{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MDMzODgw", "number": 2801, "title": "Complete session after SessionProtocol and ProxyConnectionEvent are t\u2026", "bodyText": "\u2026riggered\nMotivation:\nWhen we use the client-side proxy, we use the channel as soon as it's established to the proxy.\nHowever, the writing to the channel is pending until the proxy connects to the final destination.\nThis causes a problem especially the distance is far away between the proxy and the final destination because\nit triggers WriteTimeoutException.\nModification:\n\nComplete sesessin after SessionProtocol event and ProxyConnectionEvent are triggered.\n\nResult:\n\nClose #2606\nYou no longer see WriteTimeoutException due to the pending write when using the client-side proxy.", "createdAt": "2020-06-16T07:43:21Z", "url": "https://github.com/line/armeria/pull/2801", "merged": true, "mergeCommit": {"oid": "f5e2a558ad1f5317d00d835ba03df0d5af9e0f7c"}, "closed": true, "closedAt": "2020-06-17T08:21:04Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrwUJ6gH2gAyNDM1MDMzODgwOjBjNzAzZTNiMzRlZGI3YmIwZTYwYTBlN2E2ODQ5ZTZjMzZkMTk1Yzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsEZ96AH2gAyNDM1MDMzODgwOmE0NDQ4ODhjOWI0OThjYTgyOTUzMTFkZDljNzBkMzMxOWFhN2E0MTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0c703e3b34edb7bb0e60a0e7a6849e6c36d195c8", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/0c703e3b34edb7bb0e60a0e7a6849e6c36d195c8", "committedDate": "2020-06-16T07:42:17Z", "message": "Complete session after SessionProtocol and ProxyConnectionEvent are triggered\nMotivation:\nWhen we use client-side proxy, we use the channel as soon as it's established to the proxy.\nHowever, the writing to the channel is pending until the proxy connects to the final destination.\nThis causes a problem especially the distance is far away between the proxy and the final destionation because\nit triggers `WriteTimeoutException`.\n\nModification:\n- Complete sesessin after `SessionProtocol` event and `ProxyConnectionEvent` are triggered.\n\nResult:\n- Close #2606\n- You no longer see `WriteTimeoutException` due to the pending write when using client-side proxy."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMzIxNjc4", "url": "https://github.com/line/armeria/pull/2801#pullrequestreview-431321678", "createdAt": "2020-06-16T09:25:29Z", "commit": {"oid": "0c703e3b34edb7bb0e60a0e7a6849e6c36d195c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOToyNTozMFrOGkS9ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwOToyNTozMFrOGkS9ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxMjU3MQ==", "bodyText": "Could you add some comments about what this sentence does? e.g. why we block the event loop", "url": "https://github.com/line/armeria/pull/2801#discussion_r440712571", "createdAt": "2020-06-16T09:25:30Z", "author": {"login": "trustin"}, "path": "core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java", "diffHunk": "@@ -546,6 +544,17 @@ protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest msg) thro\n         }\n     }\n \n+    private static final class SleepHandler extends ChannelInboundHandlerAdapter {\n+\n+        @Override\n+        public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exception {\n+            if (evt instanceof ProxySuccessEvent) {\n+                Thread.sleep(Flags.defaultWriteTimeoutMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c703e3b34edb7bb0e60a0e7a6849e6c36d195c8"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be53ca72ce9a9b08f470f4c24361fe0869d777b0", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/be53ca72ce9a9b08f470f4c24361fe0869d777b0", "committedDate": "2020-06-17T06:18:05Z", "message": "Address the comment by @trustin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDg5MDM4", "url": "https://github.com/line/armeria/pull/2801#pullrequestreview-432089038", "createdAt": "2020-06-17T06:19:25Z", "commit": {"oid": "0c703e3b34edb7bb0e60a0e7a6849e6c36d195c8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjoxOToyNlrOGk3Iqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjoxOToyNlrOGk3Iqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwNTI1OQ==", "bodyText": "nit: Not strong here \ud83d\ude09\nuseProxyConnection = proxyConfig.proxyType() != ProxyType.DIRECT;", "url": "https://github.com/line/armeria/pull/2801#discussion_r441305259", "createdAt": "2020-06-17T06:19:26Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java", "diffHunk": "@@ -120,6 +123,16 @@\n         this.useHttp1Pipelining = useHttp1Pipelining;\n         this.idleTimeoutMillis = idleTimeoutMillis;\n         this.pingIntervalMillis = pingIntervalMillis;\n+\n+        switch (proxyConfig.proxyType()) {\n+            case SOCKS4:\n+            case SOCKS5:\n+            case CONNECT:\n+                useProxyConnection = true;\n+                break;\n+            default:\n+                useProxyConnection = false;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c703e3b34edb7bb0e60a0e7a6849e6c36d195c8"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDg5MTU3", "url": "https://github.com/line/armeria/pull/2801#pullrequestreview-432089157", "createdAt": "2020-06-17T06:19:41Z", "commit": {"oid": "0c703e3b34edb7bb0e60a0e7a6849e6c36d195c8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDg5NjUw", "url": "https://github.com/line/armeria/pull/2801#pullrequestreview-432089650", "createdAt": "2020-06-17T06:20:41Z", "commit": {"oid": "be53ca72ce9a9b08f470f4c24361fe0869d777b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1efba52df8bf16508761cc630259f7dd0798cd9a", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/1efba52df8bf16508761cc630259f7dd0798cd9a", "committedDate": "2020-06-17T06:21:17Z", "message": "Add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0d163829c2cf000456ba04ce450bbb4f2714446", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/d0d163829c2cf000456ba04ce450bbb4f2714446", "committedDate": "2020-06-17T06:43:00Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a444888c9b498ca8295311dd9c70d3319aa7a413", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/a444888c9b498ca8295311dd9c70d3319aa7a413", "committedDate": "2020-06-17T07:06:44Z", "message": "Throw error on default"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 214, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}