{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MTE2NjU5", "number": 2718, "title": "Specific headers such as :status, grpc-message, etc. in gRPC should not be duplicate", "bodyText": "Problem\nCurrent implementation of ArmeriaServerCall.close(Status status, Metadata metadata) may send duplicate headers :send, grpc-message, grpc-status, and armeria.grpc.ThrowableProto-bin.\nFor example, when StatusRuntimeException with metadata containing :status, grpc-status, etc. is thrown, then server sends duplicate headers.\nhttps://gist.github.com/okue/35ecbfe96c9d344a1abefc36acb0867e\n[armeria-common-worker-nio-2-1] WARN  c.l.a.client.logging.LoggingClient - Response: { cause=io.grpc.StatusException: UNAUTHENTICATED: Error in unaryCall2, headers=[EOS, :status=200, :status=200, content-type=application/grpc+proto, grpc-status=16, grpc-message=Error in unaryCall2, content-type=application/grpc+proto, grpc-status=16, grpc-message=Error in unaryCall2, armeria.grpc.throwableproto-bin=..., server=Armeria/0.99.5-SNAPSHOT, date=Sun, 17 May 2020 13:06:14 GMT, armeria.grpc.throwableproto-bin=...], content=CompletableRpcResponse{cause=io.grpc.StatusException: UNAUTHENTICATED: Error in unaryCall2}}\n\ngrpc-java implementation avoids this problem:\n\ngrpc-java/Http2ClientStreamTransportState.java#L243\ngrpc-java/AbstractServerStream.java#L141-L148\n\nModifications\n\nAdd an optional argument for MetadataUtil.fillHeaders, MetadataUtil.copyFromHeaders to copy headers excluding some keys\nArmeriaServerCall.close(status, metadata) ignores grpc-message, grpc-status, armeria.grpc.ThrowableProto-bin of given metadata\nStatusRuntimeException thrown by armeria gRPC client does not contain :status, grpc-status, grpc-message\nChanged MetadataUtil.fillHeaders and MetadataUtil.copyFromHeaders not to propagate specific headers:\n\n:status\ngrpc-message\ngrpc-status\narmeria.grpc.ThrowableProto-bin", "createdAt": "2020-05-17T13:52:39Z", "url": "https://github.com/line/armeria/pull/2718", "merged": true, "mergeCommit": {"oid": "a9f9d9cb2ed85a3412f4056b34489c13feab4216"}, "closed": true, "closedAt": "2020-06-02T04:10:08Z", "author": {"login": "okue"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciM48dAFqTQxMzE3MjU4NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnLY7pgFqTQyMjMwMDUxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTcyNTg1", "url": "https://github.com/line/armeria/pull/2718#pullrequestreview-413172585", "createdAt": "2020-05-17T15:20:29Z", "commit": {"oid": "b3e3b9fa03764eec8a54e607d4ea988e5a242593"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNToyMDoyOVrOGWhpPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNToyMDoyOVrOGWhpPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3MzA4Nw==", "bodyText": "Instead of passing these parameters, does it make sense to just have a constant with all four? I guess it makes sense to strip all of them in all cases.\nOtherwise, let's not use varargs it's wasteful for these constants.", "url": "https://github.com/line/armeria/pull/2718#discussion_r426273087", "createdAt": "2020-05-17T15:20:29Z", "author": {"login": "anuraaga"}, "path": "grpc/src/main/java/com/linecorp/armeria/internal/common/grpc/GrpcStatus.java", "diffHunk": "@@ -250,7 +251,12 @@ public static void reportStatus(HttpHeaders headers,\n             status = addCause(status, grpcThrowable);\n         }\n \n-        final Metadata metadata = MetadataUtil.copyFromHeaders(headers);\n+        final Metadata metadata = MetadataUtil.copyFromHeaders(\n+                headers,\n+                HttpHeaderNames.STATUS,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3e3b9fa03764eec8a54e607d4ea988e5a242593"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMjI3OTAz", "url": "https://github.com/line/armeria/pull/2718#pullrequestreview-413227903", "createdAt": "2020-05-18T01:41:28Z", "commit": {"oid": "b3e3b9fa03764eec8a54e607d4ea988e5a242593"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3e3b9fa03764eec8a54e607d4ea988e5a242593", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/b3e3b9fa03764eec8a54e607d4ea988e5a242593", "committedDate": "2020-05-17T09:36:24Z", "message": "Don't send duplicate headers"}, "afterCommit": {"oid": "d4a3a20fcb8326331d104ffac007dfe2a2265649", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/d4a3a20fcb8326331d104ffac007dfe2a2265649", "committedDate": "2020-05-20T17:04:34Z", "message": "Don't send duplicate headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c7517a56347a4230513ac25502f5fb5979593f1", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/1c7517a56347a4230513ac25502f5fb5979593f1", "committedDate": "2020-05-30T11:28:12Z", "message": "Strip specific headers when copying metadata"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4a3a20fcb8326331d104ffac007dfe2a2265649", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/d4a3a20fcb8326331d104ffac007dfe2a2265649", "committedDate": "2020-05-20T17:04:34Z", "message": "Don't send duplicate headers"}, "afterCommit": {"oid": "31cd6546f6ae9543b417d85a5150560a332481a2", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/31cd6546f6ae9543b417d85a5150560a332481a2", "committedDate": "2020-05-30T14:03:23Z", "message": "add test for  MetadataUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f04a77ec95f9cb635ed746174a674a625a96cfcd", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/f04a77ec95f9cb635ed746174a674a625a96cfcd", "committedDate": "2020-05-30T14:08:52Z", "message": "add test for  MetadataUtil"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31cd6546f6ae9543b417d85a5150560a332481a2", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/31cd6546f6ae9543b417d85a5150560a332481a2", "committedDate": "2020-05-30T14:03:23Z", "message": "add test for  MetadataUtil"}, "afterCommit": {"oid": "f04a77ec95f9cb635ed746174a674a625a96cfcd", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/f04a77ec95f9cb635ed746174a674a625a96cfcd", "committedDate": "2020-05-30T14:08:52Z", "message": "add test for  MetadataUtil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2149d005221c0d92b63b878226f4a5a69a1310e1", "author": {"user": {"login": "okue", "name": "Okue"}}, "url": "https://github.com/line/armeria/commit/2149d005221c0d92b63b878226f4a5a69a1310e1", "committedDate": "2020-05-30T14:43:07Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTcwMzIz", "url": "https://github.com/line/armeria/pull/2718#pullrequestreview-421570323", "createdAt": "2020-06-01T03:02:24Z", "commit": {"oid": "2149d005221c0d92b63b878226f4a5a69a1310e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTk3Njg1", "url": "https://github.com/line/armeria/pull/2718#pullrequestreview-421597685", "createdAt": "2020-06-01T05:17:52Z", "commit": {"oid": "2149d005221c0d92b63b878226f4a5a69a1310e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTk5NjA5", "url": "https://github.com/line/armeria/pull/2718#pullrequestreview-421599609", "createdAt": "2020-06-01T05:25:21Z", "commit": {"oid": "2149d005221c0d92b63b878226f4a5a69a1310e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMzAwNTEy", "url": "https://github.com/line/armeria/pull/2718#pullrequestreview-422300512", "createdAt": "2020-06-02T02:25:19Z", "commit": {"oid": "2149d005221c0d92b63b878226f4a5a69a1310e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 499, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}