{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5MzA3OTM2", "number": 3002, "title": "Support Consul service discovery", "bodyText": "Motivation:\n\nContinued from: #2192.\nRelated: #194 Service discovery support (serversets, k8s, ..).\nIt'd be nice to have Consul service discovery support.\n\nModifications:\n\nCreate armeria-consul module\nAdd dependencies for consul client and consul test server\nAdd ConsulUpdatingListener to register or deregister a service to Consul\nAdd ConsulEndpointGroup to retrieve healthy endpoints of a service managed by Consul\n\nResult:\n\nWe now have Consul service discovery support\nCloses #194\n\nTodos:\n\nAdd test case with the token for security", "createdAt": "2020-08-18T08:53:00Z", "url": "https://github.com/line/armeria/pull/3002", "merged": true, "mergeCommit": {"oid": "99a55e9a4f866b02a6594236c989c0f95de62815"}, "closed": true, "closedAt": "2020-12-14T05:35:33Z", "author": {"login": "eugene70"}, "timelineItems": {"totalCount": 67, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdARjcSAFqTQ2OTk4MDgwMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlBMQ4AFqTU0OTgxMzMxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5OTgwODAx", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-469980801", "createdAt": "2020-08-19T01:15:49Z", "commit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMToxNTo0OVrOHCr7aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwMTo0MzowM1rOHCsYsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU3ODkyMA==", "bodyText": "question: is this client communicating with the local agent only?", "url": "https://github.com/line/armeria/pull/3002#discussion_r472578920", "createdAt": "2020-08-19T01:15:49Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroup.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.ClientRequestContextCaptor;\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.endpoint.DynamicEndpointGroup;\n+import com.linecorp.armeria.client.endpoint.EndpointGroup;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+\n+import io.netty.channel.EventLoop;\n+\n+/**\n+ * A Consul-based {@link EndpointGroup} implementation that retrieves the list of {@link Endpoint}s\n+ * from Consul using <a href=\"https://www.consul.io/api\">Consul's RESTful HTTP API</a> and\n+ * updates the {@link Endpoint}s periodically.\n+ */\n+public final class ConsulEndpointGroup extends DynamicEndpointGroup {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ConsulEndpointGroup.class);\n+\n+    /**\n+     * Returns a {@link ConsulEndpointGroup} with the specified {@code serviceName}.\n+     * The returned {@link ConsulEndpointGroup} will retrieve the list of {@link Endpoint}s from\n+     * a local Consul agent(using default Consul service port).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU3OTUwMw==", "bodyText": "How about checking isClosing() here?", "url": "https://github.com/line/armeria/pull/3002#discussion_r472579503", "createdAt": "2020-08-19T01:18:00Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroup.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.ClientRequestContextCaptor;\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.endpoint.DynamicEndpointGroup;\n+import com.linecorp.armeria.client.endpoint.EndpointGroup;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+\n+import io.netty.channel.EventLoop;\n+\n+/**\n+ * A Consul-based {@link EndpointGroup} implementation that retrieves the list of {@link Endpoint}s\n+ * from Consul using <a href=\"https://www.consul.io/api\">Consul's RESTful HTTP API</a> and\n+ * updates the {@link Endpoint}s periodically.\n+ */\n+public final class ConsulEndpointGroup extends DynamicEndpointGroup {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ConsulEndpointGroup.class);\n+\n+    /**\n+     * Returns a {@link ConsulEndpointGroup} with the specified {@code serviceName}.\n+     * The returned {@link ConsulEndpointGroup} will retrieve the list of {@link Endpoint}s from\n+     * a local Consul agent(using default Consul service port).\n+     */\n+    public static ConsulEndpointGroup of(String serviceName) {\n+        return builder(serviceName).build();\n+    }\n+\n+    /**\n+     * Returns a newly-created {@link ConsulEndpointGroupBuilder} with the specified {@code serviceName}.\n+     */\n+    public static ConsulEndpointGroupBuilder builder(String serviceName) {\n+        return new ConsulEndpointGroupBuilder(serviceName);\n+    }\n+\n+    private final ConsulClient consulClient;\n+    private final String serviceName;\n+    private final long registryFetchIntervalSeconds;\n+    private final boolean useHealthyEndpoints;\n+\n+    @Nullable\n+    private volatile ScheduledFuture<?> scheduledFuture;\n+\n+    ConsulEndpointGroup(ConsulClient consulClient, String serviceName, long registryFetchIntervalSeconds,\n+                        boolean useHealthyEndpoints) {\n+        this.consulClient = consulClient;\n+        this.serviceName = serviceName;\n+        this.registryFetchIntervalSeconds = registryFetchIntervalSeconds;\n+        this.useHealthyEndpoints = useHealthyEndpoints;\n+\n+        update();\n+    }\n+\n+    private void update() {\n+        if (isClosing()) {\n+            return;\n+        }\n+\n+        final CompletableFuture<List<Endpoint>> response;\n+        final EventLoop eventLoop;\n+        try (ClientRequestContextCaptor captor = Clients.newContextCaptor()) {\n+            if (useHealthyEndpoints) {\n+                response = consulClient.healthyEndpoints(serviceName);\n+            } else {\n+                response = consulClient.endpoints(serviceName);\n+            }\n+            eventLoop = captor.get().eventLoop().withoutContext();\n+        }\n+\n+        response.handle((endpoints, cause) -> {\n+            if (cause != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4MTcyMw==", "bodyText": "How about checking whether consulUri is null and throwing an exception if it is?\nOr we can remove the ConsulClient setter which is only used in test and accept the uri in the constructor so that consulUri is not null.", "url": "https://github.com/line/armeria/pull/3002#discussion_r472581723", "createdAt": "2020-08-19T01:25:56Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupBuilder.java", "diffHunk": "@@ -0,0 +1,129 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListenerBuilder;\n+\n+/**\n+ * A builder class for {@link ConsulEndpointGroup}.\n+ */\n+public final class ConsulEndpointGroupBuilder {\n+\n+    private static final long DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS = 10;\n+\n+    private long registryFetchIntervalSeconds = DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS;\n+    private final String serviceName;\n+\n+    @Nullable\n+    private URI consulUri;\n+    @Nullable\n+    private ConsulClient consulClient;\n+    @Nullable\n+    private String token;\n+\n+    private boolean useHealthyEndpoints;\n+\n+    ConsulEndpointGroupBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+    }\n+\n+    /**\n+     * Sets the specified {@code consulUri}.\n+     */\n+    public ConsulEndpointGroupBuilder consulUri(URI consulUri) {\n+        this.consulUri = requireNonNull(consulUri, \"consulUri\");\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified {@code consulUri}.\n+     */\n+    public ConsulEndpointGroupBuilder consulUri(String consulUri) {\n+        requireNonNull(consulUri, \"consulUri\");\n+        checkArgument(!consulUri.isEmpty(), \"consulUri can't be empty\");\n+        this.consulUri = URI.create(consulUri);\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.\n+     * If not set, {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.\n+     */\n+    public ConsulEndpointGroupBuilder registryFetchInterval(Duration registryFetchInterval) {\n+        requireNonNull(registryFetchInterval, \"registryFetchInterval\");\n+        final long seconds = registryFetchInterval.getSeconds();\n+        checkArgument(seconds > 0, \"registryFetchInterval.getSeconds(): %s (expected: > 0)\", seconds);\n+        return registryFetchIntervalSeconds(seconds);\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.he interval between fetching registry requests.\n+     * If not set {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.\n+     */\n+    public ConsulEndpointGroupBuilder registryFetchIntervalSeconds(long registryFetchIntervalSeconds) {\n+        checkArgument(registryFetchIntervalSeconds > 0, \"registryFetchIntervalSeconds: %s (expected: > 0)\",\n+                      registryFetchIntervalSeconds);\n+        this.registryFetchIntervalSeconds = registryFetchIntervalSeconds;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified {@code token} for accessing Consul server.\n+     */\n+    public ConsulEndpointGroupBuilder token(String token) {\n+        this.token = requireNonNull(token, \"token\");\n+        return this;\n+    }\n+\n+    /**\n+     * Sets whether to use <a href=\"https://www.consul.io/api/health.html\">Health HTTP endpoint</a>.\n+     * Before enabling this feature, make sure that your target endpoints are health-checked by Consul.\n+     *\n+     * @see ConsulUpdatingListenerBuilder#checkUri(URI)\n+     */\n+    public ConsulEndpointGroupBuilder useHealthEndpoints(boolean useHealthyEndpoints) {\n+        this.useHealthyEndpoints = useHealthyEndpoints;\n+        return this;\n+    }\n+\n+    /**\n+     * Returns a newly-created {@link ConsulEndpointGroup}.\n+     */\n+    public ConsulEndpointGroup build() {\n+        if (consulClient == null) {\n+            consulClient = new ConsulClient(consulUri, token);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4MzEzMA==", "bodyText": "Let's add .omitNullValues().", "url": "https://github.com/line/armeria/pull/3002#discussion_r472583130", "createdAt": "2020-08-19T01:31:00Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/AgentServiceClient.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/agent/service.html\">Agent HTTP API</a>.\n+ */\n+final class AgentServiceClient {\n+\n+    static AgentServiceClient of(ConsulClient consulClient) {\n+        return new AgentServiceClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private AgentServiceClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Registers a service into the Consul agent.\n+     */\n+    HttpResponse register(String serviceId, String serviceName, String address, int port,\n+                          @Nullable Check check) {\n+        final Service service = new Service();\n+        service.id = serviceId;\n+        service.name = serviceName;\n+        service.address = address;\n+        service.port = port;\n+        if (check != null) {\n+            service.check = check;\n+        }\n+\n+        try {\n+            return client.put(\"/agent/service/register\", mapper.writeValueAsString(service));\n+        } catch (JsonProcessingException e) {\n+            return HttpResponse.ofFailure(e);\n+        }\n+    }\n+\n+    /**\n+     * De-registers a service from the Consul agent.\n+     */\n+    HttpResponse deregister(String serviceId) {\n+        requireNonNull(serviceId, \"serviceId\");\n+        return client.put(\"/agent/service/deregister/\" + serviceId, \"\");\n+    }\n+\n+    @JsonIgnoreProperties(ignoreUnknown = true)\n+    @JsonInclude(Include.NON_NULL)\n+    public static final class Service {\n+\n+        @Nullable\n+        @JsonProperty(\"Service\")\n+        String service;\n+\n+        @Nullable\n+        @JsonProperty(\"Name\")\n+        String name;\n+\n+        @JsonProperty(\"ID\")\n+        String id;\n+\n+        @Nullable\n+        @JsonProperty(\"Tags\")\n+        String[] tags;\n+\n+        @Nullable\n+        @JsonProperty(\"Address\")\n+        String address;\n+\n+        @Nullable\n+        @JsonProperty(\"TaggedAddresses\")\n+        Map<String, Object> taggedAddresses;\n+\n+        @Nullable\n+        @JsonProperty(\"Meta\")\n+        Map<String, String> meta;\n+\n+        @JsonProperty(\"Port\")\n+        int port;\n+\n+        @Nullable\n+        @JsonProperty(\"Kind\")\n+        String kind;\n+\n+        @Nullable\n+        @JsonProperty(\"Proxy\")\n+        Object proxy;\n+\n+        @Nullable\n+        @JsonProperty(\"Connect\")\n+        Object connect;\n+\n+        @Nullable\n+        @JsonProperty(\"Check\")\n+        Check check;\n+\n+        @Nullable\n+        @JsonProperty(\"Checks\")\n+        List<Check> checks;\n+\n+        @JsonProperty(\"EnableTagOverride\")\n+        boolean enableTagOverride;\n+\n+        @Nullable\n+        @JsonProperty(\"Weights\")\n+        Map<String, Object> weights;\n+\n+        @Override\n+        public String toString() {\n+            return MoreObjects.toStringHelper(this)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4MzU2OQ==", "bodyText": "Question: Only id is not null?", "url": "https://github.com/line/armeria/pull/3002#discussion_r472583569", "createdAt": "2020-08-19T01:32:42Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/AgentServiceClient.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/agent/service.html\">Agent HTTP API</a>.\n+ */\n+final class AgentServiceClient {\n+\n+    static AgentServiceClient of(ConsulClient consulClient) {\n+        return new AgentServiceClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private AgentServiceClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Registers a service into the Consul agent.\n+     */\n+    HttpResponse register(String serviceId, String serviceName, String address, int port,\n+                          @Nullable Check check) {\n+        final Service service = new Service();\n+        service.id = serviceId;\n+        service.name = serviceName;\n+        service.address = address;\n+        service.port = port;\n+        if (check != null) {\n+            service.check = check;\n+        }\n+\n+        try {\n+            return client.put(\"/agent/service/register\", mapper.writeValueAsString(service));\n+        } catch (JsonProcessingException e) {\n+            return HttpResponse.ofFailure(e);\n+        }\n+    }\n+\n+    /**\n+     * De-registers a service from the Consul agent.\n+     */\n+    HttpResponse deregister(String serviceId) {\n+        requireNonNull(serviceId, \"serviceId\");\n+        return client.put(\"/agent/service/deregister/\" + serviceId, \"\");\n+    }\n+\n+    @JsonIgnoreProperties(ignoreUnknown = true)\n+    @JsonInclude(Include.NON_NULL)\n+    public static final class Service {\n+\n+        @Nullable\n+        @JsonProperty(\"Service\")\n+        String service;\n+\n+        @Nullable\n+        @JsonProperty(\"Name\")\n+        String name;\n+\n+        @JsonProperty(\"ID\")\n+        String id;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4MzkzOA==", "bodyText": "Let's use HttpData.empty() instead of \"\".", "url": "https://github.com/line/armeria/pull/3002#discussion_r472583938", "createdAt": "2020-08-19T01:34:00Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/AgentServiceClient.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.Map;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/agent/service.html\">Agent HTTP API</a>.\n+ */\n+final class AgentServiceClient {\n+\n+    static AgentServiceClient of(ConsulClient consulClient) {\n+        return new AgentServiceClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private AgentServiceClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Registers a service into the Consul agent.\n+     */\n+    HttpResponse register(String serviceId, String serviceName, String address, int port,\n+                          @Nullable Check check) {\n+        final Service service = new Service();\n+        service.id = serviceId;\n+        service.name = serviceName;\n+        service.address = address;\n+        service.port = port;\n+        if (check != null) {\n+            service.check = check;\n+        }\n+\n+        try {\n+            return client.put(\"/agent/service/register\", mapper.writeValueAsString(service));\n+        } catch (JsonProcessingException e) {\n+            return HttpResponse.ofFailure(e);\n+        }\n+    }\n+\n+    /**\n+     * De-registers a service from the Consul agent.\n+     */\n+    HttpResponse deregister(String serviceId) {\n+        requireNonNull(serviceId, \"serviceId\");\n+        return client.put(\"/agent/service/deregister/\" + serviceId, \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4NDY5Nw==", "bodyText": "Can we make AgentServiceClient once in the constructor and reuse it?", "url": "https://github.com/line/armeria/pull/3002#discussion_r472584697", "createdAt": "2020-08-19T01:36:34Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClient.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.net.URI;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.ClientDecoration;\n+import com.linecorp.armeria.client.ClientOptions;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.WebClientBuilder;\n+import com.linecorp.armeria.client.retry.RetryRule;\n+import com.linecorp.armeria.client.retry.RetryingClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A client for accessing to Consul agent API server.\n+ */\n+public final class ConsulClient {\n+    private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    private static final ClientOptions retryingClientOptions =\n+            ClientOptions.of(ClientOptions.DECORATION.newValue(ClientDecoration.of(\n+                    RetryingClient.newDecorator(RetryRule.failsafe(), 3))));\n+\n+    private final WebClient webClient;\n+    private final HealthClient healthClient;\n+\n+    public ConsulClient(URI uri) {\n+        this(uri, null);\n+    }\n+\n+    public ConsulClient(URI uri, @Nullable String token) {\n+        final WebClientBuilder builder = WebClient.builder(uri);\n+        builder.options(retryingClientOptions);\n+        if (token != null) {\n+            // TODO(eugene70) test with token\n+            builder.addHeader(\"X-Consul-Token\", token);\n+        }\n+        webClient = builder.build();\n+        healthClient = HealthClient.of(this);\n+    }\n+\n+    /**\n+     * Returns an {@link ObjectMapper} that is used to encode and decode Consul requests and responses.\n+     */\n+    public ObjectMapper getObjectMapper() {\n+        return objectMapper;\n+    }\n+\n+    /**\n+     * Registers a service to Consul Agent with service ID.\n+     *\n+     * @param serviceId a service ID that identifying a service\n+     * @param serviceName a service name to register\n+     * @param endpoint an endpoint of service to register\n+     * @param check a check for the service\n+     * @return a {@link CompletableFuture} that will be completed with the registered service ID\n+     */\n+    public HttpResponse register(String serviceId, String serviceName, Endpoint endpoint,\n+                                 @Nullable Check check) {\n+        return AgentServiceClient.of(this)\n+                                 .register(serviceId, serviceName, endpoint.host(), endpoint.port(), check);\n+    }\n+\n+    /**\n+     * De-registers a service to Consul Agent.\n+     *\n+     * @param serviceId a service ID that identifying a service\n+     */\n+    public HttpResponse deregister(String serviceId) {\n+        return AgentServiceClient.of(this).deregister(serviceId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4NTI3NQ==", "bodyText": "Can remove public?", "url": "https://github.com/line/armeria/pull/3002#discussion_r472585275", "createdAt": "2020-08-19T01:38:57Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClient.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.net.URI;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.ClientDecoration;\n+import com.linecorp.armeria.client.ClientOptions;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.WebClientBuilder;\n+import com.linecorp.armeria.client.retry.RetryRule;\n+import com.linecorp.armeria.client.retry.RetryingClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A client for accessing to Consul agent API server.\n+ */\n+public final class ConsulClient {\n+    private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    private static final ClientOptions retryingClientOptions =\n+            ClientOptions.of(ClientOptions.DECORATION.newValue(ClientDecoration.of(\n+                    RetryingClient.newDecorator(RetryRule.failsafe(), 3))));\n+\n+    private final WebClient webClient;\n+    private final HealthClient healthClient;\n+\n+    public ConsulClient(URI uri) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4NTI5Mw==", "bodyText": "Can remove public?", "url": "https://github.com/line/armeria/pull/3002#discussion_r472585293", "createdAt": "2020-08-19T01:39:02Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClient.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.net.URI;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.ClientDecoration;\n+import com.linecorp.armeria.client.ClientOptions;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.WebClientBuilder;\n+import com.linecorp.armeria.client.retry.RetryRule;\n+import com.linecorp.armeria.client.retry.RetryingClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A client for accessing to Consul agent API server.\n+ */\n+public final class ConsulClient {\n+    private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    private static final ClientOptions retryingClientOptions =\n+            ClientOptions.of(ClientOptions.DECORATION.newValue(ClientDecoration.of(\n+                    RetryingClient.newDecorator(RetryRule.failsafe(), 3))));\n+\n+    private final WebClient webClient;\n+    private final HealthClient healthClient;\n+\n+    public ConsulClient(URI uri) {\n+        this(uri, null);\n+    }\n+\n+    public ConsulClient(URI uri, @Nullable String token) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4NTQxMA==", "bodyText": "Can remove public?", "url": "https://github.com/line/armeria/pull/3002#discussion_r472585410", "createdAt": "2020-08-19T01:39:25Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClient.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.net.URI;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.ClientDecoration;\n+import com.linecorp.armeria.client.ClientOptions;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.WebClientBuilder;\n+import com.linecorp.armeria.client.retry.RetryRule;\n+import com.linecorp.armeria.client.retry.RetryingClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A client for accessing to Consul agent API server.\n+ */\n+public final class ConsulClient {\n+    private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    private static final ClientOptions retryingClientOptions =\n+            ClientOptions.of(ClientOptions.DECORATION.newValue(ClientDecoration.of(\n+                    RetryingClient.newDecorator(RetryRule.failsafe(), 3))));\n+\n+    private final WebClient webClient;\n+    private final HealthClient healthClient;\n+\n+    public ConsulClient(URI uri) {\n+        this(uri, null);\n+    }\n+\n+    public ConsulClient(URI uri, @Nullable String token) {\n+        final WebClientBuilder builder = WebClient.builder(uri);\n+        builder.options(retryingClientOptions);\n+        if (token != null) {\n+            // TODO(eugene70) test with token\n+            builder.addHeader(\"X-Consul-Token\", token);\n+        }\n+        webClient = builder.build();\n+        healthClient = HealthClient.of(this);\n+    }\n+\n+    /**\n+     * Returns an {@link ObjectMapper} that is used to encode and decode Consul requests and responses.\n+     */\n+    public ObjectMapper getObjectMapper() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4NTc1Mw==", "bodyText": "Can we make CatalogClient  once in the constructor and reuse it?", "url": "https://github.com/line/armeria/pull/3002#discussion_r472585753", "createdAt": "2020-08-19T01:40:40Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClient.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.net.URI;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.ClientDecoration;\n+import com.linecorp.armeria.client.ClientOptions;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.WebClientBuilder;\n+import com.linecorp.armeria.client.retry.RetryRule;\n+import com.linecorp.armeria.client.retry.RetryingClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A client for accessing to Consul agent API server.\n+ */\n+public final class ConsulClient {\n+    private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    private static final ClientOptions retryingClientOptions =\n+            ClientOptions.of(ClientOptions.DECORATION.newValue(ClientDecoration.of(\n+                    RetryingClient.newDecorator(RetryRule.failsafe(), 3))));\n+\n+    private final WebClient webClient;\n+    private final HealthClient healthClient;\n+\n+    public ConsulClient(URI uri) {\n+        this(uri, null);\n+    }\n+\n+    public ConsulClient(URI uri, @Nullable String token) {\n+        final WebClientBuilder builder = WebClient.builder(uri);\n+        builder.options(retryingClientOptions);\n+        if (token != null) {\n+            // TODO(eugene70) test with token\n+            builder.addHeader(\"X-Consul-Token\", token);\n+        }\n+        webClient = builder.build();\n+        healthClient = HealthClient.of(this);\n+    }\n+\n+    /**\n+     * Returns an {@link ObjectMapper} that is used to encode and decode Consul requests and responses.\n+     */\n+    public ObjectMapper getObjectMapper() {\n+        return objectMapper;\n+    }\n+\n+    /**\n+     * Registers a service to Consul Agent with service ID.\n+     *\n+     * @param serviceId a service ID that identifying a service\n+     * @param serviceName a service name to register\n+     * @param endpoint an endpoint of service to register\n+     * @param check a check for the service\n+     * @return a {@link CompletableFuture} that will be completed with the registered service ID\n+     */\n+    public HttpResponse register(String serviceId, String serviceName, Endpoint endpoint,\n+                                 @Nullable Check check) {\n+        return AgentServiceClient.of(this)\n+                                 .register(serviceId, serviceName, endpoint.host(), endpoint.port(), check);\n+    }\n+\n+    /**\n+     * De-registers a service to Consul Agent.\n+     *\n+     * @param serviceId a service ID that identifying a service\n+     */\n+    public HttpResponse deregister(String serviceId) {\n+        return AgentServiceClient.of(this).deregister(serviceId);\n+    }\n+\n+    /**\n+     * Get registered endpoints with service name from Consul agent.\n+     */\n+    public CompletableFuture<List<Endpoint>> endpoints(String serviceName) {\n+        return CatalogClient.of(this).endpoints(serviceName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4NjA0MQ==", "bodyText": "Can remove public?", "url": "https://github.com/line/armeria/pull/3002#discussion_r472586041", "createdAt": "2020-08-19T01:41:35Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClient.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.net.URI;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.ClientDecoration;\n+import com.linecorp.armeria.client.ClientOptions;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.WebClientBuilder;\n+import com.linecorp.armeria.client.retry.RetryRule;\n+import com.linecorp.armeria.client.retry.RetryingClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A client for accessing to Consul agent API server.\n+ */\n+public final class ConsulClient {\n+    private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    private static final ClientOptions retryingClientOptions =\n+            ClientOptions.of(ClientOptions.DECORATION.newValue(ClientDecoration.of(\n+                    RetryingClient.newDecorator(RetryRule.failsafe(), 3))));\n+\n+    private final WebClient webClient;\n+    private final HealthClient healthClient;\n+\n+    public ConsulClient(URI uri) {\n+        this(uri, null);\n+    }\n+\n+    public ConsulClient(URI uri, @Nullable String token) {\n+        final WebClientBuilder builder = WebClient.builder(uri);\n+        builder.options(retryingClientOptions);\n+        if (token != null) {\n+            // TODO(eugene70) test with token\n+            builder.addHeader(\"X-Consul-Token\", token);\n+        }\n+        webClient = builder.build();\n+        healthClient = HealthClient.of(this);\n+    }\n+\n+    /**\n+     * Returns an {@link ObjectMapper} that is used to encode and decode Consul requests and responses.\n+     */\n+    public ObjectMapper getObjectMapper() {\n+        return objectMapper;\n+    }\n+\n+    /**\n+     * Registers a service to Consul Agent with service ID.\n+     *\n+     * @param serviceId a service ID that identifying a service\n+     * @param serviceName a service name to register\n+     * @param endpoint an endpoint of service to register\n+     * @param check a check for the service\n+     * @return a {@link CompletableFuture} that will be completed with the registered service ID\n+     */\n+    public HttpResponse register(String serviceId, String serviceName, Endpoint endpoint,\n+                                 @Nullable Check check) {\n+        return AgentServiceClient.of(this)\n+                                 .register(serviceId, serviceName, endpoint.host(), endpoint.port(), check);\n+    }\n+\n+    /**\n+     * De-registers a service to Consul Agent.\n+     *\n+     * @param serviceId a service ID that identifying a service\n+     */\n+    public HttpResponse deregister(String serviceId) {\n+        return AgentServiceClient.of(this).deregister(serviceId);\n+    }\n+\n+    /**\n+     * Get registered endpoints with service name from Consul agent.\n+     */\n+    public CompletableFuture<List<Endpoint>> endpoints(String serviceName) {\n+        return CatalogClient.of(this).endpoints(serviceName);\n+    }\n+\n+    /**\n+     * Returns the registered endpoints with the specified service name from Consul agent.\n+     */\n+    public CompletableFuture<List<Endpoint>> healthyEndpoints(String serviceName) {\n+        return healthClient.healthyEndpoints(serviceName);\n+    }\n+\n+    /**\n+     * Returns a {@code WebClient} for accessing to Consul server.\n+     */\n+    public WebClient consulWebClient() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU4NjQxNg==", "bodyText": "How about removing this method?\nI think ConsulEndpontGroup and ConsulUpdatingListener can have the URI when they are built.", "url": "https://github.com/line/armeria/pull/3002#discussion_r472586416", "createdAt": "2020-08-19T01:43:03Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClient.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.net.URI;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.ClientDecoration;\n+import com.linecorp.armeria.client.ClientOptions;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.WebClientBuilder;\n+import com.linecorp.armeria.client.retry.RetryRule;\n+import com.linecorp.armeria.client.retry.RetryingClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A client for accessing to Consul agent API server.\n+ */\n+public final class ConsulClient {\n+    private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    private static final ClientOptions retryingClientOptions =\n+            ClientOptions.of(ClientOptions.DECORATION.newValue(ClientDecoration.of(\n+                    RetryingClient.newDecorator(RetryRule.failsafe(), 3))));\n+\n+    private final WebClient webClient;\n+    private final HealthClient healthClient;\n+\n+    public ConsulClient(URI uri) {\n+        this(uri, null);\n+    }\n+\n+    public ConsulClient(URI uri, @Nullable String token) {\n+        final WebClientBuilder builder = WebClient.builder(uri);\n+        builder.options(retryingClientOptions);\n+        if (token != null) {\n+            // TODO(eugene70) test with token\n+            builder.addHeader(\"X-Consul-Token\", token);\n+        }\n+        webClient = builder.build();\n+        healthClient = HealthClient.of(this);\n+    }\n+\n+    /**\n+     * Returns an {@link ObjectMapper} that is used to encode and decode Consul requests and responses.\n+     */\n+    public ObjectMapper getObjectMapper() {\n+        return objectMapper;\n+    }\n+\n+    /**\n+     * Registers a service to Consul Agent with service ID.\n+     *\n+     * @param serviceId a service ID that identifying a service\n+     * @param serviceName a service name to register\n+     * @param endpoint an endpoint of service to register\n+     * @param check a check for the service\n+     * @return a {@link CompletableFuture} that will be completed with the registered service ID\n+     */\n+    public HttpResponse register(String serviceId, String serviceName, Endpoint endpoint,\n+                                 @Nullable Check check) {\n+        return AgentServiceClient.of(this)\n+                                 .register(serviceId, serviceName, endpoint.host(), endpoint.port(), check);\n+    }\n+\n+    /**\n+     * De-registers a service to Consul Agent.\n+     *\n+     * @param serviceId a service ID that identifying a service\n+     */\n+    public HttpResponse deregister(String serviceId) {\n+        return AgentServiceClient.of(this).deregister(serviceId);\n+    }\n+\n+    /**\n+     * Get registered endpoints with service name from Consul agent.\n+     */\n+    public CompletableFuture<List<Endpoint>> endpoints(String serviceName) {\n+        return CatalogClient.of(this).endpoints(serviceName);\n+    }\n+\n+    /**\n+     * Returns the registered endpoints with the specified service name from Consul agent.\n+     */\n+    public CompletableFuture<List<Endpoint>> healthyEndpoints(String serviceName) {\n+        return healthClient.healthyEndpoints(serviceName);\n+    }\n+\n+    /**\n+     * Returns a {@code WebClient} for accessing to Consul server.\n+     */\n+    public WebClient consulWebClient() {\n+        return webClient;\n+    }\n+\n+    /**\n+     * Returns the {@link URI} of Consul agent.\n+     */\n+    public URI uri() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42"}, "originalPosition": 118}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/8d3ef5d795d42d9ad22f5c3b838e8d44d3ccbe42", "committedDate": "2020-08-18T09:53:44Z", "message": "Use seconds for refreshing endpoints in ConsulEndpointGroup"}, "afterCommit": {"oid": "ca6814e442faa594225fbc7e85d66ae180fe14c8", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/ca6814e442faa594225fbc7e85d66ae180fe14c8", "committedDate": "2020-08-24T12:40:43Z", "message": "Apply reviews\n\n- Check `isClosing` again after update on `ConsulEndpointGroup`\n- Reuse instace of `CatalogClient` and `AgentServiceClient`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca6814e442faa594225fbc7e85d66ae180fe14c8", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/ca6814e442faa594225fbc7e85d66ae180fe14c8", "committedDate": "2020-08-24T12:40:43Z", "message": "Apply reviews\n\n- Check `isClosing` again after update on `ConsulEndpointGroup`\n- Reuse instace of `CatalogClient` and `AgentServiceClient`"}, "afterCommit": {"oid": "a0c2bcfcfd2e862802a46682d84423d361b52cbb", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/a0c2bcfcfd2e862802a46682d84423d361b52cbb", "committedDate": "2020-08-24T13:44:09Z", "message": "Apply reviews\n\n- Check `isClosing` again after update on `ConsulEndpointGroup`\n- Reuse instace of `CatalogClient` and `AgentServiceClient`\n- Remove `public` of `consulWebClient()` on `ConsulClient`\n- Refactor inner class `Service` on `AgentServiceClient`"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0c2bcfcfd2e862802a46682d84423d361b52cbb", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/a0c2bcfcfd2e862802a46682d84423d361b52cbb", "committedDate": "2020-08-24T13:44:09Z", "message": "Apply reviews\n\n- Check `isClosing` again after update on `ConsulEndpointGroup`\n- Reuse instace of `CatalogClient` and `AgentServiceClient`\n- Remove `public` of `consulWebClient()` on `ConsulClient`\n- Refactor inner class `Service` on `AgentServiceClient`"}, "afterCommit": {"oid": "ca0ec4a666802d3142f67d5c8e5752c74f5d494a", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/ca0ec4a666802d3142f67d5c8e5752c74f5d494a", "committedDate": "2020-08-27T14:08:12Z", "message": "Refactor whole package\n\n  - Remove low level unit tests.\n  - Create ConsulClientBuilder.\n  - Sync the manner of creating ConsulClient.\n  - Remove 'public' from class CatalogClient."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca0ec4a666802d3142f67d5c8e5752c74f5d494a", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/ca0ec4a666802d3142f67d5c8e5752c74f5d494a", "committedDate": "2020-08-27T14:08:12Z", "message": "Refactor whole package\n\n  - Remove low level unit tests.\n  - Create ConsulClientBuilder.\n  - Sync the manner of creating ConsulClient.\n  - Remove 'public' from class CatalogClient."}, "afterCommit": {"oid": "1b38de13e8b5f605af7b47c0a9010aae362309f7", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/1b38de13e8b5f605af7b47c0a9010aae362309f7", "committedDate": "2020-08-27T18:34:08Z", "message": "Refactor whole package\n\n  - Remove low level unit tests.\n  - Create ConsulClientBuilder.\n  - Sync the manner of creating ConsulClient.\n  - Remove 'public' from class CatalogClient."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3MjQ5ODMy", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-477249832", "createdAt": "2020-08-28T05:32:40Z", "commit": {"oid": "1b38de13e8b5f605af7b47c0a9010aae362309f7"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQwNTozMjo0MFrOHIqBZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QwMjo1NToyOFrOHMUAdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgzOTE0Mw==", "bodyText": "nit: indent, could be joined", "url": "https://github.com/line/armeria/pull/3002#discussion_r478839143", "createdAt": "2020-08-28T05:32:40Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/AgentServiceClient.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/agent/service.html\">Agent HTTP API</a>.\n+ */\n+final class AgentServiceClient {\n+\n+    static AgentServiceClient of(ConsulClient consulClient) {\n+        return new AgentServiceClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private AgentServiceClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Registers a service into the Consul agent.\n+     */\n+    HttpResponse register(String serviceId, String serviceName, String address, int port,\n+                          @Nullable Check check) {\n+        final Service service = new Service(serviceId, serviceName, address, port, check);\n+        try {\n+            return client.put(\"/agent/service/register\", mapper.writeValueAsString(service));\n+        } catch (JsonProcessingException e) {\n+            return HttpResponse.ofFailure(e);\n+        }\n+    }\n+\n+    /**\n+     * De-registers a service from the Consul agent.\n+     */\n+    HttpResponse deregister(String serviceId) {\n+        requireNonNull(serviceId, \"serviceId\");\n+        return client.put(\"/agent/service/deregister/\" + serviceId, HttpData.empty());\n+    }\n+\n+    @JsonIgnoreProperties(ignoreUnknown = true)\n+    @JsonInclude(Include.NON_NULL)\n+    private static final class Service {\n+\n+        @JsonProperty(\"ID\")\n+        private final String id;\n+\n+        @JsonProperty(\"Name\")\n+        private final String name;\n+\n+        @JsonProperty(\"Address\")\n+        private final String address;\n+\n+        @JsonProperty(\"Port\")\n+        private final int port;\n+\n+        @Nullable\n+        @JsonProperty(\"Check\")\n+        private final Check check;\n+\n+        Service(String id, String name, String address, int port,\n+                       @Nullable Check check) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b38de13e8b5f605af7b47c0a9010aae362309f7"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODgzOTY5Nw==", "bodyText": "Add omitNullValues()?", "url": "https://github.com/line/armeria/pull/3002#discussion_r478839697", "createdAt": "2020-08-28T05:34:14Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/CatalogClient.java", "diffHunk": "@@ -0,0 +1,199 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.function.Function;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.type.CollectionType;\n+import com.fasterxml.jackson.databind.type.TypeFactory;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Strings;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.util.Exceptions;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/catalog.html\">Catalog HTTP API</a>.\n+ */\n+final class CatalogClient {\n+\n+    private static final CollectionType collectionTypeForNode =\n+            TypeFactory.defaultInstance().constructCollectionType(List.class, Node.class);\n+\n+    static CatalogClient of(ConsulClient consulClient) {\n+        return new CatalogClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private CatalogClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Gets endpoint list with service name.\n+     */\n+    CompletableFuture<List<Endpoint>> endpoints(String serviceName) {\n+        requireNonNull(serviceName, \"serviceName\");\n+        return service(serviceName)\n+                .thenApply(nodes -> {\n+                    final Function<Node, Endpoint> nodeEndpointFunction = node -> {\n+                        final String host;\n+                        if (!Strings.isNullOrEmpty(node.serviceAddress)) {\n+                            host = node.serviceAddress;\n+                        } else if (!Strings.isNullOrEmpty(node.address)) {\n+                            host = node.address;\n+                        } else {\n+                            host = \"127.0.0.1\";\n+                        }\n+                        return Endpoint.of(host, node.servicePort);\n+                    };\n+                    return nodes.stream()\n+                                .map(nodeEndpointFunction)\n+                                .collect(toImmutableList());\n+                });\n+    }\n+\n+    /**\n+     * Returns node list with service name.\n+     */\n+    @VisibleForTesting\n+    CompletableFuture<List<Node>> service(String serviceName) {\n+        requireNonNull(serviceName, \"serviceName\");\n+\n+        return client.get(\"/catalog/service/\" + serviceName)\n+                     .aggregate()\n+                     .thenApply(response -> {\n+                         try {\n+                             return mapper.readValue(response.content().toStringUtf8(), collectionTypeForNode);\n+                         } catch (JsonProcessingException e) {\n+                             return Exceptions.throwUnsafely(e);\n+                         }\n+                     });\n+    }\n+\n+    @JsonIgnoreProperties(ignoreUnknown = true)\n+    static final class Node {\n+        @Nullable\n+        @JsonProperty(\"ID\")\n+        String id;\n+\n+        @Nullable\n+        @JsonProperty(\"Node\")\n+        String node;\n+\n+        @Nullable\n+        @JsonProperty(\"Address\")\n+        String address;\n+\n+        @Nullable\n+        @JsonProperty(\"Datacenter\")\n+        String datacenter;\n+\n+        @Nullable\n+        @JsonProperty(\"TaggedAddresses\")\n+        Map<String, String> taggedAddresses;\n+\n+        @Nullable\n+        @JsonProperty(\"NodeMeta\")\n+        Map<String, Object> nodeMeta;\n+\n+        @JsonProperty(\"CreateIndex\")\n+        int createIndex;\n+\n+        @JsonProperty(\"ModifyIndex\")\n+        int modifyIndex;\n+\n+        @Nullable\n+        @JsonProperty(\"ServiceAddress\")\n+        String serviceAddress;\n+\n+        @JsonProperty(\"ServiceEnableTagOverride\")\n+        boolean serviceEnableTagOverride;\n+\n+        @Nullable\n+        @JsonProperty(\"ServiceID\")\n+        String serviceId;\n+\n+        @Nullable\n+        @JsonProperty(\"ServiceName\")\n+        String serviceName;\n+\n+        @JsonProperty(\"ServicePort\")\n+        int servicePort;\n+\n+        @Nullable\n+        @JsonProperty(\"ServiceMeta\")\n+        Map<String, Object> serviceMeta;\n+\n+        @Nullable\n+        @JsonProperty(\"ServiceTaggedAddresses\")\n+        Map<String, Object> serviceTaggedAddresses;\n+\n+        @Nullable\n+        @JsonProperty(\"ServiceTags\")\n+        String[] serviceTags;\n+\n+        @Nullable\n+        @JsonProperty(\"ServiceProxy\")\n+        Map<String, Object> serviceProxy;\n+\n+        @Nullable\n+        @JsonProperty(\"ServiceConnect\")\n+        Map<String, Object> serviceConnect;\n+\n+        @Override\n+        public String toString() {\n+            return MoreObjects.toStringHelper(this)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b38de13e8b5f605af7b47c0a9010aae362309f7"}, "originalPosition": 177}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY2OTg1Nw==", "bodyText": "Change the modifier to public and move the documentation here?\nJavadoc is inherited.", "url": "https://github.com/line/armeria/pull/3002#discussion_r482669857", "createdAt": "2020-09-03T02:44:31Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    protected ConsulClientBuilder consulProtocol(SessionProtocol consulProtocol) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edf7653201bfa79a371084a683d51ec2263cbc1b"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY2OTkyNw==", "bodyText": "Let's add final", "url": "https://github.com/line/armeria/pull/3002#discussion_r482669927", "createdAt": "2020-09-03T02:44:47Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    protected ConsulClientBuilder consulProtocol(SessionProtocol consulProtocol) {\n+        this.consulProtocol = requireNonNull(consulProtocol, \"consulProtocol\");\n+        return this;\n+    }\n+\n+    protected ConsulClientBuilder consulAddress(String consulAddress) {\n+        this.consulAddress = requireNonNull(consulAddress, \"consulAddress\");\n+        checkArgument(!consulAddress.isEmpty(), \"consulPort can't be empty\");\n+        return this;\n+    }\n+\n+    protected ConsulClientBuilder consulPort(int consulPort) {\n+        checkArgument(consulPort > 0, \"consulPort can't be zero or negative\");\n+        this.consulPort = consulPort;\n+        return this;\n+    }\n+\n+    protected ConsulClientBuilder consulApiVersion(String consulApiVersion) {\n+        this.consulApiVersion = requireNonNull(consulApiVersion, \"consulApiVersion\");\n+        checkArgument(!consulApiVersion.isEmpty(), \"consulApiVersion can't be empty\");\n+        return this;\n+    }\n+\n+    protected ConsulClientBuilder consulToken(String consulToken) {\n+        this.consulToken = requireNonNull(consulToken, \"consulToken\");\n+        checkArgument(!consulToken.isEmpty(), \"consulToken can't be empty\");\n+        return this;\n+    }\n+\n+    protected ConsulClient buildClient() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edf7653201bfa79a371084a683d51ec2263cbc1b"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjY3Mjc1OQ==", "bodyText": "Programatically build looks good. However, some users might want to load a Consul URI from their configuration files such as yml or properties and create this builder the URI string.\nDon't we need to offer consulUri(String) and consulUri(URI)? \ud83e\udd14", "url": "https://github.com/line/armeria/pull/3002#discussion_r482672759", "createdAt": "2020-09-03T02:55:28Z", "author": {"login": "ikhoon"}, "path": "consul/src/test/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupTest.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2016 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.awaitility.Awaitility.await;\n+\n+import java.time.Duration;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulTestBase;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerListener;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListener;\n+\n+public class ConsulEndpointGroupTest extends ConsulTestBase {\n+\n+    static final List<Server> servers = new ArrayList<>();\n+\n+    @BeforeAll\n+    static void startServers() {\n+\n+        for (Endpoint endpoint : sampleEndpoints) {\n+            final Server server = Server.builder()\n+                                        .http(endpoint.port())\n+                                        .service(\"/\", new EchoService())\n+                                        .build();\n+            final ServerListener listener = ConsulUpdatingListener.builder(serviceName)\n+                                                                  .consulProtocol(SessionProtocol.HTTP)\n+                                                                  .consulAddress(consul().getAddress())\n+                                                                  .consulPort(consul().getHttpPort())\n+                                                                  .consulApiVersion(\"v1\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edf7653201bfa79a371084a683d51ec2263cbc1b"}, "originalPosition": 53}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edf7653201bfa79a371084a683d51ec2263cbc1b", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/edf7653201bfa79a371084a683d51ec2263cbc1b", "committedDate": "2020-09-02T14:42:00Z", "message": "Refactor builders using inheritance"}, "afterCommit": {"oid": "db42d873beb45f41e66ee582210675bebaa5f4ec", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/db42d873beb45f41e66ee582210675bebaa5f4ec", "committedDate": "2020-09-03T08:34:10Z", "message": "Refactor builders using inheritance\n\n  - Add consulUri() methods to builders"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db42d873beb45f41e66ee582210675bebaa5f4ec", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/db42d873beb45f41e66ee582210675bebaa5f4ec", "committedDate": "2020-09-03T08:34:10Z", "message": "Refactor builders using inheritance\n\n  - Add consulUri() methods to builders"}, "afterCommit": {"oid": "feebcd5497f9201e9efbf89653be5e0ab1dcf352", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/feebcd5497f9201e9efbf89653be5e0ab1dcf352", "committedDate": "2020-09-03T08:36:05Z", "message": "Refactor builders using inheritance\n\n  - Add consulUri() methods to builders"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNDg0MDQx", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-503484041", "createdAt": "2020-10-07T02:30:59Z", "commit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMjozMDo1OVrOHdgctA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMzowODo0OFrOHdhCLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwMjM4OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param consulProtocol the protocol scheme of Consul API service, default: HTTP\n          \n          \n            \n                 * @param consulProtocol the protocol scheme of Consul API service, default: {@link SessionProtocol#HTTP}", "url": "https://github.com/line/armeria/pull/3002#discussion_r500702388", "createdAt": "2020-10-07T02:30:59Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean flagToPreventConflict;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1\n+     * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1\n+     */\n+    public ConsulClientBuilder consulUri(URI consulUri) {\n+        requireNonNull(consulUri, \"consulUri\");\n+        checkState(!flagToPreventConflict, \"consulUri can't comes with other addressing options\");\n+        this.consulUri = consulUri;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1\n+     * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1\n+     */\n+    public ConsulClientBuilder consulUri(String consulUri) {\n+        return consulUri(URI.create(requireNonNull(consulUri, \"consulUri\")));\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service protocol scheme.\n+     * @param consulProtocol the protocol scheme of Consul API service, default: HTTP", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwMjQ5Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * The URI should include the Consul API version at path, like: /v1\n          \n          \n            \n                 * The URI should include the Consul API version at path, like: {@code /v1}", "url": "https://github.com/line/armeria/pull/3002#discussion_r500702497", "createdAt": "2020-10-07T02:31:25Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean flagToPreventConflict;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1\n+     * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1\n+     */\n+    public ConsulClientBuilder consulUri(URI consulUri) {\n+        requireNonNull(consulUri, \"consulUri\");\n+        checkState(!flagToPreventConflict, \"consulUri can't comes with other addressing options\");\n+        this.consulUri = consulUri;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwMjU1Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1\n          \n          \n            \n                 * @param consulUri the URI of Consul API service, default: http://127.0.0.1:8500/v1", "url": "https://github.com/line/armeria/pull/3002#discussion_r500702557", "createdAt": "2020-10-07T02:31:41Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean flagToPreventConflict;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1\n+     * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1\n+     */\n+    public ConsulClientBuilder consulUri(URI consulUri) {\n+        requireNonNull(consulUri, \"consulUri\");\n+        checkState(!flagToPreventConflict, \"consulUri can't comes with other addressing options\");\n+        this.consulUri = consulUri;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1\n+     * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwMzEzMg==", "bodyText": "Could we raise IllegalArgumentException if consulUri contains an empty or null path?", "url": "https://github.com/line/armeria/pull/3002#discussion_r500703132", "createdAt": "2020-10-07T02:34:18Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean flagToPreventConflict;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1\n+     * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1\n+     */\n+    public ConsulClientBuilder consulUri(URI consulUri) {\n+        requireNonNull(consulUri, \"consulUri\");\n+        checkState(!flagToPreventConflict, \"consulUri can't comes with other addressing options\");\n+        this.consulUri = consulUri;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwMzM4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param consulApiVersion the version of Consul API service, default: v1\n          \n          \n            \n                 * @param consulApiVersion the version of Consul API service, default: {@code v1}", "url": "https://github.com/line/armeria/pull/3002#discussion_r500703381", "createdAt": "2020-10-07T02:35:12Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean flagToPreventConflict;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1\n+     * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1\n+     */\n+    public ConsulClientBuilder consulUri(URI consulUri) {\n+        requireNonNull(consulUri, \"consulUri\");\n+        checkState(!flagToPreventConflict, \"consulUri can't comes with other addressing options\");\n+        this.consulUri = consulUri;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1\n+     * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1\n+     */\n+    public ConsulClientBuilder consulUri(String consulUri) {\n+        return consulUri(URI.create(requireNonNull(consulUri, \"consulUri\")));\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service protocol scheme.\n+     * @param consulProtocol the protocol scheme of Consul API service, default: HTTP\n+     */\n+    public ConsulClientBuilder consulProtocol(SessionProtocol consulProtocol) {\n+        requireNonNull(consulProtocol, \"consulProtocol\");\n+        checkState(consulUri == null, \"consulProtocol can't comes with consulUri\");\n+        this.consulProtocol = consulProtocol;\n+        flagToPreventConflict = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service host address.\n+     * @param consulAddress the host address of Consul API service, default: 127.0.0.1\n+     */\n+    public ConsulClientBuilder consulAddress(String consulAddress) {\n+        requireNonNull(consulAddress, \"consulAddress\");\n+        checkArgument(!consulAddress.isEmpty(), \"consulAddress can't be empty\");\n+        checkState(consulUri == null, \"consulAddress can't comes with consulUri\");\n+        this.consulAddress = consulAddress;\n+        flagToPreventConflict = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's HTTP service port.\n+     * @param consulPort the port of Consul agent, default: 8500\n+     */\n+    public ConsulClientBuilder consulPort(int consulPort) {\n+        checkArgument(consulPort > 0, \"consulPort can't be zero or negative\");\n+        checkState(consulUri == null, \"consulPort can't comes with consulUri\");\n+        this.consulPort = consulPort;\n+        flagToPreventConflict = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API version.\n+     * @param consulApiVersion the version of Consul API service, default: v1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwMzczNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @param consulToken the token for accessing Consul API, default: null\n          \n          \n            \n                 * @param consulToken the token for accessing Consul API, default: {@code null}", "url": "https://github.com/line/armeria/pull/3002#discussion_r500703736", "createdAt": "2020-10-07T02:36:31Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean flagToPreventConflict;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1\n+     * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1\n+     */\n+    public ConsulClientBuilder consulUri(URI consulUri) {\n+        requireNonNull(consulUri, \"consulUri\");\n+        checkState(!flagToPreventConflict, \"consulUri can't comes with other addressing options\");\n+        this.consulUri = consulUri;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1\n+     * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1\n+     */\n+    public ConsulClientBuilder consulUri(String consulUri) {\n+        return consulUri(URI.create(requireNonNull(consulUri, \"consulUri\")));\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service protocol scheme.\n+     * @param consulProtocol the protocol scheme of Consul API service, default: HTTP\n+     */\n+    public ConsulClientBuilder consulProtocol(SessionProtocol consulProtocol) {\n+        requireNonNull(consulProtocol, \"consulProtocol\");\n+        checkState(consulUri == null, \"consulProtocol can't comes with consulUri\");\n+        this.consulProtocol = consulProtocol;\n+        flagToPreventConflict = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service host address.\n+     * @param consulAddress the host address of Consul API service, default: 127.0.0.1\n+     */\n+    public ConsulClientBuilder consulAddress(String consulAddress) {\n+        requireNonNull(consulAddress, \"consulAddress\");\n+        checkArgument(!consulAddress.isEmpty(), \"consulAddress can't be empty\");\n+        checkState(consulUri == null, \"consulAddress can't comes with consulUri\");\n+        this.consulAddress = consulAddress;\n+        flagToPreventConflict = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's HTTP service port.\n+     * @param consulPort the port of Consul agent, default: 8500\n+     */\n+    public ConsulClientBuilder consulPort(int consulPort) {\n+        checkArgument(consulPort > 0, \"consulPort can't be zero or negative\");\n+        checkState(consulUri == null, \"consulPort can't comes with consulUri\");\n+        this.consulPort = consulPort;\n+        flagToPreventConflict = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API version.\n+     * @param consulApiVersion the version of Consul API service, default: v1\n+     */\n+    public ConsulClientBuilder consulApiVersion(String consulApiVersion) {\n+        requireNonNull(consulApiVersion, \"consulApiVersion\");\n+        checkArgument(!consulApiVersion.isEmpty(), \"consulApiVersion can't be empty\");\n+        checkState(consulUri == null, \"consulApiVersion can't comes with consulUri\");\n+        this.consulApiVersion = consulApiVersion;\n+        flagToPreventConflict = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified token for Consul's API.\n+     * @param consulToken the token for accessing Consul API, default: null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwNDQxNw==", "bodyText": "How about isUriComponentSet?", "url": "https://github.com/line/armeria/pull/3002#discussion_r500704417", "createdAt": "2020-10-07T02:39:30Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean flagToPreventConflict;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwNTc1MQ==", "bodyText": "Could be removed the duplicate he interval between fetching registry requests.?", "url": "https://github.com/line/armeria/pull/3002#discussion_r500705751", "createdAt": "2020-10-07T02:44:52Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupBuilder.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListenerBuilder;\n+\n+/**\n+ * A builder class for {@link ConsulEndpointGroup}.\n+ */\n+public final class ConsulEndpointGroupBuilder extends ConsulClientBuilder {\n+    private static final long DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS = 10;\n+\n+    private final String serviceName;\n+    private long registryFetchIntervalSeconds = DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS;\n+    private boolean useHealthyEndpoints;\n+\n+    ConsulEndpointGroupBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulUri(URI consulUri) {\n+        return (ConsulEndpointGroupBuilder) super.consulUri(consulUri);\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulUri(String consulUri) {\n+        return (ConsulEndpointGroupBuilder) super.consulUri(consulUri);\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulProtocol(SessionProtocol consulProtocol) {\n+        return (ConsulEndpointGroupBuilder) super.consulProtocol(consulProtocol);\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulAddress(String consulAddress) {\n+        return (ConsulEndpointGroupBuilder) super.consulAddress(consulAddress);\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulPort(int consulPort) {\n+        return (ConsulEndpointGroupBuilder) super.consulPort(consulPort);\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulApiVersion(String consulApiVersion) {\n+        return (ConsulEndpointGroupBuilder) super.consulApiVersion(consulApiVersion);\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulToken(String consulToken) {\n+        return (ConsulEndpointGroupBuilder) super.consulToken(consulToken);\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.\n+     * If not set, {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.\n+     */\n+    public ConsulEndpointGroupBuilder registryFetchInterval(Duration registryFetchInterval) {\n+        requireNonNull(registryFetchInterval, \"registryFetchInterval\");\n+        final long seconds = registryFetchInterval.getSeconds();\n+        checkArgument(seconds > 0, \"registryFetchInterval.getSeconds(): %s (expected: > 0)\", seconds);\n+        return registryFetchIntervalSeconds(seconds);\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.he interval between fetching registry requests.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwNzYxOA==", "bodyText": "This function could be a static method. Could you make this function static?\nFor example:\nprivate static Endpoint convertToEndpoint(Node node) {\n    ...\n}\n\n...\nnodes.stream().map(CatalogClient::convertToEndpoint)", "url": "https://github.com/line/armeria/pull/3002#discussion_r500707618", "createdAt": "2020-10-07T02:52:13Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/CatalogClient.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.function.Function;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.type.CollectionType;\n+import com.fasterxml.jackson.databind.type.TypeFactory;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Strings;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.util.Exceptions;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/catalog.html\">Catalog HTTP API</a>.\n+ */\n+final class CatalogClient {\n+\n+    private static final CollectionType collectionTypeForNode =\n+            TypeFactory.defaultInstance().constructCollectionType(List.class, Node.class);\n+\n+    static CatalogClient of(ConsulClient consulClient) {\n+        return new CatalogClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private CatalogClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Gets endpoint list with service name.\n+     */\n+    CompletableFuture<List<Endpoint>> endpoints(String serviceName) {\n+        requireNonNull(serviceName, \"serviceName\");\n+        return service(serviceName)\n+                .thenApply(nodes -> {\n+                    final Function<Node, Endpoint> nodeEndpointFunction = node -> {\n+                        final String host;\n+                        if (!Strings.isNullOrEmpty(node.serviceAddress)) {\n+                            host = node.serviceAddress;\n+                        } else if (!Strings.isNullOrEmpty(node.address)) {\n+                            host = node.address;\n+                        } else {\n+                            host = \"127.0.0.1\";\n+                        }\n+                        return Endpoint.of(host, node.servicePort);\n+                    };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwODgzNg==", "bodyText": "How about prepending '/' only if consulApiVersion does not start with /?", "url": "https://github.com/line/armeria/pull/3002#discussion_r500708836", "createdAt": "2020-10-07T02:56:43Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,144 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean flagToPreventConflict;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1\n+     * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1\n+     */\n+    public ConsulClientBuilder consulUri(URI consulUri) {\n+        requireNonNull(consulUri, \"consulUri\");\n+        checkState(!flagToPreventConflict, \"consulUri can't comes with other addressing options\");\n+        this.consulUri = consulUri;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: /v1\n+     * @param consulUri the URI of Consul API service, default: HTTP://127.0.0.1:8500/v1\n+     */\n+    public ConsulClientBuilder consulUri(String consulUri) {\n+        return consulUri(URI.create(requireNonNull(consulUri, \"consulUri\")));\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service protocol scheme.\n+     * @param consulProtocol the protocol scheme of Consul API service, default: HTTP\n+     */\n+    public ConsulClientBuilder consulProtocol(SessionProtocol consulProtocol) {\n+        requireNonNull(consulProtocol, \"consulProtocol\");\n+        checkState(consulUri == null, \"consulProtocol can't comes with consulUri\");\n+        this.consulProtocol = consulProtocol;\n+        flagToPreventConflict = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service host address.\n+     * @param consulAddress the host address of Consul API service, default: 127.0.0.1\n+     */\n+    public ConsulClientBuilder consulAddress(String consulAddress) {\n+        requireNonNull(consulAddress, \"consulAddress\");\n+        checkArgument(!consulAddress.isEmpty(), \"consulAddress can't be empty\");\n+        checkState(consulUri == null, \"consulAddress can't comes with consulUri\");\n+        this.consulAddress = consulAddress;\n+        flagToPreventConflict = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's HTTP service port.\n+     * @param consulPort the port of Consul agent, default: 8500\n+     */\n+    public ConsulClientBuilder consulPort(int consulPort) {\n+        checkArgument(consulPort > 0, \"consulPort can't be zero or negative\");\n+        checkState(consulUri == null, \"consulPort can't comes with consulUri\");\n+        this.consulPort = consulPort;\n+        flagToPreventConflict = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API version.\n+     * @param consulApiVersion the version of Consul API service, default: v1\n+     */\n+    public ConsulClientBuilder consulApiVersion(String consulApiVersion) {\n+        requireNonNull(consulApiVersion, \"consulApiVersion\");\n+        checkArgument(!consulApiVersion.isEmpty(), \"consulApiVersion can't be empty\");\n+        checkState(consulUri == null, \"consulApiVersion can't comes with consulUri\");\n+        this.consulApiVersion = consulApiVersion;\n+        flagToPreventConflict = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified token for Consul's API.\n+     * @param consulToken the token for accessing Consul API, default: null\n+     */\n+    public ConsulClientBuilder consulToken(String consulToken) {\n+        requireNonNull(consulToken, \"consulToken\");\n+        checkArgument(!consulToken.isEmpty(), \"consulToken can't be empty\");\n+        this.consulToken = consulToken;\n+        return this;\n+    }\n+\n+    protected final ConsulClient buildClient() {\n+        final URI uri;\n+        if (consulUri != null) {\n+            uri = consulUri;\n+        } else {\n+            try {\n+                uri = new URI(consulProtocol.uriText(), null, consulAddress, consulPort,\n+                              '/' + consulApiVersion, null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcxMTE1Mw==", "bodyText": "For consistency with other Javadoc of service discovery\nServerBuilder sb = Server.builder();\nsb.serverListener(listener);", "url": "https://github.com/line/armeria/pull/3002#discussion_r500711153", "createdAt": "2020-10-07T03:05:16Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/ConsulUpdatingListenerBuilder.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.consul;\n+\n+import static com.google.common.base.MoreObjects.firstNonNull;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Builds a new {@link ConsulUpdatingListener}, which registers the server to Consul cluster.\n+ * <h3>Examples</h3>\n+ * <pre>{@code\n+ * ConsulUpdatingListener listener = ConsulUpdatingListener.builder(\"myService\")\n+ *                                                         .consulPort(8501\")\n+ *                                                         .build();\n+ * server.addListener(listener);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcxMTU4Nw==", "bodyText": "Could you move these methods overridden only return type to the bottom of this class?", "url": "https://github.com/line/armeria/pull/3002#discussion_r500711587", "createdAt": "2020-10-07T03:07:04Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/ConsulUpdatingListenerBuilder.java", "diffHunk": "@@ -0,0 +1,188 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.consul;\n+\n+import static com.google.common.base.MoreObjects.firstNonNull;\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Builds a new {@link ConsulUpdatingListener}, which registers the server to Consul cluster.\n+ * <h3>Examples</h3>\n+ * <pre>{@code\n+ * ConsulUpdatingListener listener = ConsulUpdatingListener.builder(\"myService\")\n+ *                                                         .consulPort(8501\")\n+ *                                                         .build();\n+ * server.addListener(listener);\n+ * }</pre>\n+ */\n+public final class ConsulUpdatingListenerBuilder extends ConsulClientBuilder {\n+\n+    private static final String DEFAULT_CHECK_INTERVAL = \"10s\";\n+    private final String serviceName;\n+\n+    @Nullable\n+    private Endpoint serviceEndpoint;\n+    @Nullable\n+    private URI checkUri;\n+    @Nullable\n+    private String checkInterval;\n+    @Nullable\n+    private HttpMethod checkMethod;\n+\n+    /**\n+     * Creates a {@link ConsulUpdatingListenerBuilder} with a service name.\n+     *\n+     * @param serviceName the service name to register\n+     */\n+    ConsulUpdatingListenerBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+        checkArgument(!this.serviceName.isEmpty(), \"serviceName can't be empty\");\n+    }\n+\n+    @Override\n+    public ConsulUpdatingListenerBuilder consulUri(URI consulUri) {\n+        return (ConsulUpdatingListenerBuilder) super.consulUri(consulUri);\n+    }\n+\n+    @Override\n+    public ConsulUpdatingListenerBuilder consulUri(String consulUri) {\n+        return (ConsulUpdatingListenerBuilder) super.consulUri(consulUri);\n+    }\n+\n+    @Override\n+    public ConsulUpdatingListenerBuilder consulProtocol(SessionProtocol consulProtocol) {\n+        return (ConsulUpdatingListenerBuilder) super.consulProtocol(consulProtocol);\n+    }\n+\n+    @Override\n+    public ConsulUpdatingListenerBuilder consulAddress(String consulAddress) {\n+        return (ConsulUpdatingListenerBuilder) super.consulAddress(consulAddress);\n+    }\n+\n+    @Override\n+    public ConsulUpdatingListenerBuilder consulPort(int consulPort) {\n+        return (ConsulUpdatingListenerBuilder) super.consulPort(consulPort);\n+    }\n+\n+    @Override\n+    public ConsulUpdatingListenerBuilder consulApiVersion(String consulApiVersion) {\n+        return (ConsulUpdatingListenerBuilder) super.consulApiVersion(consulApiVersion);\n+    }\n+\n+    @Override\n+    public ConsulUpdatingListenerBuilder consulToken(String consulToken) {\n+        return (ConsulUpdatingListenerBuilder) super.consulToken(consulToken);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcxMTk4Mw==", "bodyText": "Could you move these methods overridden only return type to the bottom of this class?", "url": "https://github.com/line/armeria/pull/3002#discussion_r500711983", "createdAt": "2020-10-07T03:08:48Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupBuilder.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListenerBuilder;\n+\n+/**\n+ * A builder class for {@link ConsulEndpointGroup}.\n+ */\n+public final class ConsulEndpointGroupBuilder extends ConsulClientBuilder {\n+    private static final long DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS = 10;\n+\n+    private final String serviceName;\n+    private long registryFetchIntervalSeconds = DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS;\n+    private boolean useHealthyEndpoints;\n+\n+    ConsulEndpointGroupBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulUri(URI consulUri) {\n+        return (ConsulEndpointGroupBuilder) super.consulUri(consulUri);\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulUri(String consulUri) {\n+        return (ConsulEndpointGroupBuilder) super.consulUri(consulUri);\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulProtocol(SessionProtocol consulProtocol) {\n+        return (ConsulEndpointGroupBuilder) super.consulProtocol(consulProtocol);\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulAddress(String consulAddress) {\n+        return (ConsulEndpointGroupBuilder) super.consulAddress(consulAddress);\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulPort(int consulPort) {\n+        return (ConsulEndpointGroupBuilder) super.consulPort(consulPort);\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulApiVersion(String consulApiVersion) {\n+        return (ConsulEndpointGroupBuilder) super.consulApiVersion(consulApiVersion);\n+    }\n+\n+    @Override\n+    public ConsulEndpointGroupBuilder consulToken(String consulToken) {\n+        return (ConsulEndpointGroupBuilder) super.consulToken(consulToken);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "659a1856dfb1e535a1805db7a529c0ca531d83c1"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTczODk1", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-504573895", "createdAt": "2020-10-08T09:03:25Z", "commit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOTowMzoyNlrOHeU3rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOTowNzo0MlrOHeVCcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2MTI2Mg==", "bodyText": "How about replacing the default value (/v1) in Javadoc with v1 for reducing confusion.", "url": "https://github.com/line/armeria/pull/3002#discussion_r501561262", "createdAt": "2020-10-08T09:03:26Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.Strings;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean isUriComponentSet;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: {@code /v1}\n+     * @param consulUri the URI of Consul API service, default: {@code http://127.0.0.1:8500/v1}\n+     */\n+    public ConsulClientBuilder consulUri(URI consulUri) {\n+        checkState(!isUriComponentSet, \"consulUri can't comes with other addressing options\");\n+        requireNonNull(consulUri, \"consulUri\");\n+        final String path = consulUri.getPath();\n+        checkArgument(!Strings.isNullOrEmpty(path) && !\"/\".equals(path),\n+                      \"consulUri has to contain version path\");\n+        this.consulUri = consulUri;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: {@code /v1}\n+     * @param consulUri the URI of Consul API service, default: {@code http://127.0.0.1:8500/v1}\n+     */\n+    public ConsulClientBuilder consulUri(String consulUri) {\n+        return consulUri(URI.create(requireNonNull(consulUri, \"consulUri\")));\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service protocol scheme.\n+     * @param consulProtocol the protocol scheme of Consul API service, default: {@link SessionProtocol#HTTP}\n+     */\n+    public ConsulClientBuilder consulProtocol(SessionProtocol consulProtocol) {\n+        checkState(consulUri == null, \"consulProtocol can't comes with consulUri\");\n+        requireNonNull(consulProtocol, \"consulProtocol\");\n+        this.consulProtocol = consulProtocol;\n+        isUriComponentSet = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service host address.\n+     * @param consulAddress the host address of Consul API service, default: {@code 127.0.0.1}\n+     */\n+    public ConsulClientBuilder consulAddress(String consulAddress) {\n+        checkState(consulUri == null, \"consulAddress can't comes with consulUri\");\n+        requireNonNull(consulAddress, \"consulAddress\");\n+        checkArgument(!consulAddress.isEmpty(), \"consulAddress can't be empty\");\n+        this.consulAddress = consulAddress;\n+        isUriComponentSet = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's HTTP service port.\n+     * @param consulPort the port of Consul agent, default: {@code 8500}\n+     */\n+    public ConsulClientBuilder consulPort(int consulPort) {\n+        checkState(consulUri == null, \"consulPort can't comes with consulUri\");\n+        checkArgument(consulPort > 0, \"consulPort can't be zero or negative\");\n+        this.consulPort = consulPort;\n+        isUriComponentSet = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API version.\n+     * @param consulApiVersion the version of Consul API service, default: {@code /v1}\n+     */\n+    public ConsulClientBuilder consulApiVersion(String consulApiVersion) {\n+        checkState(consulUri == null, \"consulApiVersion can't comes with consulUri\");\n+        requireNonNull(consulApiVersion, \"consulApiVersion\");\n+        checkArgument(!consulApiVersion.isEmpty(), \"consulApiVersion can't be empty\");\n+        checkArgument(consulApiVersion.charAt(0) != '/',\n+                      \"consulApiVersion can't starts with '/'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2NDAxOA==", "bodyText": "Sorry, I missed the default values defined in this class.\nCould we use {@value ...} expression where possible. e.g. {@value #DEFAULT_CONSUL_ADDRESS}", "url": "https://github.com/line/armeria/pull/3002#discussion_r501564018", "createdAt": "2020-10-08T09:07:42Z", "author": {"login": "ikhoon"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.Strings;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean isUriComponentSet;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: {@code /v1}\n+     * @param consulUri the URI of Consul API service, default: {@code http://127.0.0.1:8500/v1}\n+     */\n+    public ConsulClientBuilder consulUri(URI consulUri) {\n+        checkState(!isUriComponentSet, \"consulUri can't comes with other addressing options\");\n+        requireNonNull(consulUri, \"consulUri\");\n+        final String path = consulUri.getPath();\n+        checkArgument(!Strings.isNullOrEmpty(path) && !\"/\".equals(path),\n+                      \"consulUri has to contain version path\");\n+        this.consulUri = consulUri;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: {@code /v1}\n+     * @param consulUri the URI of Consul API service, default: {@code http://127.0.0.1:8500/v1}\n+     */\n+    public ConsulClientBuilder consulUri(String consulUri) {\n+        return consulUri(URI.create(requireNonNull(consulUri, \"consulUri\")));\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service protocol scheme.\n+     * @param consulProtocol the protocol scheme of Consul API service, default: {@link SessionProtocol#HTTP}\n+     */\n+    public ConsulClientBuilder consulProtocol(SessionProtocol consulProtocol) {\n+        checkState(consulUri == null, \"consulProtocol can't comes with consulUri\");\n+        requireNonNull(consulProtocol, \"consulProtocol\");\n+        this.consulProtocol = consulProtocol;\n+        isUriComponentSet = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service host address.\n+     * @param consulAddress the host address of Consul API service, default: {@code 127.0.0.1}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTYyNzM5", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-504562739", "createdAt": "2020-10-08T08:50:53Z", "commit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "state": "COMMENTED", "comments": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODo1MDo1M1rOHeUXyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOToyNTozOFrOHeVt_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1MzA5OQ==", "bodyText": "How about: a local Consul agent at the default Consul service port.?", "url": "https://github.com/line/armeria/pull/3002#discussion_r501553099", "createdAt": "2020-10-08T08:50:53Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroup.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.ClientRequestContextCaptor;\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.endpoint.DynamicEndpointGroup;\n+import com.linecorp.armeria.client.endpoint.EndpointGroup;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+\n+import io.netty.channel.EventLoop;\n+\n+/**\n+ * A Consul-based {@link EndpointGroup} implementation that retrieves the list of {@link Endpoint}s\n+ * from Consul using <a href=\"https://www.consul.io/api\">Consul's RESTful HTTP API</a> and\n+ * updates the {@link Endpoint}s periodically.\n+ */\n+public final class ConsulEndpointGroup extends DynamicEndpointGroup {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ConsulEndpointGroup.class);\n+\n+    /**\n+     * Returns a {@link ConsulEndpointGroup} with the specified {@code serviceName}.\n+     * The returned {@link ConsulEndpointGroup} will retrieve the list of {@link Endpoint}s from\n+     * a local Consul agent(using default Consul service port).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1Nzk4MQ==", "bodyText": "nit: {}. -> {}", "url": "https://github.com/line/armeria/pull/3002#discussion_r501557981", "createdAt": "2020-10-08T08:58:25Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroup.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.ClientRequestContextCaptor;\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.endpoint.DynamicEndpointGroup;\n+import com.linecorp.armeria.client.endpoint.EndpointGroup;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+\n+import io.netty.channel.EventLoop;\n+\n+/**\n+ * A Consul-based {@link EndpointGroup} implementation that retrieves the list of {@link Endpoint}s\n+ * from Consul using <a href=\"https://www.consul.io/api\">Consul's RESTful HTTP API</a> and\n+ * updates the {@link Endpoint}s periodically.\n+ */\n+public final class ConsulEndpointGroup extends DynamicEndpointGroup {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ConsulEndpointGroup.class);\n+\n+    /**\n+     * Returns a {@link ConsulEndpointGroup} with the specified {@code serviceName}.\n+     * The returned {@link ConsulEndpointGroup} will retrieve the list of {@link Endpoint}s from\n+     * a local Consul agent(using default Consul service port).\n+     */\n+    public static ConsulEndpointGroup of(String serviceName) {\n+        return builder(serviceName).build();\n+    }\n+\n+    /**\n+     * Returns a newly-created {@link ConsulEndpointGroupBuilder} with the specified {@code serviceName}.\n+     */\n+    public static ConsulEndpointGroupBuilder builder(String serviceName) {\n+        return new ConsulEndpointGroupBuilder(serviceName);\n+    }\n+\n+    private final ConsulClient consulClient;\n+    private final String serviceName;\n+    private final long registryFetchIntervalSeconds;\n+    private final boolean useHealthyEndpoints;\n+\n+    @Nullable\n+    private volatile ScheduledFuture<?> scheduledFuture;\n+\n+    ConsulEndpointGroup(ConsulClient consulClient, String serviceName, long registryFetchIntervalSeconds,\n+                        boolean useHealthyEndpoints) {\n+        this.consulClient = requireNonNull(consulClient, \"consulClient\");\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+        this.registryFetchIntervalSeconds = registryFetchIntervalSeconds;\n+        this.useHealthyEndpoints = useHealthyEndpoints;\n+\n+        update();\n+    }\n+\n+    private void update() {\n+        if (isClosing()) {\n+            return;\n+        }\n+\n+        final CompletableFuture<List<Endpoint>> response;\n+        final EventLoop eventLoop;\n+        try (ClientRequestContextCaptor captor = Clients.newContextCaptor()) {\n+            if (useHealthyEndpoints) {\n+                response = consulClient.healthyEndpoints(serviceName);\n+            } else {\n+                response = consulClient.endpoints(serviceName);\n+            }\n+            eventLoop = captor.get().eventLoop().withoutContext();\n+        }\n+\n+        response.handle((endpoints, cause) -> {\n+            if (isClosing()) {\n+                return null;\n+            }\n+            if (cause != null) {\n+                logger.warn(\"Unexpected exception while fetching the registry from: {}.\" +\n+                            \" (serviceName: {})\", consulClient.uri(), serviceName, cause);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1OTUxOQ==", "bodyText": "Could we keep the interval in milliseconds internally? A user may want to check service health at sub-second frequency.", "url": "https://github.com/line/armeria/pull/3002#discussion_r501559519", "createdAt": "2020-10-08T09:00:41Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupBuilder.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListenerBuilder;\n+\n+/**\n+ * A builder class for {@link ConsulEndpointGroup}.\n+ */\n+public final class ConsulEndpointGroupBuilder extends ConsulClientBuilder {\n+    private static final long DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS = 10;\n+\n+    private final String serviceName;\n+    private long registryFetchIntervalSeconds = DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS;\n+    private boolean useHealthyEndpoints;\n+\n+    ConsulEndpointGroupBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.\n+     * If not set, {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.\n+     */\n+    public ConsulEndpointGroupBuilder registryFetchInterval(Duration registryFetchInterval) {\n+        requireNonNull(registryFetchInterval, \"registryFetchInterval\");\n+        final long seconds = registryFetchInterval.getSeconds();\n+        checkArgument(seconds > 0, \"registryFetchInterval.getSeconds(): %s (expected: > 0)\", seconds);\n+        return registryFetchIntervalSeconds(seconds);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU1OTkyNQ==", "bodyText": "requests. -> requests, in milliseconds.", "url": "https://github.com/line/armeria/pull/3002#discussion_r501559925", "createdAt": "2020-10-08T09:01:20Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupBuilder.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListenerBuilder;\n+\n+/**\n+ * A builder class for {@link ConsulEndpointGroup}.\n+ */\n+public final class ConsulEndpointGroupBuilder extends ConsulClientBuilder {\n+    private static final long DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS = 10;\n+\n+    private final String serviceName;\n+    private long registryFetchIntervalSeconds = DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS;\n+    private boolean useHealthyEndpoints;\n+\n+    ConsulEndpointGroupBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.\n+     * If not set, {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.\n+     */\n+    public ConsulEndpointGroupBuilder registryFetchInterval(Duration registryFetchInterval) {\n+        requireNonNull(registryFetchInterval, \"registryFetchInterval\");\n+        final long seconds = registryFetchInterval.getSeconds();\n+        checkArgument(seconds > 0, \"registryFetchInterval.getSeconds(): %s (expected: > 0)\", seconds);\n+        return registryFetchIntervalSeconds(seconds);\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2MDExNg==", "bodyText": "If not set,", "url": "https://github.com/line/armeria/pull/3002#discussion_r501560116", "createdAt": "2020-10-08T09:01:37Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupBuilder.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListenerBuilder;\n+\n+/**\n+ * A builder class for {@link ConsulEndpointGroup}.\n+ */\n+public final class ConsulEndpointGroupBuilder extends ConsulClientBuilder {\n+    private static final long DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS = 10;\n+\n+    private final String serviceName;\n+    private long registryFetchIntervalSeconds = DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS;\n+    private boolean useHealthyEndpoints;\n+\n+    ConsulEndpointGroupBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.\n+     * If not set, {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.\n+     */\n+    public ConsulEndpointGroupBuilder registryFetchInterval(Duration registryFetchInterval) {\n+        requireNonNull(registryFetchInterval, \"registryFetchInterval\");\n+        final long seconds = registryFetchInterval.getSeconds();\n+        checkArgument(seconds > 0, \"registryFetchInterval.getSeconds(): %s (expected: > 0)\", seconds);\n+        return registryFetchIntervalSeconds(seconds);\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.\n+     * If not set {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2MDgwNQ==", "bodyText": "Is there any reason why we are not using milliseconds here? It looks to me like we have control over the granularity of the interval.", "url": "https://github.com/line/armeria/pull/3002#discussion_r501560805", "createdAt": "2020-10-08T09:02:41Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupBuilder.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListenerBuilder;\n+\n+/**\n+ * A builder class for {@link ConsulEndpointGroup}.\n+ */\n+public final class ConsulEndpointGroupBuilder extends ConsulClientBuilder {\n+    private static final long DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS = 10;\n+\n+    private final String serviceName;\n+    private long registryFetchIntervalSeconds = DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS;\n+    private boolean useHealthyEndpoints;\n+\n+    ConsulEndpointGroupBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.\n+     * If not set, {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.\n+     */\n+    public ConsulEndpointGroupBuilder registryFetchInterval(Duration registryFetchInterval) {\n+        requireNonNull(registryFetchInterval, \"registryFetchInterval\");\n+        final long seconds = registryFetchInterval.getSeconds();\n+        checkArgument(seconds > 0, \"registryFetchInterval.getSeconds(): %s (expected: > 0)\", seconds);\n+        return registryFetchIntervalSeconds(seconds);\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.\n+     * If not set {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.\n+     */\n+    public ConsulEndpointGroupBuilder registryFetchIntervalSeconds(long registryFetchIntervalSeconds) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2MTM1Nw==", "bodyText": "Make sure ... by Consul before enabling this feature.", "url": "https://github.com/line/armeria/pull/3002#discussion_r501561357", "createdAt": "2020-10-08T09:03:35Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupBuilder.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListenerBuilder;\n+\n+/**\n+ * A builder class for {@link ConsulEndpointGroup}.\n+ */\n+public final class ConsulEndpointGroupBuilder extends ConsulClientBuilder {\n+    private static final long DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS = 10;\n+\n+    private final String serviceName;\n+    private long registryFetchIntervalSeconds = DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS;\n+    private boolean useHealthyEndpoints;\n+\n+    ConsulEndpointGroupBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.\n+     * If not set, {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.\n+     */\n+    public ConsulEndpointGroupBuilder registryFetchInterval(Duration registryFetchInterval) {\n+        requireNonNull(registryFetchInterval, \"registryFetchInterval\");\n+        final long seconds = registryFetchInterval.getSeconds();\n+        checkArgument(seconds > 0, \"registryFetchInterval.getSeconds(): %s (expected: > 0)\", seconds);\n+        return registryFetchIntervalSeconds(seconds);\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.\n+     * If not set {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.\n+     */\n+    public ConsulEndpointGroupBuilder registryFetchIntervalSeconds(long registryFetchIntervalSeconds) {\n+        checkArgument(registryFetchIntervalSeconds > 0, \"registryFetchIntervalSeconds: %s (expected: > 0)\",\n+                      registryFetchIntervalSeconds);\n+        this.registryFetchIntervalSeconds = registryFetchIntervalSeconds;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets whether to use <a href=\"https://www.consul.io/api/health.html\">Health HTTP endpoint</a>.\n+     * Before enabling this feature, make sure that your target endpoints are health-checked by Consul.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2MTY2MA==", "bodyText": "Please move this method after all chaining methods for consistency with other builder classes.", "url": "https://github.com/line/armeria/pull/3002#discussion_r501561660", "createdAt": "2020-10-08T09:04:06Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupBuilder.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListenerBuilder;\n+\n+/**\n+ * A builder class for {@link ConsulEndpointGroup}.\n+ */\n+public final class ConsulEndpointGroupBuilder extends ConsulClientBuilder {\n+    private static final long DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS = 10;\n+\n+    private final String serviceName;\n+    private long registryFetchIntervalSeconds = DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS;\n+    private boolean useHealthyEndpoints;\n+\n+    ConsulEndpointGroupBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.\n+     * If not set, {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.\n+     */\n+    public ConsulEndpointGroupBuilder registryFetchInterval(Duration registryFetchInterval) {\n+        requireNonNull(registryFetchInterval, \"registryFetchInterval\");\n+        final long seconds = registryFetchInterval.getSeconds();\n+        checkArgument(seconds > 0, \"registryFetchInterval.getSeconds(): %s (expected: > 0)\", seconds);\n+        return registryFetchIntervalSeconds(seconds);\n+    }\n+\n+    /**\n+     * Sets the interval between fetching registry requests.\n+     * If not set {@value #DEFAULT_HEALTH_CHECK_INTERVAL_SECONDS} is used by default.\n+     */\n+    public ConsulEndpointGroupBuilder registryFetchIntervalSeconds(long registryFetchIntervalSeconds) {\n+        checkArgument(registryFetchIntervalSeconds > 0, \"registryFetchIntervalSeconds: %s (expected: > 0)\",\n+                      registryFetchIntervalSeconds);\n+        this.registryFetchIntervalSeconds = registryFetchIntervalSeconds;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets whether to use <a href=\"https://www.consul.io/api/health.html\">Health HTTP endpoint</a>.\n+     * Before enabling this feature, make sure that your target endpoints are health-checked by Consul.\n+     *\n+     * @see ConsulUpdatingListenerBuilder#checkUri(URI)\n+     */\n+    public ConsulEndpointGroupBuilder useHealthEndpoints(boolean useHealthyEndpoints) {\n+        this.useHealthyEndpoints = useHealthyEndpoints;\n+        return this;\n+    }\n+\n+    /**\n+     * Returns a newly-created {@link ConsulEndpointGroup}.\n+     */\n+    public ConsulEndpointGroup build() {\n+        return new ConsulEndpointGroup(buildClient(), serviceName, registryFetchIntervalSeconds,\n+                                       useHealthyEndpoints);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2MzYwOQ==", "bodyText": "No URI encoding?", "url": "https://github.com/line/armeria/pull/3002#discussion_r501563609", "createdAt": "2020-10-08T09:06:59Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/AgentServiceClient.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/agent/service.html\">Agent HTTP API</a>.\n+ */\n+final class AgentServiceClient {\n+\n+    static AgentServiceClient of(ConsulClient consulClient) {\n+        return new AgentServiceClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private AgentServiceClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Registers a service into the Consul agent.\n+     */\n+    HttpResponse register(String serviceId, String serviceName, String address, int port,\n+                          @Nullable Check check) {\n+        final Service service = new Service(serviceId, serviceName, address, port, check);\n+        try {\n+            return client.put(\"/agent/service/register\", mapper.writeValueAsString(service));\n+        } catch (JsonProcessingException e) {\n+            return HttpResponse.ofFailure(e);\n+        }\n+    }\n+\n+    /**\n+     * De-registers a service from the Consul agent.\n+     */\n+    HttpResponse deregister(String serviceId) {\n+        requireNonNull(serviceId, \"serviceId\");\n+        return client.put(\"/agent/service/deregister/\" + serviceId, HttpData.empty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2NDIxNw==", "bodyText": "Ditto - please make sure we do URI encoding for all path components.", "url": "https://github.com/line/armeria/pull/3002#discussion_r501564217", "createdAt": "2020-10-08T09:08:00Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/CatalogClient.java", "diffHunk": "@@ -0,0 +1,198 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.type.CollectionType;\n+import com.fasterxml.jackson.databind.type.TypeFactory;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Strings;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.util.Exceptions;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/catalog.html\">Catalog HTTP API</a>.\n+ */\n+final class CatalogClient {\n+\n+    private static final CollectionType collectionTypeForNode =\n+            TypeFactory.defaultInstance().constructCollectionType(List.class, Node.class);\n+\n+    static CatalogClient of(ConsulClient consulClient) {\n+        return new CatalogClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private CatalogClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Gets endpoint list with service name.\n+     */\n+    CompletableFuture<List<Endpoint>> endpoints(String serviceName) {\n+        requireNonNull(serviceName, \"serviceName\");\n+        return service(serviceName)\n+                .thenApply(nodes -> nodes.stream()\n+                                         .map(CatalogClient::convertToEndpoint)\n+                                         .collect(toImmutableList()));\n+    }\n+\n+    /**\n+     * Returns node list with service name.\n+     */\n+    @VisibleForTesting\n+    CompletableFuture<List<Node>> service(String serviceName) {\n+        requireNonNull(serviceName, \"serviceName\");\n+\n+        return client.get(\"/catalog/service/\" + serviceName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2NTQ0OA==", "bodyText": "Please move before non-static members.", "url": "https://github.com/line/armeria/pull/3002#discussion_r501565448", "createdAt": "2020-10-08T09:10:02Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClient.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.net.URI;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.ClientDecoration;\n+import com.linecorp.armeria.client.ClientOptions;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.WebClientBuilder;\n+import com.linecorp.armeria.client.retry.RetryRule;\n+import com.linecorp.armeria.client.retry.RetryingClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A client for accessing to Consul agent API server.\n+ */\n+public final class ConsulClient {\n+    private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    private static final ClientOptions retryingClientOptions =\n+            ClientOptions.of(ClientOptions.DECORATION.newValue(ClientDecoration.of(\n+                    RetryingClient.newDecorator(RetryRule.failsafe(), 3))));\n+\n+    private final WebClient webClient;\n+    private final AgentServiceClient agentClient;\n+    private final CatalogClient catalogClient;\n+    private final HealthClient healthClient;\n+\n+    public static ConsulClientBuilder builder() {\n+        return new ConsulClientBuilder();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2NjI2Mw==", "bodyText": "Could use HttpHeaderNames.of(\"x-consul-token\") instead. Should keep it as a static final field.", "url": "https://github.com/line/armeria/pull/3002#discussion_r501566263", "createdAt": "2020-10-08T09:11:16Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClient.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.net.URI;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.ClientDecoration;\n+import com.linecorp.armeria.client.ClientOptions;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.WebClientBuilder;\n+import com.linecorp.armeria.client.retry.RetryRule;\n+import com.linecorp.armeria.client.retry.RetryingClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A client for accessing to Consul agent API server.\n+ */\n+public final class ConsulClient {\n+    private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    private static final ClientOptions retryingClientOptions =\n+            ClientOptions.of(ClientOptions.DECORATION.newValue(ClientDecoration.of(\n+                    RetryingClient.newDecorator(RetryRule.failsafe(), 3))));\n+\n+    private final WebClient webClient;\n+    private final AgentServiceClient agentClient;\n+    private final CatalogClient catalogClient;\n+    private final HealthClient healthClient;\n+\n+    public static ConsulClientBuilder builder() {\n+        return new ConsulClientBuilder();\n+    }\n+\n+    ConsulClient(URI uri, @Nullable String token) {\n+        final WebClientBuilder builder = WebClient.builder(uri);\n+        builder.options(retryingClientOptions);\n+        if (token != null) {\n+            // TODO(eugene70) test with token\n+            builder.addHeader(\"X-Consul-Token\", token);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2NjQ3OQ==", "bodyText": "Could we add a test if we did not yet?", "url": "https://github.com/line/armeria/pull/3002#discussion_r501566479", "createdAt": "2020-10-08T09:11:36Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClient.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.net.URI;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.ClientDecoration;\n+import com.linecorp.armeria.client.ClientOptions;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.WebClientBuilder;\n+import com.linecorp.armeria.client.retry.RetryRule;\n+import com.linecorp.armeria.client.retry.RetryingClient;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A client for accessing to Consul agent API server.\n+ */\n+public final class ConsulClient {\n+    private static final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    private static final ClientOptions retryingClientOptions =\n+            ClientOptions.of(ClientOptions.DECORATION.newValue(ClientDecoration.of(\n+                    RetryingClient.newDecorator(RetryRule.failsafe(), 3))));\n+\n+    private final WebClient webClient;\n+    private final AgentServiceClient agentClient;\n+    private final CatalogClient catalogClient;\n+    private final HealthClient healthClient;\n+\n+    public static ConsulClientBuilder builder() {\n+        return new ConsulClientBuilder();\n+    }\n+\n+    ConsulClient(URI uri, @Nullable String token) {\n+        final WebClientBuilder builder = WebClient.builder(uri);\n+        builder.options(retryingClientOptions);\n+        if (token != null) {\n+            // TODO(eugene70) test with token", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2OTE3OQ==", "bodyText": "Could prepend ? here so we don't have to later.", "url": "https://github.com/line/armeria/pull/3002#discussion_r501569179", "createdAt": "2020-10-08T09:15:53Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/HealthClient.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.QueryParams;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/health.html\">Health Endpoint API</a>.\n+ */\n+final class HealthClient {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(HealthClient.class);\n+\n+    private static final String PASSING_PARAM = QueryParams.of(\"passing\", true).toQueryString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2OTI5MQ==", "bodyText": "URI encoding", "url": "https://github.com/line/armeria/pull/3002#discussion_r501569291", "createdAt": "2020-10-08T09:16:05Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/HealthClient.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.QueryParams;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/health.html\">Health Endpoint API</a>.\n+ */\n+final class HealthClient {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(HealthClient.class);\n+\n+    private static final String PASSING_PARAM = QueryParams.of(\"passing\", true).toQueryString();\n+\n+    static HealthClient of(ConsulClient consulClient) {\n+        return new HealthClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private HealthClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Returns a healthy endpoint list with service name.\n+     */\n+    CompletableFuture<List<Endpoint>> healthyEndpoints(String serviceName) {\n+        return client\n+                .get(\"/health/service/\" + serviceName + '?' + PASSING_PARAM)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2OTUyNA==", "bodyText": "{}. -> {}", "url": "https://github.com/line/armeria/pull/3002#discussion_r501569524", "createdAt": "2020-10-08T09:16:25Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/HealthClient.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.QueryParams;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/health.html\">Health Endpoint API</a>.\n+ */\n+final class HealthClient {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(HealthClient.class);\n+\n+    private static final String PASSING_PARAM = QueryParams.of(\"passing\", true).toQueryString();\n+\n+    static HealthClient of(ConsulClient consulClient) {\n+        return new HealthClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private HealthClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Returns a healthy endpoint list with service name.\n+     */\n+    CompletableFuture<List<Endpoint>> healthyEndpoints(String serviceName) {\n+        return client\n+                .get(\"/health/service/\" + serviceName + '?' + PASSING_PARAM)\n+                .aggregate()\n+                .handle((response, cause) -> {\n+                    if (cause != null) {\n+                        logger.warn(\"Unexpected exception while fetching the registry from Consul: {}.\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2OTczNw==", "bodyText": "{}. -> {}", "url": "https://github.com/line/armeria/pull/3002#discussion_r501569737", "createdAt": "2020-10-08T09:16:46Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/HealthClient.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.QueryParams;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/health.html\">Health Endpoint API</a>.\n+ */\n+final class HealthClient {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(HealthClient.class);\n+\n+    private static final String PASSING_PARAM = QueryParams.of(\"passing\", true).toQueryString();\n+\n+    static HealthClient of(ConsulClient consulClient) {\n+        return new HealthClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private HealthClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Returns a healthy endpoint list with service name.\n+     */\n+    CompletableFuture<List<Endpoint>> healthyEndpoints(String serviceName) {\n+        return client\n+                .get(\"/health/service/\" + serviceName + '?' + PASSING_PARAM)\n+                .aggregate()\n+                .handle((response, cause) -> {\n+                    if (cause != null) {\n+                        logger.warn(\"Unexpected exception while fetching the registry from Consul: {}.\" +\n+                                    \" (serviceName: {})\", client.uri(), serviceName,\n+                                    cause);\n+                        return null;\n+                    }\n+\n+                    final HttpStatus status = response.status();\n+                    final String content = response.contentUtf8();\n+                    if (!status.isSuccess()) {\n+                        logger.warn(\"Unexpected response from Consul: {}. (status: {}, content: {}, \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU3MDAyMQ==", "bodyText": "{}. -> {}", "url": "https://github.com/line/armeria/pull/3002#discussion_r501570021", "createdAt": "2020-10-08T09:17:16Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/HealthClient.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.QueryParams;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/health.html\">Health Endpoint API</a>.\n+ */\n+final class HealthClient {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(HealthClient.class);\n+\n+    private static final String PASSING_PARAM = QueryParams.of(\"passing\", true).toQueryString();\n+\n+    static HealthClient of(ConsulClient consulClient) {\n+        return new HealthClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private HealthClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Returns a healthy endpoint list with service name.\n+     */\n+    CompletableFuture<List<Endpoint>> healthyEndpoints(String serviceName) {\n+        return client\n+                .get(\"/health/service/\" + serviceName + '?' + PASSING_PARAM)\n+                .aggregate()\n+                .handle((response, cause) -> {\n+                    if (cause != null) {\n+                        logger.warn(\"Unexpected exception while fetching the registry from Consul: {}.\" +\n+                                    \" (serviceName: {})\", client.uri(), serviceName,\n+                                    cause);\n+                        return null;\n+                    }\n+\n+                    final HttpStatus status = response.status();\n+                    final String content = response.contentUtf8();\n+                    if (!status.isSuccess()) {\n+                        logger.warn(\"Unexpected response from Consul: {}. (status: {}, content: {}, \" +\n+                                    \"serviceName: {})\", client.uri(), status,\n+                                    content, serviceName);\n+                        return null;\n+                    }\n+\n+                    try {\n+                        return Arrays.stream(mapper.readValue(content, HealthService[].class))\n+                                     .map(HealthClient::toEndpoint)\n+                                     .collect(toImmutableList());\n+                    } catch (IOException e) {\n+                        logger.warn(\"Unexpected exception while parsing a response from Consul: {}. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU3MDY2Nw==", "bodyText": "final?", "url": "https://github.com/line/armeria/pull/3002#discussion_r501570667", "createdAt": "2020-10-08T09:18:18Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/ConsulUpdatingListener.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.Inet4Address;\n+import java.net.URI;\n+import java.util.concurrent.ThreadLocalRandom;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.util.SystemInfo;\n+import com.linecorp.armeria.internal.consul.Check;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerListener;\n+import com.linecorp.armeria.server.ServerListenerAdapter;\n+import com.linecorp.armeria.server.ServerPort;\n+\n+/**\n+ * A {@link ServerListener} which registers the current {@link Server} to\n+ * <a href=\"https://www.consul.io\">Consul</a>.\n+ */\n+public class ConsulUpdatingListener extends ServerListenerAdapter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU3MTQwNg==", "bodyText": ".name() because toString() is for human-friendly representation?", "url": "https://github.com/line/armeria/pull/3002#discussion_r501571406", "createdAt": "2020-10-08T09:19:36Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/ConsulUpdatingListener.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.Inet4Address;\n+import java.net.URI;\n+import java.util.concurrent.ThreadLocalRandom;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.util.SystemInfo;\n+import com.linecorp.armeria.internal.consul.Check;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerListener;\n+import com.linecorp.armeria.server.ServerListenerAdapter;\n+import com.linecorp.armeria.server.ServerPort;\n+\n+/**\n+ * A {@link ServerListener} which registers the current {@link Server} to\n+ * <a href=\"https://www.consul.io\">Consul</a>.\n+ */\n+public class ConsulUpdatingListener extends ServerListenerAdapter {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ConsulUpdatingListener.class);\n+\n+    /**\n+     * Returns a {@link ConsulUpdatingListenerBuilder} that builds {@link ConsulUpdatingListener}.\n+     * @param serviceName the service name which is registered into Consul.\n+     */\n+    public static ConsulUpdatingListenerBuilder builder(String serviceName) {\n+        return new ConsulUpdatingListenerBuilder(serviceName);\n+    }\n+\n+    private final ConsulClient consulClient;\n+    private final String serviceName;\n+\n+    @Nullable\n+    private final Endpoint endpoint;\n+    @Nullable\n+    private final Check check;\n+    @Nullable\n+    private String serviceId;\n+\n+    ConsulUpdatingListener(ConsulClient consulClient, String serviceName, @Nullable Endpoint endpoint,\n+                           @Nullable URI checkUrl, @Nullable HttpMethod checkMethod, String checkInterval) {\n+        this.consulClient = requireNonNull(consulClient, \"consulClient\");\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+        this.endpoint = endpoint;\n+\n+        if (checkUrl != null) {\n+            final Check check = new Check();\n+            check.setHttp(checkUrl.toString());\n+            if (checkMethod != null) {\n+                check.setMethod(checkMethod.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU3MjE5Mw==", "bodyText": "{}. -> {}", "url": "https://github.com/line/armeria/pull/3002#discussion_r501572193", "createdAt": "2020-10-08T09:20:52Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/ConsulUpdatingListener.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.Inet4Address;\n+import java.net.URI;\n+import java.util.concurrent.ThreadLocalRandom;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.util.SystemInfo;\n+import com.linecorp.armeria.internal.consul.Check;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerListener;\n+import com.linecorp.armeria.server.ServerListenerAdapter;\n+import com.linecorp.armeria.server.ServerPort;\n+\n+/**\n+ * A {@link ServerListener} which registers the current {@link Server} to\n+ * <a href=\"https://www.consul.io\">Consul</a>.\n+ */\n+public class ConsulUpdatingListener extends ServerListenerAdapter {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ConsulUpdatingListener.class);\n+\n+    /**\n+     * Returns a {@link ConsulUpdatingListenerBuilder} that builds {@link ConsulUpdatingListener}.\n+     * @param serviceName the service name which is registered into Consul.\n+     */\n+    public static ConsulUpdatingListenerBuilder builder(String serviceName) {\n+        return new ConsulUpdatingListenerBuilder(serviceName);\n+    }\n+\n+    private final ConsulClient consulClient;\n+    private final String serviceName;\n+\n+    @Nullable\n+    private final Endpoint endpoint;\n+    @Nullable\n+    private final Check check;\n+    @Nullable\n+    private String serviceId;\n+\n+    ConsulUpdatingListener(ConsulClient consulClient, String serviceName, @Nullable Endpoint endpoint,\n+                           @Nullable URI checkUrl, @Nullable HttpMethod checkMethod, String checkInterval) {\n+        this.consulClient = requireNonNull(consulClient, \"consulClient\");\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+        this.endpoint = endpoint;\n+\n+        if (checkUrl != null) {\n+            final Check check = new Check();\n+            check.setHttp(checkUrl.toString());\n+            if (checkMethod != null) {\n+                check.setMethod(checkMethod.toString());\n+            }\n+            check.setInterval(checkInterval);\n+            this.check = check;\n+        } else {\n+            check = null;\n+        }\n+    }\n+\n+    @Override\n+    public void serverStarted(Server server) throws Exception {\n+        final Endpoint endpoint = getEndpoint(server);\n+        final String serviceId = serviceName + '.' + Long.toHexString(ThreadLocalRandom.current().nextLong());\n+        consulClient.register(serviceId, serviceName, endpoint, check)\n+                    .aggregate()\n+                    .handle((res, cause) -> {\n+                  if (cause != null) {\n+                      logger.warn(\"Failed to register {}:{} to Consul: {}\",\n+                                  endpoint.host(), endpoint.port(), consulClient.uri(), cause);\n+                      return null;\n+                  }\n+\n+                  if (res.status() != HttpStatus.OK) {\n+                      logger.warn(\"Failed to register {}:{} to Consul: {}. (status: {}, content: {})\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU3MzA2NQ==", "bodyText": "Missing return or else ?", "url": "https://github.com/line/armeria/pull/3002#discussion_r501573065", "createdAt": "2020-10-08T09:22:13Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/ConsulUpdatingListener.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.Inet4Address;\n+import java.net.URI;\n+import java.util.concurrent.ThreadLocalRandom;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.util.SystemInfo;\n+import com.linecorp.armeria.internal.consul.Check;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerListener;\n+import com.linecorp.armeria.server.ServerListenerAdapter;\n+import com.linecorp.armeria.server.ServerPort;\n+\n+/**\n+ * A {@link ServerListener} which registers the current {@link Server} to\n+ * <a href=\"https://www.consul.io\">Consul</a>.\n+ */\n+public class ConsulUpdatingListener extends ServerListenerAdapter {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ConsulUpdatingListener.class);\n+\n+    /**\n+     * Returns a {@link ConsulUpdatingListenerBuilder} that builds {@link ConsulUpdatingListener}.\n+     * @param serviceName the service name which is registered into Consul.\n+     */\n+    public static ConsulUpdatingListenerBuilder builder(String serviceName) {\n+        return new ConsulUpdatingListenerBuilder(serviceName);\n+    }\n+\n+    private final ConsulClient consulClient;\n+    private final String serviceName;\n+\n+    @Nullable\n+    private final Endpoint endpoint;\n+    @Nullable\n+    private final Check check;\n+    @Nullable\n+    private String serviceId;\n+\n+    ConsulUpdatingListener(ConsulClient consulClient, String serviceName, @Nullable Endpoint endpoint,\n+                           @Nullable URI checkUrl, @Nullable HttpMethod checkMethod, String checkInterval) {\n+        this.consulClient = requireNonNull(consulClient, \"consulClient\");\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+        this.endpoint = endpoint;\n+\n+        if (checkUrl != null) {\n+            final Check check = new Check();\n+            check.setHttp(checkUrl.toString());\n+            if (checkMethod != null) {\n+                check.setMethod(checkMethod.toString());\n+            }\n+            check.setInterval(checkInterval);\n+            this.check = check;\n+        } else {\n+            check = null;\n+        }\n+    }\n+\n+    @Override\n+    public void serverStarted(Server server) throws Exception {\n+        final Endpoint endpoint = getEndpoint(server);\n+        final String serviceId = serviceName + '.' + Long.toHexString(ThreadLocalRandom.current().nextLong());\n+        consulClient.register(serviceId, serviceName, endpoint, check)\n+                    .aggregate()\n+                    .handle((res, cause) -> {\n+                  if (cause != null) {\n+                      logger.warn(\"Failed to register {}:{} to Consul: {}\",\n+                                  endpoint.host(), endpoint.port(), consulClient.uri(), cause);\n+                      return null;\n+                  }\n+\n+                  if (res.status() != HttpStatus.OK) {\n+                      logger.warn(\"Failed to register {}:{} to Consul: {}. (status: {}, content: {})\",\n+                                  endpoint.host(), endpoint.port(), consulClient.uri(), res.status(),\n+                                  res.contentUtf8());\n+                      return null;\n+                  }\n+\n+                  logger.info(\"Registered {}:{} to Consul: {}\",\n+                              endpoint.host(), endpoint.port(), consulClient.uri());\n+                  this.serviceId = serviceId;\n+                  return null;\n+              });\n+    }\n+\n+    private Endpoint getEndpoint(Server server) {\n+        if (endpoint != null) {\n+            if (endpoint.hasPort()) {\n+                warnIfInactivePort(server, endpoint.port());\n+            }\n+            return endpoint;\n+        }\n+        return defaultEndpoint(server);\n+    }\n+\n+    private static Endpoint defaultEndpoint(Server server) {\n+        final ServerPort serverPort = server.activePort();\n+        assert serverPort != null;\n+\n+        final Inet4Address inet4Address = SystemInfo.defaultNonLoopbackIpV4Address();\n+        final String host = inet4Address != null ? inet4Address.getHostAddress() : server.defaultHostname();\n+        return Endpoint.of(host, serverPort.localAddress().getPort());\n+    }\n+\n+    private static void warnIfInactivePort(Server server, int port) {\n+        for (ServerPort serverPort : server.activePorts().values()) {\n+            if (serverPort.localAddress().getPort() == port) {\n+                return;\n+            }\n+        }\n+        logger.warn(\"The specified port number {} does not exist. (expected one of activePorts: {})\",\n+                    port, server.activePorts());\n+    }\n+\n+    @Override\n+    public void serverStopping(Server server) {\n+        if (serviceId != null) {\n+            consulClient.deregister(serviceId)\n+                        .aggregate()\n+                        .handle((res, cause) -> {\n+                      if (cause != null) {\n+                          logger.warn(\"Failed to deregister {} from Consul: {}\",\n+                                      serviceId, consulClient.uri(), cause);\n+                      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 150}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU3NTE2Ng==", "bodyText": "Do you think it's a good idea to remove all these methods in favor of consulUri? Consul agent seems to run at localhost in most cases, so I guess these methods will not be used very often.", "url": "https://github.com/line/armeria/pull/3002#discussion_r501575166", "createdAt": "2020-10-08T09:25:38Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.Strings;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean isUriComponentSet;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: {@code /v1}\n+     * @param consulUri the URI of Consul API service, default: {@code http://127.0.0.1:8500/v1}\n+     */\n+    public ConsulClientBuilder consulUri(URI consulUri) {\n+        checkState(!isUriComponentSet, \"consulUri can't comes with other addressing options\");\n+        requireNonNull(consulUri, \"consulUri\");\n+        final String path = consulUri.getPath();\n+        checkArgument(!Strings.isNullOrEmpty(path) && !\"/\".equals(path),\n+                      \"consulUri has to contain version path\");\n+        this.consulUri = consulUri;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: {@code /v1}\n+     * @param consulUri the URI of Consul API service, default: {@code http://127.0.0.1:8500/v1}\n+     */\n+    public ConsulClientBuilder consulUri(String consulUri) {\n+        return consulUri(URI.create(requireNonNull(consulUri, \"consulUri\")));\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service protocol scheme.\n+     * @param consulProtocol the protocol scheme of Consul API service, default: {@link SessionProtocol#HTTP}\n+     */\n+    public ConsulClientBuilder consulProtocol(SessionProtocol consulProtocol) {\n+        checkState(consulUri == null, \"consulProtocol can't comes with consulUri\");\n+        requireNonNull(consulProtocol, \"consulProtocol\");\n+        this.consulProtocol = consulProtocol;\n+        isUriComponentSet = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service host address.\n+     * @param consulAddress the host address of Consul API service, default: {@code 127.0.0.1}\n+     */\n+    public ConsulClientBuilder consulAddress(String consulAddress) {\n+        checkState(consulUri == null, \"consulAddress can't comes with consulUri\");\n+        requireNonNull(consulAddress, \"consulAddress\");\n+        checkArgument(!consulAddress.isEmpty(), \"consulAddress can't be empty\");\n+        this.consulAddress = consulAddress;\n+        isUriComponentSet = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's HTTP service port.\n+     * @param consulPort the port of Consul agent, default: {@code 8500}\n+     */\n+    public ConsulClientBuilder consulPort(int consulPort) {\n+        checkState(consulUri == null, \"consulPort can't comes with consulUri\");\n+        checkArgument(consulPort > 0, \"consulPort can't be zero or negative\");\n+        this.consulPort = consulPort;\n+        isUriComponentSet = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API version.\n+     * @param consulApiVersion the version of Consul API service, default: {@code /v1}\n+     */\n+    public ConsulClientBuilder consulApiVersion(String consulApiVersion) {\n+        checkState(consulUri == null, \"consulApiVersion can't comes with consulUri\");\n+        requireNonNull(consulApiVersion, \"consulApiVersion\");\n+        checkArgument(!consulApiVersion.isEmpty(), \"consulApiVersion can't be empty\");\n+        checkArgument(consulApiVersion.charAt(0) != '/',\n+                      \"consulApiVersion can't starts with '/'\");\n+        this.consulApiVersion = consulApiVersion;\n+        isUriComponentSet = true;\n+        return this;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 124}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/417f8a151a1ed25f9a7edc1f131db56c23e093ea", "committedDate": "2020-10-07T22:56:03Z", "message": "Apply reviews\n\n- Fix commnents\n- More checking consulUri argument\n- ..."}, "afterCommit": {"oid": "f3bd6a2ae4688bfd26d3aad30e335a68d3d344e9", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/f3bd6a2ae4688bfd26d3aad30e335a68d3d344e9", "committedDate": "2020-10-15T16:24:55Z", "message": "Apply reviews\n\n- Milliseconds instead seconds\n- Path be URI encoded\n- ..."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMTk2Mzg3", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-510196387", "createdAt": "2020-10-16T06:50:50Z", "commit": {"oid": "f3bd6a2ae4688bfd26d3aad30e335a68d3d344e9"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwNjo1MDo1MVrOHipr9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwNjo1OToxM1rOHiqDUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA5NjYyOQ==", "bodyText": "How about checking using a regular expression? e.g. ^v[0-9][-._a-zA-Z0-9]*$", "url": "https://github.com/line/armeria/pull/3002#discussion_r506096629", "createdAt": "2020-10-16T06:50:51Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,151 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.Strings;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean isUriComponentSet;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: {@code /v1}\n+     * @param consulUri the URI of Consul API service, default: {@code http://127.0.0.1:8500/v1}\n+     */\n+    public ConsulClientBuilder consulUri(URI consulUri) {\n+        checkState(!isUriComponentSet, \"consulUri can't comes with other addressing options\");\n+        requireNonNull(consulUri, \"consulUri\");\n+        final String path = consulUri.getPath();\n+        checkArgument(!Strings.isNullOrEmpty(path) && !\"/\".equals(path),\n+                      \"consulUri has to contain version path\");\n+        this.consulUri = consulUri;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: {@code /v1}\n+     * @param consulUri the URI of Consul API service, default: {@code http://127.0.0.1:8500/v1}\n+     */\n+    public ConsulClientBuilder consulUri(String consulUri) {\n+        return consulUri(URI.create(requireNonNull(consulUri, \"consulUri\")));\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service protocol scheme.\n+     * @param consulProtocol the protocol scheme of Consul API service, default: {@link SessionProtocol#HTTP}\n+     */\n+    public ConsulClientBuilder consulProtocol(SessionProtocol consulProtocol) {\n+        checkState(consulUri == null, \"consulProtocol can't comes with consulUri\");\n+        requireNonNull(consulProtocol, \"consulProtocol\");\n+        this.consulProtocol = consulProtocol;\n+        isUriComponentSet = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service host address.\n+     * @param consulAddress the host address of Consul API service, default: {@code 127.0.0.1}\n+     */\n+    public ConsulClientBuilder consulAddress(String consulAddress) {\n+        checkState(consulUri == null, \"consulAddress can't comes with consulUri\");\n+        requireNonNull(consulAddress, \"consulAddress\");\n+        checkArgument(!consulAddress.isEmpty(), \"consulAddress can't be empty\");\n+        this.consulAddress = consulAddress;\n+        isUriComponentSet = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's HTTP service port.\n+     * @param consulPort the port of Consul agent, default: {@code 8500}\n+     */\n+    public ConsulClientBuilder consulPort(int consulPort) {\n+        checkState(consulUri == null, \"consulPort can't comes with consulUri\");\n+        checkArgument(consulPort > 0, \"consulPort can't be zero or negative\");\n+        this.consulPort = consulPort;\n+        isUriComponentSet = true;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API version.\n+     * @param consulApiVersion the version of Consul API service, default: {@code /v1}\n+     */\n+    public ConsulClientBuilder consulApiVersion(String consulApiVersion) {\n+        checkState(consulUri == null, \"consulApiVersion can't comes with consulUri\");\n+        requireNonNull(consulApiVersion, \"consulApiVersion\");\n+        checkArgument(!consulApiVersion.isEmpty(), \"consulApiVersion can't be empty\");\n+        checkArgument(consulApiVersion.charAt(0) != '/',\n+                      \"consulApiVersion can't starts with '/'\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU2MTI2Mg=="}, "originalCommit": {"oid": "417f8a151a1ed25f9a7edc1f131db56c23e093ea"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA5NzgzMA==", "bodyText": "How about inlining a hard-coded string? i.e. path.append(\"?passing=true\")", "url": "https://github.com/line/armeria/pull/3002#discussion_r506097830", "createdAt": "2020-10-16T06:52:06Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/HealthClient.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.QueryParams;\n+import com.linecorp.armeria.internal.common.PercentEncoder;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/health.html\">Health Endpoint API</a>.\n+ */\n+final class HealthClient {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(HealthClient.class);\n+\n+    private static final String PASSING_PARAM = '?' +\n+                                                QueryParams.of(\"passing\", true).toQueryString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3bd6a2ae4688bfd26d3aad30e335a68d3d344e9"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjEwMDc3Ng==", "bodyText": "The second /** could be removed.", "url": "https://github.com/line/armeria/pull/3002#discussion_r506100776", "createdAt": "2020-10-16T06:55:54Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/package-info.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/**\n+ /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3bd6a2ae4688bfd26d3aad30e335a68d3d344e9"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjEwMjYxMA==", "bodyText": "What is the correct name of Consul token, just 'token', 'access token' or 'acl token'?", "url": "https://github.com/line/armeria/pull/3002#discussion_r506102610", "createdAt": "2020-10-16T06:59:13Z", "author": {"login": "trustin"}, "path": "consul/src/test/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupTest.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2016 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.awaitility.Awaitility.await;\n+\n+import java.time.Duration;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulTestBase;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerListener;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListener;\n+\n+public class ConsulEndpointGroupTest extends ConsulTestBase {\n+\n+    static final List<Server> servers = new ArrayList<>();\n+\n+    @BeforeAll\n+    static void startServers() {\n+\n+        for (Endpoint endpoint : sampleEndpoints) {\n+            final Server server = Server.builder()\n+                                        .http(endpoint.port())\n+                                        .service(\"/\", new EchoService())\n+                                        .build();\n+            final ServerListener listener = ConsulUpdatingListener.builder(serviceName)\n+                                                                  .consulUri(\"http://127.0.0.1:\" +\n+                                                                             consul().getHttpPort() + \"/v1\")\n+                                                                  .consulToken(TOKEN)\n+                                                                  .build();\n+            server.addListener(listener);\n+            server.start().join();\n+            servers.add(server);\n+        }\n+    }\n+\n+    @AfterAll\n+    static void stopServers() throws Exception {\n+        servers.forEach(Server::close);\n+        servers.clear();\n+    }\n+\n+    @Test\n+    void testConsulEndpointGroupWithClient() {\n+        try (ConsulEndpointGroup endpointGroup =\n+                     ConsulEndpointGroup.builder(serviceName)\n+                                        .consulProtocol(SessionProtocol.HTTP)\n+                                        .consulAddress(consul().getAddress())\n+                                        .consulPort(consul().getHttpPort())\n+                                        .consulApiVersion(\"v1\")\n+                                        .consulToken(TOKEN)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3bd6a2ae4688bfd26d3aad30e335a68d3d344e9"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMzU0MzU5", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-513354359", "createdAt": "2020-10-21T06:50:10Z", "commit": {"oid": "45896effdaff94488af816685097a0d91ec6fb62"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjo1MDoxMFrOHlcqJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjo1MDo1MFrOHlcrWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAyODkwMg==", "bodyText": "This line can be removed.", "url": "https://github.com/line/armeria/pull/3002#discussion_r509028902", "createdAt": "2020-10-21T06:50:10Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -116,8 +118,8 @@ public ConsulClientBuilder consulApiVersion(String consulApiVersion) {\n         checkState(consulUri == null, \"consulApiVersion can't comes with consulUri\");\n         requireNonNull(consulApiVersion, \"consulApiVersion\");\n         checkArgument(!consulApiVersion.isEmpty(), \"consulApiVersion can't be empty\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45896effdaff94488af816685097a0d91ec6fb62"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAyOTIwOA==", "bodyText": "\"consulApiVersion: %s (expected: a version string that starts with 'v', e.g. 'v1')\", consulVersion", "url": "https://github.com/line/armeria/pull/3002#discussion_r509029208", "createdAt": "2020-10-21T06:50:50Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -116,8 +118,8 @@ public ConsulClientBuilder consulApiVersion(String consulApiVersion) {\n         checkState(consulUri == null, \"consulApiVersion can't comes with consulUri\");\n         requireNonNull(consulApiVersion, \"consulApiVersion\");\n         checkArgument(!consulApiVersion.isEmpty(), \"consulApiVersion can't be empty\");\n-        checkArgument(consulApiVersion.charAt(0) != '/',\n-                      \"consulApiVersion can't starts with '/'\");\n+        checkArgument(CONSUL_VERSION_PATTERN.matcher(consulApiVersion).matches(),\n+                      \"consulApiVersion has unexpected format\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45896effdaff94488af816685097a0d91ec6fb62"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45896effdaff94488af816685097a0d91ec6fb62", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/45896effdaff94488af816685097a0d91ec6fb62", "committedDate": "2020-10-16T09:13:01Z", "message": "Apply reviews: regex for consulApiVersion...\n\n- check consulApiVersion with regex in ConsulClientBuilder\n- DEFAULT_CHECK_INTERVAL_MILLIS instead of DEFAULT_CHECK_INTERVAL in\n  ConsulUpdatingListenerBuilder\n- ..."}, "afterCommit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/a02470b585130671174b3d40bbd625f29d8255fa", "committedDate": "2020-10-21T21:43:20Z", "message": "Fix consulApiVersion in ConsulClientBuilder\n- remove redundant check\n- change a check message\n- rename a constant"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MzE0OTQ5", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-517314949", "createdAt": "2020-10-27T03:01:48Z", "commit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMzowMTo0OFrOHoptGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwMzozMjoxM1rOHoqLoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4ODM3OA==", "bodyText": "RESTful and HTTP mean the same thing in this context so I think we can just use the word in the web site that is\nConsul's HTTP API", "url": "https://github.com/line/armeria/pull/3002#discussion_r512388378", "createdAt": "2020-10-27T03:01:48Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroup.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.ClientRequestContextCaptor;\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.endpoint.DynamicEndpointGroup;\n+import com.linecorp.armeria.client.endpoint.EndpointGroup;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+\n+import io.netty.channel.EventLoop;\n+\n+/**\n+ * A Consul-based {@link EndpointGroup} implementation that retrieves the list of {@link Endpoint}s\n+ * from Consul using <a href=\"https://www.consul.io/api\">Consul's RESTful HTTP API</a> and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM4OTU4Ng==", "bodyText": "I think we need a setter for the endpoint selection strategy.\nhttps://github.com/line/armeria/blob/master/eureka/src/main/java/com/linecorp/armeria/client/eureka/EurekaEndpointGroupBuilder.java#L101", "url": "https://github.com/line/armeria/pull/3002#discussion_r512389586", "createdAt": "2020-10-27T03:06:22Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupBuilder.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListenerBuilder;\n+\n+/**\n+ * A builder class for {@link ConsulEndpointGroup}.\n+ */\n+public final class ConsulEndpointGroupBuilder extends ConsulClientBuilder {\n+    private static final long DEFAULT_HEALTH_CHECK_INTERVAL_MILLIS = 10_000;\n+\n+    private final String serviceName;\n+    private long registryFetchIntervalMillis = DEFAULT_HEALTH_CHECK_INTERVAL_MILLIS;\n+    private boolean useHealthyEndpoints;\n+\n+    ConsulEndpointGroupBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM5MTcwOQ==", "bodyText": "How about passing (URI)or (Strig uri) when creating this class and removing\nconsulUri(URI consulUri),\nconsulUri(String consulUri),\nconsulProtocol,\nconsulAddress,\nconsulPort,\nconsulAddress?\nIf we do that, we can remove the complex setting logic and simplify the uri setting.", "url": "https://github.com/line/armeria/pull/3002#discussion_r512391709", "createdAt": "2020-10-27T03:14:31Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,153 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.regex.Pattern;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.base.Strings;\n+\n+import com.linecorp.armeria.common.SessionProtocol;\n+\n+public class ConsulClientBuilder {\n+    private static final SessionProtocol DEFAULT_CONSUL_PROTOCOL = SessionProtocol.HTTP;\n+    private static final String DEFAULT_CONSUL_ADDRESS = \"127.0.0.1\";\n+    private static final int DEFAULT_CONSUL_PORT = 8500;\n+    private static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+    private static final Pattern CONSUL_API_VERSION_PATTERN = Pattern.compile(\"^v[0-9][-._a-zA-Z0-9]*$\");\n+\n+    @Nullable\n+    private URI consulUri;\n+    private SessionProtocol consulProtocol = DEFAULT_CONSUL_PROTOCOL;\n+    private String consulAddress = DEFAULT_CONSUL_ADDRESS;\n+    private int consulPort = DEFAULT_CONSUL_PORT;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+    private boolean isUriComponentSet;\n+\n+    protected ConsulClientBuilder() {\n+    }\n+\n+    /**\n+     * Sets the specified Consul's API service URI.\n+     * The URI should include the Consul API version at path, like: {@code /v1}\n+     * @param consulUri the URI of Consul API service, default: {@code http://127.0.0.1:8500/v1}\n+     */\n+    public ConsulClientBuilder consulUri(URI consulUri) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM5NTQ3MA==", "bodyText": "If serviceAddress and address are both null, I think we should return null (don't forget to mark @Nullable) and filter where this is called.\n.filter(Objects::nonNull)", "url": "https://github.com/line/armeria/pull/3002#discussion_r512395470", "createdAt": "2020-10-27T03:29:34Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/HealthClient.java", "diffHunk": "@@ -0,0 +1,175 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import com.fasterxml.jackson.annotation.JsonInclude.Include;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.internal.common.PercentEncoder;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/health.html\">Health Endpoint API</a>.\n+ */\n+final class HealthClient {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(HealthClient.class);\n+\n+    private static final String PASSING_PARAM = \"?passing=true\";\n+\n+    static HealthClient of(ConsulClient consulClient) {\n+        return new HealthClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private HealthClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Returns a healthy endpoint list with service name.\n+     */\n+    CompletableFuture<List<Endpoint>> healthyEndpoints(String serviceName) {\n+        requireNonNull(serviceName, \"serviceName\");\n+        final StringBuilder path = new StringBuilder(\"/health/service/\");\n+        PercentEncoder.encodeComponent(path, serviceName);\n+        path.append(PASSING_PARAM);\n+        return client\n+                .get(path.toString())\n+                .aggregate()\n+                .handle((response, cause) -> {\n+                    if (cause != null) {\n+                        logger.warn(\"Unexpected exception while fetching the registry from Consul: {}\" +\n+                                    \" (serviceName: {})\", client.uri(), serviceName,\n+                                    cause);\n+                        return null;\n+                    }\n+\n+                    final HttpStatus status = response.status();\n+                    final String content = response.contentUtf8();\n+                    if (!status.isSuccess()) {\n+                        logger.warn(\"Unexpected response from Consul: {} (status: {}, content: {},\" +\n+                                    \" serviceName: {})\", client.uri(), status,\n+                                    content, serviceName);\n+                        return null;\n+                    }\n+\n+                    try {\n+                        return Arrays.stream(mapper.readValue(content, HealthService[].class))\n+                                     .map(HealthClient::toEndpoint)\n+                                     .collect(toImmutableList());\n+                    } catch (IOException e) {\n+                        logger.warn(\"Unexpected exception while parsing a response from Consul: {}\" +\n+                                    \" (content: {}, serviceName: {})\",\n+                                    client.uri(), content, serviceName, e);\n+                        return null;\n+                    }\n+                });\n+    }\n+\n+    private static Endpoint toEndpoint(HealthService healthService) {\n+        final String host;\n+        if (!healthService.service.address.isEmpty()) {\n+            host = healthService.service.address;\n+        } else if (!healthService.node.address.isEmpty()) {\n+            host = healthService.node.address;\n+        } else {\n+            host = \"127.0.0.1\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM5NTcwMg==", "bodyText": "ditto", "url": "https://github.com/line/armeria/pull/3002#discussion_r512395702", "createdAt": "2020-10-27T03:30:23Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/CatalogClient.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.type.CollectionType;\n+import com.fasterxml.jackson.databind.type.TypeFactory;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Strings;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.util.Exceptions;\n+import com.linecorp.armeria.internal.common.PercentEncoder;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/catalog.html\">Catalog HTTP API</a>.\n+ */\n+final class CatalogClient {\n+\n+    private static final CollectionType collectionTypeForNode =\n+            TypeFactory.defaultInstance().constructCollectionType(List.class, Node.class);\n+\n+    static CatalogClient of(ConsulClient consulClient) {\n+        return new CatalogClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private CatalogClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Gets endpoint list with service name.\n+     */\n+    CompletableFuture<List<Endpoint>> endpoints(String serviceName) {\n+        requireNonNull(serviceName, \"serviceName\");\n+        return service(serviceName)\n+                .thenApply(nodes -> nodes.stream()\n+                                         .map(CatalogClient::convertToEndpoint)\n+                                         .collect(toImmutableList()));\n+    }\n+\n+    /**\n+     * Returns node list with service name.\n+     */\n+    @VisibleForTesting\n+    CompletableFuture<List<Node>> service(String serviceName) {\n+        requireNonNull(serviceName, \"serviceName\");\n+        final StringBuilder path = new StringBuilder(\"/catalog/service/\");\n+        PercentEncoder.encodeComponent(path, serviceName);\n+        return client.get(path.toString())\n+                     .aggregate()\n+                     .thenApply(response -> {\n+                         try {\n+                             return mapper.readValue(response.content().toStringUtf8(), collectionTypeForNode);\n+                         } catch (JsonProcessingException e) {\n+                             return Exceptions.throwUnsafely(e);\n+                         }\n+                     });\n+    }\n+\n+    private static Endpoint convertToEndpoint(Node node) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM5NjE5Mg==", "bodyText": "I think we can use byte[]\nreturn mapper.readValue(response.content().array(), collectionTypeForNode);", "url": "https://github.com/line/armeria/pull/3002#discussion_r512396192", "createdAt": "2020-10-27T03:32:13Z", "author": {"login": "minwoox"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/CatalogClient.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.collect.ImmutableList.toImmutableList;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.type.CollectionType;\n+import com.fasterxml.jackson.databind.type.TypeFactory;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.MoreObjects;\n+import com.google.common.base.Strings;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.util.Exceptions;\n+import com.linecorp.armeria.internal.common.PercentEncoder;\n+\n+/**\n+ * A Consul client that is responsible for\n+ * <a href=\"https://www.consul.io/api/catalog.html\">Catalog HTTP API</a>.\n+ */\n+final class CatalogClient {\n+\n+    private static final CollectionType collectionTypeForNode =\n+            TypeFactory.defaultInstance().constructCollectionType(List.class, Node.class);\n+\n+    static CatalogClient of(ConsulClient consulClient) {\n+        return new CatalogClient(consulClient);\n+    }\n+\n+    private final WebClient client;\n+    private final ObjectMapper mapper;\n+\n+    private CatalogClient(ConsulClient client) {\n+        this.client = client.consulWebClient();\n+        mapper = client.getObjectMapper();\n+    }\n+\n+    /**\n+     * Gets endpoint list with service name.\n+     */\n+    CompletableFuture<List<Endpoint>> endpoints(String serviceName) {\n+        requireNonNull(serviceName, \"serviceName\");\n+        return service(serviceName)\n+                .thenApply(nodes -> nodes.stream()\n+                                         .map(CatalogClient::convertToEndpoint)\n+                                         .collect(toImmutableList()));\n+    }\n+\n+    /**\n+     * Returns node list with service name.\n+     */\n+    @VisibleForTesting\n+    CompletableFuture<List<Node>> service(String serviceName) {\n+        requireNonNull(serviceName, \"serviceName\");\n+        final StringBuilder path = new StringBuilder(\"/catalog/service/\");\n+        PercentEncoder.encodeComponent(path, serviceName);\n+        return client.get(path.toString())\n+                     .aggregate()\n+                     .thenApply(response -> {\n+                         try {\n+                             return mapper.readValue(response.content().toStringUtf8(), collectionTypeForNode);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MDMyMzI0", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-526032324", "createdAt": "2020-11-09T08:46:56Z", "commit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0Njo1NlrOHvkPQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQwODo0OTozMVrOHvkU7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzODg1MQ==", "bodyText": "will throw an", "url": "https://github.com/line/armeria/pull/3002#discussion_r519638851", "createdAt": "2020-11-09T08:46:56Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/ConsulUpdatingListenerBuilder.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Builds a new {@link ConsulUpdatingListener}, which registers the server to Consul cluster.\n+ * <h3>Examples</h3>\n+ * <pre>{@code\n+ * ConsulUpdatingListener listener = ConsulUpdatingListener.builder(\"myService\")\n+ *                                                         .consulPort(8501\")\n+ *                                                         .build();\n+ * ServerBuilder sb = Server.builder();\n+ * sb.serverListener(listener);\n+ * }</pre>\n+ */\n+public final class ConsulUpdatingListenerBuilder extends ConsulClientBuilder {\n+\n+    private static final long DEFAULT_CHECK_INTERVAL_MILLIS = 10_000;\n+    private final String serviceName;\n+\n+    @Nullable\n+    private Endpoint serviceEndpoint;\n+    @Nullable\n+    private URI checkUri;\n+    private String checkInterval = DEFAULT_CHECK_INTERVAL_MILLIS + \"ms\";\n+    @Nullable\n+    private HttpMethod checkMethod;\n+\n+    /**\n+     * Creates a {@link ConsulUpdatingListenerBuilder} with a service name.\n+     *\n+     * @param serviceName the service name to register\n+     */\n+    ConsulUpdatingListenerBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+        checkArgument(!this.serviceName.isEmpty(), \"serviceName can't be empty\");\n+    }\n+\n+    /**\n+     * Sets URI for checking health by Consul agent.\n+     *\n+     * @param checkUri the URI for checking health of service\n+     */\n+    public ConsulUpdatingListenerBuilder checkUri(URI checkUri) {\n+        this.checkUri = requireNonNull(checkUri, \"checkUri\");\n+        return this;\n+    }\n+\n+    /**\n+     * Sets URI for checking health by Consul agent.\n+     *\n+     * @param checkUri the URI for checking health of service\n+     */\n+    public ConsulUpdatingListenerBuilder checkUri(String checkUri) {\n+        requireNonNull(checkUri, \"checkUri\");\n+        checkArgument(!checkUri.isEmpty(), \"checkUri can't be empty\");\n+        return checkUri(URI.create(checkUri));\n+    }\n+\n+    /**\n+     * Sets HTTP method for checking health by Consul agent.\n+     *\n+     * <p>Note that the {@code checkMethod} should be configured with {@link #checkUri(String)}.\n+     * Otherwise, the {@link #build()} method will throws {@link IllegalStateException}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzODkyOQ==", "bodyText": "will throw an", "url": "https://github.com/line/armeria/pull/3002#discussion_r519638929", "createdAt": "2020-11-09T08:47:03Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/ConsulUpdatingListenerBuilder.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Builds a new {@link ConsulUpdatingListener}, which registers the server to Consul cluster.\n+ * <h3>Examples</h3>\n+ * <pre>{@code\n+ * ConsulUpdatingListener listener = ConsulUpdatingListener.builder(\"myService\")\n+ *                                                         .consulPort(8501\")\n+ *                                                         .build();\n+ * ServerBuilder sb = Server.builder();\n+ * sb.serverListener(listener);\n+ * }</pre>\n+ */\n+public final class ConsulUpdatingListenerBuilder extends ConsulClientBuilder {\n+\n+    private static final long DEFAULT_CHECK_INTERVAL_MILLIS = 10_000;\n+    private final String serviceName;\n+\n+    @Nullable\n+    private Endpoint serviceEndpoint;\n+    @Nullable\n+    private URI checkUri;\n+    private String checkInterval = DEFAULT_CHECK_INTERVAL_MILLIS + \"ms\";\n+    @Nullable\n+    private HttpMethod checkMethod;\n+\n+    /**\n+     * Creates a {@link ConsulUpdatingListenerBuilder} with a service name.\n+     *\n+     * @param serviceName the service name to register\n+     */\n+    ConsulUpdatingListenerBuilder(String serviceName) {\n+        this.serviceName = requireNonNull(serviceName, \"serviceName\");\n+        checkArgument(!this.serviceName.isEmpty(), \"serviceName can't be empty\");\n+    }\n+\n+    /**\n+     * Sets URI for checking health by Consul agent.\n+     *\n+     * @param checkUri the URI for checking health of service\n+     */\n+    public ConsulUpdatingListenerBuilder checkUri(URI checkUri) {\n+        this.checkUri = requireNonNull(checkUri, \"checkUri\");\n+        return this;\n+    }\n+\n+    /**\n+     * Sets URI for checking health by Consul agent.\n+     *\n+     * @param checkUri the URI for checking health of service\n+     */\n+    public ConsulUpdatingListenerBuilder checkUri(String checkUri) {\n+        requireNonNull(checkUri, \"checkUri\");\n+        checkArgument(!checkUri.isEmpty(), \"checkUri can't be empty\");\n+        return checkUri(URI.create(checkUri));\n+    }\n+\n+    /**\n+     * Sets HTTP method for checking health by Consul agent.\n+     *\n+     * <p>Note that the {@code checkMethod} should be configured with {@link #checkUri(String)}.\n+     * Otherwise, the {@link #build()} method will throws {@link IllegalStateException}.\n+     *\n+     * @param checkMethod the {@link HttpMethod} for checking health of service\n+     */\n+    public ConsulUpdatingListenerBuilder checkMethod(HttpMethod checkMethod) {\n+        this.checkMethod = requireNonNull(checkMethod, \"checkMethod\");\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified {@link Duration} for checking health.\n+     * If not set {@value DEFAULT_CHECK_INTERVAL_MILLIS} milliseconds is used by default.\n+     *\n+     * <p>Note that the {@code checkInterval} should be configured with {@link #checkUri(URI)}.\n+     * Otherwise, the {@link #build()} method will throws {@link IllegalStateException}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTYzOTQ5Ng==", "bodyText": "Does it make sense to use HttpMethod.HEAD as the default?", "url": "https://github.com/line/armeria/pull/3002#discussion_r519639496", "createdAt": "2020-11-09T08:48:10Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/ConsulUpdatingListenerBuilder.java", "diffHunk": "@@ -0,0 +1,184 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Builds a new {@link ConsulUpdatingListener}, which registers the server to Consul cluster.\n+ * <h3>Examples</h3>\n+ * <pre>{@code\n+ * ConsulUpdatingListener listener = ConsulUpdatingListener.builder(\"myService\")\n+ *                                                         .consulPort(8501\")\n+ *                                                         .build();\n+ * ServerBuilder sb = Server.builder();\n+ * sb.serverListener(listener);\n+ * }</pre>\n+ */\n+public final class ConsulUpdatingListenerBuilder extends ConsulClientBuilder {\n+\n+    private static final long DEFAULT_CHECK_INTERVAL_MILLIS = 10_000;\n+    private final String serviceName;\n+\n+    @Nullable\n+    private Endpoint serviceEndpoint;\n+    @Nullable\n+    private URI checkUri;\n+    private String checkInterval = DEFAULT_CHECK_INTERVAL_MILLIS + \"ms\";\n+    @Nullable\n+    private HttpMethod checkMethod;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTY0MDMwMQ==", "bodyText": "checkUri (not l but i)", "url": "https://github.com/line/armeria/pull/3002#discussion_r519640301", "createdAt": "2020-11-09T08:49:31Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/ConsulUpdatingListener.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.Inet4Address;\n+import java.net.URI;\n+import java.util.concurrent.ThreadLocalRandom;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.util.SystemInfo;\n+import com.linecorp.armeria.internal.consul.Check;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerListener;\n+import com.linecorp.armeria.server.ServerListenerAdapter;\n+import com.linecorp.armeria.server.ServerPort;\n+\n+/**\n+ * A {@link ServerListener} which registers the current {@link Server} to\n+ * <a href=\"https://www.consul.io\">Consul</a>.\n+ */\n+public final class ConsulUpdatingListener extends ServerListenerAdapter {\n+\n+    private static final Logger logger = LoggerFactory.getLogger(ConsulUpdatingListener.class);\n+\n+    /**\n+     * Returns a {@link ConsulUpdatingListenerBuilder} that builds {@link ConsulUpdatingListener}.\n+     * @param serviceName the service name which is registered into Consul.\n+     */\n+    public static ConsulUpdatingListenerBuilder builder(String serviceName) {\n+        return new ConsulUpdatingListenerBuilder(serviceName);\n+    }\n+\n+    private final ConsulClient consulClient;\n+    private final String serviceName;\n+\n+    @Nullable\n+    private final Endpoint endpoint;\n+    @Nullable\n+    private final Check check;\n+    @Nullable\n+    private String serviceId;\n+\n+    ConsulUpdatingListener(ConsulClient consulClient, String serviceName, @Nullable Endpoint endpoint,\n+                           @Nullable URI checkUrl, @Nullable HttpMethod checkMethod, String checkInterval) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a02470b585130671174b3d40bbd625f29d8255fa"}, "originalPosition": 67}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da1829dbbac6e63cf798a0cbed4ede6b6dae86e6", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/da1829dbbac6e63cf798a0cbed4ede6b6dae86e6", "committedDate": "2020-11-16T22:39:24Z", "message": "Apply reviews - use HEAD method as the default\n\n- use HEAD as the default method in `ConsulUpdatingListenerBuilder`\n- use byte[] instead of String return in `CatalogClient`\n- trivial modifications"}, "afterCommit": {"oid": "6c51302cc21c8c4beaf4787bcc82df7d050a7f72", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/6c51302cc21c8c4beaf4787bcc82df7d050a7f72", "committedDate": "2020-11-16T22:59:19Z", "message": "Apply reviews - use HEAD method as the default\n\n- use HEAD as the default method in `ConsulUpdatingListenerBuilder`\n- use byte[] instead of String return in `CatalogClient`\n- trivial modifications"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e29241a19976b4ebdc4a7c8967d454c98d2b9a0f", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/e29241a19976b4ebdc4a7c8967d454c98d2b9a0f", "committedDate": "2020-11-17T12:24:17Z", "message": "Simplify builder classes\n\n* pass URI on constructor of builders\n  - ConsulClientBuilder\n  - ConsulEndpointGroupBuilder\n  - ConsulUpdatingListenerBuilder"}, "afterCommit": {"oid": "f5cc84a764be9673f9f9dc2b394c848a93ec6062", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/f5cc84a764be9673f9f9dc2b394c848a93ec6062", "committedDate": "2020-11-19T08:38:20Z", "message": "Simplify builder classes\n\n* pass URI on constructor of builders\n  - ConsulClientBuilder\n  - ConsulEndpointGroupBuilder\n  - ConsulUpdatingListenerBuilder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "864328cd35bef6812addf184c41e4c39061a07a7", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/864328cd35bef6812addf184c41e4c39061a07a7", "committedDate": "2020-11-19T13:51:56Z", "message": "Hide JavaDocs of internal APIs\n\nIntroduce a builder interface ConsulConfigSetters\nMake ConsulClientBuilder, ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder implement ConsulConfigSetters.\nMake ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder implement ConsulConfigSetters by forwarding the calls to ConsulClientBuilder.\nConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder do not extend ConsulClientBuilder anymore. They just have ConsulClientBuilder as a member field and delegate calls."}, "afterCommit": {"oid": "1bfc0b4d145dbc731ca0d834133b5c678e288092", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/1bfc0b4d145dbc731ca0d834133b5c678e288092", "committedDate": "2020-11-20T01:40:38Z", "message": "Hide JavaDocs of internal APIs\n\nIntroduce a builder interface ConsulConfigSetters\nMake ConsulClientBuilder, ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder implement ConsulConfigSetters.\nMake ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder implement ConsulConfigSetters by forwarding the calls to ConsulClientBuilder.\nConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder do not extend ConsulClientBuilder anymore. They just have ConsulClientBuilder as a member field and delegate calls."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1bfc0b4d145dbc731ca0d834133b5c678e288092", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/1bfc0b4d145dbc731ca0d834133b5c678e288092", "committedDate": "2020-11-20T01:40:38Z", "message": "Hide JavaDocs of internal APIs\n\nIntroduce a builder interface ConsulConfigSetters\nMake ConsulClientBuilder, ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder implement ConsulConfigSetters.\nMake ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder implement ConsulConfigSetters by forwarding the calls to ConsulClientBuilder.\nConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder do not extend ConsulClientBuilder anymore. They just have ConsulClientBuilder as a member field and delegate calls."}, "afterCommit": {"oid": "2d5afd82c48a9e5168cd0db8c88f3025c99c5363", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/2d5afd82c48a9e5168cd0db8c88f3025c99c5363", "committedDate": "2020-11-20T01:44:53Z", "message": "Hide JavaDocs of internal APIs\n\n- Introduce a builder interface ConsulConfigSetters\n- Make ConsulClientBuilder, ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters.\n- Make ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters by forwarding the calls to ConsulClientBuilder.\n- ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder do not extend ConsulClientBuilder anymore.\n  They just have ConsulClientBuilder as a member field and delegate calls."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d5afd82c48a9e5168cd0db8c88f3025c99c5363", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/2d5afd82c48a9e5168cd0db8c88f3025c99c5363", "committedDate": "2020-11-20T01:44:53Z", "message": "Hide JavaDocs of internal APIs\n\n- Introduce a builder interface ConsulConfigSetters\n- Make ConsulClientBuilder, ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters.\n- Make ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters by forwarding the calls to ConsulClientBuilder.\n- ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder do not extend ConsulClientBuilder anymore.\n  They just have ConsulClientBuilder as a member field and delegate calls."}, "afterCommit": {"oid": "41c1bdf89aa4ed367cb977c4c7c443da007fa22d", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/41c1bdf89aa4ed367cb977c4c7c443da007fa22d", "committedDate": "2020-11-20T02:42:02Z", "message": "Hide JavaDocs of internal APIs\n\n- Introduce a builder interface ConsulConfigSetters\n- Make ConsulClientBuilder, ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters.\n- Make ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters by forwarding the calls to ConsulClientBuilder.\n- ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder do not extend ConsulClientBuilder anymore.\n  They just have ConsulClientBuilder as a member field and delegate calls."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "41c1bdf89aa4ed367cb977c4c7c443da007fa22d", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/41c1bdf89aa4ed367cb977c4c7c443da007fa22d", "committedDate": "2020-11-20T02:42:02Z", "message": "Hide JavaDocs of internal APIs\n\n- Introduce a builder interface ConsulConfigSetters\n- Make ConsulClientBuilder, ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters.\n- Make ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters by forwarding the calls to ConsulClientBuilder.\n- ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder do not extend ConsulClientBuilder anymore.\n  They just have ConsulClientBuilder as a member field and delegate calls."}, "afterCommit": {"oid": "a177941e345c599eebe2fb1e1c6f5d964e828b94", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/a177941e345c599eebe2fb1e1c6f5d964e828b94", "committedDate": "2020-11-20T05:56:22Z", "message": "Hide JavaDocs of internal APIs\n\n- Introduce a builder interface ConsulConfigSetters\n- Make ConsulClientBuilder, ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters.\n- Make ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters by forwarding the calls to ConsulClientBuilder.\n- ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder do not extend ConsulClientBuilder anymore.\n  They just have ConsulClientBuilder as a member field and delegate calls."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a177941e345c599eebe2fb1e1c6f5d964e828b94", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/a177941e345c599eebe2fb1e1c6f5d964e828b94", "committedDate": "2020-11-20T05:56:22Z", "message": "Hide JavaDocs of internal APIs\n\n- Introduce a builder interface ConsulConfigSetters\n- Make ConsulClientBuilder, ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters.\n- Make ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters by forwarding the calls to ConsulClientBuilder.\n- ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder do not extend ConsulClientBuilder anymore.\n  They just have ConsulClientBuilder as a member field and delegate calls."}, "afterCommit": {"oid": "9ccb508c74ae372ba7f1702de405861d570f131a", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/9ccb508c74ae372ba7f1702de405861d570f131a", "committedDate": "2020-11-20T05:57:49Z", "message": "Hide JavaDocs of internal APIs\n\n- Introduce a builder interface ConsulConfigSetters\n- Make ConsulClientBuilder, ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters.\n- Make ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters by forwarding the calls to ConsulClientBuilder.\n- ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder do not extend ConsulClientBuilder anymore.\n  They just have ConsulClientBuilder as a member field and delegate calls."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjM2NDA1", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-538236405", "createdAt": "2020-11-25T08:02:33Z", "commit": {"oid": "9ccb508c74ae372ba7f1702de405861d570f131a"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwODowMzoyMFrOH5nLcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwODowNzozNlrOH5nUAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE3Mjc4Ng==", "bodyText": "We should not mention a class in an internal package because we hide them all.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Sets properties for building {@code ConsulClient}.\n          \n          \n            \n             * Sets properties for building a Consul client.", "url": "https://github.com/line/armeria/pull/3002#discussion_r530172786", "createdAt": "2020-11-25T08:03:20Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/common/consul/ConsulConfigSetters.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.consul;\n+\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+\n+/**\n+ * Sets properties for building {@code ConsulClient}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ccb508c74ae372ba7f1702de405861d570f131a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE3NDAyNQ==", "bodyText": "to -> a", "url": "https://github.com/line/armeria/pull/3002#discussion_r530174025", "createdAt": "2020-11-25T08:05:49Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClient.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.net.URI;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+\n+import com.linecorp.armeria.client.ClientDecoration;\n+import com.linecorp.armeria.client.ClientOptions;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.WebClientBuilder;\n+import com.linecorp.armeria.client.retry.RetryRule;\n+import com.linecorp.armeria.client.retry.RetryingClient;\n+import com.linecorp.armeria.common.HttpHeaderNames;\n+import com.linecorp.armeria.common.HttpResponse;\n+\n+/**\n+ * A client for accessing to Consul agent API server.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ccb508c74ae372ba7f1702de405861d570f131a"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE3NDQ0OQ==", "bodyText": "Could be final\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class ConsulClientBuilder implements ConsulConfigSetters {\n          \n          \n            \n            public final class ConsulClientBuilder implements ConsulConfigSetters {", "url": "https://github.com/line/armeria/pull/3002#discussion_r530174449", "createdAt": "2020-11-25T08:06:38Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.regex.Pattern;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.consul.ConsulConfigSetters;\n+\n+public class ConsulClientBuilder implements ConsulConfigSetters {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ccb508c74ae372ba7f1702de405861d570f131a"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE3NDY4NQ==", "bodyText": "Could be package-local:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                protected ConsulClientBuilder(URI consulUri) {\n          \n          \n            \n                ConsulClientBuilder(URI consulUri) {", "url": "https://github.com/line/armeria/pull/3002#discussion_r530174685", "createdAt": "2020-11-25T08:07:05Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.regex.Pattern;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.consul.ConsulConfigSetters;\n+\n+public class ConsulClientBuilder implements ConsulConfigSetters {\n+    public static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+    private static final Pattern CONSUL_API_VERSION_PATTERN = Pattern.compile(\"^v[0-9][-._a-zA-Z0-9]*$\");\n+\n+    private final URI consulUri;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+\n+    protected ConsulClientBuilder(URI consulUri) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ccb508c74ae372ba7f1702de405861d570f131a"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE3NDk3OQ==", "bodyText": "final would be redundant if we make this class final.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public final ConsulClient build() {\n          \n          \n            \n                public ConsulClient build() {", "url": "https://github.com/line/armeria/pull/3002#discussion_r530174979", "createdAt": "2020-11-25T08:07:36Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/internal/consul/ConsulClientBuilder.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.util.regex.Pattern;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.consul.ConsulConfigSetters;\n+\n+public class ConsulClientBuilder implements ConsulConfigSetters {\n+    public static final String DEFAULT_CONSUL_API_VERSION = \"v1\";\n+    private static final Pattern CONSUL_API_VERSION_PATTERN = Pattern.compile(\"^v[0-9][-._a-zA-Z0-9]*$\");\n+\n+    private final URI consulUri;\n+    private String consulApiVersion = DEFAULT_CONSUL_API_VERSION;\n+    @Nullable\n+    private String consulToken;\n+\n+    protected ConsulClientBuilder(URI consulUri) {\n+        this.consulUri = requireNonNull(consulUri, \"consulUri\");\n+    }\n+\n+    @Override\n+    public ConsulClientBuilder consulApiVersion(String consulApiVersion) {\n+        requireNonNull(consulApiVersion, \"consulApiVersion\");\n+        checkArgument(CONSUL_API_VERSION_PATTERN.matcher(consulApiVersion).matches(),\n+                      \"consulApiVersion: %s (expected: a version string that starts with 'v', e.g. 'v1')\",\n+                      consulApiVersion);\n+        this.consulApiVersion = consulApiVersion;\n+        return this;\n+    }\n+\n+    @Override\n+    public ConsulClientBuilder consulToken(String consulToken) {\n+        requireNonNull(consulToken, \"consulToken\");\n+        checkArgument(!consulToken.isEmpty(), \"consulToken can't be empty\");\n+        this.consulToken = consulToken;\n+        return this;\n+    }\n+\n+    public final ConsulClient build() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ccb508c74ae372ba7f1702de405861d570f131a"}, "originalPosition": 60}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ccb508c74ae372ba7f1702de405861d570f131a", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/9ccb508c74ae372ba7f1702de405861d570f131a", "committedDate": "2020-11-20T05:57:49Z", "message": "Hide JavaDocs of internal APIs\n\n- Introduce a builder interface ConsulConfigSetters\n- Make ConsulClientBuilder, ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters.\n- Make ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters by forwarding the calls to ConsulClientBuilder.\n- ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder do not extend ConsulClientBuilder anymore.\n  They just have ConsulClientBuilder as a member field and delegate calls."}, "afterCommit": {"oid": "84a5924fc66e99b5729311f8b5e864b50076b588", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/84a5924fc66e99b5729311f8b5e864b50076b588", "committedDate": "2020-11-25T08:43:36Z", "message": "Bump embedded-consul 1.9.0\n\n- Bump embedded-consul 1.9.0\n- Make final ConsulClientBuilder\n- nit: Fix comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84a5924fc66e99b5729311f8b5e864b50076b588", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/84a5924fc66e99b5729311f8b5e864b50076b588", "committedDate": "2020-11-25T08:43:36Z", "message": "Bump embedded-consul 1.9.0\n\n- Bump embedded-consul 1.9.0\n- Make final ConsulClientBuilder\n- nit: Fix comments"}, "afterCommit": {"oid": "acb45ac61b5e755baf997687d182fe1f27cdcb1b", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/acb45ac61b5e755baf997687d182fe1f27cdcb1b", "committedDate": "2020-11-25T08:46:26Z", "message": "Bump Consul 1.9.0 for testing\n\n- Bump Consul 1.9.0 for testing\n- Make final ConsulClientBuilder\n- nit: Fix comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "acb45ac61b5e755baf997687d182fe1f27cdcb1b", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/acb45ac61b5e755baf997687d182fe1f27cdcb1b", "committedDate": "2020-11-25T08:46:26Z", "message": "Bump Consul 1.9.0 for testing\n\n- Bump Consul 1.9.0 for testing\n- Make final ConsulClientBuilder\n- nit: Fix comments"}, "afterCommit": {"oid": "2b1ce9a720d628559700169238a7d6b9770a91a1", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/2b1ce9a720d628559700169238a7d6b9770a91a1", "committedDate": "2020-11-25T08:48:41Z", "message": "Bump Consul 1.9.0 for testing\n\n- Bump Consul 1.9.0 for testing\n- Make final ConsulClientBuilder\n- nit: Fix comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjcyNTg0", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-538272584", "createdAt": "2020-11-25T08:52:39Z", "commit": {"oid": "2b1ce9a720d628559700169238a7d6b9770a91a1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwODo1Mjo0MFrOH5o6EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwODo1Mjo0MFrOH5o6EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwMTEwNQ==", "bodyText": "ConsulClient -> Consul client.", "url": "https://github.com/line/armeria/pull/3002#discussion_r530201105", "createdAt": "2020-11-25T08:52:40Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/common/consul/ConsulConfigSetters.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.consul;\n+\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+\n+/**\n+ * Sets properties for building a ConsulClient.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b1ce9a720d628559700169238a7d6b9770a91a1"}, "originalPosition": 21}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b1ce9a720d628559700169238a7d6b9770a91a1", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/2b1ce9a720d628559700169238a7d6b9770a91a1", "committedDate": "2020-11-25T08:48:41Z", "message": "Bump Consul 1.9.0 for testing\n\n- Bump Consul 1.9.0 for testing\n- Make final ConsulClientBuilder\n- nit: Fix comments"}, "afterCommit": {"oid": "a973c7772da42f9ba587a3f8a691fdc1df818205", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/a973c7772da42f9ba587a3f8a691fdc1df818205", "committedDate": "2020-11-25T08:55:28Z", "message": "Bump Consul 1.9.0 for testing\n\n- Bump Consul 1.9.0 for testing\n- Make final ConsulClientBuilder\n- nit: Fix comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjczMzgx", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-538273381", "createdAt": "2020-11-25T08:53:42Z", "commit": {"oid": "2b1ce9a720d628559700169238a7d6b9770a91a1"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwODo1Mzo0MlrOH5o8gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwOTowMDoxOVrOH5pNtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwMTcyOA==", "bodyText": "Could you annotate this class with @UnstableApi?", "url": "https://github.com/line/armeria/pull/3002#discussion_r530201728", "createdAt": "2020-11-25T08:53:42Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroup.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.util.List;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ScheduledFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.ClientRequestContextCaptor;\n+import com.linecorp.armeria.client.Clients;\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.endpoint.DynamicEndpointGroup;\n+import com.linecorp.armeria.client.endpoint.EndpointGroup;\n+import com.linecorp.armeria.client.endpoint.EndpointSelectionStrategy;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+\n+import io.netty.channel.EventLoop;\n+\n+/**\n+ * A Consul-based {@link EndpointGroup} implementation that retrieves the list of {@link Endpoint}s\n+ * from Consul using <a href=\"https://www.consul.io/api\">Consul's HTTP API</a> and updates the\n+ * {@link Endpoint}s periodically.\n+ */\n+public final class ConsulEndpointGroup extends DynamicEndpointGroup {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b1ce9a720d628559700169238a7d6b9770a91a1"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwMTkwNA==", "bodyText": "Could you annotate this class with @UnstableApi?", "url": "https://github.com/line/armeria/pull/3002#discussion_r530201904", "createdAt": "2020-11-25T08:53:58Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupBuilder.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import com.linecorp.armeria.client.endpoint.EndpointSelectionStrategy;\n+import com.linecorp.armeria.common.consul.ConsulConfigSetters;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListenerBuilder;\n+\n+/**\n+ * A builder class for {@link ConsulEndpointGroup}.\n+ * <h3>Examples</h3>\n+ * <pre>{@code\n+ * ConsulEndpointGroup endpointGroup = ConsulEndpointGroup.builder(consulUri, \"myService\")\n+ *                                                        .build();\n+ * List<Endpoint> endpoints = endpointGroup.endpoints();\n+ * sb.serverListener(listener);\n+ * }</pre>\n+ */\n+public final class ConsulEndpointGroupBuilder implements ConsulConfigSetters {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b1ce9a720d628559700169238a7d6b9770a91a1"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwMjA0NA==", "bodyText": "Could you annotate this package with @UnstableApi?", "url": "https://github.com/line/armeria/pull/3002#discussion_r530202044", "createdAt": "2020-11-25T08:54:11Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/client/consul/package-info.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/**\n+ * Consul-based {@link com.linecorp.armeria.client.endpoint.EndpointGroup} implementation.\n+ */\n+@NonNullByDefault\n+package com.linecorp.armeria.client.consul;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b1ce9a720d628559700169238a7d6b9770a91a1"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwMjE1NQ==", "bodyText": "Could you annotate this class with @UnstableApi?", "url": "https://github.com/line/armeria/pull/3002#discussion_r530202155", "createdAt": "2020-11-25T08:54:20Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/common/consul/ConsulConfigSetters.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.consul;\n+\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+\n+/**\n+ * Sets properties for building a ConsulClient.\n+ */\n+public interface ConsulConfigSetters {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b1ce9a720d628559700169238a7d6b9770a91a1"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwMzc5Mw==", "bodyText": "Could you annotate this package with @UnstableApi?", "url": "https://github.com/line/armeria/pull/3002#discussion_r530203793", "createdAt": "2020-11-25T08:56:52Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/common/consul/package-info.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+/**\n+ * Various classes used internally. Anything in this package can be changed or removed at any time.\n+ */\n+@NonNullByDefault\n+package com.linecorp.armeria.common.consul;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a973c7772da42f9ba587a3f8a691fdc1df818205"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwNDM0Mw==", "bodyText": "Could you annotate this class with @UnstableApi?", "url": "https://github.com/line/armeria/pull/3002#discussion_r530204343", "createdAt": "2020-11-25T08:57:46Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/ConsulUpdatingListener.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.consul;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.Inet4Address;\n+import java.net.URI;\n+import java.util.concurrent.ThreadLocalRandom;\n+\n+import javax.annotation.Nullable;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.util.SystemInfo;\n+import com.linecorp.armeria.internal.consul.Check;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerListener;\n+import com.linecorp.armeria.server.ServerListenerAdapter;\n+import com.linecorp.armeria.server.ServerPort;\n+\n+/**\n+ * A {@link ServerListener} which registers the current {@link Server} to\n+ * <a href=\"https://www.consul.io\">Consul</a>.\n+ */\n+public final class ConsulUpdatingListener extends ServerListenerAdapter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a973c7772da42f9ba587a3f8a691fdc1df818205"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwNDQ0MQ==", "bodyText": "Could you annotate this class with @UnstableApi?", "url": "https://github.com/line/armeria/pull/3002#discussion_r530204441", "createdAt": "2020-11-25T08:57:57Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/ConsulUpdatingListenerBuilder.java", "diffHunk": "@@ -0,0 +1,160 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.server.consul;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.HttpMethod;\n+import com.linecorp.armeria.common.consul.ConsulConfigSetters;\n+import com.linecorp.armeria.internal.consul.ConsulClient;\n+import com.linecorp.armeria.internal.consul.ConsulClientBuilder;\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Builds a new {@link ConsulUpdatingListener}, which registers the server to Consul cluster.\n+ * <h3>Examples</h3>\n+ * <pre>{@code\n+ * ConsulUpdatingListener listener = ConsulUpdatingListener.builder(consulUri, \"myService\")\n+ *                                                         .build();\n+ * ServerBuilder sb = Server.builder();\n+ * sb.serverListener(listener);\n+ * }</pre>\n+ */\n+public final class ConsulUpdatingListenerBuilder implements ConsulConfigSetters {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a973c7772da42f9ba587a3f8a691fdc1df818205"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwNDYwMA==", "bodyText": "Could you annotate this package with @UnstableApi?", "url": "https://github.com/line/armeria/pull/3002#discussion_r530204600", "createdAt": "2020-11-25T08:58:12Z", "author": {"login": "trustin"}, "path": "consul/src/main/java/com/linecorp/armeria/server/consul/package-info.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/**\n+ * Automatic service registration and discovery with <a href=\"https://consul.io/\">Consul</a>.\n+ **/\n+@NonNullByDefault\n+package com.linecorp.armeria.server.consul;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a973c7772da42f9ba587a3f8a691fdc1df818205"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwNTE4MQ==", "bodyText": "How about removing public if the test runs without it?", "url": "https://github.com/line/armeria/pull/3002#discussion_r530205181", "createdAt": "2020-11-25T08:59:01Z", "author": {"login": "trustin"}, "path": "consul/src/test/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright 2016 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.awaitility.Awaitility.await;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.internal.consul.ConsulTestBase;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerListener;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListener;\n+\n+public class ConsulEndpointGroupTest extends ConsulTestBase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a973c7772da42f9ba587a3f8a691fdc1df818205"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwNTM4MQ==", "bodyText": "How about removing public if it's not necessary?", "url": "https://github.com/line/armeria/pull/3002#discussion_r530205381", "createdAt": "2020-11-25T08:59:15Z", "author": {"login": "trustin"}, "path": "consul/src/test/java/com/linecorp/armeria/client/consul/ConsulEndpointGroupTest.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright 2016 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.consul;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.awaitility.Awaitility.await;\n+\n+import java.net.URI;\n+import java.time.Duration;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.internal.consul.ConsulTestBase;\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.server.ServerListener;\n+import com.linecorp.armeria.server.consul.ConsulUpdatingListener;\n+\n+public class ConsulEndpointGroupTest extends ConsulTestBase {\n+\n+    static final List<Server> servers = new ArrayList<>();\n+\n+    @BeforeAll\n+    static void startServers() {\n+\n+        for (Endpoint endpoint : sampleEndpoints) {\n+            final Server server = Server.builder()\n+                                        .http(endpoint.port())\n+                                        .service(\"/\", new EchoService())\n+                                        .build();\n+            final ServerListener listener =\n+                    ConsulUpdatingListener.builder(URI.create(\"http://127.0.0.1:\" + consul().getHttpPort()),\n+                                                   serviceName)\n+                                          .consulToken(CONSUL_TOKEN)\n+                                          .build();\n+            server.addListener(listener);\n+            server.start().join();\n+            servers.add(server);\n+        }\n+    }\n+\n+    @AfterAll\n+    static void stopServers() throws Exception {\n+        servers.forEach(Server::close);\n+        servers.clear();\n+    }\n+\n+    @Test\n+    void testConsulEndpointGroupWithClient() {\n+        try (ConsulEndpointGroup endpointGroup =\n+                     ConsulEndpointGroup.builder(URI.create(\"http://127.0.0.1:\" + consul().getHttpPort()),\n+                                                 serviceName)\n+                                        .consulApiVersion(\"v1\")\n+                                        .consulToken(CONSUL_TOKEN)\n+                                        .registryFetchIntervalMillis(1000)\n+                                        .build()) {\n+            await().atMost(3, TimeUnit.SECONDS)\n+                   .untilAsserted(() ->\n+                                  assertThat(endpointGroup.endpoints()).hasSameSizeAs(sampleEndpoints));\n+            // stop a server\n+            servers.get(0).stop();\n+            await().atMost(3, TimeUnit.SECONDS)\n+                   .untilAsserted(() ->\n+                                  assertThat(endpointGroup.endpoints()).hasSize(sampleEndpoints.size() - 1));\n+            // restart the server\n+            servers.get(0).start();\n+            await().atMost(3, TimeUnit.SECONDS)\n+                   .untilAsserted(() ->\n+                                  assertThat(endpointGroup.endpoints()).hasSameSizeAs(sampleEndpoints));\n+        }\n+    }\n+\n+    @Test\n+    void testConsulEndpointGroupWithUrl() {\n+        try (ConsulEndpointGroup endpointGroup =\n+                     ConsulEndpointGroup.builder(URI.create(\"http://127.0.0.1:\" + consul().getHttpPort()),\n+                                                 serviceName)\n+                                        .consulToken(CONSUL_TOKEN)\n+                                        .registryFetchInterval(Duration.ofSeconds(1))\n+                                        .build()) {\n+            await().atMost(3, TimeUnit.SECONDS)\n+                   .untilAsserted(() ->\n+                                  assertThat(endpointGroup.endpoints()).hasSameSizeAs(sampleEndpoints));\n+            // stop a server\n+            servers.get(0).stop().join();\n+            await().atMost(3, TimeUnit.SECONDS)\n+                   .untilAsserted(() ->\n+                                  assertThat(endpointGroup.endpoints()).hasSize(sampleEndpoints.size() - 1));\n+            // restart the server\n+            servers.get(0).start().join();\n+            await().atMost(3, TimeUnit.SECONDS)\n+                   .untilAsserted(() ->\n+                                  assertThat(endpointGroup.endpoints()).hasSameSizeAs(sampleEndpoints));\n+        }\n+    }\n+\n+    @Test\n+    public void testSelectStrategy() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a973c7772da42f9ba587a3f8a691fdc1df818205"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwNjEzMg==", "bodyText": "Could be protected rather than public?", "url": "https://github.com/line/armeria/pull/3002#discussion_r530206132", "createdAt": "2020-11-25T09:00:19Z", "author": {"login": "trustin"}, "path": "consul/src/test/java/com/linecorp/armeria/internal/consul/ConsulTestBase.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.net.ServerSocket;\n+import java.net.URI;\n+import java.util.Random;\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.ThreadLocalRandom;\n+\n+import javax.annotation.Nullable;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+\n+import com.google.common.collect.ImmutableSet;\n+import com.pszymczyk.consul.ConsulProcess;\n+import com.pszymczyk.consul.ConsulStarterBuilder;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.common.util.CompletionActions;\n+import com.linecorp.armeria.server.AbstractHttpService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+public abstract class ConsulTestBase {\n+\n+    protected static final String CONSUL_TOKEN = UUID.randomUUID().toString();\n+    protected static final String serviceName = \"testService\";\n+    protected static final Set<Endpoint> sampleEndpoints;\n+\n+    static {\n+        final int[] ports = unusedPorts(3);\n+        sampleEndpoints = ImmutableSet.of(Endpoint.of(\"localhost\", ports[0]).withWeight(2),\n+                                          Endpoint.of(\"127.0.0.1\", ports[1]).withWeight(4),\n+                                          Endpoint.of(\"127.0.0.1\", ports[2]).withWeight(2));\n+    }\n+\n+    protected ConsulTestBase() {\n+    }\n+\n+    @Nullable\n+    private static ConsulProcess consul;\n+\n+    @Nullable\n+    private static ConsulClient consulClient;\n+\n+    @BeforeAll\n+    static void start() throws Throwable {\n+        // Initialize Consul embedded server for testing\n+        // This EmbeddedConsul tested with Consul version above 1.4.0\n+        consul = ConsulStarterBuilder.consulStarter()\n+                                     .withConsulVersion(\"1.9.0\")\n+                                     .withCustomConfig(aclConfiguration(CONSUL_TOKEN))\n+                                     .withToken(CONSUL_TOKEN)\n+                                     .build().start();\n+        // Initialize Consul client\n+        consulClient = ConsulClient.builder(URI.create(\"http://127.0.0.1:\" + consul.getHttpPort()))\n+                                   .consulToken(CONSUL_TOKEN)\n+                                   .build();\n+    }\n+\n+    @AfterAll\n+    static void stop() throws Throwable {\n+        if (consul != null) {\n+            consul.close();\n+            consul = null;\n+        }\n+        if (consulClient != null) {\n+            consulClient = null;\n+        }\n+    }\n+\n+    protected static ConsulProcess consul() {\n+        if (consul == null) {\n+            throw new IllegalStateException(\"embedded consul has not initialized\");\n+        }\n+        return consul;\n+    }\n+\n+    protected static ConsulClient client() {\n+        if (consulClient == null) {\n+            throw new IllegalStateException(\"consul client has not initialized\");\n+        }\n+        return consulClient;\n+    }\n+\n+    protected static int[] unusedPorts(int numPorts) {\n+        final int[] ports = new int[numPorts];\n+        final Random random = ThreadLocalRandom.current();\n+        for (int i = 0; i < numPorts; i++) {\n+            for (;;) {\n+                final int candidatePort = random.nextInt(64512) + 1024;\n+                try (ServerSocket ss = new ServerSocket()) {\n+                    ss.bind(new InetSocketAddress(\"127.0.0.1\", candidatePort));\n+                    ports[i] = candidatePort;\n+                    break;\n+                } catch (IOException e) {\n+                    // Port in use or unable to bind.\n+                    continue;\n+                }\n+            }\n+        }\n+\n+        return ports;\n+    }\n+\n+    private static String aclConfiguration(String token) {\n+        return\n+                new StringBuilder()\n+                        .append('{')\n+                        .append(\"\\\"acl\\\": {\")\n+                        .append(\"\\\"enabled\\\": true, \")\n+                        .append(\"\\\"default_policy\\\": \\\"deny\\\", \")\n+                        .append(\"\\\"down_policy\\\": \\\"deny\\\", \")\n+                        .append(\"\\\"tokens\\\": {\")\n+                        .append(\"    \\\"agent\\\": \\\"\").append(token).append(\"\\\", \")\n+                        .append(\"    \\\"master\\\": \\\"\").append(token).append(\"\\\", \")\n+                        .append(\"    }\")\n+                        .append('}')\n+                        .toString();\n+    }\n+\n+    public static class EchoService extends AbstractHttpService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a973c7772da42f9ba587a3f8a691fdc1df818205"}, "originalPosition": 144}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjQ5MTg4", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-538249188", "createdAt": "2020-11-25T08:21:50Z", "commit": {"oid": "9ccb508c74ae372ba7f1702de405861d570f131a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMDo0MDozOFrOH6Vq5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMDo0MDozOFrOH6Vq5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkzNDUwMQ==", "bodyText": "It can't be 'protected'. Otherwise, we have to make an empty public constructor.", "url": "https://github.com/line/armeria/pull/3002#discussion_r530934501", "createdAt": "2020-11-26T10:40:38Z", "author": {"login": "eugene70"}, "path": "consul/src/test/java/com/linecorp/armeria/internal/consul/ConsulTestBase.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.consul;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.net.ServerSocket;\n+import java.net.URI;\n+import java.util.Random;\n+import java.util.Set;\n+import java.util.UUID;\n+import java.util.concurrent.ThreadLocalRandom;\n+\n+import javax.annotation.Nullable;\n+\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+\n+import com.google.common.collect.ImmutableSet;\n+import com.pszymczyk.consul.ConsulProcess;\n+import com.pszymczyk.consul.ConsulStarterBuilder;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.common.AggregatedHttpRequest;\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.common.util.CompletionActions;\n+import com.linecorp.armeria.server.AbstractHttpService;\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+public abstract class ConsulTestBase {\n+\n+    protected static final String CONSUL_TOKEN = UUID.randomUUID().toString();\n+    protected static final String serviceName = \"testService\";\n+    protected static final Set<Endpoint> sampleEndpoints;\n+\n+    static {\n+        final int[] ports = unusedPorts(3);\n+        sampleEndpoints = ImmutableSet.of(Endpoint.of(\"localhost\", ports[0]).withWeight(2),\n+                                          Endpoint.of(\"127.0.0.1\", ports[1]).withWeight(4),\n+                                          Endpoint.of(\"127.0.0.1\", ports[2]).withWeight(2));\n+    }\n+\n+    protected ConsulTestBase() {\n+    }\n+\n+    @Nullable\n+    private static ConsulProcess consul;\n+\n+    @Nullable\n+    private static ConsulClient consulClient;\n+\n+    @BeforeAll\n+    static void start() throws Throwable {\n+        // Initialize Consul embedded server for testing\n+        // This EmbeddedConsul tested with Consul version above 1.4.0\n+        consul = ConsulStarterBuilder.consulStarter()\n+                                     .withConsulVersion(\"1.9.0\")\n+                                     .withCustomConfig(aclConfiguration(CONSUL_TOKEN))\n+                                     .withToken(CONSUL_TOKEN)\n+                                     .build().start();\n+        // Initialize Consul client\n+        consulClient = ConsulClient.builder(URI.create(\"http://127.0.0.1:\" + consul.getHttpPort()))\n+                                   .consulToken(CONSUL_TOKEN)\n+                                   .build();\n+    }\n+\n+    @AfterAll\n+    static void stop() throws Throwable {\n+        if (consul != null) {\n+            consul.close();\n+            consul = null;\n+        }\n+        if (consulClient != null) {\n+            consulClient = null;\n+        }\n+    }\n+\n+    protected static ConsulProcess consul() {\n+        if (consul == null) {\n+            throw new IllegalStateException(\"embedded consul has not initialized\");\n+        }\n+        return consul;\n+    }\n+\n+    protected static ConsulClient client() {\n+        if (consulClient == null) {\n+            throw new IllegalStateException(\"consul client has not initialized\");\n+        }\n+        return consulClient;\n+    }\n+\n+    protected static int[] unusedPorts(int numPorts) {\n+        final int[] ports = new int[numPorts];\n+        final Random random = ThreadLocalRandom.current();\n+        for (int i = 0; i < numPorts; i++) {\n+            for (;;) {\n+                final int candidatePort = random.nextInt(64512) + 1024;\n+                try (ServerSocket ss = new ServerSocket()) {\n+                    ss.bind(new InetSocketAddress(\"127.0.0.1\", candidatePort));\n+                    ports[i] = candidatePort;\n+                    break;\n+                } catch (IOException e) {\n+                    // Port in use or unable to bind.\n+                    continue;\n+                }\n+            }\n+        }\n+\n+        return ports;\n+    }\n+\n+    private static String aclConfiguration(String token) {\n+        return\n+                new StringBuilder()\n+                        .append('{')\n+                        .append(\"\\\"acl\\\": {\")\n+                        .append(\"\\\"enabled\\\": true, \")\n+                        .append(\"\\\"default_policy\\\": \\\"deny\\\", \")\n+                        .append(\"\\\"down_policy\\\": \\\"deny\\\", \")\n+                        .append(\"\\\"tokens\\\": {\")\n+                        .append(\"    \\\"agent\\\": \\\"\").append(token).append(\"\\\", \")\n+                        .append(\"    \\\"master\\\": \\\"\").append(token).append(\"\\\", \")\n+                        .append(\"    }\")\n+                        .append('}')\n+                        .toString();\n+    }\n+\n+    public static class EchoService extends AbstractHttpService {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIwNjEzMg=="}, "originalCommit": {"oid": "a973c7772da42f9ba587a3f8a691fdc1df818205"}, "originalPosition": 144}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a973c7772da42f9ba587a3f8a691fdc1df818205", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/a973c7772da42f9ba587a3f8a691fdc1df818205", "committedDate": "2020-11-25T08:55:28Z", "message": "Bump Consul 1.9.0 for testing\n\n- Bump Consul 1.9.0 for testing\n- Make final ConsulClientBuilder\n- nit: Fix comments"}, "afterCommit": {"oid": "e7ace34b03fb4bfce694436214493d4b3b2c9f27", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/e7ace34b03fb4bfce694436214493d4b3b2c9f27", "committedDate": "2020-11-26T11:02:00Z", "message": "Annotate @UnstableApi, Add option starting Consul\n\n- Annotate @UnstableApi into all public objects\n- Add option withWaitTimeout(60), default is 60s"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e7ace34b03fb4bfce694436214493d4b3b2c9f27", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/e7ace34b03fb4bfce694436214493d4b3b2c9f27", "committedDate": "2020-11-26T11:02:00Z", "message": "Annotate @UnstableApi, Add option starting Consul\n\n- Annotate @UnstableApi into all public objects\n- Add option withWaitTimeout(60), default is 60s"}, "afterCommit": {"oid": "17b34413057e642c7847703da434ee8895abaaf3", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/17b34413057e642c7847703da434ee8895abaaf3", "committedDate": "2020-11-26T11:16:17Z", "message": "Annotate @UnstableApi, Add option starting Consul\n\n- Annotate @UnstableApi into all public objects\n- Add option withWaitTimeout(120), default is 30s"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17b34413057e642c7847703da434ee8895abaaf3", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/17b34413057e642c7847703da434ee8895abaaf3", "committedDate": "2020-11-26T11:16:17Z", "message": "Annotate @UnstableApi, Add option starting Consul\n\n- Annotate @UnstableApi into all public objects\n- Add option withWaitTimeout(120), default is 30s"}, "afterCommit": {"oid": "3105754a9a3d3923fba7daa33e43ea42da5efacb", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/3105754a9a3d3923fba7daa33e43ea42da5efacb", "committedDate": "2020-11-28T02:38:02Z", "message": "Replace deprecated RetryingClient.newDecorator()\n\nRetryingClient.newDecorator(\n  RetryConfig.builder\n    (RetryRule.failsafe())\n      .maxTotalAttempts(3).build())\n\ninstead of:\n\n  RetryingClient.newDecorator(RetryRule.failsafe(), 3)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3105754a9a3d3923fba7daa33e43ea42da5efacb", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/3105754a9a3d3923fba7daa33e43ea42da5efacb", "committedDate": "2020-11-28T02:38:02Z", "message": "Replace deprecated RetryingClient.newDecorator()\n\nRetryingClient.newDecorator(\n  RetryConfig.builder\n    (RetryRule.failsafe())\n      .maxTotalAttempts(3).build())\n\ninstead of:\n\n  RetryingClient.newDecorator(RetryRule.failsafe(), 3)"}, "afterCommit": {"oid": "c75b36af740d52c47317ac8f19f9abe80caf5c4c", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/c75b36af740d52c47317ac8f19f9abe80caf5c4c", "committedDate": "2020-11-28T14:50:27Z", "message": "Replace deprecated RetryingClient.newDecorator()\n\nRetryingClient.newDecorator(\n  RetryConfig.builder\n    (RetryRule.failsafe())\n      .maxTotalAttempts(3).build())\n\ninstead of:\n\n  RetryingClient.newDecorator(RetryRule.failsafe(), 3)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c75b36af740d52c47317ac8f19f9abe80caf5c4c", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/c75b36af740d52c47317ac8f19f9abe80caf5c4c", "committedDate": "2020-11-28T14:50:27Z", "message": "Replace deprecated RetryingClient.newDecorator()\n\nRetryingClient.newDecorator(\n  RetryConfig.builder\n    (RetryRule.failsafe())\n      .maxTotalAttempts(3).build())\n\ninstead of:\n\n  RetryingClient.newDecorator(RetryRule.failsafe(), 3)"}, "afterCommit": {"oid": "bf71e04a998fc349c2db7afcc3d9f42502a48126", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/bf71e04a998fc349c2db7afcc3d9f42502a48126", "committedDate": "2020-11-28T16:06:16Z", "message": "Replace deprecated RetryingClient.newDecorator()\n\nRetryingClient.newDecorator(RetryConfig.builder(RetryRule.failsafe())\n                                       .maxTotalAttempts(3)\n                                       .build());\n\ninstead of:\n\n  RetryingClient.newDecorator(RetryRule.failsafe(), 3)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf71e04a998fc349c2db7afcc3d9f42502a48126", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/bf71e04a998fc349c2db7afcc3d9f42502a48126", "committedDate": "2020-11-28T16:06:16Z", "message": "Replace deprecated RetryingClient.newDecorator()\n\nRetryingClient.newDecorator(RetryConfig.builder(RetryRule.failsafe())\n                                       .maxTotalAttempts(3)\n                                       .build());\n\ninstead of:\n\n  RetryingClient.newDecorator(RetryRule.failsafe(), 3)"}, "afterCommit": {"oid": "eedd6197aaa54b8eacbaab92eac4264a39eff4c7", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/eedd6197aaa54b8eacbaab92eac4264a39eff4c7", "committedDate": "2020-11-29T14:30:29Z", "message": "Replace deprecated RetryingClient.newDecorator()\n\nRetryingClient.newDecorator(RetryConfig.builder(RetryRule.failsafe())\n                                       .maxTotalAttempts(3)\n                                       .build());\n\ninstead of:\n\n  RetryingClient.newDecorator(RetryRule.failsafe(), 3)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f709c385c2ed72a847bfcf73a4b4f3588816d53e", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/f709c385c2ed72a847bfcf73a4b4f3588816d53e", "committedDate": "2020-11-30T12:49:27Z", "message": "Support Consul service discovery\n\nMotivation:\n\n  - Issue: #194 Service discovery support (serversets, k8s, ..).\n  - Service discovery supports Consul.\n\nModifications:\n\n  - Creates consul module\n  - Add dependencies for consul and consul test server\n  - Add base client for consul\n  - Add test cases\n\nTo dos:\n\n  - Add detail clients corresponding to the each Consul API\n  - Add cached client for health checking\n  - Add ConsulEndpointGroup\n\nResult:\n\n  - Supports Consul discovery service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "195d469b6c8c595c1d2114c1446fddc3e3215699", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/195d469b6c8c595c1d2114c1446fddc3e3215699", "committedDate": "2020-11-30T12:49:27Z", "message": "Use seconds for refreshing endpoints in ConsulEndpointGroup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23a88ef255ed4512b9cf5cc53cfcf15f8128a086", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/23a88ef255ed4512b9cf5cc53cfcf15f8128a086", "committedDate": "2020-11-30T12:49:28Z", "message": "Apply reviews\n\n- Check `isClosing` again after update on `ConsulEndpointGroup`\n- Reuse instace of `CatalogClient` and `AgentServiceClient`\n- Remove `public` of `consulWebClient()` on `ConsulClient`\n- Refactor inner class `Service` on `AgentServiceClient`\n- Replace `HttpData.empty()` instead of \"\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03abce85c25180eabb8963fa12995e77364b8606", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/03abce85c25180eabb8963fa12995e77364b8606", "committedDate": "2020-11-30T12:49:29Z", "message": "Refactor whole package\n\n  - Remove low level unit tests.\n  - Create ConsulClientBuilder.\n  - Sync the manner of creating ConsulClient.\n  - Remove 'public' from class CatalogClient."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "272ef78e735df63fb946e305a00431da89aad1b5", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/272ef78e735df63fb946e305a00431da89aad1b5", "committedDate": "2020-11-30T12:49:30Z", "message": "Refactor builders using inheritance\n\n  - Add consulUri() methods to builders"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d679781edb58ad1b51b1ab3366588b637506f26d", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/d679781edb58ad1b51b1ab3366588b637506f26d", "committedDate": "2020-11-30T12:49:30Z", "message": "Support testing with v1.8.4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5397ca390996a1ca0d90e7de58697428f3846c6b", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/5397ca390996a1ca0d90e7de58697428f3846c6b", "committedDate": "2020-11-30T12:49:31Z", "message": "Apply reviews\n\n- Fix commnents\n- More checking consulUri argument\n- ..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f73f88cda7fd3bb3ea2b8af17a529cb8e0e2cf79", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/f73f88cda7fd3bb3ea2b8af17a529cb8e0e2cf79", "committedDate": "2020-11-30T12:49:32Z", "message": "Apply reviews\n\n- Milliseconds instead seconds\n- Path be URI encoded\n- ..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d86e84aaf58d8102ae222d54834b5d4f359f522e", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/d86e84aaf58d8102ae222d54834b5d4f359f522e", "committedDate": "2020-11-30T12:49:33Z", "message": "Apply reviews: regex for consulApiVersion...\n\n- check consulApiVersion with regex in ConsulClientBuilder\n- DEFAULT_CHECK_INTERVAL_MILLIS instead of DEFAULT_CHECK_INTERVAL in\n  ConsulUpdatingListenerBuilder\n- ..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fe88a584e00e1de21ab678269b939af1f81d4c5", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/3fe88a584e00e1de21ab678269b939af1f81d4c5", "committedDate": "2020-11-30T12:49:34Z", "message": "Fix consulApiVersion in ConsulClientBuilder\n- remove redundant check\n- change a check message\n- rename a constant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3cfadfb7bb999d6a39a2222af8f36765077de09", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/d3cfadfb7bb999d6a39a2222af8f36765077de09", "committedDate": "2020-11-30T12:49:35Z", "message": "Apply reviews - use HEAD method as the default\n\n- use HEAD as the default method in `ConsulUpdatingListenerBuilder`\n- use byte[] instead of String return in `CatalogClient`\n- trivial modifications"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bce8b1c6537d6f04eb4312096705c913e37571fe", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/bce8b1c6537d6f04eb4312096705c913e37571fe", "committedDate": "2020-11-30T12:49:35Z", "message": "remove contant DEFAULT_CHECK_METHOD"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c8d51e6856bb943b30ecd0aed723a4fa75a3bd1", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/6c8d51e6856bb943b30ecd0aed723a4fa75a3bd1", "committedDate": "2020-11-30T12:49:36Z", "message": "Simplify builder classes\n\n* pass URI on constructor of builders\n  - ConsulClientBuilder\n  - ConsulEndpointGroupBuilder\n  - ConsulUpdatingListenerBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cc847998bc469c134b786f51b0ce7756c5f5871", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/4cc847998bc469c134b786f51b0ce7756c5f5871", "committedDate": "2020-11-30T12:49:37Z", "message": "Hide JavaDocs of internal APIs\n\n- Introduce a builder interface ConsulConfigSetters\n- Make ConsulClientBuilder, ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters.\n- Make ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder\n  implement ConsulConfigSetters by forwarding the calls to ConsulClientBuilder.\n- ConsulEndpointGroupBuilder and ConsulUpdatingListenerBuilder do not extend ConsulClientBuilder anymore.\n  They just have ConsulClientBuilder as a member field and delegate calls."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cbf8d2deab26bdb5d8a22c561d55385f25a7ed0", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/1cbf8d2deab26bdb5d8a22c561d55385f25a7ed0", "committedDate": "2020-11-30T12:49:38Z", "message": "Bump Consul 1.9.0 for testing\n\n- Bump Consul 1.9.0 for testing\n- Make final ConsulClientBuilder\n- nit: Fix comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aef5deedda449053969650ac4d4eef24ee663b5b", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/aef5deedda449053969650ac4d4eef24ee663b5b", "committedDate": "2020-11-30T12:49:38Z", "message": "Annotate @UnstableApi, Add option starting Consul\n\n- Annotate @UnstableApi into all public objects\n- Add option withWaitTimeout(120), default is 30s"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66c94b7261c9038e64acaddc35187b42fc6a4f7b", "author": {"user": {"login": "eugene70", "name": "Eugene Kim"}}, "url": "https://github.com/line/armeria/commit/66c94b7261c9038e64acaddc35187b42fc6a4f7b", "committedDate": "2020-11-30T12:49:39Z", "message": "Replace deprecated RetryingClient.newDecorator()\n\nRetryingClient.newDecorator(RetryConfig.builder(RetryRule.failsafe())\n                                       .maxTotalAttempts(3)\n                                       .build());\n\ninstead of:\n\n  RetryingClient.newDecorator(RetryRule.failsafe(), 3)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49227c3be2865494485028827771eb44e7d9bc0b", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/49227c3be2865494485028827771eb44e7d9bc0b", "committedDate": "2020-11-30T12:49:40Z", "message": "Nits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6769bbc6ffcaf48e30af36d9770d14ecc07a0f40", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/6769bbc6ffcaf48e30af36d9770d14ecc07a0f40", "committedDate": "2020-11-30T05:59:59Z", "message": "Nits"}, "afterCommit": {"oid": "49227c3be2865494485028827771eb44e7d9bc0b", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/49227c3be2865494485028827771eb44e7d9bc0b", "committedDate": "2020-11-30T12:49:40Z", "message": "Nits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b8dd0d7aea099971607c26c42a49e07fc15da77", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/3b8dd0d7aea099971607c26c42a49e07fc15da77", "committedDate": "2020-12-01T06:31:26Z", "message": "Specifiy a download path for caching a embedded consul"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8064537a5f95bbb3ad245ad1fc0dde02cdc0dd17", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/8064537a5f95bbb3ad245ad1fc0dde02cdc0dd17", "committedDate": "2020-12-01T06:35:58Z", "message": "Change cache directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cf7763475f83a2c15b454cf5b87216b30efe470", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/8cf7763475f83a2c15b454cf5b87216b30efe470", "committedDate": "2020-12-01T06:47:25Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bd0d0048cab4f6c4995f4440e45b390bc4fa958", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/6bd0d0048cab4f6c4995f4440e45b390bc4fa958", "committedDate": "2020-12-01T07:29:45Z", "message": "Change cache folder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92fecdd905a73378945372f7a1c1a7ff92954cb2", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/92fecdd905a73378945372f7a1c1a7ff92954cb2", "committedDate": "2020-12-01T10:42:33Z", "message": "Await until consul successfully start"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1OTAzNzkx", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-545903791", "createdAt": "2020-12-07T08:02:46Z", "commit": {"oid": "92fecdd905a73378945372f7a1c1a7ff92954cb2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1OTE1ODk3", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-545915897", "createdAt": "2020-12-07T08:22:10Z", "commit": {"oid": "92fecdd905a73378945372f7a1c1a7ff92954cb2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5ODEzMjcy", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-549813272", "createdAt": "2020-12-11T05:35:38Z", "commit": {"oid": "92fecdd905a73378945372f7a1c1a7ff92954cb2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5ODEzMjk0", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-549813294", "createdAt": "2020-12-11T05:35:41Z", "commit": {"oid": "92fecdd905a73378945372f7a1c1a7ff92954cb2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5ODEzMzEz", "url": "https://github.com/line/armeria/pull/3002#pullrequestreview-549813313", "createdAt": "2020-12-11T05:35:44Z", "commit": {"oid": "92fecdd905a73378945372f7a1c1a7ff92954cb2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 87, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}