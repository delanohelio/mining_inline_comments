{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwMDc2MzI0", "number": 2533, "title": "Fix Subscriber not to throw an exception", "bodyText": "Motivation:\nAccording to https://github.com/reactive-streams/reactive-streams-jvm#2.13,\na subscriber must not throw an exception but just call Subscription.cancel().\nSome of our subscribers violated this rule so we should fix them.\nModifications:\n\nCall Subscription.cancel() instead of throwing an exception in Subscribers\n\nResult:\n\nSubscriber does not throw an exception anymore.", "createdAt": "2020-02-26T08:30:27Z", "url": "https://github.com/line/armeria/pull/2533", "merged": true, "mergeCommit": {"oid": "93c04dddbf9df3c43ff54709a084f332bfcfb12d"}, "closed": true, "closedAt": "2020-02-27T11:44:05Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcICcl5gH2gAyMzgwMDc2MzI0OmMxYjQ5ODNmMzE1MTZmN2E2NTg2NDI4YjRmZDBkMWZkMDAzODkzOTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIIfXzgFqTM2NDk5MjQ3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c1b4983f31516f7a6586428b4fd0d1fd00389390", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/c1b4983f31516f7a6586428b4fd0d1fd00389390", "committedDate": "2020-02-26T08:28:31Z", "message": "Handle exceptions thrown by Subscriber\nMotivation:\nAccording to https://github.com/reactive-streams/reactive-streams-jvm#2.13,\na subscriber must not throw an exception but just call `Subscription.cancel()`.\nSome of our subscribers violated this rule so we should fix them.\n\nModifications:\n- Call `Subscription.cancel()` instead of throwing an exception in `Subscriber`s\n\nResult:\n- Close #2475\n- `Subscriber` does not throw an exception anymore."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NzA1MDA5", "url": "https://github.com/line/armeria/pull/2533#pullrequestreview-364705009", "createdAt": "2020-02-26T08:40:38Z", "commit": {"oid": "c1b4983f31516f7a6586428b4fd0d1fd00389390"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwODo0MjoxNlrOFuiXSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQwODo0MzoxOFrOFuiZNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM0MTgzNA==", "bodyText": "I would say none of these methods should be invoked. The exceptions that were thrown in this class are like an assertion, i.e. better leaving as is?", "url": "https://github.com/line/armeria/pull/2533#discussion_r384341834", "createdAt": "2020-02-26T08:42:16Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/stream/NeverInvokedSubscriber.java", "diffHunk": "@@ -30,21 +34,22 @@\n \n     @Override\n     public void onSubscribe(Subscription s) {\n-        throw new IllegalStateException(\"onSubscribe(\" + s + ')');\n+        s.cancel();\n+        logger.warn(\"onSubscribe({}) is invoked.\", s);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1b4983f31516f7a6586428b4fd0d1fd00389390"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDM0MjMyNw==", "bodyText": "Probably better not logging, because a response can be closed by a remote peer at any time?", "url": "https://github.com/line/armeria/pull/2533#discussion_r384342327", "createdAt": "2020-02-26T08:43:18Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/server/ResponseConversionUtil.java", "diffHunk": "@@ -248,7 +252,9 @@ public void onComplete() {\n                 return;\n             }\n             if (!trailers.isEmpty()) {\n-                writer.write(trailers);\n+                if (!writer.tryWrite(trailers)) {\n+                    logger.warn(\"Failed to write a trailers: {}\", trailers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1b4983f31516f7a6586428b4fd0d1fd00389390"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdd155b6ca767d71ec1931179798ffbbf9068f69", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/bdd155b6ca767d71ec1931179798ffbbf9068f69", "committedDate": "2020-02-26T09:49:06Z", "message": "Address comments by @trustin"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0ODE0MTgx", "url": "https://github.com/line/armeria/pull/2533#pullrequestreview-364814181", "createdAt": "2020-02-26T11:13:13Z", "commit": {"oid": "bdd155b6ca767d71ec1931179798ffbbf9068f69"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMToxMzoxNFrOFunkxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMToxMzoxNFrOFunkxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQyNzIwNw==", "bodyText": "I guess IllegalStateException is better in this class because the exception does not go to the caller.", "url": "https://github.com/line/armeria/pull/2533#discussion_r384427207", "createdAt": "2020-02-26T11:13:14Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java", "diffHunk": "@@ -246,7 +247,8 @@ public void onNext(HttpObject o) {\n                 if (o instanceof HttpHeaders) {\n                     final HttpHeaders trailers = (HttpHeaders) o;\n                     if (trailers.contains(HttpHeaderNames.STATUS)) {\n-                        throw newIllegalStateException(\"published a trailers with status: \" + o);\n+                        fail(new IllegalArgumentException(\"published a trailers with status: \" + o));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdd155b6ca767d71ec1931179798ffbbf9068f69"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0ODIyMDEy", "url": "https://github.com/line/armeria/pull/2533#pullrequestreview-364822012", "createdAt": "2020-02-26T11:26:29Z", "commit": {"oid": "bdd155b6ca767d71ec1931179798ffbbf9068f69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0ODY1OTcx", "url": "https://github.com/line/armeria/pull/2533#pullrequestreview-364865971", "createdAt": "2020-02-26T12:42:50Z", "commit": {"oid": "bdd155b6ca767d71ec1931179798ffbbf9068f69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0OTkyNDc3", "url": "https://github.com/line/armeria/pull/2533#pullrequestreview-364992477", "createdAt": "2020-02-26T15:25:40Z", "commit": {"oid": "bdd155b6ca767d71ec1931179798ffbbf9068f69"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNToyNTo0MFrOFuv_3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNToyNTo0MFrOFuv_3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2NTIxMg==", "bodyText": "These comments seem very noisy. Do we need them? I feel like just leaving it to a SafeSubscriber abstract class that always adds try / catch is better than adding these comments that reduce the readability of the code.", "url": "https://github.com/line/armeria/pull/2533#discussion_r384565212", "createdAt": "2020-02-26T15:25:40Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HttpHealthChecker.java", "diffHunk": "@@ -174,6 +174,10 @@ public void onSubscribe(Subscription subscription) {\n \n         @Override\n         public void onNext(HttpObject obj) {\n+            // There's no chance that an exception is raised from the underlying logic, so we don't do", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bdd155b6ca767d71ec1931179798ffbbf9068f69"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 606, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}