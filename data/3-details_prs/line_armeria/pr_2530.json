{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4OTM0NzU3", "number": 2530, "title": "Make `HttpTimestampSupplier` work with negative clock value", "bodyText": "Motivation:\nThe initial value of nextUpdateNanos is 0, which can make\nHttpTimestampSupplier generate an empty string if System.nanoTime()\nreturns a negative value.\nModifivations:\n\nInitialize nextUpdateNanos with the current System.nanoTime()\nvalue.\nImprove testability of HttpTimestampSupplier so that we do not need\nto busy-loop while testing.\n\nResult:\n\nHttpTimestampSupplier works even when System.nanoTime() returns a\nnegative value.", "createdAt": "2020-02-24T11:15:08Z", "url": "https://github.com/line/armeria/pull/2530", "merged": true, "mergeCommit": {"oid": "ac7e62bd8e0d5af77ecbb706537354d64180be84"}, "closed": true, "closedAt": "2020-02-24T12:59:27Z", "author": {"login": "trustin"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHbjMnAH2gAyMzc4OTM0NzU3OjlkYjU4ZmVkNDViYjFkZjY2NTI1N2U3OGM3YTE0NDBiNWQ4ZjEyYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHckSoAFqTM2MzM0OTc0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9db58fed45bb1df665257e78c7a1440b5d8f12a7", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/9db58fed45bb1df665257e78c7a1440b5d8f12a7", "committedDate": "2020-02-24T11:09:26Z", "message": "Make `HttpTimestampSupplier` work with negative clock value\n\nMotivation:\n\nThe initial value of `nextUpdateNanos` is `0`, which can make\n`HttpTimestampSupplier` generate an empty string if `System.nanoTime()`\nreturns a negative value.\n\nModifivations:\n\n- Initialize `nextUpdateNanos` with the current `System.nanoTime()`\n  value.\n- Improve testability of `HttpTimestampSupplier` so that we do not need\n  to busy-loop while testing.\n\nResult:\n\n- `HttpTimestampSupplier` works even when `System.nanoTime()` returns a\n  negative value."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzIyODYx", "url": "https://github.com/line/armeria/pull/2530#pullrequestreview-363322861", "createdAt": "2020-02-24T11:27:44Z", "commit": {"oid": "9db58fed45bb1df665257e78c7a1440b5d8f12a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMToyNzo0NFrOFtdcAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMToyNzo0NFrOFtdcAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIxMjU0Ng==", "bodyText": "Why use spy instead of mock?", "url": "https://github.com/line/armeria/pull/2530#discussion_r383212546", "createdAt": "2020-02-24T11:27:44Z", "author": {"login": "anuraaga"}, "path": "core/src/test/java/com/linecorp/armeria/internal/common/util/HttpTimestampSupplierTest.java", "diffHunk": "@@ -17,43 +17,79 @@\n package com.linecorp.armeria.internal.common.util;\n \n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.awaitility.Awaitility.await;\n-import static org.mockito.Mockito.when;\n+import static org.mockito.Mockito.clearInvocations;\n+import static org.mockito.Mockito.never;\n+import static org.mockito.Mockito.spy;\n+import static org.mockito.Mockito.times;\n+import static org.mockito.Mockito.verify;\n \n-import java.time.Clock;\n-import java.time.Duration;\n import java.time.Instant;\n-import java.time.ZoneOffset;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.function.LongSupplier;\n+import java.util.function.Supplier;\n \n-import org.junit.jupiter.api.BeforeEach;\n import org.junit.jupiter.api.Test;\n-import org.mockito.Mock;\n \n class HttpTimestampSupplierTest {\n \n     private static final Instant TIME0 = Instant.parse(\"2019-10-18T10:15:30.05Z\");\n     private static final Instant TIME1 = Instant.parse(\"2019-10-18T10:15:31.25Z\");\n \n-    @Mock private Clock clock;\n+    @Test\n+    void normal() {\n+        final AtomicReference<Instant> instantHolder = new AtomicReference<>(TIME0);\n+        final AtomicLong nanoTimeHolder = new AtomicLong(TimeUnit.MILLISECONDS.toNanos(-500));\n \n-    private HttpTimestampSupplier supplier;\n+        // Create delegating mock suppliers.\n+        // Note that we can't use method references or lambda expressions because they generate final classes.\n+        @SuppressWarnings({ \"Convert2Lambda\", \"Anonymous2MethodRef\" })\n+        final Supplier<Instant> instantSupplier = spy(new Supplier<Instant>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9db58fed45bb1df665257e78c7a1440b5d8f12a7"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzI3NTM5", "url": "https://github.com/line/armeria/pull/2530#pullrequestreview-363327539", "createdAt": "2020-02-24T11:36:52Z", "commit": {"oid": "9db58fed45bb1df665257e78c7a1440b5d8f12a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25f591babad4c2d714e57df0833e4261c44d30ba", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/25f591babad4c2d714e57df0833e4261c44d30ba", "committedDate": "2020-02-24T11:41:55Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0aa79a2cca3e524bd1b13f6ce9b04d2cea5b21c", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/a0aa79a2cca3e524bd1b13f6ce9b04d2cea5b21c", "committedDate": "2020-02-24T11:49:08Z", "message": "Address the comments from @anuraaga"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2708e276fd2928ee5516af40deaad66620d03e40", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/2708e276fd2928ee5516af40deaad66620d03e40", "committedDate": "2020-02-24T11:51:58Z", "message": "Comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzM2ODAz", "url": "https://github.com/line/armeria/pull/2530#pullrequestreview-363336803", "createdAt": "2020-02-24T11:55:07Z", "commit": {"oid": "2708e276fd2928ee5516af40deaad66620d03e40"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f4f62c1765bb81abaecab647efbabb353aba0dd", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/7f4f62c1765bb81abaecab647efbabb353aba0dd", "committedDate": "2020-02-24T12:05:18Z", "message": "Comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzQ5NzQz", "url": "https://github.com/line/armeria/pull/2530#pullrequestreview-363349743", "createdAt": "2020-02-24T12:20:32Z", "commit": {"oid": "7f4f62c1765bb81abaecab647efbabb353aba0dd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 598, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}