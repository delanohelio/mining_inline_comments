{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2Mjc1NTg2", "number": 2887, "title": "Successful events for proxy ssl should be ignored", "bodyText": "Motivation\nWhile addressing comments @minwoox left, I realized the current implementation doesn't support nested ssl's properly.\n#2752 (comment)\nTo be specific, SslHandshakeCompletionEvents from proxy's SslHandler confuses armeria into thinking the ssl negotiation succeeded.\nThis causes h1 requests to proceed although ssl negotation hasn't occurred, and h2, https requests to fail.\nAlternatively, we may also consider dropping ssl support for proxies altogether if the cost of maintaining seems too high.\n\ud83d\ude2d \ud83d\ude22 \ud83d\ude2d \ud83d\ude22 \ud83d\ude2d \ud83d\ude22 \ud83d\ude2d \ud83d\ude22 \ud83d\ude2d \ud83d\ude22 \ud83d\ude2d \ud83d\ude22\nModification\nCheck SslHandler for client requests actually completed before proceeding with http requests.", "createdAt": "2020-07-08T14:19:14Z", "url": "https://github.com/line/armeria/pull/2887", "merged": true, "mergeCommit": {"oid": "9ea14a53414d473993fb7f6caad457255692e305"}, "closed": true, "closedAt": "2020-07-10T14:58:01Z", "author": {"login": "jrhee17"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcy7EkUgH2gAyNDQ2Mjc1NTg2OmFlM2EzMDg5NjhlNjg1OTRhNDQyZjdiMDgxNWUzMjE0Nzk4NWJmNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczaZUCAFqTQ0NjA4NzM3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ae3a308968e68594a442f7b0815e32147985bf77", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/ae3a308968e68594a442f7b0815e32147985bf77", "committedDate": "2020-07-08T14:11:41Z", "message": "Successful events for proxxy ssl should be ignored"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODcxODE5", "url": "https://github.com/line/armeria/pull/2887#pullrequestreview-444871819", "createdAt": "2020-07-08T15:17:36Z", "commit": {"oid": "ae3a308968e68594a442f7b0815e32147985bf77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNToxNzozNlrOGutB6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNToxNzozNlrOGutB6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYyNTQ0OA==", "bodyText": "How about adding more detail to this comment, like when this can happen?", "url": "https://github.com/line/armeria/pull/2887#discussion_r451625448", "createdAt": "2020-07-08T15:17:36Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpClientPipelineConfigurator.java", "diffHunk": "@@ -195,6 +195,11 @@ public void userEventTriggered(ChannelHandlerContext ctx, Object evt) throws Exc\n                     return;\n                 }\n \n+                if (!sslHandler.handshakeFuture().isDone()) {\n+                    // Ignore successful handshake events for other SslHandlers in the pipeline.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae3a308968e68594a442f7b0815e32147985bf77"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a9b27c0d69c0bd02506a747b899799413e157de", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/1a9b27c0d69c0bd02506a747b899799413e157de", "committedDate": "2020-07-08T15:50:56Z", "message": "add more explanation on why we need to check handshakeFuture"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MjUyNTc1", "url": "https://github.com/line/armeria/pull/2887#pullrequestreview-445252575", "createdAt": "2020-07-09T02:41:57Z", "commit": {"oid": "1a9b27c0d69c0bd02506a747b899799413e157de"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwMjo0MTo1N1rOGu_uAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwMjo0MTo1N1rOGu_uAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTkzMTY1MQ==", "bodyText": "How about testHttpToHttpsEndpoint? so that people get easily noticed the differences with the test below.\nOr I think we can just combine these two tests into one.", "url": "https://github.com/line/armeria/pull/2887#discussion_r451931651", "createdAt": "2020-07-09T02:41:57Z", "author": {"login": "minwoox"}, "path": "core/src/test/java/com/linecorp/armeria/client/proxy/ProxyClientIntegrationTest.java", "diffHunk": "@@ -331,12 +336,32 @@ void testHttpProxyPrefaceFailure() throws Exception {\n         clientFactory.close();\n     }\n \n-    @Test\n-    void testHttpsProxyBasicCase() throws Exception {\n+    @ParameterizedTest\n+    @EnumSource(value = SessionProtocol.class, mode = Mode.INCLUDE, names = {\"H1C\", \"H2C\", \"HTTP\"})\n+    void testHttpsProxyBasicCase(SessionProtocol protocol) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a9b27c0d69c0bd02506a747b899799413e157de"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MjgwMDU1", "url": "https://github.com/line/armeria/pull/2887#pullrequestreview-445280055", "createdAt": "2020-07-09T04:22:45Z", "commit": {"oid": "1a9b27c0d69c0bd02506a747b899799413e157de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f032ed4ff07c60a509501f84ad76f52db1b2ab1", "author": {"user": {"login": "jrhee17", "name": "jrhee17"}}, "url": "https://github.com/line/armeria/commit/2f032ed4ff07c60a509501f84ad76f52db1b2ab1", "committedDate": "2020-07-09T13:08:06Z", "message": "combine tests for https proxy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDg3Mzcz", "url": "https://github.com/line/armeria/pull/2887#pullrequestreview-446087373", "createdAt": "2020-07-10T02:41:24Z", "commit": {"oid": "2f032ed4ff07c60a509501f84ad76f52db1b2ab1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4875, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}