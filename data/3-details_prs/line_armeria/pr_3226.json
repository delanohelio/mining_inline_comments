{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMTk0Mjkz", "number": 3226, "title": "Make Armeria server can shutdown before unmanaged tomcat in springboot.", "bodyText": "Checked the document https://docs.spring.io/spring-boot/docs/2.3.1.RELEASE/reference/htmlsingle/#boot-features-graceful-shutdown, the graceful shutdown also use SmartLifeCycle, so if we make Server utilize it, we can start Armeria's graceful shutdown before the tomcat or at the same time(depends on the springboot's graceful setting). So there is no 503 when we have a request to tomcat during Armeria's graceful shutdown.\nThere is one implementation detail that our phase is Integer.MAX_VALUE. And spring provides 2 types of web lifecycle. WebServerStartStopLifecycle & WebServerGracefulShutdownLifecycle.\n\nWebServerStartStopLifecycle's phase is Integer.MAX_VALUE-1, so it will wait for Armria shutdown complete.\nUnfortunately, the phase of WebServerGracefulShutdownLifecycle is Integer.MAX_VALUE. so it means Tomcat & Armeria will enter graceful shutdown at the same time when we enable server.shutdown: graceful. But luckily, the implementation of WebServerGracefulShutdownLifecycle is just to close the protocol/port but not setting the service in the connector as null(different with WebServerStartStopLifecycle). So even enter the graceful shutdown at the same time, the tomcat connector is still alive and can be used by Armeria. It may break after future implementation change of spring side.\n\n--\nI test the code using example/spring-boot-tomcat with while sleep 1; do curl \"http://localhost:8080\"; done and send kill -TERM to test, maybe good to try and let me know if I miss something.", "createdAt": "2020-12-15T11:53:41Z", "url": "https://github.com/line/armeria/pull/3226", "merged": true, "mergeCommit": {"oid": "ea4e7f5e5fc09806bca6355e1d36dedbd6aa3a18"}, "closed": true, "closedAt": "2020-12-28T03:25:28Z", "author": {"login": "kojilin"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmcH47gBqjQxMTUxOTkzMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdqdexpgFqTU1ODk4MzYyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7587ebbda25b80e9c4f1d23eb8bb91fe74aabc83", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/7587ebbda25b80e9c4f1d23eb8bb91fe74aabc83", "committedDate": "2020-12-15T15:17:55Z", "message": "Separate server bean and smartlicecycle wrapping."}, "afterCommit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/6d18186cd3a25e7746c6f85bf8d52ca73841c57c", "committedDate": "2020-12-15T15:31:40Z", "message": "Separate server bean and smartlicecycle wrapping."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MzAwODA0", "url": "https://github.com/line/armeria/pull/3226#pullrequestreview-554300804", "createdAt": "2020-12-17T06:01:49Z", "commit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwNjowMTo1MFrOIHl_1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwNjoxNTo0NlrOIHmS9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgzMzQ5NQ==", "bodyText": "nit: Wraps {@link Server}", "url": "https://github.com/line/armeria/pull/3226#discussion_r544833495", "createdAt": "2020-12-17T06:01:50Z", "author": {"login": "ikhoon"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/spring/AbstractArmeriaAutoConfiguration.java", "diffHunk": "@@ -128,6 +129,14 @@ public Server armeriaServer(\n         return server;\n     }\n \n+    /**\n+     * Wrap server with {@link SmartLifecycle}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgzNDc1MQ==", "bodyText": "nit: final?\nCould move to internal package?", "url": "https://github.com/line/armeria/pull/3226#discussion_r544834751", "createdAt": "2020-12-17T06:05:33Z", "author": {"login": "ikhoon"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaServerGracefulShutdownLifecycle.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.spring;\n+\n+import org.springframework.context.SmartLifecycle;\n+\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Make Armeria Server utilize spring's SmartLifecycle feature.\n+ * So Armeria will shutdown before other web servers and beans in the context.\n+ */\n+public class ArmeriaServerGracefulShutdownLifecycle implements SmartLifecycle {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgzNDg0NQ==", "bodyText": "nit: {@link Server}?", "url": "https://github.com/line/armeria/pull/3226#discussion_r544834845", "createdAt": "2020-12-17T06:05:50Z", "author": {"login": "ikhoon"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaServerGracefulShutdownLifecycle.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.spring;\n+\n+import org.springframework.context.SmartLifecycle;\n+\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Make Armeria Server utilize spring's SmartLifecycle feature.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgzNTQzMg==", "bodyText": "This method looks like dead code. Could be removed?", "url": "https://github.com/line/armeria/pull/3226#discussion_r544835432", "createdAt": "2020-12-17T06:07:26Z", "author": {"login": "ikhoon"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaServerGracefulShutdownLifecycle.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.spring;\n+\n+import org.springframework.context.SmartLifecycle;\n+\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Make Armeria Server utilize spring's SmartLifecycle feature.\n+ * So Armeria will shutdown before other web servers and beans in the context.\n+ */\n+public class ArmeriaServerGracefulShutdownLifecycle implements SmartLifecycle {\n+    /**\n+     * {@link Server} created by {@link ArmeriaAutoConfiguration}. .\n+     */\n+    private final Server server;\n+\n+    /**\n+     * Creates a new instance.\n+     */\n+    public ArmeriaServerGracefulShutdownLifecycle(Server server) {\n+        this.server = server;\n+    }\n+\n+    /**\n+     * Return the created {@link Server}.\n+     */\n+    public Server getServer() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgzNzcxMQ==", "bodyText": "This is not called frequently. JFYI, (AFAIK) the performance of whenComplete() in Java8 is poorer than handle().", "url": "https://github.com/line/armeria/pull/3226#discussion_r544837711", "createdAt": "2020-12-17T06:14:06Z", "author": {"login": "ikhoon"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaServerGracefulShutdownLifecycle.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.spring;\n+\n+import org.springframework.context.SmartLifecycle;\n+\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Make Armeria Server utilize spring's SmartLifecycle feature.\n+ * So Armeria will shutdown before other web servers and beans in the context.\n+ */\n+public class ArmeriaServerGracefulShutdownLifecycle implements SmartLifecycle {\n+    /**\n+     * {@link Server} created by {@link ArmeriaAutoConfiguration}. .\n+     */\n+    private final Server server;\n+\n+    /**\n+     * Creates a new instance.\n+     */\n+    public ArmeriaServerGracefulShutdownLifecycle(Server server) {\n+        this.server = server;\n+    }\n+\n+    /**\n+     * Return the created {@link Server}.\n+     */\n+    public Server getServer() {\n+        return server;\n+    }\n+\n+    /**\n+     * Start this component.\n+     * Currently AbstractArmeriaAutoConfiguration help starting the server.\n+     */\n+    @Override\n+    public void start() {\n+    }\n+\n+    /**\n+     * Stop this component. This class implements {@link SmartLifecycle}, so don't need to support sync stop.\n+     */\n+    @Override\n+    public void stop() {\n+        throw new UnsupportedOperationException(\"Stop must not be invoked directly\");\n+    }\n+\n+    /**\n+     * Stop this component.\n+     */\n+    @Override\n+    public void stop(Runnable callback) {\n+        server.stop().whenComplete((unused, throwable) -> callback.run());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgzODM4OA==", "bodyText": "Returns?", "url": "https://github.com/line/armeria/pull/3226#discussion_r544838388", "createdAt": "2020-12-17T06:15:46Z", "author": {"login": "ikhoon"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaServerGracefulShutdownLifecycle.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.spring;\n+\n+import org.springframework.context.SmartLifecycle;\n+\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Make Armeria Server utilize spring's SmartLifecycle feature.\n+ * So Armeria will shutdown before other web servers and beans in the context.\n+ */\n+public class ArmeriaServerGracefulShutdownLifecycle implements SmartLifecycle {\n+    /**\n+     * {@link Server} created by {@link ArmeriaAutoConfiguration}. .\n+     */\n+    private final Server server;\n+\n+    /**\n+     * Creates a new instance.\n+     */\n+    public ArmeriaServerGracefulShutdownLifecycle(Server server) {\n+        this.server = server;\n+    }\n+\n+    /**\n+     * Return the created {@link Server}.\n+     */\n+    public Server getServer() {\n+        return server;\n+    }\n+\n+    /**\n+     * Start this component.\n+     * Currently AbstractArmeriaAutoConfiguration help starting the server.\n+     */\n+    @Override\n+    public void start() {\n+    }\n+\n+    /**\n+     * Stop this component. This class implements {@link SmartLifecycle}, so don't need to support sync stop.\n+     */\n+    @Override\n+    public void stop() {\n+        throw new UnsupportedOperationException(\"Stop must not be invoked directly\");\n+    }\n+\n+    /**\n+     * Stop this component.\n+     */\n+    @Override\n+    public void stop(Runnable callback) {\n+        server.stop().whenComplete((unused, throwable) -> callback.run());\n+    }\n+\n+    /**\n+     * Return the phase that this lifecycle object is supposed to run in.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNDA3MDI5", "url": "https://github.com/line/armeria/pull/3226#pullrequestreview-553407029", "createdAt": "2020-12-16T07:08:46Z", "commit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzowODo0NlrOIG2lkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwNzoxODo1N1rOIG3H1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA1NjcyMg==", "bodyText": "missing final?\nShouldn't we move this class to the internal package because a user does not use this class?", "url": "https://github.com/line/armeria/pull/3226#discussion_r544056722", "createdAt": "2020-12-16T07:08:46Z", "author": {"login": "minwoox"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaServerGracefulShutdownLifecycle.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.spring;\n+\n+import org.springframework.context.SmartLifecycle;\n+\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Make Armeria Server utilize spring's SmartLifecycle feature.\n+ * So Armeria will shutdown before other web servers and beans in the context.\n+ */\n+public class ArmeriaServerGracefulShutdownLifecycle implements SmartLifecycle {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA1Njg5Mw==", "bodyText": "Could remove this?", "url": "https://github.com/line/armeria/pull/3226#discussion_r544056893", "createdAt": "2020-12-16T07:08:58Z", "author": {"login": "minwoox"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaServerGracefulShutdownLifecycle.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.spring;\n+\n+import org.springframework.context.SmartLifecycle;\n+\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Make Armeria Server utilize spring's SmartLifecycle feature.\n+ * So Armeria will shutdown before other web servers and beans in the context.\n+ */\n+public class ArmeriaServerGracefulShutdownLifecycle implements SmartLifecycle {\n+    /**\n+     * {@link Server} created by {@link ArmeriaAutoConfiguration}. .\n+     */\n+    private final Server server;\n+\n+    /**\n+     * Creates a new instance.\n+     */\n+    public ArmeriaServerGracefulShutdownLifecycle(Server server) {\n+        this.server = server;\n+    }\n+\n+    /**\n+     * Return the created {@link Server}.\n+     */\n+    public Server getServer() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA2NTQ5NQ==", "bodyText": "question: Should we put the logic for building a server in AbstractArmeriaAutoConfiguration.armeriaServer() {...} in this method?", "url": "https://github.com/line/armeria/pull/3226#discussion_r544065495", "createdAt": "2020-12-16T07:18:57Z", "author": {"login": "minwoox"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaServerGracefulShutdownLifecycle.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.spring;\n+\n+import org.springframework.context.SmartLifecycle;\n+\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Make Armeria Server utilize spring's SmartLifecycle feature.\n+ * So Armeria will shutdown before other web servers and beans in the context.\n+ */\n+public class ArmeriaServerGracefulShutdownLifecycle implements SmartLifecycle {\n+    /**\n+     * {@link Server} created by {@link ArmeriaAutoConfiguration}. .\n+     */\n+    private final Server server;\n+\n+    /**\n+     * Creates a new instance.\n+     */\n+    public ArmeriaServerGracefulShutdownLifecycle(Server server) {\n+        this.server = server;\n+    }\n+\n+    /**\n+     * Return the created {@link Server}.\n+     */\n+    public Server getServer() {\n+        return server;\n+    }\n+\n+    /**\n+     * Start this component.\n+     * Currently AbstractArmeriaAutoConfiguration help starting the server.\n+     */\n+    @Override\n+    public void start() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MjgzNDAy", "url": "https://github.com/line/armeria/pull/3226#pullrequestreview-555283402", "createdAt": "2020-12-18T08:21:44Z", "commit": {"oid": "24a0719fa100da3f6d773131be5c8ede020be2e8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwODoyMTo0NFrOIIXXMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwODoyMjo0NlrOIIXZUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY0MjI5MA==", "bodyText": "I realized that we could just move this class to com.linecorp.armeria.spring package and make it package-private. \ud83d\ude05  Sorry about it.", "url": "https://github.com/line/armeria/pull/3226#discussion_r545642290", "createdAt": "2020-12-18T08:21:44Z", "author": {"login": "minwoox"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaServerGracefulShutdownLifecycle.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.spring;\n+\n+import org.springframework.context.SmartLifecycle;\n+\n+import com.linecorp.armeria.server.Server;\n+import com.linecorp.armeria.spring.ArmeriaAutoConfiguration;\n+\n+/**\n+ * Make Armeria {@link Server} utilize spring's SmartLifecycle feature.\n+ * So Armeria will shutdown before other web servers and beans in the context.\n+ */\n+public final class ArmeriaServerGracefulShutdownLifecycle implements SmartLifecycle {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24a0719fa100da3f6d773131be5c8ede020be2e8"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTY0MjgzMw==", "bodyText": "I don't have any idea how to make it work at the moment. \ud83d\ude05 So I guess it's fine as it is. I might try later to figure that out.", "url": "https://github.com/line/armeria/pull/3226#discussion_r545642833", "createdAt": "2020-12-18T08:22:46Z", "author": {"login": "minwoox"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaServerGracefulShutdownLifecycle.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.spring;\n+\n+import org.springframework.context.SmartLifecycle;\n+\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Make Armeria Server utilize spring's SmartLifecycle feature.\n+ * So Armeria will shutdown before other web servers and beans in the context.\n+ */\n+public class ArmeriaServerGracefulShutdownLifecycle implements SmartLifecycle {\n+    /**\n+     * {@link Server} created by {@link ArmeriaAutoConfiguration}. .\n+     */\n+    private final Server server;\n+\n+    /**\n+     * Creates a new instance.\n+     */\n+    public ArmeriaServerGracefulShutdownLifecycle(Server server) {\n+        this.server = server;\n+    }\n+\n+    /**\n+     * Return the created {@link Server}.\n+     */\n+    public Server getServer() {\n+        return server;\n+    }\n+\n+    /**\n+     * Start this component.\n+     * Currently AbstractArmeriaAutoConfiguration help starting the server.\n+     */\n+    @Override\n+    public void start() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA2NTQ5NQ=="}, "originalCommit": {"oid": "6d18186cd3a25e7746c6f85bf8d52ca73841c57c"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MzM5MzUy", "url": "https://github.com/line/armeria/pull/3226#pullrequestreview-555339352", "createdAt": "2020-12-18T09:42:58Z", "commit": {"oid": "2ef898d9310fd27836ec98057045fb17e2a46e0d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwOTo0Mjo1OFrOIIb3zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwOTo0Mjo1OFrOIIb3zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTcxNjE3NQ==", "bodyText": "I think this should be SmartLifecycle. \ud83e\udd14", "url": "https://github.com/line/armeria/pull/3226#discussion_r545716175", "createdAt": "2020-12-18T09:42:58Z", "author": {"login": "minwoox"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/spring/AbstractArmeriaAutoConfiguration.java", "diffHunk": "@@ -134,7 +133,7 @@ public Server armeriaServer(\n      * Wrap {@link Server} with {@link SmartLifecycle}.\n      */\n     @Bean\n-    public SmartLifecycle armeriaServerGracefulShutdownLifecycle(Server server) {\n+    public ArmeriaServerGracefulShutdownLifecycle armeriaServerGracefulShutdownLifecycle(Server server) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ef898d9310fd27836ec98057045fb17e2a46e0d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f60bfdf14bacb72eceed8b26e4b4dee5bbc5fe83", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/f60bfdf14bacb72eceed8b26e4b4dee5bbc5fe83", "committedDate": "2020-12-18T13:42:31Z", "message": "Make Armeria Server created from ArmeriaAutoConfiguration start/shutdown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27aeb1f2ab82cc051b27c8af112ca3623aa96ede", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/27aeb1f2ab82cc051b27c8af112ca3623aa96ede", "committedDate": "2020-12-18T13:42:31Z", "message": "Separate server bean and smartlicecycle wrapping."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69bd8058c17a261f317c412564a72647525a5fb9", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/69bd8058c17a261f317c412564a72647525a5fb9", "committedDate": "2020-12-18T13:42:31Z", "message": "Follow the suggestion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59d9457297c54483ba0554d6d5ddf0db78a3e2d0", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/59d9457297c54483ba0554d6d5ddf0db78a3e2d0", "committedDate": "2020-12-18T13:42:31Z", "message": "Move back to public api."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b8a43180b2fa293799549d25c3d964843a717aa", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/3b8a43180b2fa293799549d25c3d964843a717aa", "committedDate": "2020-12-18T13:42:31Z", "message": "Follow the comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a98e1276a4edbeac839ae0e1c32459d7593e7d17", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/a98e1276a4edbeac839ae0e1c32459d7593e7d17", "committedDate": "2020-12-18T13:42:31Z", "message": "Revert \"Follow the comments.\"\n\nThis reverts commit 5dd31686"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54da55af1cf13052d3507d8462f063698edd1ac4", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/54da55af1cf13052d3507d8462f063698edd1ac4", "committedDate": "2020-12-18T13:42:31Z", "message": "Move to internal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf2315eecf39ceb07bd73c6508768b9cd29fe2d1", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/bf2315eecf39ceb07bd73c6508768b9cd29fe2d1", "committedDate": "2020-12-18T13:42:31Z", "message": "Move to internal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1de46e7f869527cabfcda1e86d0b852a7f035f1", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/b1de46e7f869527cabfcda1e86d0b852a7f035f1", "committedDate": "2020-12-18T13:42:31Z", "message": "Follow the comment.\n\nUsing package private."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd6a966a84652fa95da226d515ac1a6273b2d5a9", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/fd6a966a84652fa95da226d515ac1a6273b2d5a9", "committedDate": "2020-12-18T13:42:31Z", "message": "Using interface instead of concrete class."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fed2b4ee25e939ea655a11374436597a3ccf2fb5", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/fed2b4ee25e939ea655a11374436597a3ccf2fb5", "committedDate": "2020-12-18T10:11:37Z", "message": "Using interface instead of concrete class."}, "afterCommit": {"oid": "fd6a966a84652fa95da226d515ac1a6273b2d5a9", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/fd6a966a84652fa95da226d515ac1a6273b2d5a9", "committedDate": "2020-12-18T13:42:31Z", "message": "Using interface instead of concrete class."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MzQxMDQ3", "url": "https://github.com/line/armeria/pull/3226#pullrequestreview-558341047", "createdAt": "2020-12-24T05:24:48Z", "commit": {"oid": "fd6a966a84652fa95da226d515ac1a6273b2d5a9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNToyNDo0OFrOIK-63g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNFQwNToyNDo0OFrOIK-63g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODM4NzU1MA==", "bodyText": "Let's remove all Javadocs for the field and methods because it's a package-private class now. \ud83d\ude04", "url": "https://github.com/line/armeria/pull/3226#discussion_r548387550", "createdAt": "2020-12-24T05:24:48Z", "author": {"login": "minwoox"}, "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/spring/ArmeriaServerGracefulShutdownLifecycle.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.spring;\n+\n+import org.springframework.context.SmartLifecycle;\n+\n+import com.linecorp.armeria.server.Server;\n+\n+/**\n+ * Make Armeria {@link Server} utilize spring's SmartLifecycle feature.\n+ * So Armeria will shutdown before other web servers and beans in the context.\n+ */\n+final class ArmeriaServerGracefulShutdownLifecycle implements SmartLifecycle {\n+    /**\n+     * {@link Server} created by {@link ArmeriaAutoConfiguration}. .\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fd6a966a84652fa95da226d515ac1a6273b2d5a9"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MzkxNDA4", "url": "https://github.com/line/armeria/pull/3226#pullrequestreview-558391408", "createdAt": "2020-12-24T07:45:33Z", "commit": {"oid": "fd6a966a84652fa95da226d515ac1a6273b2d5a9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bd38b9c8e354608a63e67caa0236b70eb0f0a61", "author": {"user": {"login": "kojilin", "name": "Koji Lin"}}, "url": "https://github.com/line/armeria/commit/2bd38b9c8e354608a63e67caa0236b70eb0f0a61", "committedDate": "2020-12-24T09:15:41Z", "message": "Update javadoc."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4OTgzNjI1", "url": "https://github.com/line/armeria/pull/3226#pullrequestreview-558983625", "createdAt": "2020-12-28T03:22:56Z", "commit": {"oid": "2bd38b9c8e354608a63e67caa0236b70eb0f0a61"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4547, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}