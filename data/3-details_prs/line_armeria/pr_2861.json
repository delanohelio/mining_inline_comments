{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNDgzMDAw", "number": 2861, "title": "Separate `HttpFile` and `AggregateHttpFile` from each other", "bodyText": "Motivation:\nAggregateHttpFile extends HttpFile unlike other Aggregated*\nclasses, such as AggregatedHttpRequest, breaking our API consistency.\nModifications:\n\n(Breaking) Make AggregatedHttpFile not extend HttpFile anymore.\nAdd AggregatedHttpFile.toHttpFile()\nAdd NonExistentAggregatedHttpFile.\n(Breaking) HttpFile.nonExistent() returns an HttpFile instead of\nAggregatedHttpFile.\n(Breaking) HttpFile.of(HttpData, ...) returns an HttpFile instead\nof AggregatedHttpFile.\n(Breaking) Rename AbstractHttpFile.headers() to additionalHeaders()\nto avoid a method signature clash.\nMiscellaneous:\n\nAdd PooledAggregatedHttpResponse.of()\nUse PooledAggregatedHttp{Request,Response}.of() when aggregating,\ninstead of calling the constructor directly.\n\n\n\nResult:\n\nConsistency in API", "createdAt": "2020-07-01T06:50:41Z", "url": "https://github.com/line/armeria/pull/2861", "merged": true, "mergeCommit": {"oid": "07a0c2927fdda456ace0166db6fead924bb894cf"}, "closed": true, "closedAt": "2020-07-02T05:33:33Z", "author": {"login": "trustin"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwkdouAH2gAyNDQyNDgzMDAwOjU2NzY3MmIzODA3ZWMzZDUzM2IxMzY4YzFmNzE5OTJiNDU1ODhhMTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcw2t5RgFqTQ0MTMzMzk3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "567672b3807ec3d533b1368c1f71992b45588a15", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/567672b3807ec3d533b1368c1f71992b45588a15", "committedDate": "2020-07-01T06:43:24Z", "message": "Separate `HttpFile` and `AggregateHttpFile` from each other\n\nMotivation:\n\n`AggregateHttpFile` extends `HttpFile` unlike other `Aggregated*`\nclasses, such as `AggregatedHttpRequest`, breaking our API consistency.\n\nModifications:\n\n- (Breaking) Make `AggregatedHttpFile` not extend `HttpFile` anymore.\n- Add `AggregatedHttpFile.toHttpFile()`\n- Add `NonExistentAggregatedHttpFile`.\n- (Breaking) `HttpFile.nonExistent()` returns an `HttpFile` instead of\n  `AggregatedHttpFile`.\n- (Breaking) `HttpFile.of(HttpData, ...)` returns an `HttpFile` instead\n  of `AggregatedHttpFile`.\n- (Breaking) Rename `AbstractHttpFile.headers()` to `additionalHeaders()`\n  to avoid a method signature clash.\n- Miscellaneous:\n  - Add `PooledAggregatedHttpResponse.of()`\n  - Use `PooledAggregatedHttp{Request,Response}.of()` when aggregating,\n    instead of calling the constructor directly.\n\nResult:\n\n- Consistency in API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4add55e442392294f14c2907c43738fbb0da189b", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/4add55e442392294f14c2907c43738fbb0da189b", "committedDate": "2020-07-01T07:08:26Z", "message": "Merge branch 'master' into split_aggregated_http_file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fce09a2d45dae1073f1d909787e017480dc1dc82", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/fce09a2d45dae1073f1d909787e017480dc1dc82", "committedDate": "2020-07-01T07:52:02Z", "message": "Fix `toString()`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNjYxNzAz", "url": "https://github.com/line/armeria/pull/2861#pullrequestreview-440661703", "createdAt": "2020-07-01T08:36:19Z", "commit": {"oid": "fce09a2d45dae1073f1d909787e017480dc1dc82"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwODozNjoyMFrOGrcabg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQwODo1NDozN1rOGrdDBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIwNzQ3MA==", "bodyText": "HttpFile.of -> AggregatedHttpFile.of?", "url": "https://github.com/line/armeria/pull/2861#discussion_r448207470", "createdAt": "2020-07-01T08:36:20Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/server/file/AggregatedHttpFile.java", "diffHunk": "@@ -15,51 +15,76 @@\n  */\n package com.linecorp.armeria.server.file;\n \n-import java.util.concurrent.CompletableFuture;\n-import java.util.concurrent.Executor;\n+import static java.util.Objects.requireNonNull;\n \n import javax.annotation.Nullable;\n \n import com.linecorp.armeria.common.AggregatedHttpResponse;\n import com.linecorp.armeria.common.HttpData;\n-import com.linecorp.armeria.common.HttpResponse;\n import com.linecorp.armeria.common.ResponseHeaders;\n-import com.linecorp.armeria.common.util.UnmodifiableFuture;\n-\n-import io.netty.buffer.ByteBufAllocator;\n \n /**\n- * An immutable variant of {@link HttpFile} which has its attributes and content readily available.\n- * Unlike {@link HttpFile}, the following operations in {@link AggregatedHttpFile} neither blocks nor raises\n- * an exception:\n- * <ul>\n- *   <li>{@link #readAttributes(Executor)}</li>\n- *   <li>{@link #readHeaders(Executor)}</li>\n- *   <li>{@link #read(Executor, ByteBufAllocator)}</li>\n- *   <li>{@link #aggregate(Executor)}</li>\n- *   <li>{@link #aggregateWithPooledObjects(Executor, ByteBufAllocator)}</li>\n- * </ul>\n- * It also has the following additional methods that give you an immediate access to the file:\n- * <ul>\n- *   <li>{@link #readAttributes()}</li>\n- *   <li>{@link #readHeaders()}</li>\n- *   <li>{@link #read()}</li>\n- * </ul>\n+ * A complete HTTP file whose attributes and content are readily available.\n  */\n-public interface AggregatedHttpFile extends HttpFile {\n+public interface AggregatedHttpFile {\n+\n+    /**\n+     * Creates a new {@link AggregatedHttpFile} which streams the specified {@link HttpData}. This method is\n+     * a shortcut for {@code HttpFile.of(data, System.currentTimeMillis()}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fce09a2d45dae1073f1d909787e017480dc1dc82"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNzc3OQ==", "bodyText": "nit: request -> file", "url": "https://github.com/line/armeria/pull/2861#discussion_r448217779", "createdAt": "2020-07-01T08:54:27Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/server/file/AggregatedHttpFile.java", "diffHunk": "@@ -110,14 +120,10 @@ default AggregatedHttpResponse read() {\n     @Nullable\n     HttpData content();\n \n-    @Override\n-    default CompletableFuture<AggregatedHttpFile> aggregate(Executor fileReadExecutor) {\n-        return CompletableFuture.completedFuture(this);\n-    }\n-\n-    @Override\n-    default CompletableFuture<AggregatedHttpFile> aggregateWithPooledObjects(Executor fileReadExecutor,\n-                                                                             ByteBufAllocator alloc) {\n-        return CompletableFuture.completedFuture(this);\n-    }\n+    /**\n+     * Converts this request into a new {@link HttpFile}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fce09a2d45dae1073f1d909787e017480dc1dc82"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIxNzg2Mg==", "bodyText": "2020 \ud83d\ude04", "url": "https://github.com/line/armeria/pull/2861#discussion_r448217862", "createdAt": "2020-07-01T08:54:37Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/server/file/AggregatedHttpFileBuilder.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright 2019 LINE Corporation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fce09a2d45dae1073f1d909787e017480dc1dc82"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "765c29772224c19078e1cbf1f1d6044f5da3b1f9", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/765c29772224c19078e1cbf1f1d6044f5da3b1f9", "committedDate": "2020-07-01T09:36:47Z", "message": "Address the comments from @minwoox"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjcyNTIy", "url": "https://github.com/line/armeria/pull/2861#pullrequestreview-441272522", "createdAt": "2020-07-02T00:20:04Z", "commit": {"oid": "765c29772224c19078e1cbf1f1d6044f5da3b1f9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMDoyMDowNFrOGr5U3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMDoyMDowNFrOGr5U3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4MTE4Mg==", "bodyText": "Is there any reason that you didn't use CompletableFuture.completeValue(attrs)?", "url": "https://github.com/line/armeria/pull/2861#discussion_r448681182", "createdAt": "2020-07-02T00:20:04Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/server/file/HttpDataFile.java", "diffHunk": "@@ -73,23 +76,23 @@ protected String pathOrUri() {\n     }\n \n     @Override\n-    public HttpFileAttributes readAttributes() {\n+    public HttpFileAttributes attributes() {\n         return attrs;\n     }\n \n     @Override\n     public CompletableFuture<HttpFileAttributes> readAttributes(Executor fileReadExecutor) {\n-        return AggregatedHttpFile.super.readAttributes(fileReadExecutor);\n+        return UnmodifiableFuture.completedFuture(attrs);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "765c29772224c19078e1cbf1f1d6044f5da3b1f9"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMzMzOTcw", "url": "https://github.com/line/armeria/pull/2861#pullrequestreview-441333970", "createdAt": "2020-07-02T03:59:27Z", "commit": {"oid": "765c29772224c19078e1cbf1f1d6044f5da3b1f9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 339, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}