{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2Mzg0Mzk1", "number": 2816, "title": "Add `onResponseTrailers()` to circuit breaker and retry rule builders", "bodyText": "Motivation:\nA user wants to determine whether a request was successful or not from\nthe value of a trailer, which is currently not possible.\nModifications:\n\nAdded onResponseTrailers() to AbstractRuleBuilder and its\nsubtypes, including:\n\nCircuitBreakerRuleBuilder\nCircuitBreakerRuleWithContentBuilder\nRetryRuleBuilder\nRetryRuleWithContentBuilder\n\n\nAdded requiresResponseTrailers() to rule types, including:\n\nCircuitBreakerRule\nCircuitBreakerRuleWithContent\nRetryRule\nRetryRuleWithContent\n\n\nUpdated CircuitBreakerClient and RetryingClient to respect\nrequiredResponseTrailers() flag and wait until response trailers are\navailable.\nMiscellaneous:\n\nRemoved the toString() implementations in some builder classes.\n\n\n\nResult:\n\nA user can break the circuit or retry based on a response trailer,\nsuch as grpc-status.", "createdAt": "2020-06-18T10:39:25Z", "url": "https://github.com/line/armeria/pull/2816", "merged": true, "mergeCommit": {"oid": "7a9afcd03e3af8c59bc7380476428acc2c7a6e39"}, "closed": true, "closedAt": "2020-06-19T03:14:31Z", "author": {"login": "trustin"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcseO5BAH2gAyNDM2Mzg0Mzk1OjI1MTAzMzIyNjgwOWM3MWNlMGNjNTZmMTkyODQyNDE1ZGY0NTQ4OWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsqQd8gFqTQzMzc3NTU1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "251033226809c71ce0cc56f192842415df45489c", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/251033226809c71ce0cc56f192842415df45489c", "committedDate": "2020-06-18T13:12:10Z", "message": "Add `onResponseTrailers()` to circuit breaker and retry rule builders\n\nMotivation:\n\nA user wants to determine whether a request was successful or not from\nthe value of a trailer, which is currently not possible.\n\nModifications:\n\n- Added `onResponseTrailers()` to `AbstractRuleBuilder` and its\n  subtypes, including:\n  - `CircuitBreakerRuleBuilder`\n  - `CircuitBreakerRuleWithContentBuilder`\n  - `RetryRuleBuilder`\n  - `RetryRuleWithContentBuilder`\n- Added `requiresResponseTrailers()` to rule types, including:\n  - `CircuitBreakerRule`\n  - `CircuitBreakerRuleWithContent`\n  - `RetryRule`\n  - `RetryRuleWithContent`\n- Updated `CircuitBreakerClient` and `RetryingClient` to respect\n  `requiredResponseTrailers()` flag and wait until response trailers are\n  available.\n- Miscellaneous:\n  - Removed the `toString()` implementations in some builder classes.\n\nResult:\n\n- A user can break the circuit or retry based on a response trailer,\n  such as `grpc-status`."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcfb69a8179f47b303e43ea40e1366ffd4dfc9c1", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/bcfb69a8179f47b303e43ea40e1366ffd4dfc9c1", "committedDate": "2020-06-18T12:19:20Z", "message": "Add a test"}, "afterCommit": {"oid": "251033226809c71ce0cc56f192842415df45489c", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/251033226809c71ce0cc56f192842415df45489c", "committedDate": "2020-06-18T13:12:10Z", "message": "Add `onResponseTrailers()` to circuit breaker and retry rule builders\n\nMotivation:\n\nA user wants to determine whether a request was successful or not from\nthe value of a trailer, which is currently not possible.\n\nModifications:\n\n- Added `onResponseTrailers()` to `AbstractRuleBuilder` and its\n  subtypes, including:\n  - `CircuitBreakerRuleBuilder`\n  - `CircuitBreakerRuleWithContentBuilder`\n  - `RetryRuleBuilder`\n  - `RetryRuleWithContentBuilder`\n- Added `requiresResponseTrailers()` to rule types, including:\n  - `CircuitBreakerRule`\n  - `CircuitBreakerRuleWithContent`\n  - `RetryRule`\n  - `RetryRuleWithContent`\n- Updated `CircuitBreakerClient` and `RetryingClient` to respect\n  `requiredResponseTrailers()` flag and wait until response trailers are\n  available.\n- Miscellaneous:\n  - Removed the `toString()` implementations in some builder classes.\n\nResult:\n\n- A user can break the circuit or retry based on a response trailer,\n  such as `grpc-status`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMjgzNDAy", "url": "https://github.com/line/armeria/pull/2816#pullrequestreview-433283402", "createdAt": "2020-06-18T13:29:29Z", "commit": {"oid": "251033226809c71ce0cc56f192842415df45489c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzoyOToyOVrOGlvVog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMzoyOToyOVrOGlvVog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIyNjA4Mg==", "bodyText": "\ud83d\ude05", "url": "https://github.com/line/armeria/pull/2816#discussion_r442226082", "createdAt": "2020-06-18T13:29:29Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/circuitbreaker/CircuitBreakerRuleUtil.java", "diffHunk": "@@ -146,10 +225,22 @@ static CircuitBreakerRule orElse(CircuitBreakerRule first, CircuitBreakerRule se\n     }\n \n     private static CircuitBreakerRuleWithContent<HttpResponse>\n-    withDuplicator(CircuitBreakerRuleWithContent<HttpResponse> retryRuleWithContent,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "251033226809c71ce0cc56f192842415df45489c"}, "originalPosition": 227}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzQ5MDA2", "url": "https://github.com/line/armeria/pull/2816#pullrequestreview-433749006", "createdAt": "2020-06-19T01:36:27Z", "commit": {"oid": "251033226809c71ce0cc56f192842415df45489c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMTozNjoyN1rOGmFSYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMTozNjoyN1rOGmFSYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU4NTY5Nw==", "bodyText": "I think we should pass HttpResponse.ofFailure(cause) instead of response.\nIf the rule does not retry on the exception, then the response will be scribed twice.", "url": "https://github.com/line/armeria/pull/2816#discussion_r442585697", "createdAt": "2020-06-19T01:36:27Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/retry/RetryingClient.java", "diffHunk": "@@ -247,7 +251,26 @@ private void doExecute0(ClientRequestContext ctx, HttpRequestDuplicator rootReqD\n         final HttpResponse response = executeWithFallback(delegate(), derivedCtx,\n                                                           (context, cause) -> HttpResponse.ofFailure(cause));\n \n-        derivedCtx.log().whenAvailable(RequestLogProperty.RESPONSE_HEADERS).thenAccept(log -> {\n+        if (requiresResponseTrailers) {\n+            response.aggregate().handle((aggregated, cause) -> {\n+                handleResponse(ctx, rootReqDuplicator, originalReq, returnedRes, future, derivedCtx,\n+                               cause != null ? response : aggregated.toHttpResponse());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "251033226809c71ce0cc56f192842415df45489c"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e741f44f733612b55df988c375346dda1d96ed75", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e741f44f733612b55df988c375346dda1d96ed75", "committedDate": "2020-06-19T02:46:12Z", "message": "Address the comment from @minwoox"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzc1NTU3", "url": "https://github.com/line/armeria/pull/2816#pullrequestreview-433775557", "createdAt": "2020-06-19T03:12:45Z", "commit": {"oid": "e741f44f733612b55df988c375346dda1d96ed75"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 242, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}