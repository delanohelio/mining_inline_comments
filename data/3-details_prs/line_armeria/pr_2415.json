{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1ODA0OTIz", "number": 2415, "title": "Fix a bug where callbacks are invoked with the wrong context", "bodyText": "Motivation:\nWhen we send a data, we don't buffer but flush them to the socket one by one.\nHowever, under heavy load, especially when using HTTP/2, there's a chance that the data is not fully written(partial write) or nor written at all because of the lack of the space in sending buffer. http://man7.org/linux/man-pages/man2/write.2.html\nEven though we try to push the data to the socket while spinning (16 times by default), it could fail.\nIn that case, we just store data to ChannelOutboundBuffer and try it next time when writing other data.\nThis is where the trouble begins. The next write that would be handling a different request, which means different RequestContext in the thread-local, completes the writing and executes all callbacks. Some of the callback should not be invoked with the RequestContext.\nThis could happen to some of the other ChannelFutures used, so I updated them as well.\nModification:\n\nRemove the RequestContext if exists in ChannelFuture listener.\n\nResult:\n\nCallbacks are not invoked with the wrong context in the thread-local\nClose #2414", "createdAt": "2020-01-22T11:31:37Z", "url": "https://github.com/line/armeria/pull/2415", "merged": true, "mergeCommit": {"oid": "f9b38ea6c164ccf62b76f72aea74756a7a842226"}, "closed": true, "closedAt": "2020-01-23T11:09:27Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb80DwUgH2gAyMzY1ODA0OTIzOjUzNjhiY2YwOTUyNmM0MmViZTU1NDJmNWZlOTExMmVjMjAxZDcxMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9HSJcAFqTM0NzE3MTk1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5368bcf09526c42ebe5542f5fe9112ec201d7111", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/5368bcf09526c42ebe5542f5fe9112ec201d7111", "committedDate": "2020-01-22T11:29:33Z", "message": "Fix a bug where an event loop with a ctx trying to push another ctx\nMotivation:\n\nModification:\n\nResult:\nClose #2414"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b38dc958dfe9233fd0fbe7fd5492b316258cacad", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/b38dc958dfe9233fd0fbe7fd5492b316258cacad", "committedDate": "2020-01-23T03:15:49Z", "message": "Add more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c499c77abea5ee53c893c6261e49af0a97f43ae2", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/c499c77abea5ee53c893c6261e49af0a97f43ae2", "committedDate": "2020-01-23T03:24:44Z", "message": "Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31d1ee7896e73d431bf5fc7562e514ac3fcd8858", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/31d1ee7896e73d431bf5fc7562e514ac3fcd8858", "committedDate": "2020-01-23T08:22:48Z", "message": "Add pop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MTI4NTMy", "url": "https://github.com/line/armeria/pull/2415#pullrequestreview-347128532", "createdAt": "2020-01-23T08:39:17Z", "commit": {"oid": "31d1ee7896e73d431bf5fc7562e514ac3fcd8858"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODozOToxN1rOFg2OxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QwODozOToxN1rOFg2OxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTk4NzI2OA==", "bodyText": "How about mentioning the specific use case of this method? We could then remove the duplicate comments in this pull request.", "url": "https://github.com/line/armeria/pull/2415#discussion_r369987268", "createdAt": "2020-01-23T08:39:17Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/RequestContextUtil.java", "diffHunk": "@@ -49,5 +49,18 @@ public static IllegalStateException newIllegalContextPushingException(\n                 \"unexpected thread or forgetting to close previous context.\");\n     }\n \n+    /**\n+     * Removes the {@link RequestContext} in the thread-local if exists and returns {@link SafeCloseable} which\n+     * pushes it back to the thread-local.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31d1ee7896e73d431bf5fc7562e514ac3fcd8858"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MTM4MTE2", "url": "https://github.com/line/armeria/pull/2415#pullrequestreview-347138116", "createdAt": "2020-01-23T08:56:48Z", "commit": {"oid": "31d1ee7896e73d431bf5fc7562e514ac3fcd8858"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12db6f3d64bc2bea261eb7380d9e56aff0289bf6", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/12db6f3d64bc2bea261eb7380d9e56aff0289bf6", "committedDate": "2020-01-23T09:03:58Z", "message": "Add description"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MTcxOTU3", "url": "https://github.com/line/armeria/pull/2415#pullrequestreview-347171957", "createdAt": "2020-01-23T09:53:28Z", "commit": {"oid": "12db6f3d64bc2bea261eb7380d9e56aff0289bf6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 898, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}