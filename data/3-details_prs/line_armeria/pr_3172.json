{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5MTgzMzkw", "number": 3172, "title": "Provide a way to allow bad HTTP2 cipher suites for client", "bodyText": "Motivation:\nA client fails to connect to a server using HTTPS if the server does not support modern cipher suites.\nBecause Armeria does not allow to use HTTP/2 cipher suite blacklist if a protocol is not H1.\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/internal/common/util/SslContextUtil.java\n    \n    \n        Lines 133 to 135\n      in\n      9e0a4c0\n    \n    \n    \n    \n\n        \n          \n           if (!forceHttp1) { \n        \n\n        \n          \n               validateHttp2Ciphers(ciphers); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nModifications:\n\nAdd tlsAllowUnsafeCiphers options to ClientFactoryBuilder and Flags\nfor disabling the cipher suites validation.\n\nResult:\n\nYou can now use [https://tools.ietf.org/html/rfc7540#appendix-A](TLS 1.2 Cipher Suite Block List) for TLS Handshake.\nFixes #3157", "createdAt": "2020-11-11T13:01:12Z", "url": "https://github.com/line/armeria/pull/3172", "merged": true, "mergeCommit": {"oid": "893f087cde3e2edd8830084842dd1c8b09fa4f66"}, "closed": true, "closedAt": "2020-11-19T08:48:28Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbdh4tgH2gAyNTE5MTgzMzkwOmFjOWQ3NWI4ZmQxYzA1N2RmNzQ0NDEzYjExYzI0MWQyOGQwZDczZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdd-IEbAFqTUzNDE2MTk0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ac9d75b8fd1c057df744413b11c241d28d0d73d1", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/ac9d75b8fd1c057df744413b11c241d28d0d73d1", "committedDate": "2020-11-11T12:57:27Z", "message": "Provide a way to allow blocklisted HTTP2 ciphers for client\n\nMotivation:\n\nA client fails to connect to a server using HTTPS if the server does not support modern cipher suites.\nBecause Armeria does not allow to use HTTP/2 cipher suite blacklist if a protocol is not `H1`.\nhttps://github.com/line/armeria/blob/9e0a4c02fdeeb276602c05992396605848d8f843/core/src/main/java/com/linecorp/armeria/internal/common/util/SslContextUtil.java#L133-L135\n\nModifications:\n\n- Add `tlsAllowUnsafeCiphers` options to ClientFactoryBuilder and Flags\n  for disabling the cipher suites validation.\n\nResult:\n\n- You can now use [https://tools.ietf.org/html/rfc7540#appendix-A](TLS 1.2 Cipher Suite Block List) for TLS Handshake.\n- Fixes #3157"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "513776d4487520f9d0c1de0c31f66c774671201b", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/513776d4487520f9d0c1de0c31f66c774671201b", "committedDate": "2020-11-11T13:00:16Z", "message": "Fix Javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dab4caf5006121dbae952ad9f33a362de76b589", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/0dab4caf5006121dbae952ad9f33a362de76b589", "committedDate": "2020-11-11T13:08:51Z", "message": "Javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13fb73cd33292db951376d456e5bfef6f0c80f73", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/13fb73cd33292db951376d456e5bfef6f0c80f73", "committedDate": "2020-11-11T13:39:56Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb505cc9b55f3b693d9a44cc5425a2bf675ab7c6", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/fb505cc9b55f3b693d9a44cc5425a2bf675ab7c6", "committedDate": "2020-11-11T15:22:48Z", "message": "Fix leak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47016ac9ed6fdd9fc679763014b5e02a1b3de4fc", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/47016ac9ed6fdd9fc679763014b5e02a1b3de4fc", "committedDate": "2020-11-12T02:17:32Z", "message": "close client factory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5Njk4OTM3", "url": "https://github.com/line/armeria/pull/3172#pullrequestreview-529698937", "createdAt": "2020-11-13T04:05:32Z", "commit": {"oid": "47016ac9ed6fdd9fc679763014b5e02a1b3de4fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMTM0Mjkx", "url": "https://github.com/line/armeria/pull/3172#pullrequestreview-531134291", "createdAt": "2020-11-16T09:13:57Z", "commit": {"oid": "47016ac9ed6fdd9fc679763014b5e02a1b3de4fc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOToxMzo1N1rOHzut8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOToxNDozMlrOHzuwXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAwNDg0OA==", "bodyText": "BAD_HTTP2_CIPHERS", "url": "https://github.com/line/armeria/pull/3172#discussion_r524004848", "createdAt": "2020-11-16T09:13:57Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/internal/common/util/SslContextUtil.java", "diffHunk": "@@ -184,7 +187,8 @@ private static void validateHttp2Ciphers(Set<String> ciphers) {\n     }\n \n     // https://httpwg.org/specs/rfc7540.html#BadCipherSuites\n-    private static final Set<String> HTTP2_BLACKLISTED_CIPHERS =\n+    @VisibleForTesting\n+    static final Set<String> HTTP2_BLACKLISTED_CIPHERS =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47016ac9ed6fdd9fc679763014b5e02a1b3de4fc"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAwNTQ2OQ==", "bodyText": "getBadCipher()?", "url": "https://github.com/line/armeria/pull/3172#discussion_r524005469", "createdAt": "2020-11-16T09:14:32Z", "author": {"login": "trustin"}, "path": "core/src/test/java/com/linecorp/armeria/internal/common/util/SslContextUtilTest.java", "diffHunk": "@@ -48,4 +59,51 @@ void jdkSsl() {\n             assertThat(supportedProtocols).contains(\"TLSv1.2\");\n         }\n     }\n+\n+    @Test\n+    void unsafeTlsCiphers() {\n+        final String cipher = getBlackListedCipher();\n+        assumeThat(cipher).isNotNull();\n+\n+        assertThatThrownBy(() -> {\n+            final ClientFactory factory =\n+                    ClientFactory.builder()\n+                                 .tlsCustomizer(builder -> builder.ciphers(ImmutableList.of(cipher)))\n+                                 .build();\n+            factory.closeAsync();\n+        }).isInstanceOf(IllegalStateException.class)\n+          .hasMessageContaining(\"Attempting to configure a server or HTTP/2 client without\");\n+\n+        final ClientFactory factory =\n+                ClientFactory.builder()\n+                             .tlsAllowUnsafeCiphers(true)\n+                             .tlsCustomizer(builder -> builder.ciphers(ImmutableList.of(cipher)))\n+                             .build();\n+        factory.closeAsync();\n+    }\n+\n+    @Nullable\n+    private static String getBlackListedCipher() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47016ac9ed6fdd9fc679763014b5e02a1b3de4fc"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "774cbbd5a9b720e75af4e2f0fa69bde8f551e1c6", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/774cbbd5a9b720e75af4e2f0fa69bde8f551e1c6", "committedDate": "2020-11-16T11:47:05Z", "message": "Address comments by @trustin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa044b583bd59467d0e244ce99354cd9a0eed2f4", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/aa044b583bd59467d0e244ce99354cd9a0eed2f4", "committedDate": "2020-11-16T13:09:13Z", "message": "Merge branch 'master' into unsafe-tls1.2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMDY0NzI3", "url": "https://github.com/line/armeria/pull/3172#pullrequestreview-532064727", "createdAt": "2020-11-17T06:56:25Z", "commit": {"oid": "aa044b583bd59467d0e244ce99354cd9a0eed2f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNjo1NjoyNVrOH0mn9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNjo1NjoyNVrOH0mn9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkyMDgyMQ==", "bodyText": "Could you use disallowed instead of block?", "url": "https://github.com/line/armeria/pull/3172#discussion_r524920821", "createdAt": "2020-11-17T06:56:25Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java", "diffHunk": "@@ -300,6 +300,20 @@ public ClientFactoryBuilder tlsCustomizer(Consumer<? super SslContextBuilder> tl\n         return this;\n     }\n \n+    /**\n+     * Sets whether to allow\n+     * <a href=\"https://tools.ietf.org/html/rfc7540#appendix-A\">TLS 1.2 Cipher Suite Block List</a>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa044b583bd59467d0e244ce99354cd9a0eed2f4"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baef82b176915cc8e6d2a0489c6b4b93a8cde108", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/baef82b176915cc8e6d2a0489c6b4b93a8cde108", "committedDate": "2020-11-17T16:50:26Z", "message": "Javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MTI4NDE5", "url": "https://github.com/line/armeria/pull/3172#pullrequestreview-534128419", "createdAt": "2020-11-19T07:01:28Z", "commit": {"oid": "baef82b176915cc8e6d2a0489c6b4b93a8cde108"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzowMToyOVrOH2PNGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzowNzoyOFrOH2PWCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNDI2NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Allow the bad cipher suites listed in\n          \n          \n            \n                 * Allows the bad cipher suites listed in", "url": "https://github.com/line/armeria/pull/3172#discussion_r526634265", "createdAt": "2020-11-19T07:01:29Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java", "diffHunk": "@@ -300,6 +300,19 @@ public ClientFactoryBuilder tlsCustomizer(Consumer<? super SslContextBuilder> tl\n         return this;\n     }\n \n+    /**\n+     * Allow the bad cipher suites listed in", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baef82b176915cc8e6d2a0489c6b4b93a8cde108"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNjEyOQ==", "bodyText": "I'm not sure what 'meet minimum security requirements' means clearly. We should convey the message that explicitly discourages its use.\nHow about:\n<p>Note that enabling this option increases the security risk of your connection.\nUse it only when you must communicate with a legacy system that does not support\nsecure cipher suites. See ... for more information", "url": "https://github.com/line/armeria/pull/3172#discussion_r526636129", "createdAt": "2020-11-19T07:06:34Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryBuilder.java", "diffHunk": "@@ -300,6 +300,19 @@ public ClientFactoryBuilder tlsCustomizer(Consumer<? super SslContextBuilder> tl\n         return this;\n     }\n \n+    /**\n+     * Allow the bad cipher suites listed in\n+     * <a href=\"https://tools.ietf.org/html/rfc7540#appendix-A\">RFC7540</a> for TLS handshake.\n+     *\n+     * <p>Note that the bad cipher suites do not meet minimum security requirements.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baef82b176915cc8e6d2a0489c6b4b93a8cde108"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNjQ5Nw==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/3172#discussion_r526636497", "createdAt": "2020-11-19T07:07:18Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryOptions.java", "diffHunk": "@@ -78,6 +78,17 @@\n     public static final ClientFactoryOption<Consumer<? super SslContextBuilder>> TLS_CUSTOMIZER =\n             ClientFactoryOption.define(\"TLS_CUSTOMIZER\", b -> { /* no-op */ });\n \n+    /**\n+     * Whether to allow the bad cipher suites listed in\n+     * <a href=\"https://tools.ietf.org/html/rfc7540#appendix-A\">RFC7540</a> for TLS handshake.\n+     *\n+     * <p>Note that the blocked cipher suites do not meet minimum security requirements.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baef82b176915cc8e6d2a0489c6b4b93a8cde108"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYzNjU1NA==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/3172#discussion_r526636554", "createdAt": "2020-11-19T07:07:28Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactoryOptions.java", "diffHunk": "@@ -446,4 +457,16 @@ public MeterRegistry meterRegistry() {\n     public ProxyConfigSelector proxyConfigSelector() {\n         return get(PROXY_CONFIG_SELECTOR);\n     }\n+\n+    /**\n+     * Returns whether to allow the bad cipher suites listed in\n+     * <a href=\"https://tools.ietf.org/html/rfc7540#appendix-A\">RFC7540</a> for TLS handshake.\n+     *\n+     * <p>Note that the bad cipher suites do not meet minimum security requirements.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baef82b176915cc8e6d2a0489c6b4b93a8cde108"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad3570e57be6e82401b1a310478a00578adb9887", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/ad3570e57be6e82401b1a310478a00578adb9887", "committedDate": "2020-11-19T07:52:49Z", "message": "Address comments @trustin / Update Javadoc"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "668a3bae0c8de38b0f2079039fcaa0a3076e0fd2", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/668a3bae0c8de38b0f2079039fcaa0a3076e0fd2", "committedDate": "2020-11-19T07:49:15Z", "message": "Address comments @trustin / Update Javadoc"}, "afterCommit": {"oid": "ad3570e57be6e82401b1a310478a00578adb9887", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/ad3570e57be6e82401b1a310478a00578adb9887", "committedDate": "2020-11-19T07:52:49Z", "message": "Address comments @trustin / Update Javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MTYxOTQx", "url": "https://github.com/line/armeria/pull/3172#pullrequestreview-534161941", "createdAt": "2020-11-19T08:03:58Z", "commit": {"oid": "ad3570e57be6e82401b1a310478a00578adb9887"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4824, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}