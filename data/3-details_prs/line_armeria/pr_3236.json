{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNDA1Njc5", "number": 3236, "title": "Refresh endpoints when the weight is changed in `HealthCheckedEndpointGroup`", "bodyText": "\u2026tGroup`\nMotivation:\nShould reflect the change of endpoints in HealthCheckedEndpointGroup even when the weight of an endpoint is changed.\nThis also fixes another bug which health check multiple times for duplicate endpoints. Related #3230\nModification:\n\nRefresh endpoints in HealthCheckedEndpointGroup when the weight of an endpoint is changed.\nFix a bug where multiple health check is executed for the same endpoints.\n\nResult:\n\nThe endpoints of HealthCheckedEndpointGroup are updated when the weight of an endpoint is changed.\nDo not execute duplicate health checks anymore for the same endpoint.", "createdAt": "2020-12-18T08:56:27Z", "url": "https://github.com/line/armeria/pull/3236", "merged": true, "mergeCommit": {"oid": "b8f8f097b29a3b5750f6b7f576cd092e9f093c86"}, "closed": true, "closedAt": "2020-12-28T03:18:47Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnULYigH2gAyNTQyNDA1Njc5OjJlNzE5YThiNmQ5YjU5OTk0YjFiN2Y2NGQzZDY1MTkzYTYyNWZkYjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdqdYI2AFqTU1ODk4Mjc0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2e719a8b6d9b59994b1b7f64d3d65193a625fdb3", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/2e719a8b6d9b59994b1b7f64d3d65193a625fdb3", "committedDate": "2020-12-18T08:50:49Z", "message": "Refresh endpoints when the weight is changed in `HealthCheckedEndpointGroup`\nMotivation:\nShould reflect the change of endpoints in `HealthCheckedEndpointGroup` even when the weight of an endpoint is changed.\n\nModification:\n- Refresh endpoints in `HealthCheckedEndpointGroup` when the weight of an endpoint is changed.\n\nResult:\n- The endpoints of `HealthCheckedEndpointGroup` are updated when the weight of an endpoint is changed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/f736e2ae715ed59d9dbaa9e23539aac6d90a4345", "committedDate": "2020-12-18T09:06:55Z", "message": "Add more test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NzgyNTQ4", "url": "https://github.com/line/armeria/pull/3236#pullrequestreview-556782548", "createdAt": "2020-12-22T02:38:34Z", "commit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMjozODozNFrOIJsVcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMjozODozNFrOIJsVcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzAzNDQ4MQ==", "bodyText": "How about checking first that the endpoints are the same?\nfinal boolean isSameEndpoints = contexts.size() == newSelectedEndpoints.size() &&\n                                contexts.keySet().containsAll(newSelectedEndpoints);", "url": "https://github.com/line/armeria/pull/3236#discussion_r547034481", "createdAt": "2020-12-22T02:38:34Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -173,26 +174,34 @@ private void refreshContexts() {\n         try {\n             synchronized (contexts) {\n                 final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n+                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2ODAyMTk0", "url": "https://github.com/line/armeria/pull/3236#pullrequestreview-556802194", "createdAt": "2020-12-22T03:52:13Z", "commit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMzo1MjoxM1rOIJtbyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwMzo1MjoxM1rOIJtbyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA1MjQ4OQ==", "bodyText": "Could remove this original local variable to prohibit unwanted access?\nfinal Set<Endpoint> newSelectedEndpoints = new HashSet<>(healthCheckStrategy.getSelectedEndpoints());", "url": "https://github.com/line/armeria/pull/3236#discussion_r547052489", "createdAt": "2020-12-22T03:52:13Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -173,26 +174,34 @@ private void refreshContexts() {\n         try {\n             synchronized (contexts) {\n                 final List<Endpoint> newSelectedEndpoints = healthCheckStrategy.getSelectedEndpoints();\n+                final Set<Endpoint> newSelectedEndpointsSet = new HashSet<>(newSelectedEndpoints);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f736e2ae715ed59d9dbaa9e23539aac6d90a4345"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19de976cc780f2ecaadfea892d72e6e2d3cee57e", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/19de976cc780f2ecaadfea892d72e6e2d3cee57e", "committedDate": "2020-12-22T04:20:40Z", "message": "Address the comment by @ikhoon"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2OTMzMzIx", "url": "https://github.com/line/armeria/pull/3236#pullrequestreview-556933321", "createdAt": "2020-12-22T09:21:27Z", "commit": {"oid": "19de976cc780f2ecaadfea892d72e6e2d3cee57e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "818e8789d882239798ee6c84b227f8acc5374302", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/818e8789d882239798ee6c84b227f8acc5374302", "committedDate": "2020-12-24T05:22:26Z", "message": "Fix comparator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MzkxNjkx", "url": "https://github.com/line/armeria/pull/3236#pullrequestreview-558391691", "createdAt": "2020-12-24T07:46:23Z", "commit": {"oid": "818e8789d882239798ee6c84b227f8acc5374302"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cf06e041a67c49cb864d7e47576d7b212991ced", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/3cf06e041a67c49cb864d7e47576d7b212991ced", "committedDate": "2020-12-24T12:54:50Z", "message": "Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4OTgyNzQ5", "url": "https://github.com/line/armeria/pull/3236#pullrequestreview-558982749", "createdAt": "2020-12-28T03:15:40Z", "commit": {"oid": "3cf06e041a67c49cb864d7e47576d7b212991ced"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4555, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}