{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MDUxODUw", "number": 2631, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxMjoxMFrODrk0PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxNDowMlrODrk3AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDE4NTU3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxMjoxMFrOF7_xcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoyODo0NFrOF8AY4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NTE1Mw==", "bodyText": "Just wondering is this change enough to fix the issue?", "url": "https://github.com/line/armeria/pull/2631#discussion_r398455153", "createdAt": "2020-03-26T10:12:10Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "diffHunk": "@@ -180,12 +182,19 @@ public void onNext(HttpObject o) {\n                 break;\n             }\n             case NEEDS_TRAILERS: {\n-                if (o instanceof HttpData || o instanceof ResponseHeaders) {\n+                if (o instanceof ResponseHeaders) {\n                     failAndRespond(new IllegalStateException(\n-                            \"published an HttpData or a ResponseHeaders: \" + o +\n+                            \"published a ResponseHeaders: \" + o +\n                             \" (expected: an HTTP trailers). service: \" + service()));\n                     return;\n                 }\n+                if (o instanceof HttpData) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5995752691eee01ae32f582225b36a2931e87d30"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2NTI0OQ==", "bodyText": "I think so. Instead of resetting, we can just ignore the content and call subscription.request(1) so that the response is completed in onComplete.", "url": "https://github.com/line/armeria/pull/2631#discussion_r398465249", "createdAt": "2020-03-26T10:28:44Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "diffHunk": "@@ -180,12 +182,19 @@ public void onNext(HttpObject o) {\n                 break;\n             }\n             case NEEDS_TRAILERS: {\n-                if (o instanceof HttpData || o instanceof ResponseHeaders) {\n+                if (o instanceof ResponseHeaders) {\n                     failAndRespond(new IllegalStateException(\n-                            \"published an HttpData or a ResponseHeaders: \" + o +\n+                            \"published a ResponseHeaders: \" + o +\n                             \" (expected: an HTTP trailers). service: \" + service()));\n                     return;\n                 }\n+                if (o instanceof HttpData) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NTE1Mw=="}, "originalCommit": {"oid": "5995752691eee01ae32f582225b36a2931e87d30"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDE4NzQ4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/server/encoding/HttpEncodedResponse.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxMjo0MVrOF7_ypw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDozNToxMFrOF8AoeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NTQ2Mw==", "bodyText": "Can we move this check to shouldEncodeResponse?", "url": "https://github.com/line/armeria/pull/2631#discussion_r398455463", "createdAt": "2020-03-26T10:12:41Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/server/encoding/HttpEncodedResponse.java", "diffHunk": "@@ -76,8 +76,8 @@ protected HttpObject filter(HttpObject obj) {\n             final ResponseHeaders headers = (ResponseHeaders) obj;\n \n             // Skip informational headers.\n-            final String status = headers.get(HttpHeaderNames.STATUS);\n-            if (ArmeriaHttpUtil.isInformational(status)) {\n+            final HttpStatus status = headers.status();\n+            if (status.isInformational() || status.isContentAlwaysEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5995752691eee01ae32f582225b36a2931e87d30"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2OTI0MQ==", "bodyText": "Ah thanks. It should be.", "url": "https://github.com/line/armeria/pull/2631#discussion_r398469241", "createdAt": "2020-03-26T10:35:10Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/server/encoding/HttpEncodedResponse.java", "diffHunk": "@@ -76,8 +76,8 @@ protected HttpObject filter(HttpObject obj) {\n             final ResponseHeaders headers = (ResponseHeaders) obj;\n \n             // Skip informational headers.\n-            final String status = headers.get(HttpHeaderNames.STATUS);\n-            if (ArmeriaHttpUtil.isInformational(status)) {\n+            final HttpStatus status = headers.status();\n+            if (status.isInformational() || status.isContentAlwaysEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NTQ2Mw=="}, "originalCommit": {"oid": "5995752691eee01ae32f582225b36a2931e87d30"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDE5MTU5OnYy", "diffSide": "RIGHT", "path": "core/src/test/java/com/linecorp/armeria/server/HttpResponseSubscriberTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxMzo0N1rOF7_1Ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDozNDo1NVrOF8An8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NjExOA==", "bodyText": "// HTTP does not allow a payload with a CONTINUE status, make sure we ignore it.", "url": "https://github.com/line/armeria/pull/2631#discussion_r398456118", "createdAt": "2020-03-26T10:13:47Z", "author": {"login": "anuraaga"}, "path": "core/src/test/java/com/linecorp/armeria/server/HttpResponseSubscriberTest.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.testing.junit.server.ServerExtension;\n+\n+public class HttpResponseSubscriberTest {\n+\n+    @RegisterExtension\n+    static final ServerExtension server = new ServerExtension() {\n+        @Override\n+        protected void configure(ServerBuilder sb) throws Exception {\n+            sb.service(\"/\", (ctx, req) -> {\n+                final ResponseHeaders headers = ResponseHeaders.builder(HttpStatus.NO_CONTENT).contentType(\n+                        MediaType.PLAIN_TEXT_UTF_8).build();\n+                // Add CONTINUE not to validate when creating HttpResponse.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5995752691eee01ae32f582225b36a2931e87d30"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2ODA0OA==", "bodyText": "Actually, I added CONTINUE to call static HttpResponse of(HttpObject... objs) {...}, let me rephrase a little bit.", "url": "https://github.com/line/armeria/pull/2631#discussion_r398468048", "createdAt": "2020-03-26T10:33:16Z", "author": {"login": "minwoox"}, "path": "core/src/test/java/com/linecorp/armeria/server/HttpResponseSubscriberTest.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.testing.junit.server.ServerExtension;\n+\n+public class HttpResponseSubscriberTest {\n+\n+    @RegisterExtension\n+    static final ServerExtension server = new ServerExtension() {\n+        @Override\n+        protected void configure(ServerBuilder sb) throws Exception {\n+            sb.service(\"/\", (ctx, req) -> {\n+                final ResponseHeaders headers = ResponseHeaders.builder(HttpStatus.NO_CONTENT).contentType(\n+                        MediaType.PLAIN_TEXT_UTF_8).build();\n+                // Add CONTINUE not to validate when creating HttpResponse.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NjExOA=="}, "originalCommit": {"oid": "5995752691eee01ae32f582225b36a2931e87d30"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ2OTEwNw==", "bodyText": "Removed the comment and use streaming() \ud83d\ude09", "url": "https://github.com/line/armeria/pull/2631#discussion_r398469107", "createdAt": "2020-03-26T10:34:55Z", "author": {"login": "minwoox"}, "path": "core/src/test/java/com/linecorp/armeria/server/HttpResponseSubscriberTest.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.testing.junit.server.ServerExtension;\n+\n+public class HttpResponseSubscriberTest {\n+\n+    @RegisterExtension\n+    static final ServerExtension server = new ServerExtension() {\n+        @Override\n+        protected void configure(ServerBuilder sb) throws Exception {\n+            sb.service(\"/\", (ctx, req) -> {\n+                final ResponseHeaders headers = ResponseHeaders.builder(HttpStatus.NO_CONTENT).contentType(\n+                        MediaType.PLAIN_TEXT_UTF_8).build();\n+                // Add CONTINUE not to validate when creating HttpResponse.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NjExOA=="}, "originalCommit": {"oid": "5995752691eee01ae32f582225b36a2931e87d30"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MDE5MjY1OnYy", "diffSide": "RIGHT", "path": "core/src/test/java/com/linecorp/armeria/server/HttpResponseSubscriberTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxNDowMlrOF7_10Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMDoxNDowMlrOF7_10Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ1NjI3Mw==", "bodyText": "DoesNot", "url": "https://github.com/line/armeria/pull/2631#discussion_r398456273", "createdAt": "2020-03-26T10:14:02Z", "author": {"login": "anuraaga"}, "path": "core/src/test/java/com/linecorp/armeria/server/HttpResponseSubscriberTest.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.common.AggregatedHttpResponse;\n+import com.linecorp.armeria.common.HttpData;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.testing.junit.server.ServerExtension;\n+\n+public class HttpResponseSubscriberTest {\n+\n+    @RegisterExtension\n+    static final ServerExtension server = new ServerExtension() {\n+        @Override\n+        protected void configure(ServerBuilder sb) throws Exception {\n+            sb.service(\"/\", (ctx, req) -> {\n+                final ResponseHeaders headers = ResponseHeaders.builder(HttpStatus.NO_CONTENT).contentType(\n+                        MediaType.PLAIN_TEXT_UTF_8).build();\n+                // Add CONTINUE not to validate when creating HttpResponse.\n+                return HttpResponse.of(ResponseHeaders.of(HttpStatus.CONTINUE), headers,\n+                                       HttpData.ofUtf8(\"foo\"));\n+            });\n+        }\n+    };\n+\n+    @Test\n+    void httpResponseSubscriberDoNotThrowExceptionWhenContentIsNotEmpty() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5995752691eee01ae32f582225b36a2931e87d30"}, "originalPosition": 50}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2817, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}