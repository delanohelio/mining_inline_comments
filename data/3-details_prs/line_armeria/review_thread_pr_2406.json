{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNzA4NTA4", "number": 2406, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTozNTowM1rODYwrNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwOToyNDoxNFrODZJMHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3Mjg5OTEwOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTozNTowM1rOFezW8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTozNTowM1rOFezW8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0MzA1Ng==", "bodyText": "Shouldn't we use CompletableFutures.succesfulAsList(...) (log the cause using defaultValueMapper) because we have to wait for all futures to be complete? never mind this. \ud83d\ude05", "url": "https://github.com/line/armeria/pull/2406#discussion_r367843056", "createdAt": "2020-01-17T09:35:03Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactory.java", "diffHunk": "@@ -96,12 +103,38 @@ static ClientFactoryBuilder builder() {\n      * Closes the default {@link ClientFactory}.\n      */\n     static void closeDefault() {\n-        LoggerFactory.getLogger(ClientFactory.class).debug(\n-                \"Closing the default {}\", ClientFactory.class.getSimpleName());\n-        try {\n-            DefaultClientFactory.DEFAULT.doClose();\n-        } finally {\n-            DefaultClientFactory.INSECURE.doClose();\n+        final Logger logger = LoggerFactory.getLogger(ClientFactory.class);\n+        logger.debug(\"Closing the default client factories\");\n+        final CompletableFuture<Void> closeFuture = CompletableFuture.allOf(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5329f4cb5216bf2a1e7eddc4a0b25e163b883ef8"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MjkyNDQ1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseable.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTo0Mzo0M1rOFezmXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTo0Mzo0M1rOFezmXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0NzAwNw==", "bodyText": "need to change the doc a little bit?\nUnlike {@link AutoCloseable}, -> In addition to the funcationality of closing synchronously with {@link AutoCloseable},", "url": "https://github.com/line/armeria/pull/2406#discussion_r367847007", "createdAt": "2020-01-17T09:43:43Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseable.java", "diffHunk": "@@ -22,12 +22,24 @@\n  * method releases the resources asynchronously, returning the {@link CompletableFuture} which is completed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5329f4cb5216bf2a1e7eddc4a0b25e163b883ef8"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MjkzOTgyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTo0ODo1MVrOFezv2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTo0ODo1MVrOFezv2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0OTQzNA==", "bodyText": "Not sure if we need this method, but if we do, how about making a static variable for this?", "url": "https://github.com/line/armeria/pull/2406#discussion_r367849434", "createdAt": "2020-01-17T09:48:51Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -0,0 +1,203 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n+import java.util.function.Consumer;\n+\n+/**\n+ * Provides support for implementing {@link AsyncCloseable}.\n+ */\n+public final class AsyncCloseableSupport implements AsyncCloseable {\n+\n+    private static final AtomicIntegerFieldUpdater<AsyncCloseableSupport> closingUpdater =\n+            AtomicIntegerFieldUpdater.newUpdater(AsyncCloseableSupport.class, \"closing\");\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} that will be completed immediately on {@link #close()} or\n+     * {@link #closeAsync()}. This method is useful when you don't have any resources to release.\n+     * <pre>{@code\n+     * > public class MyClass {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of();\n+     * >\n+     * >     public void doSomething() {\n+     * >         if (closeableSupport.isClosing()) {\n+     * >             throw new IllegalStateException(\"Closed already\");\n+     * >         }\n+     * >         ...\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     */\n+    public static AsyncCloseableSupport of() {\n+        return of(f -> f.complete(null));\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} which calls the specified {@link Consumer} on\n+     * {@link #close()} or {@link #closeAsync()}.\n+     * <pre>{@code\n+     * > class MyClass implements AutoCloseable {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of(f -> {\n+     * >         // Release resources here.\n+     * >         ...\n+     * >         f.complete(null);\n+     * >     });\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     *\n+     * @param closeAction the {@link Consumer} which performs the task that release the resources and\n+     *                    completes the given {@link CompletableFuture}.\n+     */\n+    public static AsyncCloseableSupport of(Consumer<CompletableFuture<?>> closeAction) {\n+        return new AsyncCloseableSupport(requireNonNull(closeAction, \"closeAction\"));\n+    }\n+\n+    /**\n+     * Returns the {@link AsyncCloseableSupport} which has been closed already.\n+     */\n+    public static AsyncCloseableSupport closed() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5329f4cb5216bf2a1e7eddc4a0b25e163b883ef8"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NTMxOTM1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwOTo0OTowNFrOFfKQgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xOFQwOTo0OTowNFrOFfKQgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODIxODI0Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * > public class MyClass {\n          \n          \n            \n                 * > public class MyClass implements AsyncCloseable {", "url": "https://github.com/line/armeria/pull/2406#discussion_r368218242", "createdAt": "2020-01-18T09:49:04Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -0,0 +1,211 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n+import java.util.function.Consumer;\n+\n+import com.linecorp.armeria.internal.UnmodifiableFuture;\n+\n+/**\n+ * Provides support for implementing {@link AsyncCloseable}.\n+ */\n+public final class AsyncCloseableSupport implements AsyncCloseable {\n+\n+    private static final AtomicIntegerFieldUpdater<AsyncCloseableSupport> closingUpdater =\n+            AtomicIntegerFieldUpdater.newUpdater(AsyncCloseableSupport.class, \"closing\");\n+\n+    private static final AsyncCloseableSupport CLOSED;\n+\n+    static {\n+        CLOSED = of();\n+        CLOSED.closeAsync();\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} that will be completed immediately on {@link #close()} or\n+     * {@link #closeAsync()}. This method is useful when you don't have any resources to release.\n+     * <pre>{@code\n+     * > public class MyClass {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjM0MjY5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientFactory.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwMzowNTowMlrOFfSktA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwODo0ODozNFrOFfW4Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1NDQ4NA==", "bodyText": "nit: Use singleton EMPTY_FUTURES like HttpClientFactory?", "url": "https://github.com/line/armeria/pull/2406#discussion_r368354484", "createdAt": "2020-01-20T03:05:02Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientFactory.java", "diffHunk": "@@ -162,20 +165,55 @@ public Object newClient(ClientBuilderParams params) {\n         return null;\n     }\n \n+    @Override\n+    public CompletableFuture<?> closeFuture() {\n+        return closeable.closeFuture();\n+    }\n+\n+    @Override\n+    public CompletableFuture<?> closeAsync() {\n+        return closeAsync(true);\n+    }\n+\n+    CompletableFuture<?> closeAsync(boolean checkDefault) {\n+        if (checkDefault && checkDefault()) {\n+            return closeFuture();\n+        }\n+        return closeable.closeAsync();\n+    }\n+\n+    private void closeAsync(CompletableFuture<?> future) {\n+        final CompletableFuture<?>[] delegateCloseFutures =\n+                clientFactoriesToClose.stream()\n+                                      .map(ClientFactory::closeAsync)\n+                                      .toArray(CompletableFuture[]::new);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQwMDA2MQ==", "bodyText": "Steam.toArray() does not accept it", "url": "https://github.com/line/armeria/pull/2406#discussion_r368400061", "createdAt": "2020-01-20T07:32:02Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientFactory.java", "diffHunk": "@@ -162,20 +165,55 @@ public Object newClient(ClientBuilderParams params) {\n         return null;\n     }\n \n+    @Override\n+    public CompletableFuture<?> closeFuture() {\n+        return closeable.closeFuture();\n+    }\n+\n+    @Override\n+    public CompletableFuture<?> closeAsync() {\n+        return closeAsync(true);\n+    }\n+\n+    CompletableFuture<?> closeAsync(boolean checkDefault) {\n+        if (checkDefault && checkDefault()) {\n+            return closeFuture();\n+        }\n+        return closeable.closeAsync();\n+    }\n+\n+    private void closeAsync(CompletableFuture<?> future) {\n+        final CompletableFuture<?>[] delegateCloseFutures =\n+                clientFactoriesToClose.stream()\n+                                      .map(ClientFactory::closeAsync)\n+                                      .toArray(CompletableFuture[]::new);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1NDQ4NA=="}, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQyNDk5NQ==", "bodyText": "Oops! Thanks.", "url": "https://github.com/line/armeria/pull/2406#discussion_r368424995", "createdAt": "2020-01-20T08:48:34Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientFactory.java", "diffHunk": "@@ -162,20 +165,55 @@ public Object newClient(ClientBuilderParams params) {\n         return null;\n     }\n \n+    @Override\n+    public CompletableFuture<?> closeFuture() {\n+        return closeable.closeFuture();\n+    }\n+\n+    @Override\n+    public CompletableFuture<?> closeAsync() {\n+        return closeAsync(true);\n+    }\n+\n+    CompletableFuture<?> closeAsync(boolean checkDefault) {\n+        if (checkDefault && checkDefault()) {\n+            return closeFuture();\n+        }\n+        return closeable.closeAsync();\n+    }\n+\n+    private void closeAsync(CompletableFuture<?> future) {\n+        final CompletableFuture<?>[] delegateCloseFutures =\n+                clientFactoriesToClose.stream()\n+                                      .map(ClientFactory::closeAsync)\n+                                      .toArray(CompletableFuture[]::new);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1NDQ4NA=="}, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjM2NjEyOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwMzoyOTowM1rOFfSzDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNzozMjoyOVrOFfVXPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1ODE1Nw==", "bodyText": "nit: Don't we need to add the breaking-change label? \ud83e\uddd0", "url": "https://github.com/line/armeria/pull/2406#discussion_r368358157", "createdAt": "2020-01-20T03:29:03Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseable.java", "diffHunk": "@@ -18,16 +18,28 @@\n import java.util.concurrent.CompletableFuture;\n \n /**\n- * An object that may hold resources until it is closed. Unlike {@link AutoCloseable}, the {@link #closeAsync()}\n- * method releases the resources asynchronously, returning the {@link CompletableFuture} which is completed\n- * after the resources are released.\n+ * An object that may hold resources until it is closed. In addition to {@link AutoCloseable#close()},\n+ * this interface provides {@link #closeAsync()} which releases the resources asynchronously, returning\n+ * a {@link CompletableFuture} which is completed after the resources are released.\n  */\n-@FunctionalInterface\n-public interface AsyncCloseable {\n+public interface AsyncCloseable extends AutoCloseable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQwMDE4OA==", "bodyText": "Added the label.", "url": "https://github.com/line/armeria/pull/2406#discussion_r368400188", "createdAt": "2020-01-20T07:32:29Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseable.java", "diffHunk": "@@ -18,16 +18,28 @@\n import java.util.concurrent.CompletableFuture;\n \n /**\n- * An object that may hold resources until it is closed. Unlike {@link AutoCloseable}, the {@link #closeAsync()}\n- * method releases the resources asynchronously, returning the {@link CompletableFuture} which is completed\n- * after the resources are released.\n+ * An object that may hold resources until it is closed. In addition to {@link AutoCloseable#close()},\n+ * this interface provides {@link #closeAsync()} which releases the resources asynchronously, returning\n+ * a {@link CompletableFuture} which is completed after the resources are released.\n  */\n-@FunctionalInterface\n-public interface AsyncCloseable {\n+public interface AsyncCloseable extends AutoCloseable {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM1ODE1Nw=="}, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjM4Mjc5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwMzo0Njo0OFrOFfS8nQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwOTo0Mjo0NFrOFfYaQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM2MDYwNQ==", "bodyText": "nit\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static AsyncCloseableSupport of(Consumer<CompletableFuture<?>> closeAction) {\n          \n          \n            \n                public static AsyncCloseableSupport of(Consumer<? super CompletableFuture<?>> closeAction) {", "url": "https://github.com/line/armeria/pull/2406#discussion_r368360605", "createdAt": "2020-01-20T03:46:48Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -0,0 +1,211 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n+import java.util.function.Consumer;\n+\n+import com.linecorp.armeria.internal.UnmodifiableFuture;\n+\n+/**\n+ * Provides support for implementing {@link AsyncCloseable}.\n+ */\n+public final class AsyncCloseableSupport implements AsyncCloseable {\n+\n+    private static final AtomicIntegerFieldUpdater<AsyncCloseableSupport> closingUpdater =\n+            AtomicIntegerFieldUpdater.newUpdater(AsyncCloseableSupport.class, \"closing\");\n+\n+    private static final AsyncCloseableSupport CLOSED;\n+\n+    static {\n+        CLOSED = of();\n+        CLOSED.closeAsync();\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} that will be completed immediately on {@link #close()} or\n+     * {@link #closeAsync()}. This method is useful when you don't have any resources to release.\n+     * <pre>{@code\n+     * > public class MyClass {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of();\n+     * >\n+     * >     public void doSomething() {\n+     * >         if (closeableSupport.isClosing()) {\n+     * >             throw new IllegalStateException(\"Closed already\");\n+     * >         }\n+     * >         ...\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     */\n+    public static AsyncCloseableSupport of() {\n+        return of(f -> f.complete(null));\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} which calls the specified {@link Consumer} on\n+     * {@link #close()} or {@link #closeAsync()}.\n+     * <pre>{@code\n+     * > class MyClass implements AutoCloseable {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of(f -> {\n+     * >         // Release resources here.\n+     * >         ...\n+     * >         f.complete(null);\n+     * >     });\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     *\n+     * @param closeAction the {@link Consumer} which performs the task that release the resources and\n+     *                    completes the given {@link CompletableFuture}.\n+     */\n+    public static AsyncCloseableSupport of(Consumer<CompletableFuture<?>> closeAction) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQwMDU2OQ==", "bodyText": "Thought about it, but ? super does not make sense here, because the consumer must call CompletableFuture.complete*(). A consumer that accepts a CompletionStage or Object cannot do that.", "url": "https://github.com/line/armeria/pull/2406#discussion_r368400569", "createdAt": "2020-01-20T07:33:49Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -0,0 +1,211 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n+import java.util.function.Consumer;\n+\n+import com.linecorp.armeria.internal.UnmodifiableFuture;\n+\n+/**\n+ * Provides support for implementing {@link AsyncCloseable}.\n+ */\n+public final class AsyncCloseableSupport implements AsyncCloseable {\n+\n+    private static final AtomicIntegerFieldUpdater<AsyncCloseableSupport> closingUpdater =\n+            AtomicIntegerFieldUpdater.newUpdater(AsyncCloseableSupport.class, \"closing\");\n+\n+    private static final AsyncCloseableSupport CLOSED;\n+\n+    static {\n+        CLOSED = of();\n+        CLOSED.closeAsync();\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} that will be completed immediately on {@link #close()} or\n+     * {@link #closeAsync()}. This method is useful when you don't have any resources to release.\n+     * <pre>{@code\n+     * > public class MyClass {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of();\n+     * >\n+     * >     public void doSomething() {\n+     * >         if (closeableSupport.isClosing()) {\n+     * >             throw new IllegalStateException(\"Closed already\");\n+     * >         }\n+     * >         ...\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     */\n+    public static AsyncCloseableSupport of() {\n+        return of(f -> f.complete(null));\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} which calls the specified {@link Consumer} on\n+     * {@link #close()} or {@link #closeAsync()}.\n+     * <pre>{@code\n+     * > class MyClass implements AutoCloseable {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of(f -> {\n+     * >         // Release resources here.\n+     * >         ...\n+     * >         f.complete(null);\n+     * >     });\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     *\n+     * @param closeAction the {@link Consumer} which performs the task that release the resources and\n+     *                    completes the given {@link CompletableFuture}.\n+     */\n+    public static AsyncCloseableSupport of(Consumer<CompletableFuture<?>> closeAction) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM2MDYwNQ=="}, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQyNDYwNg==", "bodyText": "Either way is fine. Sometimes contravariance makes me confused.\ud83e\udd2a\nBecause we can call CompletableFuture.complete*() even it is defined with Consumer<? super CompletableFuture<?>>. \ud83e\uddd0\n// Compiles\nConsumer<? super CompletableFuture<Integer>> consumerSuper = x -> x.complete(10);", "url": "https://github.com/line/armeria/pull/2406#discussion_r368424606", "createdAt": "2020-01-20T08:47:36Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -0,0 +1,211 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n+import java.util.function.Consumer;\n+\n+import com.linecorp.armeria.internal.UnmodifiableFuture;\n+\n+/**\n+ * Provides support for implementing {@link AsyncCloseable}.\n+ */\n+public final class AsyncCloseableSupport implements AsyncCloseable {\n+\n+    private static final AtomicIntegerFieldUpdater<AsyncCloseableSupport> closingUpdater =\n+            AtomicIntegerFieldUpdater.newUpdater(AsyncCloseableSupport.class, \"closing\");\n+\n+    private static final AsyncCloseableSupport CLOSED;\n+\n+    static {\n+        CLOSED = of();\n+        CLOSED.closeAsync();\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} that will be completed immediately on {@link #close()} or\n+     * {@link #closeAsync()}. This method is useful when you don't have any resources to release.\n+     * <pre>{@code\n+     * > public class MyClass {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of();\n+     * >\n+     * >     public void doSomething() {\n+     * >         if (closeableSupport.isClosing()) {\n+     * >             throw new IllegalStateException(\"Closed already\");\n+     * >         }\n+     * >         ...\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     */\n+    public static AsyncCloseableSupport of() {\n+        return of(f -> f.complete(null));\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} which calls the specified {@link Consumer} on\n+     * {@link #close()} or {@link #closeAsync()}.\n+     * <pre>{@code\n+     * > class MyClass implements AutoCloseable {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of(f -> {\n+     * >         // Release resources here.\n+     * >         ...\n+     * >         f.complete(null);\n+     * >     });\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     *\n+     * @param closeAction the {@link Consumer} which performs the task that release the resources and\n+     *                    completes the given {@link CompletableFuture}.\n+     */\n+    public static AsyncCloseableSupport of(Consumer<CompletableFuture<?>> closeAction) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM2MDYwNQ=="}, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQzODg4NQ==", "bodyText": "Yeah it compiles, but what I'm saying is this doesn't make sense:\nConsumer<CompletionStage<?>> consumer = stage -> ...; // Can't call complete()\nAsyncCloseableSupport.of(consumer); // This doesn't make sense. Consumer must call .complete().", "url": "https://github.com/line/armeria/pull/2406#discussion_r368438885", "createdAt": "2020-01-20T09:19:36Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -0,0 +1,211 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n+import java.util.function.Consumer;\n+\n+import com.linecorp.armeria.internal.UnmodifiableFuture;\n+\n+/**\n+ * Provides support for implementing {@link AsyncCloseable}.\n+ */\n+public final class AsyncCloseableSupport implements AsyncCloseable {\n+\n+    private static final AtomicIntegerFieldUpdater<AsyncCloseableSupport> closingUpdater =\n+            AtomicIntegerFieldUpdater.newUpdater(AsyncCloseableSupport.class, \"closing\");\n+\n+    private static final AsyncCloseableSupport CLOSED;\n+\n+    static {\n+        CLOSED = of();\n+        CLOSED.closeAsync();\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} that will be completed immediately on {@link #close()} or\n+     * {@link #closeAsync()}. This method is useful when you don't have any resources to release.\n+     * <pre>{@code\n+     * > public class MyClass {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of();\n+     * >\n+     * >     public void doSomething() {\n+     * >         if (closeableSupport.isClosing()) {\n+     * >             throw new IllegalStateException(\"Closed already\");\n+     * >         }\n+     * >         ...\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     */\n+    public static AsyncCloseableSupport of() {\n+        return of(f -> f.complete(null));\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} which calls the specified {@link Consumer} on\n+     * {@link #close()} or {@link #closeAsync()}.\n+     * <pre>{@code\n+     * > class MyClass implements AutoCloseable {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of(f -> {\n+     * >         // Release resources here.\n+     * >         ...\n+     * >         f.complete(null);\n+     * >     });\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     *\n+     * @param closeAction the {@link Consumer} which performs the task that release the resources and\n+     *                    completes the given {@link CompletableFuture}.\n+     */\n+    public static AsyncCloseableSupport of(Consumer<CompletableFuture<?>> closeAction) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM2MDYwNQ=="}, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ1MDExNQ==", "bodyText": "Consumer must call .complete().\n\nI understood. You may want to constrain consumer implementation. It makes sense to me. \ud83d\udc4d", "url": "https://github.com/line/armeria/pull/2406#discussion_r368450115", "createdAt": "2020-01-20T09:42:44Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -0,0 +1,211 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n+import java.util.function.Consumer;\n+\n+import com.linecorp.armeria.internal.UnmodifiableFuture;\n+\n+/**\n+ * Provides support for implementing {@link AsyncCloseable}.\n+ */\n+public final class AsyncCloseableSupport implements AsyncCloseable {\n+\n+    private static final AtomicIntegerFieldUpdater<AsyncCloseableSupport> closingUpdater =\n+            AtomicIntegerFieldUpdater.newUpdater(AsyncCloseableSupport.class, \"closing\");\n+\n+    private static final AsyncCloseableSupport CLOSED;\n+\n+    static {\n+        CLOSED = of();\n+        CLOSED.closeAsync();\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} that will be completed immediately on {@link #close()} or\n+     * {@link #closeAsync()}. This method is useful when you don't have any resources to release.\n+     * <pre>{@code\n+     * > public class MyClass {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of();\n+     * >\n+     * >     public void doSomething() {\n+     * >         if (closeableSupport.isClosing()) {\n+     * >             throw new IllegalStateException(\"Closed already\");\n+     * >         }\n+     * >         ...\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     */\n+    public static AsyncCloseableSupport of() {\n+        return of(f -> f.complete(null));\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} which calls the specified {@link Consumer} on\n+     * {@link #close()} or {@link #closeAsync()}.\n+     * <pre>{@code\n+     * > class MyClass implements AutoCloseable {\n+     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of(f -> {\n+     * >         // Release resources here.\n+     * >         ...\n+     * >         f.complete(null);\n+     * >     });\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeFuture() {\n+     * >         return closeableSupport.closeFuture();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() {\n+     * >         return closeableSupport.closeAsync();\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> close() {\n+     * >         return closeableSupport.close();\n+     * >     }\n+     * > }\n+     * }</pre>\n+     *\n+     * @param closeAction the {@link Consumer} which performs the task that release the resources and\n+     *                    completes the given {@link CompletableFuture}.\n+     */\n+    public static AsyncCloseableSupport of(Consumer<CompletableFuture<?>> closeAction) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM2MDYwNQ=="}, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjM5NDI1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/internal/UnmodifiableFuture.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNDowMDowN1rOFfTDdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNDowMDowN1rOFfTDdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM2MjM1OA==", "bodyText": "nit: requireNonNull(future)?", "url": "https://github.com/line/armeria/pull/2406#discussion_r368362358", "createdAt": "2020-01-20T04:00:07Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/internal/UnmodifiableFuture.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.util.Exceptions;\n+\n+/**\n+ * A {@link CompletableFuture} which prevents the caller from completing it.\n+ */\n+public final class UnmodifiableFuture<T> extends CompletableFuture<T> {\n+\n+    private static final UnmodifiableFuture<?> NIL;\n+\n+    static {\n+        NIL = new UnmodifiableFuture<>();\n+        NIL.doComplete(null);\n+    }\n+\n+    public static <U> UnmodifiableFuture<U> completedFuture(@Nullable U value) {\n+        if (value == null) {\n+            @SuppressWarnings(\"unchecked\")\n+            final UnmodifiableFuture<U> cast = (UnmodifiableFuture<U>) NIL;\n+            return cast;\n+        }\n+\n+        final UnmodifiableFuture<U> future = new UnmodifiableFuture<>();\n+        future.doComplete(value);\n+        return future;\n+    }\n+\n+    public static <U> UnmodifiableFuture<U> exceptionallyCompletedFuture(Throwable cause) {\n+        requireNonNull(cause, \"cause\");\n+        final UnmodifiableFuture<U> future = new UnmodifiableFuture<>();\n+        future.doCompleteExceptionally(cause);\n+        return future;\n+    }\n+\n+    public static <U> UnmodifiableFuture<U> wrap(CompletableFuture<U> future) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjUxODI1OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNjowNTo0OFrOFfUMWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNzozNToyNlrOFfVadA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4MTAxOA==", "bodyText": "Can you add a comment why we don't use join() here? I think this is basically only called from a shutdown hook ever, so interruption probably doesn't matter so much but not sure.", "url": "https://github.com/line/armeria/pull/2406#discussion_r368381018", "createdAt": "2020-01-20T06:05:48Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactory.java", "diffHunk": "@@ -96,12 +103,38 @@ static ClientFactoryBuilder builder() {\n      * Closes the default {@link ClientFactory}.\n      */\n     static void closeDefault() {\n-        LoggerFactory.getLogger(ClientFactory.class).debug(\n-                \"Closing the default {}\", ClientFactory.class.getSimpleName());\n-        try {\n-            DefaultClientFactory.DEFAULT.doClose();\n-        } finally {\n-            DefaultClientFactory.INSECURE.doClose();\n+        final Logger logger = LoggerFactory.getLogger(ClientFactory.class);\n+        logger.debug(\"Closing the default client factories\");\n+        final CompletableFuture<Void> closeFuture = CompletableFuture.allOf(\n+                DefaultClientFactory.DEFAULT.closeAsync(false),\n+                DefaultClientFactory.INSECURE.closeAsync(false)).handle((unused1, cause) -> {\n+            if (cause == null) {\n+                logger.debug(\"Closed the default client factories\");\n+            } else {\n+                logger.warn(\"Failed to close the default client factories:\", Exceptions.peel(cause));\n+            }\n+            return null;\n+        });\n+\n+        if (!(Thread.currentThread() instanceof NonBlocking)) {\n+            boolean interrupted = false;\n+            try {\n+                for (;;) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQwMTAxMg==", "bodyText": "It's because it may not be invoked from a shutdown hook? Nothing stops a user from calling this method manually (or automatically via some framework).", "url": "https://github.com/line/armeria/pull/2406#discussion_r368401012", "createdAt": "2020-01-20T07:35:26Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactory.java", "diffHunk": "@@ -96,12 +103,38 @@ static ClientFactoryBuilder builder() {\n      * Closes the default {@link ClientFactory}.\n      */\n     static void closeDefault() {\n-        LoggerFactory.getLogger(ClientFactory.class).debug(\n-                \"Closing the default {}\", ClientFactory.class.getSimpleName());\n-        try {\n-            DefaultClientFactory.DEFAULT.doClose();\n-        } finally {\n-            DefaultClientFactory.INSECURE.doClose();\n+        final Logger logger = LoggerFactory.getLogger(ClientFactory.class);\n+        logger.debug(\"Closing the default client factories\");\n+        final CompletableFuture<Void> closeFuture = CompletableFuture.allOf(\n+                DefaultClientFactory.DEFAULT.closeAsync(false),\n+                DefaultClientFactory.INSECURE.closeAsync(false)).handle((unused1, cause) -> {\n+            if (cause == null) {\n+                logger.debug(\"Closed the default client factories\");\n+            } else {\n+                logger.warn(\"Failed to close the default client factories:\", Exceptions.peel(cause));\n+            }\n+            return null;\n+        });\n+\n+        if (!(Thread.currentThread() instanceof NonBlocking)) {\n+            boolean interrupted = false;\n+            try {\n+                for (;;) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4MTAxOA=="}, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjUyNDAxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseable.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNjoxMDozM1rOFfUP3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNzozNjoxMVrOFfVbOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4MTkxNg==", "bodyText": "Having two similar names with same return type is making me scratch my head a little. It looks like future is a way of closing out of these three\n\n(Implicitly implied) Blocking close\nAsync close\nFuture close\n\nI know this matches our general pattern, but shall we consider renaming all fooFuture to whenFoo? ctx.log().whenComplete().thenAccept() reads like English and seems quite nice to me.", "url": "https://github.com/line/armeria/pull/2406#discussion_r368381916", "createdAt": "2020-01-20T06:10:33Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseable.java", "diffHunk": "@@ -18,16 +18,28 @@\n import java.util.concurrent.CompletableFuture;\n \n /**\n- * An object that may hold resources until it is closed. Unlike {@link AutoCloseable}, the {@link #closeAsync()}\n- * method releases the resources asynchronously, returning the {@link CompletableFuture} which is completed\n- * after the resources are released.\n+ * An object that may hold resources until it is closed. In addition to {@link AutoCloseable#close()},\n+ * this interface provides {@link #closeAsync()} which releases the resources asynchronously, returning\n+ * a {@link CompletableFuture} which is completed after the resources are released.\n  */\n-@FunctionalInterface\n-public interface AsyncCloseable {\n+public interface AsyncCloseable extends AutoCloseable {\n     /**\n-     * Releases the resources held by this object asynchronously.\n+     * Returns the {@link CompletableFuture} which is completed after the resources are released. Note that\n+     * you must use {@link #close()} or {@link #closeAsync()} to release the resources actually. This method\n+     * merely returns the {@link CompletableFuture}.\n+     */\n+    CompletableFuture<?> closeFuture();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQwMTIwOQ==", "bodyText": "That's a good idea. Let me rename. whenClosed(), then?", "url": "https://github.com/line/armeria/pull/2406#discussion_r368401209", "createdAt": "2020-01-20T07:36:11Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseable.java", "diffHunk": "@@ -18,16 +18,28 @@\n import java.util.concurrent.CompletableFuture;\n \n /**\n- * An object that may hold resources until it is closed. Unlike {@link AutoCloseable}, the {@link #closeAsync()}\n- * method releases the resources asynchronously, returning the {@link CompletableFuture} which is completed\n- * after the resources are released.\n+ * An object that may hold resources until it is closed. In addition to {@link AutoCloseable#close()},\n+ * this interface provides {@link #closeAsync()} which releases the resources asynchronously, returning\n+ * a {@link CompletableFuture} which is completed after the resources are released.\n  */\n-@FunctionalInterface\n-public interface AsyncCloseable {\n+public interface AsyncCloseable extends AutoCloseable {\n     /**\n-     * Releases the resources held by this object asynchronously.\n+     * Returns the {@link CompletableFuture} which is completed after the resources are released. Note that\n+     * you must use {@link #close()} or {@link #closeAsync()} to release the resources actually. This method\n+     * merely returns the {@link CompletableFuture}.\n+     */\n+    CompletableFuture<?> closeFuture();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4MTkxNg=="}, "originalCommit": {"oid": "930446cc6fc74ac65bd62bea43a246c28b06ad6d"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3Njg0NDgzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwOTowMDo1OFrOFfXM8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwOTowMDo1OFrOFfXM8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQzMDMyMA==", "bodyText": "nit: This one should be ListenableAsyncCloseable as well.", "url": "https://github.com/line/armeria/pull/2406#discussion_r368430320", "createdAt": "2020-01-20T09:00:58Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -80,27 +77,24 @@ public static AsyncCloseableSupport of() {\n      * Returns a new {@link AsyncCloseableSupport} which calls the specified {@link Consumer} on\n      * {@link #close()} or {@link #closeAsync()}.\n      * <pre>{@code\n-     * > class MyClass implements AutoCloseable {\n-     * >     final AsyncCloseableSupport closeableSupport = AsyncCloseableSupport.of(f -> {\n+     * > class MyClass implements AsyncCloseable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c2834ed45ad98e4bcace17cacc4628611ba8b2c"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3Njg1Mzk0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwOTowMzo1MVrOFfXSJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwOTowMzo1MVrOFfXSJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQzMTY1Mw==", "bodyText": "nit: unmodifiable?", "url": "https://github.com/line/armeria/pull/2406#discussion_r368431653", "createdAt": "2020-01-20T09:03:51Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/AsyncCloseableSupport.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;\n+import java.util.function.Consumer;\n+\n+/**\n+ * Provides support for implementing {@link AsyncCloseable} or {@link ListenableAsyncCloseable}.\n+ */\n+public final class AsyncCloseableSupport implements ListenableAsyncCloseable {\n+\n+    private static final AtomicIntegerFieldUpdater<AsyncCloseableSupport> closingUpdater =\n+            AtomicIntegerFieldUpdater.newUpdater(AsyncCloseableSupport.class, \"closing\");\n+\n+    private static final AsyncCloseableSupport CLOSED;\n+\n+    static {\n+        CLOSED = of();\n+        CLOSED.closeAsync();\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} that will be completed immediately on {@link #close()} or\n+     * {@link #closeAsync()}. This method is useful when you don't have any resources to release.\n+     * <pre>{@code\n+     * > public class MyClass implements ListenableAsyncCloseable {\n+     * >     final AsyncCloseableSupport closeable = AsyncCloseableSupport.of();\n+     * >\n+     * >     public void doSomething() {\n+     * >         if (closeable.isClosing()) {\n+     * >             throw new IllegalStateException(\"Closed already\");\n+     * >         }\n+     * >         ...\n+     * >     }\n+     * >\n+     * >     @Override\n+     * >     public boolean isClosing() { return closeable.isClosing(); }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> whenClosed() { return closeable.whenClosed(); }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() { return closeable.closeAsync(); }\n+     * >\n+     * >     @Override\n+     * >     public void close() { closeable.close(); }\n+     * > }\n+     * }</pre>\n+     */\n+    public static AsyncCloseableSupport of() {\n+        return of(f -> f.complete(null));\n+    }\n+\n+    /**\n+     * Returns a new {@link AsyncCloseableSupport} which calls the specified {@link Consumer} on\n+     * {@link #close()} or {@link #closeAsync()}.\n+     * <pre>{@code\n+     * > class MyClass implements AsyncCloseable {\n+     * >     final AsyncCloseableSupport closeable = AsyncCloseableSupport.of(f -> {\n+     * >         // Release resources here.\n+     * >         ...\n+     * >         f.complete(null);\n+     * >     });\n+     * >\n+     * >     @Override\n+     * >     public boolean isClosing() { return closeable.isClosing(); }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> whenClosed() { return closeable.whenClosed(); }\n+     * >\n+     * >     @Override\n+     * >     public CompletableFuture<?> closeAsync() { return closeable.closeAsync(); }\n+     * >\n+     * >     @Override\n+     * >     public void close() { closeable.close(); }\n+     * > }\n+     * }</pre>\n+     *\n+     * @param closeAction the {@link Consumer} which performs the task that release the resources and\n+     *                    completes the given {@link CompletableFuture}.\n+     */\n+    public static AsyncCloseableSupport of(Consumer<CompletableFuture<?>> closeAction) {\n+        return new AsyncCloseableSupport(requireNonNull(closeAction, \"closeAction\"));\n+    }\n+\n+    /**\n+     * Returns the {@link AsyncCloseableSupport} which has been closed already.\n+     */\n+    public static AsyncCloseableSupport closed() {\n+        return CLOSED;\n+    }\n+\n+    private final Consumer<CompletableFuture<?>> closeAction;\n+    private final CompletableFuture<?> closeFuture = new CompletableFuture<>();\n+    private final UnmodifiableFuture<?> unupdatableCloseFuture =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "493e868e28bcaa51861f0a166a03ec6eb28a0ba8"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NjkxNTQ4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/util/UnmodifiableFuture.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwOToyNDoxNFrOFfX23Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwOTo1MjoyMFrOFfYs_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ0MTA1Mw==", "bodyText": "Shouldn't this return CompletableFuture?", "url": "https://github.com/line/armeria/pull/2406#discussion_r368441053", "createdAt": "2020-01-20T09:24:14Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/UnmodifiableFuture.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.internal.eventloop.EventLoopCheckingCompletableFuture;\n+\n+/**\n+ * A {@link CompletableFuture} which prevents the caller from completing it. An attempt to call any of\n+ * the following methods will trigger an {@link UnsupportedOperationException}:\n+ * <ul>\n+ *   <li>{@link #complete(Object)}</li>\n+ *   <li>{@link #completeExceptionally(Throwable)}</li>\n+ *   <li>{@link #obtrudeValue(Object)}</li>\n+ *   <li>{@link #obtrudeException(Throwable)}</li>\n+ * </ul>\n+ * Also, {@link #cancel(boolean)} will do nothing but returning whether cancelled or not.\n+ */\n+public final class UnmodifiableFuture<T> extends EventLoopCheckingCompletableFuture<T> {\n+\n+    private static final UnmodifiableFuture<?> NIL;\n+\n+    static {\n+        NIL = new UnmodifiableFuture<>();\n+        NIL.doComplete(null);\n+    }\n+\n+    /**\n+     * Returns an {@link UnmodifiableFuture} which has been completed with the specified {@code value}.\n+     */\n+    public static <U> UnmodifiableFuture<U> completedFuture(@Nullable U value) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "493e868e28bcaa51861f0a166a03ec6eb28a0ba8"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ1NDY2MA==", "bodyText": "On second thought, it's better to return UnmodifiableFuture. \ud83d\ude09 Sorry about the noise.", "url": "https://github.com/line/armeria/pull/2406#discussion_r368454660", "createdAt": "2020-01-20T09:51:56Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/UnmodifiableFuture.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.internal.eventloop.EventLoopCheckingCompletableFuture;\n+\n+/**\n+ * A {@link CompletableFuture} which prevents the caller from completing it. An attempt to call any of\n+ * the following methods will trigger an {@link UnsupportedOperationException}:\n+ * <ul>\n+ *   <li>{@link #complete(Object)}</li>\n+ *   <li>{@link #completeExceptionally(Throwable)}</li>\n+ *   <li>{@link #obtrudeValue(Object)}</li>\n+ *   <li>{@link #obtrudeException(Throwable)}</li>\n+ * </ul>\n+ * Also, {@link #cancel(boolean)} will do nothing but returning whether cancelled or not.\n+ */\n+public final class UnmodifiableFuture<T> extends EventLoopCheckingCompletableFuture<T> {\n+\n+    private static final UnmodifiableFuture<?> NIL;\n+\n+    static {\n+        NIL = new UnmodifiableFuture<>();\n+        NIL.doComplete(null);\n+    }\n+\n+    /**\n+     * Returns an {@link UnmodifiableFuture} which has been completed with the specified {@code value}.\n+     */\n+    public static <U> UnmodifiableFuture<U> completedFuture(@Nullable U value) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ0MTA1Mw=="}, "originalCommit": {"oid": "493e868e28bcaa51861f0a166a03ec6eb28a0ba8"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ1NDkwOA==", "bodyText": "I'm not sure. It's like ImmutableList.of() returns an ImmutableList instead of a List. We might add more public API to it later as well.", "url": "https://github.com/line/armeria/pull/2406#discussion_r368454908", "createdAt": "2020-01-20T09:52:20Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/UnmodifiableFuture.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.util;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.concurrent.CompletableFuture;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.internal.eventloop.EventLoopCheckingCompletableFuture;\n+\n+/**\n+ * A {@link CompletableFuture} which prevents the caller from completing it. An attempt to call any of\n+ * the following methods will trigger an {@link UnsupportedOperationException}:\n+ * <ul>\n+ *   <li>{@link #complete(Object)}</li>\n+ *   <li>{@link #completeExceptionally(Throwable)}</li>\n+ *   <li>{@link #obtrudeValue(Object)}</li>\n+ *   <li>{@link #obtrudeException(Throwable)}</li>\n+ * </ul>\n+ * Also, {@link #cancel(boolean)} will do nothing but returning whether cancelled or not.\n+ */\n+public final class UnmodifiableFuture<T> extends EventLoopCheckingCompletableFuture<T> {\n+\n+    private static final UnmodifiableFuture<?> NIL;\n+\n+    static {\n+        NIL = new UnmodifiableFuture<>();\n+        NIL.doComplete(null);\n+    }\n+\n+    /**\n+     * Returns an {@link UnmodifiableFuture} which has been completed with the specified {@code value}.\n+     */\n+    public static <U> UnmodifiableFuture<U> completedFuture(@Nullable U value) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQ0MTA1Mw=="}, "originalCommit": {"oid": "493e868e28bcaa51861f0a166a03ec6eb28a0ba8"}, "originalPosition": 49}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2909, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}