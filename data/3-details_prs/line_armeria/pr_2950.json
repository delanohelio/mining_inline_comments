{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MjcwOTc5", "number": 2950, "title": "Fix a bug where gRPC message deframer is closed before writing respon\u2026", "bodyText": "\u2026ses.\nMotivation:\nThis is a workaround that some gRPC implementations do not handle onHalfClose properly.\nFor example, sporadically the listener of gRPC-Kotlin calls ArmeriaServerCall.close() due to some race condition of a Coroutine channel of the request stream.\n\tat com.linecorp.armeria.server.grpc.ArmeriaServerCall.close(ArmeriaServerCall.java:286)\n\tat io.grpc.kotlin.ServerCalls$serverCallListener$1.invoke(ServerCalls.kt:257)\n\tat io.grpc.kotlin.ServerCalls$serverCallListener$1.invoke(ServerCalls.kt:46)\n\tat kotlinx.coroutines.InvokeOnCompletion.invoke(JobSupport.kt:1386)\n\tat kotlinx.coroutines.JobSupport.notifyCompletion(JobSupport.kt:1529)\n\tat kotlinx.coroutines.JobSupport.completeStateFinalization(JobSupport.kt:323)\n\tat kotlinx.coroutines.JobSupport.finalizeFinishingState(JobSupport.kt:240)\n\tat kotlinx.coroutines.JobSupport.tryMakeCompletingSlowPath(JobSupport.kt:903)\n\tat kotlinx.coroutines.JobSupport.tryMakeCompleting(JobSupport.kt:860)\n\tat kotlinx.coroutines.JobSupport.makeCompletingOnce$kotlinx_coroutines_core(JobSupport.kt:825)\n\tat kotlinx.coroutines.AbstractCoroutine.resumeWith(AbstractCoroutine.kt:111)\n\tat kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:46)\n\tat kotlinx.coroutines.DispatchedTaskKt.resume(DispatchedTask.kt:175)\n\tat kotlinx.coroutines.DispatchedTaskKt.resumeUnconfined(DispatchedTask.kt:137)\n\tat kotlinx.coroutines.DispatchedTaskKt.dispatch(DispatchedTask.kt:108)\n\tat kotlinx.coroutines.CancellableContinuationImpl.dispatchResume(CancellableContinuationImpl.kt:308)\n\tat kotlinx.coroutines.CancellableContinuationImpl.completeResume(CancellableContinuationImpl.kt:395)\n\tat kotlinx.coroutines.channels.AbstractChannel$ReceiveHasNext.resumeReceiveClosed(AbstractChannel.kt:913)\n\tat kotlinx.coroutines.channels.AbstractSendChannel.helpClose(AbstractChannel.kt:312)\n\tat kotlinx.coroutines.channels.AbstractSendChannel.close(AbstractChannel.kt:241)\n\tat kotlinx.coroutines.channels.SendChannel$DefaultImpls.close$default(Channel.kt:102)\n\tat io.grpc.kotlin.ServerCalls$serverCallListener$2.onHalfClose(ServerCalls.kt:288)\n\tat com.linecorp.armeria.server.grpc.ArmeriaServerCall.invokeHalfClose(ArmeriaServerCall.java:426)\n\tat com.linecorp.armeria.server.grpc.ArmeriaServerCall.endOfStream(ArmeriaServerCall.java:419)\nhttps://github.com/grpc/grpc-kotlin/blob/master/stub/src/main/java/io/grpc/kotlin/ServerCalls.kt#L249-L258\nThis violates the expected behavior of onHalfClose.\nFurthermore, it blocks Armeria's event loop. See grpc/grpc-kotlin#151.\nBy rescheduling the close event we can avoid the race condition when a close event is called as the result of onHalfClose,\nModifications:\n\nClose a message deframer when it completes when HttpStreamReader.closeDeframer is called.\nClose ArmeriaClientCall when a gRPC client consumes all messages fully.\n\nResult:\n\nA gRPC-Kotlin sever handles blocking tasks with Coroutine properly\nFixes #2947", "createdAt": "2020-07-30T14:58:12Z", "url": "https://github.com/line/armeria/pull/2950", "merged": true, "mergeCommit": {"oid": "b60d02bc3c84e6cd0918ab3effcacdfde11d6387"}, "closed": true, "closedAt": "2020-08-03T15:14:18Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6AweLAH2gAyNDU5MjcwOTc5OmViNGU4OTJjODhmN2I4MzJhOGNlZDM0ZWQyY2UzYjkxYWNlNGVjOTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7QoKnAH2gAyNDU5MjcwOTc5OjAzODU3M2ZkODBmMjA1NWMwZWY2ZjMxNThmZmVhNWEwZDQxYzFhNjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eb4e892c88f7b832a8ced34ed2ce3b91ace4ec94", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/eb4e892c88f7b832a8ced34ed2ce3b91ace4ec94", "committedDate": "2020-07-30T14:46:38Z", "message": "Fix a bug where gRPC message deframer is closed before writing responses.\n\nMotivation:\n\n`HttpStreamReader.apply(Void, Throwable)` is called when a request is complete.\nIt tries to close the message deframer when the deframer is not closed or closing.\nBut this condition is not valid because the response could not be started yet.\n\nMotifications:\n- Let close a message deframer when it completes if closeDeframer is called.\n\nResult:\n\n- A gRPC-Kotlin sever handles blocking tasks with Coroutine properly\n- Fixes #2947"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "804118184be9d656db7622d188f80fd8786e7871", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/804118184be9d656db7622d188f80fd8786e7871", "committedDate": "2020-07-30T15:06:44Z", "message": "Clean up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NDg4MjY0", "url": "https://github.com/line/armeria/pull/2950#pullrequestreview-458488264", "createdAt": "2020-07-30T15:02:01Z", "commit": {"oid": "eb4e892c88f7b832a8ced34ed2ce3b91ace4ec94"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNTowMjowMVrOG5nGoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNTowMjowMVrOG5nGoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA2MjY4OA==", "bodyText": "3000?", "url": "https://github.com/line/armeria/pull/2950#discussion_r463062688", "createdAt": "2020-07-30T15:02:01Z", "author": {"login": "trustin"}, "path": "examples/grpc-kotlin/src/main/kotlin/example/armeria/grpc/kotlin/HelloServiceImpl.kt", "diffHunk": "@@ -47,7 +47,22 @@ class HelloServiceImpl : HelloServiceGrpcKt.HelloServiceCoroutineImplBase(Dispat\n      */\n     override suspend fun blockingHello(request: HelloRequest): HelloReply = withArmeriaBlockingContext {\n         try { // Simulate a blocking API call.\n-            Thread.sleep(3000)\n+            Thread.sleep(10)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb4e892c88f7b832a8ced34ed2ce3b91ace4ec94"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "034a76e98209f6958c34e4cc505f948fd4449994", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/034a76e98209f6958c34e4cc505f948fd4449994", "committedDate": "2020-07-30T15:13:29Z", "message": "Revert test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NTA5NDAy", "url": "https://github.com/line/armeria/pull/2950#pullrequestreview-458509402", "createdAt": "2020-07-30T15:24:05Z", "commit": {"oid": "034a76e98209f6958c34e4cc505f948fd4449994"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNToyNDowNVrOG5oEQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNToyNDowNVrOG5oEQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA3ODQ2NA==", "bodyText": "Could remove the empty line", "url": "https://github.com/line/armeria/pull/2950#discussion_r463078464", "createdAt": "2020-07-30T15:24:05Z", "author": {"login": "trustin"}, "path": "examples/grpc-kotlin/src/test/kotlin/example/armeria/grpc/kotlin/HelloServiceTest.kt", "diffHunk": "@@ -52,6 +53,23 @@ class HelloServiceTest {\n         }\n     }\n \n+    @ParameterizedTest\n+    @MethodSource(\"uris\")\n+    fun parallelReplyFromServerSideBlockingCall(uri: String) {\n+        runBlocking {\n+            val helloService = Clients.newClient(uri, HelloServiceCoroutineStub::class.java)\n+            repeat(30) {\n+                launch {\n+                    val message = helloService.shortBlockingHello(\n+                        HelloRequest.newBuilder().setName(\"$it Armeria\").build()\n+                    ).message\n+                    assertThat(message).isEqualTo(\"Hello, $it Armeria!\")\n+                }\n+            }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "034a76e98209f6958c34e4cc505f948fd4449994"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfaa5714be7f047412b75c255843d3c1bc878856", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/bfaa5714be7f047412b75c255843d3c1bc878856", "committedDate": "2020-07-30T15:53:37Z", "message": "Remove blank line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b3af6ff68fa974c83b5d57c57e292fdeecc6828", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/0b3af6ff68fa974c83b5d57c57e292fdeecc6828", "committedDate": "2020-07-31T05:18:05Z", "message": "Update comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4f0f82c26b68a761869fc80eb35bb289b954557", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/f4f0f82c26b68a761869fc80eb35bb289b954557", "committedDate": "2020-08-03T03:33:57Z", "message": "Merge branch 'master' into lazy-close-deframer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cda1795086dfba1005447948e817e342fa3571f4", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/cda1795086dfba1005447948e817e342fa3571f4", "committedDate": "2020-08-03T03:51:25Z", "message": "Add 'inHalfClose' flag for scheduling a close event"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "134612dee59f914f39d69738c0d645e9553e20d2", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/134612dee59f914f39d69738c0d645e9553e20d2", "committedDate": "2020-08-03T03:53:51Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "838703b0987e525b1bc8805d2e0021eb1fdc6037", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/838703b0987e525b1bc8805d2e0021eb1fdc6037", "committedDate": "2020-08-03T08:31:12Z", "message": "Close ArmeriaClientCall when a gRPC client consumes all messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f65fefa9d127f6b916299c7a708aa866b3af429", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/9f65fefa9d127f6b916299c7a708aa866b3af429", "committedDate": "2020-08-03T08:36:08Z", "message": "Clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36bbd9af2aa546f6bb2d03a8d13eaf8b87aa1b57", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/36bbd9af2aa546f6bb2d03a8d13eaf8b87aa1b57", "committedDate": "2020-08-03T08:42:11Z", "message": "Update test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cab4c5582708ea73347dbb9262ea61c1d7370b3", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/1cab4c5582708ea73347dbb9262ea61c1d7370b3", "committedDate": "2020-08-03T08:48:30Z", "message": "Add more test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dc2cb2389c4dc3581ad2b2d7cbbc6d34434391f", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/2dc2cb2389c4dc3581ad2b2d7cbbc6d34434391f", "committedDate": "2020-08-03T09:02:47Z", "message": "Address comments by @minwoox"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODgwNjM0", "url": "https://github.com/line/armeria/pull/2950#pullrequestreview-459880634", "createdAt": "2020-08-03T09:27:14Z", "commit": {"oid": "2dc2cb2389c4dc3581ad2b2d7cbbc6d34434391f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOToyNzoxNVrOG6yh-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwOToyNzoxNVrOG6yh-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI5ODQ5MQ==", "bodyText": "Shouldn't we do this after cleanup the resources? which means at the end of this method?", "url": "https://github.com/line/armeria/pull/2950#discussion_r464298491", "createdAt": "2020-08-03T09:27:15Z", "author": {"login": "minwoox"}, "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/ArmeriaMessageDeframer.java", "diffHunk": "@@ -317,6 +328,12 @@ public void closeWhenComplete() {\n      */\n     @Override\n     public void close() {\n+        if (whenClosed == null) {\n+            whenClosed = CLOSED_FUTURE;\n+        } else {\n+            whenClosed.doComplete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dc2cb2389c4dc3581ad2b2d7cbbc6d34434391f"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODgxNzEy", "url": "https://github.com/line/armeria/pull/2950#pullrequestreview-459881712", "createdAt": "2020-08-03T09:28:55Z", "commit": {"oid": "2dc2cb2389c4dc3581ad2b2d7cbbc6d34434391f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODg0NzQ3", "url": "https://github.com/line/armeria/pull/2950#pullrequestreview-459884747", "createdAt": "2020-08-03T09:33:23Z", "commit": {"oid": "2dc2cb2389c4dc3581ad2b2d7cbbc6d34434391f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "038573fd80f2055c0ef6f3158ffea5a0d41c1a64", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/038573fd80f2055c0ef6f3158ffea5a0d41c1a64", "committedDate": "2020-08-03T11:49:58Z", "message": "Address comments by @minwoox"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4975, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}