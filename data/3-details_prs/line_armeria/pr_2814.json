{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2MzEzNzIx", "number": 2814, "title": "Update gRPC-Java to 1.30.0", "bodyText": "Motivation:\ngRPC-Java 1.30.0 has been released\nWe need a workaround for ProtoReflectionService. Because it does not implement InternalNotifyOnServerBuild anymore.\nSee grpc/grpc-java#6967 #2806\nIt is a temporary workaround until upstream handles grpc/grpc-java#7138.\nModifications:\n\nUpgrade gRPC to 1.30.0 from 1.29.0\nAdd ProtoReflectionServiceInterceptor that injects dummy server to\ngRPC context.\n\nResult:\nYou can run gRPC 1.30.0 with Armeria server.\nFixes #2806", "createdAt": "2020-06-18T08:28:50Z", "url": "https://github.com/line/armeria/pull/2814", "merged": true, "mergeCommit": {"oid": "9913a3aecbd20750bad08bdd2a5e33145f0efd52"}, "closed": true, "closedAt": "2020-06-19T02:47:55Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsaKYKgH2gAyNDM2MzEzNzIxOjA1YmUxNDNhY2I2ZmExNTllOWU1YTkxMWM0Nzc2YjYzYTMxNTgwYmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsokNPAFqTQzMzc0MjU5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "05be143acb6fa159e9e5a911c4776b63a31580bd", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/05be143acb6fa159e9e5a911c4776b63a31580bd", "committedDate": "2020-06-18T08:27:37Z", "message": "Update gRPC-Java to 1.30.0\n\nMotivation:\n\ngRPC-Java [1.30.0](https://github.com/grpc/grpc-java/releases/tag/v1.30.0) has been released\nWe need a workaround for `ProtoReflectionService`. Because it does not implement `InternalNotifyOnServerBuild` anymore.\nSee https://github.com/grpc/grpc-java/pull/6967 #2806\nIt is a temporary workaround until upstream handles https://github.com/grpc/grpc-java/issues/7138.\n\nMotivations:\n\n- Upgrade gRPC to 1.30.0 from 1.29.0\n- Add ProtoReflectionServiceInterceptor that injects dummy server to\n  gRPC context.\n\nResult:\n\nYou can run gRPC 1.30.0 with Armeria server.\nFixes #2806"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b642ec4c12526bbd0c868f899bee58bd212b8924", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/b642ec4c12526bbd0c868f899bee58bd212b8924", "committedDate": "2020-06-18T08:38:29Z", "message": "Add test dependencies for gRPC integration test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDY1ODMz", "url": "https://github.com/line/armeria/pull/2814#pullrequestreview-433065833", "createdAt": "2020-06-18T08:41:28Z", "commit": {"oid": "b642ec4c12526bbd0c868f899bee58bd212b8924"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODo0MToyOFrOGllgfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODo0MToyOFrOGllgfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NTAyMg==", "bodyText": "How about creating eagerly?", "url": "https://github.com/line/armeria/pull/2814#discussion_r442065022", "createdAt": "2020-06-18T08:41:28Z", "author": {"login": "trustin"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ProtoReflectionServiceInterceptor.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.grpc;\n+\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Function;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+import io.grpc.Context;\n+import io.grpc.Contexts;\n+import io.grpc.InternalServer;\n+import io.grpc.Metadata;\n+import io.grpc.Server;\n+import io.grpc.ServerCall;\n+import io.grpc.ServerCall.Listener;\n+import io.grpc.ServerCallHandler;\n+import io.grpc.ServerInterceptor;\n+import io.grpc.ServerServiceDefinition;\n+\n+final class ProtoReflectionServiceInterceptor implements ServerInterceptor {\n+\n+    static final ProtoReflectionServiceInterceptor INSTANCE = new ProtoReflectionServiceInterceptor();\n+\n+    @Nullable\n+    private static Server dummyServer;\n+\n+    private ProtoReflectionServiceInterceptor() {}\n+\n+    @Override\n+    public <I, O> Listener<I> interceptCall(ServerCall<I, O> call, Metadata headers,\n+                                            ServerCallHandler<I, O> next) {\n+        if (dummyServer == null) {\n+            synchronized (INSTANCE) {\n+                dummyServer = newDummyServer();\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b642ec4c12526bbd0c868f899bee58bd212b8924"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDY1OTg2", "url": "https://github.com/line/armeria/pull/2814#pullrequestreview-433065986", "createdAt": "2020-06-18T08:41:39Z", "commit": {"oid": "b642ec4c12526bbd0c868f899bee58bd212b8924"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODo0MTozOVrOGllg_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODo0MTozOVrOGllg_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NTE0OA==", "bodyText": "Instead of adding here, can't we add in the same place we called notifyOnBuild before so we can use the static server config instead of request context?", "url": "https://github.com/line/armeria/pull/2814#discussion_r442065148", "createdAt": "2020-06-18T08:41:39Z", "author": {"login": "anuraaga"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -107,11 +107,13 @@ public GrpcServiceBuilder addService(ServerServiceDefinition service) {\n      */\n     public GrpcServiceBuilder addService(BindableService bindableService) {\n         if (bindableService instanceof ProtoReflectionService) {\n-            checkState(protoReflectionService == null,\n+            checkState(!isProtoReflectionServiceSet,\n                        \"Attempting to add a ProtoReflectionService but one is already present. \" +\n                        \"ProtoReflectionService must only be added once.\");\n-            protoReflectionService = (ProtoReflectionService) bindableService;\n-        }\n+            isProtoReflectionServiceSet = true;\n+            return addService(ServerInterceptors.intercept(bindableService,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b642ec4c12526bbd0c868f899bee58bd212b8924"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDY2OTUy", "url": "https://github.com/line/armeria/pull/2814#pullrequestreview-433066952", "createdAt": "2020-06-18T08:42:53Z", "commit": {"oid": "b642ec4c12526bbd0c868f899bee58bd212b8924"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDY4NjEw", "url": "https://github.com/line/armeria/pull/2814#pullrequestreview-433068610", "createdAt": "2020-06-18T08:44:51Z", "commit": {"oid": "b642ec4c12526bbd0c868f899bee58bd212b8924"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODo0NDo1MVrOGllpCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQwODo0NDo1MVrOGllpCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NzIwOA==", "bodyText": "Ah - is this supposed to be static? If so this interceptor can be static too, and yeah back to the idea we can call ProtoReflectionServiceInterceptor.addServerConfig() where we used to call notifyOnBuild", "url": "https://github.com/line/armeria/pull/2814#discussion_r442067208", "createdAt": "2020-06-18T08:44:51Z", "author": {"login": "anuraaga"}, "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ProtoReflectionServiceInterceptor.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.grpc;\n+\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Function;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+import io.grpc.Context;\n+import io.grpc.Contexts;\n+import io.grpc.InternalServer;\n+import io.grpc.Metadata;\n+import io.grpc.Server;\n+import io.grpc.ServerCall;\n+import io.grpc.ServerCall.Listener;\n+import io.grpc.ServerCallHandler;\n+import io.grpc.ServerInterceptor;\n+import io.grpc.ServerServiceDefinition;\n+\n+final class ProtoReflectionServiceInterceptor implements ServerInterceptor {\n+\n+    static final ProtoReflectionServiceInterceptor INSTANCE = new ProtoReflectionServiceInterceptor();\n+\n+    @Nullable\n+    private static Server dummyServer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b642ec4c12526bbd0c868f899bee58bd212b8924"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba212c75658486f29e8fded0c2a758cd53107d7c", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/ba212c75658486f29e8fded0c2a758cd53107d7c", "committedDate": "2020-06-18T08:56:06Z", "message": "Address comments by @trustin / Build a dummy server when service is added"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDgzMzYx", "url": "https://github.com/line/armeria/pull/2814#pullrequestreview-433083361", "createdAt": "2020-06-18T09:02:29Z", "commit": {"oid": "ba212c75658486f29e8fded0c2a758cd53107d7c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMTcxODk2", "url": "https://github.com/line/armeria/pull/2814#pullrequestreview-433171896", "createdAt": "2020-06-18T11:01:09Z", "commit": {"oid": "ba212c75658486f29e8fded0c2a758cd53107d7c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMTczMTAz", "url": "https://github.com/line/armeria/pull/2814#pullrequestreview-433173103", "createdAt": "2020-06-18T11:03:10Z", "commit": {"oid": "ba212c75658486f29e8fded0c2a758cd53107d7c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMTc0MzUy", "url": "https://github.com/line/armeria/pull/2814#pullrequestreview-433174352", "createdAt": "2020-06-18T11:05:02Z", "commit": {"oid": "ba212c75658486f29e8fded0c2a758cd53107d7c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29664c758663284b4ee34d279d324e9f58e3cffb", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/29664c758663284b4ee34d279d324e9f58e3cffb", "committedDate": "2020-06-18T12:19:12Z", "message": "Address comments by @trustin / Remove static dummy server"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMjI3MjM3", "url": "https://github.com/line/armeria/pull/2814#pullrequestreview-433227237", "createdAt": "2020-06-18T12:23:20Z", "commit": {"oid": "29664c758663284b4ee34d279d324e9f58e3cffb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b0565d3de1dca0fc0d6385e44b87c85a27c2f22", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/0b0565d3de1dca0fc0d6385e44b87c85a27c2f22", "committedDate": "2020-06-18T13:08:40Z", "message": "Update protobuf to 3.12.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "055af992bc2839e79858bc9050ee47e42aaaa3ab", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/055af992bc2839e79858bc9050ee47e42aaaa3ab", "committedDate": "2020-06-18T14:06:02Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzQyNTkw", "url": "https://github.com/line/armeria/pull/2814#pullrequestreview-433742590", "createdAt": "2020-06-19T01:14:30Z", "commit": {"oid": "055af992bc2839e79858bc9050ee47e42aaaa3ab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 234, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}