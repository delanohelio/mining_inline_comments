{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2Mjk3Nzc0", "number": 2888, "title": "Fix flaky test `ArmeriaReactiveWebServerFactoryTest.shouldRunOnSpecif\u2026", "bodyText": "\u2026iedPort()`\nMotivation:\nhttps://ci.appveyor.com/project/line/armeria/builds/33975010/job/wuef6f33dpaj0i6t#L2789\nArmeriaReactiveWebServerFactoryTest > shouldRunOnSpecifiedPort() FAILED\n    org.springframework.boot.web.server.WebServerException: Failed to start ArmeriaWebServer\n        at com.linecorp.armeria.spring.web.ArmeriaWebServer.start(ArmeriaWebServer.java:106)\n        at com.linecorp.armeria.spring.web.reactive.ArmeriaReactiveWebServerFactoryTest.runServer(ArmeriaReactiveWebServerFactoryTest.java:194)\n        at com.linecorp.armeria.spring.web.reactive.ArmeriaReactiveWebServerFactoryTest.runEchoServer(ArmeriaReactiveWebServerFactoryTest.java:187)\n        at com.linecorp.armeria.spring.web.reactive.ArmeriaReactiveWebServerFactoryTest.shouldRunOnSpecifiedPort(ArmeriaReactiveWebServerFactoryTest.java:86)\n        Caused by:\n        io.netty.channel.unix.Errors$NativeIoException: bind(..) failed: Address already in use\nThere is a race condition on finding an unused port.\nThe port seems to be used by another test because of the parallel test option.\nIt is hard to make a transaction on finding and using an unused port.\nModification:\n\nAdd junit-pioneer as a dependency\nUse @RepeatFailedTest(3) for the flaky test\n\nResult:\nRetry on a failed test", "createdAt": "2020-07-08T14:53:53Z", "url": "https://github.com/line/armeria/pull/2888", "merged": true, "mergeCommit": {"oid": "77e1e0a619fb7c03844a7b90d983eaa6a68d7b00"}, "closed": true, "closedAt": "2020-07-10T14:56:25Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcy7p85gH2gAyNDQ2Mjk3Nzc0OmE3NjI0NmRiMTM3YjhjMjc0NzYwOThiODQ3NmYwYzUxNmUzZTA1OWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczk5argFqTQ0NjQ2OTUzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a76246db137b8c27476098b8476f0c516e3e059e", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/a76246db137b8c27476098b8476f0c516e3e059e", "committedDate": "2020-07-08T14:52:31Z", "message": "Fix flaky test `ArmeriaReactiveWebServerFactoryTest.shouldRunOnSpecifiedPort()`\n\nMotivation:\nhttps://ci.appveyor.com/project/line/armeria/builds/33975010/job/wuef6f33dpaj0i6t#L2789\n```java\nArmeriaReactiveWebServerFactoryTest > shouldRunOnSpecifiedPort() FAILED\n    org.springframework.boot.web.server.WebServerException: Failed to start ArmeriaWebServer\n        at com.linecorp.armeria.spring.web.ArmeriaWebServer.start(ArmeriaWebServer.java:106)\n        at com.linecorp.armeria.spring.web.reactive.ArmeriaReactiveWebServerFactoryTest.runServer(ArmeriaReactiveWebServerFactoryTest.java:194)\n        at com.linecorp.armeria.spring.web.reactive.ArmeriaReactiveWebServerFactoryTest.runEchoServer(ArmeriaReactiveWebServerFactoryTest.java:187)\n        at com.linecorp.armeria.spring.web.reactive.ArmeriaReactiveWebServerFactoryTest.shouldRunOnSpecifiedPort(ArmeriaReactiveWebServerFactoryTest.java:86)\n        Caused by:\n        io.netty.channel.unix.Errors$NativeIoException: bind(..) failed: Address already in use\n```\n\nThere is a race condition on finding an unsed port.\nThe port seems to be used by another test because of parallel test option.\nIt is hard to make a transaction on finding and using an unused port.\n\nModification:\n\n- Add junit-pioneer as a dependency\n- Use `@RepeatFailedTest(3)` for flaky failed test\n\nResult:\n\nRetry on failed test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODY5MjQw", "url": "https://github.com/line/armeria/pull/2888#pullrequestreview-444869240", "createdAt": "2020-07-08T15:14:54Z", "commit": {"oid": "a76246db137b8c27476098b8476f0c516e3e059e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNToxNDo1NFrOGus6WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNToxNDo1NFrOGus6WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTYyMzUxMg==", "bodyText": "Maybe just enough to run in a loop? What other features does it have we can leverage in the future?", "url": "https://github.com/line/armeria/pull/2888#discussion_r451623512", "createdAt": "2020-07-08T15:14:54Z", "author": {"login": "trustin"}, "path": "dependencies.yml", "diffHunk": "@@ -462,11 +462,14 @@ org.jetbrains.kotlinx:\n org.jlleitschuh.gradle:\n   ktlint-gradle: { version: '9.2.1' }\n \n+org.jooq:\n+  joor: { version: '0.9.13' }\n+\n org.jsoup:\n   jsoup: { version: '1.13.1' }\n \n-org.jooq:\n-  joor: { version: '0.9.13' }\n+org.junit-pioneer:\n+  junit-pioneer: { version: '0.6.0' }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a76246db137b8c27476098b8476f0c516e3e059e"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da6d85287d6a79e51905273b2d34ab4526177e47", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/da6d85287d6a79e51905273b2d34ab4526177e47", "committedDate": "2020-07-09T06:18:34Z", "message": "Address comment from @trustin / Use for-loop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aedf5d88db866e9a26158f1bf2591a232be0302", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/0aedf5d88db866e9a26158f1bf2591a232be0302", "committedDate": "2020-07-09T06:30:10Z", "message": "Clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f6da6f01031f76bb61d152377a45c55d0df0885", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/1f6da6f01031f76bb61d152377a45c55d0df0885", "committedDate": "2020-07-09T07:27:11Z", "message": "Fix compile error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDk4ODQz", "url": "https://github.com/line/armeria/pull/2888#pullrequestreview-446098843", "createdAt": "2020-07-10T03:26:06Z", "commit": {"oid": "1f6da6f01031f76bb61d152377a45c55d0df0885"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMzoyNjowNlrOGvop1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQwMzoyNjowNlrOGvop1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwMjMyNg==", "bodyText": "Could you leave a comment on why we try this three times?", "url": "https://github.com/line/armeria/pull/2888#discussion_r452602326", "createdAt": "2020-07-10T03:26:06Z", "author": {"login": "minwoox"}, "path": "spring/boot2-webflux-autoconfigure/src/test/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactoryTest.java", "diffHunk": "@@ -80,10 +85,18 @@ private WebClient httpClient(WebServer server) {\n \n     @Test\n     void shouldRunOnSpecifiedPort() {\n-        final ArmeriaReactiveWebServerFactory factory = factory();\n-        final int port = SocketUtils.findAvailableTcpPort();\n-        factory.setPort(port);\n-        runEchoServer(factory, server -> assertThat(server.getPort()).isEqualTo(port));\n+        for (int i = 0; i < 3; i++) {\n+            final ArmeriaReactiveWebServerFactory factory = factory(new DefaultListableBeanFactory());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f6da6f01031f76bb61d152377a45c55d0df0885"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "489d51c1d77c750b4a7891d3b9d4ae8759a862a2", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/489d51c1d77c750b4a7891d3b9d4ae8759a862a2", "committedDate": "2020-07-10T08:28:40Z", "message": "Address comments by @minwoox"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2NDY5NTM2", "url": "https://github.com/line/armeria/pull/2888#pullrequestreview-446469536", "createdAt": "2020-07-10T14:55:31Z", "commit": {"oid": "489d51c1d77c750b4a7891d3b9d4ae8759a862a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4878, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}