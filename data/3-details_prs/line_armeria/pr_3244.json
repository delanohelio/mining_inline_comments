{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1NjY3OTYw", "number": 3244, "title": "Allow using Armeria without epoll or io_uring JARs", "bodyText": "Motivations:\nSome users prefer reducing their distribution size or solving build\nissues by excluding certain transitive dependencies. We could make\nArmeria run even if netty-transport-native-epoll and\nnetty-incubator-transport-native-io_uring are missing in the class\npath.\nModifications:\n\nMoved the logic that refers to epoll/io_uring classes to\nTransportTypeProvider and used dynamic class loading.\nMoved the references to EpollChannelOption.EPOLL_MODE to\nChannelUtil and used dynamic class loading.\nAdded the methods which were previously missing in TransportType:\n\nsocketChannelType()\ndatagramChannelType()\nisAvailable()\nunavailabilityCause()\n\n\nDeprecated the methods that merely delegates to TransportType in\nEventLoopGroups.\nRemoved the workaround for WSL, since the problem has been fixed in\nWSL2.\nnetty-incubator-transport-native-io_uring is now an optional dependency.\nMiscellaneous:\n\nFixed a build issue where public_suffixes.txt file is deleted when\n/tmp directory exists in a different file system.\n\n\n\nResult:\n\nCloses #3243\nYou can now run your Armeria application even if\nnetty-transport-native-epoll and\nnetty-incubator-transport-native-io_uring are not available in the\nclasspath, which is useful when you want to reduce the final\ndistribution size.\nYou can now check whether/why a certain transport type is unavailable\nvia Transport.isAvailable() and unavailabilityCause().\nEventLoopGroups.*ChannelType() methods have been deprecated in favor\nof the methods with same name in TransportType.\nYou can now use the epoll transport on WSL2.", "createdAt": "2020-12-26T07:44:37Z", "url": "https://github.com/line/armeria/pull/3244", "merged": true, "mergeCommit": {"oid": "4edffc8c11bd74665d652a1fd108d6a0307b6733"}, "closed": true, "closedAt": "2021-01-04T04:24:38Z", "author": {"login": "trustin"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdp39FpAH2gAyNTQ1NjY3OTYwOmUxYTM4NmUzYTdkYTJkNGJhZGI4M2EzYmE0YzRiM2ZiZjc2ZDk0NTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdq5aHTAFqTU1OTQ5OTc5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e1a386e3a7da2d4badb83a3ba4c4b3fbf76d9459", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e1a386e3a7da2d4badb83a3ba4c4b3fbf76d9459", "committedDate": "2020-12-26T07:39:38Z", "message": "Allow using Armeria without epoll or io_uring JARs\n\nMotivations:\n\nSome users prefer reducing their distribution size or solving build\nissues by excluding certain transitive dependencies. We could make\nArmeria run even if `netty-transport-native-epoll` and\n`netty-incubator-transport-native-io_uring` are missing in the class\npath.\n\nModifications:\n\n- Moved the logic that refers to epoll/io_uring classes to\n  `TransportTypeProvider` and used dynamic class loading.\n- Moved the references to `EpollChannelOption.EPOLL_MODE` to\n  `ChannelUtil` and used dynamic class loading.\n- Added the methods which were previously missing in `TransportType`:\n  - `socketChannelType()`\n  - `datagramChannelType()`\n  - `isAvailable()`\n  - `unavailabilityCause()`\n- Deprecated the methods that merely delegates to `TransportType` in\n  `EventLoopGroups`.\n- Removed the workaround for WSL, since the problem has been fixed in\n  WSL2.\n\nResult:\n\n- You can now run your Armeria application even if\n  `netty-transport-native-epoll` and\n  `netty-incubator-transport-native-io_uring` are not available in the\n  classpath, which is useful when you want to reduce the final\n  distribution size.\n- You can now check whether/why a certain transport type is unavailable\n  via `Transport.isAvailable()` and `unavailabilityCause()`.\n- `EventLoopGroups.*ChannelType()` methods have been deprecated in favor\n  of the methods with same name in `TransportType`.\n- You can now use the epoll transport on WSL2."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODUxOTQ1", "url": "https://github.com/line/armeria/pull/3244#pullrequestreview-558851945", "createdAt": "2020-12-26T07:49:37Z", "commit": {"oid": "e1a386e3a7da2d4badb83a3ba4c4b3fbf76d9459"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwNzo0OTozN1rOILhoKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwNzo0OTozN1rOILhoKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk1NjIwMw==", "bodyText": "Updated this because the previous assumptions didn't make sense.", "url": "https://github.com/line/armeria/pull/3244#discussion_r548956203", "createdAt": "2020-12-26T07:49:37Z", "author": {"login": "trustin"}, "path": "core/src/test/java/com/linecorp/armeria/common/FlagsTest.java", "diffHunk": "@@ -48,8 +48,8 @@\n     @Test\n     void epollAvailableOnLinux() {\n         assumeThat(osName).startsWith(\"linux\");\n-        assumeThat(System.getenv(\"WSLENV\")).isNull();\n-        assumeThat(System.getProperty(\"com.linecorp.armeria.useEpoll\")).isEqualTo(\"false\");\n+        assumeThat(System.getProperty(\"com.linecorp.armeria.useEpoll\")).isNull();\n+        assumeThat(System.getProperty(\"com.linecorp.armeria.transportType\")).isNull();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1a386e3a7da2d4badb83a3ba4c4b3fbf76d9459"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODUxOTQ5", "url": "https://github.com/line/armeria/pull/3244#pullrequestreview-558851949", "createdAt": "2020-12-26T07:49:42Z", "commit": {"oid": "e1a386e3a7da2d4badb83a3ba4c4b3fbf76d9459"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwNzo0OTo0MlrOILhoLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwNzo0OTo0MlrOILhoLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk1NjIwNA==", "bodyText": "Updated this because the previous assumptions didn't make sense.", "url": "https://github.com/line/armeria/pull/3244#discussion_r548956204", "createdAt": "2020-12-26T07:49:42Z", "author": {"login": "trustin"}, "path": "core/src/test/java/com/linecorp/armeria/common/FlagsTest.java", "diffHunk": "@@ -63,7 +63,7 @@ void epollAvailableOnLinux() {\n     void openSslAvailable() {\n         assumeThat(osName.startsWith(\"linux\") || osName.startsWith(\"windows\") ||\n                    osName.startsWith(\"macosx\") || osName.startsWith(\"osx\")).isTrue();\n-        assumeThat(System.getProperty(\"com.linecorp.armeria.useOpenSsl\")).isEqualTo(\"false\");\n+        assumeThat(System.getProperty(\"com.linecorp.armeria.useOpenSsl\")).isNull();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1a386e3a7da2d4badb83a3ba4c4b3fbf76d9459"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4ODUxOTg4", "url": "https://github.com/line/armeria/pull/3244#pullrequestreview-558851988", "createdAt": "2020-12-26T07:51:06Z", "commit": {"oid": "e1a386e3a7da2d4badb83a3ba4c4b3fbf76d9459"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwNzo1MTowNlrOILhoZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yNlQwNzo1MTowNlrOILhoZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODk1NjI2Mg==", "bodyText": "Changed to opt-in because this feature is highly experimental.", "url": "https://github.com/line/armeria/pull/3244#discussion_r548956262", "createdAt": "2020-12-26T07:51:06Z", "author": {"login": "trustin"}, "path": "core/build.gradle", "diffHunk": "@@ -115,7 +115,7 @@ dependencies {\n     implementation \"io.netty:netty-transport-native-epoll:${managedVersions['io.netty:netty-transport-native-epoll']}:linux-x86_64\"\n     implementation 'io.netty:netty-tcnative-boringssl-static'\n     implementation 'io.netty:netty-handler-proxy'\n-    implementation \"io.netty.incubator:netty-incubator-transport-native-io_uring:${managedVersions['io.netty.incubator:netty-incubator-transport-native-io_uring']}:linux-x86_64\"\n+    optionalImplementation \"io.netty.incubator:netty-incubator-transport-native-io_uring:${managedVersions['io.netty.incubator:netty-incubator-transport-native-io_uring']}:linux-x86_64\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1a386e3a7da2d4badb83a3ba4c4b3fbf76d9459"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4275029243983ae31750da5577887c2924b2eb1f", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/4275029243983ae31750da5577887c2924b2eb1f", "committedDate": "2020-12-26T07:53:09Z", "message": "Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e98523f435d6cd6a6dc9125c93161e1a1e1c33cb", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/e98523f435d6cd6a6dc9125c93161e1a1e1c33cb", "committedDate": "2020-12-26T08:10:05Z", "message": "Fix a build issue when tmp directory is not in the same filesystem"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5MDMzNzY1", "url": "https://github.com/line/armeria/pull/3244#pullrequestreview-559033765", "createdAt": "2020-12-28T07:58:56Z", "commit": {"oid": "e98523f435d6cd6a6dc9125c93161e1a1e1c33cb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwNzo1ODo1N1rOILzogw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yOFQwNzo1ODo1N1rOILzogw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTI1MTIwMw==", "bodyText": "Shouldn't we create TransportTypeProvider with the cause? \ud83e\udd14", "url": "https://github.com/line/armeria/pull/3244#discussion_r549251203", "createdAt": "2020-12-28T07:58:57Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/internal/common/util/TransportTypeProvider.java", "diffHunk": "@@ -0,0 +1,213 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.common.util;\n+\n+import java.lang.invoke.MethodHandle;\n+import java.lang.invoke.MethodHandles;\n+import java.util.concurrent.ThreadFactory;\n+import java.util.function.BiFunction;\n+\n+import javax.annotation.Nullable;\n+\n+import com.linecorp.armeria.common.util.Exceptions;\n+import com.linecorp.armeria.common.util.TransportType;\n+\n+import io.netty.channel.EventLoop;\n+import io.netty.channel.EventLoopGroup;\n+import io.netty.channel.nio.NioEventLoop;\n+import io.netty.channel.nio.NioEventLoopGroup;\n+import io.netty.channel.socket.DatagramChannel;\n+import io.netty.channel.socket.ServerSocketChannel;\n+import io.netty.channel.socket.SocketChannel;\n+import io.netty.channel.socket.nio.NioDatagramChannel;\n+import io.netty.channel.socket.nio.NioServerSocketChannel;\n+import io.netty.channel.socket.nio.NioSocketChannel;\n+\n+/**\n+ * Provides the properties required by {@link TransportType} by loading /dev/epoll and io_uring transport\n+ * classes dynamically, so that Armeria does not have hard dependencies on them.\n+ * See: https://github.com/line/armeria/issues/3243\n+ */\n+public final class TransportTypeProvider {\n+\n+    public static final TransportTypeProvider NIO = new TransportTypeProvider(\n+            \"NIO\", NioServerSocketChannel.class, NioSocketChannel.class, NioDatagramChannel.class,\n+            NioEventLoopGroup.class, NioEventLoop.class, NioEventLoopGroup::new, null);\n+\n+    public static final TransportTypeProvider EPOLL = of(\n+            \"EPOLL\", \"io.netty.channel.epoll.Epoll\",\n+            \"io.netty.channel.epoll.EpollServerSocketChannel\",\n+            \"io.netty.channel.epoll.EpollSocketChannel\",\n+            \"io.netty.channel.epoll.EpollDatagramChannel\",\n+            \"io.netty.channel.epoll.EpollEventLoopGroup\",\n+            \"io.netty.channel.epoll.EpollEventLoop\");\n+\n+    public static final TransportTypeProvider IO_URING = of(\n+            \"IO_URING\", \"io.netty.incubator.channel.uring.IOUring\",\n+            \"io.netty.incubator.channel.uring.IOUringServerSocketChannel\",\n+            \"io.netty.incubator.channel.uring.IOUringSocketChannel\",\n+            \"io.netty.incubator.channel.uring.IOUringDatagramChannel\",\n+            \"io.netty.incubator.channel.uring.IOUringEventLoopGroup\",\n+            \"io.netty.incubator.channel.uring.IOUringEventLoop\");\n+\n+    private static TransportTypeProvider of(\n+            String name, String entryPointTypeName,\n+            String serverSocketChannelTypeName, String socketChannelTypeName, String datagramChannelTypeName,\n+            String eventLoopGroupTypeName, String eventLoopTypeName) {\n+\n+        try {\n+            final Throwable unavailabilityCause = (Throwable)\n+                    findClass(entryPointTypeName)\n+                            .getMethod(\"unavailabilityCause\")\n+                            .invoke(null);\n+            if (unavailabilityCause != null) {\n+                throw unavailabilityCause;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e98523f435d6cd6a6dc9125c93161e1a1e1c33cb"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU5NDk5Nzk4", "url": "https://github.com/line/armeria/pull/3244#pullrequestreview-559499798", "createdAt": "2020-12-29T11:55:10Z", "commit": {"oid": "e98523f435d6cd6a6dc9125c93161e1a1e1c33cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4574, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}