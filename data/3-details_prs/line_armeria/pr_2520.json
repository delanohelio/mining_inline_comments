{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MTUxMjMx", "number": 2520, "title": "Fix a bug where `RequestContextExporter` exports wrong properties", "bodyText": "Motivation:\n\nRequestContextExporter.state() does not consider the case where the\ncurrent context has a root context. As a result, a ClientRequestContext\nmay reuse the state of its root context.\nRequestContextExporter does not take custom attributes into account\nwhen determining if the properties needs to be re-exported. As a\nresult, custom attributes will not be re-exported even if a user\nchanges any of their values.\n\nModifications:\n\nUse ClientRequestContext.ownAttr() to check whether the state object\nexists.\nCompare attribute values as well when determining if properties need\nto be re-exported.\nHandle the case where attribute or header disappears.\nMiscellaneous:\n\nImplemented toString() for:\n\nDefaultAttributeMap\nFakeChannel in AbstractRequestContextBuilder\n\n\nFixed StackOverflowError in RouteDecoratingService.toString()\n\n\n\nResult:\n\nWhen using RequestContextExporter or RequestContextExportingAppender,\nthe properties are exported properly.", "createdAt": "2020-02-21T07:47:23Z", "url": "https://github.com/line/armeria/pull/2520", "merged": true, "mergeCommit": {"oid": "b20dbb4abec2cc9382fd70c547bd6ba8aaae5ac8"}, "closed": true, "closedAt": "2020-02-24T04:24:50Z", "author": {"login": "trustin"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGavTxAH2gAyMzc4MTUxMjMxOmMxY2RiOWU5OTE0N2EyMmE4Y2M5OWFjZDhhNjI4MDFiOTc2NGVjNGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHVWougH2gAyMzc4MTUxMjMxOmE1ODdmMDY0ZTM4NmRkYzJlYTczZDUyODNiMWEzMTZhNzc5OGVlYmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c1cdb9e99147a22a8cc99acd8a62801b9764ec4d", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/c1cdb9e99147a22a8cc99acd8a62801b9764ec4d", "committedDate": "2020-02-21T07:38:50Z", "message": "Fix a bug where `RequestContextExporter` exports wrong properties\n\nMotivation:\n\n- `RequestContextExporter.state()` does not consider the case where the\n  current context has a root context. As a result, a `ClientRequestContext`\n  may reuse the state of its root context.\n- `RequestContextExporter` does not take custom attributes into account\n  when determining if the properties needs to be re-exported. As a\n  result, custom attributes will not be re-exported even if a user\n  changes any of their values.\n\nModifications:\n\n- Use `ClientRequestContext.ownAttr()` to check whether the state object\n  exists.\n- Compare attribute values as well when determining if properties need\n  to be re-exported.\n- Handle the case where attribute or header disappears.\n- Miscellaneous:\n  - Implemented `toString()` for:\n    - `DefaultAttributeMap`\n    - `FakeChannel` in `AbstractRequestContextBuilder`\n  - Fixed `StackOverflowError` in `RouteDecoratingService.toString()`\n\nResult:\n\n- When using `RequestContextExporter` or `RequestContextExportingAppender`,\n  the properties are exported properly.\n- Maybe fixes #197 partially"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f0e8a3d26cb678762f075ac8f97996e0fd82078", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/5f0e8a3d26cb678762f075ac8f97996e0fd82078", "committedDate": "2020-02-21T07:49:04Z", "message": "long -> int"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNDQ4NTcw", "url": "https://github.com/line/armeria/pull/2520#pullrequestreview-362448570", "createdAt": "2020-02-21T07:51:23Z", "commit": {"oid": "5f0e8a3d26cb678762f075ac8f97996e0fd82078"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNzo1MToyM1rOFsuOUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNzo1MjoxMlrOFsuPiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQzODk5NA==", "bodyText": "!needsUpdate &&", "url": "https://github.com/line/armeria/pull/2520#discussion_r382438994", "createdAt": "2020-02-21T07:51:23Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/RequestContextExporter.java", "diffHunk": "@@ -235,15 +240,37 @@ public boolean containsBuiltIn(BuiltInProperty property) {\n         requireNonNull(ctx, \"ctx\");\n \n         final State state = state(ctx);\n-        final RequestLog log = ctx.log().partial();\n-        final int availabilities = log.availabilityStamp();\n-        if (availabilities != state.availabilities) {\n-            state.availabilities = availabilities;\n-            export(state, ctx, log);\n+        final RequestLogAccess log = ctx.log();\n+\n+        boolean needsUpdate;\n+\n+        // Needs to update if availabilityStamp has changed.\n+        final int availabilityStamp = log.availabilityStamp();\n+        if (state.availabilityStamp != availabilityStamp) {\n+            state.availabilityStamp = availabilityStamp;\n+            needsUpdate = true;\n+        } else {\n+            needsUpdate = false;\n+        }\n+\n+        // Needs to update if any attributes have changed.\n+        if (attrs != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f0e8a3d26cb678762f075ac8f97996e0fd82078"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQzOTMwNw==", "bodyText": "if (!equals) {\n  needsUpdate = true;\n  break;\n}", "url": "https://github.com/line/armeria/pull/2520#discussion_r382439307", "createdAt": "2020-02-21T07:52:12Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/RequestContextExporter.java", "diffHunk": "@@ -235,15 +240,37 @@ public boolean containsBuiltIn(BuiltInProperty property) {\n         requireNonNull(ctx, \"ctx\");\n \n         final State state = state(ctx);\n-        final RequestLog log = ctx.log().partial();\n-        final int availabilities = log.availabilityStamp();\n-        if (availabilities != state.availabilities) {\n-            state.availabilities = availabilities;\n-            export(state, ctx, log);\n+        final RequestLogAccess log = ctx.log();\n+\n+        boolean needsUpdate;\n+\n+        // Needs to update if availabilityStamp has changed.\n+        final int availabilityStamp = log.availabilityStamp();\n+        if (state.availabilityStamp != availabilityStamp) {\n+            state.availabilityStamp = availabilityStamp;\n+            needsUpdate = true;\n+        } else {\n+            needsUpdate = false;\n+        }\n+\n+        // Needs to update if any attributes have changed.\n+        if (attrs != null) {\n+            assert state.attrValues != null;\n+            for (int i = 0; i < attrs.length; i++) {\n+                final Object oldValue = state.attrValues[i];\n+                final Object newValue = ctx.attr(attrs[i].key);\n+                state.attrValues[i] = newValue;\n+                needsUpdate |= !Objects.equals(oldValue, newValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f0e8a3d26cb678762f075ac8f97996e0fd82078"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNDUwMDgy", "url": "https://github.com/line/armeria/pull/2520#pullrequestreview-362450082", "createdAt": "2020-02-21T07:55:04Z", "commit": {"oid": "5f0e8a3d26cb678762f075ac8f97996e0fd82078"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNzo1NTowNFrOFsuTKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNzo1NTowNFrOFsuTKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ0MDIzNA==", "bodyText": "I guess easier to read if this is false and remove below else.", "url": "https://github.com/line/armeria/pull/2520#discussion_r382440234", "createdAt": "2020-02-21T07:55:04Z", "author": {"login": "anuraaga"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/RequestContextExporter.java", "diffHunk": "@@ -235,15 +240,37 @@ public boolean containsBuiltIn(BuiltInProperty property) {\n         requireNonNull(ctx, \"ctx\");\n \n         final State state = state(ctx);\n-        final RequestLog log = ctx.log().partial();\n-        final int availabilities = log.availabilityStamp();\n-        if (availabilities != state.availabilities) {\n-            state.availabilities = availabilities;\n-            export(state, ctx, log);\n+        final RequestLogAccess log = ctx.log();\n+\n+        boolean needsUpdate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f0e8a3d26cb678762f075ac8f97996e0fd82078"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "182616cc2a16ce08b1aa4a0232b2e386a8935c4e", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/182616cc2a16ce08b1aa4a0232b2e386a8935c4e", "committedDate": "2020-02-21T08:01:42Z", "message": "Address the comments from @anuraaga"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c9245e7128b6037187c24f96a5e3fc3bf98d5bb", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/7c9245e7128b6037187c24f96a5e3fc3bf98d5bb", "committedDate": "2020-02-21T08:08:54Z", "message": "Reuse the scanned attribute values when exporting / Use concrete type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71b598e927833207da0dd2afa8c5771a0e30c1ef", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/71b598e927833207da0dd2afa8c5771a0e30c1ef", "committedDate": "2020-02-21T08:11:38Z", "message": "Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNDU3OTA2", "url": "https://github.com/line/armeria/pull/2520#pullrequestreview-362457906", "createdAt": "2020-02-21T08:13:45Z", "commit": {"oid": "71b598e927833207da0dd2afa8c5771a0e30c1ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNDc3MTg3", "url": "https://github.com/line/armeria/pull/2520#pullrequestreview-362477187", "createdAt": "2020-02-21T08:52:51Z", "commit": {"oid": "71b598e927833207da0dd2afa8c5771a0e30c1ef"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwODo1Mjo1MVrOFsvnvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwODo1Mjo1MVrOFsvnvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ2MTg4NQ==", "bodyText": "nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    for (int i = 0; i < attrs.length; i++) {\n          \n          \n            \n                    for (int i = 0; i < numAttrs; i++) {", "url": "https://github.com/line/armeria/pull/2520#discussion_r382461885", "createdAt": "2020-02-21T08:52:51Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/RequestContextExporter.java", "diffHunk": "@@ -537,54 +565,60 @@ private void exportRpcResponse(Map<String, String> out, RequestLog log) {\n         }\n     }\n \n-    private void exportAttributes(Map<String, String> out, RequestContext ctx) {\n+    private void exportAttributes(State state) {\n         if (attrs == null) {\n             return;\n         }\n \n-        for (ExportEntry<AttributeKey<?>> e : attrs) {\n-            putOtherProperty(out, e, ctx.attr(e.key));\n+        assert state.attrValues != null;\n+        for (int i = 0; i < attrs.length; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71b598e927833207da0dd2afa8c5771a0e30c1ef"}, "originalPosition": 414}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTU4MzIz", "url": "https://github.com/line/armeria/pull/2520#pullrequestreview-363158323", "createdAt": "2020-02-24T03:35:47Z", "commit": {"oid": "71b598e927833207da0dd2afa8c5771a0e30c1ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b92d2332b7e5b258f4b1fed0f38b5b94b835522", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/0b92d2332b7e5b258f4b1fed0f38b5b94b835522", "committedDate": "2020-02-24T03:39:40Z", "message": "Update core/src/main/java/com/linecorp/armeria/common/logging/RequestContextExporter.java\n\nCo-Authored-By: Ikhun Um <ih.pert@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a587f064e386ddc2ea73d5283b1a316a7798eebb", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/a587f064e386ddc2ea73d5283b1a316a7798eebb", "committedDate": "2020-02-24T03:56:17Z", "message": "Merge branch 'master' into fix_request_context_exporter"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 590, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}