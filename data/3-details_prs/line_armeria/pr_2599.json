{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5OTY4Mjc2", "number": 2599, "title": "Provide a way to access a parent log from a child log", "bodyText": "Motivation:\nRequestId is used for tracking the request and the response pair.\nA request can be executed multiple times by RetryingClient.\nIt is difficult to group and trace all retried requests without the request ID of the original request.\nBy accessing the parent log from the current request context, we are able to log the parent and current request ID pair.\nModifications:\n\nAdd parent() to RequestLogAccess\nInclude the request ID of parent log to toString() in DefaultClientRequestContext\n\nResults:\n\nYou can now access a parent log from a child log.\nDefaultClientRequest.toString() contains a parent request ID if available.\nFixes #2588", "createdAt": "2020-03-17T17:15:05Z", "url": "https://github.com/line/armeria/pull/2599", "merged": true, "mergeCommit": {"oid": "e0445cf9ebb3213123af469ae19421d36062fc55"}, "closed": true, "closedAt": "2020-03-19T04:53:59Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOl8BQAH2gAyMzg5OTY4Mjc2OjllZDVhMGQ2NjFjMmUxODgwYTA4OTA0MmY2ZDU1NDUxNzQxMmMwMWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOwciRAH2gAyMzg5OTY4Mjc2OmU3ZjY1YmQyYTdjNmEyMmYxZWIzNTA5OWJlM2M4Yzc4YzI5ODAzZjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9ed5a0d661c2e1880a089042f6d554517412c01b", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/9ed5a0d661c2e1880a089042f6d554517412c01b", "committedDate": "2020-03-17T17:13:04Z", "message": "Provide a way to access parent log from child log\n\nMotivation:\n\n`RequestId` is used for tracking the request and the response pair.\nA request can be executed multiple times by `RetryingClient`.\nIt is difficult to group and trace all retried requests without the request ID of the original request.\nBy accessing the parent log from the current request context, we are able to log the parent and current request ID pair.\n\nModifications:\n\n- Add `parent()` to `RequestLogAccess`\n- Include the request ID of parent to `toString()`\n\nResults:\n\n- You can now access a parent log from a child log.\n- `DefaultClientRequest.toString()` contains a parent request ID if available.\n- Fixes #2588"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTEwNjc1", "url": "https://github.com/line/armeria/pull/2599#pullrequestreview-376510675", "createdAt": "2020-03-18T01:38:40Z", "commit": {"oid": "9ed5a0d661c2e1880a089042f6d554517412c01b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTozODo0MFrOF3zldQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTozODo0MFrOF3zldQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MTE3Mw==", "bodyText": "Checkstyle?", "url": "https://github.com/line/armeria/pull/2599#discussion_r394061173", "createdAt": "2020-03-18T01:38:40Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientRequestContextWrapper.java", "diffHunk": "@@ -31,6 +31,7 @@\n import com.linecorp.armeria.common.RequestContextWrapper;\n import com.linecorp.armeria.common.RequestId;\n import com.linecorp.armeria.common.RpcRequest;\n+import com.linecorp.armeria.common.logging.RequestLogAccess;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ed5a0d661c2e1880a089042f6d554517412c01b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTExMzg1", "url": "https://github.com/line/armeria/pull/2599#pullrequestreview-376511385", "createdAt": "2020-03-18T01:41:10Z", "commit": {"oid": "9ed5a0d661c2e1880a089042f6d554517412c01b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTo0MToxMFrOF3zn5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMTo0NDoxMVrOF3zqxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MTc5Nw==", "bodyText": "Could you add checkState that makes sure that parent is null?", "url": "https://github.com/line/armeria/pull/2599#discussion_r394061797", "createdAt": "2020-03-18T01:41:10Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/logging/DefaultRequestLog.java", "diffHunk": "@@ -420,6 +428,11 @@ private boolean isDeferredFlagSet(RequestLogProperty property) {\n     public void addChild(RequestLogAccess child) {\n         checkState(!hasLastChild, \"last child is already added\");\n         requireNonNull(child, \"child\");\n+\n+        if (child instanceof DefaultRequestLog) {\n+            ((DefaultRequestLog) child).parent = this;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ed5a0d661c2e1880a089042f6d554517412c01b"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA2MjUzMg==", "bodyText": "This will create a new clientReqIdStr every time. How about adding some state variable to minimize the regeneration of strings? e.g. You could create a small flag that keeps whether 1) channel is available and 2) log.parent is available, so strVal is regenerated when the flag changes.", "url": "https://github.com/line/armeria/pull/2599#discussion_r394062532", "createdAt": "2020-03-18T01:44:11Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -556,18 +556,30 @@ public RequestLogBuilder logBuilder() {\n \n     @Override\n     public String toString() {\n+        final String clientRequestIdStr = toStringClientRequestId();\n         if (strVal != null) {\n-            return strVal;\n+            return clientRequestIdStr + strVal;\n         }\n-        return toStringSlow();\n+        return clientRequestIdStr + toStringSlow();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ed5a0d661c2e1880a089042f6d554517412c01b"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTIxODQ5", "url": "https://github.com/line/armeria/pull/2599#pullrequestreview-376521849", "createdAt": "2020-03-18T02:17:37Z", "commit": {"oid": "9ed5a0d661c2e1880a089042f6d554517412c01b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df0dfe16e6b9bfb954f32b1c17e79a6024fee717", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/df0dfe16e6b9bfb954f32b1c17e79a6024fee717", "committedDate": "2020-03-18T03:05:43Z", "message": "Address comments by @trustin / Add strValAvailabilities"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTQyMDEy", "url": "https://github.com/line/armeria/pull/2599#pullrequestreview-376542012", "createdAt": "2020-03-18T03:29:17Z", "commit": {"oid": "df0dfe16e6b9bfb954f32b1c17e79a6024fee717"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMzoyOToxN1rOF31OAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwMzoyOToxN1rOF31OAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA4NzkzOQ==", "bodyText": "How about simplifying like this:\nfinal Channel ch = channel();\nfinal RequestLogAccess parent = log().parent();\nfinal short newAvailability = (ch != null ? ... : 0) | (parent != null ? ... : 0);\nif (strVal != null && strValAvailabilities == newAvailability) {\n    return strVal;\n}\n\nstrValAvailabilities = newAvailability;\nreturn toStringSlow(ch, parent);\nKeep in mind that toStringSlow() does this:\n        if (ch != null) {\n            this.strVal = strVal;\n        }\n.. and you must change it to make it work properly. Add tests properly so that this kind of mistake doesn't slip in.", "url": "https://github.com/line/armeria/pull/2599#discussion_r394087939", "createdAt": "2020-03-18T03:29:17Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -556,30 +559,37 @@ public RequestLogBuilder logBuilder() {\n \n     @Override\n     public String toString() {\n-        final String clientRequestIdStr = toStringClientRequestId();\n-        if (strVal != null) {\n-            return clientRequestIdStr + strVal;\n+        if (strVal == null) {\n+            strVal = toStringSlow();\n+            if (channel() != null) {\n+                strValAvailabilities |= STR_CHANNEL_AVAILABILITY;\n+            }\n+            if (log().parent() != null) {\n+                strValAvailabilities |= STR_PARENT_LOG_AVAILABILITY;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df0dfe16e6b9bfb954f32b1c17e79a6024fee717"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "495faffb45f1f92c2f287b54bf15c626ca5c1523", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/495faffb45f1f92c2f287b54bf15c626ca5c1523", "committedDate": "2020-03-18T03:53:37Z", "message": "Address comments by @trustin / Clean up implementation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NTY3OTkx", "url": "https://github.com/line/armeria/pull/2599#pullrequestreview-376567991", "createdAt": "2020-03-18T05:10:16Z", "commit": {"oid": "495faffb45f1f92c2f287b54bf15c626ca5c1523"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNToxMDoxNlrOF32inA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwNToxMDoxNlrOF32inA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEwOTU5Ng==", "bodyText": "How about just preqId?", "url": "https://github.com/line/armeria/pull/2599#discussion_r394109596", "createdAt": "2020-03-18T05:10:16Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -578,6 +588,9 @@ private String toStringSlow() {\n         // Build the string representation.\n         final StringBuilder buf = TemporaryThreadLocals.get().stringBuilder();\n         buf.append(\"[creqId=\").append(creqId);\n+        if (parent != null) {\n+            buf.append(\", pcreqId=\").append(pcreqId);\n+        }\n         if (sreqId != null) {\n             buf.append(\", sreqId=\").append(sreqId);\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "495faffb45f1f92c2f287b54bf15c626ca5c1523"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7f65bd2a7c6a22f1eb35099be3c8c78c29803f2", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/e7f65bd2a7c6a22f1eb35099be3c8c78c29803f2", "committedDate": "2020-03-18T05:27:38Z", "message": "Rename to `preqId` and fix checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 702, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}