{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNzQwMzg2", "number": 2456, "title": "Add EncodingServiceBuilder", "bodyText": "Motivation:\nEncodingService has only public constructors to use as decorator so a user has to cast the type explicitly.\nAlso, it's not the way we do for decorating. We use builders and Functions.\nModifications:\n\nAdd EncodingServiceBuilder\n(Breaking)\n\nChange the encodableRequestHeadersPredicate takes RequestHeaders\nRemove HttpEncodingService completely.\n\n\n\nResult:\n\nCleaner API.", "createdAt": "2020-02-06T07:01:43Z", "url": "https://github.com/line/armeria/pull/2456", "merged": true, "mergeCommit": {"oid": "e5641331e3bec282a5f026e5a0decea0c6a82f11"}, "closed": true, "closedAt": "2020-02-07T06:23:23Z", "author": {"login": "minwoox"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBlNYzgH2gAyMzcxNzQwMzg2OjAwMzA4NjA3YWU1YjAzYWNkY2M0NTRjMjM2YzNmOWI2MTI4ODdkNzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB47aVgFqTM1NDk0NDg4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "00308607ae5b03acdcc454c236c3f9b612887d72", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/00308607ae5b03acdcc454c236c3f9b612887d72", "committedDate": "2020-02-06T07:01:07Z", "message": "Add EncodingServiceBuilder\nMotivation:\n\n`EncodingService` has only public constructors to use as decorator so a user has to cast the type explictly.\nAlso it's not the way we do for decorating. We use builders and `Function`s.\n\nModifications:\n- Add `EncodingServiceBuilder`\n- (Breaking)\n  - Change the `encodableRequestHeadersPredicate` takes `RequestHeaders`\n  - Remove `HttpEncodingService` completely.\n\nResult:\n- Cleander API."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjM0MDgw", "url": "https://github.com/line/armeria/pull/2456#pullrequestreview-354234080", "createdAt": "2020-02-06T07:02:48Z", "commit": {"oid": "ced323696a2aedb73025dcc52109d22d94cf3318"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzowMjo0OFrOFmQ8BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzowMjo0OFrOFmQ8BQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY2NzcxNw==", "bodyText": "We really need to dedup this configuration code. \ud83d\ude05", "url": "https://github.com/line/armeria/pull/2456#discussion_r375667717", "createdAt": "2020-02-06T07:02:48Z", "author": {"login": "minwoox"}, "path": "spring/boot-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "diffHunk": "@@ -163,9 +164,12 @@ public static void configureServerWithArmeriaSettings(ServerBuilder server, Arme\n \n         final ArmeriaSettings.Compression compression = settings.getCompression();\n         if (compression != null && compression.isEnabled()) {\n+            final long parsed = parseDataSize(compression.getMinResponseSize());\n+            final int minBytesToForceChunkedAndEncoding = parsed > Integer.MAX_VALUE ? Integer.MAX_VALUE\n+                                                                                     : (int) parsed;\n             server.decorator(contentEncodingDecorator(compression.getMimeTypes(),\n                                                       compression.getExcludedUserAgents(),\n-                                                      parseDataSize(compression.getMinResponseSize())));\n+                                                      minBytesToForceChunkedAndEncoding));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ced323696a2aedb73025dcc52109d22d94cf3318"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ced323696a2aedb73025dcc52109d22d94cf3318", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/ced323696a2aedb73025dcc52109d22d94cf3318", "committedDate": "2020-02-06T06:36:50Z", "message": "Add EncodingServiceBuilder\nMotivation:\n\n`EncodingService` has only public constructors to use as decorator so a user has to cast the type explictly.\nAlso it's not the way we do for decorating. We use builders and `Function`s.\n\nModifications:\n- Add `EncodingServiceBuilder`\n- (Breaking)\n  - Change the `encodableRequestHeadersPredicate` takes `RequestHeaders`\n  - Remove `HttpEncodingService` completely.\n\nResult:\n- Cleander API."}, "afterCommit": {"oid": "00308607ae5b03acdcc454c236c3f9b612887d72", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/00308607ae5b03acdcc454c236c3f9b612887d72", "committedDate": "2020-02-06T07:01:07Z", "message": "Add EncodingServiceBuilder\nMotivation:\n\n`EncodingService` has only public constructors to use as decorator so a user has to cast the type explictly.\nAlso it's not the way we do for decorating. We use builders and `Function`s.\n\nModifications:\n- Add `EncodingServiceBuilder`\n- (Breaking)\n  - Change the `encodableRequestHeadersPredicate` takes `RequestHeaders`\n  - Remove `HttpEncodingService` completely.\n\nResult:\n- Cleander API."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjM1NDc2", "url": "https://github.com/line/armeria/pull/2456#pullrequestreview-354235476", "createdAt": "2020-02-06T07:07:19Z", "commit": {"oid": "00308607ae5b03acdcc454c236c3f9b612887d72"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzowNzoxOVrOFmRAJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNzoyMTowNFrOFmROxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY2ODc3Mw==", "bodyText": "Don't we need ? super here?", "url": "https://github.com/line/armeria/pull/2456#discussion_r375668773", "createdAt": "2020-02-06T07:07:19Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/encoding/EncodingService.java", "diffHunk": "@@ -39,66 +37,37 @@\n  *     <li>the response either has no fixed content length or the length is larger than 1KB</li>\n  * </ul>\n  */\n-public class EncodingService extends SimpleDecoratingHttpService {\n-\n-    private static final Predicate<MediaType> DEFAULT_ENCODABLE_CONTENT_TYPE_PREDICATE =\n-            contentType -> Stream.of(MediaType.ANY_TEXT_TYPE,\n-                                     MediaType.APPLICATION_XML_UTF_8,\n-                                     MediaType.JAVASCRIPT_UTF_8,\n-                                     MediaType.JSON_UTF_8)\n-                                 .anyMatch(contentType::is);\n-\n-    private static final Predicate<HttpHeaders> DEFAULT_ENCODABLE_REQUEST_HEADERS_PREDICATE =\n-            headers -> true;\n-\n-    private static final int DEFAULT_MIN_BYTES_TO_FORCE_CHUNKED_AND_ENCODING = 1024;\n+public final class EncodingService extends SimpleDecoratingHttpService {\n \n     private final Predicate<MediaType> encodableContentTypePredicate;\n-    private final Predicate<HttpHeaders> encodableRequestHeadersPredicate;\n+    private final Predicate<RequestHeaders> encodableRequestHeadersPredicate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00308607ae5b03acdcc454c236c3f9b612887d72"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3MTE5Ng==", "bodyText": "DEFAULT_MIN_BYTES_TO_FORCE_CHUNKED_AND_ENCODING is a private field.", "url": "https://github.com/line/armeria/pull/2456#discussion_r375671196", "createdAt": "2020-02-06T07:16:20Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/encoding/EncodingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.encoding;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Stream;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.server.HttpService;\n+\n+/**\n+ * Builds a new {@link EncodingService} or its decorator function.\n+ */\n+public final class EncodingServiceBuilder {\n+\n+    // TODO(minwoox) consider this condition to align with the default text preveiwer.\n+    private static final Predicate<MediaType> defaultEncodableContentTypePredicate =\n+            contentType -> Stream.of(MediaType.ANY_TEXT_TYPE,\n+                                     MediaType.APPLICATION_XML_UTF_8,\n+                                     MediaType.JAVASCRIPT_UTF_8,\n+                                     MediaType.JSON_UTF_8)\n+                                 .anyMatch(contentType::is);\n+\n+    private static final int DEFAULT_MIN_BYTES_TO_FORCE_CHUNKED_AND_ENCODING = 1024;\n+\n+    private Predicate<MediaType> encodableContentTypePredicate = defaultEncodableContentTypePredicate;\n+\n+    private Predicate<RequestHeaders> encodableRequestHeadersPredicate = headers -> true;\n+\n+    private int minBytesToForceChunkedAndEncoding = DEFAULT_MIN_BYTES_TO_FORCE_CHUNKED_AND_ENCODING;\n+\n+    EncodingServiceBuilder() {}\n+\n+    /**\n+     * Sets the specified {@link MediaType}s to evaluate whether the content type of the {@link HttpResponse}\n+     * is encodable or not. It's encodable when the content type is one of the {@link MediaType}s.\n+     */\n+    public EncodingServiceBuilder encodableContentTypes(MediaType... contentTypes) {\n+        return encodableContentTypes(ImmutableList.copyOf(requireNonNull(contentTypes, \"contentTypes\")));\n+    }\n+\n+    /**\n+     * Sets the specified {@link MediaType}s to evaluate whether the content type of the {@link HttpResponse}\n+     * is encodable or not. It's encodable when the content type is one of the {@link MediaType}s.\n+     */\n+    public EncodingServiceBuilder encodableContentTypes(Iterable<MediaType> contentTypes) {\n+        final List<MediaType> snapshot = ImmutableList.copyOf(requireNonNull(contentTypes, \"contentTypes\"));\n+        return encodableContentTypePredicate(mediaType -> snapshot.stream().anyMatch(mediaType::belongsTo));\n+    }\n+\n+    /**\n+     * Sets the specified {@link Predicate} to evaluate whether the content type of the {@link HttpResponse} is\n+     * encodable or not.\n+     */\n+    public EncodingServiceBuilder encodableContentTypePredicate(\n+            Predicate<MediaType> encodableContentTypePredicate) {\n+        requireNonNull(encodableContentTypePredicate, \"encodableContentTypePredicate\");\n+        this.encodableContentTypePredicate = encodableContentTypePredicate;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified {@link Predicate} to evaluate whether the corresponding {@link HttpResponse} of the\n+     * {@link HttpRequest} whose {@link RequestHeaders} is the input of the {@link Predicate}\n+     * is encodable or not.\n+     */\n+    public EncodingServiceBuilder encodableRequestHeadersPredicate(\n+            Predicate<RequestHeaders> encodableRequestHeadersPredicate) {\n+        requireNonNull(encodableRequestHeadersPredicate, \"encodableRequestHeadersPredicate\");\n+        this.encodableRequestHeadersPredicate = encodableRequestHeadersPredicate;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified minimum length to force chunked encoding. The {@link HttpResponse} is encoded only\n+     * when the content is variable, which means the {@link ResponseHeaders} does not have\n+     * {@code \"Content-Length\"} header, or the length of the content exceeds the specified length.\n+     * The default is {@value DEFAULT_MIN_BYTES_TO_FORCE_CHUNKED_AND_ENCODING}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00308607ae5b03acdcc454c236c3f9b612887d72"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3MjAyOA==", "bodyText": "Ints.saturatedCast(parsed)?", "url": "https://github.com/line/armeria/pull/2456#discussion_r375672028", "createdAt": "2020-02-06T07:19:10Z", "author": {"login": "ikhoon"}, "path": "dropwizard/src/main/java/com/linecorp/armeria/dropwizard/ArmeriaConfigurationUtil.java", "diffHunk": "@@ -429,9 +433,18 @@ private static URL getURL(String resourceLocation) throws FileNotFoundException\n \n     private static void configureCompression(ServerBuilder serverBuilder, Compression compression) {\n         if (compression.isEnabled()) {\n+            final int minBytesToForceChunkedAndEncoding;\n+            final String minResponseSize = compression.getMinResponseSize();\n+            if (minResponseSize == null) {\n+                minBytesToForceChunkedAndEncoding = DEFAULT_MIN_BYTES_TO_FORCE_CHUNKED_AND_ENCODING;\n+            } else {\n+                final long parsed = parseDataSize(minResponseSize);\n+                minBytesToForceChunkedAndEncoding = parsed > Integer.MAX_VALUE ? Integer.MAX_VALUE\n+                                                                               : (int) parsed;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00308607ae5b03acdcc454c236c3f9b612887d72"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3MjQ1OQ==", "bodyText": "Ditto: Ints.saturatedCast(minResponseSize)?", "url": "https://github.com/line/armeria/pull/2456#discussion_r375672459", "createdAt": "2020-02-06T07:20:50Z", "author": {"login": "ikhoon"}, "path": "spring/boot-webflux-autoconfigure/src/main/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactory.java", "diffHunk": "@@ -187,9 +187,11 @@ public WebServer getWebServer(HttpHandler httpHandler) {\n \n         final Compression compression = getCompression();\n         if (compression != null && compression.getEnabled()) {\n+            final long minResponseSize = compression.getMinResponseSize().toBytes();\n             sb.decorator(contentEncodingDecorator(compression.getMimeTypes(),\n                                                   compression.getExcludedUserAgents(),\n-                                                  compression.getMinResponseSize().toBytes()));\n+                                                  minResponseSize > Integer.MAX_VALUE ? Integer.MAX_VALUE\n+                                                                                      : (int) minResponseSize));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00308607ae5b03acdcc454c236c3f9b612887d72"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3MjUxNg==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/2456#discussion_r375672516", "createdAt": "2020-02-06T07:21:04Z", "author": {"login": "ikhoon"}, "path": "spring/boot-webflux-autoconfigure/src/main/java/com/linecorp/armeria/spring/web/reactive/ArmeriaReactiveWebServerFactory.java", "diffHunk": "@@ -261,9 +263,12 @@ private void configureArmeriaService(ServerBuilder sb, ArmeriaSettings settings)\n \n         final ArmeriaSettings.Compression compression = settings.getCompression();\n         if (compression != null && compression.isEnabled()) {\n+            final long parsed = parseDataSize(compression.getMinResponseSize());\n+            final int minBytesToForceChunkedAndEncoding = parsed > Integer.MAX_VALUE ? Integer.MAX_VALUE\n+                                                                                     : (int) parsed;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00308607ae5b03acdcc454c236c3f9b612887d72"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MjU4MDE2", "url": "https://github.com/line/armeria/pull/2456#pullrequestreview-354258016", "createdAt": "2020-02-06T08:06:01Z", "commit": {"oid": "00308607ae5b03acdcc454c236c3f9b612887d72"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwODowNjowMVrOFmSG-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwODoyMToxOFrOFmSdAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY4NjkwNw==", "bodyText": "Could create a MediaTypeSet and reuse it, instead of creating a new stream list again and again.", "url": "https://github.com/line/armeria/pull/2456#discussion_r375686907", "createdAt": "2020-02-06T08:06:01Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/encoding/EncodingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.encoding;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Stream;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.server.HttpService;\n+\n+/**\n+ * Builds a new {@link EncodingService} or its decorator function.\n+ */\n+public final class EncodingServiceBuilder {\n+\n+    // TODO(minwoox) consider this condition to align with the default text preveiwer.\n+    private static final Predicate<MediaType> defaultEncodableContentTypePredicate =\n+            contentType -> Stream.of(MediaType.ANY_TEXT_TYPE,\n+                                     MediaType.APPLICATION_XML_UTF_8,\n+                                     MediaType.JAVASCRIPT_UTF_8,\n+                                     MediaType.JSON_UTF_8)\n+                                 .anyMatch(contentType::is);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00308607ae5b03acdcc454c236c3f9b612887d72"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY5MjU0Ng==", "bodyText": "It's OK to be a private field. @value will inline the value.", "url": "https://github.com/line/armeria/pull/2456#discussion_r375692546", "createdAt": "2020-02-06T08:21:18Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/encoding/EncodingServiceBuilder.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.encoding;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+import java.util.stream.Stream;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.common.HttpRequest;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.MediaType;\n+import com.linecorp.armeria.common.RequestHeaders;\n+import com.linecorp.armeria.common.ResponseHeaders;\n+import com.linecorp.armeria.server.HttpService;\n+\n+/**\n+ * Builds a new {@link EncodingService} or its decorator function.\n+ */\n+public final class EncodingServiceBuilder {\n+\n+    // TODO(minwoox) consider this condition to align with the default text preveiwer.\n+    private static final Predicate<MediaType> defaultEncodableContentTypePredicate =\n+            contentType -> Stream.of(MediaType.ANY_TEXT_TYPE,\n+                                     MediaType.APPLICATION_XML_UTF_8,\n+                                     MediaType.JAVASCRIPT_UTF_8,\n+                                     MediaType.JSON_UTF_8)\n+                                 .anyMatch(contentType::is);\n+\n+    private static final int DEFAULT_MIN_BYTES_TO_FORCE_CHUNKED_AND_ENCODING = 1024;\n+\n+    private Predicate<MediaType> encodableContentTypePredicate = defaultEncodableContentTypePredicate;\n+\n+    private Predicate<RequestHeaders> encodableRequestHeadersPredicate = headers -> true;\n+\n+    private int minBytesToForceChunkedAndEncoding = DEFAULT_MIN_BYTES_TO_FORCE_CHUNKED_AND_ENCODING;\n+\n+    EncodingServiceBuilder() {}\n+\n+    /**\n+     * Sets the specified {@link MediaType}s to evaluate whether the content type of the {@link HttpResponse}\n+     * is encodable or not. It's encodable when the content type is one of the {@link MediaType}s.\n+     */\n+    public EncodingServiceBuilder encodableContentTypes(MediaType... contentTypes) {\n+        return encodableContentTypes(ImmutableList.copyOf(requireNonNull(contentTypes, \"contentTypes\")));\n+    }\n+\n+    /**\n+     * Sets the specified {@link MediaType}s to evaluate whether the content type of the {@link HttpResponse}\n+     * is encodable or not. It's encodable when the content type is one of the {@link MediaType}s.\n+     */\n+    public EncodingServiceBuilder encodableContentTypes(Iterable<MediaType> contentTypes) {\n+        final List<MediaType> snapshot = ImmutableList.copyOf(requireNonNull(contentTypes, \"contentTypes\"));\n+        return encodableContentTypePredicate(mediaType -> snapshot.stream().anyMatch(mediaType::belongsTo));\n+    }\n+\n+    /**\n+     * Sets the specified {@link Predicate} to evaluate whether the content type of the {@link HttpResponse} is\n+     * encodable or not.\n+     */\n+    public EncodingServiceBuilder encodableContentTypePredicate(\n+            Predicate<MediaType> encodableContentTypePredicate) {\n+        requireNonNull(encodableContentTypePredicate, \"encodableContentTypePredicate\");\n+        this.encodableContentTypePredicate = encodableContentTypePredicate;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified {@link Predicate} to evaluate whether the corresponding {@link HttpResponse} of the\n+     * {@link HttpRequest} whose {@link RequestHeaders} is the input of the {@link Predicate}\n+     * is encodable or not.\n+     */\n+    public EncodingServiceBuilder encodableRequestHeadersPredicate(\n+            Predicate<RequestHeaders> encodableRequestHeadersPredicate) {\n+        requireNonNull(encodableRequestHeadersPredicate, \"encodableRequestHeadersPredicate\");\n+        this.encodableRequestHeadersPredicate = encodableRequestHeadersPredicate;\n+        return this;\n+    }\n+\n+    /**\n+     * Sets the specified minimum length to force chunked encoding. The {@link HttpResponse} is encoded only\n+     * when the content is variable, which means the {@link ResponseHeaders} does not have\n+     * {@code \"Content-Length\"} header, or the length of the content exceeds the specified length.\n+     * The default is {@value DEFAULT_MIN_BYTES_TO_FORCE_CHUNKED_AND_ENCODING}.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY3MTE5Ng=="}, "originalCommit": {"oid": "00308607ae5b03acdcc454c236c3f9b612887d72"}, "originalPosition": 103}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c2fda57efa86e522e0bdc547ef2ee96f2f055fc", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/9c2fda57efa86e522e0bdc547ef2ee96f2f055fc", "committedDate": "2020-02-06T08:34:59Z", "message": "Address the comment from @ikhoon and @trustin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d49c88b94162b58582529fc2cd62a9dda2d8c67f", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/d49c88b94162b58582529fc2cd62a9dda2d8c67f", "committedDate": "2020-02-06T09:27:10Z", "message": "Use Set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38835df2168c677f112cdb805a0dc6cb1af2cdcc", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/38835df2168c677f112cdb805a0dc6cb1af2cdcc", "committedDate": "2020-02-07T03:41:02Z", "message": "Merge branch 'master' into add_encodingServiceBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17626127fdaf467d349670c035bee85c959ae3b4", "author": {"user": {"login": "minwoox", "name": "minux"}}, "url": "https://github.com/line/armeria/commit/17626127fdaf467d349670c035bee85c959ae3b4", "committedDate": "2020-02-07T03:48:07Z", "message": "Deprecate decorate method using reflection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0OTM3MjY0", "url": "https://github.com/line/armeria/pull/2456#pullrequestreview-354937264", "createdAt": "2020-02-07T05:27:31Z", "commit": {"oid": "17626127fdaf467d349670c035bee85c959ae3b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0OTQ0ODg5", "url": "https://github.com/line/armeria/pull/2456#pullrequestreview-354944889", "createdAt": "2020-02-07T05:59:35Z", "commit": {"oid": "17626127fdaf467d349670c035bee85c959ae3b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 966, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}