{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxOTAzODU5", "number": 2740, "title": "Provide a way to trigger a timeout without scheduler", "bodyText": "Motivation:\nSometimes a user might want to trigger timeout immediately without a specific timeout scheduler.\nThis is also useful for testing the behavior of Service or Client when a request is timed-out.\nModifications:\n\nAdd timeoutNow() to RequestContext.\nPull up isTimedOut() to RequestContext from ServiceRequestContext.\nAdd isTimedOut(boolean) to AbstractRequestContextBuilder\nDeprecation\n\nRequestContext.newDerivedContext(), ServiceRequestContext.newDerivedContext().\nAbstractCompositeService, SimpleCompositeService and SimpleCompositeRpcService.\nServiceRequestContext.newDerivedContext() seems to be used AbstractCompositeService and its subclasses only.\n\n\n\nResult:\nFixes: #2547\nYou can make a request timed-out manually by invoking RequestContext.timeoutNow().\nYou can build and test a RequestContext timed-out.", "createdAt": "2020-05-22T12:56:05Z", "url": "https://github.com/line/armeria/pull/2740", "merged": true, "mergeCommit": {"oid": "17b821a34a860a09b5cd072caf91b9039a3f9b22"}, "closed": true, "closedAt": "2020-06-04T06:17:16Z", "author": {"login": "ikhoon"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjxxNoAH2gAyNDIxOTAzODU5OmE3MzE4ZTQ1OGU1MzA2YmFiZDJlNWUyNTliZGYyN2Q3NDA2MTdjMWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn0SXRgH2gAyNDIxOTAzODU5OmQ1YmIyNTY0MGQ5NGVlZmRhMGRmNGY4MTEyZjc2NjBiMWE5NGU5ODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a7318e458e5306babd2e5e259bdf27d740617c1b", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/a7318e458e5306babd2e5e259bdf27d740617c1b", "committedDate": "2020-05-22T12:52:32Z", "message": "Provide a way to trigger a timeout without scheduler\n\nMotivation:\n\nSometimes a user might want to trigger timeout immediately without a specific timeout scheduler.\nThis is also useful for testing the behavior of `Service` or `Client` when a request is timed-out.\n\nModifications:\n\n- Add `timeoutNow()` to `RequestContext`.\n- Pull up `isTimedOut()` to `RequestContext` from `ServiceRequestContext`.\n- Add `isTimedOut(boolean)` to `AbstractRequestContextBuilder`\n\nResult:\nFixes: #2547\nYou can make a request timed-out manually by invoking `timeoutNow()`.\nYou can build and test a RequestContext timed-out."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afa9bfa4c98f5fe1a669979eb437fc8ef10e8149", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/afa9bfa4c98f5fe1a669979eb437fc8ef10e8149", "committedDate": "2020-05-23T07:26:26Z", "message": "Fix broken test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMzUxNDkw", "url": "https://github.com/line/armeria/pull/2740#pullrequestreview-422351490", "createdAt": "2020-06-02T05:27:13Z", "commit": {"oid": "afa9bfa4c98f5fe1a669979eb437fc8ef10e8149"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwNToyNzoxM1rOGdiifA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQwNToyOTowOVrOGdik7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYyNzc3Mg==", "bodyText": "Can we use ImmediateEventExecutor, so that we do not instantiate event loop threads in CommonPools unnecessarily during the class initialization?", "url": "https://github.com/line/armeria/pull/2740#discussion_r433627772", "createdAt": "2020-06-02T05:27:13Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/ServiceRequestContextBuilder.java", "diffHunk": "@@ -62,6 +65,26 @@ public void serverStarting(Server server) throws Exception {\n         }\n     };\n \n+    private static final TimeoutTask noopTimeoutTask = new TimeoutTask() {\n+        @Override\n+        public boolean canSchedule() {\n+            return true;\n+        }\n+\n+        @Override\n+        public void run() { /* no-op */ }\n+    };\n+\n+    /**\n+     * A timeout controller that has been timed-out.\n+     */\n+    private static final DefaultTimeoutController noopTimedOutController =\n+            new DefaultTimeoutController(noopTimeoutTask, CommonPools.workerGroup().next());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afa9bfa4c98f5fe1a669979eb437fc8ef10e8149"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzYyODM5OA==", "bodyText": "Should we rename this to timedOut(boolean)?", "url": "https://github.com/line/armeria/pull/2740#discussion_r433628398", "createdAt": "2020-06-02T05:29:09Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientRequestContextBuilder.java", "diffHunk": "@@ -170,4 +213,9 @@ public ClientRequestContextBuilder requestStartTime(long requestStartTimeNanos,\n         return (ClientRequestContextBuilder) super.requestStartTime(requestStartTimeNanos,\n                                                                     requestStartTimeMicros);\n     }\n+\n+    @Override\n+    public ClientRequestContextBuilder isTimedOut(boolean timeout) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afa9bfa4c98f5fe1a669979eb437fc8ef10e8149"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5535c2d22c9851e3cbe36e6354338f4a6edefd5", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/e5535c2d22c9851e3cbe36e6354338f4a6edefd5", "committedDate": "2020-06-02T14:01:29Z", "message": "Address comments by @trustin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2679490b4bee9231c51231a42f2488385812b286", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/2679490b4bee9231c51231a42f2488385812b286", "committedDate": "2020-06-03T01:46:23Z", "message": "Merge branch 'master' into manual-timeout"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMjM3NjI0", "url": "https://github.com/line/armeria/pull/2740#pullrequestreview-423237624", "createdAt": "2020-06-03T05:55:49Z", "commit": {"oid": "2679490b4bee9231c51231a42f2488385812b286"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMjU5MDU5", "url": "https://github.com/line/armeria/pull/2740#pullrequestreview-423259059", "createdAt": "2020-06-03T06:43:10Z", "commit": {"oid": "2679490b4bee9231c51231a42f2488385812b286"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwNjo0MzoxMVrOGeOFIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwNjo0MzoxMVrOGeOFIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM0MTE1NQ==", "bodyText": "What's the difference between enableTimeout and timedOut?\nCan't we combine them?", "url": "https://github.com/line/armeria/pull/2740#discussion_r434341155", "createdAt": "2020-06-03T06:43:11Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientRequestContextBuilder.java", "diffHunk": "@@ -91,6 +118,12 @@ public ClientRequestContextBuilder connectionTimings(ClientConnectionTimings con\n         return this;\n     }\n \n+    @VisibleForTesting\n+    ClientRequestContextBuilder enableTimeout(boolean enableTimeout) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2679490b4bee9231c51231a42f2488385812b286"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d96e99b28eeea721a680b0bcad05af0c853e78c", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/5d96e99b28eeea721a680b0bcad05af0c853e78c", "committedDate": "2020-06-03T08:45:30Z", "message": "Fix flaky test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMzQzMTc4", "url": "https://github.com/line/armeria/pull/2740#pullrequestreview-423343178", "createdAt": "2020-06-03T08:45:03Z", "commit": {"oid": "2679490b4bee9231c51231a42f2488385812b286"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwODo0NTowNFrOGeSFcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QwODo1Mjo0NFrOGeSXUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQwNjc2OA==", "bodyText": "Is there any reason that uses ImmediateEventExecutor.INSTANCE unlike ClientRequestContextBuilder uses?\nAlso, can we put this into the superclass to share?", "url": "https://github.com/line/armeria/pull/2740#discussion_r434406768", "createdAt": "2020-06-03T08:45:04Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/server/ServiceRequestContextBuilder.java", "diffHunk": "@@ -62,6 +65,26 @@ public void serverStarting(Server server) throws Exception {\n         }\n     };\n \n+    private static final TimeoutTask noopTimeoutTask = new TimeoutTask() {\n+        @Override\n+        public boolean canSchedule() {\n+            return true;\n+        }\n+\n+        @Override\n+        public void run() { /* no-op */ }\n+    };\n+\n+    /**\n+     * A timeout controller that has been timed-out.\n+     */\n+    private static final DefaultTimeoutController noopTimedOutController =\n+            new DefaultTimeoutController(noopTimeoutTask, ImmediateEventExecutor.INSTANCE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2679490b4bee9231c51231a42f2488385812b286"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQxMDIwNg==", "bodyText": "Thanks for the explanation. I felt that enableTimeout(false) meant that the timeout is disabled for this context so we cannot schedule it.\nHow about renaming something like configureDefaultTimeoutController?", "url": "https://github.com/line/armeria/pull/2740#discussion_r434410206", "createdAt": "2020-06-03T08:50:53Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/client/ClientRequestContextBuilder.java", "diffHunk": "@@ -91,6 +118,12 @@ public ClientRequestContextBuilder connectionTimings(ClientConnectionTimings con\n         return this;\n     }\n \n+    @VisibleForTesting\n+    ClientRequestContextBuilder enableTimeout(boolean enableTimeout) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDM0MTE1NQ=="}, "originalCommit": {"oid": "2679490b4bee9231c51231a42f2488385812b286"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDQxMTM0Nw==", "bodyText": "probably better to use timedOut as well?", "url": "https://github.com/line/armeria/pull/2740#discussion_r434411347", "createdAt": "2020-06-03T08:52:44Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/AbstractRequestContextBuilder.java", "diffHunk": "@@ -485,6 +488,24 @@ protected final Channel fakeChannel() {\n         return channel;\n     }\n \n+    /**\n+     * Returns whether a timeout is set.\n+     */\n+    protected final boolean timedOut() {\n+        return timeout;\n+    }\n+\n+    /**\n+     * Sets the specified {@code timeout}. If the specified {@code timeout} is {@code true},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d96e99b28eeea721a680b0bcad05af0c853e78c"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "367d5e97957bdfdd0d4e39609050e89bf26f27c4", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/367d5e97957bdfdd0d4e39609050e89bf26f27c4", "committedDate": "2020-06-03T13:15:07Z", "message": "Address comments by @minwoox"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MDQxMjEy", "url": "https://github.com/line/armeria/pull/2740#pullrequestreview-424041212", "createdAt": "2020-06-04T01:28:59Z", "commit": {"oid": "367d5e97957bdfdd0d4e39609050e89bf26f27c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MDQxNTI0", "url": "https://github.com/line/armeria/pull/2740#pullrequestreview-424041524", "createdAt": "2020-06-04T01:29:55Z", "commit": {"oid": "367d5e97957bdfdd0d4e39609050e89bf26f27c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwMToyOTo1NlrOGeyxMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwMToyOTo1NlrOGeyxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDk0MjI1Nw==", "bodyText": "We need to change this. \ud83d\ude09", "url": "https://github.com/line/armeria/pull/2740#discussion_r434942257", "createdAt": "2020-06-04T01:29:56Z", "author": {"login": "minwoox"}, "path": "core/src/test/java/com/linecorp/armeria/server/HttpServerRequestTimeoutTest.java", "diffHunk": "@@ -187,4 +191,11 @@ void limitRequestTimeoutByDecorator(String path) {\n                 clientWithoutTimeout.get(serverWithoutTimeout.httpUri() + path).aggregate().join();\n         assertThat(response.status().code()).isEqualTo(503);\n     }\n+\n+    @Test\n+    void timeoutNow() {\n+        final AggregatedHttpResponse response =\n+                clientWithoutTimeout.get(serverWithoutTimeout.httpUri() + \"/timeout-now\").aggregate().join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "367d5e97957bdfdd0d4e39609050e89bf26f27c4"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b93f851cfdae2eb5982701c53732440d51666a2", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/6b93f851cfdae2eb5982701c53732440d51666a2", "committedDate": "2020-06-04T02:03:27Z", "message": "Merge branch 'master' into manual-timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5bb25640d94eefda0df4f8112f7660b1a94e984", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/d5bb25640d94eefda0df4f8112f7660b1a94e984", "committedDate": "2020-06-04T02:04:15Z", "message": "Merge master"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 551, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}