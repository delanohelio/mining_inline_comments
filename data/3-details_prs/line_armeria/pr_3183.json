{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMTk3ODkw", "number": 3183, "title": "Support Thrift custom protocol", "bodyText": "To add a new Thrift protocol, user is expected to\n\nadd a new SerializationFormat\ndeclare another SerializationFormatProvider via SPI that exposes it\ndeclare another ThriftProtocolFactoryProvider via SPI that links it to a TProtocolFactory", "createdAt": "2020-11-17T07:18:13Z", "url": "https://github.com/line/armeria/pull/3183", "merged": true, "mergeCommit": {"oid": "99096a46f9de153cba3d4a4e484c7616998f120f"}, "closed": true, "closedAt": "2020-11-27T08:16:36Z", "author": {"login": "mauhiz"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddSI-aAH2gAyNTIyMTk3ODkwOjI4YzIyN2I5M2M2NzFlYzQyM2E0NjMyZWI1MmRkZjAyMDhkMDUzN2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgf0xzgH2gAyNTIyMTk3ODkwOmNiOTJiOGYxOWMzMjYxOWIyZjIxNjdjNjVjMjVmZDJmY2Y0OTVlMDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "28c227b93c671ec423a4632eb52ddf0208d0537d", "author": {"user": {"login": "mauhiz", "name": "Vincent P\u00c9RICART"}}, "url": "https://github.com/line/armeria/commit/28c227b93c671ec423a4632eb52ddf0208d0537d", "committedDate": "2020-11-17T04:49:08Z", "message": "Fix rawtypes warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2215112a4ef1562e3a2393608dfa61a840758ec3", "author": {"user": {"login": "mauhiz", "name": "Vincent P\u00c9RICART"}}, "url": "https://github.com/line/armeria/commit/2215112a4ef1562e3a2393608dfa61a840758ec3", "committedDate": "2020-11-17T07:13:06Z", "message": "Support custom Thrift serialization format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMDc2NTI0", "url": "https://github.com/line/armeria/pull/3183#pullrequestreview-532076524", "createdAt": "2020-11-17T07:21:32Z", "commit": {"oid": "2215112a4ef1562e3a2393608dfa61a840758ec3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNzoyMTozM1rOH0nNGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNzoyMTozM1rOH0nNGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzMDMzMQ==", "bodyText": "How about using SPI instead of this, like others?", "url": "https://github.com/line/armeria/pull/3183#discussion_r524930331", "createdAt": "2020-11-17T07:21:33Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -77,59 +83,53 @@ public String toString() {\n      */\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Users can add new entries at runtime using\n+     * {@link #registerThriftProtocolFactory(SerializationFormat, TProtocolFactory)}.\n+     */\n+    private static final ConcurrentMap<SerializationFormat, TProtocolFactory> knownProtocolFactories =\n+            new ConcurrentHashMap<>();\n+\n+    /**\n+     * Registers a new Thrift protocol. This operation cannot be undone.\n+     *\n+     * @param serializationFormat the handle for this new protocol\n+     * @param protocolFactory a factory to instantiate this protocol\n+     */\n+    public static void registerThriftProtocolFactory(\n+            SerializationFormat serializationFormat, TProtocolFactory protocolFactory) {\n+        knownProtocolFactories.put(serializationFormat, protocolFactory);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2215112a4ef1562e3a2393608dfa61a840758ec3"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMDc4MDAw", "url": "https://github.com/line/armeria/pull/3183#pullrequestreview-532078000", "createdAt": "2020-11-17T07:24:26Z", "commit": {"oid": "2215112a4ef1562e3a2393608dfa61a840758ec3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNzoyNDoyNlrOH0nRng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNzoyNDoyNlrOH0nRng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzMTQ4Ng==", "bodyText": "How about values() that returns Set<ThriftProtocolFactory>? ThriftProtocolFactory could provide some common properties including SerializationFormat and TProtocolFactory (or just methods that delegates to TProtocolFactory).", "url": "https://github.com/line/armeria/pull/3183#discussion_r524931486", "createdAt": "2020-11-17T07:24:26Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -77,59 +83,53 @@ public String toString() {\n      */\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Users can add new entries at runtime using\n+     * {@link #registerThriftProtocolFactory(SerializationFormat, TProtocolFactory)}.\n+     */\n+    private static final ConcurrentMap<SerializationFormat, TProtocolFactory> knownProtocolFactories =\n+            new ConcurrentHashMap<>();\n+\n+    /**\n+     * Registers a new Thrift protocol. This operation cannot be undone.\n+     *\n+     * @param serializationFormat the handle for this new protocol\n+     * @param protocolFactory a factory to instantiate this protocol\n+     */\n+    public static void registerThriftProtocolFactory(\n+            SerializationFormat serializationFormat, TProtocolFactory protocolFactory) {\n+        knownProtocolFactories.put(serializationFormat, protocolFactory);\n+    }\n+\n+    static {\n+        registerThriftProtocolFactory(ThriftSerializationFormats.BINARY, BINARY);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.COMPACT, COMPACT);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.JSON, JSON);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.TEXT, TEXT);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.TEXT_NAMED_ENUM, TEXT_NAMED_ENUM);\n+    }\n+\n     /**\n      * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n      *\n-     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n      */\n     public static TProtocolFactory get(SerializationFormat serializationFormat) {\n         requireNonNull(serializationFormat, \"serializationFormat\");\n-\n-        if (serializationFormat == ThriftSerializationFormats.BINARY) {\n-            return BINARY;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.COMPACT) {\n-            return COMPACT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.JSON) {\n-            return JSON;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT) {\n-            return TEXT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT_NAMED_ENUM) {\n-            return TEXT_NAMED_ENUM;\n-        }\n-\n-        throw new IllegalArgumentException(\"non-Thrift serializationFormat: \" + serializationFormat);\n+        return Optional.ofNullable(knownProtocolFactories.get(serializationFormat))\n+                .orElseThrow(() -> new IllegalArgumentException(\n+                        \"Unsupported Thrift serializationFormat: \" + serializationFormat));\n     }\n \n     /**\n-     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory}.\n+     * Retrieves all registered Thrift serialization formats.\n      *\n-     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} is not known by this class\n+     * @return an unmodifiable view of the registered Thrift serialization formats set.\n      */\n-    public static SerializationFormat toSerializationFormat(TProtocolFactory protoFactory) {\n-        requireNonNull(protoFactory, \"protoFactory\");\n-\n-        if (protoFactory instanceof TBinaryProtocol.Factory) {\n-            return ThriftSerializationFormats.BINARY;\n-        } else if (protoFactory instanceof TCompactProtocol.Factory) {\n-            return ThriftSerializationFormats.COMPACT;\n-        } else if (protoFactory instanceof TJSONProtocol.Factory) {\n-            return ThriftSerializationFormats.JSON;\n-        } else if (protoFactory instanceof TTextProtocolFactory) {\n-            final TTextProtocolFactory factory = (TTextProtocolFactory) protoFactory;\n-            return factory.usesNamedEnums() ? ThriftSerializationFormats.TEXT_NAMED_ENUM\n-                                            : ThriftSerializationFormats.TEXT;\n-        } else {\n-            throw new IllegalArgumentException(\n-                    \"unsupported TProtocolFactory: \" + protoFactory.getClass().getName());\n-        }\n+    public static Set<SerializationFormat> getThriftSerializationFormats() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2215112a4ef1562e3a2393608dfa61a840758ec3"}, "originalPosition": 104}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52957173000e423046d3a0b8be77beb60e0594c5", "author": {"user": {"login": "mauhiz", "name": "Vincent P\u00c9RICART"}}, "url": "https://github.com/line/armeria/commit/52957173000e423046d3a0b8be77beb60e0594c5", "committedDate": "2020-11-17T08:22:55Z", "message": "Use SPI to define Thrift Protocol factories"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97", "author": {"user": {"login": "mauhiz", "name": "Vincent P\u00c9RICART"}}, "url": "https://github.com/line/armeria/commit/6ba0f73df06682b8a8fff4506aada3b5caf8ce97", "committedDate": "2020-11-17T08:57:20Z", "message": "Please some oversensitive Javadoc parser"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MTQ0ODgw", "url": "https://github.com/line/armeria/pull/3183#pullrequestreview-534144880", "createdAt": "2020-11-19T07:34:15Z", "commit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzozNDoxNVrOH2QA-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNzo0MjozMlrOH2QQRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0NzU0NQ==", "bodyText": "How about renaming ThriftSerializationFormat to Entry, like we did in SerializationFormatProvider?", "url": "https://github.com/line/armeria/pull/3183#discussion_r526647545", "createdAt": "2020-11-19T07:34:15Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+@FunctionalInterface\n+public interface ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    final class ThriftSerializationFormat {\n+        private final SerializationFormat serializationFormat;\n+        private final TProtocolFactory tProtocolFactory;\n+\n+        public ThriftSerializationFormat(SerializationFormat serializationFormat,\n+                                         TProtocolFactory tProtocolFactory) {\n+            this.serializationFormat = requireNonNull(serializationFormat, \"serializationFormat\");\n+            this.tProtocolFactory = requireNonNull(tProtocolFactory, \"tProtocolFactory\");\n+        }\n+\n+        public SerializationFormat getSerializationFormat() {\n+            return serializationFormat;\n+        }\n+\n+        public TProtocolFactory getTProtocolFactory() {\n+            return tProtocolFactory;\n+        }\n+    }\n+\n+    /**\n+     * Accessed configured {@link ThriftSerializationFormat}s for this SPI provider.\n+     *\n+     * @return an immutable view\n+     */\n+    Set<ThriftSerializationFormat> thriftSerializationFormats();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0ODUxOA==", "bodyText": "How about just modifying this class class to make values() return all discovered Thrift serialization formats?", "url": "https://github.com/line/armeria/pull/3183#discussion_r526648518", "createdAt": "2020-11-19T07:36:20Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -15,16 +15,10 @@\n  */\n package com.linecorp.armeria.common.thrift;\n \n-import static java.util.Objects.requireNonNull;\n-\n-import java.util.Set;\n-\n-import com.google.common.collect.ImmutableSet;\n-\n import com.linecorp.armeria.common.SerializationFormat;\n \n /**\n- * Thrift-related {@link SerializationFormat} instances.\n+ * Out-of-the box supported Thrift-related {@link SerializationFormat} instances.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY0OTgzNw==", "bodyText": "OK. Then how about making ThriftSerializationFormats.values() return what this method returns, and then hiding this method from the public API?", "url": "https://github.com/line/armeria/pull/3183#discussion_r526649837", "createdAt": "2020-11-19T07:39:13Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -77,59 +83,53 @@ public String toString() {\n      */\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Users can add new entries at runtime using\n+     * {@link #registerThriftProtocolFactory(SerializationFormat, TProtocolFactory)}.\n+     */\n+    private static final ConcurrentMap<SerializationFormat, TProtocolFactory> knownProtocolFactories =\n+            new ConcurrentHashMap<>();\n+\n+    /**\n+     * Registers a new Thrift protocol. This operation cannot be undone.\n+     *\n+     * @param serializationFormat the handle for this new protocol\n+     * @param protocolFactory a factory to instantiate this protocol\n+     */\n+    public static void registerThriftProtocolFactory(\n+            SerializationFormat serializationFormat, TProtocolFactory protocolFactory) {\n+        knownProtocolFactories.put(serializationFormat, protocolFactory);\n+    }\n+\n+    static {\n+        registerThriftProtocolFactory(ThriftSerializationFormats.BINARY, BINARY);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.COMPACT, COMPACT);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.JSON, JSON);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.TEXT, TEXT);\n+        registerThriftProtocolFactory(ThriftSerializationFormats.TEXT_NAMED_ENUM, TEXT_NAMED_ENUM);\n+    }\n+\n     /**\n      * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n      *\n-     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n      */\n     public static TProtocolFactory get(SerializationFormat serializationFormat) {\n         requireNonNull(serializationFormat, \"serializationFormat\");\n-\n-        if (serializationFormat == ThriftSerializationFormats.BINARY) {\n-            return BINARY;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.COMPACT) {\n-            return COMPACT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.JSON) {\n-            return JSON;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT) {\n-            return TEXT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT_NAMED_ENUM) {\n-            return TEXT_NAMED_ENUM;\n-        }\n-\n-        throw new IllegalArgumentException(\"non-Thrift serializationFormat: \" + serializationFormat);\n+        return Optional.ofNullable(knownProtocolFactories.get(serializationFormat))\n+                .orElseThrow(() -> new IllegalArgumentException(\n+                        \"Unsupported Thrift serializationFormat: \" + serializationFormat));\n     }\n \n     /**\n-     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory}.\n+     * Retrieves all registered Thrift serialization formats.\n      *\n-     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} is not known by this class\n+     * @return an unmodifiable view of the registered Thrift serialization formats set.\n      */\n-    public static SerializationFormat toSerializationFormat(TProtocolFactory protoFactory) {\n-        requireNonNull(protoFactory, \"protoFactory\");\n-\n-        if (protoFactory instanceof TBinaryProtocol.Factory) {\n-            return ThriftSerializationFormats.BINARY;\n-        } else if (protoFactory instanceof TCompactProtocol.Factory) {\n-            return ThriftSerializationFormats.COMPACT;\n-        } else if (protoFactory instanceof TJSONProtocol.Factory) {\n-            return ThriftSerializationFormats.JSON;\n-        } else if (protoFactory instanceof TTextProtocolFactory) {\n-            final TTextProtocolFactory factory = (TTextProtocolFactory) protoFactory;\n-            return factory.usesNamedEnums() ? ThriftSerializationFormats.TEXT_NAMED_ENUM\n-                                            : ThriftSerializationFormats.TEXT;\n-        } else {\n-            throw new IllegalArgumentException(\n-                    \"unsupported TProtocolFactory: \" + protoFactory.getClass().getName());\n-        }\n+    public static Set<SerializationFormat> getThriftSerializationFormats() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzMTQ4Ng=="}, "originalCommit": {"oid": "2215112a4ef1562e3a2393608dfa61a840758ec3"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY1MDY4NA==", "bodyText": "This doesn't need to be visible to other classes than subclasses. How about making this class protected and ThriftProtocolFactoryProvider a public abstract class, like we did in SerializationFormatProvider?", "url": "https://github.com/line/armeria/pull/3183#discussion_r526650684", "createdAt": "2020-11-19T07:40:51Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+@FunctionalInterface\n+public interface ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    final class ThriftSerializationFormat {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY1MTQ2Mg==", "bodyText": "Could we revive these methods? values() could pull the values from getThriftSerializationFormats() you added.", "url": "https://github.com/line/armeria/pull/3183#discussion_r526651462", "createdAt": "2020-11-19T07:42:32Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,22 +49,5 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n-\n-    /**\n-     * Returns the set of all known Thrift serialization formats.\n-     */\n-    public static Set<SerializationFormat> values() {\n-        return THRIFT_FORMATS;\n-    }\n-\n-    /**\n-     * Returns whether the specified {@link SerializationFormat} is Thrift.\n-     */\n-    public static boolean isThrift(SerializationFormat format) {\n-        return values().contains(requireNonNull(format, \"format\"));\n-    }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ba0f73df06682b8a8fff4506aada3b5caf8ce97"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d442857c150a82bff715b1e35ee00fda255f1856", "author": {"user": {"login": "mauhiz", "name": "Vincent P\u00c9RICART"}}, "url": "https://github.com/line/armeria/commit/d442857c150a82bff715b1e35ee00fda255f1856", "committedDate": "2020-11-21T13:34:06Z", "message": "Rename Entry and change visibility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04824d39ae0a37ba94fb23ff209bb4890cc34a01", "author": {"user": {"login": "mauhiz", "name": "Vincent P\u00c9RICART"}}, "url": "https://github.com/line/armeria/commit/04824d39ae0a37ba94fb23ff209bb4890cc34a01", "committedDate": "2020-11-21T14:24:26Z", "message": "Move knownProtocolFactories; Rename to values(); revive isThrift"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fb28007fc8bab76cc5dfe29715b531cc0589666", "author": {"user": {"login": "mauhiz", "name": "Vincent P\u00c9RICART"}}, "url": "https://github.com/line/armeria/commit/8fb28007fc8bab76cc5dfe29715b531cc0589666", "committedDate": "2020-11-21T14:24:26Z", "message": "revert unnecessary diff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747", "author": {"user": {"login": "mauhiz", "name": "Vincent P\u00c9RICART"}}, "url": "https://github.com/line/armeria/commit/038a7d71386e7b4fbfa05aa074d1b8a2bf91c747", "committedDate": "2020-11-21T14:24:26Z", "message": "Restore method for binary compatibility"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MDE5Mzk4", "url": "https://github.com/line/armeria/pull/3183#pullrequestreview-537019398", "createdAt": "2020-11-24T02:00:09Z", "commit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjowMDowOVrOH4nZeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjoxNjozOFrOH4oWFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyNzgwMQ==", "bodyText": "How about making this static final field?", "url": "https://github.com/line/armeria/pull/3183#discussion_r529127801", "createdAt": "2020-11-24T02:00:09Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/DefaultThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import java.util.Set;\n+\n+import com.google.common.collect.ImmutableSet;\n+\n+/**\n+ * Default registered {@link ThriftProtocolFactoryProvider}.\n+ * It is not overridable but you may provide and register another implementation.\n+ */\n+public final class DefaultThriftProtocolFactoryProvider extends ThriftProtocolFactoryProvider {\n+    @Override\n+    protected Set<Entry> entries() {\n+        return ImmutableSet.of(\n+                new Entry(\n+                        ThriftSerializationFormats.BINARY, ThriftProtocolFactories.BINARY),\n+                new Entry(\n+                        ThriftSerializationFormats.COMPACT, ThriftProtocolFactories.COMPACT),\n+                new Entry(\n+                        ThriftSerializationFormats.JSON, ThriftProtocolFactories.JSON),\n+                new Entry(\n+                        ThriftSerializationFormats.TEXT, ThriftProtocolFactories.TEXT),\n+                new Entry(\n+                        ThriftSerializationFormats.TEXT_NAMED_ENUM, ThriftProtocolFactories.TEXT_NAMED_ENUM)\n+        );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEyODQ1OA==", "bodyText": "Some nits \ud83d\ude09:\n\nJavadoc?\nRemove get prefix?\nAdd toString()?", "url": "https://github.com/line/armeria/pull/3183#discussion_r529128458", "createdAt": "2020-11-24T02:00:48Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        private final SerializationFormat serializationFormat;\n+        private final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {\n+            this.serializationFormat = requireNonNull(serializationFormat, \"serializationFormat\");\n+            this.tProtocolFactory = requireNonNull(tProtocolFactory, \"tProtocolFactory\");\n+        }\n+\n+        public SerializationFormat getSerializationFormat() {\n+            return serializationFormat;\n+        }\n+\n+        public TProtocolFactory getTProtocolFactory() {\n+            return tProtocolFactory;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTEzMTYxMQ==", "bodyText": "Should this method return an immutable Set?", "url": "https://github.com/line/armeria/pull/3183#discussion_r529131611", "createdAt": "2020-11-24T02:04:11Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        private final SerializationFormat serializationFormat;\n+        private final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {\n+            this.serializationFormat = requireNonNull(serializationFormat, \"serializationFormat\");\n+            this.tProtocolFactory = requireNonNull(tProtocolFactory, \"tProtocolFactory\");\n+        }\n+\n+        public SerializationFormat getSerializationFormat() {\n+            return serializationFormat;\n+        }\n+\n+        public TProtocolFactory getTProtocolFactory() {\n+            return tProtocolFactory;\n+        }\n+    }\n+\n+    /**\n+     * Accessed configured {@link Entry}s for this SPI provider.\n+     *\n+     * @return an immutable view", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0MDk2Ng==", "bodyText": "nit: null checking with if condition? The Optional seems to only be in a stack by escape analysis, however, we always try to avoid creating additional objects if possible.", "url": "https://github.com/line/armeria/pull/3183#discussion_r529140966", "createdAt": "2020-11-24T02:14:08Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +63,44 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(Entry::getSerializationFormat,\n+                                        Entry::getTProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory get(SerializationFormat serializationFormat) {\n+        requireNonNull(serializationFormat, \"serializationFormat\");\n+        return Optional.ofNullable(knownProtocolFactories.get(serializationFormat))\n+                       .orElseThrow(() -> new IllegalArgumentException(\n+                               \"Unsupported Thrift serializationFormat: \" + serializationFormat));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0MzMxNw==", "bodyText": "Make it singleton and use it?", "url": "https://github.com/line/armeria/pull/3183#discussion_r529143317", "createdAt": "2020-11-24T02:16:38Z", "author": {"login": "ikhoon"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +63,44 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(Entry::getSerializationFormat,\n+                                        Entry::getTProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory get(SerializationFormat serializationFormat) {\n+        requireNonNull(serializationFormat, \"serializationFormat\");\n+        return Optional.ofNullable(knownProtocolFactories.get(serializationFormat))\n+                       .orElseThrow(() -> new IllegalArgumentException(\n+                               \"Unsupported Thrift serializationFormat: \" + serializationFormat));\n+    }\n \n     /**\n-     * Returns the set of all known Thrift serialization formats.\n+     * Retrieves all registered Thrift serialization formats.\n+     *\n+     * @return an view of the registered Thrift serialization formats.\n      */\n     public static Set<SerializationFormat> values() {\n-        return THRIFT_FORMATS;\n+        return knownProtocolFactories.keySet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MDI1NzM5", "url": "https://github.com/line/armeria/pull/3183#pullrequestreview-537025739", "createdAt": "2020-11-24T02:17:40Z", "commit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjoxNzo0MFrOH4oZ6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwMjoxODo0N1rOH4od3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0NDI5OQ==", "bodyText": "How about renaming to tProtocolFactory instead of get?", "url": "https://github.com/line/armeria/pull/3183#discussion_r529144299", "createdAt": "2020-11-24T02:17:40Z", "author": {"login": "minwoox"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +63,44 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(Entry::getSerializationFormat,\n+                                        Entry::getTProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory get(SerializationFormat serializationFormat) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTE0NTMwOQ==", "bodyText": "Question: Is there any reason that you made this as an abstract class instead of an interface like other providers?", "url": "https://github.com/line/armeria/pull/3183#discussion_r529145309", "createdAt": "2020-11-24T02:18:47Z", "author": {"login": "minwoox"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "038a7d71386e7b4fbfa05aa074d1b8a2bf91c747"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ce3c8793a73296394eeaf214259ee978e348806", "author": {"user": {"login": "mauhiz", "name": "Vincent P\u00c9RICART"}}, "url": "https://github.com/line/armeria/commit/9ce3c8793a73296394eeaf214259ee978e348806", "committedDate": "2020-11-24T08:18:44Z", "message": "Remove getters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3900e9044f741cc7e81941d0bd266d3bb577c21", "author": {"user": {"login": "mauhiz", "name": "Vincent P\u00c9RICART"}}, "url": "https://github.com/line/armeria/commit/a3900e9044f741cc7e81941d0bd266d3bb577c21", "committedDate": "2020-11-24T08:25:38Z", "message": "Replace optional with a if"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7", "author": {"user": {"login": "mauhiz", "name": "Vincent P\u00c9RICART"}}, "url": "https://github.com/line/armeria/commit/3c649257297f8cd8f414cbcd8193e3551370cdf7", "committedDate": "2020-11-24T10:41:10Z", "message": "Rename to tProtocolFactory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3Mzg0MDk3", "url": "https://github.com/line/armeria/pull/3183#pullrequestreview-537384097", "createdAt": "2020-11-24T11:08:53Z", "commit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MTkxMDMw", "url": "https://github.com/line/armeria/pull/3183#pullrequestreview-538191030", "createdAt": "2020-11-25T06:34:28Z", "commit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjozNDoyOFrOH5k7yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNjo0OTowOFrOH5lPrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzNjAxMA==", "bodyText": "Could we move to com.linecorp.armeria.internal.common.thrift? This class doesn't need to be part of public API.", "url": "https://github.com/line/armeria/pull/3183#discussion_r530136010", "createdAt": "2020-11-25T06:34:28Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/DefaultThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzNzYxOA==", "bodyText": "public -> protected?", "url": "https://github.com/line/armeria/pull/3183#discussion_r530137618", "createdAt": "2020-11-25T06:39:12Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        final SerializationFormat serializationFormat;\n+        final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzNzc1NQ==", "bodyText": "Accessed -> Returns the", "url": "https://github.com/line/armeria/pull/3183#discussion_r530137755", "createdAt": "2020-11-25T06:39:35Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactoryProvider.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.thrift;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Set;\n+\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.google.common.base.MoreObjects;\n+\n+import com.linecorp.armeria.common.SerializationFormat;\n+\n+/**\n+ * SPI Provider for links from {@link SerializationFormat} to {@link TProtocolFactory}.\n+ */\n+public abstract class ThriftProtocolFactoryProvider {\n+    /**\n+     * Pair of {@link SerializationFormat} and {@link TProtocolFactory}.\n+     */\n+    protected static final class Entry {\n+        final SerializationFormat serializationFormat;\n+        final TProtocolFactory tProtocolFactory;\n+\n+        public Entry(SerializationFormat serializationFormat, TProtocolFactory tProtocolFactory) {\n+            this.serializationFormat = requireNonNull(serializationFormat, \"serializationFormat\");\n+            this.tProtocolFactory = requireNonNull(tProtocolFactory, \"tProtocolFactory\");\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return MoreObjects.toStringHelper(this)\n+                              .add(\"serializationFormat\", serializationFormat)\n+                              .add(\"tProtocolFactory\", tProtocolFactory)\n+                              .toString();\n+        }\n+    }\n+\n+    /**\n+     * Accessed configured {@link Entry}s for this SPI provider.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzNzgwOA==", "bodyText": "use -> Use", "url": "https://github.com/line/armeria/pull/3183#discussion_r530137808", "createdAt": "2020-11-25T06:39:48Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -78,44 +78,28 @@ public String toString() {\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n     /**\n-     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     * Alias for {@link ThriftSerializationFormats#tProtocolFactory(SerializationFormat)}.\n      *\n-     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n+     * @param serializationFormat a known serialization format\n+     * @return the protocol factory linked to the input serializationFormat\n+     * @deprecated use {@link ThriftSerializationFormats#tProtocolFactory(SerializationFormat)}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzODQ1NA==", "bodyText": "How about just toProtocolFactory() or protocolFactory()? That 't' looks somewhat awkward.", "url": "https://github.com/line/armeria/pull/3183#discussion_r530138454", "createdAt": "2020-11-25T06:41:37Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -55,14 +62,43 @@\n      */\n     public static final SerializationFormat TEXT_NAMED_ENUM = SerializationFormat.of(\"ttext-named-enum\");\n \n-    private static final Set<SerializationFormat> THRIFT_FORMATS =\n-            ImmutableSet.of(BINARY, COMPACT, JSON, TEXT, TEXT_NAMED_ENUM);\n+    /**\n+     * A way to lookup the related {@link TProtocolFactory} from a {@link SerializationFormat}.\n+     * Entries are provided via registered SPI {@link ThriftProtocolFactoryProvider} implementations.\n+     */\n+    private static final Map<SerializationFormat, TProtocolFactory> knownProtocolFactories;\n+\n+    static {\n+        final List<ThriftProtocolFactoryProvider> providers = ImmutableList.copyOf(\n+                ServiceLoader.load(ThriftProtocolFactoryProvider.class,\n+                                   ThriftProtocolFactoryProvider.class.getClassLoader()));\n+        knownProtocolFactories = providers\n+                .stream()\n+                .map(ThriftProtocolFactoryProvider::entries)\n+                .flatMap(Set::stream)\n+                .collect(toImmutableMap(e -> e.serializationFormat, e -> e.tProtocolFactory));\n+    }\n+\n+    /**\n+     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     *\n+     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not a\n+     *         known Thrift serialization format\n+     */\n+    public static TProtocolFactory tProtocolFactory(SerializationFormat serializationFormat) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzODY5OA==", "bodyText": "return -> returned", "url": "https://github.com/line/armeria/pull/3183#discussion_r530138698", "createdAt": "2020-11-25T06:42:16Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/server/thrift/THttpServiceBuilder.java", "diffHunk": "@@ -121,11 +123,11 @@ public THttpServiceBuilder otherSerializationFormats(SerializationFormat otherSe\n     }\n \n     /**\n-     * Adds other {@link SerializationFormat} to the builder. Current supported {@link SerializationFormat}s are\n-     * {@link ThriftSerializationFormats#values()}. If nothing is specified then all the\n-     * {@link SerializationFormat#values()}s are added.\n+     * Adds other {@link SerializationFormat}s to the builder. If nothing is specified then all\n+     * {@link SerializationFormat}s return by {@link ThriftSerializationFormats#values()}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzOTQ0OQ==", "bodyText": "How about this:\nProvides Thrift-related {@link SerializationFormat} instances and their {@link TProtocolFactory}s.\n\n.. because whether this class registers anything is implementation detail.", "url": "https://github.com/line/armeria/pull/3183#discussion_r530139449", "createdAt": "2020-11-25T06:44:30Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftSerializationFormats.java", "diffHunk": "@@ -15,16 +15,23 @@\n  */\n package com.linecorp.armeria.common.thrift;\n \n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n import static java.util.Objects.requireNonNull;\n \n+import java.util.List;\n+import java.util.Map;\n+import java.util.ServiceLoader;\n import java.util.Set;\n \n-import com.google.common.collect.ImmutableSet;\n+import org.apache.thrift.protocol.TProtocolFactory;\n+\n+import com.google.common.collect.ImmutableList;\n \n import com.linecorp.armeria.common.SerializationFormat;\n \n /**\n- * Thrift-related {@link SerializationFormat} instances.\n+ * Registered Thrift-related {@link SerializationFormat} instances.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEzOTkzNQ==", "bodyText": "Holds -> Provides ?", "url": "https://github.com/line/armeria/pull/3183#discussion_r530139935", "createdAt": "2020-11-25T06:45:43Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -27,7 +27,7 @@\n import com.linecorp.armeria.common.thrift.text.TTextProtocolFactory;\n \n /**\n- * Provides a set of the known {@link TProtocolFactory} instances.\n+ * Holds a few known {@link TProtocolFactory} instances.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE0MTEwMA==", "bodyText": "How about reimplementing this method in ThriftSerializationFormats using a bidi map? e.g.\nSerializationFormat serfmt = ThriftSerializationFormats.of(protoFactory);", "url": "https://github.com/line/armeria/pull/3183#discussion_r530141100", "createdAt": "2020-11-25T06:49:08Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/ThriftProtocolFactories.java", "diffHunk": "@@ -78,44 +78,28 @@ public String toString() {\n     public static final TProtocolFactory TEXT_NAMED_ENUM = TTextProtocolFactory.get(true);\n \n     /**\n-     * Returns the {@link TProtocolFactory} for the specified {@link SerializationFormat}.\n+     * Alias for {@link ThriftSerializationFormats#tProtocolFactory(SerializationFormat)}.\n      *\n-     * @throws IllegalArgumentException if the specified {@link SerializationFormat} is not for Thrift\n+     * @param serializationFormat a known serialization format\n+     * @return the protocol factory linked to the input serializationFormat\n+     * @deprecated use {@link ThriftSerializationFormats#tProtocolFactory(SerializationFormat)}.\n      */\n+    @Deprecated\n     public static TProtocolFactory get(SerializationFormat serializationFormat) {\n-        requireNonNull(serializationFormat, \"serializationFormat\");\n-\n-        if (serializationFormat == ThriftSerializationFormats.BINARY) {\n-            return BINARY;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.COMPACT) {\n-            return COMPACT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.JSON) {\n-            return JSON;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT) {\n-            return TEXT;\n-        }\n-\n-        if (serializationFormat == ThriftSerializationFormats.TEXT_NAMED_ENUM) {\n-            return TEXT_NAMED_ENUM;\n-        }\n-\n-        throw new IllegalArgumentException(\"non-Thrift serializationFormat: \" + serializationFormat);\n+        return ThriftSerializationFormats.tProtocolFactory(serializationFormat);\n     }\n \n     /**\n-     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory}.\n+     * Returns the {@link SerializationFormat} for the specified {@link TProtocolFactory},\n+     * as if it were registered by {@link DefaultThriftProtocolFactoryProvider}.\n+     * Consider having your own {@link TProtocolFactory} to {@link SerializationFormat} mapping if necessary.\n      *\n-     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} is not known by this class\n+     * @throws IllegalArgumentException if the specified {@link TProtocolFactory} did not match anything\n+     * @deprecated this method cannot reliably work with custom protocol factories\n      */\n+    @Deprecated\n     public static SerializationFormat toSerializationFormat(TProtocolFactory protoFactory) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c649257297f8cd8f414cbcd8193e3551370cdf7"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3aedfe44820422637ed2fa87025729e61945fda", "author": {"user": {"login": "mauhiz", "name": "Vincent P\u00c9RICART"}}, "url": "https://github.com/line/armeria/commit/b3aedfe44820422637ed2fa87025729e61945fda", "committedDate": "2020-11-26T22:59:37Z", "message": "Address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26bdfe2eea648ea4be329ddd58c73390d228e12c", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/26bdfe2eea648ea4be329ddd58c73390d228e12c", "committedDate": "2020-11-27T04:10:56Z", "message": "Update ThriftProtocolFactories.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1df925df3ddf27857d8b1fd645428ac1599b763b", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/1df925df3ddf27857d8b1fd645428ac1599b763b", "committedDate": "2020-11-27T04:25:35Z", "message": "Javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NzAxNDMx", "url": "https://github.com/line/armeria/pull/3183#pullrequestreview-539701431", "createdAt": "2020-11-27T04:26:53Z", "commit": {"oid": "1df925df3ddf27857d8b1fd645428ac1599b763b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb92b8f19c32619b2f2167c65c25fd2fcf495e04", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/cb92b8f19c32619b2f2167c65c25fd2fcf495e04", "committedDate": "2020-11-27T04:27:31Z", "message": "Hyphen"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4846, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}