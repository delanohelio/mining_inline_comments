{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxNDU3OTUy", "number": 3177, "title": "Add Accept-Language parsing and prioritizing", "bodyText": "Motivation:\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's\nmostly useful to detect the default language of the site.\nModifications:\nAdded method acceptLanguages() and selectLocale(supportedLocales) to\nRequestHeaderGetters. acceptLanguages() is lazy and cached.\nAdded acceptLanguages(acceptedLanguages) to RequestHeadersBuilder.\nCloses #3179", "createdAt": "2020-11-16T07:20:11Z", "url": "https://github.com/line/armeria/pull/3177", "merged": true, "mergeCommit": {"oid": "79086ff48865ab3bc2d3518e6b4661c8adde91fc"}, "closed": true, "closedAt": "2020-11-30T05:37:40Z", "author": {"login": "tobias-"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddAO-qABqjM5OTg4OTk2NjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdg1tjOAFqTU0MDM0NTM5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9d6d9c9d6c64c572a3def79425e8c0f4402af23a", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/9d6d9c9d6c64c572a3def79425e8c0f4402af23a", "committedDate": "2020-11-16T07:11:54Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed."}, "afterCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185", "committedDate": "2020-11-16T07:57:14Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMTQ4MjUy", "url": "https://github.com/line/armeria/pull/3177#pullrequestreview-531148252", "createdAt": "2020-11-16T09:31:47Z", "commit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOTozMTo0N1rOHzv86Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwOTozODoxMVrOHzwY0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAyNTA2NQ==", "bodyText": "How about selectLocale(Iterable<Locale>) ?", "url": "https://github.com/line/armeria/pull/3177#discussion_r524025065", "createdAt": "2020-11-16T09:31:47Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/DefaultRoutingContext.java", "diffHunk": "@@ -133,6 +144,17 @@ public MediaType contentType() {\n         return acceptTypes;\n     }\n \n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        return acceptLanguages.get();\n+    }\n+\n+    @Nullable\n+    @Override\n+    public Locale getLocale(Collection<Locale> supportedLocales) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAzMjIwOA==", "bodyText": "I'm curious if we should return Locale.ROOT instead of null. What do you think?", "url": "https://github.com/line/armeria/pull/3177#discussion_r524032208", "createdAt": "2020-11-16T09:38:11Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/RoutingContext.java", "diffHunk": "@@ -81,6 +84,23 @@\n      */\n     List<MediaType> acceptTypes();\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    List<LanguageRange> acceptLanguages();\n+\n+    /**\n+     * This matches the {@link Locale}s supported by the server to\n+     * the @{link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match\n+     * according to client preference.\n+     * @param supportedLocales a list of locales supported by the server.\n+     * @return The best matching locale or null if no locale matches.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/7e0ed58d01bc3ce960d71a778c75bf3ce8b9a185", "committedDate": "2020-11-16T07:57:14Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed."}, "afterCommit": {"oid": "dad86224ed2dc9df60c8b8dad91b151a728b30c7", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/dad86224ed2dc9df60c8b8dad91b151a728b30c7", "committedDate": "2020-11-16T11:41:56Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dad86224ed2dc9df60c8b8dad91b151a728b30c7", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/dad86224ed2dc9df60c8b8dad91b151a728b30c7", "committedDate": "2020-11-16T11:41:56Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}, "afterCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/6b7e347b607f7e3711a919ee1d193a0f964682c9", "committedDate": "2020-11-16T14:27:20Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDg4ODk2", "url": "https://github.com/line/armeria/pull/3177#pullrequestreview-534088896", "createdAt": "2020-11-19T05:19:24Z", "commit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNToxOToyNFrOH2NJcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNToyMTo0MVrOH2NMOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMDU2MA==", "bodyText": "Shouldn't we put this into DefaultRequestHeadersBuilder because it's a request header?", "url": "https://github.com/line/armeria/pull/3177#discussion_r526600560", "createdAt": "2020-11-19T05:19:24Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/AbstractHttpHeadersBuilder.java", "diffHunk": "@@ -39,6 +44,18 @@ final HttpHeadersBase newSetters(HttpHeadersBase parent, boolean shallowCopy) {\n         return new HttpHeadersBase(parent, shallowCopy);\n     }\n \n+    @Nullable\n+    public final List<LanguageRange> acceptLanguages() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMDc4Mg==", "bodyText": "ditto\nShouldn't we put this into RequestHeaderGetters?", "url": "https://github.com/line/armeria/pull/3177#discussion_r526600782", "createdAt": "2020-11-19T05:20:03Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeaderGetters.java", "diffHunk": "@@ -49,6 +52,27 @@\n     @Nullable\n     MediaType contentType();\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    List<LanguageRange> acceptLanguages();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMTIxNA==", "bodyText": "Let's put:\nrequireNonNull(supportedLocales, \"supportedLocales\");", "url": "https://github.com/line/armeria/pull/3177#discussion_r526601214", "createdAt": "2020-11-19T05:21:25Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -254,6 +263,33 @@ final void contentType(MediaType contentType) {\n         set(HttpHeaderNames.CONTENT_TYPE, contentType.toString());\n     }\n \n+    @Nullable\n+    @Override\n+    public Locale selectLocale(Collection<Locale> supportedLocales) {\n+        return acceptLanguages()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwMTI3NQ==", "bodyText": "nit: (it) -> it", "url": "https://github.com/line/armeria/pull/3177#discussion_r526601275", "createdAt": "2020-11-19T05:21:41Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -254,6 +263,33 @@ final void contentType(MediaType contentType) {\n         set(HttpHeaderNames.CONTENT_TYPE, contentType.toString());\n     }\n \n+    @Nullable\n+    @Override\n+    public Locale selectLocale(Collection<Locale> supportedLocales) {\n+        return acceptLanguages()\n+                .stream()\n+                .flatMap((it) -> Locale.filter(ImmutableList.of(it), supportedLocales).stream())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b7e347b607f7e3711a919ee1d193a0f964682c9"}, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f5ed71e74f679299cc5a8ec6140c2e5ee121035", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/5f5ed71e74f679299cc5a8ec6140c2e5ee121035", "committedDate": "2020-11-19T09:25:37Z", "message": "Move logic to HttpHeadersBase but only expose in RequestHeaders"}, "afterCommit": {"oid": "814cda31debea9fcaaf6f3d03d2363e770f8a718", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/814cda31debea9fcaaf6f3d03d2363e770f8a718", "committedDate": "2020-11-19T09:32:35Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "814cda31debea9fcaaf6f3d03d2363e770f8a718", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/814cda31debea9fcaaf6f3d03d2363e770f8a718", "committedDate": "2020-11-19T09:32:35Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}, "afterCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/f55e0a26a43cd6bca80af67af4212cf3d548ba7b", "committedDate": "2020-11-19T09:45:27Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MzEzODg4", "url": "https://github.com/line/armeria/pull/3177#pullrequestreview-534313888", "createdAt": "2020-11-19T11:12:55Z", "commit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxMjo1NVrOH2YIIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMToxOToyOVrOH2Ya8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4MDQ0OQ==", "bodyText": "Could do just:\nfinal HttpHeadersBase getters = getters();\nif (getters != null) {\n    return getters.selectLocale(supportedLocales);\n}\nreturn null;", "url": "https://github.com/line/armeria/pull/3177#discussion_r526780449", "createdAt": "2020-11-19T11:12:55Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,35 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return DefaultRequestHeaders.ACCEPT_LANGUAGE_WILDCARD;\n+    }\n+\n+    public RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptLanguages) {\n+        requireNonNull(acceptLanguages, \"acceptLanguages\");\n+        final String acceptLanguagesValue = acceptLanguages\n+                .stream()\n+                .map(LanguageRange::toString)\n+                .collect(Collectors.joining(\", \"));\n+        set(\n+                HttpHeaderNames.ACCEPT_LANGUAGE,\n+                acceptLanguagesValue\n+        );\n+        return self();\n+    }\n+\n+    @Nullable\n+    public Locale selectLocale(Collection<Locale> supportedLocales) {\n+        final HttpHeadersBase getters = getters();\n+        if (getters instanceof RequestHeaderGetters) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4MDg0MA==", "bodyText": "Let's merge these into one line because this is Java. \ud83e\udd23\nset(HttpHeaderNames.ACCEPT_LANGUAGE, acceptLanguagesValue);", "url": "https://github.com/line/armeria/pull/3177#discussion_r526780840", "createdAt": "2020-11-19T11:13:36Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,35 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return DefaultRequestHeaders.ACCEPT_LANGUAGE_WILDCARD;\n+    }\n+\n+    public RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptLanguages) {\n+        requireNonNull(acceptLanguages, \"acceptLanguages\");\n+        final String acceptLanguagesValue = acceptLanguages\n+                .stream()\n+                .map(LanguageRange::toString)\n+                .collect(Collectors.joining(\", \"));\n+        set(\n+                HttpHeaderNames.ACCEPT_LANGUAGE,\n+                acceptLanguagesValue\n+        );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4MDk1MA==", "bodyText": "missing @Override", "url": "https://github.com/line/armeria/pull/3177#discussion_r526780950", "createdAt": "2020-11-19T11:13:46Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,35 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return DefaultRequestHeaders.ACCEPT_LANGUAGE_WILDCARD;\n+    }\n+\n+    public RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptLanguages) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4MTAxOQ==", "bodyText": "missing @Override", "url": "https://github.com/line/armeria/pull/3177#discussion_r526781019", "createdAt": "2020-11-19T11:13:51Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,35 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return DefaultRequestHeaders.ACCEPT_LANGUAGE_WILDCARD;\n+    }\n+\n+    public RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptLanguages) {\n+        requireNonNull(acceptLanguages, \"acceptLanguages\");\n+        final String acceptLanguagesValue = acceptLanguages\n+                .stream()\n+                .map(LanguageRange::toString)\n+                .collect(Collectors.joining(\", \"));\n+        set(\n+                HttpHeaderNames.ACCEPT_LANGUAGE,\n+                acceptLanguagesValue\n+        );\n+        return self();\n+    }\n+\n+    @Nullable\n+    public Locale selectLocale(Collection<Locale> supportedLocales) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4MTU5NQ==", "bodyText": "nit: HttpHeadersBase.ACCEPT_LANGUAGE_WILDCARD;", "url": "https://github.com/line/armeria/pull/3177#discussion_r526781595", "createdAt": "2020-11-19T11:14:47Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,35 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return DefaultRequestHeaders.ACCEPT_LANGUAGE_WILDCARD;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4Mzc0NQ==", "bodyText": "nit: {@link ...", "url": "https://github.com/line/armeria/pull/3177#discussion_r526783745", "createdAt": "2020-11-19T11:18:14Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "diffHunk": "@@ -318,6 +321,31 @@ default MediaType contentType() {\n         return headers().contentType();\n     }\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    default List<LanguageRange> acceptLanguages() {\n+        return headers().acceptLanguages();\n+    }\n+\n+    /**\n+     * This matches the {@link Locale}s supported by the server to\n+     * the @{link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc4NTI2NQ==", "bodyText": "I think we can remove @see", "url": "https://github.com/line/armeria/pull/3177#discussion_r526785265", "createdAt": "2020-11-19T11:19:29Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "diffHunk": "@@ -318,6 +321,31 @@ default MediaType contentType() {\n         return headers().contentType();\n     }\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    default List<LanguageRange> acceptLanguages() {\n+        return headers().acceptLanguages();\n+    }\n+\n+    /**\n+     * This matches the {@link Locale}s supported by the server to\n+     * the @{link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match\n+     * according to client preference. It does this via <s>Basic Filter</s>ing each\n+     * {@link LanguageRange} and picking the first match. This is the \"classic\"\n+     * algorithm described in @see", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0Mzg4OTk4", "url": "https://github.com/line/armeria/pull/3177#pullrequestreview-534388998", "createdAt": "2020-11-19T12:29:47Z", "commit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMjoyOTo0N1rOH2bkWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMjoyOTo0N1rOH2bkWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzNjgyNQ==", "bodyText": "{@link", "url": "https://github.com/line/armeria/pull/3177#discussion_r526836825", "createdAt": "2020-11-19T12:29:47Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeaderGetters.java", "diffHunk": "@@ -62,4 +66,25 @@\n      */\n     @Nullable\n     String authority();\n+\n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    List<LanguageRange> acceptLanguages();\n+\n+    /**\n+     * This matches the {@link Locale}s supported by the server to\n+     * the @{link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MzkyNjI1", "url": "https://github.com/line/armeria/pull/3177#pullrequestreview-534392625", "createdAt": "2020-11-19T12:32:23Z", "commit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMjozMjoyM1rOH2bubg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMjozMjoyM1rOH2bubg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzOTQwNg==", "bodyText": "Should this be exposed somewhere?", "url": "https://github.com/line/armeria/pull/3177#discussion_r526839406", "createdAt": "2020-11-19T12:32:23Z", "author": {"login": "tobias-"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -55,6 +62,9 @@\n     private static final String[] PROHIBITED_VALUE_CHAR_NAMES;\n     private static final char LAST_PROHIBITED_VALUE_CHAR;\n \n+    static final List<LanguageRange> ACCEPT_LANGUAGE_WILDCARD =\n+            ImmutableList.copyOf(LanguageRange.parse(\"*\"));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 29}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/f55e0a26a43cd6bca80af67af4212cf3d548ba7b", "committedDate": "2020-11-19T09:45:27Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}, "afterCommit": {"oid": "afdc7f95f09b874e043e77c26202d8ff06f9ea26", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/afdc7f95f09b874e043e77c26202d8ff06f9ea26", "committedDate": "2020-11-19T12:34:43Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "afdc7f95f09b874e043e77c26202d8ff06f9ea26", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/afdc7f95f09b874e043e77c26202d8ff06f9ea26", "committedDate": "2020-11-19T12:34:43Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}, "afterCommit": {"oid": "6c7dba53e30c6a201815774cbc4851aa74ab0a43", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/6c7dba53e30c6a201815774cbc4851aa74ab0a43", "committedDate": "2020-11-19T16:29:51Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c7dba53e30c6a201815774cbc4851aa74ab0a43", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/6c7dba53e30c6a201815774cbc4851aa74ab0a43", "committedDate": "2020-11-19T16:29:51Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}, "afterCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/43f6190b175beeed88e29e90d2841bc703b16de7", "committedDate": "2020-11-19T16:45:26Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0OTIzMzM4", "url": "https://github.com/line/armeria/pull/3177#pullrequestreview-534923338", "createdAt": "2020-11-19T22:52:46Z", "commit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMjo1Mjo0NlrOH21RRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQyMzowNzowM1rOH21qbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1NzkyNA==", "bodyText": "Could we use @Nullable like method and uri to reduce memory footprint?", "url": "https://github.com/line/armeria/pull/3177#discussion_r527257924", "createdAt": "2020-11-19T22:52:46Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeaders.java", "diffHunk": "@@ -16,16 +16,25 @@\n package com.linecorp.armeria.common;\n \n import java.net.URI;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Locale.LanguageRange;\n+import java.util.function.Supplier;\n \n import javax.annotation.Nullable;\n \n+import com.google.common.base.Suppliers;\n+\n @SuppressWarnings({ \"checkstyle:EqualsHashCode\", \"EqualsAndHashcode\" })\n final class DefaultRequestHeaders extends DefaultHttpHeaders implements RequestHeaders {\n \n     @Nullable\n     private HttpMethod method;\n     @Nullable\n     private URI uri;\n+    private final Supplier<List<LanguageRange>> acceptLanguage =\n+            Suppliers.memoize(super::acceptLanguages);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1ODUzNA==", "bodyText": "Should we distinguish the lack of accept-language header from accept-language: *? \ud83e\udd14", "url": "https://github.com/line/armeria/pull/3177#discussion_r527258534", "createdAt": "2020-11-19T22:54:14Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,31 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return HttpHeadersBase.ACCEPT_LANGUAGE_WILDCARD;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1OTA5Mg==", "bodyText": "Could accept Iterable<LanguageRange>?", "url": "https://github.com/line/armeria/pull/3177#discussion_r527259092", "createdAt": "2020-11-19T22:55:23Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +118,31 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        if (getters != null) {\n+            return getters.acceptLanguages();\n+        }\n+        return HttpHeadersBase.ACCEPT_LANGUAGE_WILDCARD;\n+    }\n+\n+    @Override\n+    public RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptLanguages) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1OTc3MA==", "bodyText": "That's a good question. If JDK doesn't provide this constant, how about adding armeria.common.util.LanguageRanges class that provides it, as well as other common ones?", "url": "https://github.com/line/armeria/pull/3177#discussion_r527259770", "createdAt": "2020-11-19T22:56:51Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -55,6 +62,9 @@\n     private static final String[] PROHIBITED_VALUE_CHAR_NAMES;\n     private static final char LAST_PROHIBITED_VALUE_CHAR;\n \n+    static final List<LanguageRange> ACCEPT_LANGUAGE_WILDCARD =\n+            ImmutableList.copyOf(LanguageRange.parse(\"*\"));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjgzOTQwNg=="}, "originalCommit": {"oid": "f55e0a26a43cd6bca80af67af4212cf3d548ba7b"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MDkwMA==", "bodyText": "This matches -> Matches", "url": "https://github.com/line/armeria/pull/3177#discussion_r527260900", "createdAt": "2020-11-19T22:59:26Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "diffHunk": "@@ -318,6 +321,31 @@ default MediaType contentType() {\n         return headers().contentType();\n     }\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    default List<LanguageRange> acceptLanguages() {\n+        return headers().acceptLanguages();\n+    }\n+\n+    /**\n+     * This matches the {@link Locale}s supported by the server to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2MTc3NA==", "bodyText": "Iterable could be more useful.", "url": "https://github.com/line/armeria/pull/3177#discussion_r527261774", "createdAt": "2020-11-19T23:00:53Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeadersBuilder.java", "diffHunk": "@@ -90,6 +92,13 @@ default RequestHeadersBuilder authority(Endpoint endpoint) {\n         return authority(endpoint.authority());\n     }\n \n+    /**\n+     * Sets the {@code \"accept-language\"} header.\n+     * @param acceptedLanguages the accepted languages.\n+     * @return {@code this}\n+     */\n+    RequestHeadersBuilder acceptLanguages(List<LanguageRange> acceptedLanguages);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2NDM2Ng==", "bodyText": "What should we do when we see a bad header? Raise an exception or silently ignore? Other methods, such as contentType(), ignore bad values. When all header values are invalid, should we treat it as ACCEPT_LANGUAGE_WILDCARD?", "url": "https://github.com/line/armeria/pull/3177#discussion_r527264366", "createdAt": "2020-11-19T23:07:03Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,6 +184,32 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        return acceptLanguages()\n+                .stream()\n+                .flatMap(it -> Locale.filter(ImmutableList.of(it), supportedLocales).stream())\n+                .findFirst()\n+                .orElse(null);\n+    }\n+\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            // No 'Accept-Language' header means accepting everything.\n+            return ACCEPT_LANGUAGE_WILDCARD;\n+        }\n+\n+        final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+        for (String acceptHeader : acceptHeaders) {\n+            acceptLanguages.addAll(LanguageRange.parse(acceptHeader));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7"}, "originalPosition": 56}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "43f6190b175beeed88e29e90d2841bc703b16de7", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/43f6190b175beeed88e29e90d2841bc703b16de7", "committedDate": "2020-11-19T16:45:26Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}, "afterCommit": {"oid": "bc4d7297421583cac41a8779a7ea1abc39da4cbf", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/bc4d7297421583cac41a8779a7ea1abc39da4cbf", "committedDate": "2020-11-20T08:18:13Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bc4d7297421583cac41a8779a7ea1abc39da4cbf", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/bc4d7297421583cac41a8779a7ea1abc39da4cbf", "committedDate": "2020-11-20T08:18:13Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}, "afterCommit": {"oid": "0475efbb7d5b8e2f983aee2fa7c1cae85d8d21c6", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/0475efbb7d5b8e2f983aee2fa7c1cae85d8d21c6", "committedDate": "2020-11-20T08:32:02Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0475efbb7d5b8e2f983aee2fa7c1cae85d8d21c6", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/0475efbb7d5b8e2f983aee2fa7c1cae85d8d21c6", "committedDate": "2020-11-20T08:32:02Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}, "afterCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/34b738ec4c9182305e5df22121662e133a20dc82", "committedDate": "2020-11-20T08:57:35Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NDQ1MDQ1", "url": "https://github.com/line/armeria/pull/3177#pullrequestreview-536445045", "createdAt": "2020-11-23T12:54:20Z", "commit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMjo1NDoyMFrOH4MM_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMzoxMTo1NVrOH4M08A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MjIzOA==", "bodyText": "Is it better to add varargs version? \ud83e\uddd0", "url": "https://github.com/line/armeria/pull/3177#discussion_r528682238", "createdAt": "2020-11-23T12:54:20Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeadersBuilder.java", "diffHunk": "@@ -90,6 +91,13 @@ default RequestHeadersBuilder authority(Endpoint endpoint) {\n         return authority(endpoint.authority());\n     }\n \n+    /**\n+     * Sets the {@code \"accept-language\"} header.\n+     * @param acceptedLanguages the accepted languages.\n+     * @return {@code this}\n+     */\n+    RequestHeadersBuilder acceptLanguages(Iterable<LanguageRange> acceptedLanguages);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MzEzMA==", "bodyText": "nit: Indent \ud83d\ude09\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 *     or if there is no header.\n          \n          \n            \n                 *         or if there is no header.", "url": "https://github.com/line/armeria/pull/3177#discussion_r528683130", "createdAt": "2020-11-23T12:55:44Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeaderGetters.java", "diffHunk": "@@ -62,4 +66,29 @@\n      */\n     @Nullable\n     String authority();\n+\n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client preferences.\n+     * @return All {@link LanguageRange}s of all matching headers or {@code null} if there is a parsing error\n+     *     or if there is no header.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MzcwOA==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return The best matching locale or null if no locale matches.\n          \n          \n            \n                 * @return the best matching {@link Locale} or {@code null} if no locale matches.", "url": "https://github.com/line/armeria/pull/3177#discussion_r528683708", "createdAt": "2020-11-23T12:56:43Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeaderGetters.java", "diffHunk": "@@ -62,4 +66,29 @@\n      */\n     @Nullable\n     String authority();\n+\n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client preferences.\n+     * @return All {@link LanguageRange}s of all matching headers or {@code null} if there is a parsing error\n+     *     or if there is no header.\n+     */\n+    @Nullable\n+    List<LanguageRange> acceptLanguages();\n+\n+    /**\n+     * Matches the {@link Locale}s supported by the server to\n+     * the {@link HttpHeaderNames#ACCEPT_LANGUAGE} and returns the best match\n+     * according to client preference. It does this via <s>Basic Filter</s>ing each\n+     * {@link LanguageRange} and picking the first match. This is the \"classic\"\n+     * algorithm described in\n+     * <a href=\"https://tools.ietf.org/html/rfc2616#section-14.4\">RFC2616 Accept-Language (obsoleted)</a>\n+     * and also referenced in <a href=\"https://tools.ietf.org/html/rfc7231#section-5.3.5\">RFC7231 Accept-Language</a>.\n+     * <p/>\n+     * See also {@link Locale#lookup} for another algorithm.\n+     * @param supportedLocales a {@link Collection} of locales supported by the server.\n+     * @return The best matching locale or null if no locale matches.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4NDM2NQ==", "bodyText": "Ditto", "url": "https://github.com/line/armeria/pull/3177#discussion_r528684365", "createdAt": "2020-11-23T12:57:48Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "diffHunk": "@@ -318,6 +321,31 @@ default MediaType contentType() {\n         return headers().contentType();\n     }\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    default List<LanguageRange> acceptLanguages() {\n+        return headers().acceptLanguages();\n+    }\n+\n+    /**\n+     * Matches the {@link Locale}s supported by the server to\n+     * the {@link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match\n+     * according to client preference. It does this via <s>Basic Filter</s>ing each\n+     * {@link LanguageRange} and picking the first match. This is the \"classic\"\n+     * algorithm described in\n+     * <a href=\"https://tools.ietf.org/html/rfc2616#section-14.4\">RFC2616 Accept-Language (obsoleted)</a>\n+     * and also referenced in <a href=\"https://tools.ietf.org/html/rfc7231#section-5.3.5\">RFC7231 Accept-Language</a>.\n+     * @param supportedLocales a {@link Collection} of locales supported by the server.\n+     * @return The best matching locale or null if no locale matches.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY5MDU3Ng==", "bodyText": "nit: Revert?", "url": "https://github.com/line/armeria/pull/3177#discussion_r528690576", "createdAt": "2020-11-23T13:08:46Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,11 +181,46 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        final List<LanguageRange> languageRanges = acceptLanguages();\n+        if (languageRanges == null) {\n+            return null;\n+        }\n+        return languageRanges\n+                .stream()\n+                .flatMap(it -> Locale.filter(ImmutableList.of(it), supportedLocales).stream())\n+                .findFirst()\n+                .orElse(null);\n+    }\n+\n+    @Nullable\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            return null;\n+        }\n+\n+        try {\n+            final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+            for (String acceptHeader : acceptHeaders) {\n+                acceptLanguages.addAll(LanguageRange.parse(acceptHeader));\n+            }\n+            acceptLanguages.sort(comparingDouble(LanguageRange::getWeight).reversed());\n+\n+            return ImmutableList.copyOf(acceptLanguages);\n+        } catch (IllegalArgumentException e) {\n+            // If any port of any of the headers is ill-formed\n+            return null;\n+        }\n+    }\n+\n     HttpMethod method() {\n         final String methodStr = get(HttpHeaderNames.METHOD);\n         checkState(methodStr != null, \":method header does not exist.\");\n         return HttpMethod.isSupported(methodStr) ? HttpMethod.valueOf(methodStr)\n-                                                 : HttpMethod.UNKNOWN;\n+                : HttpMethod.UNKNOWN;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY5MjQ2NA==", "bodyText": "Global comment: Could you use assertThat of Assert4J? We prefer Assert4J when asserting in tests.\nhttps://armeria.dev/community/developer-guide#use-assert4j-instead-of-junits-assertion-api", "url": "https://github.com/line/armeria/pull/3177#discussion_r528692464", "createdAt": "2020-11-23T13:11:55Z", "author": {"login": "ikhoon"}, "path": "core/src/test/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilderTest.java", "diffHunk": "@@ -142,6 +148,120 @@ void schemeFromSessionProtocol() {\n                 .isInstanceOf(IllegalArgumentException.class);\n     }\n \n+    @Test\n+    void testAcceptLanguageMultiHeader() {\n+        final RequestHeaders headers = RequestHeaders\n+                .builder()\n+                .path(\"/\")\n+                .method(HttpMethod.GET)\n+                .add(HttpHeaderNames.ACCEPT_LANGUAGE,\n+                        \"de-us ;q=0.9, *;q=0.8\",\n+                        \"en;q=0.95, en-US;q=0.98\"\n+                )\n+                .build();\n+        final List<LanguageRange> acceptLanguages = headers.acceptLanguages();\n+        assertEquals(\n+                ImmutableList.of(\n+                        new LanguageRange(\"en-US\", 0.98),\n+                        new LanguageRange(\"en\", 0.95),\n+                        new LanguageRange(\"de-us\", 0.9),\n+                        new LanguageRange(\"*\", 0.8)\n+                ),\n+                acceptLanguages\n+        );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c1a676bcb222d34b80e417fbd3d62b832a55d48", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/2c1a676bcb222d34b80e417fbd3d62b832a55d48", "committedDate": "2020-11-23T14:02:24Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/34b738ec4c9182305e5df22121662e133a20dc82", "committedDate": "2020-11-20T08:57:35Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}, "afterCommit": {"oid": "2c1a676bcb222d34b80e417fbd3d62b832a55d48", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/2c1a676bcb222d34b80e417fbd3d62b832a55d48", "committedDate": "2020-11-23T14:02:24Z", "message": "Add Accept-Language parsing and prioritizing\n\nMotivation:\n\nAccept-Language is a client supplied header detailing what locales the\nclient user prefers and the weight of the preference. It's really\nmostly useful to detect the default language of the site.\n\nModifications:\n\nAdded method `acceptLanguages()` and `getLocale(supportedLocales)` to\n`RoutingContext` and all it's subclasses.\n\nAdd a lazy init property for `acceptLanguages()` to avoid parsing\nunless needed.\n\nResult:\n\nCloses #3179"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877", "author": {"user": {"login": "ikhoon", "name": "Ikhun Um"}}, "url": "https://github.com/line/armeria/commit/e4a280c3d70a39b57889a44493ed69758ac42877", "committedDate": "2020-11-24T06:39:08Z", "message": "Format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MTE0Njgx", "url": "https://github.com/line/armeria/pull/3177#pullrequestreview-537114681", "createdAt": "2020-11-24T06:39:48Z", "commit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjE4ODE4", "url": "https://github.com/line/armeria/pull/3177#pullrequestreview-538218818", "createdAt": "2020-11-25T07:32:46Z", "commit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNzozMjo0N1rOH5mS_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNzozODoxMFrOH5mb_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE1ODMzMg==", "bodyText": "What would be the sensible behavior when acceptLanguages is empty? \ud83e\udd14", "url": "https://github.com/line/armeria/pull/3177#discussion_r530158332", "createdAt": "2020-11-25T07:32:47Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/DefaultRequestHeadersBuilder.java", "diffHunk": "@@ -112,4 +120,29 @@ public RequestHeadersBuilder authority(String authority) {\n         setters().authority(authority);\n         return this;\n     }\n+\n+    @Override\n+    @Nullable\n+    public List<LanguageRange> acceptLanguages() {\n+        final HttpHeadersBase getters = getters();\n+        return getters != null ? getters.acceptLanguages() : null;\n+    }\n+\n+    @Override\n+    public RequestHeadersBuilder acceptLanguages(Iterable<LanguageRange> acceptLanguages) {\n+        requireNonNull(acceptLanguages, \"acceptLanguages\");\n+        final String acceptLanguagesValue = Streams\n+                .stream(acceptLanguages)\n+                .map(it -> (it.getWeight() == 1.0d) ? it.getRange() : it.getRange() + \";q=\" + it.getWeight())\n+                .collect(Collectors.joining(\", \"));\n+        set(HttpHeaderNames.ACCEPT_LANGUAGE, acceptLanguagesValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE1OTA1OA==", "bodyText": "I still think we should accept Iterable<Locale> for users. We could convert it into a Collection when it's not.\n\nDitto for RequestHeaders\n\n\nWould you mind adding selectLocale(Locale...) as well? I know you don't really like it but all our methods provide a varargs version \ud83d\ude05 You can use ImmutableList.of().", "url": "https://github.com/line/armeria/pull/3177#discussion_r530159058", "createdAt": "2020-11-25T07:34:26Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequest.java", "diffHunk": "@@ -318,6 +321,32 @@ default MediaType contentType() {\n         return headers().contentType();\n     }\n \n+    /**\n+     * Returns a list of {@link LanguageRange}s that are specified in {@link HttpHeaderNames#ACCEPT_LANGUAGE}\n+     * in the order of client-side preferences. If the client does not send the header, this will contain only a\n+     * wild card {@link LanguageRange}.\n+     */\n+    @Nullable\n+    default List<LanguageRange> acceptLanguages() {\n+        return headers().acceptLanguages();\n+    }\n+\n+    /**\n+     * Matches the {@link Locale}s supported by the server to\n+     * the {@link HttpHeaderNames#ACCEPT_LANGUAGE} and returning the best match\n+     * according to client preference. It does this via <s>Basic Filter</s>ing each\n+     * {@link LanguageRange} and picking the first match. This is the \"classic\"\n+     * algorithm described in\n+     * <a href=\"https://tools.ietf.org/html/rfc2616#section-14.4\">RFC2616 Accept-Language (obsoleted)</a>\n+     * and also referenced in <a href=\"https://tools.ietf.org/html/rfc7231#section-5.3.5\">RFC7231 Accept-Language</a>.\n+     * @param supportedLocales a {@link Collection} of locales supported by the server.\n+     * @return The best matching {@link Locale} or {@code null} if no {@link Locale} matches.\n+     */\n+    @Nullable\n+    default Locale selectLocale(Collection<Locale> supportedLocales) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE2MDE1NA==", "bodyText": "How about adding now for consistency? \ud83d\ude4f You can use ImmutableList.of().", "url": "https://github.com/line/armeria/pull/3177#discussion_r530160154", "createdAt": "2020-11-25T07:36:53Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestHeadersBuilder.java", "diffHunk": "@@ -90,6 +91,13 @@ default RequestHeadersBuilder authority(Endpoint endpoint) {\n         return authority(endpoint.authority());\n     }\n \n+    /**\n+     * Sets the {@code \"accept-language\"} header.\n+     * @param acceptedLanguages the accepted languages.\n+     * @return {@code this}\n+     */\n+    RequestHeadersBuilder acceptLanguages(Iterable<LanguageRange> acceptedLanguages);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MjIzOA=="}, "originalCommit": {"oid": "34b738ec4c9182305e5df22121662e133a20dc82"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE2MDYzOQ==", "bodyText": "How about checking supportedLocales is empty before calling acceptLanguages()? If it's empty we don't need to parse the header.", "url": "https://github.com/line/armeria/pull/3177#discussion_r530160639", "createdAt": "2020-11-25T07:38:10Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/HttpHeadersBase.java", "diffHunk": "@@ -174,6 +181,41 @@ URI uri() {\n         }\n     }\n \n+    @Nullable\n+    List<LanguageRange> acceptLanguages() {\n+        final List<String> acceptHeaders = getAll(HttpHeaderNames.ACCEPT_LANGUAGE);\n+        if (acceptHeaders.isEmpty()) {\n+            return null;\n+        }\n+\n+        try {\n+            final List<LanguageRange> acceptLanguages = new ArrayList<>(4);\n+            for (String acceptHeader : acceptHeaders) {\n+                acceptLanguages.addAll(LanguageRange.parse(acceptHeader));\n+            }\n+            acceptLanguages.sort(comparingDouble(LanguageRange::getWeight).reversed());\n+\n+            return ImmutableList.copyOf(acceptLanguages);\n+        } catch (IllegalArgumentException e) {\n+            // If any port of any of the headers is ill-formed\n+            return null;\n+        }\n+    }\n+\n+    @Nullable\n+    Locale selectLocale(Collection<Locale> supportedLocales) {\n+        requireNonNull(supportedLocales, \"supportedLocales\");\n+        final List<LanguageRange> languageRanges = acceptLanguages();\n+        if (languageRanges == null || supportedLocales.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a280c3d70a39b57889a44493ed69758ac42877"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d197d43501d19a05d8830a4ba05dd8692a6d300", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/2d197d43501d19a05d8830a4ba05dd8692a6d300", "committedDate": "2020-11-25T09:32:47Z", "message": "Fix comments by @trustin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0936219f7d0dfead3cbd09e1c4a98d30e2a1b1b2", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/0936219f7d0dfead3cbd09e1c4a98d30e2a1b1b2", "committedDate": "2020-11-25T09:49:42Z", "message": "Fix more of trustins comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82e8f9da79015c54c8b204f638d0b32c2dac044d", "author": {"user": {"login": "tobias-", "name": "Sn\u014dwball"}}, "url": "https://github.com/line/armeria/commit/82e8f9da79015c54c8b204f638d0b32c2dac044d", "committedDate": "2020-11-25T09:53:15Z", "message": "Try to only use the same object as much as possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64f7aa7c926017d6fba06c623883907ea5eff389", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/64f7aa7c926017d6fba06c623883907ea5eff389", "committedDate": "2020-11-26T04:19:40Z", "message": "requireNonNull"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c2bc813a100384ca257713fa3e02c2ae8edd663", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/1c2bc813a100384ca257713fa3e02c2ae8edd663", "committedDate": "2020-11-26T04:22:10Z", "message": "requireNonNull"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "733d94fc5b7d6781936c347391c07dc0bb5fd565", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/733d94fc5b7d6781936c347391c07dc0bb5fd565", "committedDate": "2020-11-26T04:23:44Z", "message": "requireNonNull"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd6a62eaec553e895f8871002111893cbd3813a2", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/bd6a62eaec553e895f8871002111893cbd3813a2", "committedDate": "2020-11-26T04:26:07Z", "message": "Merge branch 'master' into accept_language_parsing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aec81c9513cffa67ed62dbf16e53ad348de9bed2", "author": {"user": {"login": "trustin", "name": "Trustin Lee"}}, "url": "https://github.com/line/armeria/commit/aec81c9513cffa67ed62dbf16e53ad348de9bed2", "committedDate": "2020-11-26T04:55:26Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MDMzODA3", "url": "https://github.com/line/armeria/pull/3177#pullrequestreview-539033807", "createdAt": "2020-11-26T06:55:23Z", "commit": {"oid": "aec81c9513cffa67ed62dbf16e53ad348de9bed2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzQ1Mzkx", "url": "https://github.com/line/armeria/pull/3177#pullrequestreview-540345391", "createdAt": "2020-11-28T05:57:32Z", "commit": {"oid": "aec81c9513cffa67ed62dbf16e53ad348de9bed2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4832, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}