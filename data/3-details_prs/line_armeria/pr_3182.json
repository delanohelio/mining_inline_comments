{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyMDQxNjI3", "number": 3182, "title": "Support io_uring", "bodyText": "This changeset adds support for Netty's experimental io_uring transport.\n\nAdded com.linecorp.armeria.transportType flag\nDeprecated com.linecorp.armeria.useEpoll flag in favor of transportType\nMade TransportType public API", "createdAt": "2020-11-16T23:41:14Z", "url": "https://github.com/line/armeria/pull/3182", "merged": true, "mergeCommit": {"oid": "bbc877f126fea3137c5fd86f9a2f2aa86310fdb8"}, "closed": true, "closedAt": "2020-11-26T03:37:47Z", "author": {"login": "imasahiro"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddNsQugH2gAyNTIyMDQxNjI3OjdkNmJkOTc4ZjBmZWZkMmY2NWZlN2Y0ZDEzNWU2NGI3YzljMjY1OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgJl9QgFqTUzODk1NDk2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7d6bd978f0fefd2f65fe7f4d135e64b7c9c26593", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/7d6bd978f0fefd2f65fe7f4d135e64b7c9c26593", "committedDate": "2020-11-16T23:38:09Z", "message": "Support io_uring"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTIyNTQz", "url": "https://github.com/line/armeria/pull/3182#pullrequestreview-531922543", "createdAt": "2020-11-17T00:10:16Z", "commit": {"oid": "7d6bd978f0fefd2f65fe7f4d135e64b7c9c26593"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMDoxMDoxN1rOH0eouQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMDoxMDoxN1rOH0eouQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc4OTk0NQ==", "bodyText": "useIoUring to follow the convention?", "url": "https://github.com/line/armeria/pull/3182#discussion_r524789945", "createdAt": "2020-11-17T00:10:17Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -168,6 +169,8 @@\n     private static final boolean HAS_WSLENV = System.getenv(\"WSLENV\") != null;\n     private static final boolean USE_EPOLL = getBoolean(\"useEpoll\", isEpollAvailable(),\n                                                         value -> isEpollAvailable() || !value);\n+    private static final boolean USE_IOURING = getBoolean(\"useIOUring\", false,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d6bd978f0fefd2f65fe7f4d135e64b7c9c26593"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1fc853c396ddd4597ef5540ec24cc4fda652fc3", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/c1fc853c396ddd4597ef5540ec24cc4fda652fc3", "committedDate": "2020-11-17T00:18:01Z", "message": "fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0d7e80affc3ee050db47e49626dac8983961d24", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/a0d7e80affc3ee050db47e49626dac8983961d24", "committedDate": "2020-11-17T01:05:52Z", "message": "Add Flags.defaultTransportType()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65bbf81a1e35b489d3ad465fa3362626198e1ba2", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/65bbf81a1e35b489d3ad465fa3362626198e1ba2", "committedDate": "2020-11-17T01:07:07Z", "message": "Merge branch 'master' into io_uring"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTcxNDEy", "url": "https://github.com/line/armeria/pull/3182#pullrequestreview-531971412", "createdAt": "2020-11-17T02:14:19Z", "commit": {"oid": "65bbf81a1e35b489d3ad465fa3362626198e1ba2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoxNDoxOVrOH0hsXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjoxODozMFrOH0hxEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0MDAyOA==", "bodyText": "Better removing default?", "url": "https://github.com/line/armeria/pull/3182#discussion_r524840028", "createdAt": "2020-11-17T02:14:19Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -482,11 +533,26 @@ public static String requestContextStorageProvider() {\n      *\n      * <p>This flag is enabled by default for supported platforms. Specify the\n      * {@code -Dcom.linecorp.armeria.useEpoll=false} JVM option to disable it.\n+     *\n+     * @deprecated Use {@link #defaultTransportType()} and {@code -Dcom.linecorp.armeria.transportType=epoll}.\n      */\n+    @Deprecated\n     public static boolean useEpoll() {\n         return USE_EPOLL;\n     }\n \n+    /**\n+     * Returns the {@link TransportType} that will be used for socket I/O in Armeria.\n+     *\n+     * <p>The default value of this flag is {@link #DEFAULT_TRANSPORT_TYPE_SPEC}, which retains\n+     * the transport type of socket I/O API which Armeria will be used.\n+     * Specify the {@code -Dcom.linecorp.armeria.transportType=<nio|epoll|io_uring>} JVM option to override\n+     * the default.</p>\n+     */\n+    public static TransportType defaultTransportType() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bbf81a1e35b489d3ad465fa3362626198e1ba2"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0MDU4NQ==", "bodyText": "How about removing _SPEC? It's just transport name.", "url": "https://github.com/line/armeria/pull/3182#discussion_r524840585", "createdAt": "2020-11-17T02:16:12Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -169,6 +171,22 @@\n     private static final boolean HAS_WSLENV = System.getenv(\"WSLENV\") != null;\n     private static final boolean USE_EPOLL = getBoolean(\"useEpoll\", isEpollAvailable(),\n                                                         value -> isEpollAvailable() || !value);\n+\n+    private static final String DEFAULT_TRANSPORT_TYPE_SPEC = USE_EPOLL ? \"epoll\" : \"nio\";\n+    private static final String TRANSPORT_TYPE_SPEC = getNormalized(\"transportType\",\n+                                                                    DEFAULT_TRANSPORT_TYPE_SPEC,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bbf81a1e35b489d3ad465fa3362626198e1ba2"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0MTIzMg==", "bodyText": "... this flag is {@code \"epoll\"} in Linux and {@code \"nio\"} for other operations systems.\nSpecify ...\n\n('... which retains' doesn't seem to add anything new, so I think we can remove it.)", "url": "https://github.com/line/armeria/pull/3182#discussion_r524841232", "createdAt": "2020-11-17T02:18:30Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -482,11 +533,26 @@ public static String requestContextStorageProvider() {\n      *\n      * <p>This flag is enabled by default for supported platforms. Specify the\n      * {@code -Dcom.linecorp.armeria.useEpoll=false} JVM option to disable it.\n+     *\n+     * @deprecated Use {@link #defaultTransportType()} and {@code -Dcom.linecorp.armeria.transportType=epoll}.\n      */\n+    @Deprecated\n     public static boolean useEpoll() {\n         return USE_EPOLL;\n     }\n \n+    /**\n+     * Returns the {@link TransportType} that will be used for socket I/O in Armeria.\n+     *\n+     * <p>The default value of this flag is {@link #DEFAULT_TRANSPORT_TYPE_SPEC}, which retains", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bbf81a1e35b489d3ad465fa3362626198e1ba2"}, "originalPosition": 113}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxOTc4NDgy", "url": "https://github.com/line/armeria/pull/3182#pullrequestreview-531978482", "createdAt": "2020-11-17T02:34:15Z", "commit": {"oid": "65bbf81a1e35b489d3ad465fa3362626198e1ba2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjozNDoxNVrOH0iD9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwMjozNDoxNVrOH0iD9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0NjA3MA==", "bodyText": "Is it better to use optionalImplementation?", "url": "https://github.com/line/armeria/pull/3182#discussion_r524846070", "createdAt": "2020-11-17T02:34:15Z", "author": {"login": "ikhoon"}, "path": "core/build.gradle", "diffHunk": "@@ -113,6 +113,7 @@ dependencies {\n     implementation \"io.netty:netty-transport-native-epoll:${managedVersions['io.netty:netty-transport-native-epoll']}:linux-x86_64\"\n     implementation 'io.netty:netty-tcnative-boringssl-static'\n     implementation 'io.netty:netty-handler-proxy'\n+    implementation \"io.netty.incubator:netty-incubator-transport-native-io_uring:${managedVersions['io.netty.incubator:netty-incubator-transport-native-io_uring']}:linux-x86_64\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65bbf81a1e35b489d3ad465fa3362626198e1ba2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e96b03bfb52f6e98bc9a003f0d84e24c4ff7d1e", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/3e96b03bfb52f6e98bc9a003f0d84e24c4ff7d1e", "committedDate": "2020-11-17T02:41:15Z", "message": "address comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b75ed474d84ee20e55bb1421f8ae32a594366b7a", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/b75ed474d84ee20e55bb1421f8ae32a594366b7a", "committedDate": "2020-11-17T02:42:41Z", "message": "make io_uring optionalImplementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/f8013ed7f6d31e56617650befba0686715e7dc77", "committedDate": "2020-11-18T08:43:32Z", "message": "fix checkstyle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e1512fdb55e3f5e54be56942ffff3dae437cf224", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/e1512fdb55e3f5e54be56942ffff3dae437cf224", "committedDate": "2020-11-17T03:25:09Z", "message": "fix checkstyle"}, "afterCommit": {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/f8013ed7f6d31e56617650befba0686715e7dc77", "committedDate": "2020-11-18T08:43:32Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDE2MDAz", "url": "https://github.com/line/armeria/pull/3182#pullrequestreview-534016003", "createdAt": "2020-11-19T01:39:26Z", "commit": {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMTozOToyNlrOH2JMFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwMTo1ODoyM1rOH2JkFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUzNTcwMw==", "bodyText": "can remove this line?", "url": "https://github.com/line/armeria/pull/3182#discussion_r526535703", "createdAt": "2020-11-19T01:39:26Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -384,9 +410,30 @@\n                     logger.info(\"/dev/epoll not available: ?\");\n                 }\n             }\n-        } else if (USE_EPOLL) {\n-            logger.info(\"Using /dev/epoll\");\n         }\n+        TransportType type = null;\n+        switch (TRANSPORT_TYPE_NAME) {\n+            case \"io_uring\":\n+                if (isIoUringAvailable()) {\n+                    logger.info(\"Using io_uring\");\n+                    type = TransportType.IO_URING;\n+                }\n+                // fallthrough\n+            case \"epoll\":\n+                if (isEpollAvailable() && type == null) {\n+                    logger.info(\"Using /dev/epoll\");\n+                    type = TransportType.EPOLL;\n+                }\n+                // fallthrough\n+            case \"nio\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU0MTg0NA==", "bodyText": "Shouldn't we access this IOUring class using reflection in case the dependency is not on the classpath when a user uses it?", "url": "https://github.com/line/armeria/pull/3182#discussion_r526541844", "createdAt": "2020-11-19T01:58:23Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -373,6 +391,14 @@\n     private static final boolean VALIDATE_HEADERS = getBoolean(\"validateHeaders\", true);\n \n     static {\n+        if (!isIoUringAvailable()) {\n+            final Throwable cause = IOUring.unavailabilityCause();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MTE0MjA1", "url": "https://github.com/line/armeria/pull/3182#pullrequestreview-534114205", "createdAt": "2020-11-19T06:28:10Z", "commit": {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNjoyODoxMFrOH2OeIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNjoyODoxMFrOH2OeIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYyMjI0Mg==", "bodyText": "Could we remove this method now that we can just use Flags.transportType()?", "url": "https://github.com/line/armeria/pull/3182#discussion_r526622242", "createdAt": "2020-11-19T06:28:10Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/common/util/TransportType.java", "diffHunk": "@@ -76,11 +84,7 @@\n      * Returns the available {@link TransportType}.\n      */\n     public static TransportType detectTransportType() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8d27aeb6684d57f8ac9acf0130942396a25615f", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/f8d27aeb6684d57f8ac9acf0130942396a25615f", "committedDate": "2020-11-20T02:16:51Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "259603ec3a46b316af5d3ad8af8b1cd146c31819", "author": {"user": {"login": "imasahiro", "name": "Masahiro Ide"}}, "url": "https://github.com/line/armeria/commit/259603ec3a46b316af5d3ad8af8b1cd146c31819", "committedDate": "2020-11-20T04:06:42Z", "message": "merge TransportType.isSupported(EventLoop) into isSupported(EventLoopGroup)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MjY2MTE1", "url": "https://github.com/line/armeria/pull/3182#pullrequestreview-538266115", "createdAt": "2020-11-25T08:44:32Z", "commit": {"oid": "259603ec3a46b316af5d3ad8af8b1cd146c31819"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4Mjc3NDQx", "url": "https://github.com/line/armeria/pull/3182#pullrequestreview-538277441", "createdAt": "2020-11-25T08:58:44Z", "commit": {"oid": "259603ec3a46b316af5d3ad8af8b1cd146c31819"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4OTU0OTY3", "url": "https://github.com/line/armeria/pull/3182#pullrequestreview-538954967", "createdAt": "2020-11-26T02:33:25Z", "commit": {"oid": "259603ec3a46b316af5d3ad8af8b1cd146c31819"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4843, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}