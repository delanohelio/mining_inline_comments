{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NjIyMTc4", "number": 3091, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoyMTowN1rOEri_Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoyMTowN1rOEri_Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDk3NDMwOnYy", "diffSide": "RIGHT", "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/text/TTextProtocol.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoyMTowN1rOHeX3DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMjozNTowNFrOHecYRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYxMDI1Mw==", "bodyText": "How about just using an ArrayList and updating the last element?", "url": "https://github.com/line/armeria/pull/3091#discussion_r501610253", "createdAt": "2020-10-08T10:21:07Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/text/TTextProtocol.java", "diffHunk": "@@ -717,6 +733,36 @@ private BaseContext getCurrentContext() {\n         return contextStack.peek();\n     }\n \n+    /**\n+     * Prepare the current parsing context for writing.\n+     */\n+    private void writeCurrentContext() {\n+        getCurrentContext().write();\n+        updateCurrentFieldName();\n+    }\n+\n+    /**\n+     * Prepare the current parsing context for reading.\n+     */\n+    private void readCurrentContext() {\n+        getCurrentContext().read();\n+        updateCurrentFieldName();\n+    }\n+\n+    /**\n+     * Update the current field name, if necessary.\n+     *\n+     * <p>After every read/write operation in {@link MapContext},\n+     * the field name should toggle between the map's key and value.</p>\n+     */\n+    private void updateCurrentFieldName() {\n+        if (getCurrentContext() instanceof MapContext) {\n+            currentFieldName.pop();\n+            final String suffix = getCurrentContext().isMapKey() ? MAP_KEY_SUFFIX : MAP_VALUE_SUFFIX;\n+            currentFieldName.push(currentFieldName.peek() + suffix);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14a411393cac7d052eb8228c6714ba02421c946b"}, "originalPosition": 448}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYzNjE1Mw==", "bodyText": "Thanks for the feedback!\nIn my opinion, using a Stack makes the code much cleaner, since we mostly care about the top 1 or 2 items.\nThis way, we don't have to worry about the suffix, with the exception of updateCurrentFieldName(). I was thinking of doing endsWith() on the last item here, with slicing and appending the new suffix, but it's a bit messier.\nThe current approach also handles the first nested map a bit nicer, since we don't need to setup the correct suffix when pushing to the stack (only handled by this method). This way, we only need to push the same field name again, the rest is handled in this method.\nExample:\n1. A\n2. A-> A   # readMapBegin() on L551\n3. A-> A$k # readCurrentContext() in readXXX()\n4. A-> A$v # readCurrentContext() in readXXX()\n...\n\nBut if you think using an ArrayList is better, I can change it! I can also only add the $k prefix in readMapBegin() and writeMapBegin(), since it might make debugging easier and there's one \"edge case\" less.\nEDIT: Thinking about it, keeping the A -> A case in readMapBegin() might be useful, if someone decides to add some additional logic that depends on the current actual field name being on the stack, before starting to handle the key.", "url": "https://github.com/line/armeria/pull/3091#discussion_r501636153", "createdAt": "2020-10-08T11:08:27Z", "author": {"login": "KarboniteKream"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/text/TTextProtocol.java", "diffHunk": "@@ -717,6 +733,36 @@ private BaseContext getCurrentContext() {\n         return contextStack.peek();\n     }\n \n+    /**\n+     * Prepare the current parsing context for writing.\n+     */\n+    private void writeCurrentContext() {\n+        getCurrentContext().write();\n+        updateCurrentFieldName();\n+    }\n+\n+    /**\n+     * Prepare the current parsing context for reading.\n+     */\n+    private void readCurrentContext() {\n+        getCurrentContext().read();\n+        updateCurrentFieldName();\n+    }\n+\n+    /**\n+     * Update the current field name, if necessary.\n+     *\n+     * <p>After every read/write operation in {@link MapContext},\n+     * the field name should toggle between the map's key and value.</p>\n+     */\n+    private void updateCurrentFieldName() {\n+        if (getCurrentContext() instanceof MapContext) {\n+            currentFieldName.pop();\n+            final String suffix = getCurrentContext().isMapKey() ? MAP_KEY_SUFFIX : MAP_VALUE_SUFFIX;\n+            currentFieldName.push(currentFieldName.peek() + suffix);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYxMDI1Mw=="}, "originalCommit": {"oid": "14a411393cac7d052eb8228c6714ba02421c946b"}, "originalPosition": 448}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY0NjMyOA==", "bodyText": "I think it's OK as it is. Please feel free to choose what's right for you.", "url": "https://github.com/line/armeria/pull/3091#discussion_r501646328", "createdAt": "2020-10-08T11:28:04Z", "author": {"login": "trustin"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/text/TTextProtocol.java", "diffHunk": "@@ -717,6 +733,36 @@ private BaseContext getCurrentContext() {\n         return contextStack.peek();\n     }\n \n+    /**\n+     * Prepare the current parsing context for writing.\n+     */\n+    private void writeCurrentContext() {\n+        getCurrentContext().write();\n+        updateCurrentFieldName();\n+    }\n+\n+    /**\n+     * Prepare the current parsing context for reading.\n+     */\n+    private void readCurrentContext() {\n+        getCurrentContext().read();\n+        updateCurrentFieldName();\n+    }\n+\n+    /**\n+     * Update the current field name, if necessary.\n+     *\n+     * <p>After every read/write operation in {@link MapContext},\n+     * the field name should toggle between the map's key and value.</p>\n+     */\n+    private void updateCurrentFieldName() {\n+        if (getCurrentContext() instanceof MapContext) {\n+            currentFieldName.pop();\n+            final String suffix = getCurrentContext().isMapKey() ? MAP_KEY_SUFFIX : MAP_VALUE_SUFFIX;\n+            currentFieldName.push(currentFieldName.peek() + suffix);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYxMDI1Mw=="}, "originalCommit": {"oid": "14a411393cac7d052eb8228c6714ba02421c946b"}, "originalPosition": 448}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4NDI5NA==", "bodyText": "Thanks. In this case, I'd prefer keeping Stack since the code is cleaner. \ud83d\ude47\u200d\u2642\ufe0f", "url": "https://github.com/line/armeria/pull/3091#discussion_r501684294", "createdAt": "2020-10-08T12:35:04Z", "author": {"login": "KarboniteKream"}, "path": "thrift0.13/src/main/java/com/linecorp/armeria/common/thrift/text/TTextProtocol.java", "diffHunk": "@@ -717,6 +733,36 @@ private BaseContext getCurrentContext() {\n         return contextStack.peek();\n     }\n \n+    /**\n+     * Prepare the current parsing context for writing.\n+     */\n+    private void writeCurrentContext() {\n+        getCurrentContext().write();\n+        updateCurrentFieldName();\n+    }\n+\n+    /**\n+     * Prepare the current parsing context for reading.\n+     */\n+    private void readCurrentContext() {\n+        getCurrentContext().read();\n+        updateCurrentFieldName();\n+    }\n+\n+    /**\n+     * Update the current field name, if necessary.\n+     *\n+     * <p>After every read/write operation in {@link MapContext},\n+     * the field name should toggle between the map's key and value.</p>\n+     */\n+    private void updateCurrentFieldName() {\n+        if (getCurrentContext() instanceof MapContext) {\n+            currentFieldName.pop();\n+            final String suffix = getCurrentContext().isMapKey() ? MAP_KEY_SUFFIX : MAP_VALUE_SUFFIX;\n+            currentFieldName.push(currentFieldName.peek() + suffix);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYxMDI1Mw=="}, "originalCommit": {"oid": "14a411393cac7d052eb8228c6714ba02421c946b"}, "originalPosition": 448}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1920, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}