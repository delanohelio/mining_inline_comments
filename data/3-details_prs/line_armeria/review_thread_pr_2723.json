{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5Mjk0ODU0", "number": 2723, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNzoxNDowM1rOD9REhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNzoyNDo1OVrOD9RRYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTY5NDE0OnYy", "diffSide": "RIGHT", "path": "it/context-storage/src/test/java/com/linecorp/armeria/common/CustomRequestContextStorageProvider.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNzoxNDowM1rOGWqJ4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNzoxOToxNFrOGWqS6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQxMjUxMg==", "bodyText": "Now we have a hook \ud83d\ude0e, could remove this and add a hook for counting?", "url": "https://github.com/line/armeria/pull/2723#discussion_r426412512", "createdAt": "2020-05-18T07:14:03Z", "author": {"login": "ikhoon"}, "path": "it/context-storage/src/test/java/com/linecorp/armeria/common/CustomRequestContextStorageProvider.java", "diffHunk": "@@ -48,32 +48,33 @@ static int popCalled() {\n \n     @Override\n     public RequestContextStorage newStorage() {\n-        return new RequestContextStorage() {\n-\n-            @Nullable\n-            @Override\n-            @SuppressWarnings(\"unchecked\")\n-            public <T extends RequestContext> T push(RequestContext toPush) {\n-                requireNonNull(toPush, \"toPush\");\n-                pushCalled.incrementAndGet();\n-                final InternalThreadLocalMap map = InternalThreadLocalMap.get();\n-                final RequestContext oldCtx = context.get(map);\n-                context.set(map, toPush);\n-                return (T) oldCtx;\n-            }\n-\n-            @Override\n-            public void pop(RequestContext current, @Nullable RequestContext toRestore) {\n-                popCalled.incrementAndGet();\n-                context.set(toRestore);\n-            }\n-\n-            @Nullable\n-            @Override\n-            @SuppressWarnings(\"unchecked\")\n-            public <T extends RequestContext> T currentOrNull() {\n-                return (T) context.get();\n-            }\n-        };\n+        return new CustomRequestContextStorage();\n+    }\n+\n+    static final class CustomRequestContextStorage implements RequestContextStorage {\n+        @Nullable\n+        @Override\n+        @SuppressWarnings(\"unchecked\")\n+        public <T extends RequestContext> T push(RequestContext toPush) {\n+            requireNonNull(toPush, \"toPush\");\n+            pushCalled.incrementAndGet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d56041a8db4dc50068dcc0bf3c8f5398f4970b47"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQxNDgyNw==", "bodyText": "Ah... ignore this review. This code is test code.\ud83d\ude05", "url": "https://github.com/line/armeria/pull/2723#discussion_r426414827", "createdAt": "2020-05-18T07:19:14Z", "author": {"login": "ikhoon"}, "path": "it/context-storage/src/test/java/com/linecorp/armeria/common/CustomRequestContextStorageProvider.java", "diffHunk": "@@ -48,32 +48,33 @@ static int popCalled() {\n \n     @Override\n     public RequestContextStorage newStorage() {\n-        return new RequestContextStorage() {\n-\n-            @Nullable\n-            @Override\n-            @SuppressWarnings(\"unchecked\")\n-            public <T extends RequestContext> T push(RequestContext toPush) {\n-                requireNonNull(toPush, \"toPush\");\n-                pushCalled.incrementAndGet();\n-                final InternalThreadLocalMap map = InternalThreadLocalMap.get();\n-                final RequestContext oldCtx = context.get(map);\n-                context.set(map, toPush);\n-                return (T) oldCtx;\n-            }\n-\n-            @Override\n-            public void pop(RequestContext current, @Nullable RequestContext toRestore) {\n-                popCalled.incrementAndGet();\n-                context.set(toRestore);\n-            }\n-\n-            @Nullable\n-            @Override\n-            @SuppressWarnings(\"unchecked\")\n-            public <T extends RequestContext> T currentOrNull() {\n-                return (T) context.get();\n-            }\n-        };\n+        return new CustomRequestContextStorage();\n+    }\n+\n+    static final class CustomRequestContextStorage implements RequestContextStorage {\n+        @Nullable\n+        @Override\n+        @SuppressWarnings(\"unchecked\")\n+        public <T extends RequestContext> T push(RequestContext toPush) {\n+            requireNonNull(toPush, \"toPush\");\n+            pushCalled.incrementAndGet();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQxMjUxMg=="}, "originalCommit": {"oid": "d56041a8db4dc50068dcc0bf3c8f5398f4970b47"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NTcyNzA3OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/common/RequestContextStorage.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNzoyNDo1OVrOGWqeGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwNzoyNDo1OVrOGWqeGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQxNzY5MQ==", "bodyText": "How about adding more warnings such as thread safety?", "url": "https://github.com/line/armeria/pull/2723#discussion_r426417691", "createdAt": "2020-05-18T07:24:59Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/common/RequestContextStorage.java", "diffHunk": "@@ -57,7 +63,17 @@\n  * }</pre>\n  */\n @UnstableApi\n-public interface RequestContextStorage {\n+public interface RequestContextStorage extends Unwrappable {\n+\n+    /**\n+     * Customizes the current {@link RequestContextStorage} by applying the specified {@link Function} to it.\n+     * This method is useful when you need to perform an additional operation when a {@link RequestContext}\n+     * is pushed or popped. However, keep in mind that all {@link RequestContextStorage} operations are\n+     * highly performance-sensitive operation and thus it's not a good idea to run a time-consuming task.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d56041a8db4dc50068dcc0bf3c8f5398f4970b47"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2629, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}