{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4OTc5Njcx", "number": 2429, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMDoxMDo0OFrODb3EXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNToyNzozNlrODcq-6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNTQwMzgxOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMDoxMDo0OFrOFjlmFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMDoxMDo0OFrOFjlmFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2MDQzOQ==", "bodyText": "Maybe better grouping with final boolean isSuccess;?", "url": "https://github.com/line/armeria/pull/2429#discussion_r372860439", "createdAt": "2020-01-30T10:10:48Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "diffHunk": "@@ -321,6 +323,7 @@ private void write(HttpObject o, boolean endOfStream) {\n                                 f.cause() instanceof ClosedChannelException &&\n                                 responseEncoder instanceof Http1ObjectEncoder;\n                 }\n+                final boolean isWritable = responseEncoder.isWritable(req.id(), req.streamId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00bec95c46ad456c360f19c1f18d25887a44ccb7"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNTQxNjk4OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMDoxNTowMlrOFjluKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMDoxNTowMlrOFjluKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2MjUwNg==", "bodyText": "Could be merged into the if (isSuccess) above, i.e.\nfinal ChannelFuture failedFuture;\nif (isSuccess) {\n    ...\n    if (isWritable) {\n        subscription.request(1);\n        return;\n    }\n\n    if (reqCtx.sessionProtocol().isMultiplex()) {\n        failedFuture = f.channel().newFailedFuture(ClosedPublisherException.get());\n    } else {\n        failedFuture = f.channel().newFailedFuture(ClosedSessionException.get());\n    }\n} else {\n    failedFuture = f;\n}", "url": "https://github.com/line/armeria/pull/2429#discussion_r372862506", "createdAt": "2020-01-30T10:15:02Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "diffHunk": "@@ -333,17 +336,28 @@ private void write(HttpObject o, boolean endOfStream) {\n                         reqCtx.log().whenComplete().thenAccept(reqCtx.accessLogWriter()::log);\n                     }\n \n-                    subscription.request(1);\n-                    return;\n+                    if (isWritable) {\n+                        subscription.request(1);\n+                        return;\n+                    }\n+                }\n+\n+                ChannelFuture failedFuture = f;\n+                if (isSuccess && !isWritable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00bec95c46ad456c360f19c1f18d25887a44ccb7"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwODc3NTQ5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwOTo0Mzo0NVrOFkGDAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwOTo0Mzo0NVrOFkGDAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM5MjEyOA==", "bodyText": "Oops, this is miss pushed. \ud83d\ude31  Let me revert this.", "url": "https://github.com/line/armeria/pull/2429#discussion_r373392128", "createdAt": "2020-01-31T09:43:45Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "diffHunk": "@@ -325,25 +328,43 @@ private void write(HttpObject o, boolean endOfStream) {\n                 // Write an access log if:\n                 // - every message has been sent successfully.\n                 // - any write operation is failed with a cause.\n+                final ChannelFuture failedFuture;\n                 if (isSuccess) {\n                     maybeLogFirstResponseBytesTransferred();\n \n+                    if (state == State.DONE && !endOfStream) {\n+                        // if state is DONE, the response should be ended with endOfStream.\n+                        return;\n+                    }\n+\n                     if (endOfStream && tryComplete()) {\n                         logBuilder().endResponse();\n+                        subscription.cancel();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e50413a047a118147f5a2b9eca1a83d80b20035"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMTA4OTUxOnYy", "diffSide": "LEFT", "path": "thrift/src/test/java/com/linecorp/armeria/it/metric/DropwizardMetricsIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQwNDozNDo0OFrOFkcV4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQwNTozNjozNlrOFkcffg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1NzQwOA==", "bodyText": "This is just gone?", "url": "https://github.com/line/armeria/pull/2429#discussion_r373757408", "createdAt": "2020-02-01T04:34:48Z", "author": {"login": "mauhiz"}, "path": "thrift/src/test/java/com/linecorp/armeria/it/metric/DropwizardMetricsIntegrationTest.java", "diffHunk": "@@ -72,16 +67,13 @@ protected void configure(ServerBuilder sb) throws Exception {\n     private static final ClientFactory clientFactory =\n             ClientFactory.builder().meterRegistry(registry).build();\n \n-    @AfterClass\n-    public static void closeClientFactory() {\n+    @AfterAll\n+    static void closeClientFactory() {\n         clientFactory.close();\n     }\n \n-    @Rule\n-    public final TestRule globalTimeout = new DisableOnDebug(new Timeout(30, TimeUnit.SECONDS));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f291e15d1570a982866672060184002bca9a8de0"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1NzUwOA==", "bodyText": "Now, we are using JUnit5 global timeout configurations. https://github.com/line/armeria/pull/2425/files#diff-9c2d5d92bbbb9e98c96cf3f21ecedf97", "url": "https://github.com/line/armeria/pull/2429#discussion_r373757508", "createdAt": "2020-02-01T04:37:17Z", "author": {"login": "ikhoon"}, "path": "thrift/src/test/java/com/linecorp/armeria/it/metric/DropwizardMetricsIntegrationTest.java", "diffHunk": "@@ -72,16 +67,13 @@ protected void configure(ServerBuilder sb) throws Exception {\n     private static final ClientFactory clientFactory =\n             ClientFactory.builder().meterRegistry(registry).build();\n \n-    @AfterClass\n-    public static void closeClientFactory() {\n+    @AfterAll\n+    static void closeClientFactory() {\n         clientFactory.close();\n     }\n \n-    @Rule\n-    public final TestRule globalTimeout = new DisableOnDebug(new Timeout(30, TimeUnit.SECONDS));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1NzQwOA=="}, "originalCommit": {"oid": "f291e15d1570a982866672060184002bca9a8de0"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1OTg3MA==", "bodyText": "oh, that is a nice feature!", "url": "https://github.com/line/armeria/pull/2429#discussion_r373759870", "createdAt": "2020-02-01T05:36:36Z", "author": {"login": "mauhiz"}, "path": "thrift/src/test/java/com/linecorp/armeria/it/metric/DropwizardMetricsIntegrationTest.java", "diffHunk": "@@ -72,16 +67,13 @@ protected void configure(ServerBuilder sb) throws Exception {\n     private static final ClientFactory clientFactory =\n             ClientFactory.builder().meterRegistry(registry).build();\n \n-    @AfterClass\n-    public static void closeClientFactory() {\n+    @AfterAll\n+    static void closeClientFactory() {\n         clientFactory.close();\n     }\n \n-    @Rule\n-    public final TestRule globalTimeout = new DisableOnDebug(new Timeout(30, TimeUnit.SECONDS));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc1NzQwOA=="}, "originalCommit": {"oid": "f291e15d1570a982866672060184002bca9a8de0"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMjEwNzM5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwMTowMTo0MFrOFkkhFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwMTowNzo1MFrOFkkkGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg5MTM1MQ==", "bodyText": "I realized that we might need this in HttpRequestSubscriber when we send more that one HttpData.", "url": "https://github.com/line/armeria/pull/2429#discussion_r373891351", "createdAt": "2020-02-03T01:01:40Z", "author": {"login": "minwoox"}, "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "diffHunk": "@@ -325,25 +328,41 @@ private void write(HttpObject o, boolean endOfStream) {\n                 // Write an access log if:\n                 // - every message has been sent successfully.\n                 // - any write operation is failed with a cause.\n+                final ChannelFuture failedFuture;\n                 if (isSuccess) {\n                     maybeLogFirstResponseBytesTransferred();\n \n+                    if (state == State.DONE && !endOfStream) {\n+                        // if state is DONE, the response should be ended with endOfStream.\n+                        return;\n+                    }\n+\n                     if (endOfStream && tryComplete()) {\n                         logBuilder().endResponse();\n                         reqCtx.log().whenComplete().thenAccept(reqCtx.accessLogWriter()::log);\n                     }\n \n-                    subscription.request(1);\n-                    return;\n+                    if (isWritable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f291e15d1570a982866672060184002bca9a8de0"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg5MjEyMg==", "bodyText": "Good point! Let me look into it. \ud83d\ude00", "url": "https://github.com/line/armeria/pull/2429#discussion_r373892122", "createdAt": "2020-02-03T01:07:50Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "diffHunk": "@@ -325,25 +328,41 @@ private void write(HttpObject o, boolean endOfStream) {\n                 // Write an access log if:\n                 // - every message has been sent successfully.\n                 // - any write operation is failed with a cause.\n+                final ChannelFuture failedFuture;\n                 if (isSuccess) {\n                     maybeLogFirstResponseBytesTransferred();\n \n+                    if (state == State.DONE && !endOfStream) {\n+                        // if state is DONE, the response should be ended with endOfStream.\n+                        return;\n+                    }\n+\n                     if (endOfStream && tryComplete()) {\n                         logBuilder().endResponse();\n                         reqCtx.log().whenComplete().thenAccept(reqCtx.accessLogWriter()::log);\n                     }\n \n-                    subscription.request(1);\n-                    return;\n+                    if (isWritable) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzg5MTM1MQ=="}, "originalCommit": {"oid": "f291e15d1570a982866672060184002bca9a8de0"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMzkwNTQ5OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNToyNjozNlrOFk1S_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNToyNjozNlrOFk1S_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE2NjI3MA==", "bodyText": "if -> If\ntransferred -> were transferred\nopen -> open.", "url": "https://github.com/line/armeria/pull/2429#discussion_r374166270", "createdAt": "2020-02-03T15:26:36Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "diffHunk": "@@ -289,6 +289,7 @@ public void onComplete() {\n     }\n \n     private void write(HttpObject o, boolean endOfStream) {\n+        // if the first bytes transferred, the stream must be open", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3769aebae7d7aa5406f836afddb72d5dbc6782f2"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMzkwOTU0OnYy", "diffSide": "RIGHT", "path": "core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxNToyNzozNlrOFk1VZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwMDoxMjoxN1rOFlEWQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE2Njg4NQ==", "bodyText": "Could you explain why?", "url": "https://github.com/line/armeria/pull/2429#discussion_r374166885", "createdAt": "2020-02-03T15:27:36Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java", "diffHunk": "@@ -297,6 +296,16 @@ private void write(HttpObject o, boolean endOfStream, boolean flush) {\n     }\n \n     private void write0(HttpObject o, boolean endOfStream, boolean flush) {\n+        // if the first bytes transferred, the stream must be open", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fc948e2dbc31ec409c737b4ec9d1ef6aac0b47b"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE3MTA0MQ==", "bodyText": "The reason why I'm asking this is because the comment itself simply explains what the code does. It does not add much to the code itself in my opinion.\nIf we think there's something more to explain about the code, it has to be more detailed than this.", "url": "https://github.com/line/armeria/pull/2429#discussion_r374171041", "createdAt": "2020-02-03T15:34:24Z", "author": {"login": "trustin"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java", "diffHunk": "@@ -297,6 +296,16 @@ private void write(HttpObject o, boolean endOfStream, boolean flush) {\n     }\n \n     private void write0(HttpObject o, boolean endOfStream, boolean flush) {\n+        // if the first bytes transferred, the stream must be open", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE2Njg4NQ=="}, "originalCommit": {"oid": "1fc948e2dbc31ec409c737b4ec9d1ef6aac0b47b"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDQxMjg2NA==", "bodyText": "I agree with your optinion. I will add the detail explanation about\n\nWhy I use loggedRequestFirstBytesTransferred to check stream condition\nWhen this method could be called even if the stream was closed.", "url": "https://github.com/line/armeria/pull/2429#discussion_r374412864", "createdAt": "2020-02-04T00:12:17Z", "author": {"login": "ikhoon"}, "path": "core/src/main/java/com/linecorp/armeria/client/HttpRequestSubscriber.java", "diffHunk": "@@ -297,6 +296,16 @@ private void write(HttpObject o, boolean endOfStream, boolean flush) {\n     }\n \n     private void write0(HttpObject o, boolean endOfStream, boolean flush) {\n+        // if the first bytes transferred, the stream must be open", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDE2Njg4NQ=="}, "originalCommit": {"oid": "1fc948e2dbc31ec409c737b4ec9d1ef6aac0b47b"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2948, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}