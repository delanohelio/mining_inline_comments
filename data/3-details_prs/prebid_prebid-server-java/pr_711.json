{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NzE2NTE4", "number": 711, "title": "Conversant adapter bug for apps", "bodyText": "Fix App and Site bug.", "createdAt": "2020-05-07T14:17:27Z", "url": "https://github.com/prebid/prebid-server-java/pull/711", "merged": true, "mergeCommit": {"oid": "e30210b10e996800f01f47fcc4e194fc18c0a956"}, "closed": true, "closedAt": "2020-07-16T14:41:45Z", "author": {"login": "apaliy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABce99K5AH2gAyNDE0NzE2NTE4OmNlM2QwZDAxMjhjYThhYTMxMTgzM2FjMDhhODM1NTIwOTViZGRiM2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1gQvdgH2gAyNDE0NzE2NTE4OjI0MGUyNTFkYzhkMjNmMjMyOGMzMjAwMGVkZDAwNzA3Zjc4ZWY4MjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ce3d0d0128ca8aa311833ac08a83552095bddb3c", "author": {"user": {"login": "apaliy", "name": "Andrew Paliy"}}, "url": "https://github.com/prebid/prebid-server-java/commit/ce3d0d0128ca8aa311833ac08a83552095bddb3c", "committedDate": "2020-05-07T14:14:50Z", "message": "sync from go version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NjcyODIw", "url": "https://github.com/prebid/prebid-server-java/pull/711#pullrequestreview-407672820", "createdAt": "2020-05-07T17:11:42Z", "commit": {"oid": "ce3d0d0128ca8aa311833ac08a83552095bddb3c"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzoxMTo0M1rOGSINlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzoxMTo0M1rOGSINlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2MjEwMQ==", "bodyText": "app id", "url": "https://github.com/prebid/prebid-server-java/pull/711#discussion_r421662101", "createdAt": "2020-05-07T17:11:43Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "diffHunk": "@@ -119,38 +118,49 @@ private BidRequest createBidRequest(BidRequest bidRequest, List<BidderError> err\n         if (modifiedImps.isEmpty()) {\n             throw new PreBidException(\"No valid impressions\");\n         }\n+        validateSiteAppId(extSiteId, bidRequest.getSite(), bidRequest.getApp());\n \n         final BidRequest.BidRequestBuilder requestBuilder = bidRequest.toBuilder()\n                 .imp(modifiedImps);\n \n         if (site != null) {\n-            requestBuilder.site(site.toBuilder().id(extSiteId).mobile(extMobile).build());\n+            if (StringUtils.isEmpty(site.getId()) || extMobile != null) {\n+                final String siteId = ObjectUtils.defaultIfNull(site.getId(), extSiteId);\n+                requestBuilder.site(site.toBuilder().id(siteId).mobile(extMobile).build());\n+            }\n         } else if (app != null) {\n-            requestBuilder.app(app.toBuilder().id(extSiteId).build());\n+            if (StringUtils.isEmpty(app.getId())) {\n+                requestBuilder.app(app.toBuilder().id(extSiteId).build());\n+            }\n         }\n \n         return requestBuilder.build();\n     }\n \n+    private void validateSiteAppId(String extSiteId, Site site, App app) {\n+        if (site != null && StringUtils.isEmpty(site.getId()) && StringUtils.isEmpty(extSiteId)) {\n+            throw new PreBidException(\"Missing site id\");\n+        }\n+\n+        if (app != null && StringUtils.isEmpty(app.getId()) && StringUtils.isEmpty(extSiteId)) {\n+            throw new PreBidException(\"Missing site id\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3d0d0128ca8aa311833ac08a83552095bddb3c"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4MDg2NTg5", "url": "https://github.com/prebid/prebid-server-java/pull/711#pullrequestreview-408086589", "createdAt": "2020-05-08T08:30:24Z", "commit": {"oid": "ce3d0d0128ca8aa311833ac08a83552095bddb3c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODozMDoyNFrOGSd5aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODozODowNlrOGSeG_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAxNzM4NQ==", "bodyText": "We can use declared site & app vars.", "url": "https://github.com/prebid/prebid-server-java/pull/711#discussion_r422017385", "createdAt": "2020-05-08T08:30:24Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "diffHunk": "@@ -119,38 +118,49 @@ private BidRequest createBidRequest(BidRequest bidRequest, List<BidderError> err\n         if (modifiedImps.isEmpty()) {\n             throw new PreBidException(\"No valid impressions\");\n         }\n+        validateSiteAppId(extSiteId, bidRequest.getSite(), bidRequest.getApp());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3d0d0128ca8aa311833ac08a83552095bddb3c"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAxNzkxOA==", "bodyText": "No need for separate variable here.", "url": "https://github.com/prebid/prebid-server-java/pull/711#discussion_r422017918", "createdAt": "2020-05-08T08:31:35Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "diffHunk": "@@ -119,38 +118,49 @@ private BidRequest createBidRequest(BidRequest bidRequest, List<BidderError> err\n         if (modifiedImps.isEmpty()) {\n             throw new PreBidException(\"No valid impressions\");\n         }\n+        validateSiteAppId(extSiteId, bidRequest.getSite(), bidRequest.getApp());\n \n         final BidRequest.BidRequestBuilder requestBuilder = bidRequest.toBuilder()\n                 .imp(modifiedImps);\n \n         if (site != null) {\n-            requestBuilder.site(site.toBuilder().id(extSiteId).mobile(extMobile).build());\n+            if (StringUtils.isEmpty(site.getId()) || extMobile != null) {\n+                final String siteId = ObjectUtils.defaultIfNull(site.getId(), extSiteId);\n+                requestBuilder.site(site.toBuilder().id(siteId).mobile(extMobile).build());\n+            }\n         } else if (app != null) {\n-            requestBuilder.app(app.toBuilder().id(extSiteId).build());\n+            if (StringUtils.isEmpty(app.getId())) {\n+                requestBuilder.app(app.toBuilder().id(extSiteId).build());\n+            }\n         }\n \n         return requestBuilder.build();\n     }\n \n+    private void validateSiteAppId(String extSiteId, Site site, App app) {\n+        if (site != null && StringUtils.isEmpty(site.getId()) && StringUtils.isEmpty(extSiteId)) {\n+            throw new PreBidException(\"Missing site id\");\n+        }\n+\n+        if (app != null && StringUtils.isEmpty(app.getId()) && StringUtils.isEmpty(extSiteId)) {\n+            throw new PreBidException(\"Missing site id\");\n+        }\n+    }\n+\n     private static void validateImp(Imp imp) {\n         if (imp.getBanner() == null && imp.getVideo() == null) {\n             throw new PreBidException(String.format(\"Invalid MediaType. Conversant supports only Banner and Video. \"\n                     + \"Ignoring ImpID=%s\", imp.getId()));\n         }\n     }\n \n-    private ExtImpConversant parseAndValidateImpExt(Imp imp, boolean hasSite) {\n+    private ExtImpConversant parseImpExt(Imp imp) {\n         final ExtImpConversant extImpConversant;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3d0d0128ca8aa311833ac08a83552095bddb3c"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAyMDg2MA==", "bodyText": "This and app variable can be declared right before validateSiteAppId(...) method, since they are used further.", "url": "https://github.com/prebid/prebid-server-java/pull/711#discussion_r422020860", "createdAt": "2020-05-08T08:38:06Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "diffHunk": "@@ -93,22 +94,20 @@ public ConversantBidder(String endpointUrl, JacksonMapper mapper) {\n     }\n \n     private BidRequest createBidRequest(BidRequest bidRequest, List<BidderError> errors) {\n-        final App app = bidRequest.getApp();\n-        if (app != null && StringUtils.isBlank(app.getId())) {\n-            throw new PreBidException(\"Missing app id\");\n-        }\n-\n         final List<Imp> modifiedImps = new ArrayList<>();\n         Integer extMobile = null;\n         String extSiteId = null;\n         final Site site = bidRequest.getSite();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3d0d0128ca8aa311833ac08a83552095bddb3c"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cc2802dd4eb13568d2a2476925715ebd67d2174", "author": {"user": {"login": "apaliy", "name": "Andrew Paliy"}}, "url": "https://github.com/prebid/prebid-server-java/commit/9cc2802dd4eb13568d2a2476925715ebd67d2174", "committedDate": "2020-05-12T08:27:30Z", "message": "PR fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2ODY5MTQ3", "url": "https://github.com/prebid/prebid-server-java/pull/711#pullrequestreview-416869147", "createdAt": "2020-05-22T12:24:19Z", "commit": {"oid": "9cc2802dd4eb13568d2a2476925715ebd67d2174"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMjAyODU2", "url": "https://github.com/prebid/prebid-server-java/pull/711#pullrequestreview-420202856", "createdAt": "2020-05-28T15:00:41Z", "commit": {"oid": "9cc2802dd4eb13568d2a2476925715ebd67d2174"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09815bb2aa92b9a1795f572cd5ae6a8e91849ade", "author": {"user": {"login": "rpanchyk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/09815bb2aa92b9a1795f572cd5ae6a8e91849ade", "committedDate": "2020-07-16T14:28:58Z", "message": "Merge branch 'master' into conversant-app-bug-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "240e251dc8d23f2328c32000edd00707f78ef825", "author": {"user": {"login": "rpanchyk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/240e251dc8d23f2328c32000edd00707f78ef825", "committedDate": "2020-07-16T14:39:19Z", "message": "Merge branch 'master' into conversant-app-bug-fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3173, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}