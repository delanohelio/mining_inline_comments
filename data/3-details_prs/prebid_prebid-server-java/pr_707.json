{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzNDUyNDEz", "number": 707, "title": "Resolve bidder aliases using aliases defined in request and bidder catalog when logging metrics", "bodyText": "", "createdAt": "2020-05-05T11:16:35Z", "url": "https://github.com/prebid/prebid-server-java/pull/707", "merged": true, "mergeCommit": {"oid": "a794454d7927913888887cf7a4e122c2ac2160f8"}, "closed": true, "closedAt": "2020-08-03T12:22:29Z", "author": {"login": "schernysh"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceR2vJgH2gAyNDEzNDUyNDEzOmNhNjBhODc0YTI1MjlhMmZhZmNhOTFmOTIyMmU4Mzg0OGM5YzRiMjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7RE-XAFqTQ1OTk4MDM2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ca60a874a2529a2fafca91f9222e83848c9c4b28", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/ca60a874a2529a2fafca91f9222e83848c9c4b28", "committedDate": "2020-05-05T10:51:59Z", "message": "Resolve bidder aliases using aliases defined in request and bidder catalog when logging metrics"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb0066aa522efb80c62a1b4d0410dcd6d75e2d14", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/cb0066aa522efb80c62a1b4d0410dcd6d75e2d14", "committedDate": "2020-05-05T10:51:59Z", "message": "Move vendor id resolving logic to BidderAliases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NzkwMDgw", "url": "https://github.com/prebid/prebid-server-java/pull/707#pullrequestreview-405790080", "createdAt": "2020-05-05T13:31:51Z", "commit": {"oid": "cb0066aa522efb80c62a1b4d0410dcd6d75e2d14"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMzozMTo1MVrOGQphsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMzo0NDowNlrOGQqEvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDExMDc2OA==", "bodyText": "Minor. Consider moving aliases as class field with default initialization in setUp().", "url": "https://github.com/prebid/prebid-server-java/pull/707#discussion_r420110768", "createdAt": "2020-05-05T13:31:51Z", "author": {"login": "rpanchyk"}, "path": "src/test/java/org/prebid/server/auction/BidderAliasesTest.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package org.prebid.server.auction;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnit;\n+import org.mockito.junit.MockitoRule;\n+import org.prebid.server.bidder.BidderCatalog;\n+\n+import static java.util.Collections.singletonMap;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.BDDMockito.given;\n+import static org.mockito.Mockito.verifyZeroInteractions;\n+\n+public class BidderAliasesTest {\n+\n+    @Rule\n+    public final MockitoRule mockitoRule = MockitoJUnit.rule();\n+\n+    @Mock\n+    private BidderCatalog bidderCatalog;\n+\n+    @Before\n+    public void setUp() {\n+        given(bidderCatalog.isActive(anyString())).willReturn(true);\n+    }\n+\n+    @Test\n+    public void isAliasDefinedShouldQueryCatalogWhenNoAliasesInRequest() {\n+        // given\n+        given(bidderCatalog.isAlias(anyString())).willReturn(true);\n+\n+        final BidderAliases aliases = BidderAliases.of(bidderCatalog);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb0066aa522efb80c62a1b4d0410dcd6d75e2d14"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDExOTc0Mg==", "bodyText": "Just to think. Do we really resolving alias here?\nm/b it is better to name like resolveBidderViaCatalog(...).\ni can speak crazy, but just consider.", "url": "https://github.com/prebid/prebid-server-java/pull/707#discussion_r420119742", "createdAt": "2020-05-05T13:44:06Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/auction/BidderAliases.java", "diffHunk": "@@ -1,37 +1,64 @@\n package org.prebid.server.auction;\n \n import org.apache.commons.lang3.ObjectUtils;\n+import org.prebid.server.bidder.BidderCatalog;\n \n import java.util.Collections;\n import java.util.Map;\n+import java.util.Objects;\n \n /**\n  * Represents aliases configured for bidders - configuration might come in OpenRTB request but not limited to it.\n  */\n public class BidderAliases {\n \n-    private Map<String, String> aliasToBidder;\n+    private final Map<String, String> aliasToBidder;\n \n-    private Map<String, Integer> aliasToVendorId;\n+    private final Map<String, Integer> aliasToVendorId;\n+\n+    private final BidderCatalog bidderCatalog;\n+\n+    private BidderAliases(\n+            Map<String, String> aliasToBidder, Map<String, Integer> aliasToVendorId, BidderCatalog bidderCatalog) {\n \n-    private BidderAliases(Map<String, String> aliasToBidder, Map<String, Integer> aliasToVendorId) {\n         this.aliasToBidder = ObjectUtils.firstNonNull(aliasToBidder, Collections.emptyMap());\n         this.aliasToVendorId = ObjectUtils.firstNonNull(aliasToVendorId, Collections.emptyMap());\n+        this.bidderCatalog = Objects.requireNonNull(bidderCatalog);\n+    }\n+\n+    public static BidderAliases of(\n+            Map<String, String> aliasToBidder, Map<String, Integer> aliasToVendorId, BidderCatalog bidderCatalog) {\n+\n+        return new BidderAliases(aliasToBidder, aliasToVendorId, bidderCatalog);\n     }\n \n-    public static BidderAliases of(Map<String, String> aliasToBidder, Map<String, Integer> aliasToVendorId) {\n-        return new BidderAliases(aliasToBidder, aliasToVendorId);\n+    public static BidderAliases of(BidderCatalog bidderCatalog) {\n+        return new BidderAliases(null, null, bidderCatalog);\n     }\n \n     public boolean isAliasDefined(String alias) {\n-        return aliasToBidder.containsKey(alias);\n+        return aliasToBidder.containsKey(alias) || bidderCatalog.isAlias(alias);\n     }\n \n     public String resolveBidder(String aliasOrBidder) {\n-        return aliasToBidder.getOrDefault(aliasOrBidder, aliasOrBidder);\n+        return aliasToBidder.containsKey(aliasOrBidder)\n+                ? aliasToBidder.get(aliasOrBidder)\n+                : ObjectUtils.firstNonNull(resolveAliasViaCatalog(aliasOrBidder), aliasOrBidder);\n     }\n \n     public Integer resolveAliasVendorId(String alias) {\n-        return aliasToVendorId.get(alias);\n+        return aliasToVendorId.containsKey(alias)\n+                ? aliasToVendorId.get(alias)\n+                : resolveAliasVendorIdViaCatalog(alias);\n+    }\n+\n+    private String resolveAliasViaCatalog(String aliasOrBidder) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb0066aa522efb80c62a1b4d0410dcd6d75e2d14"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b35bad88ad2f961114a9166902646c2708f75a9f", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/b35bad88ad2f961114a9166902646c2708f75a9f", "committedDate": "2020-05-05T13:49:12Z", "message": "Rename method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1ODE3Nzk1", "url": "https://github.com/prebid/prebid-server-java/pull/707#pullrequestreview-405817795", "createdAt": "2020-05-05T14:01:17Z", "commit": {"oid": "b35bad88ad2f961114a9166902646c2708f75a9f"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00651d0251d9e5beeede79e3448d38d48311c68e", "author": {"user": {"login": "rpanchyk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/00651d0251d9e5beeede79e3448d38d48311c68e", "committedDate": "2020-06-25T13:35:42Z", "message": "Merge branch 'master' into metrics-for-aliases-fix\n\n# Conflicts:\n#\tsrc/main/java/org/prebid/server/auction/PrivacyEnforcementService.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d9298d0ba067fd91ae2eea788244ebb6f5eed28", "author": {"user": {"login": "rpanchyk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/6d9298d0ba067fd91ae2eea788244ebb6f5eed28", "committedDate": "2020-08-03T12:12:26Z", "message": "Merge branch 'master' into metrics-for-aliases-fix\n\n# Conflicts:\n#\tsrc/main/java/org/prebid/server/auction/ExchangeService.java\n#\tsrc/test/java/org/prebid/server/auction/PrivacyEnforcementServiceTest.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTgwMzY3", "url": "https://github.com/prebid/prebid-server-java/pull/707#pullrequestreview-459980367", "createdAt": "2020-08-03T12:21:26Z", "commit": {"oid": "6d9298d0ba067fd91ae2eea788244ebb6f5eed28"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3168, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}