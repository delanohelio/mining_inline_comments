{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3ODMxNDE1", "number": 687, "title": "Targeting attribute truncation", "bodyText": "Issue #1266", "createdAt": "2020-04-23T10:40:47Z", "url": "https://github.com/prebid/prebid-server-java/pull/687", "merged": true, "mergeCommit": {"oid": "d7c10c27832b91eb1ed7050314cdb79797efc7e6"}, "closed": true, "closedAt": "2020-06-10T06:56:53Z", "author": {"login": "apaliy"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaIrwkgH2gAyNDA3ODMxNDE1OjQzY2U5OTEwMDM5MDE0OWEzNWY5ZGNjMmVkOGIzZGQyMGIzMDQzMmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcp0EFTAFqTQyNzc1OTI3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "43ce99100390149a35f9dcc2ed8b3dd20b30432e", "author": {"user": {"login": "apaliy", "name": "Andrew Paliy"}}, "url": "https://github.com/prebid/prebid-server-java/commit/43ce99100390149a35f9dcc2ed8b3dd20b30432e", "committedDate": "2020-04-22T13:55:09Z", "message": "Ad Server Targeting attribute truncation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5f9ab224962ee8187694aacd709157ad3f53e3d", "author": {"user": {"login": "apaliy", "name": "Andrew Paliy"}}, "url": "https://github.com/prebid/prebid-server-java/commit/b5f9ab224962ee8187694aacd709157ad3f53e3d", "committedDate": "2020-04-23T10:39:13Z", "message": "variable name change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5def2aab654a635c4fa7b72138506876fae79bb2", "author": {"user": {"login": "apaliy", "name": "Andrew Paliy"}}, "url": "https://github.com/prebid/prebid-server-java/commit/5def2aab654a635c4fa7b72138506876fae79bb2", "committedDate": "2020-04-23T11:15:10Z", "message": "test fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d584a9d73ef42d60c93ae5f451d3b1f9f63364e", "author": {"user": {"login": "apaliy", "name": "Andrew Paliy"}}, "url": "https://github.com/prebid/prebid-server-java/commit/3d584a9d73ef42d60c93ae5f451d3b1f9f63364e", "committedDate": "2020-04-23T12:01:21Z", "message": "tests added"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODE4NTE1", "url": "https://github.com/prebid/prebid-server-java/pull/687#pullrequestreview-399818515", "createdAt": "2020-04-24T10:14:55Z", "commit": {"oid": "3d584a9d73ef42d60c93ae5f451d3b1f9f63364e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDoxNDo1NVrOGLQtkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDoxNzo0NlrOGLQ0SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2MTMzMQ==", "bodyText": "extract method", "url": "https://github.com/prebid/prebid-server-java/pull/687#discussion_r414461331", "createdAt": "2020-04-24T10:14:55Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/auction/TargetingKeywordsCreator.java", "diffHunk": "@@ -249,7 +257,13 @@ void put(String prefix, String value) {\n         private List<String> createKeys(String prefix) {\n             final List<String> keys = new ArrayList<>(2);\n             if (includeBidderKeys && !excludedBidderKeys.contains(prefix)) {\n-                keys.add(String.format(\"%s_%s\", prefix, bidder));\n+                final String targetKey = String.format(\"%s_%s\", prefix, bidder);\n+                if (truncateAttrChars != null && !truncateAttrChars.equals(0)\n+                        && targetKey.length() >= truncateAttrChars) {\n+                    keys.add(targetKey.substring(0, truncateAttrChars));\n+                } else {\n+                    keys.add(targetKey);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d584a9d73ef42d60c93ae5f451d3b1f9f63364e"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2MzA0OA==", "bodyText": "this is redundant", "url": "https://github.com/prebid/prebid-server-java/pull/687#discussion_r414463048", "createdAt": "2020-04-24T10:17:46Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/handler/AuctionHandler.java", "diffHunk": "@@ -402,12 +405,16 @@ private static PreBidResponse mergeBidsWithCacheResults(PreBidResponse preBidRes\n      * The bids are sorted by cpm to find the highest bid.\n      * The ad server targeting keywords are added to all bids, with specific keywords for the highest bid.\n      */\n-    private static PreBidResponse addTargetingKeywords(PreBidRequest preBidRequest, Account account,\n+    private PreBidResponse addTargetingKeywords(PreBidRequest preBidRequest, Account account,\n                                                        PreBidResponse preBidResponse) {\n         final Integer sortBids = preBidRequest.getSortBids();\n         if (sortBids != null && sortBids == 1) {\n+            final Integer truncateAttrChars = ObjectUtils.firstNonNull(account.getTruncateTargetAttr(),\n+                    preBidRequest.getMaxKeyLength(), this.truncateTargetingAttrMaxChars);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d584a9d73ef42d60c93ae5f451d3b1f9f63364e"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODI3MTQ4", "url": "https://github.com/prebid/prebid-server-java/pull/687#pullrequestreview-399827148", "createdAt": "2020-04-24T10:28:22Z", "commit": {"oid": "3d584a9d73ef42d60c93ae5f451d3b1f9f63364e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDoyODoyMlrOGLRM0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMDoyODoyMlrOGLRM0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2OTMzMA==", "bodyText": "@rpanchyk\nIs it ok to perform validation in the configuration ?", "url": "https://github.com/prebid/prebid-server-java/pull/687#discussion_r414469330", "createdAt": "2020-04-24T10:28:22Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/spring/config/ServiceConfiguration.java", "diffHunk": "@@ -529,9 +529,16 @@ BidResponseCreator bidResponseCreator(\n             BidderCatalog bidderCatalog,\n             EventsService eventsService,\n             StoredRequestProcessor storedRequestProcessor,\n+            @Value(\"${settings.targeting.truncate-attr-chars}\") Integer truncateTargetingAttrMaxChars,\n             JacksonMapper mapper) {\n \n-        return new BidResponseCreator(cacheService, bidderCatalog, eventsService, storedRequestProcessor, mapper);\n+        if (truncateTargetingAttrMaxChars != null\n+                && (truncateTargetingAttrMaxChars < 0 || truncateTargetingAttrMaxChars > 255)) {\n+            throw new IllegalArgumentException(\n+                    \"application.yaml settings.targeting.truncate-attr-chars value must be from 0 to 225 or null\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d584a9d73ef42d60c93ae5f451d3b1f9f63364e"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "223e08e730529e16ac3ef5d37cc70aacd07af8fd", "author": {"user": {"login": "apaliy", "name": "Andrew Paliy"}}, "url": "https://github.com/prebid/prebid-server-java/commit/223e08e730529e16ac3ef5d37cc70aacd07af8fd", "committedDate": "2020-04-24T10:56:03Z", "message": "PR changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODQ3MTg3", "url": "https://github.com/prebid/prebid-server-java/pull/687#pullrequestreview-399847187", "createdAt": "2020-04-24T11:01:25Z", "commit": {"oid": "223e08e730529e16ac3ef5d37cc70aacd07af8fd"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5ODUxNjM3", "url": "https://github.com/prebid/prebid-server-java/pull/687#pullrequestreview-399851637", "createdAt": "2020-04-24T11:08:57Z", "commit": {"oid": "223e08e730529e16ac3ef5d37cc70aacd07af8fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMTowODo1N1rOGLSlNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQxMTowODo1N1rOGLSlNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ5MTk1OQ==", "bodyText": "@rpanchyk notice that default value for rubicon need to be 20", "url": "https://github.com/prebid/prebid-server-java/pull/687#discussion_r414491959", "createdAt": "2020-04-24T11:08:57Z", "author": {"login": "DGarbar"}, "path": "src/main/resources/application.yaml", "diffHunk": "@@ -76,6 +76,8 @@ settings:\n     ttl-seconds: 360\n     notification-endpoints-enabled: false\n     account-invalidation-enabled: true\n+  targeting:\n+    truncate-attr-chars: 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "223e08e730529e16ac3ef5d37cc70aacd07af8fd"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f4866f741fce8dc0f84ecdfb809af0391fdfb6a", "author": {"user": {"login": "apaliy", "name": "Andrew Paliy"}}, "url": "https://github.com/prebid/prebid-server-java/commit/4f4866f741fce8dc0f84ecdfb809af0391fdfb6a", "committedDate": "2020-04-24T12:56:15Z", "message": "minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7743115fcd1c8e2c3700bb087f40a31eb403233d", "author": {"user": {"login": "apaliy", "name": "Andrew Paliy"}}, "url": "https://github.com/prebid/prebid-server-java/commit/7743115fcd1c8e2c3700bb087f40a31eb403233d", "committedDate": "2020-04-24T13:11:21Z", "message": "minor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMTk4MzEw", "url": "https://github.com/prebid/prebid-server-java/pull/687#pullrequestreview-420198310", "createdAt": "2020-05-28T14:56:17Z", "commit": {"oid": "7743115fcd1c8e2c3700bb087f40a31eb403233d"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da880a5399273f9713755b72cc92a057af268bd4", "author": {"user": {"login": "rpanchyk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/da880a5399273f9713755b72cc92a057af268bd4", "committedDate": "2020-06-09T16:13:13Z", "message": "Merge branch 'master' into targeting-attribute-truncation\n\n# Conflicts:\n#\tsrc/main/java/org/prebid/server/auction/BidResponseCreator.java\n#\tsrc/main/java/org/prebid/server/settings/JdbcApplicationSettings.java\n#\tsrc/main/java/org/prebid/server/spring/config/ServiceConfiguration.java\n#\tsrc/test/java/org/prebid/server/auction/BidResponseCreatorTest.java\n#\tsrc/test/java/org/prebid/server/settings/JdbcApplicationSettingsTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d772bb087a3699f4b4d8507976de92542ffb915d", "author": {"user": {"login": "rpanchyk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/d772bb087a3699f4b4d8507976de92542ffb915d", "committedDate": "2020-06-10T06:53:52Z", "message": "Fixes after review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NzU5Mjcz", "url": "https://github.com/prebid/prebid-server-java/pull/687#pullrequestreview-427759273", "createdAt": "2020-06-10T06:56:30Z", "commit": {"oid": "d772bb087a3699f4b4d8507976de92542ffb915d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3352, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}