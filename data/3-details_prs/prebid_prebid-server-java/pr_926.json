{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMzQxMjI4", "number": 926, "title": "Strip eids of certain type", "bodyText": "", "createdAt": "2020-09-24T10:18:40Z", "url": "https://github.com/prebid/prebid-server-java/pull/926", "merged": true, "mergeCommit": {"oid": "774886913be28dc0e6c9fe26299d86e5e681c31d"}, "closed": true, "closedAt": "2020-09-24T10:52:17Z", "author": {"login": "BraslavskiyAndrey"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdL-eOmAH2gAyNDkyMzQxMjI4OjMwY2NmOWU1MzMwNWI3Y2IzNDI5ZWQ3NDJiZWExYjQ5YzQ5NmU1NTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdL-7zLAFqTQ5NTQ0NTA2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "30ccf9e53305b7cb3429ed742bea1b49c496e552", "author": {"user": {"login": "BraslavskiyAndrey", "name": "Braslavskyi Andrii"}}, "url": "https://github.com/prebid/prebid-server-java/commit/30ccf9e53305b7cb3429ed742bea1b49c496e552", "committedDate": "2020-09-24T10:17:32Z", "message": "Strip eids of certain type"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NDMzNTA0", "url": "https://github.com/prebid/prebid-server-java/pull/926#pullrequestreview-495433504", "createdAt": "2020-09-24T10:32:39Z", "commit": {"oid": "30ccf9e53305b7cb3429ed742bea1b49c496e552"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMDozMjozOVrOHXUIGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMDozNjozOVrOHXUQqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIwOTA1MA==", "bodyText": "Minor. Pls fix typo-case for ppuid.", "url": "https://github.com/prebid/prebid-server-java/pull/926#discussion_r494209050", "createdAt": "2020-09-24T10:32:39Z", "author": {"login": "rpanchyk"}, "path": "src/test/java/org/prebid/server/bidder/rubicon/RubiconBidderTest.java", "diffHunk": "@@ -774,14 +774,99 @@ public void makeHttpRequestsShouldCreateUserExtTpIdWithAdServerEidSource() {\n                                         \"adserver.org\",\n                                         null,\n                                         singletonList(ExtUserEidUid.of(\"adServerUid\", null,\n-                                                ExtUserEidUidExt.of(\"TDID\"))),\n+                                                ExtUserEidUidExt.of(\"TDID\", null))),\n                                         null)))\n                                 .build(),\n                         RubiconUserExt.builder()\n                                 .tpid(singletonList(ExtUserTpIdRubicon.of(\"tdid\", \"adServerUid\")))\n                                 .build()));\n     }\n \n+    @Test\n+    public void makeHttpRequestsShouldCreateUseIdIfMissingFromFirstUidStypePpuid() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(builder -> builder.user(User.builder()\n+                        .ext(ExtUser.builder()\n+                                .eids(singletonList(ExtUserEid.of(null, null,\n+                                        asList(\n+                                                ExtUserEidUid.of(\"id1\", null, ExtUserEidUidExt.of(null, \"other\")),\n+                                                ExtUserEidUid.of(\"id2\", null, ExtUserEidUidExt.of(null, \"ppuid\")),\n+                                                ExtUserEidUid.of(\"id3\", null, ExtUserEidUidExt.of(null, \"ppuid\"))),\n+                                        null)))\n+                                .build())\n+                        .build()),\n+                builder -> builder.video(Video.builder().build()), identity());\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = rubiconBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1).doesNotContainNull()\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .extracting(request -> request.getUser().getId())\n+                .containsOnly(\"id2\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotCreateUseIdIfMissingWhenNoUidWithppiudType() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30ccf9e53305b7cb3429ed742bea1b49c496e552"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIxMDI4Mw==", "bodyText": "Pls rename to hasStypeToRemove(..)", "url": "https://github.com/prebid/prebid-server-java/pull/926#discussion_r494210283", "createdAt": "2020-09-24T10:34:58Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java", "diffHunk": "@@ -709,13 +722,74 @@ private User makeUser(User user, ExtImpRubicon rubiconImpExt) {\n         final User.UserBuilder userBuilder = user != null ? user.toBuilder() : User.builder();\n \n         return userBuilder\n+                .id(resolvedId)\n                 .gender(null)\n                 .yob(null)\n                 .geo(null)\n                 .ext(mapper.fillExtension(userExt, rubiconUserExt))\n                 .build();\n     }\n \n+    private String resolveUserId(User user) {\n+        final ExtUser extUser = user != null ? user.getExt() : null;\n+        final List<ExtUserEid> extUserEids = extUser != null ? extUser.getEids() : null;\n+        return CollectionUtils.emptyIfNull(extUserEids)\n+                .stream()\n+                .map(extUserEid -> getIdFromFirstUuidWithStypePpuid(extUserEid.getUids()))\n+                .filter(Objects::nonNull)\n+                .findFirst()\n+                .orElse(null);\n+    }\n+\n+    private String getIdFromFirstUuidWithStypePpuid(List<ExtUserEidUid> extUserEidUids) {\n+        return CollectionUtils.emptyIfNull(extUserEidUids).stream()\n+                .filter(Objects::nonNull)\n+                .filter(extUserEidUid -> Objects.equals(PPUID_STYPE, getUserEidUidStype(extUserEidUid)))\n+                .map(ExtUserEidUid::getId)\n+                .findFirst()\n+                .orElse(null);\n+    }\n+\n+    private String getUserEidUidStype(ExtUserEidUid extUserEidUid) {\n+        final ExtUserEidUidExt extUserEidUidExt = extUserEidUid.getExt();\n+        return extUserEidUidExt != null ? extUserEidUidExt.getStype() : null;\n+    }\n+\n+    private boolean isHasStypeToRemove(List<ExtUserEid> extUserEids) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30ccf9e53305b7cb3429ed742bea1b49c496e552"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIxMTI0Mg==", "bodyText": "May we pass ExtUser as an argument here instead of whole User object?", "url": "https://github.com/prebid/prebid-server-java/pull/926#discussion_r494211242", "createdAt": "2020-09-24T10:36:39Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/rubicon/RubiconBidder.java", "diffHunk": "@@ -709,13 +722,74 @@ private User makeUser(User user, ExtImpRubicon rubiconImpExt) {\n         final User.UserBuilder userBuilder = user != null ? user.toBuilder() : User.builder();\n \n         return userBuilder\n+                .id(resolvedId)\n                 .gender(null)\n                 .yob(null)\n                 .geo(null)\n                 .ext(mapper.fillExtension(userExt, rubiconUserExt))\n                 .build();\n     }\n \n+    private String resolveUserId(User user) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30ccf9e53305b7cb3429ed742bea1b49c496e552"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6def448393a0d037cd8bf740817c9e5caab8277b", "author": {"user": {"login": "BraslavskiyAndrey", "name": "Braslavskyi Andrii"}}, "url": "https://github.com/prebid/prebid-server-java/commit/6def448393a0d037cd8bf740817c9e5caab8277b", "committedDate": "2020-09-24T10:46:53Z", "message": "Fix typos and other pull request comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NDQ1MDY5", "url": "https://github.com/prebid/prebid-server-java/pull/926#pullrequestreview-495445069", "createdAt": "2020-09-24T10:49:50Z", "commit": {"oid": "6def448393a0d037cd8bf740817c9e5caab8277b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3002, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}