{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0NzE2NTE4", "number": 711, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzoxMTo0M1rOD6V5Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODozODowNlrOD6kIwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNTAyNzAzOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzoxMTo0M1rOGSINlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNzoxMTo0M1rOGSINlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTY2MjEwMQ==", "bodyText": "app id", "url": "https://github.com/prebid/prebid-server-java/pull/711#discussion_r421662101", "createdAt": "2020-05-07T17:11:43Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "diffHunk": "@@ -119,38 +118,49 @@ private BidRequest createBidRequest(BidRequest bidRequest, List<BidderError> err\n         if (modifiedImps.isEmpty()) {\n             throw new PreBidException(\"No valid impressions\");\n         }\n+        validateSiteAppId(extSiteId, bidRequest.getSite(), bidRequest.getApp());\n \n         final BidRequest.BidRequestBuilder requestBuilder = bidRequest.toBuilder()\n                 .imp(modifiedImps);\n \n         if (site != null) {\n-            requestBuilder.site(site.toBuilder().id(extSiteId).mobile(extMobile).build());\n+            if (StringUtils.isEmpty(site.getId()) || extMobile != null) {\n+                final String siteId = ObjectUtils.defaultIfNull(site.getId(), extSiteId);\n+                requestBuilder.site(site.toBuilder().id(siteId).mobile(extMobile).build());\n+            }\n         } else if (app != null) {\n-            requestBuilder.app(app.toBuilder().id(extSiteId).build());\n+            if (StringUtils.isEmpty(app.getId())) {\n+                requestBuilder.app(app.toBuilder().id(extSiteId).build());\n+            }\n         }\n \n         return requestBuilder.build();\n     }\n \n+    private void validateSiteAppId(String extSiteId, Site site, App app) {\n+        if (site != null && StringUtils.isEmpty(site.getId()) && StringUtils.isEmpty(extSiteId)) {\n+            throw new PreBidException(\"Missing site id\");\n+        }\n+\n+        if (app != null && StringUtils.isEmpty(app.getId()) && StringUtils.isEmpty(extSiteId)) {\n+            throw new PreBidException(\"Missing site id\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3d0d0128ca8aa311833ac08a83552095bddb3c"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNzMzODI1OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODozMDoyNFrOGSd5aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODozMDoyNFrOGSd5aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAxNzM4NQ==", "bodyText": "We can use declared site & app vars.", "url": "https://github.com/prebid/prebid-server-java/pull/711#discussion_r422017385", "createdAt": "2020-05-08T08:30:24Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "diffHunk": "@@ -119,38 +118,49 @@ private BidRequest createBidRequest(BidRequest bidRequest, List<BidderError> err\n         if (modifiedImps.isEmpty()) {\n             throw new PreBidException(\"No valid impressions\");\n         }\n+        validateSiteAppId(extSiteId, bidRequest.getSite(), bidRequest.getApp());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3d0d0128ca8aa311833ac08a83552095bddb3c"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNzM0MTcxOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODozMTozNVrOGSd7fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODozMTozNVrOGSd7fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAxNzkxOA==", "bodyText": "No need for separate variable here.", "url": "https://github.com/prebid/prebid-server-java/pull/711#discussion_r422017918", "createdAt": "2020-05-08T08:31:35Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "diffHunk": "@@ -119,38 +118,49 @@ private BidRequest createBidRequest(BidRequest bidRequest, List<BidderError> err\n         if (modifiedImps.isEmpty()) {\n             throw new PreBidException(\"No valid impressions\");\n         }\n+        validateSiteAppId(extSiteId, bidRequest.getSite(), bidRequest.getApp());\n \n         final BidRequest.BidRequestBuilder requestBuilder = bidRequest.toBuilder()\n                 .imp(modifiedImps);\n \n         if (site != null) {\n-            requestBuilder.site(site.toBuilder().id(extSiteId).mobile(extMobile).build());\n+            if (StringUtils.isEmpty(site.getId()) || extMobile != null) {\n+                final String siteId = ObjectUtils.defaultIfNull(site.getId(), extSiteId);\n+                requestBuilder.site(site.toBuilder().id(siteId).mobile(extMobile).build());\n+            }\n         } else if (app != null) {\n-            requestBuilder.app(app.toBuilder().id(extSiteId).build());\n+            if (StringUtils.isEmpty(app.getId())) {\n+                requestBuilder.app(app.toBuilder().id(extSiteId).build());\n+            }\n         }\n \n         return requestBuilder.build();\n     }\n \n+    private void validateSiteAppId(String extSiteId, Site site, App app) {\n+        if (site != null && StringUtils.isEmpty(site.getId()) && StringUtils.isEmpty(extSiteId)) {\n+            throw new PreBidException(\"Missing site id\");\n+        }\n+\n+        if (app != null && StringUtils.isEmpty(app.getId()) && StringUtils.isEmpty(extSiteId)) {\n+            throw new PreBidException(\"Missing site id\");\n+        }\n+    }\n+\n     private static void validateImp(Imp imp) {\n         if (imp.getBanner() == null && imp.getVideo() == null) {\n             throw new PreBidException(String.format(\"Invalid MediaType. Conversant supports only Banner and Video. \"\n                     + \"Ignoring ImpID=%s\", imp.getId()));\n         }\n     }\n \n-    private ExtImpConversant parseAndValidateImpExt(Imp imp, boolean hasSite) {\n+    private ExtImpConversant parseImpExt(Imp imp) {\n         final ExtImpConversant extImpConversant;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3d0d0128ca8aa311833ac08a83552095bddb3c"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyNzM2MDY1OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODozODowNlrOGSeG_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQwODozODowNlrOGSeG_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAyMDg2MA==", "bodyText": "This and app variable can be declared right before validateSiteAppId(...) method, since they are used further.", "url": "https://github.com/prebid/prebid-server-java/pull/711#discussion_r422020860", "createdAt": "2020-05-08T08:38:06Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/conversant/ConversantBidder.java", "diffHunk": "@@ -93,22 +94,20 @@ public ConversantBidder(String endpointUrl, JacksonMapper mapper) {\n     }\n \n     private BidRequest createBidRequest(BidRequest bidRequest, List<BidderError> errors) {\n-        final App app = bidRequest.getApp();\n-        if (app != null && StringUtils.isBlank(app.getId())) {\n-            throw new PreBidException(\"Missing app id\");\n-        }\n-\n         final List<Imp> modifiedImps = new ArrayList<>();\n         Integer extMobile = null;\n         String extSiteId = null;\n         final Site site = bidRequest.getSite();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3d0d0128ca8aa311833ac08a83552095bddb3c"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4054, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}