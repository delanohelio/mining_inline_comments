{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0MDEwMzU3", "number": 958, "title": "Add krushmedia bidder", "bodyText": "", "createdAt": "2020-10-15T10:53:20Z", "url": "https://github.com/prebid/prebid-server-java/pull/958", "merged": true, "mergeCommit": {"oid": "f5ee0a8394363453669a8e7f3823d51ac068d2ad"}, "closed": true, "closedAt": "2020-10-27T08:17:57Z", "author": {"login": "snahornyi"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSx2NhABqjM4ODE2MDQzMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWkiTOgFqTUxNzQ0MDU1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32ae155cfc8616a1fd901b68e6468be2fd4d8c65", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/32ae155cfc8616a1fd901b68e6468be2fd4d8c65", "committedDate": "2020-10-15T10:51:37Z", "message": "Add krushmedia bidder"}, "afterCommit": {"oid": "8db5a88cbc9d143e7cf753844ed11bf6925753dc", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/8db5a88cbc9d143e7cf753844ed11bf6925753dc", "committedDate": "2020-10-15T13:31:25Z", "message": "Add krushmedia bidder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3456894efa824f6632c8c8c1051205286339231", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/b3456894efa824f6632c8c8c1051205286339231", "committedDate": "2020-10-15T22:50:37Z", "message": "Add krushmedia bidder"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8db5a88cbc9d143e7cf753844ed11bf6925753dc", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/8db5a88cbc9d143e7cf753844ed11bf6925753dc", "committedDate": "2020-10-15T13:31:25Z", "message": "Add krushmedia bidder"}, "afterCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/b3456894efa824f6632c8c8c1051205286339231", "committedDate": "2020-10-15T22:50:37Z", "message": "Add krushmedia bidder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNTE1NjEx", "url": "https://github.com/prebid/prebid-server-java/pull/958#pullrequestreview-510515611", "createdAt": "2020-10-16T14:18:45Z", "commit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNDoxODo0NVrOHjA1-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNTowMjoyM1rOHjDjQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ3NjAyNQ==", "bodyText": "use PreBidException", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506476025", "createdAt": "2020-10-16T14:18:45Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/bidder/krushmedia/KrushmediaBidder.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class KrushmediaBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpKrushmedia>> KRUSHMEDIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpKrushmedia>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public KrushmediaBidder(String endpointUrl, JacksonMapper mapper) {\n+\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+\n+        final ExtImpKrushmedia extImpKrushmedia;\n+        final String url;\n+\n+        try {\n+            extImpKrushmedia = parseImpExt(request.getImp().get(0));\n+            url = resolveEndpoint(extImpKrushmedia.getAccountId());\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ3Njc2Mw==", "bodyText": "unmarshalling", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506476763", "createdAt": "2020-10-16T14:19:41Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/bidder/krushmedia/KrushmediaBidder.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class KrushmediaBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpKrushmedia>> KRUSHMEDIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpKrushmedia>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public KrushmediaBidder(String endpointUrl, JacksonMapper mapper) {\n+\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+\n+        final ExtImpKrushmedia extImpKrushmedia;\n+        final String url;\n+\n+        try {\n+            extImpKrushmedia = parseImpExt(request.getImp().get(0));\n+            url = resolveEndpoint(extImpKrushmedia.getAccountId());\n+        } catch (Exception e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final BidRequest outgoingRequest = request.toBuilder()\n+                .imp(resolveUpdatedImpList(request.getImp())).build();\n+\n+        return Result.of(Collections.singletonList(\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(url)\n+                        .headers(resolveHeaders(request.getDevice()))\n+                        .payload(outgoingRequest)\n+                        .body(mapper.encode(outgoingRequest))\n+                        .build()),\n+                errors);\n+    }\n+\n+    private ExtImpKrushmedia parseImpExt(Imp imp) {\n+\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), KRUSHMEDIA_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(\"Error while unmarshaling bidder extension\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ3ODA5NA==", "bodyText": "extract into const URI_ACCOUNT_ID_MACRO", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506478094", "createdAt": "2020-10-16T14:21:23Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/bidder/krushmedia/KrushmediaBidder.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class KrushmediaBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpKrushmedia>> KRUSHMEDIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpKrushmedia>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public KrushmediaBidder(String endpointUrl, JacksonMapper mapper) {\n+\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+\n+        final ExtImpKrushmedia extImpKrushmedia;\n+        final String url;\n+\n+        try {\n+            extImpKrushmedia = parseImpExt(request.getImp().get(0));\n+            url = resolveEndpoint(extImpKrushmedia.getAccountId());\n+        } catch (Exception e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final BidRequest outgoingRequest = request.toBuilder()\n+                .imp(resolveUpdatedImpList(request.getImp())).build();\n+\n+        return Result.of(Collections.singletonList(\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(url)\n+                        .headers(resolveHeaders(request.getDevice()))\n+                        .payload(outgoingRequest)\n+                        .body(mapper.encode(outgoingRequest))\n+                        .build()),\n+                errors);\n+    }\n+\n+    private ExtImpKrushmedia parseImpExt(Imp imp) {\n+\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), KRUSHMEDIA_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(\"Error while unmarshaling bidder extension\");\n+        }\n+    }\n+\n+    private String resolveEndpoint(String accountId) {\n+\n+        return HttpUtil.validateUrl(endpointUrl.replace(\"{{AccountID}}\", accountId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ3OTI5Ng==", "bodyText": "You can omit validation (and check above only for PrebidException)", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506479296", "createdAt": "2020-10-16T14:22:44Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/bidder/krushmedia/KrushmediaBidder.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class KrushmediaBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpKrushmedia>> KRUSHMEDIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpKrushmedia>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public KrushmediaBidder(String endpointUrl, JacksonMapper mapper) {\n+\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+\n+        final ExtImpKrushmedia extImpKrushmedia;\n+        final String url;\n+\n+        try {\n+            extImpKrushmedia = parseImpExt(request.getImp().get(0));\n+            url = resolveEndpoint(extImpKrushmedia.getAccountId());\n+        } catch (Exception e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final BidRequest outgoingRequest = request.toBuilder()\n+                .imp(resolveUpdatedImpList(request.getImp())).build();\n+\n+        return Result.of(Collections.singletonList(\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(url)\n+                        .headers(resolveHeaders(request.getDevice()))\n+                        .payload(outgoingRequest)\n+                        .body(mapper.encode(outgoingRequest))\n+                        .build()),\n+                errors);\n+    }\n+\n+    private ExtImpKrushmedia parseImpExt(Imp imp) {\n+\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), KRUSHMEDIA_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(\"Error while unmarshaling bidder extension\");\n+        }\n+    }\n+\n+    private String resolveEndpoint(String accountId) {\n+\n+        return HttpUtil.validateUrl(endpointUrl.replace(\"{{AccountID}}\", accountId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ4MzEyNQ==", "bodyText": "/n .build();", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506483125", "createdAt": "2020-10-16T14:27:03Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/bidder/krushmedia/KrushmediaBidder.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class KrushmediaBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpKrushmedia>> KRUSHMEDIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpKrushmedia>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public KrushmediaBidder(String endpointUrl, JacksonMapper mapper) {\n+\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+\n+        final ExtImpKrushmedia extImpKrushmedia;\n+        final String url;\n+\n+        try {\n+            extImpKrushmedia = parseImpExt(request.getImp().get(0));\n+            url = resolveEndpoint(extImpKrushmedia.getAccountId());\n+        } catch (Exception e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final BidRequest outgoingRequest = request.toBuilder()\n+                .imp(resolveUpdatedImpList(request.getImp())).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ4ODU2NQ==", "bodyText": "Can be more clear: removeFirstImpExt", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506488565", "createdAt": "2020-10-16T14:32:03Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/bidder/krushmedia/KrushmediaBidder.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class KrushmediaBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpKrushmedia>> KRUSHMEDIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpKrushmedia>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public KrushmediaBidder(String endpointUrl, JacksonMapper mapper) {\n+\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+\n+        final ExtImpKrushmedia extImpKrushmedia;\n+        final String url;\n+\n+        try {\n+            extImpKrushmedia = parseImpExt(request.getImp().get(0));\n+            url = resolveEndpoint(extImpKrushmedia.getAccountId());\n+        } catch (Exception e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final BidRequest outgoingRequest = request.toBuilder()\n+                .imp(resolveUpdatedImpList(request.getImp())).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ4ODk4OA==", "bodyText": "use this style\n return IntStream.range(0, imps.size())\n                .mapToObj(impIndex -> impIndex == 0\n                        ? imps.get(impIndex).toBuilder().ext(null).build()\n                        : imps.get(impIndex))\n                .collect(Collectors.toList());", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506488988", "createdAt": "2020-10-16T14:32:30Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/bidder/krushmedia/KrushmediaBidder.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class KrushmediaBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpKrushmedia>> KRUSHMEDIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpKrushmedia>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public KrushmediaBidder(String endpointUrl, JacksonMapper mapper) {\n+\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+\n+        final ExtImpKrushmedia extImpKrushmedia;\n+        final String url;\n+\n+        try {\n+            extImpKrushmedia = parseImpExt(request.getImp().get(0));\n+            url = resolveEndpoint(extImpKrushmedia.getAccountId());\n+        } catch (Exception e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final BidRequest outgoingRequest = request.toBuilder()\n+                .imp(resolveUpdatedImpList(request.getImp())).build();\n+\n+        return Result.of(Collections.singletonList(\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(url)\n+                        .headers(resolveHeaders(request.getDevice()))\n+                        .payload(outgoingRequest)\n+                        .body(mapper.encode(outgoingRequest))\n+                        .build()),\n+                errors);\n+    }\n+\n+    private ExtImpKrushmedia parseImpExt(Imp imp) {\n+\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), KRUSHMEDIA_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(\"Error while unmarshaling bidder extension\");\n+        }\n+    }\n+\n+    private String resolveEndpoint(String accountId) {\n+\n+        return HttpUtil.validateUrl(endpointUrl.replace(\"{{AccountID}}\", accountId));\n+    }\n+\n+    private static List<Imp> resolveUpdatedImpList(List<Imp> imps) {\n+        return IntStream.range(0, imps.size())\n+                .mapToObj(impIndex -> impIndex == 0\n+                        ? imps.get(impIndex).toBuilder().ext(null).build() : imps.get(impIndex))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5MDk3Ng==", "bodyText": "Prefer to use isNotBlank.\nIn GO they have always default values (\"\") so it is hard to distinguish their meaning of check", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506490976", "createdAt": "2020-10-16T14:34:27Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/bidder/krushmedia/KrushmediaBidder.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class KrushmediaBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpKrushmedia>> KRUSHMEDIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpKrushmedia>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public KrushmediaBidder(String endpointUrl, JacksonMapper mapper) {\n+\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+\n+        final ExtImpKrushmedia extImpKrushmedia;\n+        final String url;\n+\n+        try {\n+            extImpKrushmedia = parseImpExt(request.getImp().get(0));\n+            url = resolveEndpoint(extImpKrushmedia.getAccountId());\n+        } catch (Exception e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final BidRequest outgoingRequest = request.toBuilder()\n+                .imp(resolveUpdatedImpList(request.getImp())).build();\n+\n+        return Result.of(Collections.singletonList(\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(url)\n+                        .headers(resolveHeaders(request.getDevice()))\n+                        .payload(outgoingRequest)\n+                        .body(mapper.encode(outgoingRequest))\n+                        .build()),\n+                errors);\n+    }\n+\n+    private ExtImpKrushmedia parseImpExt(Imp imp) {\n+\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), KRUSHMEDIA_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(\"Error while unmarshaling bidder extension\");\n+        }\n+    }\n+\n+    private String resolveEndpoint(String accountId) {\n+\n+        return HttpUtil.validateUrl(endpointUrl.replace(\"{{AccountID}}\", accountId));\n+    }\n+\n+    private static List<Imp> resolveUpdatedImpList(List<Imp> imps) {\n+        return IntStream.range(0, imps.size())\n+                .mapToObj(impIndex -> impIndex == 0\n+                        ? imps.get(impIndex).toBuilder().ext(null).build() : imps.get(impIndex))\n+                .collect(Collectors.toList());\n+    }\n+\n+    private MultiMap resolveHeaders(Device device) {\n+\n+        final MultiMap headers = HttpUtil.headers();\n+        headers.add(\"X-Openrtb-Version\", \"2.5\");\n+\n+        if (device != null) {\n+            if (StringUtils.isNotEmpty(device.getUa())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5NjM3NQ==", "bodyText": "prefer this style\n        final SeatBid firstSeatBid = bidResponse.getSeatbid().get(0);\n        return firstSeatBid.getBid().stream()\n                .filter(Objects::nonNull)\n                .map(bid -> BidderBid.of(bid, getBidType(bid.getImpid(), bidRequest.getImp()), bidResponse.getCur()))\n                .collect(Collectors.toList());", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506496375", "createdAt": "2020-10-16T14:39:52Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/bidder/krushmedia/KrushmediaBidder.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class KrushmediaBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpKrushmedia>> KRUSHMEDIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpKrushmedia>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public KrushmediaBidder(String endpointUrl, JacksonMapper mapper) {\n+\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+\n+        final ExtImpKrushmedia extImpKrushmedia;\n+        final String url;\n+\n+        try {\n+            extImpKrushmedia = parseImpExt(request.getImp().get(0));\n+            url = resolveEndpoint(extImpKrushmedia.getAccountId());\n+        } catch (Exception e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final BidRequest outgoingRequest = request.toBuilder()\n+                .imp(resolveUpdatedImpList(request.getImp())).build();\n+\n+        return Result.of(Collections.singletonList(\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(url)\n+                        .headers(resolveHeaders(request.getDevice()))\n+                        .payload(outgoingRequest)\n+                        .body(mapper.encode(outgoingRequest))\n+                        .build()),\n+                errors);\n+    }\n+\n+    private ExtImpKrushmedia parseImpExt(Imp imp) {\n+\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), KRUSHMEDIA_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(\"Error while unmarshaling bidder extension\");\n+        }\n+    }\n+\n+    private String resolveEndpoint(String accountId) {\n+\n+        return HttpUtil.validateUrl(endpointUrl.replace(\"{{AccountID}}\", accountId));\n+    }\n+\n+    private static List<Imp> resolveUpdatedImpList(List<Imp> imps) {\n+        return IntStream.range(0, imps.size())\n+                .mapToObj(impIndex -> impIndex == 0\n+                        ? imps.get(impIndex).toBuilder().ext(null).build() : imps.get(impIndex))\n+                .collect(Collectors.toList());\n+    }\n+\n+    private MultiMap resolveHeaders(Device device) {\n+\n+        final MultiMap headers = HttpUtil.headers();\n+        headers.add(\"X-Openrtb-Version\", \"2.5\");\n+\n+        if (device != null) {\n+            if (StringUtils.isNotEmpty(device.getUa())) {\n+                headers.add(\"User-Agent\", device.getUa());\n+            }\n+            if (StringUtils.isNotEmpty(device.getIp())) {\n+                headers.add(\"X-Forwarded-For\", device.getIp());\n+            }\n+            if (StringUtils.isNotEmpty(device.getLanguage())) {\n+                headers.add(\"Accept-Language\", device.getLanguage());\n+            }\n+            if (device.getDnt() != null) {\n+                headers.add(\"Accept-Language\", device.getDnt().toString());\n+            }\n+        }\n+\n+        return headers;\n+    }\n+\n+    @Override\n+    public final Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.empty();\n+        }\n+\n+        try {\n+            final BidResponse bidResponse = mapper.decodeValue(httpCall.getResponse().getBody(), BidResponse.class);\n+            return Result.of(extractBids(httpCall.getRequest().getPayload(), bidResponse), Collections.emptyList());\n+        } catch (DecodeException | PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+    }\n+\n+    private List<BidderBid> extractBids(BidRequest bidRequest, BidResponse bidResponse) {\n+\n+        if (bidResponse == null || bidResponse.getSeatbid() == null) {\n+            return Collections.emptyList();\n+        }\n+        return bidsFromResponse(bidRequest, bidResponse);\n+    }\n+\n+    private List<BidderBid> bidsFromResponse(BidRequest bidRequest, BidResponse bidResponse) {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 148}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5NzE1NA==", "bodyText": "redundant", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506497154", "createdAt": "2020-10-16T14:40:37Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/bidder/krushmedia/KrushmediaBidderTest.java", "diffHunk": "@@ -0,0 +1,270 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Native;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.video;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.xNative;\n+\n+public class KrushmediaBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.com/prebid/bid&key={{AccountID}}\";\n+\n+    private KrushmediaBidder krushmediaBidder;\n+\n+    @Before\n+    public void setUp() {\n+        krushmediaBidder = new KrushmediaBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new KrushmediaBidder(\"invalid_url\", jacksonMapper));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwMDQzOA==", "bodyText": "rename", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506500438", "createdAt": "2020-10-16T14:44:08Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/bidder/krushmedia/KrushmediaBidderTest.java", "diffHunk": "@@ -0,0 +1,270 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Native;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.video;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.xNative;\n+\n+public class KrushmediaBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.com/prebid/bid&key={{AccountID}}\";\n+\n+    private KrushmediaBidder krushmediaBidder;\n+\n+    @Before\n+    public void setUp() {\n+        krushmediaBidder = new KrushmediaBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new KrushmediaBidder(\"invalid_url\", jacksonMapper));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = krushmediaBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Error while unmarshaling bidder extension\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = krushmediaBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(\"https://test.com/prebid/bid&key=accountId\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotNativeRequestIfAlreadyExists() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwMjQxOA==", "bodyText": "Do we really need this test?\nWe can change it to \"ShouldRemoveFirsImpExt\" and test real logic", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506502418", "createdAt": "2020-10-16T14:46:22Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/bidder/krushmedia/KrushmediaBidderTest.java", "diffHunk": "@@ -0,0 +1,270 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Native;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.video;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.xNative;\n+\n+public class KrushmediaBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.com/prebid/bid&key={{AccountID}}\";\n+\n+    private KrushmediaBidder krushmediaBidder;\n+\n+    @Before\n+    public void setUp() {\n+        krushmediaBidder = new KrushmediaBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new KrushmediaBidder(\"invalid_url\", jacksonMapper));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = krushmediaBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Error while unmarshaling bidder extension\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = krushmediaBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(\"https://test.com/prebid/bid&key=accountId\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotNativeRequestIfAlreadyExists() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwMjk2Mw==", "bodyText": "format is redundant.\nThen it can be 1 line", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506502963", "createdAt": "2020-10-16T14:47:00Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/bidder/krushmedia/KrushmediaBidderTest.java", "diffHunk": "@@ -0,0 +1,270 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Native;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.video;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.xNative;\n+\n+public class KrushmediaBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.com/prebid/bid&key={{AccountID}}\";\n+\n+    private KrushmediaBidder krushmediaBidder;\n+\n+    @Before\n+    public void setUp() {\n+        krushmediaBidder = new KrushmediaBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new KrushmediaBidder(\"invalid_url\", jacksonMapper));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = krushmediaBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Error while unmarshaling bidder extension\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwNTM5Mg==", "bodyText": "assertThat(result.getValue()).hasSize(1)\n                .extracting(HttpRequest::getUri)\n                .containsOnly(\"https://test.com/prebid/bid&key=accountId\");", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506505392", "createdAt": "2020-10-16T14:50:03Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/bidder/krushmedia/KrushmediaBidderTest.java", "diffHunk": "@@ -0,0 +1,270 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Native;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.video;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.xNative;\n+\n+public class KrushmediaBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.com/prebid/bid&key={{AccountID}}\";\n+\n+    private KrushmediaBidder krushmediaBidder;\n+\n+    @Before\n+    public void setUp() {\n+        krushmediaBidder = new KrushmediaBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new KrushmediaBidder(\"invalid_url\", jacksonMapper));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = krushmediaBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Error while unmarshaling bidder extension\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = krushmediaBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(\"https://test.com/prebid/bid&key=accountId\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwNjY5NA==", "bodyText": "Add test\nmakeBidsShouldReturnEmptyBidderBidsFromFirstSeatBid", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506506694", "createdAt": "2020-10-16T14:51:38Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/bidder/krushmedia/KrushmediaBidderTest.java", "diffHunk": "@@ -0,0 +1,270 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Native;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+\n+import java.util.List;\n+import java.util.function.Function;\n+\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.video;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.xNative;\n+\n+public class KrushmediaBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.com/prebid/bid&key={{AccountID}}\";\n+\n+    private KrushmediaBidder krushmediaBidder;\n+\n+    @Before\n+    public void setUp() {\n+        krushmediaBidder = new KrushmediaBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new KrushmediaBidder(\"invalid_url\", jacksonMapper));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .id(\"123\")\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, mapper.createArrayNode()))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = krushmediaBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Error while unmarshaling bidder extension\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = krushmediaBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(\"https://test.com/prebid/bid&key=accountId\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldNotNativeRequestIfAlreadyExists() {\n+        // given\n+        String nativeRequest = \"{\\\"native\\\":{\\\"ver\\\":\\\"1.2\\\",\\\"context\\\":1,\\\"plcmttype\\\":4,\\\"plcmtcnt\\\":1,\"\n+                + \"\\\"assets\\\":[{\\\"id\\\":2,\\\"required\\\":1,\\\"title\\\":{\\\"len\\\":90}},{\\\"id\\\":6,\\\"required\\\":1,\"\n+                + \"\\\"img\\\":{\\\"type\\\":3,\\\"wmin\\\":128,\\\"hmin\\\":128,\\\"mimes\\\":[\\\"image/jpg\\\",\\\"image/jpeg\\\",\"\n+                + \"\\\"image/png\\\"]}},{\\\"id\\\":7,\\\"required\\\":1,\\\"data\\\":{\\\"type\\\":2,\\\"len\\\":120}}]}}\";\n+\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder().build())\n+                        .xNative(Native.builder().request(nativeRequest).build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = krushmediaBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        String expectedNativeRequest = \"{\\\"native\\\":{\\\"ver\\\":\\\"1.2\\\",\\\"context\\\":1,\\\"plcmttype\\\":4,\\\"plcmtcnt\\\":1,\"\n+                + \"\\\"assets\\\":[{\\\"id\\\":2,\\\"required\\\":1,\\\"title\\\":{\\\"len\\\":90}},{\\\"id\\\":6,\\\"required\\\":1,\\\"img\\\":\"\n+                + \"{\\\"type\\\":3,\\\"wmin\\\":128,\\\"hmin\\\":128,\\\"mimes\\\":[\\\"image/jpg\\\",\\\"image/jpeg\\\",\\\"image/png\\\"]}},\"\n+                + \"{\\\"id\\\":7,\\\"required\\\":1,\\\"data\\\":{\\\"type\\\":2,\\\"len\\\":120}}]}}\";\n+\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1)\n+                .extracting(httpRequest -> mapper.readValue(httpRequest.getBody(), BidRequest.class))\n+                .flatExtracting(BidRequest::getImp)\n+                .extracting(Imp::getXNative)\n+                .extracting(Native::getRequest)\n+                .containsOnly(expectedNativeRequest);\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null, \"invalid\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = krushmediaBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"Failed to decode: Unrecognized token\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnEmptyListIfBidResponseIsNull() throws JsonProcessingException {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null,\n+                mapper.writeValueAsString(null));\n+\n+        // when\n+        final Result<List<BidderBid>> result = krushmediaBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUwODIwNA==", "bodyText": "Krushmedia or remove", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506508204", "createdAt": "2020-10-16T14:52:51Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/it/KrushmediaTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package org.prebid.server.it;\n+\n+import io.restassured.response.Response;\n+import org.json.JSONException;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+import org.skyscreamer.jsonassert.JSONCompareMode;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+import java.io.IOException;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalTo;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalToIgnoreCase;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalToJson;\n+import static com.github.tomakehurst.wiremock.client.WireMock.post;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlPathEqualTo;\n+import static io.restassured.RestAssured.given;\n+import static java.util.Collections.singletonList;\n+\n+@RunWith(SpringRunner.class)\n+public class KrushmediaTest extends IntegrationTest {\n+\n+    @Test\n+    public void openrtb2AuctionShouldRespondWithBidsFromKrushmedia() throws IOException, JSONException {\n+        // given\n+        // Logicad bid response for imp", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUxMDI1NA==", "bodyText": "Rename this and files to be for krushmedia", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506510254", "createdAt": "2020-10-16T14:54:33Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/it/KrushmediaTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package org.prebid.server.it;\n+\n+import io.restassured.response.Response;\n+import org.json.JSONException;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+import org.skyscreamer.jsonassert.JSONCompareMode;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+import java.io.IOException;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalTo;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalToIgnoreCase;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalToJson;\n+import static com.github.tomakehurst.wiremock.client.WireMock.post;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlPathEqualTo;\n+import static io.restassured.RestAssured.given;\n+import static java.util.Collections.singletonList;\n+\n+@RunWith(SpringRunner.class)\n+public class KrushmediaTest extends IntegrationTest {\n+\n+    @Test\n+    public void openrtb2AuctionShouldRespondWithBidsFromKrushmedia() throws IOException, JSONException {\n+        // given\n+        // Logicad bid response for imp\n+        WIRE_MOCK_RULE.stubFor(post(urlPathEqualTo(\"/krushmedia-exchange\"))\n+                .withHeader(\"Accept\", equalTo(\"application/json\"))\n+                .withHeader(\"Content-Type\", equalToIgnoreCase(\"application/json;charset=UTF-8\"))\n+                .withRequestBody(equalToJson(jsonFrom(\"openrtb2/krushmedia/test-logicad-bid-request.json\")))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUxMjU1Nw==", "bodyText": "Dnt", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506512557", "createdAt": "2020-10-16T14:55:58Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/bidder/krushmedia/KrushmediaBidder.java", "diffHunk": "@@ -0,0 +1,176 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class KrushmediaBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpKrushmedia>> KRUSHMEDIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpKrushmedia>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public KrushmediaBidder(String endpointUrl, JacksonMapper mapper) {\n+\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+\n+        final ExtImpKrushmedia extImpKrushmedia;\n+        final String url;\n+\n+        try {\n+            extImpKrushmedia = parseImpExt(request.getImp().get(0));\n+            url = resolveEndpoint(extImpKrushmedia.getAccountId());\n+        } catch (Exception e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final BidRequest outgoingRequest = request.toBuilder()\n+                .imp(resolveUpdatedImpList(request.getImp())).build();\n+\n+        return Result.of(Collections.singletonList(\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(url)\n+                        .headers(resolveHeaders(request.getDevice()))\n+                        .payload(outgoingRequest)\n+                        .body(mapper.encode(outgoingRequest))\n+                        .build()),\n+                errors);\n+    }\n+\n+    private ExtImpKrushmedia parseImpExt(Imp imp) {\n+\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), KRUSHMEDIA_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(\"Error while unmarshaling bidder extension\");\n+        }\n+    }\n+\n+    private String resolveEndpoint(String accountId) {\n+\n+        return HttpUtil.validateUrl(endpointUrl.replace(\"{{AccountID}}\", accountId));\n+    }\n+\n+    private static List<Imp> resolveUpdatedImpList(List<Imp> imps) {\n+        return IntStream.range(0, imps.size())\n+                .mapToObj(impIndex -> impIndex == 0\n+                        ? imps.get(impIndex).toBuilder().ext(null).build() : imps.get(impIndex))\n+                .collect(Collectors.toList());\n+    }\n+\n+    private MultiMap resolveHeaders(Device device) {\n+\n+        final MultiMap headers = HttpUtil.headers();\n+        headers.add(\"X-Openrtb-Version\", \"2.5\");\n+\n+        if (device != null) {\n+            if (StringUtils.isNotEmpty(device.getUa())) {\n+                headers.add(\"User-Agent\", device.getUa());\n+            }\n+            if (StringUtils.isNotEmpty(device.getIp())) {\n+                headers.add(\"X-Forwarded-For\", device.getIp());\n+            }\n+            if (StringUtils.isNotEmpty(device.getLanguage())) {\n+                headers.add(\"Accept-Language\", device.getLanguage());\n+            }\n+            if (device.getDnt() != null) {\n+                headers.add(\"Accept-Language\", device.getDnt().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 116}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUxNDg3NA==", "bodyText": "Try to make scenario to include more cases.\nFor example add to auction-request device this value and check also for new headers\n   \"ua\": \"userAgent\",\n    \"dnt\": 2,\n    \"ip\": \"193.168.244.1\",\n    \"pxratio\": 4.2,\n    \"language\": \"en\",\n    \"ifa\": \"ifaId\"", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506514874", "createdAt": "2020-10-16T14:58:00Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/it/KrushmediaTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package org.prebid.server.it;\n+\n+import io.restassured.response.Response;\n+import org.json.JSONException;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+import org.skyscreamer.jsonassert.JSONCompareMode;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+import java.io.IOException;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalTo;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalToIgnoreCase;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalToJson;\n+import static com.github.tomakehurst.wiremock.client.WireMock.post;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlPathEqualTo;\n+import static io.restassured.RestAssured.given;\n+import static java.util.Collections.singletonList;\n+\n+@RunWith(SpringRunner.class)\n+public class KrushmediaTest extends IntegrationTest {\n+\n+    @Test\n+    public void openrtb2AuctionShouldRespondWithBidsFromKrushmedia() throws IOException, JSONException {\n+        // given\n+        // Logicad bid response for imp\n+        WIRE_MOCK_RULE.stubFor(post(urlPathEqualTo(\"/krushmedia-exchange\"))\n+                .withHeader(\"Accept\", equalTo(\"application/json\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUxNTE3Mw==", "bodyText": "redundant", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506515173", "createdAt": "2020-10-16T14:58:13Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/it/KrushmediaTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package org.prebid.server.it;\n+\n+import io.restassured.response.Response;\n+import org.json.JSONException;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+import org.skyscreamer.jsonassert.JSONCompareMode;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+import java.io.IOException;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalTo;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalToIgnoreCase;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalToJson;\n+import static com.github.tomakehurst.wiremock.client.WireMock.post;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlPathEqualTo;\n+import static io.restassured.RestAssured.given;\n+import static java.util.Collections.singletonList;\n+\n+@RunWith(SpringRunner.class)\n+public class KrushmediaTest extends IntegrationTest {\n+\n+    @Test\n+    public void openrtb2AuctionShouldRespondWithBidsFromKrushmedia() throws IOException, JSONException {\n+        // given\n+        // Logicad bid response for imp\n+        WIRE_MOCK_RULE.stubFor(post(urlPathEqualTo(\"/krushmedia-exchange\"))\n+                .withHeader(\"Accept\", equalTo(\"application/json\"))\n+                .withHeader(\"Content-Type\", equalToIgnoreCase(\"application/json;charset=UTF-8\"))\n+                .withRequestBody(equalToJson(jsonFrom(\"openrtb2/krushmedia/test-logicad-bid-request.json\")))\n+                .willReturn(aResponse().withBody(\n+                        jsonFrom(\"openrtb2/krushmedia/test-logicad-bid-response.json\"))));\n+\n+        // pre-bid cache\n+        WIRE_MOCK_RULE.stubFor(post(urlPathEqualTo(\"/cache\"))\n+                .withRequestBody(equalToJson(jsonFrom(\"openrtb2/krushmedia/test-cache-logicad-request.json\")))\n+                .willReturn(aResponse().withBody(\n+                        jsonFrom(\"openrtb2/krushmedia/test-cache-logicad-response.json\"))));\n+\n+        // when\n+        final Response response = given(SPEC)\n+                .header(\"Referer\", \"http://www.example.com\")\n+                .header(\"X-Forwarded-For\", \"193.168.244.1\")\n+                .header(\"User-Agent\", \"userAgent\")\n+                .header(\"Origin\", \"http://www.example.com\")\n+                // this uids cookie value stands for {\"uids\":{\"krushmedia\":\"KM-UID\"}}\n+                .cookie(\"uids\", \"eyJ1aWRzIjp7ImtydXNobWVkaWEiOiJLTS1VSUQifX0=\")\n+                .body(jsonFrom(\"openrtb2/krushmedia/test-auction-logicad-request.json\"))\n+                .post(\"/openrtb2/auction\");\n+\n+        // then\n+        final String expectedAuctionResponse = openrtbAuctionResponseFrom(\n+                \"openrtb2/krushmedia/test-auction-logicad-response.json\",\n+                response, singletonList(\"krushmedia\"));\n+\n+        JSONAssert.assertEquals(expectedAuctionResponse, response.asString(), JSONCompareMode.NON_EXTENSIBLE);\n+    }\n+}\n+\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUxNjUzMg==", "bodyText": "redundant for this workflow", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506516532", "createdAt": "2020-10-16T14:59:20Z", "author": {"login": "DGarbar"}, "path": "src/test/resources/org/prebid/server/it/openrtb2/krushmedia/test-auction-logicad-request.json", "diffHunk": "@@ -0,0 +1,72 @@\n+{\n+  \"id\": \"tid\",\n+  \"imp\": [\n+    {\n+      \"id\": \"testimpid\",\n+      \"banner\": {\n+        \"format\": [\n+          {\n+            \"w\": 320,\n+            \"h\": 250\n+          },\n+          {\n+            \"w\": 320,\n+            \"h\": 300\n+          }\n+        ],\n+        \"w\": 320,\n+        \"h\": 250", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUxNjY2Ng==", "bodyText": "redundant for this workflow", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506516666", "createdAt": "2020-10-16T14:59:24Z", "author": {"login": "DGarbar"}, "path": "src/test/resources/org/prebid/server/it/openrtb2/krushmedia/test-auction-logicad-request.json", "diffHunk": "@@ -0,0 +1,72 @@\n+{\n+  \"id\": \"tid\",\n+  \"imp\": [\n+    {\n+      \"id\": \"testimpid\",\n+      \"banner\": {\n+        \"format\": [\n+          {\n+            \"w\": 320,\n+            \"h\": 250\n+          },\n+          {\n+            \"w\": 320,\n+            \"h\": 300", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUyMDM4NA==", "bodyText": "it is a good practice to get this response from GO test version.", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r506520384", "createdAt": "2020-10-16T15:02:23Z", "author": {"login": "DGarbar"}, "path": "src/test/resources/org/prebid/server/it/openrtb2/krushmedia/test-logicad-bid-response.json", "diffHunk": "@@ -0,0 +1,18 @@\n+{\n+  \"id\": \"tid\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3456894efa824f6632c8c8c1051205286339231"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11ab1d2b6c655f16aa8da9c60319c903235a3a5b", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/11ab1d2b6c655f16aa8da9c60319c903235a3a5b", "committedDate": "2020-10-19T00:05:05Z", "message": "Fixes after review"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "25771331566fda42a3277a428748aed7a60da945", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/25771331566fda42a3277a428748aed7a60da945", "committedDate": "2020-10-19T00:03:20Z", "message": "Fixes after review"}, "afterCommit": {"oid": "11ab1d2b6c655f16aa8da9c60319c903235a3a5b", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/11ab1d2b6c655f16aa8da9c60319c903235a3a5b", "committedDate": "2020-10-19T00:05:05Z", "message": "Fixes after review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNTc2ODI4", "url": "https://github.com/prebid/prebid-server-java/pull/958#pullrequestreview-512576828", "createdAt": "2020-10-20T10:49:34Z", "commit": {"oid": "11ab1d2b6c655f16aa8da9c60319c903235a3a5b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDo0OTozNVrOHk2VJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMDo1MDoxNlrOHk2Wxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQwMDkzMw==", "bodyText": "redundant", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r508400933", "createdAt": "2020-10-20T10:49:35Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/it/KrushmediaTest.java", "diffHunk": "@@ -25,19 +25,24 @@\n     @Test\n     public void openrtb2AuctionShouldRespondWithBidsFromKrushmedia() throws IOException, JSONException {\n         // given\n-        // Logicad bid response for imp\n+        // Krushmedia bid response for imp\n         WIRE_MOCK_RULE.stubFor(post(urlPathEqualTo(\"/krushmedia-exchange\"))\n                 .withHeader(\"Accept\", equalTo(\"application/json\"))\n                 .withHeader(\"Content-Type\", equalToIgnoreCase(\"application/json;charset=UTF-8\"))\n-                .withRequestBody(equalToJson(jsonFrom(\"openrtb2/krushmedia/test-logicad-bid-request.json\")))\n+                .withHeader(\"User-Agent\", equalToIgnoreCase(\"test-user-agent\"))\n+                .withHeader(\"X-Forwarded-For\", equalToIgnoreCase(\"123.123.123.123\"))\n+                .withHeader(\"Accept-Language\", equalToIgnoreCase(\"en\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11ab1d2b6c655f16aa8da9c60319c903235a3a5b"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQwMTM1MA==", "bodyText": "just use first and second for names", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r508401350", "createdAt": "2020-10-20T10:50:16Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/bidder/krushmedia/KrushmediaBidderTest.java", "diffHunk": "@@ -176,6 +157,38 @@ public void makeBidsShouldReturnBannerBidIfBannerIsPresentInRequestImp() throws\n                 .containsOnly(BidderBid.of(Bid.builder().impid(\"123\").build(), banner, \"USD\"));\n     }\n \n+    @Test\n+    public void makeBidsShouldReturnEmptyBidderBidsFromFirstSeatBid() throws JsonProcessingException {\n+        // given\n+        final SeatBid zeroSeatBid = SeatBid.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11ab1d2b6c655f16aa8da9c60319c903235a3a5b"}, "originalPosition": 98}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "047f052dfd54b688188a083c3a5ac9b49115b4fd", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/047f052dfd54b688188a083c3a5ac9b49115b4fd", "committedDate": "2020-10-20T12:59:58Z", "message": "Additional fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15776856c4b8f8a70c55e6f7c5a065b465d32849", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/15776856c4b8f8a70c55e6f7c5a065b465d32849", "committedDate": "2020-10-20T11:52:02Z", "message": "Additional fix"}, "afterCommit": {"oid": "047f052dfd54b688188a083c3a5ac9b49115b4fd", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/047f052dfd54b688188a083c3a5ac9b49115b4fd", "committedDate": "2020-10-20T12:59:58Z", "message": "Additional fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNjgwODg1", "url": "https://github.com/prebid/prebid-server-java/pull/958#pullrequestreview-512680885", "createdAt": "2020-10-20T13:01:35Z", "commit": {"oid": "047f052dfd54b688188a083c3a5ac9b49115b4fd"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODk0NjEz", "url": "https://github.com/prebid/prebid-server-java/pull/958#pullrequestreview-516894613", "createdAt": "2020-10-26T15:26:00Z", "commit": {"oid": "047f052dfd54b688188a083c3a5ac9b49115b4fd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNToyNjowMVrOHoU9wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNjo0NDo1N1rOHoYlUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA0ODU3OA==", "bodyText": "Please use a solution with addHeader(..) method from here - https://github.com/rubicon-project/prebid-server-java/pull/948/files#diff-a83ec88bc3df7e7d95d1aa1863d63063c93a99e170759a0943d88b5f318cde27R144", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r512048578", "createdAt": "2020-10-26T15:26:01Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/krushmedia/KrushmediaBidder.java", "diffHunk": "@@ -0,0 +1,172 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class KrushmediaBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpKrushmedia>> KRUSHMEDIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpKrushmedia>>() {\n+            };\n+    private static final String URI_ACCOUNT_ID_MACRO = \"{{AccountID}}\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public KrushmediaBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+\n+        final ExtImpKrushmedia extImpKrushmedia;\n+        final String url;\n+\n+        try {\n+            extImpKrushmedia = parseImpExt(request.getImp().get(0));\n+            url = resolveEndpoint(extImpKrushmedia.getAccountId());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final BidRequest outgoingRequest = request.toBuilder()\n+                .imp(removeFirstImpExt(request.getImp()))\n+                .build();\n+\n+        return Result.of(Collections.singletonList(\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(url)\n+                        .headers(resolveHeaders(request.getDevice()))\n+                        .payload(outgoingRequest)\n+                        .body(mapper.encode(outgoingRequest))\n+                        .build()),\n+                errors);\n+    }\n+\n+    private ExtImpKrushmedia parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), KRUSHMEDIA_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(\"Error while unmarshalling bidder extension\");\n+        }\n+    }\n+\n+    private String resolveEndpoint(String accountId) {\n+        return endpointUrl.replace(URI_ACCOUNT_ID_MACRO, accountId);\n+    }\n+\n+    private static List<Imp> removeFirstImpExt(List<Imp> imps) {\n+        return IntStream.range(0, imps.size())\n+                .mapToObj(impIndex -> impIndex == 0\n+                        ? imps.get(impIndex).toBuilder().ext(null).build()\n+                        : imps.get(impIndex))\n+                .collect(Collectors.toList());\n+    }\n+\n+    private MultiMap resolveHeaders(Device device) {\n+        final MultiMap headers = HttpUtil.headers();\n+        headers.add(\"X-Openrtb-Version\", \"2.5\");\n+\n+        if (device != null) {\n+            if (StringUtils.isNotBlank(device.getUa())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "047f052dfd54b688188a083c3a5ac9b49115b4fd"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA1MDcwOA==", "bodyText": "Pls add gdpr, gdpr_consent and us_privacy params since /setuid is PBS endpoint and we need those.", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r512050708", "createdAt": "2020-10-26T15:28:39Z", "author": {"login": "rpanchyk"}, "path": "src/main/resources/bidder-config/krushmedia.yaml", "diffHunk": "@@ -0,0 +1,27 @@\n+adapters:\n+  krushmedia:\n+    enabled: false\n+    endpoint: http://ads4.krushmedia.com/?c=rtb&m=req&key={{AccountID}}\n+    pbs-enforces-gdpr: true\n+    pbs-enforces-ccpa: true\n+    modifying-vast-xml-allowed: true\n+    deprecated-names:\n+    aliases:\n+    meta-info:\n+      maintainer-email: adapter@krushmedia.com\n+      app-media-types:\n+        - banner\n+        - video\n+        - native\n+      site-media-types:\n+        - banner\n+        - video\n+        - native\n+      supported-vendors:\n+      vendor-id: 0\n+    usersync:\n+      url: https://cs.krushmedia.com/4e4abdd5ecc661643458a730b1aa927d.gif?gdpr={{gdpr}}&gdpr_consent={{gdpr_consent}}&us_privacy={{us_privacy}}&redir=\n+      redirect-url: /setuid?bidder=krushmedia&uid=[uid]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "047f052dfd54b688188a083c3a5ac9b49115b4fd"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjEwNzg1OQ==", "bodyText": "i'd rather suggest to wrap accountId with StringUtils.stripToEmpty(..) to avoid =null param value in URL.", "url": "https://github.com/prebid/prebid-server-java/pull/958#discussion_r512107859", "createdAt": "2020-10-26T16:44:57Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/krushmedia/KrushmediaBidder.java", "diffHunk": "@@ -0,0 +1,172 @@\n+package org.prebid.server.bidder.krushmedia;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.krushmedia.ExtImpKrushmedia;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+public class KrushmediaBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpKrushmedia>> KRUSHMEDIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpKrushmedia>>() {\n+            };\n+    private static final String URI_ACCOUNT_ID_MACRO = \"{{AccountID}}\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public KrushmediaBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+\n+        final ExtImpKrushmedia extImpKrushmedia;\n+        final String url;\n+\n+        try {\n+            extImpKrushmedia = parseImpExt(request.getImp().get(0));\n+            url = resolveEndpoint(extImpKrushmedia.getAccountId());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final BidRequest outgoingRequest = request.toBuilder()\n+                .imp(removeFirstImpExt(request.getImp()))\n+                .build();\n+\n+        return Result.of(Collections.singletonList(\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(url)\n+                        .headers(resolveHeaders(request.getDevice()))\n+                        .payload(outgoingRequest)\n+                        .body(mapper.encode(outgoingRequest))\n+                        .build()),\n+                errors);\n+    }\n+\n+    private ExtImpKrushmedia parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), KRUSHMEDIA_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(\"Error while unmarshalling bidder extension\");\n+        }\n+    }\n+\n+    private String resolveEndpoint(String accountId) {\n+        return endpointUrl.replace(URI_ACCOUNT_ID_MACRO, accountId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "047f052dfd54b688188a083c3a5ac9b49115b4fd"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8557b55603a1638b22ee798c88d433c5a075f605", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/8557b55603a1638b22ee798c88d433c5a075f605", "committedDate": "2020-10-26T18:23:00Z", "message": "Fixes after review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91f6787782be6179dd8040ebc1a2d7cc0da49e92", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/91f6787782be6179dd8040ebc1a2d7cc0da49e92", "committedDate": "2020-10-26T18:25:54Z", "message": "Merge branch 'master' into krushmedia_bidder/development\n\n# Conflicts:\n#\tsrc/test/resources/org/prebid/server/it/test-application.properties"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NDQwNTUw", "url": "https://github.com/prebid/prebid-server-java/pull/958#pullrequestreview-517440550", "createdAt": "2020-10-27T08:17:37Z", "commit": {"oid": "91f6787782be6179dd8040ebc1a2d7cc0da49e92"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3035, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}