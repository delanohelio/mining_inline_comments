{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MTI5NDU5", "number": 806, "title": "Create bidderconfing and imp.ext.context.data.attr in amp factory for\u2026", "bodyText": "\u2026 fpd", "createdAt": "2020-07-13T09:27:05Z", "url": "https://github.com/prebid/prebid-server-java/pull/806", "merged": true, "mergeCommit": {"oid": "f8eb1f0fe3716555fdbf754c769f369009d4bcfc"}, "closed": true, "closedAt": "2020-08-17T14:33:24Z", "author": {"login": "BraslavskiyAndrey"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0d7hIAH2gAyNDQ4MTI5NDU5OmUxODY0N2I1N2I0MDFjMGJlM2U1MDlhMzcyODk2YzEwZWEyOTRkZTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_zWWggFqTQ2ODUxODE4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e18647b57b401c0be3e509a372896c10ea294de4", "author": {"user": {"login": "BraslavskiyAndrey", "name": "Braslavskyi Andrii"}}, "url": "https://github.com/prebid/prebid-server-java/commit/e18647b57b401c0be3e509a372896c10ea294de4", "committedDate": "2020-07-13T09:22:24Z", "message": "Create bidderconfing and imp.ext.context.data.attr in amp factory for fpd"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MTM0NTY1", "url": "https://github.com/prebid/prebid-server-java/pull/806#pullrequestreview-447134565", "createdAt": "2020-07-13T10:38:51Z", "commit": {"oid": "e18647b57b401c0be3e509a372896c10ea294de4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMDozODo1MlrOGwi_hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMDo0MjoyMlrOGwjGqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU1ODE1MQ==", "bodyText": "It would be more readable with guard condition of form:\nif(targeting == null) {\n    return extRequest;\n}\n\n...", "url": "https://github.com/prebid/prebid-server-java/pull/806#discussion_r453558151", "createdAt": "2020-07-13T10:38:52Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/auction/FpdResolver.java", "diffHunk": "@@ -172,24 +176,66 @@ public ObjectNode resolveImpExt(ObjectNode impExt, ObjectNode targeting) {\n         return mapper.mapper().valueToTree(resolvedExtImp);\n     }\n \n-    public ExtRequest resolveBidRequestExt(ExtRequest extRequest, List<String> fpdBidders) {\n-        if (CollectionUtils.isEmpty(fpdBidders)) {\n-            return extRequest;\n+    public ExtRequest resolveBidRequestExt(ExtRequest extRequest, Targeting targeting) {\n+        if (targeting != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e18647b57b401c0be3e509a372896c10ea294de4"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU1OTk3Ng==", "bodyText": "userNode and siteNode could be used instead of getters", "url": "https://github.com/prebid/prebid-server-java/pull/806#discussion_r453559976", "createdAt": "2020-07-13T10:42:22Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/auction/FpdResolver.java", "diffHunk": "@@ -172,24 +176,66 @@ public ObjectNode resolveImpExt(ObjectNode impExt, ObjectNode targeting) {\n         return mapper.mapper().valueToTree(resolvedExtImp);\n     }\n \n-    public ExtRequest resolveBidRequestExt(ExtRequest extRequest, List<String> fpdBidders) {\n-        if (CollectionUtils.isEmpty(fpdBidders)) {\n-            return extRequest;\n+    public ExtRequest resolveBidRequestExt(ExtRequest extRequest, Targeting targeting) {\n+        if (targeting != null) {\n+            final ExtRequestPrebid extRequestPrebid = extRequest != null ? extRequest.getPrebid() : null;\n+            final ExtRequestPrebidData extRequestPrebidData = extRequestPrebid != null\n+                    ? extRequestPrebid.getData()\n+                    : null;\n+\n+            final ExtRequestPrebidData resolvedExtRequestPrebidData = resolveExtRequestPrebidData(extRequestPrebidData,\n+                    targeting.getBidders());\n+            final List<ExtRequestPrebidBidderConfig> resolvedBidderConfig = createAllowedAllBidderConfig(targeting);\n+\n+            if (resolvedExtRequestPrebidData != null || resolvedBidderConfig != null) {\n+                final ExtRequestPrebid.ExtRequestPrebidBuilder prebidBuilder = extRequestPrebid != null\n+                        ? extRequestPrebid.toBuilder()\n+                        : ExtRequestPrebid.builder();\n+                return ExtRequest.of(prebidBuilder\n+                        .data(resolvedExtRequestPrebidData != null\n+                                ? resolvedExtRequestPrebidData\n+                                : extRequestPrebidData)\n+                        .bidderconfig(resolvedBidderConfig).build());\n+            }\n+        }\n+        return extRequest;\n+    }\n+\n+    private ExtRequestPrebidData resolveExtRequestPrebidData(ExtRequestPrebidData data, List<String> fpdBidders) {\n+        if (CollectionUtils.isEmpty(fpdBidders) && data == null) {\n+            return null;\n+        }\n+        final List<String> originBidders = data != null ? data.getBidders() : Collections.emptyList();\n+        return CollectionUtils.isEmpty(originBidders)\n+                ? ExtRequestPrebidData.of(fpdBidders)\n+                : ExtRequestPrebidData.of(mergeBidders(fpdBidders, originBidders));\n+    }\n+\n+    private List<ExtRequestPrebidBidderConfig> createAllowedAllBidderConfig(Targeting targeting) {\n+        final ObjectNode userNode = targeting.getUser();\n+        final ObjectNode siteNode = targeting.getSite();\n+        if (targeting.getUser() == null && targeting.getSite() == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e18647b57b401c0be3e509a372896c10ea294de4"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d8acf82f4ffb24549966f75cb6bbe39a2ece5c6", "author": {"user": {"login": "BraslavskiyAndrey", "name": "Braslavskyi Andrii"}}, "url": "https://github.com/prebid/prebid-server-java/commit/7d8acf82f4ffb24549966f75cb6bbe39a2ece5c6", "committedDate": "2020-07-13T11:35:37Z", "message": "Fix pull request comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MTkxNjY2", "url": "https://github.com/prebid/prebid-server-java/pull/806#pullrequestreview-447191666", "createdAt": "2020-07-13T12:10:39Z", "commit": {"oid": "7d8acf82f4ffb24549966f75cb6bbe39a2ece5c6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NTE4MTg1", "url": "https://github.com/prebid/prebid-server-java/pull/806#pullrequestreview-468518185", "createdAt": "2020-08-17T14:32:53Z", "commit": {"oid": "7d8acf82f4ffb24549966f75cb6bbe39a2ece5c6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3079, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}