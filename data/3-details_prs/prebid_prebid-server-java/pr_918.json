{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNTg4ODgz", "number": 918, "title": "Add sizes support to AdoceanBidder", "bodyText": "", "createdAt": "2020-09-21T22:16:33Z", "url": "https://github.com/prebid/prebid-server-java/pull/918", "merged": true, "mergeCommit": {"oid": "93c4b49457be41882bde7741fdef115aabb9b352"}, "closed": true, "closedAt": "2020-10-30T07:33:42Z", "author": {"login": "AndriyPavlyuk"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLK5ARgH2gAyNDkwNTg4ODgzOjNkYzhkMWVmYzkwODk0OWJhZGVmMmYxZTU5OTcyODExNTVlMGQ5NzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXhtBOAFqTUyMDQyODcwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3dc8d1efc908949badef2f1e5997281155e0d976", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/3dc8d1efc908949badef2f1e5997281155e0d976", "committedDate": "2020-09-21T22:11:43Z", "message": "Add sizes support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f137bb9a47418838b89af5e6bcc5efaa6e0aae95", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/f137bb9a47418838b89af5e6bcc5efaa6e0aae95", "committedDate": "2020-10-27T12:51:21Z", "message": "Merge branch 'master' into adocean-add-support-sizes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d09aa16f81f66049cf793c7956c2e1046a0adc16", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/d09aa16f81f66049cf793c7956c2e1046a0adc16", "committedDate": "2020-10-27T13:31:42Z", "message": "Fixes after review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NzIxNTI0", "url": "https://github.com/prebid/prebid-server-java/pull/918#pullrequestreview-517721524", "createdAt": "2020-10-27T13:48:04Z", "commit": {"oid": "d09aa16f81f66049cf793c7956c2e1046a0adc16"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5OTEyMTA4", "url": "https://github.com/prebid/prebid-server-java/pull/918#pullrequestreview-519912108", "createdAt": "2020-10-29T17:31:48Z", "commit": {"oid": "d09aa16f81f66049cf793c7956c2e1046a0adc16"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzozMTo0OFrOHqnAiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzozMzowN1rOHqnDzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MTM1Mw==", "bodyText": "What the difference?", "url": "https://github.com/prebid/prebid-server-java/pull/918#discussion_r514441353", "createdAt": "2020-10-29T17:31:48Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -125,13 +132,19 @@ private boolean addRequestAndCheckIfDuplicates(List<HttpRequest<Void>> httpReque\n                         continue;\n                     }\n \n+                    queryParams.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+                    final List<String> sizeValues = test != null && test == 1\n+                            ? setSlaveSizesParam(slaveSizes, true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d09aa16f81f66049cf793c7956c2e1046a0adc16"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MjE5MA==", "bodyText": "Check for nulls in values for headers.", "url": "https://github.com/prebid/prebid-server-java/pull/918#discussion_r514442190", "createdAt": "2020-10-29T17:33:07Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -170,38 +207,55 @@ private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consen\n             uriBuilder.addParameter(\"hcuserid\", user.getBuyeruid());\n         }\n \n+        final List<String> sizeValues = test != null && test == 1\n+                ? setSlaveSizesParam(slaveSizes, true)\n+                : setSlaveSizesParam(slaveSizes, false);\n+\n+        if (CollectionUtils.isNotEmpty(sizeValues)) {\n+            uriBuilder.addParameter(\"aosspsizes\", String.join(\"-\", sizeValues));\n+        }\n+\n         return uriBuilder.toString();\n     }\n \n+    private List<String> setSlaveSizesParam(Map<String, String> slaveSizes, boolean orderByKey) {\n+        final Set<String> slaveIDs = orderByKey ? new TreeSet<>(slaveSizes.keySet()) : slaveSizes.keySet();\n+\n+        return slaveIDs.stream()\n+                .filter(slaveId -> StringUtils.isNotBlank(slaveSizes.get(slaveId)))\n+                .map(rawSlaveID -> String.format(\"%s~%s\", rawSlaveID.replaceFirst(\"adocean\", \"\"),\n+                        slaveSizes.get(rawSlaveID)))\n+                .collect(Collectors.toList());\n+    }\n+\n     private static MultiMap getHeaders(BidRequest request) {\n         final MultiMap headers = HttpUtil.headers();\n         if (request.getDevice() != null) {\n-            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.USER_AGENT_HEADER.toString(),\n-                    request.getDevice().getUa());\n-\n-            if (StringUtils.isNotBlank(request.getDevice().getIp())) {\n-                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n-                        request.getDevice().getIp());\n-            } else if (StringUtils.isNotBlank(request.getDevice().getIpv6())) {\n-                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n-                        request.getDevice().getIpv6());\n-            }\n+            addHeader(headers, \"User-Agent\", request.getDevice().getUa());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d09aa16f81f66049cf793c7956c2e1046a0adc16"}, "originalPosition": 181}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20839591fcf7ebd44fd3a82579e4b13db0fb9e13", "author": {"user": null}, "url": "https://github.com/prebid/prebid-server-java/commit/20839591fcf7ebd44fd3a82579e4b13db0fb9e13", "committedDate": "2020-10-29T20:14:41Z", "message": "Code fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDI4NzA1", "url": "https://github.com/prebid/prebid-server-java/pull/918#pullrequestreview-520428705", "createdAt": "2020-10-30T07:33:32Z", "commit": {"oid": "20839591fcf7ebd44fd3a82579e4b13db0fb9e13"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2997, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}