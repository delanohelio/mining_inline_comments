{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NzMyNDAw", "number": 750, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMzowNDo1N1rOEZ9-FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMDo0OTo0OVrOEiftWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NjY1MTczOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/bidder/ninthdecimal/NinthdecimalBidder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMzowNDo1N1rOHDGazg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMzowNDo1N1rOHDGazg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAxMjk0Mg==", "bodyText": "No reason to check this in each bidder, org.prebid.server.validation.RequestValidator#validate does it.", "url": "https://github.com/prebid/prebid-server-java/pull/750#discussion_r473012942", "createdAt": "2020-08-19T13:04:57Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/ninthdecimal/NinthdecimalBidder.java", "diffHunk": "@@ -0,0 +1,256 @@\n+package org.prebid.server.bidder.ninthdecimal;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.App;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ninthdecimal.ExtImpNinthdecimal;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class NinthdecimalBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpNinthdecimal>> NINTHDECIMAL_EXT_TYPE_REFERENCE = new\n+            TypeReference<ExtPrebid<?, ExtImpNinthdecimal>>() {\n+            };\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public NinthdecimalBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67a85f8a38f7cfee5bee79cdf6c7370aee2faf90"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1NjY1NDcyOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/bidder/ninthdecimal/NinthdecimalBidder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMzowNTozOVrOHDGcng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMzowNTozOVrOHDGcng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAxMzQwNg==", "bodyText": "Can be final.", "url": "https://github.com/prebid/prebid-server-java/pull/750#discussion_r473013406", "createdAt": "2020-08-19T13:05:39Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/ninthdecimal/NinthdecimalBidder.java", "diffHunk": "@@ -0,0 +1,256 @@\n+package org.prebid.server.bidder.ninthdecimal;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.App;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ninthdecimal.ExtImpNinthdecimal;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class NinthdecimalBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpNinthdecimal>> NINTHDECIMAL_EXT_TYPE_REFERENCE = new\n+            TypeReference<ExtPrebid<?, ExtImpNinthdecimal>>() {\n+            };\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public NinthdecimalBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        List<HttpRequest<BidRequest>> httpRequests = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67a85f8a38f7cfee5bee79cdf6c7370aee2faf90"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Njc4NjE1OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/bidder/ninthdecimal/NinthdecimalBidder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMzozNTozNVrOHDHtAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMzozNTozNVrOHDHtAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAzMzk4Ng==", "bodyText": "Can we do it in updateImp(..) method?", "url": "https://github.com/prebid/prebid-server-java/pull/750#discussion_r473033986", "createdAt": "2020-08-19T13:35:35Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/ninthdecimal/NinthdecimalBidder.java", "diffHunk": "@@ -0,0 +1,256 @@\n+package org.prebid.server.bidder.ninthdecimal;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.App;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ninthdecimal.ExtImpNinthdecimal;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class NinthdecimalBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpNinthdecimal>> NINTHDECIMAL_EXT_TYPE_REFERENCE = new\n+            TypeReference<ExtPrebid<?, ExtImpNinthdecimal>>() {\n+            };\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public NinthdecimalBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        List<HttpRequest<BidRequest>> httpRequests = new ArrayList<>();\n+        try {\n+            final Map<ExtImpNinthdecimal, List<Imp>> impToExtImp = getImpToExtImp(request, errors);\n+            httpRequests.addAll(buildBidderRequests(request, impToExtImp));\n+        } catch (PreBidException e) {\n+            return Result.of(Collections.emptyList(), errors);\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private Map<ExtImpNinthdecimal, List<Imp>> getImpToExtImp(BidRequest request, List<BidderError> errors) {\n+        final Map<ExtImpNinthdecimal, List<Imp>> extToListOfUpdatedImp = new HashMap<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpNinthdecimal extImpNinthdecimal = parseAndValidateImpExt(imp);\n+                final Imp updatedImp = updateImp(imp);\n+\n+                extToListOfUpdatedImp.putIfAbsent(extImpNinthdecimal, new ArrayList<>());\n+                extToListOfUpdatedImp.get(extImpNinthdecimal).add(updatedImp);\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        if (extToListOfUpdatedImp.isEmpty()) {\n+            throw new PreBidException(\"No appropriate impressions\");\n+        }\n+\n+        return extToListOfUpdatedImp;\n+    }\n+\n+    private ExtImpNinthdecimal parseAndValidateImpExt(Imp imp) {\n+        final ExtImpNinthdecimal extImpNinthdecimal;\n+        try {\n+            extImpNinthdecimal = mapper.mapper().convertValue(imp.getExt(), NINTHDECIMAL_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+\n+        if (StringUtils.isBlank(extImpNinthdecimal.getPubid())) {\n+            throw new PreBidException(\"No pubid value provided\");\n+        }\n+\n+        return extImpNinthdecimal;\n+    }\n+\n+    private static Imp updateImp(Imp imp) {\n+        final Imp.ImpBuilder impBuilder = imp.toBuilder().ext(null);\n+\n+        final Video video = imp.getVideo();\n+        if (video != null) {\n+            return impBuilder.banner(null)\n+                    .audio(null)\n+                    .xNative(null)\n+                    .build();\n+        }\n+\n+        final Banner banner = imp.getBanner();\n+        if (banner != null) {\n+            return impBuilder.banner(modifyImpBanner(banner)).build();\n+        }\n+\n+        throw new PreBidException(\"Unsupported impression has been received\");\n+    }\n+\n+    private static Banner modifyImpBanner(Banner banner) {\n+        if (banner != null && (banner.getW() == null || banner.getH() == null)) {\n+            final Banner.BannerBuilder bannerBuilder = banner.toBuilder();\n+            final List<Format> originalFormat = banner.getFormat();\n+\n+            if (CollectionUtils.isEmpty(originalFormat)) {\n+                throw new PreBidException(\"Expected at least one banner.format entry or explicit w/h\");\n+            }\n+\n+            final List<Format> formatSkipFirst = originalFormat.subList(1, originalFormat.size());\n+            bannerBuilder.format(formatSkipFirst);\n+\n+            Format firstFormat = originalFormat.get(0);\n+            bannerBuilder.w(firstFormat.getW());\n+            bannerBuilder.h(firstFormat.getH());\n+\n+            return bannerBuilder.build();\n+        }\n+\n+        return banner;\n+    }\n+\n+    private List<HttpRequest<BidRequest>> buildBidderRequests(BidRequest bidRequest,\n+                                                               Map<ExtImpNinthdecimal, List<Imp>> impExtToListOfImps) {\n+        final List<HttpRequest<BidRequest>> httpRequests = new ArrayList<>();\n+\n+        for (Map.Entry<ExtImpNinthdecimal, List<Imp>> impExtAndListOfImo : impExtToListOfImps.entrySet()) {\n+            final ExtImpNinthdecimal extImpNinthdecimal = impExtAndListOfImo.getKey();\n+            final List<Imp> imps = impExtAndListOfImo.getValue();\n+            final BidRequest updatedBidRequest = makeBidRequest(bidRequest, extImpNinthdecimal, imps);\n+\n+            final String body = mapper.encode(updatedBidRequest);\n+            final MultiMap headers = HttpUtil.headers()\n+                    .add(\"x-openrtb-version\", \"2.5\");\n+            final String createdEndpoint = endpointUrl + extImpNinthdecimal.getPubid();\n+\n+            final HttpRequest<BidRequest> createdBidRequest = HttpRequest.<BidRequest>builder()\n+                    .method(HttpMethod.POST)\n+                    .uri(createdEndpoint)\n+                    .body(body)\n+                    .headers(headers)\n+                    .payload(bidRequest)\n+                    .build();\n+\n+            httpRequests.add(createdBidRequest);\n+        }\n+\n+        return httpRequests;\n+    }\n+\n+    private static BidRequest makeBidRequest(BidRequest preBidRequest, ExtImpNinthdecimal extImpNinthdecimal,\n+                                             List<Imp> imps) {\n+        final BidRequest.BidRequestBuilder bidRequestBuilder = preBidRequest.toBuilder();\n+\n+        final List<Imp> modifiedImps = imps.stream()\n+                .map(imp -> imp.toBuilder().tagid(extImpNinthdecimal.getPlacement()).build())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67a85f8a38f7cfee5bee79cdf6c7370aee2faf90"}, "originalPosition": 185}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1Njc4ODA2OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/bidder/ninthdecimal/NinthdecimalBidder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMzozNTo1N1rOHDHuNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMzozNTo1N1rOHDHuNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzAzNDI5NA==", "bodyText": "Pls fix typo impExtAndListOfImo.", "url": "https://github.com/prebid/prebid-server-java/pull/750#discussion_r473034294", "createdAt": "2020-08-19T13:35:57Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/ninthdecimal/NinthdecimalBidder.java", "diffHunk": "@@ -0,0 +1,256 @@\n+package org.prebid.server.bidder.ninthdecimal;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.App;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ninthdecimal.ExtImpNinthdecimal;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class NinthdecimalBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpNinthdecimal>> NINTHDECIMAL_EXT_TYPE_REFERENCE = new\n+            TypeReference<ExtPrebid<?, ExtImpNinthdecimal>>() {\n+            };\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public NinthdecimalBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        if (CollectionUtils.isEmpty(request.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"No impression in the bid request\"));\n+        }\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        List<HttpRequest<BidRequest>> httpRequests = new ArrayList<>();\n+        try {\n+            final Map<ExtImpNinthdecimal, List<Imp>> impToExtImp = getImpToExtImp(request, errors);\n+            httpRequests.addAll(buildBidderRequests(request, impToExtImp));\n+        } catch (PreBidException e) {\n+            return Result.of(Collections.emptyList(), errors);\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private Map<ExtImpNinthdecimal, List<Imp>> getImpToExtImp(BidRequest request, List<BidderError> errors) {\n+        final Map<ExtImpNinthdecimal, List<Imp>> extToListOfUpdatedImp = new HashMap<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpNinthdecimal extImpNinthdecimal = parseAndValidateImpExt(imp);\n+                final Imp updatedImp = updateImp(imp);\n+\n+                extToListOfUpdatedImp.putIfAbsent(extImpNinthdecimal, new ArrayList<>());\n+                extToListOfUpdatedImp.get(extImpNinthdecimal).add(updatedImp);\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        if (extToListOfUpdatedImp.isEmpty()) {\n+            throw new PreBidException(\"No appropriate impressions\");\n+        }\n+\n+        return extToListOfUpdatedImp;\n+    }\n+\n+    private ExtImpNinthdecimal parseAndValidateImpExt(Imp imp) {\n+        final ExtImpNinthdecimal extImpNinthdecimal;\n+        try {\n+            extImpNinthdecimal = mapper.mapper().convertValue(imp.getExt(), NINTHDECIMAL_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+\n+        if (StringUtils.isBlank(extImpNinthdecimal.getPubid())) {\n+            throw new PreBidException(\"No pubid value provided\");\n+        }\n+\n+        return extImpNinthdecimal;\n+    }\n+\n+    private static Imp updateImp(Imp imp) {\n+        final Imp.ImpBuilder impBuilder = imp.toBuilder().ext(null);\n+\n+        final Video video = imp.getVideo();\n+        if (video != null) {\n+            return impBuilder.banner(null)\n+                    .audio(null)\n+                    .xNative(null)\n+                    .build();\n+        }\n+\n+        final Banner banner = imp.getBanner();\n+        if (banner != null) {\n+            return impBuilder.banner(modifyImpBanner(banner)).build();\n+        }\n+\n+        throw new PreBidException(\"Unsupported impression has been received\");\n+    }\n+\n+    private static Banner modifyImpBanner(Banner banner) {\n+        if (banner != null && (banner.getW() == null || banner.getH() == null)) {\n+            final Banner.BannerBuilder bannerBuilder = banner.toBuilder();\n+            final List<Format> originalFormat = banner.getFormat();\n+\n+            if (CollectionUtils.isEmpty(originalFormat)) {\n+                throw new PreBidException(\"Expected at least one banner.format entry or explicit w/h\");\n+            }\n+\n+            final List<Format> formatSkipFirst = originalFormat.subList(1, originalFormat.size());\n+            bannerBuilder.format(formatSkipFirst);\n+\n+            Format firstFormat = originalFormat.get(0);\n+            bannerBuilder.w(firstFormat.getW());\n+            bannerBuilder.h(firstFormat.getH());\n+\n+            return bannerBuilder.build();\n+        }\n+\n+        return banner;\n+    }\n+\n+    private List<HttpRequest<BidRequest>> buildBidderRequests(BidRequest bidRequest,\n+                                                               Map<ExtImpNinthdecimal, List<Imp>> impExtToListOfImps) {\n+        final List<HttpRequest<BidRequest>> httpRequests = new ArrayList<>();\n+\n+        for (Map.Entry<ExtImpNinthdecimal, List<Imp>> impExtAndListOfImo : impExtToListOfImps.entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67a85f8a38f7cfee5bee79cdf6c7370aee2faf90"}, "originalPosition": 156}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NjA2MDg4OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/bidder/ninthdecimal/NinthdecimalBidder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMDo0ODoxOFrOHQaBew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMDo0ODoxOFrOHQaBew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk2NTYyNw==", "bodyText": "Pls set currency from bid response.", "url": "https://github.com/prebid/prebid-server-java/pull/750#discussion_r486965627", "createdAt": "2020-09-11T10:48:18Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/ninthdecimal/NinthdecimalBidder.java", "diffHunk": "@@ -0,0 +1,251 @@\n+package org.prebid.server.bidder.ninthdecimal;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.App;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.ninthdecimal.ExtImpNinthdecimal;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+public class NinthdecimalBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpNinthdecimal>> NINTHDECIMAL_EXT_TYPE_REFERENCE = new\n+            TypeReference<ExtPrebid<?, ExtImpNinthdecimal>>() {\n+            };\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public NinthdecimalBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> httpRequests = new ArrayList<>();\n+        try {\n+            final Map<ExtImpNinthdecimal, List<Imp>> impToExtImp = getImpToExtImp(request, errors);\n+            httpRequests.addAll(buildBidderRequests(request, impToExtImp));\n+        } catch (PreBidException e) {\n+            return Result.of(Collections.emptyList(), errors);\n+        }\n+\n+        return Result.of(httpRequests, errors);\n+    }\n+\n+    private Map<ExtImpNinthdecimal, List<Imp>> getImpToExtImp(BidRequest request, List<BidderError> errors) {\n+        final Map<ExtImpNinthdecimal, List<Imp>> extToListOfUpdatedImp = new HashMap<>();\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpNinthdecimal extImpNinthdecimal = parseAndValidateImpExt(imp);\n+                final Imp updatedImp = updateImp(imp);\n+\n+                extToListOfUpdatedImp.putIfAbsent(extImpNinthdecimal, new ArrayList<>());\n+                extToListOfUpdatedImp.get(extImpNinthdecimal).add(updatedImp);\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        if (extToListOfUpdatedImp.isEmpty()) {\n+            throw new PreBidException(\"No appropriate impressions\");\n+        }\n+\n+        return extToListOfUpdatedImp;\n+    }\n+\n+    private ExtImpNinthdecimal parseAndValidateImpExt(Imp imp) {\n+        final ExtImpNinthdecimal extImpNinthdecimal;\n+        try {\n+            extImpNinthdecimal = mapper.mapper().convertValue(imp.getExt(), NINTHDECIMAL_EXT_TYPE_REFERENCE)\n+                    .getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+\n+        if (StringUtils.isBlank(extImpNinthdecimal.getPubid())) {\n+            throw new PreBidException(\"No pubid value provided\");\n+        }\n+\n+        return extImpNinthdecimal;\n+    }\n+\n+    private static Imp updateImp(Imp imp) {\n+        final Imp.ImpBuilder impBuilder = imp.toBuilder().ext(null);\n+\n+        final Video video = imp.getVideo();\n+        if (video != null) {\n+            return impBuilder.banner(null)\n+                    .audio(null)\n+                    .xNative(null)\n+                    .build();\n+        }\n+\n+        final Banner banner = imp.getBanner();\n+        if (banner != null) {\n+            return impBuilder.banner(modifyImpBanner(banner)).build();\n+        }\n+\n+        throw new PreBidException(\"Unsupported impression has been received\");\n+    }\n+\n+    private static Banner modifyImpBanner(Banner banner) {\n+        if (banner != null && (banner.getW() == null || banner.getH() == null)) {\n+            final Banner.BannerBuilder bannerBuilder = banner.toBuilder();\n+            final List<Format> originalFormat = banner.getFormat();\n+\n+            if (CollectionUtils.isEmpty(originalFormat)) {\n+                throw new PreBidException(\"Expected at least one banner.format entry or explicit w/h\");\n+            }\n+\n+            final List<Format> formatSkipFirst = originalFormat.subList(1, originalFormat.size());\n+            bannerBuilder.format(formatSkipFirst);\n+\n+            Format firstFormat = originalFormat.get(0);\n+            bannerBuilder.w(firstFormat.getW());\n+            bannerBuilder.h(firstFormat.getH());\n+\n+            return bannerBuilder.build();\n+        }\n+\n+        return banner;\n+    }\n+\n+    private List<HttpRequest<BidRequest>> buildBidderRequests(BidRequest bidRequest,\n+                                                               Map<ExtImpNinthdecimal, List<Imp>> impExtToListOfImps) {\n+        final List<HttpRequest<BidRequest>> httpRequests = new ArrayList<>();\n+\n+        for (Map.Entry<ExtImpNinthdecimal, List<Imp>> impExtAndListOfImp : impExtToListOfImps.entrySet()) {\n+            final ExtImpNinthdecimal extImpNinthdecimal = impExtAndListOfImp.getKey();\n+            final List<Imp> imps = impExtAndListOfImp.getValue();\n+            final BidRequest updatedBidRequest = makeBidRequest(bidRequest, extImpNinthdecimal, imps);\n+\n+            final String body = mapper.encode(updatedBidRequest);\n+            final MultiMap headers = HttpUtil.headers()\n+                    .add(\"x-openrtb-version\", \"2.5\");\n+            final String createdEndpoint = endpointUrl + extImpNinthdecimal.getPubid();\n+\n+            final HttpRequest<BidRequest> createdBidRequest = HttpRequest.<BidRequest>builder()\n+                    .method(HttpMethod.POST)\n+                    .uri(createdEndpoint)\n+                    .body(body)\n+                    .headers(headers)\n+                    .payload(bidRequest)\n+                    .build();\n+\n+            httpRequests.add(createdBidRequest);\n+        }\n+\n+        return httpRequests;\n+    }\n+\n+    private static BidRequest makeBidRequest(BidRequest preBidRequest, ExtImpNinthdecimal extImpNinthdecimal,\n+                                             List<Imp> imps) {\n+        final BidRequest.BidRequestBuilder bidRequestBuilder = preBidRequest.toBuilder();\n+        final Site site = preBidRequest.getSite();\n+        if (site != null) {\n+            bidRequestBuilder.site(site.toBuilder().publisher(null).domain(\"\").build());\n+        }\n+\n+        final App app = preBidRequest.getApp();\n+        if (app != null) {\n+            bidRequestBuilder.app(app.toBuilder().publisher(null).build());\n+        }\n+        return bidRequestBuilder.imp(updateImps(imps, extImpNinthdecimal.getPlacement())).build();\n+    }\n+\n+    private static List<Imp> updateImps(List<Imp> imps, String placement) {\n+        return imps.stream()\n+                .map(imp -> imp.toBuilder().tagid(placement).build())\n+                .collect(Collectors.toList());\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        try {\n+            final BidResponse bidResponse = mapper.decodeValue(httpCall.getResponse().getBody(), BidResponse.class);\n+            return Result.of(extractBids(httpCall.getRequest().getPayload(), bidResponse), Collections.emptyList());\n+        } catch (DecodeException | PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+    }\n+\n+    private static List<BidderBid> extractBids(BidRequest bidRequest, BidResponse bidResponse) {\n+        if (bidResponse == null || bidResponse.getSeatbid() == null) {\n+            return Collections.emptyList();\n+        }\n+        if (bidResponse.getSeatbid().size() != 1) {\n+            throw new PreBidException(String.format(\"Invalid SeatBids count: %d\", bidResponse.getSeatbid().size()));\n+        }\n+        return bidsFromResponse(bidRequest, bidResponse);\n+    }\n+\n+    private static List<BidderBid> bidsFromResponse(BidRequest bidRequest, BidResponse bidResponse) {\n+        return bidResponse.getSeatbid().stream()\n+                .map(SeatBid::getBid)\n+                .flatMap(Collection::stream)\n+                .map(bid -> BidderBid.of(bid, getType(bid.getImpid(), bidRequest.getImp()), DEFAULT_BID_CURRENCY))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4765fdbd818980e17284275c923f602af224e645"}, "originalPosition": 231}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NjA2NDAwOnYy", "diffSide": "RIGHT", "path": "src/main/resources/bidder-config/ninthdecimal.yaml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMDo0OToyMFrOHQaDag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMDo0OToyMFrOHQaDag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk2NjEyMg==", "bodyText": "Pls add privacy macro.", "url": "https://github.com/prebid/prebid-server-java/pull/750#discussion_r486966122", "createdAt": "2020-09-11T10:49:20Z", "author": {"login": "rpanchyk"}, "path": "src/main/resources/bidder-config/ninthdecimal.yaml", "diffHunk": "@@ -0,0 +1,25 @@\n+adapters:\n+  ninthdecimal:\n+    enabled: false\n+    endpoint: http://rtb.ninthdecimal.com/xp/get?pubid=\n+    pbs-enforces-gdpr: true\n+    pbs-enforces-ccpa: true\n+    modifying-vast-xml-allowed: true\n+    deprecated-names:\n+    aliases:\n+    meta-info:\n+      maintainer-email: abudig@ninthdecimal.com\n+      app-media-types:\n+        - banner\n+        - video\n+      site-media-types:\n+        - banner\n+        - video\n+      supported-vendors:\n+      vendor-id: 0\n+    usersync:\n+      url: https://rtb.ninthdecimal.com/xp/user-sync?acctid={aid}&&redirect=\n+      redirect-url: /setuid?bidder=ninthdecimal&gdpr={{gdpr}}&gdpr_consent={{gdpr_consent}}&uid=$UID", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4765fdbd818980e17284275c923f602af224e645"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NjA2NTU0OnYy", "diffSide": "RIGHT", "path": "src/test/resources/org/prebid/server/it/openrtb2/ninthdecimal/test-ninthdecimal-bid-request.json", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMDo0OTo0OVrOHQaEVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMDo0OTo0OVrOHQaEVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk2NjM1OA==", "bodyText": "No need currency here.", "url": "https://github.com/prebid/prebid-server-java/pull/750#discussion_r486966358", "createdAt": "2020-09-11T10:49:49Z", "author": {"login": "rpanchyk"}, "path": "src/test/resources/org/prebid/server/it/openrtb2/ninthdecimal/test-ninthdecimal-bid-request.json", "diffHunk": "@@ -0,0 +1,97 @@\n+{\n+  \"id\": \"tid\",\n+  \"imp\": [\n+    {\n+      \"id\": \"testimpid\",\n+      \"banner\": {\n+        \"format\": [\n+          {\n+            \"w\": 320,\n+            \"h\": 250\n+          },\n+          {\n+            \"w\": 320,\n+            \"h\": 300\n+          }\n+        ],\n+        \"w\": 320,\n+        \"h\": 250\n+      },\n+      \"tagid\": \"dummyplacement\"\n+    }\n+  ],\n+  \"site\": {\n+    \"domain\": \"\",\n+    \"page\": \"http://www.example.com\",\n+    \"ext\": {\n+      \"amp\": 0\n+    }\n+  },\n+  \"device\": {\n+    \"ua\": \"userAgent\",\n+    \"dnt\": 2,\n+    \"ip\": \"193.168.244.1\",\n+    \"pxratio\": 4.2,\n+    \"language\": \"en\",\n+    \"ifa\": \"ifaId\"\n+  },\n+  \"user\": {\n+    \"buyeruid\": \"ND-UID\",\n+    \"ext\": {\n+      \"consent\": \"consentValue\",\n+      \"digitrust\": {\n+        \"id\": \"id\",\n+        \"keyv\": 123,\n+        \"pref\": 0\n+      }\n+    }\n+  },\n+  \"at\": 1,\n+  \"tmax\": 5000,\n+  \"cur\": [\n+    \"USD\"\n+  ],\n+  \"source\": {\n+    \"fd\": 1,\n+    \"tid\": \"tid\"\n+  },\n+  \"regs\": {\n+    \"ext\": {\n+      \"gdpr\": 0\n+    }\n+  },\n+  \"ext\": {\n+    \"prebid\": {\n+      \"currency\": {\n+        \"rates\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4765fdbd818980e17284275c923f602af224e645"}, "originalPosition": 66}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4080, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}