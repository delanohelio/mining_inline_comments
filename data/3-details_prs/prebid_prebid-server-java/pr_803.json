{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3MDU1NDM1", "number": 803, "title": "Support app in EplanningBidder", "bodyText": "Change defining URL in EplanningBidder by adding information from request.api", "createdAt": "2020-07-09T19:38:28Z", "url": "https://github.com/prebid/prebid-server-java/pull/803", "merged": true, "mergeCommit": {"oid": "535da959d81833465764cfcdb1a68caa171da202"}, "closed": true, "closedAt": "2020-09-15T17:14:12Z", "author": {"login": "AndriyPavlyuk"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczUQiVgH2gAyNDQ3MDU1NDM1OjUzYjM5NDI5ZjEyYmU1OTU2MDYwY2YwYmNlNTI5MjkwNjkwYWQ4NzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJKh4sgH2gAyNDQ3MDU1NDM1OmJiODJlNDdjZmI2NjEyY2NhZGI5NmRjMjk2Mzc4MGM2MTYyMjFkNzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "53b39429f12be5956060cf0bce529290690ad874", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/53b39429f12be5956060cf0bce529290690ad874", "committedDate": "2020-07-09T19:32:23Z", "message": "Support app in EplanningBidder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1ODE1Mjc4", "url": "https://github.com/prebid/prebid-server-java/pull/803#pullrequestreview-485815278", "createdAt": "2020-09-10T10:58:16Z", "commit": {"oid": "53b39429f12be5956060cf0bce529290690ad874"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMDo1ODoxNlrOHPuN8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMTowNDozMlrOHPuaNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI0NzkyMQ==", "bodyText": "Pls extract request.getApp() to separate variable since it is used several times in method.", "url": "https://github.com/prebid/prebid-server-java/pull/803#discussion_r486247921", "createdAt": "2020-09-10T10:58:16Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/eplanning/EplanningBidder.java", "diffHunk": "@@ -193,19 +195,45 @@ private String resolveRequestUri(BidRequest request, List<String> requestsString\n         final String pageUrl = site != null && StringUtils.isNotBlank(site.getPage())\n                 ? site.getPage() : DEFAULT_PAGE_URL;\n \n-        String uri = endpointUrl + String.format(\"/%s/%s/%s/%s?ct=1&r=pbs&ncb=1&ur=%s&e=%s\",\n-                clientId, DFP_CLIENT_ID, pageDomain, SEC, HttpUtil.encodeUrl(pageUrl),\n-                String.join(\"+\", requestsStrings));\n+        final String requestTarget = request.getApp() != null && StringUtils.isNotBlank(request.getApp().getBundle())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53b39429f12be5956060cf0bce529290690ad874"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI1MDA5Mw==", "bodyText": "Would it be better if we get a small refactoring for fetching the value like:\nfinal String buyeruid = user != null ? user.getBuyeruid() : null;\nthen just replace current condition with buyeruid != null.\nBut up to you.", "url": "https://github.com/prebid/prebid-server-java/pull/803#discussion_r486250093", "createdAt": "2020-09-10T11:02:28Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/eplanning/EplanningBidder.java", "diffHunk": "@@ -193,19 +195,45 @@ private String resolveRequestUri(BidRequest request, List<String> requestsString\n         final String pageUrl = site != null && StringUtils.isNotBlank(site.getPage())\n                 ? site.getPage() : DEFAULT_PAGE_URL;\n \n-        String uri = endpointUrl + String.format(\"/%s/%s/%s/%s?ct=1&r=pbs&ncb=1&ur=%s&e=%s\",\n-                clientId, DFP_CLIENT_ID, pageDomain, SEC, HttpUtil.encodeUrl(pageUrl),\n-                String.join(\"+\", requestsStrings));\n+        final String requestTarget = request.getApp() != null && StringUtils.isNotBlank(request.getApp().getBundle())\n+                ? request.getApp().getBundle()\n+                : pageDomain;\n+\n+        final String uri = endpointUrl + String.format(\"/%s/%s/%s/%s\", clientId, DFP_CLIENT_ID, requestTarget, SEC);\n+\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(uri)\n+                .addParameter(\"r\", \"pbs\")\n+                .addParameter(\"ncb\", \"1\");\n+\n+        if (request.getApp() == null) {\n+            uriBuilder.addParameter(\"ur\", pageUrl);\n+        }\n+        uriBuilder.addParameter(\"e\", String.join(\"+\", requestsStrings));\n \n         final User user = request.getUser();\n         if (user != null && StringUtils.isNotBlank(user.getBuyeruid())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53b39429f12be5956060cf0bce529290690ad874"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjI1MTA2MA==", "bodyText": "We need to safe query string values with StringUtils.stripToNull(..) to avoid null as value.\nPls check all added (and existing) params.", "url": "https://github.com/prebid/prebid-server-java/pull/803#discussion_r486251060", "createdAt": "2020-09-10T11:04:32Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/eplanning/EplanningBidder.java", "diffHunk": "@@ -193,19 +195,45 @@ private String resolveRequestUri(BidRequest request, List<String> requestsString\n         final String pageUrl = site != null && StringUtils.isNotBlank(site.getPage())\n                 ? site.getPage() : DEFAULT_PAGE_URL;\n \n-        String uri = endpointUrl + String.format(\"/%s/%s/%s/%s?ct=1&r=pbs&ncb=1&ur=%s&e=%s\",\n-                clientId, DFP_CLIENT_ID, pageDomain, SEC, HttpUtil.encodeUrl(pageUrl),\n-                String.join(\"+\", requestsStrings));\n+        final String requestTarget = request.getApp() != null && StringUtils.isNotBlank(request.getApp().getBundle())\n+                ? request.getApp().getBundle()\n+                : pageDomain;\n+\n+        final String uri = endpointUrl + String.format(\"/%s/%s/%s/%s\", clientId, DFP_CLIENT_ID, requestTarget, SEC);\n+\n+        final URIBuilder uriBuilder = new URIBuilder()\n+                .setPath(uri)\n+                .addParameter(\"r\", \"pbs\")\n+                .addParameter(\"ncb\", \"1\");\n+\n+        if (request.getApp() == null) {\n+            uriBuilder.addParameter(\"ur\", pageUrl);\n+        }\n+        uriBuilder.addParameter(\"e\", String.join(\"+\", requestsStrings));\n \n         final User user = request.getUser();\n         if (user != null && StringUtils.isNotBlank(user.getBuyeruid())) {\n-            uri = uri + String.format(\"&uid=%s\", user.getBuyeruid());\n+            uriBuilder.addParameter(\"uid\", user.getBuyeruid());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53b39429f12be5956060cf0bce529290690ad874"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd3cdf80c7711e68101cb64c49c4787ea9b437f4", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/fd3cdf80c7711e68101cb64c49c4787ea9b437f4", "committedDate": "2020-09-11T09:21:37Z", "message": "Refactoring code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NzQxMTk4", "url": "https://github.com/prebid/prebid-server-java/pull/803#pullrequestreview-486741198", "createdAt": "2020-09-11T11:57:26Z", "commit": {"oid": "fd3cdf80c7711e68101cb64c49c4787ea9b437f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb82e47cfb6612ccadb96dc2963780c616221d77", "author": {"user": {"login": "rpanchyk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/bb82e47cfb6612ccadb96dc2963780c616221d77", "committedDate": "2020-09-15T16:38:37Z", "message": "Merge branch 'master' into eplanning-support-apps"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3074, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}