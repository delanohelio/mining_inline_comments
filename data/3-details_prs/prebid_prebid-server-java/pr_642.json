{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNzc1MDMw", "number": 642, "title": "Fixing IP error", "bodyText": "Fixing error caused during masking IP.\nLog:\n19:01:41\n2020-03-15 19:01:41.222 ERROR 22 --- [ntloop-thread-2] o.p.s.handler.openrtb2.AuctionHandler : Critical error while running the auction\n\n19:01:41\njava.lang.StringIndexOutOfBoundsException: String index out of range: -1\n\n19:01:41\nat java.lang.String.substring(String.java:1967)\n\n19:01:41\nat org.prebid.server.auction.PrivacyEnforcementService.maskIp(PrivacyEnforcementService.java:342)\n\n19:01:41\nat org.prebid.server.auction.PrivacyEnforcementService.maskIpv4(PrivacyEnforcementService.java:323)\n\n19:01:41\nat org.prebid.server.auction.PrivacyEnforcementService.maskDevice(PrivacyEnforcementService.java:308)", "createdAt": "2020-03-20T23:10:15Z", "url": "https://github.com/prebid/prebid-server-java/pull/642", "merged": true, "mergeCommit": {"oid": "9ee180417c4a5501c5d10043b83d8257d1bc85ac"}, "closed": true, "closedAt": "2020-06-04T12:30:53Z", "author": {"login": "AndriyPavlyuk"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPouOFAH2gAyMzkxNzc1MDMwOjg0NTQ2ZTk4NDU4ZjMyMzNhMzMxYjZmMWU0ODFjZDExOWYxYTkwMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn9NvogFqTQyNDM4OTU4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "84546e98458f3233a331b6f1e481cd119f1a9021", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/84546e98458f3233a331b6f1e481cd119f1a9021", "committedDate": "2020-03-20T23:01:38Z", "message": "Fixing ip error PrivacyEnforcementService during maskIp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MzgxNTE4", "url": "https://github.com/prebid/prebid-server-java/pull/642#pullrequestreview-379381518", "createdAt": "2020-03-23T12:27:57Z", "commit": {"oid": "84546e98458f3233a331b6f1e481cd119f1a9021"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMjoyNzo1N1rOF6DKew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMzowODozNVrOF6Ekfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQxMzU2Mw==", "bodyText": "Please configure your code style according to a project", "url": "https://github.com/prebid/prebid-server-java/pull/642#discussion_r396413563", "createdAt": "2020-03-23T12:27:57Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/auction/AuctionRequestFactory.java", "diffHunk": "@@ -1,5 +1,8 @@\n package org.prebid.server.auction;\n \n+import org.apache.commons.collections4.CollectionUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84546e98458f3233a331b6f1e481cd119f1a9021"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQyOTgxMQ==", "bodyText": "I would like to see smth like this to avoid code duplication\n final InetAddress inetAddress = inetAddressByIp(ipFromRequest);\n                if (isIpv4(inetAddress)) {\n                    builder.ip(ipFromRequest);\n                } else if (isIpv6(inetAddress)) {\n                    builder.ipv6(ipFromRequest);\n                }\n\n......\n\n    private InetAddress inetAddressByIp(String ip) {\n        try {\n            return InetAddress.getByName(ip);\n        } catch (UnknownHostException ex) {\n            logger.debug(\"Error occurred while checking IP\", ex);\n            return null;\n        }\n    }\n\n    private boolean isIpv4(InetAddress inetAddress) {\n        if (inetAddress instanceof Inet4Address) {\n            return ((Inet4Address) inetAddress).getHostAddress().equals(ip);\n        }\n        return false;\n    }\n\n    private boolean isIpv6(InetAddress inetAddress) {\n        return inetAddress instanceof Inet6Address;\n    }", "url": "https://github.com/prebid/prebid-server-java/pull/642#discussion_r396429811", "createdAt": "2020-03-23T12:57:01Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/auction/AuctionRequestFactory.java", "diffHunk": "@@ -277,16 +281,42 @@ private Device populateDevice(Device device, HttpServerRequest request) {\n \n         if (StringUtils.isBlank(ip) || StringUtils.isBlank(ua)) {\n             final Device.DeviceBuilder builder = device == null ? Device.builder() : device.toBuilder();\n-            builder.ip(StringUtils.isNotBlank(ip) ? ip : paramsExtractor.ipFrom(request));\n             builder.ua(StringUtils.isNotBlank(ua) ? ua : paramsExtractor.uaFrom(request));\n-\n+            final String ipFromRequest = paramsExtractor.ipFrom(request);\n+            if (StringUtils.isNotBlank(ipFromRequest)) {\n+                if (isIpv4(ipFromRequest)) {\n+                    builder.ip(ipFromRequest);\n+                } else if (isIpv6(ipFromRequest)) {\n+                    builder.ipv6(ipFromRequest);\n+                }\n+            }\n             result = builder.build();\n         } else {\n             result = null;\n         }\n         return result;\n     }\n \n+    private boolean isIpv4(String ip) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84546e98458f3233a331b6f1e481cd119f1a9021"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQzMzY3MA==", "bodyText": "remove line", "url": "https://github.com/prebid/prebid-server-java/pull/642#discussion_r396433670", "createdAt": "2020-03-23T13:03:25Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/auction/AuctionRequestFactoryTest.java", "diffHunk": "@@ -297,6 +298,27 @@ public void shouldSetFieldsFromHeadersIfBodyFieldsEmpty() {\n                 .isEqualTo(Device.builder().ip(\"192.168.244.1\").ua(\"UnitTest\").build());\n     }\n \n+    @Test\n+    public void shouldSetFieldsFromHeadersIfBodyFieldsEmptyForIpv6() {\n+        // given\n+        givenValidBidRequest();\n+\n+        givenImplicitParams(\"http://example.com\", \"example.com\", \"2001:0db8:85a3:0000:0000:8a2e:0370:7334\", \"UnitTest\");\n+\n+        // when\n+        final BidRequest request = factory.fromRequest(routingContext, 0L).result().getBidRequest();\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84546e98458f3233a331b6f1e481cd119f1a9021"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQzNjE5OQ==", "bodyText": "Why you changed this line ?", "url": "https://github.com/prebid/prebid-server-java/pull/642#discussion_r396436199", "createdAt": "2020-03-23T13:07:51Z", "author": {"login": "DGarbar"}, "path": "src/test/resources/org/prebid/server/it/openrtb2/rubicon_appnexus/test-appnexus-bid-request-1.json", "diffHunk": "@@ -53,7 +53,7 @@\n   \"device\": {\n     \"ua\": \"userAgent\",\n     \"dnt\": 2,\n-    \"ip\": \"80.215.195.0\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84546e98458f3233a331b6f1e481cd119f1a9021"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQzNjM1MA==", "bodyText": "You don't need to change json", "url": "https://github.com/prebid/prebid-server-java/pull/642#discussion_r396436350", "createdAt": "2020-03-23T13:08:07Z", "author": {"login": "DGarbar"}, "path": "src/test/resources/org/prebid/server/it/openrtb2/rubicon_appnexus/test-appnexus-bid-request-2.json", "diffHunk": "@@ -41,7 +41,7 @@\n   \"device\": {\n     \"ua\": \"userAgent\",\n     \"dnt\": 2,\n-    \"ip\": \"80.215.195.0\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84546e98458f3233a331b6f1e481cd119f1a9021"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQzNjYwNg==", "bodyText": "Please do not make unnecessary changes", "url": "https://github.com/prebid/prebid-server-java/pull/642#discussion_r396436606", "createdAt": "2020-03-23T13:08:35Z", "author": {"login": "DGarbar"}, "path": "src/test/resources/org/prebid/server/it/openrtb2/rubicon_appnexus/test-auction-rubicon-appnexus-response.json", "diffHunk": "@@ -381,29 +381,29 @@\n         \"appnexus\": [\n           {\n             \"uri\": \"{{ appnexus.exchange_uri }}?member_id=103\",\n-            \"requestbody\": \"{\\\"id\\\":\\\"tid\\\",\\\"imp\\\":[{\\\"id\\\":\\\"impId3\\\",\\\"banner\\\":{\\\"format\\\":[{\\\"w\\\":300,\\\"h\\\":250},{\\\"w\\\":300,\\\"h\\\":600}],\\\"w\\\":300,\\\"h\\\":250,\\\"pos\\\":3},\\\"tagid\\\":\\\"abc\\\",\\\"bidfloor\\\":1.0,\\\"ext\\\":{\\\"appnexus\\\":{\\\"keywords\\\":\\\"foo=bar,foo=baz\\\",\\\"traffic_source_code\\\":\\\"trafficSource\\\"}}},{\\\"id\\\":\\\"impId131\\\",\\\"native\\\":{\\\"request\\\":\\\"{\\\\\\\"ver\\\\\\\":\\\\\\\"1.1\\\\\\\",\\\\\\\"context\\\\\\\":1,\\\\\\\"contextsubtype\\\\\\\":11,\\\\\\\"plcmttype\\\\\\\":4,\\\\\\\"plcmtcnt\\\\\\\":1,\\\\\\\"assets\\\\\\\":[{\\\\\\\"id\\\\\\\":0,\\\\\\\"required\\\\\\\":1,\\\\\\\"title\\\\\\\":{\\\\\\\"len\\\\\\\":500}},{\\\\\\\"id\\\\\\\":1,\\\\\\\"required\\\\\\\":1,\\\\\\\"img\\\\\\\":{\\\\\\\"type\\\\\\\":3,\\\\\\\"wmin\\\\\\\":1,\\\\\\\"hmin\\\\\\\":1}},{\\\\\\\"id\\\\\\\":2,\\\\\\\"required\\\\\\\":0,\\\\\\\"data\\\\\\\":{\\\\\\\"len\\\\\\\":200}},{\\\\\\\"id\\\\\\\":3,\\\\\\\"required\\\\\\\":0,\\\\\\\"data\\\\\\\":{\\\\\\\"type\\\\\\\":2,\\\\\\\"len\\\\\\\":15000}},{\\\\\\\"id\\\\\\\":4,\\\\\\\"required\\\\\\\":0,\\\\\\\"data\\\\\\\":{\\\\\\\"len\\\\\\\":40}},{\\\\\\\"id\\\\\\\":5,\\\\\\\"required\\\\\\\":0,\\\\\\\"data\\\\\\\":{\\\\\\\"type\\\\\\\":11}}]}\\\",\\\"ver\\\":\\\"1.1\\\"},\\\"ext\\\":{\\\"appnexus\\\":{\\\"placement_id\\\":9880618}}}],\\\"site\\\":{\\\"domain\\\":\\\"example.com\\\",\\\"page\\\":\\\"http://www.example.com\\\",\\\"publisher\\\":{\\\"id\\\":\\\"5001\\\"},\\\"ext\\\":{\\\"amp\\\":0}},\\\"device\\\":{\\\"ua\\\":\\\"userAgent\\\",\\\"dnt\\\":2,\\\"ip\\\":\\\"80.215.195.0\\\",\\\"pxratio\\\":4.2,\\\"language\\\":\\\"en\\\",\\\"ext\\\":{\\\"prebid\\\":{\\\"interstitial\\\":{\\\"minwidthperc\\\":50,\\\"minheightperc\\\":60}}}},\\\"user\\\":{\\\"ext\\\":{\\\"consent\\\":\\\"consentValue\\\",\\\"digitrust\\\":{\\\"id\\\":\\\"id\\\",\\\"keyv\\\":123,\\\"pref\\\":0},\\\"eids\\\":[{\\\"source\\\":\\\"adserver.org\\\",\\\"uids\\\":[{\\\"id\\\":\\\"cd96870f-f53d-4986-a08e-cd1612fb13b0\\\",\\\"ext\\\":{\\\"rtiPartner\\\":\\\"TDID\\\"}}]},{\\\"source\\\":\\\"liveintent.com\\\",\\\"uids\\\":[{\\\"id\\\":\\\"efcf3a33-2eaf-4d6b-bf11-a411f134278c\\\"}],\\\"ext\\\":{\\\"segments\\\":[\\\"999\\\",\\\"888\\\"]}},{\\\"source\\\":\\\"pubcid\\\",\\\"id\\\":\\\"29cfaea8-a429-48fc-9537-8a19a8eb4f0d\\\"}]}},\\\"at\\\":1,\\\"tmax\\\":3000,\\\"cur\\\":[\\\"USD\\\"],\\\"source\\\":{\\\"fd\\\":1,\\\"tid\\\":\\\"tid\\\",\\\"ext\\\":{\\\"schain\\\":{\\\"ver\\\":\\\"1.0\\\"}}},\\\"regs\\\":{\\\"ext\\\":{\\\"us_privacy\\\":\\\"1YNN\\\"}},\\\"ext\\\":{\\\"prebid\\\":{\\\"debug\\\":1,\\\"aliases\\\":{\\\"appnexusAlias\\\":\\\"appnexus\\\"},\\\"targeting\\\":{\\\"pricegranularity\\\":{\\\"precision\\\":2,\\\"ranges\\\":[{\\\"max\\\":20,\\\"increment\\\":0.1}]},\\\"currency\\\":{\\\"rates\\\":{\\\"EUR\\\":{\\\"USD\\\":1.2406},\\\"USD\\\":{\\\"EUR\\\":0.811}}},\\\"includewinners\\\":true,\\\"includebidderkeys\\\":true},\\\"cache\\\":{\\\"bids\\\":{},\\\"vastxml\\\":{\\\"ttlseconds\\\":120}}}}}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84546e98458f3233a331b6f1e481cd119f1a9021"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a8c171e0f7730aee06dae7e0465b28ae2534137", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/0a8c171e0f7730aee06dae7e0465b28ae2534137", "committedDate": "2020-03-23T16:47:02Z", "message": "Refactoring code and tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTIyMjg2", "url": "https://github.com/prebid/prebid-server-java/pull/642#pullrequestreview-380122286", "createdAt": "2020-03-24T09:16:48Z", "commit": {"oid": "0a8c171e0f7730aee06dae7e0465b28ae2534137"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOToxNjo0OFrOF6nJGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOToxNjo1NVrOF6nJWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAwMzAzMw==", "bodyText": "When you adding something in tests, you need to clearly understand why you did that.\nYou forgot about\nif StringUtils.isBlank(ip)", "url": "https://github.com/prebid/prebid-server-java/pull/642#discussion_r397003033", "createdAt": "2020-03-24T09:16:48Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/auction/AuctionRequestFactory.java", "diffHunk": "@@ -277,16 +281,41 @@ private Device populateDevice(Device device, HttpServerRequest request) {\n \n         if (StringUtils.isBlank(ip) || StringUtils.isBlank(ua)) {\n             final Device.DeviceBuilder builder = device == null ? Device.builder() : device.toBuilder();\n-            builder.ip(StringUtils.isNotBlank(ip) ? ip : paramsExtractor.ipFrom(request));\n             builder.ua(StringUtils.isNotBlank(ua) ? ua : paramsExtractor.uaFrom(request));\n-\n+            final String ipFromRequest = paramsExtractor.ipFrom(request);\n+            final InetAddress inetAddress = inetAddressByIp(ipFromRequest);\n+            if (isIpv4(inetAddress, ipFromRequest)) {\n+                builder.ip(ipFromRequest);\n+            } else if (isIpv6(inetAddress)) {\n+                builder.ipv6(ipFromRequest);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a8c171e0f7730aee06dae7e0465b28ae2534137"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAwMzA5OQ==", "bodyText": "remove this", "url": "https://github.com/prebid/prebid-server-java/pull/642#discussion_r397003099", "createdAt": "2020-03-24T09:16:55Z", "author": {"login": "DGarbar"}, "path": "src/test/resources/org/prebid/server/it/openrtb2/rubicon_appnexus/test-auction-rubicon-appnexus-request.json", "diffHunk": "@@ -177,6 +177,7 @@\n     }\n   ],\n   \"device\": {\n+    \"ua\": \"userAgent\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a8c171e0f7730aee06dae7e0465b28ae2534137"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32033aa2c7eda55662f978d7b1a85e883208dd08", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/32033aa2c7eda55662f978d7b1a85e883208dd08", "committedDate": "2020-03-24T10:55:20Z", "message": "Add additional condition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjQ1MTk2", "url": "https://github.com/prebid/prebid-server-java/pull/642#pullrequestreview-380245196", "createdAt": "2020-03-24T12:06:36Z", "commit": {"oid": "32033aa2c7eda55662f978d7b1a85e883208dd08"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44e001fca5ee0baf538665964b88f6b2066363e8", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/44e001fca5ee0baf538665964b88f6b2066363e8", "committedDate": "2020-05-20T14:47:24Z", "message": "Merge branch 'master' into fix-ip-error\n\n# Conflicts:\n#\tsrc/main/java/org/prebid/server/auction/AuctionRequestFactory.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49b0270af369cf3300d1c88e5a487c0e1b231a6c", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/49b0270af369cf3300d1c88e5a487c0e1b231a6c", "committedDate": "2020-05-20T15:01:34Z", "message": "Merging to master branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b986fed1bbd482ad0f41d2fc04e34e660f195feb", "author": {"user": {"login": "rpanchyk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/b986fed1bbd482ad0f41d2fc04e34e660f195feb", "committedDate": "2020-06-04T11:48:52Z", "message": "Merge branch 'master' into fix-ip-error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea52d8a1440ed10ea5723d289d7e55afdd6b10cd", "author": {"user": {"login": "rpanchyk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/ea52d8a1440ed10ea5723d289d7e55afdd6b10cd", "committedDate": "2020-06-04T12:00:42Z", "message": "Fixes after review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "602f90f9b0026b7f0d26d75a3bd3bf01a53fc98a", "author": {"user": {"login": "rpanchyk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/602f90f9b0026b7f0d26d75a3bd3bf01a53fc98a", "committedDate": "2020-06-04T12:19:30Z", "message": "Merge branch 'master' into fix-ip-error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0Mzg5NTg0", "url": "https://github.com/prebid/prebid-server-java/pull/642#pullrequestreview-424389584", "createdAt": "2020-06-04T12:28:21Z", "commit": {"oid": "602f90f9b0026b7f0d26d75a3bd3bf01a53fc98a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3311, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}