{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MzkwMjc4", "number": 654, "title": "Update emit event logic", "bodyText": "Update emit event logic for correct use in BidResponse.\nHere's the logic Prebid Server uses to know when to respond with various types of event output.\nThere are 4 outputs that Prebid Server has to coordinate:\n\nPlacing 'wurl' in the PBC cache along with the bid\nInject VAST <impression> tag\nEmitting response.seatbid[].bid[].ext.prebid.events\nProvide hb_winurl in the ad server targeting\n\nThe event algorithm:\n\nIf the account doesn't support events, we're done - stop here.\nOtherwise the account does support events, so go on.\nif the bid response is VAST and we're allowed to modify the bidder's VAST, then inject <impression>.\nIf ext.prebid.targeting.cache.vast is specified, then cache the VAST\n\nelse // not video\n\nIf bid caching is turned on (ext.prebid.targeting.cache.bids), then add 'wurl' to bids cached in PBC.\nIf ext.prebid.events is defined then add response.seatbid[].bid[].ext.prebid.events to the openrtb output.", "createdAt": "2020-04-03T21:16:10Z", "url": "https://github.com/prebid/prebid-server-java/pull/654", "merged": true, "mergeCommit": {"oid": "a081e6e193a3b3af593b178c09e0dd91ee5390e3"}, "closed": true, "closedAt": "2020-04-10T08:10:32Z", "author": {"login": "AndriyPavlyuk"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUHfy_AH2gAyMzk4MzkwMjc4OmY1ZWU3NmRhOWZiMmZjZDNmODU4N2U0OGJjNjdiMzcyOWI5NjdjYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWMhmxgFqTM5MTMyMTk2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f5ee76da9fb2fcd3f8587e48bc67b3729b967cb5", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/f5ee76da9fb2fcd3f8587e48bc67b3729b967cb5", "committedDate": "2020-04-03T21:08:38Z", "message": "Add to bidrequest events"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MDEwODAw", "url": "https://github.com/prebid/prebid-server-java/pull/654#pullrequestreview-388010800", "createdAt": "2020-04-06T07:55:55Z", "commit": {"oid": "f5ee76da9fb2fcd3f8587e48bc67b3729b967cb5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwNzo1NTo1NVrOGBL06Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwODoyMzowNVrOGBMw5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzg5NTUyOQ==", "bodyText": "Seems we don't really need to pass ExtRequestPrebidEvents object.\nAssume, we can use here eventsEnabled flag instead, based on ExtRequestPrebidEvents and account.getEventsEnabled().\nSo, as following BidResponseCreator can be refactored to rid off the account.getEventsEnabled() usage.", "url": "https://github.com/prebid/prebid-server-java/pull/654#discussion_r403895529", "createdAt": "2020-04-06T07:55:55Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -107,7 +108,8 @@ public BidResponseCreator(CacheService cacheService, BidderCatalog bidderCatalog\n      * including processing of winning bids with cache IDs.\n      */\n     Future<BidResponse> create(List<BidderResponse> bidderResponses, BidRequest bidRequest,\n-                               ExtRequestTargeting targeting, BidRequestCacheInfo cacheInfo, Account account,\n+                               ExtRequestPrebidEvents extRequestPrebidEvents, ExtRequestTargeting targeting,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5ee76da9fb2fcd3f8587e48bc67b3729b967cb5"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkwODE3MA==", "bodyText": "We don't need any fields in this class.\nIt will be used just as marker.", "url": "https://github.com/prebid/prebid-server-java/pull/654#discussion_r403908170", "createdAt": "2020-04-06T08:18:22Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/proto/openrtb/ext/request/ExtRequestPrebidEvents.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package org.prebid.server.proto.openrtb.ext.request;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Value;\n+\n+/**\n+ * Defines the contract for bidrequest.ext.prebid.events\n+ */\n+@AllArgsConstructor(staticName = \"of\")\n+@Value\n+public class ExtRequestPrebidEvents {\n+\n+    /**\n+     * Defines the contract for bidrequest.ext.prebid.events.win\n+     */\n+    String win;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5ee76da9fb2fcd3f8587e48bc67b3729b967cb5"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkwODc4NA==", "bodyText": "Do not used.", "url": "https://github.com/prebid/prebid-server-java/pull/654#discussion_r403908784", "createdAt": "2020-04-06T08:19:30Z", "author": {"login": "rpanchyk"}, "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -747,10 +760,40 @@ public void shouldAddExtPrebidEvents() {\n         verify(cacheService, never()).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), any());\n     }\n \n+    @Test\n+    public void shouldNotAddExtPrebidEventsIfExtRequestPrebidEventsNull() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest();\n+        final ExtRequestTargeting targeting = givenTargeting();\n+\n+        final Bid bid = Bid.builder().id(\"bidId1\").price(BigDecimal.valueOf(5.67)).build();\n+        final List<BidderResponse> bidderResponses = singletonList(BidderResponse.of(\"bidder1\",\n+                givenSeatBid(BidderBid.of(bid, banner, \"USD\")), 100));\n+\n+        final Events events = Events.of(\"http://event-type-win\", \"http://event-type-view\");\n+        given(eventsService.createEvent(anyString(), anyString())).willReturn(events);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5ee76da9fb2fcd3f8587e48bc67b3729b967cb5"}, "originalPosition": 287}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzkxMDg4NQ==", "bodyText": "Pls rename to shouldNotAddExtPrebidEventsIfExtRequestPrebidEventsIsNull.\nAlso, add the additional unit test when Account has eventsEnabled = false.", "url": "https://github.com/prebid/prebid-server-java/pull/654#discussion_r403910885", "createdAt": "2020-04-06T08:23:05Z", "author": {"login": "rpanchyk"}, "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -747,10 +760,40 @@ public void shouldAddExtPrebidEvents() {\n         verify(cacheService, never()).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), any());\n     }\n \n+    @Test\n+    public void shouldNotAddExtPrebidEventsIfExtRequestPrebidEventsNull() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5ee76da9fb2fcd3f8587e48bc67b3729b967cb5"}, "originalPosition": 277}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1711df83b65b792b0309acefeaefc44ef74f8d59", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/1711df83b65b792b0309acefeaefc44ef74f8d59", "committedDate": "2020-04-06T21:18:04Z", "message": "Add eventsEnabled flag to ExchangeService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "981410fede4fc891adc1aa1d7fd8114f5061edb4", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/981410fede4fc891adc1aa1d7fd8114f5061edb4", "committedDate": "2020-04-06T21:35:38Z", "message": "Merge branch 'master' into update-emit-event-logic\n\n# Conflicts:\n#\tsrc/main/java/org/prebid/server/auction/BidResponseCreator.java\n#\tsrc/main/java/org/prebid/server/auction/ExchangeService.java\n#\tsrc/test/java/org/prebid/server/auction/BidResponseCreatorTest.java\n#\tsrc/test/java/org/prebid/server/auction/ExchangeServiceTest.java\n#\tsrc/test/resources/org/prebid/server/it/openrtb2/rubicon_appnexus/test-auction-rubicon-appnexus-response.json"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14de08687f65311386809422da043b624354f30f", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/14de08687f65311386809422da043b624354f30f", "committedDate": "2020-04-07T12:59:05Z", "message": "Resolving conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cf5f75ff077a10524627acb5683b9812c5274e5", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/3cf5f75ff077a10524627acb5683b9812c5274e5", "committedDate": "2020-04-07T13:06:47Z", "message": "Merge branch 'master' into update-emit-event-logic\n\n# Conflicts:\n#\tsrc/main/java/org/prebid/server/auction/ExchangeService.java\n#\tsrc/test/resources/org/prebid/server/it/openrtb2/rubicon_appnexus/test-auction-rubicon-appnexus-response.json"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a852a7defa32df1a15f99139597c3a324e0aba1", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/5a852a7defa32df1a15f99139597c3a324e0aba1", "committedDate": "2020-04-07T13:20:28Z", "message": "Resolving conflicts update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca5f29871c86d436442c4c4395fb28b8e047b987", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/ca5f29871c86d436442c4c4395fb28b8e047b987", "committedDate": "2020-04-08T13:00:58Z", "message": "Some refactoring and fixing bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2227779203f026f88bb4a5e42131371b774164fd", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/2227779203f026f88bb4a5e42131371b774164fd", "committedDate": "2020-04-08T13:43:00Z", "message": "Divide on two separate conditions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee3d3b5dd9bdd7acceb79d88500b84fbc06e5817", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/ee3d3b5dd9bdd7acceb79d88500b84fbc06e5817", "committedDate": "2020-04-08T13:58:54Z", "message": "Merge branch 'master' into update-emit-event-logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd0e5baa5c9d011342110107cceb89ca48de7a14", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/bd0e5baa5c9d011342110107cceb89ca48de7a14", "committedDate": "2020-04-08T21:48:51Z", "message": "Update caching due to new logic of events"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edc11327cb0f354b0e77a3b004c4ee16245f77bf", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/edc11327cb0f354b0e77a3b004c4ee16245f77bf", "committedDate": "2020-04-09T09:45:00Z", "message": "Changes to pass LGTM checks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNzEyODg5", "url": "https://github.com/prebid/prebid-server-java/pull/654#pullrequestreview-390712889", "createdAt": "2020-04-09T11:33:50Z", "commit": {"oid": "edc11327cb0f354b0e77a3b004c4ee16245f77bf"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMTozMzo1MFrOGDU5KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMTozODoyNFrOGDVBcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE0MTIyNQ==", "bodyText": "This check doesn't answer the question \"Is events enabled?\"", "url": "https://github.com/prebid/prebid-server-java/pull/654#discussion_r406141225", "createdAt": "2020-04-09T11:33:50Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -391,19 +393,23 @@ private static PutObject createPutObjectVideoOnly(Bid bid) {\n \n     /**\n      * Makes JSON type {@link PutObject} from {@link com.iab.openrtb.response.Bid}.\n-     * Used for OpenRTB auction request. Also, adds win url to result object.\n+     * Used for OpenRTB auction request. Also, adds win url to result object if events are enabled.\n      */\n     private PutObject createJsonPutObjectOpenrtb(CacheBid cacheBid, Map<String, List<String>> biddersToCacheBidIds,\n-                                                 String accountId, Long timestamp) {\n+                                                 Account account, boolean eventsAllowedByRequest, Long timestamp) {\n         final com.iab.openrtb.response.Bid bid = cacheBid.getBid();\n         final String bidId = bid.getId();\n+\n         final ObjectNode bidObjectNode = mapper.mapper().valueToTree(bid);\n-        biddersToCacheBidIds.entrySet().stream()\n-                .filter(biddersAndBidIds -> biddersAndBidIds.getValue().contains(bidId))\n-                .findFirst()\n-                .map(Map.Entry::getKey)\n-                .ifPresent(bidder -> bidObjectNode.put(\"wurl\", eventsService.winUrl(bidId, bidder, accountId,\n-                        timestamp)));\n+        final boolean eventsEnabled = account.getEventsEnabled() != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edc11327cb0f354b0e77a3b004c4ee16245f77bf"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE0MTYxMQ==", "bodyText": "According to requirements eventsAllowedByRequest should not be applied to CacheService at all.", "url": "https://github.com/prebid/prebid-server-java/pull/654#discussion_r406141611", "createdAt": "2020-04-09T11:34:44Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/cache/CacheService.java", "diffHunk": "@@ -391,19 +393,23 @@ private static PutObject createPutObjectVideoOnly(Bid bid) {\n \n     /**\n      * Makes JSON type {@link PutObject} from {@link com.iab.openrtb.response.Bid}.\n-     * Used for OpenRTB auction request. Also, adds win url to result object.\n+     * Used for OpenRTB auction request. Also, adds win url to result object if events are enabled.\n      */\n     private PutObject createJsonPutObjectOpenrtb(CacheBid cacheBid, Map<String, List<String>> biddersToCacheBidIds,\n-                                                 String accountId, Long timestamp) {\n+                                                 Account account, boolean eventsAllowedByRequest, Long timestamp) {\n         final com.iab.openrtb.response.Bid bid = cacheBid.getBid();\n         final String bidId = bid.getId();\n+\n         final ObjectNode bidObjectNode = mapper.mapper().valueToTree(bid);\n-        biddersToCacheBidIds.entrySet().stream()\n-                .filter(biddersAndBidIds -> biddersAndBidIds.getValue().contains(bidId))\n-                .findFirst()\n-                .map(Map.Entry::getKey)\n-                .ifPresent(bidder -> bidObjectNode.put(\"wurl\", eventsService.winUrl(bidId, bidder, accountId,\n-                        timestamp)));\n+        final boolean eventsEnabled = account.getEventsEnabled() != null;\n+        if (eventsEnabled && eventsAllowedByRequest) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edc11327cb0f354b0e77a3b004c4ee16245f77bf"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE0MzM0NA==", "bodyText": "According to requirements eventsAllowedByRequest should not be applied here.\ni mean it should not affect the hb_winurl & hb_bidid targeting keywords.", "url": "https://github.com/prebid/prebid-server-java/pull/654#discussion_r406143344", "createdAt": "2020-04-09T11:38:24Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -636,7 +640,7 @@ private Bid toBid(BidderBid bidderBid, String bidder, ExtRequestTargeting target\n             final Map<BidType, TargetingKeywordsCreator> keywordsCreatorByBidType =\n                     keywordsCreatorByBidType(targeting, isApp);\n             final boolean isWinningBid = winningBids.contains(bid);\n-            final String winUrl = eventsEnabled && bidType != BidType.video\n+            final String winUrl = eventsEnabled && eventsAllowedByRequest && bidType != BidType.video", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edc11327cb0f354b0e77a3b004c4ee16245f77bf"}, "originalPosition": 100}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd3009711b71b10c6a82639895838151efeff8aa", "author": {"user": {"login": "AndriyPavlyuk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/bd3009711b71b10c6a82639895838151efeff8aa", "committedDate": "2020-04-09T14:21:01Z", "message": "Changes in CacheService"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMzIxOTYx", "url": "https://github.com/prebid/prebid-server-java/pull/654#pullrequestreview-391321961", "createdAt": "2020-04-10T08:07:59Z", "commit": {"oid": "bd3009711b71b10c6a82639895838151efeff8aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3332, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}