{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNTg4ODgz", "number": 918, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzozMTo0OFrOEzaCyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzozMzowN1rOEzaEzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzM5NTMwOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzozMTo0OFrOHqnAiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzozMTo0OFrOHqnAiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MTM1Mw==", "bodyText": "What the difference?", "url": "https://github.com/prebid/prebid-server-java/pull/918#discussion_r514441353", "createdAt": "2020-10-29T17:31:48Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -125,13 +132,19 @@ private boolean addRequestAndCheckIfDuplicates(List<HttpRequest<Void>> httpReque\n                         continue;\n                     }\n \n+                    queryParams.add(new BasicNameValuePair(\"aid\", extImpAdocean.getSlaveId() + \":\" + impid));\n+                    final List<String> sizeValues = test != null && test == 1\n+                            ? setSlaveSizesParam(slaveSizes, true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d09aa16f81f66049cf793c7956c2e1046a0adc16"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyMzQwMDQ1OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNzozMzowN1rOHqnDzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNzozMzoxNFrOHrD6Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MjE5MA==", "bodyText": "Check for nulls in values for headers.", "url": "https://github.com/prebid/prebid-server-java/pull/918#discussion_r514442190", "createdAt": "2020-10-29T17:33:07Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -170,38 +207,55 @@ private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consen\n             uriBuilder.addParameter(\"hcuserid\", user.getBuyeruid());\n         }\n \n+        final List<String> sizeValues = test != null && test == 1\n+                ? setSlaveSizesParam(slaveSizes, true)\n+                : setSlaveSizesParam(slaveSizes, false);\n+\n+        if (CollectionUtils.isNotEmpty(sizeValues)) {\n+            uriBuilder.addParameter(\"aosspsizes\", String.join(\"-\", sizeValues));\n+        }\n+\n         return uriBuilder.toString();\n     }\n \n+    private List<String> setSlaveSizesParam(Map<String, String> slaveSizes, boolean orderByKey) {\n+        final Set<String> slaveIDs = orderByKey ? new TreeSet<>(slaveSizes.keySet()) : slaveSizes.keySet();\n+\n+        return slaveIDs.stream()\n+                .filter(slaveId -> StringUtils.isNotBlank(slaveSizes.get(slaveId)))\n+                .map(rawSlaveID -> String.format(\"%s~%s\", rawSlaveID.replaceFirst(\"adocean\", \"\"),\n+                        slaveSizes.get(rawSlaveID)))\n+                .collect(Collectors.toList());\n+    }\n+\n     private static MultiMap getHeaders(BidRequest request) {\n         final MultiMap headers = HttpUtil.headers();\n         if (request.getDevice() != null) {\n-            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.USER_AGENT_HEADER.toString(),\n-                    request.getDevice().getUa());\n-\n-            if (StringUtils.isNotBlank(request.getDevice().getIp())) {\n-                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n-                        request.getDevice().getIp());\n-            } else if (StringUtils.isNotBlank(request.getDevice().getIpv6())) {\n-                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n-                        request.getDevice().getIpv6());\n-            }\n+            addHeader(headers, \"User-Agent\", request.getDevice().getUa());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d09aa16f81f66049cf793c7956c2e1046a0adc16"}, "originalPosition": 181}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDUzODM2Mg==", "bodyText": "method addHeader contains StringUtils.isNotBlank(value)", "url": "https://github.com/prebid/prebid-server-java/pull/918#discussion_r514538362", "createdAt": "2020-10-29T20:13:42Z", "author": {"login": "snahornyi"}, "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -170,38 +207,55 @@ private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consen\n             uriBuilder.addParameter(\"hcuserid\", user.getBuyeruid());\n         }\n \n+        final List<String> sizeValues = test != null && test == 1\n+                ? setSlaveSizesParam(slaveSizes, true)\n+                : setSlaveSizesParam(slaveSizes, false);\n+\n+        if (CollectionUtils.isNotEmpty(sizeValues)) {\n+            uriBuilder.addParameter(\"aosspsizes\", String.join(\"-\", sizeValues));\n+        }\n+\n         return uriBuilder.toString();\n     }\n \n+    private List<String> setSlaveSizesParam(Map<String, String> slaveSizes, boolean orderByKey) {\n+        final Set<String> slaveIDs = orderByKey ? new TreeSet<>(slaveSizes.keySet()) : slaveSizes.keySet();\n+\n+        return slaveIDs.stream()\n+                .filter(slaveId -> StringUtils.isNotBlank(slaveSizes.get(slaveId)))\n+                .map(rawSlaveID -> String.format(\"%s~%s\", rawSlaveID.replaceFirst(\"adocean\", \"\"),\n+                        slaveSizes.get(rawSlaveID)))\n+                .collect(Collectors.toList());\n+    }\n+\n     private static MultiMap getHeaders(BidRequest request) {\n         final MultiMap headers = HttpUtil.headers();\n         if (request.getDevice() != null) {\n-            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.USER_AGENT_HEADER.toString(),\n-                    request.getDevice().getUa());\n-\n-            if (StringUtils.isNotBlank(request.getDevice().getIp())) {\n-                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n-                        request.getDevice().getIp());\n-            } else if (StringUtils.isNotBlank(request.getDevice().getIpv6())) {\n-                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n-                        request.getDevice().getIpv6());\n-            }\n+            addHeader(headers, \"User-Agent\", request.getDevice().getUa());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MjE5MA=="}, "originalCommit": {"oid": "d09aa16f81f66049cf793c7956c2e1046a0adc16"}, "originalPosition": 181}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxNDg1MA==", "bodyText": "fair", "url": "https://github.com/prebid/prebid-server-java/pull/918#discussion_r514914850", "createdAt": "2020-10-30T07:33:14Z", "author": {"login": "rpanchyk"}, "path": "src/main/java/org/prebid/server/bidder/adocean/AdoceanBidder.java", "diffHunk": "@@ -170,38 +207,55 @@ private String buildUrl(String impid, ExtImpAdocean extImpAdocean, String consen\n             uriBuilder.addParameter(\"hcuserid\", user.getBuyeruid());\n         }\n \n+        final List<String> sizeValues = test != null && test == 1\n+                ? setSlaveSizesParam(slaveSizes, true)\n+                : setSlaveSizesParam(slaveSizes, false);\n+\n+        if (CollectionUtils.isNotEmpty(sizeValues)) {\n+            uriBuilder.addParameter(\"aosspsizes\", String.join(\"-\", sizeValues));\n+        }\n+\n         return uriBuilder.toString();\n     }\n \n+    private List<String> setSlaveSizesParam(Map<String, String> slaveSizes, boolean orderByKey) {\n+        final Set<String> slaveIDs = orderByKey ? new TreeSet<>(slaveSizes.keySet()) : slaveSizes.keySet();\n+\n+        return slaveIDs.stream()\n+                .filter(slaveId -> StringUtils.isNotBlank(slaveSizes.get(slaveId)))\n+                .map(rawSlaveID -> String.format(\"%s~%s\", rawSlaveID.replaceFirst(\"adocean\", \"\"),\n+                        slaveSizes.get(rawSlaveID)))\n+                .collect(Collectors.toList());\n+    }\n+\n     private static MultiMap getHeaders(BidRequest request) {\n         final MultiMap headers = HttpUtil.headers();\n         if (request.getDevice() != null) {\n-            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.USER_AGENT_HEADER.toString(),\n-                    request.getDevice().getUa());\n-\n-            if (StringUtils.isNotBlank(request.getDevice().getIp())) {\n-                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n-                        request.getDevice().getIp());\n-            } else if (StringUtils.isNotBlank(request.getDevice().getIpv6())) {\n-                HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER,\n-                        request.getDevice().getIpv6());\n-            }\n+            addHeader(headers, \"User-Agent\", request.getDevice().getUa());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDQ0MjE5MA=="}, "originalCommit": {"oid": "d09aa16f81f66049cf793c7956c2e1046a0adc16"}, "originalPosition": 181}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3891, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}