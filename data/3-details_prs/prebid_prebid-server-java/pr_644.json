{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MDg2NTY0", "number": 644, "title": "Write to Device.Ua", "bodyText": "Write User-Agent to Device.Ua if Device.Ua and User-Agent Header are not empty.", "createdAt": "2020-03-26T10:37:30Z", "url": "https://github.com/prebid/prebid-server-java/pull/644", "merged": true, "mergeCommit": {"oid": "ecbdbc9c3172555654d7309067d08936a660e144"}, "closed": true, "closedAt": "2020-06-04T12:36:27Z", "author": {"login": "apaliy"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRZnKkAH2gAyMzk0MDg2NTY0Ojk2NDBiOTA2OGIxNGY2ZDgzMjE1YjhlYWU2ZTBlYTg1NzJhYjBlMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclvOsWAFqTQyMDIwNDk1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9640b9068b14f6d83215b8eae6e0ea8572ab0e33", "author": {"user": {"login": "apaliy", "name": "Andrew Paliy"}}, "url": "https://github.com/prebid/prebid-server-java/commit/9640b9068b14f6d83215b8eae6e0ea8572ab0e33", "committedDate": "2020-03-26T10:33:12Z", "message": "Write User-Agent to Device.Ua if Device.Ua and User-Agent Header are not empty."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyOTIyMTU5", "url": "https://github.com/prebid/prebid-server-java/pull/644#pullrequestreview-382922159", "createdAt": "2020-03-27T14:44:09Z", "commit": {"oid": "9640b9068b14f6d83215b8eae6e0ea8572ab0e33"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNDo0NDowOVrOF80UGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNDo0NDo0NlrOF80Vww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxNTk5NQ==", "bodyText": "First of all. Don't you thing that\n1 Check if Device is null\n2 Create new Device if it is Null and insert into request.\n3 call bidRequestVideo.getDevice() 4 times\n4 ...\n5 Then create new request. And create new device again. And set UA.", "url": "https://github.com/prebid/prebid-server-java/pull/644#discussion_r399315995", "createdAt": "2020-03-27T14:44:09Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/auction/VideoRequestFactory.java", "diffHunk": "@@ -85,7 +87,22 @@ private BidRequestVideo parseRequest(RoutingContext context) {\n         }\n \n         try {\n-            return mapper.decodeValue(body, BidRequestVideo.class);\n+            BidRequestVideo bidRequestVideo = mapper.decodeValue(body, BidRequestVideo.class);\n+            if (bidRequestVideo.getDevice() == null) {\n+                bidRequestVideo = bidRequestVideo.toBuilder().device(Device.builder().build()).build();\n+            }\n+            if (StringUtils.isEmpty(bidRequestVideo.getDevice().getUa())) {\n+                final String userAgentHeader = context.request().getHeader(HttpUtil.USER_AGENT_HEADER);\n+                if (StringUtils.isEmpty(userAgentHeader)) {\n+                    throw new InvalidRequestException(\"Device.UA and User-Agent Header is not presented\");\n+                }\n+                bidRequestVideo = bidRequestVideo.toBuilder()\n+                        .device(bidRequestVideo.getDevice().toBuilder()\n+                                .ua(userAgentHeader)\n+                                .build())\n+                        .build();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9640b9068b14f6d83215b8eae6e0ea8572ab0e33"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxNjEwMA==", "bodyText": "private BidRequestVideo insertDeviceUa(RoutingContext context, BidRequestVideo bidRequestVideo) {\n        final Device device = bidRequestVideo.getDevice();\n        final String deviceUa = device != null ? device.getUa() : null;\n        if (StringUtils.isBlank(deviceUa)) {\n            final String userAgentHeader = context.request().getHeader(HttpUtil.USER_AGENT_HEADER);\n            if (StringUtils.isEmpty(userAgentHeader)) {\n                throw new InvalidRequestException(\"Device.UA and User-Agent Header is not present\");\n            }\n            final Device.DeviceBuilder deviceBuilder = device == null ? Device.builder() : device.toBuilder();\n\n            return bidRequestVideo.toBuilder()\n                    .device(deviceBuilder\n                            .ua(userAgentHeader)\n                            .build())\n                    .build();\n        }\n        return bidRequestVideo;\n    }", "url": "https://github.com/prebid/prebid-server-java/pull/644#discussion_r399316100", "createdAt": "2020-03-27T14:44:20Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/auction/VideoRequestFactory.java", "diffHunk": "@@ -85,7 +87,22 @@ private BidRequestVideo parseRequest(RoutingContext context) {\n         }\n \n         try {\n-            return mapper.decodeValue(body, BidRequestVideo.class);\n+            BidRequestVideo bidRequestVideo = mapper.decodeValue(body, BidRequestVideo.class);\n+            if (bidRequestVideo.getDevice() == null) {\n+                bidRequestVideo = bidRequestVideo.toBuilder().device(Device.builder().build()).build();\n+            }\n+            if (StringUtils.isEmpty(bidRequestVideo.getDevice().getUa())) {\n+                final String userAgentHeader = context.request().getHeader(HttpUtil.USER_AGENT_HEADER);\n+                if (StringUtils.isEmpty(userAgentHeader)) {\n+                    throw new InvalidRequestException(\"Device.UA and User-Agent Header is not presented\");\n+                }\n+                bidRequestVideo = bidRequestVideo.toBuilder()\n+                        .device(bidRequestVideo.getDevice().toBuilder()\n+                                .ua(userAgentHeader)\n+                                .build())\n+                        .build();\n+            }\n+            return bidRequestVideo;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9640b9068b14f6d83215b8eae6e0ea8572ab0e33"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxNjQxOQ==", "bodyText": "check style", "url": "https://github.com/prebid/prebid-server-java/pull/644#discussion_r399316419", "createdAt": "2020-03-27T14:44:46Z", "author": {"login": "DGarbar"}, "path": "src/test/java/org/prebid/server/auction/VideoRequestFactoryTest.java", "diffHunk": "@@ -29,15 +30,14 @@\n import org.prebid.server.proto.openrtb.ext.request.ExtRequestPrebidCache;\n import org.prebid.server.proto.openrtb.ext.request.ExtRequestPrebidCacheVastxml;\n import org.prebid.server.proto.openrtb.ext.request.ExtRequestTargeting;\n+import org.prebid.server.util.HttpUtil;\n \n import java.util.Arrays;\n \n import static java.util.Collections.emptySet;\n import static java.util.Collections.singletonList;\n import static org.assertj.core.api.Assertions.assertThat;\n-import static org.mockito.ArgumentMatchers.any;\n-import static org.mockito.ArgumentMatchers.anyLong;\n-import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9640b9068b14f6d83215b8eae6e0ea8572ab0e33"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8693ac6822ba583d82d89a343980b93913a0ad", "author": {"user": {"login": "apaliy", "name": "Andrew Paliy"}}, "url": "https://github.com/prebid/prebid-server-java/commit/ae8693ac6822ba583d82d89a343980b93913a0ad", "committedDate": "2020-03-31T07:31:49Z", "message": "change request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68b574324fc4356af8ab1eec0df410c4ff942bb3", "author": {"user": {"login": "apaliy", "name": "Andrew Paliy"}}, "url": "https://github.com/prebid/prebid-server-java/commit/68b574324fc4356af8ab1eec0df410c4ff942bb3", "committedDate": "2020-03-31T07:33:01Z", "message": "change request"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjIwNzA5", "url": "https://github.com/prebid/prebid-server-java/pull/644#pullrequestreview-384620709", "createdAt": "2020-03-31T10:58:09Z", "commit": {"oid": "68b574324fc4356af8ab1eec0df410c4ff942bb3"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f529c5f0daa6808040081bb93ab6c708065a3ce", "author": {"user": {"login": "rpanchyk", "name": null}}, "url": "https://github.com/prebid/prebid-server-java/commit/1f529c5f0daa6808040081bb93ab6c708065a3ce", "committedDate": "2020-05-14T11:20:41Z", "message": "Merge branch 'master' into replace-device-ua-with-header\n\n# Conflicts:\n#\tsrc/test/java/org/prebid/server/auction/VideoRequestFactoryTest.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNzA3MjE1", "url": "https://github.com/prebid/prebid-server-java/pull/644#pullrequestreview-411707215", "createdAt": "2020-05-14T11:21:52Z", "commit": {"oid": "1f529c5f0daa6808040081bb93ab6c708065a3ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMjA0OTU1", "url": "https://github.com/prebid/prebid-server-java/pull/644#pullrequestreview-420204955", "createdAt": "2020-05-28T15:02:52Z", "commit": {"oid": "1f529c5f0daa6808040081bb93ab6c708065a3ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3319, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}