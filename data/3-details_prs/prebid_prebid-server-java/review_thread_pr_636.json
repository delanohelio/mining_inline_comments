{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MjM4NzQ0", "number": 636, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwOTo0Nzo1NFrODpCYJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOTozMjoyNVrODqtZcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzU3MTU3OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/handler/AdminHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwOTo0Nzo1NFrOF39SOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwOTo0Nzo1NFrOF39SOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIyMDA4OA==", "bodyText": "request.getParam(LOGGING_PARAM) could be extracted to a local variable as it is used down below once again", "url": "https://github.com/prebid/prebid-server-java/pull/636#discussion_r394220088", "createdAt": "2020-03-18T09:47:54Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/handler/AdminHandler.java", "diffHunk": "@@ -16,34 +17,52 @@\n \n     private static final String RECORDS_PARAM = \"records\";\n     private static final String LOGGING_PARAM = \"logging\";\n+    private static final String TIME_PARAM = \"time\";\n \n-    private final LogModifier logModifier;\n+    private final AdminManager adminManager;\n \n-    public AdminHandler(LogModifier logModifier) {\n-        this.logModifier = Objects.requireNonNull(logModifier);\n+    public AdminHandler(AdminManager adminManager) {\n+        this.adminManager = Objects.requireNonNull(adminManager);\n     }\n \n     @Override\n     public void handle(RoutingContext context) {\n         final HttpServerRequest request = context.request();\n-        final BiConsumer<Logger, String> loggingLevelModifier;\n-        final String loggingParam = request.getParam(LOGGING_PARAM);\n-        final String recordsParam = request.getParam(RECORDS_PARAM);\n-        final int records;\n-\n-        try {\n-            loggingLevelModifier = loggingLevel(loggingParam);\n-            records = records(recordsParam);\n-        } catch (IllegalArgumentException e) {\n+        if (request.getParam(LOGGING_PARAM) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cdbda6fc9dbfbc6e95aed1f6e0994ed38d65c47"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzU5MDcwOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/handler/AdminHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwOTo1MzoxM1rOF39e0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwOTo1MzoxM1rOF39e0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIyMzMxNA==", "bodyText": "Same applies to request.getParam(TIME_PARAM)", "url": "https://github.com/prebid/prebid-server-java/pull/636#discussion_r394223314", "createdAt": "2020-03-18T09:53:13Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/handler/AdminHandler.java", "diffHunk": "@@ -16,34 +17,52 @@\n \n     private static final String RECORDS_PARAM = \"records\";\n     private static final String LOGGING_PARAM = \"logging\";\n+    private static final String TIME_PARAM = \"time\";\n \n-    private final LogModifier logModifier;\n+    private final AdminManager adminManager;\n \n-    public AdminHandler(LogModifier logModifier) {\n-        this.logModifier = Objects.requireNonNull(logModifier);\n+    public AdminHandler(AdminManager adminManager) {\n+        this.adminManager = Objects.requireNonNull(adminManager);\n     }\n \n     @Override\n     public void handle(RoutingContext context) {\n         final HttpServerRequest request = context.request();\n-        final BiConsumer<Logger, String> loggingLevelModifier;\n-        final String loggingParam = request.getParam(LOGGING_PARAM);\n-        final String recordsParam = request.getParam(RECORDS_PARAM);\n-        final int records;\n-\n-        try {\n-            loggingLevelModifier = loggingLevel(loggingParam);\n-            records = records(recordsParam);\n-        } catch (IllegalArgumentException e) {\n+        if (request.getParam(LOGGING_PARAM) != null) {\n+            final BiConsumer<Logger, String> loggingLevelModifier;\n+            final String loggingParam = request.getParam(LOGGING_PARAM);\n+            final String recordsParam = request.getParam(RECORDS_PARAM);\n+            final int records;\n+\n+            try {\n+                loggingLevelModifier = loggingLevel(loggingParam);\n+                records = records(recordsParam);\n+            } catch (IllegalArgumentException e) {\n+                context.response()\n+                        .setStatusCode(HttpResponseStatus.BAD_REQUEST.code())\n+                        .end(e.getMessage());\n+                return;\n+            }\n+\n+            adminManager.setupByCounter(AdminManager.ADMIN_COUNTER_KEY, records, loggingLevelModifier,\n+                    (BiConsumer<Logger, String>) (logger, text) -> defaultLogModifier(logger).accept(logger, text));\n+            context.response()\n+                    .end(String.format(\"Logging level was changed to %s, for %s requests\", loggingParam, recordsParam));\n+        } else if (request.getParam(TIME_PARAM) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cdbda6fc9dbfbc6e95aed1f6e0994ed38d65c47"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzU5NDA2OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/handler/AdminHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwOTo1NDowNlrOF39g8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQwOTo1NDowNlrOF39g8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIyMzg1OQ==", "bodyText": "What happens if time parameter could not be parsed as Long?", "url": "https://github.com/prebid/prebid-server-java/pull/636#discussion_r394223859", "createdAt": "2020-03-18T09:54:06Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/handler/AdminHandler.java", "diffHunk": "@@ -16,34 +17,52 @@\n \n     private static final String RECORDS_PARAM = \"records\";\n     private static final String LOGGING_PARAM = \"logging\";\n+    private static final String TIME_PARAM = \"time\";\n \n-    private final LogModifier logModifier;\n+    private final AdminManager adminManager;\n \n-    public AdminHandler(LogModifier logModifier) {\n-        this.logModifier = Objects.requireNonNull(logModifier);\n+    public AdminHandler(AdminManager adminManager) {\n+        this.adminManager = Objects.requireNonNull(adminManager);\n     }\n \n     @Override\n     public void handle(RoutingContext context) {\n         final HttpServerRequest request = context.request();\n-        final BiConsumer<Logger, String> loggingLevelModifier;\n-        final String loggingParam = request.getParam(LOGGING_PARAM);\n-        final String recordsParam = request.getParam(RECORDS_PARAM);\n-        final int records;\n-\n-        try {\n-            loggingLevelModifier = loggingLevel(loggingParam);\n-            records = records(recordsParam);\n-        } catch (IllegalArgumentException e) {\n+        if (request.getParam(LOGGING_PARAM) != null) {\n+            final BiConsumer<Logger, String> loggingLevelModifier;\n+            final String loggingParam = request.getParam(LOGGING_PARAM);\n+            final String recordsParam = request.getParam(RECORDS_PARAM);\n+            final int records;\n+\n+            try {\n+                loggingLevelModifier = loggingLevel(loggingParam);\n+                records = records(recordsParam);\n+            } catch (IllegalArgumentException e) {\n+                context.response()\n+                        .setStatusCode(HttpResponseStatus.BAD_REQUEST.code())\n+                        .end(e.getMessage());\n+                return;\n+            }\n+\n+            adminManager.setupByCounter(AdminManager.ADMIN_COUNTER_KEY, records, loggingLevelModifier,\n+                    (BiConsumer<Logger, String>) (logger, text) -> defaultLogModifier(logger).accept(logger, text));\n+            context.response()\n+                    .end(String.format(\"Logging level was changed to %s, for %s requests\", loggingParam, recordsParam));\n+        } else if (request.getParam(TIME_PARAM) != null) {\n+            final long timeParam = Long.parseLong(request.getParam(TIME_PARAM));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cdbda6fc9dbfbc6e95aed1f6e0994ed38d65c47"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzYzMDYwOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/handler/AdminHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDowMzo1OFrOF395LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDowMzo1OFrOF395LA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIzMDA2MA==", "bodyText": "Aren't curly braces redundant here?", "url": "https://github.com/prebid/prebid-server-java/pull/636#discussion_r394230060", "createdAt": "2020-03-18T10:03:58Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/handler/AdminHandler.java", "diffHunk": "@@ -16,34 +17,52 @@\n \n     private static final String RECORDS_PARAM = \"records\";\n     private static final String LOGGING_PARAM = \"logging\";\n+    private static final String TIME_PARAM = \"time\";\n \n-    private final LogModifier logModifier;\n+    private final AdminManager adminManager;\n \n-    public AdminHandler(LogModifier logModifier) {\n-        this.logModifier = Objects.requireNonNull(logModifier);\n+    public AdminHandler(AdminManager adminManager) {\n+        this.adminManager = Objects.requireNonNull(adminManager);\n     }\n \n     @Override\n     public void handle(RoutingContext context) {\n         final HttpServerRequest request = context.request();\n-        final BiConsumer<Logger, String> loggingLevelModifier;\n-        final String loggingParam = request.getParam(LOGGING_PARAM);\n-        final String recordsParam = request.getParam(RECORDS_PARAM);\n-        final int records;\n-\n-        try {\n-            loggingLevelModifier = loggingLevel(loggingParam);\n-            records = records(recordsParam);\n-        } catch (IllegalArgumentException e) {\n+        if (request.getParam(LOGGING_PARAM) != null) {\n+            final BiConsumer<Logger, String> loggingLevelModifier;\n+            final String loggingParam = request.getParam(LOGGING_PARAM);\n+            final String recordsParam = request.getParam(RECORDS_PARAM);\n+            final int records;\n+\n+            try {\n+                loggingLevelModifier = loggingLevel(loggingParam);\n+                records = records(recordsParam);\n+            } catch (IllegalArgumentException e) {\n+                context.response()\n+                        .setStatusCode(HttpResponseStatus.BAD_REQUEST.code())\n+                        .end(e.getMessage());\n+                return;\n+            }\n+\n+            adminManager.setupByCounter(AdminManager.ADMIN_COUNTER_KEY, records, loggingLevelModifier,\n+                    (BiConsumer<Logger, String>) (logger, text) -> defaultLogModifier(logger).accept(logger, text));\n+            context.response()\n+                    .end(String.format(\"Logging level was changed to %s, for %s requests\", loggingParam, recordsParam));\n+        } else if (request.getParam(TIME_PARAM) != null) {\n+            final long timeParam = Long.parseLong(request.getParam(TIME_PARAM));\n+\n+            adminManager.setupByTime(AdminManager.ADMIN_TIME_KEY, timeParam,\n+                    (BiConsumer<ConditionalLogger, String>) (conditionalLogger, text) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cdbda6fc9dbfbc6e95aed1f6e0994ed38d65c47"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzY0NzQwOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/handler/openrtb2/AmpHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDowODo0MlrOF3-D8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDowODo0MlrOF3-D8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIzMjgxOA==", "bodyText": "It's considered a bad practice to catch NPE. Instead of this please check for null wherever it is possible to get one.", "url": "https://github.com/prebid/prebid-server-java/pull/636#discussion_r394232818", "createdAt": "2020-03-18T10:08:42Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/handler/openrtb2/AmpHandler.java", "diffHunk": "@@ -144,6 +147,44 @@ public void handle(RoutingContext routingContext) {\n                 .setHandler(responseResult -> handleResult(responseResult, ampEventBuilder, routingContext, startTime));\n     }\n \n+    private AuctionContext validateAccount(AuctionContext context) {\n+        if (adminManager.contains(AdminManager.ADMIN_TIME_KEY)) {\n+\n+            try {\n+                final List<String> accountIds = new ArrayList<>();\n+                accountIds.add(context.getBidRequest().getSite().getPublisher().getId());\n+                accountIds.add(context.getBidRequest().getApp().getPublisher().getId());\n+                accountIds.add(context.getAccount().getId());\n+                accountIds.addAll(context.getBidRequest().getImp().stream()\n+                        .map(Imp::getExt)\n+                        .map(this::parseExtImpRubicon)\n+                        .filter(Objects::nonNull)\n+                        .map(ExtImpRubicon::getAccountId)\n+                        .map(String::valueOf)\n+                        .collect(Collectors.toList()));\n+\n+                if (accountIds.contains(null)) {\n+                    printLog();\n+                }\n+            } catch (NullPointerException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cdbda6fc9dbfbc6e95aed1f6e0994ed38d65c47"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzY1MDI1OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/handler/openrtb2/AmpHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDowOTozNVrOF3-F2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDowOTozNVrOF3-F2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIzMzMwNg==", "bodyText": "I'm concerned about the logic of this method.\nWhat are you trying to achieve here and what is the actual requirement?", "url": "https://github.com/prebid/prebid-server-java/pull/636#discussion_r394233306", "createdAt": "2020-03-18T10:09:35Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/handler/openrtb2/AmpHandler.java", "diffHunk": "@@ -144,6 +147,44 @@ public void handle(RoutingContext routingContext) {\n                 .setHandler(responseResult -> handleResult(responseResult, ampEventBuilder, routingContext, startTime));\n     }\n \n+    private AuctionContext validateAccount(AuctionContext context) {\n+        if (adminManager.contains(AdminManager.ADMIN_TIME_KEY)) {\n+\n+            try {\n+                final List<String> accountIds = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cdbda6fc9dbfbc6e95aed1f6e0994ed38d65c47"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzY1NTA3OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/handler/openrtb2/AmpHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDoxMDo0NlrOF3-I6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDoxMDo0NlrOF3-I6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIzNDA4OA==", "bodyText": "The method name is too generic, please pick a more telling name.", "url": "https://github.com/prebid/prebid-server-java/pull/636#discussion_r394234088", "createdAt": "2020-03-18T10:10:46Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/handler/openrtb2/AmpHandler.java", "diffHunk": "@@ -144,6 +147,44 @@ public void handle(RoutingContext routingContext) {\n                 .setHandler(responseResult -> handleResult(responseResult, ampEventBuilder, routingContext, startTime));\n     }\n \n+    private AuctionContext validateAccount(AuctionContext context) {\n+        if (adminManager.contains(AdminManager.ADMIN_TIME_KEY)) {\n+\n+            try {\n+                final List<String> accountIds = new ArrayList<>();\n+                accountIds.add(context.getBidRequest().getSite().getPublisher().getId());\n+                accountIds.add(context.getBidRequest().getApp().getPublisher().getId());\n+                accountIds.add(context.getAccount().getId());\n+                accountIds.addAll(context.getBidRequest().getImp().stream()\n+                        .map(Imp::getExt)\n+                        .map(this::parseExtImpRubicon)\n+                        .filter(Objects::nonNull)\n+                        .map(ExtImpRubicon::getAccountId)\n+                        .map(String::valueOf)\n+                        .collect(Collectors.toList()));\n+\n+                if (accountIds.contains(null)) {\n+                    printLog();\n+                }\n+            } catch (NullPointerException e) {\n+                printLog();\n+            }\n+        }\n+        return context;\n+    }\n+\n+    private void printLog() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cdbda6fc9dbfbc6e95aed1f6e0994ed38d65c47"}, "originalPosition": 90}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzY2MjQ4OnYy", "diffSide": "RIGHT", "path": "src/test/java/org/prebid/server/manager/AdminManagerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDoxMjo0N1rOF3-Npw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDoxMjo0N1rOF3-Npw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIzNTMwMw==", "bodyText": "Please avoid using star imports", "url": "https://github.com/prebid/prebid-server-java/pull/636#discussion_r394235303", "createdAt": "2020-03-18T10:12:47Z", "author": {"login": "schernysh"}, "path": "src/test/java/org/prebid/server/manager/AdminManagerTest.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package org.prebid.server.manager;\n+\n+import io.vertx.core.logging.Logger;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnit;\n+import org.mockito.junit.MockitoRule;\n+\n+import java.util.function.BiConsumer;\n+\n+import static org.assertj.core.api.Assertions.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cdbda6fc9dbfbc6e95aed1f6e0994ed38d65c47"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0MzY3MzExOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/manager/AdminManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDoxNToyNlrOF3-UOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDoxNToyNlrOF3-UOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDIzNjk4NA==", "bodyText": "Please consider using java.time.Instant instead of java.util.Date throughout this class.", "url": "https://github.com/prebid/prebid-server-java/pull/636#discussion_r394236984", "createdAt": "2020-03-18T10:15:26Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/manager/AdminManager.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package org.prebid.server.manager;\n+\n+import lombok.AllArgsConstructor;\n+\n+import java.util.Date;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.function.BiConsumer;\n+\n+public class AdminManager {\n+\n+    public static final String ADMIN_COUNTER_KEY = \"admin_counter\";\n+    public static final String ADMIN_TIME_KEY = \"admin_time\";\n+\n+    private ConcurrentHashMap<String, Rule<?, ?>> actionMap;\n+\n+    public AdminManager() {\n+        actionMap = new ConcurrentHashMap<>();\n+    }\n+\n+    public void setupByCounter(String key, Integer amount, BiConsumer<?, ?> action, BiConsumer<?, ?> onFinish) {\n+        actionMap.put(key, new CounterRule(action, onFinish, amount));\n+    }\n+\n+    public void setupByTime(String key, long timeMillis, BiConsumer<?, ?> action, BiConsumer<?, ?> onFinish) {\n+        actionMap.put(key, new TimeRule(action, onFinish, timeMillis));\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public <T, U> void accept(String key, T t, U u) {\n+        final Rule<T, U> rule = (Rule<T, U>) actionMap.get(key);\n+        rule.applyRule().accept(t, u);\n+    }\n+\n+    public boolean contains(String key) {\n+        return actionMap.containsKey(key);\n+    }\n+\n+    @AllArgsConstructor\n+    private abstract static class Rule<T, U> {\n+\n+        protected BiConsumer<T, U> onRun;\n+\n+        protected BiConsumer<T, U> onFinish;\n+\n+        abstract BiConsumer<T, U> applyRule();\n+    }\n+\n+    private static class TimeRule<T, U> extends Rule<T, U> {\n+\n+        private Long time;\n+\n+        TimeRule(BiConsumer<T, U> onRun, BiConsumer<T, U> onFinish, Long timeMillis) {\n+            super(onRun, onFinish);\n+            this.onFinish = onFinish;\n+            this.time = new Date().getTime() + timeMillis;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cdbda6fc9dbfbc6e95aed1f6e0994ed38d65c47"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ0NDM1NTAxOnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/manager/AdminManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzozNDoxNlrOF4FI3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzozNDoxNlrOF4FI3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM0ODc2Nw==", "bodyText": "Actually time could be Instant as well. This will give an opportunity to use nice isBefore or isAfter methods. Also take note of plus method for getting another instant.\nAnother field for improvement: instead of Instance.now() use Instance.now(Clock) - this will ease testing a lot and will allow to get rid of Thread.sleep() (not 100% sure about that though :)).", "url": "https://github.com/prebid/prebid-server-java/pull/636#discussion_r394348767", "createdAt": "2020-03-18T13:34:16Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/manager/AdminManager.java", "diffHunk": "@@ -0,0 +1,87 @@\n+package org.prebid.server.manager;\n+\n+import lombok.AllArgsConstructor;\n+\n+import java.time.Instant;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import java.util.function.BiConsumer;\n+\n+public class AdminManager {\n+\n+    public static final String ADMIN_COUNTER_KEY = \"admin_counter\";\n+    public static final String ADMIN_TIME_KEY = \"admin_time\";\n+\n+    private ConcurrentHashMap<String, Rule<?, ?>> actionMap;\n+\n+    public AdminManager() {\n+        actionMap = new ConcurrentHashMap<>();\n+    }\n+\n+    public void setupByCounter(String key, Integer amount, BiConsumer<?, ?> action, BiConsumer<?, ?> onFinish) {\n+        actionMap.put(key, new CounterRule(action, onFinish, amount));\n+    }\n+\n+    public void setupByTime(String key, long timeMillis, BiConsumer<?, ?> action, BiConsumer<?, ?> onFinish) {\n+        actionMap.put(key, new TimeRule(action, onFinish, timeMillis));\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public <T, U> void accept(String key, T t, U u) {\n+        final Rule<T, U> rule = (Rule<T, U>) actionMap.get(key);\n+        rule.applyRule().accept(t, u);\n+    }\n+\n+    public boolean contains(String key) {\n+        return actionMap.containsKey(key);\n+    }\n+\n+    @AllArgsConstructor\n+    private abstract static class Rule<T, U> {\n+\n+        protected BiConsumer<T, U> onRun;\n+\n+        protected BiConsumer<T, U> onFinish;\n+\n+        abstract BiConsumer<T, U> applyRule();\n+    }\n+\n+    private static class TimeRule<T, U> extends Rule<T, U> {\n+\n+        private Long time;\n+\n+        TimeRule(BiConsumer<T, U> onRun, BiConsumer<T, U> onFinish, Long timeMillis) {\n+            super(onRun, onFinish);\n+            this.onFinish = onFinish;\n+            this.time = Instant.now().toEpochMilli() + timeMillis;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f923685dc85bf3716b01ce85ce2299bdbf2455d"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MTEwNTc5OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/handler/AdminHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOTozMjoyNVrOF6nw0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwOTozMjoyNVrOF6nw0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAxMzIwMw==", "bodyText": "I would extract defaultLogModifier(logger) to avoid unnecessary method execution.", "url": "https://github.com/prebid/prebid-server-java/pull/636#discussion_r397013203", "createdAt": "2020-03-24T09:32:25Z", "author": {"login": "DGarbar"}, "path": "src/main/java/org/prebid/server/handler/AdminHandler.java", "diffHunk": "@@ -41,7 +41,8 @@ public void handle(RoutingContext context) {\n             return;\n         }\n \n-        logModifier.set(loggingLevelModifier, records);\n+        adminManager.setupByCounter(AdminManager.ADMIN_COUNTER_KEY, records, loggingLevelModifier,\n+                (BiConsumer<Logger, String>) (logger, text) -> defaultLogModifier(logger).accept(logger, text));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77890c32b6d16f956eafe733d0ecf36f6cfcb0e3"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4162, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}