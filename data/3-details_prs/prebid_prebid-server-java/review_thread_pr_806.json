{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MTI5NDU5", "number": 806, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMDozODo1MlrOENwv2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMDo0MjoyMlrOENw0Wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyODY1NjI0OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/auction/FpdResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMDozODo1MlrOGwi_hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMDozODo1MlrOGwi_hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU1ODE1MQ==", "bodyText": "It would be more readable with guard condition of form:\nif(targeting == null) {\n    return extRequest;\n}\n\n...", "url": "https://github.com/prebid/prebid-server-java/pull/806#discussion_r453558151", "createdAt": "2020-07-13T10:38:52Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/auction/FpdResolver.java", "diffHunk": "@@ -172,24 +176,66 @@ public ObjectNode resolveImpExt(ObjectNode impExt, ObjectNode targeting) {\n         return mapper.mapper().valueToTree(resolvedExtImp);\n     }\n \n-    public ExtRequest resolveBidRequestExt(ExtRequest extRequest, List<String> fpdBidders) {\n-        if (CollectionUtils.isEmpty(fpdBidders)) {\n-            return extRequest;\n+    public ExtRequest resolveBidRequestExt(ExtRequest extRequest, Targeting targeting) {\n+        if (targeting != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e18647b57b401c0be3e509a372896c10ea294de4"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgyODY2Nzc4OnYy", "diffSide": "RIGHT", "path": "src/main/java/org/prebid/server/auction/FpdResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMDo0MjoyMlrOGwjGqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxMDo0MjoyMlrOGwjGqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzU1OTk3Ng==", "bodyText": "userNode and siteNode could be used instead of getters", "url": "https://github.com/prebid/prebid-server-java/pull/806#discussion_r453559976", "createdAt": "2020-07-13T10:42:22Z", "author": {"login": "schernysh"}, "path": "src/main/java/org/prebid/server/auction/FpdResolver.java", "diffHunk": "@@ -172,24 +176,66 @@ public ObjectNode resolveImpExt(ObjectNode impExt, ObjectNode targeting) {\n         return mapper.mapper().valueToTree(resolvedExtImp);\n     }\n \n-    public ExtRequest resolveBidRequestExt(ExtRequest extRequest, List<String> fpdBidders) {\n-        if (CollectionUtils.isEmpty(fpdBidders)) {\n-            return extRequest;\n+    public ExtRequest resolveBidRequestExt(ExtRequest extRequest, Targeting targeting) {\n+        if (targeting != null) {\n+            final ExtRequestPrebid extRequestPrebid = extRequest != null ? extRequest.getPrebid() : null;\n+            final ExtRequestPrebidData extRequestPrebidData = extRequestPrebid != null\n+                    ? extRequestPrebid.getData()\n+                    : null;\n+\n+            final ExtRequestPrebidData resolvedExtRequestPrebidData = resolveExtRequestPrebidData(extRequestPrebidData,\n+                    targeting.getBidders());\n+            final List<ExtRequestPrebidBidderConfig> resolvedBidderConfig = createAllowedAllBidderConfig(targeting);\n+\n+            if (resolvedExtRequestPrebidData != null || resolvedBidderConfig != null) {\n+                final ExtRequestPrebid.ExtRequestPrebidBuilder prebidBuilder = extRequestPrebid != null\n+                        ? extRequestPrebid.toBuilder()\n+                        : ExtRequestPrebid.builder();\n+                return ExtRequest.of(prebidBuilder\n+                        .data(resolvedExtRequestPrebidData != null\n+                                ? resolvedExtRequestPrebidData\n+                                : extRequestPrebidData)\n+                        .bidderconfig(resolvedBidderConfig).build());\n+            }\n+        }\n+        return extRequest;\n+    }\n+\n+    private ExtRequestPrebidData resolveExtRequestPrebidData(ExtRequestPrebidData data, List<String> fpdBidders) {\n+        if (CollectionUtils.isEmpty(fpdBidders) && data == null) {\n+            return null;\n+        }\n+        final List<String> originBidders = data != null ? data.getBidders() : Collections.emptyList();\n+        return CollectionUtils.isEmpty(originBidders)\n+                ? ExtRequestPrebidData.of(fpdBidders)\n+                : ExtRequestPrebidData.of(mergeBidders(fpdBidders, originBidders));\n+    }\n+\n+    private List<ExtRequestPrebidBidderConfig> createAllowedAllBidderConfig(Targeting targeting) {\n+        final ObjectNode userNode = targeting.getUser();\n+        final ObjectNode siteNode = targeting.getSite();\n+        if (targeting.getUser() == null && targeting.getSite() == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e18647b57b401c0be3e509a372896c10ea294de4"}, "originalPosition": 63}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3970, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}