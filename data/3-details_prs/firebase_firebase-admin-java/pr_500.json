{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzOTQ4NzIy", "number": 500, "title": "Add toJSON and fromJSON to Remote Config Template", "bodyText": "Add toJSON() and fromJSON() to Template\nAdd unit tests\n\nRelated to: #446", "createdAt": "2020-12-07T21:08:01Z", "url": "https://github.com/firebase/firebase-admin-java/pull/500", "merged": true, "mergeCommit": {"oid": "09043e6bf13cd9113e7f3cf00899738db4a8c9be"}, "closed": true, "closedAt": "2020-12-10T23:28:02Z", "author": {"login": "lahirumaramba"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdj8KhhgBqjQwODE2ODk1MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdk50N8AH2gAyNTMzOTQ4NzIyOjJjOWNhNDNlODRhNTgzZGFiNWY0MDQ0MTU2ZWY3MzQ4MTliYjFmZDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9fd135580255ab6ad8f35589c8e23b7a82f5ed5d", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/9fd135580255ab6ad8f35589c8e23b7a82f5ed5d", "committedDate": "2020-12-07T21:06:35Z", "message": "Add toJSON and fromJSON to Remote Config Template"}, "afterCommit": {"oid": "239401df217666331772f0022132c24d4476a75e", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/239401df217666331772f0022132c24d4476a75e", "committedDate": "2020-12-07T21:10:15Z", "message": "Add toJSON and fromJSON to Remote Config Template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "071940e3e852fd03f24ca69029f96b6eb23caf60", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/071940e3e852fd03f24ca69029f96b6eb23caf60", "committedDate": "2020-12-07T21:20:36Z", "message": "Add toJSON and fromJSON to Remote Config Template"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "239401df217666331772f0022132c24d4476a75e", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/239401df217666331772f0022132c24d4476a75e", "committedDate": "2020-12-07T21:10:15Z", "message": "Add toJSON and fromJSON to Remote Config Template"}, "afterCommit": {"oid": "071940e3e852fd03f24ca69029f96b6eb23caf60", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/071940e3e852fd03f24ca69029f96b6eb23caf60", "committedDate": "2020-12-07T21:20:36Z", "message": "Add toJSON and fromJSON to Remote Config Template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da323994ac5c0ffc95bc64b2d7f1040e45a0f77b", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/da323994ac5c0ffc95bc64b2d7f1040e45a0f77b", "committedDate": "2020-12-08T17:30:54Z", "message": "Update version update time serialization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cbcb9b93b493532f1dbbaac0eb25c535779db4b7", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/cbcb9b93b493532f1dbbaac0eb25c535779db4b7", "committedDate": "2020-12-08T17:28:00Z", "message": "Update version update time serialization"}, "afterCommit": {"oid": "da323994ac5c0ffc95bc64b2d7f1040e45a0f77b", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/da323994ac5c0ffc95bc64b2d7f1040e45a0f77b", "committedDate": "2020-12-08T17:30:54Z", "message": "Update version update time serialization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTgwNDMw", "url": "https://github.com/firebase/firebase-admin-java/pull/500#pullrequestreview-546580430", "createdAt": "2020-12-07T22:10:52Z", "commit": {"oid": "071940e3e852fd03f24ca69029f96b6eb23caf60"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QyMjoxMDo1MlrOIA9DSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQxOTozNDo1MFrOIBytPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzg3MTE3Ng==", "bodyText": "return", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r537871176", "createdAt": "2020-12-07T22:10:52Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/Template.java", "diffHunk": "@@ -177,6 +216,24 @@ public Template setVersion(Version version) {\n     return this;\n   }\n \n+  /**\n+   * Gets the JSON-serializable representation of this template.\n+   *\n+   * @return A JSON-serializable representation of this {@link Template} instance.\n+   */\n+  public String toJSON() {\n+    String jsonSerialization;\n+    Gson gson = new GsonBuilder()\n+            .registerTypeAdapter(ParameterValue.InAppDefault.class, new InAppDefaultAdapter())\n+            .create();\n+    try {\n+      jsonSerialization = gson.toJson(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "071940e3e852fd03f24ca69029f96b6eb23caf60"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0NTQyMQ==", "bodyText": "We should use the JsonFactory that comes from AppOptions", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538745421", "createdAt": "2020-12-08T19:27:14Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/Template.java", "diffHunk": "@@ -73,6 +87,22 @@ public Template() {\n     if (templateResponse.getVersion() != null) {\n       this.version = new Version(templateResponse.getVersion());\n     }\n+    this.etag = templateResponse.getEtag();\n+  }\n+\n+  /**\n+   * Creates and returns a new Remote Config template from a JSON string.\n+   *\n+   * @param json A non-null JSON string to populate a Remote Config template.\n+   * @return A new {@link Template} instance.\n+   * @throws IOException If the input JSON string is not parsable.\n+   */\n+  public static Template fromJSON(@NonNull String json) throws IOException {\n+    checkArgument(!Strings.isNullOrEmpty(json), \"JSON String must not be null or empty.\");\n+    JsonFactory jsonFactory = Utils.getDefaultJsonFactory();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da323994ac5c0ffc95bc64b2d7f1040e45a0f77b"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0OTM4MQ==", "bodyText": "Why not just construct a TemplateResponse instance here and then serialize that via JsonFactory? Gson shouldn't be needed.", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538749381", "createdAt": "2020-12-08T19:33:24Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/Template.java", "diffHunk": "@@ -177,6 +207,25 @@ public Template setVersion(Version version) {\n     return this;\n   }\n \n+  /**\n+   * Gets the JSON-serializable representation of this template.\n+   *\n+   * @return A JSON-serializable representation of this {@link Template} instance.\n+   */\n+  public String toJSON() {\n+    String jsonSerialization;\n+    Gson gson = new GsonBuilder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da323994ac5c0ffc95bc64b2d7f1040e45a0f77b"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc0OTkxMA==", "bodyText": "This wouldn't be needed if we used the existing TemplateResponse and VersionResponse types to handle serialization.", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538749910", "createdAt": "2020-12-08T19:34:17Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/Template.java", "diffHunk": "@@ -224,4 +273,33 @@ public boolean equals(Object o) {\n   public int hashCode() {\n     return Objects.hash(etag, parameters, conditions, parameterGroups, version);\n   }\n+\n+  private static class InAppDefaultAdapter implements JsonSerializer<ParameterValue.InAppDefault> {\n+\n+    @Override\n+    public JsonElement serialize(ParameterValue.InAppDefault src, Type typeOfSrc,\n+                                 JsonSerializationContext context) {\n+      JsonObject obj = new JsonObject();\n+      obj.addProperty(\"useInAppDefault\", true);\n+      return obj;\n+    }\n+  }\n+\n+  private static class VersionAdapter implements JsonSerializer<Version> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da323994ac5c0ffc95bc64b2d7f1040e45a0f77b"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODc1MDI2OA==", "bodyText": "Can be handled via ParameterValueResponse.", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538750268", "createdAt": "2020-12-08T19:34:50Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/Template.java", "diffHunk": "@@ -224,4 +273,33 @@ public boolean equals(Object o) {\n   public int hashCode() {\n     return Objects.hash(etag, parameters, conditions, parameterGroups, version);\n   }\n+\n+  private static class InAppDefaultAdapter implements JsonSerializer<ParameterValue.InAppDefault> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da323994ac5c0ffc95bc64b2d7f1040e45a0f77b"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b42051cd2b545f12d46d0577a245de34c8c21185", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/b42051cd2b545f12d46d0577a245de34c8c21185", "committedDate": "2020-12-08T21:46:57Z", "message": "Use Response types to serialize template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d92f733542f8765b0da375cf9b689eb09181c2e", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/8d92f733542f8765b0da375cf9b689eb09181c2e", "committedDate": "2020-12-08T22:06:53Z", "message": "Remove json string equality check to prevent failures with child reordering"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca4907df9f52747f170f920278d82466ec79a123", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/ca4907df9f52747f170f920278d82466ec79a123", "committedDate": "2020-12-08T22:17:00Z", "message": "Remove unused time validation function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bf780a2f57394ed00a52dd2951e373bc3046df8", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/4bf780a2f57394ed00a52dd2951e373bc3046df8", "committedDate": "2020-12-08T22:21:13Z", "message": "Improve Version update time unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3Njc2NjA5", "url": "https://github.com/firebase/firebase-admin-java/pull/500#pullrequestreview-547676609", "createdAt": "2020-12-08T22:13:15Z", "commit": {"oid": "8d92f733542f8765b0da375cf9b689eb09181c2e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjoxMzoxNVrOIB4mZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMjozMzoyMVrOIB5TyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0NjgyMA==", "bodyText": "Should we throw a FirebaseRemoteConfigException here?", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538846820", "createdAt": "2020-12-08T22:13:15Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/Template.java", "diffHunk": "@@ -73,6 +79,23 @@ public Template() {\n     if (templateResponse.getVersion() != null) {\n       this.version = new Version(templateResponse.getVersion());\n     }\n+    this.etag = templateResponse.getEtag();\n+  }\n+\n+  /**\n+   * Creates and returns a new Remote Config template from a JSON string.\n+   *\n+   * @param json A non-null JSON string to populate a Remote Config template.\n+   * @return A new {@link Template} instance.\n+   * @throws IOException If the input JSON string is not parsable.\n+   */\n+  public static Template fromJSON(@NonNull String json) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d92f733542f8765b0da375cf9b689eb09181c2e"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0ODc1MA==", "bodyText": "Nit: Slightly better for readability if this was turned into an if condition.\nif (includeAll) {\n  return templateResponse.setEtag(this.etag);\n}\n\nreturn templateResponse;", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538848750", "createdAt": "2020-12-08T22:16:35Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/Template.java", "diffHunk": "@@ -196,12 +233,13 @@ TemplateResponse toTemplateResponse() {\n       parameterGroupResponse.put(entry.getKey(), entry.getValue().toParameterGroupResponse());\n     }\n     TemplateResponse.VersionResponse versionResponse = (this.version == null) ? null\n-            : this.version.toVersionResponse();\n+            : this.version.toVersionResponse(includeAll);\n     return new TemplateResponse()\n             .setParameters(parameterResponses)\n             .setConditions(conditionResponses)\n             .setParameterGroups(parameterGroupResponse)\n-            .setVersion(versionResponse);\n+            .setVersion(versionResponse)\n+            .setEtag(includeAll ? this.etag : null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d92f733542f8765b0da375cf9b689eb09181c2e"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg0OTk1Nw==", "bodyText": "Nit:\nVersionResponse response = new VersionResponse().setDescription(this.description);\nif (includeAll) {\n  // add others\n}\n\nreturn response;", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538849957", "createdAt": "2020-12-08T22:18:11Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/Version.java", "diffHunk": "@@ -196,8 +190,20 @@ public Version setDescription(String description) {\n     return this;\n   }\n \n-  VersionResponse toVersionResponse() {\n+  VersionResponse toVersionResponse(boolean includeAll) {\n+    if (!includeAll) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d92f733542f8765b0da375cf9b689eb09181c2e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg1MDY3MA==", "bodyText": "Add a comment here indicating that this is never set by the HTTP response payload.", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538850670", "createdAt": "2020-12-08T22:19:29Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/internal/TemplateResponse.java", "diffHunk": "@@ -39,6 +39,9 @@\n   @Key(\"version\")\n   private VersionResponse version;\n \n+  @Key(\"etag\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca4907df9f52747f170f920278d82466ec79a123"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg1MjA0NQ==", "bodyText": "Add newline at eof", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538852045", "createdAt": "2020-12-08T22:21:49Z", "author": {"login": "hiranya911"}, "path": "src/test/resources/rcTemplateWithETag.json", "diffHunk": "@@ -0,0 +1 @@\n+{\"conditions\":[{\"expression\":\"exp ios\",\"name\":\"ios_en\",\"tagColor\":\"INDIGO\"},{\"expression\":\"exp android\",\"name\":\"android_en\"}],\"etag\":\"etag-0010201\",\"parameterGroups\":{\"greetings_group\":{\"description\":\"description\",\"parameters\":{\"greeting_text\":{\"conditionalValues\":{\"promo\":{\"useInAppDefault\":true},\"android\":{\"value\":\"hello android\"},\"ios\":{\"value\":\"hello ios\"}},\"defaultValue\":{\"useInAppDefault\":true},\"description\":\"greeting text\"},\"greeting_header\":{\"conditionalValues\":{\"promo\":{\"useInAppDefault\":true},\"android\":{\"value\":\"hello android\"},\"ios\":{\"value\":\"hello ios\"}},\"defaultValue\":{\"useInAppDefault\":true},\"description\":\"greeting header text\"}}}},\"parameters\":{\"greeting_text\":{\"conditionalValues\":{\"promo\":{\"useInAppDefault\":true},\"android\":{\"value\":\"hello android\"},\"ios\":{\"value\":\"hello ios\"}},\"defaultValue\":{\"useInAppDefault\":true},\"description\":\"greeting text\"},\"greeting_header\":{\"conditionalValues\":{\"promo\":{\"useInAppDefault\":true},\"android\":{\"value\":\"hello android\"},\"ios\":{\"value\":\"hello ios\"}},\"defaultValue\":{\"useInAppDefault\":true},\"description\":\"greeting header text\"}},\"version\":{\"description\":\"promo version\",\"legacy\":false}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca4907df9f52747f170f920278d82466ec79a123"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg1MzczMQ==", "bodyText": "This always ends up parsing at least twice. Can we improve that?\ntry {\n  return convertFromUtcZuluFormat(dateString); // common case first\n} catch (ParseException e) {\n  return convertFromUtcDateFormat(dateString); // fall back\n}", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538853731", "createdAt": "2020-12-08T22:24:53Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/RemoteConfigUtil.java", "diffHunk": "@@ -30,10 +31,52 @@ static boolean isValidVersionNumber(String versionNumber) {\n     return !Strings.isNullOrEmpty(versionNumber) && versionNumber.matches(\"^\\\\d+$\");\n   }\n \n+  static long convertToMilliseconds(String dateString) throws ParseException {\n+    if (isUTCDateString(dateString)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca4907df9f52747f170f920278d82466ec79a123"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg1NDU2Mw==", "bodyText": "Can we assign TimeZone.getTimeZone(\"UTC\") to a class-level constant?", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538854563", "createdAt": "2020-12-08T22:26:28Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/RemoteConfigUtil.java", "diffHunk": "@@ -30,10 +31,52 @@ static boolean isValidVersionNumber(String versionNumber) {\n     return !Strings.isNullOrEmpty(versionNumber) && versionNumber.matches(\"^\\\\d+$\");\n   }\n \n+  static long convertToMilliseconds(String dateString) throws ParseException {\n+    if (isUTCDateString(dateString)) {\n+      return convertFromUtcDateFormat(dateString);\n+    }\n+    return convertFromUtcZuluFormat(dateString);\n+  }\n+\n   static String convertToUtcZuluFormat(long millis) {\n+    // sample output date string: 2020-12-08T15:49:51.887878Z\n     checkArgument(millis >= 0, \"Milliseconds duration must not be negative\");\n     SimpleDateFormat dateFormat = new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSS000000'Z'\");\n     dateFormat.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n     return dateFormat.format(new Date(millis));\n   }\n+\n+  static String convertToUtcDateFormat(long millis) {\n+    // sample output date string: Tue, 08 Dec 2020 15:49:51 GMT\n+    checkArgument(millis >= 0, \"Milliseconds duration must not be negative\");\n+    SimpleDateFormat dateFormat = new SimpleDateFormat(\"EEE, dd MMM yyyy HH:mm:ss z\");\n+    dateFormat.setTimeZone(TimeZone.getTimeZone(\"UTC\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca4907df9f52747f170f920278d82466ec79a123"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg1NTAwOA==", "bodyText": "Use constants for pattern strings.", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538855008", "createdAt": "2020-12-08T22:27:13Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/RemoteConfigUtil.java", "diffHunk": "@@ -30,10 +31,52 @@ static boolean isValidVersionNumber(String versionNumber) {\n     return !Strings.isNullOrEmpty(versionNumber) && versionNumber.matches(\"^\\\\d+$\");\n   }\n \n+  static long convertToMilliseconds(String dateString) throws ParseException {\n+    if (isUTCDateString(dateString)) {\n+      return convertFromUtcDateFormat(dateString);\n+    }\n+    return convertFromUtcZuluFormat(dateString);\n+  }\n+\n   static String convertToUtcZuluFormat(long millis) {\n+    // sample output date string: 2020-12-08T15:49:51.887878Z\n     checkArgument(millis >= 0, \"Milliseconds duration must not be negative\");\n     SimpleDateFormat dateFormat = new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSS000000'Z'\");\n     dateFormat.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n     return dateFormat.format(new Date(millis));\n   }\n+\n+  static String convertToUtcDateFormat(long millis) {\n+    // sample output date string: Tue, 08 Dec 2020 15:49:51 GMT\n+    checkArgument(millis >= 0, \"Milliseconds duration must not be negative\");\n+    SimpleDateFormat dateFormat = new SimpleDateFormat(\"EEE, dd MMM yyyy HH:mm:ss z\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca4907df9f52747f170f920278d82466ec79a123"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg1NjM0Mg==", "bodyText": "Make this a separate test case.", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538856342", "createdAt": "2020-12-08T22:29:31Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/remoteconfig/TemplateTest.java", "diffHunk": "@@ -153,4 +159,193 @@ public void testEquality() {\n     assertNotEquals(templateThree, templateFive);\n     assertNotEquals(templateFour, templateFive);\n   }\n+\n+  @Test(expected = IOException.class)\n+  public void testFromJSONWithInvalidString() throws IOException {\n+    Template.fromJSON(\"abc\");\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testFromJSONWithEmptyString() throws IOException {\n+    Template.fromJSON(\"\");\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testFromJSONWithNullString() throws IOException {\n+    Template.fromJSON(null);\n+  }\n+\n+  @Test\n+  public void testFromJSON() throws IOException {\n+    Template template = Template.fromJSON(\"{}\");\n+\n+    assertNotNull(template.getParameters());\n+    assertNotNull(template.getConditions());\n+    assertNotNull(template.getParameterGroups());\n+    assertTrue(template.getParameters().isEmpty());\n+    assertTrue(template.getConditions().isEmpty());\n+    assertTrue(template.getParameterGroups().isEmpty());\n+    assertNull(template.getETag());\n+\n+    template = Template.fromJSON(\"{\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bf780a2f57394ed00a52dd2951e373bc3046df8"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg1NzQyNg==", "bodyText": "Split into multiple test cases", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538857426", "createdAt": "2020-12-08T22:31:33Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/remoteconfig/TemplateTest.java", "diffHunk": "@@ -153,4 +159,193 @@ public void testEquality() {\n     assertNotEquals(templateThree, templateFive);\n     assertNotEquals(templateFour, templateFive);\n   }\n+\n+  @Test(expected = IOException.class)\n+  public void testFromJSONWithInvalidString() throws IOException {\n+    Template.fromJSON(\"abc\");\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testFromJSONWithEmptyString() throws IOException {\n+    Template.fromJSON(\"\");\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testFromJSONWithNullString() throws IOException {\n+    Template.fromJSON(null);\n+  }\n+\n+  @Test\n+  public void testFromJSON() throws IOException {\n+    Template template = Template.fromJSON(\"{}\");\n+\n+    assertNotNull(template.getParameters());\n+    assertNotNull(template.getConditions());\n+    assertNotNull(template.getParameterGroups());\n+    assertTrue(template.getParameters().isEmpty());\n+    assertTrue(template.getConditions().isEmpty());\n+    assertTrue(template.getParameterGroups().isEmpty());\n+    assertNull(template.getETag());\n+\n+    template = Template.fromJSON(\"{\"\n+            + \"  \\\"etag\\\": \\\"etag-001234\\\",\"\n+            + \"  \\\"conditions\\\": [\"\n+            + \"    {\"\n+            + \"      \\\"name\\\": \\\"ios_en\\\",\"\n+            + \"      \\\"expression\\\": \\\"device.os == 'ios' && device.country in ['us', 'uk']\\\",\"\n+            + \"      \\\"tagColor\\\": \\\"INDIGO\\\"\"\n+            + \"    },\"\n+            + \"    {\"\n+            + \"      \\\"name\\\": \\\"android_en\\\",\"\n+            + \"      \\\"expression\\\": \\\"device.os == 'android' && device.country in ['us', 'uk']\\\"\"\n+            + \"    }\"\n+            + \"  ]\"\n+            + \"}\");\n+\n+    assertNotNull(template.getParameters());\n+    assertNotNull(template.getConditions());\n+    assertNotNull(template.getParameterGroups());\n+    assertTrue(template.getParameters().isEmpty());\n+    assertEquals(2, template.getConditions().size());\n+    assertEquals(\"ios_en\", template.getConditions().get(0).getName());\n+    assertEquals(\"device.os == 'ios' && device.country in ['us', 'uk']\",\n+            template.getConditions().get(0).getExpression());\n+    assertEquals(TagColor.INDIGO, template.getConditions().get(0).getTagColor());\n+    assertEquals(\"android_en\", template.getConditions().get(1).getName());\n+    assertEquals(\"device.os == 'android' && device.country in ['us', 'uk']\",\n+            template.getConditions().get(1).getExpression());\n+    assertEquals(TagColor.UNSPECIFIED, template.getConditions().get(1).getTagColor());\n+    assertTrue(template.getParameterGroups().isEmpty());\n+    assertEquals(\"etag-001234\", template.getETag());\n+  }\n+\n+  @Test\n+  public void testFromJSONWithVersion() throws IOException {\n+    final Version expectedVersion = new Version(new TemplateResponse.VersionResponse()\n+            .setDescription(\"template version\")\n+            .setUpdateTime(\"2020-12-08T15:49:51.887878Z\")\n+            .setUpdateUser(new TemplateResponse.UserResponse().setEmail(\"user@user.com\"))\n+            .setLegacy(false)\n+            .setUpdateType(\"INCREMENTAL_UPDATE\")\n+            .setRollbackSource(\"26\")\n+            .setVersionNumber(\"34\")\n+            .setUpdateOrigin(\"ADMIN_SDK_NODE\")\n+    );\n+    String jsonString = \"{\\\"parameters\\\":{},\\\"conditions\\\":[],\\\"parameterGroups\\\":{},\"\n+            + \"\\\"version\\\":{\\\"versionNumber\\\":\\\"34\\\",\"\n+            + \"\\\"updateTime\\\":\\\"Tue, 08 Dec 2020 15:49:51 UTC\\\",\"\n+            + \"\\\"updateOrigin\\\":\\\"ADMIN_SDK_NODE\\\",\\\"updateType\\\":\\\"INCREMENTAL_UPDATE\\\",\"\n+            + \"\\\"updateUser\\\":{\\\"email\\\":\\\"user@user.com\\\"},\\\"rollbackSource\\\":\\\"26\\\",\"\n+            + \"\\\"legacy\\\":false,\\\"description\\\":\\\"template version\\\"}}\";\n+    Template template = Template.fromJSON(jsonString);\n+\n+    assertNotNull(template.getParameters());\n+    assertNotNull(template.getConditions());\n+    assertNotNull(template.getParameterGroups());\n+    assertTrue(template.getParameters().isEmpty());\n+    assertTrue(template.getConditions().isEmpty());\n+    assertTrue(template.getParameterGroups().isEmpty());\n+    assertNull(template.getETag());\n+    // check version\n+    assertEquals(expectedVersion, template.getVersion());\n+    // update time should be correctly converted to milliseconds\n+    assertEquals(1607442591000L, template.getVersion().getUpdateTime());\n+  }\n+\n+  @Test\n+  public void testToJSON() {\n+    // Empty template\n+    String jsonString = new Template().toJSON();\n+\n+    assertEquals(\"{\\\"conditions\\\":[],\"\n+            + \"\\\"parameterGroups\\\":{},\\\"parameters\\\":{}}\", jsonString);\n+\n+    // Template with parameter values", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bf780a2f57394ed00a52dd2951e373bc3046df8"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODg1ODQ0MA==", "bodyText": "How about something like this?\nTemplate original = new Template();\nTemplate other = Template.fromJSON(original.toJSON());\nassertEqual(other, original);", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r538858440", "createdAt": "2020-12-08T22:33:21Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/remoteconfig/TemplateTest.java", "diffHunk": "@@ -153,4 +159,193 @@ public void testEquality() {\n     assertNotEquals(templateThree, templateFive);\n     assertNotEquals(templateFour, templateFive);\n   }\n+\n+  @Test(expected = IOException.class)\n+  public void testFromJSONWithInvalidString() throws IOException {\n+    Template.fromJSON(\"abc\");\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testFromJSONWithEmptyString() throws IOException {\n+    Template.fromJSON(\"\");\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testFromJSONWithNullString() throws IOException {\n+    Template.fromJSON(null);\n+  }\n+\n+  @Test\n+  public void testFromJSON() throws IOException {\n+    Template template = Template.fromJSON(\"{}\");\n+\n+    assertNotNull(template.getParameters());\n+    assertNotNull(template.getConditions());\n+    assertNotNull(template.getParameterGroups());\n+    assertTrue(template.getParameters().isEmpty());\n+    assertTrue(template.getConditions().isEmpty());\n+    assertTrue(template.getParameterGroups().isEmpty());\n+    assertNull(template.getETag());\n+\n+    template = Template.fromJSON(\"{\"\n+            + \"  \\\"etag\\\": \\\"etag-001234\\\",\"\n+            + \"  \\\"conditions\\\": [\"\n+            + \"    {\"\n+            + \"      \\\"name\\\": \\\"ios_en\\\",\"\n+            + \"      \\\"expression\\\": \\\"device.os == 'ios' && device.country in ['us', 'uk']\\\",\"\n+            + \"      \\\"tagColor\\\": \\\"INDIGO\\\"\"\n+            + \"    },\"\n+            + \"    {\"\n+            + \"      \\\"name\\\": \\\"android_en\\\",\"\n+            + \"      \\\"expression\\\": \\\"device.os == 'android' && device.country in ['us', 'uk']\\\"\"\n+            + \"    }\"\n+            + \"  ]\"\n+            + \"}\");\n+\n+    assertNotNull(template.getParameters());\n+    assertNotNull(template.getConditions());\n+    assertNotNull(template.getParameterGroups());\n+    assertTrue(template.getParameters().isEmpty());\n+    assertEquals(2, template.getConditions().size());\n+    assertEquals(\"ios_en\", template.getConditions().get(0).getName());\n+    assertEquals(\"device.os == 'ios' && device.country in ['us', 'uk']\",\n+            template.getConditions().get(0).getExpression());\n+    assertEquals(TagColor.INDIGO, template.getConditions().get(0).getTagColor());\n+    assertEquals(\"android_en\", template.getConditions().get(1).getName());\n+    assertEquals(\"device.os == 'android' && device.country in ['us', 'uk']\",\n+            template.getConditions().get(1).getExpression());\n+    assertEquals(TagColor.UNSPECIFIED, template.getConditions().get(1).getTagColor());\n+    assertTrue(template.getParameterGroups().isEmpty());\n+    assertEquals(\"etag-001234\", template.getETag());\n+  }\n+\n+  @Test\n+  public void testFromJSONWithVersion() throws IOException {\n+    final Version expectedVersion = new Version(new TemplateResponse.VersionResponse()\n+            .setDescription(\"template version\")\n+            .setUpdateTime(\"2020-12-08T15:49:51.887878Z\")\n+            .setUpdateUser(new TemplateResponse.UserResponse().setEmail(\"user@user.com\"))\n+            .setLegacy(false)\n+            .setUpdateType(\"INCREMENTAL_UPDATE\")\n+            .setRollbackSource(\"26\")\n+            .setVersionNumber(\"34\")\n+            .setUpdateOrigin(\"ADMIN_SDK_NODE\")\n+    );\n+    String jsonString = \"{\\\"parameters\\\":{},\\\"conditions\\\":[],\\\"parameterGroups\\\":{},\"\n+            + \"\\\"version\\\":{\\\"versionNumber\\\":\\\"34\\\",\"\n+            + \"\\\"updateTime\\\":\\\"Tue, 08 Dec 2020 15:49:51 UTC\\\",\"\n+            + \"\\\"updateOrigin\\\":\\\"ADMIN_SDK_NODE\\\",\\\"updateType\\\":\\\"INCREMENTAL_UPDATE\\\",\"\n+            + \"\\\"updateUser\\\":{\\\"email\\\":\\\"user@user.com\\\"},\\\"rollbackSource\\\":\\\"26\\\",\"\n+            + \"\\\"legacy\\\":false,\\\"description\\\":\\\"template version\\\"}}\";\n+    Template template = Template.fromJSON(jsonString);\n+\n+    assertNotNull(template.getParameters());\n+    assertNotNull(template.getConditions());\n+    assertNotNull(template.getParameterGroups());\n+    assertTrue(template.getParameters().isEmpty());\n+    assertTrue(template.getConditions().isEmpty());\n+    assertTrue(template.getParameterGroups().isEmpty());\n+    assertNull(template.getETag());\n+    // check version\n+    assertEquals(expectedVersion, template.getVersion());\n+    // update time should be correctly converted to milliseconds\n+    assertEquals(1607442591000L, template.getVersion().getUpdateTime());\n+  }\n+\n+  @Test\n+  public void testToJSON() {\n+    // Empty template\n+    String jsonString = new Template().toJSON();\n+\n+    assertEquals(\"{\\\"conditions\\\":[],\"\n+            + \"\\\"parameterGroups\\\":{},\\\"parameters\\\":{}}\", jsonString);\n+\n+    // Template with parameter values\n+    Template t = new Template();\n+    t.getParameters()\n+            .put(\"with_value\", new Parameter().setDefaultValue(ParameterValue.of(\"hello\")));\n+    t.getParameters()\n+            .put(\"with_inApp\", new Parameter().setDefaultValue(ParameterValue.inAppDefault()));\n+    jsonString = t.toJSON();\n+\n+    assertEquals(\"{\\\"conditions\\\":[],\\\"parameterGroups\\\":{},\"\n+            + \"\\\"parameters\\\":{\\\"with_value\\\":{\\\"conditionalValues\\\":{},\"\n+            + \"\\\"defaultValue\\\":{\\\"value\\\":\\\"hello\\\"}},\\\"with_inApp\\\":{\\\"conditionalValues\\\":{},\"\n+            + \"\\\"defaultValue\\\":{\\\"useInAppDefault\\\":true}}}}\", jsonString);\n+\n+    // Template with etag\n+    jsonString = new Template().setETag(\"etag-12345\").toJSON();\n+\n+    assertEquals(\"{\\\"conditions\\\":[],\\\"etag\\\":\\\"etag-12345\\\",\\\"parameterGroups\\\":{},\"\n+            + \"\\\"parameters\\\":{}}\", jsonString);\n+\n+    // Template with etag and conditions\n+    jsonString = new Template()\n+            .setETag(\"etag-0010201\")\n+            .setConditions(CONDITIONS).toJSON();\n+\n+    assertEquals(\"{\\\"conditions\\\":[{\\\"expression\\\":\\\"exp ios\\\",\\\"name\\\":\\\"ios_en\\\",\"\n+            + \"\\\"tagColor\\\":\\\"INDIGO\\\"},{\\\"expression\\\":\\\"exp android\\\",\"\n+            + \"\\\"name\\\":\\\"android_en\\\"}],\\\"etag\\\":\\\"etag-0010201\\\",\\\"parameterGroups\\\":{},\"\n+            + \"\\\"parameters\\\":{}}\", jsonString);\n+  }\n+\n+  @Test\n+  public void testToJSONWithVersion() {\n+    Version version = new Version(new TemplateResponse.VersionResponse()\n+            .setDescription(\"template version\")\n+            .setUpdateTime(\"2020-12-08T15:49:51.887878Z\")\n+            .setUpdateUser(new TemplateResponse.UserResponse().setEmail(\"user@user.com\"))\n+            .setLegacy(false)\n+            .setUpdateType(\"INCREMENTAL_UPDATE\")\n+            .setRollbackSource(\"26\")\n+            .setVersionNumber(\"34\")\n+            .setUpdateOrigin(\"ADMIN_SDK_NODE\")\n+    );\n+    String jsonString = new Template().setVersion(version).toJSON();\n+\n+    assertEquals(\"{\\\"conditions\\\":[],\\\"parameterGroups\\\":{},\\\"parameters\\\":{},\"\n+            + \"\\\"version\\\":{\\\"description\\\":\\\"template version\\\",\\\"legacy\\\":false,\"\n+            + \"\\\"rollbackSource\\\":\\\"26\\\",\\\"updateOrigin\\\":\\\"ADMIN_SDK_NODE\\\",\"\n+            + \"\\\"updateTime\\\":\\\"Tue, 08 Dec 2020 15:49:51 UTC\\\",\"\n+            + \"\\\"updateType\\\":\\\"INCREMENTAL_UPDATE\\\",\\\"updateUser\\\":{\"\n+            + \"\\\"email\\\":\\\"user@user.com\\\"},\\\"versionNumber\\\":\\\"34\\\"}}\", jsonString);\n+  }\n+\n+  @Test\n+  public void testToJSONAndFromJSON() throws IOException {\n+    String jsonString = new Template().toJSON();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bf780a2f57394ed00a52dd2951e373bc3046df8"}, "originalPosition": 180}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15bf2af6f2cc91af2c969fdda134726ba657dff0", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/15bf2af6f2cc91af2c969fdda134726ba657dff0", "committedDate": "2020-12-09T06:06:17Z", "message": "Clean up code base"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bfc019df5e122699ac84ff2121a6333a17c3a46", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/9bfc019df5e122699ac84ff2121a6333a17c3a46", "committedDate": "2020-12-09T20:05:54Z", "message": "PR fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NjE2MzQx", "url": "https://github.com/firebase/firebase-admin-java/pull/500#pullrequestreview-548616341", "createdAt": "2020-12-09T21:16:57Z", "commit": {"oid": "9bfc019df5e122699ac84ff2121a6333a17c3a46"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMToxNjo1OFrOICp24w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMToyMDowMVrOICp-eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY1Mzg1OQ==", "bodyText": "The example input doesn't really match the pattern. You might want to remove the fractional seconds before parsing the timestamp.", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r539653859", "createdAt": "2020-12-09T21:16:58Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/RemoteConfigUtil.java", "diffHunk": "@@ -27,66 +27,52 @@\n \n final class RemoteConfigUtil {\n \n+  private static final String ZULU_DATE_PATTERN = \"yyyy-MM-dd'T'HH:mm:ss.SSS000000'Z'\";\n+  private static final String ZULU_DATE_NO_FRAC_SECS_PATTERN = \"yyyy-MM-dd'T'HH:mm:ss\";\n+  private static final String UTC_DATE_PATTERN = \"EEE, dd MMM yyyy HH:mm:ss z\";\n+  private static final TimeZone UTC_TIME_ZONE = TimeZone.getTimeZone(\"UTC\");\n+\n   static boolean isValidVersionNumber(String versionNumber) {\n     return !Strings.isNullOrEmpty(versionNumber) && versionNumber.matches(\"^\\\\d+$\");\n   }\n \n   static long convertToMilliseconds(String dateString) throws ParseException {\n-    if (isUTCDateString(dateString)) {\n+    try {\n+      return convertFromUtcZuluFormat(dateString);\n+    } catch (ParseException e) {\n       return convertFromUtcDateFormat(dateString);\n     }\n-    return convertFromUtcZuluFormat(dateString);\n   }\n \n   static String convertToUtcZuluFormat(long millis) {\n     // sample output date string: 2020-12-08T15:49:51.887878Z\n     checkArgument(millis >= 0, \"Milliseconds duration must not be negative\");\n-    SimpleDateFormat dateFormat = new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSS000000'Z'\");\n-    dateFormat.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n+    SimpleDateFormat dateFormat = new SimpleDateFormat(ZULU_DATE_PATTERN);\n+    dateFormat.setTimeZone(UTC_TIME_ZONE);\n     return dateFormat.format(new Date(millis));\n   }\n \n   static String convertToUtcDateFormat(long millis) {\n     // sample output date string: Tue, 08 Dec 2020 15:49:51 GMT\n     checkArgument(millis >= 0, \"Milliseconds duration must not be negative\");\n-    SimpleDateFormat dateFormat = new SimpleDateFormat(\"EEE, dd MMM yyyy HH:mm:ss z\");\n-    dateFormat.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n+    SimpleDateFormat dateFormat = new SimpleDateFormat(UTC_DATE_PATTERN);\n+    dateFormat.setTimeZone(UTC_TIME_ZONE);\n     return dateFormat.format(new Date(millis));\n   }\n \n   static long convertFromUtcZuluFormat(String dateString) throws ParseException {\n     // sample input date string: 2020-12-08T15:49:51.887878Z\n     checkArgument(!Strings.isNullOrEmpty(dateString), \"Date string must not be null or empty\");\n-    SimpleDateFormat dateFormat = new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss\");\n-    dateFormat.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n+    SimpleDateFormat dateFormat = new SimpleDateFormat(ZULU_DATE_NO_FRAC_SECS_PATTERN);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bfc019df5e122699ac84ff2121a6333a17c3a46"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY1NDI1MQ==", "bodyText": "this(null)", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r539654251", "createdAt": "2020-12-09T21:17:33Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/Template.java", "diffHunk": "@@ -46,11 +46,20 @@\n \n   /**\n    * Creates a new {@link Template}.\n+   *\n+   * @param etag The ETag of this template.\n    */\n-  public Template() {\n-    parameters = new HashMap<>();\n-    conditions = new ArrayList<>();\n-    parameterGroups = new HashMap<>();\n+  public Template(String etag) {\n+    this.parameters = new HashMap<>();\n+    this.conditions = new ArrayList<>();\n+    this.parameterGroups = new HashMap<>();\n+    this.etag = etag;\n+  }\n+\n+  Template() {\n+    this.parameters = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bfc019df5e122699ac84ff2121a6333a17c3a46"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY1NDY2NQ==", "bodyText": "Use a local variable and split into 2 steps.", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r539654665", "createdAt": "2020-12-09T21:18:14Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/Template.java", "diffHunk": "@@ -84,18 +93,24 @@ public Template() {\n \n   /**\n    * Creates and returns a new Remote Config template from a JSON string.\n+   * Input JSON string must contain an {@code etag} property to create a valid template.\n    *\n    * @param json A non-null JSON string to populate a Remote Config template.\n    * @return A new {@link Template} instance.\n-   * @throws IOException If the input JSON string is not parsable.\n+   * @throws FirebaseRemoteConfigException If the input JSON string is not parsable.\n    */\n-  public static Template fromJSON(@NonNull String json) throws IOException {\n+  public static Template fromJSON(@NonNull String json) throws FirebaseRemoteConfigException {\n     checkArgument(!Strings.isNullOrEmpty(json), \"JSON String must not be null or empty.\");\n     // using the default json factory as no rpc calls are made here\n     JsonFactory jsonFactory = Utils.getDefaultJsonFactory();\n-    JsonParser parser = jsonFactory.createJsonParser(json);\n-    TemplateResponse templateResponse = parser.parseAndClose(TemplateResponse.class);\n-    return new Template(templateResponse);\n+    try {\n+      return new Template(jsonFactory", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bfc019df5e122699ac84ff2121a6333a17c3a46"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY1NTgwMg==", "bodyText": "Add a comment here indicating why we need 2 zulu format strings.", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r539655802", "createdAt": "2020-12-09T21:20:01Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/RemoteConfigUtil.java", "diffHunk": "@@ -20,20 +20,59 @@\n \n import com.google.common.base.Strings;\n \n+import java.text.ParseException;\n import java.text.SimpleDateFormat;\n import java.util.Date;\n import java.util.TimeZone;\n \n final class RemoteConfigUtil {\n \n+  private static final String ZULU_DATE_PATTERN = \"yyyy-MM-dd'T'HH:mm:ss.SSS000000'Z'\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bfc019df5e122699ac84ff2121a6333a17c3a46"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NjIwODk0", "url": "https://github.com/firebase/firebase-admin-java/pull/500#pullrequestreview-548620894", "createdAt": "2020-12-09T21:23:13Z", "commit": {"oid": "9bfc019df5e122699ac84ff2121a6333a17c3a46"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMToyMzoxNFrOICqG-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMToyMzoxNFrOICqG-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTY1Nzk3Nw==", "bodyText": "Why not run assertEquals on the template instances?", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r539657977", "createdAt": "2020-12-09T21:23:14Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/remoteconfig/TemplateTest.java", "diffHunk": "@@ -153,4 +166,192 @@ public void testEquality() {\n     assertNotEquals(templateThree, templateFive);\n     assertNotEquals(templateFour, templateFive);\n   }\n+\n+  @Test(expected = FirebaseRemoteConfigException.class)\n+  public void testFromJSONWithInvalidString() throws FirebaseRemoteConfigException {\n+    Template.fromJSON(\"abc\");\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testFromJSONWithEmptyString() throws FirebaseRemoteConfigException {\n+    Template.fromJSON(\"\");\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testFromJSONWithNullString() throws FirebaseRemoteConfigException {\n+    Template.fromJSON(null);\n+  }\n+\n+  @Test\n+  public void testFromJSONWithEmptyTemplateString() throws FirebaseRemoteConfigException {\n+    Template template = Template.fromJSON(\"{}\");\n+\n+    assertNotNull(template.getParameters());\n+    assertNotNull(template.getConditions());\n+    assertNotNull(template.getParameterGroups());\n+    assertTrue(template.getParameters().isEmpty());\n+    assertTrue(template.getConditions().isEmpty());\n+    assertTrue(template.getParameterGroups().isEmpty());\n+    assertNull(template.getETag());\n+  }\n+\n+  @Test\n+  public void testFromJSONWithNonEmptyTemplateString() throws FirebaseRemoteConfigException {\n+    Template template = Template.fromJSON(\"{\"\n+            + \"  \\\"etag\\\": \\\"etag-001234\\\",\"\n+            + \"  \\\"conditions\\\": [\"\n+            + \"    {\"\n+            + \"      \\\"name\\\": \\\"ios_en\\\",\"\n+            + \"      \\\"expression\\\": \\\"device.os == 'ios' && device.country in ['us', 'uk']\\\",\"\n+            + \"      \\\"tagColor\\\": \\\"INDIGO\\\"\"\n+            + \"    },\"\n+            + \"    {\"\n+            + \"      \\\"name\\\": \\\"android_en\\\",\"\n+            + \"      \\\"expression\\\": \\\"device.os == 'android' && device.country in ['us', 'uk']\\\"\"\n+            + \"    }\"\n+            + \"  ]\"\n+            + \"}\");\n+\n+    assertNotNull(template.getParameters());\n+    assertNotNull(template.getConditions());\n+    assertNotNull(template.getParameterGroups());\n+    assertTrue(template.getParameters().isEmpty());\n+    assertEquals(2, template.getConditions().size());\n+    assertEquals(\"ios_en\", template.getConditions().get(0).getName());\n+    assertEquals(\"device.os == 'ios' && device.country in ['us', 'uk']\",\n+            template.getConditions().get(0).getExpression());\n+    assertEquals(TagColor.INDIGO, template.getConditions().get(0).getTagColor());\n+    assertEquals(\"android_en\", template.getConditions().get(1).getName());\n+    assertEquals(\"device.os == 'android' && device.country in ['us', 'uk']\",\n+            template.getConditions().get(1).getExpression());\n+    assertEquals(TagColor.UNSPECIFIED, template.getConditions().get(1).getTagColor());\n+    assertTrue(template.getParameterGroups().isEmpty());\n+    assertEquals(\"etag-001234\", template.getETag());\n+  }\n+\n+  @Test\n+  public void testFromJSONWithVersion() throws FirebaseRemoteConfigException {\n+    final Version expectedVersion = new Version(new TemplateResponse.VersionResponse()\n+            .setDescription(\"template version\")\n+            .setUpdateTime(\"2020-12-08T15:49:51.887878Z\")\n+            .setUpdateUser(new TemplateResponse.UserResponse().setEmail(\"user@user.com\"))\n+            .setLegacy(false)\n+            .setUpdateType(\"INCREMENTAL_UPDATE\")\n+            .setRollbackSource(\"26\")\n+            .setVersionNumber(\"34\")\n+            .setUpdateOrigin(\"ADMIN_SDK_NODE\")\n+    );\n+    String jsonString = \"{\\\"parameters\\\":{},\\\"conditions\\\":[],\\\"parameterGroups\\\":{},\"\n+            + \"\\\"version\\\":{\\\"versionNumber\\\":\\\"34\\\",\"\n+            + \"\\\"updateTime\\\":\\\"Tue, 08 Dec 2020 15:49:51 UTC\\\",\"\n+            + \"\\\"updateOrigin\\\":\\\"ADMIN_SDK_NODE\\\",\\\"updateType\\\":\\\"INCREMENTAL_UPDATE\\\",\"\n+            + \"\\\"updateUser\\\":{\\\"email\\\":\\\"user@user.com\\\"},\\\"rollbackSource\\\":\\\"26\\\",\"\n+            + \"\\\"legacy\\\":false,\\\"description\\\":\\\"template version\\\"}}\";\n+    Template template = Template.fromJSON(jsonString);\n+\n+    assertNotNull(template.getParameters());\n+    assertNotNull(template.getConditions());\n+    assertNotNull(template.getParameterGroups());\n+    assertTrue(template.getParameters().isEmpty());\n+    assertTrue(template.getConditions().isEmpty());\n+    assertTrue(template.getParameterGroups().isEmpty());\n+    assertNull(template.getETag());\n+    // check version\n+    assertEquals(expectedVersion, template.getVersion());\n+    // update time should be correctly converted to milliseconds\n+    assertEquals(1607442591000L, template.getVersion().getUpdateTime());\n+  }\n+\n+  @Test\n+  public void testToJSONWithEmptyTemplate() {\n+    String jsonString = new Template().toJSON();\n+\n+    assertEquals(\"{\\\"conditions\\\":[],\"\n+            + \"\\\"parameterGroups\\\":{},\\\"parameters\\\":{}}\", jsonString);\n+  }\n+\n+  @Test\n+  public void testToJSONWithParameterValues() {\n+    Template t = new Template();\n+    t.getParameters()\n+            .put(\"with_value\", new Parameter().setDefaultValue(ParameterValue.of(\"hello\")));\n+    t.getParameters()\n+            .put(\"with_inApp\", new Parameter().setDefaultValue(ParameterValue.inAppDefault()));\n+    String jsonString = t.toJSON();\n+\n+    assertEquals(\"{\\\"conditions\\\":[],\\\"parameterGroups\\\":{},\"\n+            + \"\\\"parameters\\\":{\\\"with_value\\\":{\\\"conditionalValues\\\":{},\"\n+            + \"\\\"defaultValue\\\":{\\\"value\\\":\\\"hello\\\"}},\\\"with_inApp\\\":{\\\"conditionalValues\\\":{},\"\n+            + \"\\\"defaultValue\\\":{\\\"useInAppDefault\\\":true}}}}\", jsonString);\n+  }\n+\n+  @Test\n+  public void testToJSONWithEtag() {\n+    String jsonString = new Template(\"etag-12345\").toJSON();\n+\n+    assertEquals(\"{\\\"conditions\\\":[],\\\"etag\\\":\\\"etag-12345\\\",\\\"parameterGroups\\\":{},\"\n+            + \"\\\"parameters\\\":{}}\", jsonString);\n+  }\n+\n+  @Test\n+  public void testToJSONWithEtagAndConditions() {\n+    String jsonString = new Template(\"etag-0010201\")\n+            .setConditions(CONDITIONS).toJSON();\n+\n+    assertEquals(\"{\\\"conditions\\\":[{\\\"expression\\\":\\\"exp ios\\\",\\\"name\\\":\\\"ios_en\\\",\"\n+            + \"\\\"tagColor\\\":\\\"INDIGO\\\"},{\\\"expression\\\":\\\"exp android\\\",\"\n+            + \"\\\"name\\\":\\\"android_en\\\"}],\\\"etag\\\":\\\"etag-0010201\\\",\\\"parameterGroups\\\":{},\"\n+            + \"\\\"parameters\\\":{}}\", jsonString);\n+  }\n+\n+  @Test\n+  public void testToJSONWithVersion() {\n+    Version version = new Version(new TemplateResponse.VersionResponse()\n+            .setDescription(\"template version\")\n+            .setUpdateTime(\"2020-12-08T15:49:51.887878Z\")\n+            .setUpdateUser(new TemplateResponse.UserResponse().setEmail(\"user@user.com\"))\n+            .setLegacy(false)\n+            .setUpdateType(\"INCREMENTAL_UPDATE\")\n+            .setRollbackSource(\"26\")\n+            .setVersionNumber(\"34\")\n+            .setUpdateOrigin(\"ADMIN_SDK_NODE\")\n+    );\n+    String jsonString = new Template().setVersion(version).toJSON();\n+\n+    assertEquals(\"{\\\"conditions\\\":[],\\\"parameterGroups\\\":{},\\\"parameters\\\":{},\"\n+            + \"\\\"version\\\":{\\\"description\\\":\\\"template version\\\",\\\"legacy\\\":false,\"\n+            + \"\\\"rollbackSource\\\":\\\"26\\\",\\\"updateOrigin\\\":\\\"ADMIN_SDK_NODE\\\",\"\n+            + \"\\\"updateTime\\\":\\\"Tue, 08 Dec 2020 15:49:51 UTC\\\",\"\n+            + \"\\\"updateType\\\":\\\"INCREMENTAL_UPDATE\\\",\\\"updateUser\\\":{\"\n+            + \"\\\"email\\\":\\\"user@user.com\\\"},\\\"versionNumber\\\":\\\"34\\\"}}\", jsonString);\n+  }\n+\n+  @Test\n+  public void testToJSONAndFromJSON() throws FirebaseRemoteConfigException {\n+    Template originalTemplate = new Template();\n+    Template otherTemplate = Template.fromJSON(originalTemplate.toJSON());\n+\n+    assertEquals(originalTemplate, otherTemplate);\n+\n+    Version expectedVersion = Version.withDescription(\"promo version\");\n+    originalTemplate = new Template(\"etag-0010201\")\n+            .setParameters(PARAMETERS)\n+            .setConditions(CONDITIONS)\n+            .setParameterGroups(PARAMETER_GROUPS)\n+            .setVersion(expectedVersion);\n+    Template template = Template.fromJSON(originalTemplate.toJSON());\n+\n+    assertEquals(\"etag-0010201\", template.getETag());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bfc019df5e122699ac84ff2121a6333a17c3a46"}, "originalPosition": 221}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5aa86007b0e220df47789d7c07481aa183885c02", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/5aa86007b0e220df47789d7c07481aa183885c02", "committedDate": "2020-12-10T18:39:02Z", "message": "Code cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NTY4MDI4", "url": "https://github.com/firebase/firebase-admin-java/pull/500#pullrequestreview-549568028", "createdAt": "2020-12-10T20:17:53Z", "commit": {"oid": "5aa86007b0e220df47789d7c07481aa183885c02"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMDoxNzo1M1rOIDbkvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMDoxNzo1M1rOIDbkvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQ2ODQxNQ==", "bodyText": "This should happen before everything else.", "url": "https://github.com/firebase/firebase-admin-java/pull/500#discussion_r540468415", "createdAt": "2020-12-10T20:17:53Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/remoteconfig/RemoteConfigUtil.java", "diffHunk": "@@ -20,20 +20,74 @@\n \n import com.google.common.base.Strings;\n \n+import java.text.ParseException;\n import java.text.SimpleDateFormat;\n import java.util.Date;\n import java.util.TimeZone;\n \n final class RemoteConfigUtil {\n \n+  // SimpleDateFormat cannot handle fractional seconds in timestamps\n+  // (example: \"2014-10-02T15:01:23.045123456Z\"). Therefore, we strip fractional seconds\n+  // from the date string (example: \"2014-10-02T15:01:23\") when parsing Zulu timestamp strings.\n+  // The backend API expects timestamps in Zulu format with fractional seconds. To generate correct\n+  // timestamps in payloads we use \".SSS000000'Z'\" suffix.\n+  // Hence, two Zulu date patterns are used below.\n+  private static final String ZULU_DATE_PATTERN = \"yyyy-MM-dd'T'HH:mm:ss.SSS000000'Z'\";\n+  private static final String ZULU_DATE_NO_FRAC_SECS_PATTERN = \"yyyy-MM-dd'T'HH:mm:ss\";\n+  private static final String UTC_DATE_PATTERN = \"EEE, dd MMM yyyy HH:mm:ss z\";\n+  private static final TimeZone UTC_TIME_ZONE = TimeZone.getTimeZone(\"UTC\");\n+\n   static boolean isValidVersionNumber(String versionNumber) {\n     return !Strings.isNullOrEmpty(versionNumber) && versionNumber.matches(\"^\\\\d+$\");\n   }\n \n+  static long convertToMilliseconds(String dateString) throws ParseException {\n+    try {\n+      return convertFromUtcZuluFormat(dateString);\n+    } catch (ParseException e) {\n+      return convertFromUtcDateFormat(dateString);\n+    }\n+  }\n+\n   static String convertToUtcZuluFormat(long millis) {\n+    // sample output date string: 2020-11-12T22:12:02.000000000Z\n     checkArgument(millis >= 0, \"Milliseconds duration must not be negative\");\n-    SimpleDateFormat dateFormat = new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSS000000'Z'\");\n-    dateFormat.setTimeZone(TimeZone.getTimeZone(\"UTC\"));\n+    SimpleDateFormat dateFormat = new SimpleDateFormat(ZULU_DATE_PATTERN);\n+    dateFormat.setTimeZone(UTC_TIME_ZONE);\n     return dateFormat.format(new Date(millis));\n   }\n+\n+  static String convertToUtcDateFormat(long millis) {\n+    // sample output date string: Tue, 08 Dec 2020 15:49:51 GMT\n+    checkArgument(millis >= 0, \"Milliseconds duration must not be negative\");\n+    SimpleDateFormat dateFormat = new SimpleDateFormat(UTC_DATE_PATTERN);\n+    dateFormat.setTimeZone(UTC_TIME_ZONE);\n+    return dateFormat.format(new Date(millis));\n+  }\n+\n+  static long convertFromUtcZuluFormat(String dateString) throws ParseException {\n+    // Input timestamp is in RFC3339 UTC \"Zulu\" format, accurate to\n+    // nanoseconds (up to 9 fractional seconds digits).\n+    // SimpleDateFormat cannot handle fractional seconds, therefore we strip fractional seconds\n+    // from the input date string before parsing.\n+    // example: input -> \"2014-10-02T15:01:23.045123456Z\"\n+    // formatted -> \"2014-10-02T15:01:23\"\n+    int indexOfPeriod = dateString.indexOf(\".\");\n+    if (indexOfPeriod != -1) {\n+      dateString = dateString.substring(0, indexOfPeriod);\n+    }\n+    checkArgument(!Strings.isNullOrEmpty(dateString), \"Date string must not be null or empty\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5aa86007b0e220df47789d7c07481aa183885c02"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c9ca43e84a583dab5f4044156ef734819bb1fd1", "author": {"user": {"login": "lahirumaramba", "name": "Lahiru Maramba"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/2c9ca43e84a583dab5f4044156ef734819bb1fd1", "committedDate": "2020-12-10T21:00:08Z", "message": "PR fixes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2790, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}