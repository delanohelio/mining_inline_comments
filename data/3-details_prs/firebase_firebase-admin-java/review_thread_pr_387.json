{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNDU3NjY4", "number": 387, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOTozNjo0N1rODvtjEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDozMzoyNVrODwjm2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzU1OTIzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOTozNjo0N1rOGCTF8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODoyODo0M1rOGDkdIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2MzE1NQ==", "bodyText": "For readability, I'd suggest defining another constructor for this class:\nFirebaseUserManager(@NonNull FirebaseApp app) {\n  this(app, null);\n}\n\nYou can call it from FirebaseAuth.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r405063155", "createdAt": "2020-04-07T19:36:47Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -115,15 +115,18 @@\n    * Creates a new FirebaseUserManager instance.\n    *\n    * @param app A non-null {@link FirebaseApp}.\n+   * @param tenantId The associated tenant ID if the user operations should be tenant-aware,\n+   *     otherwise {@code null}\n    */\n-  FirebaseUserManager(@NonNull FirebaseApp app) {\n+  FirebaseUserManager(@NonNull FirebaseApp app, @Nullable String tenantId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM5NjE5NA==", "bodyText": "Done.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r406396194", "createdAt": "2020-04-09T18:28:43Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -115,15 +115,18 @@\n    * Creates a new FirebaseUserManager instance.\n    *\n    * @param app A non-null {@link FirebaseApp}.\n+   * @param tenantId The associated tenant ID if the user operations should be tenant-aware,\n+   *     otherwise {@code null}\n    */\n-  FirebaseUserManager(@NonNull FirebaseApp app) {\n+  FirebaseUserManager(@NonNull FirebaseApp app, @Nullable String tenantId) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2MzE1NQ=="}, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzU2NDM2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOTozODozMVrOGCTJQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxOToyNTozMFrOGDmS1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NDAwMQ==", "bodyText": "I feel like a simple if-else will explain the logic here a bit better:\nif (Strings.isNullOrEmpty(tenantId) {\n  this.userMgtBaseUrl = ...\n} else {\n  this.userMgtBaseUrl = ...\n}\n\nThen in getTenantUrlSuffix() make tenantId non-null.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r405064001", "createdAt": "2020-04-07T19:38:31Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -115,15 +115,18 @@\n    * Creates a new FirebaseUserManager instance.\n    *\n    * @param app A non-null {@link FirebaseApp}.\n+   * @param tenantId The associated tenant ID if the user operations should be tenant-aware,\n+   *     otherwise {@code null}\n    */\n-  FirebaseUserManager(@NonNull FirebaseApp app) {\n+  FirebaseUserManager(@NonNull FirebaseApp app, @Nullable String tenantId) {\n     checkNotNull(app, \"FirebaseApp must not be null\");\n     String projectId = ImplFirebaseTrampolines.getProjectId(app);\n     checkArgument(!Strings.isNullOrEmpty(projectId),\n         \"Project ID is required to access the auth service. Use a service account credential or \"\n             + \"set the project ID explicitly via FirebaseOptions. Alternatively you can also \"\n             + \"set the project ID via the GOOGLE_CLOUD_PROJECT environment variable.\");\n-    this.userMgtBaseUrl = String.format(ID_TOOLKIT_URL, \"v1\", projectId);\n+    this.userMgtBaseUrl =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQyNjMyNA==", "bodyText": "Done.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r406426324", "createdAt": "2020-04-09T19:25:30Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -115,15 +115,18 @@\n    * Creates a new FirebaseUserManager instance.\n    *\n    * @param app A non-null {@link FirebaseApp}.\n+   * @param tenantId The associated tenant ID if the user operations should be tenant-aware,\n+   *     otherwise {@code null}\n    */\n-  FirebaseUserManager(@NonNull FirebaseApp app) {\n+  FirebaseUserManager(@NonNull FirebaseApp app, @Nullable String tenantId) {\n     checkNotNull(app, \"FirebaseApp must not be null\");\n     String projectId = ImplFirebaseTrampolines.getProjectId(app);\n     checkArgument(!Strings.isNullOrEmpty(projectId),\n         \"Project ID is required to access the auth service. Use a service account credential or \"\n             + \"set the project ID explicitly via FirebaseOptions. Alternatively you can also \"\n             + \"set the project ID via the GOOGLE_CLOUD_PROJECT environment variable.\");\n-    this.userMgtBaseUrl = String.format(ID_TOOLKIT_URL, \"v1\", projectId);\n+    this.userMgtBaseUrl =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NDAwMQ=="}, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzU2NjI4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOTozOTowMVrOGCTKeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODoyODo1MlrOGDkdgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NDMxMw==", "bodyText": "checkArgument(!Strings.isNullOrEmpty(tenantId));", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r405064313", "createdAt": "2020-04-07T19:39:01Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -312,6 +315,10 @@ String getEmailActionLink(EmailLinkType type, String email,\n     throw new FirebaseAuthException(INTERNAL_ERROR, \"Failed to create email action link\");\n   }\n \n+  private static String getTenantUrlSuffix(@Nullable String tenantId) {\n+    return tenantId == null ? \"\" : \"/tenants/\" + tenantId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM5NjI5MQ==", "bodyText": "Done.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r406396291", "createdAt": "2020-04-09T18:28:52Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -312,6 +315,10 @@ String getEmailActionLink(EmailLinkType type, String email,\n     throw new FirebaseAuthException(INTERNAL_ERROR, \"Failed to create email action link\");\n   }\n \n+  private static String getTenantUrlSuffix(@Nullable String tenantId) {\n+    return tenantId == null ? \"\" : \"/tenants/\" + tenantId;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NDMxMw=="}, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzU3MzM3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOTo0MTowMlrOGCTO3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODozMDoxN1rOGDkgzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NTQzOA==", "bodyText": "Can we shift the FirebaseAuth.Builder into this class, and reuse it in both child classes? A constructor with this many args is a little strange.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r405065438", "createdAt": "2020-04-07T19:41:02Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java", "diffHunk": "@@ -63,17 +63,13 @@\n       final FirebaseApp firebaseApp,\n       Supplier<FirebaseTokenFactory> tokenFactory,\n       Supplier<? extends FirebaseTokenVerifier> idTokenVerifier,\n-      Supplier<? extends FirebaseTokenVerifier> cookieVerifier) {\n+      Supplier<? extends FirebaseTokenVerifier> cookieVerifier,\n+      Supplier<FirebaseUserManager> userManager) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM5NzEzMw==", "bodyText": "I've made this change, but I have to admit, I find this design a little strange.\nFortunately, this design is not exposed to any users, so I suppose it can always be iterated upon in the future.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r406397133", "createdAt": "2020-04-09T18:30:17Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/AbstractFirebaseAuth.java", "diffHunk": "@@ -63,17 +63,13 @@\n       final FirebaseApp firebaseApp,\n       Supplier<FirebaseTokenFactory> tokenFactory,\n       Supplier<? extends FirebaseTokenVerifier> idTokenVerifier,\n-      Supplier<? extends FirebaseTokenVerifier> cookieVerifier) {\n+      Supplier<? extends FirebaseTokenVerifier> cookieVerifier,\n+      Supplier<FirebaseUserManager> userManager) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NTQzOA=="}, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzU3NTkzOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/google/firebase/auth/TenantAwareFirebaseAuth.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOTo0MTo1MVrOGCTQdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODoyODo1OVrOGDkd1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NTg0NA==", "bodyText": "check not null or empty", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r405065844", "createdAt": "2020-04-07T19:41:51Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/TenantAwareFirebaseAuth.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.firebase.auth;\n+\n+import com.google.api.client.util.Clock;\n+import com.google.common.base.Supplier;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.auth.internal.FirebaseTokenFactory;\n+\n+/**\n+ * The tenant-aware Firebase client.\n+ *\n+ * <p>This can be used to perform a variety of authentication-related operations, scoped to a\n+ * particular tenant.\n+ */\n+public class TenantAwareFirebaseAuth extends AbstractFirebaseAuth {\n+\n+  private final String tenantId;\n+\n+  TenantAwareFirebaseAuth(final FirebaseApp firebaseApp, final String tenantId) {\n+    // TODO(micahstairs): Incorporate tenant ID into token generation as well as ID token and\n+    // session cookie verification.\n+    super(\n+        firebaseApp,\n+        new Supplier<FirebaseTokenFactory>() {\n+          @Override\n+          public FirebaseTokenFactory get() {\n+            return FirebaseTokenUtils.createTokenFactory(firebaseApp, Clock.SYSTEM);\n+          }\n+        },\n+        new Supplier<FirebaseTokenVerifier>() {\n+          @Override\n+          public FirebaseTokenVerifier get() {\n+            return FirebaseTokenUtils.createIdTokenVerifier(firebaseApp, Clock.SYSTEM);\n+          }\n+        },\n+        new Supplier<FirebaseTokenVerifier>() {\n+          @Override\n+          public FirebaseTokenVerifier get() {\n+            return FirebaseTokenUtils.createSessionCookieVerifier(firebaseApp, Clock.SYSTEM);\n+          }\n+        },\n+        new Supplier<FirebaseUserManager>() {\n+          @Override\n+          public FirebaseUserManager get() {\n+            return new FirebaseUserManager(firebaseApp, tenantId);\n+          }\n+        });\n+    this.tenantId = tenantId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM5NjM3NQ==", "bodyText": "Done.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r406396375", "createdAt": "2020-04-09T18:28:59Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/TenantAwareFirebaseAuth.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.firebase.auth;\n+\n+import com.google.api.client.util.Clock;\n+import com.google.common.base.Supplier;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.auth.internal.FirebaseTokenFactory;\n+\n+/**\n+ * The tenant-aware Firebase client.\n+ *\n+ * <p>This can be used to perform a variety of authentication-related operations, scoped to a\n+ * particular tenant.\n+ */\n+public class TenantAwareFirebaseAuth extends AbstractFirebaseAuth {\n+\n+  private final String tenantId;\n+\n+  TenantAwareFirebaseAuth(final FirebaseApp firebaseApp, final String tenantId) {\n+    // TODO(micahstairs): Incorporate tenant ID into token generation as well as ID token and\n+    // session cookie verification.\n+    super(\n+        firebaseApp,\n+        new Supplier<FirebaseTokenFactory>() {\n+          @Override\n+          public FirebaseTokenFactory get() {\n+            return FirebaseTokenUtils.createTokenFactory(firebaseApp, Clock.SYSTEM);\n+          }\n+        },\n+        new Supplier<FirebaseTokenVerifier>() {\n+          @Override\n+          public FirebaseTokenVerifier get() {\n+            return FirebaseTokenUtils.createIdTokenVerifier(firebaseApp, Clock.SYSTEM);\n+          }\n+        },\n+        new Supplier<FirebaseTokenVerifier>() {\n+          @Override\n+          public FirebaseTokenVerifier get() {\n+            return FirebaseTokenUtils.createSessionCookieVerifier(firebaseApp, Clock.SYSTEM);\n+          }\n+        },\n+        new Supplier<FirebaseUserManager>() {\n+          @Override\n+          public FirebaseUserManager get() {\n+            return new FirebaseUserManager(firebaseApp, tenantId);\n+          }\n+        });\n+    this.tenantId = tenantId;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NTg0NA=="}, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzU4MDQzOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOTo0MzoyM1rOGCTTeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODoyOToyMVrOGDke0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NjYxNg==", "bodyText": "Also delete the tenant at the end of the test", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r405066616", "createdAt": "2020-04-07T19:43:23Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -320,6 +319,203 @@ public void onSuccess(ListUsersPage result) {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareUserLifecycle() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    final String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+\n+    // Create user\n+    UserRecord userRecord = tenantAwareAuth.createUserAsync(new UserRecord.CreateRequest()).get();\n+    String uid = userRecord.getUid();\n+\n+    // Get user\n+    userRecord = tenantAwareAuth.getUserAsync(userRecord.getUid()).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertNull(userRecord.getDisplayName());\n+    assertNull(userRecord.getEmail());\n+    assertNull(userRecord.getPhoneNumber());\n+    assertNull(userRecord.getPhotoUrl());\n+    assertFalse(userRecord.isEmailVerified());\n+    assertFalse(userRecord.isDisabled());\n+    assertTrue(userRecord.getUserMetadata().getCreationTimestamp() > 0);\n+    assertEquals(0, userRecord.getUserMetadata().getLastSignInTimestamp());\n+    assertEquals(0, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Update user\n+    RandomUser randomUser = RandomUser.create();\n+    String phone = randomPhoneNumber();\n+    UserRecord.UpdateRequest request = userRecord.updateRequest()\n+        .setDisplayName(\"Updated Name\")\n+        .setEmail(randomUser.email)\n+        .setPhoneNumber(phone)\n+        .setPhotoUrl(\"https://example.com/photo.png\")\n+        .setEmailVerified(true)\n+        .setPassword(\"secret\");\n+    userRecord = tenantAwareAuth.updateUserAsync(request).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertEquals(\"Updated Name\", userRecord.getDisplayName());\n+    assertEquals(randomUser.email, userRecord.getEmail());\n+    assertEquals(phone, userRecord.getPhoneNumber());\n+    assertEquals(\"https://example.com/photo.png\", userRecord.getPhotoUrl());\n+    assertTrue(userRecord.isEmailVerified());\n+    assertFalse(userRecord.isDisabled());\n+    assertEquals(2, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Get user by email\n+    userRecord = tenantAwareAuth.getUserByEmailAsync(userRecord.getEmail()).get();\n+    assertEquals(uid, userRecord.getUid());\n+\n+    // Disable user and remove properties\n+    request = userRecord.updateRequest()\n+        .setPhotoUrl(null)\n+        .setDisplayName(null)\n+        .setPhoneNumber(null)\n+        .setDisabled(true);\n+    userRecord = tenantAwareAuth.updateUserAsync(request).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertNull(userRecord.getDisplayName());\n+    assertEquals(randomUser.email, userRecord.getEmail());\n+    assertNull(userRecord.getPhoneNumber());\n+    assertNull(userRecord.getPhotoUrl());\n+    assertTrue(userRecord.isEmailVerified());\n+    assertTrue(userRecord.isDisabled());\n+    assertEquals(1, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Delete user\n+    tenantAwareAuth.deleteUserAsync(userRecord.getUid()).get();\n+    assertUserDoesNotExist(tenantAwareAuth, userRecord.getUid());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM5NjYyNQ==", "bodyText": "Done.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r406396625", "createdAt": "2020-04-09T18:29:21Z", "author": {"login": "micahstairs"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -320,6 +319,203 @@ public void onSuccess(ListUsersPage result) {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareUserLifecycle() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    final String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+\n+    // Create user\n+    UserRecord userRecord = tenantAwareAuth.createUserAsync(new UserRecord.CreateRequest()).get();\n+    String uid = userRecord.getUid();\n+\n+    // Get user\n+    userRecord = tenantAwareAuth.getUserAsync(userRecord.getUid()).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertNull(userRecord.getDisplayName());\n+    assertNull(userRecord.getEmail());\n+    assertNull(userRecord.getPhoneNumber());\n+    assertNull(userRecord.getPhotoUrl());\n+    assertFalse(userRecord.isEmailVerified());\n+    assertFalse(userRecord.isDisabled());\n+    assertTrue(userRecord.getUserMetadata().getCreationTimestamp() > 0);\n+    assertEquals(0, userRecord.getUserMetadata().getLastSignInTimestamp());\n+    assertEquals(0, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Update user\n+    RandomUser randomUser = RandomUser.create();\n+    String phone = randomPhoneNumber();\n+    UserRecord.UpdateRequest request = userRecord.updateRequest()\n+        .setDisplayName(\"Updated Name\")\n+        .setEmail(randomUser.email)\n+        .setPhoneNumber(phone)\n+        .setPhotoUrl(\"https://example.com/photo.png\")\n+        .setEmailVerified(true)\n+        .setPassword(\"secret\");\n+    userRecord = tenantAwareAuth.updateUserAsync(request).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertEquals(\"Updated Name\", userRecord.getDisplayName());\n+    assertEquals(randomUser.email, userRecord.getEmail());\n+    assertEquals(phone, userRecord.getPhoneNumber());\n+    assertEquals(\"https://example.com/photo.png\", userRecord.getPhotoUrl());\n+    assertTrue(userRecord.isEmailVerified());\n+    assertFalse(userRecord.isDisabled());\n+    assertEquals(2, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Get user by email\n+    userRecord = tenantAwareAuth.getUserByEmailAsync(userRecord.getEmail()).get();\n+    assertEquals(uid, userRecord.getUid());\n+\n+    // Disable user and remove properties\n+    request = userRecord.updateRequest()\n+        .setPhotoUrl(null)\n+        .setDisplayName(null)\n+        .setPhoneNumber(null)\n+        .setDisabled(true);\n+    userRecord = tenantAwareAuth.updateUserAsync(request).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertNull(userRecord.getDisplayName());\n+    assertEquals(randomUser.email, userRecord.getEmail());\n+    assertNull(userRecord.getPhoneNumber());\n+    assertNull(userRecord.getPhotoUrl());\n+    assertTrue(userRecord.isEmailVerified());\n+    assertTrue(userRecord.isDisabled());\n+    assertEquals(1, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Delete user\n+    tenantAwareAuth.deleteUserAsync(userRecord.getUid()).get();\n+    assertUserDoesNotExist(tenantAwareAuth, userRecord.getUid());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2NjYxNg=="}, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 143}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzU4MTUzOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOTo0MzozOVrOGCTUEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxODoyOTowNVrOGDkeLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2Njc3MQ==", "bodyText": "And delete the tenant", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r405066771", "createdAt": "2020-04-07T19:43:39Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -320,6 +319,203 @@ public void onSuccess(ListUsersPage result) {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareUserLifecycle() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    final String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+\n+    // Create user\n+    UserRecord userRecord = tenantAwareAuth.createUserAsync(new UserRecord.CreateRequest()).get();\n+    String uid = userRecord.getUid();\n+\n+    // Get user\n+    userRecord = tenantAwareAuth.getUserAsync(userRecord.getUid()).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertNull(userRecord.getDisplayName());\n+    assertNull(userRecord.getEmail());\n+    assertNull(userRecord.getPhoneNumber());\n+    assertNull(userRecord.getPhotoUrl());\n+    assertFalse(userRecord.isEmailVerified());\n+    assertFalse(userRecord.isDisabled());\n+    assertTrue(userRecord.getUserMetadata().getCreationTimestamp() > 0);\n+    assertEquals(0, userRecord.getUserMetadata().getLastSignInTimestamp());\n+    assertEquals(0, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Update user\n+    RandomUser randomUser = RandomUser.create();\n+    String phone = randomPhoneNumber();\n+    UserRecord.UpdateRequest request = userRecord.updateRequest()\n+        .setDisplayName(\"Updated Name\")\n+        .setEmail(randomUser.email)\n+        .setPhoneNumber(phone)\n+        .setPhotoUrl(\"https://example.com/photo.png\")\n+        .setEmailVerified(true)\n+        .setPassword(\"secret\");\n+    userRecord = tenantAwareAuth.updateUserAsync(request).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertEquals(\"Updated Name\", userRecord.getDisplayName());\n+    assertEquals(randomUser.email, userRecord.getEmail());\n+    assertEquals(phone, userRecord.getPhoneNumber());\n+    assertEquals(\"https://example.com/photo.png\", userRecord.getPhotoUrl());\n+    assertTrue(userRecord.isEmailVerified());\n+    assertFalse(userRecord.isDisabled());\n+    assertEquals(2, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Get user by email\n+    userRecord = tenantAwareAuth.getUserByEmailAsync(userRecord.getEmail()).get();\n+    assertEquals(uid, userRecord.getUid());\n+\n+    // Disable user and remove properties\n+    request = userRecord.updateRequest()\n+        .setPhotoUrl(null)\n+        .setDisplayName(null)\n+        .setPhoneNumber(null)\n+        .setDisabled(true);\n+    userRecord = tenantAwareAuth.updateUserAsync(request).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertNull(userRecord.getDisplayName());\n+    assertEquals(randomUser.email, userRecord.getEmail());\n+    assertNull(userRecord.getPhoneNumber());\n+    assertNull(userRecord.getPhotoUrl());\n+    assertTrue(userRecord.isEmailVerified());\n+    assertTrue(userRecord.isDisabled());\n+    assertEquals(1, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Delete user\n+    tenantAwareAuth.deleteUserAsync(userRecord.getUid()).get();\n+    assertUserDoesNotExist(tenantAwareAuth, userRecord.getUid());\n+  }\n+\n+  @Test\n+  public void testTenantAwareListUsers() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    final String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    TenantAwareFirebaseAuth tenantAwareAuth = tenantManager.getAuthForTenant(tenantId);\n+    final List<String> uids = new ArrayList<>();\n+\n+    try {\n+      for (int i = 0; i < 3; i++) {\n+        UserRecord.CreateRequest createRequest =\n+            new UserRecord.CreateRequest().setPassword(\"password\");\n+        uids.add(tenantAwareAuth.createUserAsync(createRequest).get().getUid());\n+      }\n+\n+      // Test list by batches\n+      final AtomicInteger collected = new AtomicInteger(0);\n+      ListUsersPage page = tenantAwareAuth.listUsersAsync(null).get();\n+      while (page != null) {\n+        for (ExportedUserRecord user : page.getValues()) {\n+          if (uids.contains(user.getUid())) {\n+            collected.incrementAndGet();\n+            assertNotNull(\"Missing passwordHash field. A common cause would be \"\n+                + \"forgetting to add the \\\"Firebase Authentication Admin\\\" permission. See \"\n+                + \"instructions in CONTRIBUTING.md\", user.getPasswordHash());\n+            assertNotNull(user.getPasswordSalt());\n+            assertEquals(tenantId, user.getTenantId());\n+          }\n+        }\n+        page = page.getNextPage();\n+      }\n+      assertEquals(uids.size(), collected.get());\n+\n+      // Test iterate all\n+      collected.set(0);\n+      page = tenantAwareAuth.listUsersAsync(null).get();\n+      for (ExportedUserRecord user : page.iterateAll()) {\n+        if (uids.contains(user.getUid())) {\n+          collected.incrementAndGet();\n+          assertNotNull(user.getPasswordHash());\n+          assertNotNull(user.getPasswordSalt());\n+          assertEquals(tenantId, user.getTenantId());\n+        }\n+      }\n+      assertEquals(uids.size(), collected.get());\n+\n+      // Test iterate async\n+      collected.set(0);\n+      final Semaphore semaphore = new Semaphore(0);\n+      final AtomicReference<Throwable> error = new AtomicReference<>();\n+      ApiFuture<ListUsersPage> pageFuture = tenantAwareAuth.listUsersAsync(null);\n+      ApiFutures.addCallback(pageFuture, new ApiFutureCallback<ListUsersPage>() {\n+        @Override\n+        public void onFailure(Throwable t) {\n+          error.set(t);\n+          semaphore.release();\n+        }\n+\n+        @Override\n+        public void onSuccess(ListUsersPage result) {\n+          for (ExportedUserRecord user : result.iterateAll()) {\n+            if (uids.contains(user.getUid())) {\n+              collected.incrementAndGet();\n+              assertNotNull(user.getPasswordHash());\n+              assertNotNull(user.getPasswordSalt());\n+              assertEquals(tenantId, user.getTenantId());\n+            }\n+          }\n+          semaphore.release();\n+        }\n+      }, MoreExecutors.directExecutor());\n+      semaphore.acquire();\n+      assertEquals(uids.size(), collected.get());\n+      assertNull(error.get());\n+    } finally {\n+      for (String uid : uids) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 224}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM5NjQ2Mw==", "bodyText": "Done.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r406396463", "createdAt": "2020-04-09T18:29:05Z", "author": {"login": "micahstairs"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -320,6 +319,203 @@ public void onSuccess(ListUsersPage result) {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareUserLifecycle() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    final String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+\n+    // Create user\n+    UserRecord userRecord = tenantAwareAuth.createUserAsync(new UserRecord.CreateRequest()).get();\n+    String uid = userRecord.getUid();\n+\n+    // Get user\n+    userRecord = tenantAwareAuth.getUserAsync(userRecord.getUid()).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertNull(userRecord.getDisplayName());\n+    assertNull(userRecord.getEmail());\n+    assertNull(userRecord.getPhoneNumber());\n+    assertNull(userRecord.getPhotoUrl());\n+    assertFalse(userRecord.isEmailVerified());\n+    assertFalse(userRecord.isDisabled());\n+    assertTrue(userRecord.getUserMetadata().getCreationTimestamp() > 0);\n+    assertEquals(0, userRecord.getUserMetadata().getLastSignInTimestamp());\n+    assertEquals(0, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Update user\n+    RandomUser randomUser = RandomUser.create();\n+    String phone = randomPhoneNumber();\n+    UserRecord.UpdateRequest request = userRecord.updateRequest()\n+        .setDisplayName(\"Updated Name\")\n+        .setEmail(randomUser.email)\n+        .setPhoneNumber(phone)\n+        .setPhotoUrl(\"https://example.com/photo.png\")\n+        .setEmailVerified(true)\n+        .setPassword(\"secret\");\n+    userRecord = tenantAwareAuth.updateUserAsync(request).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertEquals(\"Updated Name\", userRecord.getDisplayName());\n+    assertEquals(randomUser.email, userRecord.getEmail());\n+    assertEquals(phone, userRecord.getPhoneNumber());\n+    assertEquals(\"https://example.com/photo.png\", userRecord.getPhotoUrl());\n+    assertTrue(userRecord.isEmailVerified());\n+    assertFalse(userRecord.isDisabled());\n+    assertEquals(2, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Get user by email\n+    userRecord = tenantAwareAuth.getUserByEmailAsync(userRecord.getEmail()).get();\n+    assertEquals(uid, userRecord.getUid());\n+\n+    // Disable user and remove properties\n+    request = userRecord.updateRequest()\n+        .setPhotoUrl(null)\n+        .setDisplayName(null)\n+        .setPhoneNumber(null)\n+        .setDisabled(true);\n+    userRecord = tenantAwareAuth.updateUserAsync(request).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertNull(userRecord.getDisplayName());\n+    assertEquals(randomUser.email, userRecord.getEmail());\n+    assertNull(userRecord.getPhoneNumber());\n+    assertNull(userRecord.getPhotoUrl());\n+    assertTrue(userRecord.isEmailVerified());\n+    assertTrue(userRecord.isDisabled());\n+    assertEquals(1, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Delete user\n+    tenantAwareAuth.deleteUserAsync(userRecord.getUid()).get();\n+    assertUserDoesNotExist(tenantAwareAuth, userRecord.getUid());\n+  }\n+\n+  @Test\n+  public void testTenantAwareListUsers() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    final String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    TenantAwareFirebaseAuth tenantAwareAuth = tenantManager.getAuthForTenant(tenantId);\n+    final List<String> uids = new ArrayList<>();\n+\n+    try {\n+      for (int i = 0; i < 3; i++) {\n+        UserRecord.CreateRequest createRequest =\n+            new UserRecord.CreateRequest().setPassword(\"password\");\n+        uids.add(tenantAwareAuth.createUserAsync(createRequest).get().getUid());\n+      }\n+\n+      // Test list by batches\n+      final AtomicInteger collected = new AtomicInteger(0);\n+      ListUsersPage page = tenantAwareAuth.listUsersAsync(null).get();\n+      while (page != null) {\n+        for (ExportedUserRecord user : page.getValues()) {\n+          if (uids.contains(user.getUid())) {\n+            collected.incrementAndGet();\n+            assertNotNull(\"Missing passwordHash field. A common cause would be \"\n+                + \"forgetting to add the \\\"Firebase Authentication Admin\\\" permission. See \"\n+                + \"instructions in CONTRIBUTING.md\", user.getPasswordHash());\n+            assertNotNull(user.getPasswordSalt());\n+            assertEquals(tenantId, user.getTenantId());\n+          }\n+        }\n+        page = page.getNextPage();\n+      }\n+      assertEquals(uids.size(), collected.get());\n+\n+      // Test iterate all\n+      collected.set(0);\n+      page = tenantAwareAuth.listUsersAsync(null).get();\n+      for (ExportedUserRecord user : page.iterateAll()) {\n+        if (uids.contains(user.getUid())) {\n+          collected.incrementAndGet();\n+          assertNotNull(user.getPasswordHash());\n+          assertNotNull(user.getPasswordSalt());\n+          assertEquals(tenantId, user.getTenantId());\n+        }\n+      }\n+      assertEquals(uids.size(), collected.get());\n+\n+      // Test iterate async\n+      collected.set(0);\n+      final Semaphore semaphore = new Semaphore(0);\n+      final AtomicReference<Throwable> error = new AtomicReference<>();\n+      ApiFuture<ListUsersPage> pageFuture = tenantAwareAuth.listUsersAsync(null);\n+      ApiFutures.addCallback(pageFuture, new ApiFutureCallback<ListUsersPage>() {\n+        @Override\n+        public void onFailure(Throwable t) {\n+          error.set(t);\n+          semaphore.release();\n+        }\n+\n+        @Override\n+        public void onSuccess(ListUsersPage result) {\n+          for (ExportedUserRecord user : result.iterateAll()) {\n+            if (uids.contains(user.getUid())) {\n+              collected.incrementAndGet();\n+              assertNotNull(user.getPasswordHash());\n+              assertNotNull(user.getPasswordSalt());\n+              assertEquals(tenantId, user.getTenantId());\n+            }\n+          }\n+          semaphore.release();\n+        }\n+      }, MoreExecutors.directExecutor());\n+      semaphore.acquire();\n+      assertEquals(uids.size(), collected.get());\n+      assertNull(error.get());\n+    } finally {\n+      for (String uid : uids) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2Njc3MQ=="}, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 224}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzU5MTc2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/google/firebase/auth/TenantAwareFirebaseAuth.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOTo0Njo1M1rOGCTayQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMDowNTozMVrOGCUEZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2ODQ4OQ==", "bodyText": "I believe this class also needs to override verifyIdToken(). But feel free to do that in a separate PR.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r405068489", "createdAt": "2020-04-07T19:46:53Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/TenantAwareFirebaseAuth.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.firebase.auth;\n+\n+import com.google.api.client.util.Clock;\n+import com.google.common.base.Supplier;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.auth.internal.FirebaseTokenFactory;\n+\n+/**\n+ * The tenant-aware Firebase client.\n+ *\n+ * <p>This can be used to perform a variety of authentication-related operations, scoped to a\n+ * particular tenant.\n+ */\n+public class TenantAwareFirebaseAuth extends AbstractFirebaseAuth {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA3OTE0MQ==", "bodyText": "The TODO I left there was intended to cover this work.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r405079141", "createdAt": "2020-04-07T20:05:31Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/TenantAwareFirebaseAuth.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.firebase.auth;\n+\n+import com.google.api.client.util.Clock;\n+import com.google.common.base.Supplier;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.auth.internal.FirebaseTokenFactory;\n+\n+/**\n+ * The tenant-aware Firebase client.\n+ *\n+ * <p>This can be used to perform a variety of authentication-related operations, scoped to a\n+ * particular tenant.\n+ */\n+public class TenantAwareFirebaseAuth extends AbstractFirebaseAuth {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2ODQ4OQ=="}, "originalCommit": {"oid": "6feaa2b4b1f5198ec3f2d682325d4a558441975c"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjM4MDU3OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDoyMjowMVrOGDoDcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMVQwMjoyNDoxNlrOGEJpmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NTE1Mw==", "bodyText": "Strings.isNullOrEmpty for good measure", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r406455153", "createdAt": "2020-04-09T20:22:01Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -115,21 +115,39 @@\n    * Creates a new FirebaseUserManager instance.\n    *\n    * @param app A non-null {@link FirebaseApp}.\n+   * @param tenantId The associated tenant ID if the user operations should be tenant-aware,\n+   *     otherwise {@code null}\n    */\n-  FirebaseUserManager(@NonNull FirebaseApp app) {\n+  FirebaseUserManager(@NonNull FirebaseApp app, @Nullable String tenantId) {\n     checkNotNull(app, \"FirebaseApp must not be null\");\n     String projectId = ImplFirebaseTrampolines.getProjectId(app);\n     checkArgument(!Strings.isNullOrEmpty(projectId),\n         \"Project ID is required to access the auth service. Use a service account credential or \"\n             + \"set the project ID explicitly via FirebaseOptions. Alternatively you can also \"\n             + \"set the project ID via the GOOGLE_CLOUD_PROJECT environment variable.\");\n-    this.userMgtBaseUrl = String.format(ID_TOOLKIT_URL, \"v1\", projectId);\n+    if (tenantId == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "442c7191bb2f37ccd8ecee986cb1cbac70e2ec2a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyOTc5MA==", "bodyText": "Hmm I don't think we want to check Strings.isNullOrEmpty in this case, since a null value for the tenant ID is acceptable.\nHowever, if the value is non-null, I've added a check to ensure that it is not an empty string.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r406729790", "createdAt": "2020-04-10T12:09:29Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -115,21 +115,39 @@\n    * Creates a new FirebaseUserManager instance.\n    *\n    * @param app A non-null {@link FirebaseApp}.\n+   * @param tenantId The associated tenant ID if the user operations should be tenant-aware,\n+   *     otherwise {@code null}\n    */\n-  FirebaseUserManager(@NonNull FirebaseApp app) {\n+  FirebaseUserManager(@NonNull FirebaseApp app, @Nullable String tenantId) {\n     checkNotNull(app, \"FirebaseApp must not be null\");\n     String projectId = ImplFirebaseTrampolines.getProjectId(app);\n     checkArgument(!Strings.isNullOrEmpty(projectId),\n         \"Project ID is required to access the auth service. Use a service account credential or \"\n             + \"set the project ID explicitly via FirebaseOptions. Alternatively you can also \"\n             + \"set the project ID via the GOOGLE_CLOUD_PROJECT environment variable.\");\n-    this.userMgtBaseUrl = String.format(ID_TOOLKIT_URL, \"v1\", projectId);\n+    if (tenantId == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NTE1Mw=="}, "originalCommit": {"oid": "442c7191bb2f37ccd8ecee986cb1cbac70e2ec2a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg4ODkzNQ==", "bodyText": "What I meant was if (String.isNullOrEmpty(tenantId)). But this is ok too.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r406888935", "createdAt": "2020-04-10T18:38:55Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -115,21 +115,39 @@\n    * Creates a new FirebaseUserManager instance.\n    *\n    * @param app A non-null {@link FirebaseApp}.\n+   * @param tenantId The associated tenant ID if the user operations should be tenant-aware,\n+   *     otherwise {@code null}\n    */\n-  FirebaseUserManager(@NonNull FirebaseApp app) {\n+  FirebaseUserManager(@NonNull FirebaseApp app, @Nullable String tenantId) {\n     checkNotNull(app, \"FirebaseApp must not be null\");\n     String projectId = ImplFirebaseTrampolines.getProjectId(app);\n     checkArgument(!Strings.isNullOrEmpty(projectId),\n         \"Project ID is required to access the auth service. Use a service account credential or \"\n             + \"set the project ID explicitly via FirebaseOptions. Alternatively you can also \"\n             + \"set the project ID via the GOOGLE_CLOUD_PROJECT environment variable.\");\n-    this.userMgtBaseUrl = String.format(ID_TOOLKIT_URL, \"v1\", projectId);\n+    if (tenantId == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NTE1Mw=="}, "originalCommit": {"oid": "442c7191bb2f37ccd8ecee986cb1cbac70e2ec2a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzAwNTU5NA==", "bodyText": "Ah okay, that makes more sense!", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r407005594", "createdAt": "2020-04-11T02:24:16Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -115,21 +115,39 @@\n    * Creates a new FirebaseUserManager instance.\n    *\n    * @param app A non-null {@link FirebaseApp}.\n+   * @param tenantId The associated tenant ID if the user operations should be tenant-aware,\n+   *     otherwise {@code null}\n    */\n-  FirebaseUserManager(@NonNull FirebaseApp app) {\n+  FirebaseUserManager(@NonNull FirebaseApp app, @Nullable String tenantId) {\n     checkNotNull(app, \"FirebaseApp must not be null\");\n     String projectId = ImplFirebaseTrampolines.getProjectId(app);\n     checkArgument(!Strings.isNullOrEmpty(projectId),\n         \"Project ID is required to access the auth service. Use a service account credential or \"\n             + \"set the project ID explicitly via FirebaseOptions. Alternatively you can also \"\n             + \"set the project ID via the GOOGLE_CLOUD_PROJECT environment variable.\");\n-    this.userMgtBaseUrl = String.format(ID_TOOLKIT_URL, \"v1\", projectId);\n+    if (tenantId == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NTE1Mw=="}, "originalCommit": {"oid": "442c7191bb2f37ccd8ecee986cb1cbac70e2ec2a"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMjQxNjI1OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMDozMzoyNVrOGDoZmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMjowODowOVrOGD4yjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2MDgyNg==", "bodyText": "Looks like this is still missing a delete call.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r406460826", "createdAt": "2020-04-09T20:33:25Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -320,6 +319,208 @@ public void onSuccess(ListUsersPage result) {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareUserLifecycle() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    final String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+\n+    // Create user\n+    UserRecord userRecord = tenantAwareAuth.createUserAsync(new UserRecord.CreateRequest()).get();\n+    String uid = userRecord.getUid();\n+\n+    // Get user\n+    userRecord = tenantAwareAuth.getUserAsync(userRecord.getUid()).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertNull(userRecord.getDisplayName());\n+    assertNull(userRecord.getEmail());\n+    assertNull(userRecord.getPhoneNumber());\n+    assertNull(userRecord.getPhotoUrl());\n+    assertFalse(userRecord.isEmailVerified());\n+    assertFalse(userRecord.isDisabled());\n+    assertTrue(userRecord.getUserMetadata().getCreationTimestamp() > 0);\n+    assertEquals(0, userRecord.getUserMetadata().getLastSignInTimestamp());\n+    assertEquals(0, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Update user\n+    RandomUser randomUser = RandomUser.create();\n+    String phone = randomPhoneNumber();\n+    UserRecord.UpdateRequest request = userRecord.updateRequest()\n+        .setDisplayName(\"Updated Name\")\n+        .setEmail(randomUser.email)\n+        .setPhoneNumber(phone)\n+        .setPhotoUrl(\"https://example.com/photo.png\")\n+        .setEmailVerified(true)\n+        .setPassword(\"secret\");\n+    userRecord = tenantAwareAuth.updateUserAsync(request).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertEquals(\"Updated Name\", userRecord.getDisplayName());\n+    assertEquals(randomUser.email, userRecord.getEmail());\n+    assertEquals(phone, userRecord.getPhoneNumber());\n+    assertEquals(\"https://example.com/photo.png\", userRecord.getPhotoUrl());\n+    assertTrue(userRecord.isEmailVerified());\n+    assertFalse(userRecord.isDisabled());\n+    assertEquals(2, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Get user by email\n+    userRecord = tenantAwareAuth.getUserByEmailAsync(userRecord.getEmail()).get();\n+    assertEquals(uid, userRecord.getUid());\n+\n+    // Disable user and remove properties\n+    request = userRecord.updateRequest()\n+        .setPhotoUrl(null)\n+        .setDisplayName(null)\n+        .setPhoneNumber(null)\n+        .setDisabled(true);\n+    userRecord = tenantAwareAuth.updateUserAsync(request).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertNull(userRecord.getDisplayName());\n+    assertEquals(randomUser.email, userRecord.getEmail());\n+    assertNull(userRecord.getPhoneNumber());\n+    assertNull(userRecord.getPhotoUrl());\n+    assertTrue(userRecord.isEmailVerified());\n+    assertTrue(userRecord.isDisabled());\n+    assertEquals(1, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Delete user\n+    tenantAwareAuth.deleteUserAsync(userRecord.getUid()).get();\n+    assertUserDoesNotExist(tenantAwareAuth, userRecord.getUid());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "442c7191bb2f37ccd8ecee986cb1cbac70e2ec2a"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjcyOTM1OA==", "bodyText": "Sorry, I think I might have added it to another test the first time around.\nDone.", "url": "https://github.com/firebase/firebase-admin-java/pull/387#discussion_r406729358", "createdAt": "2020-04-10T12:08:09Z", "author": {"login": "micahstairs"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -320,6 +319,208 @@ public void onSuccess(ListUsersPage result) {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareUserLifecycle() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    final String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+\n+    // Create user\n+    UserRecord userRecord = tenantAwareAuth.createUserAsync(new UserRecord.CreateRequest()).get();\n+    String uid = userRecord.getUid();\n+\n+    // Get user\n+    userRecord = tenantAwareAuth.getUserAsync(userRecord.getUid()).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertNull(userRecord.getDisplayName());\n+    assertNull(userRecord.getEmail());\n+    assertNull(userRecord.getPhoneNumber());\n+    assertNull(userRecord.getPhotoUrl());\n+    assertFalse(userRecord.isEmailVerified());\n+    assertFalse(userRecord.isDisabled());\n+    assertTrue(userRecord.getUserMetadata().getCreationTimestamp() > 0);\n+    assertEquals(0, userRecord.getUserMetadata().getLastSignInTimestamp());\n+    assertEquals(0, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Update user\n+    RandomUser randomUser = RandomUser.create();\n+    String phone = randomPhoneNumber();\n+    UserRecord.UpdateRequest request = userRecord.updateRequest()\n+        .setDisplayName(\"Updated Name\")\n+        .setEmail(randomUser.email)\n+        .setPhoneNumber(phone)\n+        .setPhotoUrl(\"https://example.com/photo.png\")\n+        .setEmailVerified(true)\n+        .setPassword(\"secret\");\n+    userRecord = tenantAwareAuth.updateUserAsync(request).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertEquals(\"Updated Name\", userRecord.getDisplayName());\n+    assertEquals(randomUser.email, userRecord.getEmail());\n+    assertEquals(phone, userRecord.getPhoneNumber());\n+    assertEquals(\"https://example.com/photo.png\", userRecord.getPhotoUrl());\n+    assertTrue(userRecord.isEmailVerified());\n+    assertFalse(userRecord.isDisabled());\n+    assertEquals(2, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Get user by email\n+    userRecord = tenantAwareAuth.getUserByEmailAsync(userRecord.getEmail()).get();\n+    assertEquals(uid, userRecord.getUid());\n+\n+    // Disable user and remove properties\n+    request = userRecord.updateRequest()\n+        .setPhotoUrl(null)\n+        .setDisplayName(null)\n+        .setPhoneNumber(null)\n+        .setDisabled(true);\n+    userRecord = tenantAwareAuth.updateUserAsync(request).get();\n+    assertEquals(uid, userRecord.getUid());\n+    assertEquals(tenantId, userRecord.getTenantId());\n+    assertNull(userRecord.getDisplayName());\n+    assertEquals(randomUser.email, userRecord.getEmail());\n+    assertNull(userRecord.getPhoneNumber());\n+    assertNull(userRecord.getPhotoUrl());\n+    assertTrue(userRecord.isEmailVerified());\n+    assertTrue(userRecord.isDisabled());\n+    assertEquals(1, userRecord.getProviderData().length);\n+    assertTrue(userRecord.getCustomClaims().isEmpty());\n+\n+    // Delete user\n+    tenantAwareAuth.deleteUserAsync(userRecord.getUid()).get();\n+    assertUserDoesNotExist(tenantAwareAuth, userRecord.getUid());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ2MDgyNg=="}, "originalCommit": {"oid": "442c7191bb2f37ccd8ecee986cb1cbac70e2ec2a"}, "originalPosition": 143}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1544, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}