{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NzQzODY5", "number": 391, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODowMjozMlrOD0XPqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDozMjo0MVrOD09Ubg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjMzMzg2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/google/firebase/auth/FirebaseTokenUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODowMjozMlrOGJRYVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMzo1ODoxNVrOGJ38Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NTEyNg==", "bodyText": "Session cookies do not support tenants at the moment. We can remove this.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412375126", "createdAt": "2020-04-21T18:02:32Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/FirebaseTokenUtils.java", "diffHunk": "@@ -82,10 +94,16 @@ static FirebaseTokenVerifierImpl createIdTokenVerifier(FirebaseApp app, Clock cl\n         .setJsonFactory(app.getOptions().getJsonFactory())\n         .setPublicKeysManager(publicKeysManager)\n         .setIdTokenVerifier(idTokenVerifier)\n+        .setTenantId(tenantId)\n         .build();\n   }\n \n   static FirebaseTokenVerifierImpl createSessionCookieVerifier(FirebaseApp app, Clock clock) {\n+    return createSessionCookieVerifier(app, clock, null);\n+  }\n+\n+  static FirebaseTokenVerifierImpl createSessionCookieVerifier(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzAwNjkxOQ==", "bodyText": "Done.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413006919", "createdAt": "2020-04-22T13:58:15Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseTokenUtils.java", "diffHunk": "@@ -82,10 +94,16 @@ static FirebaseTokenVerifierImpl createIdTokenVerifier(FirebaseApp app, Clock cl\n         .setJsonFactory(app.getOptions().getJsonFactory())\n         .setPublicKeysManager(publicKeysManager)\n         .setIdTokenVerifier(idTokenVerifier)\n+        .setTenantId(tenantId)\n         .build();\n   }\n \n   static FirebaseTokenVerifierImpl createSessionCookieVerifier(FirebaseApp app, Clock clock) {\n+    return createSessionCookieVerifier(app, clock, null);\n+  }\n+\n+  static FirebaseTokenVerifierImpl createSessionCookieVerifier(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NTEyNg=="}, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjM0MjM2OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/google/firebase/auth/FirebaseTokenVerifierImpl.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODowNDoyNlrOGJRdWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDoyMDoyNFrOGKJ78w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NjQxMQ==", "bodyText": "Following might be a bit more readable:\nif (!Strings.isNullOrEmpty(this.tenantId)) {\n  if (!this.tenantId.equals(tokenTenantId) {\n    // ...\n  }\n}", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412376411", "createdAt": "2020-04-21T18:04:26Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/FirebaseTokenVerifierImpl.java", "diffHunk": "@@ -278,6 +283,18 @@ private boolean containsLegacyUidField(IdToken.Payload payload) {\n     return false;\n   }\n \n+  private void checkTenantId(final FirebaseToken firebaseToken) throws FirebaseAuthException {\n+    String tokenTenantId = firebaseToken.getTenantId();\n+    if (!Strings.nullToEmpty(tokenTenantId).equals(Strings.nullToEmpty(tenantId))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjkzODkwMg==", "bodyText": "That's more readable, yes, but it also behaves differently.\nDon't we want to throw an exception if this.tenantId is null and tokenTenantId is non-empty?", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412938902", "createdAt": "2020-04-22T12:30:35Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseTokenVerifierImpl.java", "diffHunk": "@@ -278,6 +283,18 @@ private boolean containsLegacyUidField(IdToken.Payload payload) {\n     return false;\n   }\n \n+  private void checkTenantId(final FirebaseToken firebaseToken) throws FirebaseAuthException {\n+    String tokenTenantId = firebaseToken.getTenantId();\n+    if (!Strings.nullToEmpty(tokenTenantId).equals(Strings.nullToEmpty(tenantId))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NjQxMQ=="}, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIxNzMzNA==", "bodyText": "Ah I see your point. What if we do this in the constructor then:\nthis.tenantId = Strings.nullToEmpty(tenantId);\n\nThen during verification you can do !this.tenantId.equals(tokenTenantId).", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413217334", "createdAt": "2020-04-22T18:25:42Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/FirebaseTokenVerifierImpl.java", "diffHunk": "@@ -278,6 +283,18 @@ private boolean containsLegacyUidField(IdToken.Payload payload) {\n     return false;\n   }\n \n+  private void checkTenantId(final FirebaseToken firebaseToken) throws FirebaseAuthException {\n+    String tokenTenantId = firebaseToken.getTenantId();\n+    if (!Strings.nullToEmpty(tokenTenantId).equals(Strings.nullToEmpty(tenantId))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NjQxMQ=="}, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI5NjA4NA==", "bodyText": "Moving Strings.nullToEmpty to the constructor is a good idea.\nBut I think we'd need to do !this.tenantId.equals(Strings.nullToEmpty(tokenTenantId))) or else we'd say there was a mismatch if both were initially null.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413296084", "createdAt": "2020-04-22T20:13:06Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseTokenVerifierImpl.java", "diffHunk": "@@ -278,6 +283,18 @@ private boolean containsLegacyUidField(IdToken.Payload payload) {\n     return false;\n   }\n \n+  private void checkTenantId(final FirebaseToken firebaseToken) throws FirebaseAuthException {\n+    String tokenTenantId = firebaseToken.getTenantId();\n+    if (!Strings.nullToEmpty(tokenTenantId).equals(Strings.nullToEmpty(tenantId))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NjQxMQ=="}, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwMTc0Nw==", "bodyText": "I pulled the other Strings.nullToEmpty to the previous line where tokenTenantId is defined. I think this is better now.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413301747", "createdAt": "2020-04-22T20:20:24Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseTokenVerifierImpl.java", "diffHunk": "@@ -278,6 +283,18 @@ private boolean containsLegacyUidField(IdToken.Payload payload) {\n     return false;\n   }\n \n+  private void checkTenantId(final FirebaseToken firebaseToken) throws FirebaseAuthException {\n+    String tokenTenantId = firebaseToken.getTenantId();\n+    if (!Strings.nullToEmpty(tokenTenantId).equals(Strings.nullToEmpty(tenantId))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3NjQxMQ=="}, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjM1NTk1OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODowNzoyN1rOGJRlwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDoyMDozOVrOGKJ8fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3ODU2Mg==", "bodyText": "Might want to push this into a finally block", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412378562", "createdAt": "2020-04-21T18:07:27Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -705,6 +706,58 @@ public void testCustomTokenWithIAM() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareCustomToken() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    // Create and decode a token with a tenant-aware client.\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+    String customToken = tenantAwareAuth.createCustomTokenAsync(\"user1\").get();\n+    String idToken = signInWithCustomToken(customToken, tenantId);\n+    FirebaseToken decoded = tenantAwareAuth.verifyIdTokenAsync(idToken).get();\n+    assertEquals(\"user1\", decoded.getUid());\n+    assertEquals(tenantId, decoded.getTenantId());\n+\n+    // Delete tenant.\n+    tenantManager.deleteTenantAsync(tenantId).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjkzMTYxNQ==", "bodyText": "There's no existing try block to add the finally block to. Are you suggesting that I wrap the entire \"Create and decode a token with a tenant-aware client\" section with a try (and no catch)?", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412931615", "createdAt": "2020-04-22T12:19:46Z", "author": {"login": "micahstairs"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -705,6 +706,58 @@ public void testCustomTokenWithIAM() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareCustomToken() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    // Create and decode a token with a tenant-aware client.\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+    String customToken = tenantAwareAuth.createCustomTokenAsync(\"user1\").get();\n+    String idToken = signInWithCustomToken(customToken, tenantId);\n+    FirebaseToken decoded = tenantAwareAuth.verifyIdTokenAsync(idToken).get();\n+    assertEquals(\"user1\", decoded.getUid());\n+    assertEquals(tenantId, decoded.getTenantId());\n+\n+    // Delete tenant.\n+    tenantManager.deleteTenantAsync(tenantId).get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3ODU2Mg=="}, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzIxNTI0NQ==", "bodyText": "Yes. You will see this pattern being used in a number of existing test cases. See testCustomClaims() for example.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413215245", "createdAt": "2020-04-22T18:22:31Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -705,6 +706,58 @@ public void testCustomTokenWithIAM() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareCustomToken() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    // Create and decode a token with a tenant-aware client.\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+    String customToken = tenantAwareAuth.createCustomTokenAsync(\"user1\").get();\n+    String idToken = signInWithCustomToken(customToken, tenantId);\n+    FirebaseToken decoded = tenantAwareAuth.verifyIdTokenAsync(idToken).get();\n+    assertEquals(\"user1\", decoded.getUid());\n+    assertEquals(tenantId, decoded.getTenantId());\n+\n+    // Delete tenant.\n+    tenantManager.deleteTenantAsync(tenantId).get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3ODU2Mg=="}, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwMTg4NQ==", "bodyText": "Okay sounds good! Done.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413301885", "createdAt": "2020-04-22T20:20:39Z", "author": {"login": "micahstairs"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -705,6 +706,58 @@ public void testCustomTokenWithIAM() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareCustomToken() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    // Create and decode a token with a tenant-aware client.\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+    String customToken = tenantAwareAuth.createCustomTokenAsync(\"user1\").get();\n+    String idToken = signInWithCustomToken(customToken, tenantId);\n+    FirebaseToken decoded = tenantAwareAuth.verifyIdTokenAsync(idToken).get();\n+    assertEquals(\"user1\", decoded.getUid());\n+    assertEquals(tenantId, decoded.getTenantId());\n+\n+    // Delete tenant.\n+    tenantManager.deleteTenantAsync(tenantId).get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3ODU2Mg=="}, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjM1NjYzOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODowNzozNlrOGJRmKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMzo1ODoyNVrOGJ381A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3ODY2NA==", "bodyText": "Same here", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412378664", "createdAt": "2020-04-21T18:07:36Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -705,6 +706,58 @@ public void testCustomTokenWithIAM() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareCustomToken() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    // Create and decode a token with a tenant-aware client.\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+    String customToken = tenantAwareAuth.createCustomTokenAsync(\"user1\").get();\n+    String idToken = signInWithCustomToken(customToken, tenantId);\n+    FirebaseToken decoded = tenantAwareAuth.verifyIdTokenAsync(idToken).get();\n+    assertEquals(\"user1\", decoded.getUid());\n+    assertEquals(tenantId, decoded.getTenantId());\n+\n+    // Delete tenant.\n+    tenantManager.deleteTenantAsync(tenantId).get();\n+  }\n+\n+  @Test\n+  public void testVerifyTokenWithWrongTenantAwareClient() throws Exception {\n+    // Create tenants to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest1 =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName1\");\n+    String tenantId1 = tenantManager.createTenant(tenantCreateRequest1).getTenantId();\n+    Tenant.CreateRequest tenantCreateRequest2 =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName2\");\n+    String tenantId2 = tenantManager.createTenant(tenantCreateRequest2).getTenantId();\n+\n+    // Create tenant-aware clients.\n+    TenantAwareFirebaseAuth tenantAwareAuth1 = auth.getTenantManager().getAuthForTenant(tenantId1);\n+    TenantAwareFirebaseAuth tenantAwareAuth2 = auth.getTenantManager().getAuthForTenant(tenantId2);\n+\n+    // Create a token with one client and decode with the other.\n+    String customToken = tenantAwareAuth1.createCustomTokenAsync(\"user1\").get();\n+    String idToken = signInWithCustomToken(customToken, tenantId1);\n+    try {\n+      tenantAwareAuth2.verifyIdTokenAsync(idToken).get();\n+      fail(\"No error thrown for verifying a token with the wrong tenant-aware client\");\n+    } catch (ExecutionException e) {\n+      assertTrue(e.getCause() instanceof FirebaseAuthException);\n+      assertEquals(FirebaseUserManager.TENANT_ID_MISMATCH,\n+          ((FirebaseAuthException) e.getCause()).getErrorCode());\n+    }\n+\n+    // Delete tenants.\n+    tenantManager.deleteTenantAsync(tenantId1).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzAwNzA2MA==", "bodyText": "Done.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413007060", "createdAt": "2020-04-22T13:58:25Z", "author": {"login": "micahstairs"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -705,6 +706,58 @@ public void testCustomTokenWithIAM() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareCustomToken() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    // Create and decode a token with a tenant-aware client.\n+    TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+    String customToken = tenantAwareAuth.createCustomTokenAsync(\"user1\").get();\n+    String idToken = signInWithCustomToken(customToken, tenantId);\n+    FirebaseToken decoded = tenantAwareAuth.verifyIdTokenAsync(idToken).get();\n+    assertEquals(\"user1\", decoded.getUid());\n+    assertEquals(tenantId, decoded.getTenantId());\n+\n+    // Delete tenant.\n+    tenantManager.deleteTenantAsync(tenantId).get();\n+  }\n+\n+  @Test\n+  public void testVerifyTokenWithWrongTenantAwareClient() throws Exception {\n+    // Create tenants to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest1 =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName1\");\n+    String tenantId1 = tenantManager.createTenant(tenantCreateRequest1).getTenantId();\n+    Tenant.CreateRequest tenantCreateRequest2 =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName2\");\n+    String tenantId2 = tenantManager.createTenant(tenantCreateRequest2).getTenantId();\n+\n+    // Create tenant-aware clients.\n+    TenantAwareFirebaseAuth tenantAwareAuth1 = auth.getTenantManager().getAuthForTenant(tenantId1);\n+    TenantAwareFirebaseAuth tenantAwareAuth2 = auth.getTenantManager().getAuthForTenant(tenantId2);\n+\n+    // Create a token with one client and decode with the other.\n+    String customToken = tenantAwareAuth1.createCustomTokenAsync(\"user1\").get();\n+    String idToken = signInWithCustomToken(customToken, tenantId1);\n+    try {\n+      tenantAwareAuth2.verifyIdTokenAsync(idToken).get();\n+      fail(\"No error thrown for verifying a token with the wrong tenant-aware client\");\n+    } catch (ExecutionException e) {\n+      assertTrue(e.getCause() instanceof FirebaseAuthException);\n+      assertEquals(FirebaseUserManager.TENANT_ID_MISMATCH,\n+          ((FirebaseAuthException) e.getCause()).getErrorCode());\n+    }\n+\n+    // Delete tenants.\n+    tenantManager.deleteTenantAsync(tenantId1).get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM3ODY2NA=="}, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2MjM3MTMzOnYy", "diffSide": "RIGHT", "path": "src/test/java/com/google/firebase/auth/internal/FirebaseTokenFactoryTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODoxMDo1NlrOGJRurw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMzo1ODozM1rOGJ39Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4MDg0Nw==", "bodyText": "Can we also have some unit tests in FirebaseTokenVerifierImplTest.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r412380847", "createdAt": "2020-04-21T18:10:56Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/auth/internal/FirebaseTokenFactoryTest.java", "diffHunk": "@@ -18,6 +18,7 @@\n \n import static com.google.common.base.Preconditions.checkNotNull;\n import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzAwNzE4Ng==", "bodyText": "Done.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413007186", "createdAt": "2020-04-22T13:58:33Z", "author": {"login": "micahstairs"}, "path": "src/test/java/com/google/firebase/auth/internal/FirebaseTokenFactoryTest.java", "diffHunk": "@@ -18,6 +18,7 @@\n \n import static com.google.common.base.Preconditions.checkNotNull;\n import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4MDg0Nw=="}, "originalCommit": {"oid": "10ea21551fb5e5b420f809d746c85370d552ce3e"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2ODU0MzQ4OnYy", "diffSide": "RIGHT", "path": "src/main/java/com/google/firebase/auth/FirebaseTokenVerifierImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDoyNToxOVrOGKKHZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToxNzoyMlrOGKMPKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwNDY3OA==", "bodyText": "Nit: nullToEmpty is not strictly needed here, since you call equals on this.tenantId which is never null. But I'll leave it to you decide.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413304678", "createdAt": "2020-04-22T20:25:19Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/FirebaseTokenVerifierImpl.java", "diffHunk": "@@ -278,6 +283,18 @@ private boolean containsLegacyUidField(IdToken.Payload payload) {\n     return false;\n   }\n \n+  private void checkTenantId(final FirebaseToken firebaseToken) throws FirebaseAuthException {\n+    String tokenTenantId = Strings.nullToEmpty(firebaseToken.getTenantId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "646f98d29fb674a4d3cc74251edef7fd455e7216"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMzOTQzMw==", "bodyText": "We actually do need it or else we'd say there was a mismatch if both were initially null. I confirmed this theory by making the change and watching FirebaseTokenVerifierImplTest.testVerifyToken fail.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413339433", "createdAt": "2020-04-22T21:17:22Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseTokenVerifierImpl.java", "diffHunk": "@@ -278,6 +283,18 @@ private boolean containsLegacyUidField(IdToken.Payload payload) {\n     return false;\n   }\n \n+  private void checkTenantId(final FirebaseToken firebaseToken) throws FirebaseAuthException {\n+    String tokenTenantId = Strings.nullToEmpty(firebaseToken.getTenantId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwNDY3OA=="}, "originalCommit": {"oid": "646f98d29fb674a4d3cc74251edef7fd455e7216"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2ODU3MTk4OnYy", "diffSide": "RIGHT", "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMDozMjo0MVrOGKKYbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToxMDozMVrOGKL_Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwOTAzOQ==", "bodyText": "You can only create one tenant for this test. For the 2nd tenant use a fake tenant ID string. And to ensure proper clean up you will have to do something like this:\n// create test tenants\ntry {\n   // create token\n   try {\n     // verify token\n   }. catch {\n     // assert\n   }\n} finally {\n  // clean up tenants\n}\n\nYou can move the inner try-catch into a new helper method if this looks too ugly.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413309039", "createdAt": "2020-04-22T20:32:41Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -705,6 +706,60 @@ public void testCustomTokenWithIAM() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareCustomToken() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    try {\n+      // Create and decode a token with a tenant-aware client.\n+      TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+      String customToken = tenantAwareAuth.createCustomTokenAsync(\"user1\").get();\n+      String idToken = signInWithCustomToken(customToken, tenantId);\n+      FirebaseToken decoded = tenantAwareAuth.verifyIdTokenAsync(idToken).get();\n+      assertEquals(\"user1\", decoded.getUid());\n+      assertEquals(tenantId, decoded.getTenantId());\n+    } finally {\n+      // Delete tenant.\n+      tenantManager.deleteTenantAsync(tenantId).get();\n+    }\n+  }\n+\n+  @Test\n+  public void testVerifyTokenWithWrongTenantAwareClient() throws Exception {\n+    // Create tenants to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest1 =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName1\");\n+    String tenantId1 = tenantManager.createTenant(tenantCreateRequest1).getTenantId();\n+    Tenant.CreateRequest tenantCreateRequest2 =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "646f98d29fb674a4d3cc74251edef7fd455e7216"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMzNTM3NA==", "bodyText": "Done.", "url": "https://github.com/firebase/firebase-admin-java/pull/391#discussion_r413335374", "createdAt": "2020-04-22T21:10:31Z", "author": {"login": "micahstairs"}, "path": "src/test/java/com/google/firebase/auth/FirebaseAuthIT.java", "diffHunk": "@@ -705,6 +706,60 @@ public void testCustomTokenWithIAM() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testTenantAwareCustomToken() throws Exception {\n+    // Create tenant to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName\");\n+    String tenantId = tenantManager.createTenant(tenantCreateRequest).getTenantId();\n+\n+    try {\n+      // Create and decode a token with a tenant-aware client.\n+      TenantAwareFirebaseAuth tenantAwareAuth = auth.getTenantManager().getAuthForTenant(tenantId);\n+      String customToken = tenantAwareAuth.createCustomTokenAsync(\"user1\").get();\n+      String idToken = signInWithCustomToken(customToken, tenantId);\n+      FirebaseToken decoded = tenantAwareAuth.verifyIdTokenAsync(idToken).get();\n+      assertEquals(\"user1\", decoded.getUid());\n+      assertEquals(tenantId, decoded.getTenantId());\n+    } finally {\n+      // Delete tenant.\n+      tenantManager.deleteTenantAsync(tenantId).get();\n+    }\n+  }\n+\n+  @Test\n+  public void testVerifyTokenWithWrongTenantAwareClient() throws Exception {\n+    // Create tenants to use.\n+    TenantManager tenantManager = auth.getTenantManager();\n+    Tenant.CreateRequest tenantCreateRequest1 =\n+        new Tenant.CreateRequest().setDisplayName(\"DisplayName1\");\n+    String tenantId1 = tenantManager.createTenant(tenantCreateRequest1).getTenantId();\n+    Tenant.CreateRequest tenantCreateRequest2 =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMwOTAzOQ=="}, "originalCommit": {"oid": "646f98d29fb674a4d3cc74251edef7fd455e7216"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1550, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}