{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1NzA3NDIx", "number": 449, "title": "Moved tenant management code into a new package", "bodyText": "Moved TenantManager and related classes into a new multitenancy package.\nAdded AuthHttpClient and FirebaseTenantClient internal APIs for making REST calls.", "createdAt": "2020-07-07T21:51:28Z", "url": "https://github.com/firebase/firebase-admin-java/pull/449", "merged": true, "mergeCommit": {"oid": "042121baaddec0d53daa41bb3197a1416a311da4"}, "closed": true, "closedAt": "2020-07-09T22:30:31Z", "author": {"login": "hiranya911"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxDXa2AH2gAyNDQ1NzA3NDIxOjk5ZDA3OGUxNTI5ZjNlNjJhYzk0YTlkMTNiNDIxNTJiMjcxMjRlM2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczUZP9AFqTQ0NTkxNTQwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "99d078e1529f3e62ac94a9d13b42152b27124e3b", "author": {"user": {"login": "hiranya911", "name": "Hiranya Jayathilaka"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/99d078e1529f3e62ac94a9d13b42152b27124e3b", "committedDate": "2020-07-02T18:43:40Z", "message": "Multi-tenancy refactor experiment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df7d86ae61015c0682a24de181715f26eb9b0225", "author": {"user": {"login": "hiranya911", "name": "Hiranya Jayathilaka"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/df7d86ae61015c0682a24de181715f26eb9b0225", "committedDate": "2020-07-07T21:38:13Z", "message": "fix(auth): Completed tenant mgt refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c", "author": {"user": {"login": "hiranya911", "name": "Hiranya Jayathilaka"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/3d52e1789edccffbe488f2acfdc1499a2572567c", "committedDate": "2020-07-07T21:51:57Z", "message": "Added license header to new class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NTEzMTQ5", "url": "https://github.com/firebase/firebase-admin-java/pull/449#pullrequestreview-445513149", "createdAt": "2020-07-09T11:04:49Z", "commit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMTowNDo1MFrOGvMU5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMTo0MDozM1rOGvNXsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEzODIxMw==", "bodyText": "Why don't we need to need to check if the app has been destroyed in the tenant manager?", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452138213", "createdAt": "2020-07-09T11:04:50Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseAuth.java", "diffHunk": "@@ -213,12 +214,7 @@ FirebaseTokenVerifier getSessionCookieVerifier(boolean checkRevoked) {\n   }\n \n   @Override\n-  protected void doDestroy() {\n-    // Only destroy the tenant manager if it has been created.\n-    if (tenantManagerCreated.get()) {\n-      getTenantManager().destroy();\n-    }\n-  }\n+  protected void doDestroy() { }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjEzODg4Mg==", "bodyText": "This variable is no longer needed now that doDestroy is a no-op.", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452138882", "createdAt": "2020-07-09T11:06:05Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseAuth.java", "diffHunk": "@@ -53,7 +54,7 @@\n       @Override\n       public TenantManager get() {\n         tenantManagerCreated.set(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE0NjE3NA==", "bodyText": "Did you purposefully omit some error codes from this map? e.g. TENANT_ID_MISMATCH", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452146174", "createdAt": "2020-07-09T11:21:21Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/internal/AuthHttpClient.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.firebase.auth.internal;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import com.google.api.client.http.GenericUrl;\n+import com.google.api.client.http.HttpContent;\n+import com.google.api.client.http.HttpRequest;\n+import com.google.api.client.http.HttpRequestFactory;\n+import com.google.api.client.http.HttpResponse;\n+import com.google.api.client.http.HttpResponseException;\n+import com.google.api.client.http.HttpResponseInterceptor;\n+import com.google.api.client.http.json.JsonHttpContent;\n+import com.google.api.client.json.JsonFactory;\n+import com.google.api.client.json.JsonObjectParser;\n+import com.google.common.base.Strings;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSortedSet;\n+import com.google.firebase.auth.FirebaseAuthException;\n+import com.google.firebase.internal.Nullable;\n+import com.google.firebase.internal.SdkUtils;\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Provides a convenient API for making REST calls to the Firebase Auth backend servers.\n+ */\n+public final class AuthHttpClient {\n+\n+  private static final String CLIENT_VERSION_HEADER = \"X-Client-Version\";\n+\n+  private static final String CLIENT_VERSION = \"Java/Admin/\" + SdkUtils.getVersion();\n+\n+  private static final String INTERNAL_ERROR = \"internal-error\";\n+\n+  // Map of server-side error codes to SDK error codes.\n+  // SDK error codes defined at: https://firebase.google.com/docs/auth/admin/errors\n+  private static final Map<String, String> ERROR_CODES = ImmutableMap.<String, String>builder()\n+      .put(\"CLAIMS_TOO_LARGE\", \"claims-too-large\")\n+      .put(\"CONFIGURATION_NOT_FOUND\", \"configuration-not-found\")\n+      .put(\"INSUFFICIENT_PERMISSION\", \"insufficient-permission\")\n+      .put(\"DUPLICATE_EMAIL\", \"email-already-exists\")\n+      .put(\"DUPLICATE_LOCAL_ID\", \"uid-already-exists\")\n+      .put(\"EMAIL_EXISTS\", \"email-already-exists\")\n+      .put(\"INVALID_CLAIMS\", \"invalid-claims\")\n+      .put(\"INVALID_EMAIL\", \"invalid-email\")\n+      .put(\"INVALID_PAGE_SELECTION\", \"invalid-page-token\")\n+      .put(\"INVALID_PHONE_NUMBER\", \"invalid-phone-number\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE0Njc4MA==", "bodyText": "Should we use a broader term than \"user management backend service\" if this is being used for tenant/provider-related requests too?", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452146780", "createdAt": "2020-07-09T11:22:42Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/internal/AuthHttpClient.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.firebase.auth.internal;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import com.google.api.client.http.GenericUrl;\n+import com.google.api.client.http.HttpContent;\n+import com.google.api.client.http.HttpRequest;\n+import com.google.api.client.http.HttpRequestFactory;\n+import com.google.api.client.http.HttpResponse;\n+import com.google.api.client.http.HttpResponseException;\n+import com.google.api.client.http.HttpResponseInterceptor;\n+import com.google.api.client.http.json.JsonHttpContent;\n+import com.google.api.client.json.JsonFactory;\n+import com.google.api.client.json.JsonObjectParser;\n+import com.google.common.base.Strings;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSortedSet;\n+import com.google.firebase.auth.FirebaseAuthException;\n+import com.google.firebase.internal.Nullable;\n+import com.google.firebase.internal.SdkUtils;\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Provides a convenient API for making REST calls to the Firebase Auth backend servers.\n+ */\n+public final class AuthHttpClient {\n+\n+  private static final String CLIENT_VERSION_HEADER = \"X-Client-Version\";\n+\n+  private static final String CLIENT_VERSION = \"Java/Admin/\" + SdkUtils.getVersion();\n+\n+  private static final String INTERNAL_ERROR = \"internal-error\";\n+\n+  // Map of server-side error codes to SDK error codes.\n+  // SDK error codes defined at: https://firebase.google.com/docs/auth/admin/errors\n+  private static final Map<String, String> ERROR_CODES = ImmutableMap.<String, String>builder()\n+      .put(\"CLAIMS_TOO_LARGE\", \"claims-too-large\")\n+      .put(\"CONFIGURATION_NOT_FOUND\", \"configuration-not-found\")\n+      .put(\"INSUFFICIENT_PERMISSION\", \"insufficient-permission\")\n+      .put(\"DUPLICATE_EMAIL\", \"email-already-exists\")\n+      .put(\"DUPLICATE_LOCAL_ID\", \"uid-already-exists\")\n+      .put(\"EMAIL_EXISTS\", \"email-already-exists\")\n+      .put(\"INVALID_CLAIMS\", \"invalid-claims\")\n+      .put(\"INVALID_EMAIL\", \"invalid-email\")\n+      .put(\"INVALID_PAGE_SELECTION\", \"invalid-page-token\")\n+      .put(\"INVALID_PHONE_NUMBER\", \"invalid-phone-number\")\n+      .put(\"PHONE_NUMBER_EXISTS\", \"phone-number-already-exists\")\n+      .put(\"PROJECT_NOT_FOUND\", \"project-not-found\")\n+      .put(\"USER_NOT_FOUND\", \"user-not-found\")\n+      .put(\"WEAK_PASSWORD\", \"invalid-password\")\n+      .put(\"UNAUTHORIZED_DOMAIN\", \"unauthorized-continue-uri\")\n+      .put(\"INVALID_DYNAMIC_LINK_DOMAIN\", \"invalid-dynamic-link-domain\")\n+      .put(\"TENANT_NOT_FOUND\", \"tenant-not-found\")\n+      .build();\n+\n+  private final JsonFactory jsonFactory;\n+  private final HttpRequestFactory requestFactory;\n+\n+  private HttpResponseInterceptor interceptor;\n+\n+  public AuthHttpClient(JsonFactory jsonFactory, HttpRequestFactory requestFactory) {\n+    this.jsonFactory = jsonFactory;\n+    this.requestFactory = requestFactory;\n+  }\n+\n+  public static Set<String> generateMask(Map<String, Object> properties) {\n+    ImmutableSortedSet.Builder<String> maskBuilder = ImmutableSortedSet.naturalOrder();\n+    for (Map.Entry<String, Object> entry : properties.entrySet()) {\n+      if (entry.getValue() instanceof Map) {\n+        Set<String> childMask = generateMask((Map<String, Object>) entry.getValue());\n+        for (String childProperty : childMask) {\n+          maskBuilder.add(entry.getKey() + \".\" + childProperty);\n+        }\n+      } else {\n+        maskBuilder.add(entry.getKey());\n+      }\n+    }\n+    return maskBuilder.build();\n+  }\n+\n+  public void setInterceptor(HttpResponseInterceptor interceptor) {\n+    this.interceptor = interceptor;\n+  }\n+\n+  public <T> T sendRequest(\n+      String method, GenericUrl url,\n+      @Nullable Object content, Class<T> clazz) throws FirebaseAuthException {\n+\n+    checkArgument(!Strings.isNullOrEmpty(method), \"method must not be null or empty\");\n+    checkNotNull(url, \"url must not be null\");\n+    checkNotNull(clazz, \"response class must not be null\");\n+    HttpResponse response = null;\n+    try {\n+      HttpContent httpContent = content != null ? new JsonHttpContent(jsonFactory, content) : null;\n+      HttpRequest request =\n+          requestFactory.buildRequest(method.equals(\"PATCH\") ? \"POST\" : method, url, httpContent);\n+      request.setParser(new JsonObjectParser(jsonFactory));\n+      request.getHeaders().set(CLIENT_VERSION_HEADER, CLIENT_VERSION);\n+      if (method.equals(\"PATCH\")) {\n+        request.getHeaders().set(\"X-HTTP-Method-Override\", \"PATCH\");\n+      }\n+      request.setResponseInterceptor(interceptor);\n+      response = request.execute();\n+      return response.parseAs(clazz);\n+    } catch (HttpResponseException e) {\n+      // Server responded with an HTTP error\n+      handleHttpError(e);\n+      return null;\n+    } catch (IOException e) {\n+      // All other IO errors (Connection refused, reset, parse error etc.)\n+      throw new FirebaseAuthException(\n+          INTERNAL_ERROR, \"Error while calling user management backend service\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 131}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE0NzExNA==", "bodyText": "Should we use a broader term than \"User management service\" if this is being used for tenant/provider-related requests too?", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452147114", "createdAt": "2020-07-09T11:23:25Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/internal/AuthHttpClient.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.firebase.auth.internal;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import com.google.api.client.http.GenericUrl;\n+import com.google.api.client.http.HttpContent;\n+import com.google.api.client.http.HttpRequest;\n+import com.google.api.client.http.HttpRequestFactory;\n+import com.google.api.client.http.HttpResponse;\n+import com.google.api.client.http.HttpResponseException;\n+import com.google.api.client.http.HttpResponseInterceptor;\n+import com.google.api.client.http.json.JsonHttpContent;\n+import com.google.api.client.json.JsonFactory;\n+import com.google.api.client.json.JsonObjectParser;\n+import com.google.common.base.Strings;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSortedSet;\n+import com.google.firebase.auth.FirebaseAuthException;\n+import com.google.firebase.internal.Nullable;\n+import com.google.firebase.internal.SdkUtils;\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Set;\n+\n+/**\n+ * Provides a convenient API for making REST calls to the Firebase Auth backend servers.\n+ */\n+public final class AuthHttpClient {\n+\n+  private static final String CLIENT_VERSION_HEADER = \"X-Client-Version\";\n+\n+  private static final String CLIENT_VERSION = \"Java/Admin/\" + SdkUtils.getVersion();\n+\n+  private static final String INTERNAL_ERROR = \"internal-error\";\n+\n+  // Map of server-side error codes to SDK error codes.\n+  // SDK error codes defined at: https://firebase.google.com/docs/auth/admin/errors\n+  private static final Map<String, String> ERROR_CODES = ImmutableMap.<String, String>builder()\n+      .put(\"CLAIMS_TOO_LARGE\", \"claims-too-large\")\n+      .put(\"CONFIGURATION_NOT_FOUND\", \"configuration-not-found\")\n+      .put(\"INSUFFICIENT_PERMISSION\", \"insufficient-permission\")\n+      .put(\"DUPLICATE_EMAIL\", \"email-already-exists\")\n+      .put(\"DUPLICATE_LOCAL_ID\", \"uid-already-exists\")\n+      .put(\"EMAIL_EXISTS\", \"email-already-exists\")\n+      .put(\"INVALID_CLAIMS\", \"invalid-claims\")\n+      .put(\"INVALID_EMAIL\", \"invalid-email\")\n+      .put(\"INVALID_PAGE_SELECTION\", \"invalid-page-token\")\n+      .put(\"INVALID_PHONE_NUMBER\", \"invalid-phone-number\")\n+      .put(\"PHONE_NUMBER_EXISTS\", \"phone-number-already-exists\")\n+      .put(\"PROJECT_NOT_FOUND\", \"project-not-found\")\n+      .put(\"USER_NOT_FOUND\", \"user-not-found\")\n+      .put(\"WEAK_PASSWORD\", \"invalid-password\")\n+      .put(\"UNAUTHORIZED_DOMAIN\", \"unauthorized-continue-uri\")\n+      .put(\"INVALID_DYNAMIC_LINK_DOMAIN\", \"invalid-dynamic-link-domain\")\n+      .put(\"TENANT_NOT_FOUND\", \"tenant-not-found\")\n+      .build();\n+\n+  private final JsonFactory jsonFactory;\n+  private final HttpRequestFactory requestFactory;\n+\n+  private HttpResponseInterceptor interceptor;\n+\n+  public AuthHttpClient(JsonFactory jsonFactory, HttpRequestFactory requestFactory) {\n+    this.jsonFactory = jsonFactory;\n+    this.requestFactory = requestFactory;\n+  }\n+\n+  public static Set<String> generateMask(Map<String, Object> properties) {\n+    ImmutableSortedSet.Builder<String> maskBuilder = ImmutableSortedSet.naturalOrder();\n+    for (Map.Entry<String, Object> entry : properties.entrySet()) {\n+      if (entry.getValue() instanceof Map) {\n+        Set<String> childMask = generateMask((Map<String, Object>) entry.getValue());\n+        for (String childProperty : childMask) {\n+          maskBuilder.add(entry.getKey() + \".\" + childProperty);\n+        }\n+      } else {\n+        maskBuilder.add(entry.getKey());\n+      }\n+    }\n+    return maskBuilder.build();\n+  }\n+\n+  public void setInterceptor(HttpResponseInterceptor interceptor) {\n+    this.interceptor = interceptor;\n+  }\n+\n+  public <T> T sendRequest(\n+      String method, GenericUrl url,\n+      @Nullable Object content, Class<T> clazz) throws FirebaseAuthException {\n+\n+    checkArgument(!Strings.isNullOrEmpty(method), \"method must not be null or empty\");\n+    checkNotNull(url, \"url must not be null\");\n+    checkNotNull(clazz, \"response class must not be null\");\n+    HttpResponse response = null;\n+    try {\n+      HttpContent httpContent = content != null ? new JsonHttpContent(jsonFactory, content) : null;\n+      HttpRequest request =\n+          requestFactory.buildRequest(method.equals(\"PATCH\") ? \"POST\" : method, url, httpContent);\n+      request.setParser(new JsonObjectParser(jsonFactory));\n+      request.getHeaders().set(CLIENT_VERSION_HEADER, CLIENT_VERSION);\n+      if (method.equals(\"PATCH\")) {\n+        request.getHeaders().set(\"X-HTTP-Method-Override\", \"PATCH\");\n+      }\n+      request.setResponseInterceptor(interceptor);\n+      response = request.execute();\n+      return response.parseAs(clazz);\n+    } catch (HttpResponseException e) {\n+      // Server responded with an HTTP error\n+      handleHttpError(e);\n+      return null;\n+    } catch (IOException e) {\n+      // All other IO errors (Connection refused, reset, parse error etc.)\n+      throw new FirebaseAuthException(\n+          INTERNAL_ERROR, \"Error while calling user management backend service\", e);\n+    } finally {\n+      if (response != null) {\n+        try {\n+          response.disconnect();\n+        } catch (IOException ignored) {\n+          // Ignored\n+        }\n+      }\n+    }\n+  }\n+\n+  private void handleHttpError(HttpResponseException e) throws FirebaseAuthException {\n+    try {\n+      HttpErrorResponse response = jsonFactory.fromString(e.getContent(), HttpErrorResponse.class);\n+      String code = ERROR_CODES.get(response.getErrorCode());\n+      if (code != null) {\n+        throw new FirebaseAuthException(code, \"User management service responded with an error\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 148}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE0OTU0Ng==", "bodyText": "Wouldn't it be nice to keep all of these constants in one place? AuthHttpClient is a good spot to keep them. And it appears INTERNAL_ERROR is currently being duplicated both here and AuthHttpClient.", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452149546", "createdAt": "2020-07-09T11:28:13Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -71,37 +61,10 @@\n  */\n class FirebaseUserManager {\n \n-  static final String CONFIGURATION_NOT_FOUND_ERROR = \"configuration-not-found\";\n-  static final String TENANT_ID_MISMATCH_ERROR = \"tenant-id-mismatch\";\n-  static final String TENANT_NOT_FOUND_ERROR = \"tenant-not-found\";\n   static final String USER_NOT_FOUND_ERROR = \"user-not-found\";\n   static final String INTERNAL_ERROR = \"internal-error\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1MDQ3Ng==", "bodyText": "Can getTenantUrlSuffix be removed now that the tenant-related methods have been removed?", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452150476", "createdAt": "2020-07-09T11:30:13Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -449,27 +367,12 @@ ListSamlProviderConfigsResponse listSamlProviderConfigs(int maxResults, String p\n \n   void deleteOidcProviderConfig(String providerId) throws FirebaseAuthException {\n     GenericUrl url = new GenericUrl(idpConfigMgtBaseUrl + getOidcUrlSuffix(providerId));\n-    sendRequest(\"DELETE\", url, null, GenericJson.class);\n+    httpClient.sendRequest(\"DELETE\", url, null, GenericJson.class);\n   }\n \n   void deleteSamlProviderConfig(String providerId) throws FirebaseAuthException {\n     GenericUrl url = new GenericUrl(idpConfigMgtBaseUrl + getSamlUrlSuffix(providerId));\n-    sendRequest(\"DELETE\", url, null, GenericJson.class);\n-  }\n-\n-  private static Set<String> generateMask(Map<String, Object> properties) {\n-    ImmutableSortedSet.Builder<String> maskBuilder = ImmutableSortedSet.naturalOrder();\n-    for (Map.Entry<String, Object> entry : properties.entrySet()) {\n-      if (entry.getValue() instanceof Map) {\n-        Set<String> childMask = generateMask((Map<String, Object>) entry.getValue());\n-        for (String childProperty : childMask) {\n-          maskBuilder.add(entry.getKey() + \".\" + childProperty);\n-        }\n-      } else {\n-        maskBuilder.add(entry.getKey());\n-      }\n-    }\n-    return maskBuilder.build();\n+    httpClient.sendRequest(\"DELETE\", url, null, GenericJson.class);\n   }\n \n   private static String getTenantUrlSuffix(String tenantId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 277}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1MTI4OA==", "bodyText": "Consolidate these errors in AuthHttpClient? INTERNAL_ERROR is currently being duplicated across both.", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452151288", "createdAt": "2020-07-09T11:31:55Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/multitenancy/FirebaseTenantClient.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.firebase.auth.multitenancy;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import com.google.api.client.http.GenericUrl;\n+import com.google.api.client.http.HttpRequestFactory;\n+import com.google.api.client.http.HttpResponseInterceptor;\n+import com.google.api.client.json.GenericJson;\n+import com.google.api.client.json.JsonFactory;\n+import com.google.common.base.Joiner;\n+import com.google.common.base.Strings;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.ImplFirebaseTrampolines;\n+import com.google.firebase.auth.FirebaseAuthException;\n+import com.google.firebase.auth.internal.AuthHttpClient;\n+import com.google.firebase.auth.internal.ListTenantsResponse;\n+import com.google.firebase.internal.ApiClientUtils;\n+import java.util.Map;\n+\n+final class FirebaseTenantClient {\n+\n+  static final int MAX_LIST_TENANTS_RESULTS = 100;\n+\n+  static final String TENANT_NOT_FOUND_ERROR = \"tenant-not-found\";\n+\n+  static final String INTERNAL_ERROR = \"internal-error\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1MTkwOA==", "bodyText": "Add period after \"token\".", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452151908", "createdAt": "2020-07-09T11:33:17Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/multitenancy/FirebaseTenantClient.java", "diffHunk": "@@ -0,0 +1,115 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.firebase.auth.multitenancy;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkNotNull;\n+\n+import com.google.api.client.http.GenericUrl;\n+import com.google.api.client.http.HttpRequestFactory;\n+import com.google.api.client.http.HttpResponseInterceptor;\n+import com.google.api.client.json.GenericJson;\n+import com.google.api.client.json.JsonFactory;\n+import com.google.common.base.Joiner;\n+import com.google.common.base.Strings;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.ImplFirebaseTrampolines;\n+import com.google.firebase.auth.FirebaseAuthException;\n+import com.google.firebase.auth.internal.AuthHttpClient;\n+import com.google.firebase.auth.internal.ListTenantsResponse;\n+import com.google.firebase.internal.ApiClientUtils;\n+import java.util.Map;\n+\n+final class FirebaseTenantClient {\n+\n+  static final int MAX_LIST_TENANTS_RESULTS = 100;\n+\n+  static final String TENANT_NOT_FOUND_ERROR = \"tenant-not-found\";\n+\n+  static final String INTERNAL_ERROR = \"internal-error\";\n+\n+  private static final String ID_TOOLKIT_URL =\n+      \"https://identitytoolkit.googleapis.com/%s/projects/%s\";\n+\n+  private final String tenantMgtBaseUrl;\n+  private final AuthHttpClient httpClient;\n+\n+  FirebaseTenantClient(FirebaseApp app) {\n+    checkNotNull(app, \"FirebaseApp must not be null\");\n+    String projectId = ImplFirebaseTrampolines.getProjectId(app);\n+    checkArgument(!Strings.isNullOrEmpty(projectId),\n+        \"Project ID is required to access the auth service. Use a service account credential or \"\n+            + \"set the project ID explicitly via FirebaseOptions. Alternatively you can also \"\n+            + \"set the project ID via the GOOGLE_CLOUD_PROJECT environment variable.\");\n+    this.tenantMgtBaseUrl = String.format(ID_TOOLKIT_URL, \"v2\", projectId);\n+    JsonFactory jsonFactory = app.getOptions().getJsonFactory();\n+    HttpRequestFactory requestFactory = ApiClientUtils.newAuthorizedRequestFactory(app);\n+    this.httpClient = new AuthHttpClient(jsonFactory, requestFactory);\n+  }\n+\n+  void setInterceptor(HttpResponseInterceptor interceptor) {\n+    httpClient.setInterceptor(interceptor);\n+  }\n+\n+  Tenant getTenant(String tenantId) throws FirebaseAuthException {\n+    GenericUrl url = new GenericUrl(tenantMgtBaseUrl + getTenantUrlSuffix(tenantId));\n+    return httpClient.sendRequest(\"GET\", url, null, Tenant.class);\n+  }\n+\n+  Tenant createTenant(Tenant.CreateRequest request) throws FirebaseAuthException {\n+    GenericUrl url = new GenericUrl(tenantMgtBaseUrl + \"/tenants\");\n+    return httpClient.sendRequest(\"POST\", url, request.getProperties(), Tenant.class);\n+  }\n+\n+  Tenant updateTenant(Tenant.UpdateRequest request) throws FirebaseAuthException {\n+    Map<String, Object> properties = request.getProperties();\n+    GenericUrl url = new GenericUrl(tenantMgtBaseUrl + getTenantUrlSuffix(request.getTenantId()));\n+    url.put(\"updateMask\", Joiner.on(\",\").join(AuthHttpClient.generateMask(properties)));\n+    return httpClient.sendRequest(\"PATCH\", url, properties, Tenant.class);\n+  }\n+\n+  void deleteTenant(String tenantId) throws FirebaseAuthException {\n+    GenericUrl url = new GenericUrl(tenantMgtBaseUrl + getTenantUrlSuffix(tenantId));\n+    httpClient.sendRequest(\"DELETE\", url, null, GenericJson.class);\n+  }\n+\n+  ListTenantsResponse listTenants(int maxResults, String pageToken)\n+      throws FirebaseAuthException {\n+    ImmutableMap.Builder<String, Object> builder =\n+        ImmutableMap.<String, Object>builder().put(\"pageSize\", maxResults);\n+    if (pageToken != null) {\n+      checkArgument(!pageToken.equals(\n+          ListTenantsPage.END_OF_LIST), \"Invalid end of list page token\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1MjQwOQ==", "bodyText": "Rename this variable to tenantClient. It's not a FirebaseUserManager anywmore!", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452152409", "createdAt": "2020-07-09T11:34:21Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/multitenancy/ListTenantsPage.java", "diffHunk": "@@ -198,9 +197,9 @@ ListTenantsResponse fetch(int maxResults, String pageToken)\n \n   static class DefaultTenantSource implements TenantSource {\n \n-    private final FirebaseUserManager userManager;\n+    private final FirebaseTenantClient userManager;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1MzMzMw==", "bodyText": "This should be {@link TenantManager}.", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452153333", "createdAt": "2020-07-09T11:36:21Z", "author": {"login": "micahstairs"}, "path": "src/main/java/com/google/firebase/auth/multitenancy/TenantManager.java", "diffHunk": "@@ -14,45 +14,54 @@\n  * limitations under the License.\n  */\n \n-package com.google.firebase.auth;\n+package com.google.firebase.auth.multitenancy;\n \n import static com.google.common.base.Preconditions.checkArgument;\n import static com.google.common.base.Preconditions.checkNotNull;\n-import static com.google.common.base.Preconditions.checkState;\n \n-import com.google.api.client.json.JsonFactory;\n+import com.google.api.client.http.HttpResponseInterceptor;\n import com.google.api.core.ApiFuture;\n+import com.google.common.annotations.VisibleForTesting;\n import com.google.common.base.Strings;\n import com.google.firebase.FirebaseApp;\n-import com.google.firebase.auth.ListTenantsPage.DefaultTenantSource;\n-import com.google.firebase.auth.ListTenantsPage.PageFactory;\n-import com.google.firebase.auth.ListTenantsPage.TenantSource;\n-import com.google.firebase.auth.Tenant.CreateRequest;\n-import com.google.firebase.auth.Tenant.UpdateRequest;\n+import com.google.firebase.auth.FirebaseAuth;\n+import com.google.firebase.auth.FirebaseAuthException;\n+import com.google.firebase.auth.multitenancy.ListTenantsPage.DefaultTenantSource;\n+import com.google.firebase.auth.multitenancy.ListTenantsPage.PageFactory;\n+import com.google.firebase.auth.multitenancy.ListTenantsPage.TenantSource;\n+import com.google.firebase.auth.multitenancy.Tenant.CreateRequest;\n+import com.google.firebase.auth.multitenancy.Tenant.UpdateRequest;\n import com.google.firebase.internal.CallableOperation;\n import com.google.firebase.internal.NonNull;\n import com.google.firebase.internal.Nullable;\n import java.util.HashMap;\n import java.util.Map;\n-import java.util.concurrent.atomic.AtomicBoolean;\n \n /**\n  * This class can be used to perform a variety of tenant-related operations, including creating,\n  * updating, and listing tenants.\n  */\n public final class TenantManager {\n \n-  private final Object lock = new Object();\n-  private final AtomicBoolean destroyed = new AtomicBoolean(false);\n-\n   private final FirebaseApp firebaseApp;\n-  private final FirebaseUserManager userManager;\n+  private final FirebaseTenantClient tenantClient;\n   private final Map<String, TenantAwareFirebaseAuth> tenantAwareAuths;\n \n-  TenantManager(FirebaseApp firebaseApp, FirebaseUserManager userManager) {\n+  /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1Mzg3Ng==", "bodyText": "Is TENANTS_BASE_URL still needed?", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452153876", "createdAt": "2020-07-09T11:37:27Z", "author": {"login": "micahstairs"}, "path": "src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java", "diffHunk": "@@ -78,11 +82,13 @@\n           .setAndroidInstallApp(true)\n           .setAndroidMinimumVersion(\"6\")\n           .build();\n+\n   private static final Map<String, Object> ACTION_CODE_SETTINGS_MAP =\n           ACTION_CODE_SETTINGS.getProperties();\n \n   private static final String PROJECT_BASE_URL =\n       \"https://identitytoolkit.googleapis.com/v2/projects/test-project-id\";\n+\n   private static final String TENANTS_BASE_URL = PROJECT_BASE_URL + \"/tenants\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1NDI4Mw==", "bodyText": "Consolidate in AuthHttpClient?", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452154283", "createdAt": "2020-07-09T11:38:21Z", "author": {"login": "micahstairs"}, "path": "src/test/java/com/google/firebase/auth/ProviderConfigTestUtils.java", "diffHunk": "@@ -26,68 +26,72 @@\n import java.util.concurrent.ExecutionException;\n import org.junit.rules.ExternalResource;\n \n-class ProviderConfigTestUtils {\n+public class ProviderConfigTestUtils {\n \n-  static void assertOidcProviderConfigDoesNotExist(\n+  static final String CONFIGURATION_NOT_FOUND_ERROR = \"configuration-not-found\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1NDcwNQ==", "bodyText": "LLC", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452154705", "createdAt": "2020-07-09T11:39:18Z", "author": {"login": "micahstairs"}, "path": "src/test/java/com/google/firebase/auth/multitenancy/FirebaseTenantClientTest.java", "diffHunk": "@@ -0,0 +1,362 @@\n+/*\n+ * Copyright 2020 Google Inc.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE1NTMxMw==", "bodyText": "Use a static import for Assert.assertEquals?", "url": "https://github.com/firebase/firebase-admin-java/pull/449#discussion_r452155313", "createdAt": "2020-07-09T11:40:33Z", "author": {"login": "micahstairs"}, "path": "src/test/java/com/google/firebase/auth/multitenancy/TenantAwareFirebaseAuthIT.java", "diffHunk": "@@ -247,7 +258,7 @@ public void testVerifyTokenWithWrongTenantAwareClient() throws Exception {\n       fail(\"No error thrown for verifying a token with the wrong tenant-aware client\");\n     } catch (ExecutionException e) {\n       assertTrue(e.getCause() instanceof FirebaseAuthException);\n-      assertEquals(FirebaseUserManager.TENANT_ID_MISMATCH_ERROR,\n+      Assert.assertEquals(\"tenant-id-mismatch\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d52e1789edccffbe488f2acfdc1499a2572567c"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb329c58e5debf4ff12774c43e7a592c7a516c13", "author": {"user": {"login": "hiranya911", "name": "Hiranya Jayathilaka"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/eb329c58e5debf4ff12774c43e7a592c7a516c13", "committedDate": "2020-07-09T17:50:34Z", "message": "Responding to code review comments: Consolidated error codes in AuthHttpClient"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1ODQxMTE5", "url": "https://github.com/firebase/firebase-admin-java/pull/449#pullrequestreview-445841119", "createdAt": "2020-07-09T17:52:09Z", "commit": {"oid": "eb329c58e5debf4ff12774c43e7a592c7a516c13"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1ODUxNDI1", "url": "https://github.com/firebase/firebase-admin-java/pull/449#pullrequestreview-445851425", "createdAt": "2020-07-09T18:06:40Z", "commit": {"oid": "eb329c58e5debf4ff12774c43e7a592c7a516c13"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1OTE1NDAw", "url": "https://github.com/firebase/firebase-admin-java/pull/449#pullrequestreview-445915400", "createdAt": "2020-07-09T19:41:54Z", "commit": {"oid": "eb329c58e5debf4ff12774c43e7a592c7a516c13"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2910, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}