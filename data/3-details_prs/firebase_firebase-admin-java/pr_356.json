{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MjAyMTg2", "number": 356, "title": "fix: Enabled automatic HTTP retries for FirebaseProjectManagement", "bodyText": "Enables automatic HTTP retries for the FirebaseProjectManagement API. We disable retries for unit tests for faster execution of tests.\nRELEASE NOTE: Project management APIs in the FirebaseProjectManagement class now automatically retries operations that fail due to retry-eligible HTTP errors.", "createdAt": "2020-01-28T20:01:06Z", "url": "https://github.com/firebase/firebase-admin-java/pull/356", "merged": true, "mergeCommit": {"oid": "a039e051c9433eb26eafbde5c152fdcb5a4b80d9"}, "closed": true, "closedAt": "2020-02-10T19:16:51Z", "author": {"login": "hiranya911"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-26NKgH2gAyMzY4MjAyMTg2OmUyNjBiOWZkNWQ4NzAyNGUwOWYzYTM3NmYxODNhZTFmYmRjNzQxZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCKEv1AFqTM1NTUyMTQ3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e260b9fd5d87024e09f3a376f183ae1fbdc741fb", "author": {"user": {"login": "hiranya911", "name": "Hiranya Jayathilaka"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/e260b9fd5d87024e09f3a376f183ae1fbdc741fb", "committedDate": "2020-01-28T19:56:41Z", "message": "Enabled automatic HTTP retries for FirebaseProjectManagement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fffdae80be973ce6e1243df9b8f5d29155d51802", "author": {"user": {"login": "hiranya911", "name": "Hiranya Jayathilaka"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/fffdae80be973ce6e1243df9b8f5d29155d51802", "committedDate": "2020-01-28T21:50:19Z", "message": "Added some test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78ff994ea3fbae34729a0c8d75f4d88fe9717dfe", "author": {"user": {"login": "hiranya911", "name": "Hiranya Jayathilaka"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/78ff994ea3fbae34729a0c8d75f4d88fe9717dfe", "committedDate": "2020-01-28T23:42:05Z", "message": "Added helper function for disabling exponential backoff during tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8be0e06112a46920e0e8310b150f3397f6b0b24d", "author": {"user": {"login": "hiranya911", "name": "Hiranya Jayathilaka"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/8be0e06112a46920e0e8310b150f3397f6b0b24d", "committedDate": "2020-01-29T00:31:35Z", "message": "Added util class for simplifying retry tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7742c35b4e71cae1ba3072ee0fbfbabddacf092", "author": {"user": {"login": "hiranya911", "name": "Hiranya Jayathilaka"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/e7742c35b4e71cae1ba3072ee0fbfbabddacf092", "committedDate": "2020-01-29T00:49:31Z", "message": "Simplified test cases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "666fa3cbd1412bfd0b4e3395433d72cbd49b2841", "author": {"user": {"login": "hiranya911", "name": "Hiranya Jayathilaka"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/666fa3cbd1412bfd0b4e3395433d72cbd49b2841", "committedDate": "2020-01-29T00:52:04Z", "message": "Removed unused method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwOTg3NTE1", "url": "https://github.com/firebase/firebase-admin-java/pull/356#pullrequestreview-350987515", "createdAt": "2020-01-30T17:01:00Z", "commit": {"oid": "666fa3cbd1412bfd0b4e3395433d72cbd49b2841"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTE5ODk2", "url": "https://github.com/firebase/firebase-admin-java/pull/356#pullrequestreview-355519896", "createdAt": "2020-02-08T01:40:43Z", "commit": {"oid": "666fa3cbd1412bfd0b4e3395433d72cbd49b2841"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMTo0MDo0M1rOFnOffQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wOFQwMTo0MDo0M1rOFnOffQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjY3NjIyMQ==", "bodyText": "At first I kind of want to say we should bake this assertion into the API infrastructure itself instead of directly verifying in a unit test that no one touched the code. But then the OO design I came up with to facilitate this turns out to be impossible due to various classes being final. I was hoping that we can write a subclass of HttpRequest called RetryingHttpRequest that declares at compile time that getUnsuccessfulResponseHandler will return RetryHandlerDecorator or a suitable base class, but alas, HttpRequest is final. (And so is HttpRequestFactory, which is the other class I wanted to subclass.)\nWithout the above OO structure, the only other way to structure the test to be more behavioural would be to treat the retrying mechanism completely like a black box, and empirically measure retry intervals and retry counts after forcing an unsuccessful response. This is going to be painfully flaky, so I think what you have is probably for the best.", "url": "https://github.com/firebase/firebase-admin-java/pull/356#discussion_r376676221", "createdAt": "2020-02-08T01:40:43Z", "author": {"login": "weixifan"}, "path": "src/test/java/com/google/firebase/internal/TestApiClientUtils.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright 2020 Google Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.firebase.internal;\n+\n+import static com.google.firebase.internal.ApiClientUtils.DEFAULT_RETRY_CONFIG;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+\n+import com.google.api.client.http.GenericUrl;\n+import com.google.api.client.http.HttpRequest;\n+import com.google.api.client.http.HttpRequestFactory;\n+import com.google.api.client.http.HttpUnsuccessfulResponseHandler;\n+import com.google.api.client.testing.util.MockSleeper;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.internal.RetryInitializer.RetryHandlerDecorator;\n+import java.io.IOException;\n+\n+public class TestApiClientUtils {\n+\n+  private static final RetryConfig TEST_RETRY_CONFIG = RetryConfig.builder()\n+      .setMaxRetries(DEFAULT_RETRY_CONFIG.getMaxRetries())\n+      .setRetryStatusCodes(DEFAULT_RETRY_CONFIG.getRetryStatusCodes())\n+      .setMaxIntervalMillis(DEFAULT_RETRY_CONFIG.getMaxIntervalMillis())\n+      .setSleeper(new MockSleeper())\n+      .build();\n+\n+  private static final GenericUrl TEST_URL = new GenericUrl(\"https://firebase.google.com\");\n+\n+  /**\n+   * Creates a new {@code HttpRequestFactory} which provides authorization (OAuth2), timeouts and\n+   * automatic retries. Bypasses exponential backoff between consecutive retries for faster\n+   * execution during tests.\n+   *\n+   * @param app {@link FirebaseApp} from which to obtain authorization credentials.\n+   * @return A new {@code HttpRequestFactory} instance.\n+   */\n+  public static HttpRequestFactory delayBypassedRequestFactory(FirebaseApp app) {\n+    return ApiClientUtils.newAuthorizedRequestFactory(app, TEST_RETRY_CONFIG);\n+  }\n+\n+  /**\n+   * Creates a new {@code HttpRequestFactory} which provides authorization (OAuth2), timeouts but\n+   * no retries.\n+   *\n+   * @param app {@link FirebaseApp} from which to obtain authorization credentials.\n+   * @return A new {@code HttpRequestFactory} instance.\n+   */\n+  public static HttpRequestFactory retryDisabledRequestFactory(FirebaseApp app) {\n+    return ApiClientUtils.newAuthorizedRequestFactory(app, null);\n+  }\n+\n+  /**\n+   * Checks whther the given HttpRequestFactory has been configured for authorization and\n+   * automatic retries.\n+   *\n+   * @param requestFactory The HttpRequestFactory to check.\n+   */\n+  public static void assertAuthAndRetrySupport(HttpRequestFactory requestFactory) {\n+    assertTrue(requestFactory.getInitializer() instanceof FirebaseRequestInitializer);\n+    HttpRequest request;\n+    try {\n+      request = requestFactory.buildGetRequest(TEST_URL);\n+    } catch (IOException e) {\n+      throw new RuntimeException(\"Failed to initialize request\", e);\n+    }\n+\n+    // Verify authorization\n+    assertTrue(request.getHeaders().getAuthorization().startsWith(\"Bearer \"));\n+\n+    // Verify retry support\n+    HttpUnsuccessfulResponseHandler retryHandler = request.getUnsuccessfulResponseHandler();\n+    assertTrue(retryHandler instanceof RetryHandlerDecorator);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "666fa3cbd1412bfd0b4e3395433d72cbd49b2841"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTIxNDc3", "url": "https://github.com/firebase/firebase-admin-java/pull/356#pullrequestreview-355521477", "createdAt": "2020-02-08T01:58:10Z", "commit": {"oid": "666fa3cbd1412bfd0b4e3395433d72cbd49b2841"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2811, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}