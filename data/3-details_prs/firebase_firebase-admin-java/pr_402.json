{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExODIxMjk2", "number": 402, "title": "Add operation to update OIDC provider configs.", "bodyText": "This adds an operation to update OIDC provider configs (can be done using either the tenant-aware or standard Firebase client).\nThis work is part of adding multi-tenancy support (see issue #332).", "createdAt": "2020-04-30T20:34:30Z", "url": "https://github.com/firebase/firebase-admin-java/pull/402", "merged": true, "mergeCommit": {"oid": "ee98321d4156dde09644527a6d0aaedfc5e041f5"}, "closed": true, "closedAt": "2020-05-01T21:03:17Z", "author": {"login": "micahstairs"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccz9CDgH2gAyNDExODIxMjk2OjJkNjUwM2QxZmMyYzY5NjI4NzI3M2NhNTEyZDAxOGMzNGNmNTU0OGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcdILsdAFqTQwNDM5OTI1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2d6503d1fc2c696287273ca512d018c34cf5548e", "author": {"user": {"login": "micahstairs", "name": "Micah Stairs"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/2d6503d1fc2c696287273ca512d018c34cf5548e", "committedDate": "2020-04-30T21:27:47Z", "message": "Add operation to update OIDC provider configs."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3533e8e86a978eb036825898f7bf552fe7cff7e5", "author": {"user": {"login": "micahstairs", "name": "Micah Stairs"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/3533e8e86a978eb036825898f7bf552fe7cff7e5", "committedDate": "2020-04-30T20:32:57Z", "message": "Add operation to update OIDC provider configs."}, "afterCommit": {"oid": "2d6503d1fc2c696287273ca512d018c34cf5548e", "author": {"user": {"login": "micahstairs", "name": "Micah Stairs"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/2d6503d1fc2c696287273ca512d018c34cf5548e", "committedDate": "2020-04-30T21:27:47Z", "message": "Add operation to update OIDC provider configs."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzODkyNDU3", "url": "https://github.com/firebase/firebase-admin-java/pull/402#pullrequestreview-403892457", "createdAt": "2020-04-30T21:31:47Z", "commit": {"oid": "2d6503d1fc2c696287273ca512d018c34cf5548e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMTozMTo0OFrOGO7E2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMTozODo0NFrOGO7Q2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwMTE0NA==", "bodyText": "You will need to address this when implementing SAML config support.", "url": "https://github.com/firebase/firebase-admin-java/pull/402#discussion_r418301144", "createdAt": "2020-04-30T21:31:48Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/FirebaseUserManager.java", "diffHunk": "@@ -330,21 +322,45 @@ OidcProviderConfig createOidcProviderConfig(\n     return sendRequest(\"POST\", url, request.getProperties(), OidcProviderConfig.class);\n   }\n \n+  OidcProviderConfig updateOidcProviderConfig(OidcProviderConfig.UpdateRequest request)\n+      throws FirebaseAuthException {\n+    Map<String, Object> properties = request.getProperties();\n+    checkArgument(!properties.isEmpty(),\n+        \"provider config update must have at least one property set\");\n+    GenericUrl url =\n+        new GenericUrl(idpConfigMgtBaseUrl + getOidcUrlSuffix(request.getProviderId()));\n+    url.put(\"updateMask\", generateMask(properties));\n+    return sendRequest(\"PATCH\", url, properties, OidcProviderConfig.class);\n+  }\n+\n   OidcProviderConfig getOidcProviderConfig(String providerId) throws FirebaseAuthException {\n-    GenericUrl url = new GenericUrl(idpConfigMgtBaseUrl + \"/oauthIdpConfigs/\" + providerId);\n+    GenericUrl url = new GenericUrl(idpConfigMgtBaseUrl + getOidcUrlSuffix(providerId));\n     return sendRequest(\"GET\", url, null, OidcProviderConfig.class);\n   }\n \n   void deleteProviderConfig(String providerId) throws FirebaseAuthException {\n-    GenericUrl url = new GenericUrl(idpConfigMgtBaseUrl + \"/oauthIdpConfigs/\" + providerId);\n+    GenericUrl url = new GenericUrl(idpConfigMgtBaseUrl + getOidcUrlSuffix(providerId));\n     sendRequest(\"DELETE\", url, null, GenericJson.class);\n   }\n \n+  private static String generateMask(Map<String, Object> properties) {\n+    // This implementation does not currently handle the case of nested properties. This is fine", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d6503d1fc2c696287273ca512d018c34cf5548e"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwMzA0NA==", "bodyText": "Also test for empty/null client ID?", "url": "https://github.com/firebase/firebase-admin-java/pull/402#discussion_r418303044", "createdAt": "2020-04-30T21:36:00Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/auth/OidcProviderConfigTest.java", "diffHunk": "@@ -71,7 +71,41 @@ public void testCreateRequest() throws IOException {\n   }\n \n   @Test(expected = IllegalArgumentException.class)\n-  public void testInvalidIssuerUrl() {\n+  public void testCreateRequestInvalidIssuerUrl() {\n     new OidcProviderConfig.CreateRequest().setIssuer(\"not a valid url\");\n   }\n+\n+  @Test\n+  public void testUpdateRequestFromOidcProviderConfig() throws IOException {\n+    OidcProviderConfig config = jsonFactory.fromString(OIDC_JSON_STRING, OidcProviderConfig.class);\n+\n+    OidcProviderConfig.UpdateRequest updateRequest = config.updateRequest();\n+\n+    assertEquals(\"oidc.provider-id\", updateRequest.getProviderId());\n+    assertTrue(updateRequest.getProperties().isEmpty());\n+  }\n+\n+  @Test\n+  public void testUpdateRequest() throws IOException {\n+    OidcProviderConfig.UpdateRequest updateRequest =\n+        new OidcProviderConfig.UpdateRequest(\"oidc.provider-id\");\n+    updateRequest\n+      .setDisplayName(\"DISPLAY_NAME\")\n+      .setEnabled(false)\n+      .setClientId(\"CLIENT_ID\")\n+      .setIssuer(\"https://oidc.com/issuer\");\n+\n+    assertEquals(\"oidc.provider-id\", updateRequest.getProviderId());\n+    Map<String,Object> properties = updateRequest.getProperties();\n+    assertEquals(properties.size(), 4);\n+    assertEquals(\"DISPLAY_NAME\", (String) properties.get(\"displayName\"));\n+    assertFalse((boolean) properties.get(\"enabled\"));\n+    assertEquals(\"CLIENT_ID\", (String) properties.get(\"clientId\"));\n+    assertEquals(\"https://oidc.com/issuer\", (String) properties.get(\"issuer\"));\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testUpdateRequestInvalidIssuerUrl() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d6503d1fc2c696287273ca512d018c34cf5548e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwMzQ0Nw==", "bodyText": "assertEquals(1, parsed.size());", "url": "https://github.com/firebase/firebase-admin-java/pull/402#discussion_r418303447", "createdAt": "2020-04-30T21:36:56Z", "author": {"login": "hiranya911"}, "path": "src/test/java/com/google/firebase/auth/FirebaseUserManagerTest.java", "diffHunk": "@@ -1491,6 +1491,110 @@ public void testTenantAwareCreateOidcProvider() throws Exception {\n     checkUrl(interceptor, \"POST\", TENANTS_BASE_URL + \"/TENANT_ID/oauthIdpConfigs\");\n   }\n \n+  @Test\n+  public void testUpdateOidcProvider() throws Exception {\n+    TestResponseInterceptor interceptor = initializeAppForUserManagement(\n+        TestUtils.loadResource(\"oidc.json\"));\n+    OidcProviderConfig.UpdateRequest request =\n+        new OidcProviderConfig.UpdateRequest(\"oidc.provider-id\")\n+            .setDisplayName(\"DISPLAY_NAME\")\n+            .setEnabled(true)\n+            .setClientId(\"CLIENT_ID\")\n+            .setIssuer(\"https://oidc.com/issuer\");\n+\n+    OidcProviderConfig config = FirebaseAuth.getInstance().updateOidcProviderConfig(request);\n+\n+    checkOidcProviderConfig(config);\n+    checkRequestHeaders(interceptor);\n+    checkUrl(interceptor, \"PATCH\", PROJECT_BASE_URL + \"/oauthIdpConfigs/oidc.provider-id\");\n+    GenericUrl url = interceptor.getResponse().getRequest().getUrl();\n+    assertEquals(\"clientId,displayName,enabled,issuer\", url.getFirst(\"updateMask\"));\n+    GenericJson parsed = parseRequestContent(interceptor);\n+    assertEquals(\"DISPLAY_NAME\", parsed.get(\"displayName\"));\n+    assertTrue((boolean) parsed.get(\"enabled\"));\n+    assertEquals(\"CLIENT_ID\", parsed.get(\"clientId\"));\n+    assertEquals(\"https://oidc.com/issuer\", parsed.get(\"issuer\"));\n+  }\n+\n+  @Test\n+  public void testUpdateOidcProviderMinimal() throws Exception {\n+    TestResponseInterceptor interceptor = initializeAppForUserManagement(\n+        TestUtils.loadResource(\"oidc.json\"));\n+    OidcProviderConfig.UpdateRequest request =\n+        new OidcProviderConfig.UpdateRequest(\"oidc.provider-id\").setDisplayName(\"DISPLAY_NAME\");\n+\n+    OidcProviderConfig config = FirebaseAuth.getInstance().updateOidcProviderConfig(request);\n+\n+    checkOidcProviderConfig(config);\n+    checkRequestHeaders(interceptor);\n+    checkUrl(interceptor, \"PATCH\", PROJECT_BASE_URL + \"/oauthIdpConfigs/oidc.provider-id\");\n+    GenericUrl url = interceptor.getResponse().getRequest().getUrl();\n+    assertEquals(\"displayName\", url.getFirst(\"updateMask\"));\n+    GenericJson parsed = parseRequestContent(interceptor);\n+    assertEquals(\"DISPLAY_NAME\", parsed.get(\"displayName\"));\n+    assertNull(parsed.get(\"enabled\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d6503d1fc2c696287273ca512d018c34cf5548e"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMwNDIxNw==", "bodyText": "check not null or empty", "url": "https://github.com/firebase/firebase-admin-java/pull/402#discussion_r418304217", "createdAt": "2020-04-30T21:38:44Z", "author": {"login": "hiranya911"}, "path": "src/main/java/com/google/firebase/auth/ProviderConfig.java", "diffHunk": "@@ -104,4 +104,48 @@ public T setEnabled(boolean enabled) {\n \n     abstract T getThis();\n   }\n+\n+  /**\n+   * A base class for updating the attributes of an existing provider.\n+   */\n+  public abstract static class AbstractUpdateRequest<T extends AbstractUpdateRequest<T>> {\n+\n+    final String providerId;\n+    final Map<String,Object> properties = new HashMap<>();\n+\n+    AbstractUpdateRequest(String providerId) {\n+      this.providerId = providerId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d6503d1fc2c696287273ca512d018c34cf5548e"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "952e3c96881cbd42469bce13f593df4ff535db45", "author": {"user": {"login": "micahstairs", "name": "Micah Stairs"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/952e3c96881cbd42469bce13f593df4ff535db45", "committedDate": "2020-05-01T02:06:43Z", "message": "Address pull request feedback."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MzI3NDA3", "url": "https://github.com/firebase/firebase-admin-java/pull/402#pullrequestreview-404327407", "createdAt": "2020-05-01T18:37:56Z", "commit": {"oid": "952e3c96881cbd42469bce13f593df4ff535db45"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "934a44575372e28cfd85e4255d552faf4b2ba447", "author": {"user": {"login": "micahstairs", "name": "Micah Stairs"}}, "url": "https://github.com/firebase/firebase-admin-java/commit/934a44575372e28cfd85e4255d552faf4b2ba447", "committedDate": "2020-05-01T21:00:10Z", "message": "Add units test to make sure an exception is thrown when the client ID is missing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0Mzk5MjU0", "url": "https://github.com/firebase/firebase-admin-java/pull/402#pullrequestreview-404399254", "createdAt": "2020-05-01T21:01:55Z", "commit": {"oid": "934a44575372e28cfd85e4255d552faf4b2ba447"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2860, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}