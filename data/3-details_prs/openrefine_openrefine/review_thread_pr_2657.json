{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1NTAwNTI5", "number": 2657, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQxOTo1MDo0MlrOEBImVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyMToxNVrOEC3Mjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NjI0OTE5OnYy", "diffSide": "RIGHT", "path": "main/src/com/google/refine/io/ProjectMetadataUtilities.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQxOTo1MDo0MlrOGc1BfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQyMToxNDozNlrOGfYHWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4MjA0NA==", "bodyText": "There is no reason for recon candidates to end up in the project metadata, so both writers are equivalent. Perhaps we could use saveWriter because we are saving things to disk, but it is a style change.", "url": "https://github.com/OpenRefine/OpenRefine/pull/2657#discussion_r432882044", "createdAt": "2020-05-30T19:50:42Z", "author": {"login": "wetneb"}, "path": "main/src/com/google/refine/io/ProjectMetadataUtilities.java", "diffHunk": "@@ -60,25 +61,35 @@\n     public static void save(ProjectMetadata projectMeta, File projectDir) throws IOException  {\n         File tempFile = new File(projectDir, \"metadata.temp.json\");\n         saveToFile(projectMeta, tempFile);\n+        if (tempFile.length() == 0) {\n+            throw new IOException(\"Failed to save project metadata - keeping backups\");\n+        }\n+\n+        // TODO Do we want to make sure we can successfully deserialize the file too?\n \n         File file = new File(projectDir, \"metadata.json\");\n         File oldFile = new File(projectDir, \"metadata.old.json\");\n \n-        if (oldFile.exists()) {\n-            oldFile.delete();\n-        }\n-        \n         if (file.exists()) {\n+            if(file.length() > 0) {\n+                if (oldFile.exists()) {\n+                    oldFile.delete();\n+                }\n             file.renameTo(oldFile);\n+            } else {\n+                file.delete();\n+            }\n         }\n \n         tempFile.renameTo(file);\n     }\n     \n     protected static void saveToFile(ProjectMetadata projectMeta, File metadataFile) throws IOException   {\n-        Writer writer = new OutputStreamWriter(new FileOutputStream(metadataFile));\n+        Writer writer = new OutputStreamWriter(new FileOutputStream(metadataFile), StandardCharsets.UTF_8);\n         try {\n             ParsingUtilities.defaultWriter.writeValue(writer, projectMeta);\n+            // TODO: Do we want the below instead? Doesn't filter recon candidates\n+//            ParsingUtilities.saveWriter.writeValue(writer, projectMeta);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cc4df2ba4bf3269ac3a99539ab74de499e58d57"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU1NDEzNw==", "bodyText": "I switched to saveWriter", "url": "https://github.com/OpenRefine/OpenRefine/pull/2657#discussion_r435554137", "createdAt": "2020-06-04T21:14:36Z", "author": {"login": "tfmorris"}, "path": "main/src/com/google/refine/io/ProjectMetadataUtilities.java", "diffHunk": "@@ -60,25 +61,35 @@\n     public static void save(ProjectMetadata projectMeta, File projectDir) throws IOException  {\n         File tempFile = new File(projectDir, \"metadata.temp.json\");\n         saveToFile(projectMeta, tempFile);\n+        if (tempFile.length() == 0) {\n+            throw new IOException(\"Failed to save project metadata - keeping backups\");\n+        }\n+\n+        // TODO Do we want to make sure we can successfully deserialize the file too?\n \n         File file = new File(projectDir, \"metadata.json\");\n         File oldFile = new File(projectDir, \"metadata.old.json\");\n \n-        if (oldFile.exists()) {\n-            oldFile.delete();\n-        }\n-        \n         if (file.exists()) {\n+            if(file.length() > 0) {\n+                if (oldFile.exists()) {\n+                    oldFile.delete();\n+                }\n             file.renameTo(oldFile);\n+            } else {\n+                file.delete();\n+            }\n         }\n \n         tempFile.renameTo(file);\n     }\n     \n     protected static void saveToFile(ProjectMetadata projectMeta, File metadataFile) throws IOException   {\n-        Writer writer = new OutputStreamWriter(new FileOutputStream(metadataFile));\n+        Writer writer = new OutputStreamWriter(new FileOutputStream(metadataFile), StandardCharsets.UTF_8);\n         try {\n             ParsingUtilities.defaultWriter.writeValue(writer, projectMeta);\n+            // TODO: Do we want the below instead? Doesn't filter recon candidates\n+//            ParsingUtilities.saveWriter.writeValue(writer, projectMeta);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4MjA0NA=="}, "originalCommit": {"oid": "9cc4df2ba4bf3269ac3a99539ab74de499e58d57"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5NjI0OTg2OnYy", "diffSide": "RIGHT", "path": "main/src/com/google/refine/io/ProjectMetadataUtilities.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQxOTo1MjoxMVrOGc1B3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMFQyMDo1NTozOVrOGc1TWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4MjE0MA==", "bodyText": "Perhaps we could look into making the deserializer more flexible with respect to encoding issues (just like it can be configured to accept unescaped tabs)? I have not checked if it is possible though.", "url": "https://github.com/OpenRefine/OpenRefine/pull/2657#discussion_r432882140", "createdAt": "2020-05-30T19:52:11Z", "author": {"login": "wetneb"}, "path": "main/src/com/google/refine/io/ProjectMetadataUtilities.java", "diffHunk": "@@ -60,25 +61,35 @@\n     public static void save(ProjectMetadata projectMeta, File projectDir) throws IOException  {\n         File tempFile = new File(projectDir, \"metadata.temp.json\");\n         saveToFile(projectMeta, tempFile);\n+        if (tempFile.length() == 0) {\n+            throw new IOException(\"Failed to save project metadata - keeping backups\");\n+        }\n+\n+        // TODO Do we want to make sure we can successfully deserialize the file too?\n \n         File file = new File(projectDir, \"metadata.json\");\n         File oldFile = new File(projectDir, \"metadata.old.json\");\n \n-        if (oldFile.exists()) {\n-            oldFile.delete();\n-        }\n-        \n         if (file.exists()) {\n+            if(file.length() > 0) {\n+                if (oldFile.exists()) {\n+                    oldFile.delete();\n+                }\n             file.renameTo(oldFile);\n+            } else {\n+                file.delete();\n+            }\n         }\n \n         tempFile.renameTo(file);\n     }\n     \n     protected static void saveToFile(ProjectMetadata projectMeta, File metadataFile) throws IOException   {\n-        Writer writer = new OutputStreamWriter(new FileOutputStream(metadataFile));\n+        Writer writer = new OutputStreamWriter(new FileOutputStream(metadataFile), StandardCharsets.UTF_8);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cc4df2ba4bf3269ac3a99539ab74de499e58d57"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4NjYxNw==", "bodyText": "Jackson does it's own encoding guessing, but it's got to be one of the JSON legal encodings (UTF-8, 16, 32). The ASCII is legal UTF-8, but the upper half of ISO 8859-1 isn't, which is where, I suspect, the problem comes in.", "url": "https://github.com/OpenRefine/OpenRefine/pull/2657#discussion_r432886617", "createdAt": "2020-05-30T20:55:39Z", "author": {"login": "tfmorris"}, "path": "main/src/com/google/refine/io/ProjectMetadataUtilities.java", "diffHunk": "@@ -60,25 +61,35 @@\n     public static void save(ProjectMetadata projectMeta, File projectDir) throws IOException  {\n         File tempFile = new File(projectDir, \"metadata.temp.json\");\n         saveToFile(projectMeta, tempFile);\n+        if (tempFile.length() == 0) {\n+            throw new IOException(\"Failed to save project metadata - keeping backups\");\n+        }\n+\n+        // TODO Do we want to make sure we can successfully deserialize the file too?\n \n         File file = new File(projectDir, \"metadata.json\");\n         File oldFile = new File(projectDir, \"metadata.old.json\");\n \n-        if (oldFile.exists()) {\n-            oldFile.delete();\n-        }\n-        \n         if (file.exists()) {\n+            if(file.length() > 0) {\n+                if (oldFile.exists()) {\n+                    oldFile.delete();\n+                }\n             file.renameTo(oldFile);\n+            } else {\n+                file.delete();\n+            }\n         }\n \n         tempFile.renameTo(file);\n     }\n     \n     protected static void saveToFile(ProjectMetadata projectMeta, File metadataFile) throws IOException   {\n-        Writer writer = new OutputStreamWriter(new FileOutputStream(metadataFile));\n+        Writer writer = new OutputStreamWriter(new FileOutputStream(metadataFile), StandardCharsets.UTF_8);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjg4MjE0MA=="}, "originalCommit": {"oid": "9cc4df2ba4bf3269ac3a99539ab74de499e58d57"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDM2OTQzOnYy", "diffSide": "RIGHT", "path": "pom.xml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyMToxNVrOGfk92g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzoyMTo1MlrOGf23sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NDY5OA==", "bodyText": "I guess we should ideally be able to apply this only for specific tests, no? I am not sure how that could be done, though. I am trying to think about the risks we are taking by switching to this encoding everywhere. Intuitively it should help us surface more bugs rather than hide ones which would only happen if the system encoding is UTF-8, so it is probably fine?", "url": "https://github.com/OpenRefine/OpenRefine/pull/2657#discussion_r435764698", "createdAt": "2020-06-05T08:21:15Z", "author": {"login": "wetneb"}, "path": "pom.xml", "diffHunk": "@@ -57,7 +57,7 @@\n     <jee.port>3333</jee.port>\n     <refine.data>/tmp/refine</refine.data>\n     <surefire.version>2.22.2</surefire.version>\n-    <surefireArgs></surefireArgs>\n+    <surefireArgs>-Dfile.encoding=cp1252</surefireArgs>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a84c8487271d5fb8e2fe60ee320cafcd8a605d4a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA1ODAzMg==", "bodyText": "That was my thinking. We assume/need UTF-8 generally, but our most popular platform doesn't use that as its default encoding, so neither should our tests. I think all tests should be run with this setting.", "url": "https://github.com/OpenRefine/OpenRefine/pull/2657#discussion_r436058032", "createdAt": "2020-06-05T17:21:52Z", "author": {"login": "tfmorris"}, "path": "pom.xml", "diffHunk": "@@ -57,7 +57,7 @@\n     <jee.port>3333</jee.port>\n     <refine.data>/tmp/refine</refine.data>\n     <surefire.version>2.22.2</surefire.version>\n-    <surefireArgs></surefireArgs>\n+    <surefireArgs>-Dfile.encoding=cp1252</surefireArgs>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NDY5OA=="}, "originalCommit": {"oid": "a84c8487271d5fb8e2fe60ee320cafcd8a605d4a"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2677, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}