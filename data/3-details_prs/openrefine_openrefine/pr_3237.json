{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1ODk0MDE2", "number": 3237, "title": "Refactor HTTP code into common module & Improve Fetch URL  - fixes #3129", "bodyText": "Fixes #3129.\nMakes the following improvements to the Fetch URL code:\n\nswitches to Apache HTTP Client 5.0.2 including support for HTTP/2 as well as automatic retries and other general improvements\nreuses HTTP client across requests for the entire operation rather than rebuilding it for every request to improve connection reuse and not pay connection setup cost every time (especially bad for HTTPS)\nhonors Retry-After header (built-in support), but if none specified uses binary exponential backup (default is single retry at 1 sec.)\ncomputes interrequest delay using a request interceptor\n\nBecause the namespace was changed, the new client can coexist with the old client, but we should probably abstract this out into a reusable class that can be reused by project creation, reconciliation, etc.\nI went ahead and split things out into their own reusable class and extended it to support POSTs as well as GETs so that it could be used for reconciliation too.", "createdAt": "2020-10-01T01:46:07Z", "url": "https://github.com/OpenRefine/OpenRefine/pull/3237", "merged": true, "mergeCommit": {"oid": "14f43dc2cccab09eacf5d9771110cf08e579d82b"}, "closed": true, "closedAt": "2020-12-07T05:38:37Z", "author": {"login": "tfmorris"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWv4gxABqjM5MjgyODI3OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdjurcOABqjQwNzc3NTE0Nzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d1d81c2d05fe443523682e82c2ec155c6fbace4", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/4d1d81c2d05fe443523682e82c2ec155c6fbace4", "committedDate": "2020-10-01T01:51:21Z", "message": "Update to Apache HTTP client 5.0.2"}, "afterCommit": {"oid": "0cf54c40dd3c324dc84e05970a0ee5d9fd901c99", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/0cf54c40dd3c324dc84e05970a0ee5d9fd901c99", "committedDate": "2020-10-27T21:29:51Z", "message": "Update to Apache HTTP client 5.0.2"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0cf54c40dd3c324dc84e05970a0ee5d9fd901c99", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/0cf54c40dd3c324dc84e05970a0ee5d9fd901c99", "committedDate": "2020-10-27T21:29:51Z", "message": "Update to Apache HTTP client 5.0.2"}, "afterCommit": {"oid": "80807859645dddc622fe9a50138e33c9acc1eac5", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/80807859645dddc622fe9a50138e33c9acc1eac5", "committedDate": "2020-11-03T22:50:43Z", "message": "Update to Apache HTTP client 5.0.2"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80807859645dddc622fe9a50138e33c9acc1eac5", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/80807859645dddc622fe9a50138e33c9acc1eac5", "committedDate": "2020-11-03T22:50:43Z", "message": "Update to Apache HTTP client 5.0.2"}, "afterCommit": {"oid": "9ab40f7ca254f8944ec9a8e8a1d33c853c8644b8", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/9ab40f7ca254f8944ec9a8e8a1d33c853c8644b8", "committedDate": "2020-11-14T20:57:11Z", "message": "Refactor HTTP code into a common utility class\n\nCentralizes the six (slightly) different implementations to use\na common Apache HTTP Client 5 implementation which implements our\nstrategies for retries, timeouts, error handling, etc."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ab40f7ca254f8944ec9a8e8a1d33c853c8644b8", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/9ab40f7ca254f8944ec9a8e8a1d33c853c8644b8", "committedDate": "2020-11-14T20:57:11Z", "message": "Refactor HTTP code into a common utility class\n\nCentralizes the six (slightly) different implementations to use\na common Apache HTTP Client 5 implementation which implements our\nstrategies for retries, timeouts, error handling, etc."}, "afterCommit": {"oid": "4d87b55015492962228704f3f36542bcaf87c52a", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/4d87b55015492962228704f3f36542bcaf87c52a", "committedDate": "2020-11-14T21:24:28Z", "message": "Refactor HTTP code into a common utility class\n\nCentralizes the six (slightly) different implementations to use\na common Apache HTTP Client 5 implementation which implements our\nstrategies for retries, timeouts, error handling, etc."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyNzQ5NTE4", "url": "https://github.com/OpenRefine/OpenRefine/pull/3237#pullrequestreview-532749518", "createdAt": "2020-11-17T19:41:38Z", "commit": {"oid": "52e9756988392572780508a84f6d2c1698176915"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0MTozOFrOH1GeOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxOTo0Mjo0M1rOH1GjUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ0MjYxOA==", "bodyText": "I would leave this comment since this refactoring does not address this yet.", "url": "https://github.com/OpenRefine/OpenRefine/pull/3237#discussion_r525442618", "createdAt": "2020-11-17T19:41:38Z", "author": {"login": "wetneb"}, "path": "main/src/com/google/refine/model/recon/ReconciledDataExtensionJob.java", "diffHunk": "@@ -218,46 +203,17 @@ public ReconciledDataExtensionJob(DataExtensionConfig obj, String endpoint) {\n         return map;\n     }\n \n-    /**\n-     * @todo this should be refactored to be unified with the HTTP querying code\n-     * from StandardReconConfig. We should ideally extract a library to query\n-     * reconciliation services and expose it as such for others to reuse.\n-     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52e9756988392572780508a84f6d2c1698176915"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTQ0MzkyMA==", "bodyText": "I'd also leave this TODO since error reporting should not be in the server logs: users should be notified about it.", "url": "https://github.com/OpenRefine/OpenRefine/pull/3237#discussion_r525443920", "createdAt": "2020-11-17T19:42:43Z", "author": {"login": "wetneb"}, "path": "main/src/com/google/refine/model/recon/StandardReconConfig.java", "diffHunk": "@@ -475,51 +463,40 @@ private CloseableHttpClient getHttpClient() {\n         stringWriter.write(\"}\");\n         String queriesString = stringWriter.toString();\n         \n-        HttpPost request = new HttpPost(service);\n-        List<NameValuePair> body = Collections.singletonList(\n-                new BasicNameValuePair(\"queries\", queriesString));\n-        request.setEntity(new UrlEncodedFormEntity(body, Consts.UTF_8));\n-        \n-        try (CloseableHttpResponse response = getHttpClient().execute(request)) {\n-            StatusLine statusLine = response.getStatusLine();\n-            if (statusLine.getStatusCode() >= 400) {\n-                logger.error(\"Failed  - code: \"\n-                        + Integer.toString(statusLine.getStatusCode())\n-                        + \" message: \" + statusLine.getReasonPhrase());\n+        try {\n+            String responseString = postQueries(service, queriesString);\n+            ObjectNode o = ParsingUtilities.evaluateJsonStringToObjectNode(responseString);\n+\n+            if (o == null) { // utility method returns null instead of throwing\n+                logger.error(\"Failed to parse string as JSON: \" + responseString);\n             } else {\n-                String s = ParsingUtilities.inputStreamToString(response.getEntity().getContent());\n-                ObjectNode o = ParsingUtilities.evaluateJsonStringToObjectNode(s);\n-                if (o == null) { // utility method returns null instead of throwing\n-                    logger.error(\"Failed to parse string as JSON: \" + s);\n-                } else {\n-                    for (int i = 0; i < jobs.size(); i++) {\n-                        StandardReconJob job = (StandardReconJob) jobs.get(i);\n-                        Recon recon = null;\n-\n-                        String text = job.text;\n-                        String key = \"q\" + i;\n-                        if (o.has(key) && o.get(key) instanceof ObjectNode) {\n-                            ObjectNode o2 = (ObjectNode) o.get(key);\n-                            if (o2.has(\"result\") && o2.get(\"result\") instanceof ArrayNode) {\n-                                ArrayNode results = (ArrayNode) o2.get(\"result\");\n-\n-                                recon = createReconServiceResults(text, results, historyEntryID);\n-                            } else {\n-                                logger.warn(\"Service error for text: \" + text + \"\\n  Job code: \" + job.code + \"\\n  Response: \" + o2.toString());\n-                            }\n+                for (int i = 0; i < jobs.size(); i++) {\n+                    StandardReconJob job = (StandardReconJob) jobs.get(i);\n+                    Recon recon = null;\n+\n+                    String text = job.text;\n+                    String key = \"q\" + i;\n+                    if (o.has(key) && o.get(key) instanceof ObjectNode) {\n+                        ObjectNode o2 = (ObjectNode) o.get(key);\n+                        if (o2.has(\"result\") && o2.get(\"result\") instanceof ArrayNode) {\n+                            ArrayNode results = (ArrayNode) o2.get(\"result\");\n+\n+                            recon = createReconServiceResults(text, results, historyEntryID);\n                         } else {\n-                            // TODO: better error reporting", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52e9756988392572780508a84f6d2c1698176915"}, "originalPosition": 143}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bce3292ec3753cfd504fcddc9b86868dba34787d", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/bce3292ec3753cfd504fcddc9b86868dba34787d", "committedDate": "2020-12-07T05:27:28Z", "message": "Update to Apache HTTP Client 5.x\n\nAdds support for Retry-After headers, HTTP/2, and a bunch of\nother stuff under the covers, but this is a straight 1:1\nreplacement without any functional changes unless provided\nby the default settings."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2eceb3c401a54598be5ac9b8536ecb501bab1d91", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/2eceb3c401a54598be5ac9b8536ecb501bab1d91", "committedDate": "2020-12-07T05:27:29Z", "message": "Add error checking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0146fd395bb426f02979cd9fde7ac2ccb77dcab", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/f0146fd395bb426f02979cd9fde7ac2ccb77dcab", "committedDate": "2020-12-07T05:27:29Z", "message": "Fix request delay calculation & add more retries\n\nMoves request delay to a request interceptor and fixes calculation\nof the delay (again).\n\nIncrease retries from 1x to 3x and use delay*2 as the default\nretry interval, if no Retry-After header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c5cff6790b0ac1a28f454b954378df9ecb86123", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/4c5cff6790b0ac1a28f454b954378df9ecb86123", "committedDate": "2020-12-07T05:27:29Z", "message": "Reuse HTTP client across requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5af1ecd04b14d0cfbfe1f8e5d7df42d013ee390c", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/5af1ecd04b14d0cfbfe1f8e5d7df42d013ee390c", "committedDate": "2020-12-07T05:27:29Z", "message": "Add test for retries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80ba0fc670a438b4f5ed85519dcceb8c4bd3f137", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/80ba0fc670a438b4f5ed85519dcceb8c4bd3f137", "committedDate": "2020-12-07T05:27:29Z", "message": "Add exponential backup retry strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7223fc50d18e3b3bc28bd07b0601f01ade2c259f", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/7223fc50d18e3b3bc28bd07b0601f01ade2c259f", "committedDate": "2020-12-07T05:27:29Z", "message": "Use IOException instead of Exception for HTTP errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd5d4454afc38a3206ab6983c0cf1c29a066bfca", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/fd5d4454afc38a3206ab6983c0cf1c29a066bfca", "committedDate": "2020-12-07T05:27:29Z", "message": "Refactor HTTP code into a common utility class\n\nCentralizes the six (slightly) different implementations to use\na common Apache HTTP Client 5 implementation which implements our\nstrategies for retries, timeouts, error handling, etc."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4285d372ddad7d31d3f424f9541ff410fcd24ee0", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/4285d372ddad7d31d3f424f9541ff410fcd24ee0", "committedDate": "2020-11-29T01:53:36Z", "message": "Add an additional TODO"}, "afterCommit": {"oid": "fd5d4454afc38a3206ab6983c0cf1c29a066bfca", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/fd5d4454afc38a3206ab6983c0cf1c29a066bfca", "committedDate": "2020-12-07T05:27:29Z", "message": "Refactor HTTP code into a common utility class\n\nCentralizes the six (slightly) different implementations to use\na common Apache HTTP Client 5 implementation which implements our\nstrategies for retries, timeouts, error handling, etc."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3435, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}