{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MDY4OTgy", "number": 2870, "title": "Report HTTP error codes to the user when creating a project from a URL", "bodyText": "Fixes #2837", "createdAt": "2020-07-03T13:50:31Z", "url": "https://github.com/OpenRefine/OpenRefine/pull/2870", "merged": true, "mergeCommit": {"oid": "f62f63706c96d40e9de489a5a5f8a26787fb2eca"}, "closed": true, "closedAt": "2020-07-07T09:58:48Z", "author": {"login": "urvashigupta7"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxUUeNAFqTQ0MjQ0ODY1MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyi1IVAFqTQ0Mzc0MTI0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNDQ4NjUw", "url": "https://github.com/OpenRefine/OpenRefine/pull/2870#pullrequestreview-442448650", "createdAt": "2020-07-03T14:28:50Z", "commit": {"oid": "fae348ede51bf53a6bc22be2b3be001327af2d40"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fae348ede51bf53a6bc22be2b3be001327af2d40", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/fae348ede51bf53a6bc22be2b3be001327af2d40", "committedDate": "2020-07-03T13:48:31Z", "message": "HTTP Error"}, "afterCommit": {"oid": "c5bb7e116425065f61c98163a725e80cc57ac7b5", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/c5bb7e116425065f61c98163a725e80cc57ac7b5", "committedDate": "2020-07-03T15:16:25Z", "message": "HTTP Error"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c5bb7e116425065f61c98163a725e80cc57ac7b5", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/c5bb7e116425065f61c98163a725e80cc57ac7b5", "committedDate": "2020-07-03T15:16:25Z", "message": "HTTP Error"}, "afterCommit": {"oid": "ed4af84806826087ad582420f6e765d8f9704c8f", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/ed4af84806826087ad582420f6e765d8f9704c8f", "committedDate": "2020-07-03T15:31:14Z", "message": "HTTP Error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a6fc90f02559944cacbbe926b19d363db892086", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/3a6fc90f02559944cacbbe926b19d363db892086", "committedDate": "2020-07-03T16:22:05Z", "message": "HTTP Error"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed4af84806826087ad582420f6e765d8f9704c8f", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/ed4af84806826087ad582420f6e765d8f9704c8f", "committedDate": "2020-07-03T15:31:14Z", "message": "HTTP Error"}, "afterCommit": {"oid": "3a6fc90f02559944cacbbe926b19d363db892086", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/3a6fc90f02559944cacbbe926b19d363db892086", "committedDate": "2020-07-03T16:22:05Z", "message": "HTTP Error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNTU3NTg4", "url": "https://github.com/OpenRefine/OpenRefine/pull/2870#pullrequestreview-442557588", "createdAt": "2020-07-03T20:52:58Z", "commit": {"oid": "3a6fc90f02559944cacbbe926b19d363db892086"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QyMDo1NTozNFrOGs3ppg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QyMDo1NzowMlrOGs3qZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcwMjMxMA==", "bodyText": "The standard way to do this is to consider anything greater or equal to 400 to be an error.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        if (statusCode / 100 != 2) {\n          \n          \n            \n                                        if (statusCode >= 400) {", "url": "https://github.com/OpenRefine/OpenRefine/pull/2870#discussion_r449702310", "createdAt": "2020-07-03T20:55:34Z", "author": {"login": "tfmorris"}, "path": "main/src/com/google/refine/importing/ImportingUtilities.java", "diffHunk": "@@ -309,11 +310,18 @@ public void update(long bytesRead, long contentLength, int itemCount) {\n                         CloseableHttpResponse response = httpclient.execute(httpGet);\n \n                         try {\n-                            response.getStatusLine();\n+                            StatusLine status = response.getStatusLine();\n                             HttpEntity entity = response.getEntity();\n                             if (entity == null) {\n                                 throw new Exception(\"No content found in \" + url.toString());\n                             }\n+                            int statusCode = response.getStatusLine().getStatusCode();\n+                            if (statusCode / 100 != 2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a6fc90f02559944cacbbe926b19d363db892086"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTcwMjUwMg==", "bodyText": "It would be tidier to put this with the rest of the status processing code below.", "url": "https://github.com/OpenRefine/OpenRefine/pull/2870#discussion_r449702502", "createdAt": "2020-07-03T20:57:02Z", "author": {"login": "tfmorris"}, "path": "main/src/com/google/refine/importing/ImportingUtilities.java", "diffHunk": "@@ -309,11 +310,18 @@ public void update(long bytesRead, long contentLength, int itemCount) {\n                         CloseableHttpResponse response = httpclient.execute(httpGet);\n \n                         try {\n-                            response.getStatusLine();\n+                            StatusLine status = response.getStatusLine();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a6fc90f02559944cacbbe926b19d363db892086"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f1d13bd83b22362e470655b49e4ef864703c1425", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/f1d13bd83b22362e470655b49e4ef864703c1425", "committedDate": "2020-07-06T09:35:35Z", "message": "test"}, "afterCommit": {"oid": "c10acbfbf9fbbbf94ac844c054b8f1f72b17b437", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/c10acbfbf9fbbbf94ac844c054b8f1f72b17b437", "committedDate": "2020-07-06T09:36:46Z", "message": "add test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c10acbfbf9fbbbf94ac844c054b8f1f72b17b437", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/c10acbfbf9fbbbf94ac844c054b8f1f72b17b437", "committedDate": "2020-07-06T09:36:46Z", "message": "add test"}, "afterCommit": {"oid": "51688c588eb16c05df8d5a5816f59f0cc45fc777", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/51688c588eb16c05df8d5a5816f59f0cc45fc777", "committedDate": "2020-07-06T09:39:41Z", "message": "add test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3bf83f20f14c9edb1ceb2f9900e50fdf11c5ba06", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/3bf83f20f14c9edb1ceb2f9900e50fdf11c5ba06", "committedDate": "2020-07-06T15:27:03Z", "message": "Merge branch 'HTTP-Error' of https://github.com/urvashigupta7/OpenRefine into HTTP-Error"}, "afterCommit": {"oid": "fb34f64463dda97baaefc23056ccbe9c99c0758c", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/fb34f64463dda97baaefc23056ccbe9c99c0758c", "committedDate": "2020-07-06T17:23:06Z", "message": "urlImportingTestCompleted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb34f64463dda97baaefc23056ccbe9c99c0758c", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/fb34f64463dda97baaefc23056ccbe9c99c0758c", "committedDate": "2020-07-06T17:23:06Z", "message": "urlImportingTestCompleted"}, "afterCommit": {"oid": "f16335343fbe1162c36eca708f7a6d77a736ae90", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/f16335343fbe1162c36eca708f7a6d77a736ae90", "committedDate": "2020-07-06T17:28:12Z", "message": "urlImportingTestCompleted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMjk3NTI2", "url": "https://github.com/OpenRefine/OpenRefine/pull/2870#pullrequestreview-443297526", "createdAt": "2020-07-06T18:02:56Z", "commit": {"oid": "ce2152639643a5aa44df5896b34795820c300023"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxODowMjo1NlrOGthwPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxODowNDowNlrOGthyiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM5MjEyNA==", "bodyText": "If no exception is thrown, this test will pass because the Assert will not be executed at all. A better way to assert that exceptions are thrown is to remove the try/catch block and to add the exception class in the @Test annotation as @Test(expectedExceptions = Exception.class)", "url": "https://github.com/OpenRefine/OpenRefine/pull/2870#discussion_r450392124", "createdAt": "2020-07-06T18:02:56Z", "author": {"login": "wetneb"}, "path": "main/tests/server/src/com/google/refine/importing/ImportingUtilitiesTests.java", "diffHunk": "@@ -82,4 +95,75 @@ private ObjectNode getNestedOptions(ImportingJob job, TreeImportingParserBase pa\n         JSONUtilities.safePut(options, \"recordPath\", path);\n         return options;\n     }\n+\n+    private static String RESPONSE_BODY = \"{\\\"code\\\":401,\" + \"\\\"message\\\":\\\"Unauthorised\\\"\" + \"}\";\n+    private final static String MESSAGE = String.format(\"HTTP error %d : %s | %s\", 401,\n+            \"Client Error\", RESPONSE_BODY);\n+\n+    @Test\n+    public void urlImporting() {\n+\n+        try {\n+            MockWebServer server = new MockWebServer();\n+            MockResponse mockResponse = new MockResponse();\n+            mockResponse.setBody(RESPONSE_BODY);\n+            mockResponse.setResponseCode(401);\n+            server.start();\n+            server.enqueue(mockResponse);\n+            HttpUrl url = server.url(\"/random\");\n+\n+            MultipartEntityBuilder builder = MultipartEntityBuilder.create();\n+            StringBody stringBody = new StringBody(url.toString(), ContentType.MULTIPART_FORM_DATA);\n+            builder = builder.addPart(\"download\", stringBody);\n+            HttpEntity entity = builder.build();\n+\n+            ByteArrayOutputStream os = new ByteArrayOutputStream();\n+            entity.writeTo(os);\n+            ByteArrayInputStream is = new ByteArrayInputStream(os.toByteArray());\n+\n+            HttpServletRequest req = Mockito.mock(HttpServletRequest.class);\n+            when(req.getContentType()).thenReturn(entity.getContentType().getValue());\n+            when(req.getParameter(\"download\")).thenReturn(url.toString());\n+            when(req.getMethod()).thenReturn(\"POST\");\n+            when(req.getContentLength()).thenReturn((int) entity.getContentLength());\n+            when(req.getInputStream()).thenReturn(new MockServletInputStream(is));\n+\n+\n+            ImportingJob job = ImportingManager.createJob();\n+            Properties parameters = ParsingUtilities.parseUrlParameters(req);\n+            ObjectNode retrievalRecord = ParsingUtilities.mapper.createObjectNode();\n+            ObjectNode progress = ParsingUtilities.mapper.createObjectNode();\n+            ImportingUtilities.retrieveContentFromPostRequest(req, parameters, job.getRawDataDir(), retrievalRecord, new ImportingUtilities.Progress() {\n+                @Override\n+                public void setProgress(String message, int percent) {\n+                    if (message != null) {\n+                        JSONUtilities.safePut(progress, \"message\", message);\n+                    }\n+                    JSONUtilities.safePut(progress, \"percent\", percent);\n+                }\n+\n+                @Override\n+                public boolean isCanceled() {\n+                    return job.canceled;\n+                }\n+            });\n+        } catch (Exception exception) {\n+            Assert.assertEquals(MESSAGE, exception.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce2152639643a5aa44df5896b34795820c300023"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM5MjcxMg==", "bodyText": "Since both of these variables are only used in the test below, I would just define them there. If they really need to be declared as static attributes, then they should go at the beginning of the test class. Also I would remove the + concatenation operators and just declare RESPONSE_BODY as a single string.", "url": "https://github.com/OpenRefine/OpenRefine/pull/2870#discussion_r450392712", "createdAt": "2020-07-06T18:04:06Z", "author": {"login": "wetneb"}, "path": "main/tests/server/src/com/google/refine/importing/ImportingUtilitiesTests.java", "diffHunk": "@@ -82,4 +95,75 @@ private ObjectNode getNestedOptions(ImportingJob job, TreeImportingParserBase pa\n         JSONUtilities.safePut(options, \"recordPath\", path);\n         return options;\n     }\n+\n+    private static String RESPONSE_BODY = \"{\\\"code\\\":401,\" + \"\\\"message\\\":\\\"Unauthorised\\\"\" + \"}\";\n+    private final static String MESSAGE = String.format(\"HTTP error %d : %s | %s\", 401,\n+            \"Client Error\", RESPONSE_BODY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce2152639643a5aa44df5896b34795820c300023"}, "originalPosition": 40}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce2152639643a5aa44df5896b34795820c300023", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/ce2152639643a5aa44df5896b34795820c300023", "committedDate": "2020-07-06T17:30:40Z", "message": "Merge branch 'master' into HTTP-Error"}, "afterCommit": {"oid": "19acdc0a1c1937f242764287eb70b4c82a10e2d2", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/19acdc0a1c1937f242764287eb70b4c82a10e2d2", "committedDate": "2020-07-07T03:15:36Z", "message": "urlImportingTestCompleted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89560f31d4e589987e80cae47034507dc105785b", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/89560f31d4e589987e80cae47034507dc105785b", "committedDate": "2020-07-07T03:22:29Z", "message": "urlImportingTestCompleted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd9a4df183bba4c6eb68766441317f48b92fd5ee", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/fd9a4df183bba4c6eb68766441317f48b92fd5ee", "committedDate": "2020-07-07T03:18:33Z", "message": "Merge branch 'master' into HTTP-Error"}, "afterCommit": {"oid": "89560f31d4e589987e80cae47034507dc105785b", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/89560f31d4e589987e80cae47034507dc105785b", "committedDate": "2020-07-07T03:22:29Z", "message": "urlImportingTestCompleted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81fd6d250096ad52f33d9ecafc77de899b000b2c", "author": {"user": {"login": "urvashigupta7", "name": "Urvashi Gupta "}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/81fd6d250096ad52f33d9ecafc77de899b000b2c", "committedDate": "2020-07-07T03:23:49Z", "message": "Merge branch 'master' into HTTP-Error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNzQxMjQx", "url": "https://github.com/OpenRefine/OpenRefine/pull/2870#pullrequestreview-443741241", "createdAt": "2020-07-07T09:57:06Z", "commit": {"oid": "81fd6d250096ad52f33d9ecafc77de899b000b2c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3141, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}