{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNDI5ODA4", "number": 3027, "title": "Fix ToDate test failure & inefficiency - fixes #3026", "bodyText": "Fixes #3026.\n\nUse Instant.truncate(DAYS) instead of homebrew offset calculation.\nFix handling of unknown language code as first format string. It was creating 160 copies of it and trying to convert (unsuccessfully) with them all.\n\nThe unknown language code used to return an EvalError but that behavior was changed and the test that covered it was disabled. Presumably this was intentional, but I'm not sure why.\n@ostephens do you know why?", "createdAt": "2020-08-03T22:35:36Z", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027", "merged": true, "mergeCommit": {"oid": "55edae2b7bb835bd2ed87cd8ab35e49d64c41767"}, "closed": true, "closedAt": "2020-08-09T11:53:44Z", "author": {"login": "tfmorris"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7Z5mGgBqjM2MTc4MjkwODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9MRewgFqTQ2Mzg2NzgyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a422497fe1293254f00a2846b7edbb26bf5ecf03", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/a422497fe1293254f00a2846b7edbb26bf5ecf03", "committedDate": "2020-08-03T22:27:58Z", "message": "Don't add 160 copies of the same format string\n\nNot sure what this code is trying to do, but it's just\nwasting processing for no effect. I don't understand what\nit's attempting to do well enough to implement it properly."}, "afterCommit": {"oid": "a5cd443f7ce79379abca48052015a88b3feef089", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/a5cd443f7ce79379abca48052015a88b3feef089", "committedDate": "2020-08-03T22:38:01Z", "message": "Don't add 160 copies of the same format string\n\nNot sure what this code is trying to do, but it's just\nwasting processing for no effect. I don't understand what\nit's attempting to do well enough to implement it properly."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5cd443f7ce79379abca48052015a88b3feef089", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/a5cd443f7ce79379abca48052015a88b3feef089", "committedDate": "2020-08-03T22:38:01Z", "message": "Don't add 160 copies of the same format string\n\nNot sure what this code is trying to do, but it's just\nwasting processing for no effect. I don't understand what\nit's attempting to do well enough to implement it properly."}, "afterCommit": {"oid": "d4849ea948c60c8978d78aa561d26c7084e02cc3", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/d4849ea948c60c8978d78aa561d26c7084e02cc3", "committedDate": "2020-08-04T00:01:05Z", "message": "Fix date parsing with locale as first format string\n\nAlso refactors for simpicity, restores a dropped test,\nands adds a ToDo/question about previous test behavior\nchange."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNDQ4NzE2", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027#pullrequestreview-462448716", "createdAt": "2020-08-06T11:56:33Z", "commit": {"oid": "d4849ea948c60c8978d78aa561d26c7084e02cc3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMTo1NjozM1rOG8wVtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMTo1NjozM1rOG8wVtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1OTczNQ==", "bodyText": "It is not clear to me that this new version is equivalent, for instance of datetime objects with precision down to the second. You are correct that the motivation for this .plusSeconds() was to preserve the date part across timezones but I think this code also handles timestamps with a higher precision than day.", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027#discussion_r466359735", "createdAt": "2020-08-06T11:56:33Z", "author": {"login": "wetneb"}, "path": "main/src/com/google/refine/expr/functions/ToDate.java", "diffHunk": "@@ -168,8 +167,7 @@ private OffsetDateTime parse(String o1, Locale locale, List<String> formats) {\n         } else {\n             try {\n                 return javax.xml.bind.DatatypeConverter.parseDateTime(o1).getTime().toInstant()\n-                \t\t.plusSeconds(ZonedDateTime.now().getOffset().getTotalSeconds())\n-                \t\t.atOffset(ZoneOffset.of(\"Z\"));\n+                        .truncatedTo(ChronoUnit.DAYS).atOffset(ZoneOffset.of(\"Z\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4849ea948c60c8978d78aa561d26c7084e02cc3"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c61f48578d6ac678c2756a761a259df80fa184fc", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/c61f48578d6ac678c2756a761a259df80fa184fc", "committedDate": "2020-08-06T17:52:03Z", "message": "Fix ToDate test failure - fixes #3026\n\nInstead of computing offset from UTC at current\npoint in time, use the offset from the parsed\ndate so that we're not affected by crossing\na daylight savings time boundary."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d4849ea948c60c8978d78aa561d26c7084e02cc3", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/d4849ea948c60c8978d78aa561d26c7084e02cc3", "committedDate": "2020-08-04T00:01:05Z", "message": "Fix date parsing with locale as first format string\n\nAlso refactors for simpicity, restores a dropped test,\nands adds a ToDo/question about previous test behavior\nchange."}, "afterCommit": {"oid": "c6ef7f06f796ccd196de1c0e7517e9765f899737", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/c6ef7f06f796ccd196de1c0e7517e9765f899737", "committedDate": "2020-08-06T17:53:45Z", "message": "Fix date parsing with locale as first format string\n\nAlso refactors for simpicity, restores a dropped test,\nands adds a ToDo/question about previous test behavior\nchange."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNzA3NTA3", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027#pullrequestreview-463707507", "createdAt": "2020-08-08T01:39:28Z", "commit": {"oid": "3fd7ce92108aa4d57de6b024e87cc18e45a7fd4a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMTozOToyOFrOG9shXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wOFQwMTozOToyOFrOG9shXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM0NTc1Nw==", "bodyText": "@wetneb I think this test should pass, but it fails due to UTC timezone offset code that you added. Can you review and see if you agree?", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027#discussion_r467345757", "createdAt": "2020-08-08T01:39:28Z", "author": {"login": "tfmorris"}, "path": "main/tests/server/src/com/google/refine/expr/functions/strings/ToFromConversionTests.java", "diffHunk": "@@ -167,12 +170,22 @@ public void testToDate() throws CalendarParserException {\n       // First string can be a locale identifier instead of a format string\n       Assert.assertEquals(invoke(\"toDate\", \"2013-06-01\",\"zh\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n       Assert.assertEquals(invoke(\"toDate\", \"01-\u516d\u6708-2013\",\"zh\",\"dd-MMM-yyyy\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n+      Assert.assertEquals(invoke(\"toDate\", \"01-\u516d\u6708-2013\",\"zh\", \"MMM-dd-yyyy\", \"dd-MMM-yyyy\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01\"));\n \n       // If a long, convert to string\n       Assert.assertEquals(invoke(\"toDate\", (long) 2012), invoke(\"toDate\", \"2012-01-01\"));\n \n       // If already a date, leave it alone\n       Assert.assertEquals(invoke(\"toDate\", CalendarParser.parseAsOffsetDateTime(\"2012-03-01\")),CalendarParser.parseAsOffsetDateTime(\"2012-03-01\"));\n+\n+      // FIXME: Date/times without timezone info should be interpreted as local time, not UTC\n+//      Assert.assertEquals(invoke(\"toDate\", \"2013-06-01T13:12:11\"), CalendarParser.parseAsOffsetDateTime(\"2013-06-01 13:12:11\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fd7ce92108aa4d57de6b024e87cc18e45a7fd4a"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3fd7ce92108aa4d57de6b024e87cc18e45a7fd4a", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/3fd7ce92108aa4d57de6b024e87cc18e45a7fd4a", "committedDate": "2020-08-08T01:28:35Z", "message": "Add more datetime tests"}, "afterCommit": {"oid": "ef3d19f10dda63776569cbeb615dfc8b8f0262c0", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/ef3d19f10dda63776569cbeb615dfc8b8f0262c0", "committedDate": "2020-08-08T18:51:12Z", "message": "Fix date parsing with locale as first format string\n\nAlso refactors for simpicity, restore some dropped tests,\nand restores previous behavior of considering a bad\nformat string an error instead of silently ignoring it.\n\nIt does NOT address another issue which was introduced\nin May 2018 of treating date/times without timzone\ninformation as UTC instead of local."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97c309f8bbb90d5a6dea2bdba26dbb55cdf74b8b", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/97c309f8bbb90d5a6dea2bdba26dbb55cdf74b8b", "committedDate": "2020-08-08T19:41:25Z", "message": "Fix date parsing with locale as first format string\n\nAlso refactors for simpicity, restore some dropped tests,\nand restores previous behavior of considering a bad\nformat string an error instead of silently ignoring it.\n\nIt does NOT address another issue which was introduced\nin May 2018 of treating date/times without timzone\ninformation as UTC instead of local."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "182c769e7db0eb81a6b17c4f72df6b2dac1a2e30", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/182c769e7db0eb81a6b17c4f72df6b2dac1a2e30", "committedDate": "2020-08-08T19:31:56Z", "message": "Final try"}, "afterCommit": {"oid": "97c309f8bbb90d5a6dea2bdba26dbb55cdf74b8b", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/97c309f8bbb90d5a6dea2bdba26dbb55cdf74b8b", "committedDate": "2020-08-08T19:41:25Z", "message": "Fix date parsing with locale as first format string\n\nAlso refactors for simpicity, restore some dropped tests,\nand restores previous behavior of considering a bad\nformat string an error instead of silently ignoring it.\n\nIt does NOT address another issue which was introduced\nin May 2018 of treating date/times without timzone\ninformation as UTC instead of local."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef60cf23c3fc1fa5dcfaa6f83e2fd630be01e8db", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/ef60cf23c3fc1fa5dcfaa6f83e2fd630be01e8db", "committedDate": "2020-08-09T01:20:10Z", "message": "Restore error checking and messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21590dfef75d757bd0cf1a0777c990f78cbfd5eb", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/21590dfef75d757bd0cf1a0777c990f78cbfd5eb", "committedDate": "2020-08-09T01:58:11Z", "message": "Save & restore default timezone for tests\n\nAlso add some ToDos for places where LocalDate is being misused."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cb3d8ed983214b0d0bb304b2aeeb88520df79cf", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/6cb3d8ed983214b0d0bb304b2aeeb88520df79cf", "committedDate": "2020-08-09T01:46:58Z", "message": "Save & restore default timezone for tests"}, "afterCommit": {"oid": "21590dfef75d757bd0cf1a0777c990f78cbfd5eb", "author": {"user": {"login": "tfmorris", "name": "Tom Morris"}}, "url": "https://github.com/OpenRefine/OpenRefine/commit/21590dfef75d757bd0cf1a0777c990f78cbfd5eb", "committedDate": "2020-08-09T01:58:11Z", "message": "Save & restore default timezone for tests\n\nAlso add some ToDos for places where LocalDate is being misused."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzODY3ODI1", "url": "https://github.com/OpenRefine/OpenRefine/pull/3027#pullrequestreview-463867825", "createdAt": "2020-08-09T11:53:25Z", "commit": {"oid": "21590dfef75d757bd0cf1a0777c990f78cbfd5eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3085, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}