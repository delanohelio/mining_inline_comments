{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0NDAwNTQ5", "number": 13881, "title": "Use AmbiguousEJBReferenceException with legacy EJB bindings", "bodyText": "Expose com.ibm.websphere.ejbcontainer as internal IBM API\nRemove unused entity EJB APIs\nModify legacy bindings support to throw AmbiguousEJBReferenceException\nUpdate bindings FAT to use AmbiguousEJBReferenceException\nCleanup old apps in setup for each FAT test", "createdAt": "2020-09-10T22:35:55Z", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881", "merged": true, "mergeCommit": {"oid": "1bf3ea968a065298563e6ef8c5ef29c5c9eff189"}, "closed": true, "closedAt": "2020-09-21T14:11:40Z", "author": {"login": "brideck"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH2u3TAFqTQ4Njg0MjUyNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJzl7CABqjM3Nzg4NzU0NTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2ODQyNTI2", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#pullrequestreview-486842526", "createdAt": "2020-09-11T14:11:49Z", "commit": {"oid": "287799d96bb8dae6282de766df43d96cc365ffb7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNDoxMTo0OVrOHQghsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNTowMDoyMVrOHQif7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA3MjE3Ng==", "bodyText": "should this be called \"localBinding\" or is that a copy paste thing?", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#discussion_r487072176", "createdAt": "2020-09-11T14:11:49Z", "author": {"login": "olendvcook"}, "path": "dev/com.ibm.ws.ejbcontainer/src/com/ibm/ws/ejbcontainer/osgi/internal/NameSpaceBinderImpl.java", "diffHunk": "@@ -254,21 +259,39 @@ public void bindDefaultEJBRemote(EJBBinding bindingObject, HomeRecord hr) {\n      * To bind to root we register a service to the BundleContext, passing it a Reference Object\n      *\n      * @param bindingObject the EJB Binding information\n-     * @param hr the HomeRecord of the EJB\n-     * @param bindingName the JNDI binding name\n+     * @param hr            the HomeRecord of the EJB\n+     * @param bindingName   the JNDI binding name\n+     * @param isSimpleName  Flag used to force creation of an AmbiguousEJBReference if an\n+     *                          ambiguous simple name binding is detected\n      */\n-    private void bindLegacyRemoteBinding(EJBBinding bindingObject, HomeRecord hr, String bindingName) {\n+    private void bindLegacyRemoteBinding(EJBBinding bindingObject, HomeRecord hr, String bindingName, boolean isSimpleName) {\n         EJBRemoteRuntime remoteRuntime = ejbRemoteRuntimeServiceRef.getService();\n         if (remoteRuntime != null) {\n-\n-            // TODO: If BindingsHelper.ivRemoteBindings.contains(bindingName); we have duplicate bindings\n-            // and need to bind Ambiguous. #11441\n-\n             BindingsHelper bh = BindingsHelper.getRemoteHelper(hr);\n-            bh.ivRemoteBindings.add(bindingName);\n-\n             BundleContext bc = ejbRemoteRuntimeServiceRef.getReference().getBundle().getBundleContext();\n             BeanMetaData bmd = hr.getBeanMetaData();\n+            EJBBinding localBinding = new EJBBinding(bindingObject.homeRecord, bindingObject.interfaceName, bindingObject.interfaceIndex, bindingObject.isLocal);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "287799d96bb8dae6282de766df43d96cc365ffb7"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEwMTY2OA==", "bodyText": "If I saw just this in trace bind: false I would think the bind failed, not that it's not Ambiguous so I'd make this clearer.", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#discussion_r487101668", "createdAt": "2020-09-11T14:55:45Z", "author": {"login": "olendvcook"}, "path": "dev/com.ibm.ws.ejbcontainer/src/com/ibm/ws/ejbcontainer/osgi/internal/naming/EJBLocalNamingHelperImpl.java", "diffHunk": "@@ -81,18 +87,33 @@ public synchronized void bind(EJBBinding binding, String name) {\n             Tr.entry(tc, \"bind: \" + name);\n         }\n \n+        EJBBinding previousBinding = EJBLocalBindings.get(name);\n+\n+        // There won't be a previous binding for an ambiguous simple binding name\n+        if (isSimpleName) {\n+            localBinding.setAmbiguousReference();\n+            notAmbiguous = false;\n+        }\n+\n+        if (previousBinding != null) {\n+            localBinding.setAmbiguousReference();\n+            localBinding.addJ2EENames(previousBinding.getJ2EENames());\n+            notAmbiguous = false;\n+        }\n+\n         Lock writeLock = javaColonLock.writeLock();\n         writeLock.lock();\n         try {\n-            //TODO: If EJBLocalBindings already contains name, bind ambiguous reference exception\n-            EJBLocalBindings.put(name, binding);\n+            EJBLocalBindings.put(name, localBinding);\n         } finally {\n             writeLock.unlock();\n         }\n \n         if (isTraceOn && tc.isEntryEnabled()) {\n-            Tr.exit(tc, \"bind\");\n+            Tr.exit(tc, \"bind: \" + notAmbiguous);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "287799d96bb8dae6282de766df43d96cc365ffb7"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEwNDQ5NQ==", "bodyText": "Same here, if I saw just this in trace bind: false I would think the bind failed, not that it's not Ambiguous so I'd make this clearer.", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#discussion_r487104495", "createdAt": "2020-09-11T15:00:21Z", "author": {"login": "olendvcook"}, "path": "dev/com.ibm.ws.ejbcontainer/src/com/ibm/ws/ejbcontainer/osgi/internal/naming/LocalColonEJBNamingHelperImpl.java", "diffHunk": "@@ -70,25 +74,42 @@ protected void unsetEJBHomeRuntime(ServiceReference<EJBHomeRuntime> ref) {\n     }\n \n     @Override\n-    public synchronized void bind(EJBBinding binding, String name) {\n+    public synchronized boolean bind(EJBBinding binding, String name, boolean isSimpleName) {\n         final boolean isTraceOn = TraceComponent.isAnyTracingEnabled();\n+        boolean notAmbiguous = true;\n+        EJBBinding localBinding = new EJBBinding(binding.homeRecord, binding.interfaceName, binding.interfaceIndex, binding.isLocal);\n+\n         if (isTraceOn && tc.isEntryEnabled()) {\n             Tr.entry(tc, \"bind: \" + name);\n         }\n \n+        EJBBinding previousBinding = localColonEJBBindings.get(name);\n+\n+        // There won't be a previous binding for an ambiguous simple binding name\n+        if (isSimpleName) {\n+            localBinding.setAmbiguousReference();\n+            notAmbiguous = false;\n+        }\n+\n+        if (previousBinding != null) {\n+            localBinding.setAmbiguousReference();\n+            localBinding.addJ2EENames(previousBinding.getJ2EENames());\n+            notAmbiguous = false;\n+        }\n+\n         Lock writeLock = javaColonLock.writeLock();\n         writeLock.lock();\n         try {\n-\n-            //TODO: If LocalColonEJBBindings already contains name, bind ambiguous reference exception\n-            localColonEJBBindings.put(name, binding);\n+            localColonEJBBindings.put(name, localBinding);\n         } finally {\n             writeLock.unlock();\n         }\n \n         if (isTraceOn && tc.isEntryEnabled()) {\n-            Tr.exit(tc, \"bind\");\n+            Tr.exit(tc, \"bind: \" + notAmbiguous);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "287799d96bb8dae6282de766df43d96cc365ffb7"}, "originalPosition": 59}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2ODY3Mzg2", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#pullrequestreview-486867386", "createdAt": "2020-09-11T14:39:31Z", "commit": {"oid": "287799d96bb8dae6282de766df43d96cc365ffb7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNDozOTozMVrOHQhqDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNDozOTozMVrOHQhqDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA5MDcwMQ==", "bodyText": "I know our fat_tools do this as well, but seems odd to have a FAT depend on our internal projects.  Would it work instead to depend on our API : com.ibm.websphere.appserver.api.ejbcontainer??", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#discussion_r487090701", "createdAt": "2020-09-11T14:39:31Z", "author": {"login": "tkburroughs"}, "path": "dev/com.ibm.ws.ejbcontainer.bindings_fat/bnd.bnd", "diffHunk": "@@ -54,4 +54,6 @@ tested.features: \\\n \tcom.ibm.websphere.javaee.servlet.3.1;version=latest,\\\n \tcom.ibm.websphere.javaee.transaction.1.1;version=latest,\\\n \tcom.ibm.websphere.security;version=latest,\\\n-\tcom.ibm.ws.ejbcontainer.fat_tools;version=latest\n\\ No newline at end of file\n+\tcom.ibm.ws.ejbcontainer.core;version=latest,\\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "287799d96bb8dae6282de766df43d96cc365ffb7"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "287799d96bb8dae6282de766df43d96cc365ffb7", "author": {"user": {"login": "brideck", "name": "Brian Decker"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/287799d96bb8dae6282de766df43d96cc365ffb7", "committedDate": "2020-09-11T04:36:03Z", "message": "11441: Fix whitespace"}, "afterCommit": {"oid": "46dad3961fec204f81bca34d6e3380b7d11b67a6", "author": {"user": {"login": "brideck", "name": "Brian Decker"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/46dad3961fec204f81bca34d6e3380b7d11b67a6", "committedDate": "2020-09-11T17:23:38Z", "message": "11441: Fix feature checker issues and address review comments\n- Clarify trace and variable names\n- Clean up FAT project dependencies"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2OTkyNDU2", "url": "https://github.com/OpenLiberty/open-liberty/pull/13881#pullrequestreview-486992456", "createdAt": "2020-09-11T17:29:15Z", "commit": {"oid": "46dad3961fec204f81bca34d6e3380b7d11b67a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46dad3961fec204f81bca34d6e3380b7d11b67a6", "author": {"user": {"login": "brideck", "name": "Brian Decker"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/46dad3961fec204f81bca34d6e3380b7d11b67a6", "committedDate": "2020-09-11T17:23:38Z", "message": "11441: Fix feature checker issues and address review comments\n- Clarify trace and variable names\n- Clean up FAT project dependencies"}, "afterCommit": {"oid": "8f751cbd9859715d66cc513eb2765b042197e9f2", "author": {"user": {"login": "brideck", "name": "Brian Decker"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/8f751cbd9859715d66cc513eb2765b042197e9f2", "committedDate": "2020-09-16T22:16:38Z", "message": "11441: Update API to version 2.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66d8d9bb7a906806a212028a4f115eede18f4b66", "author": {"user": {"login": "brideck", "name": "Brian Decker"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/66d8d9bb7a906806a212028a4f115eede18f4b66", "committedDate": "2020-09-17T16:28:16Z", "message": "Use AmbiguousEJBReferenceException with legacy EJB bindings\n- Expose com.ibm.websphere.ejbcontainer as internal IBM API\n- Remove unused entity EJB APIs\n- Modify legacy bindings to throw AmbiguousEJBReferenceException\n- Update bindings FAT to use AmbiguousEJBReferenceException\n- Cleanup old apps in setup for each FAT test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8a488bc6fa943a91f05f0e2662ec47ae1a5750e", "author": {"user": {"login": "brideck", "name": "Brian Decker"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/c8a488bc6fa943a91f05f0e2662ec47ae1a5750e", "committedDate": "2020-09-17T16:28:16Z", "message": "11441: Fix unittest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9b1fb45418fe2176dee513c168e321925c1031f", "author": {"user": {"login": "brideck", "name": "Brian Decker"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/e9b1fb45418fe2176dee513c168e321925c1031f", "committedDate": "2020-09-17T16:28:17Z", "message": "11441: Fix whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "326d3e5ef94d27ea1ac61749618ce4704ce015af", "author": {"user": {"login": "brideck", "name": "Brian Decker"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/326d3e5ef94d27ea1ac61749618ce4704ce015af", "committedDate": "2020-09-17T16:28:17Z", "message": "11441: Fix feature checker issues and address review comments\n- Clarify trace and variable names\n- Clean up FAT project dependencies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a8b7c3aec49ef876a11582694a1e682f1971858", "author": {"user": {"login": "brideck", "name": "Brian Decker"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/6a8b7c3aec49ef876a11582694a1e682f1971858", "committedDate": "2020-09-17T16:28:17Z", "message": "11441: Update API to version 2.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7f77e774216113c50997bda8fab15e80cf88152", "author": {"user": {"login": "brideck", "name": "Brian Decker"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/f7f77e774216113c50997bda8fab15e80cf88152", "committedDate": "2020-09-17T16:28:18Z", "message": "11441: Update containerServices to version 4.0"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f751cbd9859715d66cc513eb2765b042197e9f2", "author": {"user": {"login": "brideck", "name": "Brian Decker"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/8f751cbd9859715d66cc513eb2765b042197e9f2", "committedDate": "2020-09-16T22:16:38Z", "message": "11441: Update API to version 2.0"}, "afterCommit": {"oid": "f7f77e774216113c50997bda8fab15e80cf88152", "author": {"user": {"login": "brideck", "name": "Brian Decker"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/f7f77e774216113c50997bda8fab15e80cf88152", "committedDate": "2020-09-17T16:28:18Z", "message": "11441: Update containerServices to version 4.0"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3341, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}