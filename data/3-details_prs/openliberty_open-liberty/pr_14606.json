{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NjQxMzMy", "number": 14606, "title": "Issue #14600: Fix a performance degradation that was introduced when \u2026", "bodyText": "\u2026checking whether CDI was needed for Jakarta EE9.\nfixes #14600", "createdAt": "2020-10-21T15:35:11Z", "url": "https://github.com/OpenLiberty/open-liberty/pull/14606", "merged": true, "mergeCommit": {"oid": "d97229007e34b54773f5c62adba6b2143b84912b"}, "closed": true, "closedAt": "2020-10-27T02:09:04Z", "author": {"login": "jvanhill"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUxaIugFqTUxNDA0NDExOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWURh2gBqjM5MjA2NjQ4NDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MDQ0MTE4", "url": "https://github.com/OpenLiberty/open-liberty/pull/14606#pullrequestreview-514044118", "createdAt": "2020-10-21T18:09:24Z", "commit": {"oid": "9de875552242ee2043ca07d0bdcdcc833cc55242"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxODowOToyNVrOHl7r5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxODowOToyNVrOHl7r5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTUzNzI1Mw==", "bodyText": "In general this whole method is an anti-pattern.  Usually this is handled with a service being applied to the instance and this not being calculated on EVERY web request.  In order to reduce the extra processing of getting the installed features I suggest to change this to the below for now in order to get us back to close to where we were.\n        if (WebContainer.getServletContainerSpecLevel() < WebContainer.SPEC_LEVEL_40) {\n            return false;\n        }\n        Set<String> features = provisionerService.getInstalledFeatures();\n        return features.contains(\"appSecurity-3.0\") || features.contains(\"appSecurity-4.0\");", "url": "https://github.com/OpenLiberty/open-liberty/pull/14606#discussion_r509537253", "createdAt": "2020-10-21T18:09:25Z", "author": {"login": "jhanders34"}, "path": "dev/com.ibm.ws.webcontainer.security/src/com/ibm/ws/webcontainer/security/WebAppSecurityCollaboratorImpl.java", "diffHunk": "@@ -461,31 +461,16 @@ public void handleException(HttpServletRequest req, HttpServletResponse rsp, Thr\n     }\n \n     @Override\n-    @FFDCIgnore(NumberFormatException.class)\n     public boolean isCDINeeded() {\n-        int specLevel = WebContainer.getServletContainerSpecLevel();\n-\n-        /*\n-         * Determine which version of appSecurity we are running.\n-         */\n-        Set<String> installedFeatures = provisionerService.getInstalledFeatures();\n-        float appSecurityVers = 0.0f;\n-        for (String feature : installedFeatures) {\n-            if (feature.startsWith(\"appSecurity-\")) {\n-                try {\n-                    appSecurityVers = Float.valueOf(feature.substring(12));\n-                    break;\n-                } catch (NumberFormatException e) {\n-                    // Ignore. Not the feature we are looking for.\n-                }\n-            }\n-        }\n-\n         /*\n-         * Future-proof check. Some of these combinations aren't valid, but\n-         * they will not make it this far.\n+         * Tried to future-proof this check by iterating over all the\n+         * installed features and finding the version of appSecurity installed,\n+         * but that introduced a performance degradation. So for now, checking\n+         * for the appSecurity-3.0/4.0 features directly.\n          */\n-        return appSecurityVers >= 3.0 && specLevel >= WebContainer.SPEC_LEVEL_40;\n+        return WebContainer.getServletContainerSpecLevel() >= WebContainer.SPEC_LEVEL_40 &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9de875552242ee2043ca07d0bdcdcc833cc55242"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9de875552242ee2043ca07d0bdcdcc833cc55242", "author": {"user": {"login": "jvanhill", "name": "Jesse Van Hill"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/9de875552242ee2043ca07d0bdcdcc833cc55242", "committedDate": "2020-10-21T15:33:58Z", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9."}, "afterCommit": {"oid": "8eccb2c9d7803275d21bc863a10c05548f32405e", "author": {"user": {"login": "jvanhill", "name": "Jesse Van Hill"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/8eccb2c9d7803275d21bc863a10c05548f32405e", "committedDate": "2020-10-21T19:19:09Z", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTA1OTg2", "url": "https://github.com/OpenLiberty/open-liberty/pull/14606#pullrequestreview-514105986", "createdAt": "2020-10-21T19:22:23Z", "commit": {"oid": "8eccb2c9d7803275d21bc863a10c05548f32405e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8eccb2c9d7803275d21bc863a10c05548f32405e", "author": {"user": {"login": "jvanhill", "name": "Jesse Van Hill"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/8eccb2c9d7803275d21bc863a10c05548f32405e", "committedDate": "2020-10-21T19:19:09Z", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9."}, "afterCommit": {"oid": "304a49e9030757026e543f0048ce24af15ff1778", "author": {"user": {"login": "jvanhill", "name": "Jesse Van Hill"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/304a49e9030757026e543f0048ce24af15ff1778", "committedDate": "2020-10-23T13:27:44Z", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "304a49e9030757026e543f0048ce24af15ff1778", "author": {"user": {"login": "jvanhill", "name": "Jesse Van Hill"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/304a49e9030757026e543f0048ce24af15ff1778", "committedDate": "2020-10-23T13:27:44Z", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9."}, "afterCommit": {"oid": "6536c2f513ce80f85377368e43aaf0291aaaf63c", "author": {"user": {"login": "jvanhill", "name": "Jesse Van Hill"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/6536c2f513ce80f85377368e43aaf0291aaaf63c", "committedDate": "2020-10-25T19:51:16Z", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "652e439435abd7be84b568bcdef49de29306d483", "author": {"user": {"login": "jvanhill", "name": "Jesse Van Hill"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/652e439435abd7be84b568bcdef49de29306d483", "committedDate": "2020-10-26T13:20:20Z", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6536c2f513ce80f85377368e43aaf0291aaaf63c", "author": {"user": {"login": "jvanhill", "name": "Jesse Van Hill"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/6536c2f513ce80f85377368e43aaf0291aaaf63c", "committedDate": "2020-10-25T19:51:16Z", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9."}, "afterCommit": {"oid": "652e439435abd7be84b568bcdef49de29306d483", "author": {"user": {"login": "jvanhill", "name": "Jesse Van Hill"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/652e439435abd7be84b568bcdef49de29306d483", "committedDate": "2020-10-26T13:20:20Z", "message": "Issue #14600: Fix a performance degradation that was introduced when checking whether CDI was needed for Jakarta EE9."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2979, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}