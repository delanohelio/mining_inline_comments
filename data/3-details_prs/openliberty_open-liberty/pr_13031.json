{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MTgyMjk3", "number": 13031, "title": "Issue 13030: Wait for HTTP to allow ACME startup", "bodyText": "Fixes #13030\n\nWait on both the ACME web app and HTTP opening\nAdd internal config for timeout\nNormalize minRenew config\nAdded test with \"slow\" app to make sure HTTP is delayed and ACME waits appropriately\nRemove app1 from acme_fat, not needed", "createdAt": "2020-07-15T00:47:42Z", "url": "https://github.com/OpenLiberty/open-liberty/pull/13031", "merged": true, "mergeCommit": {"oid": "7bb62717933afa47f89ad0220d814d82c56611ce"}, "closed": true, "closedAt": "2020-07-22T21:39:57Z", "author": {"login": "kristip17"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1Q2cagBqjM1NTAyNzMyNTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3eu_sABqjM1NzY5MzQ4NjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e5078bc0fb19b590b33fba82fc7f7c11e75a28c3", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/e5078bc0fb19b590b33fba82fc7f7c11e75a28c3", "committedDate": "2020-07-15T00:46:34Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}, "afterCommit": {"oid": "cdd6ecd5e77fb7513ea9905e2deb7b0a16fb9429", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/cdd6ecd5e77fb7513ea9905e2deb7b0a16fb9429", "committedDate": "2020-07-15T20:41:27Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdd6ecd5e77fb7513ea9905e2deb7b0a16fb9429", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/cdd6ecd5e77fb7513ea9905e2deb7b0a16fb9429", "committedDate": "2020-07-15T20:41:27Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}, "afterCommit": {"oid": "c651b5ac4e7721a749660ba3460fe3de38b9e71d", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/c651b5ac4e7721a749660ba3460fe3de38b9e71d", "committedDate": "2020-07-15T21:03:28Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5ODc1NTQ3", "url": "https://github.com/OpenLiberty/open-liberty/pull/13031#pullrequestreview-449875547", "createdAt": "2020-07-16T13:59:14Z", "commit": {"oid": "c651b5ac4e7721a749660ba3460fe3de38b9e71d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMzo1OToxNFrOGysR4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNlQxMzo1OToxNFrOGysR4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTgwNzQ1OA==", "bodyText": "I would probably make this a WARNING, since it is significant and would help us debug the issue immediately.", "url": "https://github.com/OpenLiberty/open-liberty/pull/13031#discussion_r455807458", "createdAt": "2020-07-16T13:59:14Z", "author": {"login": "jvanhill"}, "path": "dev/com.ibm.ws.security.acme/src/com/ibm/ws/security/acme/internal/AcmeApplicationStateListener.java", "diffHunk": "@@ -140,10 +196,51 @@ public void waitUntilWebAppAvailable() throws AcmeCaException {\n \t\t\t\t}\n \n \t\t\t} else {\n-\t\t\t\tif (TraceComponent.isAnyTracingEnabled() && tc.isEntryEnabled()) {\n+\t\t\t\tif (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled()) {\n \t\t\t\t\tTr.debug(tc, methodName + \": ACME authorization web application already started - not waiting.\");\n \t\t\t\t}\n \t\t\t}\n+\n+\t\t\tif (!isHttpStarted) {\n+\t\t\t\tif (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled()) {\n+\n+\t\t\t\t\tTr.debug(tc, methodName + \": HTTP has not started - waiting.\");\n+\t\t\t\t}\n+\n+\t\t\t\tboolean signaled = false, keepWaiting = true;\n+\t\t\t\tCalendar cal = Calendar.getInstance();\n+\t\t\t\tint timeToWait = 1;\n+\t\t\t\tcal.add(Calendar.MINUTE, timeToWait); // Wait 1 minute, the HTTP port should open after 30 seconds\n+\t\t\t\twhile (keepWaiting) {\n+\t\t\t\t\ttry {\n+\t\t\t\t\t\tkeepWaiting = false;\n+\t\t\t\t\t\tsignaled = httpStartedCondition.awaitUntil(cal.getTime());\n+\t\t\t\t\t} catch (InterruptedException e) {\n+\t\t\t\t\t\tkeepWaiting = true;\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t\tif (TraceComponent.isAnyTracingEnabled() && tc.isEntryEnabled()) {\n+\t\t\t\t\tTr.debug(tc, methodName + \": Finished waiting.\");\n+\t\t\t\t}\n+\n+\t\t\t\t/*\n+\t\t\t\t * If the wait above expired and we weren't signaled by the startedPhase2\n+\t\t\t\t * method, we will attempt to start ACME anyway. If the HTTP port is truly not\n+\t\t\t\t * open, then the CA call back to the well-known URL will fail\n+\t\t\t\t * (\"Connection refused\" or similar).\n+\t\t\t\t */\n+\t\t\t\tif (!signaled || !isHttpStarted) {\n+\t\t\t\t\tif (TraceComponent.isAnyTracingEnabled() && tc.isEventEnabled()) {\n+\t\t\t\t\t\tTr.event(tc, methodName", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c651b5ac4e7721a749660ba3460fe3de38b9e71d"}, "originalPosition": 198}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c651b5ac4e7721a749660ba3460fe3de38b9e71d", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/c651b5ac4e7721a749660ba3460fe3de38b9e71d", "committedDate": "2020-07-15T21:03:28Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}, "afterCommit": {"oid": "030196961924a26b324b8ce1510503857ed08273", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/030196961924a26b324b8ce1510503857ed08273", "committedDate": "2020-07-16T20:58:00Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "030196961924a26b324b8ce1510503857ed08273", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/030196961924a26b324b8ce1510503857ed08273", "committedDate": "2020-07-16T20:58:00Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}, "afterCommit": {"oid": "f83112014f99b3f97e4790c58203f26d07051c67", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/f83112014f99b3f97e4790c58203f26d07051c67", "committedDate": "2020-07-16T21:23:52Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f83112014f99b3f97e4790c58203f26d07051c67", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/f83112014f99b3f97e4790c58203f26d07051c67", "committedDate": "2020-07-16T21:23:52Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}, "afterCommit": {"oid": "5bef16eb63e62a6b6ac9256f56b5f49e7ff90db5", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/5bef16eb63e62a6b6ac9256f56b5f49e7ff90db5", "committedDate": "2020-07-20T02:36:00Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bef16eb63e62a6b6ac9256f56b5f49e7ff90db5", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/5bef16eb63e62a6b6ac9256f56b5f49e7ff90db5", "committedDate": "2020-07-20T02:36:00Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}, "afterCommit": {"oid": "cded4279e5b7ba4d7b1a007165b38cb0338df1b9", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/cded4279e5b7ba4d7b1a007165b38cb0338df1b9", "committedDate": "2020-07-21T21:14:08Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTM1MDc4", "url": "https://github.com/OpenLiberty/open-liberty/pull/13031#pullrequestreview-452935078", "createdAt": "2020-07-22T01:31:10Z", "commit": {"oid": "cded4279e5b7ba4d7b1a007165b38cb0338df1b9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cded4279e5b7ba4d7b1a007165b38cb0338df1b9", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/cded4279e5b7ba4d7b1a007165b38cb0338df1b9", "committedDate": "2020-07-21T21:14:08Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}, "afterCommit": {"oid": "57584bace5150ff6be5d368ce6c67d447c7567f7", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/57584bace5150ff6be5d368ce6c67d447c7567f7", "committedDate": "2020-07-22T14:04:15Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTIwODM2", "url": "https://github.com/OpenLiberty/open-liberty/pull/13031#pullrequestreview-453520836", "createdAt": "2020-07-22T17:11:29Z", "commit": {"oid": "57584bace5150ff6be5d368ce6c67d447c7567f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNzoxMToyOVrOG1sKhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNzoxMToyOVrOG1sKhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MTMwMA==", "bodyText": "A nit:  Change \"URL which indicates the internal application started.\" to \"URL to indicate that the internal application started.\" or to \"URL, which indicates that the internal application started.\"", "url": "https://github.com/OpenLiberty/open-liberty/pull/13031#discussion_r458951300", "createdAt": "2020-07-22T17:11:29Z", "author": {"login": "helyarp"}, "path": "dev/com.ibm.ws.security.acme/resources/com/ibm/ws/security/acme/resources/AcmeMessages.nlsprops", "diffHunk": "@@ -179,9 +179,9 @@ CWPKI2035E=CWPKI2035E: The ACME service could not store the signed certificate i\n CWPKI2035E.explanation=The certificate was successfully retrieved from the certificate authority, but it cannot be stored locally.\n CWPKI2035E.useraction=Review the error message for details on the failure. Verify the keystore file location is correct and the server has write file permissions.\n \n-CWPKI2036E=CWPKI2036E: The ACME service timed out waiting for the web authorization application to start. The application is required to complete a certificate request with an ACME certificate authority. The service waited for {0} minutes.\n-CWPKI2036E.explanation=The application used to complete a certificate request did not start in the expected time frame. A signed certificate cannot be requested.\n-CWPKI2036E.useraction=Review the log for earlier messages or errors.\n+CWPKI2036W=CWPKI2036W: The ACME service timed out waiting for the web authorization application to start. The application is required to complete a certificate request with an ACME certificate authority. The certificate request is attempted. The service waited for {0}.\n+CWPKI2036W.explanation=The application used to complete a certificate request did not start in the expected time frame. If the application starts, the request proceeds. If the application does not start, the certificate request fails.\n+CWPKI2036W.useraction=Review the log for earlier messages or errors. Review the log for a CWWKT0016I message that includes a web application with the ''acme-challenge'' URL which indicates the internal application started.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57584bace5150ff6be5d368ce6c67d447c7567f7"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddcbbb98596a956ca35689389783534611ba35dd", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/ddcbbb98596a956ca35689389783534611ba35dd", "committedDate": "2020-07-22T18:00:06Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "57584bace5150ff6be5d368ce6c67d447c7567f7", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/57584bace5150ff6be5d368ce6c67d447c7567f7", "committedDate": "2020-07-22T14:04:15Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}, "afterCommit": {"oid": "ddcbbb98596a956ca35689389783534611ba35dd", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/ddcbbb98596a956ca35689389783534611ba35dd", "committedDate": "2020-07-22T18:00:06Z", "message": "Issue 13030: Wait for HTTP to allow ACME startup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2144, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}