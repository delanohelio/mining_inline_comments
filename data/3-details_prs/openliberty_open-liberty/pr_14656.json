{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NTA1NjU0", "number": 14656, "title": "Issue 14655: Only check on baseEntries after config processed", "bodyText": "Fixes #14655\nThe previous behavior was that the ConfigManager sent out a notification to Listeners only after receiving a Modify. When VMMService (the only implemented listener) received the event, it checks that the participatingBaseEntries listed match a registry. If a registry isn't found, an error message is issued (CWIMK0004E).\nThe startup timing has changed such that sometimes we process the config as an empty initialize then call modify when we may or may not have finished processing the registries (such as BasicRegistry or LdapRegistry). This caused a false negative on the error messages.\nTo match previous behavior and avoid the baseEntry check happening too early. I did the following:\n\nAdd a listener for checking when server config modifications are complete\nToggle when we're past init phase and modify is being called (otherwise, URAPIs_RealmPropertyMappingTest failed because we received a config complete check before initializing the CustomRegistry/CustomRepository features in that test -- I think this matches more closely to the original behavior).\nAdded a call to deregister in VMMService or we ended up with a new and old VMMService to call from ConfigManager\nAdded a new FAT test that recreates the failing scenario and intentional creates a scenario that should log the CWIMK0004E", "createdAt": "2020-10-22T19:18:19Z", "url": "https://github.com/OpenLiberty/open-liberty/pull/14656", "merged": true, "mergeCommit": {"oid": "0d5c6271bf951d184a2763207b07568f991b87a0"}, "closed": true, "closedAt": "2020-10-31T21:05:29Z", "author": {"login": "kristip17"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVI_kPgBqjM5MTEyNDc5OTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXnb2wgBqjM5NDE0Mzc3ODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d0c3e36ba0925062130a30c3dfe0afe3d45fe6b", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/2d0c3e36ba0925062130a30c3dfe0afe3d45fe6b", "committedDate": "2020-10-22T19:16:20Z", "message": "Issue 14655: Only check on baseEntries after config processed"}, "afterCommit": {"oid": "522a47216445b83eb330c3e58d4fbbacf503dd8b", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/522a47216445b83eb330c3e58d4fbbacf503dd8b", "committedDate": "2020-10-22T21:14:07Z", "message": "Issue 14655: Only check on baseEntries after config processed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "522a47216445b83eb330c3e58d4fbbacf503dd8b", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/522a47216445b83eb330c3e58d4fbbacf503dd8b", "committedDate": "2020-10-22T21:14:07Z", "message": "Issue 14655: Only check on baseEntries after config processed"}, "afterCommit": {"oid": "526f9dd6e38a91bad3f05c6aea7607305a7865c9", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/526f9dd6e38a91bad3f05c6aea7607305a7865c9", "committedDate": "2020-10-23T13:11:36Z", "message": "Issue 14655: Only check on baseEntries after config processed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "526f9dd6e38a91bad3f05c6aea7607305a7865c9", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/526f9dd6e38a91bad3f05c6aea7607305a7865c9", "committedDate": "2020-10-23T13:11:36Z", "message": "Issue 14655: Only check on baseEntries after config processed"}, "afterCommit": {"oid": "91633a9d85b0929ec289ef3020073101ead7cb5f", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/91633a9d85b0929ec289ef3020073101ead7cb5f", "committedDate": "2020-10-26T19:34:10Z", "message": "Issue 14655: Only check on baseEntries after config processed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91633a9d85b0929ec289ef3020073101ead7cb5f", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/91633a9d85b0929ec289ef3020073101ead7cb5f", "committedDate": "2020-10-26T19:34:10Z", "message": "Issue 14655: Only check on baseEntries after config processed"}, "afterCommit": {"oid": "19bf4e0171b279996218cdb22cbbe279e65abe2b", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/19bf4e0171b279996218cdb22cbbe279e65abe2b", "committedDate": "2020-10-27T17:19:32Z", "message": "Issue 14655: Only check on baseEntries after config processed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MDgyMjk0", "url": "https://github.com/OpenLiberty/open-liberty/pull/14656#pullrequestreview-518082294", "createdAt": "2020-10-27T19:43:07Z", "commit": {"oid": "19bf4e0171b279996218cdb22cbbe279e65abe2b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTo0MzowN1rOHpN2eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxOTo0ODo0NlrOHpOHGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4MDYwMg==", "bodyText": "Add javadoc.", "url": "https://github.com/OpenLiberty/open-liberty/pull/14656#discussion_r512980602", "createdAt": "2020-10-27T19:43:07Z", "author": {"login": "jvanhill"}, "path": "dev/com.ibm.ws.security.wim.core/src/com/ibm/ws/security/wim/ConfigManager.java", "diffHunk": "@@ -424,10 +434,14 @@ public void registerRealmConfigChangeListener(RealmConfigChangeListener listener\n             listeners.add(listener);\n     }\n \n+    public void deregisterRealmConfigChangeListener(RealmConfigChangeListener listener) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19bf4e0171b279996218cdb22cbbe279e65abe2b"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4MTc4Mg==", "bodyText": "Remove trivial? Add javadoc.", "url": "https://github.com/OpenLiberty/open-liberty/pull/14656#discussion_r512981782", "createdAt": "2020-10-27T19:44:52Z", "author": {"login": "jvanhill"}, "path": "dev/com.ibm.ws.security.wim.core/src/com/ibm/ws/security/wim/ConfigManager.java", "diffHunk": "@@ -496,4 +510,56 @@ public long getPageCacheTimeOut() {\n     void setRepositoryManager(RepositoryManager repositoryManager) {\n         this.repositoryManager = repositoryManager;\n     }\n+\n+    @Trivial", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19bf4e0171b279996218cdb22cbbe279e65abe2b"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4MTg4Nw==", "bodyText": "Ditto.", "url": "https://github.com/OpenLiberty/open-liberty/pull/14656#discussion_r512981887", "createdAt": "2020-10-27T19:45:00Z", "author": {"login": "jvanhill"}, "path": "dev/com.ibm.ws.security.wim.core/src/com/ibm/ws/security/wim/ConfigManager.java", "diffHunk": "@@ -496,4 +510,56 @@ public long getPageCacheTimeOut() {\n     void setRepositoryManager(RepositoryManager repositoryManager) {\n         this.repositoryManager = repositoryManager;\n     }\n+\n+    @Trivial\n+    @Reference(service = FutureMonitor.class)\n+    protected void setFutureMonitor(FutureMonitor futureMonitor) {\n+        _futureMonitor = futureMonitor;\n+    }\n+\n+    @Trivial", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19bf4e0171b279996218cdb22cbbe279e65abe2b"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjk4NDg1OQ==", "bodyText": "Reverse the string equality check so the constant is first to protect against possible NPE.", "url": "https://github.com/OpenLiberty/open-liberty/pull/14656#discussion_r512984859", "createdAt": "2020-10-27T19:48:46Z", "author": {"login": "jvanhill"}, "path": "dev/com.ibm.ws.security.wim.core/src/com/ibm/ws/security/wim/ConfigManager.java", "diffHunk": "@@ -496,4 +510,56 @@ public long getPageCacheTimeOut() {\n     void setRepositoryManager(RepositoryManager repositoryManager) {\n         this.repositoryManager = repositoryManager;\n     }\n+\n+    @Trivial\n+    @Reference(service = FutureMonitor.class)\n+    protected void setFutureMonitor(FutureMonitor futureMonitor) {\n+        _futureMonitor = futureMonitor;\n+    }\n+\n+    @Trivial\n+    protected void unsetFutureMonitor(FutureMonitor futureMonitor) {\n+        _futureMonitor = null;\n+    }\n+\n+    /**\n+     * After a configuration modification, run a RealConfigChange check which will verify the participatingBaseEntries.\n+     *\n+     * We used to do this directly from the modify command, but timing change during startup/modify and we would process the check\n+     * before the user registries activated, leading to misleading error messages being printed.\n+     */\n+    @Trivial\n+    @Override\n+    public void notificationCreated(RuntimeUpdateManager updateManager, RuntimeUpdateNotification notification) {\n+        if (modified && notification.getName().equals(RuntimeUpdateNotification.CONFIG_UPDATES_DELIVERED)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19bf4e0171b279996218cdb22cbbe279e65abe2b"}, "originalPosition": 120}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19bf4e0171b279996218cdb22cbbe279e65abe2b", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/19bf4e0171b279996218cdb22cbbe279e65abe2b", "committedDate": "2020-10-27T17:19:32Z", "message": "Issue 14655: Only check on baseEntries after config processed"}, "afterCommit": {"oid": "bf95fa7679e8c438191bad413eaddad683d360c2", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/bf95fa7679e8c438191bad413eaddad683d360c2", "committedDate": "2020-10-29T19:21:45Z", "message": "Issue 14655: Only check on baseEntries after config processed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNjY5ODU3", "url": "https://github.com/OpenLiberty/open-liberty/pull/14656#pullrequestreview-520669857", "createdAt": "2020-10-30T13:32:53Z", "commit": {"oid": "bf95fa7679e8c438191bad413eaddad683d360c2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxMzozMjo1M1rOHrPJQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxMzozMjo1M1rOHrPJQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTA5ODk0NA==", "bodyText": "We should be building in the autofvt build directory, so not sure we should need this.", "url": "https://github.com/OpenLiberty/open-liberty/pull/14656#discussion_r515098944", "createdAt": "2020-10-30T13:32:53Z", "author": {"login": "jvanhill"}, "path": "dev/com.ibm.ws.security.wim.core_fat/publish/servers/com.ibm.ws.security.wim.core.fat.mod/.gitignore", "diffHunk": "@@ -0,0 +1 @@\n+/dropins", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf95fa7679e8c438191bad413eaddad683d360c2"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83483d16056fa9daec9f41842c1b26b2efd7e021", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/83483d16056fa9daec9f41842c1b26b2efd7e021", "committedDate": "2020-10-30T14:13:53Z", "message": "Issue 14655: Only check on baseEntries after config processed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf95fa7679e8c438191bad413eaddad683d360c2", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/bf95fa7679e8c438191bad413eaddad683d360c2", "committedDate": "2020-10-29T19:21:45Z", "message": "Issue 14655: Only check on baseEntries after config processed"}, "afterCommit": {"oid": "83483d16056fa9daec9f41842c1b26b2efd7e021", "author": {"user": {"login": "kristip17", "name": "Kristi Peterson"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/83483d16056fa9daec9f41842c1b26b2efd7e021", "committedDate": "2020-10-30T14:13:53Z", "message": "Issue 14655: Only check on baseEntries after config processed"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2996, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}