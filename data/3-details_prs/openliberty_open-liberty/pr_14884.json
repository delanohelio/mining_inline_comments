{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NzE0MTA3", "number": 14884, "title": "Register CDI extensions from SPI against all deployments not just the\u2026", "bodyText": "fixes #14883 by calling applicationContext.registerSPIExtensions even when not creating a BDA", "createdAt": "2020-11-09T12:03:19Z", "url": "https://github.com/OpenLiberty/open-liberty/pull/14884", "merged": true, "mergeCommit": {"oid": "db46173d97ceabda8e37316d81e7980807b00711"}, "closed": true, "closedAt": "2020-11-10T10:26:44Z", "author": {"login": "benjamin-confino"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda2IO-AFqTUyNjM0NDM5Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbGwoEAFqTUyNzA1ODk5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzQ0Mzk3", "url": "https://github.com/OpenLiberty/open-liberty/pull/14884#pullrequestreview-526344397", "createdAt": "2020-11-09T15:03:07Z", "commit": {"oid": "0d22ea0d8ec385198385b920296c0a125b11d410"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNTowMzowN1rOHvy9Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNTowMzowN1rOHvy9Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg4MDAzNA==", "bodyText": "Can you try to make the two paths a little closer? e.g. surely you can get the spiExtensionClasses from the extensionArchive? So the code would more more like this;\nextensionArchive = runtimeExtensionMap.get(serviceID);\nif (extensionArchive == null) {\n    //only create a new archive, don't register any classes with the deployment\n    extensionArchive = newSPIExtensionArchive(sr, extension.getService(), applicationContext);\n    runtimeExtensionMap.put(serviceID, extensionArchive);\n}\nSet<Extension> spiExtensionClasses = extensionArchive.getExtensions();\napplicationContext.registerSPIExtensions(spiExtensionClasses);", "url": "https://github.com/OpenLiberty/open-liberty/pull/14884#discussion_r519880034", "createdAt": "2020-11-09T15:03:07Z", "author": {"login": "tevans78"}, "path": "dev/com.ibm.ws.cdi.weld/src/com/ibm/ws/cdi/impl/CDIContainerImpl.java", "diffHunk": "@@ -593,17 +593,23 @@ public String getCurrentApplicationContextID() {\n         //Now do the exact same thing for extensions coming from the SPI\n         Iterator<ServiceAndServiceReferencePair<CDIExtensionMetadata>> spiExtensions = cdiRuntime.getSPIExtensionServices();\n         while (spiExtensions.hasNext()) {\n-            ServiceAndServiceReferencePair<CDIExtensionMetadata> extension = spiExtensions.next();\n-            ServiceReference<CDIExtensionMetadata> sr = extension.getServiceReference();\n+            ServiceAndServiceReferencePair<CDIExtensionMetadata> extensionMetaData = spiExtensions.next();\n+            ServiceReference<CDIExtensionMetadata> sr = extensionMetaData.getServiceReference();\n             if (sr != null) {\n                 Long serviceID = ServiceReferenceUtils.getId(sr);\n                 ExtensionArchive extensionArchive = null;\n                 synchronized (this) {\n                     extensionArchive = runtimeExtensionMap.get(serviceID);\n \n                     if (extensionArchive == null) {\n-                        extensionArchive = newSPIExtensionArchive(sr, extension.getService(), applicationContext);\n+                        extensionArchive = newSPIExtensionArchive(sr, extensionMetaData.getService(), applicationContext);\n                         runtimeExtensionMap.put(serviceID, extensionArchive);\n+                    } else {\n+                        // We don't need to create the extension archive but we do need to register the contained extensions into the deploymnet.\n+                        // Since ExtensionArchive doesn't have a method for getting the extension classes, we'll get the extensions from the service.\n+\n+                        Set<Extension> spiExtensionClasses = getExtensionInstancesFromService(extensionMetaData.getService());\n+                        applicationContext.registerSPIExtensions(spiExtensionClasses);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d22ea0d8ec385198385b920296c0a125b11d410"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84d6f287b1c1ba41c42fb4cc082c0e1cd02a161c", "author": {"user": {"login": "benjamin-confino", "name": "Benjamin Confino"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/84d6f287b1c1ba41c42fb4cc082c0e1cd02a161c", "committedDate": "2020-11-09T16:03:32Z", "message": "Register CDI extensions from SPI against all deployments not just the first"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d22ea0d8ec385198385b920296c0a125b11d410", "author": {"user": {"login": "benjamin-confino", "name": "Benjamin Confino"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/0d22ea0d8ec385198385b920296c0a125b11d410", "committedDate": "2020-11-09T12:00:54Z", "message": "Register CDI extensions from SPI against all deployments not just the first"}, "afterCommit": {"oid": "84d6f287b1c1ba41c42fb4cc082c0e1cd02a161c", "author": {"user": {"login": "benjamin-confino", "name": "Benjamin Confino"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/84d6f287b1c1ba41c42fb4cc082c0e1cd02a161c", "committedDate": "2020-11-09T16:03:32Z", "message": "Register CDI extensions from SPI against all deployments not just the first"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MDU4OTky", "url": "https://github.com/OpenLiberty/open-liberty/pull/14884#pullrequestreview-527058992", "createdAt": "2020-11-10T10:25:45Z", "commit": {"oid": "84d6f287b1c1ba41c42fb4cc082c0e1cd02a161c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2963, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}