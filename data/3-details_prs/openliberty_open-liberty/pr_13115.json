{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0MzI3NDMz", "number": 13115, "title": "launch wab module uninstall async", "bodyText": "", "createdAt": "2020-07-21T09:46:08Z", "url": "https://github.com/OpenLiberty/open-liberty/pull/13115", "merged": true, "mergeCommit": {"oid": "9b9794482e9d40492928a5f38313f4e4a9d7d645"}, "closed": true, "closedAt": "2020-07-22T15:58:24Z", "author": {"login": "sebratton"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3DCpBgH2gAyNDU0MzI3NDMzOmFkY2FiNDI4MzQxZGJmOTg3MjNiODNhNzUwN2RhYTM5MmI1MWExMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3aVTXgFqTQ1MzI4NTg1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "adcab428341dbf98723b83a7507daa392b51a112", "author": {"user": {"login": "sebratton", "name": "Samuel E Bratton"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/adcab428341dbf98723b83a7507daa392b51a112", "committedDate": "2020-07-21T09:44:31Z", "message": "launch wab module uninstall async"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26c59f15133765ba46c09bc7d17efe11d02a811f", "author": {"user": {"login": "sebratton", "name": "Samuel E Bratton"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/26c59f15133765ba46c09bc7d17efe11d02a811f", "committedDate": "2020-07-21T18:35:29Z", "message": "File-headers/comments updated"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyODA5OTA2", "url": "https://github.com/OpenLiberty/open-liberty/pull/13115#pullrequestreview-452809906", "createdAt": "2020-07-21T20:36:58Z", "commit": {"oid": "26c59f15133765ba46c09bc7d17efe11d02a811f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMDozNjo1OFrOG1I1ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMDo0NzozOFrOG1JLGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3MjUzOA==", "bodyText": "should use ctx.getBundle(org.osgi.framework.Constants.SYSTEM_BUNDLE_LOCATION) instead of bundle ID 0 here to avoid calling of region framework hooks.", "url": "https://github.com/OpenLiberty/open-liberty/pull/13115#discussion_r458372538", "createdAt": "2020-07-21T20:36:58Z", "author": {"login": "tjwatson"}, "path": "dev/com.ibm.ws.app.manager.wab/src/com/ibm/ws/app/manager/wab/internal/WABInstaller.java", "diffHunk": "@@ -568,9 +577,33 @@ protected boolean uninstallFromWebContainer(WAB wab) {\n                             wabGroupsLock.unlock();\n                         }\n                         if (wab.getCreatedApplicationInfo()) {\n+                            // system WABs get uninstalled here\n                             deployedApp.uninstallApp(wab);\n                         } else {\n-                            deployedApp.uninstallModule(wab);\n+                            final CountDownLatch latch = new CountDownLatch(1);\n+                            if (ctx.getBundle(0).getState() == Bundle.STOPPING) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26c59f15133765ba46c09bc7d17efe11d02a811f"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NDI1MA==", "bodyText": "The latch is only used inside the following if.  Would be better to only construct it inside the if.", "url": "https://github.com/OpenLiberty/open-liberty/pull/13115#discussion_r458374250", "createdAt": "2020-07-21T20:40:09Z", "author": {"login": "tjwatson"}, "path": "dev/com.ibm.ws.app.manager.wab/src/com/ibm/ws/app/manager/wab/internal/WABInstaller.java", "diffHunk": "@@ -568,9 +577,33 @@ protected boolean uninstallFromWebContainer(WAB wab) {\n                             wabGroupsLock.unlock();\n                         }\n                         if (wab.getCreatedApplicationInfo()) {\n+                            // system WABs get uninstalled here\n                             deployedApp.uninstallApp(wab);\n                         } else {\n-                            deployedApp.uninstallModule(wab);\n+                            final CountDownLatch latch = new CountDownLatch(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26c59f15133765ba46c09bc7d17efe11d02a811f"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3ODAxMQ==", "bodyText": "Typically the best practice is to do the following when you catch the InterruptedException and don't want to propagate any errors:\nThread.currentThread().interrupt();\n\nThis is to keep the thread interrupted so that anything else doing work has to exit quickly also.", "url": "https://github.com/OpenLiberty/open-liberty/pull/13115#discussion_r458378011", "createdAt": "2020-07-21T20:47:38Z", "author": {"login": "tjwatson"}, "path": "dev/com.ibm.ws.app.manager.wab/src/com/ibm/ws/app/manager/wab/internal/WABInstaller.java", "diffHunk": "@@ -568,9 +577,33 @@ protected boolean uninstallFromWebContainer(WAB wab) {\n                             wabGroupsLock.unlock();\n                         }\n                         if (wab.getCreatedApplicationInfo()) {\n+                            // system WABs get uninstalled here\n                             deployedApp.uninstallApp(wab);\n                         } else {\n-                            deployedApp.uninstallModule(wab);\n+                            final CountDownLatch latch = new CountDownLatch(1);\n+                            if (ctx.getBundle(0).getState() == Bundle.STOPPING) {\n+                                // if shutting down, launch uninstallModule asynchronously and wait up\n+                                // to 30 secs. This avoids blocking server shutdown unduly.\n+                                executorService.getService().submit(new Runnable() {\n+                                    @Override\n+                                    public void run() {\n+                                        deployedApp.uninstallModule(wab);\n+                                        latch.countDown();\n+                                    }\n+                                }, Boolean.TRUE);\n+                                try {\n+                                    // If a quiesce has not been initiated then a force stop was called so\n+                                    // continue without waiting. Otherwise give the uninstallModule thread\n+                                    // time to unwind before proceeding with WAB removal.\n+                                    if (quiesceStarted.get()) {\n+                                        latch.await(30, TimeUnit.SECONDS);\n+                                    }\n+                                } catch (InterruptedException e) {\n+                                    // Continue with wab uninstall on this thread.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26c59f15133765ba46c09bc7d17efe11d02a811f"}, "originalPosition": 124}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "201a31b240a112ff795a26c4fa215718c18e5b54", "author": {"user": {"login": "sebratton", "name": "Samuel E Bratton"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/201a31b240a112ff795a26c4fa215718c18e5b54", "committedDate": "2020-07-21T21:33:40Z", "message": "Make code review suggested changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMjg1ODUx", "url": "https://github.com/OpenLiberty/open-liberty/pull/13115#pullrequestreview-453285851", "createdAt": "2020-07-22T12:52:43Z", "commit": {"oid": "201a31b240a112ff795a26c4fa215718c18e5b54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2010, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}