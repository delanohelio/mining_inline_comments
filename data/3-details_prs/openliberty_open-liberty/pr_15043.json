{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNDQyNjE0", "number": 15043, "title": "Avoid illegal state exception", "bodyText": "Fixes #15026", "createdAt": "2020-11-18T20:11:39Z", "url": "https://github.com/OpenLiberty/open-liberty/pull/15043", "merged": true, "mergeCommit": {"oid": "b86dd5b303cc7216f84e5bacb05eabe9272a6bef"}, "closed": true, "closedAt": "2021-01-29T15:13:44Z", "author": {"login": "KyleAure"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddz_pZgFqTUzMzgzODI2OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABd0tAmkgFqTU3ODgxNzM5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzODM4MjY4", "url": "https://github.com/OpenLiberty/open-liberty/pull/15043#pullrequestreview-533838268", "createdAt": "2020-11-18T20:15:43Z", "commit": {"oid": "31412b57d8363f886f19769ff4d6ff71267d0a4c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDoxNTo0M1rOH2AVYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQyMDoxNTo0M1rOH2AVYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjM5MDYyNg==", "bodyText": "Need to figure out a way to get at the PoolManager so that I can get at the connections in the unshared pool.\nOr need an alternative way to change the state of the connections while purging.", "url": "https://github.com/OpenLiberty/open-liberty/pull/15043#discussion_r526390626", "createdAt": "2020-11-18T20:15:43Z", "author": {"login": "KyleAure"}, "path": "dev/com.ibm.ws.jca_fat/test-applications/fvtweb/src/web/JCAFVTServlet.java", "diffHunk": "@@ -732,6 +745,92 @@ public void testMBeanPurgeTwoResourceRef(HttpServletRequest request, HttpServlet\n         }\n     }\n \n+    /**\n+     * Test race condition between an invalid state change and pool purge setting state to stale\n+     */\n+    public void testMBeanPurgeRaceCondition(HttpServletRequest request, HttpServletResponse response) throws Throwable {\n+        ConnectionFactory cf1 = (ConnectionFactory) new InitialContext().lookup(\"java:comp/env/jms/cf1-unshareable\");\n+        Connection con1 = null;\n+        UserTransaction tran = (UserTransaction) new InitialContext().lookup(\"java:comp/UserTransaction\");\n+        try {\n+            tran.begin();//Starting this removes the LTC\n+            con1 = cf1.createConnection();\n+\n+            MBeanServer mbs = ManagementFactory.getPlatformMBeanServer();\n+            ObjectInstance bean = getMBeanObjectInstance(\"jms/cf1\");\n+\n+            con1.close();\n+            tran.commit();\n+\n+            //Attempt to mark connections stale right before they are purged\n+            ExecutorService exec = Executors.newFixedThreadPool(2);\n+            List<Callable<Boolean>> callables = Arrays.asList(new MarkStale(mbs, bean), new PurgeTask(mbs, bean));\n+            List<Future<Boolean>> futures = exec.invokeAll(callables);\n+            awaitTerminationAfterShutdown(exec);\n+\n+            System.out.println(\"**  Pool contents after purge:\\n\" + getPoolContents(bean));\n+            if (getPoolSize(bean) != 0)\n+                throw new Exception(\"Not all connections were purged from the pool!\");\n+\n+            assertTrue(futures.get(0).get().booleanValue());\n+            assertTrue(futures.get(1).get().booleanValue());\n+        } finally {\n+            if (con1 != null)\n+                con1.close();\n+        }\n+    }\n+\n+    @SuppressWarnings(\"restriction\")\n+    private class MarkStale implements Callable<Boolean> {\n+        MCWrapper[] wrappers;\n+\n+        MarkStale(MBeanServer mbs, ObjectInstance bean) {\n+            //Get at MCWrappers from poolmanager]\n+            try {\n+                // TODO figure out a way to get at the pool manager so that we can call:\n+//                wrappers = pm.getUnSharedPoolConnections(); //NOTE this will get a lock\n+            } catch (Exception e) {\n+                throw new RuntimeException(\"Failed to get wrappers\", e);\n+            }\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31412b57d8363f886f19769ff4d6ff71267d0a4c"}, "originalPosition": 85}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "31412b57d8363f886f19769ff4d6ff71267d0a4c", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/31412b57d8363f886f19769ff4d6ff71267d0a4c", "committedDate": "2020-11-18T20:10:52Z", "message": "avoid illegal state exception"}, "afterCommit": {"oid": "87205b4209289648ce6d128e0782e4fc73a79098", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/87205b4209289648ce6d128e0782e4fc73a79098", "committedDate": "2020-11-30T15:32:16Z", "message": "avoid illegal state exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87205b4209289648ce6d128e0782e4fc73a79098", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/87205b4209289648ce6d128e0782e4fc73a79098", "committedDate": "2020-11-30T15:32:16Z", "message": "avoid illegal state exception"}, "afterCommit": {"oid": "246426f7e11f040cf6c31003bca5bf9c1846fd57", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/246426f7e11f040cf6c31003bca5bf9c1846fd57", "committedDate": "2020-11-30T21:13:14Z", "message": "avoid illegal state exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "246426f7e11f040cf6c31003bca5bf9c1846fd57", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/246426f7e11f040cf6c31003bca5bf9c1846fd57", "committedDate": "2020-11-30T21:13:14Z", "message": "avoid illegal state exception"}, "afterCommit": {"oid": "6cbaa9146e660859ae3543d38f41d8a9aaae2506", "author": {"user": null}, "url": "https://github.com/OpenLiberty/open-liberty/commit/6cbaa9146e660859ae3543d38f41d8a9aaae2506", "committedDate": "2020-11-30T20:29:34Z", "message": "Allow addExpirable() before Expirer.start()"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cbaa9146e660859ae3543d38f41d8a9aaae2506", "author": {"user": null}, "url": "https://github.com/OpenLiberty/open-liberty/commit/6cbaa9146e660859ae3543d38f41d8a9aaae2506", "committedDate": "2020-11-30T20:29:34Z", "message": "Allow addExpirable() before Expirer.start()"}, "afterCommit": {"oid": "5dad895472fd2a9496435367dc6475321e9341f2", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/5dad895472fd2a9496435367dc6475321e9341f2", "committedDate": "2020-11-30T21:19:31Z", "message": "avoid illegal state exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5dad895472fd2a9496435367dc6475321e9341f2", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/5dad895472fd2a9496435367dc6475321e9341f2", "committedDate": "2020-11-30T21:19:31Z", "message": "avoid illegal state exception"}, "afterCommit": {"oid": "9ea81cf818c3f6bc80296c3bceb9f42fa0b8cde8", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/9ea81cf818c3f6bc80296c3bceb9f42fa0b8cde8", "committedDate": "2020-11-30T21:23:04Z", "message": "avoid illegal state exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ea81cf818c3f6bc80296c3bceb9f42fa0b8cde8", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/9ea81cf818c3f6bc80296c3bceb9f42fa0b8cde8", "committedDate": "2020-11-30T21:23:04Z", "message": "avoid illegal state exception"}, "afterCommit": {"oid": "58250254f917152876907a9b982330e146431968", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/58250254f917152876907a9b982330e146431968", "committedDate": "2020-12-01T19:18:41Z", "message": "avoid illegal state exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58250254f917152876907a9b982330e146431968", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/58250254f917152876907a9b982330e146431968", "committedDate": "2020-12-01T19:18:41Z", "message": "avoid illegal state exception"}, "afterCommit": {"oid": "93f01301d65daaf44ce8447f77a750e74f15749b", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/93f01301d65daaf44ce8447f77a750e74f15749b", "committedDate": "2020-12-03T21:10:47Z", "message": "avoid illegal state exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93f01301d65daaf44ce8447f77a750e74f15749b", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/93f01301d65daaf44ce8447f77a750e74f15749b", "committedDate": "2020-12-03T21:10:47Z", "message": "avoid illegal state exception"}, "afterCommit": {"oid": "e32bd034dd06ec02026a346f6b1e87ef282ee2de", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/e32bd034dd06ec02026a346f6b1e87ef282ee2de", "committedDate": "2020-12-04T21:14:47Z", "message": "avoid illegal state exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d18c8b4a5bd0aad829e08a9b0c418b86e99009e", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/2d18c8b4a5bd0aad829e08a9b0c418b86e99009e", "committedDate": "2021-01-20T16:01:25Z", "message": "update copyright"}, "afterCommit": {"oid": "d5df91cf3756fba8902c189b9ca8fa4fb163d42c", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/d5df91cf3756fba8902c189b9ca8fa4fb163d42c", "committedDate": "2021-01-20T18:42:09Z", "message": "update copyright"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d711019d5f04380e039d04413afc5d4792f4a20", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/1d711019d5f04380e039d04413afc5d4792f4a20", "committedDate": "2021-01-20T19:37:03Z", "message": "avoid illegal state exception\n\nupdate copyright"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d5df91cf3756fba8902c189b9ca8fa4fb163d42c", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/d5df91cf3756fba8902c189b9ca8fa4fb163d42c", "committedDate": "2021-01-20T18:42:09Z", "message": "update copyright"}, "afterCommit": {"oid": "1d711019d5f04380e039d04413afc5d4792f4a20", "author": {"user": {"login": "KyleAure", "name": "Kyle Aure"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/1d711019d5f04380e039d04413afc5d4792f4a20", "committedDate": "2021-01-20T19:37:03Z", "message": "avoid illegal state exception\n\nupdate copyright"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc4ODE3Mzk0", "url": "https://github.com/OpenLiberty/open-liberty/pull/15043#pullrequestreview-578817394", "createdAt": "2021-01-28T23:07:42Z", "commit": {"oid": "1d711019d5f04380e039d04413afc5d4792f4a20"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2848, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}