{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxOTU0MTQ0", "number": 14122, "title": "Rework KerberosTicket refresh mechanism", "bodyText": "#build", "createdAt": "2020-09-23T18:16:15Z", "url": "https://github.com/OpenLiberty/open-liberty/pull/14122", "merged": true, "mergeCommit": {"oid": "ddbdd864958edf46e3fa48af473ec910a0cc045c"}, "closed": true, "closedAt": "2020-09-28T14:52:24Z", "author": {"login": "aguibert"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMDE2EAFqTQ5NTcwNTAzMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMcMDZAFqTQ5Njg1MTAyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NzA1MDMz", "url": "https://github.com/OpenLiberty/open-liberty/pull/14122#pullrequestreview-495705033", "createdAt": "2020-09-24T15:39:20Z", "commit": {"oid": "fba303f2fea9354125808933198a34c2b92b0e6f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNTozOToyMFrOHXg-pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNTozOToyMFrOHXg-pA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQxOTYyMA==", "bodyText": "This remove/add code is what needed to be replaced, since sub.getPrivateCredentials(KerberosTicket.class) only returns a copy of the credential set, not the actual set of credentials", "url": "https://github.com/OpenLiberty/open-liberty/pull/14122#discussion_r494419620", "createdAt": "2020-09-24T15:39:20Z", "author": {"login": "aguibert"}, "path": "dev/com.ibm.ws.security.kerberos.auth/src/com/ibm/ws/security/kerberos/auth/internal/LRUCache.java", "diffHunk": "@@ -84,37 +86,38 @@ public Subject get(KerberosPrincipal principal) {\n \n             // Ensure the KerberosTicket is current and attempt to renew if not\n             Set<KerberosTicket> kerbTickets = sub.getPrivateCredentials(KerberosTicket.class);\n-            KerberosTicket renewedTicket = null;\n-            KerberosTicket oldTicket = null;\n             for (KerberosTicket kerbTicket : kerbTickets) {\n-                if (!kerbTicket.isCurrent()) {\n-                    if (kerbTicket.isRenewable()) {\n-                        // If the ticket is not current but is renewable, try to renew the ticket if\n-                        // there is at least 10m remaining on the renewTill time\n-                        long renewTillMs = kerbTicket.getRenewTill().getTime();\n-                        long timeLeft = renewTillMs - System.currentTimeMillis() - TimeUnit.MINUTES.toMillis(10);\n-                        if (timeLeft < 0) {\n+                if (kerbTicket.isCurrent()) {\n+                    // we have a valid ticket\n+                    break;\n+                }\n+\n+                if (kerbTicket.isRenewable()) {\n+                    // If the ticket is not current but is renewable, try to renew the ticket if\n+                    // there is at least 10m remaining on the renewTill time\n+                    Instant renewTill = kerbTicket.getRenewTill().toInstant().minus(10, ChronoUnit.MINUTES);\n+                    if (Instant.now().isAfter(renewTill)) {\n+                        if (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled())\n+                            Tr.debug(tc, \"no match because is renewable but past the renewTill time. renewTill=\" + renewTill);\n+                        return null;\n+                    } else {\n+                        if (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled())\n+                            Tr.debug(tc, \"found match for non-current ticket, but ticket is renewable. Attempting to renew now\");\n+                        try {\n+                            kerbTicket.refresh();\n+                        } catch (RefreshFailedException e) {\n                             if (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled())\n-                                Tr.debug(tc, \"no match because is renewable but past the renewTill time. timeLeft=\" + timeLeft);\n+                                Tr.debug(tc, \"unable to refresh kerberos ticket due to: \" + e);\n                             return null;\n-                        } else {\n-                            if (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled())\n-                                Tr.debug(tc, \"found match for non-current ticket, but ticket is renewable. Attempting to renew now\");\n-                            oldTicket = kerbTicket;\n-                            renewedTicket = cloneTicket(kerbTicket);\n-                            break;\n                         }\n-                    } else {\n-                        if (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled())\n-                            Tr.debug(tc, \"no match because ticket is not current and not renewable\");\n-                        return null;\n+                        break;\n                     }\n+                } else {\n+                    if (TraceComponent.isAnyTracingEnabled() && tc.isDebugEnabled())\n+                        Tr.debug(tc, \"no match because ticket is not current and not renewable\");\n+                    return null;\n                 }\n             }\n-            if (oldTicket != null && renewedTicket != null) {\n-                kerbTickets.remove(oldTicket);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fba303f2fea9354125808933198a34c2b92b0e6f"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MDgzMjYw", "url": "https://github.com/OpenLiberty/open-liberty/pull/14122#pullrequestreview-496083260", "createdAt": "2020-09-25T03:13:48Z", "commit": {"oid": "fba303f2fea9354125808933198a34c2b92b0e6f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMzoxMzo0OFrOHXzgRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMzoxMzo0OFrOHXzgRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDcyMzE0MA==", "bodyText": "If the kerberos ticket is current but almost expired, should we try to refresh it?", "url": "https://github.com/OpenLiberty/open-liberty/pull/14122#discussion_r494723140", "createdAt": "2020-09-25T03:13:48Z", "author": {"login": "utle"}, "path": "dev/com.ibm.ws.security.kerberos.auth/src/com/ibm/ws/security/kerberos/auth/internal/LRUCache.java", "diffHunk": "@@ -84,37 +86,38 @@ public Subject get(KerberosPrincipal principal) {\n \n             // Ensure the KerberosTicket is current and attempt to renew if not\n             Set<KerberosTicket> kerbTickets = sub.getPrivateCredentials(KerberosTicket.class);\n-            KerberosTicket renewedTicket = null;\n-            KerberosTicket oldTicket = null;\n             for (KerberosTicket kerbTicket : kerbTickets) {\n-                if (!kerbTicket.isCurrent()) {\n-                    if (kerbTicket.isRenewable()) {\n-                        // If the ticket is not current but is renewable, try to renew the ticket if\n-                        // there is at least 10m remaining on the renewTill time\n-                        long renewTillMs = kerbTicket.getRenewTill().getTime();\n-                        long timeLeft = renewTillMs - System.currentTimeMillis() - TimeUnit.MINUTES.toMillis(10);\n-                        if (timeLeft < 0) {\n+                if (kerbTicket.isCurrent()) {\n+                    // we have a valid ticket\n+                    break;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fba303f2fea9354125808933198a34c2b92b0e6f"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "898e8e4f1508022fadebe23153d0874dc02d374a", "author": {"user": {"login": "aguibert", "name": "Andrew Guibert"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/898e8e4f1508022fadebe23153d0874dc02d374a", "committedDate": "2020-09-25T20:29:50Z", "message": "Rework KerberosTicket refresh mechanism"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fba303f2fea9354125808933198a34c2b92b0e6f", "author": {"user": {"login": "aguibert", "name": "Andrew Guibert"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/fba303f2fea9354125808933198a34c2b92b0e6f", "committedDate": "2020-09-23T18:15:54Z", "message": "Rework KerberosTicket refresh mechanism"}, "afterCommit": {"oid": "898e8e4f1508022fadebe23153d0874dc02d374a", "author": {"user": {"login": "aguibert", "name": "Andrew Guibert"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/898e8e4f1508022fadebe23153d0874dc02d374a", "committedDate": "2020-09-25T20:29:50Z", "message": "Rework KerberosTicket refresh mechanism"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2ODUxMDI4", "url": "https://github.com/OpenLiberty/open-liberty/pull/14122#pullrequestreview-496851028", "createdAt": "2020-09-25T20:54:50Z", "commit": {"oid": "898e8e4f1508022fadebe23153d0874dc02d374a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3289, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}