{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4ODYzODc5", "number": 12763, "title": "Improve performance when no tracer is found", "bodyText": "With MicroProfile-3.x feature is enabled, mpOpenTracing-1.3 is also enabled although users have no intention of using OpenTracing.  Most likely the loading of a tracer will fail.  Previously, mpOT code tried to load the tracer on every JAX-RS request.\nThis PR will make the following changes:-\n\nLoad tracer only once.  A dummy tracer is stored in the tracer map when the initial loading of the tracer is failed.  Subsequent requests will not load the tracer again when the map has a dummy tracer.\nAppStateListener is added to listener when an application stopped.  The corresponding entry in the tracer map will be removed.\nAppStateListener also listens to <Library /> changes.  All entries in the tracer map will be cleared.\n\nFixes #12613", "createdAt": "2020-06-23T22:49:52Z", "url": "https://github.com/OpenLiberty/open-liberty/pull/12763", "merged": true, "mergeCommit": {"oid": "898fa03bc635a57aa50eb67e9941a7012d9c4981"}, "closed": true, "closedAt": "2020-07-08T19:43:22Z", "author": {"login": "fmhwong"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuNgIyABqjM0NzUwOTc0Mzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy_DgugFqTQ0NTA0MDgwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "267800e71f64d138ee2de98fb7344ad2fd0c5d36", "author": {"user": {"login": "fmhwong", "name": "Felix Wong"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/267800e71f64d138ee2de98fb7344ad2fd0c5d36", "committedDate": "2020-06-23T22:36:28Z", "message": "Load tracer once only"}, "afterCommit": {"oid": "a3f23c7f61af136105b50ae44770f2ccacbfcdf9", "author": {"user": {"login": "fmhwong", "name": "Felix Wong"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/a3f23c7f61af136105b50ae44770f2ccacbfcdf9", "committedDate": "2020-06-23T22:39:36Z", "message": "Load tracer once only"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3f23c7f61af136105b50ae44770f2ccacbfcdf9", "author": {"user": {"login": "fmhwong", "name": "Felix Wong"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/a3f23c7f61af136105b50ae44770f2ccacbfcdf9", "committedDate": "2020-06-23T22:39:36Z", "message": "Load tracer once only"}, "afterCommit": {"oid": "f583b32d89b899bc53e245e7e7d92aeac9bb8fbc", "author": {"user": {"login": "fmhwong", "name": "Felix Wong"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/f583b32d89b899bc53e245e7e7d92aeac9bb8fbc", "committedDate": "2020-06-23T22:51:53Z", "message": "Load tracer once only"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f583b32d89b899bc53e245e7e7d92aeac9bb8fbc", "author": {"user": {"login": "fmhwong", "name": "Felix Wong"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/f583b32d89b899bc53e245e7e7d92aeac9bb8fbc", "committedDate": "2020-06-23T22:51:53Z", "message": "Load tracer once only"}, "afterCommit": {"oid": "1570466789d836d8e24f8fcb3e3eb2b5abbf421b", "author": {"user": {"login": "fmhwong", "name": "Felix Wong"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/1570466789d836d8e24f8fcb3e3eb2b5abbf421b", "committedDate": "2020-07-02T20:57:44Z", "message": "Load tracer once only"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MjgxNDQz", "url": "https://github.com/OpenLiberty/open-liberty/pull/12763#pullrequestreview-444281443", "createdAt": "2020-07-07T22:02:40Z", "commit": {"oid": "1570466789d836d8e24f8fcb3e3eb2b5abbf421b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjowMjo0MFrOGuRNAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjowNzo1MVrOGuRU6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE2OTUzOQ==", "bodyText": "Do you need to \"unregister\" the Library listener on deactivate?  It all goes away maybe when deactivate is done?", "url": "https://github.com/OpenLiberty/open-liberty/pull/12763#discussion_r451169539", "createdAt": "2020-07-07T22:02:40Z", "author": {"login": "jhanders34"}, "path": "dev/com.ibm.ws.opentracing.1.3/src/com/ibm/ws/opentracing/AppStateListener.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 IBM Corporation and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *\n+ * Contributors:\n+ *     IBM Corporation - initial API and implementation\n+ *******************************************************************************/\n+package com.ibm.ws.opentracing;\n+\n+import java.util.Dictionary;\n+import java.util.Hashtable;\n+import java.util.Map;\n+\n+import org.osgi.framework.BundleContext;\n+import org.osgi.framework.ServiceReference;\n+import org.osgi.service.component.ComponentContext;\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.ConfigurationPolicy;\n+import org.osgi.service.component.annotations.Reference;\n+import org.osgi.service.component.annotations.ReferenceCardinality;\n+import org.osgi.service.component.annotations.ReferencePolicy;\n+\n+import com.ibm.ws.container.service.app.deploy.ApplicationInfo;\n+import com.ibm.ws.container.service.state.ApplicationStateListener;\n+import com.ibm.ws.container.service.state.StateChangeException;\n+import com.ibm.wsspi.kernel.service.utils.ConcurrentServiceReferenceSet;\n+import com.ibm.wsspi.library.Library;\n+import com.ibm.wsspi.library.LibraryChangeListener;\n+\n+@Component(service = { ApplicationStateListener.class }, configurationPolicy = ConfigurationPolicy.IGNORE, immediate = true, property = \"library=unbound\")\n+public class AppStateListener implements ApplicationStateListener, LibraryChangeListener {\n+\n+    private static final String LIBRARY = \"library\";\n+    private volatile ConcurrentServiceReferenceSet<Library> librarySet = new ConcurrentServiceReferenceSet<Library>(LIBRARY);\n+\n+    protected void activate(ComponentContext context, Map<String, Object> props) {\n+        librarySet.activate(context);\n+        for (ServiceReference<Library> ref : librarySet.references()) {\n+            registerLibraryListener(context.getBundleContext(), (String) ref.getProperty(\"id\"));\n+        }\n+    }\n+\n+    protected void deactivate(ComponentContext context) {\n+        librarySet.deactivate(context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1570466789d836d8e24f8fcb3e3eb2b5abbf421b"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3MDExNw==", "bodyText": "if appName is null this will also fail with a NullPointerException.", "url": "https://github.com/OpenLiberty/open-liberty/pull/12763#discussion_r451170117", "createdAt": "2020-07-07T22:04:14Z", "author": {"login": "jhanders34"}, "path": "dev/com.ibm.ws.opentracing.1.3/src/com/ibm/ws/opentracing/OpentracingTracerManager.java", "diffHunk": "@@ -47,14 +50,21 @@ private static Tracer ensureTracer(String appName) {\n             Tr.entry(tc, methodName, appName);\n         }\n \n-        Tracer tracer = applicationTracers.get(appName);\n+        Tracer tracer = null;\n         boolean found = true;\n+        if (appName != null) {\n+            tracer = applicationTracers.get(appName);\n+        }\n \n         if (tracer == null) {\n             found = false;\n             tracer = applicationTracers.computeIfAbsent(appName, TracerCreator.INSTANCE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1570466789d836d8e24f8fcb3e3eb2b5abbf421b"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3MTU2MQ==", "bodyText": "update the copyright?", "url": "https://github.com/OpenLiberty/open-liberty/pull/12763#discussion_r451171561", "createdAt": "2020-07-07T22:07:51Z", "author": {"login": "jhanders34"}, "path": "dev/com.ibm.ws.opentracing.1.3/bnd.bnd", "diffHunk": "@@ -22,7 +22,8 @@ WS-TraceGroup: OPENTRACING\n -dsannotations: com.ibm.ws.opentracing.OpentracingUserFeatureAccessService, \\\n                 com.ibm.ws.opentracing.OpentracingJaxRsProviderRegister, \\\n                 com.ibm.ws.opentracing.OpentracingJaxRsEMCallbackImpl, \\\n-                com.ibm.ws.opentracing.OpentracingService\n+                com.ibm.ws.opentracing.OpentracingService, \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1570466789d836d8e24f8fcb3e3eb2b5abbf421b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92f4a9fbfe9e9180484b77b6fb3b115776dae9ac", "author": {"user": {"login": "fmhwong", "name": "Felix Wong"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/92f4a9fbfe9e9180484b77b6fb3b115776dae9ac", "committedDate": "2020-07-08T02:26:27Z", "message": "Load tracer once only"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1570466789d836d8e24f8fcb3e3eb2b5abbf421b", "author": {"user": {"login": "fmhwong", "name": "Felix Wong"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/1570466789d836d8e24f8fcb3e3eb2b5abbf421b", "committedDate": "2020-07-02T20:57:44Z", "message": "Load tracer once only"}, "afterCommit": {"oid": "92f4a9fbfe9e9180484b77b6fb3b115776dae9ac", "author": {"user": {"login": "fmhwong", "name": "Felix Wong"}}, "url": "https://github.com/OpenLiberty/open-liberty/commit/92f4a9fbfe9e9180484b77b6fb3b115776dae9ac", "committedDate": "2020-07-08T02:26:27Z", "message": "Load tracer once only"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDQwODA3", "url": "https://github.com/OpenLiberty/open-liberty/pull/12763#pullrequestreview-445040807", "createdAt": "2020-07-08T18:50:09Z", "commit": {"oid": "92f4a9fbfe9e9180484b77b6fb3b115776dae9ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2315, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}