{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3MzQyMzg4", "number": 224, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxOTowOToyM1rODhL7vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxODo1ODozNlrODjMv9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2MTI1MTE2OnYy", "diffSide": "RIGHT", "path": "apps/bfd-model/bfd-model-rif/src/main/resources/db/migration/V25__Add_partd_contract_number_index.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxOTowOToyM1rOFrz-Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxOTowOToyM1rOFrz-Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ4NDY0Ng==", "bodyText": "This is missing the update to provide ${logic.using-hash}", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/224#discussion_r381484646", "createdAt": "2020-02-19T19:09:23Z", "author": {"login": "whytheplatypus"}, "path": "apps/bfd-model/bfd-model-rif/src/main/resources/db/migration/V25__Add_partd_contract_number_index.sql", "diffHunk": "@@ -0,0 +1,36 @@\n+\n+create index ${logic.index-create-concurrently} \"Beneficiaries_partd_contract_number_jan_id_idx\"\n+    on \"Beneficiaries\" ${logic.using-hash} (\"partDContractNumberJanId\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b44cefd1c67d21d3445259d45350f5d24378117f"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2OTg2MDQzOnYy", "diffSide": "RIGHT", "path": "apps/bfd-model/bfd-model-rif/src/main/resources/db/migration/V25__Add_partd_contract_number_index.sql", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMDo0NjozN1rOFtEH2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMDo0NjozN1rOFtEH2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc5Nzc4NA==", "bodyText": "Did you consider a partial index (ie. an index with a where clause)? Looking at the shape of these columns, the data look's very sparse, with 0,N, and C being the most common values. Real contracts like H0023 only make a small ~10% of the data. If possible, using a partial index will make the index much smaller and perform much better.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/224#discussion_r382797784", "createdAt": "2020-02-21T20:46:37Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-model/bfd-model-rif/src/main/resources/db/migration/V25__Add_partd_contract_number_index.sql", "diffHunk": "@@ -0,0 +1,36 @@\n+\n+create index ${logic.index-create-concurrently} \"Beneficiaries_partd_contract_number_jan_id_idx\"\n+    on \"Beneficiaries\" ${logic.using-hash} (\"partDContractNumberJanId\");\n+\n+create index ${logic.index-create-concurrently} \"Beneficiaries_partd_contract_number_feb_id_idx\"\n+    on \"Beneficiaries\" ${logic.using-hash} (\"partDContractNumberFebId\");\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b44cefd1c67d21d3445259d45350f5d24378117f"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2OTg2NTMxOnYy", "diffSide": "RIGHT", "path": "apps/bfd-model/bfd-model-rif/src/main/resources/db/migration/V25__Add_partd_contract_number_index.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMDo0ODoxOVrOFtEKvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMDo0ODoxOVrOFtEKvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc5ODUyNw==", "bodyText": "I like the idea of using a hash index.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/224#discussion_r382798527", "createdAt": "2020-02-21T20:48:19Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-model/bfd-model-rif/src/main/resources/db/migration/V25__Add_partd_contract_number_index.sql", "diffHunk": "@@ -0,0 +1,36 @@\n+\n+create index ${logic.index-create-concurrently} \"Beneficiaries_partd_contract_number_jan_id_idx\"\n+    on \"Beneficiaries\" ${logic.using-hash} (\"partDContractNumberJanId\");\n+\n+create index ${logic.index-create-concurrently} \"Beneficiaries_partd_contract_number_feb_id_idx\"\n+    on \"Beneficiaries\" ${logic.using-hash} (\"partDContractNumberFebId\");\n+\n+create index ${logic.index-create-concurrently} \"Beneficiaries_partd_contract_number_mar_id_idx\"\n+    on \"Beneficiaries\" ${logic.using-hash} (\"partDContractNumberMarId\");\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b44cefd1c67d21d3445259d45350f5d24378117f"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTU1NDcwOnYy", "diffSide": "RIGHT", "path": "apps/bfd-model/bfd-model-rif/src/main/java/gov/cms/bfd/model/rif/schema/DatabaseSchemaManager.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTozMDoyOVrOFuwOQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTo0MjoyMlrOFuwujQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2ODg5Ng==", "bodyText": "This name makes my head hurt. Could we just call it the postgresql-only-line?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/224#discussion_r384568896", "createdAt": "2020-02-26T15:30:29Z", "author": {"login": "karlmdavis"}, "path": "apps/bfd-model/bfd-model-rif/src/main/java/gov/cms/bfd/model/rif/schema/DatabaseSchemaManager.java", "diffHunk": "@@ -89,6 +89,7 @@ public static void dropIndexes(DataSource dataSource) {\n         placeholders.put(\"logic.index-create-concurrently\", \"\");\n         placeholders.put(\"logic.sequence-start\", \"start with\");\n         placeholders.put(\"logic.sequence-increment\", \"increment by\");\n+        placeholders.put(\"logic.non-hsql-only-line\", \"--\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d9b5ac4de630a72fa9803a7b488cc1e5cf444d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3NzE2NQ==", "bodyText": "sure, although that's also confusing since there's no mention of postgres anywhere else.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/224#discussion_r384577165", "createdAt": "2020-02-26T15:42:22Z", "author": {"login": "whytheplatypus"}, "path": "apps/bfd-model/bfd-model-rif/src/main/java/gov/cms/bfd/model/rif/schema/DatabaseSchemaManager.java", "diffHunk": "@@ -89,6 +89,7 @@ public static void dropIndexes(DataSource dataSource) {\n         placeholders.put(\"logic.index-create-concurrently\", \"\");\n         placeholders.put(\"logic.sequence-start\", \"start with\");\n         placeholders.put(\"logic.sequence-increment\", \"increment by\");\n+        placeholders.put(\"logic.non-hsql-only-line\", \"--\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2ODg5Ng=="}, "originalCommit": {"oid": "73d9b5ac4de630a72fa9803a7b488cc1e5cf444d"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTU1OTcyOnYy", "diffSide": "RIGHT", "path": "apps/bfd-model/bfd-model-rif/src/main/resources/db/migration/V25__Add_partd_contract_number_index.sql", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTozMTozNFrOFuwRVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo0MzozNFrOFuzW7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2OTY4Nw==", "bodyText": "Did you want to keep the partial index, even though the CONCURRENT likely covers the original concern?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/224#discussion_r384569687", "createdAt": "2020-02-26T15:31:34Z", "author": {"login": "karlmdavis"}, "path": "apps/bfd-model/bfd-model-rif/src/main/resources/db/migration/V25__Add_partd_contract_number_index.sql", "diffHunk": "@@ -0,0 +1,59 @@\n+\n+create index ${logic.index-create-concurrently} \"Beneficiaries_partd_contract_number_jan_id_idx\"\n+    on \"Beneficiaries\" (\"partDContractNumberJanId\")\n+    ${logic.non-hsql-only-line} where length(\"partDContractNumberJanId\") = 5\n+    ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d9b5ac4de630a72fa9803a7b488cc1e5cf444d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYyMDI3MQ==", "bodyText": "I'm not seeing an appreciable relative improvement in performance with the partial index, so I'll plan on removing in the interest of simplicity.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/224#discussion_r384620271", "createdAt": "2020-02-26T16:43:34Z", "author": {"login": "whytheplatypus"}, "path": "apps/bfd-model/bfd-model-rif/src/main/resources/db/migration/V25__Add_partd_contract_number_index.sql", "diffHunk": "@@ -0,0 +1,59 @@\n+\n+create index ${logic.index-create-concurrently} \"Beneficiaries_partd_contract_number_jan_id_idx\"\n+    on \"Beneficiaries\" (\"partDContractNumberJanId\")\n+    ${logic.non-hsql-only-line} where length(\"partDContractNumberJanId\") = 5\n+    ;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU2OTY4Nw=="}, "originalCommit": {"oid": "73d9b5ac4de630a72fa9803a7b488cc1e5cf444d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MTU2MjIxOnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTozMjoxNVrOFuwTDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTozMjoxNVrOFuwTDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3MDEyNQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // Triggers indexes built with a where field = length clause\n          \n          \n            \n                        // This additional `WHERE` clause must be present to trigger partial indexes, which were built with a where field = length clause.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/224#discussion_r384570125", "createdAt": "2020-02-26T15:32:15Z", "author": {"login": "karlmdavis"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -379,7 +379,11 @@ private CriteriaQuery queryBeneficiariesBy(\n               beneMatchesRoot.fetch(f, JoinType.LEFT);\n             });\n     beneMatches.select(beneMatchesRoot);\n-    beneMatches.where(builder.equal(beneMatchesRoot.get(field), value));\n+    beneMatches.where(\n+        builder.and(\n+            builder.equal(beneMatchesRoot.get(field), value),\n+            // Triggers indexes built with a where field = length clause", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73d9b5ac4de630a72fa9803a7b488cc1e5cf444d"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MjM1NjM5OnYy", "diffSide": "RIGHT", "path": "apps/bfd-model/bfd-model-rif/src/main/resources/db/migration/V25__Add_partd_contract_number_index.sql", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxODo1ODozNlrOFu4DtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxOTowMjo1NFrOFu4M1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY5NzI2OA==", "bodyText": "Sorry, one last thing: I'd add a header comment here that explains the reason for the change and references the JIRA ticket.\nI wouldn't do that everywhere, but makes sense for DB migrations to me, as I often read them start - end, and I suspect other folks do, too. Good chance to help folks understand how & why the app has evolved over time.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/224#discussion_r384697268", "createdAt": "2020-02-26T18:58:36Z", "author": {"login": "karlmdavis"}, "path": "apps/bfd-model/bfd-model-rif/src/main/resources/db/migration/V25__Add_partd_contract_number_index.sql", "diffHunk": "@@ -0,0 +1,36 @@\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "901e1aa794208300d0ebf08c63f6dde78948558f"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY5OTYwNg==", "bodyText": "good call, done.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/224#discussion_r384699606", "createdAt": "2020-02-26T19:02:54Z", "author": {"login": "whytheplatypus"}, "path": "apps/bfd-model/bfd-model-rif/src/main/resources/db/migration/V25__Add_partd_contract_number_index.sql", "diffHunk": "@@ -0,0 +1,36 @@\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDY5NzI2OA=="}, "originalCommit": {"oid": "901e1aa794208300d0ebf08c63f6dde78948558f"}, "originalPosition": 1}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 304, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}