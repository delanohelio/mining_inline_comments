{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMjIyMTM2", "number": 234, "title": "BLUEBUTTON-1281: Jenkins Build, Update and Deploy", "bodyText": "Change Details\nThis PR attempts to improve our jenkins building, updating and deployment process.\nUpdates Readme and Instructions for Build, Update and Deployment\nDeployment\n\nTF - Adds jenkins_boundary policy to jenkins role\nTF - Via a EFS module, Provisions EFS and mount point, to replace EBS JENKINS_HOME.\nTF - Updated to reflect the need for two environments, mgmt and mgmt-test.\nTF - Removes extra Jenkins permissions / groups, not needed. Simplified.\nTF - Moves to launch templates for ASG's.\nPacker - Updates jenkins build and config packer templates to include additional var (env).\nAnsible - Rekeys jenkins vault with new vault pass\n\nBuilding the Jenkins AMI\n\nSecured and segmented ssh access for all engineers via ssh_users role\nInstalls and configures the Cloudwatch agent.\nInstalls ops tools (aws, jq, terraform via tfenv, ansible, pip) via ops_tools role\nAdds paramterized-scheduler plugin\nInstalls the swarm plugin\nBumps instance size to c5.xlarge\nConfigured lockable-resource plugin (lock envs)\nMounts EFS for JENKINS_HOME (/var/lib/jenkins)\nUpdates github token (rotated)\nRemoves proxy (healthapt leftover)\nremoves epel_repo role, not needed.\nInstalls nfs-utils for EFS mounting.\n\nUpdate Jenkins\n\nSimplified plugin update task\nAdds EFS mount role.\n\nAcceptance Validation\nI've built, updates and deployed to both the mgmt-test and mgmt environments using this new code. Will want to peer review this PR, show output, answer questions. It's a lot to take in and I'm happy to do an interactive review at first pass and let reviewing engineers then take it away.\nExternal References\n\nBLUEBUTTON-1281\n\nSecurity Implications\n\n\n new software dependencies\n\n\n\n altered security controls\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n requires more information or team discussion to evaluate security implications", "createdAt": "2020-03-03T22:27:56Z", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234", "merged": true, "mergeCommit": {"oid": "cd44c1f09e4a550bb759c2629ea4cfa4c21d0f8b"}, "closed": true, "closedAt": "2020-03-16T18:11:54Z", "author": {"login": "jzulim"}, "timelineItems": {"totalCount": 85, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDFQ9JAH2gAyMzgzMjIyMTM2OmJhZTZmMDMzM2YwNWZkYmUxMmNlZDk3NDJiYjc3YTgyODMzNTk5ZmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMWMLNgFqTM3MjE4MjM5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bae6f0333f05fdbe12ced9742bb77a82833599fe", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/bae6f0333f05fdbe12ced9742bb77a82833599fe", "committedDate": "2020-02-10T22:55:54Z", "message": "remove install_epel_repo role, not needed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a4be4b1ef1e5a4d686fc8da80aa811574459644", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/2a4be4b1ef1e5a4d686fc8da80aa811574459644", "committedDate": "2020-02-10T22:55:54Z", "message": "Install tools aws,jq and TF config updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55ecc2673805216447058d82ed98a99ebc1fc33e", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/55ecc2673805216447058d82ed98a99ebc1fc33e", "committedDate": "2020-02-10T22:55:54Z", "message": "Add Jenkins Boundry to Jenkins role."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "044cf7368de0ca008aaa45403ab95a6bae04148d", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/044cf7368de0ca008aaa45403ab95a6bae04148d", "committedDate": "2020-02-10T22:55:55Z", "message": "Install and configure Lockable Resource plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6c77485daaaed908cc87527759d5f17192a1bc6", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/e6c77485daaaed908cc87527759d5f17192a1bc6", "committedDate": "2020-02-10T22:55:55Z", "message": "Adding default AWS CLI config template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfacbb21feb208811b101dbb133f00340357258b", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/dfacbb21feb208811b101dbb133f00340357258b", "committedDate": "2020-02-10T22:55:55Z", "message": "Bump instance size and add ssh_users role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aff1bdc92357ef44d39bdee8df197d4d39c9a5c", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/0aff1bdc92357ef44d39bdee8df197d4d39c9a5c", "committedDate": "2020-02-10T22:55:56Z", "message": "Adding map for loackable resource def"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b92391cd2dea56db35352796ee0bba0f29518f81", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/b92391cd2dea56db35352796ee0bba0f29518f81", "committedDate": "2020-02-10T22:58:17Z", "message": "EFS Scaffolding."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63762b78936da1f7962630751690d1dfd4cc77be", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/63762b78936da1f7962630751690d1dfd4cc77be", "committedDate": "2020-02-10T22:58:17Z", "message": "Add nfs-utils to jenkins playbook"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4596640c7fe1c3185131be67f3fd828ece151fc6", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/4596640c7fe1c3185131be67f3fd828ece151fc6", "committedDate": "2020-02-10T23:03:00Z", "message": "Initial mgmt-test environment TF"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbf57d7139a0081b3ab77e2fbc0a339e46bd810a", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/bbf57d7139a0081b3ab77e2fbc0a339e46bd810a", "committedDate": "2020-02-10T23:03:00Z", "message": "Tweaking var values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d66836f723fe80d4753fee6118dce1f4ebe816a", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/4d66836f723fe80d4753fee6118dce1f4ebe816a", "committedDate": "2020-02-10T23:05:40Z", "message": "Switch build jenkins from ebs to efs storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04a08530778ee109d31cd2268d6d6aac4eef6543", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/04a08530778ee109d31cd2268d6d6aac4eef6543", "committedDate": "2020-02-10T23:51:05Z", "message": "Rekey Jenkins Vault"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "456d8d2fa5c5d17d202a3df4f2f63a96205feb89", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/456d8d2fa5c5d17d202a3df4f2f63a96205feb89", "committedDate": "2020-02-10T23:55:30Z", "message": "ansible 2.8 requires efs_facts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aba06b36c13399004ed0cdfce810bbed4ec2f4bd", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/aba06b36c13399004ed0cdfce810bbed4ec2f4bd", "committedDate": "2020-02-11T01:50:35Z", "message": "Debug EFS and Add EFS Policy to packer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "587c51b42710e142c7927ea831b279a77ed06cc9", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/587c51b42710e142c7927ea831b279a77ed06cc9", "committedDate": "2020-02-11T22:43:08Z", "message": "Working EFS Mount Role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5524edc320205a2a7efcf2a715dc1e6173a589e2", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/5524edc320205a2a7efcf2a715dc1e6173a589e2", "committedDate": "2020-02-11T23:28:02Z", "message": "Adding paramterized-scheduler plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1eb9222b44b6904dde93aef70a712cd779e520f", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/b1eb9222b44b6904dde93aef70a712cd779e520f", "committedDate": "2020-02-12T02:55:39Z", "message": "Working around Jenkins Crumb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f824cabbb1690abfdd0d1daa2a2519ec2b11b45", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/8f824cabbb1690abfdd0d1daa2a2519ec2b11b45", "committedDate": "2020-02-12T04:59:59Z", "message": "Remove vault_proxy_host"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa5fde2b1e6d4b51cfdfda221ae8e1e3e74257cc", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/fa5fde2b1e6d4b51cfdfda221ae8e1e3e74257cc", "committedDate": "2020-02-12T16:50:37Z", "message": "Fixing crumb for jenkins security"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c93c4985c3da791f64d4a67d81db0f2572d1d00", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/4c93c4985c3da791f64d4a67d81db0f2572d1d00", "committedDate": "2020-02-17T20:42:34Z", "message": "Updating Readme"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "415a2ea653cd8e1cb072ee41b81b7e6ae76d44b8", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/415a2ea653cd8e1cb072ee41b81b7e6ae76d44b8", "committedDate": "2020-02-17T21:29:38Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f0a689464fabba864d49efd3b6aa4262ce01d61", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/0f0a689464fabba864d49efd3b6aa4262ce01d61", "committedDate": "2020-02-17T21:33:35Z", "message": "Updating Readme (again)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "928b2b1a578e8456dec59a4e9c7cbbf263ad0fa5", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/928b2b1a578e8456dec59a4e9c7cbbf263ad0fa5", "committedDate": "2020-02-18T19:11:47Z", "message": "FInal tweaks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3d2233a042e7ec9a108391d8b91d9f83ed5d6b1", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/a3d2233a042e7ec9a108391d8b91d9f83ed5d6b1", "committedDate": "2020-02-21T18:10:28Z", "message": "Adding ops_tools role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d3f2e73ee11fcf1bbe0568ed780aa1c254bac08", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/1d3f2e73ee11fcf1bbe0568ed780aa1c254bac08", "committedDate": "2020-02-24T18:58:42Z", "message": "Add new roles to update_jenkins playbook"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f83b55c5ef23d68247e4ba0a9a7ba698f87ae56", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/5f83b55c5ef23d68247e4ba0a9a7ba698f87ae56", "committedDate": "2020-02-25T00:05:59Z", "message": "Config CW agent for Jenkins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbd33fe263fe8852a881878af9781f333a542add", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/fbd33fe263fe8852a881878af9781f333a542add", "committedDate": "2020-02-25T01:58:18Z", "message": "MOve tfenv to permissiable location"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d00fe3076ed9458cae0590e531ae07deb8829afc", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/d00fe3076ed9458cae0590e531ae07deb8829afc", "committedDate": "2020-02-25T15:38:26Z", "message": "Updating vault with new git token and vault pw"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c0bbd2fa0a9b90b9dd840fe6df44b20cf4aa55e", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/4c0bbd2fa0a9b90b9dd840fe6df44b20cf4aa55e", "committedDate": "2020-03-01T22:04:11Z", "message": "remove install_epel_repo role, not needed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ba157c725dc1f0c2e9209154124a2136ca16c82", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/5ba157c725dc1f0c2e9209154124a2136ca16c82", "committedDate": "2020-03-01T22:04:13Z", "message": "Install tools aws,jq and TF config updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f844c1c67e7cceeb7c746c04869a77854c08ccf", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/4f844c1c67e7cceeb7c746c04869a77854c08ccf", "committedDate": "2020-03-01T22:04:14Z", "message": "Add Jenkins Boundry to Jenkins role."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed529016a7fc4b05938245f128ec2e1d461f67c5", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/ed529016a7fc4b05938245f128ec2e1d461f67c5", "committedDate": "2020-03-01T22:04:14Z", "message": "Install and configure Lockable Resource plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "442e93238f7da20afcebb52e4c59e4bf1b965d99", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/442e93238f7da20afcebb52e4c59e4bf1b965d99", "committedDate": "2020-03-01T22:04:15Z", "message": "Adding default AWS CLI config template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48865f074ac63079e119ec3eac311f418f899758", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/48865f074ac63079e119ec3eac311f418f899758", "committedDate": "2020-03-01T22:04:15Z", "message": "Bump instance size and add ssh_users role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3638daaed2fa1a1d61da247c3fc6e22e06be2e3c", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/3638daaed2fa1a1d61da247c3fc6e22e06be2e3c", "committedDate": "2020-03-01T22:04:15Z", "message": "Adding map for loackable resource def"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "729a9da4af4201b45eb4bbafba67fa655fd2e69b", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/729a9da4af4201b45eb4bbafba67fa655fd2e69b", "committedDate": "2020-03-01T22:04:16Z", "message": "EFS Scaffolding."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a06df05aec997d1e1e69042e39d1e7c45b0439d", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/2a06df05aec997d1e1e69042e39d1e7c45b0439d", "committedDate": "2020-03-01T22:04:16Z", "message": "Add nfs-utils to jenkins playbook"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b10aca85a16e01c3af3d4f4462cb6ff5d4feeba", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/8b10aca85a16e01c3af3d4f4462cb6ff5d4feeba", "committedDate": "2020-03-01T22:04:16Z", "message": "Initial mgmt-test environment TF"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cc45a8bac1346262f150fc9f6584cd27dcfdb6a", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/8cc45a8bac1346262f150fc9f6584cd27dcfdb6a", "committedDate": "2020-03-01T22:04:17Z", "message": "Tweaking var values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "671c4d8bea88bd1a35387726bdd8c7ba62353595", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/671c4d8bea88bd1a35387726bdd8c7ba62353595", "committedDate": "2020-03-01T22:04:17Z", "message": "Switch build jenkins from ebs to efs storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eab1159ca566d60b4c740c2b48c8e84225ac4bf8", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/eab1159ca566d60b4c740c2b48c8e84225ac4bf8", "committedDate": "2020-03-01T22:04:17Z", "message": "Rekey Jenkins Vault"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e18fdab28229c2fc1cfe76af4940e4cda1c9d4b", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/8e18fdab28229c2fc1cfe76af4940e4cda1c9d4b", "committedDate": "2020-03-01T22:04:17Z", "message": "ansible 2.8 requires efs_facts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9853fd9eab6e65732ec8600509ea47a055319fc", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/c9853fd9eab6e65732ec8600509ea47a055319fc", "committedDate": "2020-03-01T22:04:18Z", "message": "Debug EFS and Add EFS Policy to packer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac15f3391f3ad04450f8ef56a7a004ac4a5dc16f", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/ac15f3391f3ad04450f8ef56a7a004ac4a5dc16f", "committedDate": "2020-03-01T22:04:18Z", "message": "Working EFS Mount Role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7ef4332aef24746a112c70f7eed6b22f1d130e9", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/b7ef4332aef24746a112c70f7eed6b22f1d130e9", "committedDate": "2020-03-01T22:04:18Z", "message": "Adding paramterized-scheduler plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c517e69db441f3a5b86645477becdef1df20bb81", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/c517e69db441f3a5b86645477becdef1df20bb81", "committedDate": "2020-03-01T22:04:19Z", "message": "Working around Jenkins Crumb"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e33fb7d3a2cb1846314bb4ed37b7a88bea1c5628", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/e33fb7d3a2cb1846314bb4ed37b7a88bea1c5628", "committedDate": "2020-03-01T22:04:19Z", "message": "Remove vault_proxy_host"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9164ec88ba786293acadb4f2bcb4cd95b5883d3d", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/9164ec88ba786293acadb4f2bcb4cd95b5883d3d", "committedDate": "2020-03-01T22:04:19Z", "message": "Fixing crumb for jenkins security"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e45884c1fb4c48e52e34fe8ce527030559b98a3", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/0e45884c1fb4c48e52e34fe8ce527030559b98a3", "committedDate": "2020-03-01T22:04:20Z", "message": "Updating Readme"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8679bf7de23b729d9fb9067b4cd7814a93336516", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/8679bf7de23b729d9fb9067b4cd7814a93336516", "committedDate": "2020-03-01T22:04:20Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "123d26f7915b1d8ac5b003a71453e982fd56ce82", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/123d26f7915b1d8ac5b003a71453e982fd56ce82", "committedDate": "2020-03-01T22:04:21Z", "message": "Updating Readme (again)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "814e0a8155215dcfd2a701de89468681014607bd", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/814e0a8155215dcfd2a701de89468681014607bd", "committedDate": "2020-03-01T22:04:21Z", "message": "FInal tweaks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64b8fdd06344c142057e172f17cc8acb2263562c", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/64b8fdd06344c142057e172f17cc8acb2263562c", "committedDate": "2020-03-01T22:04:21Z", "message": "Adding ops_tools role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2eecb4ec68da3b83142eb97e28afa56f09ef8811", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/2eecb4ec68da3b83142eb97e28afa56f09ef8811", "committedDate": "2020-03-01T22:04:21Z", "message": "Add new roles to update_jenkins playbook"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5410cbdaa2eb7b0bebbc293ca3fdd7fe7ccb038", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/f5410cbdaa2eb7b0bebbc293ca3fdd7fe7ccb038", "committedDate": "2020-03-01T22:04:22Z", "message": "Config CW agent for Jenkins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aac1c20cb05ad7fda8b4f9a0e76891ff09f23907", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/aac1c20cb05ad7fda8b4f9a0e76891ff09f23907", "committedDate": "2020-03-01T22:04:22Z", "message": "MOve tfenv to permissiable location"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d60e8f777cef134709eb4a92f08926d85532c345", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/d60e8f777cef134709eb4a92f08926d85532c345", "committedDate": "2020-03-01T22:04:22Z", "message": "Updating vault with new git token and vault pw"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59234e66bf259b6e204de127d1477b6c751a31f1", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/59234e66bf259b6e204de127d1477b6c751a31f1", "committedDate": "2020-03-01T22:04:33Z", "message": "Merge branch 'BLUEBUTTON-1281-jenkins-build-ami' of https://github.com/CMSgov/beneficiary-fhir-data into BLUEBUTTON-1281-jenkins-build-ami"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f54e07447dfac0a245ed43dc8b38e27ee47b240", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/6f54e07447dfac0a245ed43dc8b38e27ee47b240", "committedDate": "2020-03-01T23:00:44Z", "message": "Extending EFS Variable for multi env"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55cc75ac3674a3b9d78425ff191d7706cc7c1d18", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/55cc75ac3674a3b9d78425ff191d7706cc7c1d18", "committedDate": "2020-03-02T02:34:23Z", "message": "Making use of env var"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "578a1591eddc07e421c5df0a77349ab83b21d6d3", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/578a1591eddc07e421c5df0a77349ab83b21d6d3", "committedDate": "2020-03-03T17:33:17Z", "message": "Jenkins sec, efs_dns and IAM cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83c45e8165783be30822c4a9ac1f28531ecb6332", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/83c45e8165783be30822c4a9ac1f28531ecb6332", "committedDate": "2020-03-03T21:28:02Z", "message": "Add efs_dns var to test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9748b2f4cd0ffb2364b7db4da5a28ff8cea849d", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/b9748b2f4cd0ffb2364b7db4da5a28ff8cea849d", "committedDate": "2020-03-03T22:24:48Z", "message": "Update README again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08ae2a024f39e28759cb17b346da21998ce85a13", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/08ae2a024f39e28759cb17b346da21998ce85a13", "committedDate": "2020-03-03T22:27:48Z", "message": "Add note to STOP jenkins before deploy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df464a91f7cd14da2011115d2027d72b5dab1087", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/df464a91f7cd14da2011115d2027d72b5dab1087", "committedDate": "2020-03-03T22:32:30Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0be5f705b3befebd9e9173df705cf68a210da32", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/d0be5f705b3befebd9e9173df705cf68a210da32", "committedDate": "2020-03-04T19:13:04Z", "message": "Adding swarm plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a558b6d2673c6f4f6a14f10df5e2654e8672be5", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/3a558b6d2673c6f4f6a14f10df5e2654e8672be5", "committedDate": "2020-03-05T14:37:21Z", "message": "Removing efs_dns var, not needed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/36d08302512da6b53dfffdc593ca946749bd5426", "committedDate": "2020-03-05T14:39:48Z", "message": "Tweak Jenkins Build and Deploy runbook"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTU1NzQz", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#pullrequestreview-369955743", "createdAt": "2020-03-05T22:18:06Z", "commit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoxODowNlrOFymRjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoxODowNlrOFymRjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwMDIwNw==", "bodyText": "Just a few close quotes needed for preformatted text.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388600207", "createdAt": "2020-03-05T22:18:06Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/README.md", "diffHunk": "@@ -7,61 +7,49 @@ This folder currently hosts DevOps related code (Ansible, Packer, Terraform, etc\n Project and Directory Structure\n - We are using the suggested directory structure provided by the Ansible community: https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html#directory-layout\n \n-### Jenkins Playbooks \n-##### To Do\n- 1. Research ssh pipelining issue, currently turned off across entire playbook. \n- 2. Install Cloudwatch agent and configure.\n- 3. Configure Splunk Agent \n- 4. Setup SSH Access, currently using bfd-jenkins key. Located in team keybase. \n-   - option 1: https://aws.amazon.com/blogs/compute/new-using-amazon-ec2-instance-connect-for-ssh-access-to-your-ec2-instances/\n- 5. Automate via groovy the setup of docker name and location in global tools settings.\n- 6. Consider moving to Jenkins in Docker. \n+## Jenkins Playbooks \n \n-#### New Jenkins Installation\n+### New Jenkins Installation\n __Name: build_jenkins.yml__<br>\n __Summary:__ This playbook and associated roles configures a CCS Gold Image with specific prerequsities and then apache, jenkins and BFD specific configuration. \n \n-##### High Level Usage Instructions\n+#### High Level Usage Instructions\n  - Requirements: \n    - Local Environment \n      - CCS VPN Connection with proper profile. \n     - AWS CLI authentication setup for the BFD AWS Account with admin privs. \n     - Tools: Packer, Ansible\n    - A Gold Image ID provided by the CCS (GDIT)\n-   - A previously created and formatted EBS volume\n-     - Create EBS Volume within AWS (console or cli)\n-       - Suggested configuration\n-         - Name: Same as used for the variable {{ bfd-jenkins-ebs_name }} value in the playbook. \n-         - Type: General Purpose SSD (gp2)\n-         - Size: >= 1000G \n-         - AZ: us-east-1(a-c)\n-         - Encryption: Yes, use MGMT CMK\n-         - Device: /dev/sdf \n-         - Filesystem: xfs \n-   - Build the Jenkins AMI from within the Ansible/ directory of the ops code (i.e. bfd-ops) by running the following command to build AND configure the Jenkins instance and volume for the first time. \n-     - *packer build -var 'source_ami=ami-12345678' -var 'subnet_id=subnet-0987654321' update_jenkins.json*\n+   - A previously created EFS mount (this is completed with the Terraform `mgmt-stateful` module) \n+   - Subnet ID - changes with mgmt (us-east-1a) or mgmt-test (us-east-1c)\n+   __STOP the current jenkins service on the live instance.__\n+   - Build the Jenkins AMI from within the `ops/ansible/playbooks-ccs` directory of the ops code by running the following command to build AND configure the Jenkins instance and volume for the first time. \n+     - `packer build -var 'source_ami=ami-0f2d8f925de453e46' -var 'subnet_id=subnet-092c2a68bd18b34d1' - var 'env=mgmt' ../../packer/build_jenkins.json`\n    - Note the AMI ID that was created. You'll update the terraform variables at a later stage to deploy this.\n-   \n-##### Post Installation Config \n-Visit Jenkins URL: https://builds.bfd-mgmt.cmscloud.local/jenkins and use credentials located in vault to login and configure the following:\n- - Global Tool Chains Config - Configure Docker\n-     - name: docker\n-     - location: /var/lib \n \n-- Global Security Config - Enable Slave -> Master Access Control\n-\n-#### Update Jenkins Installation \n+### Update Jenkins Installation \n \n __Name: update_jenkins.yml__<br>\n-__Summary:__ This playbook and associated roles configures a CCS Gold Image with specific prerequsities and then apache, jenkins and BFD specific configuration. It essential applies all roles from the build_jenkins.yml playbook except for the configuration aspects which are stored on a persistent EBS volume and attached to this instance. \n+__Summary:__ This playbook and associated roles configures a CCS Gold Image with specific prerequsities and then apache, jenkins and BFD specific configuration. It essential applies all roles from the build_jenkins.yml playbook except for the configuration aspects which are stored on a persistent EFS volume and attached to this instance. \n \n-##### High Level Usage Instructions\n+#### High Level Usage Instructions\n  - Requirements: \n    - Local Environment \n      - CCS VPN Connection with proper profile. \n     - AWS CLI authentication setup for the BFD AWS Account with admin privs. \n     - Tools: Packer, Ansible\n    - A Gold Image ID provided by the CCS (GDIT)\n- - __example command__: from within the ansible directory and replacing the ami and subnet values that meet your deployment needs. \n+   - Subnet ID changes with mgmt (us-east-1a) or mgmt-test (us-east-1c)\n+   __STOP the current jenkins service on the live instance.__\n+ - __example command__: from within the `ops/ansible/playbooks-ccs` directory and replacing the ami and subnet values that meet your deployment needs. \n+\n+- `packer build -var 'source_ami=ami-12345678' -var 'subnet_id=subnet-0987654321' - var 'env=mgmt' update_jenkins.json`\n+\n+### Jenkins Deployment\n+- Update the terraform vars in Keybase (/infrastructure/secrets/terraform-vars) and supply the new AMI form the previous build or update packer job. \n+- Move into the `ops/terraform/env/mgmt, mgmt-test/stateless", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTU4NTk2", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#pullrequestreview-369958596", "createdAt": "2020-03-05T22:24:16Z", "commit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoyNDoxNlrOFyma_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoyNDoxNlrOFyma_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwMjYyMg==", "bodyText": "I know this already existed as debt prior to your work, but it might be good to remove the unused environment (which I believe is env_prod_stg) to reduce confusion when having to use the lockable resources.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388602622", "createdAt": "2020-03-05T22:24:16Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/roles/conf_jenkins/templates/configLockableResources.groovy.j2", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+   Copyright 2015-2019 Sam Gleske - https://github.com/samrocketman/jenkins-bootstrap-shared\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+       http://www.apache.org/licenses/LICENSE-2.0\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+   */\n+/*\n+  Configures global lockable resources.\n+   lockable-resources 2.2\n+ */\n+ \n+import jenkins.model.Jenkins\n+import org.jenkins.plugins.lockableresources.LockableResource\n+import org.jenkins.plugins.lockableresources.LockableResourcesManager\n+\n+if(!binding.hasVariable('lockable_resources')) {\n+    lockable_resources = [\u2018name' : \u2018env_test\u2019, \u2018name\u2019 : 'env_prod_stg' \u2018name : 'env_prod', \u2018name\u2019 : 'env_prod_sbx' ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTYwOTU0", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#pullrequestreview-369960954", "createdAt": "2020-03-05T22:29:19Z", "commit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoyOToxOVrOFymieA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoyOToxOVrOFymieA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNDUzNg==", "bodyText": "This is really nifty!", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388604536", "createdAt": "2020-03-05T22:29:19Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/roles/install_jenkins/tasks/plugins.yml", "diffHunk": "@@ -53,40 +53,44 @@\n   until: >\n      'status' in jenkins_service_status and\n      jenkins_service_status['status'] == 200\n-     \n-- name: Install Plugins\n-  jenkins_plugin:\n-    name: \"{{ item }}\"\n-    state: present\n-    jenkins_home: \"{{ jenkins_home }}\"\n+\n+- name: Configure Security Recommendations\n+  jenkins_script:\n     url: \"{{ jenkins_url_local }}\"\n+    user: \"{{ jenkins_dynamic_admin_username | default(omit) }}\"\n+    password: \"{{ jenkins_dynamic_admin_password | default(omit) }}\"\n+    script: \"{{ lookup('template', 'templates/configSecrec.groovy.j2') }}\"\n+  register: shell_jenkins_security_recommendations\n+  changed_when: \"(shell_jenkins_security_recommendations is success) and 'Changed' in shell_jenkins_security_recommendations.output\"\n+\n+- name: Get Jenkins Crumb\n+  uri:\n+    force_basic_auth: yes\n     url_username: \"{{ jenkins_dynamic_admin_username | default(omit) }}\"\n     url_password: \"{{ jenkins_dynamic_admin_password | default(omit) }}\"\n-    validate_certs: true\n-    timeout: \"{{ jenkins_plugins_timeout }}\"\n-  with_items:\n-    - \"{{ jenkins_plugins_recommended }}\"\n-    - \"{{ jenkins_plugins_extra }}\"\n-  become: true\n-  retries: \"{{ jenkins_plugins_retries }}\"\n-  notify:\n-    - \"Restart Service 'jenkins'\"\n+    url: \"{{ jenkins_url_local }}/crumbIssuer/api/json\"\n+    return_content: yes\n+  register: jenkins_crumb\n+  until: jenkins_crumb.content.find('Please wait while Jenkins is getting ready') == -1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTYxNTg1", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#pullrequestreview-369961585", "createdAt": "2020-03-05T22:30:37Z", "commit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjozMDozN1rOFymkUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjozMDozN1rOFymkUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNTAxMQ==", "bodyText": "I think this version number could be hoisted up to a var somewhere higher in the chain for easier maintainabililty.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388605011", "createdAt": "2020-03-05T22:30:37Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/roles/install_jenkins/tasks/tools.yml", "diffHunk": "@@ -3,30 +3,61 @@\n # Installs additional build and deploy tools\n ###\n \n-- name: Install tfenv to manage terrfaorm\n+- name: Install tfenv to manage terraform\n   git:\n     repo: https://github.com/tfutils/tfenv.git \n-    dest: ~/.tfenv\n+    dest: /usr/bin/.tfenv\n \n - name: Create symlinks for tfenv\n   file:\n-    src: ~/.tfenv/bin/tfenv\n+    src: /usr/bin/.tfenv/bin/tfenv\n     dest: /usr/bin/tfenv\n     mode: '0755'\n     state: link\n     \n - name: Link tfenv tf wrapper. \n   file:\n-    src: ~/.tfenv/bin/terraform\n+    src: /usr/bin/.tfenv/bin/terraform\n     dest: /usr/bin/terraform\n     mode: '0755'\n     state: link\n \n - name: Install terraform \n-  shell: tfenv install 0.12.5\n+  shell: tfenv install 0.12.8", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTYzMDI5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#pullrequestreview-369963029", "createdAt": "2020-03-05T22:33:40Z", "commit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjozMzo0MFrOFymo5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjozMzo0MFrOFymo5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNjE4Mg==", "bodyText": "Could combine these two into a single yum statement, although a bit micro-optimizey \ud83e\udd37\u200d\u2642", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388606182", "createdAt": "2020-03-05T22:33:40Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/roles/install_jenkins/tasks/tools.yml", "diffHunk": "@@ -3,30 +3,61 @@\n # Installs additional build and deploy tools\n ###\n \n-- name: Install tfenv to manage terrfaorm\n+- name: Install tfenv to manage terraform\n   git:\n     repo: https://github.com/tfutils/tfenv.git \n-    dest: ~/.tfenv\n+    dest: /usr/bin/.tfenv\n \n - name: Create symlinks for tfenv\n   file:\n-    src: ~/.tfenv/bin/tfenv\n+    src: /usr/bin/.tfenv/bin/tfenv\n     dest: /usr/bin/tfenv\n     mode: '0755'\n     state: link\n     \n - name: Link tfenv tf wrapper. \n   file:\n-    src: ~/.tfenv/bin/terraform\n+    src: /usr/bin/.tfenv/bin/terraform\n     dest: /usr/bin/terraform\n     mode: '0755'\n     state: link\n \n - name: Install terraform \n-  shell: tfenv install 0.12.5\n+  shell: tfenv install 0.12.8\n   \n - name: Install packer\n   unarchive:\n     src: https://releases.hashicorp.com/packer/1.4.3/packer_1.4.3_linux_amd64.zip\n     dest: /usr/bin\n     remote_src: yes\n+\n+- name: Install - AWS CLI\n+  pip:\n+    name: \"awscli\"\n+\n+- name: Create .aws directory in the home directory\n+  file:\n+    path: \"{{ jenkins_home }}/.aws/\"\n+    state: directory\n+    owner: \"jenkins\"\n+    group: \"jenkins\"\n+    mode: 0755\n+\n+- name: Copy the aws config file to the box\n+  become: yes\n+  template:\n+    src: ../templates/aws_config.j2\n+    dest: \"{{ jenkins_home }}/.aws/config\"\n+    owner: \"jenkins\"\n+    group: \"jenkins\"\n+    mode: 0600\n+\n+- name: Install - jq\n+  yum:\n+    name: \n+      - jq\n+\n+- name: Install nfs-utils\n+  yum:\n+    name:\n+      - nfs-utils", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTY0MzE3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#pullrequestreview-369964317", "createdAt": "2020-03-05T22:36:33Z", "commit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjozNjozM1rOFymtRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjozNjozM1rOFymtRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNzMwMg==", "bodyText": "For consistency I would move the task definition into separate lines, new ansible style ftw!", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388607302", "createdAt": "2020-03-05T22:36:33Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/roles/mount_efs/tasks/main.yml", "diffHunk": "@@ -0,0 +1,27 @@\n+---\n+##\n+# Mounts Jenkins Data EBS Volume\n+##\n+- name: Ensure NFS is installed.\n+  package: \"name={{ nfs_package }} state=installed\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTY2ODIx", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#pullrequestreview-369966821", "createdAt": "2020-03-05T22:42:03Z", "commit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo0MjowNFrOFym1rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo0MjowNFrOFym1rA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwOTQ1Mg==", "bodyText": "Can you clarify how this works for both mgmt and mgmt-test?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388609452", "createdAt": "2020-03-05T22:42:04Z", "author": {"login": "njdister"}, "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -26,6 +26,16 @@ data \"aws_subnet_ids\" \"app_subnets\" {\n   }\n }\n \n+# Subnet for EFS \n+\n+data \"aws_subnet_ids\" \"efs\" {\n+  vpc_id = data.aws_vpc.main.id\n+\n+  tags = {\n+    Name = \"bfd-mgmt-az3-app\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTcxMjU5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#pullrequestreview-369971259", "createdAt": "2020-03-05T22:52:06Z", "commit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo1MjowNlrOFynE-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo1MjowNlrOFynE-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxMzM2OA==", "bodyText": "Can you get this from a data source or is that not easily possible?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388613368", "createdAt": "2020-03-05T22:52:06Z", "author": {"login": "njdister"}, "path": "ops/terraform/modules/resources/efs/main.tf", "diffHunk": "@@ -0,0 +1,66 @@\n+# EFS\n+# \n+# Create a EFS Resource, Mount Target and Security Group  \n+#\n+\n+locals {\n+  tags        = merge({Layer=var.layer, role=var.role}, var.env_config.tags) \n+}\n+\n+data \"aws_vpc\" \"main\" {\n+  filter {\n+    name = \"tag:Name\"\n+    values = [\"bfd-mgmt-vpc\"]\n+  }\n+}\n+\n+data \"aws_subnet\" \"main\" {\n+  vpc_id            = data.aws_vpc.main.id\n+  availability_zone = var.env_config.azs\n+  filter {\n+    name    = \"tag:Layer\"\n+    values  = [var.layer] \n+  }\n+}\n+\n+\n+resource \"aws_efs_file_system\" \"efs\" {\n+   creation_token = \"bfd-${var.env_config.env}-${var.role}-efs\"\n+   performance_mode = \"generalPurpose\"\n+   throughput_mode = \"bursting\"\n+   encrypted = \"true\"\n+ \n+  tags = {\n+    Name = \"bfd-${var.env_config.env}-${var.role}-efs\"\n+  }\n+}\n+\n+resource \"aws_security_group\" \"efs-sg\" {\n+  name        = \"bfd-${var.env_config.env}-${var.role}-efs-sg\"\n+  description = \"EFS Security Group\"\n+  vpc_id      = data.aws_vpc.main.id\n+\n+  // NFS\n+  ingress {\n+    description     = \"Inbound access for EFS\"\n+    from_port = 2049\n+    to_port = 2049\n+    protocol = \"tcp\"\n+    cidr_blocks = [\"10.252.40.0/21\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTcxMzUx", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#pullrequestreview-369971351", "createdAt": "2020-03-05T22:52:20Z", "commit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo1MjoyMFrOFynFZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo1MjoyMFrOFynFZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxMzQ3OQ==", "bodyText": "Can you get this from a data source or is that not easily possible?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388613479", "createdAt": "2020-03-05T22:52:20Z", "author": {"login": "njdister"}, "path": "ops/terraform/modules/resources/efs/main.tf", "diffHunk": "@@ -0,0 +1,66 @@\n+# EFS\n+# \n+# Create a EFS Resource, Mount Target and Security Group  \n+#\n+\n+locals {\n+  tags        = merge({Layer=var.layer, role=var.role}, var.env_config.tags) \n+}\n+\n+data \"aws_vpc\" \"main\" {\n+  filter {\n+    name = \"tag:Name\"\n+    values = [\"bfd-mgmt-vpc\"]\n+  }\n+}\n+\n+data \"aws_subnet\" \"main\" {\n+  vpc_id            = data.aws_vpc.main.id\n+  availability_zone = var.env_config.azs\n+  filter {\n+    name    = \"tag:Layer\"\n+    values  = [var.layer] \n+  }\n+}\n+\n+\n+resource \"aws_efs_file_system\" \"efs\" {\n+   creation_token = \"bfd-${var.env_config.env}-${var.role}-efs\"\n+   performance_mode = \"generalPurpose\"\n+   throughput_mode = \"bursting\"\n+   encrypted = \"true\"\n+ \n+  tags = {\n+    Name = \"bfd-${var.env_config.env}-${var.role}-efs\"\n+  }\n+}\n+\n+resource \"aws_security_group\" \"efs-sg\" {\n+  name        = \"bfd-${var.env_config.env}-${var.role}-efs-sg\"\n+  description = \"EFS Security Group\"\n+  vpc_id      = data.aws_vpc.main.id\n+\n+  // NFS\n+  ingress {\n+    description     = \"Inbound access for EFS\"\n+    from_port = 2049\n+    to_port = 2049\n+    protocol = \"tcp\"\n+    cidr_blocks = [\"10.252.40.0/21\"]\n+  }\n+\n+  // Terraform removes the default rule\n+  egress {\n+    description     = \"Outbound Access for EFS\"\n+    from_port = 0\n+    to_port = 0\n+    protocol = \"-1\"\n+    cidr_blocks = [\"10.252.40.0/21\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5OTc4ODIz", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#pullrequestreview-369978823", "createdAt": "2020-03-05T23:10:34Z", "commit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df8c608b547e9b23b95d0d69915ed764314af793", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/df8c608b547e9b23b95d0d69915ed764314af793", "committedDate": "2020-03-05T23:57:56Z", "message": "PR Improvement suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "011fe9a705a3738063cb98c537b837423ba8a62f", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/011fe9a705a3738063cb98c537b837423ba8a62f", "committedDate": "2020-03-06T00:13:50Z", "message": "Variable bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a5feb7c7d4ace43765bf6aa698b0d189ab48e8d", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/0a5feb7c7d4ace43765bf6aa698b0d189ab48e8d", "committedDate": "2020-03-06T20:03:54Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4cc8c5b46106463a9f9df7644c755ec29702554", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/c4cc8c5b46106463a9f9df7644c755ec29702554", "committedDate": "2020-03-06T20:07:24Z", "message": "Fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTk3OTcz", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#pullrequestreview-370597973", "createdAt": "2020-03-06T20:12:52Z", "commit": {"oid": "c4cc8c5b46106463a9f9df7644c755ec29702554"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTgyMzkx", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#pullrequestreview-372182391", "createdAt": "2020-03-10T17:44:23Z", "commit": {"oid": "c4cc8c5b46106463a9f9df7644c755ec29702554"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 702, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}