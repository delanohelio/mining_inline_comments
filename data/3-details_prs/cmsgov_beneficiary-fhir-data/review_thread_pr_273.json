{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NTY4MTYy", "number": 273, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTozODoxN1rOD8NbiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDowODoxOVrOD8OB7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDYxMTkyOnYy", "diffSide": "LEFT", "path": "ops/terraform/env/prod-sbx/stateful/main.tf", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTozODoxN1rOGVAtqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTozODoxN1rOGVAtqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4NDk2OA==", "bodyText": "Confirmed from BCDA perspective, these are no longer needed.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#discussion_r424684968", "createdAt": "2020-05-13T19:38:17Z", "author": {"login": "msnook"}, "path": "ops/terraform/env/prod-sbx/stateful/main.tf", "diffHunk": "@@ -51,7 +51,7 @@ module \"stateful\" {\n \n   medicare_opt_out_config = {\n     read_roles        = [\"arn:aws:iam::755619740999:role/dpc-dev-consent-execution-role\", \"arn:aws:iam::349849222861:role/Ab2dInstanceRole\", \"arn:aws:iam::777200079629:role/Ab2dInstanceRole\", \"arn:aws:iam::330810004472:role/Ab2dInstanceRole\"]\n-    write_roles       = [\"arn:aws:iam::755619740999:role/bcda-dev-nfs-instance\", \"arn:aws:iam::755619740999:role/bcda-test-nfs-instance\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDYxMjYxOnYy", "diffSide": "LEFT", "path": "ops/terraform/env/prod/stateful/main.tf", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTozODozMlrOGVAuJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTozODozMlrOGVAuJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4NTA5NQ==", "bodyText": "Confirmed from BCDA perspective, this is no longer needed.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#discussion_r424685095", "createdAt": "2020-05-13T19:38:32Z", "author": {"login": "msnook"}, "path": "ops/terraform/env/prod/stateful/main.tf", "diffHunk": "@@ -60,7 +60,7 @@ module \"stateful\" {\n   medicare_opt_out_config = {\n     # TODO: add read roles for DPC\n     read_roles        = []\n-    write_roles       = [\"arn:aws:iam::755619740999:role/bcda-prod-nfs-instance\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NDcxMDIwOnYy", "diffSide": "RIGHT", "path": "ops/terraform/modules/resources/s3_pii/templates/bucket-policy.json", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDowODoxOVrOGVBsiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNToxODowMVrOGVhSNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwMTA2NQ==", "bodyText": "Suggest that you could add s3:HeadBucket, and s3: GetBucketLocation to the actions list.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#discussion_r424701065", "createdAt": "2020-05-13T20:08:19Z", "author": {"login": "RickHawesUSDS"}, "path": "ops/terraform/modules/resources/s3_pii/templates/bucket-policy.json", "diffHunk": "@@ -1,62 +1,48 @@\n+${jsonencode(\n {\n   \"Version\": \"2012-10-17\",\n   \"Id\": \"bfd-${env}-${bucket_name}-s3-policy\",\n   \"Statement\": [\n-    {\n-      \"Sid\": \"BFDPIIS3ListBucket\",\n-      \"Effect\": \"Allow\",\n-      \"Principal\": {\n-        \"AWS\": [\n-          %{ for reader in readers ~}\"${reader}\",%{ endfor ~}\n-          %{ for writer in writers ~}\"${writer}\",%{ endfor ~}\n-          %{ for admin in admins ~}\"${admin}\",%{ endfor ~}\n-          \"${root}\"\n-        ]\n-      },\n-      \"Action\": [\n-        \"s3:ListBucket\"\n-      ],\n-      \"Resource\": \"arn:aws:s3:::${bucket_id}\"\n-    },\n     {\n       \"Sid\": \"BFDPIIS3ReadBucket\",\n       \"Effect\": \"Allow\",\n       \"Principal\": {\n         \"AWS\": [\n-          %{ for reader in readers ~}\"${reader}\",%{ endfor ~}\n-          %{ for writer in writers ~}\"${writer}\",%{ endfor ~}\n-          %{ for admin in admins ~}\"${admin}\",%{ endfor ~}\n-          \"${root}\"\n+          for arn in concat(readers, writers) : \"${arn}\"\n         ]\n       },\n       \"Action\": [\n-        \"s3:GetObject\"\n+        \"s3:ListBucket*\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIxODYxMw==", "bodyText": "It appears s3:HeadBucket is not a valid operation for a specific S3 bucket, only for * so not valid within the context of the S3 policy.  The IAM writer policy already has s3:HeadBucket.  I have added s3:GetBucket* to the S3 policy to be more inclusive of read operations.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#discussion_r425218613", "createdAt": "2020-05-14T15:18:01Z", "author": {"login": "njdister"}, "path": "ops/terraform/modules/resources/s3_pii/templates/bucket-policy.json", "diffHunk": "@@ -1,62 +1,48 @@\n+${jsonencode(\n {\n   \"Version\": \"2012-10-17\",\n   \"Id\": \"bfd-${env}-${bucket_name}-s3-policy\",\n   \"Statement\": [\n-    {\n-      \"Sid\": \"BFDPIIS3ListBucket\",\n-      \"Effect\": \"Allow\",\n-      \"Principal\": {\n-        \"AWS\": [\n-          %{ for reader in readers ~}\"${reader}\",%{ endfor ~}\n-          %{ for writer in writers ~}\"${writer}\",%{ endfor ~}\n-          %{ for admin in admins ~}\"${admin}\",%{ endfor ~}\n-          \"${root}\"\n-        ]\n-      },\n-      \"Action\": [\n-        \"s3:ListBucket\"\n-      ],\n-      \"Resource\": \"arn:aws:s3:::${bucket_id}\"\n-    },\n     {\n       \"Sid\": \"BFDPIIS3ReadBucket\",\n       \"Effect\": \"Allow\",\n       \"Principal\": {\n         \"AWS\": [\n-          %{ for reader in readers ~}\"${reader}\",%{ endfor ~}\n-          %{ for writer in writers ~}\"${writer}\",%{ endfor ~}\n-          %{ for admin in admins ~}\"${admin}\",%{ endfor ~}\n-          \"${root}\"\n+          for arn in concat(readers, writers) : \"${arn}\"\n         ]\n       },\n       \"Action\": [\n-        \"s3:GetObject\"\n+        \"s3:ListBucket*\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwMTA2NQ=="}, "originalCommit": {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 359, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}