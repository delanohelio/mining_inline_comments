{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1MDExNjg3", "number": 219, "title": "BLUEBUTTON-1593 Refactor to simplify paging parameters", "bodyText": "Change Details\nSummary:\nThis refactors the paging code related to the work done for BLUEBUTTON-1593 (Support paging for TYPE parameter) and BLUEBUTTON-1506 (Bulk Export Since support). This builds on the work commited via the PR: #155\nThe following was done:\n\nRefactored the createPageLink() method in the PageLinkBuilder class with the following:\n\nRetains the original URL parameters utilizing the RequestDetails.  This includes type, excludeSAMHSA, lastUpdated, or any other parameters.\nOnly update URL parameters related to paging, including startIndex and _count.\n\n\nRemoves PageLinkBuilder Java parameters not directly concerned with paging, including lastUpdated, claimTypes, and excludeSamhsaq\n\nCURL Example and Response Links\ncurl -v -k -E ${KEYSTORE_FILE} https://${HOST}:${PORT}/v1/fhir/ExplanationOfBenefit?\"patient=${FHIR_ID}&_count=10&startIndex=0&type=https://bluebutton.cms.gov/resources/codesystem/eob-type|carrier,hospice,https://bluebutton.cms.gov/resources/codesystem/eob-type|pde&_format=application%2Fjson%2Bfhir&_lastUpdated=gt2018-11-21T00:00:00-05:00&_lastUpdated=lt2020-11-22T14:00:00-05:00\"\n\n  \"type\": \"searchset\",\n  \"total\": 35,\n  \"link\": [\n    {\n      \"relation\": \"first\",\n      \"url\": \"https://172.21.0.3:8569/v1/fhir/ExplanationOfBenefit?startIndex=0&_count=10&patient=20000000001561&_lastUpdated=gt2018-11-21T00%3A00%3A00-05%3A00&_lastUpdated=lt2020-11-22T14%3A00%3A00-05%3A00&_format=application%2Fjson%2Bfhir&type=https%3A%2F%2Fbluebutton.cms.gov%2Fresources%2Fc\nodesystem%2Feob-type%7Ccarrier%2Chospice%2Chttps%3A%2F%2Fbluebutton.cms.gov%2Fresources%2Fcodesystem%2Feob-type%7Cpde\"\n    },\n    {\n      \"relation\": \"next\",\n      \"url\": \"https://172.21.0.3:8569/v1/fhir/ExplanationOfBenefit?startIndex=10&_count=10&patient=20000000001561&_lastUpdated=gt2018-11-21T00%3A00%3A00-05%3A00&_lastUpdated=lt2020-11-22T14%3A00%3A00-05%3A00&_format=application%2Fjson%2Bfhir&type=https%3A%2F%2Fbluebutton.cms.gov%2Fresources%2F\ncodesystem%2Feob-type%7Ccarrier%2Chospice%2Chttps%3A%2F%2Fbluebutton.cms.gov%2Fresources%2Fcodesystem%2Feob-type%7Cpde\"\n    },\n    {\n      \"relation\": \"last\",\n      \"url\": \"https://172.21.0.3:8569/v1/fhir/ExplanationOfBenefit?startIndex=30&_count=10&patient=20000000001561&_lastUpdated=gt2018-11-21T00%3A00%3A00-05%3A00&_lastUpdated=lt2020-11-22T14%3A00%3A00-05%3A00&_format=application%2Fjson%2Bfhir&type=https%3A%2F%2Fbluebutton.cms.gov%2Fresources%2F\ncodesystem%2Feob-type%7Ccarrier%2Chospice%2Chttps%3A%2F%2Fbluebutton.cms.gov%2Fresources%2Fcodesystem%2Feob-type%7Cpde\"\n    },\n    {\n      \"relation\": \"self\",\n      \"url\": \"https://172.21.0.3:8569/v1/fhir/ExplanationOfBenefit?_count=10&_format=application%2Fjson%2Bfhir&_lastUpdated=gt2018-11-21T00%3A00%3A00-05%3A00&_lastUpdated=lt2020-11-22T14%3A00%3A00-05%3A00&patient=20000000001561&startIndex=0&type=https%3A%2F%2Fbluebutton.cms.gov%2Fresources%2Fc\nodesystem%2Feob-type%7Ccarrier%2Chospice%2Chttps%3A%2F%2Fbluebutton.cms.gov%2Fresources%2Fcodesystem%2Feob-type%7Cpde\"\n    }\n  ],\n\nAcceptance Validation\n\nThat URL paging parameters are working as expected for resource requests.  This includes parameters related to TYPE, excludeSAMHSA, and Since functionality.\n\n\n\nFeedback Requested\n\nExternal References\n\n\nBLUEBUTTON-1593\nBLUEBUTTON-1506\n\nSecurity Implications", "createdAt": "2020-02-13T18:02:14Z", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/219", "merged": true, "mergeCommit": {"oid": "0eba6fba3219251296f65f713097fbaed955f7c2"}, "closed": true, "closedAt": "2020-02-19T17:19:05Z", "author": {"login": "dtisza1"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcD-aytAH2gAyMzc1MDExNjg3OjU0YTQzYzE1ZjFhN2M4ZjZkNTQwOGVhN2ZjYzIxZjk4YmVlYmE2NDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcF5I-rAFqTM2MTI0MDg2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "54a43c15f1a7c8f6d5408ea7fcc21f98beeba640", "author": {"user": {"login": "dtisza1", "name": "David Tisza"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/54a43c15f1a7c8f6d5408ea7fcc21f98beeba640", "committedDate": "2020-02-13T17:31:14Z", "message": "Refactor to simplify paging parameters\n\n- Refactor of createPageLink() URL parameter building.\n\n- Remove method params not related to paging.\n\n- Retain original params from RequestDetails."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDQ3OTky", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/219#pullrequestreview-358447992", "createdAt": "2020-02-13T18:23:44Z", "commit": {"oid": "54a43c15f1a7c8f6d5408ea7fcc21f98beeba640"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODoyMzo0NVrOFpeoqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODoyMzo0NVrOFpeoqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzNzg2Nw==", "bodyText": "It looks like these can be removed, I don't see them being used anywhere.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/219#discussion_r379037867", "createdAt": "2020-02-13T18:23:45Z", "author": {"login": "whytheplatypus"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PageLinkBuilder.java", "diffHunk": "@@ -28,36 +28,17 @@\n   private final String resource;\n   private final String searchByDesc;\n   private final String identifier;\n-  private final DateRangeParam lastUpdated;\n-  private final String excludeSamhsa;\n-  private final Set<ClaimType> claimTypes;\n+  private final RequestDetails requestDetails;\n \n   public PageLinkBuilder(\n-      RequestDetails requestDetails,\n-      String resource,\n-      String searchByDesc,\n-      String identifier,\n-      DateRangeParam lastUpdated,\n-      Set<ClaimType> claimTypes,\n-      String excludeSamhsa) {\n+      RequestDetails requestDetails, String resource, String searchByDesc, String identifier) {\n     this.pageSize = parseIntegerParameters(requestDetails, Constants.PARAM_COUNT);\n     this.startIndex = parseIntegerParameters(requestDetails, \"startIndex\");\n     this.serverBase = requestDetails.getServerBaseForRequest();\n     this.resource = resource;\n     this.searchByDesc = searchByDesc;\n     this.identifier = identifier;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54a43c15f1a7c8f6d5408ea7fcc21f98beeba640"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb7a7c7357b3f826fec2627e793bc9059b2d73de", "author": {"user": {"login": "dtisza1", "name": "David Tisza"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/cb7a7c7357b3f826fec2627e793bc9059b2d73de", "committedDate": "2020-02-13T19:08:21Z", "message": "Remove two unused variables."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDgwNDg0", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/219#pullrequestreview-358480484", "createdAt": "2020-02-13T19:12:48Z", "commit": {"oid": "cb7a7c7357b3f826fec2627e793bc9059b2d73de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDkwOTYx", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/219#pullrequestreview-358490961", "createdAt": "2020-02-13T19:28:46Z", "commit": {"oid": "cb7a7c7357b3f826fec2627e793bc9059b2d73de"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxOToyODo0N1rOFpguTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxOToyODo0N1rOFpguTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA3MjA3OA==", "bodyText": "Small suggestion. You can make this read simpler by removing...\nMap<String, String> param = new HashMap<>(requestDetails...", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/219#discussion_r379072078", "createdAt": "2020-02-13T19:28:47Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PageLinkBuilder.java", "diffHunk": "@@ -179,41 +155,27 @@ public void addPageLinks(Bundle toBundle, int numTotalResults) {\n    */\n   private String createPageLink(int startIndex) {\n     StringBuilder b = new StringBuilder();\n+\n+    // Setup URL base and resource.\n     b.append(serverBase);\n     b.append(resource);\n-    b.append(Constants.PARAM_COUNT + \"=\" + getPageSize());\n-    b.append(\"&startIndex=\" + startIndex);\n-    b.append(\"&\" + searchByDesc + \"=\" + identifier);\n-\n-    // Add the lastUpdated parameters if present\n-    if (lastUpdated != null) {\n-      DateParam lowerBound = lastUpdated.getLowerBound();\n-      if (lowerBound != null && !lowerBound.isEmpty()) {\n-        b.append(\n-            \"&\"\n-                + Constants.PARAM_LASTUPDATED\n-                + \"=\"\n-                + lowerBound.getPrefix().getValue()\n-                + lowerBound.getValueAsString());\n-      }\n-      DateParam upperBound = lastUpdated.getUpperBound();\n-      if (upperBound != null && !upperBound.isEmpty()) {\n-        b.append(\n-            \"&\"\n-                + Constants.PARAM_LASTUPDATED\n-                + \"=\"\n-                + upperBound.getPrefix().getValue()\n-                + upperBound.getValueAsString());\n-      }\n-    }\n \n-    // Add the \"type\" parameter if present\n-    if (claimTypes != null) {\n-      b.append(\"&type=\" + claimTypes.toString().toLowerCase().replaceAll(\"[\\\\[\\\\] ]\", \"\"));\n-    }\n+    // Get a copy of all request parameters.\n+    Map<String, String[]> params = new HashMap<String, String[]>(requestDetails.getParameters());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb7a7c7357b3f826fec2627e793bc9059b2d73de"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDk1OTg2", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/219#pullrequestreview-358495986", "createdAt": "2020-02-13T19:36:30Z", "commit": {"oid": "cb7a7c7357b3f826fec2627e793bc9059b2d73de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxOTozNjozMFrOFpg9bQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxOTozNjozMFrOFpg9bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA3NTk0OQ==", "bodyText": "Now that we are really improving this method. I'm wondering if we could use UriBuilder instead of StringBuilder here.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/219#discussion_r379075949", "createdAt": "2020-02-13T19:36:30Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PageLinkBuilder.java", "diffHunk": "@@ -179,41 +155,27 @@ public void addPageLinks(Bundle toBundle, int numTotalResults) {\n    */\n   private String createPageLink(int startIndex) {\n     StringBuilder b = new StringBuilder();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb7a7c7357b3f826fec2627e793bc9059b2d73de"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b62a3ef437c911a2661a99313eb8df53a1d2f84", "author": {"user": {"login": "dtisza1", "name": "David Tisza"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/1b62a3ef437c911a2661a99313eb8df53a1d2f84", "committedDate": "2020-02-13T20:04:33Z", "message": "Refactor HashMap to be more readable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "954103da75674a280440181f5ac07b9970b18eb8", "author": {"user": {"login": "dtisza1", "name": "David Tisza"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/954103da75674a280440181f5ac07b9970b18eb8", "committedDate": "2020-02-14T15:07:10Z", "message": "Refactor createPageLink() to use URIBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a32ed3d709e244f845878227954dab07fafee8c1", "author": {"user": {"login": "dtisza1", "name": "David Tisza"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/a32ed3d709e244f845878227954dab07fafee8c1", "committedDate": "2020-02-14T17:22:42Z", "message": "Merge remote-tracking branch 'origin/master' into BLUEBUTTON-1593-refactor-paging-for-type-excludesamhsa"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MTUyMDE5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/219#pullrequestreview-359152019", "createdAt": "2020-02-14T18:58:24Z", "commit": {"oid": "a32ed3d709e244f845878227954dab07fafee8c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMjQwODY4", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/219#pullrequestreview-361240868", "createdAt": "2020-02-19T16:30:06Z", "commit": {"oid": "a32ed3d709e244f845878227954dab07fafee8c1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 675, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}