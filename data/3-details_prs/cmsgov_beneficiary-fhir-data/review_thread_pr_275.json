{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NzE1OTgz", "number": 275, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NDowOFrOD89f_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0OTo0M1rOD8_yNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MjQ4NzY2OnYy", "diffSide": "RIGHT", "path": "insights/terraform/modules/bucket/main.tf", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NDowOVrOGWOLLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NDowOVrOGWOLLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NDA5NQ==", "bodyText": "This change makes defaults explicit", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425954095", "createdAt": "2020-05-15T17:44:09Z", "author": {"login": "RickHawesUSDS"}, "path": "insights/terraform/modules/bucket/main.tf", "diffHunk": "@@ -47,6 +47,8 @@ resource \"aws_s3_bucket_object\" \"top\" {\n resource \"aws_kms_key\" \"main\" {\n   description   = \"CMK for the ${local.full_name} bucket\"\n   tags          = var.tags\n+  key_usage     = \"ENCRYPT_DECRYPT\"\n+  is_enabled    = true\n   policy        = length(var.cross_accounts) > 0 ? data.aws_iam_policy_document.cmk_policy.json : null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MjQ4OTM0OnYy", "diffSide": "RIGHT", "path": "insights/terraform/modules/bucket/outputs.tf", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NDozOFrOGWOMNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NDozOFrOGWOMNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NDM1Ng==", "bodyText": "Will need the arn later.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425954356", "createdAt": "2020-05-15T17:44:38Z", "author": {"login": "RickHawesUSDS"}, "path": "insights/terraform/modules/bucket/outputs.tf", "diffHunk": "@@ -9,3 +9,7 @@ output \"id\" {\n output \"bucket_cmk\" {\n   value = aws_kms_key.main.key_id\n }\n+\n+output \"bucket_cmk_arn\" {\n+  value = aws_kms_key.main.arn\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MjQ5MTYwOnYy", "diffSide": "RIGHT", "path": "insights/terraform/modules/bucket/policies.tf", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NToxOVrOGWONow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NToxOVrOGWONow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NDcyMw==", "bodyText": "Expanding the policy to be more comprehensive.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425954723", "createdAt": "2020-05-15T17:45:19Z", "author": {"login": "RickHawesUSDS"}, "path": "insights/terraform/modules/bucket/policies.tf", "diffHunk": "@@ -187,11 +189,11 @@ resource \"aws_s3_bucket_policy\" \"cross_account\" {\n               \"Action\": [\n                   \"s3:AbortMultipartUpload\",\n                   \"s3:GetBucketLocation\",\n-                  \"s3:GetObject\",\n+                  \"s3:GetObject*\",\n                   \"s3:ListBucket\",\n                   \"s3:ListBucketMultipartUploads\",\n-                  \"s3:PutObject\",\n-                  \"s3:PutObjectAcl\"\n+                  \"s3:PutObject*\",\n+                  \"s3:DeleteObject*\"\n               ],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MjQ5NTExOnYy", "diffSide": "LEFT", "path": "insights/terraform/projects/ab2d/main.tf", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NjoyOFrOGWOP5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NjoyOFrOGWOP5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NTMwMQ==", "bodyText": "Moving these tables to a new tables.tf as refactoring.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425955301", "createdAt": "2020-05-15T17:46:28Z", "author": {"login": "RickHawesUSDS"}, "path": "insights/terraform/projects/ab2d/main.tf", "diffHunk": "@@ -46,148 +54,17 @@ module \"database\" {\n   tags            = local.tags\n }\n \n-## Tables for the project", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MjQ5Nzk5OnYy", "diffSide": "RIGHT", "path": "insights/terraform/modules/jobs/main.tf", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NzoyOFrOGWOR4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NzoyOFrOGWOR4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NTgwOQ==", "bodyText": "The Glue Jobs module will have a lot more in the future.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425955809", "createdAt": "2020-05-15T17:47:28Z", "author": {"login": "RickHawesUSDS"}, "path": "insights/terraform/modules/jobs/main.tf", "diffHunk": "@@ -0,0 +1 @@\n+# Glue jobs stuff goes here", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1Mjg0NTQ4OnYy", "diffSide": "RIGHT", "path": "insights/terraform/modules/jobs/policies.tf", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0Mzo1N1rOGWRtsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0Mzo1N1rOGWRtsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMjA4Mw==", "bodyText": "Somewhat inconsequential, but the SID is included, yet blank.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426012083", "createdAt": "2020-05-15T19:43:57Z", "author": {"login": "njdister"}, "path": "insights/terraform/modules/jobs/policies.tf", "diffHunk": "@@ -0,0 +1,94 @@\n+## Glue Role\n+\n+resource \"aws_iam_role\" \"glue_role\" {\n+  name        = \"bfd-insights-${var.project}-glue-role\"\n+  description = \"Allow the Glue service to access the Insights buckets\" \n+  tags        = var.tags\n+  path        = \"/bfd-insights/\"\n+\n+  assume_role_policy = <<-POLICY\n+  {\n+    \"Version\": \"2012-10-17\",\n+    \"Statement\": [\n+      {\n+        \"Action\": \"sts:AssumeRole\",\n+        \"Principal\": {\n+          \"Service\": \"glue.amazonaws.com\"\n+        },\n+        \"Effect\": \"Allow\",\n+        \"Sid\": \"\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1Mjg1MDU3OnYy", "diffSide": "RIGHT", "path": "insights/terraform/modules/jobs/policies.tf", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0NTo0NVrOGWRw4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMDo0Njo0N1rOGWTWng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMjg5OQ==", "bodyText": "Interesting way to generate policy documents!  Appears less likely to break than by directly embedding JSON in a HEREDOC.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426012899", "createdAt": "2020-05-15T19:45:45Z", "author": {"login": "njdister"}, "path": "insights/terraform/modules/jobs/policies.tf", "diffHunk": "@@ -0,0 +1,94 @@\n+## Glue Role\n+\n+resource \"aws_iam_role\" \"glue_role\" {\n+  name        = \"bfd-insights-${var.project}-glue-role\"\n+  description = \"Allow the Glue service to access the Insights buckets\" \n+  tags        = var.tags\n+  path        = \"/bfd-insights/\"\n+\n+  assume_role_policy = <<-POLICY\n+  {\n+    \"Version\": \"2012-10-17\",\n+    \"Statement\": [\n+      {\n+        \"Action\": \"sts:AssumeRole\",\n+        \"Principal\": {\n+          \"Service\": \"glue.amazonaws.com\"\n+        },\n+        \"Effect\": \"Allow\",\n+        \"Sid\": \"\"\n+      }\n+    ]\n+  }\n+  POLICY\n+}\n+\n+## Find and create policies for the role\n+\n+data \"aws_iam_policy\" \"glue_service\" {\n+  arn  = \"arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole\"\n+}\n+\n+data \"aws_iam_policy\" \"athena_service\" {\n+  arn  = \"arn:aws:iam::aws:policy/AmazonAthenaFullAccess\"\n+}\n+\n+data \"aws_iam_policy_document\" \"s3_access\" {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAzODk0Mg==", "bodyText": "Right. JSON and HEREDOC are harder to debug.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426038942", "createdAt": "2020-05-15T20:46:47Z", "author": {"login": "RickHawesUSDS"}, "path": "insights/terraform/modules/jobs/policies.tf", "diffHunk": "@@ -0,0 +1,94 @@\n+## Glue Role\n+\n+resource \"aws_iam_role\" \"glue_role\" {\n+  name        = \"bfd-insights-${var.project}-glue-role\"\n+  description = \"Allow the Glue service to access the Insights buckets\" \n+  tags        = var.tags\n+  path        = \"/bfd-insights/\"\n+\n+  assume_role_policy = <<-POLICY\n+  {\n+    \"Version\": \"2012-10-17\",\n+    \"Statement\": [\n+      {\n+        \"Action\": \"sts:AssumeRole\",\n+        \"Principal\": {\n+          \"Service\": \"glue.amazonaws.com\"\n+        },\n+        \"Effect\": \"Allow\",\n+        \"Sid\": \"\"\n+      }\n+    ]\n+  }\n+  POLICY\n+}\n+\n+## Find and create policies for the role\n+\n+data \"aws_iam_policy\" \"glue_service\" {\n+  arn  = \"arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole\"\n+}\n+\n+data \"aws_iam_policy\" \"athena_service\" {\n+  arn  = \"arn:aws:iam::aws:policy/AmazonAthenaFullAccess\"\n+}\n+\n+data \"aws_iam_policy_document\" \"s3_access\" {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMjg5OQ=="}, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1Mjg2MTk5OnYy", "diffSide": "RIGHT", "path": "insights/terraform/projects/ab2d/main.tf", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0OTo0M1rOGWR3-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMDo1NTowNFrOGWTjlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxNDcxMw==", "bodyText": "Suggest replacing hardcoded acct number with the caller identity data source", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426014713", "createdAt": "2020-05-15T19:49:43Z", "author": {"login": "njdister"}, "path": "insights/terraform/projects/ab2d/main.tf", "diffHunk": "@@ -25,6 +25,14 @@ module \"bucket\" {\n   ]\n }\n \n+data \"aws_s3_bucket\" \"moderate_bucket\" {\n+  bucket = \"bfd-insights-moderate-577373831711\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA0MjI2MQ==", "bodyText": "Good point. Pushed a new change.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426042261", "createdAt": "2020-05-15T20:55:04Z", "author": {"login": "RickHawesUSDS"}, "path": "insights/terraform/projects/ab2d/main.tf", "diffHunk": "@@ -25,6 +25,14 @@ module \"bucket\" {\n   ]\n }\n \n+data \"aws_s3_bucket\" \"moderate_bucket\" {\n+  bucket = \"bfd-insights-moderate-577373831711\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxNDcxMw=="}, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 363, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}