{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNTkzNTAz", "number": 210, "title": "BLUEBUTTON-1281: Build MGMT TEST environment", "bodyText": "Change Details\n\nThis PR attempts to accomplishes several things:\n\n\nBegins to bring the mgmt TF and it's supporting modules into closer alignment with the method in which our TEST,PROD-SBX and PROD environments are built, as they are share specific resources and some reconciliation was needed, stateful is done, stateless will be completed within the new mgmt-test AZ to limit disruption of the Jenkins service.  The plan is to use this new mgmt-test environment to further this effort.\n\n\nAdds TF env mgmt-test with the AZ being the 'kicker'. us-east-1a will be MGMT and us-east-1c will be used for MGMT-TEST.\n\n\n\nStateful resources have already been created.\nStateless resource TF plan out is included in the comments. please review.\nFor some of the resources, I had to remove the env var within the naming, for shared resources between the two AZ's (ex. VPC, SG's, etc.) so that he env variable could be used for naming resources.\n\n\nUpdates Jenkins instance size to c5.xlarge (set as default in variables.tf and in TF vars in Keybase) - Until I deploy Jenkins with the new jenkins module (under construction) we will not be able to compare performance. My plan is to leave both Jenkins up and test them independently. See /keybase/team/oeda_bfs/infrastructure/secrets/terraform/jenkins for vars.\nRenamed instance_size to jenkins_instance_size variable.\n\n\nAcceptance Validation\n\n\nPlease ignore the state of the MGMT environment, I will use the new MGMT-TEST environment to resolve the open issues with MGMT (i.e. new LB and ASG resources, need to update Jenkins to use those and to switch to EFS)\nHaving run the stateful and with the output of the stateless, I believe this shows completeness.\n\n\nFeedback Requested\n\n\nInput on how I created the second environment, within the same VPC. I've decided to use AZ's to create the segmentation. Is there a better way?\n\nExternal References\n\n\nBLUEBUTTON-1579\nBLUEBUTTON-1807\n\nSecurity Implications\n\n\n new software dependencies\n\n\n\n altered security controls\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n requires more information or team discussion to evaluate security implications\n\n\nI added the 'is public' flag, have it default to false. Might use in the future?", "createdAt": "2020-02-04T00:48:38Z", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210", "merged": true, "mergeCommit": {"oid": "24697c61051c2eaceb92c3037ee2be90ac31f743"}, "closed": true, "closedAt": "2020-02-07T18:27:01Z", "author": {"login": "jzulim"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcA2KQ5AH2gAyMzcwNTkzNTAzOjlhNGY2MGMxMzM2YzdiNGQwNDBlNDNiNjAzNmVmYmE0OGIwMGE1YzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCDjJRAH2gAyMzcwNTkzNTAzOjFhYzExYzRkNzgwZDMxZDMyNDRkYzFiOWY2Mjg4NDI3OTE1ZThlODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9a4f60c1336c7b4d040e43b6036efba48b00a5c4", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/9a4f60c1336c7b4d040e43b6036efba48b00a5c4", "committedDate": "2020-02-04T00:12:10Z", "message": "Adding mgmt-test core files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "055e0c5eda0f6fe05a3216c0384a0adaa068ffa8", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/055e0c5eda0f6fe05a3216c0384a0adaa068ffa8", "committedDate": "2020-02-04T00:12:44Z", "message": "Adding vars file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e33fdc607bca703ffe7132124ab5e1f59e1bc375", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/e33fdc607bca703ffe7132124ab5e1f59e1bc375", "committedDate": "2020-02-04T00:13:27Z", "message": "Stateful backend"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bb3723e2ab011086b9343b3b7f751bf7fe25b29", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/9bb3723e2ab011086b9343b3b7f751bf7fe25b29", "committedDate": "2020-02-04T00:14:01Z", "message": "Stateful main for mgmt-test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d43ae0748990910bea8ab8260482cff612c453e3", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/d43ae0748990910bea8ab8260482cff612c453e3", "committedDate": "2020-02-04T00:14:42Z", "message": "Stateless backend config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbf343783d3652e4eb6d78bbbac3e546550273c9", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/fbf343783d3652e4eb6d78bbbac3e546550273c9", "committedDate": "2020-02-04T00:15:25Z", "message": "Stateless main for mgmt-test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b24d10566dbaabac5336e361d0fc40c7d74bff58", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/b24d10566dbaabac5336e361d0fc40c7d74bff58", "committedDate": "2020-02-04T00:17:37Z", "message": "Updating mgmt_stateful module main tf"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64c471fac0ec341875828628de6421ae8e54fe4e", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/64c471fac0ec341875828628de6421ae8e54fe4e", "committedDate": "2020-02-04T00:18:20Z", "message": "Updating mgmt_stateful vars, add az"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90430e547f65bdb838c017cbc310e81a2bea1821", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/90430e547f65bdb838c017cbc310e81a2bea1821", "committedDate": "2020-02-04T00:19:42Z", "message": "Updating mgmt_stateless module with new layout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4574fa3bcdd835de22c615a9c7afc0ffc9b062d9", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/4574fa3bcdd835de22c615a9c7afc0ffc9b062d9", "committedDate": "2020-02-04T00:20:23Z", "message": "Updaitng stateless vars with public and az option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68d939c80eb9413bca85871c486bc9eba4f5dd5d", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/68d939c80eb9413bca85871c486bc9eba4f5dd5d", "committedDate": "2020-02-04T00:36:22Z", "message": "Adding generic user_data script for jenkins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e1f92b106c36dbb2031f403ffc57a5e9ac3728b", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/8e1f92b106c36dbb2031f403ffc57a5e9ac3728b", "committedDate": "2020-02-04T00:37:24Z", "message": "Updating Jenkins module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/f38c13832e54ec6c929044ecee8f0731c52c1516", "committedDate": "2020-02-04T01:06:18Z", "message": "Remove app_subnets var, use data to get vals."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMTQxMDc3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#pullrequestreview-353141077", "createdAt": "2020-02-04T16:57:08Z", "commit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNjo1NzowOVrOFlbzXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNjo1NzowOVrOFlbzXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDc5NzE0OQ==", "bodyText": "For standardization across modules I would move the azs var outside of env_config.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r374797149", "createdAt": "2020-02-04T16:57:09Z", "author": {"login": "njdister"}, "path": "ops/terraform/env/mgmt-test/stateful/main.tf", "diffHunk": "@@ -0,0 +1,18 @@\n+terraform {\n+  required_version = \"~> 0.12\"\n+}\n+\n+provider \"aws\" {\n+  version = \"~> 2.25\"\n+  region = \"us-east-1\"\n+}\n+\n+module \"stateful\" {\n+  source = \"../../../modules/mgmt_stateful\"\n+\n+  env_config = {\n+    env               = \"mgmt-test\"\n+    tags              = {application=\"bfd\", business=\"oeda\", stack=\"mgmt-test\", Environment=\"mgmt-test\"}\n+    azs               = \"us-east-1c\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMTk0MTc5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#pullrequestreview-353194179", "createdAt": "2020-02-04T18:15:47Z", "commit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODoxNTo0OFrOFleU4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODoxNTo0OFrOFleU4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgzODQ5OA==", "bodyText": "Is renaming this going to affect any other modules that use this policy?  Worth a sanity check.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r374838498", "createdAt": "2020-02-04T18:15:48Z", "author": {"login": "njdister"}, "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -77,27 +75,19 @@ data \"aws_security_group\" \"management\" {\n #\n # Build a VPC private local zone for CNAME records\n #\n+\n resource \"aws_route53_zone\" \"local_zone\" {\n   name    = \"bfd-${var.env_config.env}.local\"\n   vpc {\n     vpc_id = data.aws_vpc.main.id\n   }\n }\n \n-# S3 Admin bucket for logs and other adminstrative \n-#\n-module \"admin\" {\n-  source              = \"../resources/s3\"\n-  role                = \"admin\"\n-  env_config          = local.env_config\n-  kms_key_id          = data.aws_kms_key.master_key.arn\n-  acl                 = \"log-delivery-write\"\n-}\n-\n # IAM policy to allow read access to ansible vault password\n #\n+\n resource \"aws_iam_policy\" \"ansible_vault_pw_ro_s3\" {\n-  name        = \"bfd-ansible-vault-pw-ro-s3\"\n+  name        = \"bfd-${var.env_config.env}-ansible-vault-pw-ro-s3\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "originalPosition": 98}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMjA5OTY4", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#pullrequestreview-353209968", "createdAt": "2020-02-04T18:40:11Z", "commit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0MDoxMVrOFlfGzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0MDoxMVrOFlfGzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1MTI3OA==", "bodyText": "Do you know if any of the packer roles/policies are actually used?  I suspect not unless we are doing something fancy in jenkins to sandbox packer (didn't appear so when I checked)", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r374851278", "createdAt": "2020-02-04T18:40:11Z", "author": {"login": "njdister"}, "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -121,33 +111,54 @@ resource \"aws_iam_policy\" \"ansible_vault_pw_ro_s3\" {\n EOF\n }\n \n-# S3 bucket for Build Artifacts\n+# S3 Admin bucket for adminstrative stuff\n #\n-module \"artifacts\" {\n+\n+module \"admin\" { \n   source              = \"../resources/s3\"\n-  role                = \"artifacts\"\n+  role                = \"admin\"\n   env_config          = local.env_config\n   kms_key_id          = data.aws_kms_key.master_key.arn\n-  log_bucket          = module.admin.id\n+  log_bucket          = module.logs.id\n+}\n+\n+# S3 bucket for logs \n+#\n+\n+module \"logs\" { \n+  source              = \"../resources/s3\"\n+  role                = \"logs\"\n+  env_config          = local.env_config\n+  acl                 = \"log-delivery-write\"  # For AWS bucket logs\n+  kms_key_id          = null                  # Use AWS encryption to support AWS Agents writing to this bucket\n }\n \n-# EBS Volume for Jenkins Data\n+# EFS for Jenkins Data (JENKINS_HOME)\n+resource \"aws_efs_file_system\" \"foo\" {\n+  creation_token = \"bfd-${var.env_config.env}-jenkins-data\"\n+\n+  tags = {\n+    Name = \"bfd-${var.env_config.env}-jenkins-data\"\n+  }\n+}\n \n resource \"aws_ebs_volume\" \"jenkins_data\" {\n-  availability_zone = data.aws_subnet.selected[0].availability_zone\n+  availability_zone = var.env_config.azs\n   size              = 1000\n   type              = \"gp2\"\n+  encrypted         = true\n+  kms_key_id        = data.aws_kms_key.master_key.arn\n \n   tags = {\n-    Name       = \"bfd-mgmt-jenkins-data-master\"\n+    Name       = \"bfd-${var.env_config.env}-jenkins-data\"\n     cpm_backup = \"4HR Daily Weekly Monthly\"\n   }\n }\n \n # IAM Roles, Profiles and Policies for Packer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "originalPosition": 157}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMjEyODUx", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#pullrequestreview-353212851", "createdAt": "2020-02-04T18:44:39Z", "commit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0NDozOVrOFlfPyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODo0NDozOVrOFlfPyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1MzU3Ng==", "bodyText": "This is a bit confusing having two AZ variables.  It would be good to standardize how we do this.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r374853576", "createdAt": "2020-02-04T18:44:39Z", "author": {"login": "njdister"}, "path": "ops/terraform/modules/resources/jenkins/main.tf", "diffHunk": "@@ -1,4 +1,6 @@\n locals {\n+  azs         = [\"us-east-1a\"]\n+  env_config  = {env=var.env_config.env, tags=var.env_config.tags, azs=local.azs}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjg2ODQ3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#pullrequestreview-353686847", "createdAt": "2020-02-05T12:45:01Z", "commit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjo0NTowMlrOFl2dEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjo0NTowMlrOFl2dEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzMzgxMQ==", "bodyText": "In the current version of stateless/main.tf there is a variable for vpn_security_group_id, was this intentionally left out?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375233811", "createdAt": "2020-02-05T12:45:02Z", "author": {"login": "cthulhuplus"}, "path": "ops/terraform/env/mgmt-test/stateless/main.tf", "diffHunk": "@@ -0,0 +1,22 @@\n+terraform {\n+  required_version = \"~> 0.12\"\n+}\n+\n+provider \"aws\" {\n+  version = \"~> 2.25\"\n+  region = \"us-east-1\"\n+}\n+\n+module \"stateless\" {\n+  source = \"../../../modules/mgmt_stateless\"\n+\n+  env_config = {\n+    env               = \"mgmt-test\"\n+    tags              = {application=\"bfd\", business=\"oeda\", stack=\"mgmt\", Environment=\"mgmt-test\"}\n+  }  \n+\n+  jenkins_ami            = var.jenkins_ami\n+  jenkins_key_name       = var.jenkins_key_name\n+  jenkins_instance_size  = var.jenkins_instance_size\n+  azs                    = var.azs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjg3ODA3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#pullrequestreview-353687807", "createdAt": "2020-02-05T12:46:49Z", "commit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjo0Njo0OVrOFl2f5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjo0Njo0OVrOFl2f5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzNDUzNQ==", "bodyText": "Same as before, there is a missing declaration for vpn_security_group_id.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375234535", "createdAt": "2020-02-05T12:46:49Z", "author": {"login": "cthulhuplus"}, "path": "ops/terraform/env/mgmt-test/stateless/variables.tf", "diffHunk": "@@ -0,0 +1,20 @@\n+variable \"jenkins_ami\" {\n+  description       = \"Jenkins server AMI\"\n+  type              = string\n+}\n+\n+variable \"jenkins_key_name\" {\n+  description       = \"The EC2 key pair name to assign to jenkins instances\"\n+  type              = string\n+}\n+\n+variable \"jenkins_instance_size\" {\n+  type              = string\n+  description       = \"The EC2 instance size to use\"\n+  default           = \"c5.xlarge\"\n+}\n+\n+variable \"azs\" {\n+  description       = \"AZs to use\"\n+  type              = list", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjkwNTI3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#pullrequestreview-353690527", "createdAt": "2020-02-05T12:51:39Z", "commit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjo1MTozOVrOFl2nzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjo1MTozOVrOFl2nzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzNjU1OA==", "bodyText": "Maybe I'm being nit picky, but \"foo\" seems out of place in production code", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375236558", "createdAt": "2020-02-05T12:51:39Z", "author": {"login": "cthulhuplus"}, "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -121,33 +111,54 @@ resource \"aws_iam_policy\" \"ansible_vault_pw_ro_s3\" {\n EOF\n }\n \n-# S3 bucket for Build Artifacts\n+# S3 Admin bucket for adminstrative stuff\n #\n-module \"artifacts\" {\n+\n+module \"admin\" { \n   source              = \"../resources/s3\"\n-  role                = \"artifacts\"\n+  role                = \"admin\"\n   env_config          = local.env_config\n   kms_key_id          = data.aws_kms_key.master_key.arn\n-  log_bucket          = module.admin.id\n+  log_bucket          = module.logs.id\n+}\n+\n+# S3 bucket for logs \n+#\n+\n+module \"logs\" { \n+  source              = \"../resources/s3\"\n+  role                = \"logs\"\n+  env_config          = local.env_config\n+  acl                 = \"log-delivery-write\"  # For AWS bucket logs\n+  kms_key_id          = null                  # Use AWS encryption to support AWS Agents writing to this bucket\n }\n \n-# EBS Volume for Jenkins Data\n+# EFS for Jenkins Data (JENKINS_HOME)\n+resource \"aws_efs_file_system\" \"foo\" {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "originalPosition": 134}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjkxNzQy", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#pullrequestreview-353691742", "createdAt": "2020-02-05T12:53:45Z", "commit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjo1Mzo0NVrOFl2rcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMjo1Mzo0NVrOFl2rcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTIzNzQ5MQ==", "bodyText": "I feel like switching to hard coded values is a step backwards, if it is necessary to achieve a short term goal we should create a tech debt ticket to re-variable-ize in the future.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#discussion_r375237491", "createdAt": "2020-02-05T12:53:45Z", "author": {"login": "cthulhuplus"}, "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -5,16 +5,15 @@\n #\n \n locals {\n-  azs = [\"us-east-1a\", \"us-east-1b\", \"us-east-1c\"]\n-  env_config = {env=var.env_config.env, tags=var.env_config.tags, vpc_id=data.aws_vpc.main.id, zone_id=aws_route53_zone.local_zone.id }\n+  env_config = {env=var.env_config.env, tags=var.env_config.tags, vpc_id=data.aws_vpc.main.id, zone_id=aws_route53_zone.local_zone.id, azs=var.env_config.azs}\n }\n \n # VPC\n #\n data \"aws_vpc\" \"main\" {\n   filter {\n     name = \"tag:Name\"\n-    values = [\"bfd-${var.env_config.env}-vpc\"]\n+    values = [\"bfd-mgmt-vpc\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNjk2NDMz", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#pullrequestreview-353696433", "createdAt": "2020-02-05T13:01:41Z", "commit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MTYzMzM1", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#pullrequestreview-354163335", "createdAt": "2020-02-06T02:10:00Z", "commit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NjMyOTg2", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/210#pullrequestreview-354632986", "createdAt": "2020-02-06T17:23:46Z", "commit": {"oid": "f38c13832e54ec6c929044ecee8f0731c52c1516"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ac11c4d780d31d3244dc1b9f6288427915e8e83", "author": {"user": {"login": "jzulim", "name": "John Zulim"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/1ac11c4d780d31d3244dc1b9f6288427915e8e83", "committedDate": "2020-02-07T18:22:02Z", "message": "Merge branch 'master' into BLUEBUTTON-1281-mgmt-test-v2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 669, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}