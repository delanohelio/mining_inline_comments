{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NzE1OTgz", "number": 275, "title": "BFD-164: AB2D glue role", "bodyText": "JIRA Ticket:\nBFD-164\nUser Story or Bug Summary:\nSetup the BFD-Insights project for AB2D\nWhat Does This PR Do?\nThis PR adds an AWS role for Glue jobs to access the S3 buckets of the project.\nWhat Should Reviewers Watch For?\nMistakes or missing pieces.\nSubmitters should complete the following questionnaire:\nN/A", "createdAt": "2020-05-15T17:33:15Z", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275", "merged": true, "mergeCommit": {"oid": "e29010305f6ed9f9d435d77ef7e2d5d3a5e0ca7c"}, "closed": true, "closedAt": "2020-05-15T21:16:23Z", "author": {"login": "RickHawesUSDS"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchljv3gH2gAyNDE4NzE1OTgzOjI2MGU1YjlkNzcwNDk2ZjVkYTEyZjRlM2NmOThiNWZmNmExODJmNzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchove7gFqTQxMjk3MTgwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/260e5b9d770496f5da12f4e3cf98b5ff6a182f72", "committedDate": "2020-05-15T17:31:07Z", "message": "AB2D glue role"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODQ2MzYx", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#pullrequestreview-412846361", "createdAt": "2020-05-15T17:44:08Z", "commit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NDowOVrOGWOLLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNzo0NzoyOFrOGWOR4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NDA5NQ==", "bodyText": "This change makes defaults explicit", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425954095", "createdAt": "2020-05-15T17:44:09Z", "author": {"login": "RickHawesUSDS"}, "path": "insights/terraform/modules/bucket/main.tf", "diffHunk": "@@ -47,6 +47,8 @@ resource \"aws_s3_bucket_object\" \"top\" {\n resource \"aws_kms_key\" \"main\" {\n   description   = \"CMK for the ${local.full_name} bucket\"\n   tags          = var.tags\n+  key_usage     = \"ENCRYPT_DECRYPT\"\n+  is_enabled    = true\n   policy        = length(var.cross_accounts) > 0 ? data.aws_iam_policy_document.cmk_policy.json : null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NDM1Ng==", "bodyText": "Will need the arn later.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425954356", "createdAt": "2020-05-15T17:44:38Z", "author": {"login": "RickHawesUSDS"}, "path": "insights/terraform/modules/bucket/outputs.tf", "diffHunk": "@@ -9,3 +9,7 @@ output \"id\" {\n output \"bucket_cmk\" {\n   value = aws_kms_key.main.key_id\n }\n+\n+output \"bucket_cmk_arn\" {\n+  value = aws_kms_key.main.arn\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NDcyMw==", "bodyText": "Expanding the policy to be more comprehensive.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425954723", "createdAt": "2020-05-15T17:45:19Z", "author": {"login": "RickHawesUSDS"}, "path": "insights/terraform/modules/bucket/policies.tf", "diffHunk": "@@ -187,11 +189,11 @@ resource \"aws_s3_bucket_policy\" \"cross_account\" {\n               \"Action\": [\n                   \"s3:AbortMultipartUpload\",\n                   \"s3:GetBucketLocation\",\n-                  \"s3:GetObject\",\n+                  \"s3:GetObject*\",\n                   \"s3:ListBucket\",\n                   \"s3:ListBucketMultipartUploads\",\n-                  \"s3:PutObject\",\n-                  \"s3:PutObjectAcl\"\n+                  \"s3:PutObject*\",\n+                  \"s3:DeleteObject*\"\n               ],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NTMwMQ==", "bodyText": "Moving these tables to a new tables.tf as refactoring.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425955301", "createdAt": "2020-05-15T17:46:28Z", "author": {"login": "RickHawesUSDS"}, "path": "insights/terraform/projects/ab2d/main.tf", "diffHunk": "@@ -46,148 +54,17 @@ module \"database\" {\n   tags            = local.tags\n }\n \n-## Tables for the project", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk1NTgwOQ==", "bodyText": "The Glue Jobs module will have a lot more in the future.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r425955809", "createdAt": "2020-05-15T17:47:28Z", "author": {"login": "RickHawesUSDS"}, "path": "insights/terraform/modules/jobs/main.tf", "diffHunk": "@@ -0,0 +1 @@\n+# Glue jobs stuff goes here", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODcwMDY3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#pullrequestreview-412870067", "createdAt": "2020-05-15T18:21:06Z", "commit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODkzMTc2", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#pullrequestreview-412893176", "createdAt": "2020-05-15T18:57:06Z", "commit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTIxNDQ0", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#pullrequestreview-412921444", "createdAt": "2020-05-15T19:43:57Z", "commit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0Mzo1N1rOGWRtsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0Mzo1N1rOGWRtsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMjA4Mw==", "bodyText": "Somewhat inconsequential, but the SID is included, yet blank.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426012083", "createdAt": "2020-05-15T19:43:57Z", "author": {"login": "njdister"}, "path": "insights/terraform/modules/jobs/policies.tf", "diffHunk": "@@ -0,0 +1,94 @@\n+## Glue Role\n+\n+resource \"aws_iam_role\" \"glue_role\" {\n+  name        = \"bfd-insights-${var.project}-glue-role\"\n+  description = \"Allow the Glue service to access the Insights buckets\" \n+  tags        = var.tags\n+  path        = \"/bfd-insights/\"\n+\n+  assume_role_policy = <<-POLICY\n+  {\n+    \"Version\": \"2012-10-17\",\n+    \"Statement\": [\n+      {\n+        \"Action\": \"sts:AssumeRole\",\n+        \"Principal\": {\n+          \"Service\": \"glue.amazonaws.com\"\n+        },\n+        \"Effect\": \"Allow\",\n+        \"Sid\": \"\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTIyNTAy", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#pullrequestreview-412922502", "createdAt": "2020-05-15T19:45:45Z", "commit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0NTo0NVrOGWRw4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0NTo0NVrOGWRw4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxMjg5OQ==", "bodyText": "Interesting way to generate policy documents!  Appears less likely to break than by directly embedding JSON in a HEREDOC.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426012899", "createdAt": "2020-05-15T19:45:45Z", "author": {"login": "njdister"}, "path": "insights/terraform/modules/jobs/policies.tf", "diffHunk": "@@ -0,0 +1,94 @@\n+## Glue Role\n+\n+resource \"aws_iam_role\" \"glue_role\" {\n+  name        = \"bfd-insights-${var.project}-glue-role\"\n+  description = \"Allow the Glue service to access the Insights buckets\" \n+  tags        = var.tags\n+  path        = \"/bfd-insights/\"\n+\n+  assume_role_policy = <<-POLICY\n+  {\n+    \"Version\": \"2012-10-17\",\n+    \"Statement\": [\n+      {\n+        \"Action\": \"sts:AssumeRole\",\n+        \"Principal\": {\n+          \"Service\": \"glue.amazonaws.com\"\n+        },\n+        \"Effect\": \"Allow\",\n+        \"Sid\": \"\"\n+      }\n+    ]\n+  }\n+  POLICY\n+}\n+\n+## Find and create policies for the role\n+\n+data \"aws_iam_policy\" \"glue_service\" {\n+  arn  = \"arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole\"\n+}\n+\n+data \"aws_iam_policy\" \"athena_service\" {\n+  arn  = \"arn:aws:iam::aws:policy/AmazonAthenaFullAccess\"\n+}\n+\n+data \"aws_iam_policy_document\" \"s3_access\" {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTI0OTk5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#pullrequestreview-412924999", "createdAt": "2020-05-15T19:49:43Z", "commit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0OTo0M1rOGWR3-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxOTo0OTo0M1rOGWR3-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjAxNDcxMw==", "bodyText": "Suggest replacing hardcoded acct number with the caller identity data source", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#discussion_r426014713", "createdAt": "2020-05-15T19:49:43Z", "author": {"login": "njdister"}, "path": "insights/terraform/projects/ab2d/main.tf", "diffHunk": "@@ -25,6 +25,14 @@ module \"bucket\" {\n   ]\n }\n \n+data \"aws_s3_bucket\" \"moderate_bucket\" {\n+  bucket = \"bfd-insights-moderate-577373831711\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260e5b9d770496f5da12f4e3cf98b5ff6a182f72"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bb9ba9888014c1af4444ed98b4272057100f7b5", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/7bb9ba9888014c1af4444ed98b4272057100f7b5", "committedDate": "2020-05-15T20:54:08Z", "message": "Changes suggested by Nathan"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTY5NTk0", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#pullrequestreview-412969594", "createdAt": "2020-05-15T21:09:19Z", "commit": {"oid": "7bb9ba9888014c1af4444ed98b4272057100f7b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTcxODA4", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/275#pullrequestreview-412971808", "createdAt": "2020-05-15T21:13:39Z", "commit": {"oid": "7bb9ba9888014c1af4444ed98b4272057100f7b5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 748, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}