{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4NzIxMjEx", "number": 228, "title": "Fix latency issue when RIF files are being loaded. ", "bodyText": "Why\nDuring a load of RIF files in production, Coverage calls were discovered to be slowing down.\nWhat Changed\nReplace a lock for the entire refreshFilters method with one just at the end when the state is set.\nTesting Done\n\nLocal IT\nAd-hoc load testing of making a request while loading", "createdAt": "2020-02-23T16:01:03Z", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228", "merged": true, "mergeCommit": {"oid": "6edfed431b233fb302719b4e85caa14011ec7225"}, "closed": true, "closedAt": "2020-02-23T17:34:50Z", "author": {"login": "RickHawesUSDS"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHLDvyAH2gAyMzc4NzIxMjExOjAwY2E0MzY1ZmQ4MTAxOTJiMzNjMGFlZmQzN2Q2MjlkMmM4MDE1N2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHMPHBgFqTM2MzEwOTY1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "00ca4365fd810192b33c0aefd37d629d2c80157d", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/00ca4365fd810192b33c0aefd37d629d2c80157d", "committedDate": "2020-02-23T15:56:36Z", "message": "Improve refreshFilters locking\n\n- Replace a lock for the entire refreshFilters call with one at the end."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTA1MjM5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228#pullrequestreview-363105239", "createdAt": "2020-02-23T16:04:19Z", "commit": {"oid": "00ca4365fd810192b33c0aefd37d629d2c80157d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QxNjowNDoxOVrOFtRfNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QxNjowNToxMVrOFtRfZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAxNjc1Nw==", "bodyText": "This the mistake. The design calls for this function to not interfere with requests. By making the call synchronous, it locks the manger and requests have to wait.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228#discussion_r383016757", "createdAt": "2020-02-23T16:04:19Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -204,10 +204,11 @@ public synchronized boolean isInBounds(DateRangeParam range) {\n    * call.\n    */\n   @Scheduled(fixedDelay = 1000, initialDelay = 2000)\n-  public synchronized void refreshFilters() {\n+  public void refreshFilters() {\n     /*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00ca4365fd810192b33c0aefd37d629d2c80157d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAxNjgwNQ==", "bodyText": "Now, instead of setting the filters and other states during the method, the state is set once at the end.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228#discussion_r383016805", "createdAt": "2020-02-23T16:05:11Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -232,26 +233,25 @@ public synchronized void refreshFilters() {\n             || this.firstBatchCreated.before(currentFirstBatchUpdate)) {\n           LOGGER.info(\"Trimmed LoadedFile filters before {}\", currentFirstBatchUpdate);\n           List<LoadedFile> loadedFiles = fetchLoadedFiles();\n-          this.filters = trimFilters(this.filters, loadedFiles);\n-          this.firstBatchCreated = currentFirstBatchUpdate;\n+          newFilters = trimFilters(newFilters, loadedFiles);\n         }\n \n-        // update the transaction time as well\n-        this.transactionTime = currentLastBatchCreated;\n+        set(newFilters, currentFirstBatchUpdate, currentFirstBatchUpdate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00ca4365fd810192b33c0aefd37d629d2c80157d"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTA3NDU5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228#pullrequestreview-363107459", "createdAt": "2020-02-23T16:40:30Z", "commit": {"oid": "00ca4365fd810192b33c0aefd37d629d2c80157d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QxNjo0MDozMFrOFtRp_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yM1QxNjo0MDozMFrOFtRp_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAxOTUxNg==", "bodyText": "Shouldn't the third parameter passed into set be currentLastBatchCreated rather than currentFirstBatchUpdate or am I misunderstanding the workflow?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228#discussion_r383019516", "createdAt": "2020-02-23T16:40:30Z", "author": {"login": "njdister"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -232,26 +233,25 @@ public synchronized void refreshFilters() {\n             || this.firstBatchCreated.before(currentFirstBatchUpdate)) {\n           LOGGER.info(\"Trimmed LoadedFile filters before {}\", currentFirstBatchUpdate);\n           List<LoadedFile> loadedFiles = fetchLoadedFiles();\n-          this.filters = trimFilters(this.filters, loadedFiles);\n-          this.firstBatchCreated = currentFirstBatchUpdate;\n+          newFilters = trimFilters(newFilters, loadedFiles);\n         }\n \n-        // update the transaction time as well\n-        this.transactionTime = currentLastBatchCreated;\n+        set(newFilters, currentFirstBatchUpdate, currentFirstBatchUpdate);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzAxNjgwNQ=="}, "originalCommit": {"oid": "00ca4365fd810192b33c0aefd37d629d2c80157d"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "888ce25ac89a0ffd3b0826dd32bd909806032fc3", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/888ce25ac89a0ffd3b0826dd32bd909806032fc3", "committedDate": "2020-02-23T16:51:36Z", "message": "Fixed a mistake in setting state"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTA4ODUz", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228#pullrequestreview-363108853", "createdAt": "2020-02-23T17:03:58Z", "commit": {"oid": "888ce25ac89a0ffd3b0826dd32bd909806032fc3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTA5NTcy", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228#pullrequestreview-363109572", "createdAt": "2020-02-23T17:17:22Z", "commit": {"oid": "888ce25ac89a0ffd3b0826dd32bd909806032fc3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTA5NjU3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/228#pullrequestreview-363109657", "createdAt": "2020-02-23T17:18:55Z", "commit": {"oid": "888ce25ac89a0ffd3b0826dd32bd909806032fc3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 689, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}