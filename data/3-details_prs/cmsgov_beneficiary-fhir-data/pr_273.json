{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NTY4MTYy", "number": 273, "title": "BLUEBUTTON-1864: Refactor medicare opt out module to support assumed writer role", "bodyText": "JIRA Ticket:\nBLUEBUTTON-1864\nUser Story or Bug Summary:\nRefactor medicare opt out module to support assumed writer role\nWhat Does This PR Do?\n\nRefactors the s3_pii module so that we no longer pass in a list of external writer roles, but instead pass in a list of writer AWS accounts that will assume a writer role we create.  This solves the issue of a bucket owner not being able to apply policies to objects owned by another account.\nWhile refactoring this module I ran into multiple issues with JSON formatting due to terraform template string interpolation, so I have wrapped the JSON templates in jsonencode and moved to native terraform expressions as per recommendations: https://www.terraform.io/docs/configuration/functions/templatefile.html#generating-json-or-yaml-from-a-template\nRestructured the bucket policy a bit so it is simpler to reason about and reduces duplication\nMinor formatting changes\nAdds @RickHawesUSDS as an admin\n\nWhat Should Reviewers Watch For?\nThis has successfully been applied in test, prod-sbx, and prod (and tested by 3rd party teams in prod-sbx) however it would be good to watch out for:\n\nUnintended side effects\nGeneral clarity\n\nWhat Security Implications Does This PR Have?\n\nIf the answer to any of the questions below is Yes, then here's a link to the associated Security Impact Assessment: N/A.\n\nDoes this PR add any new software dependencies? No.\nDoes this PR modify or invalidate any of our security controls?No.\nDoes this PR store or transmit data that was not stored or transmitted before? No.\n\n\nIf the answer to any of the questions below is Yes, then please add @StewGoin as a reviewer, and note that this PR should not be merged unless/until he also approves it.\n\nDo you think this PR requires additional review of its security implications for other reasons? No.\n\n\n\nWhat Needs to Be Merged and Deployed Before this PR?\nN/A\nSubmitter Checklist\nBefore requesting final review, I've gone through and verified that this PR complies with the following requirements:\n\n\n I've refactored and rebased this PR (for help, see: this and this, if needed, so that it is as small as it can reasonably be, in order to:\n\nEnsure that any problems it causes have a small \"blast radius\".\nEnsure that it'll be easier to rollback if that becomes necessary.\nEase the burden on reviewers.\n\n\n\n I've verified that the commits in this PR:\n\n\nReasonably explain the \"what\" and \"why\" of the changes.\n\n\nLeverage JIRA's smart commits to reference the JIRA ticket that they're associated with. For example, aim for commit messages like this (note also the 50/72 formatting used here):\nAdded the whizbang to the doodad.\n\nThe new whizbang should really simplify things for our whoosit users.\nIt was a bit tricky to get it into the doodad, but we decided that the\nflipwhee pattern was the best approach for now. Might want to revisit\nthat in the future if it ends up being too hard to maintain.\n\nSOMEPROJECT-42\n\n\n\n\n\n I've verified that this PR includes all required documentation changes, including README updates and changelog / release notes entries.\n\n\n I've verified that all new and modified code is appropriately commented, such that the what and why of its design would be reasonably clear to engineers, preferably ones unfamiliar with the project.\n\n\n I've verified that all tech debt and/or shortcomings introduced by this PR is detailed in TODO and/or FIXME comments, which include a JIRA ticket ID for any items that require urgent attention.\n\n\n I've requested review from at least two other engineers on this project, at least one of whom is a senior engineer or owns the relevant component(s) here.\n\n\n I've requested review from any relevant engineers on other projects (e.g. BFD, SLS, etc.).\n\n\n I've verified that this PR and its changes comply with all other policies in the DASG Engineering Standards and have specifically called out any/all deviations in this PR.", "createdAt": "2020-05-13T19:33:05Z", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273", "merged": true, "mergeCommit": {"oid": "6fe162c8942f441cf1b8f9d3cbbd2efdd33033b2"}, "closed": true, "closedAt": "2020-05-18T15:29:50Z", "author": {"login": "njdister"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceGra4AH2gAyNDE3NTY4MTYyOjRiMTY3ODE2YTAwOWNmMGRmMmY1MWM0N2M4YmI1NTVkYWIzMTUxMWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcihmJ7gFqTQxMzcwMzc3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4b167816a009cf0df2f51c47c8bb555dab31511b", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/4b167816a009cf0df2f51c47c8bb555dab31511b", "committedDate": "2020-05-04T21:50:40Z", "message": "Add AB2D root ARN due to greenfield"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b432b87007e50ef37662332d21a6e8ae6472d151", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/b432b87007e50ef37662332d21a6e8ae6472d151", "committedDate": "2020-05-05T18:17:39Z", "message": "Make bucket policy statements apply to root and objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8fce0ceded7bd6b3488fdfa7ce958ac6551e903", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/b8fce0ceded7bd6b3488fdfa7ce958ac6551e903", "committedDate": "2020-05-05T19:42:19Z", "message": "Add object versioning to policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1774d736a8eaa4602e198b99bc24cc83eb1ad4c", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/a1774d736a8eaa4602e198b99bc24cc83eb1ad4c", "committedDate": "2020-05-12T18:33:34Z", "message": "More inclusive permissions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "231c4114f9371c0b935fe3eb3b438e878f04b38a", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/231c4114f9371c0b935fe3eb3b438e878f04b38a", "committedDate": "2020-05-13T14:19:23Z", "message": "Add writer assume from external acct role and policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caaff2a7edd24db4100fe40b1f94b915b88dc094", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/caaff2a7edd24db4100fe40b1f94b915b88dc094", "committedDate": "2020-05-13T14:26:36Z", "message": "Revert \"Add AB2D root ARN due to greenfield\"\n\nThis reverts commit 4b167816a009cf0df2f51c47c8bb555dab31511b."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18f16d1a7e6bcde93694a19a1db2e28b11c58291", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/18f16d1a7e6bcde93694a19a1db2e28b11c58291", "committedDate": "2020-05-13T14:32:26Z", "message": "Add headbucket perm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccbc61cec2285be1a491ab7bfb0be220f1819258", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/ccbc61cec2285be1a491ab7bfb0be220f1819258", "committedDate": "2020-05-13T14:39:00Z", "message": "Pass through write ext assume acct"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3841002c20d7e38787d00a9177fe27739b81b5cb", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/3841002c20d7e38787d00a9177fe27739b81b5cb", "committedDate": "2020-05-13T14:40:26Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fedb127af32044c31bc8ea9e24f030c42019434", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/0fedb127af32044c31bc8ea9e24f030c42019434", "committedDate": "2020-05-13T14:59:28Z", "message": "HeadBucket must target *, add perms to write assume role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1682f8678334be6a20f1f940b004f1a423775147", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/1682f8678334be6a20f1f940b004f1a423775147", "committedDate": "2020-05-13T15:04:35Z", "message": "Fix policy syntax"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5886e0222b814f0b26566d7add849db63c6ace42", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/5886e0222b814f0b26566d7add849db63c6ace42", "committedDate": "2020-05-13T18:39:57Z", "message": "Completely refactor S3 PII module to use jsonencode in templates to fix various validation issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/bff6f8061f75f5b9a793cd652a3355f328ca92cd", "committedDate": "2020-05-13T18:54:45Z", "message": "Fix formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjQwNDYz", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#pullrequestreview-411240463", "createdAt": "2020-05-13T19:38:17Z", "commit": {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTozODoxN1rOGVAtqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTozODoxN1rOGVAtqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4NDk2OA==", "bodyText": "Confirmed from BCDA perspective, these are no longer needed.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#discussion_r424684968", "createdAt": "2020-05-13T19:38:17Z", "author": {"login": "msnook"}, "path": "ops/terraform/env/prod-sbx/stateful/main.tf", "diffHunk": "@@ -51,7 +51,7 @@ module \"stateful\" {\n \n   medicare_opt_out_config = {\n     read_roles        = [\"arn:aws:iam::755619740999:role/dpc-dev-consent-execution-role\", \"arn:aws:iam::349849222861:role/Ab2dInstanceRole\", \"arn:aws:iam::777200079629:role/Ab2dInstanceRole\", \"arn:aws:iam::330810004472:role/Ab2dInstanceRole\"]\n-    write_roles       = [\"arn:aws:iam::755619740999:role/bcda-dev-nfs-instance\", \"arn:aws:iam::755619740999:role/bcda-test-nfs-instance\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjQwNjE5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#pullrequestreview-411240619", "createdAt": "2020-05-13T19:38:32Z", "commit": {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTozODozMlrOGVAuJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxOTozODozMlrOGVAuJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY4NTA5NQ==", "bodyText": "Confirmed from BCDA perspective, this is no longer needed.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#discussion_r424685095", "createdAt": "2020-05-13T19:38:32Z", "author": {"login": "msnook"}, "path": "ops/terraform/env/prod/stateful/main.tf", "diffHunk": "@@ -60,7 +60,7 @@ module \"stateful\" {\n   medicare_opt_out_config = {\n     # TODO: add read roles for DPC\n     read_roles        = []\n-    write_roles       = [\"arn:aws:iam::755619740999:role/bcda-prod-nfs-instance\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjQzOTQw", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#pullrequestreview-411243940", "createdAt": "2020-05-13T19:43:29Z", "commit": {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjYxMTM2", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#pullrequestreview-411261136", "createdAt": "2020-05-13T20:08:19Z", "commit": {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDowODoxOVrOGVBsiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDowODoxOVrOGVBsiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwMTA2NQ==", "bodyText": "Suggest that you could add s3:HeadBucket, and s3: GetBucketLocation to the actions list.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#discussion_r424701065", "createdAt": "2020-05-13T20:08:19Z", "author": {"login": "RickHawesUSDS"}, "path": "ops/terraform/modules/resources/s3_pii/templates/bucket-policy.json", "diffHunk": "@@ -1,62 +1,48 @@\n+${jsonencode(\n {\n   \"Version\": \"2012-10-17\",\n   \"Id\": \"bfd-${env}-${bucket_name}-s3-policy\",\n   \"Statement\": [\n-    {\n-      \"Sid\": \"BFDPIIS3ListBucket\",\n-      \"Effect\": \"Allow\",\n-      \"Principal\": {\n-        \"AWS\": [\n-          %{ for reader in readers ~}\"${reader}\",%{ endfor ~}\n-          %{ for writer in writers ~}\"${writer}\",%{ endfor ~}\n-          %{ for admin in admins ~}\"${admin}\",%{ endfor ~}\n-          \"${root}\"\n-        ]\n-      },\n-      \"Action\": [\n-        \"s3:ListBucket\"\n-      ],\n-      \"Resource\": \"arn:aws:s3:::${bucket_id}\"\n-    },\n     {\n       \"Sid\": \"BFDPIIS3ReadBucket\",\n       \"Effect\": \"Allow\",\n       \"Principal\": {\n         \"AWS\": [\n-          %{ for reader in readers ~}\"${reader}\",%{ endfor ~}\n-          %{ for writer in writers ~}\"${writer}\",%{ endfor ~}\n-          %{ for admin in admins ~}\"${admin}\",%{ endfor ~}\n-          \"${root}\"\n+          for arn in concat(readers, writers) : \"${arn}\"\n         ]\n       },\n       \"Action\": [\n-        \"s3:GetObject\"\n+        \"s3:ListBucket*\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bff6f8061f75f5b9a793cd652a3355f328ca92cd"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e7aa9958bcfa0fe36e7e7d3df4139c0c440fba1", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/3e7aa9958bcfa0fe36e7e7d3df4139c0c440fba1", "committedDate": "2020-05-14T15:01:14Z", "message": "Add more bucket read operations to s3 policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4241d1480ca1fdcee32596f4c6aaa32ba5e6ffe", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/d4241d1480ca1fdcee32596f4c6aaa32ba5e6ffe", "committedDate": "2020-05-14T15:18:24Z", "message": "Head bucket not valid within S3 policy on specific bucket ARN"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d787750974c030852da30975858af3f1e7f0e36d", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/d787750974c030852da30975858af3f1e7f0e36d", "committedDate": "2020-05-14T16:53:31Z", "message": "Use Ricks account from BFD"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODk3NTYx", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#pullrequestreview-412897561", "createdAt": "2020-05-15T19:01:59Z", "commit": {"oid": "d787750974c030852da30975858af3f1e7f0e36d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNzAzNzc3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/273#pullrequestreview-413703777", "createdAt": "2020-05-18T15:28:03Z", "commit": {"oid": "d787750974c030852da30975858af3f1e7f0e36d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 745, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}