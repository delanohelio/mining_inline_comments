{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0ODU1NTEx", "number": 218, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzoxNjowNlrODfik7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNjoyODowOFrODfnNcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0Mzk4OTU3OnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzoxNjowNlrOFpTSmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzoxNjowNlrOFpTSmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1MTk5NQ==", "bodyText": "This date is used in the case that the LoadedBatches table is empty. It just needs to be sometime in the past.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378851995", "createdAt": "2020-02-13T13:16:06Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -27,6 +31,10 @@\n public class LoadedFilterManager {\n   private static final Logger LOGGER = LoggerFactory.getLogger(LoadedFilterManager.class);\n \n+  // A date before the lastUpdate feature was rolled out\n+  private static final Date BEFORE_LAST_UPDATE = Date.from(Instant.parse(\"2020-01-01T00:00:00Z\"));\n+\n+  // The size of the beneficiaryId column", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "310cbe31149ad97b921b81d32c29aa40d9b269bf"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0Mzk5MTg3OnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzoxNjo1MlrOFpTUEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzoxNjo1MlrOFpTUEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1MjM2OA==", "bodyText": "lastBatchCreated is set by the refreshFilters.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378852368", "createdAt": "2020-02-13T13:16:52Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -35,11 +43,14 @@\n   // The filter set\n   private List<LoadedFileFilter> filters;\n \n-  // Max created date from the database's LoadedBatch table\n+  // The latest transaction time from the LoadedBatch files\n   private Date transactionTime;\n \n-  // Min created date from the databases's LoadedBatch table\n-  private Date firstBatchUpdate;\n+  // The last LoadedBatch.created in the filter set\n+  private Date lastBatchCreated;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "310cbe31149ad97b921b81d32c29aa40d9b269bf"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0Mzk5Mzc0OnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzoxNzoyNlrOFpTVMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzoxNzoyNlrOFpTVMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1MjY1Ng==", "bodyText": "transactionTime is set by init and refreshFilters", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378852656", "createdAt": "2020-02-13T13:17:26Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -35,11 +43,14 @@\n   // The filter set\n   private List<LoadedFileFilter> filters;\n \n-  // Max created date from the database's LoadedBatch table\n+  // The latest transaction time from the LoadedBatch files\n   private Date transactionTime;\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "310cbe31149ad97b921b81d32c29aa40d9b269bf"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0Mzk5Nzg4OnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzoxODozOVrOFpTXqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzoxODozOVrOFpTXqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg1MzI5MQ==", "bodyText": "Here's the algorithm change. fetchLastLoadedBatchCreated will have a consistent duration because of the index on LoadedBatches", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378853291", "createdAt": "2020-02-13T13:18:39Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -115,8 +138,8 @@ public void setEntityManager(EntityManager entityManager) {\n \n   /** Called to finish initialization of the manager */\n   @PostConstruct\n-  public void init() {\n-    refreshFilters();\n+  public synchronized void init() {\n+    transactionTime = fetchLastLoadedBatchCreated();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "310cbe31149ad97b921b81d32c29aa40d9b269bf"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NDA3NTExOnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzo0MTozM1rOFpUGfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxMzo0MTozM1rOFpUGfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg2NTI3OA==", "bodyText": "I've moved this else clause out of this function to the caller for code readability reasons. This logic shouldn't handle the case when the table is empty.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378865278", "createdAt": "2020-02-13T13:41:33Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -341,29 +375,30 @@ public static LoadedFileFilter buildFilter(\n   /* DB Operations */\n \n   /**\n-   * Return the max date from the LoadedBatch table\n+   * Return the max date from the LoadedBatch table. If no batches are present, then the schema\n+   * migration time which will be a timestamp before the first loaded batch\n    *\n    * @return the max date\n    */\n-  private Date fetchLastLoadedBatchTime() {\n+  private Optional<Date> fetchLastLoadedBatchCreated() {\n     Date maxCreated =\n         entityManager\n             .createQuery(\"select max(b.created) from LoadedBatch b\", Date.class)\n             .getSingleResult();\n-    return Optional.ofNullable(maxCreated).orElse(new Date());\n+    return Optional.ofNullable(maxCreated);\n   }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c"}, "originalPosition": 195}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NDc0NTYyOnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNjoyNzoyNlrOFpam6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODoyODo0OVrOFpezWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MTg4Mw==", "bodyText": "If I'm not mistaken the parameters have changed but the general logic behind this statement has not correct?  I ask because currently in the test environment this is logging every second and causing logs to fill up quite a bit.\nCould this be changed to a debug level?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378971883", "createdAt": "2020-02-13T16:27:26Z", "author": {"login": "njdister"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -188,25 +214,30 @@ public synchronized void refreshFilters() {\n      */\n     try {\n       // If new batches are present, then build new filters for the affected files\n-      final Date currentLastDatabaseUpdate = fetchLastLoadedBatchTime();\n-      if (this.transactionTime == null || this.transactionTime.before(currentLastDatabaseUpdate)) {\n+      final Date currentLastBatchCreated =\n+          fetchLastLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+      if (this.lastBatchCreated == null || this.lastBatchCreated.before(currentLastBatchCreated)) {\n         LOGGER.info(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4ODI3Mw==", "bodyText": "This code shouldn't put a log entry every second, only when new RIF batch was loaded. It doesn't on my laptop. Can you send me the logs where it is?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378988273", "createdAt": "2020-02-13T16:53:16Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -188,25 +214,30 @@ public synchronized void refreshFilters() {\n      */\n     try {\n       // If new batches are present, then build new filters for the affected files\n-      final Date currentLastDatabaseUpdate = fetchLastLoadedBatchTime();\n-      if (this.transactionTime == null || this.transactionTime.before(currentLastDatabaseUpdate)) {\n+      final Date currentLastBatchCreated =\n+          fetchLastLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+      if (this.lastBatchCreated == null || this.lastBatchCreated.before(currentLastBatchCreated)) {\n         LOGGER.info(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MTg4Mw=="}, "originalCommit": {"oid": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA0MDYwMQ==", "bodyText": "Got your logs. I understand the problem and was able to reproduce it locally. The cause was using now() for the case where there was an empty LoadedBatches table.  I also confirmed that this change fixes the problem.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r379040601", "createdAt": "2020-02-13T18:28:49Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -188,25 +214,30 @@ public synchronized void refreshFilters() {\n      */\n     try {\n       // If new batches are present, then build new filters for the affected files\n-      final Date currentLastDatabaseUpdate = fetchLastLoadedBatchTime();\n-      if (this.transactionTime == null || this.transactionTime.before(currentLastDatabaseUpdate)) {\n+      final Date currentLastBatchCreated =\n+          fetchLastLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+      if (this.lastBatchCreated == null || this.lastBatchCreated.before(currentLastBatchCreated)) {\n         LOGGER.info(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MTg4Mw=="}, "originalCommit": {"oid": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c"}, "originalPosition": 109}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NDc0NzIxOnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNjoyNzo0OFrOFpan4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNjoyNzo0OFrOFpan4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MjEzMA==", "bodyText": "Is this the equivalent of saying if lastBatchCreated is null or lastBatchCreated is before transactionTime?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378972130", "createdAt": "2020-02-13T16:27:48Z", "author": {"login": "whytheplatypus"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -188,25 +214,30 @@ public synchronized void refreshFilters() {\n      */\n     try {\n       // If new batches are present, then build new filters for the affected files\n-      final Date currentLastDatabaseUpdate = fetchLastLoadedBatchTime();\n-      if (this.transactionTime == null || this.transactionTime.before(currentLastDatabaseUpdate)) {\n+      final Date currentLastBatchCreated =\n+          fetchLastLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+      if (this.lastBatchCreated == null || this.lastBatchCreated.before(currentLastBatchCreated)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM0NDc0ODY0OnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNjoyODowOFrOFpaoyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNjoyODowOFrOFpaoyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MjM2Mw==", "bodyText": "Same as above, this is currently logging every second in test.  Can this be changed to debug?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/218#discussion_r378972363", "createdAt": "2020-02-13T16:28:08Z", "author": {"login": "njdister"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/LoadedFilterManager.java", "diffHunk": "@@ -188,25 +214,30 @@ public synchronized void refreshFilters() {\n      */\n     try {\n       // If new batches are present, then build new filters for the affected files\n-      final Date currentLastDatabaseUpdate = fetchLastLoadedBatchTime();\n-      if (this.transactionTime == null || this.transactionTime.before(currentLastDatabaseUpdate)) {\n+      final Date currentLastBatchCreated =\n+          fetchLastLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+      if (this.lastBatchCreated == null || this.lastBatchCreated.before(currentLastBatchCreated)) {\n         LOGGER.info(\n             \"Refreshing LoadedFile filters with new filters from {} to {}\",\n-            transactionTime,\n-            currentLastDatabaseUpdate);\n-        List<LoadedTuple> loadedTuples = fetchLoadedTuples(this.transactionTime);\n+            lastBatchCreated,\n+            currentLastBatchCreated);\n+        List<LoadedTuple> loadedTuples = fetchLoadedTuples(this.lastBatchCreated);\n         this.filters = updateFilters(this.filters, loadedTuples, this::fetchLoadedBatches);\n-        this.transactionTime = currentLastDatabaseUpdate;\n+        this.lastBatchCreated = currentLastBatchCreated;\n \n         // If batches been trimmed, then remove filters which are no longer present\n-        final Date currentFirstBatchUpdate = fetchFirstLoadedBatchTime();\n-        if (this.firstBatchUpdate == null\n-            || this.firstBatchUpdate.before(currentFirstBatchUpdate)) {\n+        final Date currentFirstBatchUpdate =\n+            fetchFirstLoadedBatchCreated().orElse(BEFORE_LAST_UPDATED_FEATURE);\n+        if (this.firstBatchCreated == null\n+            || this.firstBatchCreated.before(currentFirstBatchUpdate)) {\n           LOGGER.info(\"Trimmed LoadedFile filters before {}\", currentFirstBatchUpdate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "915fa815ed3fa1fb9a13aaf89302b14fd4a5186c"}, "originalPosition": 129}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 296, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}