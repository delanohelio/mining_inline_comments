{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNjgyODg2", "number": 246, "title": "BLUEBUTTON 1788: Outpatient Data Fixes and Tests", "bodyText": "Why\nThe last attempt at loading this Outpatient data failed. This PR documents the changes made to fix this bug and more importantly the test added to fully test every record so that we confidence in the data load.\nWhat Changed\n\nThe root cause bug was identified as a missing PTNT_DSCHRG_STUS_CD field in some records. Fortunately, a good default value exists for this field. 0-Unknown Value was used in these cases.\nDiscovered a corner case typo bug in the Outpatient transformer. This was fixed.\nA new test that loads and requests all 174k synthetic outpatient records was added. Previously, only a sample of these records was tested.\nWork was done to optimize the execution speed of the outpatient tests. Without these optimizations, the 174k record test didn't complete in a day. This should have a small benefit to normal testing every developer does.\nFor documentation purposes, added all scripts used.\n\nTesting Done\n\nNew integration test for every record\nManual local loading of data and requesting every record\n\nDeployment Plan\n\nGet PR approved\nDeploy to test and request every record\nPair with JZ and deploy to sandbox and prod. Test every record.\n\nReview Guidance\n\nLook over the fixup python script for the repair to the data\nLook over the test to see if it is complete", "createdAt": "2020-03-18T21:50:12Z", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/246", "merged": true, "mergeCommit": {"oid": "3553d8eb9697b2dab536e5262a24fc58f583a426"}, "closed": true, "closedAt": "2020-03-19T19:11:16Z", "author": {"login": "RickHawesUSDS"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO9AFBgH2gAyMzkwNjgyODg2OjFhYzQ4NzVkYTUwZWE2MzgyNTU2OTM4YzE2NTcwYzRkNzM1NjJiZDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPPVwQgFqTM3NzkzOTgyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ac4875da50ea6382556938c16570c4d73562bd2", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/1ac4875da50ea6382556938c16570c4d73562bd2", "committedDate": "2020-03-18T20:05:19Z", "message": "Fix a small typo bug in the outpatient transformer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9aafd4dc451671e79a802c19d8c0942f0e293900", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/9aafd4dc451671e79a802c19d8c0942f0e293900", "committedDate": "2020-03-18T20:06:00Z", "message": "Added a test for all outpatient synthetic records"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62d54cb750190a3b93baa6ed2fe277bd8874efe9", "author": {"user": null}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/62d54cb750190a3b93baa6ed2fe277bd8874efe9", "committedDate": "2020-03-18T21:32:33Z", "message": "Documentation Updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MjYyMDQy", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/246#pullrequestreview-377262042", "createdAt": "2020-03-18T21:53:20Z", "commit": {"oid": "62d54cb750190a3b93baa6ed2fe277bd8874efe9"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MjYzMjE4", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/246#pullrequestreview-377263218", "createdAt": "2020-03-18T21:55:32Z", "commit": {"oid": "62d54cb750190a3b93baa6ed2fe277bd8874efe9"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMTo1NTozMlrOF4YQlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQyMjowMDoyMVrOF4YY7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2MjAzNg==", "bodyText": "I fixed this because it is a clear typo to me. Only a very small number of EOBs have admission code 3.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/246#discussion_r394662036", "createdAt": "2020-03-18T21:55:32Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/OutpatientClaimTransformer.java", "diffHunk": "@@ -227,7 +227,7 @@ private static ExplanationOfBenefit transformClaim(OutpatientClaim claimGroup) {\n       TransformerUtils.addDiagnosisCode(\n           eob,\n           Diagnosis.from(\n-                  claimGroup.getDiagnosisAdmission2Code(),\n+                  claimGroup.getDiagnosisAdmission3Code(),\n                   claimGroup.getDiagnosisAdmission3CodeVersion(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d54cb750190a3b93baa6ed2fe277bd8874efe9"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2MjkyNw==", "bodyText": "The code to add diagnosis codes to EOB checks for duplicates. There are couple of synthetic records that have duplicate diagnoses, so the count of the claim will not match exactly the count in the EOB.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/246#discussion_r394662927", "createdAt": "2020-03-18T21:57:33Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/test/java/gov/cms/bfd/server/war/stu3/providers/OutpatientClaimTransformerTest.java", "diffHunk": "@@ -135,7 +176,9 @@ static void assertMatches(OutpatientClaim claim, ExplanationOfBenefit eob) throw\n         claim.getPrimaryPayerPaidAmount(),\n         claim.getFiscalIntermediaryNumber());\n \n-    Assert.assertEquals(countDiagnosisCodes(claim), eob.getDiagnosis().size());\n+    Assert.assertTrue(\n+        \"Expect actual diagnosis count is less than or equal to the claim count\",\n+        countDiagnosisCodes(claim) >= eob.getDiagnosis().size());\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d54cb750190a3b93baa6ed2fe277bd8874efe9"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2MzExOQ==", "bodyText": "These codes were missing before.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/246#discussion_r394663119", "createdAt": "2020-03-18T21:57:56Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/test/java/gov/cms/bfd/server/war/stu3/providers/OutpatientClaimTransformerTest.java", "diffHunk": "@@ -275,10 +318,12 @@ static void assertMatches(OutpatientClaim claim, ExplanationOfBenefit eob) throw\n   public static long countDiagnosisCodes(OutpatientClaim claim) {\n     Stream<String> methodNames =\n         Stream.concat(\n-            IntStream.range(1, 26).mapToObj(i -> \"getDiagnosis\" + i + \"Code\"),\n+            Stream.concat(\n+                IntStream.range(1, 26).mapToObj(i -> \"getDiagnosis\" + i + \"Code\"),\n+                IntStream.range(1, 5).mapToObj(i -> \"getDiagnosisAdmission\" + i + \"Code\")),\n             Stream.concat(\n                 IntStream.range(1, 16).mapToObj(i -> \"getDiagnosisExternal\" + i + \"Code\"),\n-                IntStream.range(1, 4).mapToObj(i -> \"getDiagnosisAdmission\" + i + \"Code\")));\n+                Stream.of(\"getDiagnosisPrincipalCode\", \"getDiagnosisExternalFirstCode\")));\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d54cb750190a3b93baa6ed2fe277bd8874efe9"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2MzU4Ng==", "bodyText": "Doing this operation on every record slowed down our tests significantly.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/246#discussion_r394663586", "createdAt": "2020-03-18T21:58:57Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/test/java/gov/cms/bfd/server/war/stu3/providers/TransformerTestUtils.java", "diffHunk": "@@ -912,12 +915,7 @@ static void assertInformationPeriodEquals(\n    * @param resource the FHIR {@link Resource} to check\n    */\n   static void assertNoEncodedOptionals(Resource resource) {\n-    FhirContext fhirContext = FhirContext.forDstu3();\n     String encodedResourceXml = fhirContext.newXmlParser().encodeResourceToString(resource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d54cb750190a3b93baa6ed2fe277bd8874efe9"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2MzkwNg==", "bodyText": "These print outs added to the jibberish of the test logs.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/246#discussion_r394663906", "createdAt": "2020-03-18T21:59:41Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/test/java/gov/cms/bfd/server/war/stu3/providers/TransformerTestUtils.java", "diffHunk": "@@ -912,12 +915,7 @@ static void assertInformationPeriodEquals(\n    * @param resource the FHIR {@link Resource} to check\n    */\n   static void assertNoEncodedOptionals(Resource resource) {\n-    FhirContext fhirContext = FhirContext.forDstu3();\n     String encodedResourceXml = fhirContext.newXmlParser().encodeResourceToString(resource);\n-    String encodedResourceJson = fhirContext.newJsonParser().encodeResourceToString(resource);\n-    System.out.println(encodedResourceXml);\n-    System.out.println(encodedResourceJson);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d54cb750190a3b93baa6ed2fe277bd8874efe9"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY2NDE3NA==", "bodyText": "For documentation purposes, I decided to put these files into a new script directory.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/246#discussion_r394664174", "createdAt": "2020-03-18T22:00:21Z", "author": {"login": "RickHawesUSDS"}, "path": "ops/ccs-ops-misc/synthetic-data/scripts/outpatient/convert_files.sh", "diffHunk": "@@ -0,0 +1,21 @@\n+#!/usr/bin/bash", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62d54cb750190a3b93baa6ed2fe277bd8874efe9"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3OTMyODQx", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/246#pullrequestreview-377932841", "createdAt": "2020-03-19T17:19:08Z", "commit": {"oid": "62d54cb750190a3b93baa6ed2fe277bd8874efe9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3OTM5ODI0", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/246#pullrequestreview-377939824", "createdAt": "2020-03-19T17:27:17Z", "commit": {"oid": "62d54cb750190a3b93baa6ed2fe277bd8874efe9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 715, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}