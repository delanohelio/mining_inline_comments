{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2NDk0NDUz", "number": 390, "title": "BFD-379-Support-BB2-Address-Fields-Filtering-header-includeAddressFields", "bodyText": "Change Details\nAs BB2, I do not want to receive the newly added address-related fields (listed in AC) from BFD in order to prevent this information from being passed through to BB2 consumers, which ultimately ensures beneficiary privacy. These fields should continue to be passed to other BFD peering partners.\n\n\nAcceptance Validation\nA/C:\nBFD uses includeAddressFields header to prevent the following fields (newly mapped from CCW) from being available to BB2:\nAdditions to Patient resource:\nDRVD_LINE_1_ADR\nDRVD_LINE_2_ADR\nDRVD_LINE_3_ADR\nDRVD_LINE_4_ADR\nDRVD_LINE_5_ADR\nDRVD_LINE_6_ADR\nCITY_NAME\nChanged source of mapping:\nPatient.getState() is now get its value from STATE_CD (CME derived) instead of from STATE_CODE (EDB)\nPatient.getPostalCode() is now get its value from STATE_CNTY_ZIP_CD (CME derived) instead of from BENE_ZIP_CD(EDB)\nRemoved from Patient resource:\nPatient.getDistrict() is no longer available (not mapped from CCW)\nSee below quote for rationale for the changes:\n` The BFD is in the process of mapping new data fields to the BFD API. We wanted to let you know of\n\na few changes that pertain to all APIs. Currently, the following variables are sent from CCW\nthrough the FHIR export and available to all APIs in the patient resource. The source for these\nis EDB:\n\n\nSTATE_CODE BENE_CNTY_CD BENE_ZIP_CD\n\n\n\nWe'll be adding the following fields be added to the FHIR export, which come from the CME\n\nDerived Mailing Source:\n\n\nDRVD_LINE_1_ADR DRVD_LINE_2_ADR DRVD_LINE_3_ADR DRVD_LINE_4_ADR DRVD_LINE_5_ADR\n\nDRVD_LINE_6_ADR CITY_NAME STATE_CD STATE_CNTY_ZIP_CD\n\n\nIn order to not create discrepancies in a beneficiary's address by grabbing different\n\ncomponents of a beneficiary's address from data sources, we will map the following variables from\nthe CME Derived Mailing source:\n\n\nSTATE_CD STATE_CNTY_ZIP_CD\n\n\n\nand stop mapping the following fields from EDB:\n\n\n\nSTATE_CODE BENE_CNTY_CD BENE_ZIP_CD\n\n\n*`\nNOTE - includeAddressFields defaults to false\nNOTE - these fields should still be available to other peering partners\nAdditional integration tests to prevent regression\n\n\nFeedback Requested\n\nExternal References\n\n\nBFD-235\n\nDependencies:\n\nPR #308 Cbrune/BFD-235 - update mapping spreadsheet to include fields for the beneficiary and inpatient claims table\n\nSecurity Implications\n\n\n new software dependencies\n\n\n\n altered security controls\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n requires more information or team discussion to evaluate security implications", "createdAt": "2020-11-06T04:56:51Z", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390", "merged": true, "mergeCommit": {"oid": "20caedd65963b799db11e56142081af2279daf75"}, "closed": true, "closedAt": "2021-02-03T01:54:13Z", "author": {"login": "JFU-GIT"}, "timelineItems": {"totalCount": 52, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbnls0ABqjM5ODYyNDEyNjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd2WYumAFqTU4MTk0MTk1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NTM1MTc4", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-529535178", "createdAt": "2020-11-12T22:06:34Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5NDUxMDc5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-569451079", "createdAt": "2021-01-15T17:19:30Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzoxOTozMFrOIUlIyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzoxOTozMFrOIUlIyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ1MDg5MQ==", "bodyText": "maybe just rename rh to requestHeader", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r558450891", "createdAt": "2021-01-15T17:19:30Z", "author": {"login": "cbrunefearless"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/BeneficiaryTransformer.java", "diffHunk": "@@ -65,18 +65,17 @@\n    * @param metricRegistry the {@link MetricRegistry} to use\n    * @param beneficiary the CCW {@link Beneficiary} to transform\n    * @param includeIdentifiersValues the includeIdentifiers header values to use\n+   * @param includeAddressFields the boolean flag includeAddressFields derived from header\n    * @return a FHIR {@link Patient} resource that represents the specified {@link Beneficiary}\n    */\n   @Trace\n   public static Patient transform(\n-      MetricRegistry metricRegistry,\n-      Beneficiary beneficiary,\n-      List<String> includeIdentifiersValues) {\n+      MetricRegistry metricRegistry, Beneficiary beneficiary, RequestHeaders rh) {\n     Timer.Context timer =\n         metricRegistry\n             .timer(MetricRegistry.name(BeneficiaryTransformer.class.getSimpleName(), \"transform\"))\n             .time();\n-    Patient patient = transform(beneficiary, includeIdentifiersValues);\n+    Patient patient = transform(beneficiary, rh);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5NDUxMjI2", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-569451226", "createdAt": "2021-01-15T17:19:42Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzoxOTo0MlrOIUlJRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzoxOTo0MlrOIUlJRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ1MTAxNA==", "bodyText": "maybe just rename rh to requestHeader", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r558451014", "createdAt": "2021-01-15T17:19:42Z", "author": {"login": "cbrunefearless"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/BeneficiaryTransformer.java", "diffHunk": "@@ -85,9 +84,11 @@ public static Patient transform(\n   /**\n    * @param beneficiary the CCW {@link Beneficiary} to transform\n    * @param includeIdentifiersValues the includeIdentifiers header values to use\n+   * @param includeAddressFields the includeAddressFields flag derived from header - used to\n+   *     determine if derived address info be included or not\n    * @return a FHIR {@link Patient} resource that represents the specified {@link Beneficiary}\n    */\n-  private static Patient transform(Beneficiary beneficiary, List<String> includeIdentifiersValues) {\n+  private static Patient transform(Beneficiary beneficiary, RequestHeaders rh) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5NDUxODE5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-569451819", "createdAt": "2021-01-15T17:20:28Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzoyMDoyOFrOIUlLPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzoyMDoyOFrOIUlLPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ1MTUxOA==", "bodyText": "great job!", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r558451518", "createdAt": "2021-01-15T17:20:28Z", "author": {"login": "cbrunefearless"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/BeneficiaryTransformer.java", "diffHunk": "@@ -176,11 +177,27 @@ private static Patient transform(Beneficiary beneficiary, List<String> includeId\n       }\n     }\n \n-    patient\n-        .addAddress()\n-        .setState(beneficiary.getStateCode())\n-        .setDistrict(beneficiary.getCountyCode())\n-        .setPostalCode(beneficiary.getPostalCode());\n+    // support header includeAddressFields from downstream components e.g. BB2\n+    // per requirement of BFD-379, BB2 always send header includeAddressFields = False\n+    Boolean addrHdrVal = rh.getValue(PatientResourceProvider.HEADER_NAME_INCLUDE_ADDRESS_FIELDS);\n+    if (addrHdrVal != null && addrHdrVal) {\n+      patient\n+          .addAddress()\n+          .setState(beneficiary.getStateCode())\n+          .setPostalCode(beneficiary.getPostalCode())\n+          .setCity(beneficiary.getDerivedCityName().orElse(null))\n+          .addLine(beneficiary.getDerivedMailingAddress1().orElse(null))\n+          .addLine(beneficiary.getDerivedMailingAddress2().orElse(null))\n+          .addLine(beneficiary.getDerivedMailingAddress3().orElse(null))\n+          .addLine(beneficiary.getDerivedMailingAddress4().orElse(null))\n+          .addLine(beneficiary.getDerivedMailingAddress5().orElse(null))\n+          .addLine(beneficiary.getDerivedMailingAddress6().orElse(null));\n+    } else {\n+      patient\n+          .addAddress()\n+          .setState(beneficiary.getStateCode())\n+          .setPostalCode(beneficiary.getPostalCode());\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5NDUyMDEy", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-569452012", "createdAt": "2021-01-15T17:20:45Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzoyMDo0NVrOIUlL5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzoyMDo0NVrOIUlL5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ1MTY4Ng==", "bodyText": "maybe just rename rh to requestHeader", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r558451686", "createdAt": "2021-01-15T17:20:45Z", "author": {"login": "cbrunefearless"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -121,21 +121,22 @@ public Patient read(@IdParam IdType patientId, RequestDetails requestDetails) {\n     String beneIdText = patientId.getIdPart();\n     if (beneIdText == null || beneIdText.trim().isEmpty()) throw new IllegalArgumentException();\n \n-    List<String> includeIdentifiersValues = returnIncludeIdentifiersValues(requestDetails);\n+    RequestHeaders rh = RequestHeaders.getHeaderWrapper(requestDetails);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5NDYzNTcw", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-569463570", "createdAt": "2021-01-15T17:36:38Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzozNjozOFrOIUlu5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzozNjozOFrOIUlu5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ2MDY0NA==", "bodyText": "maybe just rename rh to requestHeader", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r558460644", "createdAt": "2021-01-15T17:36:38Z", "author": {"login": "cbrunefearless"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -512,11 +518,11 @@ public Bundle searchByIdentifier(\n     if (!SUPPORTED_HASH_IDENTIFIER_SYSTEMS.contains(identifier.getSystem()))\n       throw new InvalidRequestException(\"Unsupported identifier system: \" + identifier.getSystem());\n \n-    List<String> includeIdentifiersValues = returnIncludeIdentifiersValues(requestDetails);\n+    RequestHeaders rh = RequestHeaders.getHeaderWrapper(requestDetails);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 184}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5NDY0MjY0", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-569464264", "createdAt": "2021-01-15T17:37:34Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzozNzozNFrOIUlw8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzozNzozNFrOIUlw8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ2MTE2OQ==", "bodyText": "delete this commented out code", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r558461169", "createdAt": "2021-01-15T17:37:34Z", "author": {"login": "cbrunefearless"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -553,43 +559,55 @@ public Bundle searchByIdentifier(\n \n   /**\n    * @param hicnHash the {@link Beneficiary#getHicn()} hash value to match\n-   * @param includeIdentifiersValues the {@link #returnIncludeIdentifiersValues(RequestDetails)}\n-   *     value to use\n+   * @param rh the {@link #RequestHeaders} where resource request headers encapsulated\n    * @return a FHIR {@link Patient} for the CCW {@link Beneficiary} that matches the specified\n    *     {@link Beneficiary#getHicn()} hash value\n    * @throws NoResultException A {@link NoResultException} will be thrown if no matching {@link\n    *     Beneficiary} can be found\n    */\n   @Trace\n-  private Patient queryDatabaseByHicnHash(String hicnHash, List<String> includeIdentifiersValues) {\n-    return queryDatabaseByHash(\n-        hicnHash, \"hicn\", includeIdentifiersValues, Beneficiary_.hicn, BeneficiaryHistory_.hicn);\n+  private Patient queryDatabaseByHicnHash(String hicnHash, RequestHeaders rh) {\n+    return queryDatabaseByHash(hicnHash, \"hicn\", Beneficiary_.hicn, BeneficiaryHistory_.hicn, rh);\n   }\n+  // private Patient queryDatabaseByHicnHash(", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 225}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5NDY0NTc4", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-569464578", "createdAt": "2021-01-15T17:38:02Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzozODowMlrOIUlyJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzozODowMlrOIUlyJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ2MTQ3Nw==", "bodyText": "delete comments out code", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r558461477", "createdAt": "2021-01-15T17:38:02Z", "author": {"login": "cbrunefearless"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -553,43 +559,55 @@ public Bundle searchByIdentifier(\n \n   /**\n    * @param hicnHash the {@link Beneficiary#getHicn()} hash value to match\n-   * @param includeIdentifiersValues the {@link #returnIncludeIdentifiersValues(RequestDetails)}\n-   *     value to use\n+   * @param rh the {@link #RequestHeaders} where resource request headers encapsulated\n    * @return a FHIR {@link Patient} for the CCW {@link Beneficiary} that matches the specified\n    *     {@link Beneficiary#getHicn()} hash value\n    * @throws NoResultException A {@link NoResultException} will be thrown if no matching {@link\n    *     Beneficiary} can be found\n    */\n   @Trace\n-  private Patient queryDatabaseByHicnHash(String hicnHash, List<String> includeIdentifiersValues) {\n-    return queryDatabaseByHash(\n-        hicnHash, \"hicn\", includeIdentifiersValues, Beneficiary_.hicn, BeneficiaryHistory_.hicn);\n+  private Patient queryDatabaseByHicnHash(String hicnHash, RequestHeaders rh) {\n+    return queryDatabaseByHash(hicnHash, \"hicn\", Beneficiary_.hicn, BeneficiaryHistory_.hicn, rh);\n   }\n+  // private Patient queryDatabaseByHicnHash(\n+  //     String hicnHash, List<String> includeIdentifiersValues, Boolean includeAddressFields) {\n+  //   return queryDatabaseByHash(\n+  //       hicnHash,\n+  //       \"hicn\",\n+  //       includeIdentifiersValues,\n+  //       Beneficiary_.hicn,\n+  //       BeneficiaryHistory_.hicn,\n+  //       includeAddressFields);\n+  // }\n \n   /**\n    * @param mbiHash the {@link Beneficiary#getMbiHash()} ()} hash value to match\n-   * @param includeIdentifiersValues the {@link #returnIncludeIdentifiersValues(RequestDetails)}\n-   *     value to use\n+   * @param rh the {@link #RequestHeaders} where resource request headers encapsulated\n    * @return a FHIR {@link Patient} for the CCW {@link Beneficiary} that matches the specified\n    *     {@link Beneficiary#getMbiHash()} ()} hash value\n    * @throws NoResultException A {@link NoResultException} will be thrown if no matching {@link\n    *     Beneficiary} can be found\n    */\n   @Trace\n-  private Patient queryDatabaseByMbiHash(String mbiHash, List<String> includeIdentifiersValues) {\n+  private Patient queryDatabaseByMbiHash(String mbiHash, RequestHeaders rh) {\n     return queryDatabaseByHash(\n-        mbiHash,\n-        \"mbi\",\n-        includeIdentifiersValues,\n-        Beneficiary_.mbiHash,\n-        BeneficiaryHistory_.mbiHash);\n+        mbiHash, \"mbi\", Beneficiary_.mbiHash, BeneficiaryHistory_.mbiHash, rh);\n   }\n+  // private Patient queryDatabaseByMbiHash(\n+  //     String mbiHash, List<String> includeIdentifiersValues, Boolean includeAddressFields) {\n+  //   return queryDatabaseByHash(\n+  //       mbiHash,\n+  //       \"mbi\",\n+  //       includeIdentifiersValues,", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 262}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5NDY0ODIw", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-569464820", "createdAt": "2021-01-15T17:38:22Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzozODoyMlrOIUly7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNzozODoyMlrOIUly7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODQ2MTY3Nw==", "bodyText": "rename rh to requestHeader", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r558461677", "createdAt": "2021-01-15T17:38:22Z", "author": {"login": "cbrunefearless"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -601,9 +619,9 @@ private Patient queryDatabaseByMbiHash(String mbiHash, List<String> includeIdent\n   private Patient queryDatabaseByHash(\n       String hash,\n       String hashType,\n-      List<String> includeIdentifiersValues,\n       SingularAttribute<Beneficiary, String> beneficiaryHashField,\n-      SingularAttribute<BeneficiaryHistory, String> beneficiaryHistoryHashField) {\n+      SingularAttribute<BeneficiaryHistory, String> beneficiaryHistoryHashField,\n+      RequestHeaders rh) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 285}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5Nzg0ODQ1", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-569784845", "createdAt": "2021-01-16T00:22:48Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcyNDA5MTI3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-572409127", "createdAt": "2021-01-20T16:30:40Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjozMDo0MFrOIXHMZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjozMDo0MFrOIXHMZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTEwNjAyMw==", "bodyText": "Nice catch, thanks.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r561106023", "createdAt": "2021-01-20T16:30:40Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/r4/providers/R4PatientResourceProvider.java", "diffHunk": "@@ -86,7 +86,7 @@ public void setMetricRegistry(MetricRegistry metricRegistry) {\n     this.metricRegistry = metricRegistry;\n   }\n \n-  /** @param loadedFilterManager the {@link R4LoadedFilterManager} to use */\n+  /** @param loadedFilterManager the {@link LoadedFilterManager} to use */", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcyNDEwNDQ5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-572410449", "createdAt": "2021-01-20T16:32:01Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjozMjowMVrOIXHQSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjozMjowMVrOIXHQSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTEwNzAxOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               *     determine if derived address info be included or not\n          \n          \n            \n               *     determine if derived address info shall be included or not", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r561107018", "createdAt": "2021-01-20T16:32:01Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/BeneficiaryTransformer.java", "diffHunk": "@@ -85,9 +84,11 @@ public static Patient transform(\n   /**\n    * @param beneficiary the CCW {@link Beneficiary} to transform\n    * @param includeIdentifiersValues the includeIdentifiers header values to use\n+   * @param includeAddressFields the includeAddressFields flag derived from header - used to\n+   *     determine if derived address info be included or not", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcyNDE3MDQ2", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-572417046", "createdAt": "2021-01-20T16:39:08Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjozOTowOFrOIXHjOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjozOTowOFrOIXHjOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTExMTg2NQ==", "bodyText": "Yes, they do. Thx.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r561111865", "createdAt": "2021-01-20T16:39:08Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -262,17 +267,18 @@ public Bundle searchByCoverageContract(\n           String cursor,\n       RequestDetails requestDetails) {\n     checkCoverageId(coverageId);\n-    List<String> includeIdentifiersValues = returnIncludeIdentifiersValues(requestDetails);\n+    RequestHeaders requestHeader = RequestHeaders.getHeaderWrapper(requestDetails);\n     PatientLinkBuilder paging = new PatientLinkBuilder(requestDetails.getCompleteUrl());\n     checkPageSize(paging);\n \n     Operation operation = new Operation(Operation.Endpoint.V1_PATIENT);\n     operation.setOption(\"by\", \"coverageContract\");\n-    operation.setOption(\"IncludeIdentifiers\", includeIdentifiersValues.toString());\n+    // need to confirm if all headers of this nature participate in OPTION tracking", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcyNDE4OTgw", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-572418980", "createdAt": "2021-01-20T16:41:18Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjo0MToxOFrOIXHpCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjo0MToxOFrOIXHpCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTExMzM1NQ==", "bodyText": "No.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r561113355", "createdAt": "2021-01-20T16:41:18Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -262,17 +267,18 @@ public Bundle searchByCoverageContract(\n           String cursor,\n       RequestDetails requestDetails) {\n     checkCoverageId(coverageId);\n-    List<String> includeIdentifiersValues = returnIncludeIdentifiersValues(requestDetails);\n+    RequestHeaders requestHeader = RequestHeaders.getHeaderWrapper(requestDetails);\n     PatientLinkBuilder paging = new PatientLinkBuilder(requestDetails.getCompleteUrl());\n     checkPageSize(paging);\n \n     Operation operation = new Operation(Operation.Endpoint.V1_PATIENT);\n     operation.setOption(\"by\", \"coverageContract\");\n-    operation.setOption(\"IncludeIdentifiers\", includeIdentifiersValues.toString());\n+    // need to confirm if all headers of this nature participate in OPTION tracking\n+    requestHeader.getNVPairs().forEach((n, v) -> operation.setOption(n, v.toString()));\n     operation.publishOperationName();\n \n-    List<Beneficiary> matchingBeneficiaries =\n-        fetchBeneficiaries(coverageId, includeIdentifiersValues, paging);\n+    // BFD379: do address fields participate in mathing?", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcyNDIwNTU3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-572420557", "createdAt": "2021-01-20T16:43:04Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjo0MzowNVrOIXHthA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjo0MzowNVrOIXHthA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTExNDUwMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @param requestHeader the {@link #RequestHeaders} where resource request headers encapsulated\n          \n          \n            \n               * @param requestHeader the {@link #RequestHeaders} where resource request headers are encapsulated", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r561114500", "createdAt": "2021-01-20T16:43:05Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -553,43 +563,36 @@ public Bundle searchByIdentifier(\n \n   /**\n    * @param hicnHash the {@link Beneficiary#getHicn()} hash value to match\n-   * @param includeIdentifiersValues the {@link #returnIncludeIdentifiersValues(RequestDetails)}\n-   *     value to use\n+   * @param requestHeader the {@link #RequestHeaders} where resource request headers encapsulated", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 214}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcyNDIxMTA3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-572421107", "createdAt": "2021-01-20T16:43:39Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjo0MzozOVrOIXHvAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjo0MzozOVrOIXHvAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTExNDg4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * @param requestHeader the {@link #RequestHeaders} where resource request headers encapsulated\n          \n          \n            \n               * @param requestHeader the {@link #RequestHeaders} where resource request headers are encapsulated", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r561114880", "createdAt": "2021-01-20T16:43:39Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -553,43 +563,36 @@ public Bundle searchByIdentifier(\n \n   /**\n    * @param hicnHash the {@link Beneficiary#getHicn()} hash value to match\n-   * @param includeIdentifiersValues the {@link #returnIncludeIdentifiersValues(RequestDetails)}\n-   *     value to use\n+   * @param requestHeader the {@link #RequestHeaders} where resource request headers encapsulated\n    * @return a FHIR {@link Patient} for the CCW {@link Beneficiary} that matches the specified\n    *     {@link Beneficiary#getHicn()} hash value\n    * @throws NoResultException A {@link NoResultException} will be thrown if no matching {@link\n    *     Beneficiary} can be found\n    */\n   @Trace\n-  private Patient queryDatabaseByHicnHash(String hicnHash, List<String> includeIdentifiersValues) {\n+  private Patient queryDatabaseByHicnHash(String hicnHash, RequestHeaders requestHeader) {\n     return queryDatabaseByHash(\n-        hicnHash, \"hicn\", includeIdentifiersValues, Beneficiary_.hicn, BeneficiaryHistory_.hicn);\n+        hicnHash, \"hicn\", Beneficiary_.hicn, BeneficiaryHistory_.hicn, requestHeader);\n   }\n \n   /**\n    * @param mbiHash the {@link Beneficiary#getMbiHash()} ()} hash value to match\n-   * @param includeIdentifiersValues the {@link #returnIncludeIdentifiersValues(RequestDetails)}\n-   *     value to use\n+   * @param requestHeader the {@link #RequestHeaders} where resource request headers encapsulated\n    * @return a FHIR {@link Patient} for the CCW {@link Beneficiary} that matches the specified\n    *     {@link Beneficiary#getMbiHash()} ()} hash value\n    * @throws NoResultException A {@link NoResultException} will be thrown if no matching {@link\n    *     Beneficiary} can be found\n    */\n   @Trace\n-  private Patient queryDatabaseByMbiHash(String mbiHash, List<String> includeIdentifiersValues) {\n+  private Patient queryDatabaseByMbiHash(String mbiHash, RequestHeaders requestHeader) {\n     return queryDatabaseByHash(\n-        mbiHash,\n-        \"mbi\",\n-        includeIdentifiersValues,\n-        Beneficiary_.mbiHash,\n-        BeneficiaryHistory_.mbiHash);\n+        mbiHash, \"mbi\", Beneficiary_.mbiHash, BeneficiaryHistory_.mbiHash, requestHeader);\n   }\n \n   /**\n    * @param hash the {@link Beneficiary} hash value to match\n    * @param hashType a string to represent the hash type (used for logging purposes)\n-   * @param includeIdentifiersValues the {@link #returnIncludeIdentifiersValues(RequestDetails)}\n-   *     value to use\n+   * @param requestHeader the {@link #RequestHeaders} where resource request headers encapsulated", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 255}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcyNDI4NzUx", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-572428751", "createdAt": "2021-01-20T16:51:57Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjo1MTo1OFrOIXIF1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjo1MTo1OFrOIXIF1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTEyMDcyNg==", "bodyText": "Please add this change to R4BeneficiaryTransformer.java as well.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r561120726", "createdAt": "2021-01-20T16:51:58Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/BeneficiaryTransformer.java", "diffHunk": "@@ -65,18 +65,17 @@\n    * @param metricRegistry the {@link MetricRegistry} to use\n    * @param beneficiary the CCW {@link Beneficiary} to transform\n    * @param includeIdentifiersValues the includeIdentifiers header values to use\n+   * @param includeAddressFields the boolean flag includeAddressFields derived from header", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcyNDI5MjY5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-572429269", "createdAt": "2021-01-20T16:52:33Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjo1MjozM1rOIXIHag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjo1MjozM1rOIXIHag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTEyMTEzMA==", "bodyText": "Please add this change to R4PatientResourceProvider.java as well.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r561121130", "createdAt": "2021-01-20T16:52:33Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -121,21 +121,22 @@ public Patient read(@IdParam IdType patientId, RequestDetails requestDetails) {\n     String beneIdText = patientId.getIdPart();\n     if (beneIdText == null || beneIdText.trim().isEmpty()) throw new IllegalArgumentException();\n \n-    List<String> includeIdentifiersValues = returnIncludeIdentifiersValues(requestDetails);\n+    RequestHeaders requestHeader = RequestHeaders.getHeaderWrapper(requestDetails);", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcyNDMwMzMw", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-572430330", "createdAt": "2021-01-20T16:53:43Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjo1Mzo0NFrOIXIKLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yMFQxNjo1Mzo0NFrOIXIKLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTEyMTgzOQ==", "bodyText": "Will you consider refactoring this to be included in the ../commons so it can be shared across V1 (stu3) and V2 (R4)?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r561121839", "createdAt": "2021-01-20T16:53:44Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/RequestHeaders.java", "diffHunk": "@@ -0,0 +1,157 @@\n+package gov.cms.bfd.server.war.stu3.providers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 1}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "d5138f788138775e03dc7def8b274f3547168737", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/d5138f788138775e03dc7def8b274f3547168737", "committedDate": "2021-01-20T22:56:41Z", "message": "Update apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java\n\nCo-authored-by: John Zulim <john.zulim@adhocteam.us>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc5NjA1MDg0", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-579605084", "createdAt": "2021-01-29T20:44:30Z", "commit": null, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQyMDo0NDozMFrOIc0COw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yOVQyMDo0NDozMFrOIc0COw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzA4MzU3OQ==", "bodyText": "@JFU-GIT - Looks like a recent merge removed your comments. These should go back. Apologies.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r567083579", "createdAt": "2021-01-29T20:44:30Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/test/java/gov/cms/bfd/server/war/stu3/providers/ExtraParamsInterceptor.java", "diffHunk": "@@ -10,25 +10,16 @@\n /** A HAPI {@link IClientInterceptor} that allows us to add HTTP headers to our requests. */\n public class ExtraParamsInterceptor implements IClientInterceptor {\n   private RequestHeaders requestHeader;\n-  // private IHttpRequest theRequest;", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc5NjM3MDEw", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-579637010", "createdAt": "2021-01-29T21:39:12Z", "commit": null, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "087ca7b322930fe9718f640eadd06a44245cb749", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/087ca7b322930fe9718f640eadd06a44245cb749", "committedDate": "2021-02-02T16:37:40Z", "message": "implement support header includeAddressFields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db94a927211044c520979473116f3c76e26ec15c", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/db94a927211044c520979473116f3c76e26ec15c", "committedDate": "2021-02-02T16:37:40Z", "message": "fix link ref in javadoc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f837574ac2018455aea9ed8e411478fe1ca9c3f", "author": {"user": {"login": "cbrunefearless", "name": "Chris Brune"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/8f837574ac2018455aea9ed8e411478fe1ca9c3f", "committedDate": "2021-02-02T16:37:40Z", "message": "Added responses for json files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b400b40c1c58d5bd9d3a3787be4ca4fe15852d8", "author": {"user": {"login": "cbrunefearless", "name": "Chris Brune"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/1b400b40c1c58d5bd9d3a3787be4ca4fe15852d8", "committedDate": "2021-02-02T16:37:41Z", "message": "Fixed integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f531dfdfc11e669c0b6a20a16c3e5602b52598b6", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/f531dfdfc11e669c0b6a20a16c3e5602b52598b6", "committedDate": "2021-02-02T16:37:41Z", "message": "re-factor tests and fix minor bugs and code packup\n\nfix methods signature: extraParamsInterceptor.setIncludeIdentifiers(...)\n\nre-factor bene transformer, patient resource provider, etc. and integration tests.\n\nfix a typo in exception message, add stack dump to debug on CI.\n\nadd callstack dump for debugging.\n\ndebug trace\n\ndiagnose changes\n\nfix header value parsing.\n\ntest code pack up clean up\n\ntrace CI failure\n\nfix str compare!"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c0a3d6c5fd415d32ed5b7d678cd1236ebc41f71", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/5c0a3d6c5fd415d32ed5b7d678cd1236ebc41f71", "committedDate": "2021-02-02T16:37:41Z", "message": "patch a missed line in ITs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d888bae08af2809281167fb104a749dd125471b", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/8d888bae08af2809281167fb104a749dd125471b", "committedDate": "2021-02-02T16:37:41Z", "message": "changes made per PR review."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acc5032a9dc8facaa77a622e78b9e5a3416ef8f0", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/acc5032a9dc8facaa77a622e78b9e5a3416ef8f0", "committedDate": "2021-02-02T16:37:41Z", "message": "Update apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/BeneficiaryTransformer.java\n\nCo-authored-by: John Zulim <john.zulim@adhocteam.us>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8d0359fe1c68f75d5e7b7e630e253fabd4a6872", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/d8d0359fe1c68f75d5e7b7e630e253fabd4a6872", "committedDate": "2021-02-02T16:37:41Z", "message": "Update apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java\n\nCo-authored-by: John Zulim <john.zulim@adhocteam.us>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df96522f1c783abb909a51e1f3a828484f1e2865", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/df96522f1c783abb909a51e1f3a828484f1e2865", "committedDate": "2021-02-02T16:37:41Z", "message": "changes made per PR review. extract common code, enable address fields filter on V2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa2f49b1f2d1e1f95050b5225d23d89c62f655f4", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/aa2f49b1f2d1e1f95050b5225d23d89c62f655f4", "committedDate": "2021-02-02T16:37:41Z", "message": "code cleanup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "aa2f49b1f2d1e1f95050b5225d23d89c62f655f4", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/aa2f49b1f2d1e1f95050b5225d23d89c62f655f4", "committedDate": "2021-02-02T16:37:41Z", "message": "code cleanup."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxNTk4Njg3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-581598687", "createdAt": "2021-02-02T17:31:55Z", "commit": {"oid": "aa2f49b1f2d1e1f95050b5225d23d89c62f655f4"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74022676645f81db4c1c8d915ff32a8b91d8c524", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/74022676645f81db4c1c8d915ff32a8b91d8c524", "committedDate": "2021-02-02T19:04:15Z", "message": "add and fix javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxNjk3NDI4", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-581697428", "createdAt": "2021-02-02T19:27:50Z", "commit": {"oid": "aa2f49b1f2d1e1f95050b5225d23d89c62f655f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMlQxOToyNzo1MFrOIehMTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMlQxOToyNzo1MFrOIehMTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODg3MjAxNQ==", "bodyText": "@jfuqian Can you detail the reason for failing requests if these request headers arent populated? These should be optional, and the default to false I believe. What was your thinking with this?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r568872015", "createdAt": "2021-02-02T19:27:50Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/commons/RequestHeaders.java", "diffHunk": "@@ -0,0 +1,207 @@\n+package gov.cms.bfd.server.war.commons;\n+\n+import ca.uhn.fhir.rest.api.server.RequestDetails;\n+import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * A per request instance holds all resource (FHIR) request headers, such as: \"includeIdentifiers\"\n+ * {@link PatientResourceProvider#HEADER_NAME_INCLUDE_IDENTIFIERS} \"includeAddressFields\" {@link\n+ * PatientResourceProvider#HEADER_NAME_INCLUDE_ADDRESS_FIELDS} which serve as part of BFD API\n+ */\n+public class RequestHeaders {\n+  RequestDetails requestDetails;\n+  Map<String, Object> headerNVs = new HashMap<String, Object>();\n+\n+  private RequestHeaders(RequestDetails requestDetails) {\n+    this.requestDetails = requestDetails;\n+    // parse headers\n+    CommonHeaders.FHIR_REQUEST_HEADERS.forEach(\n+        (h) -> {\n+          String v = this.requestDetails.getHeader(h);\n+          if (h.equals(CommonHeaders.HEADER_NAME_INCLUDE_ADDRESS_FIELDS)) {\n+            this.headerNVs.put(h, returnIncludeAddressFieldsValue(v));\n+          }\n+          if (h.equals(CommonHeaders.HEADER_NAME_INCLUDE_IDENTIFIERS)) {\n+            this.headerNVs.put(h, returnIncludeIdentifiersValues(v));\n+          }\n+        });\n+  }\n+\n+  /**\n+   * instantiate an empty RH, used by tests\n+   *\n+   * @param requestDetails\n+   */\n+  private RequestHeaders() {}\n+\n+  /**\n+   * currently used by internal code to create a RH instance with ad hoc header/value pairs for\n+   * testing code\n+   *\n+   * @param hdrValues the header/value pairs\n+   */\n+  private RequestHeaders(String... hdrValues) {\n+    // convert h1 v1, h2 v2, ... into nv pairs\n+    if (hdrValues == null || hdrValues.length % 2 != 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa2f49b1f2d1e1f95050b5225d23d89c62f655f4"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxNjk3NzQx", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-581697741", "createdAt": "2021-02-02T19:28:13Z", "commit": {"oid": "aa2f49b1f2d1e1f95050b5225d23d89c62f655f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMlQxOToyODoxM1rOIehNSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wMlQxOToyODoxM1rOIehNSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2ODg3MjI2NA==", "bodyText": "Similar Question, what's the purpose for checking for brackets?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r568872264", "createdAt": "2021-02-02T19:28:13Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/commons/RequestHeaders.java", "diffHunk": "@@ -0,0 +1,207 @@\n+package gov.cms.bfd.server.war.commons;\n+\n+import ca.uhn.fhir.rest.api.server.RequestDetails;\n+import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * A per request instance holds all resource (FHIR) request headers, such as: \"includeIdentifiers\"\n+ * {@link PatientResourceProvider#HEADER_NAME_INCLUDE_IDENTIFIERS} \"includeAddressFields\" {@link\n+ * PatientResourceProvider#HEADER_NAME_INCLUDE_ADDRESS_FIELDS} which serve as part of BFD API\n+ */\n+public class RequestHeaders {\n+  RequestDetails requestDetails;\n+  Map<String, Object> headerNVs = new HashMap<String, Object>();\n+\n+  private RequestHeaders(RequestDetails requestDetails) {\n+    this.requestDetails = requestDetails;\n+    // parse headers\n+    CommonHeaders.FHIR_REQUEST_HEADERS.forEach(\n+        (h) -> {\n+          String v = this.requestDetails.getHeader(h);\n+          if (h.equals(CommonHeaders.HEADER_NAME_INCLUDE_ADDRESS_FIELDS)) {\n+            this.headerNVs.put(h, returnIncludeAddressFieldsValue(v));\n+          }\n+          if (h.equals(CommonHeaders.HEADER_NAME_INCLUDE_IDENTIFIERS)) {\n+            this.headerNVs.put(h, returnIncludeIdentifiersValues(v));\n+          }\n+        });\n+  }\n+\n+  /**\n+   * instantiate an empty RH, used by tests\n+   *\n+   * @param requestDetails\n+   */\n+  private RequestHeaders() {}\n+\n+  /**\n+   * currently used by internal code to create a RH instance with ad hoc header/value pairs for\n+   * testing code\n+   *\n+   * @param hdrValues the header/value pairs\n+   */\n+  private RequestHeaders(String... hdrValues) {\n+    // convert h1 v1, h2 v2, ... into nv pairs\n+    if (hdrValues == null || hdrValues.length % 2 != 0) {\n+      throw new IllegalArgumentException(\n+          \"Header Value string not valid - must be in pairs like h1, v1, h2, v2, ...: \"\n+              + hdrValues);\n+    }\n+    Map<String, String> nvPairs = new HashMap<String, String>();\n+    String curKey = null;\n+    for (String s : hdrValues) {\n+      if (s.startsWith(\"[\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa2f49b1f2d1e1f95050b5225d23d89c62f655f4"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1e8c4475f9766cdebf3d7547844e284c1f69101", "author": {"user": {"login": "JFU-GIT", "name": "James Fuqian"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/f1e8c4475f9766cdebf3d7547844e284c1f69101", "committedDate": "2021-02-02T20:09:38Z", "message": "code clean up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxOTM4MTAz", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-581938103", "createdAt": "2021-02-03T01:44:36Z", "commit": {"oid": "f1e8c4475f9766cdebf3d7547844e284c1f69101"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo0NDozNlrOIesXWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wM1QwMTo0NDozNlrOIesXWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTA1NTA2NA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#discussion_r569055064", "createdAt": "2021-02-03T01:44:36Z", "author": {"login": "jzulim"}, "path": "apps/bfd-server/bfd-server-war/src/test/java/gov/cms/bfd/server/war/stu3/providers/BeneficiaryTransformerTest.java", "diffHunk": "@@ -367,5 +417,70 @@ else if (beneficiary.getSex() == Sex.FEMALE.getCode())\n           CcwCodebookVariable.RFRNC_YR, beneficiary.getBeneEnrollmentReferenceYear(), patient);\n \n     TransformerTestUtils.assertLastUpdatedEquals(beneficiary.getLastUpdated(), patient);\n+\n+    Boolean inclAddrFlds =\n+        (Boolean)\n+            requestHeader.getValue(PatientResourceProvider.HEADER_NAME_INCLUDE_ADDRESS_FIELDS);\n+\n+    if (inclAddrFlds != null && inclAddrFlds) {\n+      Assert.assertEquals(1, patient.getAddress().size());\n+      // assert address fields etc.\n+      Assert.assertEquals(beneficiary.getStateCode(), patient.getAddress().get(0).getState());\n+      // assert CountyCode is no longer mapped\n+      Assert.assertNull(patient.getAddress().get(0).getDistrict());\n+      Assert.assertEquals(beneficiary.getPostalCode(), patient.getAddress().get(0).getPostalCode());\n+      Assert.assertEquals(\n+          beneficiary.getDerivedCityName().orElse(null), patient.getAddress().get(0).getCity());\n+\n+      Assert.assertEquals(\n+          beneficiary.getDerivedMailingAddress1().orElse(\"\"),\n+          patient.getAddress().get(0).getLine().get(0).getValueNotNull());\n+      Assert.assertEquals(\n+          beneficiary.getDerivedMailingAddress2().orElse(\"\"),\n+          patient.getAddress().get(0).getLine().get(1).getValueNotNull());\n+      Assert.assertEquals(\n+          beneficiary.getDerivedMailingAddress3().orElse(\"\"),\n+          patient.getAddress().get(0).getLine().get(2).getValueNotNull());\n+      Assert.assertEquals(\n+          beneficiary.getDerivedMailingAddress4().orElse(\"\"),\n+          patient.getAddress().get(0).getLine().get(3).getValueNotNull());\n+      Assert.assertEquals(\n+          beneficiary.getDerivedMailingAddress5().orElse(\"\"),\n+          patient.getAddress().get(0).getLine().get(4).getValueNotNull());\n+      Assert.assertEquals(\n+          beneficiary.getDerivedMailingAddress6().orElse(\"\"),\n+          patient.getAddress().get(0).getLine().get(5).getValueNotNull());\n+    } else {\n+      Assert.assertEquals(1, patient.getAddress().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1e8c4475f9766cdebf3d7547844e284c1f69101"}, "originalPosition": 254}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxOTQxNTk1", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-581941595", "createdAt": "2021-02-03T01:53:09Z", "commit": {"oid": "f1e8c4475f9766cdebf3d7547844e284c1f69101"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgxOTQxOTUy", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/390#pullrequestreview-581941952", "createdAt": "2021-02-03T01:54:04Z", "commit": {"oid": "f1e8c4475f9766cdebf3d7547844e284c1f69101"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 519, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}