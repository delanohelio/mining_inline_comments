{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMjIyMTM2", "number": 234, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoxODowNlrODlm5_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo1MjoyMFrODlnc2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzYxMzQyOnYy", "diffSide": "RIGHT", "path": "ops/ansible/playbooks-ccs/README.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoxODowNlrOFymRjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoxODowNlrOFymRjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwMDIwNw==", "bodyText": "Just a few close quotes needed for preformatted text.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388600207", "createdAt": "2020-03-05T22:18:06Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/README.md", "diffHunk": "@@ -7,61 +7,49 @@ This folder currently hosts DevOps related code (Ansible, Packer, Terraform, etc\n Project and Directory Structure\n - We are using the suggested directory structure provided by the Ansible community: https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html#directory-layout\n \n-### Jenkins Playbooks \n-##### To Do\n- 1. Research ssh pipelining issue, currently turned off across entire playbook. \n- 2. Install Cloudwatch agent and configure.\n- 3. Configure Splunk Agent \n- 4. Setup SSH Access, currently using bfd-jenkins key. Located in team keybase. \n-   - option 1: https://aws.amazon.com/blogs/compute/new-using-amazon-ec2-instance-connect-for-ssh-access-to-your-ec2-instances/\n- 5. Automate via groovy the setup of docker name and location in global tools settings.\n- 6. Consider moving to Jenkins in Docker. \n+## Jenkins Playbooks \n \n-#### New Jenkins Installation\n+### New Jenkins Installation\n __Name: build_jenkins.yml__<br>\n __Summary:__ This playbook and associated roles configures a CCS Gold Image with specific prerequsities and then apache, jenkins and BFD specific configuration. \n \n-##### High Level Usage Instructions\n+#### High Level Usage Instructions\n  - Requirements: \n    - Local Environment \n      - CCS VPN Connection with proper profile. \n     - AWS CLI authentication setup for the BFD AWS Account with admin privs. \n     - Tools: Packer, Ansible\n    - A Gold Image ID provided by the CCS (GDIT)\n-   - A previously created and formatted EBS volume\n-     - Create EBS Volume within AWS (console or cli)\n-       - Suggested configuration\n-         - Name: Same as used for the variable {{ bfd-jenkins-ebs_name }} value in the playbook. \n-         - Type: General Purpose SSD (gp2)\n-         - Size: >= 1000G \n-         - AZ: us-east-1(a-c)\n-         - Encryption: Yes, use MGMT CMK\n-         - Device: /dev/sdf \n-         - Filesystem: xfs \n-   - Build the Jenkins AMI from within the Ansible/ directory of the ops code (i.e. bfd-ops) by running the following command to build AND configure the Jenkins instance and volume for the first time. \n-     - *packer build -var 'source_ami=ami-12345678' -var 'subnet_id=subnet-0987654321' update_jenkins.json*\n+   - A previously created EFS mount (this is completed with the Terraform `mgmt-stateful` module) \n+   - Subnet ID - changes with mgmt (us-east-1a) or mgmt-test (us-east-1c)\n+   __STOP the current jenkins service on the live instance.__\n+   - Build the Jenkins AMI from within the `ops/ansible/playbooks-ccs` directory of the ops code by running the following command to build AND configure the Jenkins instance and volume for the first time. \n+     - `packer build -var 'source_ami=ami-0f2d8f925de453e46' -var 'subnet_id=subnet-092c2a68bd18b34d1' - var 'env=mgmt' ../../packer/build_jenkins.json`\n    - Note the AMI ID that was created. You'll update the terraform variables at a later stage to deploy this.\n-   \n-##### Post Installation Config \n-Visit Jenkins URL: https://builds.bfd-mgmt.cmscloud.local/jenkins and use credentials located in vault to login and configure the following:\n- - Global Tool Chains Config - Configure Docker\n-     - name: docker\n-     - location: /var/lib \n \n-- Global Security Config - Enable Slave -> Master Access Control\n-\n-#### Update Jenkins Installation \n+### Update Jenkins Installation \n \n __Name: update_jenkins.yml__<br>\n-__Summary:__ This playbook and associated roles configures a CCS Gold Image with specific prerequsities and then apache, jenkins and BFD specific configuration. It essential applies all roles from the build_jenkins.yml playbook except for the configuration aspects which are stored on a persistent EBS volume and attached to this instance. \n+__Summary:__ This playbook and associated roles configures a CCS Gold Image with specific prerequsities and then apache, jenkins and BFD specific configuration. It essential applies all roles from the build_jenkins.yml playbook except for the configuration aspects which are stored on a persistent EFS volume and attached to this instance. \n \n-##### High Level Usage Instructions\n+#### High Level Usage Instructions\n  - Requirements: \n    - Local Environment \n      - CCS VPN Connection with proper profile. \n     - AWS CLI authentication setup for the BFD AWS Account with admin privs. \n     - Tools: Packer, Ansible\n    - A Gold Image ID provided by the CCS (GDIT)\n- - __example command__: from within the ansible directory and replacing the ami and subnet values that meet your deployment needs. \n+   - Subnet ID changes with mgmt (us-east-1a) or mgmt-test (us-east-1c)\n+   __STOP the current jenkins service on the live instance.__\n+ - __example command__: from within the `ops/ansible/playbooks-ccs` directory and replacing the ami and subnet values that meet your deployment needs. \n+\n+- `packer build -var 'source_ami=ami-12345678' -var 'subnet_id=subnet-0987654321' - var 'env=mgmt' update_jenkins.json`\n+\n+### Jenkins Deployment\n+- Update the terraform vars in Keybase (/infrastructure/secrets/terraform-vars) and supply the new AMI form the previous build or update packer job. \n+- Move into the `ops/terraform/env/mgmt, mgmt-test/stateless", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzYyOTM5OnYy", "diffSide": "RIGHT", "path": "ops/ansible/playbooks-ccs/roles/conf_jenkins/templates/configLockableResources.groovy.j2", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoyNDoxNlrOFyma_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoyNDoxNlrOFyma_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwMjYyMg==", "bodyText": "I know this already existed as debt prior to your work, but it might be good to remove the unused environment (which I believe is env_prod_stg) to reduce confusion when having to use the lockable resources.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388602622", "createdAt": "2020-03-05T22:24:16Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/roles/conf_jenkins/templates/configLockableResources.groovy.j2", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+   Copyright 2015-2019 Sam Gleske - https://github.com/samrocketman/jenkins-bootstrap-shared\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+       http://www.apache.org/licenses/LICENSE-2.0\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+   */\n+/*\n+  Configures global lockable resources.\n+   lockable-resources 2.2\n+ */\n+ \n+import jenkins.model.Jenkins\n+import org.jenkins.plugins.lockableresources.LockableResource\n+import org.jenkins.plugins.lockableresources.LockableResourcesManager\n+\n+if(!binding.hasVariable('lockable_resources')) {\n+    lockable_resources = [\u2018name' : \u2018env_test\u2019, \u2018name\u2019 : 'env_prod_stg' \u2018name : 'env_prod', \u2018name\u2019 : 'env_prod_sbx' ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzY0MjU4OnYy", "diffSide": "RIGHT", "path": "ops/ansible/playbooks-ccs/roles/install_jenkins/tasks/plugins.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoyOToxOVrOFymieA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjoyOToxOVrOFymieA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNDUzNg==", "bodyText": "This is really nifty!", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388604536", "createdAt": "2020-03-05T22:29:19Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/roles/install_jenkins/tasks/plugins.yml", "diffHunk": "@@ -53,40 +53,44 @@\n   until: >\n      'status' in jenkins_service_status and\n      jenkins_service_status['status'] == 200\n-     \n-- name: Install Plugins\n-  jenkins_plugin:\n-    name: \"{{ item }}\"\n-    state: present\n-    jenkins_home: \"{{ jenkins_home }}\"\n+\n+- name: Configure Security Recommendations\n+  jenkins_script:\n     url: \"{{ jenkins_url_local }}\"\n+    user: \"{{ jenkins_dynamic_admin_username | default(omit) }}\"\n+    password: \"{{ jenkins_dynamic_admin_password | default(omit) }}\"\n+    script: \"{{ lookup('template', 'templates/configSecrec.groovy.j2') }}\"\n+  register: shell_jenkins_security_recommendations\n+  changed_when: \"(shell_jenkins_security_recommendations is success) and 'Changed' in shell_jenkins_security_recommendations.output\"\n+\n+- name: Get Jenkins Crumb\n+  uri:\n+    force_basic_auth: yes\n     url_username: \"{{ jenkins_dynamic_admin_username | default(omit) }}\"\n     url_password: \"{{ jenkins_dynamic_admin_password | default(omit) }}\"\n-    validate_certs: true\n-    timeout: \"{{ jenkins_plugins_timeout }}\"\n-  with_items:\n-    - \"{{ jenkins_plugins_recommended }}\"\n-    - \"{{ jenkins_plugins_extra }}\"\n-  become: true\n-  retries: \"{{ jenkins_plugins_retries }}\"\n-  notify:\n-    - \"Restart Service 'jenkins'\"\n+    url: \"{{ jenkins_url_local }}/crumbIssuer/api/json\"\n+    return_content: yes\n+  register: jenkins_crumb\n+  until: jenkins_crumb.content.find('Please wait while Jenkins is getting ready') == -1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzY0NTc2OnYy", "diffSide": "RIGHT", "path": "ops/ansible/playbooks-ccs/roles/install_jenkins/tasks/tools.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjozMDozN1rOFymkUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMzozNjozOVrOFyn8mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNTAxMQ==", "bodyText": "I think this version number could be hoisted up to a var somewhere higher in the chain for easier maintainabililty.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388605011", "createdAt": "2020-03-05T22:30:37Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/roles/install_jenkins/tasks/tools.yml", "diffHunk": "@@ -3,30 +3,61 @@\n # Installs additional build and deploy tools\n ###\n \n-- name: Install tfenv to manage terrfaorm\n+- name: Install tfenv to manage terraform\n   git:\n     repo: https://github.com/tfutils/tfenv.git \n-    dest: ~/.tfenv\n+    dest: /usr/bin/.tfenv\n \n - name: Create symlinks for tfenv\n   file:\n-    src: ~/.tfenv/bin/tfenv\n+    src: /usr/bin/.tfenv/bin/tfenv\n     dest: /usr/bin/tfenv\n     mode: '0755'\n     state: link\n     \n - name: Link tfenv tf wrapper. \n   file:\n-    src: ~/.tfenv/bin/terraform\n+    src: /usr/bin/.tfenv/bin/terraform\n     dest: /usr/bin/terraform\n     mode: '0755'\n     state: link\n \n - name: Install terraform \n-  shell: tfenv install 0.12.5\n+  shell: tfenv install 0.12.8", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYyNzYxMQ==", "bodyText": "Agreed", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388627611", "createdAt": "2020-03-05T23:36:39Z", "author": {"login": "jzulim"}, "path": "ops/ansible/playbooks-ccs/roles/install_jenkins/tasks/tools.yml", "diffHunk": "@@ -3,30 +3,61 @@\n # Installs additional build and deploy tools\n ###\n \n-- name: Install tfenv to manage terrfaorm\n+- name: Install tfenv to manage terraform\n   git:\n     repo: https://github.com/tfutils/tfenv.git \n-    dest: ~/.tfenv\n+    dest: /usr/bin/.tfenv\n \n - name: Create symlinks for tfenv\n   file:\n-    src: ~/.tfenv/bin/tfenv\n+    src: /usr/bin/.tfenv/bin/tfenv\n     dest: /usr/bin/tfenv\n     mode: '0755'\n     state: link\n     \n - name: Link tfenv tf wrapper. \n   file:\n-    src: ~/.tfenv/bin/terraform\n+    src: /usr/bin/.tfenv/bin/terraform\n     dest: /usr/bin/terraform\n     mode: '0755'\n     state: link\n \n - name: Install terraform \n-  shell: tfenv install 0.12.5\n+  shell: tfenv install 0.12.8", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNTAxMQ=="}, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzY1Mzg0OnYy", "diffSide": "RIGHT", "path": "ops/ansible/playbooks-ccs/roles/install_jenkins/tasks/tools.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjozMzo0MFrOFymo5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMzozODozN1rOFyn-zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNjE4Mg==", "bodyText": "Could combine these two into a single yum statement, although a bit micro-optimizey \ud83e\udd37\u200d\u2642", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388606182", "createdAt": "2020-03-05T22:33:40Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/roles/install_jenkins/tasks/tools.yml", "diffHunk": "@@ -3,30 +3,61 @@\n # Installs additional build and deploy tools\n ###\n \n-- name: Install tfenv to manage terrfaorm\n+- name: Install tfenv to manage terraform\n   git:\n     repo: https://github.com/tfutils/tfenv.git \n-    dest: ~/.tfenv\n+    dest: /usr/bin/.tfenv\n \n - name: Create symlinks for tfenv\n   file:\n-    src: ~/.tfenv/bin/tfenv\n+    src: /usr/bin/.tfenv/bin/tfenv\n     dest: /usr/bin/tfenv\n     mode: '0755'\n     state: link\n     \n - name: Link tfenv tf wrapper. \n   file:\n-    src: ~/.tfenv/bin/terraform\n+    src: /usr/bin/.tfenv/bin/terraform\n     dest: /usr/bin/terraform\n     mode: '0755'\n     state: link\n \n - name: Install terraform \n-  shell: tfenv install 0.12.5\n+  shell: tfenv install 0.12.8\n   \n - name: Install packer\n   unarchive:\n     src: https://releases.hashicorp.com/packer/1.4.3/packer_1.4.3_linux_amd64.zip\n     dest: /usr/bin\n     remote_src: yes\n+\n+- name: Install - AWS CLI\n+  pip:\n+    name: \"awscli\"\n+\n+- name: Create .aws directory in the home directory\n+  file:\n+    path: \"{{ jenkins_home }}/.aws/\"\n+    state: directory\n+    owner: \"jenkins\"\n+    group: \"jenkins\"\n+    mode: 0755\n+\n+- name: Copy the aws config file to the box\n+  become: yes\n+  template:\n+    src: ../templates/aws_config.j2\n+    dest: \"{{ jenkins_home }}/.aws/config\"\n+    owner: \"jenkins\"\n+    group: \"jenkins\"\n+    mode: 0600\n+\n+- name: Install - jq\n+  yum:\n+    name: \n+      - jq\n+\n+- name: Install nfs-utils\n+  yum:\n+    name:\n+      - nfs-utils", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYyODE3NQ==", "bodyText": "I like this, but mostly for 'related' packages.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388628175", "createdAt": "2020-03-05T23:38:37Z", "author": {"login": "jzulim"}, "path": "ops/ansible/playbooks-ccs/roles/install_jenkins/tasks/tools.yml", "diffHunk": "@@ -3,30 +3,61 @@\n # Installs additional build and deploy tools\n ###\n \n-- name: Install tfenv to manage terrfaorm\n+- name: Install tfenv to manage terraform\n   git:\n     repo: https://github.com/tfutils/tfenv.git \n-    dest: ~/.tfenv\n+    dest: /usr/bin/.tfenv\n \n - name: Create symlinks for tfenv\n   file:\n-    src: ~/.tfenv/bin/tfenv\n+    src: /usr/bin/.tfenv/bin/tfenv\n     dest: /usr/bin/tfenv\n     mode: '0755'\n     state: link\n     \n - name: Link tfenv tf wrapper. \n   file:\n-    src: ~/.tfenv/bin/terraform\n+    src: /usr/bin/.tfenv/bin/terraform\n     dest: /usr/bin/terraform\n     mode: '0755'\n     state: link\n \n - name: Install terraform \n-  shell: tfenv install 0.12.5\n+  shell: tfenv install 0.12.8\n   \n - name: Install packer\n   unarchive:\n     src: https://releases.hashicorp.com/packer/1.4.3/packer_1.4.3_linux_amd64.zip\n     dest: /usr/bin\n     remote_src: yes\n+\n+- name: Install - AWS CLI\n+  pip:\n+    name: \"awscli\"\n+\n+- name: Create .aws directory in the home directory\n+  file:\n+    path: \"{{ jenkins_home }}/.aws/\"\n+    state: directory\n+    owner: \"jenkins\"\n+    group: \"jenkins\"\n+    mode: 0755\n+\n+- name: Copy the aws config file to the box\n+  become: yes\n+  template:\n+    src: ../templates/aws_config.j2\n+    dest: \"{{ jenkins_home }}/.aws/config\"\n+    owner: \"jenkins\"\n+    group: \"jenkins\"\n+    mode: 0600\n+\n+- name: Install - jq\n+  yum:\n+    name: \n+      - jq\n+\n+- name: Install nfs-utils\n+  yum:\n+    name:\n+      - nfs-utils", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNjE4Mg=="}, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzY2MTM2OnYy", "diffSide": "RIGHT", "path": "ops/ansible/playbooks-ccs/roles/mount_efs/tasks/main.yml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjozNjozM1rOFymtRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNDoxNzoyMVrOFy6MTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNzMwMg==", "bodyText": "For consistency I would move the task definition into separate lines, new ansible style ftw!", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388607302", "createdAt": "2020-03-05T22:36:33Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/roles/mount_efs/tasks/main.yml", "diffHunk": "@@ -0,0 +1,27 @@\n+---\n+##\n+# Mounts Jenkins Data EBS Volume\n+##\n+- name: Ensure NFS is installed.\n+  package: \"name={{ nfs_package }} state=installed\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYzNjk5MA==", "bodyText": "I'm sorry, I'm not following. Can you show what you mean?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388636990", "createdAt": "2020-03-06T00:08:38Z", "author": {"login": "jzulim"}, "path": "ops/ansible/playbooks-ccs/roles/mount_efs/tasks/main.yml", "diffHunk": "@@ -0,0 +1,27 @@\n+---\n+##\n+# Mounts Jenkins Data EBS Volume\n+##\n+- name: Ensure NFS is installed.\n+  package: \"name={{ nfs_package }} state=installed\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNzMwMg=="}, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkyNjU0Mw==", "bodyText": "package:\n  name: {{ nfs_package }}\n  state: installed", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388926543", "createdAt": "2020-03-06T14:17:21Z", "author": {"login": "njdister"}, "path": "ops/ansible/playbooks-ccs/roles/mount_efs/tasks/main.yml", "diffHunk": "@@ -0,0 +1,27 @@\n+---\n+##\n+# Mounts Jenkins Data EBS Volume\n+##\n+- name: Ensure NFS is installed.\n+  package: \"name={{ nfs_package }} state=installed\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwNzMwMg=="}, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzY3NTU2OnYy", "diffSide": "RIGHT", "path": "ops/terraform/modules/mgmt_stateful/main.tf", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo0MjowNFrOFym1rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxOToyMToxMlrOFzEbtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwOTQ1Mg==", "bodyText": "Can you clarify how this works for both mgmt and mgmt-test?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388609452", "createdAt": "2020-03-05T22:42:04Z", "author": {"login": "njdister"}, "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -26,6 +26,16 @@ data \"aws_subnet_ids\" \"app_subnets\" {\n   }\n }\n \n+# Subnet for EFS \n+\n+data \"aws_subnet_ids\" \"efs\" {\n+  vpc_id = data.aws_vpc.main.id\n+\n+  tags = {\n+    Name = \"bfd-mgmt-az3-app\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYzMTM3MA==", "bodyText": "It doesnt, nice catch. I must have hand jammed this when switching 'environments' from mgmt to mgmt-test. Do you have a recommendation how I might handle this, outside of adding a new variable", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388631370", "createdAt": "2020-03-05T23:50:04Z", "author": {"login": "jzulim"}, "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -26,6 +26,16 @@ data \"aws_subnet_ids\" \"app_subnets\" {\n   }\n }\n \n+# Subnet for EFS \n+\n+data \"aws_subnet_ids\" \"efs\" {\n+  vpc_id = data.aws_vpc.main.id\n+\n+  tags = {\n+    Name = \"bfd-mgmt-az3-app\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwOTQ1Mg=="}, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY0Mjg3NQ==", "bodyText": "I think I have a way. Hold please. :)", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388642875", "createdAt": "2020-03-06T00:27:39Z", "author": {"login": "jzulim"}, "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -26,6 +26,16 @@ data \"aws_subnet_ids\" \"app_subnets\" {\n   }\n }\n \n+# Subnet for EFS \n+\n+data \"aws_subnet_ids\" \"efs\" {\n+  vpc_id = data.aws_vpc.main.id\n+\n+  tags = {\n+    Name = \"bfd-mgmt-az3-app\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwOTQ1Mg=="}, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA5NDMyNQ==", "bodyText": "Turns out I dont think this is needed. In the EFS module I grab the vpc and subnet data via:\n  vpc_id            = data.aws_vpc.main.id\n  availability_zone = var.env_config.azs\n  filter {\n    name    = \"tag:Layer\"\n    values  = [var.layer] \n  }\n}```", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r389094325", "createdAt": "2020-03-06T19:21:12Z", "author": {"login": "jzulim"}, "path": "ops/terraform/modules/mgmt_stateful/main.tf", "diffHunk": "@@ -26,6 +26,16 @@ data \"aws_subnet_ids\" \"app_subnets\" {\n   }\n }\n \n+# Subnet for EFS \n+\n+data \"aws_subnet_ids\" \"efs\" {\n+  vpc_id = data.aws_vpc.main.id\n+\n+  tags = {\n+    Name = \"bfd-mgmt-az3-app\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYwOTQ1Mg=="}, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzcwMTg4OnYy", "diffSide": "RIGHT", "path": "ops/terraform/modules/resources/efs/main.tf", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo1MjowNlrOFynE-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMzo1NzowMFrOFyoTkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxMzM2OA==", "bodyText": "Can you get this from a data source or is that not easily possible?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388613368", "createdAt": "2020-03-05T22:52:06Z", "author": {"login": "njdister"}, "path": "ops/terraform/modules/resources/efs/main.tf", "diffHunk": "@@ -0,0 +1,66 @@\n+# EFS\n+# \n+# Create a EFS Resource, Mount Target and Security Group  \n+#\n+\n+locals {\n+  tags        = merge({Layer=var.layer, role=var.role}, var.env_config.tags) \n+}\n+\n+data \"aws_vpc\" \"main\" {\n+  filter {\n+    name = \"tag:Name\"\n+    values = [\"bfd-mgmt-vpc\"]\n+  }\n+}\n+\n+data \"aws_subnet\" \"main\" {\n+  vpc_id            = data.aws_vpc.main.id\n+  availability_zone = var.env_config.azs\n+  filter {\n+    name    = \"tag:Layer\"\n+    values  = [var.layer] \n+  }\n+}\n+\n+\n+resource \"aws_efs_file_system\" \"efs\" {\n+   creation_token = \"bfd-${var.env_config.env}-${var.role}-efs\"\n+   performance_mode = \"generalPurpose\"\n+   throughput_mode = \"bursting\"\n+   encrypted = \"true\"\n+ \n+  tags = {\n+    Name = \"bfd-${var.env_config.env}-${var.role}-efs\"\n+  }\n+}\n+\n+resource \"aws_security_group\" \"efs-sg\" {\n+  name        = \"bfd-${var.env_config.env}-${var.role}-efs-sg\"\n+  description = \"EFS Security Group\"\n+  vpc_id      = data.aws_vpc.main.id\n+\n+  // NFS\n+  ingress {\n+    description     = \"Inbound access for EFS\"\n+    from_port = 2049\n+    to_port = 2049\n+    protocol = \"tcp\"\n+    cidr_blocks = [\"10.252.40.0/21\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYzMzQ5MQ==", "bodyText": "cidr_blocks = [\"${data.aws_vpc.main.cidr_block}\"]\nMaybe something like that.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388633491", "createdAt": "2020-03-05T23:57:00Z", "author": {"login": "jzulim"}, "path": "ops/terraform/modules/resources/efs/main.tf", "diffHunk": "@@ -0,0 +1,66 @@\n+# EFS\n+# \n+# Create a EFS Resource, Mount Target and Security Group  \n+#\n+\n+locals {\n+  tags        = merge({Layer=var.layer, role=var.role}, var.env_config.tags) \n+}\n+\n+data \"aws_vpc\" \"main\" {\n+  filter {\n+    name = \"tag:Name\"\n+    values = [\"bfd-mgmt-vpc\"]\n+  }\n+}\n+\n+data \"aws_subnet\" \"main\" {\n+  vpc_id            = data.aws_vpc.main.id\n+  availability_zone = var.env_config.azs\n+  filter {\n+    name    = \"tag:Layer\"\n+    values  = [var.layer] \n+  }\n+}\n+\n+\n+resource \"aws_efs_file_system\" \"efs\" {\n+   creation_token = \"bfd-${var.env_config.env}-${var.role}-efs\"\n+   performance_mode = \"generalPurpose\"\n+   throughput_mode = \"bursting\"\n+   encrypted = \"true\"\n+ \n+  tags = {\n+    Name = \"bfd-${var.env_config.env}-${var.role}-efs\"\n+  }\n+}\n+\n+resource \"aws_security_group\" \"efs-sg\" {\n+  name        = \"bfd-${var.env_config.env}-${var.role}-efs-sg\"\n+  description = \"EFS Security Group\"\n+  vpc_id      = data.aws_vpc.main.id\n+\n+  // NFS\n+  ingress {\n+    description     = \"Inbound access for EFS\"\n+    from_port = 2049\n+    to_port = 2049\n+    protocol = \"tcp\"\n+    cidr_blocks = [\"10.252.40.0/21\"]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxMzM2OA=="}, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwNzcwMjY1OnYy", "diffSide": "RIGHT", "path": "ops/terraform/modules/resources/efs/main.tf", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo1MjoyMFrOFynFZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQyMjo1MjoyMFrOFynFZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODYxMzQ3OQ==", "bodyText": "Can you get this from a data source or is that not easily possible?", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/234#discussion_r388613479", "createdAt": "2020-03-05T22:52:20Z", "author": {"login": "njdister"}, "path": "ops/terraform/modules/resources/efs/main.tf", "diffHunk": "@@ -0,0 +1,66 @@\n+# EFS\n+# \n+# Create a EFS Resource, Mount Target and Security Group  \n+#\n+\n+locals {\n+  tags        = merge({Layer=var.layer, role=var.role}, var.env_config.tags) \n+}\n+\n+data \"aws_vpc\" \"main\" {\n+  filter {\n+    name = \"tag:Name\"\n+    values = [\"bfd-mgmt-vpc\"]\n+  }\n+}\n+\n+data \"aws_subnet\" \"main\" {\n+  vpc_id            = data.aws_vpc.main.id\n+  availability_zone = var.env_config.azs\n+  filter {\n+    name    = \"tag:Layer\"\n+    values  = [var.layer] \n+  }\n+}\n+\n+\n+resource \"aws_efs_file_system\" \"efs\" {\n+   creation_token = \"bfd-${var.env_config.env}-${var.role}-efs\"\n+   performance_mode = \"generalPurpose\"\n+   throughput_mode = \"bursting\"\n+   encrypted = \"true\"\n+ \n+  tags = {\n+    Name = \"bfd-${var.env_config.env}-${var.role}-efs\"\n+  }\n+}\n+\n+resource \"aws_security_group\" \"efs-sg\" {\n+  name        = \"bfd-${var.env_config.env}-${var.role}-efs-sg\"\n+  description = \"EFS Security Group\"\n+  vpc_id      = data.aws_vpc.main.id\n+\n+  // NFS\n+  ingress {\n+    description     = \"Inbound access for EFS\"\n+    from_port = 2049\n+    to_port = 2049\n+    protocol = \"tcp\"\n+    cidr_blocks = [\"10.252.40.0/21\"]\n+  }\n+\n+  // Terraform removes the default rule\n+  egress {\n+    description     = \"Outbound Access for EFS\"\n+    from_port = 0\n+    to_port = 0\n+    protocol = \"-1\"\n+    cidr_blocks = [\"10.252.40.0/21\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36d08302512da6b53dfffdc593ca946749bd5426"}, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 327, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}