{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5MzY4MDkx", "number": 249, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDoxNzo1NVrODvJlAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDozNTowN1rODvKGoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzY2NTk0OnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/QueryLoggingListener.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDoxNzo1NVrOGBZ9sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDoxNzo1NVrOGBZ9sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEyNzE1Mg==", "bodyText": "New type of DB query for our logs.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/249#discussion_r404127152", "createdAt": "2020-04-06T14:17:55Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/QueryLoggingListener.java", "diffHunk": "@@ -149,6 +149,12 @@ public void beforeQuery(ExecutionInfo execInfo, List<QueryInfo> queryInfoList) {\n                 && s.contains(\" join \")\n                 && s.contains(\"\\\"hicn\\\"=\"))),\n \n+    BENE_BY_COVERAGE(\n+        \"bene_by_coverage\",\n+        (s ->\n+            s.contains(\"from \\\"Beneficiaries\\\"\")\n+                && s.contains(\"where beneficiar0_.\\\"partDContractNumber\"))),\n+\n     EOBS_BY_BENE_ID_CARRIER(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d08b186b8fe1c2d58574cc1b2bea602345e531f"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzY2ODM3OnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/CoverageResourceProvider.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDoxODoyNVrOGBZ_Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDoxODoyNVrOGBZ_Tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEyNzU2Nw==", "bodyText": "Renamed PageLinkBuilder but otherwise, it works the same as before.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/249#discussion_r404127567", "createdAt": "2020-04-06T14:18:25Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/CoverageResourceProvider.java", "diffHunk": "@@ -165,7 +165,7 @@ public Bundle searchByBeneficiary(\n       coverages = new LinkedList<IBaseResource>();\n     }\n \n-    PageLinkBuilder paging = new PageLinkBuilder(requestDetails, \"/Coverage?\");\n+    OffsetLinkBuilder paging = new OffsetLinkBuilder(requestDetails, \"/Coverage?\");\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d08b186b8fe1c2d58574cc1b2bea602345e531f"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzcxODYyOnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientLinkBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDoyODozOFrOGBae9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDoyODozOFrOGBae9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEzNTY3MQ==", "bodyText": "I'm initializing with a string vs RequestDetail because it makes it easier to test the class.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/249#discussion_r404135671", "createdAt": "2020-04-06T14:28:38Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientLinkBuilder.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package gov.cms.bfd.server.war.stu3.providers;\n+\n+import ca.uhn.fhir.rest.api.Constants;\n+import ca.uhn.fhir.rest.server.exceptions.InvalidRequestException;\n+import java.util.List;\n+import org.hl7.fhir.dstu3.model.Bundle;\n+import org.hl7.fhir.dstu3.model.Bundle.BundleEntryComponent;\n+import org.hl7.fhir.dstu3.model.Patient;\n+import org.springframework.util.LinkedMultiValueMap;\n+import org.springframework.util.MultiValueMap;\n+import org.springframework.web.util.UriComponents;\n+import org.springframework.web.util.UriComponentsBuilder;\n+\n+/** A link builder for Patient resources using bene-id cursors */\n+public final class PatientLinkBuilder implements LinkBuilder {\n+  private final UriComponents components;\n+  private final Integer count;\n+  private final String cursor;\n+\n+  public static final String PARAM_CURSOR = \"cursor\";\n+\n+  public PatientLinkBuilder(String requestString) {\n+    components = UriComponentsBuilder.fromUriString(requestString).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d08b186b8fe1c2d58574cc1b2bea602345e531f"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzcyNTIzOnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDozMDowMlrOGBajLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDozMDowMlrOGBajLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEzNjc1MA==", "bodyText": "This has been rearranged for clarity.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/249#discussion_r404136750", "createdAt": "2020-04-06T14:30:02Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -240,39 +239,17 @@ public Bundle searchByCoverageContract(\n       @RequiredParam(name = \"_has:Coverage.extension\")\n           @Description(shortDefinition = \"Part D coverage type\")\n           TokenParam coverageId,\n-      @OptionalParam(name = \"startIndex\")\n-          @Description(shortDefinition = \"The offset used for result pagination\")\n-          String startIndex,\n+      @OptionalParam(name = \"cursor\")\n+          @Description(shortDefinition = \"The cursor used for result pagination\")\n+          String cursor,\n       RequestDetails requestDetails) {\n-\n-    if (coverageId.getQueryParameterQualifier() != null)\n-      throw new InvalidRequestException(\n-          \"Unsupported query parameter qualifier: \" + coverageId.getQueryParameterQualifier());\n-\n-    String contractCode = coverageId.getValueNotNull();\n-    if (contractCode.length() != 5)\n-      throw new InvalidRequestException(\"Unsupported query parameter value: \" + contractCode);\n-\n-    String contractMonth =\n-        coverageId.getSystem().substring(coverageId.getSystem().lastIndexOf('/') + 1);\n-    CcwCodebookVariable partDContractMonth = partDCwVariableFor(contractMonth);\n-    SingularAttribute<Beneficiary, String> contractMonthField = partDFieldFor(partDContractMonth);\n-\n+    checkCoverageId(coverageId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d08b186b8fe1c2d58574cc1b2bea602345e531f"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzc0MDUxOnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDozMjo0OVrOGBasTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDo1NTozMFrOGBbx0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEzOTA4Nw==", "bodyText": "For readability, I'm trying make this code follow SQL somewhat. b is used as a table alias would be used in a SQL statement.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/249#discussion_r404139087", "createdAt": "2020-04-06T14:32:49Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -337,51 +314,65 @@ private CcwCodebookVariable partDCwVariableFor(String system) {\n         \"Unsupported extension system: \" + cntrctMonth.getVariable().getId().toLowerCase());\n   }\n \n-  private Long fetchResultCount(CriteriaQuery criteria) {\n-    Predicate restriction = criteria.getRestriction();\n-    CriteriaBuilder builder = entityManager.getCriteriaBuilder();\n-    CriteriaQuery<Long> countQuery = builder.createQuery(Long.class);\n-    countQuery.where(restriction);\n-    return entityManager\n-        .createQuery(countQuery.select(builder.count(countQuery.from(Beneficiary.class))))\n-        .getSingleResult();\n-  }\n-\n-  private List<Beneficiary> fetchBeneficiaries(CriteriaQuery criteria, PageLinkBuilder pagingArgs) {\n-    Query query = entityManager.createQuery(criteria);\n-\n-    if (pagingArgs.isPagingRequested()) {\n-      query.setFirstResult(pagingArgs.getStartIndex());\n-      query.setMaxResults(pagingArgs.getPageSize());\n-    }\n+  /**\n+   * Fetch beneficiaries for the PartD coverage parameter\n+   *\n+   * @param coverageId coverage type\n+   * @param includedIdentifiers list from the includeIdentifier header\n+   * @param paging specified\n+   * @return the beneficiaries\n+   */\n+  private List<Beneficiary> fetchBeneficiaries(\n+      TokenParam coverageId, List<String> includedIdentifiers, PatientLinkBuilder paging) {\n+    List<SetAttribute<Beneficiary, ?>> withRelations = new LinkedList<>();\n+    if (hasHICN(includedIdentifiers)) withRelations.add(Beneficiary_.beneficiaryHistories);\n+    if (hasMBI(includedIdentifiers)) withRelations.add(Beneficiary_.medicareBeneficiaryIdHistories);\n \n-    return query.getResultList();\n-  }\n+    String contractMonth =\n+        coverageId.getSystem().substring(coverageId.getSystem().lastIndexOf('/') + 1);\n+    CcwCodebookVariable partDContractMonth = partDCwVariableFor(contractMonth);\n+    SingularAttribute<Beneficiary, String> contractMonthField = partDFieldFor(partDContractMonth);\n+    String contractCode = coverageId.getValueNotNull();\n \n-  private CriteriaQuery queryBeneficiariesBy(\n-      SingularAttribute<Beneficiary, String> field, String value) {\n-    List<SetAttribute<Beneficiary, ?>> withRelations =\n-        new LinkedList<SetAttribute<Beneficiary, ?>>();\n-    return queryBeneficiariesBy(field, value, withRelations);\n+    CriteriaQuery<Beneficiary> criteria =\n+        queryBeneficiariesBy(contractMonthField, contractCode, paging, withRelations);\n+    return entityManager.createQuery(criteria).setMaxResults(paging.getPageSize()).getResultList();\n   }\n \n-  private CriteriaQuery queryBeneficiariesBy(\n+  /**\n+   * Build a criteria for a general Beneficiary query\n+   *\n+   * @param field to match on\n+   * @param value to match on\n+   * @param paging to use for the result set\n+   * @param joins to add for many-to-one relations\n+   * @return the criteria\n+   */\n+  private CriteriaQuery<Beneficiary> queryBeneficiariesBy(\n       SingularAttribute<Beneficiary, String> field,\n       String value,\n-      List<SetAttribute<Beneficiary, ?>> relations) {\n-\n-    CriteriaBuilder builder = entityManager.getCriteriaBuilder();\n-    CriteriaQuery<Beneficiary> beneMatches = builder.createQuery(Beneficiary.class);\n-    Root<Beneficiary> beneMatchesRoot = beneMatches.from(Beneficiary.class);\n-    relations.stream()\n-        .forEach(\n-            f -> {\n-              beneMatchesRoot.fetch(f, JoinType.LEFT);\n-            });\n-    beneMatches.select(beneMatchesRoot);\n-    beneMatches.where(builder.equal(beneMatchesRoot.get(field), value));\n-\n-    return beneMatches;\n+      PatientLinkBuilder paging,\n+      List<SetAttribute<Beneficiary, ?>> joins) {\n+\n+    CriteriaBuilder cb = entityManager.getCriteriaBuilder();\n+    CriteriaQuery<Beneficiary> criteria = cb.createQuery(Beneficiary.class);\n+    Root<Beneficiary> b = criteria.from(Beneficiary.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d08b186b8fe1c2d58574cc1b2bea602345e531f"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE1Njg4Mg==", "bodyText": "ty this is much cleaner", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/249#discussion_r404156882", "createdAt": "2020-04-06T14:55:30Z", "author": {"login": "whytheplatypus"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -337,51 +314,65 @@ private CcwCodebookVariable partDCwVariableFor(String system) {\n         \"Unsupported extension system: \" + cntrctMonth.getVariable().getId().toLowerCase());\n   }\n \n-  private Long fetchResultCount(CriteriaQuery criteria) {\n-    Predicate restriction = criteria.getRestriction();\n-    CriteriaBuilder builder = entityManager.getCriteriaBuilder();\n-    CriteriaQuery<Long> countQuery = builder.createQuery(Long.class);\n-    countQuery.where(restriction);\n-    return entityManager\n-        .createQuery(countQuery.select(builder.count(countQuery.from(Beneficiary.class))))\n-        .getSingleResult();\n-  }\n-\n-  private List<Beneficiary> fetchBeneficiaries(CriteriaQuery criteria, PageLinkBuilder pagingArgs) {\n-    Query query = entityManager.createQuery(criteria);\n-\n-    if (pagingArgs.isPagingRequested()) {\n-      query.setFirstResult(pagingArgs.getStartIndex());\n-      query.setMaxResults(pagingArgs.getPageSize());\n-    }\n+  /**\n+   * Fetch beneficiaries for the PartD coverage parameter\n+   *\n+   * @param coverageId coverage type\n+   * @param includedIdentifiers list from the includeIdentifier header\n+   * @param paging specified\n+   * @return the beneficiaries\n+   */\n+  private List<Beneficiary> fetchBeneficiaries(\n+      TokenParam coverageId, List<String> includedIdentifiers, PatientLinkBuilder paging) {\n+    List<SetAttribute<Beneficiary, ?>> withRelations = new LinkedList<>();\n+    if (hasHICN(includedIdentifiers)) withRelations.add(Beneficiary_.beneficiaryHistories);\n+    if (hasMBI(includedIdentifiers)) withRelations.add(Beneficiary_.medicareBeneficiaryIdHistories);\n \n-    return query.getResultList();\n-  }\n+    String contractMonth =\n+        coverageId.getSystem().substring(coverageId.getSystem().lastIndexOf('/') + 1);\n+    CcwCodebookVariable partDContractMonth = partDCwVariableFor(contractMonth);\n+    SingularAttribute<Beneficiary, String> contractMonthField = partDFieldFor(partDContractMonth);\n+    String contractCode = coverageId.getValueNotNull();\n \n-  private CriteriaQuery queryBeneficiariesBy(\n-      SingularAttribute<Beneficiary, String> field, String value) {\n-    List<SetAttribute<Beneficiary, ?>> withRelations =\n-        new LinkedList<SetAttribute<Beneficiary, ?>>();\n-    return queryBeneficiariesBy(field, value, withRelations);\n+    CriteriaQuery<Beneficiary> criteria =\n+        queryBeneficiariesBy(contractMonthField, contractCode, paging, withRelations);\n+    return entityManager.createQuery(criteria).setMaxResults(paging.getPageSize()).getResultList();\n   }\n \n-  private CriteriaQuery queryBeneficiariesBy(\n+  /**\n+   * Build a criteria for a general Beneficiary query\n+   *\n+   * @param field to match on\n+   * @param value to match on\n+   * @param paging to use for the result set\n+   * @param joins to add for many-to-one relations\n+   * @return the criteria\n+   */\n+  private CriteriaQuery<Beneficiary> queryBeneficiariesBy(\n       SingularAttribute<Beneficiary, String> field,\n       String value,\n-      List<SetAttribute<Beneficiary, ?>> relations) {\n-\n-    CriteriaBuilder builder = entityManager.getCriteriaBuilder();\n-    CriteriaQuery<Beneficiary> beneMatches = builder.createQuery(Beneficiary.class);\n-    Root<Beneficiary> beneMatchesRoot = beneMatches.from(Beneficiary.class);\n-    relations.stream()\n-        .forEach(\n-            f -> {\n-              beneMatchesRoot.fetch(f, JoinType.LEFT);\n-            });\n-    beneMatches.select(beneMatchesRoot);\n-    beneMatches.where(builder.equal(beneMatchesRoot.get(field), value));\n-\n-    return beneMatches;\n+      PatientLinkBuilder paging,\n+      List<SetAttribute<Beneficiary, ?>> joins) {\n+\n+    CriteriaBuilder cb = entityManager.getCriteriaBuilder();\n+    CriteriaQuery<Beneficiary> criteria = cb.createQuery(Beneficiary.class);\n+    Root<Beneficiary> b = criteria.from(Beneficiary.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEzOTA4Nw=="}, "originalCommit": {"oid": "0d08b186b8fe1c2d58574cc1b2bea602345e531f"}, "originalPosition": 161}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwNzc1MjAxOnYy", "diffSide": "RIGHT", "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/TransformerUtils.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDozNTowN1rOGBazcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDozNTowN1rOGBazcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE0MDkxMg==", "bodyText": "No total value when paging is requested.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/249#discussion_r404140912", "createdAt": "2020-04-06T14:35:07Z", "author": {"login": "RickHawesUSDS"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/TransformerUtils.java", "diffHunk": "@@ -2955,25 +2957,22 @@ public static Bundle createBundle(\n   }\n \n   /**\n-   * Create a bundle from one page of resources\n+   * Create a bundle from the entire search result\n    *\n-   * @param paging a {@link PageLinkBuilder} used to determine if paging is requested and the\n-   *     parameters for doing so. The resources list is trimmed to fit the requested page.\n    * @param resources a list of {@link ExplanationOfBenefit}s, {@link Coverage}s, or {@link\n-   *     Patient}s, of which a portion or all will be added to the bundle based on the paging values\n-   * @param total number of resources in the entire search result\n+   *     Patient}s, all of which will be added to the bundle\n+   * @param paging contains the {@link LinkBuilder} information to add to the bundle\n+   * @param transactionTime date for the bundle\n    * @return Returns a {@link Bundle} of either {@link ExplanationOfBenefit}s, {@link Coverage}s, or\n    *     {@link Patient}s, which may contain multiple matching resources, or may also be empty.\n    */\n   public static Bundle createBundle(\n-      PageLinkBuilder paging, List<IBaseResource> resources, int total, Date transactionTime) {\n+      List<IBaseResource> resources, LinkBuilder paging, Date transactionTime) {\n     Bundle bundle = new Bundle();\n-\n-    if (paging.isPagingRequested()) {\n-      paging.addPageLinks(bundle, total);\n-    }\n-\n-    bundle = TransformerUtils.addResourcesToBundle(bundle, resources);\n+    TransformerUtils.addResourcesToBundle(bundle, resources);\n+    paging.addLinks(bundle);\n+    bundle.setTotalElement(\n+        paging.isPagingRequested() ? new UnsignedIntType() : new UnsignedIntType(resources.size()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d08b186b8fe1c2d58574cc1b2bea602345e531f"}, "originalPosition": 67}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 341, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}