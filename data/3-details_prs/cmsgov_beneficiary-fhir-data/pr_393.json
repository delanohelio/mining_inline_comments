{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5MjY5MjYw", "number": 393, "title": "Cbrune/bfd 525 paging bug", "bodyText": "Change Details\nI believe there are three issues with using the header \"IncludeIdentifiers=mbi\" on the Patient endpoint to search for contract membership by month.\nNext link (for paging through lists of results) is not being included on many (maybe all) production contracts as part of the response to a search.\nAn extra empty next link is added in specific conditions. When queried it throws a 500 error.\nIf there is no membership information for a given month a 500 error is thrown like with issue 2.\nThe exact same calls without using \"IncludeIdentifiers=mbi\" as a header succeed.\nOur PDP partners are requesting this information and need it to proceed.\nThis change fixes issues from the next link (for paging through lists of results) that is not being included on many production contracts as part of the response to a search.  Also adds the next link in specific conditions.\n\n\nAcceptance Validation\n\nUnit tests are included with fix and IT tests pass.\n\nFeedback Requested\n\nThe changes make sense, unit tests pass, and IT tests pass as well.\nExternal References\n\n\nBLUEBUTTON-xxx\n\nSecurity Implications\n\n\n new software dependencies\n\n\n\n altered security controls\n\n\n\n new data stored or transmitted\n\n\n\n security checklist is completed for this change\n\n\n\n requires more information or team discussion to evaluate security implications", "createdAt": "2020-11-11T15:23:02Z", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393", "merged": true, "mergeCommit": {"oid": "df6dbc0d569a99d1bd58220b27f14897d2a152c6"}, "closed": true, "closedAt": "2020-11-16T16:53:38Z", "author": {"login": "cbrunefearless"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbRe49gH2gAyNTE5MjY5MjYwOjc0M2I3YTg3MzQwNjViMjBhYTc4YzFkOTgxYjE5ODQzODhhNjQzYWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddH4vYgFqTUzMTUxMjQ5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "743b7a8734065b20aa78c1d981b1984388a643ac", "author": {"user": {"login": "cbrunefearless", "name": "Chris Brune"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/743b7a8734065b20aa78c1d981b1984388a643ac", "committedDate": "2020-11-10T22:55:19Z", "message": "Added paging link to link builder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "610c794ef064b80a1caca4e6c027a82583d94545", "author": {"user": {"login": "cbrunefearless", "name": "Chris Brune"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/610c794ef064b80a1caca4e6c027a82583d94545", "committedDate": "2020-11-10T23:09:21Z", "message": "added logic to r4provider"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MTE2ODcz", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#pullrequestreview-529116873", "createdAt": "2020-11-12T14:05:16Z", "commit": {"oid": "610c794ef064b80a1caca4e6c027a82583d94545"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88a1fbe01f2ff73b6c6d22aa9a88ae98684037e8", "author": {"user": {"login": "cbrunefearless", "name": "Chris Brune"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/88a1fbe01f2ff73b6c6d22aa9a88ae98684037e8", "committedDate": "2020-11-12T19:15:26Z", "message": "Merge branch 'master' into cbrune/bfd-525-paging-bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a520923a840f925ddb46f23df1126ccba1500e07", "author": {"user": {"login": "cbrunefearless", "name": "Chris Brune"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/a520923a840f925ddb46f23df1126ccba1500e07", "committedDate": "2020-11-13T16:20:14Z", "message": "set distinct in the query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9aa32d5fb490f2b4cd3d037468af1e104cbdf21", "author": {"user": {"login": "cbrunefearless", "name": "Chris Brune"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/a9aa32d5fb490f2b4cd3d037468af1e104cbdf21", "committedDate": "2020-11-13T16:26:16Z", "message": "reverted changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMjA3NzM0", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#pullrequestreview-530207734", "createdAt": "2020-11-13T16:28:11Z", "commit": {"oid": "a9aa32d5fb490f2b4cd3d037468af1e104cbdf21"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMjA5MDcy", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#pullrequestreview-530209072", "createdAt": "2020-11-13T16:29:49Z", "commit": {"oid": "a9aa32d5fb490f2b4cd3d037468af1e104cbdf21"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjoyOTo0OVrOHy1M8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNjozNjo0M1rOHy1ePQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2MjUxMw==", "bodyText": "Definitely looks broken, and doesn't match the V1 logic.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                boolean hasAnotherPage = matchingBeneficiaries.size() == paging.getPageSize();\n          \n          \n            \n                boolean hasAnotherPage = matchingBeneficiaries.size() > paging.getPageSize();", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#discussion_r523062513", "createdAt": "2020-11-13T16:29:49Z", "author": {"login": "karlmdavis"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/r4/providers/R4PatientResourceProvider.java", "diffHunk": "@@ -269,6 +269,13 @@ public Bundle searchByCoverageContract(\n     List<Beneficiary> matchingBeneficiaries =\n         fetchBeneficiaries(coverageId, includeIdentifiersValues, paging);\n \n+    // Insures backwards compatability\n+    boolean hasAnotherPage = matchingBeneficiaries.size() == paging.getPageSize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9aa32d5fb490f2b4cd3d037468af1e104cbdf21"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2NTg4Nw==", "bodyText": "Just a note: I haven't tested this at all, so please make sure you do.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#discussion_r523065887", "createdAt": "2020-11-13T16:35:10Z", "author": {"login": "karlmdavis"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -454,7 +459,7 @@ private String partDFieldFor(CcwCodebookVariable month) {\n     if (hasHICN(identifiers)) joinsClause += \"left join fetch b.beneficiaryHistories \";\n \n     String query =\n-        \"select b from Beneficiary b \"\n+        \"select distinct b from Beneficiary b \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9aa32d5fb490f2b4cd3d037468af1e104cbdf21"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzA2Njk0MQ==", "bodyText": "This same change would also be needed in the V2 resource provider.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#discussion_r523066941", "createdAt": "2020-11-13T16:36:43Z", "author": {"login": "karlmdavis"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/stu3/providers/PatientResourceProvider.java", "diffHunk": "@@ -454,7 +459,7 @@ private String partDFieldFor(CcwCodebookVariable month) {\n     if (hasHICN(identifiers)) joinsClause += \"left join fetch b.beneficiaryHistories \";\n \n     String query =\n-        \"select b from Beneficiary b \"\n+        \"select distinct b from Beneficiary b \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9aa32d5fb490f2b4cd3d037468af1e104cbdf21"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3095919d32c7038fc4be8103152cada307c50145", "author": {"user": {"login": "cbrunefearless", "name": "Chris Brune"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/3095919d32c7038fc4be8103152cada307c50145", "committedDate": "2020-11-13T17:19:19Z", "message": "Changed from == to greater than"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMjcwNjgz", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#pullrequestreview-530270683", "createdAt": "2020-11-13T17:36:20Z", "commit": {"oid": "3095919d32c7038fc4be8103152cada307c50145"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMjg4MTQ4", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#pullrequestreview-530288148", "createdAt": "2020-11-13T18:01:54Z", "commit": {"oid": "3095919d32c7038fc4be8103152cada307c50145"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxODowMTo1NFrOHy5UXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxODowMTo1NFrOHy5UXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEyOTk0OA==", "bodyText": "I think you should consider adding a unit test for the distinct issue, if you can. Not a hard requirement; just a suggestion.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#discussion_r523129948", "createdAt": "2020-11-13T18:01:54Z", "author": {"login": "karlmdavis"}, "path": "apps/bfd-server/bfd-server-war/src/test/java/gov/cms/bfd/server/war/stu3/providers/PatientLinkBuilderTest.java", "diffHunk": "@@ -103,6 +103,28 @@ public void fullPageTest() {\n     Assert.assertTrue(bundle.getLink().isEmpty());\n     paging.addLinks(bundle);\n \n+    Assert.assertNotNull(bundle.getLink(Constants.LINK_SELF));\n+    Assert.assertNotNull(bundle.getLink(Constants.LINK_FIRST));\n+    Assert.assertNull(bundle.getLink(Constants.LINK_NEXT));\n+  }\n+\n+  @Test\n+  public void fullPageTestWithPaging() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3095919d32c7038fc4be8103152cada307c50145"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7000431ec769cc9ed8e83e0b774db3f51750194", "author": {"user": {"login": "karlmdavis", "name": "Karl M. Davis"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/a7000431ec769cc9ed8e83e0b774db3f51750194", "committedDate": "2020-11-13T19:37:49Z", "message": "Fixed more bugs with benes that have multiple MBIs.\n\nAdded unit tests to help cover these issues.\n\nBFD-525"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDAzODU1", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#pullrequestreview-530403855", "createdAt": "2020-11-13T20:45:00Z", "commit": {"oid": "a7000431ec769cc9ed8e83e0b774db3f51750194"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMDo0NTowMVrOHy-pbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMDo0NTowMVrOHy-pbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIxNzI2MA==", "bodyText": "Delete this comment as when we originally modified this file, we did not apply the +1 fix.  Now that the fix has been applied, this comment no longer applies.", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#discussion_r523217260", "createdAt": "2020-11-13T20:45:01Z", "author": {"login": "nflearl"}, "path": "apps/bfd-server/bfd-server-war/src/main/java/gov/cms/bfd/server/war/r4/providers/R4PatientResourceProvider.java", "diffHunk": "@@ -269,6 +269,13 @@ public Bundle searchByCoverageContract(\n     List<Beneficiary> matchingBeneficiaries =\n         fetchBeneficiaries(coverageId, includeIdentifiersValues, paging);\n \n+    // Insures backwards compatability", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7000431ec769cc9ed8e83e0b774db3f51750194"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDA0ODQ5", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#pullrequestreview-530404849", "createdAt": "2020-11-13T20:46:51Z", "commit": {"oid": "a7000431ec769cc9ed8e83e0b774db3f51750194"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97b264b1c6b18783ead66d4b60efaa771ad61402", "author": {"user": {"login": "cbrunefearless", "name": "Chris Brune"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/97b264b1c6b18783ead66d4b60efaa771ad61402", "committedDate": "2020-11-13T21:43:42Z", "message": "Removed comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDM3MTU2", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#pullrequestreview-530437156", "createdAt": "2020-11-13T21:48:41Z", "commit": {"oid": "a7000431ec769cc9ed8e83e0b774db3f51750194"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dad7eb3be3768452378b91371b43860f6404c90e", "author": {"user": {"login": "cbrunefearless", "name": "Chris Brune"}}, "url": "https://github.com/CMSgov/beneficiary-fhir-data/commit/dad7eb3be3768452378b91371b43860f6404c90e", "committedDate": "2020-11-13T22:12:55Z", "message": "Merged"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDU0MDY4", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#pullrequestreview-530454068", "createdAt": "2020-11-13T22:20:13Z", "commit": {"oid": "dad7eb3be3768452378b91371b43860f6404c90e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNDQyMjc3", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#pullrequestreview-531442277", "createdAt": "2020-11-16T15:41:03Z", "commit": {"oid": "dad7eb3be3768452378b91371b43860f6404c90e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTEyNDkz", "url": "https://github.com/CMSgov/beneficiary-fhir-data/pull/393#pullrequestreview-531512493", "createdAt": "2020-11-16T16:52:21Z", "commit": {"oid": "dad7eb3be3768452378b91371b43860f6404c90e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 522, "cost": 1, "resetAt": "2021-11-01T13:07:16Z"}}}