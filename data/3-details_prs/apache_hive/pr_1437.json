{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0NTkzMjk3", "number": 1437, "title": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries", "bodyText": "What changes were proposed in this pull request?\n\nDo phase 1 parsing of subquery expressions in order to count CTE references in those subqueries\nAdd a config to materialize CTEs with aggregate output only\n\nWhy are the changes needed?\nImprove performance of complex queries referencing the same fully aggregate CTE more than one times.\nDoes this PR introduce any user-facing change?\nAdds a new config into HiveConf: hive.optimize.cte.materialize.full.aggregate.only.\nPrior this patch if hive.optimize.cte.materialize.threshold was higher than -1 all non-subquery CTEs were materialized if they were referenced more times than the threshold. This patch limits this to fully aggregate CTEs only by default. The original behavior can restored by setting hive.optimize.cte.materialize.full.aggregate.only to false.\nHow was this patch tested?\n\nNew q tests were added.\n\nmvn test -Dtest.output.overwrite -DskipSparkTests -Dtest=TestMiniLlapLocalCliDriver -Dqfile=cte_mat_6.q,cte_mat_7.q -pl itests/qtest -Pitests\n\n\nRun query14\n\nmvn test -Dtest.output.overwrite -DskipSparkTests -Dtest=TestTezPerfCliDriver -Dqfile=query14.q -pl itests/qtest -Pitests", "createdAt": "2020-08-27T10:06:30Z", "url": "https://github.com/apache/hive/pull/1437", "merged": true, "mergeCommit": {"oid": "d700ea54ec5da5364d92a9faaa58f89ea03181e0"}, "closed": true, "closedAt": "2020-09-02T17:00:52Z", "author": {"login": "kasakrisz"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDB_qbgBqjM3MDAxNjI0OTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE_B2FAFqTQ4MTAyMDEyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8059e519402eb2008b4c259f7f4553f027ea6ac9", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/8059e519402eb2008b4c259f7f4553f027ea6ac9", "committedDate": "2020-08-27T09:47:46Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries"}, "afterCommit": {"oid": "55a60cc9e1ba98cf038d471d5edcfd3ed0dedcb4", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/55a60cc9e1ba98cf038d471d5edcfd3ed0dedcb4", "committedDate": "2020-08-27T15:18:00Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "55a60cc9e1ba98cf038d471d5edcfd3ed0dedcb4", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/55a60cc9e1ba98cf038d471d5edcfd3ed0dedcb4", "committedDate": "2020-08-27T15:18:00Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries"}, "afterCommit": {"oid": "e2174573c38121047c90fe414faebe88e22cbf8c", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/e2174573c38121047c90fe414faebe88e22cbf8c", "committedDate": "2020-08-28T07:01:12Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3OTc5NjAy", "url": "https://github.com/apache/hive/pull/1437#pullrequestreview-477979602", "createdAt": "2020-08-28T19:35:28Z", "commit": {"oid": "e2174573c38121047c90fe414faebe88e22cbf8c"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxOTozNToyOFrOHJSQOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxOTo0NTo1OVrOHJShHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ5ODI5Ng==", "bodyText": "Should we set the default to 2 now that it is only triggered in very specific cases?", "url": "https://github.com/apache/hive/pull/1437#discussion_r479498296", "createdAt": "2020-08-28T19:35:28Z", "author": {"login": "jcamachor"}, "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "diffHunk": "@@ -2591,6 +2591,10 @@ private static void populateLlapDaemonVarsSet(Set<String> llapDaemonVarsSetLocal\n     HIVE_CTE_MATERIALIZE_THRESHOLD(\"hive.optimize.cte.materialize.threshold\", -1,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2174573c38121047c90fe414faebe88e22cbf8c"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUwMDkxMg==", "bodyText": "Trying to understand this step. Does this lead to parsing the same subquery multiple times?", "url": "https://github.com/apache/hive/pull/1437#discussion_r479500912", "createdAt": "2020-08-28T19:41:52Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/QB.java", "diffHunk": "@@ -457,4 +469,17 @@ public boolean hasTableDefined() {\n     return !(aliases.size() == 1 && aliases.get(0).equals(SemanticAnalyzer.DUMMY_TABLE));\n   }\n \n+  public void addSubqExprAlias(ASTNode expressionTree, SemanticAnalyzer semanticAnalyzer) throws SemanticException {\n+    String alias = \"__subexpr\" + subQueryExpressionAliasCounter++;\n+\n+    // Recursively do the first phase of semantic analysis for the subquery\n+    QBExpr qbexpr = new QBExpr(alias);\n+\n+    ASTNode subqref = (ASTNode) expressionTree.getChild(1);\n+    semanticAnalyzer.doPhase1QBExpr(subqref, qbexpr, getId(), alias, isInsideView());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2174573c38121047c90fe414faebe88e22cbf8c"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUwMTQ0MQ==", "bodyText": "Although the method is evident, could we add a comment?\nShould this be static since it is a utility method that can be used beyond this scope?", "url": "https://github.com/apache/hive/pull/1437#discussion_r479501441", "createdAt": "2020-08-28T19:43:12Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/QBParseInfo.java", "diffHunk": "@@ -677,6 +685,33 @@ public void setNoScanAnalyzeCommand(boolean isNoScanAnalyzeCommand) {\n   public boolean hasInsertTables() {\n     return this.insertIntoTables.size() > 0 || this.insertOverwriteTables.size() > 0;\n   }\n+\n+  public boolean isFullyAggregate() throws SemanticException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2174573c38121047c90fe414faebe88e22cbf8c"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTUwMjYyMw==", "bodyText": "Could we add tests to make sure the optimization is only triggered for SELECT queries? For instance, I am thinking about CTAS and CMV statements, the optimization should not triggered in those cases (I guess it could lead some kind of side effect, at least for CMV).", "url": "https://github.com/apache/hive/pull/1437#discussion_r479502623", "createdAt": "2020-08-28T19:45:59Z", "author": {"login": "jcamachor"}, "path": "ql/src/test/queries/clientpositive/cte_mat_6.q", "diffHunk": "@@ -0,0 +1,81 @@\n+set hive.optimize.cte.materialize.threshold=1;\n+\n+create table t0(col0 int);\n+\n+insert into t0(col0) values\n+(1),(2),\n+(100),(100),(100),\n+(200),(200);\n+\n+-- CTE is referenced from scalar subquery in the select clause\n+explain\n+with cte as (select count(*) as small_count from t0 where col0 < 10)\n+select t0.col0, (select small_count from cte)\n+from t0\n+order by t0.col0;\n+\n+with cte as (select count(*) as small_count from t0 where col0 < 10)\n+select t0.col0, (select small_count from cte)\n+from t0\n+order by t0.col0;\n+\n+-- disable cte materialization\n+set hive.optimize.cte.materialize.threshold=-1;\n+\n+explain\n+with cte as (select count(*) as small_count from t0 where col0 < 10)\n+select t0.col0, (select small_count from cte)\n+from t0\n+order by t0.col0;\n+\n+\n+with cte as (select count(*) as small_count from t0 where col0 < 10)\n+select t0.col0, (select small_count from cte)\n+from t0\n+order by t0.col0;\n+\n+\n+-- enable cte materialization\n+set hive.optimize.cte.materialize.threshold=1;\n+\n+-- CTE is referenced from scalar subquery in the where clause\n+explain\n+with cte as (select count(*) as small_count from t0 where col0 < 10)\n+select t0.col0\n+from t0\n+where t0.col0 > (select small_count from cte)\n+order by t0.col0;\n+\n+with cte as (select count(*) as small_count from t0 where col0 < 10)\n+select t0.col0\n+from t0\n+where t0.col0 > (select small_count from cte)\n+order by t0.col0;\n+\n+-- CTE is referenced from scalar subquery in the having clause\n+explain\n+with cte as (select count(*) as small_count from t0 where col0 < 10)\n+select t0.col0, count(*)\n+from t0\n+group by col0\n+having count(*) > (select small_count from cte)\n+order by t0.col0;\n+\n+with cte as (select count(*) as small_count from t0 where col0 < 10)\n+select t0.col0, count(*)\n+from t0\n+group by col0\n+having count(*) > (select small_count from cte)\n+order by t0.col0;\n+\n+-- mix full aggregate and non-full aggregate ctes\n+explain\n+with cte1 as (select col0 as k1 from t0 where col0 = '5'),\n+     cte2 as (select count(*) as all_count from t0),\n+     cte3 as (select col0 as k3, col0 + col0 as k3_2x, count(*) as key_count from t0 group by col0)\n+select t0.col0, count(*)\n+from t0\n+join cte1 on t0.col0 = cte1.k1\n+join cte3 on t0.col0 = cte3.k3\n+group by col0\n+having count(*) > (select all_count from cte2)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2174573c38121047c90fe414faebe88e22cbf8c"}, "originalPosition": 81}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2174573c38121047c90fe414faebe88e22cbf8c", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/e2174573c38121047c90fe414faebe88e22cbf8c", "committedDate": "2020-08-28T07:01:12Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries"}, "afterCommit": {"oid": "341fe738ea68334908155d3c39c6f3ed0c8b883e", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/341fe738ea68334908155d3c39c6f3ed0c8b883e", "committedDate": "2020-08-31T08:47:49Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries - address review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "341fe738ea68334908155d3c39c6f3ed0c8b883e", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/341fe738ea68334908155d3c39c6f3ed0c8b883e", "committedDate": "2020-08-31T08:47:49Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries - address review comments"}, "afterCommit": {"oid": "f8b10c84fb8d1caff99e13d4d4d1bf02b8b4eab7", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/f8b10c84fb8d1caff99e13d4d4d1bf02b8b4eab7", "committedDate": "2020-08-31T09:15:10Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries - address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5ODQ5NTE1", "url": "https://github.com/apache/hive/pull/1437#pullrequestreview-479849515", "createdAt": "2020-09-01T15:14:18Z", "commit": {"oid": "24bf9fc5932a142b251fac4e17c9cb70090ca6f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNToxNDoxOVrOHK7aWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNToxNDoxOVrOHK7aWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyMTIxMA==", "bodyText": "Expected?", "url": "https://github.com/apache/hive/pull/1437#discussion_r481221210", "createdAt": "2020-09-01T15:14:19Z", "author": {"login": "jcamachor"}, "path": "ql/src/test/results/clientpositive/llap/cte_4.q.out", "diffHunk": "@@ -106,23 +106,17 @@ PREHOOK: query: create table s2 as\n with q1 as ( select key from src where key = '4')\n select * from q1\n PREHOOK: type: CREATETABLE_AS_SELECT\n-PREHOOK: Input: default@q1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24bf9fc5932a142b251fac4e17c9cb70090ca6f6"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37e5229f20981237e89b4637e6b4540aa936f271", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/37e5229f20981237e89b4637e6b4540aa936f271", "committedDate": "2020-09-02T04:11:25Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cf7c06b9043171af40629e16a573b784ccb013e", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/6cf7c06b9043171af40629e16a573b784ccb013e", "committedDate": "2020-09-02T04:11:25Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries - address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "143eb43d659e83ef673a850e513b9ef464580831", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/143eb43d659e83ef673a850e513b9ef464580831", "committedDate": "2020-09-02T04:11:25Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries - update q outs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25dd3fcf98254f4b57bde9ed59283db536a3b48e", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/25dd3fcf98254f4b57bde9ed59283db536a3b48e", "committedDate": "2020-09-02T04:34:52Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries - set threshold to 3"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "24bf9fc5932a142b251fac4e17c9cb70090ca6f6", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/24bf9fc5932a142b251fac4e17c9cb70090ca6f6", "committedDate": "2020-08-31T11:35:48Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries - update q outs"}, "afterCommit": {"oid": "25dd3fcf98254f4b57bde9ed59283db536a3b48e", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/25dd3fcf98254f4b57bde9ed59283db536a3b48e", "committedDate": "2020-09-02T04:34:52Z", "message": "HIVE-24081: Enable pre-materializing CTEs referenced in scalar subqueries - set threshold to 3"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMDIwMTI3", "url": "https://github.com/apache/hive/pull/1437#pullrequestreview-481020127", "createdAt": "2020-09-02T16:58:58Z", "commit": {"oid": "25dd3fcf98254f4b57bde9ed59283db536a3b48e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3255, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}