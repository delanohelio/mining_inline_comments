{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3ODI3OTY1", "number": 992, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMTo0OToxMlrOD1Pikw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMTo1NzoxNVrOD1Pu0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MTU1NzMxOnYy", "diffSide": "RIGHT", "path": "ql/src/test/org/apache/hadoop/hive/ql/parse/type/TestTypeCheckProcFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMTo0OToxMlrOGKlLtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNTo1OTowNlrOGKvvsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc0ODE1MQ==", "bodyText": "this is a \"@parameterized\" testclass; please don't add testcases which are not use the parameterized nature... move these to a new testclass\nit might make sense to split the testcases into separate methods", "url": "https://github.com/apache/hive/pull/992#discussion_r413748151", "createdAt": "2020-04-23T11:49:12Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/test/org/apache/hadoop/hive/ql/parse/type/TestTypeCheckProcFactory.java", "diffHunk": "@@ -140,4 +147,37 @@ public void testWithNonZeroFraction() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testValidateUDFOnTypeCheck() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca425983510ee841439e9a9dd83b6e0547501a9"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkyMTIwMQ==", "bodyText": "Thank you for mentioning this, move the test to TestTypeCompareValidation.", "url": "https://github.com/apache/hive/pull/992#discussion_r413921201", "createdAt": "2020-04-23T15:59:06Z", "author": {"login": "dengzhhu653"}, "path": "ql/src/test/org/apache/hadoop/hive/ql/parse/type/TestTypeCheckProcFactory.java", "diffHunk": "@@ -140,4 +147,37 @@ public void testWithNonZeroFraction() throws Exception {\n     }\n   }\n \n+  @Test\n+  public void testValidateUDFOnTypeCheck() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc0ODE1MQ=="}, "originalCommit": {"oid": "3ca425983510ee841439e9a9dd83b6e0547501a9"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MTU2NzY2OnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/type/TypeCheckProcFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMTo1MTo1NFrOGKlSDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QyMjoxMzo1N1rOGK-R4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc0OTc3Mg==", "bodyText": "you could move the oiTypeInfo0 conditions into a method (along with the Set) and then reuse the method 2 lines down\nmight make this more readable", "url": "https://github.com/apache/hive/pull/992#discussion_r413749772", "createdAt": "2020-04-23T11:51:54Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/type/TypeCheckProcFactory.java", "diffHunk": "@@ -789,12 +791,25 @@ protected void validateUDF(ASTNode expr, boolean isFunction, TypeCheckCtx ctx, F\n \n         LogHelper console = new LogHelper(LOG);\n \n+        Set<PrimitiveObjectInspector.PrimitiveCategory> unsafeConventionTyps = Sets.newHashSet(\n+            PrimitiveObjectInspector.PrimitiveCategory.STRING,\n+            PrimitiveObjectInspector.PrimitiveCategory.VARCHAR,\n+            PrimitiveObjectInspector.PrimitiveCategory.CHAR);\n         // For now, if a bigint is going to be cast to a double throw an error or warning\n-        if ((oiTypeInfo0.equals(TypeInfoFactory.stringTypeInfo) && oiTypeInfo1.equals(TypeInfoFactory.longTypeInfo)) ||\n-            (oiTypeInfo0.equals(TypeInfoFactory.longTypeInfo) && oiTypeInfo1.equals(TypeInfoFactory.stringTypeInfo))) {\n+        if ((oiTypeInfo0 instanceof PrimitiveTypeInfo &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca425983510ee841439e9a9dd83b6e0547501a9"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDE1OTMzMQ==", "bodyText": "Move the conditions to method unSafeCompareWithBigInt.", "url": "https://github.com/apache/hive/pull/992#discussion_r414159331", "createdAt": "2020-04-23T22:13:57Z", "author": {"login": "dengzhhu653"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/type/TypeCheckProcFactory.java", "diffHunk": "@@ -789,12 +791,25 @@ protected void validateUDF(ASTNode expr, boolean isFunction, TypeCheckCtx ctx, F\n \n         LogHelper console = new LogHelper(LOG);\n \n+        Set<PrimitiveObjectInspector.PrimitiveCategory> unsafeConventionTyps = Sets.newHashSet(\n+            PrimitiveObjectInspector.PrimitiveCategory.STRING,\n+            PrimitiveObjectInspector.PrimitiveCategory.VARCHAR,\n+            PrimitiveObjectInspector.PrimitiveCategory.CHAR);\n         // For now, if a bigint is going to be cast to a double throw an error or warning\n-        if ((oiTypeInfo0.equals(TypeInfoFactory.stringTypeInfo) && oiTypeInfo1.equals(TypeInfoFactory.longTypeInfo)) ||\n-            (oiTypeInfo0.equals(TypeInfoFactory.longTypeInfo) && oiTypeInfo1.equals(TypeInfoFactory.stringTypeInfo))) {\n+        if ((oiTypeInfo0 instanceof PrimitiveTypeInfo &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc0OTc3Mg=="}, "originalCommit": {"oid": "3ca425983510ee841439e9a9dd83b6e0547501a9"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MTU3NDMyOnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/type/TypeCheckProcFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMTo1Mzo0MFrOGKlWKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNTo0OTowNlrOGKvPyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc1MDgyNA==", "bodyText": "I don't think the type variable is needed - you could just get both types when you are generating the warning messages.", "url": "https://github.com/apache/hive/pull/992#discussion_r413750824", "createdAt": "2020-04-23T11:53:40Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/type/TypeCheckProcFactory.java", "diffHunk": "@@ -789,12 +791,25 @@ protected void validateUDF(ASTNode expr, boolean isFunction, TypeCheckCtx ctx, F\n \n         LogHelper console = new LogHelper(LOG);\n \n+        Set<PrimitiveObjectInspector.PrimitiveCategory> unsafeConventionTyps = Sets.newHashSet(\n+            PrimitiveObjectInspector.PrimitiveCategory.STRING,\n+            PrimitiveObjectInspector.PrimitiveCategory.VARCHAR,\n+            PrimitiveObjectInspector.PrimitiveCategory.CHAR);\n         // For now, if a bigint is going to be cast to a double throw an error or warning\n-        if ((oiTypeInfo0.equals(TypeInfoFactory.stringTypeInfo) && oiTypeInfo1.equals(TypeInfoFactory.longTypeInfo)) ||\n-            (oiTypeInfo0.equals(TypeInfoFactory.longTypeInfo) && oiTypeInfo1.equals(TypeInfoFactory.stringTypeInfo))) {\n+        if ((oiTypeInfo0 instanceof PrimitiveTypeInfo &&\n+            unsafeConventionTyps.contains(((PrimitiveTypeInfo)oiTypeInfo0).getPrimitiveCategory()) &&\n+            oiTypeInfo1.equals(TypeInfoFactory.longTypeInfo)) || (oiTypeInfo1 instanceof PrimitiveTypeInfo &&\n+            unsafeConventionTyps.contains(((PrimitiveTypeInfo)oiTypeInfo1).getPrimitiveCategory()) &&\n+            oiTypeInfo0.equals(TypeInfoFactory.longTypeInfo))) {\n           String error = StrictChecks.checkTypeSafety(conf);\n-          if (error != null) throw new UDFArgumentException(error);\n-          console.printError(\"WARNING: Comparing a bigint and a string may result in a loss of precision.\");\n+          if (error != null) {\n+            throw new UDFArgumentException(error);\n+          }\n+          String type = oiTypeInfo0.getTypeName();\n+          if (oiTypeInfo0.equals(TypeInfoFactory.longTypeInfo)) {\n+            type = oiTypeInfo1.getTypeName();\n+          }\n+          console.printError(\"WARNING: Comparing a bigint and a \" + type + \" may result in a loss of precision.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca425983510ee841439e9a9dd83b6e0547501a9"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkxMzAzMg==", "bodyText": "Yes, the variable can be removed by this way, thank you.", "url": "https://github.com/apache/hive/pull/992#discussion_r413913032", "createdAt": "2020-04-23T15:49:06Z", "author": {"login": "dengzhhu653"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/type/TypeCheckProcFactory.java", "diffHunk": "@@ -789,12 +791,25 @@ protected void validateUDF(ASTNode expr, boolean isFunction, TypeCheckCtx ctx, F\n \n         LogHelper console = new LogHelper(LOG);\n \n+        Set<PrimitiveObjectInspector.PrimitiveCategory> unsafeConventionTyps = Sets.newHashSet(\n+            PrimitiveObjectInspector.PrimitiveCategory.STRING,\n+            PrimitiveObjectInspector.PrimitiveCategory.VARCHAR,\n+            PrimitiveObjectInspector.PrimitiveCategory.CHAR);\n         // For now, if a bigint is going to be cast to a double throw an error or warning\n-        if ((oiTypeInfo0.equals(TypeInfoFactory.stringTypeInfo) && oiTypeInfo1.equals(TypeInfoFactory.longTypeInfo)) ||\n-            (oiTypeInfo0.equals(TypeInfoFactory.longTypeInfo) && oiTypeInfo1.equals(TypeInfoFactory.stringTypeInfo))) {\n+        if ((oiTypeInfo0 instanceof PrimitiveTypeInfo &&\n+            unsafeConventionTyps.contains(((PrimitiveTypeInfo)oiTypeInfo0).getPrimitiveCategory()) &&\n+            oiTypeInfo1.equals(TypeInfoFactory.longTypeInfo)) || (oiTypeInfo1 instanceof PrimitiveTypeInfo &&\n+            unsafeConventionTyps.contains(((PrimitiveTypeInfo)oiTypeInfo1).getPrimitiveCategory()) &&\n+            oiTypeInfo0.equals(TypeInfoFactory.longTypeInfo))) {\n           String error = StrictChecks.checkTypeSafety(conf);\n-          if (error != null) throw new UDFArgumentException(error);\n-          console.printError(\"WARNING: Comparing a bigint and a string may result in a loss of precision.\");\n+          if (error != null) {\n+            throw new UDFArgumentException(error);\n+          }\n+          String type = oiTypeInfo0.getTypeName();\n+          if (oiTypeInfo0.equals(TypeInfoFactory.longTypeInfo)) {\n+            type = oiTypeInfo1.getTypeName();\n+          }\n+          console.printError(\"WARNING: Comparing a bigint and a \" + type + \" may result in a loss of precision.\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc1MDgyNA=="}, "originalCommit": {"oid": "3ca425983510ee841439e9a9dd83b6e0547501a9"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MTU4ODY1OnYy", "diffSide": "RIGHT", "path": "ql/src/test/results/clientpositive/llap/unsafe_compare.q.out", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxMTo1NzoxNVrOGKleoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNTo1NjowOVrOGKvl_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc1Mjk5Mg==", "bodyText": "I think these both '2882303761517473127' and '2882303761517473276' should fit into char(20) / varchar(20)\nand because of that this result leaves me a bit puzzled; is this row expected with the appid1 = 2882303761517473127 condition?", "url": "https://github.com/apache/hive/pull/992#discussion_r413752992", "createdAt": "2020-04-23T11:57:15Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/test/results/clientpositive/llap/unsafe_compare.q.out", "diffHunk": "@@ -0,0 +1,40 @@\n+PREHOOK: query: CREATE TABLE test_a (appid1 varchar(256),  appid2 char(20))\n+PREHOOK: type: CREATETABLE\n+PREHOOK: Output: database:default\n+PREHOOK: Output: default@test_a\n+POSTHOOK: query: CREATE TABLE test_a (appid1 varchar(256),  appid2 char(20))\n+POSTHOOK: type: CREATETABLE\n+POSTHOOK: Output: database:default\n+POSTHOOK: Output: default@test_a\n+PREHOOK: query: INSERT INTO  test_a VALUES ('2882303761517473127', '2882303761517473127'), ('2882303761517473276','2882303761517473276')\n+PREHOOK: type: QUERY\n+PREHOOK: Input: _dummy_database@_dummy_table\n+PREHOOK: Output: default@test_a\n+POSTHOOK: query: INSERT INTO  test_a VALUES ('2882303761517473127', '2882303761517473127'), ('2882303761517473276','2882303761517473276')\n+POSTHOOK: type: QUERY\n+POSTHOOK: Input: _dummy_database@_dummy_table\n+POSTHOOK: Output: default@test_a\n+POSTHOOK: Lineage: test_a.appid1 SCRIPT []\n+POSTHOOK: Lineage: test_a.appid2 SCRIPT []\n+WARNING: Comparing a bigint and a varchar(256) may result in a loss of precision.\n+PREHOOK: query: SELECT appid1 FROM test_a WHERE appid1 = 2882303761517473127\n+PREHOOK: type: QUERY\n+PREHOOK: Input: default@test_a\n+#### A masked pattern was here ####\n+POSTHOOK: query: SELECT appid1 FROM test_a WHERE appid1 = 2882303761517473127\n+POSTHOOK: type: QUERY\n+POSTHOOK: Input: default@test_a\n+#### A masked pattern was here ####\n+2882303761517473127\n+2882303761517473276", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ca425983510ee841439e9a9dd83b6e0547501a9"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkxODcxNw==", "bodyText": "This test is now removed. The test wants to prove that comparing a bigint and a (var)char may result in a loss of precision,  which produces a confusing result.", "url": "https://github.com/apache/hive/pull/992#discussion_r413918717", "createdAt": "2020-04-23T15:56:09Z", "author": {"login": "dengzhhu653"}, "path": "ql/src/test/results/clientpositive/llap/unsafe_compare.q.out", "diffHunk": "@@ -0,0 +1,40 @@\n+PREHOOK: query: CREATE TABLE test_a (appid1 varchar(256),  appid2 char(20))\n+PREHOOK: type: CREATETABLE\n+PREHOOK: Output: database:default\n+PREHOOK: Output: default@test_a\n+POSTHOOK: query: CREATE TABLE test_a (appid1 varchar(256),  appid2 char(20))\n+POSTHOOK: type: CREATETABLE\n+POSTHOOK: Output: database:default\n+POSTHOOK: Output: default@test_a\n+PREHOOK: query: INSERT INTO  test_a VALUES ('2882303761517473127', '2882303761517473127'), ('2882303761517473276','2882303761517473276')\n+PREHOOK: type: QUERY\n+PREHOOK: Input: _dummy_database@_dummy_table\n+PREHOOK: Output: default@test_a\n+POSTHOOK: query: INSERT INTO  test_a VALUES ('2882303761517473127', '2882303761517473127'), ('2882303761517473276','2882303761517473276')\n+POSTHOOK: type: QUERY\n+POSTHOOK: Input: _dummy_database@_dummy_table\n+POSTHOOK: Output: default@test_a\n+POSTHOOK: Lineage: test_a.appid1 SCRIPT []\n+POSTHOOK: Lineage: test_a.appid2 SCRIPT []\n+WARNING: Comparing a bigint and a varchar(256) may result in a loss of precision.\n+PREHOOK: query: SELECT appid1 FROM test_a WHERE appid1 = 2882303761517473127\n+PREHOOK: type: QUERY\n+PREHOOK: Input: default@test_a\n+#### A masked pattern was here ####\n+POSTHOOK: query: SELECT appid1 FROM test_a WHERE appid1 = 2882303761517473127\n+POSTHOOK: type: QUERY\n+POSTHOOK: Input: default@test_a\n+#### A masked pattern was here ####\n+2882303761517473127\n+2882303761517473276", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc1Mjk5Mg=="}, "originalCommit": {"oid": "3ca425983510ee841439e9a9dd83b6e0547501a9"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 781, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}