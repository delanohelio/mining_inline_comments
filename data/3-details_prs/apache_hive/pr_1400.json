{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MjI2Njg0", "number": 1400, "title": "HIVE-18284: Fix NPE when inserting data with 'distribute by' clause with dynpart sort optimization", "bodyText": "\u2026\n\nWhat changes were proposed in this pull request?\n\nChanges are required in ReduceSinkDeduplication to merge properly the Child reduce sink operator and parent reduce sink operator\nWhy are the changes needed?\n\nA Null Pointer Exception occurs when inserting data with 'distribute by' clause when hive.optimize.sort.dynamic.partition=true we expect the keys to be sorted in the reducer side so that reducers can keep only one record writer open at any time thereby reducing the memory pressure on the reducers (HIVE-6455) , But in case of non-vectorizied , non-llap execution the keys are not sorted and fails with NPE.\nRefer: https://issues.apache.org/jira/browse/HIVE-18284?focusedCommentId=17173124&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-17173124\nCaused due to: https://issues.apache.org/jira/browse/HIVE-13260\nDoes this PR introduce any user-facing change?\n\nNo\nHow was this patch tested?\n\nAdded a qtest", "createdAt": "2020-08-13T08:17:53Z", "url": "https://github.com/apache/hive/pull/1400", "merged": true, "mergeCommit": {"oid": "5d735c20ffb6a8624382155a3e90e650db2fb80e"}, "closed": true, "closedAt": "2021-01-21T16:57:14Z", "author": {"login": "shameersss1"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDUBB3AFqTQ3NzY3NjEzMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdyQObEgH2gAyNDY3MjI2Njg0OjBhY2JmZjMyMDMwNjE5Yzk4MmI4OTYxZDI1Y2UxNmUxOWJjZTVjZDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3Njc2MTMx", "url": "https://github.com/apache/hive/pull/1400#pullrequestreview-477676131", "createdAt": "2020-08-28T12:11:30Z", "commit": {"oid": "1ac7b0f70e07faa87ce75669d65040f983027a6e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMjoxMTozMFrOHJAyNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxMjoxNTo1MFrOHJBFFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTIxMjA4Nw==", "bodyText": "I think we should be merging the child into the parent inside this \"if\" - and we have 2  specific conditionals which are handled - so I think an else false here would be needed - to close down unhandled future cases", "url": "https://github.com/apache/hive/pull/1400#discussion_r479212087", "createdAt": "2020-08-28T12:11:30Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/correlation/ReduceSinkDeDuplicationUtils.java", "diffHunk": "@@ -181,6 +183,23 @@ public static boolean merge(HiveConf hiveConf, ReduceSinkOperator cRS, ReduceSin\n         TableDesc keyTable = PlanUtils.getReduceKeyTableDesc(new ArrayList<FieldSchema>(), pRS\n             .getConf().getOrder(), pRS.getConf().getNullOrder());\n         pRS.getConf().setKeySerializeInfo(keyTable);\n+      } else if (cRS.getConf().getKeyCols() != null && cRS.getConf().getKeyCols().size() > 0) {\n+        ArrayList<String> keyColNames = Lists.newArrayList();\n+        for (ExprNodeDesc keyCol : pRS.getConf().getKeyCols()) {\n+          String keyColName = keyCol.getExprString();\n+          keyColNames.add(keyColName);\n+        }\n+        List<FieldSchema> fields = PlanUtils.getFieldSchemasFromColumnList(pRS.getConf().getKeyCols(),\n+            keyColNames, 0, \"\");\n+        TableDesc keyTable = PlanUtils.getReduceKeyTableDesc(fields, pRS.getConf().getOrder(),\n+            pRS.getConf().getNullOrder());\n+        ArrayList<String> outputKeyCols = Lists.newArrayList();\n+        for (int i = 0; i < fields.size(); i++) {\n+          outputKeyCols.add(fields.get(i).getName());\n+        }\n+        pRS.getConf().setOutputKeyColumnNames(outputKeyCols);\n+        pRS.getConf().setKeySerializeInfo(keyTable);\n+        pRS.getConf().setNumDistributionKeys(cRS.getConf().getNumDistributionKeys());\n       }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ac7b0f70e07faa87ce75669d65040f983027a6e"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTIxNjkxNw==", "bodyText": "don't we need any conditional on pRS here?", "url": "https://github.com/apache/hive/pull/1400#discussion_r479216917", "createdAt": "2020-08-28T12:15:50Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/correlation/ReduceSinkDeDuplicationUtils.java", "diffHunk": "@@ -181,6 +183,23 @@ public static boolean merge(HiveConf hiveConf, ReduceSinkOperator cRS, ReduceSin\n         TableDesc keyTable = PlanUtils.getReduceKeyTableDesc(new ArrayList<FieldSchema>(), pRS\n             .getConf().getOrder(), pRS.getConf().getNullOrder());\n         pRS.getConf().setKeySerializeInfo(keyTable);\n+      } else if (cRS.getConf().getKeyCols() != null && cRS.getConf().getKeyCols().size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ac7b0f70e07faa87ce75669d65040f983027a6e"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NTc5OTk1", "url": "https://github.com/apache/hive/pull/1400#pullrequestreview-519579995", "createdAt": "2020-10-29T11:44:21Z", "commit": {"oid": "1ac7b0f70e07faa87ce75669d65040f983027a6e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NTgwODQz", "url": "https://github.com/apache/hive/pull/1400#pullrequestreview-519580843", "createdAt": "2020-10-29T11:45:37Z", "commit": {"oid": "1ac7b0f70e07faa87ce75669d65040f983027a6e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMTo0NTozOFrOHqYD4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMTo0NTozOFrOHqYD4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5NjQ1MQ==", "bodyText": "do we need to run this test with minitez - or it may run with minillaplocal?", "url": "https://github.com/apache/hive/pull/1400#discussion_r514196451", "createdAt": "2020-10-29T11:45:38Z", "author": {"login": "kgyrtkirk"}, "path": "itests/src/test/resources/testconfiguration.properties", "diffHunk": "@@ -6,6 +6,7 @@ minimr.query.files=\\\n \n # Queries ran by both MiniLlapLocal and MiniTez\n minitez.query.files.shared=\\\n+  dynpart_sort_optimization_distribute_by.q,\\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ac7b0f70e07faa87ce75669d65040f983027a6e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bf9c6647bdedd15fcedce92508ea447cbbece1d", "author": {"user": {"login": "srahman-qubole", "name": "Syed Shameerur Rahman"}}, "url": "https://github.com/apache/hive/commit/4bf9c6647bdedd15fcedce92508ea447cbbece1d", "committedDate": "2021-01-18T05:09:58Z", "message": "HIVE-18284: Fix NPE when inserting data with 'distribute by' clause with dynpart sort optimization"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e521b4487a67418115986822c39bc4fd86277b54", "author": {"user": {"login": "kgyrtkirk", "name": "Zoltan Haindrich"}}, "url": "https://github.com/apache/hive/commit/e521b4487a67418115986822c39bc4fd86277b54", "committedDate": "2021-01-04T12:36:57Z", "message": "Merge branch 'master' into HIVE-18284"}, "afterCommit": {"oid": "4bf9c6647bdedd15fcedce92508ea447cbbece1d", "author": {"user": {"login": "srahman-qubole", "name": "Syed Shameerur Rahman"}}, "url": "https://github.com/apache/hive/commit/4bf9c6647bdedd15fcedce92508ea447cbbece1d", "committedDate": "2021-01-18T05:09:58Z", "message": "HIVE-18284: Fix NPE when inserting data with 'distribute by' clause with dynpart sort optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0acbff32030619c982b8961d25ce16e19bce5cd6", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/0acbff32030619c982b8961d25ce16e19bce5cd6", "committedDate": "2021-01-21T08:27:41Z", "message": "Fix qtest failure"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3453, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}