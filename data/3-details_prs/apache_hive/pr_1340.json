{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MzYwOTE4", "number": 1340, "title": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading", "bodyText": "", "createdAt": "2020-07-30T16:19:58Z", "url": "https://github.com/apache/hive/pull/1340", "merged": true, "mergeCommit": {"oid": "ee186af06e552bdb9790a783c3b0ff65953171e6"}, "closed": true, "closedAt": "2020-08-04T11:29:40Z", "author": {"login": "maheshk114"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6WiSRgBqjM2MDkyMTU2Njk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7hPqFgBqjM2MTg4NTg2NzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d4b4673fa2bf0dadba6d3afba7d289150ce8efb", "author": {"user": {"login": "maheshk114", "name": "mahesh kumar behera"}}, "url": "https://github.com/apache/hive/commit/0d4b4673fa2bf0dadba6d3afba7d289150ce8efb", "committedDate": "2020-07-31T03:04:07Z", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name"}, "afterCommit": {"oid": "f379d93e38532be318bbab59e41cd4cae795c643", "author": {"user": {"login": "maheshk114", "name": "mahesh kumar behera"}}, "url": "https://github.com/apache/hive/commit/f379d93e38532be318bbab59e41cd4cae795c643", "committedDate": "2020-07-31T16:08:45Z", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f379d93e38532be318bbab59e41cd4cae795c643", "author": {"user": {"login": "maheshk114", "name": "mahesh kumar behera"}}, "url": "https://github.com/apache/hive/commit/f379d93e38532be318bbab59e41cd4cae795c643", "committedDate": "2020-07-31T16:08:45Z", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name"}, "afterCommit": {"oid": "6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d", "author": {"user": {"login": "maheshk114", "name": "mahesh kumar behera"}}, "url": "https://github.com/apache/hive/commit/6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d", "committedDate": "2020-08-01T04:27:21Z", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTE0Njc2", "url": "https://github.com/apache/hive/pull/1340#pullrequestreview-460514676", "createdAt": "2020-08-04T05:55:06Z", "commit": {"oid": "6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNTo1NTowNlrOG7SHIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNTo1NjowNFrOG7SILw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgxNTkwNQ==", "bodyText": "Can you add TODO or a followup ticket that would replace this string with actual TaskCounter enum from tez (in next subsequent tez release) ?", "url": "https://github.com/apache/hive/pull/1340#discussion_r464815905", "createdAt": "2020-08-04T05:55:06Z", "author": {"login": "rbalamohan"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/exec/vector/mapjoin/fast/VectorMapJoinFastHashTableLoader.java", "diffHunk": "@@ -125,13 +126,24 @@ public void load(MapJoinTableContainer[] mapJoinTables,\n         KeyValueReader kvReader = (KeyValueReader) input.getReader();\n \n         Long keyCountObj = parentKeyCounts.get(pos);\n-        long keyCount = (keyCountObj == null) ? -1 : keyCountObj.longValue();\n+        long estKeyCount = (keyCountObj == null) ? -1 : keyCountObj;\n+\n+        long inputRecords = -1;\n+        try {\n+          inputRecords = ((AbstractLogicalInput) input).getContext().getCounters().", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgxNjE3NQ==", "bodyText": "Can you add \"delta\" (line 171) in the log as well, to have details on the hash table load time?", "url": "https://github.com/apache/hive/pull/1340#discussion_r464816175", "createdAt": "2020-08-04T05:56:04Z", "author": {"login": "rbalamohan"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/exec/vector/mapjoin/fast/VectorMapJoinFastHashTableLoader.java", "diffHunk": "@@ -125,13 +126,24 @@ public void load(MapJoinTableContainer[] mapJoinTables,\n         KeyValueReader kvReader = (KeyValueReader) input.getReader();\n \n         Long keyCountObj = parentKeyCounts.get(pos);\n-        long keyCount = (keyCountObj == null) ? -1 : keyCountObj.longValue();\n+        long estKeyCount = (keyCountObj == null) ? -1 : keyCountObj;\n+\n+        long inputRecords = -1;\n+        try {\n+          inputRecords = ((AbstractLogicalInput) input).getContext().getCounters().\n+                  findCounter(\"org.apache.tez.common.counters.TaskCounter\",\n+                          \"APPROXIMATE_INPUT_RECORDS\").getValue();\n+        } catch (Exception e) {\n+          LOG.debug(\"Failed to get value for counter APPROXIMATE_INPUT_RECORDS\", e);\n+        }\n+        long keyCount = Math.max(estKeyCount, inputRecords);\n \n         VectorMapJoinFastTableContainer vectorMapJoinFastTableContainer =\n                 new VectorMapJoinFastTableContainer(desc, hconf, keyCount);\n \n-        LOG.info(\"Loading hash table for input: {} cacheKey: {} tableContainer: {} smallTablePos: {}\", inputName,\n-          cacheKey, vectorMapJoinFastTableContainer.getClass().getSimpleName(), pos);\n+        LOG.info(\"Loading hash table for input: {} cacheKey: {} tableContainer: {} smallTablePos: {} \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a0af20bbb873b56c72132bfcc23124a92011400", "author": {"user": {"login": "maheshk114", "name": "mahesh kumar behera"}}, "url": "https://github.com/apache/hive/commit/1a0af20bbb873b56c72132bfcc23124a92011400", "committedDate": "2020-08-04T07:11:00Z", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e01811d75420caf76aa0f3e9d8f3cf33446b7de", "author": {"user": {"login": "maheshk114", "name": "mahesh kumar behera"}}, "url": "https://github.com/apache/hive/commit/9e01811d75420caf76aa0f3e9d8f3cf33446b7de", "committedDate": "2020-08-04T07:11:00Z", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e6aca60301c11f0713bc57fbb7eb35389387e7d", "author": {"user": {"login": "maheshk114", "name": "mahesh kumar behera"}}, "url": "https://github.com/apache/hive/commit/6e6aca60301c11f0713bc57fbb7eb35389387e7d", "committedDate": "2020-08-04T07:11:00Z", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d", "author": {"user": {"login": "maheshk114", "name": "mahesh kumar behera"}}, "url": "https://github.com/apache/hive/commit/6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d", "committedDate": "2020-08-01T04:27:21Z", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name"}, "afterCommit": {"oid": "6e6aca60301c11f0713bc57fbb7eb35389387e7d", "author": {"user": {"login": "maheshk114", "name": "mahesh kumar behera"}}, "url": "https://github.com/apache/hive/commit/6e6aca60301c11f0713bc57fbb7eb35389387e7d", "committedDate": "2020-08-04T07:11:00Z", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3389, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}