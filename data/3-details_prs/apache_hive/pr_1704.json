{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NjgyOTQ4", "number": 1704, "title": "HIVE-24424: Use PreparedStatements in DbNotificationListener getNextNLId", "bodyText": "What changes were proposed in this pull request?\n\nWhy are the changes needed?\n\nDoes this PR introduce any user-facing change?\n\nHow was this patch tested?", "createdAt": "2020-11-24T18:41:50Z", "url": "https://github.com/apache/hive/pull/1704", "merged": true, "mergeCommit": {"oid": "f0814f02f102586b44991aaaa47ceedd7c7c0d1e"}, "closed": true, "closedAt": "2020-11-30T18:20:32Z", "author": {"login": "belugabehr"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgQiDIgFqTUzOTE5Mzk3NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhnk8PgFqTU0MTA1MjkyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MTkzOTc0", "url": "https://github.com/apache/hive/pull/1704#pullrequestreview-539193974", "createdAt": "2020-11-26T10:38:29Z", "commit": {"oid": "5d8eb8880fc37acba1223db33c897d67b9d61026"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MjE3MTI3", "url": "https://github.com/apache/hive/pull/1704#pullrequestreview-539217127", "createdAt": "2020-11-26T11:08:43Z", "commit": {"oid": "5d8eb8880fc37acba1223db33c897d67b9d61026"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTowODo0M1rOH6WuSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTowODo0M1rOH6WuSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk1MTc1Mg==", "bodyText": "These two are constants, please extract them.", "url": "https://github.com/apache/hive/pull/1704#discussion_r530951752", "createdAt": "2020-11-26T11:08:43Z", "author": {"login": "miklosgergely"}, "path": "hcatalog/server-extensions/src/main/java/org/apache/hive/hcatalog/listener/DbNotificationListener.java", "diffHunk": "@@ -970,28 +971,44 @@ private static void close(ResultSet rs) {\n     }\n   }\n \n-  private long getNextNLId(Statement stmt, SQLGenerator sqlGenerator, String sequence)\n+  /**\n+   * Get the next notification log ID.\n+   *\n+   * @return The next ID to use for a notification log message\n+   * @throws SQLException if a database access error occurs or this method is\n+   *           called on a closed connection\n+   * @throws MetaException if the sequence table is not properly initialized\n+   */\n+  private long getNextNLId(Connection con, SQLGenerator sqlGenerator, String sequence)\n           throws SQLException, MetaException {\n-    String s = sqlGenerator.addForUpdateClause(\"select \\\"NEXT_VAL\\\" from \" +\n-            \"\\\"SEQUENCE_TABLE\\\" where \\\"SEQUENCE_NAME\\\" = \" + quoteString(sequence));\n-    LOG.debug(\"Going to execute query <\" + s + \">\");\n-    ResultSet rs = null;\n-    try {\n-      rs = stmt.executeQuery(s);\n-      if (!rs.next()) {\n-        throw new MetaException(\"Transaction database not properly configured, can't find next NL id.\");\n+    final String seq_sql = \"select \\\"NEXT_VAL\\\" from \\\"SEQUENCE_TABLE\\\" where \\\"SEQUENCE_NAME\\\" = ?\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d8eb8880fc37acba1223db33c897d67b9d61026"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MjE3NDc5", "url": "https://github.com/apache/hive/pull/1704#pullrequestreview-539217479", "createdAt": "2020-11-26T11:09:13Z", "commit": {"oid": "5d8eb8880fc37acba1223db33c897d67b9d61026"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTowOToxM1rOH6WvXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTowOToxM1rOH6WvXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk1MjAyOQ==", "bodyText": "Please use camelCase for variables within a function.", "url": "https://github.com/apache/hive/pull/1704#discussion_r530952029", "createdAt": "2020-11-26T11:09:13Z", "author": {"login": "miklosgergely"}, "path": "hcatalog/server-extensions/src/main/java/org/apache/hive/hcatalog/listener/DbNotificationListener.java", "diffHunk": "@@ -970,28 +971,44 @@ private static void close(ResultSet rs) {\n     }\n   }\n \n-  private long getNextNLId(Statement stmt, SQLGenerator sqlGenerator, String sequence)\n+  /**\n+   * Get the next notification log ID.\n+   *\n+   * @return The next ID to use for a notification log message\n+   * @throws SQLException if a database access error occurs or this method is\n+   *           called on a closed connection\n+   * @throws MetaException if the sequence table is not properly initialized\n+   */\n+  private long getNextNLId(Connection con, SQLGenerator sqlGenerator, String sequence)\n           throws SQLException, MetaException {\n-    String s = sqlGenerator.addForUpdateClause(\"select \\\"NEXT_VAL\\\" from \" +\n-            \"\\\"SEQUENCE_TABLE\\\" where \\\"SEQUENCE_NAME\\\" = \" + quoteString(sequence));\n-    LOG.debug(\"Going to execute query <\" + s + \">\");\n-    ResultSet rs = null;\n-    try {\n-      rs = stmt.executeQuery(s);\n-      if (!rs.next()) {\n-        throw new MetaException(\"Transaction database not properly configured, can't find next NL id.\");\n+    final String seq_sql = \"select \\\"NEXT_VAL\\\" from \\\"SEQUENCE_TABLE\\\" where \\\"SEQUENCE_NAME\\\" = ?\";\n+    final String upd_sql = \"update \\\"SEQUENCE_TABLE\\\" set \\\"NEXT_VAL\\\" = ? where \\\"SEQUENCE_NAME\\\" = ?\";\n+\n+    final String sou_sql = sqlGenerator.addForUpdateClause(seq_sql);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d8eb8880fc37acba1223db33c897d67b9d61026"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7615970382e4df5d530c975d78c8ef624822751", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/a7615970382e4df5d530c975d78c8ef624822751", "committedDate": "2020-11-26T16:10:12Z", "message": "Extract static values. Fix CamelCase. Enhance loggig."}, "afterCommit": {"oid": "6a72369d6dea71eab6e6ee3f8c64164fdab39aea", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/6a72369d6dea71eab6e6ee3f8c64164fdab39aea", "committedDate": "2020-11-27T00:10:23Z", "message": "Extract static values. Fix CamelCase. Enhance loggig."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "535fa46cadeeb59f4afff1096c8b3616601e91b4", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/535fa46cadeeb59f4afff1096c8b3616601e91b4", "committedDate": "2020-11-30T14:43:49Z", "message": "HIVE-24424: Use PreparedStatements in DbNotificationListener getNextNLId"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7493861c67d8a1796cc85212ca44d4da26848d4", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/b7493861c67d8a1796cc85212ca44d4da26848d4", "committedDate": "2020-11-30T14:43:49Z", "message": "Return the next log id, not next-next. Add JavaDocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93490035a3084dcbc2f77e147ac4c71d9d6d140b", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/93490035a3084dcbc2f77e147ac4c71d9d6d140b", "committedDate": "2020-11-30T14:43:49Z", "message": "Extract static values. Fix CamelCase. Enhance loggig."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a72369d6dea71eab6e6ee3f8c64164fdab39aea", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/6a72369d6dea71eab6e6ee3f8c64164fdab39aea", "committedDate": "2020-11-27T00:10:23Z", "message": "Extract static values. Fix CamelCase. Enhance loggig."}, "afterCommit": {"oid": "93490035a3084dcbc2f77e147ac4c71d9d6d140b", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/93490035a3084dcbc2f77e147ac4c71d9d6d140b", "committedDate": "2020-11-30T14:43:49Z", "message": "Extract static values. Fix CamelCase. Enhance loggig."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMDUyOTI3", "url": "https://github.com/apache/hive/pull/1704#pullrequestreview-541052927", "createdAt": "2020-11-30T16:03:23Z", "commit": {"oid": "93490035a3084dcbc2f77e147ac4c71d9d6d140b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3074, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}