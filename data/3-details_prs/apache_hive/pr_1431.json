{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczMTE1OTA4", "number": 1431, "title": "HIVE-24061: Improve llap task scheduling for better cache hit rate", "bodyText": "https://issues.apache.org/jira/browse/HIVE-24061\nChanges:\n\nAdjust locality delay when the task is getting scheduled.\nReset locality delay when all nodes in the cluster are busy and wouldn't be able to schedule tasks.\nOptimize schedulePendingTasks to exit early, when all nodes are busy. This helps in reducing lock contention as well.\n\nPatch was tested on a medium scale cluster and observed good improvement in runtime of queries.", "createdAt": "2020-08-25T10:50:36Z", "url": "https://github.com/apache/hive/pull/1431", "merged": true, "mergeCommit": {"oid": "13ac9cd8979b28069b62589b7b6aa2784753ffdc"}, "closed": true, "closedAt": "2020-08-26T17:52:27Z", "author": {"login": "rbalamohan"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCU5DRAH2gAyNDczMTE1OTA4OjIyYmIwNmI1YWNiMjRkNDhjMDBmNzE5YTU1MDZhNDg4MGIzMjBlMWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCg4wFAH2gAyNDczMTE1OTA4OmQyNThmNTdmZWM0MjczMWI2MmU2Yzk5OWYwMDg5NzVlZThiNTBlYmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "22bb06b5acb24d48c00f719a5506a4880b320e1a", "author": {"user": {"login": "rbalamohan", "name": null}}, "url": "https://github.com/apache/hive/commit/22bb06b5acb24d48c00f719a5506a4880b320e1a", "committedDate": "2020-08-25T10:45:30Z", "message": "HIVE-24061: Improve llap task scheduling for better cache hit rate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3afd9c81db76c140a635a950b8e3e39c01f4a7b5", "author": {"user": {"login": "rbalamohan", "name": null}}, "url": "https://github.com/apache/hive/commit/3afd9c81db76c140a635a950b8e3e39c01f4a7b5", "committedDate": "2020-08-25T15:01:09Z", "message": "HIVE-24061: Improve llap task scheduling for better cache hit rate"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NzA5MzUz", "url": "https://github.com/apache/hive/pull/1431#pullrequestreview-474709353", "createdAt": "2020-08-25T17:38:15Z", "commit": {"oid": "3afd9c81db76c140a635a950b8e3e39c01f4a7b5"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzozODoxNlrOHGi4TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzo0Mzo1NlrOHGjEzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNDk3Mg==", "bodyText": "nit: to differentiate node vs cluster, rename this to isClusterCapacityFull?", "url": "https://github.com/apache/hive/pull/1431#discussion_r476624972", "createdAt": "2020-08-25T17:38:16Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskSchedulerService.java", "diffHunk": "@@ -251,6 +251,7 @@ public void setError(Void v, Throwable t) {\n \n   private final Lock scheduleLock = new ReentrantLock();\n   private final Condition scheduleCondition = scheduleLock.newCondition();\n+  private final AtomicBoolean isCapacityFull = new AtomicBoolean(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3afd9c81db76c140a635a950b8e3e39c01f4a7b5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNjExMA==", "bodyText": "the condition seems to have flipped here. is this expected?", "url": "https://github.com/apache/hive/pull/1431#discussion_r476626110", "createdAt": "2020-08-25T17:40:15Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskSchedulerService.java", "diffHunk": "@@ -1390,7 +1395,7 @@ private SelectHostResult selectHost(TaskInfo request) {\n       boolean shouldDelayForLocality = request.shouldDelayForLocality(schedulerAttemptTime);\n       LOG.debug(\"ShouldDelayForLocality={} for task={} on hosts={}\", shouldDelayForLocality,\n           request.task, requestedHostsDebugStr);\n-      if (requestedHosts != null && requestedHosts.length > 0) {\n+      if (!isRequestedHostPresent(request)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3afd9c81db76c140a635a950b8e3e39c01f4a7b5"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNjgwMg==", "bodyText": "isCapacityFull can be set to false in else condition here? instead of trySchedulingPendingTasks.. just a minor readability improvement..", "url": "https://github.com/apache/hive/pull/1431#discussion_r476626802", "createdAt": "2020-08-25T17:41:30Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskSchedulerService.java", "diffHunk": "@@ -1487,6 +1492,14 @@ private SelectHostResult selectHost(TaskInfo request) {\n         return SELECT_HOST_RESULT_DELAYED_RESOURCES;\n       }\n \n+      // When all nodes are busy, reset locality delay\n+      if (activeNodesWithFreeSlots.isEmpty()) {\n+        isCapacityFull.set(true);\n+        if (request.localityDelayTimeout > 0 && isRequestedHostPresent(request)) {\n+          request.resetLocalityDelayInfo();\n+        }\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3afd9c81db76c140a635a950b8e3e39c01f4a7b5"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyODE3NQ==", "bodyText": "This can be outer if condition? only if cluster capacity is available run the task iterator.", "url": "https://github.com/apache/hive/pull/1431#discussion_r476628175", "createdAt": "2020-08-25T17:43:56Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskSchedulerService.java", "diffHunk": "@@ -1817,8 +1830,10 @@ protected void schedulePendingTasks() throws InterruptedException {\n         Iterator<TaskInfo> taskIter = taskListAtPriority.iterator();\n         boolean scheduledAllAtPriority = true;\n         while (taskIter.hasNext()) {\n-          // TODO Optimization: Add a check to see if there's any capacity available. No point in\n-          // walking through all active nodes, if they don't have potential capacity.\n+          // Early exit where there are no slots available\n+          if (isCapacityFull.get()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3afd9c81db76c140a635a950b8e3e39c01f4a7b5"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f1e0cf4d2d5a3ac8a33a5247c6285137c54f31c", "author": {"user": {"login": "rbalamohan", "name": null}}, "url": "https://github.com/apache/hive/commit/2f1e0cf4d2d5a3ac8a33a5247c6285137c54f31c", "committedDate": "2020-08-25T22:18:57Z", "message": "HIVE-24061: Improve llap task scheduling for better cache hit rate"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MDU3ODcy", "url": "https://github.com/apache/hive/pull/1431#pullrequestreview-475057872", "createdAt": "2020-08-25T23:44:33Z", "commit": {"oid": "2f1e0cf4d2d5a3ac8a33a5247c6285137c54f31c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d258f57fec42731b62e6c999f008975ee8b50ebb", "author": {"user": {"login": "rbalamohan", "name": null}}, "url": "https://github.com/apache/hive/commit/d258f57fec42731b62e6c999f008975ee8b50ebb", "committedDate": "2020-08-26T00:44:02Z", "message": "HIVE-24061: Improve llap task scheduling for better cache hit rate"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3243, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}