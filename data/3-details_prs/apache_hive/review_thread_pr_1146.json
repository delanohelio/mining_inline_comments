{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2MjUxNjc3", "number": 1146, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMDo1NjozOVrOEGs3Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNTo1Njo1NFrOEIOkrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1NDYxOTYyOnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/DriverFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMDo1NjozOVrOGlqNVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxMDo1NjozOVrOGlqNVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE0MjAzNg==", "bodyText": "Could you please describe it briefly this in ConfVars.HIVE_QUERY_REEXECUTION_STRATEGIES?\n...and I think you may enable this plugin by default", "url": "https://github.com/apache/hive/pull/1146#discussion_r442142036", "createdAt": "2020-06-18T10:56:39Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/DriverFactory.java", "diffHunk": "@@ -64,6 +65,9 @@ private static IReExecutionPlugin buildReExecPlugin(String name) throws RuntimeE\n     if (name.equals(\"reoptimize\")) {\n       return new ReOptimizePlugin();\n     }\n+    if(name.equals(\"reexecutelostam\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5296258efd04ce3852d48fc95b542777892c675a"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2ODk4MDAzOnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/reexec/ReExecuteLostAMQueryPlugin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzo0MjozM1rOGnz6Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzo0MjozM1rOGnz6Ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5ODEzOQ==", "bodyText": "In Hive code, we follow 2 spaced tabs. Pls update it in newly created files in this patch.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444398139", "createdAt": "2020-06-23T17:42:33Z", "author": {"login": "sankarh"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/reexec/ReExecuteLostAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.hive.ql.Driver;\n+import org.apache.hadoop.hive.ql.hooks.ExecuteWithHookContext;\n+import org.apache.hadoop.hive.ql.hooks.HookContext;\n+import org.apache.hadoop.hive.ql.plan.mapper.PlanMapper;\n+\n+import java.util.regex.Pattern;\n+\n+public class ReExecuteLostAMQueryPlugin implements IReExecutionPlugin {\n+    private boolean retryPossible;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTAxODA5OnYy", "diffSide": "RIGHT", "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzo1Mjo0N1rOGn0SHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNTozNDo0OFrOGoDiew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQwNDI1NQ==", "bodyText": "Too many blank lines.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444404255", "createdAt": "2020-06-23T17:52:47Z", "author": {"login": "sankarh"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.llap.LlapBaseInputFormat;\n+import org.apache.hadoop.hive.ql.metadata.HiveException;\n+import org.apache.hadoop.yarn.api.records.ApplicationReport;\n+import org.apache.hadoop.yarn.api.records.YarnApplicationState;\n+import org.apache.hadoop.yarn.client.api.YarnClient;\n+import org.apache.hive.jdbc.BaseJdbcWithMiniLlap;\n+import org.apache.hive.jdbc.HiveStatement;\n+import org.apache.hive.jdbc.TestJdbcWithMiniLlapArrow;\n+import org.apache.hive.jdbc.miniHS2.MiniHS2;\n+import org.junit.*;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.net.URL;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public class TestReExecuteKilledTezAMQueryPlugin {\n+    protected static final Logger LOG = LoggerFactory.getLogger(TestJdbcWithMiniLlapArrow.class);\n+\n+    private static MiniHS2 miniHS2 = null;\n+    private static final String tableName = \"testKillTezAmTbl\";\n+    private static String dataFileDir;\n+    private static final String testDbName = \"testKillTezAmDb\";\n+    protected static Connection hs2Conn = null;\n+    private static HiveConf conf;\n+\n+    private static class ExceptionHolder {\n+        Throwable throwable;\n+    }\n+\n+    static HiveConf defaultConf() throws Exception {\n+        String confDir = \"../../data/conf/llap/\";\n+        if (confDir != null && !confDir.isEmpty()) {\n+            HiveConf.setHiveSiteLocation(new URL(\"file://\"+ new File(confDir).toURI().getPath() + \"/hive-site.xml\"));\n+            System.out.println(\"Setting hive-site: \" + HiveConf.getHiveSiteLocation());\n+        }\n+        HiveConf defaultConf = new HiveConf();\n+        defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SUPPORT_CONCURRENCY, false);\n+        defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SERVER2_ENABLE_DOAS, false);\n+        defaultConf.addResource(new URL(\"file://\" + new File(confDir).toURI().getPath() + \"/tez-site.xml\"));\n+        return defaultConf;\n+    }\n+\n+    @BeforeClass\n+    public static void beforeTest() throws Exception {\n+        conf = defaultConf();\n+        conf.setVar(HiveConf.ConfVars.USERS_IN_ADMIN_ROLE, System.getProperty(\"user.name\"));\n+        conf.set(HiveConf.ConfVars.HIVE_QUERY_REEXECUTION_STRATEGIES.varname, \"reexecute_lost_am\");\n+        MiniHS2.cleanupLocalDir();\n+        Class.forName(MiniHS2.getJdbcDriverName());\n+        miniHS2 = new MiniHS2(conf, MiniHS2.MiniClusterType.LLAP);\n+        dataFileDir = conf.get(\"test.data.files\").replace('\\\\', '/').replace(\"c:\", \"\");\n+        Map<String, String> confOverlay = new HashMap<String, String>();\n+        miniHS2.start(confOverlay);\n+        miniHS2.getDFS().getFileSystem().mkdirs(new Path(\"/apps_staging_dir/anonymous\"));\n+\n+        Connection conDefault = getConnection(miniHS2.getJdbcURL(),\n+                System.getProperty(\"user.name\"), \"bar\");\n+        Statement stmt = conDefault.createStatement();\n+        String tblName = testDbName + \".\" + tableName;\n+        Path dataFilePath = new Path(dataFileDir, \"kv1.txt\");\n+        String udfName = TestJdbcWithMiniLlapArrow.SleepMsUDF.class.getName();\n+        stmt.execute(\"drop database if exists \" + testDbName + \" cascade\");\n+        stmt.execute(\"create database \" + testDbName);\n+        stmt.execute(\"set role admin\");\n+        stmt.execute(\"dfs -put \" + dataFilePath.toString() + \" \" + \"kv1.txt\");\n+        stmt.execute(\"use \" + testDbName);\n+        stmt.execute(\"create table \" + tblName + \" (int_col int, value string) \");\n+        stmt.execute(\"load data inpath 'kv1.txt' into table \" + tblName);\n+        stmt.execute(\"create function sleepMsUDF as '\" + udfName + \"'\");\n+        stmt.execute(\"grant select on table \" + tblName + \" to role public\");\n+\n+        stmt.close();\n+        conDefault.close();\n+    }\n+\n+    @AfterClass\n+    public static void afterTest() {\n+        if (miniHS2 != null && miniHS2.isStarted()) {\n+            miniHS2.stop();\n+        }\n+    }\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        hs2Conn = getConnection(miniHS2.getJdbcURL(), System.getProperty(\"user.name\"), \"bar\");\n+    }\n+\n+    public static Connection getConnection(String jdbcURL, String user, String pwd) throws SQLException {\n+        Connection conn = DriverManager.getConnection(jdbcURL, user, pwd);\n+        conn.createStatement().execute(\"set hive.support.concurrency = false\");\n+        return conn;\n+    }\n+\n+    @After\n+    public void tearDown() throws Exception {\n+        LlapBaseInputFormat.closeAll();\n+        hs2Conn.close();\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 130}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY1NDIwMw==", "bodyText": "fixed.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444654203", "createdAt": "2020-06-24T05:34:48Z", "author": {"login": "adesh-rao"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.llap.LlapBaseInputFormat;\n+import org.apache.hadoop.hive.ql.metadata.HiveException;\n+import org.apache.hadoop.yarn.api.records.ApplicationReport;\n+import org.apache.hadoop.yarn.api.records.YarnApplicationState;\n+import org.apache.hadoop.yarn.client.api.YarnClient;\n+import org.apache.hive.jdbc.BaseJdbcWithMiniLlap;\n+import org.apache.hive.jdbc.HiveStatement;\n+import org.apache.hive.jdbc.TestJdbcWithMiniLlapArrow;\n+import org.apache.hive.jdbc.miniHS2.MiniHS2;\n+import org.junit.*;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.net.URL;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public class TestReExecuteKilledTezAMQueryPlugin {\n+    protected static final Logger LOG = LoggerFactory.getLogger(TestJdbcWithMiniLlapArrow.class);\n+\n+    private static MiniHS2 miniHS2 = null;\n+    private static final String tableName = \"testKillTezAmTbl\";\n+    private static String dataFileDir;\n+    private static final String testDbName = \"testKillTezAmDb\";\n+    protected static Connection hs2Conn = null;\n+    private static HiveConf conf;\n+\n+    private static class ExceptionHolder {\n+        Throwable throwable;\n+    }\n+\n+    static HiveConf defaultConf() throws Exception {\n+        String confDir = \"../../data/conf/llap/\";\n+        if (confDir != null && !confDir.isEmpty()) {\n+            HiveConf.setHiveSiteLocation(new URL(\"file://\"+ new File(confDir).toURI().getPath() + \"/hive-site.xml\"));\n+            System.out.println(\"Setting hive-site: \" + HiveConf.getHiveSiteLocation());\n+        }\n+        HiveConf defaultConf = new HiveConf();\n+        defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SUPPORT_CONCURRENCY, false);\n+        defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SERVER2_ENABLE_DOAS, false);\n+        defaultConf.addResource(new URL(\"file://\" + new File(confDir).toURI().getPath() + \"/tez-site.xml\"));\n+        return defaultConf;\n+    }\n+\n+    @BeforeClass\n+    public static void beforeTest() throws Exception {\n+        conf = defaultConf();\n+        conf.setVar(HiveConf.ConfVars.USERS_IN_ADMIN_ROLE, System.getProperty(\"user.name\"));\n+        conf.set(HiveConf.ConfVars.HIVE_QUERY_REEXECUTION_STRATEGIES.varname, \"reexecute_lost_am\");\n+        MiniHS2.cleanupLocalDir();\n+        Class.forName(MiniHS2.getJdbcDriverName());\n+        miniHS2 = new MiniHS2(conf, MiniHS2.MiniClusterType.LLAP);\n+        dataFileDir = conf.get(\"test.data.files\").replace('\\\\', '/').replace(\"c:\", \"\");\n+        Map<String, String> confOverlay = new HashMap<String, String>();\n+        miniHS2.start(confOverlay);\n+        miniHS2.getDFS().getFileSystem().mkdirs(new Path(\"/apps_staging_dir/anonymous\"));\n+\n+        Connection conDefault = getConnection(miniHS2.getJdbcURL(),\n+                System.getProperty(\"user.name\"), \"bar\");\n+        Statement stmt = conDefault.createStatement();\n+        String tblName = testDbName + \".\" + tableName;\n+        Path dataFilePath = new Path(dataFileDir, \"kv1.txt\");\n+        String udfName = TestJdbcWithMiniLlapArrow.SleepMsUDF.class.getName();\n+        stmt.execute(\"drop database if exists \" + testDbName + \" cascade\");\n+        stmt.execute(\"create database \" + testDbName);\n+        stmt.execute(\"set role admin\");\n+        stmt.execute(\"dfs -put \" + dataFilePath.toString() + \" \" + \"kv1.txt\");\n+        stmt.execute(\"use \" + testDbName);\n+        stmt.execute(\"create table \" + tblName + \" (int_col int, value string) \");\n+        stmt.execute(\"load data inpath 'kv1.txt' into table \" + tblName);\n+        stmt.execute(\"create function sleepMsUDF as '\" + udfName + \"'\");\n+        stmt.execute(\"grant select on table \" + tblName + \" to role public\");\n+\n+        stmt.close();\n+        conDefault.close();\n+    }\n+\n+    @AfterClass\n+    public static void afterTest() {\n+        if (miniHS2 != null && miniHS2.isStarted()) {\n+            miniHS2.stop();\n+        }\n+    }\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        hs2Conn = getConnection(miniHS2.getJdbcURL(), System.getProperty(\"user.name\"), \"bar\");\n+    }\n+\n+    public static Connection getConnection(String jdbcURL, String user, String pwd) throws SQLException {\n+        Connection conn = DriverManager.getConnection(jdbcURL, user, pwd);\n+        conn.createStatement().execute(\"set hive.support.concurrency = false\");\n+        return conn;\n+    }\n+\n+    @After\n+    public void tearDown() throws Exception {\n+        LlapBaseInputFormat.closeAll();\n+        hs2Conn.close();\n+    }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQwNDI1NQ=="}, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 130}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTAyODk1OnYy", "diffSide": "RIGHT", "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzo1NTo0N1rOGn0ZBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNzo1NTo0N1rOGn0ZBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQwNjAyMQ==", "bodyText": "Do you mean 500*100ms?", "url": "https://github.com/apache/hive/pull/1146#discussion_r444406021", "createdAt": "2020-06-23T17:55:47Z", "author": {"login": "sankarh"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.llap.LlapBaseInputFormat;\n+import org.apache.hadoop.hive.ql.metadata.HiveException;\n+import org.apache.hadoop.yarn.api.records.ApplicationReport;\n+import org.apache.hadoop.yarn.api.records.YarnApplicationState;\n+import org.apache.hadoop.yarn.client.api.YarnClient;\n+import org.apache.hive.jdbc.BaseJdbcWithMiniLlap;\n+import org.apache.hive.jdbc.HiveStatement;\n+import org.apache.hive.jdbc.TestJdbcWithMiniLlapArrow;\n+import org.apache.hive.jdbc.miniHS2.MiniHS2;\n+import org.junit.*;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.net.URL;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public class TestReExecuteKilledTezAMQueryPlugin {\n+    protected static final Logger LOG = LoggerFactory.getLogger(TestJdbcWithMiniLlapArrow.class);\n+\n+    private static MiniHS2 miniHS2 = null;\n+    private static final String tableName = \"testKillTezAmTbl\";\n+    private static String dataFileDir;\n+    private static final String testDbName = \"testKillTezAmDb\";\n+    protected static Connection hs2Conn = null;\n+    private static HiveConf conf;\n+\n+    private static class ExceptionHolder {\n+        Throwable throwable;\n+    }\n+\n+    static HiveConf defaultConf() throws Exception {\n+        String confDir = \"../../data/conf/llap/\";\n+        if (confDir != null && !confDir.isEmpty()) {\n+            HiveConf.setHiveSiteLocation(new URL(\"file://\"+ new File(confDir).toURI().getPath() + \"/hive-site.xml\"));\n+            System.out.println(\"Setting hive-site: \" + HiveConf.getHiveSiteLocation());\n+        }\n+        HiveConf defaultConf = new HiveConf();\n+        defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SUPPORT_CONCURRENCY, false);\n+        defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SERVER2_ENABLE_DOAS, false);\n+        defaultConf.addResource(new URL(\"file://\" + new File(confDir).toURI().getPath() + \"/tez-site.xml\"));\n+        return defaultConf;\n+    }\n+\n+    @BeforeClass\n+    public static void beforeTest() throws Exception {\n+        conf = defaultConf();\n+        conf.setVar(HiveConf.ConfVars.USERS_IN_ADMIN_ROLE, System.getProperty(\"user.name\"));\n+        conf.set(HiveConf.ConfVars.HIVE_QUERY_REEXECUTION_STRATEGIES.varname, \"reexecute_lost_am\");\n+        MiniHS2.cleanupLocalDir();\n+        Class.forName(MiniHS2.getJdbcDriverName());\n+        miniHS2 = new MiniHS2(conf, MiniHS2.MiniClusterType.LLAP);\n+        dataFileDir = conf.get(\"test.data.files\").replace('\\\\', '/').replace(\"c:\", \"\");\n+        Map<String, String> confOverlay = new HashMap<String, String>();\n+        miniHS2.start(confOverlay);\n+        miniHS2.getDFS().getFileSystem().mkdirs(new Path(\"/apps_staging_dir/anonymous\"));\n+\n+        Connection conDefault = getConnection(miniHS2.getJdbcURL(),\n+                System.getProperty(\"user.name\"), \"bar\");\n+        Statement stmt = conDefault.createStatement();\n+        String tblName = testDbName + \".\" + tableName;\n+        Path dataFilePath = new Path(dataFileDir, \"kv1.txt\");\n+        String udfName = TestJdbcWithMiniLlapArrow.SleepMsUDF.class.getName();\n+        stmt.execute(\"drop database if exists \" + testDbName + \" cascade\");\n+        stmt.execute(\"create database \" + testDbName);\n+        stmt.execute(\"set role admin\");\n+        stmt.execute(\"dfs -put \" + dataFilePath.toString() + \" \" + \"kv1.txt\");\n+        stmt.execute(\"use \" + testDbName);\n+        stmt.execute(\"create table \" + tblName + \" (int_col int, value string) \");\n+        stmt.execute(\"load data inpath 'kv1.txt' into table \" + tblName);\n+        stmt.execute(\"create function sleepMsUDF as '\" + udfName + \"'\");\n+        stmt.execute(\"grant select on table \" + tblName + \" to role public\");\n+\n+        stmt.close();\n+        conDefault.close();\n+    }\n+\n+    @AfterClass\n+    public static void afterTest() {\n+        if (miniHS2 != null && miniHS2.isStarted()) {\n+            miniHS2.stop();\n+        }\n+    }\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        hs2Conn = getConnection(miniHS2.getJdbcURL(), System.getProperty(\"user.name\"), \"bar\");\n+    }\n+\n+    public static Connection getConnection(String jdbcURL, String user, String pwd) throws SQLException {\n+        Connection conn = DriverManager.getConnection(jdbcURL, user, pwd);\n+        conn.createStatement().execute(\"set hive.support.concurrency = false\");\n+        return conn;\n+    }\n+\n+    @After\n+    public void tearDown() throws Exception {\n+        LlapBaseInputFormat.closeAll();\n+        hs2Conn.close();\n+    }\n+\n+\n+\n+    @Test\n+    public void testKillQueryById() throws Exception {\n+        String user = System.getProperty(\"user.name\");\n+        Connection con1 = getConnection(miniHS2.getJdbcURL(testDbName),\n+                user, \"bar\");\n+\n+        final HiveStatement stmt = (HiveStatement)con1.createStatement();\n+        final StringBuffer stmtQueryId = new StringBuffer();\n+        ExceptionHolder originalQExHolder = new ExceptionHolder();\n+        originalQExHolder.throwable = null;\n+\n+        // Thread executing the query\n+        Thread tExecute = new Thread(new Runnable() {\n+            @Override\n+            public void run() {\n+                try {\n+                    System.out.println(\"Executing query: \");\n+                    stmt.execute(\"set hive.llap.execution.mode = none\");\n+\n+                    // The test table has 500 rows, so total query time should be ~ 500*500ms", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 152}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTA0NzIzOnYy", "diffSide": "RIGHT", "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODowMDozNlrOGn0kmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODowMDozNlrOGn0kmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQwODk4Nw==", "bodyText": "Shall remove else part if we move rest of the code with break inside \"if\" block.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444408987", "createdAt": "2020-06-23T18:00:36Z", "author": {"login": "sankarh"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.llap.LlapBaseInputFormat;\n+import org.apache.hadoop.hive.ql.metadata.HiveException;\n+import org.apache.hadoop.yarn.api.records.ApplicationReport;\n+import org.apache.hadoop.yarn.api.records.YarnApplicationState;\n+import org.apache.hadoop.yarn.client.api.YarnClient;\n+import org.apache.hive.jdbc.BaseJdbcWithMiniLlap;\n+import org.apache.hive.jdbc.HiveStatement;\n+import org.apache.hive.jdbc.TestJdbcWithMiniLlapArrow;\n+import org.apache.hive.jdbc.miniHS2.MiniHS2;\n+import org.junit.*;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.net.URL;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public class TestReExecuteKilledTezAMQueryPlugin {\n+    protected static final Logger LOG = LoggerFactory.getLogger(TestJdbcWithMiniLlapArrow.class);\n+\n+    private static MiniHS2 miniHS2 = null;\n+    private static final String tableName = \"testKillTezAmTbl\";\n+    private static String dataFileDir;\n+    private static final String testDbName = \"testKillTezAmDb\";\n+    protected static Connection hs2Conn = null;\n+    private static HiveConf conf;\n+\n+    private static class ExceptionHolder {\n+        Throwable throwable;\n+    }\n+\n+    static HiveConf defaultConf() throws Exception {\n+        String confDir = \"../../data/conf/llap/\";\n+        if (confDir != null && !confDir.isEmpty()) {\n+            HiveConf.setHiveSiteLocation(new URL(\"file://\"+ new File(confDir).toURI().getPath() + \"/hive-site.xml\"));\n+            System.out.println(\"Setting hive-site: \" + HiveConf.getHiveSiteLocation());\n+        }\n+        HiveConf defaultConf = new HiveConf();\n+        defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SUPPORT_CONCURRENCY, false);\n+        defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SERVER2_ENABLE_DOAS, false);\n+        defaultConf.addResource(new URL(\"file://\" + new File(confDir).toURI().getPath() + \"/tez-site.xml\"));\n+        return defaultConf;\n+    }\n+\n+    @BeforeClass\n+    public static void beforeTest() throws Exception {\n+        conf = defaultConf();\n+        conf.setVar(HiveConf.ConfVars.USERS_IN_ADMIN_ROLE, System.getProperty(\"user.name\"));\n+        conf.set(HiveConf.ConfVars.HIVE_QUERY_REEXECUTION_STRATEGIES.varname, \"reexecute_lost_am\");\n+        MiniHS2.cleanupLocalDir();\n+        Class.forName(MiniHS2.getJdbcDriverName());\n+        miniHS2 = new MiniHS2(conf, MiniHS2.MiniClusterType.LLAP);\n+        dataFileDir = conf.get(\"test.data.files\").replace('\\\\', '/').replace(\"c:\", \"\");\n+        Map<String, String> confOverlay = new HashMap<String, String>();\n+        miniHS2.start(confOverlay);\n+        miniHS2.getDFS().getFileSystem().mkdirs(new Path(\"/apps_staging_dir/anonymous\"));\n+\n+        Connection conDefault = getConnection(miniHS2.getJdbcURL(),\n+                System.getProperty(\"user.name\"), \"bar\");\n+        Statement stmt = conDefault.createStatement();\n+        String tblName = testDbName + \".\" + tableName;\n+        Path dataFilePath = new Path(dataFileDir, \"kv1.txt\");\n+        String udfName = TestJdbcWithMiniLlapArrow.SleepMsUDF.class.getName();\n+        stmt.execute(\"drop database if exists \" + testDbName + \" cascade\");\n+        stmt.execute(\"create database \" + testDbName);\n+        stmt.execute(\"set role admin\");\n+        stmt.execute(\"dfs -put \" + dataFilePath.toString() + \" \" + \"kv1.txt\");\n+        stmt.execute(\"use \" + testDbName);\n+        stmt.execute(\"create table \" + tblName + \" (int_col int, value string) \");\n+        stmt.execute(\"load data inpath 'kv1.txt' into table \" + tblName);\n+        stmt.execute(\"create function sleepMsUDF as '\" + udfName + \"'\");\n+        stmt.execute(\"grant select on table \" + tblName + \" to role public\");\n+\n+        stmt.close();\n+        conDefault.close();\n+    }\n+\n+    @AfterClass\n+    public static void afterTest() {\n+        if (miniHS2 != null && miniHS2.isStarted()) {\n+            miniHS2.stop();\n+        }\n+    }\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        hs2Conn = getConnection(miniHS2.getJdbcURL(), System.getProperty(\"user.name\"), \"bar\");\n+    }\n+\n+    public static Connection getConnection(String jdbcURL, String user, String pwd) throws SQLException {\n+        Connection conn = DriverManager.getConnection(jdbcURL, user, pwd);\n+        conn.createStatement().execute(\"set hive.support.concurrency = false\");\n+        return conn;\n+    }\n+\n+    @After\n+    public void tearDown() throws Exception {\n+        LlapBaseInputFormat.closeAll();\n+        hs2Conn.close();\n+    }\n+\n+\n+\n+    @Test\n+    public void testKillQueryById() throws Exception {\n+        String user = System.getProperty(\"user.name\");\n+        Connection con1 = getConnection(miniHS2.getJdbcURL(testDbName),\n+                user, \"bar\");\n+\n+        final HiveStatement stmt = (HiveStatement)con1.createStatement();\n+        final StringBuffer stmtQueryId = new StringBuffer();\n+        ExceptionHolder originalQExHolder = new ExceptionHolder();\n+        originalQExHolder.throwable = null;\n+\n+        // Thread executing the query\n+        Thread tExecute = new Thread(new Runnable() {\n+            @Override\n+            public void run() {\n+                try {\n+                    System.out.println(\"Executing query: \");\n+                    stmt.execute(\"set hive.llap.execution.mode = none\");\n+\n+                    // The test table has 500 rows, so total query time should be ~ 500*500ms\n+                    stmt.executeAsync(\"select sleepMsUDF(t1.int_col, 100), t1.int_col, t2.int_col \" +\n+                            \"from \" + tableName + \" t1 join \" + tableName + \" t2 on t1.int_col = t2.int_col\");\n+                    stmtQueryId.append(stmt.getQueryId());\n+                    stmt.getUpdateCount();\n+                } catch (SQLException e) {\n+                    originalQExHolder.throwable = e;\n+                }\n+            }\n+        });\n+\n+        tExecute.start();\n+\n+        // wait for other thread to create the stmt handle\n+        int count = 0;\n+        while (++count <= 10) {\n+                Thread.sleep(2000);\n+                String queryId;\n+                if (stmtQueryId.length() != 0) {\n+                    queryId = stmtQueryId.toString();\n+                } else {\n+                    continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 173}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTA1MzIyOnYy", "diffSide": "RIGHT", "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODowMjoyNlrOGn0oag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODowMjoyNlrOGn0oag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQwOTk2Mg==", "bodyText": "We shall move cleanup code before Assert as it may not execute if Assert throws exception.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444409962", "createdAt": "2020-06-23T18:02:26Z", "author": {"login": "sankarh"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.llap.LlapBaseInputFormat;\n+import org.apache.hadoop.hive.ql.metadata.HiveException;\n+import org.apache.hadoop.yarn.api.records.ApplicationReport;\n+import org.apache.hadoop.yarn.api.records.YarnApplicationState;\n+import org.apache.hadoop.yarn.client.api.YarnClient;\n+import org.apache.hive.jdbc.BaseJdbcWithMiniLlap;\n+import org.apache.hive.jdbc.HiveStatement;\n+import org.apache.hive.jdbc.TestJdbcWithMiniLlapArrow;\n+import org.apache.hive.jdbc.miniHS2.MiniHS2;\n+import org.junit.*;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.net.URL;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public class TestReExecuteKilledTezAMQueryPlugin {\n+    protected static final Logger LOG = LoggerFactory.getLogger(TestJdbcWithMiniLlapArrow.class);\n+\n+    private static MiniHS2 miniHS2 = null;\n+    private static final String tableName = \"testKillTezAmTbl\";\n+    private static String dataFileDir;\n+    private static final String testDbName = \"testKillTezAmDb\";\n+    protected static Connection hs2Conn = null;\n+    private static HiveConf conf;\n+\n+    private static class ExceptionHolder {\n+        Throwable throwable;\n+    }\n+\n+    static HiveConf defaultConf() throws Exception {\n+        String confDir = \"../../data/conf/llap/\";\n+        if (confDir != null && !confDir.isEmpty()) {\n+            HiveConf.setHiveSiteLocation(new URL(\"file://\"+ new File(confDir).toURI().getPath() + \"/hive-site.xml\"));\n+            System.out.println(\"Setting hive-site: \" + HiveConf.getHiveSiteLocation());\n+        }\n+        HiveConf defaultConf = new HiveConf();\n+        defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SUPPORT_CONCURRENCY, false);\n+        defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SERVER2_ENABLE_DOAS, false);\n+        defaultConf.addResource(new URL(\"file://\" + new File(confDir).toURI().getPath() + \"/tez-site.xml\"));\n+        return defaultConf;\n+    }\n+\n+    @BeforeClass\n+    public static void beforeTest() throws Exception {\n+        conf = defaultConf();\n+        conf.setVar(HiveConf.ConfVars.USERS_IN_ADMIN_ROLE, System.getProperty(\"user.name\"));\n+        conf.set(HiveConf.ConfVars.HIVE_QUERY_REEXECUTION_STRATEGIES.varname, \"reexecute_lost_am\");\n+        MiniHS2.cleanupLocalDir();\n+        Class.forName(MiniHS2.getJdbcDriverName());\n+        miniHS2 = new MiniHS2(conf, MiniHS2.MiniClusterType.LLAP);\n+        dataFileDir = conf.get(\"test.data.files\").replace('\\\\', '/').replace(\"c:\", \"\");\n+        Map<String, String> confOverlay = new HashMap<String, String>();\n+        miniHS2.start(confOverlay);\n+        miniHS2.getDFS().getFileSystem().mkdirs(new Path(\"/apps_staging_dir/anonymous\"));\n+\n+        Connection conDefault = getConnection(miniHS2.getJdbcURL(),\n+                System.getProperty(\"user.name\"), \"bar\");\n+        Statement stmt = conDefault.createStatement();\n+        String tblName = testDbName + \".\" + tableName;\n+        Path dataFilePath = new Path(dataFileDir, \"kv1.txt\");\n+        String udfName = TestJdbcWithMiniLlapArrow.SleepMsUDF.class.getName();\n+        stmt.execute(\"drop database if exists \" + testDbName + \" cascade\");\n+        stmt.execute(\"create database \" + testDbName);\n+        stmt.execute(\"set role admin\");\n+        stmt.execute(\"dfs -put \" + dataFilePath.toString() + \" \" + \"kv1.txt\");\n+        stmt.execute(\"use \" + testDbName);\n+        stmt.execute(\"create table \" + tblName + \" (int_col int, value string) \");\n+        stmt.execute(\"load data inpath 'kv1.txt' into table \" + tblName);\n+        stmt.execute(\"create function sleepMsUDF as '\" + udfName + \"'\");\n+        stmt.execute(\"grant select on table \" + tblName + \" to role public\");\n+\n+        stmt.close();\n+        conDefault.close();\n+    }\n+\n+    @AfterClass\n+    public static void afterTest() {\n+        if (miniHS2 != null && miniHS2.isStarted()) {\n+            miniHS2.stop();\n+        }\n+    }\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        hs2Conn = getConnection(miniHS2.getJdbcURL(), System.getProperty(\"user.name\"), \"bar\");\n+    }\n+\n+    public static Connection getConnection(String jdbcURL, String user, String pwd) throws SQLException {\n+        Connection conn = DriverManager.getConnection(jdbcURL, user, pwd);\n+        conn.createStatement().execute(\"set hive.support.concurrency = false\");\n+        return conn;\n+    }\n+\n+    @After\n+    public void tearDown() throws Exception {\n+        LlapBaseInputFormat.closeAll();\n+        hs2Conn.close();\n+    }\n+\n+\n+\n+    @Test\n+    public void testKillQueryById() throws Exception {\n+        String user = System.getProperty(\"user.name\");\n+        Connection con1 = getConnection(miniHS2.getJdbcURL(testDbName),\n+                user, \"bar\");\n+\n+        final HiveStatement stmt = (HiveStatement)con1.createStatement();\n+        final StringBuffer stmtQueryId = new StringBuffer();\n+        ExceptionHolder originalQExHolder = new ExceptionHolder();\n+        originalQExHolder.throwable = null;\n+\n+        // Thread executing the query\n+        Thread tExecute = new Thread(new Runnable() {\n+            @Override\n+            public void run() {\n+                try {\n+                    System.out.println(\"Executing query: \");\n+                    stmt.execute(\"set hive.llap.execution.mode = none\");\n+\n+                    // The test table has 500 rows, so total query time should be ~ 500*500ms\n+                    stmt.executeAsync(\"select sleepMsUDF(t1.int_col, 100), t1.int_col, t2.int_col \" +\n+                            \"from \" + tableName + \" t1 join \" + tableName + \" t2 on t1.int_col = t2.int_col\");\n+                    stmtQueryId.append(stmt.getQueryId());\n+                    stmt.getUpdateCount();\n+                } catch (SQLException e) {\n+                    originalQExHolder.throwable = e;\n+                }\n+            }\n+        });\n+\n+        tExecute.start();\n+\n+        // wait for other thread to create the stmt handle\n+        int count = 0;\n+        while (++count <= 10) {\n+                Thread.sleep(2000);\n+                String queryId;\n+                if (stmtQueryId.length() != 0) {\n+                    queryId = stmtQueryId.toString();\n+                } else {\n+                    continue;\n+                }\n+                System.out.println(\"Killing query: \" + queryId);\n+                killAMForQueryId(queryId);\n+                break;\n+        }\n+\n+        tExecute.join();\n+        Assert.assertEquals(originalQExHolder.throwable, null);\n+        try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 182}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTA3MTkzOnYy", "diffSide": "RIGHT", "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODowODowOVrOGn00Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNTo1MTozN1rOGoD2Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQxMzAyNg==", "bodyText": "Not just decommissioned case. We retry, even if AM is killed manually. So, let's keep it \"...due to tez AM being killed.\"", "url": "https://github.com/apache/hive/pull/1146#discussion_r444413026", "createdAt": "2020-06-23T18:08:09Z", "author": {"login": "sankarh"}, "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "diffHunk": "@@ -4979,10 +4979,11 @@ private static void populateLlapDaemonVarsSet(Set<String> llapDaemonVarsSetLocal\n \n     HIVE_QUERY_REEXECUTION_ENABLED(\"hive.query.reexecution.enabled\", true,\n         \"Enable query reexecutions\"),\n-    HIVE_QUERY_REEXECUTION_STRATEGIES(\"hive.query.reexecution.strategies\", \"overlay,reoptimize\",\n+    HIVE_QUERY_REEXECUTION_STRATEGIES(\"hive.query.reexecution.strategies\", \"overlay,reoptimize,reexecute_lost_am\",\n         \"comma separated list of plugin can be used:\\n\"\n             + \"  overlay: hiveconf subtree 'reexec.overlay' is used as an overlay in case of an execution errors out\\n\"\n-            + \"  reoptimize: collects operator statistics during execution and recompile the query after a failure\"),\n+            + \"  reoptimize: collects operator statistics during execution and recompile the query after a failure\\n\"\n+            + \"  reexecute_lost_am: reexecutes query if it failed due to tez am node gets decommissioned\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY1Mzk4Mg==", "bodyText": "No, the plugin does not retry if the AM was killed manually because of the error message that we are grepping for.\nIn case AM is killed, the error message is something like \"*killed by user\". It does not throw -100 exitcode.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444653982", "createdAt": "2020-06-24T05:33:58Z", "author": {"login": "adesh-rao"}, "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "diffHunk": "@@ -4979,10 +4979,11 @@ private static void populateLlapDaemonVarsSet(Set<String> llapDaemonVarsSetLocal\n \n     HIVE_QUERY_REEXECUTION_ENABLED(\"hive.query.reexecution.enabled\", true,\n         \"Enable query reexecutions\"),\n-    HIVE_QUERY_REEXECUTION_STRATEGIES(\"hive.query.reexecution.strategies\", \"overlay,reoptimize\",\n+    HIVE_QUERY_REEXECUTION_STRATEGIES(\"hive.query.reexecution.strategies\", \"overlay,reoptimize,reexecute_lost_am\",\n         \"comma separated list of plugin can be used:\\n\"\n             + \"  overlay: hiveconf subtree 'reexec.overlay' is used as an overlay in case of an execution errors out\\n\"\n-            + \"  reoptimize: collects operator statistics during execution and recompile the query after a failure\"),\n+            + \"  reoptimize: collects operator statistics during execution and recompile the query after a failure\\n\"\n+            + \"  reexecute_lost_am: reexecutes query if it failed due to tez am node gets decommissioned\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQxMzAyNg=="}, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY1OTI2Nw==", "bodyText": "Make sense.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444659267", "createdAt": "2020-06-24T05:51:37Z", "author": {"login": "sankarh"}, "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "diffHunk": "@@ -4979,10 +4979,11 @@ private static void populateLlapDaemonVarsSet(Set<String> llapDaemonVarsSetLocal\n \n     HIVE_QUERY_REEXECUTION_ENABLED(\"hive.query.reexecution.enabled\", true,\n         \"Enable query reexecutions\"),\n-    HIVE_QUERY_REEXECUTION_STRATEGIES(\"hive.query.reexecution.strategies\", \"overlay,reoptimize\",\n+    HIVE_QUERY_REEXECUTION_STRATEGIES(\"hive.query.reexecution.strategies\", \"overlay,reoptimize,reexecute_lost_am\",\n         \"comma separated list of plugin can be used:\\n\"\n             + \"  overlay: hiveconf subtree 'reexec.overlay' is used as an overlay in case of an execution errors out\\n\"\n-            + \"  reoptimize: collects operator statistics during execution and recompile the query after a failure\"),\n+            + \"  reoptimize: collects operator statistics during execution and recompile the query after a failure\\n\"\n+            + \"  reexecute_lost_am: reexecutes query if it failed due to tez am node gets decommissioned\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQxMzAyNg=="}, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTA3ODU2OnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/reexec/ReExecuteLostAMQueryPlugin.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODowOTo1OFrOGn04hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNTo1MjoxN1rOGoD2_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQxNDA4NA==", "bodyText": "Based on -100 exitcode, can we differentiate if the query was killed by \"KILL QUERY\" command or just Tez AM got killed? If killed by KILL QUERY, then we shouldn't retry.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444414084", "createdAt": "2020-06-23T18:09:58Z", "author": {"login": "sankarh"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/reexec/ReExecuteLostAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.hive.ql.Driver;\n+import org.apache.hadoop.hive.ql.hooks.ExecuteWithHookContext;\n+import org.apache.hadoop.hive.ql.hooks.HookContext;\n+import org.apache.hadoop.hive.ql.plan.mapper.PlanMapper;\n+\n+import java.util.regex.Pattern;\n+\n+public class ReExecuteLostAMQueryPlugin implements IReExecutionPlugin {\n+    private boolean retryPossible;\n+\n+    // Lost am container have exit code -100, due to node failures.\n+    private Pattern lostAMContainerErrorPattern = Pattern.compile(\".*AM Container for .* exited .* exitCode: -100.*\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY1NDgzNQ==", "bodyText": "Kill Query will kill the running AM, and the error message will be different (like \"application killed by user\"). Anyway, the plugin does not retry when the tez AM is killed manually.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444654835", "createdAt": "2020-06-24T05:37:05Z", "author": {"login": "adesh-rao"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/reexec/ReExecuteLostAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.hive.ql.Driver;\n+import org.apache.hadoop.hive.ql.hooks.ExecuteWithHookContext;\n+import org.apache.hadoop.hive.ql.hooks.HookContext;\n+import org.apache.hadoop.hive.ql.plan.mapper.PlanMapper;\n+\n+import java.util.regex.Pattern;\n+\n+public class ReExecuteLostAMQueryPlugin implements IReExecutionPlugin {\n+    private boolean retryPossible;\n+\n+    // Lost am container have exit code -100, due to node failures.\n+    private Pattern lostAMContainerErrorPattern = Pattern.compile(\".*AM Container for .* exited .* exitCode: -100.*\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQxNDA4NA=="}, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY1OTQ1Mw==", "bodyText": "Then no worries.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444659453", "createdAt": "2020-06-24T05:52:17Z", "author": {"login": "sankarh"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/reexec/ReExecuteLostAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.hive.ql.Driver;\n+import org.apache.hadoop.hive.ql.hooks.ExecuteWithHookContext;\n+import org.apache.hadoop.hive.ql.hooks.HookContext;\n+import org.apache.hadoop.hive.ql.plan.mapper.PlanMapper;\n+\n+import java.util.regex.Pattern;\n+\n+public class ReExecuteLostAMQueryPlugin implements IReExecutionPlugin {\n+    private boolean retryPossible;\n+\n+    // Lost am container have exit code -100, due to node failures.\n+    private Pattern lostAMContainerErrorPattern = Pattern.compile(\".*AM Container for .* exited .* exitCode: -100.*\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQxNDA4NA=="}, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTA4NTA0OnYy", "diffSide": "RIGHT", "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODoxMTo1N1rOGn08jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODoxMTo1N1rOGn08jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQxNTExOQ==", "bodyText": "TestReExecuteKilledTezAMQueryPlugin.class can be used as logger argument.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444415119", "createdAt": "2020-06-23T18:11:57Z", "author": {"login": "sankarh"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.llap.LlapBaseInputFormat;\n+import org.apache.hadoop.hive.ql.metadata.HiveException;\n+import org.apache.hadoop.yarn.api.records.ApplicationReport;\n+import org.apache.hadoop.yarn.api.records.YarnApplicationState;\n+import org.apache.hadoop.yarn.client.api.YarnClient;\n+import org.apache.hive.jdbc.BaseJdbcWithMiniLlap;\n+import org.apache.hive.jdbc.HiveStatement;\n+import org.apache.hive.jdbc.TestJdbcWithMiniLlapArrow;\n+import org.apache.hive.jdbc.miniHS2.MiniHS2;\n+import org.junit.*;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.net.URL;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public class TestReExecuteKilledTezAMQueryPlugin {\n+    protected static final Logger LOG = LoggerFactory.getLogger(TestJdbcWithMiniLlapArrow.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTA5NjU0OnYy", "diffSide": "RIGHT", "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODoxNTowM1rOGn1Dhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODoxNTowM1rOGn1Dhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQxNjkwMw==", "bodyText": "Can see unused imports. Pls remove them.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444416903", "createdAt": "2020-06-23T18:15:03Z", "author": {"login": "sankarh"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.llap.LlapBaseInputFormat;\n+import org.apache.hadoop.hive.ql.metadata.HiveException;\n+import org.apache.hadoop.yarn.api.records.ApplicationReport;\n+import org.apache.hadoop.yarn.api.records.YarnApplicationState;\n+import org.apache.hadoop.yarn.client.api.YarnClient;\n+import org.apache.hive.jdbc.BaseJdbcWithMiniLlap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTA5OTI5OnYy", "diffSide": "RIGHT", "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODoxNTo1MlrOGn1FQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxODoxNTo1MlrOGn1FQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQxNzM0Ng==", "bodyText": "Why need LlapBaseInputFormat.closeAll?", "url": "https://github.com/apache/hive/pull/1146#discussion_r444417346", "createdAt": "2020-06-23T18:15:52Z", "author": {"login": "sankarh"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.llap.LlapBaseInputFormat;\n+import org.apache.hadoop.hive.ql.metadata.HiveException;\n+import org.apache.hadoop.yarn.api.records.ApplicationReport;\n+import org.apache.hadoop.yarn.api.records.YarnApplicationState;\n+import org.apache.hadoop.yarn.client.api.YarnClient;\n+import org.apache.hive.jdbc.BaseJdbcWithMiniLlap;\n+import org.apache.hive.jdbc.HiveStatement;\n+import org.apache.hive.jdbc.TestJdbcWithMiniLlapArrow;\n+import org.apache.hive.jdbc.miniHS2.MiniHS2;\n+import org.junit.*;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.net.URL;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+\n+public class TestReExecuteKilledTezAMQueryPlugin {\n+    protected static final Logger LOG = LoggerFactory.getLogger(TestJdbcWithMiniLlapArrow.class);\n+\n+    private static MiniHS2 miniHS2 = null;\n+    private static final String tableName = \"testKillTezAmTbl\";\n+    private static String dataFileDir;\n+    private static final String testDbName = \"testKillTezAmDb\";\n+    protected static Connection hs2Conn = null;\n+    private static HiveConf conf;\n+\n+    private static class ExceptionHolder {\n+        Throwable throwable;\n+    }\n+\n+    static HiveConf defaultConf() throws Exception {\n+        String confDir = \"../../data/conf/llap/\";\n+        if (confDir != null && !confDir.isEmpty()) {\n+            HiveConf.setHiveSiteLocation(new URL(\"file://\"+ new File(confDir).toURI().getPath() + \"/hive-site.xml\"));\n+            System.out.println(\"Setting hive-site: \" + HiveConf.getHiveSiteLocation());\n+        }\n+        HiveConf defaultConf = new HiveConf();\n+        defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SUPPORT_CONCURRENCY, false);\n+        defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SERVER2_ENABLE_DOAS, false);\n+        defaultConf.addResource(new URL(\"file://\" + new File(confDir).toURI().getPath() + \"/tez-site.xml\"));\n+        return defaultConf;\n+    }\n+\n+    @BeforeClass\n+    public static void beforeTest() throws Exception {\n+        conf = defaultConf();\n+        conf.setVar(HiveConf.ConfVars.USERS_IN_ADMIN_ROLE, System.getProperty(\"user.name\"));\n+        conf.set(HiveConf.ConfVars.HIVE_QUERY_REEXECUTION_STRATEGIES.varname, \"reexecute_lost_am\");\n+        MiniHS2.cleanupLocalDir();\n+        Class.forName(MiniHS2.getJdbcDriverName());\n+        miniHS2 = new MiniHS2(conf, MiniHS2.MiniClusterType.LLAP);\n+        dataFileDir = conf.get(\"test.data.files\").replace('\\\\', '/').replace(\"c:\", \"\");\n+        Map<String, String> confOverlay = new HashMap<String, String>();\n+        miniHS2.start(confOverlay);\n+        miniHS2.getDFS().getFileSystem().mkdirs(new Path(\"/apps_staging_dir/anonymous\"));\n+\n+        Connection conDefault = getConnection(miniHS2.getJdbcURL(),\n+                System.getProperty(\"user.name\"), \"bar\");\n+        Statement stmt = conDefault.createStatement();\n+        String tblName = testDbName + \".\" + tableName;\n+        Path dataFilePath = new Path(dataFileDir, \"kv1.txt\");\n+        String udfName = TestJdbcWithMiniLlapArrow.SleepMsUDF.class.getName();\n+        stmt.execute(\"drop database if exists \" + testDbName + \" cascade\");\n+        stmt.execute(\"create database \" + testDbName);\n+        stmt.execute(\"set role admin\");\n+        stmt.execute(\"dfs -put \" + dataFilePath.toString() + \" \" + \"kv1.txt\");\n+        stmt.execute(\"use \" + testDbName);\n+        stmt.execute(\"create table \" + tblName + \" (int_col int, value string) \");\n+        stmt.execute(\"load data inpath 'kv1.txt' into table \" + tblName);\n+        stmt.execute(\"create function sleepMsUDF as '\" + udfName + \"'\");\n+        stmt.execute(\"grant select on table \" + tblName + \" to role public\");\n+\n+        stmt.close();\n+        conDefault.close();\n+    }\n+\n+    @AfterClass\n+    public static void afterTest() {\n+        if (miniHS2 != null && miniHS2.isStarted()) {\n+            miniHS2.stop();\n+        }\n+    }\n+\n+    @Before\n+    public void setUp() throws Exception {\n+        hs2Conn = getConnection(miniHS2.getJdbcURL(), System.getProperty(\"user.name\"), \"bar\");\n+    }\n+\n+    public static Connection getConnection(String jdbcURL, String user, String pwd) throws SQLException {\n+        Connection conn = DriverManager.getConnection(jdbcURL, user, pwd);\n+        conn.createStatement().execute(\"set hive.support.concurrency = false\");\n+        return conn;\n+    }\n+\n+    @After\n+    public void tearDown() throws Exception {\n+        LlapBaseInputFormat.closeAll();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7d1f554c5ed0970e00b2f6d5e5537dcc46bcaf"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDYyNDA0OnYy", "diffSide": "RIGHT", "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNTo1NDozNVrOGoD5zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNTo1NDozNVrOGoD5zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY2MDE3Mw==", "bodyText": "Unaligned to 2 spaces tab. Check other methods too. It seems only annotation is corrected.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444660173", "createdAt": "2020-06-24T05:54:35Z", "author": {"login": "sankarh"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.yarn.api.records.ApplicationReport;\n+import org.apache.hadoop.yarn.api.records.YarnApplicationState;\n+import org.apache.hadoop.yarn.client.api.YarnClient;\n+import org.apache.hive.jdbc.HiveStatement;\n+import org.apache.hive.jdbc.TestJdbcWithMiniLlapArrow;\n+import org.apache.hive.jdbc.miniHS2.MiniHS2;\n+import org.junit.*;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.net.URL;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class TestReExecuteKilledTezAMQueryPlugin {\n+  protected static final Logger LOG = LoggerFactory.getLogger(TestReExecuteKilledTezAMQueryPlugin.class);\n+\n+  private static MiniHS2 miniHS2 = null;\n+  private static final String tableName = \"testKillTezAmTbl\";\n+  private static String dataFileDir;\n+  private static final String testDbName = \"testKillTezAmDb\";\n+  protected static Connection hs2Conn = null;\n+  private static HiveConf conf;\n+\n+  private static class ExceptionHolder {\n+    Throwable throwable;\n+  }\n+\n+  static HiveConf defaultConf() throws Exception {\n+    String confDir = \"../../data/conf/llap/\";\n+    if (confDir != null && !confDir.isEmpty()) {\n+      HiveConf.setHiveSiteLocation(new URL(\"file://\"+ new File(confDir).toURI().getPath() + \"/hive-site.xml\"));\n+      System.out.println(\"Setting hive-site: \" + HiveConf.getHiveSiteLocation());\n+    }\n+    HiveConf defaultConf = new HiveConf();\n+    defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SUPPORT_CONCURRENCY, false);\n+    defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SERVER2_ENABLE_DOAS, false);\n+    defaultConf.addResource(new URL(\"file://\" + new File(confDir).toURI().getPath() + \"/tez-site.xml\"));\n+    return defaultConf;\n+  }\n+\n+  @BeforeClass\n+    public static void beforeTest() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d0fad3089ca949df319b827cc6d76b348a5347d"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDYyNjM0OnYy", "diffSide": "RIGHT", "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNTo1NTo1M1rOGoD7WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNTo1NTo1M1rOGoD7WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY2MDU2OA==", "bodyText": "hs2Conn is unused. Shall remove it.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444660568", "createdAt": "2020-06-24T05:55:53Z", "author": {"login": "sankarh"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.yarn.api.records.ApplicationReport;\n+import org.apache.hadoop.yarn.api.records.YarnApplicationState;\n+import org.apache.hadoop.yarn.client.api.YarnClient;\n+import org.apache.hive.jdbc.HiveStatement;\n+import org.apache.hive.jdbc.TestJdbcWithMiniLlapArrow;\n+import org.apache.hive.jdbc.miniHS2.MiniHS2;\n+import org.junit.*;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.net.URL;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class TestReExecuteKilledTezAMQueryPlugin {\n+  protected static final Logger LOG = LoggerFactory.getLogger(TestReExecuteKilledTezAMQueryPlugin.class);\n+\n+  private static MiniHS2 miniHS2 = null;\n+  private static final String tableName = \"testKillTezAmTbl\";\n+  private static String dataFileDir;\n+  private static final String testDbName = \"testKillTezAmDb\";\n+  protected static Connection hs2Conn = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d0fad3089ca949df319b827cc6d76b348a5347d"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDYyODMwOnYy", "diffSide": "RIGHT", "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNTo1Njo1NFrOGoD8oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQwNTo1Njo1NFrOGoD8oA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDY2MDg5Ng==", "bodyText": "Shall move try { to next line.", "url": "https://github.com/apache/hive/pull/1146#discussion_r444660896", "createdAt": "2020-06-24T05:56:54Z", "author": {"login": "sankarh"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/reexec/TestReExecuteKilledTezAMQueryPlugin.java", "diffHunk": "@@ -0,0 +1,195 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.fs.Path;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.yarn.api.records.ApplicationReport;\n+import org.apache.hadoop.yarn.api.records.YarnApplicationState;\n+import org.apache.hadoop.yarn.client.api.YarnClient;\n+import org.apache.hive.jdbc.HiveStatement;\n+import org.apache.hive.jdbc.TestJdbcWithMiniLlapArrow;\n+import org.apache.hive.jdbc.miniHS2.MiniHS2;\n+import org.junit.*;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.net.URL;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+public class TestReExecuteKilledTezAMQueryPlugin {\n+  protected static final Logger LOG = LoggerFactory.getLogger(TestReExecuteKilledTezAMQueryPlugin.class);\n+\n+  private static MiniHS2 miniHS2 = null;\n+  private static final String tableName = \"testKillTezAmTbl\";\n+  private static String dataFileDir;\n+  private static final String testDbName = \"testKillTezAmDb\";\n+  protected static Connection hs2Conn = null;\n+  private static HiveConf conf;\n+\n+  private static class ExceptionHolder {\n+    Throwable throwable;\n+  }\n+\n+  static HiveConf defaultConf() throws Exception {\n+    String confDir = \"../../data/conf/llap/\";\n+    if (confDir != null && !confDir.isEmpty()) {\n+      HiveConf.setHiveSiteLocation(new URL(\"file://\"+ new File(confDir).toURI().getPath() + \"/hive-site.xml\"));\n+      System.out.println(\"Setting hive-site: \" + HiveConf.getHiveSiteLocation());\n+    }\n+    HiveConf defaultConf = new HiveConf();\n+    defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SUPPORT_CONCURRENCY, false);\n+    defaultConf.setBoolVar(HiveConf.ConfVars.HIVE_SERVER2_ENABLE_DOAS, false);\n+    defaultConf.addResource(new URL(\"file://\" + new File(confDir).toURI().getPath() + \"/tez-site.xml\"));\n+    return defaultConf;\n+  }\n+\n+  @BeforeClass\n+    public static void beforeTest() throws Exception {\n+      conf = defaultConf();\n+      conf.setVar(HiveConf.ConfVars.USERS_IN_ADMIN_ROLE, System.getProperty(\"user.name\"));\n+      conf.set(HiveConf.ConfVars.HIVE_QUERY_REEXECUTION_STRATEGIES.varname, \"reexecute_lost_am\");\n+      MiniHS2.cleanupLocalDir();\n+      Class.forName(MiniHS2.getJdbcDriverName());\n+      miniHS2 = new MiniHS2(conf, MiniHS2.MiniClusterType.LLAP);\n+      dataFileDir = conf.get(\"test.data.files\").replace('\\\\', '/').replace(\"c:\", \"\");\n+      Map<String, String> confOverlay = new HashMap<String, String>();\n+      miniHS2.start(confOverlay);\n+      miniHS2.getDFS().getFileSystem().mkdirs(new Path(\"/apps_staging_dir/anonymous\"));\n+\n+      Connection conDefault = getConnection(miniHS2.getJdbcURL(),\n+      System.getProperty(\"user.name\"), \"bar\");\n+      Statement stmt = conDefault.createStatement();\n+      String tblName = testDbName + \".\" + tableName;\n+      Path dataFilePath = new Path(dataFileDir, \"kv1.txt\");\n+      String udfName = TestJdbcWithMiniLlapArrow.SleepMsUDF.class.getName();\n+      stmt.execute(\"drop database if exists \" + testDbName + \" cascade\");\n+      stmt.execute(\"create database \" + testDbName);\n+      stmt.execute(\"set role admin\");\n+      stmt.execute(\"dfs -put \" + dataFilePath.toString() + \" \" + \"kv1.txt\");\n+      stmt.execute(\"use \" + testDbName);\n+      stmt.execute(\"create table \" + tblName + \" (int_col int, value string) \");\n+      stmt.execute(\"load data inpath 'kv1.txt' into table \" + tblName);\n+      stmt.execute(\"create function sleepMsUDF as '\" + udfName + \"'\");\n+      stmt.execute(\"grant select on table \" + tblName + \" to role public\");\n+\n+      stmt.close();\n+      conDefault.close();\n+    }\n+\n+  @AfterClass\n+    public static void afterTest() {\n+      if (miniHS2 != null && miniHS2.isStarted()) {\n+        miniHS2.stop();\n+      }\n+    }\n+\n+  @Before\n+    public void setUp() throws Exception {\n+      hs2Conn = getConnection(miniHS2.getJdbcURL(), System.getProperty(\"user.name\"), \"bar\");\n+    }\n+\n+  public static Connection getConnection(String jdbcURL, String user, String pwd) throws SQLException {\n+    Connection conn = DriverManager.getConnection(jdbcURL, user, pwd);\n+    conn.createStatement().execute(\"set hive.support.concurrency = false\");\n+    return conn;\n+  }\n+\n+  @After\n+    public void tearDown() throws Exception {\n+      hs2Conn.close();\n+    }\n+\n+    @Test\n+    public void testKillQueryById() throws Exception {\n+      String user = System.getProperty(\"user.name\");\n+      Connection con1 = getConnection(miniHS2.getJdbcURL(testDbName), user, \"bar\");\n+\n+      final HiveStatement stmt = (HiveStatement)con1.createStatement();\n+      final StringBuffer stmtQueryId = new StringBuffer();\n+      ExceptionHolder originalQExHolder = new ExceptionHolder();\n+      originalQExHolder.throwable = null;\n+\n+      // Thread executing the query\n+      Thread tExecute = new Thread(new Runnable() {\n+        @Override\n+        public void run() {\n+          try {\n+            System.out.println(\"Executing query: \");\n+            stmt.execute(\"set hive.llap.execution.mode = none\");\n+\n+            // The test table has 500 rows, so total query time should be ~ 500*100ms\n+            stmt.executeAsync(\"select sleepMsUDF(t1.int_col, 100), t1.int_col, t2.int_col \" +\n+            \"from \" + tableName + \" t1 join \" + tableName + \" t2 on t1.int_col = t2.int_col\");\n+            stmtQueryId.append(stmt.getQueryId());\n+            stmt.getUpdateCount();\n+          } catch (SQLException e) {\n+            originalQExHolder.throwable = e;\n+          }\n+        }\n+      });\n+\n+      tExecute.start();\n+\n+      // wait for other thread to create the stmt handle\n+      int count = 0;\n+      while (++count <= 10) {\n+        Thread.sleep(2000);\n+        if (stmtQueryId.length() != 0) {\n+          String queryId = stmtQueryId.toString();\n+          System.out.println(\"Killing query: \" + queryId);\n+          killAMForQueryId(queryId);\n+          break;\n+        }\n+      }\n+\n+      tExecute.join();try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d0fad3089ca949df319b827cc6d76b348a5347d"}, "originalPosition": 169}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 649, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}