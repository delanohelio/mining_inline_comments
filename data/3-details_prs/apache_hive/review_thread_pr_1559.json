{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NjA4MzM2", "number": 1559, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTo1NDoyMVrOEqz5uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTo1NTo0OVrOEqz8YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzI2MDA5OnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTo1NDoyMVrOHdOuSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjoyNjowMVrOHdQCsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMTk3OA==", "bodyText": "that's redundant", "url": "https://github.com/apache/hive/pull/1559#discussion_r500411978", "createdAt": "2020-10-06T15:54:21Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -5250,20 +5252,22 @@ public LockHandle acquireLock(String key) throws MetaException {\n           derbySemaphore.acquire();\n         }\n         LOG.debug(quoteString(key) + \" locked by \" + quoteString(TxnHandler.hostname));\n+        needToCloseConn = false;  //The connection is good, we need not close it\n         //OK, so now we have a lock\n         return new LockHandleImpl(dbConn, stmt, rs, key, derbySemaphore);\n       } catch (SQLException ex) {\n-        rollbackDBConn(dbConn);\n-        close(rs, stmt, dbConn);\n         checkRetryable(dbConn, ex, \"acquireLock(\" + key + \")\");\n         throw new MetaException(\"Unable to lock \" + quoteString(key) + \" due to: \" + getMessage(ex) + \"; \" + StringUtils.stringifyException(ex));\n       }\n       catch(InterruptedException ex) {\n-        rollbackDBConn(dbConn);\n-        close(rs, stmt, dbConn);\n         throw new MetaException(\"Unable to lock \" + quoteString(key) + \" due to: \" + ex.getMessage() + StringUtils.stringifyException(ex));\n       }\n       finally {\n+        if (needToCloseConn) {\n+          rollbackDBConn(dbConn);\n+          close(rs, stmt, dbConn);\n+          needToCloseConn = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ef76ca24601c659e732c4227e2864b160a89344"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMzU4NQ==", "bodyText": "Will remove", "url": "https://github.com/apache/hive/pull/1559#discussion_r500433585", "createdAt": "2020-10-06T16:26:01Z", "author": {"login": "yongzhi"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -5250,20 +5252,22 @@ public LockHandle acquireLock(String key) throws MetaException {\n           derbySemaphore.acquire();\n         }\n         LOG.debug(quoteString(key) + \" locked by \" + quoteString(TxnHandler.hostname));\n+        needToCloseConn = false;  //The connection is good, we need not close it\n         //OK, so now we have a lock\n         return new LockHandleImpl(dbConn, stmt, rs, key, derbySemaphore);\n       } catch (SQLException ex) {\n-        rollbackDBConn(dbConn);\n-        close(rs, stmt, dbConn);\n         checkRetryable(dbConn, ex, \"acquireLock(\" + key + \")\");\n         throw new MetaException(\"Unable to lock \" + quoteString(key) + \" due to: \" + getMessage(ex) + \"; \" + StringUtils.stringifyException(ex));\n       }\n       catch(InterruptedException ex) {\n-        rollbackDBConn(dbConn);\n-        close(rs, stmt, dbConn);\n         throw new MetaException(\"Unable to lock \" + quoteString(key) + \" due to: \" + ex.getMessage() + StringUtils.stringifyException(ex));\n       }\n       finally {\n+        if (needToCloseConn) {\n+          rollbackDBConn(dbConn);\n+          close(rs, stmt, dbConn);\n+          needToCloseConn = false;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMTk3OA=="}, "originalCommit": {"oid": "1ef76ca24601c659e732c4227e2864b160a89344"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzI2Njg4OnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTo1NTo0OVrOHdOyhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxOToxMTo0N1rOHdWPNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMzA2Mg==", "bodyText": "that won't work if thread was interrupted right after getting the connection, set it to true by default.", "url": "https://github.com/apache/hive/pull/1559#discussion_r500413062", "createdAt": "2020-10-06T15:55:49Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -5213,11 +5213,13 @@ public LockHandle acquireLock(String key) throws MetaException {\n     Connection dbConn = null;\n     Statement stmt = null;\n     ResultSet rs = null;\n+    boolean needToCloseConn = false;\n     try {\n       try {\n         String sqlStmt = sqlGenerator.addForUpdateClause(\"SELECT \\\"MT_COMMENT\\\" FROM \\\"AUX_TABLE\\\" WHERE \\\"MT_KEY1\\\"=\" + quoteString(key) + \" and \\\"MT_KEY2\\\"=0\");\n         lockInternal();\n         dbConn = getDbConn(Connection.TRANSACTION_READ_COMMITTED, connPoolMutex);\n+        needToCloseConn = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ef76ca24601c659e732c4227e2864b160a89344"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxODQ1Nw==", "bodyText": "Also I think this LockHandle should implement AutoCloseable and close active connection if any.", "url": "https://github.com/apache/hive/pull/1559#discussion_r500418457", "createdAt": "2020-10-06T16:03:27Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -5213,11 +5213,13 @@ public LockHandle acquireLock(String key) throws MetaException {\n     Connection dbConn = null;\n     Statement stmt = null;\n     ResultSet rs = null;\n+    boolean needToCloseConn = false;\n     try {\n       try {\n         String sqlStmt = sqlGenerator.addForUpdateClause(\"SELECT \\\"MT_COMMENT\\\" FROM \\\"AUX_TABLE\\\" WHERE \\\"MT_KEY1\\\"=\" + quoteString(key) + \" and \\\"MT_KEY2\\\"=0\");\n         lockInternal();\n         dbConn = getDbConn(Connection.TRANSACTION_READ_COMMITTED, connPoolMutex);\n+        needToCloseConn = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMzA2Mg=="}, "originalCommit": {"oid": "1ef76ca24601c659e732c4227e2864b160a89344"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0NjIzMw==", "bodyText": "AutoCloseable may not be necessary, lockHandle implement releaseLocks()  which close the connection.  It uses with acquireLock in our codes in following pattern:\nTxnStore.MutexAPI.LockHandle handle = null;\ntry {\nhandle = txnHandler.getMutexAPI().acquireLock(TxnStore.MUTEX_KEY.TxnCleaner.name());\nlong start = System.currentTimeMillis();\ntxnHandler.cleanEmptyAbortedAndCommittedTxns();\nLOG.debug(\"Txn cleaner service took: {} seconds.\", elapsedSince(start));\n} catch (Throwable t) {\nLOG.error(\"Unexpected error in thread: {}, message: {}\", Thread.currentThread().getName(), t.getMessage(), t);\n} finally {\nif (handle != null) {\nhandle.releaseLocks();\n}\n}\nWill fix the variable needToCloseConn", "url": "https://github.com/apache/hive/pull/1559#discussion_r500446233", "createdAt": "2020-10-06T16:45:31Z", "author": {"login": "yongzhi"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -5213,11 +5213,13 @@ public LockHandle acquireLock(String key) throws MetaException {\n     Connection dbConn = null;\n     Statement stmt = null;\n     ResultSet rs = null;\n+    boolean needToCloseConn = false;\n     try {\n       try {\n         String sqlStmt = sqlGenerator.addForUpdateClause(\"SELECT \\\"MT_COMMENT\\\" FROM \\\"AUX_TABLE\\\" WHERE \\\"MT_KEY1\\\"=\" + quoteString(key) + \" and \\\"MT_KEY2\\\"=0\");\n         lockInternal();\n         dbConn = getDbConn(Connection.TRANSACTION_READ_COMMITTED, connPoolMutex);\n+        needToCloseConn = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMzA2Mg=="}, "originalCommit": {"oid": "1ef76ca24601c659e732c4227e2864b160a89344"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyMDA3NA==", "bodyText": "hopefully it's done like this everywhere, otherwise we might get same issue but in different place", "url": "https://github.com/apache/hive/pull/1559#discussion_r500520074", "createdAt": "2020-10-06T18:45:02Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -5213,11 +5213,13 @@ public LockHandle acquireLock(String key) throws MetaException {\n     Connection dbConn = null;\n     Statement stmt = null;\n     ResultSet rs = null;\n+    boolean needToCloseConn = false;\n     try {\n       try {\n         String sqlStmt = sqlGenerator.addForUpdateClause(\"SELECT \\\"MT_COMMENT\\\" FROM \\\"AUX_TABLE\\\" WHERE \\\"MT_KEY1\\\"=\" + quoteString(key) + \" and \\\"MT_KEY2\\\"=0\");\n         lockInternal();\n         dbConn = getDbConn(Connection.TRANSACTION_READ_COMMITTED, connPoolMutex);\n+        needToCloseConn = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMzA2Mg=="}, "originalCommit": {"oid": "1ef76ca24601c659e732c4227e2864b160a89344"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUzNTA5NA==", "bodyText": "Yes, I checked every place that acquireLock is called, they are always matching.", "url": "https://github.com/apache/hive/pull/1559#discussion_r500535094", "createdAt": "2020-10-06T19:11:47Z", "author": {"login": "yongzhi"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -5213,11 +5213,13 @@ public LockHandle acquireLock(String key) throws MetaException {\n     Connection dbConn = null;\n     Statement stmt = null;\n     ResultSet rs = null;\n+    boolean needToCloseConn = false;\n     try {\n       try {\n         String sqlStmt = sqlGenerator.addForUpdateClause(\"SELECT \\\"MT_COMMENT\\\" FROM \\\"AUX_TABLE\\\" WHERE \\\"MT_KEY1\\\"=\" + quoteString(key) + \" and \\\"MT_KEY2\\\"=0\");\n         lockInternal();\n         dbConn = getDbConn(Connection.TRANSACTION_READ_COMMITTED, connPoolMutex);\n+        needToCloseConn = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMzA2Mg=="}, "originalCommit": {"oid": "1ef76ca24601c659e732c4227e2864b160a89344"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 333, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}