{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNTU5MDE0", "number": 1792, "title": "HIVE-24551: Hive should include transitive dependencies from calcite after shading it", "bodyText": "What changes were proposed in this pull request?\n\nThis includes calcite-core's transitive dependencies:\n\nnet.hydromatic:eigenbase-properties\norg.codehaus.janino:janino\norg.codehaus.janino:commons-compiler\norg.pentaho:pentaho-aggdesigner-algorithm\n\nin the fat hive-exec jar.\nWhy are the changes needed?\n\nCurrently as part of effort of shading Guava from Hive, we shade Calcite and exclude all its artifacts from the binary distribution. However, this also removes all its transitive dependencies which will still needed at runtime. Without these, Hive queries will fail with error like:\nException in thread \"main\" java.lang.NoClassDefFoundError: org/eigenbase/util/property/BooleanProperty\n        at org.apache.calcite.util.SaffronProperties.<init>(SaffronProperties.java:66)\n        at org.apache.calcite.util.SaffronProperties.instance(SaffronProperties.java:134)\n        at org.apache.calcite.util.Util.getDefaultCharset(Util.java:769)\n        at org.apache.calcite.rel.type.RelDataTypeFactoryImpl.getDefaultCharset(RelDataTypeFactoryImpl.java:565)\n        at org.apache.calcite.sql.type.SqlTypeUtil.addCharsetAndCollation(SqlTypeUtil.java:1070)\n        at org.apache.calcite.sql.type.SqlTypeFactoryImpl.createSqlType(SqlTypeFactoryImpl.java:65)\n        at org.apache.calcite.rex.RexBuilder.<init>(RexBuilder.java:114)\n        at org.apache.calcite.prepare.CalcitePrepareImpl.perform(CalcitePrepareImpl.java:991)\n        at org.apache.calcite.tools.Frameworks.withPrepare(Frameworks.java:149)\n        at org.apache.calcite.tools.Frameworks.withPlanner(Frameworks.java:106)\n        at org.apache.hadoop.hive.ql.parse.CalcitePlanner.logicalPlan(CalcitePlanner.java:1069)\n        at org.apache.hadoop.hive.ql.parse.CalcitePlanner.getOptimizedAST(CalcitePlanner.java:1085)\n        at org.apache.hadoop.hive.ql.parse.CalcitePlanner.genOPTree(CalcitePlanner.java:364)\n        at org.apache.hadoop.hive.ql.parse.SemanticAnalyzer.analyzeInternal(SemanticAnalyzer.java:11138)\n        at org.apache.hadoop.hive.ql.parse.CalcitePlanner.analyzeInternal(CalcitePlanner.java:286)\n        at org.apache.hadoop.hive.ql.parse.BaseSemanticAnalyzer.analyze(BaseSemanticAnalyzer.java:258)\n        at org.apache.hadoop.hive.ql.Driver.compile(Driver.java:512)\n        at org.apache.hadoop.hive.ql.Driver.compileInternal(Driver.java:1317)\n        at org.apache.hadoop.hive.ql.Driver.runInternal(Driver.java:1457)\n        at org.apache.hadoop.hive.ql.Driver.run(Driver.java:1237)\n        at org.apache.hadoop.hive.ql.Driver.run(Driver.java:1227)\n        at org.apache.hadoop.hive.cli.CliDriver.processLocalCmd(CliDriver.java:233)\n        at org.apache.hadoop.hive.cli.CliDriver.processCmd(CliDriver.java:184)\n        at org.apache.hadoop.hive.cli.CliDriver.processLine(CliDriver.java:403)\n        at org.apache.hadoop.hive.cli.CliDriver.executeDriver(CliDriver.java:821)\n        at org.apache.hadoop.hive.cli.CliDriver.run(CliDriver.java:759)\n        at org.apache.hadoop.hive.cli.CliDriver.main(CliDriver.java:686)\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.lang.reflect.Method.invoke(Method.java:498)\n        at org.apache.hadoop.util.RunJar.run(RunJar.java:234)\n        at org.apache.hadoop.util.RunJar.main(RunJar.java:148)\nCaused by: java.lang.ClassNotFoundException: org.eigenbase.util.property.BooleanProperty\n        at java.net.URLClassLoader.findClass(URLClassLoader.java:382)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:418)\n        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:352)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:351)\n        ... 33 more\n\nDoes this PR introduce any user-facing change?\n\nNo\nHow was this patch tested?\n\nVerified that the classes are included in the hive-exec jars with the change. I also manually tested this by launching a HS2 and run a simple query against it. It passed while previous was failing due to the above error.", "createdAt": "2020-12-17T02:31:21Z", "url": "https://github.com/apache/hive/pull/1792", "merged": true, "mergeCommit": {"oid": "52a4ab843503567a18219247eeaec840414a3376"}, "closed": true, "closedAt": "2020-12-21T00:46:38Z", "author": {"login": "sunchao"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm6EvpAH2gAyNTQxNTU5MDE0OjFkMWY1NDJmYzFlY2ZjNWE3NDk0MmU3MmE0ODA1MmYxZTJhZWQ5ZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnyrwsAH2gAyNTQxNTU5MDE0OjA5YzRlM2VhMDMyNDU1M2U0ZmYxYTgwNzRiYjE2ZTZiMTRhNWFlMzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1d1f542fc1ecfc5a74942e72a48052f1e2aed9eb", "author": {"user": {"login": "sunchao", "name": "Chao Sun"}}, "url": "https://github.com/apache/hive/commit/1d1f542fc1ecfc5a74942e72a48052f1e2aed9eb", "committedDate": "2020-12-17T02:26:02Z", "message": "HIVE-24551"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MjQxOTQ2", "url": "https://github.com/apache/hive/pull/1792#pullrequestreview-554241946", "createdAt": "2020-12-17T02:49:16Z", "commit": {"oid": "1d1f542fc1ecfc5a74942e72a48052f1e2aed9eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MjQyMzE5", "url": "https://github.com/apache/hive/pull/1792#pullrequestreview-554242319", "createdAt": "2020-12-17T02:50:24Z", "commit": {"oid": "1d1f542fc1ecfc5a74942e72a48052f1e2aed9eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMjo1MDoyNFrOIHiQgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwMjo1MDoyNFrOIHiQgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDc3MjIyNQ==", "bodyText": "One question. Will this be flaky? Once calcite changes transitive dependencies, seems we also need to update this.", "url": "https://github.com/apache/hive/pull/1792#discussion_r544772225", "createdAt": "2020-12-17T02:50:24Z", "author": {"login": "viirya"}, "path": "ql/pom.xml", "diffHunk": "@@ -880,6 +880,12 @@\n                   <include>joda-time:joda-time</include>\n                   <include>org.apache.calcite:*</include>\n                   <include>org.apache.calcite.avatica:avatica</include>\n+                  <!-- include all of calcite's transitive dependencies as well since\n+                    otherwise they'll be removed in assembly packaging -->\n+                  <include>net.hydromatic:eigenbase-properties</include>\n+                  <include>org.codehaus.janino:janino</include>\n+                  <include>org.codehaus.janino:commons-compiler</include>\n+                  <include>org.pentaho:pentaho-aggdesigner-algorithm</include>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d1f542fc1ecfc5a74942e72a48052f1e2aed9eb"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0Mjg2MTYz", "url": "https://github.com/apache/hive/pull/1792#pullrequestreview-554286163", "createdAt": "2020-12-17T05:17:10Z", "commit": {"oid": "1d1f542fc1ecfc5a74942e72a48052f1e2aed9eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDMxNTU0", "url": "https://github.com/apache/hive/pull/1792#pullrequestreview-554431554", "createdAt": "2020-12-17T09:42:06Z", "commit": {"oid": "1d1f542fc1ecfc5a74942e72a48052f1e2aed9eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "700112a4e869c3881f3e5158743f701bd3f01b11", "author": {"user": {"login": "sunchao", "name": "Chao Sun"}}, "url": "https://github.com/apache/hive/commit/700112a4e869c3881f3e5158743f701bd3f01b11", "committedDate": "2020-12-17T17:40:02Z", "message": "Empty commit to trigger CI again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a970908ee515dc70e05cff3cd16ed1722db21ba", "author": {"user": {"login": "sunchao", "name": "Chao Sun"}}, "url": "https://github.com/apache/hive/commit/2a970908ee515dc70e05cff3cd16ed1722db21ba", "committedDate": "2020-12-18T02:42:47Z", "message": "revert previous change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11f3d3b22bc9293640e294cf59847b82e7f3cc01", "author": {"user": {"login": "sunchao", "name": "Chao Sun"}}, "url": "https://github.com/apache/hive/commit/11f3d3b22bc9293640e294cf59847b82e7f3cc01", "committedDate": "2020-12-18T04:31:47Z", "message": "add dependencies instead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09c4e3ea0324553e4ff1a8074bb16e6b14a5ae39", "author": {"user": {"login": "sunchao", "name": "Chao Sun"}}, "url": "https://github.com/apache/hive/commit/09c4e3ea0324553e4ff1a8074bb16e6b14a5ae39", "committedDate": "2020-12-19T20:23:20Z", "message": "bump accumulo version to 1.7.3 and decrease test timeout to 4hr"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2940, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}