{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNTA0NzMw", "number": 1356, "title": "HIVE-23980: Shade Guava from hive-exec in Hive 2.3", "bodyText": "What changes were proposed in this pull request?\n\nThis PR proposes to shade Guava from hive-exec in Hive 2.3 branch.\nWhy are the changes needed?\n\nWhen trying to upgrade Guava in Spark, found the following error. A Guava method became package-private since Guava version 20. So there is incompatibility with Guava versions > 19.0.\nsbt.ForkMain$ForkError: sbt.ForkMain$ForkError: java.lang.IllegalAccessError: tried to access method com.google.common.collect.Iterators.emptyIterator()Lcom/google/common/collect/UnmodifiableIterator; from class org.apache.hadoop.hive.ql.exec.FetchOperator\n\tat org.apache.hadoop.hive.ql.exec.FetchOperator.<init>(FetchOperator.java:108)\n\tat org.apache.hadoop.hive.ql.exec.FetchTask.initialize(FetchTask.java:87)\n\tat org.apache.hadoop.hive.ql.Driver.compile(Driver.java:541)\n\tat org.apache.hadoop.hive.ql.Driver.compileInternal(Driver.java:1317)\n\tat org.apache.hadoop.hive.ql.Driver.runInternal(Driver.java:1457)\n\tat org.apache.hadoop.hive.ql.Driver.run(Driver.java:1237)\n\tat org.apache.hadoop.hive.ql.Driver.run(Driver.java:1227)\n\nThis is a problem for downstream clients. Hive project noticed that problem too in HIVE-22126, however that only targets 4.0.0. It'd be nicer if we can also shade Guava from current Hive versions, e.g. Hive 2.3 line.\nDoes this PR introduce any user-facing change?\n\nYes. Guava will be shaded from hive-exec.\nHow was this patch tested?\n\nBuilt Hive locally and checked jar content.", "createdAt": "2020-08-04T03:25:20Z", "url": "https://github.com/apache/hive/pull/1356", "merged": true, "mergeCommit": {"oid": "2b3d4c921a5185cf546f7642aae55394d3f7b13b"}, "closed": true, "closedAt": "2020-12-01T20:19:53Z", "author": {"login": "viirya"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7vsUzAFqTQ2MTI1MzgyNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhxYnJAFqTU0MTQ2MzM3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMjUzODI2", "url": "https://github.com/apache/hive/pull/1356#pullrequestreview-461253826", "createdAt": "2020-08-05T00:01:33Z", "commit": {"oid": "569a4a151d281f85a9bdb7b60801c7f3f04483ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwMDowMTozNFrOG71fsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwMDowMTozNFrOG71fsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM5NTYzMw==", "bodyText": "Without this change, a runtime error like the following was happened:\njava.lang.NoSuchMethodError: org.apache.hadoop.hive.ql.log.PerfLogger.getStartTimes()Lorg/apache/hive/com/google/common/collect/ImmutableMap;", "url": "https://github.com/apache/hive/pull/1356#discussion_r465395633", "createdAt": "2020-08-05T00:01:34Z", "author": {"login": "viirya"}, "path": "common/src/java/org/apache/hadoop/hive/ql/log/PerfLogger.java", "diffHunk": "@@ -207,11 +207,11 @@ public Long getDuration(String method) {\n   }\n \n \n-  public ImmutableMap<String, Long> getStartTimes() {\n+  public Map<String, Long> getStartTimes() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569a4a151d281f85a9bdb7b60801c7f3f04483ad"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMDc4ODIw", "url": "https://github.com/apache/hive/pull/1356#pullrequestreview-462078820", "createdAt": "2020-08-05T22:57:42Z", "commit": {"oid": "569a4a151d281f85a9bdb7b60801c7f3f04483ad"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "569a4a151d281f85a9bdb7b60801c7f3f04483ad", "author": {"user": {"login": "viirya", "name": "Liang-Chi Hsieh"}}, "url": "https://github.com/apache/hive/commit/569a4a151d281f85a9bdb7b60801c7f3f04483ad", "committedDate": "2020-08-04T23:55:44Z", "message": "Hide guava's ImmutableMap from hive-common APIs."}, "afterCommit": {"oid": "6e4077e9550549e34adafab8f75f61827e59fe5e", "author": {"user": {"login": "viirya", "name": "Liang-Chi Hsieh"}}, "url": "https://github.com/apache/hive/commit/6e4077e9550549e34adafab8f75f61827e59fe5e", "committedDate": "2020-09-24T19:52:19Z", "message": "Hide guava's ImmutableMap from hive-common APIs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9238cb440e971ec3d650a0a86f9e187bc4cad192", "author": {"user": {"login": "viirya", "name": "Liang-Chi Hsieh"}}, "url": "https://github.com/apache/hive/commit/9238cb440e971ec3d650a0a86f9e187bc4cad192", "committedDate": "2020-11-16T18:03:46Z", "message": "Shade guava."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a7f6c2b47abaf27312c48279923d241f4fd4bd6", "author": {"user": {"login": "viirya", "name": "Liang-Chi Hsieh"}}, "url": "https://github.com/apache/hive/commit/4a7f6c2b47abaf27312c48279923d241f4fd4bd6", "committedDate": "2020-11-16T18:03:46Z", "message": "Shade another package."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "996e4d3be2d66e12ea494bc6415d4326c939b75b", "author": {"user": {"login": "viirya", "name": "Liang-Chi Hsieh"}}, "url": "https://github.com/apache/hive/commit/996e4d3be2d66e12ea494bc6415d4326c939b75b", "committedDate": "2020-11-16T18:03:46Z", "message": "Hide guava's ImmutableMap from hive-common APIs."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e4077e9550549e34adafab8f75f61827e59fe5e", "author": {"user": {"login": "viirya", "name": "Liang-Chi Hsieh"}}, "url": "https://github.com/apache/hive/commit/6e4077e9550549e34adafab8f75f61827e59fe5e", "committedDate": "2020-09-24T19:52:19Z", "message": "Hide guava's ImmutableMap from hive-common APIs."}, "afterCommit": {"oid": "996e4d3be2d66e12ea494bc6415d4326c939b75b", "author": {"user": {"login": "viirya", "name": "Liang-Chi Hsieh"}}, "url": "https://github.com/apache/hive/commit/996e4d3be2d66e12ea494bc6415d4326c939b75b", "committedDate": "2020-11-16T18:03:46Z", "message": "Hide guava's ImmutableMap from hive-common APIs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd930f271d203b45e15e470ba59fdc97161cc313", "author": {"user": {"login": "viirya", "name": "Liang-Chi Hsieh"}}, "url": "https://github.com/apache/hive/commit/bd930f271d203b45e15e470ba59fdc97161cc313", "committedDate": "2020-11-16T18:22:48Z", "message": "Include org.apache.calcite to avoid test failure."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6754070fd109fab902c472f5fe489501d51e32b2", "author": {"user": {"login": "viirya", "name": "Liang-Chi Hsieh"}}, "url": "https://github.com/apache/hive/commit/6754070fd109fab902c472f5fe489501d51e32b2", "committedDate": "2020-11-16T19:38:24Z", "message": "Update pom files."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4846ed3ef5b4bb600586e201ec3b86a1c0edd871", "author": {"user": {"login": "viirya", "name": "Liang-Chi Hsieh"}}, "url": "https://github.com/apache/hive/commit/4846ed3ef5b4bb600586e201ec3b86a1c0edd871", "committedDate": "2020-11-17T02:47:04Z", "message": "Trigger Build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMjI4NDQ2", "url": "https://github.com/apache/hive/pull/1356#pullrequestreview-541228446", "createdAt": "2020-11-30T19:34:14Z", "commit": {"oid": "4846ed3ef5b4bb600586e201ec3b86a1c0edd871"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxOTozNDoxNFrOH8Ke8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxOTozNDoxNFrOH8Ke8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg0ODM3MA==", "bodyText": "hmm why we need two hive-metastore dependencies (one with tests classifier)? I don't see this in the original patch.", "url": "https://github.com/apache/hive/pull/1356#discussion_r532848370", "createdAt": "2020-11-30T19:34:14Z", "author": {"login": "sunchao"}, "path": "itests/hive-blobstore/pom.xml", "diffHunk": "@@ -55,33 +55,33 @@\n     </dependency>\n     <dependency>\n       <groupId>org.apache.hive</groupId>\n-      <artifactId>hive-metastore</artifactId>\n+      <artifactId>hive-exec</artifactId>\n       <version>${project.version}</version>\n       <scope>test</scope>\n     </dependency>\n     <dependency>\n       <groupId>org.apache.hive</groupId>\n       <artifactId>hive-metastore</artifactId>\n       <version>${project.version}</version>\n-      <classifier>tests</classifier>\n       <scope>test</scope>\n     </dependency>\n     <dependency>\n       <groupId>org.apache.hive</groupId>\n-      <artifactId>hive-it-unit</artifactId>\n+      <artifactId>hive-metastore</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4846ed3ef5b4bb600586e201ec3b86a1c0edd871"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxNDYzMzcy", "url": "https://github.com/apache/hive/pull/1356#pullrequestreview-541463372", "createdAt": "2020-12-01T03:28:58Z", "commit": {"oid": "4846ed3ef5b4bb600586e201ec3b86a1c0edd871"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3412, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}