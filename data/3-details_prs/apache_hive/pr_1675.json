{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxNTY2NzUw", "number": 1675, "title": "HIVE-23197", "bodyText": "", "createdAt": "2020-11-16T10:27:16Z", "url": "https://github.com/apache/hive/pull/1675", "merged": true, "mergeCommit": {"oid": "dfb74e6f6e8c84ca22693beea5e8e488e3bd358b"}, "closed": true, "closedAt": "2020-11-18T10:02:08Z", "author": {"login": "szlta"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddCXIhgH2gAyNTIxNTY2NzUwOmQzZThmZjU2MDU2MDZkOGM2MGZmYzM4YTU5Mzc0YmI0Y2VhNGIxYzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddq-0aAFqTUzMzI2NjkzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d3e8ff5605606d8c60ffc38a59374bb4cea4b1c9", "author": {"user": {"login": "szlta", "name": "Adam Szita"}}, "url": "https://github.com/apache/hive/commit/d3e8ff5605606d8c60ffc38a59374bb4cea4b1c9", "committedDate": "2020-11-16T10:26:07Z", "message": "HIVE-23197: Implement selective purge for LRFU\n\nChange-Id: If4b6b20ce31d844318b6310db476af87216cbea4"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMTk0NDgz", "url": "https://github.com/apache/hive/pull/1675#pullrequestreview-531194483", "createdAt": "2020-11-16T10:30:33Z", "commit": {"oid": "d3e8ff5605606d8c60ffc38a59374bb4cea4b1c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDozMDozNFrOHzz-RQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDozMDozNFrOHzz-RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA5MDk0OQ==", "bodyText": "Why is this?", "url": "https://github.com/apache/hive/pull/1675#discussion_r524090949", "createdAt": "2020-11-16T10:30:34Z", "author": {"login": "pvary"}, "path": "llap-server/src/java/org/apache/hadoop/hive/llap/cache/LowLevelLrfuCachePolicy.java", "diffHunk": "@@ -147,7 +152,9 @@ public void notifyLock(LlapCacheableBuffer buffer) {\n \n   @Override\n   public void notifyUnlock(LlapCacheableBuffer buffer) {\n-\n+    if (proactiveEvictionEnabled) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3e8ff5605606d8c60ffc38a59374bb4cea4b1c9"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMjE2MzAz", "url": "https://github.com/apache/hive/pull/1675#pullrequestreview-531216303", "createdAt": "2020-11-16T10:59:42Z", "commit": {"oid": "d3e8ff5605606d8c60ffc38a59374bb4cea4b1c9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDo1OTo0M1rOHz17Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDo1OTo0M1rOHz17Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDEyMjkyMw==", "bodyText": "Have I told you that I hate continue?\nThis is basically an if/else in disguise :(", "url": "https://github.com/apache/hive/pull/1675#discussion_r524122923", "createdAt": "2020-11-16T10:59:43Z", "author": {"login": "pvary"}, "path": "llap-server/src/java/org/apache/hadoop/hive/llap/cache/LowLevelLrfuCachePolicy.java", "diffHunk": "@@ -240,18 +247,38 @@ public void setEvictionListener(EvictionListener listener) {\n     this.evictionListener = listener;\n   }\n \n-  @Override\n-  public long purge() {\n+  private long evictOrPurge(boolean isPurge) {\n     long evicted = 0;\n     LlapCacheableBuffer oldTail;\n     listLock.lock();\n     try {\n       LlapCacheableBuffer current = listTail;\n+      LlapCacheableBuffer lockedHead = null;\n+      LlapCacheableBuffer lockedTail = null;\n       oldTail = listTail;\n       while (current != null) {\n-        boolean canEvict = LlapCacheableBuffer.INVALIDATE_OK == current.invalidate();\n+        // Case for when there is proactive eviction, but current buffer is not marked -> thus need to be kept\n+        if (!isPurge && !current.isMarkedForEviction()) {\n+          LlapCacheableBuffer newCurrent = current.prev;\n+          oldTail = removeFromLocalList(oldTail, current);\n+\n+          current.indexInHeap = LlapCacheableBuffer.IN_LIST;\n+          if (lockedHead != null) {\n+            current.next = lockedHead;\n+            lockedHead.prev = current;\n+            lockedHead = current;\n+          } else {\n+            lockedHead = current;\n+            lockedTail = current;\n+            current.next = null;\n+          }\n+\n+          current = newCurrent;\n+          continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3e8ff5605606d8c60ffc38a59374bb4cea4b1c9"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxMjIwMDQy", "url": "https://github.com/apache/hive/pull/1675#pullrequestreview-531220042", "createdAt": "2020-11-16T11:05:04Z", "commit": {"oid": "d3e8ff5605606d8c60ffc38a59374bb4cea4b1c9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a47608910a7c0c31a8f309c88574edae96483c4e", "author": {"user": {"login": "szlta", "name": "Adam Szita"}}, "url": "https://github.com/apache/hive/commit/a47608910a7c0c31a8f309c88574edae96483c4e", "committedDate": "2020-11-17T10:42:56Z", "message": "Fixing maintaining memory manager state\n\nChange-Id: I6f0604a38d26b3bd7f52afc1ea4cd0cac8a2b109"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMjY2OTM4", "url": "https://github.com/apache/hive/pull/1675#pullrequestreview-533266938", "createdAt": "2020-11-18T09:45:40Z", "commit": {"oid": "a47608910a7c0c31a8f309c88574edae96483c4e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3042, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}