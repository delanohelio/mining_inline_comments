{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNzQ5NDE2", "number": 1528, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNjo0MDo1NFrOEpHYJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMTowOTowM1rOEpxrpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNTQ3OTQyOnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/column/change/AlterTableChangeColumnOperation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxNjo0MDo1NFrOHamReg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODozMTo1OFrOHbWXew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY1MjA5MA==", "bodyText": "required?", "url": "https://github.com/apache/hive/pull/1528#discussion_r497652090", "createdAt": "2020-09-30T16:40:54Z", "author": {"login": "adesh-rao"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/column/change/AlterTableChangeColumnOperation.java", "diffHunk": "@@ -33,6 +35,7 @@\n import org.apache.hadoop.hive.ql.metadata.Partition;\n import org.apache.hadoop.hive.ql.metadata.Table;\n import org.apache.hadoop.hive.serde2.avro.AvroSerdeUtils;\n+import org.apache.spark.util.CollectionsUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0124e648b59dd9c66d7657e87205e562209d8b18"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ0MDA1OQ==", "bodyText": "Removed", "url": "https://github.com/apache/hive/pull/1528#discussion_r498440059", "createdAt": "2020-10-01T18:31:58Z", "author": {"login": "ashish-kumar-sharma"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/column/change/AlterTableChangeColumnOperation.java", "diffHunk": "@@ -33,6 +35,7 @@\n import org.apache.hadoop.hive.ql.metadata.Partition;\n import org.apache.hadoop.hive.ql.metadata.Table;\n import org.apache.hadoop.hive.serde2.avro.AvroSerdeUtils;\n+import org.apache.spark.util.CollectionsUtils;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY1MjA5MA=="}, "originalCommit": {"oid": "0124e648b59dd9c66d7657e87205e562209d8b18"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExODcyNzI3OnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/utils/MetaStoreServerUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMTowNzowN1rOHbFZpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoyNToyN1rOHbWJpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE2MjA4NQ==", "bodyText": "add a null check for columnNames? getColumnNames returns null too.", "url": "https://github.com/apache/hive/pull/1528#discussion_r498162085", "createdAt": "2020-10-01T11:07:07Z", "author": {"login": "adesh-rao"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/utils/MetaStoreServerUtils.java", "diffHunk": "@@ -1554,4 +1555,30 @@ public static Partition createMetaPartitionObject(Table tbl, Map<String, String>\n     }\n     return tpart;\n   }\n+\n+  /**\n+   * Validate bucket columns should belong to table columns.\n+   * @param sd StorageDescriptor of given table\n+   * @return true if bucket columns are empty or belong to table columns else false\n+   */\n+  public static boolean validateBucketColumns(StorageDescriptor sd) {\n+    if (CollectionUtils.isNotEmpty(sd.getBucketCols())) {\n+      List<String> columnNames =\n+          getColumnNames(sd.getCols()).stream().map(String::toLowerCase).collect(Collectors.toList());\n+      return columnNames.containsAll(sd.getBucketCols().stream().map(String::toLowerCase).collect(Collectors.toList()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0124e648b59dd9c66d7657e87205e562209d8b18"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzNjUxNw==", "bodyText": "Done", "url": "https://github.com/apache/hive/pull/1528#discussion_r498436517", "createdAt": "2020-10-01T18:25:27Z", "author": {"login": "ashish-kumar-sharma"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/utils/MetaStoreServerUtils.java", "diffHunk": "@@ -1554,4 +1555,30 @@ public static Partition createMetaPartitionObject(Table tbl, Map<String, String>\n     }\n     return tpart;\n   }\n+\n+  /**\n+   * Validate bucket columns should belong to table columns.\n+   * @param sd StorageDescriptor of given table\n+   * @return true if bucket columns are empty or belong to table columns else false\n+   */\n+  public static boolean validateBucketColumns(StorageDescriptor sd) {\n+    if (CollectionUtils.isNotEmpty(sd.getBucketCols())) {\n+      List<String> columnNames =\n+          getColumnNames(sd.getCols()).stream().map(String::toLowerCase).collect(Collectors.toList());\n+      return columnNames.containsAll(sd.getBucketCols().stream().map(String::toLowerCase).collect(Collectors.toList()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE2MjA4NQ=="}, "originalCommit": {"oid": "0124e648b59dd9c66d7657e87205e562209d8b18"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExODcyOTA3OnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/TestHiveMetaStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMTowNzo0MFrOHbFauw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoyNTozN1rOHbWJ5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE2MjM2Mw==", "bodyText": "required?", "url": "https://github.com/apache/hive/pull/1528#discussion_r498162363", "createdAt": "2020-10-01T11:07:40Z", "author": {"login": "adesh-rao"}, "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/TestHiveMetaStore.java", "diffHunk": "@@ -63,6 +64,8 @@\n import org.datanucleus.api.jdo.JDOPersistenceManagerFactory;\n import org.junit.Assert;\n import org.junit.Before;\n+import org.junit.experimental.categories.Category;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0124e648b59dd9c66d7657e87205e562209d8b18"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzNjU4Mg==", "bodyText": "removed", "url": "https://github.com/apache/hive/pull/1528#discussion_r498436582", "createdAt": "2020-10-01T18:25:37Z", "author": {"login": "ashish-kumar-sharma"}, "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/TestHiveMetaStore.java", "diffHunk": "@@ -63,6 +64,8 @@\n import org.datanucleus.api.jdo.JDOPersistenceManagerFactory;\n import org.junit.Assert;\n import org.junit.Before;\n+import org.junit.experimental.categories.Category;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE2MjM2Mw=="}, "originalCommit": {"oid": "0124e648b59dd9c66d7657e87205e562209d8b18"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExODc0MTQyOnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/TestHiveMetaStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMToxMTozN1rOHbFiUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODozMToxMVrOHbWV9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE2NDMwNg==", "bodyText": "Won't adding a qtest be better?\nYou are explicitly doing tblUpdated.getSd().getBucketCols() and updating them in the test. qtest will check end to end flow and you don't need to bother about getting Sd and updating the cols explicitly (Just a single alter table will do the trick).", "url": "https://github.com/apache/hive/pull/1528#discussion_r498164306", "createdAt": "2020-10-01T11:11:37Z", "author": {"login": "adesh-rao"}, "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/TestHiveMetaStore.java", "diffHunk": "@@ -3428,4 +3432,44 @@ public void testUpdatePartitionStat_doesNotUpdateStats() throws Exception {\n     m.invoke(hms, tbl, part, false, null);\n     verify(wh, never()).getFileStatusesForLocation(part.getSd().getLocation());\n   }\n+\n+  @Test(expected = InvalidOperationException.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0124e648b59dd9c66d7657e87205e562209d8b18"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzOTY3MA==", "bodyText": "Method is added in standalone metastore. So we need to add some unit test case in some form to validate the code the while building the standalone.", "url": "https://github.com/apache/hive/pull/1528#discussion_r498439670", "createdAt": "2020-10-01T18:31:11Z", "author": {"login": "ashish-kumar-sharma"}, "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/TestHiveMetaStore.java", "diffHunk": "@@ -3428,4 +3432,44 @@ public void testUpdatePartitionStat_doesNotUpdateStats() throws Exception {\n     m.invoke(hms, tbl, part, false, null);\n     verify(wh, never()).getFileStatusesForLocation(part.getSd().getLocation());\n   }\n+\n+  @Test(expected = InvalidOperationException.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE2NDMwNg=="}, "originalCommit": {"oid": "0124e648b59dd9c66d7657e87205e562209d8b18"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExODc0NTIzOnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/TestHiveMetaStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxMToxMjo1NFrOHbFkuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODozMTo0NFrOHbWXBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE2NDkyMQ==", "bodyText": "Also, Is it a positive test case or negative? I see that there is an expected error but we are doing the positive validations too. We should break this into two, right?", "url": "https://github.com/apache/hive/pull/1528#discussion_r498164921", "createdAt": "2020-10-01T11:12:54Z", "author": {"login": "adesh-rao"}, "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/TestHiveMetaStore.java", "diffHunk": "@@ -3428,4 +3432,44 @@ public void testUpdatePartitionStat_doesNotUpdateStats() throws Exception {\n     m.invoke(hms, tbl, part, false, null);\n     verify(wh, never()).getFileStatusesForLocation(part.getSd().getLocation());\n   }\n+\n+  @Test(expected = InvalidOperationException.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0124e648b59dd9c66d7657e87205e562209d8b18"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzOTk0Mw==", "bodyText": "Divided the test in negative and positive", "url": "https://github.com/apache/hive/pull/1528#discussion_r498439943", "createdAt": "2020-10-01T18:31:44Z", "author": {"login": "ashish-kumar-sharma"}, "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/TestHiveMetaStore.java", "diffHunk": "@@ -3428,4 +3432,44 @@ public void testUpdatePartitionStat_doesNotUpdateStats() throws Exception {\n     m.invoke(hms, tbl, part, false, null);\n     verify(wh, never()).getFileStatusesForLocation(part.getSd().getLocation());\n   }\n+\n+  @Test(expected = InvalidOperationException.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODE2NDkyMQ=="}, "originalCommit": {"oid": "0124e648b59dd9c66d7657e87205e562209d8b18"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTc0MzUxOnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/column/change/AlterTableChangeColumnOperation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoxNTozMFrOHbjRVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0OTozMVrOHbyvxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1MTQ3OA==", "bodyText": "Should we store it in lower-case?", "url": "https://github.com/apache/hive/pull/1528#discussion_r498651478", "createdAt": "2020-10-02T07:15:30Z", "author": {"login": "sankarh"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/column/change/AlterTableChangeColumnOperation.java", "diffHunk": "@@ -72,6 +74,10 @@ protected void doAlteration(Table table, Partition partition) throws HiveExcepti\n         if (desc.getNewColumnComment() != null) {\n           oldColumn.setComment(desc.getNewColumnComment());\n         }\n+        if (CollectionUtils.isNotEmpty(sd.getBucketCols()) && sd.getBucketCols().contains(oldColumnName)) {\n+          sd.getBucketCols().remove(oldColumnName);\n+          sd.getBucketCols().add(desc.getNewColumnName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca8ef861c96028c04119f22334c834e4fc91de0f"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwNTAyOA==", "bodyText": "newColumnName is converted toLowerCase in query planning while populating \"desc\" but to be fail safe i have added toLowerCase() here also.", "url": "https://github.com/apache/hive/pull/1528#discussion_r498905028", "createdAt": "2020-10-02T15:49:31Z", "author": {"login": "ashish-kumar-sharma"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/column/change/AlterTableChangeColumnOperation.java", "diffHunk": "@@ -72,6 +74,10 @@ protected void doAlteration(Table table, Partition partition) throws HiveExcepti\n         if (desc.getNewColumnComment() != null) {\n           oldColumn.setComment(desc.getNewColumnComment());\n         }\n+        if (CollectionUtils.isNotEmpty(sd.getBucketCols()) && sd.getBucketCols().contains(oldColumnName)) {\n+          sd.getBucketCols().remove(oldColumnName);\n+          sd.getBucketCols().add(desc.getNewColumnName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1MTQ3OA=="}, "originalCommit": {"oid": "ca8ef861c96028c04119f22334c834e4fc91de0f"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTc0NDM4OnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/column/change/AlterTableChangeColumnOperation.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoxNTo1OFrOHbjR9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0ODowNFrOHbysqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1MTYzOA==", "bodyText": "Is oldColumnName case in-sensitive?", "url": "https://github.com/apache/hive/pull/1528#discussion_r498651638", "createdAt": "2020-10-02T07:15:58Z", "author": {"login": "sankarh"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/column/change/AlterTableChangeColumnOperation.java", "diffHunk": "@@ -72,6 +74,10 @@ protected void doAlteration(Table table, Partition partition) throws HiveExcepti\n         if (desc.getNewColumnComment() != null) {\n           oldColumn.setComment(desc.getNewColumnComment());\n         }\n+        if (CollectionUtils.isNotEmpty(sd.getBucketCols()) && sd.getBucketCols().contains(oldColumnName)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca8ef861c96028c04119f22334c834e4fc91de0f"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwNDIzMg==", "bodyText": "As per HIVE column contract it should be case in-sensitive. But it is not handled properly in  query planning of \"alter table {tablename} change\". So I have added toLowerCase() in query planning also.", "url": "https://github.com/apache/hive/pull/1528#discussion_r498904232", "createdAt": "2020-10-02T15:48:04Z", "author": {"login": "ashish-kumar-sharma"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/column/change/AlterTableChangeColumnOperation.java", "diffHunk": "@@ -72,6 +74,10 @@ protected void doAlteration(Table table, Partition partition) throws HiveExcepti\n         if (desc.getNewColumnComment() != null) {\n           oldColumn.setComment(desc.getNewColumnComment());\n         }\n+        if (CollectionUtils.isNotEmpty(sd.getBucketCols()) && sd.getBucketCols().contains(oldColumnName)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1MTYzOA=="}, "originalCommit": {"oid": "ca8ef861c96028c04119f22334c834e4fc91de0f"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMTc0ODU1OnYy", "diffSide": "RIGHT", "path": "ql/src/test/queries/clientpositive/alter_bucketedtable_change_column.q", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwNzoxNzoyOFrOHbjUbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0NToxOFrOHbymhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1MjI2OA==", "bodyText": "Add test for column names with mix of upper and lower case letters.", "url": "https://github.com/apache/hive/pull/1528#discussion_r498652268", "createdAt": "2020-10-02T07:17:28Z", "author": {"login": "sankarh"}, "path": "ql/src/test/queries/clientpositive/alter_bucketedtable_change_column.q", "diffHunk": "@@ -0,0 +1,10 @@\n+--! qt:dataset:src\n+create table alter_bucket_change_col_t1(key string, value string) partitioned by (ds string) clustered by (key) into 10 buckets;\n+\n+describe formatted alter_bucket_change_col_t1;\n+\n+-- Test changing name of bucket column\n+\n+alter table alter_bucket_change_col_t1 change key keys string;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca8ef861c96028c04119f22334c834e4fc91de0f"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwMjY2MA==", "bodyText": "added - \"Serial_Num\" which cover lower case, Upper case and also special char.", "url": "https://github.com/apache/hive/pull/1528#discussion_r498902660", "createdAt": "2020-10-02T15:45:18Z", "author": {"login": "ashish-kumar-sharma"}, "path": "ql/src/test/queries/clientpositive/alter_bucketedtable_change_column.q", "diffHunk": "@@ -0,0 +1,10 @@\n+--! qt:dataset:src\n+create table alter_bucket_change_col_t1(key string, value string) partitioned by (ds string) clustered by (key) into 10 buckets;\n+\n+describe formatted alter_bucket_change_col_t1;\n+\n+-- Test changing name of bucket column\n+\n+alter table alter_bucket_change_col_t1 change key keys string;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY1MjI2OA=="}, "originalCommit": {"oid": "ca8ef861c96028c04119f22334c834e4fc91de0f"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMjM0MzM5OnYy", "diffSide": "RIGHT", "path": "ql/src/test/queries/clientpositive/alter_numbuckets_partitioned_table_h23.q", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMDo0MTozM1rOHbpHSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0NDoyNlrOHbykgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc0NzIxMQ==", "bodyText": "Also check the output of \"show create table\" command.", "url": "https://github.com/apache/hive/pull/1528#discussion_r498747211", "createdAt": "2020-10-02T10:41:33Z", "author": {"login": "sankarh"}, "path": "ql/src/test/queries/clientpositive/alter_numbuckets_partitioned_table_h23.q", "diffHunk": "@@ -52,6 +52,12 @@ alter table tst1_n1 clustered by (value) into 12 buckets;\n \n describe formatted tst1_n1;\n \n+-- Test changing name of bucket column\n+\n+alter table tst1_n1 change key keys string;\n+\n+describe formatted tst1_n1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbe784cacf5c90eed347428699eab0c5a3420d47"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwMjE0Nw==", "bodyText": "after adding show create table test start failing. because result expect \"### masked information ####\". which lead to multiple test failure. The information shown by show create table is same as describe table as we are only change column name. Hence after multiple retry I decide to remove it.", "url": "https://github.com/apache/hive/pull/1528#discussion_r498902147", "createdAt": "2020-10-02T15:44:26Z", "author": {"login": "ashish-kumar-sharma"}, "path": "ql/src/test/queries/clientpositive/alter_numbuckets_partitioned_table_h23.q", "diffHunk": "@@ -52,6 +52,12 @@ alter table tst1_n1 clustered by (value) into 12 buckets;\n \n describe formatted tst1_n1;\n \n+-- Test changing name of bucket column\n+\n+alter table tst1_n1 change key keys string;\n+\n+describe formatted tst1_n1;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc0NzIxMQ=="}, "originalCommit": {"oid": "bbe784cacf5c90eed347428699eab0c5a3420d47"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMjQwMDgyOnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/HiveAlterHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMTowNDoyOFrOHbpq3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0NDoxMlrOHbyj5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc1NjMxNw==", "bodyText": "Useful to add an error log with the column name which is missing from table columns list.", "url": "https://github.com/apache/hive/pull/1528#discussion_r498756317", "createdAt": "2020-10-02T11:04:28Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/HiveAlterHandler.java", "diffHunk": "@@ -130,6 +130,11 @@ public void alterTable(RawStore msdb, Warehouse wh, String catName, String dbnam\n       throw new InvalidOperationException(\"Invalid column \" + validate);\n     }\n \n+    // Validate bucketedColumns in new table\n+    if (!MetaStoreServerUtils.validateBucketColumns(newt.getSd())) {\n+      throw new InvalidOperationException(\"Bucket column doesn't match with any table columns\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbe784cacf5c90eed347428699eab0c5a3420d47"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwMTk5MA==", "bodyText": "Converted return type to List.\nAdded Log.error() along with column name.\nAdded column to exception also.", "url": "https://github.com/apache/hive/pull/1528#discussion_r498901990", "createdAt": "2020-10-02T15:44:12Z", "author": {"login": "ashish-kumar-sharma"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/HiveAlterHandler.java", "diffHunk": "@@ -130,6 +130,11 @@ public void alterTable(RawStore msdb, Warehouse wh, String catName, String dbnam\n       throw new InvalidOperationException(\"Invalid column \" + validate);\n     }\n \n+    // Validate bucketedColumns in new table\n+    if (!MetaStoreServerUtils.validateBucketColumns(newt.getSd())) {\n+      throw new InvalidOperationException(\"Bucket column doesn't match with any table columns\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc1NjMxNw=="}, "originalCommit": {"oid": "bbe784cacf5c90eed347428699eab0c5a3420d47"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMjQwNjUyOnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/utils/MetaStoreServerUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMTowNzowNFrOHbpuoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0MjowMFrOHbyfMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc1NzI4MA==", "bodyText": "Check if CollectionUtils.isEmpty(sd.getBucketCols()) case even before getting table columns list and return true. It will avoid repeated checks below and also avoids unnecessary computes for non-bucketed tables.", "url": "https://github.com/apache/hive/pull/1528#discussion_r498757280", "createdAt": "2020-10-02T11:07:04Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/utils/MetaStoreServerUtils.java", "diffHunk": "@@ -1554,4 +1555,32 @@ public static Partition createMetaPartitionObject(Table tbl, Map<String, String>\n     }\n     return tpart;\n   }\n+\n+  /**\n+   * Validate bucket columns should belong to table columns.\n+   * @param sd StorageDescriptor of given table\n+   * @return true if bucket columns are empty or belong to table columns else false\n+   */\n+  public static boolean validateBucketColumns(StorageDescriptor sd) {\n+    List<String> columnNames = getColumnNames(sd.getCols());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbe784cacf5c90eed347428699eab0c5a3420d47"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwMDc4Ng==", "bodyText": "Done", "url": "https://github.com/apache/hive/pull/1528#discussion_r498900786", "createdAt": "2020-10-02T15:42:00Z", "author": {"login": "ashish-kumar-sharma"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/utils/MetaStoreServerUtils.java", "diffHunk": "@@ -1554,4 +1555,32 @@ public static Partition createMetaPartitionObject(Table tbl, Map<String, String>\n     }\n     return tpart;\n   }\n+\n+  /**\n+   * Validate bucket columns should belong to table columns.\n+   * @param sd StorageDescriptor of given table\n+   * @return true if bucket columns are empty or belong to table columns else false\n+   */\n+  public static boolean validateBucketColumns(StorageDescriptor sd) {\n+    List<String> columnNames = getColumnNames(sd.getCols());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc1NzI4MA=="}, "originalCommit": {"oid": "bbe784cacf5c90eed347428699eab0c5a3420d47"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMjQwNzEwOnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/utils/MetaStoreServerUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMTowNzoyM1rOHbpvBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0MTo0N1rOHbyerw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc1NzM4MA==", "bodyText": "nit: Add space before \"(\"", "url": "https://github.com/apache/hive/pull/1528#discussion_r498757380", "createdAt": "2020-10-02T11:07:23Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/utils/MetaStoreServerUtils.java", "diffHunk": "@@ -1554,4 +1555,32 @@ public static Partition createMetaPartitionObject(Table tbl, Map<String, String>\n     }\n     return tpart;\n   }\n+\n+  /**\n+   * Validate bucket columns should belong to table columns.\n+   * @param sd StorageDescriptor of given table\n+   * @return true if bucket columns are empty or belong to table columns else false\n+   */\n+  public static boolean validateBucketColumns(StorageDescriptor sd) {\n+    List<String> columnNames = getColumnNames(sd.getCols());\n+    if(CollectionUtils.isNotEmpty(sd.getBucketCols()) &&  CollectionUtils.isNotEmpty(columnNames)){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbe784cacf5c90eed347428699eab0c5a3420d47"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwMDY1NQ==", "bodyText": "Done", "url": "https://github.com/apache/hive/pull/1528#discussion_r498900655", "createdAt": "2020-10-02T15:41:47Z", "author": {"login": "ashish-kumar-sharma"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/utils/MetaStoreServerUtils.java", "diffHunk": "@@ -1554,4 +1555,32 @@ public static Partition createMetaPartitionObject(Table tbl, Map<String, String>\n     }\n     return tpart;\n   }\n+\n+  /**\n+   * Validate bucket columns should belong to table columns.\n+   * @param sd StorageDescriptor of given table\n+   * @return true if bucket columns are empty or belong to table columns else false\n+   */\n+  public static boolean validateBucketColumns(StorageDescriptor sd) {\n+    List<String> columnNames = getColumnNames(sd.getCols());\n+    if(CollectionUtils.isNotEmpty(sd.getBucketCols()) &&  CollectionUtils.isNotEmpty(columnNames)){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc1NzM4MA=="}, "originalCommit": {"oid": "bbe784cacf5c90eed347428699eab0c5a3420d47"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyMjQxMDYwOnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/utils/MetaStoreServerUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMTowOTowM1rOHbpxXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNTo0MTozNVrOHbyeNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc1Nzk4MQ==", "bodyText": "Will cols always have names in lower case?", "url": "https://github.com/apache/hive/pull/1528#discussion_r498757981", "createdAt": "2020-10-02T11:09:03Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/utils/MetaStoreServerUtils.java", "diffHunk": "@@ -1554,4 +1555,32 @@ public static Partition createMetaPartitionObject(Table tbl, Map<String, String>\n     }\n     return tpart;\n   }\n+\n+  /**\n+   * Validate bucket columns should belong to table columns.\n+   * @param sd StorageDescriptor of given table\n+   * @return true if bucket columns are empty or belong to table columns else false\n+   */\n+  public static boolean validateBucketColumns(StorageDescriptor sd) {\n+    List<String> columnNames = getColumnNames(sd.getCols());\n+    if(CollectionUtils.isNotEmpty(sd.getBucketCols()) &&  CollectionUtils.isNotEmpty(columnNames)){\n+      return columnNames.containsAll(sd.getBucketCols().stream().map(String::toLowerCase).collect(Collectors.toList()));\n+    } else if (CollectionUtils.isNotEmpty(sd.getBucketCols()) &&  CollectionUtils.isEmpty(columnNames)) {\n+      return false;\n+    } else {\n+      return true;\n+    }\n+  }\n+\n+  /**\n+   * Generate column name list  from the fieldSchema list\n+   * @param cols fieldSchema list\n+   * @return column name list\n+   */\n+  public static List<String> getColumnNames(List<FieldSchema> cols) {\n+    if (CollectionUtils.isNotEmpty(cols)) {\n+      return cols.stream().map(FieldSchema::getName).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbe784cacf5c90eed347428699eab0c5a3420d47"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkwMDUzNQ==", "bodyText": "Expected column name in lower case. But in order to be fail safe added toLowerCase() here also.", "url": "https://github.com/apache/hive/pull/1528#discussion_r498900535", "createdAt": "2020-10-02T15:41:35Z", "author": {"login": "ashish-kumar-sharma"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/utils/MetaStoreServerUtils.java", "diffHunk": "@@ -1554,4 +1555,32 @@ public static Partition createMetaPartitionObject(Table tbl, Map<String, String>\n     }\n     return tpart;\n   }\n+\n+  /**\n+   * Validate bucket columns should belong to table columns.\n+   * @param sd StorageDescriptor of given table\n+   * @return true if bucket columns are empty or belong to table columns else false\n+   */\n+  public static boolean validateBucketColumns(StorageDescriptor sd) {\n+    List<String> columnNames = getColumnNames(sd.getCols());\n+    if(CollectionUtils.isNotEmpty(sd.getBucketCols()) &&  CollectionUtils.isNotEmpty(columnNames)){\n+      return columnNames.containsAll(sd.getBucketCols().stream().map(String::toLowerCase).collect(Collectors.toList()));\n+    } else if (CollectionUtils.isNotEmpty(sd.getBucketCols()) &&  CollectionUtils.isEmpty(columnNames)) {\n+      return false;\n+    } else {\n+      return true;\n+    }\n+  }\n+\n+  /**\n+   * Generate column name list  from the fieldSchema list\n+   * @param cols fieldSchema list\n+   * @return column name list\n+   */\n+  public static List<String> getColumnNames(List<FieldSchema> cols) {\n+    if (CollectionUtils.isNotEmpty(cols)) {\n+      return cols.stream().map(FieldSchema::getName).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc1Nzk4MQ=="}, "originalCommit": {"oid": "bbe784cacf5c90eed347428699eab0c5a3420d47"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 295, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}