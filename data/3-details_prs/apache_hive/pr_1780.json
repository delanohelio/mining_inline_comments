{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5ODEzMjM3", "number": 1780, "title": "HIVE-24534 HIVE-24646: Strict checks between decimal/characters & bigint/doubles", "bodyText": "What changes were proposed in this pull request?\nThrow an error when hive.strict.checks.type.safety=true and the query contains comparison between decimals and character or bigint and double types.\nWhy are the changes needed?\nTo fail-fast and avoid unexpected query results. Examples in HIVE-24534.\nStrict type checks between bigint and double types was implemented before but due to a bug it was not throwing an error but just a warning.\nDoes this PR introduce any user-facing change?\nQueries relying on comparisons between decimal and character  or  bigint and double types will fail.\nHow was this patch tested?\nmvn clean test -Dtest=TestNegativeCliDriver -Dqfile_regex=\"strict_type_decimal.*\" -Dtest.output.overwrite\nmvn test -Dtest=TestDecimalStringValidation", "createdAt": "2020-12-14T21:31:43Z", "url": "https://github.com/apache/hive/pull/1780", "merged": true, "mergeCommit": {"oid": "624d420d2d7bff53057389e6d45f83ca02a0524e"}, "closed": true, "closedAt": "2021-01-19T15:15:04Z", "author": {"login": "zabetak"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmUKgWAFqTU1MjEzMDc4OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdxUKDCAFqTU3MDM1MDUwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTMwNzg5", "url": "https://github.com/apache/hive/pull/1780#pullrequestreview-552130789", "createdAt": "2020-12-15T06:06:24Z", "commit": {"oid": "0e32034d7236695f19e5663df7720d4f3d44a6c4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjowNjoyNFrOIF6bjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjowNjoyNFrOIF6bjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3MTExOQ==", "bodyText": "These rules are seem to be constant. Can you please extract them?\nprivate static final Set<Set<PrimitiveObjectInspector.PrimitiveCategory>> decimalCharacterComparisonRules =\n  Collections.unmodifiableSet(new HashSet<>() {{add(...)...}})", "url": "https://github.com/apache/hive/pull/1780#discussion_r543071119", "createdAt": "2020-12-15T06:06:24Z", "author": {"login": "kasakrisz"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/type/TypeCheckProcFactory.java", "diffHunk": "@@ -801,6 +797,22 @@ private boolean unSafeCompareWithBigInt(TypeInfo otherTypeInfo, TypeInfo bigintC\n       }\n       return false;\n     }\n+    \n+    private boolean isDecimalCharacterComparison(TypeInfo type1, TypeInfo type2) {\n+      if(type1 instanceof PrimitiveTypeInfo && type2 instanceof PrimitiveTypeInfo) {\n+        Set<Set<PrimitiveObjectInspector.PrimitiveCategory>> comparisons = new HashSet<>(3);\n+        comparisons.add(EnumSet.of(\n+            PrimitiveObjectInspector.PrimitiveCategory.DECIMAL, PrimitiveObjectInspector.PrimitiveCategory.CHAR));\n+        comparisons.add(EnumSet.of(\n+            PrimitiveObjectInspector.PrimitiveCategory.DECIMAL, PrimitiveObjectInspector.PrimitiveCategory.VARCHAR));\n+        comparisons.add(EnumSet.of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e32034d7236695f19e5663df7720d4f3d44a6c4"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjA4MTcx", "url": "https://github.com/apache/hive/pull/1780#pullrequestreview-552608171", "createdAt": "2020-12-15T15:57:08Z", "commit": {"oid": "ab7432b6f8af27755acc28b2034fd2d3870c0207"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "394daf6924ef5580ea48a0d844f013b01ad6ccf4", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/394daf6924ef5580ea48a0d844f013b01ad6ccf4", "committedDate": "2021-01-15T19:01:24Z", "message": "HIVE-24534: Prevent comparisons between character and decimals types when strict checks enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1797c1aa38f8cbd59cba2b1e5307763ff1945fc", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/a1797c1aa38f8cbd59cba2b1e5307763ff1945fc", "committedDate": "2021-01-15T19:01:24Z", "message": "HIVE-24534: Add function call validation tests for chars and decimals"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "453f684fe5cdcb2a771ca9e018300fc3a13493f3", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/453f684fe5cdcb2a771ca9e018300fc3a13493f3", "committedDate": "2021-01-15T19:01:24Z", "message": "HIVE-24534: Minor formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5937841473755719e24e601991fc060f254b2ca", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/a5937841473755719e24e601991fc060f254b2ca", "committedDate": "2021-01-15T19:01:44Z", "message": "HIVE-24534: Add qtest negative tests for comparisons between chars and decimals"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0e5f2b71403e7244a0032c7082d6c62a06f1325", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/b0e5f2b71403e7244a0032c7082d6c62a06f1325", "committedDate": "2021-01-15T19:01:47Z", "message": "HIVE-24534: Make decimal/character categories a class constant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ff5d3602e40b2dcfdc25f11e8fb3f50a7912317", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/6ff5d3602e40b2dcfdc25f11e8fb3f50a7912317", "committedDate": "2021-01-15T19:01:47Z", "message": "Run LLAP tests with strict type checks enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37e707705c6cc7c025bbe7fb1b67682062dc84c7", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/37e707705c6cc7c025bbe7fb1b67682062dc84c7", "committedDate": "2021-01-16T00:10:35Z", "message": "HIVE-24534 HIVE-24646: Refactoring for readability and missing functionality\n\nBIG_INT and DOUBLE comparison should fail with strict checks on\naccording to the respective property."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8714f35d8bd463bb3d67eb6e3bbe21a51ff6b563", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/8714f35d8bd463bb3d67eb6e3bbe21a51ff6b563", "committedDate": "2021-01-16T00:10:35Z", "message": "HIVE-24534: Update warning messages of TestMiniLlapLocalCliDriver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "410069e7b5ad3930f3057bbea0126c5d4d2cccd9", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/410069e7b5ad3930f3057bbea0126c5d4d2cccd9", "committedDate": "2021-01-16T00:10:35Z", "message": "HIVE-24534: Update tez_smb_reduce_side.q.out but not sure why it changed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2692a9e0bb92c22b190668462db0c2efe3333bd5", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/2692a9e0bb92c22b190668462db0c2efe3333bd5", "committedDate": "2021-01-16T00:11:00Z", "message": "HIVE-24534 HIVE-24646: Update failing LLAP driver tests\n\nDisable hive.strict.type.checks for the respective files."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab7432b6f8af27755acc28b2034fd2d3870c0207", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/ab7432b6f8af27755acc28b2034fd2d3870c0207", "committedDate": "2020-12-15T09:58:15Z", "message": "HIVE-24534: Make decimal/character categories a class constant"}, "afterCommit": {"oid": "2692a9e0bb92c22b190668462db0c2efe3333bd5", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/2692a9e0bb92c22b190668462db0c2efe3333bd5", "committedDate": "2021-01-16T00:11:00Z", "message": "HIVE-24534 HIVE-24646: Update failing LLAP driver tests\n\nDisable hive.strict.type.checks for the respective files."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e67a8c655aba72bd13ebb4efb4f537c5bca423fe", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/e67a8c655aba72bd13ebb4efb4f537c5bca423fe", "committedDate": "2021-01-18T08:58:43Z", "message": "HIVE-24534: Update tez_smb_reduce_side.q.out file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwMzUwNTAx", "url": "https://github.com/apache/hive/pull/1780#pullrequestreview-570350501", "createdAt": "2021-01-18T10:20:17Z", "commit": {"oid": "e67a8c655aba72bd13ebb4efb4f537c5bca423fe"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOFQxMDoyMDoxN1rOIVinLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOFQxMDoyNzoxNFrOIVi3PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ1ODA5NQ==", "bodyText": "Maybe a loss of precision is more user friendly compared to information.", "url": "https://github.com/apache/hive/pull/1780#discussion_r559458095", "createdAt": "2021-01-18T10:20:17Z", "author": {"login": "dengzhhu653"}, "path": "ql/src/test/results/clientpositive/llap/avrotblsjoin.q.out", "diffHunk": "@@ -71,9 +71,9 @@ POSTHOOK: Input: _dummy_database@_dummy_table\n POSTHOOK: Output: default@table1_1\n POSTHOOK: Lineage: table1_1.col1 SCRIPT []\n POSTHOOK: Lineage: table1_1.col2 SCRIPT []\n-WARNING: Comparing a bigint and a string may result in a loss of precision.\n-WARNING: Comparing a bigint and a string may result in a loss of precision.\n-WARNING: Comparing a bigint and a string may result in a loss of precision.\n+WARNING: Comparing string and bigint may result in loss of information.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e67a8c655aba72bd13ebb4efb4f537c5bca423fe"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTQ2MjIwNQ==", "bodyText": "the result of this qfile seems unrelated to the changes...", "url": "https://github.com/apache/hive/pull/1780#discussion_r559462205", "createdAt": "2021-01-18T10:27:14Z", "author": {"login": "dengzhhu653"}, "path": "ql/src/test/results/clientpositive/llap/partition_wise_fileformat2.q.out", "diffHunk": "@@ -123,31 +123,6 @@ POSTHOOK: Input: default@partition_test_partitioned@dt=102\n \t\t100\n \t\t100\n \t\t100\n-238\tval_238\t102", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e67a8c655aba72bd13ebb4efb4f537c5bca423fe"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2922, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}