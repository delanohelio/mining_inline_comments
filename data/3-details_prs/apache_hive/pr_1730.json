{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxNjk1MzE0", "number": 1730, "title": "HIVE-24475: Generalize fixacidkeyindex utility", "bodyText": "Change-Id: I6b9f501f2804aa5c71ee03cadcea3ec24fdd6005\n\nWhat changes were proposed in this pull request?\n\nThere is a utility in hive which can validate/fix corrupted hive.acid.key.index.\nhive --service fixacidkeyindex\nUnfortunately it is only tailored for a specific problem (https://issues.apache.org/jira/browse/HIVE-18907), instead of generally validating and recovering the hive.acid.key.index from the stripe data itself.\nThe PR generalize the validation/recovery by checking/rebuilding the hive.acid.key.index from the data itself.\nWhy are the changes needed?\n\nThe name fixacidkeyindex suggests that this is a general validation/fixer tool for the index.\nDoes this PR introduce any user-facing change?\n\nhiveconf params can now be specified to the tool, to minimize the diff in the recovered file. (E.g: --hiveconf hive.exec.orc.default.block.padding=false)\nHow was this patch tested?\n\nUnit test and manual testing.", "createdAt": "2020-12-03T11:04:19Z", "url": "https://github.com/apache/hive/pull/1730", "merged": true, "mergeCommit": {"oid": "a0c9f8eef6b171ef581c99492ccde5954ca2f0c2"}, "closed": true, "closedAt": "2020-12-09T08:52:21Z", "author": {"login": "asinkovits"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiftyoAH2gAyNTMxNjk1MzE0OjBmZmI0YjMyNzYxY2M0NGQ1MGFmMDk0OGM2Y2Q5Y2M5ZjY3ZWU5NTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj4mWAgH2gAyNTMxNjk1MzE0Ojk5NTUyNGZkZGViNmRhYTBlN2IzZWYwMWFlNzMyMGQxZTU4MmM5Njg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0ffb4b32761cc44d50af0948c6cd9cc9f67ee956", "author": {"user": {"login": "asinkovits", "name": "Antal Sinkovits"}}, "url": "https://github.com/apache/hive/commit/0ffb4b32761cc44d50af0948c6cd9cc9f67ee956", "committedDate": "2020-12-03T09:27:44Z", "message": "HIVE-24475: Generalize fixacidkeyindex utility\n\nChange-Id: I6b9f501f2804aa5c71ee03cadcea3ec24fdd6005"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzOTI0MzA5", "url": "https://github.com/apache/hive/pull/1730#pullrequestreview-543924309", "createdAt": "2020-12-03T12:55:56Z", "commit": {"oid": "0ffb4b32761cc44d50af0948c6cd9cc9f67ee956"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjo1NTo1NlrOH-aTNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjo1NTo1NlrOH-aTNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTIwNDY2Mw==", "bodyText": "Shouldn't this check if the index was actually corrected in the new file? It just checks the output of the tool.", "url": "https://github.com/apache/hive/pull/1730#discussion_r535204663", "createdAt": "2020-12-03T12:55:56Z", "author": {"login": "pvargacl"}, "path": "ql/src/test/org/apache/hadoop/hive/ql/io/orc/TestFixAcidKeyIndex.java", "diffHunk": "@@ -243,6 +233,12 @@ public void testInvalidKeyIndex() throws Exception {\n     checkInvalidKeyIndex(testFilePath);\n     // Try fixing, this should result in new fixed file.\n     fixInvalidIndex(testFilePath);\n+\n+    // Multiple stripes\n+    createTestAcidFile(testFilePath, 12000, new FaultyKeyIndexBuilder());\n+    checkInvalidKeyIndex(testFilePath);\n+    // Try fixing, this should result in new fixed file.\n+    fixInvalidIndex(testFilePath);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ffb4b32761cc44d50af0948c6cd9cc9f67ee956"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NjAwNDYz", "url": "https://github.com/apache/hive/pull/1730#pullrequestreview-545600463", "createdAt": "2020-12-05T16:48:18Z", "commit": {"oid": "0ffb4b32761cc44d50af0948c6cd9cc9f67ee956"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQxNjo0ODoxOFrOH_89eQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQxNjo0ODoxOFrOH_89eQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjgyMTExMw==", "bodyText": "Can this be moved out of the loop ?", "url": "https://github.com/apache/hive/pull/1730#discussion_r536821113", "createdAt": "2020-12-05T16:48:18Z", "author": {"login": "maheshk114"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/io/orc/FixAcidKeyIndex.java", "diffHunk": "@@ -163,11 +144,52 @@ static void checkFile(Configuration conf, Path inputPath) throws IOException {\n       return;\n     }\n \n-    boolean validIndex = isAcidKeyIndexValid(reader);\n+    AcidKeyIndexValidationResult validationResult = validate(conf, inputPath);\n+    boolean validIndex = validationResult.isValid;\n     System.out.println(\"Checking \" + inputPath + \" - acid key index is \" +\n         (validIndex ? \"valid\" : \"invalid\"));\n   }\n \n+  public static AcidKeyIndexValidationResult validate(Configuration conf, Path inputPath) throws IOException {\n+    AcidKeyIndexValidationResult result = new AcidKeyIndexValidationResult();\n+    FileSystem fs = inputPath.getFileSystem(conf);\n+    Reader reader = OrcFile.createReader(fs, inputPath);\n+    List<StripeInformation> stripes = reader.getStripes();\n+    RecordIdentifier[] keyIndex = OrcRecordUpdater.parseKeyIndex(reader);\n+    StructObjectInspector soi = (StructObjectInspector) reader.getObjectInspector();\n+    // struct<operation:int,originalTransaction:bigint,bucket:int,rowId:bigint,currentTransaction:bigint\n+\n+    long rowsProcessed = 0;\n+    try (RecordReader rr = reader.rows()) {\n+      for(int i=0; i<stripes.size(); i++) {\n+        rowsProcessed += stripes.get(i).getNumberOfRows();\n+        rr.seekToRow(rowsProcessed-1);\n+        OrcStruct row = (OrcStruct) rr.next(null);\n+\n+        List<? extends StructField> structFields = soi.getAllStructFieldRefs();\n+\n+        StructField transactionField = structFields.get(1);\n+        StructField bucketField = structFields.get(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ffb4b32761cc44d50af0948c6cd9cc9f67ee956"}, "originalPosition": 104}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "995524fddeb6daa0e7b3ef01ae7320d1e582c968", "author": {"user": {"login": "asinkovits", "name": "Antal Sinkovits"}}, "url": "https://github.com/apache/hive/commit/995524fddeb6daa0e7b3ef01ae7320d1e582c968", "committedDate": "2020-12-07T17:01:09Z", "message": "Code review\n\nChange-Id: I074c260204f1049f2e9b0b5fec6fe979d80e248d"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2853, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}