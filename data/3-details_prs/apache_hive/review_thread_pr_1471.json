{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5OTUyODg0", "number": 1471, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQyMTowNDoxMlrOEgoiIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMToyNjo0NFrOEha7zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNjUzOTg3OnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQyMTowNDoxMlrOHNkZHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQyMTowNDoxMlrOHNkZHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4OTc5MQ==", "bodyText": "validateMaterializedViewsFromRegistry is only called if the MV is coming from the registry. However, we need the authorization check in all cases, e.g., dummy registry.\nYou can simply call the new method from Calcite planner.", "url": "https://github.com/apache/hive/pull/1471#discussion_r483989791", "createdAt": "2020-09-05T21:04:12Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java", "diffHunk": "@@ -1736,6 +1768,10 @@ public boolean validateMaterializedViewsFromRegistry(List<Table> cachedMateriali\n       // Final result\n       boolean result = true;\n       for (Table cachedMaterializedViewTable : cachedMaterializedViewTables) {\n+        if (!checkPrivillegeForMV(cachedMaterializedViewTable)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fffd02546e86899d0a499db4cba3814e9bed99f"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNjU0MDIwOnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQyMTowNDo0MVrOHNkZQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQyMTowNDo0MVrOHNkZQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4OTgyNA==", "bodyText": "Can we move this to HiveMaterializedViewUtils?\nThere is also a typo: Privillege", "url": "https://github.com/apache/hive/pull/1471#discussion_r483989824", "createdAt": "2020-09-05T21:04:41Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java", "diffHunk": "@@ -1718,6 +1722,34 @@ public Table apply(org.apache.hadoop.hive.metastore.api.Table table) {\n     }\n   }\n \n+  /**\n+   * Validate if given materialized view has SELECT privileges for current user\n+   * @param cachedMVTable\n+   * @return false if user does not have privilege otherwise true\n+   * @throws HiveException\n+   */\n+  private boolean checkPrivillegeForMV(final Table cachedMVTable) throws HiveException{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fffd02546e86899d0a499db4cba3814e9bed99f"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNjU0MDk1OnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQyMTowNTo0NFrOHNkZkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQyMTowNTo0NFrOHNkZkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4OTkwNg==", "bodyText": "Can we check the privileges for all MVs used by the query at once so we do not need multiple round trips?", "url": "https://github.com/apache/hive/pull/1471#discussion_r483989906", "createdAt": "2020-09-05T21:05:44Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java", "diffHunk": "@@ -1718,6 +1722,34 @@ public Table apply(org.apache.hadoop.hive.metastore.api.Table table) {\n     }\n   }\n \n+  /**\n+   * Validate if given materialized view has SELECT privileges for current user\n+   * @param cachedMVTable\n+   * @return false if user does not have privilege otherwise true\n+   * @throws HiveException\n+   */\n+  private boolean checkPrivillegeForMV(final Table cachedMVTable) throws HiveException{\n+    List<String> colNames =\n+        cachedMVTable.getAllCols().stream()\n+            .map(FieldSchema::getName)\n+            .collect(Collectors.toList());\n+\n+    HivePrivilegeObject privObject = new HivePrivilegeObject(cachedMVTable.getDbName(),\n+        cachedMVTable.getTableName(), colNames);\n+    List<HivePrivilegeObject> privObjects = new ArrayList<HivePrivilegeObject>();\n+    privObjects.add(privObject);\n+    try {\n+      SessionState.get().getAuthorizerV2().\n+          checkPrivileges(HiveOperationType.QUERY, privObjects, privObjects, new HiveAuthzContext.Builder().build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fffd02546e86899d0a499db4cba3814e9bed99f"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNDc5NTIxOnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/CalcitePlanner.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMToyNTo0OFrOHOukEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMToyMTo1NlrOHPaxTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTAwOA==", "bodyText": "nit. typo", "url": "https://github.com/apache/hive/pull/1471#discussion_r485205008", "createdAt": "2020-09-08T21:25:48Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/CalcitePlanner.java", "diffHunk": "@@ -2280,6 +2280,15 @@ private RelNode applyMaterializedViewRewriting(RelOptPlanner planner, RelNode ba\n         return calcitePreMVRewritingPlan;\n       }\n \n+      try {\n+        if (!HiveMaterializedViewUtils.checkPrivilegeForMV(materializedViewsUsedAfterRewrite)) {\n+          // if materialized views do not have appropriate privilges, we shouldn't be using them", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51e0a465ba45b0af889aa633520731f448d816ca"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyOTI5NQ==", "bodyText": "Fixed", "url": "https://github.com/apache/hive/pull/1471#discussion_r485929295", "createdAt": "2020-09-09T21:21:56Z", "author": {"login": "vineetgarg02"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/CalcitePlanner.java", "diffHunk": "@@ -2280,6 +2280,15 @@ private RelNode applyMaterializedViewRewriting(RelOptPlanner planner, RelNode ba\n         return calcitePreMVRewritingPlan;\n       }\n \n+      try {\n+        if (!HiveMaterializedViewUtils.checkPrivilegeForMV(materializedViewsUsedAfterRewrite)) {\n+          // if materialized views do not have appropriate privilges, we shouldn't be using them", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTAwOA=="}, "originalCommit": {"oid": "51e0a465ba45b0af889aa633520731f448d816ca"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzNDc5NzU4OnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/views/HiveMaterializedViewUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMToyNjo0NFrOHOuliQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMToyMTo0OVrOHPaxKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTM4NQ==", "bodyText": "Can we use full name: checkPrivilegeForMaterializedViews ?", "url": "https://github.com/apache/hive/pull/1471#discussion_r485205385", "createdAt": "2020-09-08T21:26:44Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/views/HiveMaterializedViewUtils.java", "diffHunk": "@@ -347,6 +355,38 @@ public static RelNode copyNodeNewCluster(RelOptCluster optCluster, RelNode node)\n     }\n   }\n \n+  /**\n+   * Validate if given materialized view has SELECT privileges for current user\n+   * @param cachedMVTable\n+   * @return false if user does not have privilege otherwise true\n+   * @throws HiveException\n+   */\n+  public static boolean checkPrivilegeForMV(List<Table> cachedMVTableList) throws HiveException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51e0a465ba45b0af889aa633520731f448d816ca"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyOTI1Nw==", "bodyText": "Done", "url": "https://github.com/apache/hive/pull/1471#discussion_r485929257", "createdAt": "2020-09-09T21:21:49Z", "author": {"login": "vineetgarg02"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/views/HiveMaterializedViewUtils.java", "diffHunk": "@@ -347,6 +355,38 @@ public static RelNode copyNodeNewCluster(RelOptCluster optCluster, RelNode node)\n     }\n   }\n \n+  /**\n+   * Validate if given materialized view has SELECT privileges for current user\n+   * @param cachedMVTable\n+   * @return false if user does not have privilege otherwise true\n+   * @throws HiveException\n+   */\n+  public static boolean checkPrivilegeForMV(List<Table> cachedMVTableList) throws HiveException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTM4NQ=="}, "originalCommit": {"oid": "51e0a465ba45b0af889aa633520731f448d816ca"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 418, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}