{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0MTU2MzIy", "number": 1532, "title": "HIVE-20137: truncate for transactional tables", "bodyText": "What changes were proposed in this pull request?\nTruncate table for transactional tables no longer deletes all the data, rather just creates an empty base dir.\nWhy are the changes needed?\nFaster truncate, it can allow concurrent reads\nDoes this PR introduce any user-facing change?\nNo\nHow was this patch tested?\nTests were added", "createdAt": "2020-09-28T13:48:55Z", "url": "https://github.com/apache/hive/pull/1532", "merged": true, "mergeCommit": {"oid": "cbd4a6b5ec4cc9e9d4cbcb2dd122940807b694f7"}, "closed": true, "closedAt": "2020-10-06T07:53:33Z", "author": {"login": "pvargacl"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNT2tKAH2gAyNDk0MTU2MzIyOjdiZWNiYjZlODYyMTVjMjM5YTM3Mzk5NDhiY2JhOGFjYWQ5OTlhYjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPiaKhgFqTUwMTk3Njg5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7becbb6e86215c239a3739948bcba8acad999ab9", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/7becbb6e86215c239a3739948bcba8acad999ab9", "committedDate": "2020-09-28T13:46:12Z", "message": "HIVE-20137: truncate for transactional tables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "639d2f67a0c7a15368b74e97f8f96713a2e42c15", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/639d2f67a0c7a15368b74e97f8f96713a2e42c15", "committedDate": "2020-09-28T20:32:52Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "923e859aa3901bc7eb7193ca623c57679c9404b4", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/923e859aa3901bc7eb7193ca623c57679c9404b4", "committedDate": "2020-09-29T12:05:17Z", "message": "Quickstat overrides truncated values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0a942a9916809e02130647980229c6a3ac76b35", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/d0a942a9916809e02130647980229c6a3ac76b35", "committedDate": "2020-09-29T15:43:13Z", "message": "Quickstat overrides truncated values - test fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMTE5MzY0", "url": "https://github.com/apache/hive/pull/1532#pullrequestreview-500119364", "createdAt": "2020-10-01T08:29:27Z", "commit": {"oid": "d0a942a9916809e02130647980229c6a3ac76b35"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODoyOToyN1rOHa_5tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODozNzowN1rOHbAMMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MTk5MQ==", "bodyText": "could we remove those and reference constants from AcidConstants directly", "url": "https://github.com/apache/hive/pull/1532#discussion_r498071991", "createdAt": "2020-10-01T08:29:27Z", "author": {"login": "deniskuzZ"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/io/AcidUtils.java", "diffHunk": "@@ -114,16 +114,16 @@\n public class AcidUtils {\n   // This key will be put in the conf file when planning an acid operation\n   public static final String CONF_ACID_KEY = \"hive.doing.acid\";\n-  public static final String BASE_PREFIX = \"base_\";\n+  public static final String BASE_PREFIX = AcidConstants.BASE_PREFIX;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0a942a9916809e02130647980229c6a3ac76b35"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3MjQxMw==", "bodyText": "could we rename local var to truncateFiles or something (same as below)", "url": "https://github.com/apache/hive/pull/1532#discussion_r498072413", "createdAt": "2020-10-01T08:30:10Z", "author": {"login": "deniskuzZ"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/misc/truncate/TruncateTableAnalyzer.java", "diffHunk": "@@ -112,23 +113,27 @@ private void checkTruncateEligibility(ASTNode ast, ASTNode root, String tableNam\n \n   private void addTruncateTableOutputs(ASTNode root, Table table, Map<String, String> partitionSpec)\n       throws SemanticException {\n+    boolean shared = AcidUtils.isTransactionalTable(table) &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0a942a9916809e02130647980229c6a3ac76b35"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3NjcyMQ==", "bodyText": "Do you think it would make sense to move metaFile creation under MetaDataFile class, not sure however it should be under AcidConstants?", "url": "https://github.com/apache/hive/pull/1532#discussion_r498076721", "createdAt": "2020-10-01T08:37:07Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java", "diffHunk": "@@ -3357,6 +3355,52 @@ private void truncateTableInternal(String dbName, String tableName, List<String>\n       }\n     }\n \n+    /**\n+     * Add an empty baseDir with a truncate metadatafile\n+     * @param location\n+     * @param writeId\n+     * @param fs\n+     * @throws Exception\n+     */\n+    private void addTruncateBaseFile(Path location, long writeId, FileSystem fs) throws Exception {\n+      Path basePath = new Path(location, AcidConstants.baseDir(writeId));\n+      fs.mkdirs(basePath);\n+      // We can not leave the folder empty, otherwise it will be skipped at some file listing in AcidUtils\n+      // No need for a data file, a simple metadata is enough", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0a942a9916809e02130647980229c6a3ac76b35"}, "originalPosition": 93}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff482be8cca848b0e41820efd420211eadd5c3eb", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/ff482be8cca848b0e41820efd420211eadd5c3eb", "committedDate": "2020-10-01T12:46:00Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxOTc2ODkz", "url": "https://github.com/apache/hive/pull/1532#pullrequestreview-501976893", "createdAt": "2020-10-05T11:51:27Z", "commit": {"oid": "ff482be8cca848b0e41820efd420211eadd5c3eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3115, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}