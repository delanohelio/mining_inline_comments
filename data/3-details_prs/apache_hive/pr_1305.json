{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1OTIwOTAy", "number": 1305, "title": "HIVE-23892: Remove interpretation for character RexLiteral", "bodyText": "NOTICE\nPlease create an issue in ASF JIRA before opening a pull request,\nand you need to set the title of the pull request which starts with\nthe corresponding JIRA issue number. (e.g. HIVE-XXXXX: Fix a typo in YYY)\nFor more details, please see https://cwiki.apache.org/confluence/display/Hive/HowToContribute", "createdAt": "2020-07-23T19:55:13Z", "url": "https://github.com/apache/hive/pull/1305", "merged": true, "mergeCommit": {"oid": "9a77675d35c35b6595b407b4925c80b8d964e6ff"}, "closed": true, "closedAt": "2020-07-30T14:09:57Z", "author": {"login": "jcamachor"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc38GW_ABqjM1ODI0ODg1ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5X-GsgBqjM1OTQ4NzY3MjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd5d83eb41d5745a0089d35c9ac2f65ed846505d", "author": {"user": {"login": "jcamachor", "name": "Jes\u00fas Camacho Rodr\u00edguez"}}, "url": "https://github.com/apache/hive/commit/fd5d83eb41d5745a0089d35c9ac2f65ed846505d", "committedDate": "2020-07-23T19:53:59Z", "message": "HIVE-23892"}, "afterCommit": {"oid": "0b87bc71c4009d73597645592665b9515cbcc163", "author": {"user": {"login": "jcamachor", "name": "Jes\u00fas Camacho Rodr\u00edguez"}}, "url": "https://github.com/apache/hive/commit/0b87bc71c4009d73597645592665b9515cbcc163", "committedDate": "2020-07-24T04:13:01Z", "message": "q file changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0b87bc71c4009d73597645592665b9515cbcc163", "author": {"user": {"login": "jcamachor", "name": "Jes\u00fas Camacho Rodr\u00edguez"}}, "url": "https://github.com/apache/hive/commit/0b87bc71c4009d73597645592665b9515cbcc163", "committedDate": "2020-07-24T04:13:01Z", "message": "q file changes"}, "afterCommit": {"oid": "f3e785e5b4c926d6351ff834ccc11d2e4f8fc0cf", "author": {"user": {"login": "jcamachor", "name": "Jes\u00fas Camacho Rodr\u00edguez"}}, "url": "https://github.com/apache/hive/commit/f3e785e5b4c926d6351ff834ccc11d2e4f8fc0cf", "committedDate": "2020-07-25T00:31:32Z", "message": "q file changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NjIwMzI5", "url": "https://github.com/apache/hive/pull/1305#pullrequestreview-455620329", "createdAt": "2020-07-27T09:28:14Z", "commit": {"oid": "6101458772eb1a2f8b934217af2657b6a306dc1a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwOToyODoxNFrOG3av_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QwOTo0MDowOFrOG3bJ_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc2MzEzNA==", "bodyText": "I don't know why I've not choosen this path in HIVE-21316...\nmaybe I missed that MAX_VARCHAR_LENGTH  and  MAX_CHAR_LENGTH is both below 64K", "url": "https://github.com/apache/hive/pull/1305#discussion_r460763134", "createdAt": "2020-07-27T09:28:14Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/translator/ExprNodeConverter.java", "diffHunk": "@@ -341,26 +342,22 @@ public static ExprNodeConstantDesc toExprNodeConstantDesc(RexLiteral literal) {\n       case DECIMAL:\n         return new ExprNodeConstantDesc(TypeInfoFactory.getDecimalTypeInfo(lType.getPrecision(),\n             lType.getScale()), HiveDecimal.create((BigDecimal)literal.getValue3()));\n-      case VARCHAR:\n       case CHAR: {\n-        if (literal.getValue() instanceof HiveNlsString) {\n-          HiveNlsString mxNlsString = (HiveNlsString) literal.getValue();\n-          switch (mxNlsString.interpretation) {\n-          case STRING:\n-            return new ExprNodeConstantDesc(TypeInfoFactory.stringTypeInfo, literal.getValue3());\n-          case CHAR: {\n-            int precision = lType.getPrecision();\n-            HiveChar value = new HiveChar((String) literal.getValue3(), precision);\n-            return new ExprNodeConstantDesc(new CharTypeInfo(precision), value);\n-          }\n-          case VARCHAR: {\n-            int precision = lType.getPrecision();\n-            HiveVarchar value = new HiveVarchar((String) literal.getValue3(), precision);\n-            return new ExprNodeConstantDesc(new VarcharTypeInfo(precision), value);\n-          }\n-          }\n+        Preconditions.checkState(literal.getValue() instanceof NlsString,\n+            \"char values must use NlsString for correctness\");\n+        int precision = lType.getPrecision();\n+        HiveChar value = new HiveChar((String) literal.getValue3(), precision);\n+        return new ExprNodeConstantDesc(new CharTypeInfo(precision), value);\n+      }\n+      case VARCHAR: {\n+        Preconditions.checkState(literal.getValue() instanceof NlsString,\n+            \"varchar/string values must use NlsString for correctness\");\n+        int precision = lType.getPrecision();\n+        if (precision == Integer.MAX_VALUE) {\n+          return new ExprNodeConstantDesc(TypeInfoFactory.stringTypeInfo, literal.getValue3());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6101458772eb1a2f8b934217af2657b6a306dc1a"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc2NTkyOQ==", "bodyText": "interesting change; will this also mean that:\nCONCAT(CAST('F' AS CHAR(200)),CAST('F' AS CHAR(200)))\n\nwill not be processable because it would need CHAR(400) - which is not supported?", "url": "https://github.com/apache/hive/pull/1305#discussion_r460765929", "createdAt": "2020-07-27T09:33:12Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/test/results/clientpositive/llap/vector_const.q.out", "diffHunk": "@@ -40,7 +40,7 @@ STAGE PLANS:\n                   alias: varchar_const_1\n                   Statistics: Num rows: 1 Data size: 4 Basic stats: COMPLETE Column stats: COMPLETE\n                   Select Operator\n-                    expressions: 'FF' (type: varchar(3))\n+                    expressions: 'FF' (type: varchar(4))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6101458772eb1a2f8b934217af2657b6a306dc1a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDc2OTc5MA==", "bodyText": "this will discard type distinction between char/varchar - but because CHAR is already padded at this point; it will work correctly!\nawesome! :)", "url": "https://github.com/apache/hive/pull/1305#discussion_r460769790", "createdAt": "2020-07-27T09:40:08Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/type/RexNodeExprFactory.java", "diffHunk": "@@ -374,7 +373,7 @@ protected Object interpretConstantAsPrimitive(PrimitiveTypeInfo targetType, Obje\n         HiveChar newValue = new HiveChar(constValue, length);\n         HiveChar maxCharConst = new HiveChar(constValue, HiveChar.MAX_CHAR_LENGTH);\n         if (maxCharConst.equals(newValue)) {\n-          return makeHiveUnicodeString(Interpretation.CHAR, newValue.getValue());\n+          return makeHiveUnicodeString(newValue.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6101458772eb1a2f8b934217af2657b6a306dc1a"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NTUwNTgy", "url": "https://github.com/apache/hive/pull/1305#pullrequestreview-456550582", "createdAt": "2020-07-28T11:43:51Z", "commit": {"oid": "f00483cad90da9a6c2bfd351419f1b038d231ed6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3daacf17449a5334f7ece95e1d7913772974e6d", "author": {"user": {"login": "jcamachor", "name": "Jes\u00fas Camacho Rodr\u00edguez"}}, "url": "https://github.com/apache/hive/commit/c3daacf17449a5334f7ece95e1d7913772974e6d", "committedDate": "2020-07-28T15:14:52Z", "message": "HIVE-23892"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "037bbb741588d87d3d4229f8178b1d0659f6c068", "author": {"user": {"login": "jcamachor", "name": "Jes\u00fas Camacho Rodr\u00edguez"}}, "url": "https://github.com/apache/hive/commit/037bbb741588d87d3d4229f8178b1d0659f6c068", "committedDate": "2020-07-28T15:14:52Z", "message": "q file changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e2b27e0673be34f0f9dcd01adfb0ddb4c8f61a7", "author": {"user": {"login": "jcamachor", "name": "Jes\u00fas Camacho Rodr\u00edguez"}}, "url": "https://github.com/apache/hive/commit/0e2b27e0673be34f0f9dcd01adfb0ddb4c8f61a7", "committedDate": "2020-07-28T15:14:52Z", "message": "comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5dfaeae48a0ca4019b3d869795102ded045ba54", "author": {"user": {"login": "jcamachor", "name": "Jes\u00fas Camacho Rodr\u00edguez"}}, "url": "https://github.com/apache/hive/commit/b5dfaeae48a0ca4019b3d869795102ded045ba54", "committedDate": "2020-07-28T15:14:52Z", "message": "additional test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f00483cad90da9a6c2bfd351419f1b038d231ed6", "author": {"user": {"login": "jcamachor", "name": "Jes\u00fas Camacho Rodr\u00edguez"}}, "url": "https://github.com/apache/hive/commit/f00483cad90da9a6c2bfd351419f1b038d231ed6", "committedDate": "2020-07-27T17:14:16Z", "message": "additional test"}, "afterCommit": {"oid": "b5dfaeae48a0ca4019b3d869795102ded045ba54", "author": {"user": {"login": "jcamachor", "name": "Jes\u00fas Camacho Rodr\u00edguez"}}, "url": "https://github.com/apache/hive/commit/b5dfaeae48a0ca4019b3d869795102ded045ba54", "committedDate": "2020-07-28T15:14:52Z", "message": "additional test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3614, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}