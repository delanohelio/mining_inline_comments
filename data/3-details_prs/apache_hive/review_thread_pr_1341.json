{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MzY2ODgy", "number": 1341, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNDo1NDozNlrOET7cYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNzoyMjo1MlrOEU4Kuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MzMyMzIwOnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MetaStoreDirectSql.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNDo1NDozNlrOG5783g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNDo1NDozNlrOG5783g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDI1NA==", "bodyText": "Nit: formatting", "url": "https://github.com/apache/hive/pull/1341#discussion_r463404254", "createdAt": "2020-07-31T04:54:36Z", "author": {"login": "pvary"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MetaStoreDirectSql.java", "diffHunk": "@@ -984,16 +984,23 @@ private boolean isViewTable(String catName, String dbName, String tblName) throw\n       part.setCatName(catName);\n       part.setDbName(dbName);\n       part.setTableName(tblName);\n-      if (fields[4] != null) part.setCreateTime(MetastoreDirectSqlUtils.extractSqlInt(fields[4]));\n-      if (fields[5] != null) part.setLastAccessTime(MetastoreDirectSqlUtils.extractSqlInt(fields[5]));\n+      if (fields[4] != null) {\n+        part.setCreateTime(MetastoreDirectSqlUtils.extractSqlInt(fields[4]));\n+      }\n+      if (fields[5] != null) {\n+        part.setLastAccessTime(MetastoreDirectSqlUtils.extractSqlInt(fields[5]));\n+      }\n       Long writeId = MetastoreDirectSqlUtils.extractSqlLong(fields[14]);\n       if (writeId != null) {\n         part.setWriteId(writeId);\n       }\n       partitions.put(partitionId, part);\n \n \n-      if (sdId == null) continue; // Probably a view.\n+      if (sdId == null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd9529c1b1a94b1fe0f813cc0e148c293977c065"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MzMyNjkxOnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MetaStoreDirectSql.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNDo1NjoyMVrOG57-xQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxNDoxODozN1rOG6KQyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDc0MQ==", "bodyText": "Please carefully check every \". Postgres and MySql are very problematic", "url": "https://github.com/apache/hive/pull/1341#discussion_r463404741", "createdAt": "2020-07-31T04:56:21Z", "author": {"login": "pvary"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MetaStoreDirectSql.java", "diffHunk": "@@ -2960,4 +2977,22 @@ public void lockDbTable(String tableName) throws MetaException {\n       throw new MetaException(\"Error while locking table \" + tableName + \": \" + sqle.getMessage());\n     }\n   }\n+\n+  public void deleteColumnStatsState(long tbl_id) throws MetaException {\n+    // @formatter:off\n+    String queryText = \"\"\n+        + \"delete from \" + PARTITION_PARAMS + \" pp\"\n+            + \" using \" + PARTITIONS + \" p \"\n+            + \" where \"\n+            + \"   p.\\\"PART_ID = pp.\\\"PART_ID\\\"\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd9529c1b1a94b1fe0f813cc0e148c293977c065"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYzODcyOA==", "bodyText": "I've changed the sql - now it works with mysql as well", "url": "https://github.com/apache/hive/pull/1341#discussion_r463638728", "createdAt": "2020-07-31T14:18:37Z", "author": {"login": "kgyrtkirk"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MetaStoreDirectSql.java", "diffHunk": "@@ -2960,4 +2977,22 @@ public void lockDbTable(String tableName) throws MetaException {\n       throw new MetaException(\"Error while locking table \" + tableName + \": \" + sqle.getMessage());\n     }\n   }\n+\n+  public void deleteColumnStatsState(long tbl_id) throws MetaException {\n+    // @formatter:off\n+    String queryText = \"\"\n+        + \"delete from \" + PARTITION_PARAMS + \" pp\"\n+            + \" using \" + PARTITIONS + \" p \"\n+            + \" where \"\n+            + \"   p.\\\"PART_ID = pp.\\\"PART_ID\\\"\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNDc0MQ=="}, "originalCommit": {"oid": "bd9529c1b1a94b1fe0f813cc0e148c293977c065"}, "originalPosition": 117}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MzMzMDI0OnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNDo1ODozNlrOG58Arg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwNjo1MDoxNlrOG593Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNTIzMA==", "bodyText": "This seems strange. Setting this to null and one line below checking", "url": "https://github.com/apache/hive/pull/1341#discussion_r463405230", "createdAt": "2020-07-31T04:58:36Z", "author": {"login": "pvary"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java", "diffHunk": "@@ -9483,6 +9483,81 @@ private void dropPartitionColumnStatisticsNoTxn(\n     queryWithParams.getLeft().closeAll();\n   }\n \n+  @Override\n+  public void deleteAllPartitionColumnStatistics(TableName tn, String writeIdList) {\n+\n+    String catName = tn.getCat();\n+    String dbName = tn.getDb();\n+    String tableName = tn.getTable();\n+\n+    Query query = null;\n+    dbName = org.apache.commons.lang3.StringUtils.defaultString(dbName, Warehouse.DEFAULT_DATABASE_NAME);\n+    catName = normalizeIdentifier(catName);\n+    if (tableName == null) {\n+      throw new RuntimeException(\"Table name is null.\");\n+    }\n+    boolean ret = false;\n+    try {\n+      openTransaction();\n+      MTable mTable = getMTable(catName, dbName, tableName);\n+\n+      query = pm.newQuery(MPartitionColumnStatistics.class);\n+\n+      Object engine = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd9529c1b1a94b1fe0f813cc0e148c293977c065"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQzNTU3NA==", "bodyText": "oh..sorry; I plan to disable this option by default - and leave only a targeted test to cover for it\nbut I wanted to make a sanity check that this will work in case all tests are executed (and it does)\nI should have marked it as wip or something..I'll clean up things like this in the next version.\nthank you for taking a look!  I was testing with psql so far but  I'll check mysql as well!", "url": "https://github.com/apache/hive/pull/1341#discussion_r463435574", "createdAt": "2020-07-31T06:50:16Z", "author": {"login": "kgyrtkirk"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java", "diffHunk": "@@ -9483,6 +9483,81 @@ private void dropPartitionColumnStatisticsNoTxn(\n     queryWithParams.getLeft().closeAll();\n   }\n \n+  @Override\n+  public void deleteAllPartitionColumnStatistics(TableName tn, String writeIdList) {\n+\n+    String catName = tn.getCat();\n+    String dbName = tn.getDb();\n+    String tableName = tn.getTable();\n+\n+    Query query = null;\n+    dbName = org.apache.commons.lang3.StringUtils.defaultString(dbName, Warehouse.DEFAULT_DATABASE_NAME);\n+    catName = normalizeIdentifier(catName);\n+    if (tableName == null) {\n+      throw new RuntimeException(\"Table name is null.\");\n+    }\n+    boolean ret = false;\n+    try {\n+      openTransaction();\n+      MTable mTable = getMTable(catName, dbName, tableName);\n+\n+      query = pm.newQuery(MPartitionColumnStatistics.class);\n+\n+      Object engine = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQwNTIzMA=="}, "originalCommit": {"oid": "bd9529c1b1a94b1fe0f813cc0e148c293977c065"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzI2NzE0OnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-common/src/main/java/org/apache/hadoop/hive/metastore/conf/MetastoreConf.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNzoyMToxMVrOG7UNIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNzoyMToxMVrOG7UNIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg1MDIwOA==", "bodyText": "nit: Whether?", "url": "https://github.com/apache/hive/pull/1341#discussion_r464850208", "createdAt": "2020-08-04T07:21:11Z", "author": {"login": "pvary"}, "path": "standalone-metastore/metastore-common/src/main/java/org/apache/hadoop/hive/metastore/conf/MetastoreConf.java", "diffHunk": "@@ -1352,6 +1352,12 @@ public static ConfVars getMetaConf(String name) {\n             \"If both this and the metastore.dbaccess.ssl.* properties are set, then the latter properties \\n\" +\n             \"will overwrite what was set in the deprecated property.\"),\n \n+    COLSTATS_RETAIN_ON_COLUMN_REMOVAL(\"metastore.colstats.retain.on.column.removal\",\n+        \"hive.metastore.colstats.retain.on.column.removal\", true,\n+        \"Wether to retain column statistics during column removals in partitioned tables - disabling this \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a58d6387aaa9d4abbb234b88610b8297864c681"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzI3MjI3OnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MetaStoreDirectSql.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNzoyMjo1MlrOG7UQQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNzoyMjo1MlrOG7UQQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg1MTAwOA==", "bodyText": "nit: spaces around the '+' sing", "url": "https://github.com/apache/hive/pull/1341#discussion_r464851008", "createdAt": "2020-08-04T07:22:52Z", "author": {"login": "pvary"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MetaStoreDirectSql.java", "diffHunk": "@@ -2960,4 +2976,21 @@ public void lockDbTable(String tableName) throws MetaException {\n       throw new MetaException(\"Error while locking table \" + tableName + \": \" + sqle.getMessage());\n     }\n   }\n+\n+  public void deleteColumnStatsState(long tbl_id) throws MetaException {\n+    // @formatter:off\n+    String queryText = \"\"\n+        + \"delete from \" + PARTITION_PARAMS + \" \"\n+            + \" where \"\n+            + \"   \\\"PART_ID\\\" in (select p.\\\"PART_ID\\\"  from \"+PARTITIONS+\" p where\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a58d6387aaa9d4abbb234b88610b8297864c681"}, "originalPosition": 115}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 479, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}