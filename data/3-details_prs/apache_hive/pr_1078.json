{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMjg1ODA3", "number": 1078, "title": "HIVE-23266: Remove QueryWrapper from ObjectStore", "bodyText": "", "createdAt": "2020-06-08T17:21:15Z", "url": "https://github.com/apache/hive/pull/1078", "merged": true, "mergeCommit": {"oid": "f77987fbac6ab92acad78dda1047fd2a9aeff7bd"}, "closed": true, "closedAt": "2020-06-13T01:01:51Z", "author": {"login": "belugabehr"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpTyCvAH2gAyNDMxMjg1ODA3OjkxZTkxNGRkMzg3M2MyYjMxY2M4OTYyNmZkYTFmYThhZTc4NjlhOGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqia8NAFqTQyOTcxNzM3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "91e914dd3873c2b31cc89626fda1fa8ae7869a8d", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/91e914dd3873c2b31cc89626fda1fa8ae7869a8d", "committedDate": "2020-06-08T17:19:50Z", "message": "Initial commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e529efddcf087862150197db0e85b69c1e073bf6", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/e529efddcf087862150197db0e85b69c1e073bf6", "committedDate": "2020-06-08T17:19:50Z", "message": "Fixed exception handling for partition lookup.  Fixed meta tool Exception wrapping."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17cb9f7278f47bc300a89850ba7e8c2b2c785283", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/17cb9f7278f47bc300a89850ba7e8c2b2c785283", "committedDate": "2020-06-08T17:19:50Z", "message": "Fixed error with leaked lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1134e04e43eec4bc66d641c3e2b1ca9bd8a6c59c", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/1134e04e43eec4bc66d641c3e2b1ca9bd8a6c59c", "committedDate": "2020-06-08T17:19:50Z", "message": "Remove check status of transaction for partitions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9023a61a5098097080301da72367946b064f3a94", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/9023a61a5098097080301da72367946b064f3a94", "committedDate": "2020-06-08T17:19:50Z", "message": "Do not retrieve all records for raw queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0e130eac2bd5aac20ed58a4b98392062a0d73cb", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/f0e130eac2bd5aac20ed58a4b98392062a0d73cb", "committedDate": "2020-06-08T17:19:50Z", "message": "Retrieve results for executeJDOQLSelect within the open Query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a1f52917002f434ebcbb22c1d5f356a7733f9d3", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/2a1f52917002f434ebcbb22c1d5f356a7733f9d3", "committedDate": "2020-06-08T17:51:33Z", "message": "Better handle exception being thrown by listMPartitionsWithProjection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODAwODQ4", "url": "https://github.com/apache/hive/pull/1078#pullrequestreview-426800848", "createdAt": "2020-06-09T05:35:24Z", "commit": {"oid": "2a1f52917002f434ebcbb22c1d5f356a7733f9d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNTozNToyNFrOGg5YKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNTozNToyNFrOGg5YKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE0NzY5MA==", "bodyText": "what if exception happens when getPartitionsInternal,  the transaction may become unbalanced", "url": "https://github.com/apache/hive/pull/1078#discussion_r437147690", "createdAt": "2020-06-09T05:35:24Z", "author": {"login": "dengzhhu653"}, "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/VerifyingObjectStore.java", "diffHunk": "@@ -93,9 +93,11 @@ public boolean getPartitionsByExpr(String catName, String dbName, String tblName\n   @Override\n   public List<Partition> getPartitions(\n       String catName, String dbName, String tableName, int maxParts) throws MetaException, NoSuchObjectException {\n+    openTransaction();\n     List<Partition> sqlResults = getPartitionsInternal(catName, dbName, tableName, maxParts, true, false);\n     List<Partition> ormResults = getPartitionsInternal(catName, dbName, tableName, maxParts, false, true);\n     verifyLists(sqlResults, ormResults, Partition.class);\n+    commitTransaction();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1f52917002f434ebcbb22c1d5f356a7733f9d3"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODAyMzQ3", "url": "https://github.com/apache/hive/pull/1078#pullrequestreview-426802347", "createdAt": "2020-06-09T05:39:36Z", "commit": {"oid": "2a1f52917002f434ebcbb22c1d5f356a7733f9d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNTozOTozNlrOGg5dHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNTozOTozNlrOGg5dHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE0ODk1OQ==", "bodyText": "rollbackAndCleanup", "url": "https://github.com/apache/hive/pull/1078#discussion_r437148959", "createdAt": "2020-06-09T05:39:36Z", "author": {"login": "dengzhhu653"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java", "diffHunk": "@@ -7109,22 +7121,37 @@ protected String describeResult() {\n   }\n \n   @Override\n-  public List<HiveObjectPrivilege> listPrincipalDBGrantsAll(\n-      String principalName, PrincipalType principalType) {\n-    try (QueryWrapper queryWrapper = new QueryWrapper()) {\n-      return convertDB(listPrincipalAllDBGrant(principalName, principalType, queryWrapper));\n+  public List<HiveObjectPrivilege> listPrincipalDBGrantsAll(String principalName, PrincipalType principalType) {\n+    List<HiveObjectPrivilege> results = Collections.emptyList();\n+    try {\n+      openTransaction();\n+      results = convertDB(listPrincipalAllDBGrant(principalName, principalType));\n+      commitTransaction();\n+    } catch (Exception e) {\n+      throw new RuntimeException(e);\n+    } finally {\n+      rollbackAndCleanup(true, null);\n     }\n+    return results;\n   }\n \n   @Override\n   public List<HiveObjectPrivilege> listDBGrantsAll(String catName, String dbName) {\n-    return listDBGrantsAll(catName, dbName, null);\n+    List<HiveObjectPrivilege> results = Collections.emptyList();\n+    try {\n+      openTransaction();\n+      results = listDBGrantsAll(catName, dbName, null);\n+      commitTransaction();\n+    } catch (Exception e) {\n+      throw new RuntimeException(e);\n+    } finally {\n+      rollbackAndCleanup(true, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1f52917002f434ebcbb22c1d5f356a7733f9d3"}, "originalPosition": 540}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2ODAzOTUy", "url": "https://github.com/apache/hive/pull/1078#pullrequestreview-426803952", "createdAt": "2020-06-09T05:43:46Z", "commit": {"oid": "2a1f52917002f434ebcbb22c1d5f356a7733f9d3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNTo0Mzo0NlrOGg5iVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNTo0Mzo0NlrOGg5iVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzE1MDI5NQ==", "bodyText": "The transaction may unable to rollback when exception happens.", "url": "https://github.com/apache/hive/pull/1078#discussion_r437150295", "createdAt": "2020-06-09T05:43:46Z", "author": {"login": "dengzhhu653"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/ObjectStore.java", "diffHunk": "@@ -7109,22 +7121,37 @@ protected String describeResult() {\n   }\n \n   @Override\n-  public List<HiveObjectPrivilege> listPrincipalDBGrantsAll(\n-      String principalName, PrincipalType principalType) {\n-    try (QueryWrapper queryWrapper = new QueryWrapper()) {\n-      return convertDB(listPrincipalAllDBGrant(principalName, principalType, queryWrapper));\n+  public List<HiveObjectPrivilege> listPrincipalDBGrantsAll(String principalName, PrincipalType principalType) {\n+    List<HiveObjectPrivilege> results = Collections.emptyList();\n+    try {\n+      openTransaction();\n+      results = convertDB(listPrincipalAllDBGrant(principalName, principalType));\n+      commitTransaction();\n+    } catch (Exception e) {\n+      throw new RuntimeException(e);\n+    } finally {\n+      rollbackAndCleanup(true, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a1f52917002f434ebcbb22c1d5f356a7733f9d3"}, "originalPosition": 524}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14a722c75804746be417c45001d75a7ed45b2859", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/14a722c75804746be417c45001d75a7ed45b2859", "committedDate": "2020-06-11T14:55:47Z", "message": "Trivial change to remove whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f63831582fac2ad7462cd40376f76a0bf66f686", "author": {"user": {"login": "belugabehr", "name": null}}, "url": "https://github.com/apache/hive/commit/2f63831582fac2ad7462cd40376f76a0bf66f686", "committedDate": "2020-06-11T16:18:02Z", "message": "Track success and rollback if required"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NzE3Mzc0", "url": "https://github.com/apache/hive/pull/1078#pullrequestreview-429717374", "createdAt": "2020-06-12T12:57:06Z", "commit": {"oid": "2f63831582fac2ad7462cd40376f76a0bf66f686"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3825, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}