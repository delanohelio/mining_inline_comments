{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1ODMxMTMx", "number": 1817, "title": "HIVE-24278: Implement an UDF for throwing exception in arbitrary vertex", "bodyText": "What changes were proposed in this pull request?\nImplemented a udf and udaf, that can throw exception in parameterized vertex / task / task attempt.\nWhy are the changes needed?\nThe udf/udaf can help us making a query fail in different stages.\nDoes this PR introduce any user-facing change?\nNo.\nHow was this patch tested?\nQtests, manual log checking.", "createdAt": "2020-12-27T16:48:24Z", "url": "https://github.com/apache/hive/pull/1817", "merged": true, "mergeCommit": {"oid": "1d5e6bdff99cd5aa7b885f001635d7231c3b9d44"}, "closed": true, "closedAt": "2021-01-19T16:24:32Z", "author": {"login": "abstractdog"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdqlDfIgBqjQxNTE4Njk3MDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdwY5lQgBqjQyMTExNTAwNzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3cbaeb465bf4b675e5f7475c389fe654af216f5f", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/3cbaeb465bf4b675e5f7475c389fe654af216f5f", "committedDate": "2020-12-27T16:47:53Z", "message": "HIVE-24278: Implement an UDF for throwing exception in arbitrary vertex"}, "afterCommit": {"oid": "5a665397e10935640a97eea5516c663c1744390b", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/5a665397e10935640a97eea5516c663c1744390b", "committedDate": "2020-12-28T12:12:01Z", "message": "HIVE-24278: Implement an UDF for throwing exception in arbitrary vertex"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5a665397e10935640a97eea5516c663c1744390b", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/5a665397e10935640a97eea5516c663c1744390b", "committedDate": "2020-12-28T12:12:01Z", "message": "HIVE-24278: Implement an UDF for throwing exception in arbitrary vertex"}, "afterCommit": {"oid": "d9b3a5233be803481288c9b29d1da8e1f77163ad", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/d9b3a5233be803481288c9b29d1da8e1f77163ad", "committedDate": "2020-12-28T23:31:21Z", "message": "HIVE-24278: Implement an UDF for throwing exception in arbitrary vertex"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9b3a5233be803481288c9b29d1da8e1f77163ad", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/d9b3a5233be803481288c9b29d1da8e1f77163ad", "committedDate": "2020-12-28T23:31:21Z", "message": "HIVE-24278: Implement an UDF for throwing exception in arbitrary vertex"}, "afterCommit": {"oid": "7dd331879e49994ffac4e73e5ff519f6ddeaff7d", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/7dd331879e49994ffac4e73e5ff519f6ddeaff7d", "committedDate": "2020-12-29T01:35:32Z", "message": "HIVE-24278: Implement an UDF for throwing exception in arbitrary vertex"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY2OTY4ODk4", "url": "https://github.com/apache/hive/pull/1817#pullrequestreview-566968898", "createdAt": "2021-01-13T08:00:59Z", "commit": {"oid": "7dd331879e49994ffac4e73e5ff519f6ddeaff7d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwODowMDo1OVrOISjfJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xM1QwODowMDo1OVrOISjfJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjMyNjY5NQ==", "bodyText": "I know it will be mostly just us using this - but it would be helpfull to document the accepted format (and probably throw an exception if something else is passed)", "url": "https://github.com/apache/hive/pull/1817#discussion_r556326695", "createdAt": "2021-01-13T08:00:59Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/udf/generic/GenericUDFExceptionInVertex.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.hadoop.hive.ql.udf.generic;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.apache.hadoop.hive.ql.exec.Description;\n+import org.apache.hadoop.hive.ql.exec.MapredContext;\n+import org.apache.hadoop.hive.ql.exec.UDFArgumentException;\n+import org.apache.hadoop.hive.ql.exec.UDFArgumentTypeException;\n+import org.apache.hadoop.hive.ql.exec.tez.TezProcessor;\n+import org.apache.hadoop.hive.ql.metadata.HiveException;\n+import org.apache.hadoop.hive.serde2.objectinspector.ObjectInspector;\n+import org.apache.hadoop.hive.serde2.objectinspector.primitive.PrimitiveObjectInspectorFactory;\n+import org.apache.hadoop.hive.serde2.objectinspector.primitive.WritableConstantIntObjectInspector;\n+import org.apache.hadoop.hive.serde2.objectinspector.primitive.WritableConstantStringObjectInspector;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This class implements the UDF which can throw an exception in arbitrary vertex (typically mapper)\n+ * / task / task attempt. For throwing exception in reducer side, where most probably\n+ * GroupByOperator codepath applies, GenericUDAFExceptionInVertex is used.\n+ */\n+@Description(name = \"exception_in_vertex_udf\", value = \"_FUNC_(vertexName, taskNumberExpression, taskAttemptNumberExpression)\")\n+public class GenericUDFExceptionInVertex extends GenericUDF {\n+  private static final Logger LOG = LoggerFactory.getLogger(GenericUDFExceptionInVertex.class);\n+\n+  private String vertexName;\n+  private String taskNumberExpr;\n+  private String taskAttemptNumberExpr;\n+  private String currentVertexName;\n+  private int currentTaskNumber;\n+  private int currentTaskAttemptNumber;\n+  private boolean alreadyCheckedAndPassed;\n+\n+  @Override\n+  public ObjectInspector initialize(ObjectInspector[] parameters) throws UDFArgumentException {\n+    if (parameters.length < 2) {\n+      throw new UDFArgumentTypeException(-1,\n+          \"At least two argument is expected (fake column ref, vertex name)\");\n+    }\n+\n+    this.vertexName = getVertexName(parameters, 1);\n+    this.taskNumberExpr = getTaskNumber(parameters, 2);\n+    this.taskAttemptNumberExpr = getTaskAttemptNumber(parameters, 3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7dd331879e49994ffac4e73e5ff519f6ddeaff7d"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c35f11ee8cf7b78cc296a7ab56ff12b711a51ef", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/5c35f11ee8cf7b78cc296a7ab56ff12b711a51ef", "committedDate": "2021-01-15T13:24:36Z", "message": "HIVE-24278: Implement an UDF for throwing exception in arbitrary vertex"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7dd331879e49994ffac4e73e5ff519f6ddeaff7d", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/7dd331879e49994ffac4e73e5ff519f6ddeaff7d", "committedDate": "2020-12-29T01:35:32Z", "message": "HIVE-24278: Implement an UDF for throwing exception in arbitrary vertex"}, "afterCommit": {"oid": "5c35f11ee8cf7b78cc296a7ab56ff12b711a51ef", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/5c35f11ee8cf7b78cc296a7ab56ff12b711a51ef", "committedDate": "2021-01-15T13:24:36Z", "message": "HIVE-24278: Implement an UDF for throwing exception in arbitrary vertex"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2822, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}