{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NTc4NDI2", "number": 1509, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTo1Nzo1OVrOEllXYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTo1Nzo1OVrOEllXYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODQ0OTYwOnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/lock/show/ShowDbLocksAnalyzer.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTo1Nzo1OVrOHVIi0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNjo1NTozN1rOHVsbuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjEyOA==", "bodyText": "Do we create txnManager instance here just to get the value of useNewLocksFormat flag?", "url": "https://github.com/apache/hive/pull/1509#discussion_r491922128", "createdAt": "2020-09-21T09:57:59Z", "author": {"login": "deniskuzZ"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/lock/show/ShowDbLocksAnalyzer.java", "diffHunk": "@@ -47,14 +47,16 @@ public void analyzeInternal(ASTNode root) throws SemanticException {\n     String dbName = stripQuotes(root.getChild(0).getText());\n     boolean isExtended = (root.getChildCount() > 1);\n \n-    HiveTxnManager txnManager = null;\n+    boolean useNewLocksFormat;\n     try {\n-      txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);\n+      HiveTxnManager txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e38686db29c51db368771b416810c7de06b2322"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNTU0NQ==", "bodyText": "That's correct. Normally, we should (but I am not 100% sure) have a TxnManager at this point so there is no need to create a new one just to obtain the flag. I pushed commit 297882e to try this out.", "url": "https://github.com/apache/hive/pull/1509#discussion_r492225545", "createdAt": "2020-09-21T17:23:42Z", "author": {"login": "zabetak"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/lock/show/ShowDbLocksAnalyzer.java", "diffHunk": "@@ -47,14 +47,16 @@ public void analyzeInternal(ASTNode root) throws SemanticException {\n     String dbName = stripQuotes(root.getChild(0).getText());\n     boolean isExtended = (root.getChildCount() > 1);\n \n-    HiveTxnManager txnManager = null;\n+    boolean useNewLocksFormat;\n     try {\n-      txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);\n+      HiveTxnManager txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjEyOA=="}, "originalCommit": {"oid": "0e38686db29c51db368771b416810c7de06b2322"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI2MjkxMQ==", "bodyText": "TxnManager is initialized before query compilation and has a session scope. Correct way to access it is via SessionState. Looks like ShowDbLocksAnalyzer was always creating new instance of TxnManager.", "url": "https://github.com/apache/hive/pull/1509#discussion_r492262911", "createdAt": "2020-09-21T18:28:30Z", "author": {"login": "deniskuzZ"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/lock/show/ShowDbLocksAnalyzer.java", "diffHunk": "@@ -47,14 +47,16 @@ public void analyzeInternal(ASTNode root) throws SemanticException {\n     String dbName = stripQuotes(root.getChild(0).getText());\n     boolean isExtended = (root.getChildCount() > 1);\n \n-    HiveTxnManager txnManager = null;\n+    boolean useNewLocksFormat;\n     try {\n-      txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);\n+      HiveTxnManager txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjEyOA=="}, "originalCommit": {"oid": "0e38686db29c51db368771b416810c7de06b2322"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM2NDc5MA==", "bodyText": "Did you check the last commit? Do you have something else in mind?", "url": "https://github.com/apache/hive/pull/1509#discussion_r492364790", "createdAt": "2020-09-21T21:47:20Z", "author": {"login": "zabetak"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/lock/show/ShowDbLocksAnalyzer.java", "diffHunk": "@@ -47,14 +47,16 @@ public void analyzeInternal(ASTNode root) throws SemanticException {\n     String dbName = stripQuotes(root.getChild(0).getText());\n     boolean isExtended = (root.getChildCount() > 1);\n \n-    HiveTxnManager txnManager = null;\n+    boolean useNewLocksFormat;\n     try {\n-      txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);\n+      HiveTxnManager txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjEyOA=="}, "originalCommit": {"oid": "0e38686db29c51db368771b416810c7de06b2322"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxMDEzOQ==", "bodyText": "LGTM", "url": "https://github.com/apache/hive/pull/1509#discussion_r492510139", "createdAt": "2020-09-22T06:55:37Z", "author": {"login": "deniskuzZ"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/lock/show/ShowDbLocksAnalyzer.java", "diffHunk": "@@ -47,14 +47,16 @@ public void analyzeInternal(ASTNode root) throws SemanticException {\n     String dbName = stripQuotes(root.getChild(0).getText());\n     boolean isExtended = (root.getChildCount() > 1);\n \n-    HiveTxnManager txnManager = null;\n+    boolean useNewLocksFormat;\n     try {\n-      txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);\n+      HiveTxnManager txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjEyOA=="}, "originalCommit": {"oid": "0e38686db29c51db368771b416810c7de06b2322"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 442, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}