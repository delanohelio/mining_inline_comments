{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MjA0MzYz", "number": 1323, "title": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "bodyText": "HIVE-23723\nLimit operator (without an order by) can be pushed through SELECTS and LEFT OUTER JOINs, by keeping the exisint limit.", "createdAt": "2020-07-27T14:34:10Z", "url": "https://github.com/apache/hive/pull/1323", "merged": true, "mergeCommit": {"oid": "cb62e1a5a604a555b312fcd62e7c3dc26a725479"}, "closed": true, "closedAt": "2020-08-24T10:12:29Z", "author": {"login": "zeroflag"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5YfUrAFqTQ1Njc1NjQxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-NqKGABqjM2NDg0MTM5MjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NzU2NDE0", "url": "https://github.com/apache/hive/pull/1323#pullrequestreview-456756414", "createdAt": "2020-07-28T15:33:05Z", "commit": {"oid": "2759c81ae5e39137f669b1d21e9d68be674bfe5d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTozMzowNVrOG4ScuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTozMzowNVrOG4ScuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY3NTcwNA==", "bodyText": "Should we also check whether the ReduceSink also has a topn value greater then 0?\nreduceSink.getConf().getTopN() > 0", "url": "https://github.com/apache/hive/pull/1323#discussion_r461675704", "createdAt": "2020-07-28T15:33:05Z", "author": {"login": "kasakrisz"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/OrderlessLimitPushDownOptimizer.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ *\n+ *  * Licensed to the Apache Software Foundation (ASF) under one\n+ *  * or more contributor license agreements.  See the NOTICE file\n+ *  * distributed with this work for additional information\n+ *  * regarding copyright ownership.  The ASF licenses this file\n+ *  * to you under the Apache License, Version 2.0 (the\n+ *  * \"License\"); you may not use this file except in compliance\n+ *  * with the License.  You may obtain a copy of the License at\n+ *  *\n+ *  *     http://www.apache.org/licenses/LICENSE-2.0\n+ *  *\n+ *  * Unless required by applicable law or agreed to in writing, software\n+ *  * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  * See the License for the specific language governing permissions and\n+ *  * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.hadoop.hive.ql.optimizer;\n+\n+import static org.apache.hadoop.hive.ql.optimizer.topnkey.TopNKeyProcessor.copyDown;\n+import static org.apache.hadoop.hive.ql.optimizer.topnkey.TopNKeyPushdownProcessor.moveDown;\n+\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Stack;\n+\n+import org.apache.hadoop.hive.ql.exec.CommonJoinOperator;\n+import org.apache.hadoop.hive.ql.exec.LimitOperator;\n+import org.apache.hadoop.hive.ql.exec.Operator;\n+import org.apache.hadoop.hive.ql.exec.ReduceSinkOperator;\n+import org.apache.hadoop.hive.ql.lib.DefaultGraphWalker;\n+import org.apache.hadoop.hive.ql.lib.DefaultRuleDispatcher;\n+import org.apache.hadoop.hive.ql.lib.Node;\n+import org.apache.hadoop.hive.ql.lib.NodeProcessorCtx;\n+import org.apache.hadoop.hive.ql.lib.RuleRegExp;\n+import org.apache.hadoop.hive.ql.lib.SemanticGraphWalker;\n+import org.apache.hadoop.hive.ql.lib.SemanticNodeProcessor;\n+import org.apache.hadoop.hive.ql.lib.SemanticRule;\n+import org.apache.hadoop.hive.ql.parse.ParseContext;\n+import org.apache.hadoop.hive.ql.parse.SemanticException;\n+import org.apache.hadoop.hive.ql.plan.JoinCondDesc;\n+import org.apache.hadoop.hive.ql.plan.JoinDesc;\n+import org.apache.hadoop.hive.ql.plan.OperatorDesc;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Push LIMIT without an Order By through Selects and Left Outer Joins\n+ */\n+public class OrderlessLimitPushDownOptimizer extends Transform {\n+  private static final Logger LOG = LoggerFactory.getLogger(OrderlessLimitPushDownOptimizer.class);\n+\n+  @Override\n+  public ParseContext transform(ParseContext pctx) throws SemanticException {\n+    Map<SemanticRule, SemanticNodeProcessor> opRules = new LinkedHashMap<SemanticRule, SemanticNodeProcessor>();\n+    opRules.put(\n+            new RuleRegExp(\"LIMIT push down\", LimitOperator.getOperatorName() + \"%\"),\n+            new LimitPushDown());\n+    SemanticGraphWalker walker = new DefaultGraphWalker(new DefaultRuleDispatcher(null, opRules, null));\n+    walker.startWalking(new ArrayList<>(pctx.getTopOps().values()), null);\n+    return pctx;\n+  }\n+\n+  private static class LimitPushDown implements SemanticNodeProcessor {\n+    @Override\n+    public Object process(Node nd, Stack<Node> stack, NodeProcessorCtx procCtx, Object... nodeOutputs) throws SemanticException {\n+      ReduceSinkOperator reduceSink = findReduceSink(stack);\n+      if (reduceSink != null && !reduceSink.getConf().hasOrderBy()) { // LIMIT + ORDER BY handled by TopNKey push down", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2759c81ae5e39137f669b1d21e9d68be674bfe5d"}, "originalPosition": 73}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "686a9ef258f523a401ae9f4d81c872d78e4395ee", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/686a9ef258f523a401ae9f4d81c872d78e4395ee", "committedDate": "2020-07-29T12:58:14Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}, "afterCommit": {"oid": "c223a3e76574f8ed62c5962c89bdfa4d826fbc99", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/c223a3e76574f8ed62c5962c89bdfa4d826fbc99", "committedDate": "2020-07-29T14:04:51Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MjEzMzAz", "url": "https://github.com/apache/hive/pull/1323#pullrequestreview-458213303", "createdAt": "2020-07-30T08:56:48Z", "commit": {"oid": "78c90da56c3bd920b8fb446e63e7481446fd53a4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwODo1Njo0OFrOG5aQ3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQwOTo0NDo0NVrOG5b77Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg1MjMxNg==", "bodyText": "Why couldn't be pushed through[SEL_1]  ?", "url": "https://github.com/apache/hive/pull/1323#discussion_r462852316", "createdAt": "2020-07-30T08:56:48Z", "author": {"login": "kasakrisz"}, "path": "ql/src/test/results/clientpositive/llap/explainuser_1.q.out", "diffHunk": "@@ -124,27 +124,25 @@ Stage-3\n                   <-Reducer 2 [SIMPLE_EDGE] llap\n                     File Output Operator [FS_7]\n                       table:{\"name:\":\"default.src_orc_merge_test_part_n1\"}\n-                      Select Operator [SEL_6] (rows=100 width=95)\n+                      Select Operator [SEL_4] (rows=100 width=178)\n                         Output:[\"_col0\",\"_col1\"]\n                         Limit [LIM_5] (rows=100 width=178)\n                           Number of rows:100\n-                          Select Operator [SEL_4] (rows=100 width=178)\n-                            Output:[\"_col0\",\"_col1\"]\n-                          <-Map 1 [CUSTOM_SIMPLE_EDGE] llap\n-                            PARTITION_ONLY_SHUFFLE [RS_3]\n-                              Limit [LIM_2] (rows=100 width=178)\n-                                Number of rows:100\n-                                Select Operator [SEL_1] (rows=500 width=178)\n-                                  Output:[\"_col0\",\"_col1\"]\n-                                  TableScan [TS_0] (rows=500 width=178)\n-                                    default@src,src,Tbl:COMPLETE,Col:COMPLETE,Output:[\"key\",\"value\"]\n+                        <-Map 1 [CUSTOM_SIMPLE_EDGE] llap\n+                          PARTITION_ONLY_SHUFFLE [RS_3]\n+                            Limit [LIM_2] (rows=100 width=178)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78c90da56c3bd920b8fb446e63e7481446fd53a4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg2OTY1MA==", "bodyText": "Does -- SORT_QUERY_RESULTS help avoid resultset change?", "url": "https://github.com/apache/hive/pull/1323#discussion_r462869650", "createdAt": "2020-07-30T09:27:01Z", "author": {"login": "kasakrisz"}, "path": "ql/src/test/results/clientpositive/llap/limit_join_transpose.q.out", "diffHunk": "@@ -108,7 +111,7 @@ limit 1\n POSTHOOK: type: QUERY\n POSTHOOK: Input: default@src\n #### A masked pattern was here ####\n-0\tval_0\t0\tval_0\n+238\tval_238\t238\tval_238", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78c90da56c3bd920b8fb446e63e7481446fd53a4"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg3MDI2NA==", "bodyText": "Result set disappeared.", "url": "https://github.com/apache/hive/pull/1323#discussion_r462870264", "createdAt": "2020-07-30T09:28:09Z", "author": {"login": "kasakrisz"}, "path": "ql/src/test/results/clientpositive/llap/limit_join_transpose.q.out", "diffHunk": "@@ -1207,7 +1223,6 @@ limit 1 offset 1\n POSTHOOK: type: QUERY\n POSTHOOK: Input: default@src\n #### A masked pattern was here ####\n-0\tval_0\t0\tval_0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78c90da56c3bd920b8fb446e63e7481446fd53a4"}, "originalPosition": 313}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg3OTcyNQ==", "bodyText": "It is worth investigating why we end up with a plan where the parent of a TNK is a Limit but that can be a follow-up patch since it is out of scope of this patch.", "url": "https://github.com/apache/hive/pull/1323#discussion_r462879725", "createdAt": "2020-07-30T09:44:45Z", "author": {"login": "kasakrisz"}, "path": "ql/src/test/results/clientpositive/llap/input14_limit.q.out", "diffHunk": "@@ -75,19 +75,19 @@ STAGE PLANS:\n         Reducer 2 \n             Execution mode: vectorized, llap\n             Reduce Operator Tree:\n-              Select Operator\n-                expressions: VALUE._col0 (type: string), VALUE._col1 (type: string)\n-                outputColumnNames: _col0, _col1\n-                Statistics: Num rows: 500 Data size: 89000 Basic stats: COMPLETE Column stats: COMPLETE\n-                Limit\n-                  Number of rows: 20\n-                  Statistics: Num rows: 20 Data size: 3560 Basic stats: COMPLETE Column stats: COMPLETE\n-                  Top N Key Operator\n-                    sort order: +\n-                    keys: _col0 (type: string)\n-                    null sort order: a\n+              Limit", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78c90da56c3bd920b8fb446e63e7481446fd53a4"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3517c44f8b67eb4ce03994565b9d44dff9059690", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/3517c44f8b67eb4ce03994565b9d44dff9059690", "committedDate": "2020-08-05T11:28:11Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}, "afterCommit": {"oid": "933dcb6e0f2f7fb432d34246b8d2e44ec9992eff", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/933dcb6e0f2f7fb432d34246b8d2e44ec9992eff", "committedDate": "2020-08-05T13:28:22Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9ab95d3cb5c925cdead74a9633eafeeb9dbc916", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/b9ab95d3cb5c925cdead74a9633eafeeb9dbc916", "committedDate": "2020-08-12T14:03:11Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23ad0504777b61cac8575f1b757fbd3a2733f8d7", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/23ad0504777b61cac8575f1b757fbd3a2733f8d7", "committedDate": "2020-08-12T14:03:11Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "748db6e71e423fc516f9fd2808e24d1ec938a035", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/748db6e71e423fc516f9fd2808e24d1ec938a035", "committedDate": "2020-08-12T14:03:11Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc0107b1157c4dfd5c91dd8a8d114f947a098db6", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/cc0107b1157c4dfd5c91dd8a8d114f947a098db6", "committedDate": "2020-08-12T14:03:11Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab5988fea63c9e281abdf181fab4d0809f0c6f3e", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/ab5988fea63c9e281abdf181fab4d0809f0c6f3e", "committedDate": "2020-08-12T14:03:11Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fc560e13c6ac28ceac77e870d249e85602fdb31", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/7fc560e13c6ac28ceac77e870d249e85602fdb31", "committedDate": "2020-08-12T14:03:12Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ba2c5f4a113ad1291e232e84c220124f1560144", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/4ba2c5f4a113ad1291e232e84c220124f1560144", "committedDate": "2020-08-12T14:03:12Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a8a601e7086abd654cbfcf4ecbcd9d098e3e546", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/9a8a601e7086abd654cbfcf4ecbcd9d098e3e546", "committedDate": "2020-08-12T14:03:12Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12e879caea755db324e816ccac8b47193c7f47a7", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/12e879caea755db324e816ccac8b47193c7f47a7", "committedDate": "2020-08-12T14:03:13Z", "message": " HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b002080112f89130094f6b64cf5a51c30efddaee", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/b002080112f89130094f6b64cf5a51c30efddaee", "committedDate": "2020-08-12T14:03:13Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e29d1fc54231428ed555bf3f85506112e6522ac8", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/e29d1fc54231428ed555bf3f85506112e6522ac8", "committedDate": "2020-08-12T14:03:13Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7f1e12fa6e46ce7f82d3426a25aa538a2af6cb4", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/e7f1e12fa6e46ce7f82d3426a25aa538a2af6cb4", "committedDate": "2020-08-12T16:03:49Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "316688c048431670fde52d5016ebbebecf255ada", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/316688c048431670fde52d5016ebbebecf255ada", "committedDate": "2020-08-12T07:38:41Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}, "afterCommit": {"oid": "e7f1e12fa6e46ce7f82d3426a25aa538a2af6cb4", "author": {"user": {"login": "zeroflag", "name": "Attila Magyar"}}, "url": "https://github.com/apache/hive/commit/e7f1e12fa6e46ce7f82d3426a25aa538a2af6cb4", "committedDate": "2020-08-12T16:03:49Z", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3351, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}