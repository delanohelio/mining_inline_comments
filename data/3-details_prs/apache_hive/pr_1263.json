{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwMTYxNjA5", "number": 1263, "title": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view", "bodyText": "", "createdAt": "2020-07-16T12:36:04Z", "url": "https://github.com/apache/hive/pull/1263", "merged": true, "mergeCommit": {"oid": "c2797683c19ddf653d23d3c143286ef1cc4e7561"}, "closed": true, "closedAt": "2020-07-22T15:21:15Z", "author": {"login": "bmaidics"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1wRgbABqjM1NTcyMTI1NzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3Z0Y7ABqjM1NzU1MDEyOTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "590c21c6c21d4fe171a3fa0ab380503c063a1f53", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/590c21c6c21d4fe171a3fa0ab380503c063a1f53", "committedDate": "2020-07-16T12:33:55Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}, "afterCommit": {"oid": "c1206c572d9df98a32b40dc75268be9e4272b318", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/c1206c572d9df98a32b40dc75268be9e4272b318", "committedDate": "2020-07-17T09:18:15Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1206c572d9df98a32b40dc75268be9e4272b318", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/c1206c572d9df98a32b40dc75268be9e4272b318", "committedDate": "2020-07-17T09:18:15Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}, "afterCommit": {"oid": "1d5ddc49706c23ec5d89a6fc1c9fd0a7d2c225e8", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/1d5ddc49706c23ec5d89a6fc1c9fd0a7d2c225e8", "committedDate": "2020-07-17T09:20:33Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1d5ddc49706c23ec5d89a6fc1c9fd0a7d2c225e8", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/1d5ddc49706c23ec5d89a6fc1c9fd0a7d2c225e8", "committedDate": "2020-07-17T09:20:33Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}, "afterCommit": {"oid": "d322d66fb09f1547614af771984df6233fec3819", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/d322d66fb09f1547614af771984df6233fec3819", "committedDate": "2020-07-20T12:50:40Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d322d66fb09f1547614af771984df6233fec3819", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/d322d66fb09f1547614af771984df6233fec3819", "committedDate": "2020-07-20T12:50:40Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}, "afterCommit": {"oid": "9f554137b9220b3943b2e7be0b975e0bf1b54a02", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/9f554137b9220b3943b2e7be0b975e0bf1b54a02", "committedDate": "2020-07-20T13:05:29Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMjc5NTQ5", "url": "https://github.com/apache/hive/pull/1263#pullrequestreview-452279549", "createdAt": "2020-07-21T09:23:25Z", "commit": {"oid": "9f554137b9220b3943b2e7be0b975e0bf1b54a02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwOToyMzoyNVrOG0vnVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwOToyMzoyNVrOG0vnVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk1OTI1Mw==", "bodyText": "nit: space", "url": "https://github.com/apache/hive/pull/1263#discussion_r457959253", "createdAt": "2020-07-21T09:23:25Z", "author": {"login": "pvary"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java", "diffHunk": "@@ -12566,38 +12565,44 @@ void analyzeInternal(ASTNode ast, Supplier<PlannerContext> pcf) throws SemanticE\n       createVwDesc.setTablesUsed(getTablesUsed(pCtx));\n     }\n \n-    // 6. Generate table access stats if required\n-    if (HiveConf.getBoolVar(this.conf, HiveConf.ConfVars.HIVE_STATS_COLLECT_TABLEKEYS)) {\n-      TableAccessAnalyzer tableAccessAnalyzer = new TableAccessAnalyzer(pCtx);\n-      setTableAccessInfo(tableAccessAnalyzer.analyzeTableAccess());\n-    }\n+    //If we're creating views and ColumnAccessInfo is already created, we should not run these.\n+    if(!forViewCreation ||  getColumnAccessInfo() == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f554137b9220b3943b2e7be0b975e0bf1b54a02"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNzYzMjg2", "url": "https://github.com/apache/hive/pull/1263#pullrequestreview-452763286", "createdAt": "2020-07-21T19:26:32Z", "commit": {"oid": "9f554137b9220b3943b2e7be0b975e0bf1b54a02"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxOToyNjozM1rOG1Gldg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxOTozMTowM1rOG1GuoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzNTYwNg==", "bodyText": "Can we add information to the comment above about why we are skipping those specific steps 6-8?", "url": "https://github.com/apache/hive/pull/1263#discussion_r458335606", "createdAt": "2020-07-21T19:26:33Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java", "diffHunk": "@@ -12566,38 +12565,44 @@ void analyzeInternal(ASTNode ast, Supplier<PlannerContext> pcf) throws SemanticE\n       createVwDesc.setTablesUsed(getTablesUsed(pCtx));\n     }\n \n-    // 6. Generate table access stats if required\n-    if (HiveConf.getBoolVar(this.conf, HiveConf.ConfVars.HIVE_STATS_COLLECT_TABLEKEYS)) {\n-      TableAccessAnalyzer tableAccessAnalyzer = new TableAccessAnalyzer(pCtx);\n-      setTableAccessInfo(tableAccessAnalyzer.analyzeTableAccess());\n-    }\n+    //If we're creating views and ColumnAccessInfo is already created, we should not run these.\n+    if(!forViewCreation ||  getColumnAccessInfo() == null) {\n+      // 6. Generate table access stats if required\n+      if (HiveConf.getBoolVar(this.conf, HiveConf.ConfVars.HIVE_STATS_COLLECT_TABLEKEYS)) {\n+        TableAccessAnalyzer tableAccessAnalyzer = new TableAccessAnalyzer(pCtx);\n+        setTableAccessInfo(tableAccessAnalyzer.analyzeTableAccess());\n+      }\n+      AuxOpTreeSignature.linkAuxSignatures(pCtx);\n+      // 7. Perform Logical optimization\n+      if (LOG.isDebugEnabled()) {\n+        LOG.debug(\"Before logical optimization\\n\" + Operator.toString(pCtx.getTopOps().values()));\n+      }\n+      Optimizer optm = new Optimizer();\n+      optm.setPctx(pCtx);\n+      optm.initialize(conf);\n+      pCtx = optm.optimize();\n+      if (pCtx.getColumnAccessInfo() != null) {\n+        // set ColumnAccessInfo for view column authorization\n+        setColumnAccessInfo(pCtx.getColumnAccessInfo());\n+      }\n+      if (LOG.isDebugEnabled()) {\n+        LOG.debug(\"After logical optimization\\n\" + Operator.toString(pCtx.getTopOps().values()));\n+      }\n \n-    AuxOpTreeSignature.linkAuxSignatures(pCtx);\n-    // 7. Perform Logical optimization\n-    if (LOG.isDebugEnabled()) {\n-      LOG.debug(\"Before logical optimization\\n\" + Operator.toString(pCtx.getTopOps().values()));\n-    }\n-    Optimizer optm = new Optimizer();\n-    optm.setPctx(pCtx);\n-    optm.initialize(conf);\n-    pCtx = optm.optimize();\n-    if (pCtx.getColumnAccessInfo() != null) {\n-      // set ColumnAccessInfo for view column authorization\n-      setColumnAccessInfo(pCtx.getColumnAccessInfo());\n+      // 8. Generate column access stats if required - wait until column pruning", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f554137b9220b3943b2e7be0b975e0bf1b54a02"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzNzk1Mw==", "bodyText": "This is a CREATE VIEW. Why are partitions that are not accessed part of the entities accessed? This should not have changed? This happens in all these different tests so the root cause should be the same.", "url": "https://github.com/apache/hive/pull/1263#discussion_r458337953", "createdAt": "2020-07-21T19:31:03Z", "author": {"login": "jcamachor"}, "path": "ql/src/test/results/clientpositive/llap/ppd_deterministic_expr.q.out", "diffHunk": "@@ -198,6 +198,9 @@ PREHOOK: query: create view viewDeterministicUDFA partitioned on (vpart1, vpart2\n where part1 in ('US', 'CA')\n PREHOOK: type: CREATEVIEW\n PREHOOK: Input: default@testa\n+PREHOOK: Input: default@testa@part1=CA/part2=ABC/part3=300", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f554137b9220b3943b2e7be0b975e0bf1b54a02"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f554137b9220b3943b2e7be0b975e0bf1b54a02", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/9f554137b9220b3943b2e7be0b975e0bf1b54a02", "committedDate": "2020-07-20T13:05:29Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}, "afterCommit": {"oid": "791b009c523ea55bde0bff52e674afaabcf89fe4", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/791b009c523ea55bde0bff52e674afaabcf89fe4", "committedDate": "2020-07-22T09:30:04Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "041e34fbb823344950de3aec8453b20b811311c5", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/041e34fbb823344950de3aec8453b20b811311c5", "committedDate": "2020-07-22T12:15:49Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "791b009c523ea55bde0bff52e674afaabcf89fe4", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/791b009c523ea55bde0bff52e674afaabcf89fe4", "committedDate": "2020-07-22T09:30:04Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}, "afterCommit": {"oid": "041e34fbb823344950de3aec8453b20b811311c5", "author": {"user": {"login": "bmaidics", "name": null}}, "url": "https://github.com/apache/hive/commit/041e34fbb823344950de3aec8453b20b811311c5", "committedDate": "2020-07-22T12:15:49Z", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3556, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}