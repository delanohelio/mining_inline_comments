{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNjU4Mzc2", "number": 1196, "title": "HIVE-23791: Optimize ACID stats generation", "bodyText": "Run AcidUtils.getHdfsDirSnapshots to collect the relevant files, and use that for stats generation", "createdAt": "2020-07-01T12:12:25Z", "url": "https://github.com/apache/hive/pull/1196", "merged": true, "mergeCommit": {"oid": "1ce2a1d9ed635dafb45c9349ce2481e8aa315dc5"}, "closed": true, "closedAt": "2020-07-06T13:28:00Z", "author": {"login": "pvary"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwpI7BAH2gAyNDQyNjU4Mzc2Ojg1YzVhODI2MWU2ODY2YmUxN2EzODJlM2QyNjM0NzY0MDI5ZGJkODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyNfptAFqTQ0MjkwMDM5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "85c5a8261e6866be17a382e3d2634764029dbd81", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/hive/commit/85c5a8261e6866be17a382e3d2634764029dbd81", "committedDate": "2020-07-01T12:10:18Z", "message": "HIVE-23791: Optimize ACID stats generation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDE3NTcy", "url": "https://github.com/apache/hive/pull/1196#pullrequestreview-441017572", "createdAt": "2020-07-01T16:18:49Z", "commit": {"oid": "85c5a8261e6866be17a382e3d2634764029dbd81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNjoxODo0OVrOGrsu6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNjoxODo0OVrOGrsu6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NDg1OQ==", "bodyText": "There is a slight problem here, if we are on hdfs and the file listing with id is supported. Few lines below there is a check for dirsnapshot == null, that was running every time for this case, but now it won't run if you call getacidstate with nonnull dirsnapshot", "url": "https://github.com/apache/hive/pull/1196#discussion_r448474859", "createdAt": "2020-07-01T16:18:49Z", "author": {"login": "pvargacl"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/io/AcidUtils.java", "diffHunk": "@@ -1305,7 +1322,9 @@ public static Directory getAcidState(FileSystem fileSystem, Path candidateDirect\n             bestBase, ignoreEmptyFiles, abortedDirectories, fs, validTxnList);\n       }\n     } else {\n-      dirSnapshots = getHdfsDirSnapshots(fs, candidateDirectory);\n+      if (dirSnapshots == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c5a8261e6866be17a382e3d2634764029dbd81"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDI2NDY5", "url": "https://github.com/apache/hive/pull/1196#pullrequestreview-441026469", "createdAt": "2020-07-01T16:30:55Z", "commit": {"oid": "85c5a8261e6866be17a382e3d2634764029dbd81"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNjozMDo1NVrOGrtLCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNjozMDo1NVrOGrtLCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ4MjA1Nw==", "bodyText": "this might be out-of-scope for this change: but this static method in AcidUtils is trying to do all the work upfront...\nwhich might lead to:\n\nthat it does work which is not even needed\nit doesn't scan some location - and the map just returns null ; so it might be not noticable\n\nI think it would be better if this method would return a something (it could still be a map) which could fill in stuff from hdfs if its not cached already...", "url": "https://github.com/apache/hive/pull/1196#discussion_r448482057", "createdAt": "2020-07-01T16:30:55Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/io/AcidUtils.java", "diffHunk": "@@ -2614,28 +2633,25 @@ public static Path getVersionFilePath(Path deltaOrBase) {\n           + \" from \" + jc.get(ValidTxnWriteIdList.VALID_TABLES_WRITEIDS_KEY));\n       return null;\n     }\n-    Directory acidInfo = AcidUtils.getAcidState(fs, dir, jc, idList, null, false);\n+    if (fs == null) {\n+      fs = dir.getFileSystem(jc);\n+    }\n+    // Collect the all of the files/dirs\n+    Map<Path, HdfsDirSnapshot> hdfsDirSnapshots = AcidUtils.getHdfsDirSnapshots(fs, dir);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85c5a8261e6866be17a382e3d2634764029dbd81"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be5818d66c59d3010e176a2fa8255233ecd53c9d", "author": {"user": {"login": "pvary", "name": null}}, "url": "https://github.com/apache/hive/commit/be5818d66c59d3010e176a2fa8255233ecd53c9d", "committedDate": "2020-07-01T16:38:41Z", "message": "Addressing Petya's comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyOTAwMzk5", "url": "https://github.com/apache/hive/pull/1196#pullrequestreview-442900399", "createdAt": "2020-07-06T09:05:38Z", "commit": {"oid": "be5818d66c59d3010e176a2fa8255233ecd53c9d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3727, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}