{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MzYwOTE4", "number": 1340, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNTo1NTowNlrOEU2xcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNTo1NjowNFrOEU2yIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzA0MzcwOnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/exec/vector/mapjoin/fast/VectorMapJoinFastHashTableLoader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNTo1NTowNlrOG7SHIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNTo1NTowNlrOG7SHIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgxNTkwNQ==", "bodyText": "Can you add TODO or a followup ticket that would replace this string with actual TaskCounter enum from tez (in next subsequent tez release) ?", "url": "https://github.com/apache/hive/pull/1340#discussion_r464815905", "createdAt": "2020-08-04T05:55:06Z", "author": {"login": "rbalamohan"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/exec/vector/mapjoin/fast/VectorMapJoinFastHashTableLoader.java", "diffHunk": "@@ -125,13 +126,24 @@ public void load(MapJoinTableContainer[] mapJoinTables,\n         KeyValueReader kvReader = (KeyValueReader) input.getReader();\n \n         Long keyCountObj = parentKeyCounts.get(pos);\n-        long keyCount = (keyCountObj == null) ? -1 : keyCountObj.longValue();\n+        long estKeyCount = (keyCountObj == null) ? -1 : keyCountObj;\n+\n+        long inputRecords = -1;\n+        try {\n+          inputRecords = ((AbstractLogicalInput) input).getContext().getCounters().", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMzA0NTQ1OnYy", "diffSide": "RIGHT", "path": "ql/src/java/org/apache/hadoop/hive/ql/exec/vector/mapjoin/fast/VectorMapJoinFastHashTableLoader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNTo1NjowNFrOG7SILw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNTo1NjowNFrOG7SILw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgxNjE3NQ==", "bodyText": "Can you add \"delta\" (line 171) in the log as well, to have details on the hash table load time?", "url": "https://github.com/apache/hive/pull/1340#discussion_r464816175", "createdAt": "2020-08-04T05:56:04Z", "author": {"login": "rbalamohan"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/exec/vector/mapjoin/fast/VectorMapJoinFastHashTableLoader.java", "diffHunk": "@@ -125,13 +126,24 @@ public void load(MapJoinTableContainer[] mapJoinTables,\n         KeyValueReader kvReader = (KeyValueReader) input.getReader();\n \n         Long keyCountObj = parentKeyCounts.get(pos);\n-        long keyCount = (keyCountObj == null) ? -1 : keyCountObj.longValue();\n+        long estKeyCount = (keyCountObj == null) ? -1 : keyCountObj;\n+\n+        long inputRecords = -1;\n+        try {\n+          inputRecords = ((AbstractLogicalInput) input).getContext().getCounters().\n+                  findCounter(\"org.apache.tez.common.counters.TaskCounter\",\n+                          \"APPROXIMATE_INPUT_RECORDS\").getValue();\n+        } catch (Exception e) {\n+          LOG.debug(\"Failed to get value for counter APPROXIMATE_INPUT_RECORDS\", e);\n+        }\n+        long keyCount = Math.max(estKeyCount, inputRecords);\n \n         VectorMapJoinFastTableContainer vectorMapJoinFastTableContainer =\n                 new VectorMapJoinFastTableContainer(desc, hconf, keyCount);\n \n-        LOG.info(\"Loading hash table for input: {} cacheKey: {} tableContainer: {} smallTablePos: {}\", inputName,\n-          cacheKey, vectorMapJoinFastTableContainer.getClass().getSimpleName(), pos);\n+        LOG.info(\"Loading hash table for input: {} cacheKey: {} tableContainer: {} smallTablePos: {} \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 476, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}