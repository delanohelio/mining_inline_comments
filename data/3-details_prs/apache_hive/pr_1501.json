{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3MzcwNzgw", "number": 1501, "title": "HIVE-24168: Disable hdfsEncryptionShims cache during query-based comp\u2026", "bodyText": "Hive keeps a cache of encryption shims in SessionState (Map<URI, HadoopShims.HdfsEncryptionShim> hdfsEncryptionShims). Each encryption shim in the cache stores a FileSystem object.\nAfter compaction where the session user is not the same user as the owner of the partition/table directory, we close all FileSystem objects associated with the user running the compaction, possibly closing an FS stored in the encryption shim cache. The next time query-based compaction is run on a table/partition owned by the same user, compaction will fail in MoveTask[1] since the FileSystem stored in the cache was closed.\nThis change disables the cache during query-based compaction (optionally; default: disabled).\n[1] Error:\n{code:java}\n2020-09-08 11:23:50,170 ERROR org.apache.hadoop.hive.ql.Driver: [rncdpdev-2.fyre.ibm.com-27]: FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.MoveTask. java.io.IOException: Filesystem closed. org.apache.hadoop.hive.ql.metadata.HiveException: java.io.IOException: Filesystem closed", "createdAt": "2020-09-15T15:15:22Z", "url": "https://github.com/apache/hive/pull/1501", "merged": true, "mergeCommit": {"oid": "a8d12dd7eeb980fd4bb0ec1c9933f93f5a8e058a"}, "closed": true, "closedAt": "2020-09-28T08:21:19Z", "author": {"login": "klcopp"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJJR3mgH2gAyNDg3MzcwNzgwOmEwYzRlMjUwYmJhNmI5MTMyN2VhYjAxOGJhYzMzNGUwYWNmZTJjMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMAfk6gFqTQ5NTUyNTYwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a0c4e250bba6b91327eab018bac334e0acfe2c12", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/a0c4e250bba6b91327eab018bac334e0acfe2c12", "committedDate": "2020-09-15T15:11:13Z", "message": "HIVE-24168: Disable hdfsEncryptionShims cache during query-based compaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca3825137e1a07da202dc8bae9e2a3c1d0b0d533", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/ca3825137e1a07da202dc8bae9e2a3c1d0b0d533", "committedDate": "2020-09-15T15:16:32Z", "message": "Added javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69f93f66b66b11f3cbd77fa97e5884fc93a0014f", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/69f93f66b66b11f3cbd77fa97e5884fc93a0014f", "committedDate": "2020-09-15T15:18:31Z", "message": "Uncommented temporarily commented-out code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f11408494eaa6da0e83be54a52712abb76e3a949", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/f11408494eaa6da0e83be54a52712abb76e3a949", "committedDate": "2020-09-15T15:22:50Z", "message": "Formatting and comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5MzM3NzY1", "url": "https://github.com/apache/hive/pull/1501#pullrequestreview-489337765", "createdAt": "2020-09-16T07:15:58Z", "commit": {"oid": "f11408494eaa6da0e83be54a52712abb76e3a949"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwNzoxNTo1OFrOHSjTwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwNzoxNTo1OFrOHSjTwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTIxNDkxMw==", "bodyText": "Shouldn't isCompactionTable return true in both cases? Isn't it a problem the other places we use this util, that the mmCompactionTable are missed?", "url": "https://github.com/apache/hive/pull/1501#discussion_r489214913", "createdAt": "2020-09-16T07:15:58Z", "author": {"login": "pvargacl"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/io/AcidUtils.java", "diffHunk": "@@ -445,14 +446,23 @@ public static boolean isCompactionTable(Properties tblProperties) {\n   }\n \n   /**\n-   * Determine if a table is used during query based compaction.\n+   * Determine if a table is used during query based compaction for CRUD tables.\n    * @param parameters table properties map\n    * @return true, if the parameters contains {@link AcidUtils#COMPACTOR_TABLE_PROPERTY}\n    */\n   public static boolean isCompactionTable(Map<String, String> parameters) {\n     return Boolean.valueOf(parameters.getOrDefault(COMPACTOR_TABLE_PROPERTY, \"false\"));\n   }\n \n+  /**\n+   * Determine if a table is used during query based compaction for MM insert-only tables.\n+   * @param parameters table properties map\n+   * @return true, if the parameters contains {@link AcidUtils#MM_COMPACTOR_TABLE_PROPERTY}\n+   */\n+  public static boolean isMmCompactionTable(Map<String, String> parameters) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f11408494eaa6da0e83be54a52712abb76e3a949"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NjcxMDEw", "url": "https://github.com/apache/hive/pull/1501#pullrequestreview-489671010", "createdAt": "2020-09-16T14:14:33Z", "commit": {"oid": "f11408494eaa6da0e83be54a52712abb76e3a949"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNDoxNDozM1rOHSy9Qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNDoxNDozM1rOHSy9Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ3MTI5OQ==", "bodyText": "Would it make sense to include the hashes for the fs instances in the debug logs?", "url": "https://github.com/apache/hive/pull/1501#discussion_r489471299", "createdAt": "2020-09-16T14:14:33Z", "author": {"login": "zchovan"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java", "diffHunk": "@@ -4475,7 +4481,8 @@ public static boolean moveFile(final HiveConf conf, Path srcf, final Path destf,\n         destFs.copyFromLocalFile(srcf, destf);\n         return true;\n       } else {\n-        if (needToCopy(conf, srcf, destf, srcFs, destFs, configuredOwner, isManaged)) {\n+        if (needToCopy(conf, srcf, destf, srcFs, destFs, configuredOwner, isManaged, isCompactionTable,\n+            isMmCompactionTable)) {\n           //copy if across file system or encryption zones.\n           LOG.debug(\"Copying source \" + srcf + \" to \" + destf + \" because HDFS encryption zones are different.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f11408494eaa6da0e83be54a52712abb76e3a949"}, "originalPosition": 91}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc4e63d9734312a7258c10c5871fdbc48f68c87d", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/dc4e63d9734312a7258c10c5871fdbc48f68c87d", "committedDate": "2020-09-17T08:40:33Z", "message": "Rename isCompactionTable() methods to isFullAcidCompactionTable()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd6f0eadf27094621d7f43e9ef4ae825c621a4d9", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/fd6f0eadf27094621d7f43e9ef4ae825c621a4d9", "committedDate": "2020-09-17T08:44:43Z", "message": "Rename isCompactionTable variables to isFullAcidCompactionTable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNjIxNjQ0", "url": "https://github.com/apache/hive/pull/1501#pullrequestreview-490621644", "createdAt": "2020-09-17T13:56:07Z", "commit": {"oid": "fd6f0eadf27094621d7f43e9ef4ae825c621a4d9"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f23793710904720343bf153f1fac64238fb2892", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/7f23793710904720343bf153f1fac64238fb2892", "committedDate": "2020-09-18T09:40:08Z", "message": "Revert all changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee71ca4cc5d222a577d764121768a3f72a42092c", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/ee71ca4cc5d222a577d764121768a3f72a42092c", "committedDate": "2020-09-18T13:49:37Z", "message": "Redid, addressed review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a56576a800dddd27aae41bb15772e7f66279b5cb", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/a56576a800dddd27aae41bb15772e7f66279b5cb", "committedDate": "2020-09-22T09:53:15Z", "message": "Return null (previous behavior) if FS URI schema is not hdfs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NTI1NjAz", "url": "https://github.com/apache/hive/pull/1501#pullrequestreview-495525603", "createdAt": "2020-09-24T12:38:49Z", "commit": {"oid": "a56576a800dddd27aae41bb15772e7f66279b5cb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3321, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}