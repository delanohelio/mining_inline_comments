{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1Mzc0NzY3", "number": 1219, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoyMjoxN1rOEMDVbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoyMzozMFrOEMDW9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMDczMDA0OnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoyMjoxN1rOGt8CAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoyMjoxN1rOGt8CAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMjY1Ng==", "bodyText": "nit: should", "url": "https://github.com/apache/hive/pull/1219#discussion_r450822656", "createdAt": "2020-07-07T12:22:17Z", "author": {"login": "pvary"}, "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java", "diffHunk": "@@ -135,7 +136,7 @@ public void cleansCommittedAndEmptyAbortedOnly() throws Exception {\n \n     // kept only the 5 non-empty aborted ones\n     Assert.assertEquals(5, getTxnCount());\n-    Assert.assertEquals(15, getMaxTxnId());\n+    Assert.assertTrue(\"The max txnId shoul be at least 15\", getMaxTxnId() >= 15);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fb62cf2a06ceb7613fdc4689bc2e804c357f9ce"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMDczMDczOnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoyMjoyOFrOGt8CaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoyMjoyOFrOGt8CaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMjc2MQ==", "bodyText": "nit: should", "url": "https://github.com/apache/hive/pull/1219#discussion_r450822761", "createdAt": "2020-07-07T12:22:28Z", "author": {"login": "pvary"}, "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/txn/TestAcidTxnCleanerService.java", "diffHunk": "@@ -148,16 +149,16 @@ public void cleansEmptyAbortedBatchTxns() throws Exception {\n         TxnStore.TIMED_OUT_TXN_ABORT_BATCH_SIZE + 50);\n     OpenTxnsResponse resp = txnHandler.openTxns(new OpenTxnRequest(\n         TxnStore.TIMED_OUT_TXN_ABORT_BATCH_SIZE + 50, \"user\", \"hostname\"));\n+    txnHandler.setOpenTxnTimeOutMillis(1);\n     txnHandler.abortTxns(new AbortTxnsRequest(resp.getTxn_ids()));\n     GetOpenTxnsResponse openTxns = txnHandler.getOpenTxns();\n     Assert.assertEquals(TxnStore.TIMED_OUT_TXN_ABORT_BATCH_SIZE + 50 + 1, openTxns.getOpen_txnsSize());\n-    txnHandler.setOpenTxnTimeOutMillis(1);\n \n     underTest.run();\n \n     openTxns = txnHandler.getOpenTxns();\n     Assert.assertEquals(2, openTxns.getOpen_txnsSize());\n-    Assert.assertEquals(TxnStore.TIMED_OUT_TXN_ABORT_BATCH_SIZE + 50 + 1, getMaxTxnId());\n+    Assert.assertTrue(\"The max txnId shoul be at least\", getMaxTxnId() >= TxnStore.TIMED_OUT_TXN_ABORT_BATCH_SIZE + 50 + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fb62cf2a06ceb7613fdc4689bc2e804c357f9ce"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMDczMzk3OnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjoyMzozMFrOGt8EhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMjo1OToxMlrOGt9WfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMzMwMQ==", "bodyText": "Why is this change?", "url": "https://github.com/apache/hive/pull/1219#discussion_r450823301", "createdAt": "2020-07-07T12:23:30Z", "author": {"login": "pvary"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -568,6 +568,7 @@ public OpenTxnsResponse openTxns(OpenTxnRequest rqst) throws MetaException {\n            */\n           LOG.error(\"OpenTxnTimeOut exceeded commit duration {}, deleting transactionIds: {}\", elapsedMillis, txnIds);\n           deleteInvalidOpenTransactions(dbConn, txnIds);\n+          dbConn.commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fb62cf2a06ceb7613fdc4689bc2e804c357f9ce"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyOTE4Nw==", "bodyText": "It was missing, the delete was not persisted. When I was testing manually, I didn't notice, because I was querying back the data on the same connection...\nIt does not cause a big problem, these transactions would be cleaned up eventually when they time out.", "url": "https://github.com/apache/hive/pull/1219#discussion_r450829187", "createdAt": "2020-07-07T12:34:16Z", "author": {"login": "pvargacl"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -568,6 +568,7 @@ public OpenTxnsResponse openTxns(OpenTxnRequest rqst) throws MetaException {\n            */\n           LOG.error(\"OpenTxnTimeOut exceeded commit duration {}, deleting transactionIds: {}\", elapsedMillis, txnIds);\n           deleteInvalidOpenTransactions(dbConn, txnIds);\n+          dbConn.commit();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMzMwMQ=="}, "originalCommit": {"oid": "3fb62cf2a06ceb7613fdc4689bc2e804c357f9ce"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NDExMQ==", "bodyText": "I thought close(null, stmt, dbConn) commits, but you are right, that it does not commit.\nShall we create a test case for this? :)", "url": "https://github.com/apache/hive/pull/1219#discussion_r450844111", "createdAt": "2020-07-07T12:58:54Z", "author": {"login": "pvary"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -568,6 +568,7 @@ public OpenTxnsResponse openTxns(OpenTxnRequest rqst) throws MetaException {\n            */\n           LOG.error(\"OpenTxnTimeOut exceeded commit duration {}, deleting transactionIds: {}\", elapsedMillis, txnIds);\n           deleteInvalidOpenTransactions(dbConn, txnIds);\n+          dbConn.commit();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMzMwMQ=="}, "originalCommit": {"oid": "3fb62cf2a06ceb7613fdc4689bc2e804c357f9ce"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDg0NDI4NQ==", "bodyText": "Maybe in a follow-up jira...", "url": "https://github.com/apache/hive/pull/1219#discussion_r450844285", "createdAt": "2020-07-07T12:59:12Z", "author": {"login": "pvary"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -568,6 +568,7 @@ public OpenTxnsResponse openTxns(OpenTxnRequest rqst) throws MetaException {\n            */\n           LOG.error(\"OpenTxnTimeOut exceeded commit duration {}, deleting transactionIds: {}\", elapsedMillis, txnIds);\n           deleteInvalidOpenTransactions(dbConn, txnIds);\n+          dbConn.commit();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDgyMzMwMQ=="}, "originalCommit": {"oid": "3fb62cf2a06ceb7613fdc4689bc2e804c357f9ce"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 535, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}