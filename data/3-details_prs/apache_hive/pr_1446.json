{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2MjgzNzc3", "number": 1446, "title": "HIVE-22622: Hive allows to create a struct with duplicate attribute names", "bodyText": "What changes were proposed in this pull request?\nAdd a check for duplicated struct attribute identifiers and throw SemanticException with customized error message when found.\nWhy are the changes needed?\nCreating a table with a struct type column with duplicate attribute identifier and inserting records is allowed but later when querying from the table we cannot distinguish between the attributes of the struct has the same identifier.\nIn some cases (depending on table serde format) the query may fails. See jira for details.\nDoes this PR introduce any user-facing change?\nIntroduce new error code and message. Example:\nFAILED: SemanticException [Error 10423]: Attribute \"id\" specified more than once in structured type.\n\nHow was this patch tested?\n\nCreate new negative test:\n\nmvn test -Dtest.output.overwrite -DskipSparkTests -Dtest=TestNegativeCliDriver -Dqfile=struct_attribute_uniqueness.q,struct_attribute_uniqueness_2.q -pl itests/qtest -Pitests\n\n\nReproduce query failure\n\nCREATE TABLE person\n(\n    `id`      int,\n    `address` struct<number:int,street:string,number:int>\n)\n    ROW FORMAT SERDE\n        'org.apache.hadoop.hive.ql.io.orc.OrcSerde'\n    STORED AS INPUTFORMAT\n        'org.apache.hadoop.hive.ql.io.orc.OrcInputFormat'\n        OUTPUTFORMAT\n            'org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat';\n\nINSERT INTO person\nVALUES (1, named_struct('number', 61, 'street', 'Terrasse', 'number', 62));\nINSERT INTO person\nVALUES (2, named_struct('number', 51, 'street', 'Terrasse', 'number', 52));\n\nSELECT address.number FROM person;", "createdAt": "2020-08-31T13:02:12Z", "url": "https://github.com/apache/hive/pull/1446", "merged": true, "mergeCommit": {"oid": "93208383964cc3ed5bdf4088f13fd13ecdec6c2c"}, "closed": true, "closedAt": "2020-09-01T22:26:05Z", "author": {"login": "kasakrisz"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdESaLYgH2gAyNDc2MjgzNzc3OmE2MWRkNTY4N2Q4ZTk5Y2ZhYTI5YmI4MjU3ZGE0MmQzM2M5OTc1MGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEvDw_gFqTQ4MDE1ODA1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a61dd5687d8e99cfaa29bb8257da42d33c99750f", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/a61dd5687d8e99cfaa29bb8257da42d33c99750f", "committedDate": "2020-08-31T12:59:49Z", "message": "HIVE-22622: Hive allows to create a struct with duplicate attribute names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTYwNzM2", "url": "https://github.com/apache/hive/pull/1446#pullrequestreview-478960736", "createdAt": "2020-08-31T21:15:49Z", "commit": {"oid": "a61dd5687d8e99cfaa29bb8257da42d33c99750f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4OTY3Nzkw", "url": "https://github.com/apache/hive/pull/1446#pullrequestreview-478967790", "createdAt": "2020-08-31T21:28:41Z", "commit": {"oid": "a61dd5687d8e99cfaa29bb8257da42d33c99750f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMToyODo0MlrOHKJ2HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQyMToyODo0MlrOHKJ2HA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDQwOTExNg==", "bodyText": "nit: Usually we use \"field\" for row types and \"attribute\" for struct types. Plus it reads more natural if we inline the attribute name in the sentence:\nAttribute \\\"{0}\\\" specified more than once in structured type.", "url": "https://github.com/apache/hive/pull/1446#discussion_r480409116", "createdAt": "2020-08-31T21:28:42Z", "author": {"login": "zabetak"}, "path": "common/src/java/org/apache/hadoop/hive/ql/ErrorMsg.java", "diffHunk": "@@ -471,6 +471,7 @@\n           \"Not an ordered-set aggregate function: {0}. WITHIN GROUP clause is not allowed.\", true),\n   WITHIN_GROUP_PARAMETER_MISMATCH(10422,\n           \"The number of hypothetical direct arguments ({0}) must match the number of ordering columns ({1})\", true),\n+  AMBIGUOUS_STRUCT_FIELD(10423, \"Struct field is not unique: {0}\", true),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a61dd5687d8e99cfaa29bb8257da42d33c99750f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b34a2bd2a2c1c6dc095dee4c10c147dd3e2fb78f", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/b34a2bd2a2c1c6dc095dee4c10c147dd3e2fb78f", "committedDate": "2020-09-01T06:58:55Z", "message": "HIVE-22622: Hive allows to create a struct with duplicate attribute names - address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMTU4MDU3", "url": "https://github.com/apache/hive/pull/1446#pullrequestreview-480158057", "createdAt": "2020-09-01T22:22:35Z", "commit": {"oid": "b34a2bd2a2c1c6dc095dee4c10c147dd3e2fb78f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3268, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}