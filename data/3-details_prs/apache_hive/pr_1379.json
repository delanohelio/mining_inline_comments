{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0NjQ5NjAy", "number": 1379, "title": "HIVE-23408: Hive on Tez : Kafka storage handler broken in secure envi\u2026", "bodyText": "\u2026ronment\nChange-Id: I486e9169279765b8a695d27264b770c8db92128f\n\nWhat changes were proposed in this pull request?\n\ncollect kafka delegation token in HS2\npropagate tokens to tez and use it in tasks\n\nWhy are the changes needed?\ntez tasks fail to connect to kafka brokers on a secure cluster\nDoes this PR introduce any user-facing change?\nnot really, except that tez tasks will able to read from kafka topics on a secure cluster\nHow was this patch tested?\ntested on secure cluster", "createdAt": "2020-08-07T14:53:43Z", "url": "https://github.com/apache/hive/pull/1379", "merged": true, "mergeCommit": {"oid": "bba73fba560b6a0a6617b67026fe32a3241bfeca"}, "closed": true, "closedAt": "2020-09-07T08:39:06Z", "author": {"login": "abstractdog"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCCmdTAH2gAyNDY0NjQ5NjAyOjc5MmY2OTQ5OWYxOTM1Y2ZhYWQ3NDMzNTM2MzBkYzUxODM1YmQxMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFqwQtgFqTQ4MjkwOTEyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "792f69499f1935cfaad743353630dc51835bd119", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/792f69499f1935cfaad743353630dc51835bd119", "committedDate": "2020-08-24T13:26:54Z", "message": "HIVE-23408: Hive on Tez : Kafka storage handler broken in secure environment\n\nChange-Id: I486e9169279765b8a695d27264b770c8db92128f"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe6a71e0fd9ceac1b471edd6fb7fd427beb30c7a", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/fe6a71e0fd9ceac1b471edd6fb7fd427beb30c7a", "committedDate": "2020-08-07T14:52:12Z", "message": "HIVE-23408: Hive on Tez : Kafka storage handler broken in secure environment\n\nChange-Id: I486e9169279765b8a695d27264b770c8db92128f"}, "afterCommit": {"oid": "792f69499f1935cfaad743353630dc51835bd119", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/792f69499f1935cfaad743353630dc51835bd119", "committedDate": "2020-08-24T13:26:54Z", "message": "HIVE-23408: Hive on Tez : Kafka storage handler broken in secure environment\n\nChange-Id: I486e9169279765b8a695d27264b770c8db92128f"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxOTI1OTcw", "url": "https://github.com/apache/hive/pull/1379#pullrequestreview-481925970", "createdAt": "2020-09-03T14:56:59Z", "commit": {"oid": "792f69499f1935cfaad743353630dc51835bd119"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNDo1Njo1OVrOHMqpQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNDo1ODo0NFrOHMquVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA0MzY0OQ==", "bodyText": "Kafka version is also declared specifically in kafka-handler/pom.xml Can we parmeterize there, so that all of Hive is referencing just one kafka version?", "url": "https://github.com/apache/hive/pull/1379#discussion_r483043649", "createdAt": "2020-09-03T14:56:59Z", "author": {"login": "ashutoshc"}, "path": "pom.xml", "diffHunk": "@@ -169,6 +169,7 @@\n     <junit.version>4.13</junit.version>\n     <junit.jupiter.version>5.6.2</junit.jupiter.version>\n     <junit.vintage.version>5.6.2</junit.vintage.version>\n+    <kafka.version>2.5.0</kafka.version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "792f69499f1935cfaad743353630dc51835bd119"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA0NDk0OQ==", "bodyText": "This is iterating over all partition objects in plan even when kafka is not used. This gets expensive when there are large number of partition objects. Is it possible to do a quick check to see if kafka is used before iterating over full list of parttions?", "url": "https://github.com/apache/hive/pull/1379#discussion_r483044949", "createdAt": "2020-09-03T14:58:44Z", "author": {"login": "ashutoshc"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/exec/tez/DagUtils.java", "diffHunk": "@@ -265,11 +279,70 @@ public URI apply(Path path) {\n         }\n         dag.addURIsForCredentials(uris);\n       }\n+      getKafkaCredentials((MapWork)work, dag, conf);\n     }\n-\n     getCredentialsForFileSinks(work, dag);\n   }\n \n+  private void getKafkaCredentials(MapWork work, DAG dag, JobConf conf) {\n+    Token<?> tokenCheck = dag.getCredentials().getToken(KAFKA_DELEGATION_TOKEN_KEY);\n+    if (tokenCheck != null) {\n+      LOG.debug(\"Kafka credentials already added, skipping...\");\n+      return;\n+    }\n+    LOG.info(\"Getting kafka credentials for mapwork: \" + work.getName());\n+\n+    String kafkaBrokers = null;\n+    Map<String, PartitionDesc> partitions = work.getAliasToPartnInfo();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "792f69499f1935cfaad743353630dc51835bd119"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f7a0ed812713b57d261e4744a510ea5bba64c01", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/0f7a0ed812713b57d261e4744a510ea5bba64c01", "committedDate": "2020-09-04T14:54:44Z", "message": "HIVE-23408: addressing PR comments\n\nChange-Id: I5b09b318f5dfdbda07247748f9f8e566e00805ed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edc4ad440af4e234b731104bbcb9837cbdf43a19", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/edc4ad440af4e234b731104bbcb9837cbdf43a19", "committedDate": "2020-09-04T11:35:37Z", "message": "HIVE-23408: addressing PR comments\n\nChange-Id: I5b09b318f5dfdbda07247748f9f8e566e00805ed"}, "afterCommit": {"oid": "0f7a0ed812713b57d261e4744a510ea5bba64c01", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/0f7a0ed812713b57d261e4744a510ea5bba64c01", "committedDate": "2020-09-04T14:54:44Z", "message": "HIVE-23408: addressing PR comments\n\nChange-Id: I5b09b318f5dfdbda07247748f9f8e566e00805ed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyOTA5MTI4", "url": "https://github.com/apache/hive/pull/1379#pullrequestreview-482909128", "createdAt": "2020-09-04T19:55:35Z", "commit": {"oid": "0f7a0ed812713b57d261e4744a510ea5bba64c01"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3431, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}