{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwNzk5OTY1", "number": 1786, "title": "HIVE-23684: Large underestimation in NDV stats when input and join ca\u2026", "bodyText": "\u2026rdinality ratio is big\n\nWhat changes were proposed in this pull request?\n\nWhy are the changes needed?\n\nDoes this PR introduce any user-facing change?\n\nHow was this patch tested?", "createdAt": "2020-12-16T00:06:58Z", "url": "https://github.com/apache/hive/pull/1786", "merged": true, "mergeCommit": {"oid": "e08e6396280a0377355f9dc6339c5aa1d98a7a5e"}, "closed": true, "closedAt": "2021-01-13T16:45:45Z", "author": {"login": "vineetgarg02"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdm1F_QAFqTU1NDA1OTM1NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvhilTgH2gAyNTQwNzk5OTY1OjY4MDJlY2M0NmYzMTk2M2ZiZTYyYmQ4ZTFlOGMyMGNhNWY5ODM0Zjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MDU5MzU1", "url": "https://github.com/apache/hive/pull/1786#pullrequestreview-554059355", "createdAt": "2020-12-16T20:30:21Z", "commit": {"oid": "9f9dbb2a921b285935400c4b4859f7fc9e262834"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMDozMDoyMVrOIHX4pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMDozMjoyNVrOIHX9gA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYwMjI3Ng==", "bodyText": "typo: estimatation", "url": "https://github.com/apache/hive/pull/1786#discussion_r544602276", "createdAt": "2020-12-16T20:30:21Z", "author": {"login": "jcamachor"}, "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "diffHunk": "@@ -2686,6 +2686,8 @@ private static void populateLlapDaemonVarsSet(Set<String> llapDaemonVarsSetLocal\n         \"Estimate statistics in absence of statistics.\"),\n     HIVE_STATS_NDV_ESTIMATE_PERC(\"hive.stats.ndv.estimate.percent\", (float)20,\n         \"This many percentage of rows will be estimated as count distinct in absence of statistics.\"),\n+    HIVE_STATS_JOIN_NDV_READJUSTMENT(\"hive.stats.join.ndv.readjustment\", false,\n+        \"Setting this to true will make Hive use Calcite to adjust estimatation for ndv after join.\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f9dbb2a921b285935400c4b4859f7fc9e262834"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYwMzAwNg==", "bodyText": "Setting this to true will make Hive use Calcite\nInstead of 'Calcite' logic, could you maybe mention (one-liner since it is a config and there is no need of it to be too long) the kind of estimation it does?", "url": "https://github.com/apache/hive/pull/1786#discussion_r544603006", "createdAt": "2020-12-16T20:31:35Z", "author": {"login": "jcamachor"}, "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "diffHunk": "@@ -2686,6 +2686,8 @@ private static void populateLlapDaemonVarsSet(Set<String> llapDaemonVarsSetLocal\n         \"Estimate statistics in absence of statistics.\"),\n     HIVE_STATS_NDV_ESTIMATE_PERC(\"hive.stats.ndv.estimate.percent\", (float)20,\n         \"This many percentage of rows will be estimated as count distinct in absence of statistics.\"),\n+    HIVE_STATS_JOIN_NDV_READJUSTMENT(\"hive.stats.join.ndv.readjustment\", false,\n+        \"Setting this to true will make Hive use Calcite to adjust estimatation for ndv after join.\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f9dbb2a921b285935400c4b4859f7fc9e262834"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDYwMzUyMA==", "bodyText": "Can RelMdUtil.numDistinctVals return null? Just making sure we do not need a null check.", "url": "https://github.com/apache/hive/pull/1786#discussion_r544603520", "createdAt": "2020-12-16T20:32:25Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/stats/annotation/StatsRulesProcFactory.java", "diffHunk": "@@ -2546,19 +2547,25 @@ private void updateColStats(HiveConf conf, Statistics stats, long leftUnmatchedR\n       for (ColStatistics cs : colStats) {\n         colNameStatsAvailable.add(cs.getColumnName());\n         int pos = jop.getConf().getReversedExprs().get(cs.getColumnName());\n-        long oldRowCount = rowCountParents.get(pos);\n-        double ratio = (double) newNumRows / (double) oldRowCount;\n         long oldDV = cs.getCountDistint();\n+\n+        boolean useCalciteForNdvReadjustment\n+            = HiveConf.getBoolVar(conf, ConfVars.HIVE_STATS_JOIN_NDV_READJUSTMENT);\n         long newDV = oldDV;\n+        if (useCalciteForNdvReadjustment) {\n+          newDV = RelMdUtil.numDistinctVals(oldDV * 1.0, newNumRows * 1.0).longValue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f9dbb2a921b285935400c4b4859f7fc9e262834"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f447833b98749d72092d27fc5f7760a15cc3c35c", "author": {"user": {"login": "vineetgarg02", "name": "Vineet G"}}, "url": "https://github.com/apache/hive/commit/f447833b98749d72092d27fc5f7760a15cc3c35c", "committedDate": "2020-12-21T20:31:19Z", "message": "HIVE-23684: Large underestimation in NDV stats when input and join cardinality ratio is big"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d3fef877cbf45ea3a54379137490e8f80b9bd48", "author": {"user": {"login": "vineetgarg02", "name": "Vineet G"}}, "url": "https://github.com/apache/hive/commit/8d3fef877cbf45ea3a54379137490e8f80b9bd48", "committedDate": "2020-12-21T20:31:19Z", "message": "addressing review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c8ef43980567cff19c7aea58d0ced32c1b06d23c", "author": {"user": {"login": "vineetgarg02", "name": "Vineet G"}}, "url": "https://github.com/apache/hive/commit/c8ef43980567cff19c7aea58d0ced32c1b06d23c", "committedDate": "2020-12-21T16:51:07Z", "message": "addressing review comments"}, "afterCommit": {"oid": "8d3fef877cbf45ea3a54379137490e8f80b9bd48", "author": {"user": {"login": "vineetgarg02", "name": "Vineet G"}}, "url": "https://github.com/apache/hive/commit/8d3fef877cbf45ea3a54379137490e8f80b9bd48", "committedDate": "2020-12-21T20:31:19Z", "message": "addressing review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2ODE3MjE5", "url": "https://github.com/apache/hive/pull/1786#pullrequestreview-556817219", "createdAt": "2020-12-22T04:51:17Z", "commit": {"oid": "8d3fef877cbf45ea3a54379137490e8f80b9bd48"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNDo1MToxOFrOIJuS0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQwNDo1MToxOFrOIJuS0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA2NjU3OQ==", "bodyText": "We should probably add a precondition so we fail it if is null. Otherwise, we will basically not scale the value silently, which is neither the new behavior or the old behavior.", "url": "https://github.com/apache/hive/pull/1786#discussion_r547066579", "createdAt": "2020-12-22T04:51:18Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/stats/annotation/StatsRulesProcFactory.java", "diffHunk": "@@ -2553,7 +2553,10 @@ private void updateColStats(HiveConf conf, Statistics stats, long leftUnmatchedR\n             = HiveConf.getBoolVar(conf, ConfVars.HIVE_STATS_JOIN_NDV_READJUSTMENT);\n         long newDV = oldDV;\n         if (useCalciteForNdvReadjustment) {\n-          newDV = RelMdUtil.numDistinctVals(oldDV * 1.0, newNumRows * 1.0).longValue();\n+          Double approxNdv = RelMdUtil.numDistinctVals(oldDV * 1.0, newNumRows * 1.0);\n+          if (approxNdv != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d3fef877cbf45ea3a54379137490e8f80b9bd48"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14b093d4441dcfe017f7947c5b6e4dc06818d363", "author": {"user": {"login": "vineetgarg02", "name": "Vineet G"}}, "url": "https://github.com/apache/hive/commit/14b093d4441dcfe017f7947c5b6e4dc06818d363", "committedDate": "2020-12-22T16:56:41Z", "message": "addressing review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a95b5d0c85cd9076a363337ecb00830602c7ed1", "author": {"user": {"login": "vineetgarg02", "name": "Vineet G"}}, "url": "https://github.com/apache/hive/commit/8a95b5d0c85cd9076a363337ecb00830602c7ed1", "committedDate": "2020-12-22T16:57:19Z", "message": "Merge remote-tracking branch 'upstream/master' into HIVE-23684"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c2e7c59d315ace51fc3ff52b9abd010b553b5f5", "author": {"user": {"login": "vineetgarg02", "name": "Vineet G"}}, "url": "https://github.com/apache/hive/commit/2c2e7c59d315ace51fc3ff52b9abd010b553b5f5", "committedDate": "2021-01-04T16:59:02Z", "message": "Merge remote-tracking branch 'upstream/master' into HIVE-23684"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6802ecc46f31963fbe62bd8e1e8c20ca5f9834f7", "author": {"user": {"login": "vineetgarg02", "name": "Vineet G"}}, "url": "https://github.com/apache/hive/commit/6802ecc46f31963fbe62bd8e1e8c20ca5f9834f7", "committedDate": "2021-01-12T20:56:19Z", "message": "Merge remote-tracking branch 'upstream/master' into HIVE-23684"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2932, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}