{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxODQ2ODM5", "number": 1735, "title": "HIVE-24474: Failed compaction always logs TxnAbortedException (again)", "bodyText": "What changes were proposed in this pull request?\nWhy are the changes needed?\nSee HIVE-24474\nDoes this PR introduce any user-facing change?\nNo\nHow was this patch tested?\nManually, since the TxnAbortedException only appears in the logs.", "createdAt": "2020-12-03T15:06:05Z", "url": "https://github.com/apache/hive/pull/1735", "merged": true, "mergeCommit": {"oid": "314ff8d44f802ea1a7834abc4837c4709e9f4971"}, "closed": true, "closedAt": "2020-12-16T08:59:46Z", "author": {"login": "klcopp"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdifFJEAH2gAyNTMxODQ2ODM5OjQxYTY4ODY5M2U3MGE2MzAzZWI1ZDJjYjE4YTJhYzMzODM5NDM5ZjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmZxIfgFqTU1MjQxNDIwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "41a688693e70a6303eb5d2cb18a2ac33839439f4", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/41a688693e70a6303eb5d2cb18a2ac33839439f4", "committedDate": "2020-12-03T08:43:20Z", "message": "HIVE-24474: Failed compaction always throws TxnAbortedException (again)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0ODYzNjMw", "url": "https://github.com/apache/hive/pull/1735#pullrequestreview-544863630", "createdAt": "2020-12-04T11:07:57Z", "commit": {"oid": "41a688693e70a6303eb5d2cb18a2ac33839439f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMTowNzo1OFrOH_MHIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMTowNzo1OFrOH_MHIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAyMDc2OQ==", "bodyText": "Why not just set it to TXN_ID_NOT_SET after calling abortComapctionAndMarkFailed?", "url": "https://github.com/apache/hive/pull/1735#discussion_r536020769", "createdAt": "2020-12-04T11:07:58Z", "author": {"login": "pvary"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Worker.java", "diffHunk": "@@ -561,12 +561,12 @@ protected Boolean findNextCompactionAndExecute(boolean computeStats) throws Inte\n       } catch (Throwable e) {\n         LOG.error(\"Caught exception while trying to compact \" + ci +\n             \".  Marking failed to avoid repeated failures\", e);\n-        abortCompactionAndMarkFailed(ci, compactorTxnId, e);\n+        compactorTxnId = abortCompactionAndMarkFailed(ci, compactorTxnId, e);\n       }\n     } catch (TException | IOException t) {\n       LOG.error(\"Caught an exception in the main loop of compactor worker \" + workerName, t);\n       try {\n-        abortCompactionAndMarkFailed(ci, compactorTxnId, t);\n+        compactorTxnId = abortCompactionAndMarkFailed(ci, compactorTxnId, t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41a688693e70a6303eb5d2cb18a2ac33839439f4"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3775e9c3a33eb5800d6ac6d0b15cafb58b3ecbb", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/c3775e9c3a33eb5800d6ac6d0b15cafb58b3ecbb", "committedDate": "2020-12-08T15:55:51Z", "message": "Revert \"HIVE-24474: Failed compaction always throws TxnAbortedException (again)\"\n\nThis reverts commit 41a688693e70a6303eb5d2cb18a2ac33839439f4."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65d4586a1bd2391f200c24604343838b9771333c", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/65d4586a1bd2391f200c24604343838b9771333c", "committedDate": "2020-12-09T15:57:38Z", "message": "Created an inner class to track the compaction txn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6", "committedDate": "2020-12-10T15:13:59Z", "message": "Fixed mistake"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTE4MTU3", "url": "https://github.com/apache/hive/pull/1735#pullrequestreview-549918157", "createdAt": "2020-12-11T09:09:46Z", "commit": {"oid": "70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOTowOTo0NlrOIDvlew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOTowOTo0NlrOIDvlew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5NjI4Mw==", "bodyText": "Maybe change compactionHeartbeater to use the new class instead of Id?", "url": "https://github.com/apache/hive/pull/1735#discussion_r540796283", "createdAt": "2020-12-11T09:09:46Z", "author": {"login": "pvary"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Worker.java", "diffHunk": "@@ -483,12 +471,12 @@ protected Boolean findNextCompactionAndExecute(boolean computeStats) throws Inte\n        * multiple statements in it (for query based compactor) which is not supported (and since\n        * this case some of the statements are DDL, even in the future will not be allowed in a\n        * multi-stmt txn. {@link Driver#setCompactionWriteIds(ValidWriteIdList, long)} */\n-      compactorTxnId = msc.openTxn(ci.runAs, TxnType.COMPACTION);\n+      compactionTxn.open(ci);\n \n-      heartbeater = new CompactionHeartbeater(compactorTxnId, fullTableName, conf);\n+      heartbeater = new CompactionHeartbeater(compactionTxn.getTxnId(), fullTableName, conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTE4NjM5", "url": "https://github.com/apache/hive/pull/1735#pullrequestreview-549918639", "createdAt": "2020-12-11T09:10:26Z", "commit": {"oid": "70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOToxMDoyNlrOIDvnIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOToxMDoyNlrOIDvnIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5NjcwNw==", "bodyText": "Maybe toString for CompactionTxnId?", "url": "https://github.com/apache/hive/pull/1735#discussion_r540796707", "createdAt": "2020-12-11T09:10:26Z", "author": {"login": "pvary"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Worker.java", "diffHunk": "@@ -556,20 +544,20 @@ protected Boolean findNextCompactionAndExecute(boolean computeStats) throws Inte\n         verifyTableIdHasNotChanged(ci, t1);\n \n         LOG.info(\"Completed \" + ci.type.toString() + \" compaction for \" + ci.getFullPartitionName() + \" in txn \"\n-            + JavaUtils.txnIdToString(compactorTxnId) + \", marking as compacted.\");\n+            + JavaUtils.txnIdToString(compactionTxn.getTxnId()) + \", marking as compacted.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTE5Mzkx", "url": "https://github.com/apache/hive/pull/1735#pullrequestreview-549919391", "createdAt": "2020-12-11T09:11:30Z", "commit": {"oid": "70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOToxMTozMFrOIDvpvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwOToxMTozMFrOIDvpvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5NzM3Mw==", "bodyText": "Maybe commitOrAbort? Or close? This is not always commit if I understand correctly", "url": "https://github.com/apache/hive/pull/1735#discussion_r540797373", "createdAt": "2020-12-11T09:11:30Z", "author": {"login": "pvary"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Worker.java", "diffHunk": "@@ -579,7 +567,7 @@ protected Boolean findNextCompactionAndExecute(boolean computeStats) throws Inte\n     } catch (Throwable t) {\n       LOG.error(\"Caught an exception in the main loop of compactor worker \" + workerName, t);\n     } finally {\n-      commitTxnIfSet(compactorTxnId);\n+      compactionTxn.commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6"}, "originalPosition": 102}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4f7ce97df8e3a1ebc1213c03506bd07034a41c5", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/c4f7ce97df8e3a1ebc1213c03506bd07034a41c5", "committedDate": "2020-12-11T10:22:45Z", "message": "Addressed review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMzQ2MjM1", "url": "https://github.com/apache/hive/pull/1735#pullrequestreview-550346235", "createdAt": "2020-12-11T17:36:54Z", "commit": {"oid": "c4f7ce97df8e3a1ebc1213c03506bd07034a41c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxNzozNjo1NFrOIEC9ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxNzozNjo1NFrOIEC9ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTExMzcwMQ==", "bodyText": "What if we extend AutoCloseable?\nThen we can use the try withresource without finally magic. And close could say - if needed commit.\nI think this is the last comment.\nHow do you like this code? Is it better?", "url": "https://github.com/apache/hive/pull/1735#discussion_r541113701", "createdAt": "2020-12-11T17:36:54Z", "author": {"login": "pvary"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Worker.java", "diffHunk": "@@ -636,4 +621,66 @@ private static boolean isDynPartAbort(Table t, CompactionInfo ci) {\n     return t.getPartitionKeys() != null && t.getPartitionKeys().size() > 0\n         && ci.partName == null;\n   }\n+\n+  /**\n+   * Keep track of the compaction's transaction and its operations.\n+   */\n+  private class CompactionTxn {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4f7ce97df8e3a1ebc1213c03506bd07034a41c5"}, "originalPosition": 193}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "706dda7380ab3c3dfa455195928f1c89225f81f3", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/706dda7380ab3c3dfa455195928f1c89225f81f3", "committedDate": "2020-12-14T12:20:33Z", "message": "Use try-with-resources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d8d6391821399796e1be0443a204073e1ad584e", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/2d8d6391821399796e1be0443a204073e1ad584e", "committedDate": "2020-12-14T12:40:00Z", "message": "Cosmetic fixes and cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12cab7fff16ce0ce01be9e4c5292668af8789b83", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/12cab7fff16ce0ce01be9e4c5292668af8789b83", "committedDate": "2020-12-15T08:42:33Z", "message": "Fixed mistake"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNDE0MjAz", "url": "https://github.com/apache/hive/pull/1735#pullrequestreview-552414203", "createdAt": "2020-12-15T12:47:40Z", "commit": {"oid": "12cab7fff16ce0ce01be9e4c5292668af8789b83"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2859, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}