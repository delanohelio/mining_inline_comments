{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNDQxODUw", "number": 1688, "title": "HIVE-24403: change min_history_level to make it compatible with older versions", "bodyText": "What changes were proposed in this pull request?\nModify HIVE-23107 to make it backward compatible with older version HMS-s using the same backend DB\nWhy are the changes needed?\nDoes this PR introduce any user-facing change?\nNo\nHow was this patch tested?\nUnit tests", "createdAt": "2020-11-18T20:10:10Z", "url": "https://github.com/apache/hive/pull/1688", "merged": true, "mergeCommit": {"oid": "ee8663eed41cb8842f891e863bffeff0c2aa539e"}, "closed": true, "closedAt": "2020-12-04T09:00:03Z", "author": {"login": "pvargacl"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddz3KbgH2gAyNTIzNDQxODUwOjhmMTljODgyNTEyNWVlMDI5YmMyY2JkYzQ0YjVhMDUzMjg5MGUwYzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdig4f4AFqTU0MzgyOTQxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f19c8825125ee029bc2cbdc44b5a0532890e0c6", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/8f19c8825125ee029bc2cbdc44b5a0532890e0c6", "committedDate": "2020-11-18T20:06:27Z", "message": "HIVE-24403: change min_history_level to make it compatible with older versions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8860053501848d78491929abb1cc240b3f4dcec7", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/8860053501848d78491929abb1cc240b3f4dcec7", "committedDate": "2020-11-19T11:25:04Z", "message": "Add test and tableNotExist check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/1220f0210ee0b669728e8976b8e2f8293463b5ea", "committedDate": "2020-11-19T15:42:18Z", "message": "Fix test results"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MzI1NjUx", "url": "https://github.com/apache/hive/pull/1688#pullrequestreview-538325651", "createdAt": "2020-11-25T09:54:01Z", "commit": {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwOTo1NDowMVrOH5rb6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwOTo1NDowMVrOH5rb6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0MjUzNg==", "bodyText": "That's not a test class. Production code becomes massive because of that.", "url": "https://github.com/apache/hive/pull/1688#discussion_r530242536", "createdAt": "2020-11-25T09:54:01Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnDbUtil.java", "diffHunk": "@@ -385,6 +391,26 @@ public static String queryToString(Configuration conf, String query, boolean inc\n     return sb.toString();\n   }\n \n+  /**\n+   * This is only for testing, it does not use the connectionPool from TxnHandler!\n+   * @param conf\n+   * @param query\n+   * @throws Exception\n+   */\n+  @VisibleForTesting\n+  public static void executeUpdate(Configuration conf, String query)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea"}, "originalPosition": 95}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MzMxOTA3", "url": "https://github.com/apache/hive/pull/1688#pullrequestreview-538331907", "createdAt": "2020-11-25T10:00:55Z", "commit": {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMDowMDo1NVrOH5rvPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMDowMDo1NVrOH5rvPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI0NzQ4NA==", "bodyText": "you can just select 1", "url": "https://github.com/apache/hive/pull/1688#discussion_r530247484", "createdAt": "2020-11-25T10:00:55Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -390,6 +404,42 @@ public void setConf(Configuration conf){\n     }\n   }\n \n+  /**\n+   * Check if min_history_level table is usable\n+   * @return\n+   * @throws MetaException\n+   */\n+  private boolean checkMinHistoryLevelTable(boolean configValue) throws MetaException {\n+    if (!configValue) {\n+      // don't check it if disabled\n+      return false;\n+    }\n+    Connection dbConn = null;\n+    boolean tableExists = true;\n+    try {\n+      dbConn = getDbConn(Connection.TRANSACTION_READ_COMMITTED);\n+      try (Statement stmt = dbConn.createStatement()) {\n+        // Dummy query to see if table exists\n+        try (ResultSet rs = stmt.executeQuery(\"SELECT MIN(\\\"MHL_MIN_OPEN_TXNID\\\") FROM \\\"MIN_HISTORY_LEVEL\\\"\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MzM1ODU0", "url": "https://github.com/apache/hive/pull/1688#pullrequestreview-538335854", "createdAt": "2020-11-25T10:05:30Z", "commit": {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMDowNTozMFrOH5r7Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMDowNTozMFrOH5r7Yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI1MDU5NA==", "bodyText": "why not to embed getMinOpenTxnIdWaterMark(dbConn) inside of addTxnToMinHistoryLevel and remove above minOpenTxnId block?", "url": "https://github.com/apache/hive/pull/1688#discussion_r530250594", "createdAt": "2020-11-25T10:05:30Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -670,6 +725,8 @@ public OpenTxnsResponse openTxns(OpenTxnRequest rqst) throws MetaException {\n \n       assert txnIds.size() == numTxns;\n \n+      addTxnToMinHistoryLevel(dbConn, txnIds, minOpenTxnId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MzM5ODA1", "url": "https://github.com/apache/hive/pull/1688#pullrequestreview-538339805", "createdAt": "2020-11-25T10:10:17Z", "commit": {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMDoxMDoxN1rOH5sHjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMDoxMDoxN1rOH5sHjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI1MzcwOA==", "bodyText": "Are you covering the case that schema change doesn't force any restart? Lot's of code duplication, can you wrap needed methods with aspect?", "url": "https://github.com/apache/hive/pull/1688#discussion_r530253708", "createdAt": "2020-11-25T10:10:17Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -5094,6 +5153,99 @@ public void countOpenTxns() throws MetaException {\n     }\n   }\n \n+  /**\n+   * Add min history level entry for each generated txn record\n+   * @param dbConn Connection\n+   * @param txnIds new transaction ids\n+   * @deprecated Remove this method when min_history_level table is dropped\n+   * @throws SQLException ex\n+   */\n+  @Deprecated\n+  private void addTxnToMinHistoryLevel(Connection dbConn, List<Long> txnIds, long minOpenTxnId) throws SQLException {\n+    if (!useMinHistoryLevel) {\n+      return;\n+    }\n+    // Need to register minimum open txnid for current transactions into MIN_HISTORY table.\n+    try (Statement stmt = dbConn.createStatement()) {\n+\n+      List<String> rows = txnIds.stream().map(txnId -> txnId + \", \" + minOpenTxnId).collect(Collectors.toList());\n+\n+      // Insert transaction entries into MIN_HISTORY_LEVEL.\n+      List<String> inserts =\n+          sqlGenerator.createInsertValuesStmt(\"\\\"MIN_HISTORY_LEVEL\\\" (\\\"MHL_TXNID\\\", \\\"MHL_MIN_OPEN_TXNID\\\")\", rows);\n+      for (String insert : inserts) {\n+        LOG.debug(\"Going to execute insert <\" + insert + \">\");\n+        stmt.execute(insert);\n+      }\n+      LOG.info(\"Added entries to MIN_HISTORY_LEVEL for current txns: (\" + txnIds + \") with min_open_txn: \" + minOpenTxnId);\n+    } catch (SQLException e) {\n+      if (dbProduct.isTableNotExists(e)) {\n+        // If the table does not exists anymore, we disable the flag and start to work the new way\n+        // This enables to switch to the new functionality without a restart\n+        useMinHistoryLevel = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea"}, "originalPosition": 141}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4MzcxNDQ4", "url": "https://github.com/apache/hive/pull/1688#pullrequestreview-538371448", "createdAt": "2020-11-25T10:48:47Z", "commit": {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4Mzc5MjA2", "url": "https://github.com/apache/hive/pull/1688#pullrequestreview-538379206", "createdAt": "2020-11-25T10:58:12Z", "commit": {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMDo1ODoxMlrOH5t_zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMDo1ODoxMlrOH5t_zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDI4NDQ5NQ==", "bodyText": "maybe rename to isTableNotExistsError", "url": "https://github.com/apache/hive/pull/1688#discussion_r530284495", "createdAt": "2020-11-25T10:58:12Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/DatabaseProduct.java", "diffHunk": "@@ -186,6 +186,19 @@ public boolean isDeadlock(SQLException e) {\n             || e.getMessage().contains(\"can't serialize access for this transaction\"))));\n   }\n \n+  /**\n+   * Is the given exception a table not found exception\n+   * @param e Exception\n+   * @return\n+   */\n+  public boolean isTableNotExists(SQLException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1220f0210ee0b669728e8976b8e2f8293463b5ea"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2be472755fe31521147f56206f3c0adc7002e0f2", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/2be472755fe31521147f56206f3c0adc7002e0f2", "committedDate": "2020-12-02T13:39:47Z", "message": "Merge remote-tracking branch 'origin/master' into HIVE-24403-min_history_rollback\n\n# Conflicts:\n#\tstandalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnStore.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a18b24af8518ac1daae894045076a4c8ea3ebf1", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/1a18b24af8518ac1daae894045076a4c8ea3ebf1", "committedDate": "2020-12-02T18:27:33Z", "message": "address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODI5NDE1", "url": "https://github.com/apache/hive/pull/1688#pullrequestreview-543829415", "createdAt": "2020-12-03T10:49:20Z", "commit": {"oid": "1a18b24af8518ac1daae894045076a4c8ea3ebf1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3057, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}