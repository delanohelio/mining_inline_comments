{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5Njg5MjY2", "number": 1778, "title": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4", "bodyText": "What changes were proposed in this pull request?\nUpgrade netty3 to netty4 in Shuffle Handler.\nWhy are the changes needed?\nNetty3 is EOL since 2016.\nDoes this PR introduce any user-facing change?\nNo.\nHow was this patch tested?\nTested on cluster, microstrategy workload 100/100 queries passed.", "createdAt": "2020-12-14T17:40:14Z", "url": "https://github.com/apache/hive/pull/1778", "merged": true, "mergeCommit": {"oid": "cc3f4d1d3b766f444606a4b06341eb8c4ae8148c"}, "closed": true, "closedAt": "2021-04-21T08:13:17Z", "author": {"login": "abstractdog"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmWeLhABqjQxMTM0MTA2ODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeO6iPGgBqjQ2MTgwNTYyODU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fabc14d86baefa8ffbd7443adc1836af4ccc05f2", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/fabc14d86baefa8ffbd7443adc1836af4ccc05f2", "committedDate": "2020-12-14T16:41:03Z", "message": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4"}, "afterCommit": {"oid": "ebd431dda6699868001093b9ce64577ede38a43b", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/ebd431dda6699868001093b9ce64577ede38a43b", "committedDate": "2020-12-15T08:56:57Z", "message": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ebd431dda6699868001093b9ce64577ede38a43b", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/ebd431dda6699868001093b9ce64577ede38a43b", "committedDate": "2020-12-15T08:56:57Z", "message": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4"}, "afterCommit": {"oid": "827af5537d62585e913c612817f9a26b4edb6b2f", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/827af5537d62585e913c612817f9a26b4edb6b2f", "committedDate": "2021-01-06T09:43:29Z", "message": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "827af5537d62585e913c612817f9a26b4edb6b2f", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/827af5537d62585e913c612817f9a26b4edb6b2f", "committedDate": "2021-01-06T09:43:29Z", "message": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4"}, "afterCommit": {"oid": "e42d37515b1a2e4a1cd622f84200660a11fc3699", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/e42d37515b1a2e4a1cd622f84200660a11fc3699", "committedDate": "2021-04-10T06:49:01Z", "message": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e42d37515b1a2e4a1cd622f84200660a11fc3699", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/e42d37515b1a2e4a1cd622f84200660a11fc3699", "committedDate": "2021-04-10T06:49:01Z", "message": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4"}, "afterCommit": {"oid": "d9cb128e349d0d18bfc9ab686d720d611797b1ae", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/d9cb128e349d0d18bfc9ab686d720d611797b1ae", "committedDate": "2021-04-11T11:09:25Z", "message": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9cb128e349d0d18bfc9ab686d720d611797b1ae", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/d9cb128e349d0d18bfc9ab686d720d611797b1ae", "committedDate": "2021-04-11T11:09:25Z", "message": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4"}, "afterCommit": {"oid": "78ad65f2dd2cea1ee3bb06b0b3d27a2a6cebecd7", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/78ad65f2dd2cea1ee3bb06b0b3d27a2a6cebecd7", "committedDate": "2021-04-13T03:54:38Z", "message": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjM0MzgwMzg4", "url": "https://github.com/apache/hive/pull/1778#pullrequestreview-634380388", "createdAt": "2021-04-13T09:35:18Z", "commit": {"oid": "78ad65f2dd2cea1ee3bb06b0b3d27a2a6cebecd7"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0xM1QwOTozNToxOFrOJH7M4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0xM1QxMDowMjowMFrOJH8UwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjI4OTc2Mg==", "bodyText": "Shall we simplify this to:\ntransferred = true;\nif (this.shuffleTransferToAllowed) {\n      return super.transferTo(target, position);\n}\nreturn  customShuffleTransfer(target, position);", "url": "https://github.com/apache/hive/pull/1778#discussion_r612289762", "createdAt": "2021-04-13T09:35:18Z", "author": {"login": "pgaref"}, "path": "llap-server/src/java/org/apache/hadoop/hive/llap/shufflehandler/FadvisedFileRegion.java", "diffHunk": "@@ -71,15 +72,39 @@ public long transferTo(WritableByteChannel target, long position)\n       throws IOException {\n     if (manageOsCache && readaheadPool != null) {\n       readaheadRequest = readaheadPool.readaheadStream(identifier, fd,\n-          getPosition() + position, readaheadLength,\n-          getPosition() + getCount(), readaheadRequest);\n+          position() + position, readaheadLength,\n+          position() + count(), readaheadRequest);\n     }\n-    \n+    long written = 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ad65f2dd2cea1ee3bb06b0b3d27a2a6cebecd7"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjI5MjU4Mw==", "bodyText": "Shall we keep the original log message for advancing the file descriptor as well here?\nWhy do we need the extra fd.valid check here? (maybe leave a comment?)", "url": "https://github.com/apache/hive/pull/1778#discussion_r612292583", "createdAt": "2021-04-13T09:39:14Z", "author": {"login": "pgaref"}, "path": "llap-server/src/java/org/apache/hadoop/hive/llap/shufflehandler/FadvisedFileRegion.java", "diffHunk": "@@ -124,39 +149,33 @@ long customShuffleTransfer(WritableByteChannel target, long position)\n         position += trans; \n         trans = 0;\n       }\n-      \n+\n       //write data to the target\n       while(byteBuffer.hasRemaining()) {\n         target.write(byteBuffer);\n       }\n       \n       byteBuffer.clear();\n     }\n-    \n+\n     return actualCount - trans;\n   }\n \n-  \n-  @Override\n-  public void releaseExternalResources() {\n-    if (readaheadRequest != null) {\n-      readaheadRequest.cancel();\n-    }\n-    super.releaseExternalResources();\n-  }\n-  \n   /**\n    * Call when the transfer completes successfully so we can advise the OS that\n    * we don't need the region to be cached anymore.\n    */\n   public void transferSuccessful() {\n-    if (manageOsCache && getCount() > 0) {\n+    if (manageOsCache && count() > 0) {\n       try {\n         if (canEvictAfterTransfer) {\n-          LOG.debug(\"shuffleBufferSize: {}, path: {}\", shuffleBufferSize, identifier);\n-          NativeIO.POSIX.getCacheManipulator().posixFadviseIfPossible(identifier,\n-              fd, getPosition(), getCount(),\n-              NativeIO.POSIX.POSIX_FADV_DONTNEED);\n+          if (fd.valid()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ad65f2dd2cea1ee3bb06b0b3d27a2a6cebecd7"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjMwMDk4MA==", "bodyText": "I know this is copy pasted from below but do we have a ticket for this?\nIs it still needed?", "url": "https://github.com/apache/hive/pull/1778#discussion_r612300980", "createdAt": "2021-04-13T09:51:24Z", "author": {"login": "pgaref"}, "path": "llap-server/src/java/org/apache/hadoop/hive/llap/shufflehandler/ShuffleHandler.java", "diffHunk": "@@ -339,27 +350,60 @@ private ShuffleHandler(Configuration conf) {\n \n \n   public void start() throws Exception {\n-    ServerBootstrap bootstrap = new ServerBootstrap(selector);\n-    // Timer is shared across entire factory and must be released separately\n-    timer = new HashedWheelTimer();\n-    try {\n-      pipelineFact = new HttpPipelineFactory(conf, timer);\n-    } catch (Exception ex) {\n-      throw new RuntimeException(ex);\n-    }\n-    bootstrap.setPipelineFactory(pipelineFact);\n-    bootstrap.setOption(\"backlog\", NetUtil.SOMAXCONN);\n+    ServerBootstrap bootstrap = new ServerBootstrap()\n+        .channel(NioServerSocketChannel.class)\n+        .group(bossGroup, workerGroup)\n+        .localAddress(port)\n+        .option(ChannelOption.SO_BACKLOG, NetUtil.SOMAXCONN)\n+        .childOption(ChannelOption.SO_KEEPALIVE, true);\n+    initPipeline(bootstrap, conf);\n+\n     port = conf.getInt(SHUFFLE_PORT_CONFIG_KEY, DEFAULT_SHUFFLE_PORT);\n-    Channel ch = bootstrap.bind(new InetSocketAddress(port));\n+    Channel ch = bootstrap.bind().sync().channel();\n     accepted.add(ch);\n-    port = ((InetSocketAddress)ch.getLocalAddress()).getPort();\n+    port = ((InetSocketAddress)ch.localAddress()).getPort();\n     conf.set(SHUFFLE_PORT_CONFIG_KEY, Integer.toString(port));\n-    pipelineFact.SHUFFLE.setPort(port);\n+    SHUFFLE.setPort(port);\n     if (dirWatcher != null) {\n       dirWatcher.start();\n     }\n-    LOG.info(\"LlapShuffleHandler\" + \" listening on port \" + port + \" (SOMAXCONN: \" + bootstrap.getOption(\"backlog\")\n-      + \")\");\n+    LOG.info(\"LlapShuffleHandler listening on port {} (SOMAXCONN: {})\", port, NetUtil.SOMAXCONN);\n+  }\n+\n+  private void initPipeline(ServerBootstrap bootstrap, Configuration conf) throws Exception {\n+    SHUFFLE = getShuffle(conf);\n+    // TODO Setup SSL Shuffle", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ad65f2dd2cea1ee3bb06b0b3d27a2a6cebecd7"}, "originalPosition": 259}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjMwNTY4Ng==", "bodyText": "Why is this need now? How was connection kept alive before ?", "url": "https://github.com/apache/hive/pull/1778#discussion_r612305686", "createdAt": "2021-04-13T09:58:14Z", "author": {"login": "pgaref"}, "path": "llap-server/src/java/org/apache/hadoop/hive/llap/shufflehandler/ShuffleHandler.java", "diffHunk": "@@ -797,16 +803,17 @@ public void messageReceived(ChannelHandlerContext ctx, MessageEvent evt)\n \n       Map<String, MapOutputInfo> mapOutputInfoMap =\n           new HashMap<String, MapOutputInfo>();\n-      Channel ch = evt.getChannel();\n-\n+      Channel ch = ctx.channel();\n       // In case of KeepAlive, ensure that timeout handler does not close connection until entire\n       // response is written (i.e, response headers + mapOutput).\n-      ChannelPipeline pipeline = ch.getPipeline();\n+      ChannelPipeline pipeline = ch.pipeline();\n       TimeoutHandler timeoutHandler = (TimeoutHandler)pipeline.get(TIMEOUT_HANDLER);\n       timeoutHandler.setEnabledTimeout(false);\n \n       String user = userRsrc.get(jobId);\n-\n+      if (keepAliveParam || connectionKeepAliveEnabled){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ad65f2dd2cea1ee3bb06b0b3d27a2a6cebecd7"}, "originalPosition": 494}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxMjMwODE2MQ==", "bodyText": "This looks much cleaner with deallocate() call replacing completion Listeners", "url": "https://github.com/apache/hive/pull/1778#discussion_r612308161", "createdAt": "2021-04-13T10:02:00Z", "author": {"login": "pgaref"}, "path": "llap-server/src/java/org/apache/hadoop/hive/llap/shufflehandler/ShuffleHandler.java", "diffHunk": "@@ -1031,25 +1038,14 @@ protected ChannelFuture sendMapOutput(ChannelHandlerContext ctx, Channel ch,\n             info.getStartOffset(), info.getPartLength(), manageOsCache, readaheadLength,\n             readaheadPool, spillfile.getAbsolutePath(), \n             shuffleBufferSize, shuffleTransferToAllowed, canEvictAfterTransfer);\n-        writeFuture = ch.write(partition);\n-        writeFuture.addListener(new ChannelFutureListener() {\n-            // TODO error handling; distinguish IO/connection failures,\n-            //      attribute to appropriate spill output\n-          @Override\n-          public void operationComplete(ChannelFuture future) {\n-            if (future.isSuccess()) {\n-              partition.transferSuccessful();\n-            }\n-            partition.releaseExternalResources();\n-          }\n-        });\n+        writeFuture = ch.writeAndFlush(partition);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78ad65f2dd2cea1ee3bb06b0b3d27a2a6cebecd7"}, "originalPosition": 552}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "78ad65f2dd2cea1ee3bb06b0b3d27a2a6cebecd7", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/78ad65f2dd2cea1ee3bb06b0b3d27a2a6cebecd7", "committedDate": "2021-04-13T03:54:38Z", "message": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4"}, "afterCommit": {"oid": "a9eebcbbec26d22d6179f79a53860116ebb1616e", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/a9eebcbbec26d22d6179f79a53860116ebb1616e", "committedDate": "2021-04-14T08:14:01Z", "message": "cleanup netty3 from pom hieararchy where possible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d26933d306bf9a18f244be37fbfe78dba406294a", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/d26933d306bf9a18f244be37fbfe78dba406294a", "committedDate": "2021-04-14T13:43:10Z", "message": "HIVE-24524: LLAP ShuffleHandler: upgrade to netty4"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9eebcbbec26d22d6179f79a53860116ebb1616e", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/a9eebcbbec26d22d6179f79a53860116ebb1616e", "committedDate": "2021-04-14T08:14:01Z", "message": "cleanup netty3 from pom hieararchy where possible"}, "afterCommit": {"oid": "3e99fa3aae9b4779e8cbc4255eaaa51e05dd5597", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/3e99fa3aae9b4779e8cbc4255eaaa51e05dd5597", "committedDate": "2021-04-14T13:43:10Z", "message": "cleanup netty3 from pom hieararchy where possible"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "155c62ff83738decc140a89a5744b53b1f41c0f7", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/155c62ff83738decc140a89a5744b53b1f41c0f7", "committedDate": "2021-04-18T06:49:28Z", "message": "finished http message"}, "afterCommit": {"oid": "fecb6c67f067e88e76d1d48be7358d9db4a76173", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/fecb6c67f067e88e76d1d48be7358d9db4a76173", "committedDate": "2021-04-18T20:34:34Z", "message": "finished http message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d064c8fe61316605a5293a80a2b06a808adf661", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/2d064c8fe61316605a5293a80a2b06a808adf661", "committedDate": "2021-04-19T17:06:29Z", "message": "cleanup netty3 from pom hieararchy where possible"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fecb6c67f067e88e76d1d48be7358d9db4a76173", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/fecb6c67f067e88e76d1d48be7358d9db4a76173", "committedDate": "2021-04-18T20:34:34Z", "message": "finished http message"}, "afterCommit": {"oid": "17e05075e490aa0d73fd31ddd0c54335d64bb343", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/17e05075e490aa0d73fd31ddd0c54335d64bb343", "committedDate": "2021-04-19T17:06:30Z", "message": "finished http message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea58cd9ba08bf592de7b4753198ece6df4624816", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/ea58cd9ba08bf592de7b4753198ece6df4624816", "committedDate": "2021-04-20T09:34:57Z", "message": "finished http message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17e05075e490aa0d73fd31ddd0c54335d64bb343", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/17e05075e490aa0d73fd31ddd0c54335d64bb343", "committedDate": "2021-04-19T17:06:30Z", "message": "finished http message"}, "afterCommit": {"oid": "ea58cd9ba08bf592de7b4753198ece6df4624816", "author": {"user": {"login": "abstractdog", "name": "Bodor Laszlo"}}, "url": "https://github.com/apache/hive/commit/ea58cd9ba08bf592de7b4753198ece6df4624816", "committedDate": "2021-04-20T09:34:57Z", "message": "finished http message"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2917, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}