{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyNTIxMjMz", "number": 1525, "title": "HIVE-24199: Incorrect result when subquey in exists contains limit", "bodyText": "What changes were proposed in this pull request?\n\nFix incorrect result when subquey in exists contains limit.\nError when query has a subquery with offset\n\nWhy are the changes needed?\n\nFix correctness issue\n\ncreate table web_sales (ws_order_number int, ws_warehouse_sk int) stored as orc;\n\ninsert into web_sales values\n(1, 1),\n(1, 2),\n(2, 1),\n(2, 2);\n\nQuery\nselect * from web_sales ws1\nwhere exists (select 1 from web_sales ws2 where ws1.ws_order_number = ws2.ws_order_number limit 1);\n\nshould return 4 rows but returns only 2.\n\nCorrectness can not be guaranteed if subquery has offset.\n\nDoes this PR introduce any user-facing change?\nSemantic exception is thrown when user tries to execute a query which has a subquery with offset.\nSee offset_in_subquery.q\nHow was this patch tested?\nmvn test -DskipSparkTests -Dtest=TestMiniLlapLocalCliDriver -Dqfile=subquery_join_rewrite.q -pl itests/qtest -Pitests -Dtest.output.overwrite\nmvn test -DskipSparkTests -Dtest=TestNegativeCliDriver -Dqfile=offset_in_subquery.q -pl itests/qtest -Pitests -Dtest.output.overwrite", "createdAt": "2020-09-24T15:17:23Z", "url": "https://github.com/apache/hive/pull/1525", "merged": true, "mergeCommit": {"oid": "e1867bf85063fc61150b1b1405984419b98262ea"}, "closed": true, "closedAt": "2020-10-07T17:14:59Z", "author": {"login": "kasakrisz"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNkh83gBqjM4MTgzOTMxNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQQKjhAFqTUwNDA5NTAzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd56523acd37a91ab4c32705e56d02591f62c0f4", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/cd56523acd37a91ab4c32705e56d02591f62c0f4", "committedDate": "2020-09-24T15:10:31Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit"}, "afterCommit": {"oid": "faaa9442620001db8d5623fa4d396ca96b8bb103", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/faaa9442620001db8d5623fa4d396ca96b8bb103", "committedDate": "2020-09-29T08:35:46Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "faaa9442620001db8d5623fa4d396ca96b8bb103", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/faaa9442620001db8d5623fa4d396ca96b8bb103", "committedDate": "2020-09-29T08:35:46Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit"}, "afterCommit": {"oid": "eb4499dd816a7151be5e48014885e2445e434e30", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/eb4499dd816a7151be5e48014885e2445e434e30", "committedDate": "2020-09-29T09:13:21Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb4499dd816a7151be5e48014885e2445e434e30", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/eb4499dd816a7151be5e48014885e2445e434e30", "committedDate": "2020-09-29T09:13:21Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit"}, "afterCommit": {"oid": "7c3da644d4364689dafe0846bd0f1b84e781431a", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/7c3da644d4364689dafe0846bd0f1b84e781431a", "committedDate": "2020-09-30T13:20:36Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c3da644d4364689dafe0846bd0f1b84e781431a", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/7c3da644d4364689dafe0846bd0f1b84e781431a", "committedDate": "2020-09-30T13:20:36Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit"}, "afterCommit": {"oid": "7314db32eab015e41e008d49cf5fb0124e4e8521", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/7314db32eab015e41e008d49cf5fb0124e4e8521", "committedDate": "2020-10-01T08:47:50Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7314db32eab015e41e008d49cf5fb0124e4e8521", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/7314db32eab015e41e008d49cf5fb0124e4e8521", "committedDate": "2020-10-01T08:47:50Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit"}, "afterCommit": {"oid": "9f2eeeaab340374b899d8028b8d4198b1437aa09", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/9f2eeeaab340374b899d8028b8d4198b1437aa09", "committedDate": "2020-10-02T10:48:02Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNDM4Nzcy", "url": "https://github.com/apache/hive/pull/1525#pullrequestreview-503438772", "createdAt": "2020-10-07T00:00:18Z", "commit": {"oid": "9f2eeeaab340374b899d8028b8d4198b1437aa09"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMDowMDoxOFrOHdd9BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMDowMDoxOFrOHdd9BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY2MTUwOA==", "bodyText": "Can you add a comment to explain/mention why limit is being removed for correlated EXISTs?", "url": "https://github.com/apache/hive/pull/1525#discussion_r500661508", "createdAt": "2020-10-07T00:00:18Z", "author": {"login": "vineetgarg02"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/HiveSubQueryRemoveRule.java", "diffHunk": "@@ -406,6 +409,16 @@ private RexNode rewriteInExists(RexSubQuery e, Set<CorrelationId> variablesSet,\n         offset = offset + 1;\n         builder.push(e.rel);\n       }\n+    } else if (e.getKind() == SqlKind.EXISTS && !variablesSet.isEmpty()) {\n+      // Query has 'exists' and correlation:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9f2eeeaab340374b899d8028b8d4198b1437aa09"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62378f64be71521d4c24a8cf753018021b016f1b", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/62378f64be71521d4c24a8cf753018021b016f1b", "committedDate": "2020-10-07T05:27:08Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21dc1d5541407f0aeff8fb45e266a46c70a4dea8", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/21dc1d5541407f0aeff8fb45e266a46c70a4dea8", "committedDate": "2020-10-07T05:42:58Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit - add comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9f2eeeaab340374b899d8028b8d4198b1437aa09", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/9f2eeeaab340374b899d8028b8d4198b1437aa09", "committedDate": "2020-10-02T10:48:02Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit"}, "afterCommit": {"oid": "21dc1d5541407f0aeff8fb45e266a46c70a4dea8", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/21dc1d5541407f0aeff8fb45e266a46c70a4dea8", "committedDate": "2020-10-07T05:42:58Z", "message": "HIVE-24199: Incorrect result when subquey in exists contains limit - add comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MDk1MDMy", "url": "https://github.com/apache/hive/pull/1525#pullrequestreview-504095032", "createdAt": "2020-10-07T17:10:03Z", "commit": {"oid": "21dc1d5541407f0aeff8fb45e266a46c70a4dea8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3099, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}