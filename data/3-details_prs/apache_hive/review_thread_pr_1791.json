{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNDg2OTYy", "number": 1791, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxNzo0MTo1MFrOFLYEHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0wOVQxODowMzoyOFrOFjk6dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NDcyOTI3OnYy", "diffSide": "RIGHT", "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxNzo0MTo1MFrOIOg0Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMjoyNDowMFrOIOpwZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA4ODYyNg==", "bodyText": "nit: SAML2 should be SAML to match the value in the set", "url": "https://github.com/apache/hive/pull/1791#discussion_r552088626", "createdAt": "2021-01-05T17:41:50Z", "author": {"login": "nrg4878"}, "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "diffHunk": "@@ -3871,15 +3870,16 @@ private static void populateLlapDaemonVarsSet(Set<String> llapDaemonVarsSetLocal\n \n     // HiveServer2 auth configuration\n     HIVE_SERVER2_AUTHENTICATION(\"hive.server2.authentication\", \"NONE\",\n-      new StringSet(\"NOSASL\", \"NONE\", \"LDAP\", \"KERBEROS\", \"PAM\", \"CUSTOM\"),\n+      new StringSet(\"NOSASL\", \"NONE\", \"LDAP\", \"KERBEROS\", \"PAM\", \"CUSTOM\", \"SAML\"),\n         \"Client authentication types.\\n\" +\n         \"  NONE: no authentication check\\n\" +\n         \"  LDAP: LDAP/AD based authentication\\n\" +\n         \"  KERBEROS: Kerberos/GSSAPI authentication\\n\" +\n         \"  CUSTOM: Custom authentication provider\\n\" +\n         \"          (Use with property hive.server2.custom.authentication.class)\\n\" +\n         \"  PAM: Pluggable authentication module\\n\" +\n-        \"  NOSASL:  Raw transport\"),\n+        \"  NOSASL:  Raw transport\\n\" +\n+        \"  SAML2: SAML 2.0 compliant authentication. This is only supported in http transport mode.\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIzNTEwOA==", "bodyText": "Fixed", "url": "https://github.com/apache/hive/pull/1791#discussion_r552235108", "createdAt": "2021-01-05T22:24:00Z", "author": {"login": "vihangk1"}, "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "diffHunk": "@@ -3871,15 +3870,16 @@ private static void populateLlapDaemonVarsSet(Set<String> llapDaemonVarsSetLocal\n \n     // HiveServer2 auth configuration\n     HIVE_SERVER2_AUTHENTICATION(\"hive.server2.authentication\", \"NONE\",\n-      new StringSet(\"NOSASL\", \"NONE\", \"LDAP\", \"KERBEROS\", \"PAM\", \"CUSTOM\"),\n+      new StringSet(\"NOSASL\", \"NONE\", \"LDAP\", \"KERBEROS\", \"PAM\", \"CUSTOM\", \"SAML\"),\n         \"Client authentication types.\\n\" +\n         \"  NONE: no authentication check\\n\" +\n         \"  LDAP: LDAP/AD based authentication\\n\" +\n         \"  KERBEROS: Kerberos/GSSAPI authentication\\n\" +\n         \"  CUSTOM: Custom authentication provider\\n\" +\n         \"          (Use with property hive.server2.custom.authentication.class)\\n\" +\n         \"  PAM: Pluggable authentication module\\n\" +\n-        \"  NOSASL:  Raw transport\"),\n+        \"  NOSASL:  Raw transport\\n\" +\n+        \"  SAML2: SAML 2.0 compliant authentication. This is only supported in http transport mode.\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA4ODYyNg=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NDgwNDE3OnYy", "diffSide": "RIGHT", "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODowMjo0OVrOIOhiog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMjo0OToyOVrOIOqZ7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwMDUxNA==", "bodyText": "TODO item", "url": "https://github.com/apache/hive/pull/1791#discussion_r552100514", "createdAt": "2021-01-05T18:02:49Z", "author": {"login": "nrg4878"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -301,10 +326,20 @@ public HiveConnection(String uri, Properties info) throws SQLException {\n     supportedProtocols.add(TProtocolVersion.HIVE_CLI_SERVICE_PROTOCOL_V9);\n     supportedProtocols.add(TProtocolVersion.HIVE_CLI_SERVICE_PROTOCOL_V10);\n \n+    if (isBrowserAuthMode()) {\n+      try {\n+        browserClient = browserClientFactory.create(connParams);\n+      } catch (HiveJdbcBrowserException e) {\n+        throw new SQLException(\"\");\n+      }\n+    } else {\n+      browserClient = null;\n+    }\n     if (isEmbeddedMode) {\n       client = EmbeddedCLIServicePortal.get(connParams.getHiveConfs());\n       connParams.getHiveConfs().clear();\n       // open client session\n+      // TODO(Vihang) need to throw here if saml auth?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI0NTc0Mg==", "bodyText": "Done", "url": "https://github.com/apache/hive/pull/1791#discussion_r552245742", "createdAt": "2021-01-05T22:49:29Z", "author": {"login": "vihangk1"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -301,10 +326,20 @@ public HiveConnection(String uri, Properties info) throws SQLException {\n     supportedProtocols.add(TProtocolVersion.HIVE_CLI_SERVICE_PROTOCOL_V9);\n     supportedProtocols.add(TProtocolVersion.HIVE_CLI_SERVICE_PROTOCOL_V10);\n \n+    if (isBrowserAuthMode()) {\n+      try {\n+        browserClient = browserClientFactory.create(connParams);\n+      } catch (HiveJdbcBrowserException e) {\n+        throw new SQLException(\"\");\n+      }\n+    } else {\n+      browserClient = null;\n+    }\n     if (isEmbeddedMode) {\n       client = EmbeddedCLIServicePortal.get(connParams.getHiveConfs());\n       connParams.getHiveConfs().clear();\n       // open client session\n+      // TODO(Vihang) need to throw here if saml auth?", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwMDUxNA=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NDgxOTQ4OnYy", "diffSide": "RIGHT", "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODowNzoyNVrOIOhsMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMjo1Mjo0MFrOIOqebQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwMjk2MQ==", "bodyText": "I understand why this is done but feels odd that this throws a SQLException. Can we throw something else here and then wrap it in a SQLException in the calling method? Even a TTransportException would make sense over SQLException (though it is not thrown from thrift).", "url": "https://github.com/apache/hive/pull/1791#discussion_r552102961", "createdAt": "2021-01-05T18:07:25Z", "author": {"login": "nrg4878"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -476,12 +511,18 @@ private String getServerHttpUrl(boolean useSsl) {\n   private TTransport createHttpTransport() throws SQLException, TTransportException {\n     CloseableHttpClient httpClient;\n     boolean useSsl = isSslConnection();\n-    // Create an http client from the configs\n+    validateSslForBrowserMode();\n     httpClient = getHttpClient(useSsl);\n     transport = new THttpClient(getServerHttpUrl(useSsl), httpClient);\n     return transport;\n   }\n \n+  protected void validateSslForBrowserMode() throws SQLException {\n+    if (isBrowserAuthMode() && !isSslConnection()) {\n+      throw new SQLException(\"Browser mode is only supported with SSL is enabled\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI0Njg5Mw==", "bodyText": "I updated the code to throw a new SQLException(new IllegalArgumentException()) here. However, I don't see what is the real benefit of doing this way since the constructor of HiveConnection only allows for SQLException to be thrown.", "url": "https://github.com/apache/hive/pull/1791#discussion_r552246893", "createdAt": "2021-01-05T22:52:40Z", "author": {"login": "vihangk1"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -476,12 +511,18 @@ private String getServerHttpUrl(boolean useSsl) {\n   private TTransport createHttpTransport() throws SQLException, TTransportException {\n     CloseableHttpClient httpClient;\n     boolean useSsl = isSslConnection();\n-    // Create an http client from the configs\n+    validateSslForBrowserMode();\n     httpClient = getHttpClient(useSsl);\n     transport = new THttpClient(getServerHttpUrl(useSsl), httpClient);\n     return transport;\n   }\n \n+  protected void validateSslForBrowserMode() throws SQLException {\n+    if (isBrowserAuthMode() && !isSslConnection()) {\n+      throw new SQLException(\"Browser mode is only supported with SSL is enabled\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwMjk2MQ=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NDgzMDI5OnYy", "diffSide": "RIGHT", "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODoxMDoyN1rOIOhyuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwMDoxMjozNFrOIOsSag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwNDYzMg==", "bodyText": "wouldn't httpClientBuilder be null if cookieAuth is disabled? We could use http transport with cookieAuth disabled right?", "url": "https://github.com/apache/hive/pull/1791#discussion_r552104632", "createdAt": "2021-01-05T18:10:27Z", "author": {"login": "nrg4878"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -592,6 +638,10 @@ public boolean retryRequest(IOException exception, int executionCount, HttpConte\n       }\n     });\n \n+    if (isBrowserAuthMode()) {\n+      httpClientBuilder", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI0Nzg0MQ==", "bodyText": "I am not sure if you are reviewing this one commit at a time or by combining all the commits. line 626 on the latest code in this branch creates a httpClientBuilder if the cookieAuth is disabled.", "url": "https://github.com/apache/hive/pull/1791#discussion_r552247841", "createdAt": "2021-01-05T22:55:04Z", "author": {"login": "vihangk1"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -592,6 +638,10 @@ public boolean retryRequest(IOException exception, int executionCount, HttpConte\n       }\n     });\n \n+    if (isBrowserAuthMode()) {\n+      httpClientBuilder", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwNDYzMg=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI3NjU4Ng==", "bodyText": "This is however a good point. Having browser mode without cookie auth doesn't make sense. Since without cookie auth, each http call will open a browser (althought it will be automatically authenticated). I think for the first version may be we should disallow browser auth if cookie-auth is not enabled on the server side. Thoughts?", "url": "https://github.com/apache/hive/pull/1791#discussion_r552276586", "createdAt": "2021-01-06T00:12:34Z", "author": {"login": "vihangk1"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -592,6 +638,10 @@ public boolean retryRequest(IOException exception, int executionCount, HttpConte\n       }\n     });\n \n+    if (isBrowserAuthMode()) {\n+      httpClientBuilder", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwNDYzMg=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 140}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NDgzMjU5OnYy", "diffSide": "RIGHT", "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODoxMToxNVrOIOh0Uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMjo1NTo1NVrOIOqjgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwNTA0Mw==", "bodyText": "TODO: If nothing to do, should we remove your name from the comment?", "url": "https://github.com/apache/hive/pull/1791#discussion_r552105043", "createdAt": "2021-01-05T18:11:15Z", "author": {"login": "nrg4878"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -896,39 +946,103 @@ private void openSession() throws SQLException {\n       openReq.setPassword(sessConfMap.get(JdbcConnectionParams.AUTH_PASSWD));\n     }\n \n+    //TODO(Vihang): This is a bit hacky. We piggy back on a dummy OpenSession call", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 150}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI0ODE5Mg==", "bodyText": "yeah, sorry. I removed my name. I had it to track all the todos.", "url": "https://github.com/apache/hive/pull/1791#discussion_r552248192", "createdAt": "2021-01-05T22:55:55Z", "author": {"login": "vihangk1"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -896,39 +946,103 @@ private void openSession() throws SQLException {\n       openReq.setPassword(sessConfMap.get(JdbcConnectionParams.AUTH_PASSWD));\n     }\n \n+    //TODO(Vihang): This is a bit hacky. We piggy back on a dummy OpenSession call", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjEwNTA0Mw=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 150}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NDg2NTg5OnYy", "diffSide": "RIGHT", "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODoyMDowM1rOIOiJHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzoxNjoxMVrOIOq_XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExMDM2NA==", "bodyText": "is this a known error code for failed auth?", "url": "https://github.com/apache/hive/pull/1791#discussion_r552110364", "createdAt": "2021-01-05T18:20:03Z", "author": {"login": "nrg4878"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -896,39 +946,103 @@ private void openSession() throws SQLException {\n       openReq.setPassword(sessConfMap.get(JdbcConnectionParams.AUTH_PASSWD));\n     }\n \n+    //TODO(Vihang): This is a bit hacky. We piggy back on a dummy OpenSession call\n+    // to get the redirect response from the server. Instead its probably cleaner to\n+    // explicitly do a HTTP post request and get the response.\n+    int numRetry = isBrowserAuthMode() ? 2 : 1;\n+    for (int i=0; i<numRetry; i++) {\n+      try {\n+        openSession(openReq);\n+      } catch (TException e) {\n+        if (isSamlRedirect(e)) {\n+          boolean success = doBrowserSSO();\n+          if (!success) {\n+            String msg = browserClient.getServerResponse() == null\n+                || browserClient.getServerResponse().getMsg() == null ? \"\"\n+                : browserClient.getServerResponse().getMsg();\n+            throw new SQLException(\n+                \"Could not establish connection to \" + jdbcUriString + \": \"\n+                    + msg, \" 08S01\", e);\n+          }\n+        } else {\n+          throw new SQLException(\n+              \"Could not establish connection to \" + jdbcUriString + \": \" + e\n+                  .getMessage(), \" 08S01\", e);\n+        }\n+      }\n+    }\n+    isClosed = false;\n+  }\n+\n+  private boolean doBrowserSSO() throws SQLException {\n     try {\n-      TOpenSessionResp openResp = client.OpenSession(openReq);\n+      Preconditions.checkNotNull(browserClient);\n+      try (IJdbcBrowserClient bc = browserClient) {\n+        browserClient.doBrowserSSO();\n+        HiveJdbcBrowserServerResponse response = browserClient.getServerResponse();\n+        if (response != null) {\n+          return response.isSuccessful();\n+        }\n+        return false;\n+      }\n+    } catch (Exception ex) {\n+      throw new SQLException(\"Browser based SSO failed: \" + ex.getMessage(),\n+          \" 08S01\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 192}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI1NTMyNA==", "bodyText": "I could find where to look for these standard error codes. The closest hit online was the https://docs.microsoft.com/en-us/sql/odbc/reference/appendixes/appendix-a-odbc-error-codes?view=sql-server-ver15 which lists 08S01 as \"communications like failure\". I didn't see anything which suggests a authentication error. The closest was perhaps 28000 but I am not sure if this is the right place to look for these codes. Do you know where can I find this for JDBC?", "url": "https://github.com/apache/hive/pull/1791#discussion_r552255324", "createdAt": "2021-01-05T23:16:11Z", "author": {"login": "vihangk1"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -896,39 +946,103 @@ private void openSession() throws SQLException {\n       openReq.setPassword(sessConfMap.get(JdbcConnectionParams.AUTH_PASSWD));\n     }\n \n+    //TODO(Vihang): This is a bit hacky. We piggy back on a dummy OpenSession call\n+    // to get the redirect response from the server. Instead its probably cleaner to\n+    // explicitly do a HTTP post request and get the response.\n+    int numRetry = isBrowserAuthMode() ? 2 : 1;\n+    for (int i=0; i<numRetry; i++) {\n+      try {\n+        openSession(openReq);\n+      } catch (TException e) {\n+        if (isSamlRedirect(e)) {\n+          boolean success = doBrowserSSO();\n+          if (!success) {\n+            String msg = browserClient.getServerResponse() == null\n+                || browserClient.getServerResponse().getMsg() == null ? \"\"\n+                : browserClient.getServerResponse().getMsg();\n+            throw new SQLException(\n+                \"Could not establish connection to \" + jdbcUriString + \": \"\n+                    + msg, \" 08S01\", e);\n+          }\n+        } else {\n+          throw new SQLException(\n+              \"Could not establish connection to \" + jdbcUriString + \": \" + e\n+                  .getMessage(), \" 08S01\", e);\n+        }\n+      }\n+    }\n+    isClosed = false;\n+  }\n+\n+  private boolean doBrowserSSO() throws SQLException {\n     try {\n-      TOpenSessionResp openResp = client.OpenSession(openReq);\n+      Preconditions.checkNotNull(browserClient);\n+      try (IJdbcBrowserClient bc = browserClient) {\n+        browserClient.doBrowserSSO();\n+        HiveJdbcBrowserServerResponse response = browserClient.getServerResponse();\n+        if (response != null) {\n+          return response.isSuccessful();\n+        }\n+        return false;\n+      }\n+    } catch (Exception ex) {\n+      throw new SQLException(\"Browser based SSO failed: \" + ex.getMessage(),\n+          \" 08S01\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExMDM2NA=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 192}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NDg2ODc5OnYy", "diffSide": "RIGHT", "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxODoyMTowM1rOIOiK_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwMDowOToyNFrOIOsJvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExMDg0Ng==", "bodyText": "is 08S01 a known error code for failed auth with SAML?", "url": "https://github.com/apache/hive/pull/1791#discussion_r552110846", "createdAt": "2021-01-05T18:21:03Z", "author": {"login": "nrg4878"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -896,39 +946,103 @@ private void openSession() throws SQLException {\n       openReq.setPassword(sessConfMap.get(JdbcConnectionParams.AUTH_PASSWD));\n     }\n \n+    //TODO(Vihang): This is a bit hacky. We piggy back on a dummy OpenSession call\n+    // to get the redirect response from the server. Instead its probably cleaner to\n+    // explicitly do a HTTP post request and get the response.\n+    int numRetry = isBrowserAuthMode() ? 2 : 1;\n+    for (int i=0; i<numRetry; i++) {\n+      try {\n+        openSession(openReq);\n+      } catch (TException e) {\n+        if (isSamlRedirect(e)) {\n+          boolean success = doBrowserSSO();\n+          if (!success) {\n+            String msg = browserClient.getServerResponse() == null\n+                || browserClient.getServerResponse().getMsg() == null ? \"\"\n+                : browserClient.getServerResponse().getMsg();\n+            throw new SQLException(\n+                \"Could not establish connection to \" + jdbcUriString + \": \"\n+                    + msg, \" 08S01\", e);\n+          }\n+        } else {\n+          throw new SQLException(\n+              \"Could not establish connection to \" + jdbcUriString + \": \" + e\n+                  .getMessage(), \" 08S01\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI3NDM2Ng==", "bodyText": "08S01 stands for \"communications link failure\" which is not exactly what we want but arguably related to the authentication error. I can interpret it as \"User is not authenticated and hence communications link failed\". I would be happy to update this to a more specific error code if you know of a better one.", "url": "https://github.com/apache/hive/pull/1791#discussion_r552274366", "createdAt": "2021-01-06T00:09:24Z", "author": {"login": "vihangk1"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -896,39 +946,103 @@ private void openSession() throws SQLException {\n       openReq.setPassword(sessConfMap.get(JdbcConnectionParams.AUTH_PASSWD));\n     }\n \n+    //TODO(Vihang): This is a bit hacky. We piggy back on a dummy OpenSession call\n+    // to get the redirect response from the server. Instead its probably cleaner to\n+    // explicitly do a HTTP post request and get the response.\n+    int numRetry = isBrowserAuthMode() ? 2 : 1;\n+    for (int i=0; i<numRetry; i++) {\n+      try {\n+        openSession(openReq);\n+      } catch (TException e) {\n+        if (isSamlRedirect(e)) {\n+          boolean success = doBrowserSSO();\n+          if (!success) {\n+            String msg = browserClient.getServerResponse() == null\n+                || browserClient.getServerResponse().getMsg() == null ? \"\"\n+                : browserClient.getServerResponse().getMsg();\n+            throw new SQLException(\n+                \"Could not establish connection to \" + jdbcUriString + \": \"\n+                    + msg, \" 08S01\", e);\n+          }\n+        } else {\n+          throw new SQLException(\n+              \"Could not establish connection to \" + jdbcUriString + \": \" + e\n+                  .getMessage(), \" 08S01\", e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjExMDg0Ng=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 171}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NTA2NDk1OnYy", "diffSide": "RIGHT", "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxOToyMToyMVrOIOkEBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzoyNzo1M1rOIOrPYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE0MTgyOA==", "bodyText": "its not clear what the change is here. The proposed code looks similar to the existing code in the OpenSession() method. What has changed?", "url": "https://github.com/apache/hive/pull/1791#discussion_r552141828", "createdAt": "2021-01-05T19:21:21Z", "author": {"login": "nrg4878"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -896,39 +946,103 @@ private void openSession() throws SQLException {\n       openReq.setPassword(sessConfMap.get(JdbcConnectionParams.AUTH_PASSWD));\n     }\n \n+    //TODO(Vihang): This is a bit hacky. We piggy back on a dummy OpenSession call\n+    // to get the redirect response from the server. Instead its probably cleaner to\n+    // explicitly do a HTTP post request and get the response.\n+    int numRetry = isBrowserAuthMode() ? 2 : 1;\n+    for (int i=0; i<numRetry; i++) {\n+      try {\n+        openSession(openReq);\n+      } catch (TException e) {\n+        if (isSamlRedirect(e)) {\n+          boolean success = doBrowserSSO();\n+          if (!success) {\n+            String msg = browserClient.getServerResponse() == null\n+                || browserClient.getServerResponse().getMsg() == null ? \"\"\n+                : browserClient.getServerResponse().getMsg();\n+            throw new SQLException(\n+                \"Could not establish connection to \" + jdbcUriString + \": \"\n+                    + msg, \" 08S01\", e);\n+          }\n+        } else {\n+          throw new SQLException(\n+              \"Could not establish connection to \" + jdbcUriString + \": \" + e\n+                  .getMessage(), \" 08S01\", e);\n+        }\n+      }\n+    }\n+    isClosed = false;\n+  }\n+\n+  private boolean doBrowserSSO() throws SQLException {\n     try {\n-      TOpenSessionResp openResp = client.OpenSession(openReq);\n+      Preconditions.checkNotNull(browserClient);\n+      try (IJdbcBrowserClient bc = browserClient) {\n+        browserClient.doBrowserSSO();\n+        HiveJdbcBrowserServerResponse response = browserClient.getServerResponse();\n+        if (response != null) {\n+          return response.isSuccessful();\n+        }\n+        return false;\n+      }\n+    } catch (Exception ex) {\n+      throw new SQLException(\"Browser based SSO failed: \" + ex.getMessage(),\n+          \" 08S01\",\n+          ex);\n+    }\n+  }\n \n-      // Populate a given configuration from HS2 server HiveConf, only if that configuration\n-      // is not already present in Connection parameter HiveConf i.e., client side configuration\n-      // takes precedence over the server side configuration.\n-      Map<String, String> serverHiveConf = openResp.getConfiguration();\n+  @VisibleForTesting\n+  public IJdbcBrowserClient getBrowserClient() {\n+    return browserClient;\n+  }\n \n-      updateServerHiveConf(serverHiveConf, connParams);\n+  private void openSession(TOpenSessionReq openReq) throws TException, SQLException {\n+    TOpenSessionResp openResp = client.OpenSession(openReq);\n \n-      // validate connection\n-      Utils.verifySuccess(openResp.getStatus());\n-      if (!supportedProtocols.contains(openResp.getServerProtocolVersion())) {\n-        throw new TException(\"Unsupported Hive2 protocol\");\n-      }\n-      protocol = openResp.getServerProtocolVersion();\n-      sessHandle = openResp.getSessionHandle();\n-\n-      final String serverFetchSizeString =\n-          openResp.getConfiguration().get(ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.varname);\n-      if (serverFetchSizeString == null) {\n-        throw new IllegalStateException(\"Server returned a null default fetch size. Check that \"\n-            + ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.varname + \" is configured correctly.\");\n-      }\n+    // Populate a given configuration from HS2 server HiveConf, only if that configuration", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 224}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI1OTQyNQ==", "bodyText": "The patch moves these lines (900-926) before the patch into a separate method so that we can have a retry attempt of this code. The first attempt to get the redirect URL and the second one to actually open the session.", "url": "https://github.com/apache/hive/pull/1791#discussion_r552259425", "createdAt": "2021-01-05T23:27:53Z", "author": {"login": "vihangk1"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -896,39 +946,103 @@ private void openSession() throws SQLException {\n       openReq.setPassword(sessConfMap.get(JdbcConnectionParams.AUTH_PASSWD));\n     }\n \n+    //TODO(Vihang): This is a bit hacky. We piggy back on a dummy OpenSession call\n+    // to get the redirect response from the server. Instead its probably cleaner to\n+    // explicitly do a HTTP post request and get the response.\n+    int numRetry = isBrowserAuthMode() ? 2 : 1;\n+    for (int i=0; i<numRetry; i++) {\n+      try {\n+        openSession(openReq);\n+      } catch (TException e) {\n+        if (isSamlRedirect(e)) {\n+          boolean success = doBrowserSSO();\n+          if (!success) {\n+            String msg = browserClient.getServerResponse() == null\n+                || browserClient.getServerResponse().getMsg() == null ? \"\"\n+                : browserClient.getServerResponse().getMsg();\n+            throw new SQLException(\n+                \"Could not establish connection to \" + jdbcUriString + \": \"\n+                    + msg, \" 08S01\", e);\n+          }\n+        } else {\n+          throw new SQLException(\n+              \"Could not establish connection to \" + jdbcUriString + \": \" + e\n+                  .getMessage(), \" 08S01\", e);\n+        }\n+      }\n+    }\n+    isClosed = false;\n+  }\n+\n+  private boolean doBrowserSSO() throws SQLException {\n     try {\n-      TOpenSessionResp openResp = client.OpenSession(openReq);\n+      Preconditions.checkNotNull(browserClient);\n+      try (IJdbcBrowserClient bc = browserClient) {\n+        browserClient.doBrowserSSO();\n+        HiveJdbcBrowserServerResponse response = browserClient.getServerResponse();\n+        if (response != null) {\n+          return response.isSuccessful();\n+        }\n+        return false;\n+      }\n+    } catch (Exception ex) {\n+      throw new SQLException(\"Browser based SSO failed: \" + ex.getMessage(),\n+          \" 08S01\",\n+          ex);\n+    }\n+  }\n \n-      // Populate a given configuration from HS2 server HiveConf, only if that configuration\n-      // is not already present in Connection parameter HiveConf i.e., client side configuration\n-      // takes precedence over the server side configuration.\n-      Map<String, String> serverHiveConf = openResp.getConfiguration();\n+  @VisibleForTesting\n+  public IJdbcBrowserClient getBrowserClient() {\n+    return browserClient;\n+  }\n \n-      updateServerHiveConf(serverHiveConf, connParams);\n+  private void openSession(TOpenSessionReq openReq) throws TException, SQLException {\n+    TOpenSessionResp openResp = client.OpenSession(openReq);\n \n-      // validate connection\n-      Utils.verifySuccess(openResp.getStatus());\n-      if (!supportedProtocols.contains(openResp.getServerProtocolVersion())) {\n-        throw new TException(\"Unsupported Hive2 protocol\");\n-      }\n-      protocol = openResp.getServerProtocolVersion();\n-      sessHandle = openResp.getSessionHandle();\n-\n-      final String serverFetchSizeString =\n-          openResp.getConfiguration().get(ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.varname);\n-      if (serverFetchSizeString == null) {\n-        throw new IllegalStateException(\"Server returned a null default fetch size. Check that \"\n-            + ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.varname + \" is configured correctly.\");\n-      }\n+    // Populate a given configuration from HS2 server HiveConf, only if that configuration", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE0MTgyOA=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 224}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NTExMjAwOnYy", "diffSide": "RIGHT", "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxOTozNDoxMlrOIOkgMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMzozMDoxOVrOIOrSgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE0OTA0MA==", "bodyText": "@vihangk1 Could you please add some comments to the method as to why we look for 302 and 303 in the error message. This will help remember the logic", "url": "https://github.com/apache/hive/pull/1791#discussion_r552149040", "createdAt": "2021-01-05T19:34:12Z", "author": {"login": "nrg4878"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -896,39 +946,103 @@ private void openSession() throws SQLException {\n       openReq.setPassword(sessConfMap.get(JdbcConnectionParams.AUTH_PASSWD));\n     }\n \n+    //TODO(Vihang): This is a bit hacky. We piggy back on a dummy OpenSession call\n+    // to get the redirect response from the server. Instead its probably cleaner to\n+    // explicitly do a HTTP post request and get the response.\n+    int numRetry = isBrowserAuthMode() ? 2 : 1;\n+    for (int i=0; i<numRetry; i++) {\n+      try {\n+        openSession(openReq);\n+      } catch (TException e) {\n+        if (isSamlRedirect(e)) {\n+          boolean success = doBrowserSSO();\n+          if (!success) {\n+            String msg = browserClient.getServerResponse() == null\n+                || browserClient.getServerResponse().getMsg() == null ? \"\"\n+                : browserClient.getServerResponse().getMsg();\n+            throw new SQLException(\n+                \"Could not establish connection to \" + jdbcUriString + \": \"\n+                    + msg, \" 08S01\", e);\n+          }\n+        } else {\n+          throw new SQLException(\n+              \"Could not establish connection to \" + jdbcUriString + \": \" + e\n+                  .getMessage(), \" 08S01\", e);\n+        }\n+      }\n+    }\n+    isClosed = false;\n+  }\n+\n+  private boolean doBrowserSSO() throws SQLException {\n     try {\n-      TOpenSessionResp openResp = client.OpenSession(openReq);\n+      Preconditions.checkNotNull(browserClient);\n+      try (IJdbcBrowserClient bc = browserClient) {\n+        browserClient.doBrowserSSO();\n+        HiveJdbcBrowserServerResponse response = browserClient.getServerResponse();\n+        if (response != null) {\n+          return response.isSuccessful();\n+        }\n+        return false;\n+      }\n+    } catch (Exception ex) {\n+      throw new SQLException(\"Browser based SSO failed: \" + ex.getMessage(),\n+          \" 08S01\",\n+          ex);\n+    }\n+  }\n \n-      // Populate a given configuration from HS2 server HiveConf, only if that configuration\n-      // is not already present in Connection parameter HiveConf i.e., client side configuration\n-      // takes precedence over the server side configuration.\n-      Map<String, String> serverHiveConf = openResp.getConfiguration();\n+  @VisibleForTesting\n+  public IJdbcBrowserClient getBrowserClient() {\n+    return browserClient;\n+  }\n \n-      updateServerHiveConf(serverHiveConf, connParams);\n+  private void openSession(TOpenSessionReq openReq) throws TException, SQLException {\n+    TOpenSessionResp openResp = client.OpenSession(openReq);\n \n-      // validate connection\n-      Utils.verifySuccess(openResp.getStatus());\n-      if (!supportedProtocols.contains(openResp.getServerProtocolVersion())) {\n-        throw new TException(\"Unsupported Hive2 protocol\");\n-      }\n-      protocol = openResp.getServerProtocolVersion();\n-      sessHandle = openResp.getSessionHandle();\n-\n-      final String serverFetchSizeString =\n-          openResp.getConfiguration().get(ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.varname);\n-      if (serverFetchSizeString == null) {\n-        throw new IllegalStateException(\"Server returned a null default fetch size. Check that \"\n-            + ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.varname + \" is configured correctly.\");\n-      }\n+    // Populate a given configuration from HS2 server HiveConf, only if that configuration\n+    // is not already present in Connection parameter HiveConf i.e., client side configuration\n+    // takes precedence over the server side configuration.\n+    Map<String, String> serverHiveConf = openResp.getConfiguration();\n+\n+    updateServerHiveConf(serverHiveConf, connParams);\n+\n+    // validate connection\n+    Utils.verifySuccess(openResp.getStatus());\n+    if (!supportedProtocols.contains(openResp.getServerProtocolVersion())) {\n+      throw new TException(\"Unsupported Hive2 protocol\");\n+    }\n+    protocol = openResp.getServerProtocolVersion();\n+    sessHandle = openResp.getSessionHandle();\n \n-      this.defaultFetchSize = Integer.parseInt(serverFetchSizeString);\n-      if (this.defaultFetchSize <= 0) {\n-        throw new IllegalStateException(\"Default fetch size must be greater than 0\");\n+    final String serverFetchSizeString =\n+        openResp.getConfiguration().get(ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.varname);\n+    if (serverFetchSizeString == null) {\n+      throw new IllegalStateException(\"Server returned a null default fetch size. Check that \"\n+          + ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.varname + \" is configured correctly.\");\n+    }\n+\n+    this.defaultFetchSize = Integer.parseInt(serverFetchSizeString);\n+    if (this.defaultFetchSize <= 0) {\n+      throw new IllegalStateException(\"Default fetch size must be greater than 0\");\n+    }\n+  }\n+\n+  private boolean isSamlRedirect(TException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 255}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI2MDIyNQ==", "bodyText": "makes sense. Done.", "url": "https://github.com/apache/hive/pull/1791#discussion_r552260225", "createdAt": "2021-01-05T23:30:19Z", "author": {"login": "vihangk1"}, "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -896,39 +946,103 @@ private void openSession() throws SQLException {\n       openReq.setPassword(sessConfMap.get(JdbcConnectionParams.AUTH_PASSWD));\n     }\n \n+    //TODO(Vihang): This is a bit hacky. We piggy back on a dummy OpenSession call\n+    // to get the redirect response from the server. Instead its probably cleaner to\n+    // explicitly do a HTTP post request and get the response.\n+    int numRetry = isBrowserAuthMode() ? 2 : 1;\n+    for (int i=0; i<numRetry; i++) {\n+      try {\n+        openSession(openReq);\n+      } catch (TException e) {\n+        if (isSamlRedirect(e)) {\n+          boolean success = doBrowserSSO();\n+          if (!success) {\n+            String msg = browserClient.getServerResponse() == null\n+                || browserClient.getServerResponse().getMsg() == null ? \"\"\n+                : browserClient.getServerResponse().getMsg();\n+            throw new SQLException(\n+                \"Could not establish connection to \" + jdbcUriString + \": \"\n+                    + msg, \" 08S01\", e);\n+          }\n+        } else {\n+          throw new SQLException(\n+              \"Could not establish connection to \" + jdbcUriString + \": \" + e\n+                  .getMessage(), \" 08S01\", e);\n+        }\n+      }\n+    }\n+    isClosed = false;\n+  }\n+\n+  private boolean doBrowserSSO() throws SQLException {\n     try {\n-      TOpenSessionResp openResp = client.OpenSession(openReq);\n+      Preconditions.checkNotNull(browserClient);\n+      try (IJdbcBrowserClient bc = browserClient) {\n+        browserClient.doBrowserSSO();\n+        HiveJdbcBrowserServerResponse response = browserClient.getServerResponse();\n+        if (response != null) {\n+          return response.isSuccessful();\n+        }\n+        return false;\n+      }\n+    } catch (Exception ex) {\n+      throw new SQLException(\"Browser based SSO failed: \" + ex.getMessage(),\n+          \" 08S01\",\n+          ex);\n+    }\n+  }\n \n-      // Populate a given configuration from HS2 server HiveConf, only if that configuration\n-      // is not already present in Connection parameter HiveConf i.e., client side configuration\n-      // takes precedence over the server side configuration.\n-      Map<String, String> serverHiveConf = openResp.getConfiguration();\n+  @VisibleForTesting\n+  public IJdbcBrowserClient getBrowserClient() {\n+    return browserClient;\n+  }\n \n-      updateServerHiveConf(serverHiveConf, connParams);\n+  private void openSession(TOpenSessionReq openReq) throws TException, SQLException {\n+    TOpenSessionResp openResp = client.OpenSession(openReq);\n \n-      // validate connection\n-      Utils.verifySuccess(openResp.getStatus());\n-      if (!supportedProtocols.contains(openResp.getServerProtocolVersion())) {\n-        throw new TException(\"Unsupported Hive2 protocol\");\n-      }\n-      protocol = openResp.getServerProtocolVersion();\n-      sessHandle = openResp.getSessionHandle();\n-\n-      final String serverFetchSizeString =\n-          openResp.getConfiguration().get(ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.varname);\n-      if (serverFetchSizeString == null) {\n-        throw new IllegalStateException(\"Server returned a null default fetch size. Check that \"\n-            + ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.varname + \" is configured correctly.\");\n-      }\n+    // Populate a given configuration from HS2 server HiveConf, only if that configuration\n+    // is not already present in Connection parameter HiveConf i.e., client side configuration\n+    // takes precedence over the server side configuration.\n+    Map<String, String> serverHiveConf = openResp.getConfiguration();\n+\n+    updateServerHiveConf(serverHiveConf, connParams);\n+\n+    // validate connection\n+    Utils.verifySuccess(openResp.getStatus());\n+    if (!supportedProtocols.contains(openResp.getServerProtocolVersion())) {\n+      throw new TException(\"Unsupported Hive2 protocol\");\n+    }\n+    protocol = openResp.getServerProtocolVersion();\n+    sessHandle = openResp.getSessionHandle();\n \n-      this.defaultFetchSize = Integer.parseInt(serverFetchSizeString);\n-      if (this.defaultFetchSize <= 0) {\n-        throw new IllegalStateException(\"Default fetch size must be greater than 0\");\n+    final String serverFetchSizeString =\n+        openResp.getConfiguration().get(ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.varname);\n+    if (serverFetchSizeString == null) {\n+      throw new IllegalStateException(\"Server returned a null default fetch size. Check that \"\n+          + ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.varname + \" is configured correctly.\");\n+    }\n+\n+    this.defaultFetchSize = Integer.parseInt(serverFetchSizeString);\n+    if (this.defaultFetchSize <= 0) {\n+      throw new IllegalStateException(\"Default fetch size must be greater than 0\");\n+    }\n+  }\n+\n+  private boolean isSamlRedirect(TException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjE0OTA0MA=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 255}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NjQyMzE1OnYy", "diffSide": "RIGHT", "path": "jdbc/src/java/org/apache/hive/jdbc/saml/HiveJdbcBrowserClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwMzo0Njo0MVrOIOw8tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQyMTo0ODoyMlrOIRokww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM1Mjk1MQ==", "bodyText": "should this account for serverSocket being null in case of an exception in getServerSocket() ?", "url": "https://github.com/apache/hive/pull/1791#discussion_r552352951", "createdAt": "2021-01-06T03:46:41Z", "author": {"login": "nrg4878"}, "path": "jdbc/src/java/org/apache/hive/jdbc/saml/HiveJdbcBrowserClient.java", "diffHunk": "@@ -0,0 +1,322 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hive.jdbc.saml;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Strings;\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import java.awt.Desktop;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.PrintWriter;\n+import java.io.UnsupportedEncodingException;\n+import java.net.InetAddress;\n+import java.net.ServerSocket;\n+import java.net.Socket;\n+import java.net.SocketTimeoutException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URLDecoder;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import org.apache.hive.jdbc.Utils.JdbcConnectionParams;\n+import org.apache.hive.service.auth.saml.HiveSamlUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This class is used to execute a browser based SSO workflow with the authentication mode\n+ * is browser.\n+ */\n+public class HiveJdbcBrowserClient implements IJdbcBrowserClient {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(HiveJdbcBrowserClient.class);\n+  // error message when the socket times out.\n+  @VisibleForTesting\n+  public static final String TIMEOUT_ERROR_MSG = \"Timed out while waiting for server response\";\n+  private final ServerSocket serverSocket;\n+  private HiveJdbcBrowserServerResponse serverResponse;\n+  protected JdbcBrowserClientContext clientContext;\n+  // By default we wait for 2 min unless overridden by a JDBC connection param\n+  // browserResponseTimeout\n+  private static final int DEFAULT_SOCKET_TIMEOUT_SECS = 120;\n+  private final ExecutorService serverResponseThread = Executors.newSingleThreadExecutor(\n+      new ThreadFactoryBuilder().setNameFormat(\"Hive-Jdbc-Browser-Client-%d\")\n+          .setDaemon(true).build());\n+\n+  HiveJdbcBrowserClient(JdbcConnectionParams connectionParams)\n+      throws HiveJdbcBrowserException {\n+    serverSocket = getServerSocket(connectionParams.getSessionVars());\n+  }\n+\n+  private ServerSocket getServerSocket(Map<String, String> sessionConf)\n+      throws HiveJdbcBrowserException {\n+    final ServerSocket serverSocket;\n+    int port = Integer.parseInt(sessionConf\n+        .getOrDefault(JdbcConnectionParams.AUTH_BROWSER_RESPONSE_PORT, \"0\"));\n+    int timeout = Integer.parseInt(\n+        sessionConf.getOrDefault(JdbcConnectionParams.AUTH_BROWSER_RESPONSE_TIMEOUT_SECS,\n+            String.valueOf(DEFAULT_SOCKET_TIMEOUT_SECS)));\n+    try {\n+      serverSocket = new ServerSocket(port, 0,\n+          InetAddress.getByName(HiveSamlUtils.LOOP_BACK_INTERFACE));\n+      LOG.debug(\"Browser response timeout is set to {} seconds\", timeout);\n+      serverSocket.setSoTimeout(timeout * 1000);\n+    } catch (IOException e) {\n+      throw new HiveJdbcBrowserException(\"Unable to bind to the localhost\");\n+    }\n+    return serverSocket;\n+  }\n+\n+  public Integer getPort() {\n+    return serverSocket.getLocalPort();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM2MTQ3NQ==", "bodyText": "serverSocket is a final field and it will always be not-null. If there is an exception during getServerSocket, the HiveJdbcBrowserClient's constructor will error out.", "url": "https://github.com/apache/hive/pull/1791#discussion_r555361475", "createdAt": "2021-01-11T21:48:22Z", "author": {"login": "vihangk1"}, "path": "jdbc/src/java/org/apache/hive/jdbc/saml/HiveJdbcBrowserClient.java", "diffHunk": "@@ -0,0 +1,322 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hive.jdbc.saml;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Strings;\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import java.awt.Desktop;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.PrintWriter;\n+import java.io.UnsupportedEncodingException;\n+import java.net.InetAddress;\n+import java.net.ServerSocket;\n+import java.net.Socket;\n+import java.net.SocketTimeoutException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URLDecoder;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import org.apache.hive.jdbc.Utils.JdbcConnectionParams;\n+import org.apache.hive.service.auth.saml.HiveSamlUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This class is used to execute a browser based SSO workflow with the authentication mode\n+ * is browser.\n+ */\n+public class HiveJdbcBrowserClient implements IJdbcBrowserClient {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(HiveJdbcBrowserClient.class);\n+  // error message when the socket times out.\n+  @VisibleForTesting\n+  public static final String TIMEOUT_ERROR_MSG = \"Timed out while waiting for server response\";\n+  private final ServerSocket serverSocket;\n+  private HiveJdbcBrowserServerResponse serverResponse;\n+  protected JdbcBrowserClientContext clientContext;\n+  // By default we wait for 2 min unless overridden by a JDBC connection param\n+  // browserResponseTimeout\n+  private static final int DEFAULT_SOCKET_TIMEOUT_SECS = 120;\n+  private final ExecutorService serverResponseThread = Executors.newSingleThreadExecutor(\n+      new ThreadFactoryBuilder().setNameFormat(\"Hive-Jdbc-Browser-Client-%d\")\n+          .setDaemon(true).build());\n+\n+  HiveJdbcBrowserClient(JdbcConnectionParams connectionParams)\n+      throws HiveJdbcBrowserException {\n+    serverSocket = getServerSocket(connectionParams.getSessionVars());\n+  }\n+\n+  private ServerSocket getServerSocket(Map<String, String> sessionConf)\n+      throws HiveJdbcBrowserException {\n+    final ServerSocket serverSocket;\n+    int port = Integer.parseInt(sessionConf\n+        .getOrDefault(JdbcConnectionParams.AUTH_BROWSER_RESPONSE_PORT, \"0\"));\n+    int timeout = Integer.parseInt(\n+        sessionConf.getOrDefault(JdbcConnectionParams.AUTH_BROWSER_RESPONSE_TIMEOUT_SECS,\n+            String.valueOf(DEFAULT_SOCKET_TIMEOUT_SECS)));\n+    try {\n+      serverSocket = new ServerSocket(port, 0,\n+          InetAddress.getByName(HiveSamlUtils.LOOP_BACK_INTERFACE));\n+      LOG.debug(\"Browser response timeout is set to {} seconds\", timeout);\n+      serverSocket.setSoTimeout(timeout * 1000);\n+    } catch (IOException e) {\n+      throw new HiveJdbcBrowserException(\"Unable to bind to the localhost\");\n+    }\n+    return serverSocket;\n+  }\n+\n+  public Integer getPort() {\n+    return serverSocket.getLocalPort();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM1Mjk1MQ=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NjQyNDc0OnYy", "diffSide": "RIGHT", "path": "jdbc/src/java/org/apache/hive/jdbc/saml/HiveJdbcBrowserClient.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwMzo0NzozN1rOIOw9hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQwMzozNDozOVrOIRwXEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM1MzE1Nw==", "bodyText": "looks like this needs some real validation code?", "url": "https://github.com/apache/hive/pull/1791#discussion_r552353157", "createdAt": "2021-01-06T03:47:37Z", "author": {"login": "nrg4878"}, "path": "jdbc/src/java/org/apache/hive/jdbc/saml/HiveJdbcBrowserClient.java", "diffHunk": "@@ -0,0 +1,322 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hive.jdbc.saml;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Strings;\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import java.awt.Desktop;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.PrintWriter;\n+import java.io.UnsupportedEncodingException;\n+import java.net.InetAddress;\n+import java.net.ServerSocket;\n+import java.net.Socket;\n+import java.net.SocketTimeoutException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URLDecoder;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import org.apache.hive.jdbc.Utils.JdbcConnectionParams;\n+import org.apache.hive.service.auth.saml.HiveSamlUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This class is used to execute a browser based SSO workflow with the authentication mode\n+ * is browser.\n+ */\n+public class HiveJdbcBrowserClient implements IJdbcBrowserClient {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(HiveJdbcBrowserClient.class);\n+  // error message when the socket times out.\n+  @VisibleForTesting\n+  public static final String TIMEOUT_ERROR_MSG = \"Timed out while waiting for server response\";\n+  private final ServerSocket serverSocket;\n+  private HiveJdbcBrowserServerResponse serverResponse;\n+  protected JdbcBrowserClientContext clientContext;\n+  // By default we wait for 2 min unless overridden by a JDBC connection param\n+  // browserResponseTimeout\n+  private static final int DEFAULT_SOCKET_TIMEOUT_SECS = 120;\n+  private final ExecutorService serverResponseThread = Executors.newSingleThreadExecutor(\n+      new ThreadFactoryBuilder().setNameFormat(\"Hive-Jdbc-Browser-Client-%d\")\n+          .setDaemon(true).build());\n+\n+  HiveJdbcBrowserClient(JdbcConnectionParams connectionParams)\n+      throws HiveJdbcBrowserException {\n+    serverSocket = getServerSocket(connectionParams.getSessionVars());\n+  }\n+\n+  private ServerSocket getServerSocket(Map<String, String> sessionConf)\n+      throws HiveJdbcBrowserException {\n+    final ServerSocket serverSocket;\n+    int port = Integer.parseInt(sessionConf\n+        .getOrDefault(JdbcConnectionParams.AUTH_BROWSER_RESPONSE_PORT, \"0\"));\n+    int timeout = Integer.parseInt(\n+        sessionConf.getOrDefault(JdbcConnectionParams.AUTH_BROWSER_RESPONSE_TIMEOUT_SECS,\n+            String.valueOf(DEFAULT_SOCKET_TIMEOUT_SECS)));\n+    try {\n+      serverSocket = new ServerSocket(port, 0,\n+          InetAddress.getByName(HiveSamlUtils.LOOP_BACK_INTERFACE));\n+      LOG.debug(\"Browser response timeout is set to {} seconds\", timeout);\n+      serverSocket.setSoTimeout(timeout * 1000);\n+    } catch (IOException e) {\n+      throw new HiveJdbcBrowserException(\"Unable to bind to the localhost\");\n+    }\n+    return serverSocket;\n+  }\n+\n+  public Integer getPort() {\n+    return serverSocket.getLocalPort();\n+  }\n+\n+  @Override\n+  public void close() throws IOException {\n+    if (serverSocket != null) {\n+      serverSocket.close();\n+    }\n+  }\n+\n+  public void init(JdbcBrowserClientContext clientContext) {\n+    // everytime we set the sso URI we should clean up the previous state if its set.\n+    // this may be from the previous invalid connection attempt or if the token has\n+    // expired\n+    reset();\n+    this.clientContext = clientContext;\n+    LOG.trace(\"Initialized the JDBCBrowser client with URL {}\",\n+        clientContext.getSsoUri());\n+  }\n+\n+  private void reset() {\n+    serverResponse = null;\n+    clientContext = null;\n+  }\n+\n+  private boolean validateSSOUrl(URI ssoUrl) {\n+    //TODO(Vihang) add URL validation code here\n+    return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ4OTA0Mg==", "bodyText": "Initially I thought we can add a validation check to confirm that the SSO URL is from an expected domain. However, I plan to move that to a separate task since it is not critical. I removed this from the patch.", "url": "https://github.com/apache/hive/pull/1791#discussion_r555489042", "createdAt": "2021-01-12T03:34:39Z", "author": {"login": "vihangk1"}, "path": "jdbc/src/java/org/apache/hive/jdbc/saml/HiveJdbcBrowserClient.java", "diffHunk": "@@ -0,0 +1,322 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hive.jdbc.saml;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Preconditions;\n+import com.google.common.base.Strings;\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+import java.awt.Desktop;\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.PrintWriter;\n+import java.io.UnsupportedEncodingException;\n+import java.net.InetAddress;\n+import java.net.ServerSocket;\n+import java.net.Socket;\n+import java.net.SocketTimeoutException;\n+import java.net.URI;\n+import java.net.URISyntaxException;\n+import java.net.URLDecoder;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.Callable;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.ExecutorService;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.Future;\n+import org.apache.hive.jdbc.Utils.JdbcConnectionParams;\n+import org.apache.hive.service.auth.saml.HiveSamlUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * This class is used to execute a browser based SSO workflow with the authentication mode\n+ * is browser.\n+ */\n+public class HiveJdbcBrowserClient implements IJdbcBrowserClient {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(HiveJdbcBrowserClient.class);\n+  // error message when the socket times out.\n+  @VisibleForTesting\n+  public static final String TIMEOUT_ERROR_MSG = \"Timed out while waiting for server response\";\n+  private final ServerSocket serverSocket;\n+  private HiveJdbcBrowserServerResponse serverResponse;\n+  protected JdbcBrowserClientContext clientContext;\n+  // By default we wait for 2 min unless overridden by a JDBC connection param\n+  // browserResponseTimeout\n+  private static final int DEFAULT_SOCKET_TIMEOUT_SECS = 120;\n+  private final ExecutorService serverResponseThread = Executors.newSingleThreadExecutor(\n+      new ThreadFactoryBuilder().setNameFormat(\"Hive-Jdbc-Browser-Client-%d\")\n+          .setDaemon(true).build());\n+\n+  HiveJdbcBrowserClient(JdbcConnectionParams connectionParams)\n+      throws HiveJdbcBrowserException {\n+    serverSocket = getServerSocket(connectionParams.getSessionVars());\n+  }\n+\n+  private ServerSocket getServerSocket(Map<String, String> sessionConf)\n+      throws HiveJdbcBrowserException {\n+    final ServerSocket serverSocket;\n+    int port = Integer.parseInt(sessionConf\n+        .getOrDefault(JdbcConnectionParams.AUTH_BROWSER_RESPONSE_PORT, \"0\"));\n+    int timeout = Integer.parseInt(\n+        sessionConf.getOrDefault(JdbcConnectionParams.AUTH_BROWSER_RESPONSE_TIMEOUT_SECS,\n+            String.valueOf(DEFAULT_SOCKET_TIMEOUT_SECS)));\n+    try {\n+      serverSocket = new ServerSocket(port, 0,\n+          InetAddress.getByName(HiveSamlUtils.LOOP_BACK_INTERFACE));\n+      LOG.debug(\"Browser response timeout is set to {} seconds\", timeout);\n+      serverSocket.setSoTimeout(timeout * 1000);\n+    } catch (IOException e) {\n+      throw new HiveJdbcBrowserException(\"Unable to bind to the localhost\");\n+    }\n+    return serverSocket;\n+  }\n+\n+  public Integer getPort() {\n+    return serverSocket.getLocalPort();\n+  }\n+\n+  @Override\n+  public void close() throws IOException {\n+    if (serverSocket != null) {\n+      serverSocket.close();\n+    }\n+  }\n+\n+  public void init(JdbcBrowserClientContext clientContext) {\n+    // everytime we set the sso URI we should clean up the previous state if its set.\n+    // this may be from the previous invalid connection attempt or if the token has\n+    // expired\n+    reset();\n+    this.clientContext = clientContext;\n+    LOG.trace(\"Initialized the JDBCBrowser client with URL {}\",\n+        clientContext.getSsoUri());\n+  }\n+\n+  private void reset() {\n+    serverResponse = null;\n+    clientContext = null;\n+  }\n+\n+  private boolean validateSSOUrl(URI ssoUrl) {\n+    //TODO(Vihang) add URL validation code here\n+    return true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM1MzE1Nw=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NjQ0NjQwOnYy", "diffSide": "RIGHT", "path": "service/pom.xml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwNDowMDoyOFrOIOxJZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQwMzozNDo1OVrOIRwXaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM1NjE5Ng==", "bodyText": "should define the scope for this dependency. Might pull in transitive dependencies that might be undesirable.", "url": "https://github.com/apache/hive/pull/1791#discussion_r552356196", "createdAt": "2021-01-06T04:00:28Z", "author": {"login": "nrg4878"}, "path": "service/pom.xml", "diffHunk": "@@ -179,6 +179,37 @@\n         </exclusion>\n       </exclusions>\n     </dependency>\n+    <dependency>\n+      <groupId>org.pac4j</groupId>\n+      <artifactId>pac4j-saml-opensamlv3</artifactId>\n+      <version>4.0.3</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTM2MjEzOA==", "bodyText": "I found on dependency which can potentially cause problems (commons-collections). I excluded it here. However, finding all the dependencies which are unnecessary may be a bit more complex. I will create a separate JIRA for that if that is okay with you.", "url": "https://github.com/apache/hive/pull/1791#discussion_r555362138", "createdAt": "2021-01-11T21:49:42Z", "author": {"login": "vihangk1"}, "path": "service/pom.xml", "diffHunk": "@@ -179,6 +179,37 @@\n         </exclusion>\n       </exclusions>\n     </dependency>\n+    <dependency>\n+      <groupId>org.pac4j</groupId>\n+      <artifactId>pac4j-saml-opensamlv3</artifactId>\n+      <version>4.0.3</version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM1NjE5Ng=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ4OTEyOA==", "bodyText": "Created HIVE-24619 to track this.", "url": "https://github.com/apache/hive/pull/1791#discussion_r555489128", "createdAt": "2021-01-12T03:34:59Z", "author": {"login": "vihangk1"}, "path": "service/pom.xml", "diffHunk": "@@ -179,6 +179,37 @@\n         </exclusion>\n       </exclusions>\n     </dependency>\n+    <dependency>\n+      <groupId>org.pac4j</groupId>\n+      <artifactId>pac4j-saml-opensamlv3</artifactId>\n+      <version>4.0.3</version>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM1NjE5Ng=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NjQ2NzA0OnYy", "diffSide": "RIGHT", "path": "service/src/java/org/apache/hive/service/auth/AuthenticationProviderFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwNDoxMzoxNVrOIOxUWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMlQwMzozNToyNlrOIRwYBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM1OTAwMQ==", "bodyText": "not sure I understand how this works.\nWhen auth is set to SAML on server, is this provider even called?", "url": "https://github.com/apache/hive/pull/1791#discussion_r552359001", "createdAt": "2021-01-06T04:13:15Z", "author": {"login": "nrg4878"}, "path": "service/src/java/org/apache/hive/service/auth/AuthenticationProviderFactory.java", "diffHunk": "@@ -76,6 +77,9 @@ public static PasswdAuthenticationProvider getAuthenticationProvider(AuthMethods\n       return new CustomAuthenticationProviderImpl((conf == null) ? AuthMethods.CUSTOM.getConf() : conf);\n     } else if (authMethod == AuthMethods.NONE) {\n       return new AnonymousAuthenticationProviderImpl();\n+    } else if (authMethod == AuthMethods.SAML) {\n+      //TODO right thing to do?\n+      return new AnonymousAuthenticationProviderImpl();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ4OTI4NA==", "bodyText": "I don't think it is necessary. I removed this from the PR.", "url": "https://github.com/apache/hive/pull/1791#discussion_r555489284", "createdAt": "2021-01-12T03:35:26Z", "author": {"login": "vihangk1"}, "path": "service/src/java/org/apache/hive/service/auth/AuthenticationProviderFactory.java", "diffHunk": "@@ -76,6 +77,9 @@ public static PasswdAuthenticationProvider getAuthenticationProvider(AuthMethods\n       return new CustomAuthenticationProviderImpl((conf == null) ? AuthMethods.CUSTOM.getConf() : conf);\n     } else if (authMethod == AuthMethods.NONE) {\n       return new AnonymousAuthenticationProviderImpl();\n+    } else if (authMethod == AuthMethods.SAML) {\n+      //TODO right thing to do?\n+      return new AnonymousAuthenticationProviderImpl();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjM1OTAwMQ=="}, "originalCommit": {"oid": "2763d7f5e05bad6a15c503d49666db55e33e7f7a"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzcyODQ5MDQ3OnYy", "diffSide": "RIGHT", "path": "service/src/java/org/apache/hive/service/auth/saml/HiveSamlGroupNameFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0wOVQxODowMjo1NlrOIzPTfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0wOVQxODowMjo1NlrOIzPTfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDU5OTAzNw==", "bodyText": "We should not be logging configured user and group filters to the logs regardless of the log levels. User's security configuration might be inadvertently logged to the files that are then distributed. Can you please create a follow up jira to review such statements.", "url": "https://github.com/apache/hive/pull/1791#discussion_r590599037", "createdAt": "2021-03-09T18:02:56Z", "author": {"login": "nrg4878"}, "path": "service/src/java/org/apache/hive/service/auth/saml/HiveSamlGroupNameFilter.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hive.service.auth.saml;\n+\n+import com.google.common.base.Predicate;\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import java.util.List;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.conf.HiveConf.ConfVars;\n+import org.pac4j.saml.credentials.SAML2Credentials.SAMLAttribute;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class HiveSamlGroupNameFilter implements Predicate<SAMLAttribute> {\n+\n+  private static final Logger LOG = LoggerFactory\n+      .getLogger(HiveSamlGroupNameFilter.class);\n+  private final List<String> groupNames;\n+  private static final Splitter COMMA_SPLITTER = Splitter.on(',').trimResults()\n+      .omitEmptyStrings();\n+  private final String attributeName;\n+\n+  public HiveSamlGroupNameFilter(HiveConf conf) {\n+    String groupNameStr = conf.get(ConfVars.HIVE_SERVER2_SAML_GROUP_FILTER.varname);\n+    attributeName = conf.get(ConfVars.HIVE_SERVER2_SAML_GROUP_ATTRIBUTE_NAME.varname, \"\");\n+    ImmutableList.Builder<String> builder = ImmutableList.builder();\n+    if (groupNameStr != null && !groupNameStr.isEmpty()) {\n+      builder\n+          .addAll(COMMA_SPLITTER.split(groupNameStr));\n+    }\n+    groupNames = builder.build();\n+    LOG.debug(\"Initialized allowed group names as {}\", groupNames);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b358b44038c5d47eeb70db29728e65f50727c7b1"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzcyODQ5MTQ4OnYy", "diffSide": "RIGHT", "path": "service/src/java/org/apache/hive/service/auth/saml/HiveSamlGroupNameFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0wOVQxODowMzoxNFrOIzPUHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0wOVQxODowMzoxNFrOIzPUHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDU5OTE5Ng==", "bodyText": "ditto", "url": "https://github.com/apache/hive/pull/1791#discussion_r590599196", "createdAt": "2021-03-09T18:03:14Z", "author": {"login": "nrg4878"}, "path": "service/src/java/org/apache/hive/service/auth/saml/HiveSamlGroupNameFilter.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hive.service.auth.saml;\n+\n+import com.google.common.base.Predicate;\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import java.util.List;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.conf.HiveConf.ConfVars;\n+import org.pac4j.saml.credentials.SAML2Credentials.SAMLAttribute;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class HiveSamlGroupNameFilter implements Predicate<SAMLAttribute> {\n+\n+  private static final Logger LOG = LoggerFactory\n+      .getLogger(HiveSamlGroupNameFilter.class);\n+  private final List<String> groupNames;\n+  private static final Splitter COMMA_SPLITTER = Splitter.on(',').trimResults()\n+      .omitEmptyStrings();\n+  private final String attributeName;\n+\n+  public HiveSamlGroupNameFilter(HiveConf conf) {\n+    String groupNameStr = conf.get(ConfVars.HIVE_SERVER2_SAML_GROUP_FILTER.varname);\n+    attributeName = conf.get(ConfVars.HIVE_SERVER2_SAML_GROUP_ATTRIBUTE_NAME.varname, \"\");\n+    ImmutableList.Builder<String> builder = ImmutableList.builder();\n+    if (groupNameStr != null && !groupNameStr.isEmpty()) {\n+      builder\n+          .addAll(COMMA_SPLITTER.split(groupNameStr));\n+    }\n+    groupNames = builder.build();\n+    LOG.debug(\"Initialized allowed group names as {}\", groupNames);\n+  }\n+\n+  public boolean apply(List<SAMLAttribute> attributes) {\n+    if (attributeName.isEmpty() && attributes.size() == 0) {\n+      return true;\n+    }\n+    for (SAMLAttribute attribute : attributes) {\n+      if (apply(attribute)) {\n+        return true;\n+      }\n+    }\n+    return false;\n+  }\n+\n+  @Override\n+  public boolean apply(SAMLAttribute attribute) {\n+    if (attributeName.isEmpty()) {\n+      // if attributeName is not configured, then it means groups based\n+      // filtering is not enabled and we allow any authenticated user.\n+      return true;\n+    }\n+    if (attribute == null || attribute.getName() == null) {\n+      return false;\n+    }\n+    if (!attributeName.equals(attribute.getName())) {\n+      LOG.debug(\"Attribute name {} did not match with {}\", attribute.getName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b358b44038c5d47eeb70db29728e65f50727c7b1"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzcyODQ5MjcwOnYy", "diffSide": "RIGHT", "path": "service/src/java/org/apache/hive/service/auth/saml/HiveSamlGroupNameFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0wOVQxODowMzoyOFrOIzPUzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0wOVQxODowMzoyOFrOIzPUzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MDU5OTM3NA==", "bodyText": "ditto", "url": "https://github.com/apache/hive/pull/1791#discussion_r590599374", "createdAt": "2021-03-09T18:03:28Z", "author": {"login": "nrg4878"}, "path": "service/src/java/org/apache/hive/service/auth/saml/HiveSamlGroupNameFilter.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hive.service.auth.saml;\n+\n+import com.google.common.base.Predicate;\n+import com.google.common.base.Splitter;\n+import com.google.common.collect.ImmutableList;\n+import java.util.List;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hadoop.hive.conf.HiveConf.ConfVars;\n+import org.pac4j.saml.credentials.SAML2Credentials.SAMLAttribute;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class HiveSamlGroupNameFilter implements Predicate<SAMLAttribute> {\n+\n+  private static final Logger LOG = LoggerFactory\n+      .getLogger(HiveSamlGroupNameFilter.class);\n+  private final List<String> groupNames;\n+  private static final Splitter COMMA_SPLITTER = Splitter.on(',').trimResults()\n+      .omitEmptyStrings();\n+  private final String attributeName;\n+\n+  public HiveSamlGroupNameFilter(HiveConf conf) {\n+    String groupNameStr = conf.get(ConfVars.HIVE_SERVER2_SAML_GROUP_FILTER.varname);\n+    attributeName = conf.get(ConfVars.HIVE_SERVER2_SAML_GROUP_ATTRIBUTE_NAME.varname, \"\");\n+    ImmutableList.Builder<String> builder = ImmutableList.builder();\n+    if (groupNameStr != null && !groupNameStr.isEmpty()) {\n+      builder\n+          .addAll(COMMA_SPLITTER.split(groupNameStr));\n+    }\n+    groupNames = builder.build();\n+    LOG.debug(\"Initialized allowed group names as {}\", groupNames);\n+  }\n+\n+  public boolean apply(List<SAMLAttribute> attributes) {\n+    if (attributeName.isEmpty() && attributes.size() == 0) {\n+      return true;\n+    }\n+    for (SAMLAttribute attribute : attributes) {\n+      if (apply(attribute)) {\n+        return true;\n+      }\n+    }\n+    return false;\n+  }\n+\n+  @Override\n+  public boolean apply(SAMLAttribute attribute) {\n+    if (attributeName.isEmpty()) {\n+      // if attributeName is not configured, then it means groups based\n+      // filtering is not enabled and we allow any authenticated user.\n+      return true;\n+    }\n+    if (attribute == null || attribute.getName() == null) {\n+      return false;\n+    }\n+    if (!attributeName.equals(attribute.getName())) {\n+      LOG.debug(\"Attribute name {} did not match with {}\", attribute.getName(),\n+          attributeName);\n+      return false;\n+    }\n+    for (String attrVal : attribute.getAttributeValues()) {\n+      LOG.debug(\"Evaluating group name {}\", attrVal);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b358b44038c5d47eeb70db29728e65f50727c7b1"}, "originalPosition": 80}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 177, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}