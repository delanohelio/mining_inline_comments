{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3MTc4NDQy", "number": 1705, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxMTo0N1rOE-iXkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxNToyNVrOE-icLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MDEwMjU5OnYy", "diffSide": "RIGHT", "path": "llap-client/src/java/org/apache/hadoop/hive/llap/tezplugins/helpers/LlapTaskUmbilicalServer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxMTo0N1rOH7vuNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxMTo0N1rOH7vuNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQwOTkxMA==", "bodyText": "can you use RangeValidator from HiveConf and make sure the min is 1024 and max is 65535 which is the port range for user space ports.", "url": "https://github.com/apache/hive/pull/1705#discussion_r532409910", "createdAt": "2020-11-30T08:11:47Z", "author": {"login": "prasanthj"}, "path": "llap-client/src/java/org/apache/hadoop/hive/llap/tezplugins/helpers/LlapTaskUmbilicalServer.java", "diffHunk": "@@ -54,27 +56,54 @@\n \n   public LlapTaskUmbilicalServer(Configuration conf, LlapTaskUmbilicalProtocol umbilical, int numHandlers) throws IOException {\n     jobTokenSecretManager = new JobTokenSecretManager();\n-    int umbilicalPort = HiveConf.getIntVar(conf, HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT);\n-    if (umbilicalPort <= 0) {\n-      umbilicalPort = 0;\n+\n+    String[] portRange =\n+        conf.get(HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT.varname)\n+            .split(\"-\");\n+\n+    int minPort = Integer.parseInt(portRange[0]);\n+    boolean portFound = false;\n+    IOException e = null;\n+    if (portRange.length == 1) {\n+      // Single port specified, not Range.\n+      startServer(conf, umbilical, numHandlers, minPort);\n+      portFound = true;\n+    } else {\n+      int maxPort = Integer.parseInt(portRange[1]);\n+      for (int i = minPort; i < maxPort; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MDEwNTU5OnYy", "diffSide": "RIGHT", "path": "llap-client/src/java/org/apache/hadoop/hive/llap/tezplugins/helpers/LlapTaskUmbilicalServer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxMjo0NVrOH7vv7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxMjo0NVrOH7vv7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMDM1MQ==", "bodyText": "Log at warn level to say which port is being tried and what error message received for debugging.", "url": "https://github.com/apache/hive/pull/1705#discussion_r532410351", "createdAt": "2020-11-30T08:12:45Z", "author": {"login": "prasanthj"}, "path": "llap-client/src/java/org/apache/hadoop/hive/llap/tezplugins/helpers/LlapTaskUmbilicalServer.java", "diffHunk": "@@ -54,27 +56,54 @@\n \n   public LlapTaskUmbilicalServer(Configuration conf, LlapTaskUmbilicalProtocol umbilical, int numHandlers) throws IOException {\n     jobTokenSecretManager = new JobTokenSecretManager();\n-    int umbilicalPort = HiveConf.getIntVar(conf, HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT);\n-    if (umbilicalPort <= 0) {\n-      umbilicalPort = 0;\n+\n+    String[] portRange =\n+        conf.get(HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT.varname)\n+            .split(\"-\");\n+\n+    int minPort = Integer.parseInt(portRange[0]);\n+    boolean portFound = false;\n+    IOException e = null;\n+    if (portRange.length == 1) {\n+      // Single port specified, not Range.\n+      startServer(conf, umbilical, numHandlers, minPort);\n+      portFound = true;\n+    } else {\n+      int maxPort = Integer.parseInt(portRange[1]);\n+      for (int i = minPort; i < maxPort; i++) {\n+        try {\n+          startServer(conf, umbilical, numHandlers, i);\n+          portFound = true;\n+          break;\n+        } catch (BindException be) {\n+          // Ignore and move ahead, in search of a free port.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MDEwODUxOnYy", "diffSide": "RIGHT", "path": "llap-client/src/java/org/apache/hadoop/hive/llap/tezplugins/helpers/LlapTaskUmbilicalServer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxMzozOVrOH7vxsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxMzozOVrOH7vxsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMDgwMw==", "bodyText": "nit: you could move this to a private variable instead of searching conf object every time (now that startServer is in a loop)", "url": "https://github.com/apache/hive/pull/1705#discussion_r532410803", "createdAt": "2020-11-30T08:13:39Z", "author": {"login": "prasanthj"}, "path": "llap-client/src/java/org/apache/hadoop/hive/llap/tezplugins/helpers/LlapTaskUmbilicalServer.java", "diffHunk": "@@ -54,27 +56,54 @@\n \n   public LlapTaskUmbilicalServer(Configuration conf, LlapTaskUmbilicalProtocol umbilical, int numHandlers) throws IOException {\n     jobTokenSecretManager = new JobTokenSecretManager();\n-    int umbilicalPort = HiveConf.getIntVar(conf, HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT);\n-    if (umbilicalPort <= 0) {\n-      umbilicalPort = 0;\n+\n+    String[] portRange =\n+        conf.get(HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT.varname)\n+            .split(\"-\");\n+\n+    int minPort = Integer.parseInt(portRange[0]);\n+    boolean portFound = false;\n+    IOException e = null;\n+    if (portRange.length == 1) {\n+      // Single port specified, not Range.\n+      startServer(conf, umbilical, numHandlers, minPort);\n+      portFound = true;\n+    } else {\n+      int maxPort = Integer.parseInt(portRange[1]);\n+      for (int i = minPort; i < maxPort; i++) {\n+        try {\n+          startServer(conf, umbilical, numHandlers, i);\n+          portFound = true;\n+          break;\n+        } catch (BindException be) {\n+          // Ignore and move ahead, in search of a free port.\n+          e = be;\n+        }\n+      }\n     }\n-    server = new RPC.Builder(conf)\n-        .setProtocol(LlapTaskUmbilicalProtocol.class)\n-        .setBindAddress(\"0.0.0.0\")\n-        .setPort(umbilicalPort)\n-        .setInstance(umbilical)\n-        .setNumHandlers(numHandlers)\n-        .setSecretManager(jobTokenSecretManager).build();\n-\n-    if (conf.getBoolean(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHORIZATION, false)) {\n-      server.refreshServiceAcl(conf, new LlapUmbilicalExternalPolicyProvider());\n+    if (!portFound) {\n+      throw e;\n     }\n \n-    server.start();\n     this.address = NetUtils.getConnectAddress(server);\n     LOG.info(\n         \"Started TaskUmbilicalServer: \" + umbilical.getClass().getName() + \" at address: \" + address +\n-        \" with numHandlers=\" + numHandlers);\n+            \" with numHandlers=\" + numHandlers);\n+  }\n+\n+  private void startServer(Configuration conf,\n+      LlapTaskUmbilicalProtocol umbilical, int numHandlers, int port)\n+      throws IOException {\n+    server = new RPC.Builder(conf).setProtocol(LlapTaskUmbilicalProtocol.class)\n+        .setBindAddress(\"0.0.0.0\").setPort(port).setInstance(umbilical)\n+        .setNumHandlers(numHandlers).setSecretManager(jobTokenSecretManager)\n+        .build();\n+    if (conf\n+        .getBoolean(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHORIZATION,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MDExMTU1OnYy", "diffSide": "RIGHT", "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxNDoyOVrOH7vzYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxNDoyOVrOH7vzYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMTIzMg==", "bodyText": "add what the min and max values for the range can be (1024 - 65535)", "url": "https://github.com/apache/hive/pull/1705#discussion_r532411232", "createdAt": "2020-11-30T08:14:29Z", "author": {"login": "prasanthj"}, "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "diffHunk": "@@ -4917,8 +4917,9 @@ private static void populateLlapDaemonVarsSet(Set<String> llapDaemonVarsSetLocal\n       \"Sleep duration (in milliseconds) to wait before retrying on error when obtaining a\\n\" +\n       \"connection to LLAP daemon from Tez AM.\",\n       \"llap.task.communicator.connection.sleep-between-retries-millis\"),\n-    LLAP_TASK_UMBILICAL_SERVER_PORT(\"hive.llap.daemon.umbilical.port\", 0,\n-      \"LLAP task umbilical server RPC port\"),\n+    LLAP_TASK_UMBILICAL_SERVER_PORT(\"hive.llap.daemon.umbilical.port\", \"0\",\n+      \"LLAP task umbilical server RPC port or range of ports to try in case \"\n+          + \"the first port is occupied\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MDExMjIxOnYy", "diffSide": "RIGHT", "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskCommunicator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxNDo0NVrOH7vzyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxNDo0NVrOH7vzyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMTMzNw==", "bodyText": "same here for logging", "url": "https://github.com/apache/hive/pull/1705#discussion_r532411337", "createdAt": "2020-11-30T08:14:45Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskCommunicator.java", "diffHunk": "@@ -257,23 +259,32 @@ protected void startRpcServer() {\n \n       int numHandlers =\n           HiveConf.getIntVar(conf, ConfVars.LLAP_TASK_COMMUNICATOR_LISTENER_THREAD_COUNT);\n-      int umbilicalPort = HiveConf.getIntVar(conf, ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT);\n-      if (umbilicalPort <= 0) {\n-        umbilicalPort = 0;\n+      String[] portRange =\n+          conf.get(HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT.varname)\n+              .split(\"-\");\n+      boolean portFound = false;\n+      IOException ioe = null;\n+      int minPort = Integer.parseInt(portRange[0]);\n+      if (portRange.length == 1) {\n+        // Single port specified, not range.\n+        startServerInternal(conf, minPort, numHandlers, jobTokenSecretManager);\n+        portFound = true;\n+      } else {\n+        int maxPort = Integer.parseInt(portRange[1]);\n+        for (int i = minPort; i < maxPort; i++) {\n+          try {\n+            startServerInternal(conf, i, numHandlers, jobTokenSecretManager);\n+            portFound = true;\n+            break;\n+          } catch (BindException be) {\n+            // Ignore and move ahead, in search of a free port.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MDExMjkwOnYy", "diffSide": "RIGHT", "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskCommunicator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxNDo1OFrOH7v0QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxNDo1OFrOH7v0QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMTQ1Nw==", "bodyText": "same here (use RangeValidator)", "url": "https://github.com/apache/hive/pull/1705#discussion_r532411457", "createdAt": "2020-11-30T08:14:58Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskCommunicator.java", "diffHunk": "@@ -257,23 +259,32 @@ protected void startRpcServer() {\n \n       int numHandlers =\n           HiveConf.getIntVar(conf, ConfVars.LLAP_TASK_COMMUNICATOR_LISTENER_THREAD_COUNT);\n-      int umbilicalPort = HiveConf.getIntVar(conf, ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT);\n-      if (umbilicalPort <= 0) {\n-        umbilicalPort = 0;\n+      String[] portRange =\n+          conf.get(HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT.varname)\n+              .split(\"-\");\n+      boolean portFound = false;\n+      IOException ioe = null;\n+      int minPort = Integer.parseInt(portRange[0]);\n+      if (portRange.length == 1) {\n+        // Single port specified, not range.\n+        startServerInternal(conf, minPort, numHandlers, jobTokenSecretManager);\n+        portFound = true;\n+      } else {\n+        int maxPort = Integer.parseInt(portRange[1]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MDExNDM5OnYy", "diffSide": "RIGHT", "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskCommunicator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxNToyNVrOH7v1Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxNToyNVrOH7v1Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMTY4Ng==", "bodyText": "nit: same here to move this to private variable.", "url": "https://github.com/apache/hive/pull/1705#discussion_r532411686", "createdAt": "2020-11-30T08:15:25Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskCommunicator.java", "diffHunk": "@@ -283,6 +294,23 @@ protected void startRpcServer() {\n     }\n   }\n \n+  private void startServerInternal(Configuration conf, int umbilicalPort,\n+      int numHandlers, JobTokenSecretManager jobTokenSecretManager)\n+      throws IOException {\n+    server = new RPC.Builder(conf).setProtocol(LlapTaskUmbilicalProtocol.class)\n+        .setBindAddress(\"0.0.0.0\").setPort(umbilicalPort).setInstance(umbilical)\n+        .setNumHandlers(numHandlers).setSecretManager(jobTokenSecretManager)\n+        .build();\n+\n+    if (conf", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 73}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 270, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}