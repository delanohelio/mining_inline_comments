{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3Nzc3Nzgz", "number": 1712, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwOTo0NDoxMFrOE-kfyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODoxMTozMFrOFArV_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0MDQ1MTMwOnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwOTo0NDoxMFrOH7y-DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwNzo0OTowM1rOH_EtLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ2MzExNw==", "bodyText": "@nareshpr , do you know if partition key name (name=value) is already normalized here?", "url": "https://github.com/apache/hive/pull/1712#discussion_r532463117", "createdAt": "2020-11-30T09:44:10Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -2725,7 +2725,7 @@ private void insertTxnComponents(long txnid, LockRequest rqst, Connection dbConn\n           }\n           String dbName = normalizeCase(lc.getDbname());\n           String tblName = normalizeCase(lc.getTablename());\n-          String partName = normalizeCase(lc.getPartitionname());\n+          String partName = lc.getPartitionname();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ed99e0661d57f256c48f4b9ef95d64d6b6456a7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyMTU1Mg==", "bodyText": "Yes, i validated below 4 SQL's with my patch, partition(key=value) is already normalized\ninsert into table abc PARTITION(CitY='Bangalore') values('Dan');\ninsert overwrite table abc partition(CiTy='Bangalore') select Name from abc;\nupdate table abc set Name='xy' where CiTy='Bangalore';\ndelete from abc where CiTy='Bangalore';", "url": "https://github.com/apache/hive/pull/1712#discussion_r532821552", "createdAt": "2020-11-30T18:48:56Z", "author": {"login": "nareshpr"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -2725,7 +2725,7 @@ private void insertTxnComponents(long txnid, LockRequest rqst, Connection dbConn\n           }\n           String dbName = normalizeCase(lc.getDbname());\n           String tblName = normalizeCase(lc.getTablename());\n-          String partName = normalizeCase(lc.getPartitionname());\n+          String partName = lc.getPartitionname();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ2MzExNw=="}, "originalCommit": {"oid": "7ed99e0661d57f256c48f4b9ef95d64d6b6456a7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzE5NTg0Mg==", "bodyText": "Could there be an issue with partition key name normalization if HMS API is used outside of Hive, for example via Impala?", "url": "https://github.com/apache/hive/pull/1712#discussion_r533195842", "createdAt": "2020-12-01T09:14:17Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -2725,7 +2725,7 @@ private void insertTxnComponents(long txnid, LockRequest rqst, Connection dbConn\n           }\n           String dbName = normalizeCase(lc.getDbname());\n           String tblName = normalizeCase(lc.getTablename());\n-          String partName = normalizeCase(lc.getPartitionname());\n+          String partName = lc.getPartitionname();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ2MzExNw=="}, "originalCommit": {"oid": "7ed99e0661d57f256c48f4b9ef95d64d6b6456a7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY0MDQwMg==", "bodyText": "I doubt HMS API's will hit this flow. Let me know any example or testcase. If required, i can change code to split key=value & convert key to lowerCase and join. Let me know if that is required.", "url": "https://github.com/apache/hive/pull/1712#discussion_r533640402", "createdAt": "2020-12-01T18:44:35Z", "author": {"login": "nareshpr"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -2725,7 +2725,7 @@ private void insertTxnComponents(long txnid, LockRequest rqst, Connection dbConn\n           }\n           String dbName = normalizeCase(lc.getDbname());\n           String tblName = normalizeCase(lc.getTablename());\n-          String partName = normalizeCase(lc.getPartitionname());\n+          String partName = lc.getPartitionname();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ2MzExNw=="}, "originalCommit": {"oid": "7ed99e0661d57f256c48f4b9ef95d64d6b6456a7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk0MDU3MA==", "bodyText": "Impala uses HMS API for transaction management. They rely on a TxnHandler.lock() method to handle concurrent txns.", "url": "https://github.com/apache/hive/pull/1712#discussion_r534940570", "createdAt": "2020-12-03T08:46:57Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -2725,7 +2725,7 @@ private void insertTxnComponents(long txnid, LockRequest rqst, Connection dbConn\n           }\n           String dbName = normalizeCase(lc.getDbname());\n           String tblName = normalizeCase(lc.getTablename());\n-          String partName = normalizeCase(lc.getPartitionname());\n+          String partName = lc.getPartitionname();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ2MzExNw=="}, "originalCommit": {"oid": "7ed99e0661d57f256c48f4b9ef95d64d6b6456a7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTg5OTQzNg==", "bodyText": "I changed it to split & convert partition key to lower key.", "url": "https://github.com/apache/hive/pull/1712#discussion_r535899436", "createdAt": "2020-12-04T07:49:03Z", "author": {"login": "nareshpr"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -2725,7 +2725,7 @@ private void insertTxnComponents(long txnid, LockRequest rqst, Connection dbConn\n           }\n           String dbName = normalizeCase(lc.getDbname());\n           String tblName = normalizeCase(lc.getTablename());\n-          String partName = normalizeCase(lc.getPartitionname());\n+          String partName = lc.getPartitionname();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ2MzExNw=="}, "originalCommit": {"oid": "7ed99e0661d57f256c48f4b9ef95d64d6b6456a7"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MjUxNDY2OnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODowMjo1MFrOH_FIVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODowMjo1MFrOH_FIVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkwNjM5MA==", "bodyText": "No need for the else clause", "url": "https://github.com/apache/hive/pull/1712#discussion_r535906390", "createdAt": "2020-12-04T08:02:50Z", "author": {"login": "klcopp"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -2877,6 +2877,20 @@ private static String normalizeCase(String s) {\n     return s == null ? null : s.toLowerCase();\n   }\n \n+  private static String normalizePartitionCase(String s) {\n+    if (s == null) {\n+      return null;\n+    } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4c3c059f935df37375b0f2df3574d6bde672d30"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MjU0NDYzOnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODoxMTozMFrOH_FZwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODoxMTozMFrOH_FZwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkxMDg1MA==", "bodyText": "@nareshpr, LGTM, however could you please try to reuse FileUtils.makePartName(List partCols, List vals):\nMap<String, String> map = Splitter.on( \"=\" ).withKeyValueSeparator( Path.SEPARATOR ).split(lc.getPartitionname());\nreturn FileUtils.makePartName(new ArrayList<>(map.keySet()), new ArrayList<>(map.values()));", "url": "https://github.com/apache/hive/pull/1712#discussion_r535910850", "createdAt": "2020-12-04T08:11:30Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -2877,6 +2877,20 @@ private static String normalizeCase(String s) {\n     return s == null ? null : s.toLowerCase();\n   }\n \n+  private static String normalizePartitionCase(String s) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4c3c059f935df37375b0f2df3574d6bde672d30"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 104, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}