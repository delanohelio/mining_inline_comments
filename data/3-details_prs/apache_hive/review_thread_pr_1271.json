{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwODY5NTQ2", "number": 1271, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNTowNToyOFrOEPkinQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNDowNzo0N1rOEhQ8-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0NzYyNzgxOnYy", "diffSide": "RIGHT", "path": "standalone-metastore/metastore-server/pom.xml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNTowNToyOFrOGzWnJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwNzoxMjo0OFrOG1-rig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUwMTAyOQ==", "bodyText": "@kgyrtkirk Is this change okay? I mean we could have used reflection again to call serde classes but it will make code more complex and non-readable.", "url": "https://github.com/apache/hive/pull/1271#discussion_r456501029", "createdAt": "2020-07-17T15:05:28Z", "author": {"login": "shameersss1"}, "path": "standalone-metastore/metastore-server/pom.xml", "diffHunk": "@@ -204,6 +204,11 @@\n       <artifactId>hive-storage-api</artifactId>\n       <version>${storage-api.version}</version>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.hive</groupId>\n+      <artifactId>hive-serde</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6980856ea9600e9c29d38d8000c0f296b16e8aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2NjE3OQ==", "bodyText": "TypeInfo and friends in the metastore...I don't think we want to do it :)\nI don't yet have a concreate idea how to avoid it - because in case we want to evaluate partition values correctly we would need the same stuff we use on the ql side...\ntechnically this dependency means that if we want to move out the metastore - we should also take the serde stuff with it...", "url": "https://github.com/apache/hive/pull/1271#discussion_r458866179", "createdAt": "2020-07-22T15:09:49Z", "author": {"login": "kgyrtkirk"}, "path": "standalone-metastore/metastore-server/pom.xml", "diffHunk": "@@ -204,6 +204,11 @@\n       <artifactId>hive-storage-api</artifactId>\n       <version>${storage-api.version}</version>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.hive</groupId>\n+      <artifactId>hive-serde</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUwMTAyOQ=="}, "originalCommit": {"oid": "d6980856ea9600e9c29d38d8000c0f296b16e8aa"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI1NDY2Ng==", "bodyText": "Fixed!", "url": "https://github.com/apache/hive/pull/1271#discussion_r459254666", "createdAt": "2020-07-23T07:12:48Z", "author": {"login": "shameersss1"}, "path": "standalone-metastore/metastore-server/pom.xml", "diffHunk": "@@ -204,6 +204,11 @@\n       <artifactId>hive-storage-api</artifactId>\n       <version>${storage-api.version}</version>\n     </dependency>\n+    <dependency>\n+      <groupId>org.apache.hive</groupId>\n+      <artifactId>hive-serde</artifactId>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUwMTAyOQ=="}, "originalCommit": {"oid": "d6980856ea9600e9c29d38d8000c0f296b16e8aa"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMzE2MjE3OnYy", "diffSide": "LEFT", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MsckPartitionExpressionProxy.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNDowNzo0N1rOHOe8mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMDowNzo1OFrOHPskxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0OTE0NA==", "bodyText": "I don't know - have you explored using the SA approach ? seeing the ql class thru reflection looks a bit wierd.\nother way around could be to move Expr related classes out from ql (not sure if that's possible)", "url": "https://github.com/apache/hive/pull/1271#discussion_r484949144", "createdAt": "2020-09-08T14:07:47Z", "author": {"login": "kgyrtkirk"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MsckPartitionExpressionProxy.java", "diffHunk": "@@ -1,114 +0,0 @@\n-package org.apache.hadoop.hive.metastore;\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- * <p>\n- * http://www.apache.org/licenses/LICENSE-2.0\n- * <p>\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-import java.nio.charset.StandardCharsets;\n-import java.util.ArrayList;\n-import java.util.HashSet;\n-import java.util.List;\n-import java.util.Set;\n-\n-import org.apache.hadoop.hive.metastore.api.FieldSchema;\n-import org.apache.hadoop.hive.metastore.api.FileMetadataExprType;\n-import org.apache.hadoop.hive.metastore.api.MetaException;\n-import org.apache.hadoop.hive.metastore.utils.FileUtils;\n-import org.apache.hadoop.hive.ql.io.sarg.SearchArgument;\n-import org.apache.hadoop.util.StringUtils;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-// This is added as part of moving MSCK code from ql to standalone-metastore. There is a metastore API to drop\n-// partitions by name but we cannot use it because msck typically will contain partition value (year=2014). We almost\n-// never drop partition by name (year). So we need to construct expression filters, the current\n-// PartitionExpressionProxy implementations (PartitionExpressionForMetastore and HCatClientHMSImpl.ExpressionBuilder)\n-// all depend on ql code to build ExprNodeDesc for the partition expressions. It also depends on kryo for serializing\n-// the expression objects to byte[]. For MSCK drop partition, we don't need complex expression generator. For now,\n-// all we do is split the partition spec (year=2014/month=24) into filter expression year='2014' and month='24' and\n-// rely on metastore database to deal with type conversions. Ideally, PartitionExpressionProxy default implementation\n-// should use SearchArgument (storage-api) to construct the filter expression and not depend on ql, but the usecase\n-// for msck is pretty simple and this specific implementation should suffice.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2d6235d46e73a1966f37d3ef0d87279780b93aa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM0NjE0OQ==", "bodyText": "Hm..hm.. using SARG will complicate a lot i guess and moving ExprNode related classes from ql is not trivial (we could explore this a bit further) but looking at a big picture most of the ExprNode classes is dependent on serde classes since we don't want serde classes in standalone-metastore We should either put the ExprNode related class in some other module or new a new module which both ql and standalone-metastore can use.\nI could think of an another approach even though it is hacky, It solves the purpose. - Since PartitionExpressionForMetastore class is required only during partition pruning step, We can switch back the expression proxy class to MsckPartitionExpressionProxy once the partition pruning step is done. This way we could solve the compatability issue.\n@kgyrtkirk Any thoughts on validity of the above approach?", "url": "https://github.com/apache/hive/pull/1271#discussion_r485346149", "createdAt": "2020-09-09T05:26:13Z", "author": {"login": "shameersss1"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MsckPartitionExpressionProxy.java", "diffHunk": "@@ -1,114 +0,0 @@\n-package org.apache.hadoop.hive.metastore;\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- * <p>\n- * http://www.apache.org/licenses/LICENSE-2.0\n- * <p>\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-import java.nio.charset.StandardCharsets;\n-import java.util.ArrayList;\n-import java.util.HashSet;\n-import java.util.List;\n-import java.util.Set;\n-\n-import org.apache.hadoop.hive.metastore.api.FieldSchema;\n-import org.apache.hadoop.hive.metastore.api.FileMetadataExprType;\n-import org.apache.hadoop.hive.metastore.api.MetaException;\n-import org.apache.hadoop.hive.metastore.utils.FileUtils;\n-import org.apache.hadoop.hive.ql.io.sarg.SearchArgument;\n-import org.apache.hadoop.util.StringUtils;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-// This is added as part of moving MSCK code from ql to standalone-metastore. There is a metastore API to drop\n-// partitions by name but we cannot use it because msck typically will contain partition value (year=2014). We almost\n-// never drop partition by name (year). So we need to construct expression filters, the current\n-// PartitionExpressionProxy implementations (PartitionExpressionForMetastore and HCatClientHMSImpl.ExpressionBuilder)\n-// all depend on ql code to build ExprNodeDesc for the partition expressions. It also depends on kryo for serializing\n-// the expression objects to byte[]. For MSCK drop partition, we don't need complex expression generator. For now,\n-// all we do is split the partition spec (year=2014/month=24) into filter expression year='2014' and month='24' and\n-// rely on metastore database to deal with type conversions. Ideally, PartitionExpressionProxy default implementation\n-// should use SearchArgument (storage-api) to construct the filter expression and not depend on ql, but the usecase\n-// for msck is pretty simple and this specific implementation should suffice.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0OTE0NA=="}, "originalCommit": {"oid": "b2d6235d46e73a1966f37d3ef0d87279780b93aa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5MzQ5NA==", "bodyText": "or another approach could be when we fail to deserizalize the expr bytes with kyro on exception simply try converting byte array to string", "url": "https://github.com/apache/hive/pull/1271#discussion_r485393494", "createdAt": "2020-09-09T07:23:39Z", "author": {"login": "shameersss1"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MsckPartitionExpressionProxy.java", "diffHunk": "@@ -1,114 +0,0 @@\n-package org.apache.hadoop.hive.metastore;\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- * <p>\n- * http://www.apache.org/licenses/LICENSE-2.0\n- * <p>\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-import java.nio.charset.StandardCharsets;\n-import java.util.ArrayList;\n-import java.util.HashSet;\n-import java.util.List;\n-import java.util.Set;\n-\n-import org.apache.hadoop.hive.metastore.api.FieldSchema;\n-import org.apache.hadoop.hive.metastore.api.FileMetadataExprType;\n-import org.apache.hadoop.hive.metastore.api.MetaException;\n-import org.apache.hadoop.hive.metastore.utils.FileUtils;\n-import org.apache.hadoop.hive.ql.io.sarg.SearchArgument;\n-import org.apache.hadoop.util.StringUtils;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-// This is added as part of moving MSCK code from ql to standalone-metastore. There is a metastore API to drop\n-// partitions by name but we cannot use it because msck typically will contain partition value (year=2014). We almost\n-// never drop partition by name (year). So we need to construct expression filters, the current\n-// PartitionExpressionProxy implementations (PartitionExpressionForMetastore and HCatClientHMSImpl.ExpressionBuilder)\n-// all depend on ql code to build ExprNodeDesc for the partition expressions. It also depends on kryo for serializing\n-// the expression objects to byte[]. For MSCK drop partition, we don't need complex expression generator. For now,\n-// all we do is split the partition spec (year=2014/month=24) into filter expression year='2014' and month='24' and\n-// rely on metastore database to deal with type conversions. Ideally, PartitionExpressionProxy default implementation\n-// should use SearchArgument (storage-api) to construct the filter expression and not depend on ql, but the usecase\n-// for msck is pretty simple and this specific implementation should suffice.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0OTE0NA=="}, "originalCommit": {"oid": "b2d6235d46e73a1966f37d3ef0d87279780b93aa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM5Mzg2MA==", "bodyText": "@kgyrtkirk Any thoughts on above two approaches?", "url": "https://github.com/apache/hive/pull/1271#discussion_r485393860", "createdAt": "2020-09-09T07:24:19Z", "author": {"login": "shameersss1"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MsckPartitionExpressionProxy.java", "diffHunk": "@@ -1,114 +0,0 @@\n-package org.apache.hadoop.hive.metastore;\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- * <p>\n- * http://www.apache.org/licenses/LICENSE-2.0\n- * <p>\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-import java.nio.charset.StandardCharsets;\n-import java.util.ArrayList;\n-import java.util.HashSet;\n-import java.util.List;\n-import java.util.Set;\n-\n-import org.apache.hadoop.hive.metastore.api.FieldSchema;\n-import org.apache.hadoop.hive.metastore.api.FileMetadataExprType;\n-import org.apache.hadoop.hive.metastore.api.MetaException;\n-import org.apache.hadoop.hive.metastore.utils.FileUtils;\n-import org.apache.hadoop.hive.ql.io.sarg.SearchArgument;\n-import org.apache.hadoop.util.StringUtils;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-// This is added as part of moving MSCK code from ql to standalone-metastore. There is a metastore API to drop\n-// partitions by name but we cannot use it because msck typically will contain partition value (year=2014). We almost\n-// never drop partition by name (year). So we need to construct expression filters, the current\n-// PartitionExpressionProxy implementations (PartitionExpressionForMetastore and HCatClientHMSImpl.ExpressionBuilder)\n-// all depend on ql code to build ExprNodeDesc for the partition expressions. It also depends on kryo for serializing\n-// the expression objects to byte[]. For MSCK drop partition, we don't need complex expression generator. For now,\n-// all we do is split the partition spec (year=2014/month=24) into filter expression year='2014' and month='24' and\n-// rely on metastore database to deal with type conversions. Ideally, PartitionExpressionProxy default implementation\n-// should use SearchArgument (storage-api) to construct the filter expression and not depend on ql, but the usecase\n-// for msck is pretty simple and this specific implementation should suffice.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0OTE0NA=="}, "originalCommit": {"oid": "b2d6235d46e73a1966f37d3ef0d87279780b93aa"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIyMDk5Ng==", "bodyText": "I have changed the approach, Please take a look at the new implementation.", "url": "https://github.com/apache/hive/pull/1271#discussion_r486220996", "createdAt": "2020-09-10T10:07:58Z", "author": {"login": "shameersss1"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/MsckPartitionExpressionProxy.java", "diffHunk": "@@ -1,114 +0,0 @@\n-package org.apache.hadoop.hive.metastore;\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n- * <p>\n- * http://www.apache.org/licenses/LICENSE-2.0\n- * <p>\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-\n-import java.nio.charset.StandardCharsets;\n-import java.util.ArrayList;\n-import java.util.HashSet;\n-import java.util.List;\n-import java.util.Set;\n-\n-import org.apache.hadoop.hive.metastore.api.FieldSchema;\n-import org.apache.hadoop.hive.metastore.api.FileMetadataExprType;\n-import org.apache.hadoop.hive.metastore.api.MetaException;\n-import org.apache.hadoop.hive.metastore.utils.FileUtils;\n-import org.apache.hadoop.hive.ql.io.sarg.SearchArgument;\n-import org.apache.hadoop.util.StringUtils;\n-import org.slf4j.Logger;\n-import org.slf4j.LoggerFactory;\n-\n-// This is added as part of moving MSCK code from ql to standalone-metastore. There is a metastore API to drop\n-// partitions by name but we cannot use it because msck typically will contain partition value (year=2014). We almost\n-// never drop partition by name (year). So we need to construct expression filters, the current\n-// PartitionExpressionProxy implementations (PartitionExpressionForMetastore and HCatClientHMSImpl.ExpressionBuilder)\n-// all depend on ql code to build ExprNodeDesc for the partition expressions. It also depends on kryo for serializing\n-// the expression objects to byte[]. For MSCK drop partition, we don't need complex expression generator. For now,\n-// all we do is split the partition spec (year=2014/month=24) into filter expression year='2014' and month='24' and\n-// rely on metastore database to deal with type conversions. Ideally, PartitionExpressionProxy default implementation\n-// should use SearchArgument (storage-api) to construct the filter expression and not depend on ql, but the usecase\n-// for msck is pretty simple and this specific implementation should suffice.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk0OTE0NA=="}, "originalCommit": {"oid": "b2d6235d46e73a1966f37d3ef0d87279780b93aa"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 592, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}