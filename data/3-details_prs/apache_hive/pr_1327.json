{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3NjM4NzM2", "number": 1327, "title": "HIVE-23763: Query based minor compaction produces wrong files when ro\u2026", "bodyText": "\u2026ws with different buckets Ids are processed by the same FileSinkOperator\nNOTICE\nPlease create an issue in ASF JIRA before opening a pull request,\nand you need to set the title of the pull request which starts with\nthe corresponding JIRA issue number. (e.g. HIVE-XXXXX: Fix a typo in YYY)\nFor more details, please see https://cwiki.apache.org/confluence/display/Hive/HowToContribute", "createdAt": "2020-07-28T08:21:53Z", "url": "https://github.com/apache/hive/pull/1327", "merged": true, "mergeCommit": {"oid": "98c925c8cb52e410c9aa02a499d2ac15a6d6777b"}, "closed": true, "closedAt": "2020-08-04T10:35:53Z", "author": {"login": "kuczoram"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5R5kfAH2gAyNDU3NjM4NzM2OjdlMTM0ODViY2Q4NDE3YTI4OWY2ZmFjODFiZGExOTdkZjFmNDZkMWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7hfHWAFqTQ2MDU2MTYzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e13485bcd8417a289f6fac81bda197df1f46d1b", "author": {"user": {"login": "kuczoram", "name": null}}, "url": "https://github.com/apache/hive/commit/7e13485bcd8417a289f6fac81bda197df1f46d1b", "committedDate": "2020-07-28T08:11:02Z", "message": "HIVE-23763: Query based minor compaction produces wrong files when rows with different buckets Ids are processed by the same FileSinkOperator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9f07ac6639a7fd652a31b92f708e73d33c3f4c1", "author": {"user": {"login": "kuczoram", "name": null}}, "url": "https://github.com/apache/hive/commit/f9f07ac6639a7fd652a31b92f708e73d33c3f4c1", "committedDate": "2020-07-30T15:40:22Z", "message": "HIVE-23763: Fix the MM compaction tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDE4MjQ2", "url": "https://github.com/apache/hive/pull/1327#pullrequestreview-459018246", "createdAt": "2020-07-31T08:53:54Z", "commit": {"oid": "f9f07ac6639a7fd652a31b92f708e73d33c3f4c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODo1Mzo1NFrOG6BHJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODo1Mzo1NFrOG6BHJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ4ODgwNw==", "bodyText": "Can we leave a comment why are these settings needed?", "url": "https://github.com/apache/hive/pull/1327#discussion_r463488807", "createdAt": "2020-07-31T08:53:54Z", "author": {"login": "pvary"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/txn/compactor/CompactorOnTezTest.java", "diffHunk": "@@ -95,6 +98,10 @@ private void setupTez(HiveConf conf) {\n     conf.set(\"hive.tez.container.size\", \"128\");\n     conf.setBoolean(\"hive.merge.tezfiles\", false);\n     conf.setBoolean(\"hive.in.tez.test\", true);\n+    if (!mmCompaction) {\n+      conf.set(\"tez.grouping.max-size\", \"1024\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9f07ac6639a7fd652a31b92f708e73d33c3f4c1"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDE4OTkx", "url": "https://github.com/apache/hive/pull/1327#pullrequestreview-459018991", "createdAt": "2020-07-31T08:55:02Z", "commit": {"oid": "f9f07ac6639a7fd652a31b92f708e73d33c3f4c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODo1NTowMlrOG6BJhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODo1NTowMlrOG6BJhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ4OTQxNA==", "bodyText": "Could we leave a comment with the expected file structure?", "url": "https://github.com/apache/hive/pull/1327#discussion_r463489414", "createdAt": "2020-07-31T08:55:02Z", "author": {"login": "pvary"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/txn/compactor/CompactorOnTezTest.java", "diffHunk": "@@ -217,6 +224,64 @@ void insertTestData(String dbName, String tblName) throws Exception {\n       executeStatementOnDriver(\"delete from \" + tblName + \" where a = '1'\", driver);\n     }\n \n+    void createTableWithoutBucketWithMultipleSplits(String dbName, String tblName, String tempTblName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9f07ac6639a7fd652a31b92f708e73d33c3f4c1"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDIwMjg5", "url": "https://github.com/apache/hive/pull/1327#pullrequestreview-459020289", "createdAt": "2020-07-31T08:57:05Z", "commit": {"oid": "f9f07ac6639a7fd652a31b92f708e73d33c3f4c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODo1NzowNlrOG6BNgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODo1NzowNlrOG6BNgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ5MDQzNA==", "bodyText": "I have seen issues with queries using virtual columns (INPUT__FILE__NAME, ROW__ID). The row number in the results were different with and without the virtual columns. - This is just a note, maybe no action is needed here", "url": "https://github.com/apache/hive/pull/1327#discussion_r463490434", "createdAt": "2020-07-31T08:57:06Z", "author": {"login": "pvary"}, "path": "itests/hive-unit/src/test/java/org/apache/hadoop/hive/ql/txn/compactor/CompactorOnTezTest.java", "diffHunk": "@@ -261,22 +326,77 @@ protected void insertMmTestData(String tblName, int iterations) throws Exception\n     }\n \n     List<String> getAllData(String tblName) throws Exception {\n-      return getAllData(null, tblName);\n+      return getAllData(null, tblName, false);\n     }\n \n-    List<String> getAllData(String dbName, String tblName) throws Exception {\n+    List<String> getAllData(String tblName, boolean withRowId) throws Exception {\n+      return getAllData(null, tblName, withRowId);\n+    }\n+\n+    List<String> getAllData(String dbName, String tblName, boolean withRowId) throws Exception {\n       if (dbName != null) {\n         tblName = dbName + \".\" + tblName;\n       }\n-      List<String> result = executeStatementOnDriverAndReturnResults(\"select * from \" + tblName, driver);\n+      StringBuffer query = new StringBuffer();\n+      query.append(\"select \");\n+      if (withRowId) {\n+        query.append(\"ROW__ID, \");\n+      }\n+      query.append(\"* from \");\n+      query.append(tblName);\n+      List<String> result = executeStatementOnDriverAndReturnResults(query.toString(), driver);\n       Collections.sort(result);\n       return result;\n     }\n \n+    List<String> getDataWithInputFileNames(String dbName, String tblName) throws Exception {\n+      if (dbName != null) {\n+        tblName = dbName + \".\" + tblName;\n+      }\n+      StringBuffer query = new StringBuffer();\n+      query.append(\"select \");\n+      query.append(\"INPUT__FILE__NAME, a from \");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9f07ac6639a7fd652a31b92f708e73d33c3f4c1"}, "originalPosition": 129}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDIxODAw", "url": "https://github.com/apache/hive/pull/1327#pullrequestreview-459021800", "createdAt": "2020-07-31T08:59:25Z", "commit": {"oid": "f9f07ac6639a7fd652a31b92f708e73d33c3f4c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODo1OToyNlrOG6BSDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODo1OToyNlrOG6BSDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ5MTU5OA==", "bodyText": "Are the results in order? Can we close writers for old buckets? That could save memory", "url": "https://github.com/apache/hive/pull/1327#discussion_r463491598", "createdAt": "2020-07-31T08:59:26Z", "author": {"login": "pvary"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/exec/FileSinkOperator.java", "diffHunk": "@@ -1063,7 +1076,11 @@ public void process(Object row, int tag) throws HiveException {\n       // RecordUpdater expects to get the actual row, not a serialized version of it.  Thus we\n       // pass the row rather than recordValue.\n       if (conf.getWriteType() == AcidUtils.Operation.NOT_ACID || conf.isMmTable() || conf.isCompactionTable()) {\n-        rowOutWriters[findWriterOffset(row)].write(recordValue);\n+        writerOffset = bucketId;\n+        if (!conf.isCompactionTable()) {\n+          writerOffset = findWriterOffset(row);\n+        }\n+        rowOutWriters[writerOffset].write(recordValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9f07ac6639a7fd652a31b92f708e73d33c3f4c1"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDIyMzk3", "url": "https://github.com/apache/hive/pull/1327#pullrequestreview-459022397", "createdAt": "2020-07-31T09:00:20Z", "commit": {"oid": "f9f07ac6639a7fd652a31b92f708e73d33c3f4c1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOTowMDoyMFrOG6BUBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwOTowMDoyMFrOG6BUBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ5MjEwMw==", "bodyText": "Can we leave a comment why this settings are needed?", "url": "https://github.com/apache/hive/pull/1327#discussion_r463492103", "createdAt": "2020-07-31T09:00:20Z", "author": {"login": "pvary"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/QueryCompactor.java", "diffHunk": "@@ -115,6 +115,10 @@ void runCompactionQueries(HiveConf conf, String tmpTableName, StorageDescriptor\n       }\n       for (String query : compactionQueries) {\n         LOG.info(\"Running {} compaction via query: {}\", compactionInfo.isMajorCompaction() ? \"major\" : \"minor\", query);\n+        if (!compactionInfo.isMajorCompaction()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9f07ac6639a7fd652a31b92f708e73d33c3f4c1"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "707ae82cef2c6568cda535d0080847ef7de69e07", "author": {"user": {"login": "kuczoram", "name": null}}, "url": "https://github.com/apache/hive/commit/707ae82cef2c6568cda535d0080847ef7de69e07", "committedDate": "2020-08-03T16:12:29Z", "message": "HIVE-23763: Address the review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTYxNjM3", "url": "https://github.com/apache/hive/pull/1327#pullrequestreview-460561637", "createdAt": "2020-08-04T07:28:29Z", "commit": {"oid": "707ae82cef2c6568cda535d0080847ef7de69e07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3365, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}