{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwODMwMDEx", "number": 1186, "title": "HIVE-23768: Metastore's update service wrongly strips partition column stats from the cache", "bodyText": "", "createdAt": "2020-06-27T00:01:11Z", "url": "https://github.com/apache/hive/pull/1186", "merged": true, "mergeCommit": {"oid": "03efbb3db1bbccfd3548fa7fa3f130be081e1cdd"}, "closed": true, "closedAt": "2020-07-02T17:07:23Z", "author": {"login": "zabetak"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvMSwMAH2gAyNDQwODMwMDExOmUzOGNmYzU5MDUyNDZhMDZhNmViODliZjAxNWRlYzU0ZmY0NGU0ZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwdsWQAFqTQ0MDQzODA4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e38cfc5905246a06a6eb89bf015dec54ff44e4dd", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/e38cfc5905246a06a6eb89bf015dec54ff44e4dd", "committedDate": "2020-06-26T23:59:52Z", "message": "HIVE-23768: Add unit test in TestCachedStore reproducing the missing partition column stats problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03d26d95d1c17247d5a5ad6448bfe180c136655a", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/03d26d95d1c17247d5a5ad6448bfe180c136655a", "committedDate": "2020-06-26T23:59:52Z", "message": "HIVE-23768: Remove partition update from updateTablePartitionColStats in CachedStore\n\nUsing alterPartitionInCache is problematic:\n1. It empties all relevant stats about partitions even those updated just now.\n2. It is not necessary since partitions were updated/refreshed just before calling the method updateTablePartitionColStats."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8520356539ec6a84bbffa1e6a8dc260e4fa00da4", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/8520356539ec6a84bbffa1e6a8dc260e4fa00da4", "committedDate": "2020-06-26T23:59:52Z", "message": "HIVE-23768: Remove table update from updateTableColStats in CachedStore\n\nSame as before alterTableInCache is not necessary since the table is refreshed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff20976a0337007ae9ccefdea7fe498e83676eba", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/ff20976a0337007ae9ccefdea7fe498e83676eba", "committedDate": "2020-06-26T23:59:52Z", "message": "HIVE-23768: Remove unused code in TestCachedStore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6793c82da21901f42c877ceeb322672f1d9f1c97", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/6793c82da21901f42c877ceeb322672f1d9f1c97", "committedDate": "2020-06-26T23:59:52Z", "message": "HIVE-23768: Refactor createTable method in TestCachedStore\n\n1. Inline a few variables.\n2. Use empty map instead of new hash map.\n3. Hardcode owner for all tables."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/ccfc6d94538d49d8bb56f5767ace5fc0132e322f", "committedDate": "2020-06-26T23:59:52Z", "message": "HIVE-23768: Add TODO in CachedStore#mergeColStatsForPartitions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzM2MjA2", "url": "https://github.com/apache/hive/pull/1186#pullrequestreview-439736206", "createdAt": "2020-06-30T07:22:00Z", "commit": {"oid": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNzoyMjowMFrOGqvGNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNzoyMzoyNVrOGqvJdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTAxNA==", "bodyText": "Sorry, I am bit confused looking at this diff. So, the original issue seems to be - \"Metastore's update service wrongly strips partition column stats from the cache in an attempt to update them.\" . How are we fixing this issue by not updating the stats in the cache ? Wouldn't the right fix for this is to to ensure sharedCache.alterTableInCache and sharedCache.alterPartitionInCache methods do the right thing and not incorrectly remove partition column stats ?", "url": "https://github.com/apache/hive/pull/1186#discussion_r447465014", "createdAt": "2020-06-30T07:22:00Z", "author": {"login": "kishendas"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -851,8 +851,6 @@ private void updateTableColStats(RawStore rawStore, String catName, String dbNam\n             sharedCache.refreshTableColStatsInCache(StringUtils.normalizeIdentifier(catName),\n                 StringUtils.normalizeIdentifier(dbName), StringUtils.normalizeIdentifier(tblName),\n                 tableColStats.getStatsObj());\n-            // Update the table to get consistent stats state.\n-            sharedCache.alterTableInCache(catName, dbName, tblName, table);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTUyMg==", "bodyText": "Same concern here as previous. How do we fix this issue by not updating the cache at all ?", "url": "https://github.com/apache/hive/pull/1186#discussion_r447465522", "createdAt": "2020-06-30T07:22:50Z", "author": {"login": "kishendas"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -900,13 +898,6 @@ private void updateTablePartitionColStats(RawStore rawStore, String catName, Str\n               rawStore.getPartitionColumnStatistics(catName, dbName, tblName, partNames, colNames, CacheUtils.HIVE_ENGINE);\n           Deadline.stopTimer();\n           sharedCache.refreshPartitionColStatsInCache(catName, dbName, tblName, partitionColStats);\n-          Deadline.startTimer(\"getPartitionsByNames\");\n-          List<Partition> parts = rawStore.getPartitionsByNames(catName, dbName, tblName, partNames);\n-          Deadline.stopTimer();\n-          // Also save partitions for consistency as they have the stats state.\n-          for (Partition part : parts) {\n-            sharedCache.alterPartitionInCache(catName, dbName, tblName, part.getValues(), part);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ2NTg0Nw==", "bodyText": "Please create a JIRA for this TODO and add a reference in the comment.", "url": "https://github.com/apache/hive/pull/1186#discussion_r447465847", "createdAt": "2020-06-30T07:23:25Z", "author": {"login": "kishendas"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -2264,6 +2255,8 @@ private MergedColumnStatsForPartitions mergeColStatsForPartitions(String catName\n       if (colStatsMap.size() < 1) {\n         LOG.debug(\"No stats data found for: dbName={} tblName= {} partNames= {} colNames= \", dbName, tblName, partNames,\n             colNames);\n+        // TODO: If we don't find any stats then most likely we should return null. Returning an empty object will not\n+        // trigger the lookup in the raw store and we will end up with missing stats.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMzkzNzk2", "url": "https://github.com/apache/hive/pull/1186#pullrequestreview-440393796", "createdAt": "2020-06-30T21:19:15Z", "commit": {"oid": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMToxOToxNVrOGrO3Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMToxOToxNVrOGrO3Hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NTQzOQ==", "bodyText": "Why is this change required ? I think in the test case, it's preferable to explicitly add drop statements , so that we know what's going on.", "url": "https://github.com/apache/hive/pull/1186#discussion_r447985439", "createdAt": "2020-06-30T21:19:15Z", "author": {"login": "kishendas"}, "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/cache/TestCachedStore.java", "diffHunk": "@@ -136,17 +129,19 @@\n     MetaStoreTestUtils.setConfForStandloneMode(conf);\n     ObjectStore objectStore = new ObjectStore();\n     objectStore.setConf(conf);\n-    objectStore.dropTable(DEFAULT_CATALOG_NAME, db1Utbl1.getDbName(), db1Utbl1.getTableName());\n-    Deadline.startTimer(\"\");\n-    objectStore.dropPartitions(DEFAULT_CATALOG_NAME, db1Ptbl1.getDbName(), db1Ptbl1.getTableName(), db1Ptbl1PtnNames);\n-    objectStore.dropTable(DEFAULT_CATALOG_NAME, db1Ptbl1.getDbName(), db1Ptbl1.getTableName());\n-    objectStore.dropTable(DEFAULT_CATALOG_NAME, db2Utbl1.getDbName(), db2Utbl1.getTableName());\n-    Deadline.startTimer(\"\");\n-    objectStore.dropPartitions(DEFAULT_CATALOG_NAME, db2Ptbl1.getDbName(), db2Ptbl1.getTableName(), db2Ptbl1PtnNames);\n-    objectStore.dropTable(DEFAULT_CATALOG_NAME, db2Ptbl1.getDbName(), db2Ptbl1.getTableName());\n-    objectStore.dropDatabase(DEFAULT_CATALOG_NAME, db1.getName());\n-    objectStore.dropDatabase(DEFAULT_CATALOG_NAME, db2.getName());\n+    for (String clg : objectStore.getCatalogs()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMzk1OTU1", "url": "https://github.com/apache/hive/pull/1186#pullrequestreview-440395955", "createdAt": "2020-06-30T21:22:49Z", "commit": {"oid": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMToyMjo0OVrOGrO9rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQyMToyMjo0OVrOGrO9rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk4NzExNw==", "bodyText": "Why is this test case being removed ?", "url": "https://github.com/apache/hive/pull/1186#discussion_r447987117", "createdAt": "2020-06-30T21:22:49Z", "author": {"login": "kishendas"}, "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/cache/TestCachedStore.java", "diffHunk": "@@ -1566,160 +1643,6 @@ private Table createUnpartitionedTableObject(Database db) {\n     return tbl;\n   }\n \n-  private TableAndColStats createUnpartitionedTableObjectWithColStats(Database db) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f"}, "originalPosition": 227}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwNDM4MDgz", "url": "https://github.com/apache/hive/pull/1186#pullrequestreview-440438083", "createdAt": "2020-06-30T22:50:08Z", "commit": {"oid": "ccfc6d94538d49d8bb56f5767ace5fc0132e322f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3717, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}