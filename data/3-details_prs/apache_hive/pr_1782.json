{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMTYxNTAw", "number": 1782, "title": "HIVE-24434: Filter out materialized views for rewriting if plan pattern is not allowed", "bodyText": "What changes were proposed in this pull request?\n\nStore the scope of each materialized view in the cache/registry. It specifies whether the MV can be used in both Calcite and Sql text based query rewrites or Sql text based only.\nScope value is calculated when the MV definition is parsed during adding the MV to the Registry.\n\nWhy are the changes needed?\nNumber of Materialized views added to the Calcite based rewrite planner affects query compilation performance. Too much view definition increases the planning time without any benefit. There are plan patterns which are not supported by the planner. MV having such patterns in its definition can be filtered out before even added to the planner.\nDoes this PR introduce any user-facing change?\nNo.\nHow was this patch tested?\nmvn test -DskipSparkTests -Dtest=TestMiniLlapLocalCliDriver -Dqfile=materialized_view_rewrite_11.q -pl itests/qtest -Pitests", "createdAt": "2020-12-15T10:57:45Z", "url": "https://github.com/apache/hive/pull/1782", "merged": true, "mergeCommit": {"oid": "9c4c54cdebc85be110e39588b9b5a42d3ac2ace2"}, "closed": true, "closedAt": "2021-01-04T16:48:13Z", "author": {"login": "kasakrisz"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmczBrABqjQxMTU0NDI5Mjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABds4qzEAFqTU2MTE1MTE0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3dd328706d09e90ef95441871c66634ee4eddb3d", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/3dd328706d09e90ef95441871c66634ee4eddb3d", "committedDate": "2020-12-15T10:46:12Z", "message": "HIVE-24434: Filter out materialized views for rewriting if plan pattern is not allowed"}, "afterCommit": {"oid": "4762427b245b6dbd866560804915f077227937fd", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/4762427b245b6dbd866560804915f077227937fd", "committedDate": "2020-12-15T16:11:45Z", "message": "add licence header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MDA3MTkz", "url": "https://github.com/apache/hive/pull/1782#pullrequestreview-558007193", "createdAt": "2020-12-23T15:54:34Z", "commit": {"oid": "4762427b245b6dbd866560804915f077227937fd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNTo1NDozNVrOIKoz3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QyMTowMzoyNVrOIK1olQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODAyNTMwOA==", "bodyText": "nit. Import to avoid using fully-qualified class name here?", "url": "https://github.com/apache/hive/pull/1782#discussion_r548025308", "createdAt": "2020-12-23T15:54:35Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java", "diffHunk": "@@ -1831,7 +1832,8 @@ public RelOptMaterialization getMaterializedViewForRebuild(String dbName, String\n \n   private List<RelOptMaterialization> getValidMaterializedViews(List<Table> materializedViewTables,\n       List<String> tablesUsed, boolean forceMVContentsUpToDate, boolean expandGroupingSets,\n-      HiveTxnManager txnMgr) throws HiveException {\n+      HiveTxnManager txnMgr, EnumSet<org.apache.hadoop.hive.ql.metadata.Materialization.RewriteAlgorithm> scope)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4762427b245b6dbd866560804915f077227937fd"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODIyNjg3MA==", "bodyText": "Should this class extend RelOptMaterialization rather than wrapping it? I think it would make sense since we may extend it with other properties in the future and may be convenient to be accessible anywhere in Calcite code.", "url": "https://github.com/apache/hive/pull/1782#discussion_r548226870", "createdAt": "2020-12-23T20:50:56Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Materialization.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.metadata;\n+\n+import org.apache.calcite.plan.RelOptMaterialization;\n+\n+import java.util.EnumSet;\n+\n+import static org.apache.commons.collections.CollectionUtils.intersection;\n+\n+/**\n+ * Wrapper class of {@link RelOptMaterialization} and corresponding flags.\n+ */\n+public class Materialization {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4762427b245b6dbd866560804915f077227937fd"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODIzNTQxMw==", "bodyText": "nit. null -> Null", "url": "https://github.com/apache/hive/pull/1782#discussion_r548235413", "createdAt": "2020-12-23T21:03:25Z", "author": {"login": "jcamachor"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/CBOPlan.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.parse;\n+\n+import org.apache.calcite.rel.RelNode;\n+\n+/**\n+ * Wrapper of Calcite plan.\n+ */\n+public class CBOPlan {\n+  private final RelNode plan;\n+  private final String invalidAutomaticRewritingMaterializationReason;\n+\n+  public CBOPlan(RelNode plan, String invalidAutomaticRewritingMaterializationReason) {\n+    this.plan = plan;\n+    this.invalidAutomaticRewritingMaterializationReason = invalidAutomaticRewritingMaterializationReason;\n+  }\n+\n+  /**\n+   * Root node of plan.\n+   * @return Root {@link RelNode}\n+   */\n+  public RelNode getPlan() {\n+    return plan;\n+  }\n+\n+  /**\n+   * Returns an error message if this plan can not be a definition of a Materialized view which is an input of\n+   * Calcite based materialized view query rewrite.\n+   * null or empty string otherwise.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4762427b245b6dbd866560804915f077227937fd"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46ad10fcf2bb698c5b1cf298767c2bd74d3f1f13", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/46ad10fcf2bb698c5b1cf298767c2bd74d3f1f13", "committedDate": "2021-01-04T02:41:43Z", "message": "HIVE-24434: Filter out materialized views for rewriting if plan pattern is not allowed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b42752936e3b909dad43c693f914fec97f4d8808", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/b42752936e3b909dad43c693f914fec97f4d8808", "committedDate": "2021-01-04T02:41:43Z", "message": "add licence header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4936c2b3b4c59429a4aa9975fb863ad4ef1e662", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/d4936c2b3b4c59429a4aa9975fb863ad4ef1e662", "committedDate": "2021-01-04T03:45:26Z", "message": "instead of wrap extend RelOptMaterialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df5bdac13b37ab1439ceaebe0961462a5da51aa6", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/df5bdac13b37ab1439ceaebe0961462a5da51aa6", "committedDate": "2021-01-04T03:47:58Z", "message": "fix comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4762427b245b6dbd866560804915f077227937fd", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/4762427b245b6dbd866560804915f077227937fd", "committedDate": "2020-12-15T16:11:45Z", "message": "add licence header"}, "afterCommit": {"oid": "df5bdac13b37ab1439ceaebe0961462a5da51aa6", "author": {"user": {"login": "kasakrisz", "name": "Krisztian Kasa"}}, "url": "https://github.com/apache/hive/commit/df5bdac13b37ab1439ceaebe0961462a5da51aa6", "committedDate": "2021-01-04T03:47:58Z", "message": "fix comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxMTUxMTQ2", "url": "https://github.com/apache/hive/pull/1782#pullrequestreview-561151146", "createdAt": "2021-01-04T16:11:20Z", "commit": {"oid": "df5bdac13b37ab1439ceaebe0961462a5da51aa6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2925, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}