{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3MTc4NDQy", "number": 1705, "title": "HIVE-24426. Spark job fails with fixed LlapTaskUmbilicalServer port.", "bodyText": "https://issues.apache.org/jira/browse/HIVE-24426", "createdAt": "2020-11-25T06:05:39Z", "url": "https://github.com/apache/hive/pull/1705", "merged": true, "mergeCommit": {"oid": "c636bdfb5714aa442db168e8f268b51263c6f3cd"}, "closed": true, "closedAt": "2020-12-01T07:13:19Z", "author": {"login": "ayushtkn"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdf3z-NAH2gAyNTI3MTc4NDQyOjhiZWRiYjJhMzY1MDIwOTQxNmQ4OTBkNjU3OWY4NTQ4ZjAxYTI4NGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhqHtPAH2gAyNTI3MTc4NDQyOjE0ZTJkYWNkZmU1ZGM1NWNlMDZmM2U5OGU1NTU1ODVlN2I3OGQ5MjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8bedbb2a3650209416d890d6579f8548f01a284a", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/hive/commit/8bedbb2a3650209416d890d6579f8548f01a284a", "committedDate": "2020-11-25T05:50:26Z", "message": "HIVE-24426. Spark job fails with fixed LlapTaskUmbilicalServer port."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/hive/commit/3a786c0f6e1d34c1e636698439c7572bbf607ff0", "committedDate": "2020-11-27T15:25:52Z", "message": "Retrigger Build."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNjczODE5", "url": "https://github.com/apache/hive/pull/1705#pullrequestreview-540673819", "createdAt": "2020-11-30T08:11:46Z", "commit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxMTo0N1rOH7vuNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODoxNToyNVrOH7v1Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQwOTkxMA==", "bodyText": "can you use RangeValidator from HiveConf and make sure the min is 1024 and max is 65535 which is the port range for user space ports.", "url": "https://github.com/apache/hive/pull/1705#discussion_r532409910", "createdAt": "2020-11-30T08:11:47Z", "author": {"login": "prasanthj"}, "path": "llap-client/src/java/org/apache/hadoop/hive/llap/tezplugins/helpers/LlapTaskUmbilicalServer.java", "diffHunk": "@@ -54,27 +56,54 @@\n \n   public LlapTaskUmbilicalServer(Configuration conf, LlapTaskUmbilicalProtocol umbilical, int numHandlers) throws IOException {\n     jobTokenSecretManager = new JobTokenSecretManager();\n-    int umbilicalPort = HiveConf.getIntVar(conf, HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT);\n-    if (umbilicalPort <= 0) {\n-      umbilicalPort = 0;\n+\n+    String[] portRange =\n+        conf.get(HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT.varname)\n+            .split(\"-\");\n+\n+    int minPort = Integer.parseInt(portRange[0]);\n+    boolean portFound = false;\n+    IOException e = null;\n+    if (portRange.length == 1) {\n+      // Single port specified, not Range.\n+      startServer(conf, umbilical, numHandlers, minPort);\n+      portFound = true;\n+    } else {\n+      int maxPort = Integer.parseInt(portRange[1]);\n+      for (int i = minPort; i < maxPort; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMDM1MQ==", "bodyText": "Log at warn level to say which port is being tried and what error message received for debugging.", "url": "https://github.com/apache/hive/pull/1705#discussion_r532410351", "createdAt": "2020-11-30T08:12:45Z", "author": {"login": "prasanthj"}, "path": "llap-client/src/java/org/apache/hadoop/hive/llap/tezplugins/helpers/LlapTaskUmbilicalServer.java", "diffHunk": "@@ -54,27 +56,54 @@\n \n   public LlapTaskUmbilicalServer(Configuration conf, LlapTaskUmbilicalProtocol umbilical, int numHandlers) throws IOException {\n     jobTokenSecretManager = new JobTokenSecretManager();\n-    int umbilicalPort = HiveConf.getIntVar(conf, HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT);\n-    if (umbilicalPort <= 0) {\n-      umbilicalPort = 0;\n+\n+    String[] portRange =\n+        conf.get(HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT.varname)\n+            .split(\"-\");\n+\n+    int minPort = Integer.parseInt(portRange[0]);\n+    boolean portFound = false;\n+    IOException e = null;\n+    if (portRange.length == 1) {\n+      // Single port specified, not Range.\n+      startServer(conf, umbilical, numHandlers, minPort);\n+      portFound = true;\n+    } else {\n+      int maxPort = Integer.parseInt(portRange[1]);\n+      for (int i = minPort; i < maxPort; i++) {\n+        try {\n+          startServer(conf, umbilical, numHandlers, i);\n+          portFound = true;\n+          break;\n+        } catch (BindException be) {\n+          // Ignore and move ahead, in search of a free port.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMDgwMw==", "bodyText": "nit: you could move this to a private variable instead of searching conf object every time (now that startServer is in a loop)", "url": "https://github.com/apache/hive/pull/1705#discussion_r532410803", "createdAt": "2020-11-30T08:13:39Z", "author": {"login": "prasanthj"}, "path": "llap-client/src/java/org/apache/hadoop/hive/llap/tezplugins/helpers/LlapTaskUmbilicalServer.java", "diffHunk": "@@ -54,27 +56,54 @@\n \n   public LlapTaskUmbilicalServer(Configuration conf, LlapTaskUmbilicalProtocol umbilical, int numHandlers) throws IOException {\n     jobTokenSecretManager = new JobTokenSecretManager();\n-    int umbilicalPort = HiveConf.getIntVar(conf, HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT);\n-    if (umbilicalPort <= 0) {\n-      umbilicalPort = 0;\n+\n+    String[] portRange =\n+        conf.get(HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT.varname)\n+            .split(\"-\");\n+\n+    int minPort = Integer.parseInt(portRange[0]);\n+    boolean portFound = false;\n+    IOException e = null;\n+    if (portRange.length == 1) {\n+      // Single port specified, not Range.\n+      startServer(conf, umbilical, numHandlers, minPort);\n+      portFound = true;\n+    } else {\n+      int maxPort = Integer.parseInt(portRange[1]);\n+      for (int i = minPort; i < maxPort; i++) {\n+        try {\n+          startServer(conf, umbilical, numHandlers, i);\n+          portFound = true;\n+          break;\n+        } catch (BindException be) {\n+          // Ignore and move ahead, in search of a free port.\n+          e = be;\n+        }\n+      }\n     }\n-    server = new RPC.Builder(conf)\n-        .setProtocol(LlapTaskUmbilicalProtocol.class)\n-        .setBindAddress(\"0.0.0.0\")\n-        .setPort(umbilicalPort)\n-        .setInstance(umbilical)\n-        .setNumHandlers(numHandlers)\n-        .setSecretManager(jobTokenSecretManager).build();\n-\n-    if (conf.getBoolean(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHORIZATION, false)) {\n-      server.refreshServiceAcl(conf, new LlapUmbilicalExternalPolicyProvider());\n+    if (!portFound) {\n+      throw e;\n     }\n \n-    server.start();\n     this.address = NetUtils.getConnectAddress(server);\n     LOG.info(\n         \"Started TaskUmbilicalServer: \" + umbilical.getClass().getName() + \" at address: \" + address +\n-        \" with numHandlers=\" + numHandlers);\n+            \" with numHandlers=\" + numHandlers);\n+  }\n+\n+  private void startServer(Configuration conf,\n+      LlapTaskUmbilicalProtocol umbilical, int numHandlers, int port)\n+      throws IOException {\n+    server = new RPC.Builder(conf).setProtocol(LlapTaskUmbilicalProtocol.class)\n+        .setBindAddress(\"0.0.0.0\").setPort(port).setInstance(umbilical)\n+        .setNumHandlers(numHandlers).setSecretManager(jobTokenSecretManager)\n+        .build();\n+    if (conf\n+        .getBoolean(CommonConfigurationKeysPublic.HADOOP_SECURITY_AUTHORIZATION,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMTIzMg==", "bodyText": "add what the min and max values for the range can be (1024 - 65535)", "url": "https://github.com/apache/hive/pull/1705#discussion_r532411232", "createdAt": "2020-11-30T08:14:29Z", "author": {"login": "prasanthj"}, "path": "common/src/java/org/apache/hadoop/hive/conf/HiveConf.java", "diffHunk": "@@ -4917,8 +4917,9 @@ private static void populateLlapDaemonVarsSet(Set<String> llapDaemonVarsSetLocal\n       \"Sleep duration (in milliseconds) to wait before retrying on error when obtaining a\\n\" +\n       \"connection to LLAP daemon from Tez AM.\",\n       \"llap.task.communicator.connection.sleep-between-retries-millis\"),\n-    LLAP_TASK_UMBILICAL_SERVER_PORT(\"hive.llap.daemon.umbilical.port\", 0,\n-      \"LLAP task umbilical server RPC port\"),\n+    LLAP_TASK_UMBILICAL_SERVER_PORT(\"hive.llap.daemon.umbilical.port\", \"0\",\n+      \"LLAP task umbilical server RPC port or range of ports to try in case \"\n+          + \"the first port is occupied\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMTMzNw==", "bodyText": "same here for logging", "url": "https://github.com/apache/hive/pull/1705#discussion_r532411337", "createdAt": "2020-11-30T08:14:45Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskCommunicator.java", "diffHunk": "@@ -257,23 +259,32 @@ protected void startRpcServer() {\n \n       int numHandlers =\n           HiveConf.getIntVar(conf, ConfVars.LLAP_TASK_COMMUNICATOR_LISTENER_THREAD_COUNT);\n-      int umbilicalPort = HiveConf.getIntVar(conf, ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT);\n-      if (umbilicalPort <= 0) {\n-        umbilicalPort = 0;\n+      String[] portRange =\n+          conf.get(HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT.varname)\n+              .split(\"-\");\n+      boolean portFound = false;\n+      IOException ioe = null;\n+      int minPort = Integer.parseInt(portRange[0]);\n+      if (portRange.length == 1) {\n+        // Single port specified, not range.\n+        startServerInternal(conf, minPort, numHandlers, jobTokenSecretManager);\n+        portFound = true;\n+      } else {\n+        int maxPort = Integer.parseInt(portRange[1]);\n+        for (int i = minPort; i < maxPort; i++) {\n+          try {\n+            startServerInternal(conf, i, numHandlers, jobTokenSecretManager);\n+            portFound = true;\n+            break;\n+          } catch (BindException be) {\n+            // Ignore and move ahead, in search of a free port.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMTQ1Nw==", "bodyText": "same here (use RangeValidator)", "url": "https://github.com/apache/hive/pull/1705#discussion_r532411457", "createdAt": "2020-11-30T08:14:58Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskCommunicator.java", "diffHunk": "@@ -257,23 +259,32 @@ protected void startRpcServer() {\n \n       int numHandlers =\n           HiveConf.getIntVar(conf, ConfVars.LLAP_TASK_COMMUNICATOR_LISTENER_THREAD_COUNT);\n-      int umbilicalPort = HiveConf.getIntVar(conf, ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT);\n-      if (umbilicalPort <= 0) {\n-        umbilicalPort = 0;\n+      String[] portRange =\n+          conf.get(HiveConf.ConfVars.LLAP_TASK_UMBILICAL_SERVER_PORT.varname)\n+              .split(\"-\");\n+      boolean portFound = false;\n+      IOException ioe = null;\n+      int minPort = Integer.parseInt(portRange[0]);\n+      if (portRange.length == 1) {\n+        // Single port specified, not range.\n+        startServerInternal(conf, minPort, numHandlers, jobTokenSecretManager);\n+        portFound = true;\n+      } else {\n+        int maxPort = Integer.parseInt(portRange[1]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQxMTY4Ng==", "bodyText": "nit: same here to move this to private variable.", "url": "https://github.com/apache/hive/pull/1705#discussion_r532411686", "createdAt": "2020-11-30T08:15:25Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskCommunicator.java", "diffHunk": "@@ -283,6 +294,23 @@ protected void startRpcServer() {\n     }\n   }\n \n+  private void startServerInternal(Configuration conf, int umbilicalPort,\n+      int numHandlers, JobTokenSecretManager jobTokenSecretManager)\n+      throws IOException {\n+    server = new RPC.Builder(conf).setProtocol(LlapTaskUmbilicalProtocol.class)\n+        .setBindAddress(\"0.0.0.0\").setPort(umbilicalPort).setInstance(umbilical)\n+        .setNumHandlers(numHandlers).setSecretManager(jobTokenSecretManager)\n+        .build();\n+\n+    if (conf", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a786c0f6e1d34c1e636698439c7572bbf607ff0"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee9bea2b87927b397dbfa7336f23dc501953a35e", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/hive/commit/ee9bea2b87927b397dbfa7336f23dc501953a35e", "committedDate": "2020-11-30T10:27:57Z", "message": "Handle Review Comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwODkwMTg3", "url": "https://github.com/apache/hive/pull/1705#pullrequestreview-540890187", "createdAt": "2020-11-30T13:07:24Z", "commit": {"oid": "ee9bea2b87927b397dbfa7336f23dc501953a35e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b0fa7a89c09885f78b582189a65d7151dbecf72", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/hive/commit/0b0fa7a89c09885f78b582189a65d7151dbecf72", "committedDate": "2020-11-30T13:12:02Z", "message": "Added Success Log Message."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14e2dacdfe5dc55ce06f3e98e555585e7b78d925", "author": {"user": {"login": "ayushtkn", "name": "Ayush Saxena"}}, "url": "https://github.com/apache/hive/commit/14e2dacdfe5dc55ce06f3e98e555585e7b78d925", "committedDate": "2020-11-30T19:01:10Z", "message": "Retrigger build."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3077, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}