{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyODM2Mzgx", "number": 1428, "title": "HIVE-24068: Add re-execution plugin for handling DAG submission and unmanaged AM failures", "bodyText": "What changes were proposed in this pull request?\nDAG submission failure can also happen in environments where AM container died causing DNS issues. DAG submissions are safe to retry as the DAG hasn't started execution yet. There are retries at getSession and submitDAG level individually but some submitDAG failure has to retry getSession as well as AM could be unreachable, this can be handled in re-execution plugin. This PR adds a new re-execution plugin for intermittent DAG submission failures.\nWhy are the changes needed?\nTo make hive resilient to environments with network/DNS issues.\nDoes this PR introduce any user-facing change?\nYes. Adds the re-exec plugin as default option.\nHow was this patch tested?\nManually. Tez code was changed to explicitly throw UnknownHostException to simulate DNS/network issue and tested to make sure retry happens.", "createdAt": "2020-08-24T23:23:37Z", "url": "https://github.com/apache/hive/pull/1428", "merged": true, "mergeCommit": {"oid": "cd4154e9b0979c9a52f2e10fe358b496567cd8f7"}, "closed": true, "closedAt": "2020-08-26T17:47:51Z", "author": {"login": "prasanthj"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCLHn7AH2gAyNDcyODM2MzgxOjVhM2ZhYTFmYTQ1MTJiMWNkZGI0NmUxNWExYjY0OWZiYzQxMjgwYjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCaOKUgH2gAyNDcyODM2MzgxOmQyZGNlNGY2Njg3YTJiOWY5ZDFkYTJlZjcwN2M0NDUxMGM1NTI5M2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a3faa1fa4512b1cddb46e15a1b649fbc41280b7", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/5a3faa1fa4512b1cddb46e15a1b649fbc41280b7", "committedDate": "2020-08-24T23:22:22Z", "message": "HIVE-24068: Add re-execution plugin for handling DAG submission failures"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MjE1NjQ2", "url": "https://github.com/apache/hive/pull/1428#pullrequestreview-474215646", "createdAt": "2020-08-25T07:43:07Z", "commit": {"oid": "5a3faa1fa4512b1cddb46e15a1b649fbc41280b7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwNzo0MzowN1rOHGLjqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwNzo0MzowN1rOHGLjqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI0Mjg1Ng==", "bodyText": "I think this explanation could be moved into the class documentation", "url": "https://github.com/apache/hive/pull/1428#discussion_r476242856", "createdAt": "2020-08-25T07:43:07Z", "author": {"login": "kgyrtkirk"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/reexec/ReExecutionDagSubmitPlugin.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.ql.reexec;\n+\n+import org.apache.hadoop.hive.ql.Driver;\n+import org.apache.hadoop.hive.ql.hooks.ExecuteWithHookContext;\n+import org.apache.hadoop.hive.ql.hooks.HookContext;\n+import org.apache.hadoop.hive.ql.hooks.HookContext.HookType;\n+import org.apache.hadoop.hive.ql.plan.mapper.PlanMapper;\n+import org.apache.hadoop.hive.ql.processors.CommandProcessorException;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Re-Executes a query when DAG submission fails after get session returned successfully.\n+ */\n+public class ReExecutionDagSubmitPlugin implements IReExecutionPlugin {\n+\n+  private static final Logger LOG = LoggerFactory.getLogger(ReExecutionDagSubmitPlugin.class);\n+  class LocalHook implements ExecuteWithHookContext {\n+\n+    @Override\n+    public void run(HookContext hookContext) throws Exception {\n+      if (hookContext.getHookType() == HookType.ON_FAILURE_HOOK) {\n+        Throwable exception = hookContext.getException();\n+        if (exception != null) {\n+          if (exception.getMessage() != null) {\n+            // there could be race condition where getSession could return a healthy AM but by the time DAG is submitted\n+            // the AM could become unhealthy/unreachable (possible DNS or network issues) which can fail tez DAG\n+            // submission. Since the DAG hasn't started execution yet this failure can be safely restarted.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a3faa1fa4512b1cddb46e15a1b649fbc41280b7"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00f71ff9ac20ad39774512e9e90e788a9bcea5f9", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/00f71ff9ac20ad39774512e9e90e788a9bcea5f9", "committedDate": "2020-08-25T16:56:31Z", "message": "addressed Zoltan's code review comments. Added unmanaged AM failure to lost AM query plugin."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2dce4f6687a2b9f9d1da2ef707c44510c55293c", "author": {"user": null}, "url": "https://github.com/apache/hive/commit/d2dce4f6687a2b9f9d1da2ef707c44510c55293c", "committedDate": "2020-08-25T16:58:05Z", "message": "fix comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3240, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}