{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczMTE1OTA4", "number": 1431, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzozODoxNlrOEcLQxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzo0Mzo1NlrOEcLYeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3OTgwMTAxOnYy", "diffSide": "RIGHT", "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskSchedulerService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzozODoxNlrOHGi4TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzozODoxNlrOHGi4TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNDk3Mg==", "bodyText": "nit: to differentiate node vs cluster, rename this to isClusterCapacityFull?", "url": "https://github.com/apache/hive/pull/1431#discussion_r476624972", "createdAt": "2020-08-25T17:38:16Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskSchedulerService.java", "diffHunk": "@@ -251,6 +251,7 @@ public void setError(Void v, Throwable t) {\n \n   private final Lock scheduleLock = new ReentrantLock();\n   private final Condition scheduleCondition = scheduleLock.newCondition();\n+  private final AtomicBoolean isCapacityFull = new AtomicBoolean(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3afd9c81db76c140a635a950b8e3e39c01f4a7b5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3OTgwODE4OnYy", "diffSide": "RIGHT", "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskSchedulerService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzo0MDoxNVrOHGi8vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzo0MDoxNVrOHGi8vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNjExMA==", "bodyText": "the condition seems to have flipped here. is this expected?", "url": "https://github.com/apache/hive/pull/1431#discussion_r476626110", "createdAt": "2020-08-25T17:40:15Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskSchedulerService.java", "diffHunk": "@@ -1390,7 +1395,7 @@ private SelectHostResult selectHost(TaskInfo request) {\n       boolean shouldDelayForLocality = request.shouldDelayForLocality(schedulerAttemptTime);\n       LOG.debug(\"ShouldDelayForLocality={} for task={} on hosts={}\", shouldDelayForLocality,\n           request.task, requestedHostsDebugStr);\n-      if (requestedHosts != null && requestedHosts.length > 0) {\n+      if (!isRequestedHostPresent(request)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3afd9c81db76c140a635a950b8e3e39c01f4a7b5"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3OTgxMjMxOnYy", "diffSide": "RIGHT", "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskSchedulerService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzo0MTozMFrOHGi_cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzo0MTozMFrOHGi_cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyNjgwMg==", "bodyText": "isCapacityFull can be set to false in else condition here? instead of trySchedulingPendingTasks.. just a minor readability improvement..", "url": "https://github.com/apache/hive/pull/1431#discussion_r476626802", "createdAt": "2020-08-25T17:41:30Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskSchedulerService.java", "diffHunk": "@@ -1487,6 +1492,14 @@ private SelectHostResult selectHost(TaskInfo request) {\n         return SELECT_HOST_RESULT_DELAYED_RESOURCES;\n       }\n \n+      // When all nodes are busy, reset locality delay\n+      if (activeNodesWithFreeSlots.isEmpty()) {\n+        isCapacityFull.set(true);\n+        if (request.localityDelayTimeout > 0 && isRequestedHostPresent(request)) {\n+          request.resetLocalityDelayInfo();\n+        }\n+      }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3afd9c81db76c140a635a950b8e3e39c01f4a7b5"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3OTgyMDcyOnYy", "diffSide": "RIGHT", "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskSchedulerService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzo0Mzo1NlrOHGjEzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxNzo0Mzo1NlrOHGjEzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYyODE3NQ==", "bodyText": "This can be outer if condition? only if cluster capacity is available run the task iterator.", "url": "https://github.com/apache/hive/pull/1431#discussion_r476628175", "createdAt": "2020-08-25T17:43:56Z", "author": {"login": "prasanthj"}, "path": "llap-tez/src/java/org/apache/hadoop/hive/llap/tezplugins/LlapTaskSchedulerService.java", "diffHunk": "@@ -1817,8 +1830,10 @@ protected void schedulePendingTasks() throws InterruptedException {\n         Iterator<TaskInfo> taskIter = taskListAtPriority.iterator();\n         boolean scheduledAllAtPriority = true;\n         while (taskIter.hasNext()) {\n-          // TODO Optimization: Add a check to see if there's any capacity available. No point in\n-          // walking through all active nodes, if they don't have potential capacity.\n+          // Early exit where there are no slots available\n+          if (isCapacityFull.get()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3afd9c81db76c140a635a950b8e3e39c01f4a7b5"}, "originalPosition": 50}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 380, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}