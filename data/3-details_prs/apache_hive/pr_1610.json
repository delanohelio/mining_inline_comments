{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5NTYyMDE1", "number": 1610, "title": "HIVE-24259: [CachedStore] Optimise get all constraint api", "bodyText": "What changes were proposed in this pull request?\n\n\nRedundant check if table is present or not\nCurrently in order to get all constraint form the cachedstore. 6 different call is made with in the cached store. Which led to 6 different call to raw store\n\nWhy are the changes needed?\n\n\nCheck only once if table exit in cached store.\nInstead of calling individual constraint in cached store. Add a method which return all constraint at once and if data is not consistent then fall back to rawstore.\n\nDoes this PR introduce any user-facing change?\n\nNo\nHow was this patch tested?\n\nrunning all UTs", "createdAt": "2020-10-25T09:19:49Z", "url": "https://github.com/apache/hive/pull/1610", "merged": true, "mergeCommit": {"oid": "300cc9c6d16ca7587c65db52da19ef1d8fae10a1"}, "closed": true, "closedAt": "2021-02-22T04:36:58Z", "author": {"login": "ashish-kumar-sharma"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdV8PKxgBqjM5MTc2MTkwMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd8WAsxABqjQzNTY1NDM0ODY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "228d3f7d02ab6a8dbc08c3b749ec28f178749d7e", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/228d3f7d02ab6a8dbc08c3b749ec28f178749d7e", "committedDate": "2020-10-16T12:13:13Z", "message": "First commit"}, "afterCommit": {"oid": "55eea4be1843fe2e6d61c926d22ccadcfe8a5f1d", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/55eea4be1843fe2e6d61c926d22ccadcfe8a5f1d", "committedDate": "2020-10-25T09:18:22Z", "message": "First commit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "55eea4be1843fe2e6d61c926d22ccadcfe8a5f1d", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/55eea4be1843fe2e6d61c926d22ccadcfe8a5f1d", "committedDate": "2020-10-25T09:18:22Z", "message": "First commit"}, "afterCommit": {"oid": "7ae4031e8b6da4027665bf35b3c4c13b881f02ea", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/7ae4031e8b6da4027665bf35b3c4c13b881f02ea", "committedDate": "2020-10-25T12:45:09Z", "message": "HIVE-24259: [CachedStore] Optimise getAlltableConstraint from 6 cache call to 1 cache call"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODI0MTMz", "url": "https://github.com/apache/hive/pull/1610#pullrequestreview-516824133", "createdAt": "2020-10-26T14:19:31Z", "commit": {"oid": "7ae4031e8b6da4027665bf35b3c4c13b881f02ea"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDoxOTozMlrOHoRtxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxNDoxOTozMlrOHoRtxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5NTMzNQ==", "bodyText": "Majority of the calls are likely to be redirected to RawStore and lose the advantage of cache. How about an optional flag in SQLAllTableConstraints and TableWrapper to mark if it is a complete snapshot of constraints?", "url": "https://github.com/apache/hive/pull/1610#discussion_r511995335", "createdAt": "2020-10-26T14:19:32Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -2836,14 +2836,32 @@ long getPartsFound() {\n   @Override\n   public SQLAllTableConstraints getAllTableConstraints(String catName, String dbName, String tblName)\n       throws MetaException, NoSuchObjectException {\n-    SQLAllTableConstraints sqlAllTableConstraints = new SQLAllTableConstraints();\n-    sqlAllTableConstraints.setPrimaryKeys(getPrimaryKeys(catName, dbName, tblName));\n-    sqlAllTableConstraints.setForeignKeys(getForeignKeys(catName, null, null, dbName, tblName));\n-    sqlAllTableConstraints.setUniqueConstraints(getUniqueConstraints(catName, dbName, tblName));\n-    sqlAllTableConstraints.setDefaultConstraints(getDefaultConstraints(catName, dbName, tblName));\n-    sqlAllTableConstraints.setCheckConstraints(getCheckConstraints(catName, dbName, tblName));\n-    sqlAllTableConstraints.setNotNullConstraints(getNotNullConstraints(catName, dbName, tblName));\n-    return sqlAllTableConstraints;\n+\n+    catName = StringUtils.normalizeIdentifier(catName);\n+    dbName = StringUtils.normalizeIdentifier(dbName);\n+    tblName = StringUtils.normalizeIdentifier(tblName);\n+    if (!shouldCacheTable(catName, dbName, tblName) || (canUseEvents && rawStore.isActiveTransaction())) {\n+      return rawStore.getAllTableConstraints(catName, dbName, tblName);\n+    }\n+\n+    Table tbl = sharedCache.getTableFromCache(catName, dbName, tblName);\n+    if (tbl == null) {\n+      // The table containing the constraints is not yet loaded in cache\n+      return rawStore.getAllTableConstraints(catName, dbName, tblName);\n+    }\n+    SQLAllTableConstraints constraints = sharedCache.listCachedAllTableConstraints(catName, dbName, tblName);\n+\n+    // if any of the constraint value is missing then there might be the case of partial constraints are stored in cached.\n+    // So fall back to raw store for correct values\n+    if (constraints != null && CollectionUtils.isNotEmpty(constraints.getPrimaryKeys()) && CollectionUtils", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ae4031e8b6da4027665bf35b3c4c13b881f02ea"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzQxMjQ1", "url": "https://github.com/apache/hive/pull/1610#pullrequestreview-526341245", "createdAt": "2020-11-09T14:59:56Z", "commit": {"oid": "eea2fa7506907337b81becb277f71879a0d05fdd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDo1OTo1N1rOHvy0LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNTowNTo0NVrOHvzExg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3NzY3Ng==", "bodyText": "keys with null is accessed at line 2413", "url": "https://github.com/apache/hive/pull/1610#discussion_r519877676", "createdAt": "2020-11-09T14:59:57Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/SharedCache.java", "diffHunk": "@@ -2397,7 +2397,7 @@ public SQLAllTableConstraints listCachedAllTableConstraints(String catName, Stri\n \n   public List<SQLForeignKey> listCachedForeignKeys(String catName, String foreignDbName, String foreignTblName,\n                                                    String parentDbName, String parentTblName) {\n-    List<SQLForeignKey> keys = new ArrayList<>();\n+    List<SQLForeignKey> keys = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eea2fa7506907337b81becb277f71879a0d05fdd"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3OTg3MA==", "bodyText": "Add a TODO that this check is inefficient as all calls will hit rawstore if even one of the constraint type is not set for the given table.", "url": "https://github.com/apache/hive/pull/1610#discussion_r519879870", "createdAt": "2020-11-09T15:02:55Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -2844,15 +2814,10 @@ public SQLAllTableConstraints getAllTableConstraints(String catName, String dbNa\n       return rawStore.getAllTableConstraints(catName, dbName, tblName);\n     }\n \n-    Table tbl = sharedCache.getTableFromCache(catName, dbName, tblName);\n-    if (tbl == null) {\n-      // The table containing the constraints is not yet loaded in cache\n-      return rawStore.getAllTableConstraints(catName, dbName, tblName);\n-    }\n     SQLAllTableConstraints constraints = sharedCache.listCachedAllTableConstraints(catName, dbName, tblName);\n \n-    // if any of the constraint value is missing then there might be the case of partial constraints are stored in cached.\n-    // So fall back to raw store for correct values\n+    /* If constraint value is missing then there might be the case that table is not stored in cached or", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eea2fa7506907337b81becb277f71879a0d05fdd"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg4MTkyNg==", "bodyText": "Why is it hard to set a flag for consistency? If we hit else flow in this case, we shall try to update the cache and if that fails for some reason, then set the flag to false else set to true. Same with pre-warm and refresh flows.\nAlso, we need to check only the flag to validate the consistency of cache. No need to check for null or empty constraints.", "url": "https://github.com/apache/hive/pull/1610#discussion_r519881926", "createdAt": "2020-11-09T15:05:45Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -2836,14 +2836,32 @@ long getPartsFound() {\n   @Override\n   public SQLAllTableConstraints getAllTableConstraints(String catName, String dbName, String tblName)\n       throws MetaException, NoSuchObjectException {\n-    SQLAllTableConstraints sqlAllTableConstraints = new SQLAllTableConstraints();\n-    sqlAllTableConstraints.setPrimaryKeys(getPrimaryKeys(catName, dbName, tblName));\n-    sqlAllTableConstraints.setForeignKeys(getForeignKeys(catName, null, null, dbName, tblName));\n-    sqlAllTableConstraints.setUniqueConstraints(getUniqueConstraints(catName, dbName, tblName));\n-    sqlAllTableConstraints.setDefaultConstraints(getDefaultConstraints(catName, dbName, tblName));\n-    sqlAllTableConstraints.setCheckConstraints(getCheckConstraints(catName, dbName, tblName));\n-    sqlAllTableConstraints.setNotNullConstraints(getNotNullConstraints(catName, dbName, tblName));\n-    return sqlAllTableConstraints;\n+\n+    catName = StringUtils.normalizeIdentifier(catName);\n+    dbName = StringUtils.normalizeIdentifier(dbName);\n+    tblName = StringUtils.normalizeIdentifier(tblName);\n+    if (!shouldCacheTable(catName, dbName, tblName) || (canUseEvents && rawStore.isActiveTransaction())) {\n+      return rawStore.getAllTableConstraints(catName, dbName, tblName);\n+    }\n+\n+    Table tbl = sharedCache.getTableFromCache(catName, dbName, tblName);\n+    if (tbl == null) {\n+      // The table containing the constraints is not yet loaded in cache\n+      return rawStore.getAllTableConstraints(catName, dbName, tblName);\n+    }\n+    SQLAllTableConstraints constraints = sharedCache.listCachedAllTableConstraints(catName, dbName, tblName);\n+\n+    // if any of the constraint value is missing then there might be the case of partial constraints are stored in cached.\n+    // So fall back to raw store for correct values\n+    if (constraints != null && CollectionUtils.isNotEmpty(constraints.getPrimaryKeys()) && CollectionUtils", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk5NTMzNQ=="}, "originalCommit": {"oid": "7ae4031e8b6da4027665bf35b3c4c13b881f02ea"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzc2NTM1", "url": "https://github.com/apache/hive/pull/1610#pullrequestreview-540376535", "createdAt": "2020-11-28T13:47:13Z", "commit": {"oid": "7e75fa6db9962fffa1900c6bf2a84d9481ff48ab"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQxMzo0NzoxM1rOH7ZRXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQxNDoxNzoyNVrOH7ZdIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA0MjA3OQ==", "bodyText": "Keep one member per line to be more readable.", "url": "https://github.com/apache/hive/pull/1610#discussion_r532042079", "createdAt": "2020-11-28T13:47:13Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/SharedCache.java", "diffHunk": "@@ -134,17 +134,8 @@ public int getPosition() {\n     }\n   }\n \n-  private enum MemberName {\n-    TABLE_COL_STATS_CACHE,\n-    PARTITION_CACHE,\n-    PARTITION_COL_STATS_CACHE,\n-    AGGR_COL_STATS_CACHE,\n-    PRIMARY_KEY_CACHE,\n-    FOREIGN_KEY_CACHE,\n-    NOTNULL_CONSTRAINT_CACHE,\n-    UNIQUE_CONSTRAINT_CACHE,\n-    DEFAULT_CONSTRAINT_CACHE,\n-    CHECK_CONSTRAINT_CACHE\n+  public enum MemberName {\n+    TABLE_COL_STATS_CACHE, PARTITION_CACHE, PARTITION_COL_STATS_CACHE, AGGR_COL_STATS_CACHE, PRIMARY_KEY_CACHE, FOREIGN_KEY_CACHE, NOTNULL_CONSTRAINT_CACHE, UNIQUE_CONSTRAINT_CACHE, DEFAULT_CONSTRAINT_CACHE, CHECK_CONSTRAINT_CACHE, ALL_TABLE_CONSTRAINT", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e75fa6db9962fffa1900c6bf2a84d9481ff48ab"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA0NTA5MA==", "bodyText": "Using too many flags is complex. Check if we can simplify it using below logic.\n\nFetch all constraints and update cache -> If this update is successful, then set \"isAllConstraintsSet=true\"\nIf partially successful due to memory constraint, then set \"isAllConstraintsSet=false\" and set bit position of completed constraint \"long constraintStatusBits\". We can assign one bit per constraintType and generally in the order in which we update it. It means, if we encounter a bit which is unset, then rest of the bits are unset too.\nWe never refresh individual constraints. Always try to update all constraints by using same method which follow above logic to set the flag. Shall remove all individual update(CachedStore.updateTablePrimaryKeys...) and refresh(SharedCache.refreshPrimaryKeysInCache...) methods for each types. This ensure, we always cache a valid snapshot.\nWhen read any constraint, first check isAllConstraintsSet==true. If true, then assume all are valid and return the cached entry immediately. If false, then just the corresponding bit in \"constraintStatusBits\" and if true, then return the cached entry or else return null and invoke RawStore.\n\nNote: We can also get rid of isAllConstraintsSet flag by using constraintStatusBits = -1 for \"true\" scenario.", "url": "https://github.com/apache/hive/pull/1610#discussion_r532045090", "createdAt": "2020-11-28T14:17:25Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/SharedCache.java", "diffHunk": "@@ -309,12 +302,19 @@ public int getObjectSize(Class<?> clazz, Object obj) {\n     private Map<String, SQLDefaultConstraint> defaultConstraintCache = new ConcurrentHashMap<>();\n     private Map<String, SQLCheckConstraint> checkConstraintCache = new ConcurrentHashMap<>();\n \n+    private boolean pk = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e75fa6db9962fffa1900c6bf2a84d9481ff48ab"}, "originalPosition": 56}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7e75fa6db9962fffa1900c6bf2a84d9481ff48ab", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/7e75fa6db9962fffa1900c6bf2a84d9481ff48ab", "committedDate": "2020-11-26T12:41:53Z", "message": "code reformat"}, "afterCommit": {"oid": "a6c3bda00b7fdace0840e3f2e01495c46f57f970", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/a6c3bda00b7fdace0840e3f2e01495c46f57f970", "committedDate": "2021-01-29T09:22:01Z", "message": "code reformat"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg1NjYwODIx", "url": "https://github.com/apache/hive/pull/1610#pullrequestreview-585660821", "createdAt": "2021-02-08T16:07:09Z", "commit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wOFQxNjowNzoxMFrOIhqYRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wOFQxNjoyMDoxNFrOIhq_8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjE2ODI2MQ==", "bodyText": "There is a separate api for createTableWithConstraints.\nIs this api also used when table is created with constraints?", "url": "https://github.com/apache/hive/pull/1610#discussion_r572168261", "createdAt": "2021-02-08T16:07:10Z", "author": {"login": "adesh-rao"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -1325,6 +1204,7 @@ private void validateTableType(Table tbl) {\n     }\n     validateTableType(tbl);\n     sharedCache.addTableToCache(catName, dbName, tblName, tbl);\n+    sharedCache.addTableConstraintsToCache(catName,dbName,tblName,new SQLAllTableConstraints());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "originalPosition": 184}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjE3MjI3OQ==", "bodyText": "nit: need extra spaces before case?", "url": "https://github.com/apache/hive/pull/1610#discussion_r572172279", "createdAt": "2021-02-08T16:12:18Z", "author": {"login": "adesh-rao"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/SharedCache.java", "diffHunk": "@@ -418,12 +424,12 @@ private void updateMemberSize(MemberName mn, Integer size, SizeMode mode) {\n       }\n \n       switch (mode) {\n-        case Delta:\n-          this.memberObjectsSize[mn.ordinal()] += size;\n-          break;\n-        case Snapshot:\n-          this.memberObjectsSize[mn.ordinal()] = size;\n-          break;\n+      case Delta:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjE3ODQxNg==", "bodyText": "below check was present earlier:\nif (CollectionUtils.isEmpty(keys)) {\t\n      return rawStore.getCheckConstraints(catName, dbName, tblName);\t\n}\n\nWhy is this removed? Is this check moved somewhere else?", "url": "https://github.com/apache/hive/pull/1610#discussion_r572178416", "createdAt": "2021-02-08T16:20:14Z", "author": {"login": "adesh-rao"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -2814,21 +2649,12 @@ long getPartsFound() {\n     catName = StringUtils.normalizeIdentifier(catName);\n     dbName = StringUtils.normalizeIdentifier(dbName);\n     tblName = StringUtils.normalizeIdentifier(tblName);\n-    if (!shouldCacheTable(catName, dbName, tblName) || (canUseEvents && rawStore.isActiveTransaction())) {\n+    if (!shouldCacheTable(catName, dbName, tblName) || (canUseEvents && rawStore.isActiveTransaction()) || !sharedCache\n+        .isTableConstraintValid(catName, dbName, tblName)) {\n       return rawStore.getCheckConstraints(catName, dbName, tblName);\n     }\n+    return sharedCache.listCachedCheckConstraint(catName, dbName, tblName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "originalPosition": 332}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg4MzAwMjI1", "url": "https://github.com/apache/hive/pull/1610#pullrequestreview-588300225", "createdAt": "2021-02-11T07:47:04Z", "commit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xMVQwNzo0NzowNFrOIjsZzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xMVQwODoyNDoxMFrOIjtdXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDI5ODU3NQ==", "bodyText": "nit: Add space after comma.", "url": "https://github.com/apache/hive/pull/1610#discussion_r574298575", "createdAt": "2021-02-11T07:47:04Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -1325,6 +1204,7 @@ private void validateTableType(Table tbl) {\n     }\n     validateTableType(tbl);\n     sharedCache.addTableToCache(catName, dbName, tblName, tbl);\n+    sharedCache.addTableConstraintsToCache(catName,dbName,tblName,new SQLAllTableConstraints());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "originalPosition": 184}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDMwMjg2NQ==", "bodyText": "This method never returns false. It means, isConstraintsValid flag is always true. Is it by design? If yes, when it will be false?", "url": "https://github.com/apache/hive/pull/1610#discussion_r574302865", "createdAt": "2021-02-11T07:56:31Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/SharedCache.java", "diffHunk": "@@ -506,10 +512,18 @@ boolean cacheCheckConstraints(List<SQLCheckConstraint> checkConstraints, boolean\n       return cacheConstraints(checkConstraints, fromPrewarm, MemberName.CHECK_CONSTRAINT_CACHE);\n     }\n \n+    boolean cacheConstraints(SQLAllTableConstraints constraints, boolean fromPrewarm) {\n+      this.isConstraintsValid =\n+          cacheConstraints(constraints.getPrimaryKeys(), fromPrewarm, MemberName.PRIMARY_KEY_CACHE) && cacheConstraints(\n+              constraints.getForeignKeys(), fromPrewarm, MemberName.FOREIGN_KEY_CACHE) && cacheConstraints(constraints.getDefaultConstraints(), fromPrewarm, MemberName.DEFAULT_CONSTRAINT_CACHE)\n+              && cacheConstraints(constraints.getUniqueConstraints(), fromPrewarm, MemberName.UNIQUE_CONSTRAINT_CACHE)\n+              && cacheConstraints(constraints.getNotNullConstraints(), fromPrewarm, MemberName.NOTNULL_CONSTRAINT_CACHE)\n+              && cacheConstraints(constraints.getCheckConstraints(), fromPrewarm, MemberName.CHECK_CONSTRAINT_CACHE);\n+      return this.isConstraintsValid;\n+    }\n+\n     // Common method to cache constraints\n-    private boolean cacheConstraints(List constraintsList,\n-                             boolean fromPrewarm,\n-                             MemberName mn) {\n+    private boolean cacheConstraints(List constraintsList, boolean fromPrewarm, MemberName mn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDMwNDY4MQ==", "bodyText": "This also always returns true and in tune make isConstraintsValid=true always.", "url": "https://github.com/apache/hive/pull/1610#discussion_r574304681", "createdAt": "2021-02-11T08:00:33Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/SharedCache.java", "diffHunk": "@@ -715,154 +747,105 @@ public void removeConstraint(String name) {\n       }\n     }\n \n-    public void refreshPrimaryKeys(List<SQLPrimaryKey> keys) {\n-      Map<String, SQLPrimaryKey> newKeys = new ConcurrentHashMap<>();\n+    public void refreshAllTableConstraints(SQLAllTableConstraints constraints) {\n       try {\n         tableLock.writeLock().lock();\n-        int size = 0;\n-        for (SQLPrimaryKey key : keys) {\n-          if (compareAndSetMemberCacheUpdated(MemberName.PRIMARY_KEY_CACHE, true, false)) {\n-            LOG.debug(\"Skipping primary key cache update for table: \" + getTable().getTableName()\n-                    + \"; the primary keys are already refreshed.\");\n-            return;\n-          }\n-          String pkName = StringUtils.normalizeIdentifier(key.getPk_name());\n-          key.setPk_name(pkName);\n-          newKeys.put(pkName, key);\n-          size += getObjectSize(SQLPrimaryKey.class, key);\n-        }\n-        primaryKeyCache = newKeys;\n-        updateMemberSize(MemberName.PRIMARY_KEY_CACHE, size, SizeMode.Snapshot);\n-        LOG.debug(\"Primary keys refresh in cache was successful for {}.{}.{}\",\n-            this.getTable().getCatName(), this.getTable().getDbName(), this.getTable().getTableName());\n+        this.isConstraintsValid =\n+            refreshConstraint(constraints.getPrimaryKeys(), MemberName.PRIMARY_KEY_CACHE) && refreshConstraint(\n+                constraints.getForeignKeys(), MemberName.FOREIGN_KEY_CACHE) && refreshConstraint(\n+                constraints.getUniqueConstraints(), MemberName.UNIQUE_CONSTRAINT_CACHE) && refreshConstraint(\n+                constraints.getDefaultConstraints(), MemberName.DEFAULT_CONSTRAINT_CACHE) && refreshConstraint(\n+                constraints.getNotNullConstraints(), MemberName.NOTNULL_CONSTRAINT_CACHE) && refreshConstraint(\n+                constraints.getCheckConstraints(), MemberName.CHECK_CONSTRAINT_CACHE);\n       } finally {\n         tableLock.writeLock().unlock();\n       }\n     }\n \n-    public void refreshForeignKeys(List<SQLForeignKey> keys) {\n-      Map<String, SQLForeignKey> newKeys = new ConcurrentHashMap<>();\n-      try {\n-        tableLock.writeLock().lock();\n-        int size = 0;\n-        for (SQLForeignKey key : keys) {\n-          if (compareAndSetMemberCacheUpdated(MemberName.FOREIGN_KEY_CACHE, true, false)) {\n-            LOG.debug(\"Skipping foreign key cache update for table: \" + getTable().getTableName()\n-                    + \"; the foreign keys are already refreshed.\");\n-            return;\n+    private boolean refreshConstraint(List constraints, MemberName mn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDMwNTE3MA==", "bodyText": "nit: Space before  ( and after comma", "url": "https://github.com/apache/hive/pull/1610#discussion_r574305170", "createdAt": "2021-02-11T08:01:39Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/SharedCache.java", "diffHunk": "@@ -1788,47 +1771,16 @@ public boolean populateTableInCache(Table table, TableCacheObjects cacheObjects)\n     tblWrapper.setMemberCacheUpdated(MemberName.PARTITION_COL_STATS_CACHE, false);\n     tblWrapper.setMemberCacheUpdated(MemberName.AGGR_COL_STATS_CACHE, false);\n \n-    if (CollectionUtils.isNotEmpty(constraints.getPrimaryKeys())) {\n-      if (!tblWrapper.cachePrimaryKeys(constraints.getPrimaryKeys(), true)) {\n-        return false;\n-      }\n-    }\n-    tblWrapper.setMemberCacheUpdated(MemberName.PRIMARY_KEY_CACHE, false);\n-\n-    if (CollectionUtils.isNotEmpty(constraints.getForeignKeys())) {\n-      if (!tblWrapper.cacheForeignKeys(constraints.getForeignKeys(), true)) {\n-        return false;\n-      }\n-    }\n-    tblWrapper.setMemberCacheUpdated(MemberName.FOREIGN_KEY_CACHE, false);\n-\n-    if (CollectionUtils.isNotEmpty(constraints.getNotNullConstraints())) {\n-      if (!tblWrapper.cacheNotNullConstraints(constraints.getNotNullConstraints(), true)) {\n-        return false;\n-      }\n-    }\n-    tblWrapper.setMemberCacheUpdated(MemberName.NOTNULL_CONSTRAINT_CACHE, false);\n-\n-    if (CollectionUtils.isNotEmpty(constraints.getUniqueConstraints())) {\n-      if (!tblWrapper.cacheUniqueConstraints(constraints.getUniqueConstraints(), true)) {\n-        return false;\n-      }\n-    }\n-    tblWrapper.setMemberCacheUpdated(MemberName.UNIQUE_CONSTRAINT_CACHE, false);\n-\n-    if (CollectionUtils.isNotEmpty(constraints.getDefaultConstraints())) {\n-      if (!tblWrapper.cacheDefaultConstraints(constraints.getDefaultConstraints(), true)) {\n-        return false;\n-      }\n-    }\n-    tblWrapper.setMemberCacheUpdated(MemberName.DEFAULT_CONSTRAINT_CACHE, false);\n-\n-    if (CollectionUtils.isNotEmpty(constraints.getCheckConstraints())) {\n-      if (!tblWrapper.cacheCheckConstraints(constraints.getCheckConstraints(), true)) {\n-        return false;\n-      }\n+    if(tblWrapper.cacheConstraints(constraints,true)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "originalPosition": 399}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDMxMjYzNQ==", "bodyText": "Why do we set this flag to false?", "url": "https://github.com/apache/hive/pull/1610#discussion_r574312635", "createdAt": "2021-02-11T08:17:42Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/SharedCache.java", "diffHunk": "@@ -715,154 +747,105 @@ public void removeConstraint(String name) {\n       }\n     }\n \n-    public void refreshPrimaryKeys(List<SQLPrimaryKey> keys) {\n-      Map<String, SQLPrimaryKey> newKeys = new ConcurrentHashMap<>();\n+    public void refreshAllTableConstraints(SQLAllTableConstraints constraints) {\n       try {\n         tableLock.writeLock().lock();\n-        int size = 0;\n-        for (SQLPrimaryKey key : keys) {\n-          if (compareAndSetMemberCacheUpdated(MemberName.PRIMARY_KEY_CACHE, true, false)) {\n-            LOG.debug(\"Skipping primary key cache update for table: \" + getTable().getTableName()\n-                    + \"; the primary keys are already refreshed.\");\n-            return;\n-          }\n-          String pkName = StringUtils.normalizeIdentifier(key.getPk_name());\n-          key.setPk_name(pkName);\n-          newKeys.put(pkName, key);\n-          size += getObjectSize(SQLPrimaryKey.class, key);\n-        }\n-        primaryKeyCache = newKeys;\n-        updateMemberSize(MemberName.PRIMARY_KEY_CACHE, size, SizeMode.Snapshot);\n-        LOG.debug(\"Primary keys refresh in cache was successful for {}.{}.{}\",\n-            this.getTable().getCatName(), this.getTable().getDbName(), this.getTable().getTableName());\n+        this.isConstraintsValid =\n+            refreshConstraint(constraints.getPrimaryKeys(), MemberName.PRIMARY_KEY_CACHE) && refreshConstraint(\n+                constraints.getForeignKeys(), MemberName.FOREIGN_KEY_CACHE) && refreshConstraint(\n+                constraints.getUniqueConstraints(), MemberName.UNIQUE_CONSTRAINT_CACHE) && refreshConstraint(\n+                constraints.getDefaultConstraints(), MemberName.DEFAULT_CONSTRAINT_CACHE) && refreshConstraint(\n+                constraints.getNotNullConstraints(), MemberName.NOTNULL_CONSTRAINT_CACHE) && refreshConstraint(\n+                constraints.getCheckConstraints(), MemberName.CHECK_CONSTRAINT_CACHE);\n       } finally {\n         tableLock.writeLock().unlock();\n       }\n     }\n \n-    public void refreshForeignKeys(List<SQLForeignKey> keys) {\n-      Map<String, SQLForeignKey> newKeys = new ConcurrentHashMap<>();\n-      try {\n-        tableLock.writeLock().lock();\n-        int size = 0;\n-        for (SQLForeignKey key : keys) {\n-          if (compareAndSetMemberCacheUpdated(MemberName.FOREIGN_KEY_CACHE, true, false)) {\n-            LOG.debug(\"Skipping foreign key cache update for table: \" + getTable().getTableName()\n-                    + \"; the foreign keys are already refreshed.\");\n-            return;\n+    private boolean refreshConstraint(List constraints, MemberName mn) {\n+      int size = 0;\n+      switch (mn) {\n+      case PRIMARY_KEY_CACHE:\n+        Map<String, SQLPrimaryKey> newPk = new ConcurrentHashMap<>();\n+        if (!CollectionUtils.isEmpty(constraints)) {\n+          for (SQLPrimaryKey key : (List<SQLPrimaryKey>) constraints) {\n+            String pkName = StringUtils.normalizeIdentifier(key.getPk_name());\n+            key.setPk_name(pkName);\n+            newPk.put(pkName, key);\n+            size += getObjectSize(SQLPrimaryKey.class, key);\n           }\n-          String fkName = StringUtils.normalizeIdentifier(key.getFk_name());\n-          key.setFk_name(fkName);\n-          newKeys.put(fkName, key);\n-          size += getObjectSize(SQLForeignKey.class, key);\n         }\n-        foreignKeyCache = newKeys;\n-        updateMemberSize(MemberName.FOREIGN_KEY_CACHE, size, SizeMode.Snapshot);\n-        LOG.debug(\"Foreign keys refresh in cache was successful for {}.{}.{}\",\n-            this.getTable().getCatName(), this.getTable().getDbName(), this.getTable().getTableName());\n-      } finally {\n-        tableLock.writeLock().unlock();\n-      }\n-    }\n-\n-    public void refreshNotNullConstraints(List<SQLNotNullConstraint> constraints) {\n-      Map<String, SQLNotNullConstraint> newConstraints = new ConcurrentHashMap<>();\n-      try {\n-        tableLock.writeLock().lock();\n-        int size = 0;\n-        for (SQLNotNullConstraint constraint : constraints) {\n-          if (compareAndSetMemberCacheUpdated(MemberName.NOTNULL_CONSTRAINT_CACHE, true, false)) {\n-            LOG.debug(\"Skipping not null constraints cache update for table: \" + getTable().getTableName()\n-                    + \"; the not null constraints are already refreshed.\");\n-            return;\n+        primaryKeyCache = newPk;\n+        break;\n+      case FOREIGN_KEY_CACHE:\n+        Map<String, SQLForeignKey> newFk = new ConcurrentHashMap<>();\n+        if (!CollectionUtils.isEmpty(constraints)) {\n+          for (SQLForeignKey key : (List<SQLForeignKey>) constraints) {\n+            String fkName = StringUtils.normalizeIdentifier(key.getFk_name());\n+            key.setFk_name(fkName);\n+            newFk.put(fkName, key);\n+            size += getObjectSize(SQLForeignKey.class, key);\n           }\n-          String nnName = StringUtils.normalizeIdentifier(constraint.getNn_name());\n-          constraint.setNn_name(nnName);\n-          newConstraints.put(nnName, constraint);\n-          size += getObjectSize(SQLNotNullConstraint.class, constraint);\n         }\n-        notNullConstraintCache = newConstraints;\n-        updateMemberSize(MemberName.NOTNULL_CONSTRAINT_CACHE, size, SizeMode.Snapshot);\n-        LOG.debug(\"Not null constraints refresh in cache was successful for {}.{}.{}\",\n-            this.getTable().getCatName(), this.getTable().getDbName(), this.getTable().getTableName());\n-      } finally {\n-        tableLock.writeLock().unlock();\n-      }\n-    }\n-\n-    public void refreshUniqueConstraints(List<SQLUniqueConstraint> constraints) {\n-      Map<String, SQLUniqueConstraint> newConstraints = new ConcurrentHashMap<>();\n-      try {\n-        tableLock.writeLock().lock();\n-        int size = 0;\n-        for (SQLUniqueConstraint constraint : constraints) {\n-          if (compareAndSetMemberCacheUpdated(MemberName.UNIQUE_CONSTRAINT_CACHE, true, false)) {\n-            LOG.debug(\"Skipping unique constraints cache update for table: \" + getTable().getTableName()\n-                    + \"; the unique constraints are already refreshed.\");\n-            return;\n+        foreignKeyCache = newFk;\n+        break;\n+      case UNIQUE_CONSTRAINT_CACHE:\n+        Map<String, SQLUniqueConstraint> newUc = new ConcurrentHashMap<>();\n+        if (!CollectionUtils.isEmpty(constraints)) {\n+          for (SQLUniqueConstraint constraint : (List<SQLUniqueConstraint>) constraints) {\n+            String ucName = StringUtils.normalizeIdentifier(constraint.getUk_name());\n+            constraint.setUk_name(ucName);\n+            newUc.put(ucName, constraint);\n+            size += getObjectSize(SQLUniqueConstraint.class, constraint);\n           }\n-          String ucName = StringUtils.normalizeIdentifier(constraint.getUk_name());\n-          constraint.setUk_name(ucName);\n-          newConstraints.put(ucName, constraint);\n-          size += getObjectSize(SQLUniqueConstraint.class, constraint);\n         }\n-        uniqueConstraintCache = newConstraints;\n-        updateMemberSize(MemberName.UNIQUE_CONSTRAINT_CACHE, size, SizeMode.Snapshot);\n-        LOG.debug(\"Unique constraints refresh in cache was successful for {}.{}.{}\",\n-            this.getTable().getCatName(), this.getTable().getDbName(), this.getTable().getTableName());\n-      } finally {\n-        tableLock.writeLock().unlock();\n-      }\n-    }\n-\n-    public void refreshDefaultConstraints(List<SQLDefaultConstraint> constraints) {\n-      Map<String, SQLDefaultConstraint> newConstraints = new ConcurrentHashMap<>();\n-      try {\n-        tableLock.writeLock().lock();\n-        int size = 0;\n-        for (SQLDefaultConstraint constraint : constraints) {\n-          if (compareAndSetMemberCacheUpdated(MemberName.DEFAULT_CONSTRAINT_CACHE, true, false)) {\n-            LOG.debug(\"Skipping default constraint cache update for table: \" + getTable().getTableName()\n-                + \"; the default constraint are already refreshed.\");\n-            return;\n+        uniqueConstraintCache = newUc;\n+        break;\n+      case NOTNULL_CONSTRAINT_CACHE:\n+        Map<String, SQLNotNullConstraint> newNn = new ConcurrentHashMap<>();\n+        if (!CollectionUtils.isEmpty(constraints)) {\n+          for (SQLNotNullConstraint constraint : (List<SQLNotNullConstraint>) constraints) {\n+            String nnName = StringUtils.normalizeIdentifier(constraint.getNn_name());\n+            constraint.setNn_name(nnName);\n+            newNn.put(nnName, constraint);\n+            size += getObjectSize(SQLNotNullConstraint.class, constraint);\n           }\n-          String dcName = StringUtils.normalizeIdentifier(constraint.getDc_name());\n-          constraint.setDc_name(dcName);\n-          newConstraints.put(dcName, constraint);\n-          size += getObjectSize(SQLDefaultConstraint.class, constraint);\n         }\n-        defaultConstraintCache = newConstraints;\n-        updateMemberSize(MemberName.DEFAULT_CONSTRAINT_CACHE, size, SizeMode.Snapshot);\n-        LOG.debug(\"Default constraints refresh in cache was successful for {}.{}.{}\", this.getTable().getCatName(),\n-            this.getTable().getDbName(), this.getTable().getTableName());\n-      } finally {\n-        tableLock.writeLock().unlock();\n-      }\n-    }\n-\n-    public void refreshCheckConstraints(List<SQLCheckConstraint> constraints) {\n-      Map<String, SQLCheckConstraint> newConstraints = new ConcurrentHashMap<>();\n-      try {\n-        tableLock.writeLock().lock();\n-        int size = 0;\n-        for (SQLCheckConstraint constraint : constraints) {\n-          if (compareAndSetMemberCacheUpdated(MemberName.CHECK_CONSTRAINT_CACHE, true, false)) {\n-            LOG.debug(\"Skipping check constraint cache update for table: \" + getTable().getTableName()\n-                + \"; the check constraint are already refreshed.\");\n-            return;\n+        notNullConstraintCache = newNn;\n+        break;\n+      case DEFAULT_CONSTRAINT_CACHE:\n+        Map<String, SQLDefaultConstraint> newDc = new ConcurrentHashMap<>();\n+        if (!CollectionUtils.isEmpty(constraints)) {\n+          for (SQLDefaultConstraint constraint : (List<SQLDefaultConstraint>) constraints) {\n+            String dcName = StringUtils.normalizeIdentifier(constraint.getDc_name());\n+            constraint.setDc_name(dcName);\n+            newDc.put(dcName, constraint);\n+            size += getObjectSize(SQLDefaultConstraint.class, constraint);\n           }\n-          String ccName = StringUtils.normalizeIdentifier(constraint.getDc_name());\n-          constraint.setDc_name(ccName);\n-          newConstraints.put(ccName, constraint);\n-          size += getObjectSize(SQLCheckConstraint.class, constraint);\n         }\n-        checkConstraintCache = newConstraints;\n-        updateMemberSize(MemberName.CHECK_CONSTRAINT_CACHE, size, SizeMode.Snapshot);\n-        LOG.debug(\"check constraints refresh in cache was successful for {}.{}.{}\", this.getTable().getCatName(),\n-            this.getTable().getDbName(), this.getTable().getTableName());\n-      } finally {\n-        tableLock.writeLock().unlock();\n-      }\n+        defaultConstraintCache = newDc;\n+        break;\n+      case CHECK_CONSTRAINT_CACHE:\n+        Map<String, SQLCheckConstraint> newCc = new ConcurrentHashMap<>();\n+        if (!CollectionUtils.isEmpty(constraints)) {\n+          for (SQLCheckConstraint constraint : (List<SQLCheckConstraint>) constraints) {\n+            String ccName = StringUtils.normalizeIdentifier(constraint.getDc_name());\n+            constraint.setDc_name(ccName);\n+            newCc.put(ccName, constraint);\n+            size += getObjectSize(SQLCheckConstraint.class, constraint);\n+          }\n+        }\n+        checkConstraintCache = newCc;\n+        break;\n+      default:\n+        LOG.error(\"Should not reach here\");\n+        break;\n+      }\n+      updateMemberSize(mn, size, SizeMode.Snapshot);\n+      setMemberCacheUpdated(mn, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "originalPosition": 349}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDMxMzk1MA==", "bodyText": "Keep tblWrapper != null within ().", "url": "https://github.com/apache/hive/pull/1610#discussion_r574313950", "createdAt": "2021-02-11T08:20:25Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/SharedCache.java", "diffHunk": "@@ -2187,7 +2139,7 @@ public void addPrimaryKeysToCache(String catName, String dbName, String tblName,\n       cacheLock.readLock().lock();\n       String tblKey = CacheUtils.buildTableKey(catName, dbName, tblName);\n       TableWrapper tblWrapper = tableCache.getIfPresent(tblKey);\n-      if (tblWrapper != null) {\n+      if (tblWrapper != null && tblWrapper.isConstraintsValid()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "originalPosition": 418}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDMxNDUxOQ==", "bodyText": "Why do we update cache for each constraint individually? We should always cache a single snapshot of constraints of table. If not, isConstraintsValid flag wouldn't make sense.", "url": "https://github.com/apache/hive/pull/1610#discussion_r574314519", "createdAt": "2021-02-11T08:21:38Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/SharedCache.java", "diffHunk": "@@ -2187,7 +2139,7 @@ public void addPrimaryKeysToCache(String catName, String dbName, String tblName,\n       cacheLock.readLock().lock();\n       String tblKey = CacheUtils.buildTableKey(catName, dbName, tblName);\n       TableWrapper tblWrapper = tableCache.getIfPresent(tblKey);\n-      if (tblWrapper != null) {\n+      if (tblWrapper != null && tblWrapper.isConstraintsValid()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "originalPosition": 418}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDMxNTMwMw==", "bodyText": "Still keys can be referenced with null at line 2365.", "url": "https://github.com/apache/hive/pull/1610#discussion_r574315303", "createdAt": "2021-02-11T08:23:08Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/SharedCache.java", "diffHunk": "@@ -2397,7 +2397,7 @@ public SQLAllTableConstraints listCachedAllTableConstraints(String catName, Stri\n \n   public List<SQLForeignKey> listCachedForeignKeys(String catName, String foreignDbName, String foreignTblName,\n                                                    String parentDbName, String parentTblName) {\n-    List<SQLForeignKey> keys = new ArrayList<>();\n+    List<SQLForeignKey> keys = null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg3NzY3Ng=="}, "originalCommit": {"oid": "eea2fa7506907337b81becb277f71879a0d05fdd"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDMxNTg2OQ==", "bodyText": "nit: Need space after comma", "url": "https://github.com/apache/hive/pull/1610#discussion_r574315869", "createdAt": "2021-02-11T08:24:10Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/test/java/org/apache/hadoop/hive/metastore/cache/TestCachedStore.java", "diffHunk": "@@ -1558,6 +1558,7 @@ public void testPrimaryKeys() {\n     Table tbl = createUnpartitionedTableObject(db);\n \n     sharedCache.addTableToCache(DEFAULT_CATALOG_NAME, \"db\", tbl.getTableName(), tbl);\n+    sharedCache.addTableConstraintsToCache(DEFAULT_CATALOG_NAME,\"db\", tbl.getTableName(), new SQLAllTableConstraints());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2f6702d771a50f3caae8767e9d24f191080131b"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3739de108139913dc95d240f4fba6fe601fd4f59", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/3739de108139913dc95d240f4fba6fe601fd4f59", "committedDate": "2021-02-16T14:04:41Z", "message": "HIVE-24259: test fixed"}, "afterCommit": {"oid": "255b2e02d7933dda1e23720dfd47d3ec6c24714e", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/255b2e02d7933dda1e23720dfd47d3ec6c24714e", "committedDate": "2021-02-16T16:10:36Z", "message": "HIVE-24259: optimise allTableConstraint call in cache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35ffe500ae2467a5022a60037b53660a2916ac0e", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/35ffe500ae2467a5022a60037b53660a2916ac0e", "committedDate": "2021-02-16T16:49:38Z", "message": "HIVE-24259: test fix"}, "afterCommit": {"oid": "b00d479ba6ab510378474637d7f37e6a79808532", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/b00d479ba6ab510378474637d7f37e6a79808532", "committedDate": "2021-02-17T04:45:54Z", "message": "HIVE-24259: optimise get all table constraint from cache store"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b00d479ba6ab510378474637d7f37e6a79808532", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/b00d479ba6ab510378474637d7f37e6a79808532", "committedDate": "2021-02-17T04:45:54Z", "message": "HIVE-24259: optimise get all table constraint from cache store"}, "afterCommit": {"oid": "ffaa5a606ff8fe90fd6d08baccc8e15388b009f3", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/ffaa5a606ff8fe90fd6d08baccc8e15388b009f3", "committedDate": "2021-02-18T08:05:56Z", "message": "HIVE-24259: fixed failing test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ffaa5a606ff8fe90fd6d08baccc8e15388b009f3", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/ffaa5a606ff8fe90fd6d08baccc8e15388b009f3", "committedDate": "2021-02-18T08:05:56Z", "message": "HIVE-24259: fixed failing test"}, "afterCommit": {"oid": "a738dab45dc1fd598371436ef3741e8928927662", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/a738dab45dc1fd598371436ef3741e8928927662", "committedDate": "2021-02-18T08:39:16Z", "message": "HIVE-24259: optimise get all table constraint from cache store"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTkzMDA4NTk3", "url": "https://github.com/apache/hive/pull/1610#pullrequestreview-593008597", "createdAt": "2021-02-18T09:28:03Z", "commit": {"oid": "a738dab45dc1fd598371436ef3741e8928927662"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xOFQwOToyODowNFrOIneMQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xOFQxMDo1MjoxMVrOInhvBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODI2MDAzNA==", "bodyText": "This check is done in several places. Shall add utility method for this.", "url": "https://github.com/apache/hive/pull/1610#discussion_r578260034", "createdAt": "2021-02-18T09:28:04Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -2674,28 +2554,19 @@ long getPartsFound() {\n     catName = StringUtils.normalizeIdentifier(catName);\n     dbName = StringUtils.normalizeIdentifier(dbName);\n     tblName = StringUtils.normalizeIdentifier(tblName);\n-    if (!shouldCacheTable(catName, dbName, tblName) || (canUseEvents && rawStore.isActiveTransaction())) {\n+    if (!shouldCacheTable(catName, dbName, tblName) || (canUseEvents && rawStore.isActiveTransaction()) || !sharedCache", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a738dab45dc1fd598371436ef3741e8928927662"}, "originalPosition": 193}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODI2MjM4OA==", "bodyText": "invalidate is single word in this context.Change method name to invalidateConstraintsCache.", "url": "https://github.com/apache/hive/pull/1610#discussion_r578262388", "createdAt": "2021-02-18T09:31:16Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/SharedCache.java", "diffHunk": "@@ -2187,8 +2160,10 @@ public void addPrimaryKeysToCache(String catName, String dbName, String tblName,\n       cacheLock.readLock().lock();\n       String tblKey = CacheUtils.buildTableKey(catName, dbName, tblName);\n       TableWrapper tblWrapper = tableCache.getIfPresent(tblKey);\n-      if (tblWrapper != null) {\n-        tblWrapper.cachePrimaryKeys(keys, false);\n+      if ((tblWrapper != null) && tblWrapper.isConstraintsValid()) {\n+        // Because lake of snapshot freshness validation.\n+        // For now disabling cached constraint snapshot addition in parts by invalidating constraint snapshot.\n+        tblWrapper.inValidateConstraints();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a738dab45dc1fd598371436ef3741e8928927662"}, "originalPosition": 462}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3ODMxODA4Ng==", "bodyText": "We have separate events for add individual constraints. I think, we need not keep it as part of create table event.\nIt adds additional overhead when transmit events for incremental replication. Also, takes additional storage in HMS.", "url": "https://github.com/apache/hive/pull/1610#discussion_r578318086", "createdAt": "2021-02-18T10:52:11Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/events/CreateTableEvent.java", "diffHunk": "@@ -29,11 +30,14 @@\n \n   private final Table table;\n   private final boolean isReplicated;\n+  private final SQLAllTableConstraints constraints;\n \n-  public CreateTableEvent(Table table, boolean status, IHMSHandler handler, boolean isReplicated) {\n+  public CreateTableEvent(Table table, boolean status, IHMSHandler handler, boolean isReplicated,\n+      SQLAllTableConstraints constraints) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a738dab45dc1fd598371436ef3741e8928927662"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk0NDE0MTQ5", "url": "https://github.com/apache/hive/pull/1610#pullrequestreview-594414149", "createdAt": "2021-02-19T17:38:01Z", "commit": {"oid": "b66d8ecc2a2064c336d830e4c72a3c605ebe8008"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xOVQxNzozODowMVrOIohO2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xOVQxNzo0OTowM1rOIohoeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTM1ODQyNg==", "bodyText": "It is not used anywhere other than below method. We can remove it and move these validations there.", "url": "https://github.com/apache/hive/pull/1610#discussion_r579358426", "createdAt": "2021-02-19T17:38:01Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CacheUtils.java", "diffHunk": "@@ -144,4 +147,15 @@ public static boolean matches(String name, String pattern) {\n     }\n     return false;\n   }\n+\n+  public static boolean validateShouldCacheTableCanUseEventIsActiveTransaction(String catName, String dbName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66d8ecc2a2064c336d830e4c72a3c605ebe8008"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTM2MzM2NA==", "bodyText": "The method name is too long and not readable. Shall make it shouldGetConstraintFromRawStore().", "url": "https://github.com/apache/hive/pull/1610#discussion_r579363364", "createdAt": "2021-02-19T17:46:25Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CacheUtils.java", "diffHunk": "@@ -144,4 +147,15 @@ public static boolean matches(String name, String pattern) {\n     }\n     return false;\n   }\n+\n+  public static boolean validateShouldCacheTableCanUseEventIsActiveTransaction(String catName, String dbName,\n+      String tblName, boolean canUseEvents, RawStore rawStore) {\n+    return !shouldCacheTable(catName, dbName, tblName) || (canUseEvents && rawStore.isActiveTransaction());\n+  }\n+\n+  public static boolean validateShouldCacheTableCanUseEventIsActiveTransactionIsConstraintsValid(String catName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66d8ecc2a2064c336d830e4c72a3c605ebe8008"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTM2NDYxNQ==", "bodyText": "Shall move this method as private method inside CachedStore to avoid passing too many arguments.", "url": "https://github.com/apache/hive/pull/1610#discussion_r579364615", "createdAt": "2021-02-19T17:48:23Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CacheUtils.java", "diffHunk": "@@ -144,4 +147,15 @@ public static boolean matches(String name, String pattern) {\n     }\n     return false;\n   }\n+\n+  public static boolean validateShouldCacheTableCanUseEventIsActiveTransaction(String catName, String dbName,\n+      String tblName, boolean canUseEvents, RawStore rawStore) {\n+    return !shouldCacheTable(catName, dbName, tblName) || (canUseEvents && rawStore.isActiveTransaction());\n+  }\n+\n+  public static boolean validateShouldCacheTableCanUseEventIsActiveTransactionIsConstraintsValid(String catName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66d8ecc2a2064c336d830e4c72a3c605ebe8008"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3OTM2NDk4Ng==", "bodyText": "nit: Add space after each parameter.", "url": "https://github.com/apache/hive/pull/1610#discussion_r579364986", "createdAt": "2021-02-19T17:49:03Z", "author": {"login": "sankarh"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/cache/CachedStore.java", "diffHunk": "@@ -2554,8 +2554,7 @@ long getPartsFound() {\n     catName = StringUtils.normalizeIdentifier(catName);\n     dbName = StringUtils.normalizeIdentifier(dbName);\n     tblName = StringUtils.normalizeIdentifier(tblName);\n-    if (!shouldCacheTable(catName, dbName, tblName) || (canUseEvents && rawStore.isActiveTransaction()) || !sharedCache\n-        .isTableConstraintValid(catName, dbName, tblName)) {\n+    if (validateShouldCacheTableCanUseEventIsActiveTransactionIsConstraintsValid(catName,dbName,tblName,canUseEvents,rawStore,sharedCache)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66d8ecc2a2064c336d830e4c72a3c605ebe8008"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk0NzczMzU2", "url": "https://github.com/apache/hive/pull/1610#pullrequestreview-594773356", "createdAt": "2021-02-20T18:07:12Z", "commit": {"oid": "eb4281003a6e933caf08758feba56f0fdf88f77e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk0ODQ5MzU1", "url": "https://github.com/apache/hive/pull/1610#pullrequestreview-594849355", "createdAt": "2021-02-21T14:57:06Z", "commit": {"oid": "eb4281003a6e933caf08758feba56f0fdf88f77e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bed562ca6a15bc15d614006c6fbde48904e542ff", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/bed562ca6a15bc15d614006c6fbde48904e542ff", "committedDate": "2021-02-21T16:51:01Z", "message": "HIVE-24259: optimise get all table constraint from cache store"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb4281003a6e933caf08758feba56f0fdf88f77e", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/eb4281003a6e933caf08758feba56f0fdf88f77e", "committedDate": "2021-02-20T12:05:40Z", "message": "HIVE-24259: comment resolved"}, "afterCommit": {"oid": "bed562ca6a15bc15d614006c6fbde48904e542ff", "author": {"user": {"login": "ashish-kumar-sharma", "name": "Ashish Kumar Sharma"}}, "url": "https://github.com/apache/hive/commit/bed562ca6a15bc15d614006c6fbde48904e542ff", "committedDate": "2021-02-21T16:51:01Z", "message": "HIVE-24259: optimise get all table constraint from cache store"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3217, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}