{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0Njk1NDQ5", "number": 1647, "title": "HIVE-24329: Add Notification event for compaction commit", "bodyText": "What changes were proposed in this pull request?\nAdd new notification event type for commit compaction.\nWhy are the changes needed?\nThe new event can be used by file metadata cache implementations to invalidate the cache content\nDoes this PR introduce any user-facing change?\nNo\nHow was this patch tested?", "createdAt": "2020-11-03T12:19:24Z", "url": "https://github.com/apache/hive/pull/1647", "merged": true, "mergeCommit": {"oid": "c1010a11dd5ce78daaa684f15d1aa55ce406c41a"}, "closed": true, "closedAt": "2020-11-23T08:18:00Z", "author": {"login": "pvargacl"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY4KhwAH2gAyNTE0Njk1NDQ5OjIyZTYyMjA5ZjM2NWY1MzA2MzNiNjhlZjZjODAzZTQ0MjUyZDJiMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeTQp2gH2gAyNTE0Njk1NDQ5OjYwMjI5OWNlNzA0NjFkYjM3MWUwYWI5MmUzNmQwNjg3YzVmNmI3N2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "22e62209f365f530633b68ef6c803e44252d2b0c", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/22e62209f365f530633b68ef6c803e44252d2b0c", "committedDate": "2020-11-03T12:17:36Z", "message": "HIVE-24329: Add Notification event for compaction commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/21fab98f792042bd82ae6ef1f73a08ce89d85a61", "committedDate": "2020-11-10T15:22:13Z", "message": "Merge remote-tracking branch 'origin/master' into HIVE-24329-compaction-notification-2\n\n# Conflicts:\n#\tstandalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MTk5NjMy", "url": "https://github.com/apache/hive/pull/1647#pullrequestreview-528199632", "createdAt": "2020-11-11T14:04:55Z", "commit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDowNDo1NVrOHxOggQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDowNDo1NVrOHxOggQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM3OTk2OQ==", "bodyText": "I haven't seen that other events contained db information. Is it required here?", "url": "https://github.com/apache/hive/pull/1647#discussion_r521379969", "createdAt": "2020-11-11T14:04:55Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/events/CommitCompactionEvent.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.metastore.events;\n+\n+import org.apache.hadoop.classification.InterfaceAudience;\n+import org.apache.hadoop.classification.InterfaceStability;\n+import org.apache.hadoop.hive.metastore.IHMSHandler;\n+import org.apache.hadoop.hive.metastore.api.CompactionType;\n+import org.apache.hadoop.hive.metastore.api.TxnType;\n+import org.apache.hadoop.hive.metastore.txn.CompactionInfo;\n+\n+/**\n+ * CommitCompactionEvent\n+ * Event generated for compaction commit operation\n+ */\n+@InterfaceAudience.Public\n+@InterfaceStability.Stable\n+public class CommitCompactionEvent extends ListenerEvent {\n+\n+  private final Long txnId;\n+  private final Long compactionId;\n+  private final CompactionType type;\n+  private final String dbname;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MjAxNDg0", "url": "https://github.com/apache/hive/pull/1647#pullrequestreview-528201484", "createdAt": "2020-11-11T14:07:10Z", "commit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDowNzoxMFrOHxOl9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDowNzoxMFrOHxOl9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4MTM2NA==", "bodyText": "Same as above, do we actually need db name here?", "url": "https://github.com/apache/hive/pull/1647#discussion_r521381364", "createdAt": "2020-11-11T14:07:10Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/messaging/CommitCompactionMessage.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/* * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.metastore.messaging;\n+\n+import org.apache.hadoop.hive.metastore.api.CompactionType;\n+import org.apache.hadoop.hive.metastore.api.Partition;\n+import org.apache.hadoop.hive.metastore.api.Table;\n+import org.apache.hadoop.hive.metastore.api.WriteEventInfo;\n+\n+import java.util.List;\n+\n+/**\n+ * Message sent when a compaction commit is done.\n+ */\n+public abstract class CommitCompactionMessage extends EventMessage {\n+\n+  protected CommitCompactionMessage() {\n+    super(EventType.COMMIT_COMPACTION);\n+  }\n+\n+  public abstract Long getTxnId();\n+\n+  public abstract Long getCompactionId();\n+\n+  public abstract  CompactionType getType();\n+\n+  public abstract String getDbname();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MjAyODc4", "url": "https://github.com/apache/hive/pull/1647#pullrequestreview-528202878", "createdAt": "2020-11-11T14:08:47Z", "commit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDowODo0N1rOHxOqAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDowODo0N1rOHxOqAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4MjQwMg==", "bodyText": "Maybe use builder to avoid constructor with huge number of params?", "url": "https://github.com/apache/hive/pull/1647#discussion_r521382402", "createdAt": "2020-11-11T14:08:47Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/messaging/json/JSONCommitCompactionMessage.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.hadoop.hive.metastore.messaging.json;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.collect.Lists;\n+import org.apache.hadoop.hive.metastore.api.CompactionType;\n+import org.apache.hadoop.hive.metastore.api.Partition;\n+import org.apache.hadoop.hive.metastore.api.Table;\n+import org.apache.hadoop.hive.metastore.api.WriteEventInfo;\n+import org.apache.hadoop.hive.metastore.messaging.CommitCompactionMessage;\n+import org.apache.hadoop.hive.metastore.messaging.CommitTxnMessage;\n+import org.apache.hadoop.hive.metastore.messaging.MessageBuilder;\n+\n+import java.util.List;\n+\n+/**\n+ * JSON implementation of CommitCompactionMessage\n+ */\n+public class JSONCommitCompactionMessage extends CommitCompactionMessage {\n+\n+  @JsonProperty\n+  private Long txnid;\n+\n+  @JsonProperty\n+  private Long timestamp;\n+\n+  @JsonProperty\n+  private String server;\n+\n+  @JsonProperty\n+  private String servicePrincipal;\n+\n+  @JsonProperty\n+  private Long compactionId;\n+\n+  @JsonProperty\n+  private CompactionType type;\n+\n+  @JsonProperty\n+  private String dbname;\n+\n+  @JsonProperty\n+  private String tableName;\n+\n+  @JsonProperty\n+  private String partName;\n+\n+  /**\n+   * Default constructor, needed for Jackson.\n+   */\n+  public JSONCommitCompactionMessage() {\n+  }\n+\n+  public JSONCommitCompactionMessage(String server, String servicePrincipal, Long timestamp, Long txnid,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MjA0MDQ4", "url": "https://github.com/apache/hive/pull/1647#pullrequestreview-528204048", "createdAt": "2020-11-11T14:10:05Z", "commit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDoxMDowNVrOHxOtcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDoxMDowNVrOHxOtcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4MzI4MA==", "bodyText": "why is it protected?", "url": "https://github.com/apache/hive/pull/1647#discussion_r521383280", "createdAt": "2020-11-11T14:10:05Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/CompactionTxnHandler.java", "diffHunk": "@@ -1162,6 +1172,55 @@ protected void updateWSCommitIdAndCleanUpMetadata(Statement stmt, long txnid, Tx\n               TxnDbUtil.getEpochFn(dbProduct) + \" WHERE \\\"CQ_TXN_ID\\\" = \" + txnid);\n     }\n   }\n+\n+  protected CompactionInfo getCompactionByTxnId(Connection dbConn, long txnid) throws SQLException, MetaException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MjA4MzU3", "url": "https://github.com/apache/hive/pull/1647#pullrequestreview-528208357", "createdAt": "2020-11-11T14:15:05Z", "commit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDoxNTowNVrOHxO6SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDoxNTowNVrOHxO6SA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4NjU2OA==", "bodyText": "Why do we have compaction related stuff in TxnHandler? It's an abstract class already.", "url": "https://github.com/apache/hive/pull/1647#discussion_r521386568", "createdAt": "2020-11-11T14:15:05Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -1409,6 +1407,23 @@ public void commitTxn(CommitTxnRequest rqst)\n     }\n   }\n \n+  /**\n+   * Create Notifiaction Events on txn commit\n+   * @param dbConn DatabaseConnection\n+   * @param txnid committed txn\n+   * @param txnType transaction type\n+   * @throws MetaException ex\n+   */\n+  protected void createCommitNotificationEvent(Connection dbConn, long txnid, Optional<TxnType> txnType)\n+      throws MetaException, SQLException {\n+    if (transactionalListeners != null) {\n+      MetaStoreListenerNotifier.notifyEventWithDirectSql(transactionalListeners,\n+              EventMessage.EventType.COMMIT_TXN, new CommitTxnEvent(txnid, txnType.get()), dbConn, sqlGenerator);\n+    }\n+  }\n+\n+  protected abstract CompactionInfo getCompactionByTxnId(Connection dbConn, long txnid) throws SQLException, MetaException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MjU4NTE5", "url": "https://github.com/apache/hive/pull/1647#pullrequestreview-528258519", "createdAt": "2020-11-11T15:10:24Z", "commit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNToxMDoyNFrOHxRP1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNToxMDoyNFrOHxRP1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQyNDg1NA==", "bodyText": "I think, this has overlap with createCommitNotificationEvent", "url": "https://github.com/apache/hive/pull/1647#discussion_r521424854", "createdAt": "2020-11-11T15:10:24Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java", "diffHunk": "@@ -8373,6 +8374,11 @@ public void commit_txn(CommitTxnRequest rqst) throws TException {\n       if (listeners != null && !listeners.isEmpty()) {\n         MetaStoreListenerNotifier.notifyEvent(listeners, EventType.COMMIT_TXN,\n                 new CommitTxnEvent(rqst.getTxnid(), this));\n+        CompactionInfo compactionInfo = getTxnHandler().getCompactionByTxnId(rqst.getTxnid());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MjYwMjc1", "url": "https://github.com/apache/hive/pull/1647#pullrequestreview-528260275", "createdAt": "2020-11-11T15:12:16Z", "commit": {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa358c5eac2bf8d5ba5e594e6835a2ccbfb45f78", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/aa358c5eac2bf8d5ba5e594e6835a2ccbfb45f78", "committedDate": "2020-11-16T13:01:16Z", "message": "Fix review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18e9e86d4d1977f88b85994469dc8377d386b8c5", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/18e9e86d4d1977f88b85994469dc8377d386b8c5", "committedDate": "2020-11-16T13:04:17Z", "message": "Merge remote-tracking branch 'origin/master' into HIVE-24329-compaction-notification-2\n\n# Conflicts:\n#\tstandalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afcc84a8ad4877cb73c7c49272aeb7e55e80dab3", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/afcc84a8ad4877cb73c7c49272aeb7e55e80dab3", "committedDate": "2020-11-16T13:19:34Z", "message": "Fix DbNotificationListener"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NjcwMDQ2", "url": "https://github.com/apache/hive/pull/1647#pullrequestreview-534670046", "createdAt": "2020-11-19T17:13:16Z", "commit": {"oid": "afcc84a8ad4877cb73c7c49272aeb7e55e80dab3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNzoxMzoxN1rOH2pEBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNzoxMzoxN1rOH2pEBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA1NzkyNQ==", "bodyText": "Wouldn't it be better if we wrap this with Optional?", "url": "https://github.com/apache/hive/pull/1647#discussion_r527057925", "createdAt": "2020-11-19T17:13:17Z", "author": {"login": "deniskuzZ"}, "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/CompactionTxnHandler.java", "diffHunk": "@@ -1176,6 +1186,55 @@ protected void updateWSCommitIdAndCleanUpMetadata(Statement stmt, long txnid, Tx\n               TxnDbUtil.getEpochFn(dbProduct) + \" WHERE \\\"CQ_TXN_ID\\\" = \" + txnid);\n     }\n   }\n+\n+  private CompactionInfo getCompactionByTxnId(Connection dbConn, long txnid) throws SQLException, MetaException {\n+    CompactionInfo info = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afcc84a8ad4877cb73c7c49272aeb7e55e80dab3"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0Njc0NDU0", "url": "https://github.com/apache/hive/pull/1647#pullrequestreview-534674454", "createdAt": "2020-11-19T17:18:08Z", "commit": {"oid": "afcc84a8ad4877cb73c7c49272aeb7e55e80dab3"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "602299ce70461db371e0ab92e36d0687c5f6b77b", "author": {"user": {"login": "pvargacl", "name": "Peter Varga"}}, "url": "https://github.com/apache/hive/commit/602299ce70461db371e0ab92e36d0687c5f6b77b", "committedDate": "2020-11-20T08:41:21Z", "message": "Use Optional"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3001, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}