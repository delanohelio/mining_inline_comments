{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NTc4NDI2", "number": 1509, "title": "HIVE-24179: Memory leak in HS2 DbTxnManager when compiling SHOW LOCKS statement", "bodyText": "What changes were proposed in this pull request?\n\nAvoid multiple shutdown hooks for the same threadpool in DbTxnManager\nClose new HiveTxnManager in ShowLocksAnalyzer to release resources\n\nWhy are the changes needed?\nAvoid the memory leak when executing SHOW LOCKS statements and simplify code.\nDoes this PR introduce any user-facing change?\nNo\nHow was this patch tested?\nmvn test -pl itests/hive-unit -Dtest=TestDbTxnManagerMemoryLeak -Pitests\nIf it finishes then there is no memory leak, otherwise most of the time you get an OutOfMemoryError.\nSee the JIRA case for more details.\nThe commit with the test is not meant to be merged into master", "createdAt": "2020-09-18T23:12:32Z", "url": "https://github.com/apache/hive/pull/1509", "merged": true, "mergeCommit": {"oid": "8e7b8f80325be5506f02ccfc810bd151ff29ac99"}, "closed": true, "closedAt": "2020-11-13T17:24:44Z", "author": {"login": "zabetak"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLAZQFgFqTQ5MjQ0MTM2Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcKYWrABqjM5OTQ0NDk4OTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNDQxMzY2", "url": "https://github.com/apache/hive/pull/1509#pullrequestreview-492441366", "createdAt": "2020-09-21T09:57:59Z", "commit": {"oid": "0e38686db29c51db368771b416810c7de06b2322"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTo1Nzo1OVrOHVIi0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTo1Nzo1OVrOHVIi0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjEyOA==", "bodyText": "Do we create txnManager instance here just to get the value of useNewLocksFormat flag?", "url": "https://github.com/apache/hive/pull/1509#discussion_r491922128", "createdAt": "2020-09-21T09:57:59Z", "author": {"login": "deniskuzZ"}, "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/lock/show/ShowDbLocksAnalyzer.java", "diffHunk": "@@ -47,14 +47,16 @@ public void analyzeInternal(ASTNode root) throws SemanticException {\n     String dbName = stripQuotes(root.getChild(0).getText());\n     boolean isExtended = (root.getChildCount() > 1);\n \n-    HiveTxnManager txnManager = null;\n+    boolean useNewLocksFormat;\n     try {\n-      txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);\n+      HiveTxnManager txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e38686db29c51db368771b416810c7de06b2322"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTcxNzAz", "url": "https://github.com/apache/hive/pull/1509#pullrequestreview-493171703", "createdAt": "2020-09-22T06:59:54Z", "commit": {"oid": "297882ee80d52689a9cc1c68da9f7580918439bb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "301085b0ede69f8c9b64f70b4150d39df1796926", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/301085b0ede69f8c9b64f70b4150d39df1796926", "committedDate": "2020-11-13T17:08:48Z", "message": "HIVE-24179: Memory leak in HS2 DbTxnManager when compiling SHOW LOCKS statement\n\n1. Avoid multiple shutdown hooks for the same threadpool in DbTxnManager.\n\nEnforce unique initialization and shutdown of the thread pool. Apart\nfrom the apparent memory leak there is no need to register a shutdown\nhook for the executor service multiple times. It wastes memory,\ncomplicates code, and serves no purpose.\n\nChange initHeartbeatExecutorService to synchronized putting the class\nlock in the whole method. Mixing instance and class locks is confusing\nand does not offer any particular benefit.\n\n2. Avoid HiveTxnManager instantiation in lock analyzers.\n\nA transaction manager should already exist inside the\nanalyzer before calling the analyze method. There is no need to create a\nnew one just to obtain the useNewShowLocksFormat boolean indicator."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "297882ee80d52689a9cc1c68da9f7580918439bb", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/297882ee80d52689a9cc1c68da9f7580918439bb", "committedDate": "2020-09-21T16:43:27Z", "message": "HIVE-24179: Avoid HiveTxnManager instantiation in lock analyzers\n\nA transaction manager should already exist inside the\nanalyzer before calling the analyze method. There is no need to create a\nnew one just to obtain the useNewShowLocksFormat boolean indicator."}, "afterCommit": {"oid": "301085b0ede69f8c9b64f70b4150d39df1796926", "author": {"user": {"login": "zabetak", "name": "Stamatis Zampetakis"}}, "url": "https://github.com/apache/hive/commit/301085b0ede69f8c9b64f70b4150d39df1796926", "committedDate": "2020-11-13T17:08:48Z", "message": "HIVE-24179: Memory leak in HS2 DbTxnManager when compiling SHOW LOCKS statement\n\n1. Avoid multiple shutdown hooks for the same threadpool in DbTxnManager.\n\nEnforce unique initialization and shutdown of the thread pool. Apart\nfrom the apparent memory leak there is no need to register a shutdown\nhook for the executor service multiple times. It wastes memory,\ncomplicates code, and serves no purpose.\n\nChange initHeartbeatExecutorService to synchronized putting the class\nlock in the whole method. Mixing instance and class locks is confusing\nand does not offer any particular benefit.\n\n2. Avoid HiveTxnManager instantiation in lock analyzers.\n\nA transaction manager should already exist inside the\nanalyzer before calling the analyze method. There is no need to create a\nnew one just to obtain the useNewShowLocksFormat boolean indicator."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3328, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}