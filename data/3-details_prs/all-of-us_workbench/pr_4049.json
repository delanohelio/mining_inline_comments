{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMjUyNzQx", "number": 4049, "title": "[RW-5363][risk=no]  Puppeteer test for notebook download", "bodyText": "See code comments for details. Finally got this working after a lot of trial and error. The biggest blockers:\n\nUtilities all use Page, rather than Frame. This meant I couldn't use existing libraries for frame elements.\nSome things rendered offscreen on headless - adding the viewport fixed this.\nSome events were not firing in headless, a page.evaluate(() => $(..).click()) ultimately solved this, since Jupyter relies on jQuery pretty heavily.\nDownload opens a new tab. In debug mode, this takes control of the browser - need to bring the main page to the foreground in order to continue..", "createdAt": "2020-09-22T23:57:32Z", "url": "https://github.com/all-of-us/workbench/pull/4049", "merged": true, "mergeCommit": {"oid": "d542478df08f2b0092288cfb6824e8bede2e0d16"}, "closed": true, "closedAt": "2020-09-28T17:56:16Z", "author": {"login": "calbach"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLhBN-ABqjM3OTU2MTQwNjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNByaOgFqTQ5NzA5NDE2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba7e487f8bcaa50fc8a8bd0e39cfed95f3e6f0c7", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/ba7e487f8bcaa50fc8a8bd0e39cfed95f3e6f0c7", "committedDate": "2020-09-22T23:53:21Z", "message": "Finally..."}, "afterCommit": {"oid": "a582d55b6d9e099c6535bad5295f798c5e089641", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/a582d55b6d9e099c6535bad5295f798c5e089641", "committedDate": "2020-09-22T23:58:30Z", "message": "Finally..."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0Nzg2NjEz", "url": "https://github.com/all-of-us/workbench/pull/4049#pullrequestreview-494786613", "createdAt": "2020-09-23T15:29:34Z", "commit": {"oid": "a582d55b6d9e099c6535bad5295f798c5e089641"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNToyOTozNFrOHW0Szg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNToyOTozNFrOHW0Szg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzY4NzUwMg==", "bodyText": "Note: in case you see this diff disappear, I stole this line for #4053", "url": "https://github.com/all-of-us/workbench/pull/4049#discussion_r493687502", "createdAt": "2020-09-23T15:29:34Z", "author": {"login": "jmthibault79"}, "path": "e2e/README.md", "diffHunk": "@@ -44,6 +44,7 @@ interactions visible to you.\n * Run one test on deployed AoU \"test\" environment <div class=\"text-blue\">`yarn test:debug [TEST_FILE]` </div>\n * Run one test on your local server <div class=\"text-blue\">`yarn test-local [TEST_FILE]` </div>\n * Run one test in headless Chrome with node `--inspect-brk` argument. It pauses test playback at breakpoints which is useful for debugging or/and writing new tests <div class=\"text-blue\">`yarn test:debugTest [TEST_FILE]` </div>\n+  * Navigate to chrome://inspect after launching the tests to debug test code", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a582d55b6d9e099c6535bad5295f798c5e089641"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db7a52ac7a38129e0caf7db5bbf3c54635533f04", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/db7a52ac7a38129e0caf7db5bbf3c54635533f04", "committedDate": "2020-09-23T23:27:02Z", "message": "Stuck on two issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80c708b69dd0cb6e6d1d60c013571a24b5ef955f", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/80c708b69dd0cb6e6d1d60c013571a24b5ef955f", "committedDate": "2020-09-23T23:27:02Z", "message": "doc issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59543c7a900fc287d3cd567e79d441a9204eaafc", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/59543c7a900fc287d3cd567e79d441a9204eaafc", "committedDate": "2020-09-23T23:27:02Z", "message": "Finally..."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd", "committedDate": "2020-09-23T23:27:02Z", "message": "poll for 10s until new tab shows up"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3441a36dcd84130345375520e1c53361952d68a1", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/3441a36dcd84130345375520e1c53361952d68a1", "committedDate": "2020-09-23T23:26:15Z", "message": "poll for 10s until new tab shows up"}, "afterCommit": {"oid": "621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd", "committedDate": "2020-09-23T23:27:02Z", "message": "poll for 10s until new tab shows up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MTY4NzM4", "url": "https://github.com/all-of-us/workbench/pull/4049#pullrequestreview-495168738", "createdAt": "2020-09-24T01:58:23Z", "commit": {"oid": "621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMTo1ODoyM1rOHXHCew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwMzoxOTowNFrOHXIPdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzk5NDYxOQ==", "bodyText": "tslint error.", "url": "https://github.com/all-of-us/workbench/pull/4049#discussion_r493994619", "createdAt": "2020-09-24T01:58:23Z", "author": {"login": "aweng98"}, "path": "e2e/tests/notebook/notebook-download.spec.ts", "diffHunk": "@@ -0,0 +1,88 @@\n+import NotebookDownloadModal from 'app/page/notebook-download-modal';\n+import WorkspaceDataPage from 'app/page/workspace-data-page';\n+import {makeRandomName} from 'utils/str-utils';\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import {waitForFn} from 'utils/waits-utils';\n+\n+describe('Jupyter notebook download test', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  const testDownloadModal = async (modal: NotebookDownloadModal): Promise<void> => {\n+    let downloadBtn = await modal.getDownloadButton();\n+    expect(await downloadBtn.getProperty('disabled')).toBeTruthy();\n+\n+    await modal.clickPolicyCheckbox();\n+\n+    downloadBtn = await modal.getDownloadButton();\n+    const btnProps = await downloadBtn.getProperties();\n+    expect(btnProps['disabled']).toBeFalsy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwMTA1Mw==", "bodyText": "nit: I'd have used css selector to be consistent with others. but nothing wrong with xpath selectors.", "url": "https://github.com/all-of-us/workbench/pull/4049#discussion_r494001053", "createdAt": "2020-09-24T02:24:13Z", "author": {"login": "aweng98"}, "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -6,19 +6,28 @@ import {waitForDocumentTitle} from 'utils/waits-utils';\n import {ResourceCard} from 'app/text-labels';\n import AuthenticatedPage from './authenticated-page';\n import NotebookCell, {CellType} from './notebook-cell';\n+import NotebookDownloadModal from './notebook-download-modal';\n import WorkspaceAnalysisPage from './workspace-analysis-page';\n \n // CSS selectors\n enum CssSelector {\n   body = 'body.notebook_app',\n   notebookContainer = '#notebook-container',\n+\n   toolbarContainer = '#maintoolbar-container',\n   runCellButton = 'button[data-jupyter-action=\"jupyter-notebook:run-cell-and-select-next\"]',\n   saveNotebookButton = 'button[data-jupyter-action=\"jupyter-notebook:save-notebook\"]',\n   kernelIcon = '#kernel_indicator_icon',\n   kernelName = '.kernel_indicator_name',\n }\n \n+enum Xpath {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwMTk0NA==", "bodyText": "nit: It would also make sense to check/verify policy texts in modal window before close.", "url": "https://github.com/all-of-us/workbench/pull/4049#discussion_r494001944", "createdAt": "2020-09-24T02:27:41Z", "author": {"login": "aweng98"}, "path": "e2e/tests/notebook/notebook-download.spec.ts", "diffHunk": "@@ -0,0 +1,88 @@\n+import NotebookDownloadModal from 'app/page/notebook-download-modal';\n+import WorkspaceDataPage from 'app/page/workspace-data-page';\n+import {makeRandomName} from 'utils/str-utils';\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import {waitForFn} from 'utils/waits-utils';\n+\n+describe('Jupyter notebook download test', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  const testDownloadModal = async (modal: NotebookDownloadModal): Promise<void> => {\n+    let downloadBtn = await modal.getDownloadButton();\n+    expect(await downloadBtn.getProperty('disabled')).toBeTruthy();\n+\n+    await modal.clickPolicyCheckbox();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAxNDMyNg==", "bodyText": "This check always pass even for disabled: false because getProperty() returns a JSHandle object.\nThis code checks properly:\n   let downloadBtn = await modal.getDownloadButton();\n   // sleep 2 seconds because state of the button changes. polling for \"disable: true\" would be a nicer solution. Without sleep, `disabled` is `false` after modal is opened because the check happened too soon.\n    await page.waitFor(2000);\n    expect(await getPropValue<boolean>(downloadBtn, 'disabled')).toBe(true);\n\n    await modal.clickPolicyCheckbox();\n\n    expect(await getPropValue<boolean>(downloadBtn, 'disabled')).toBe(false);", "url": "https://github.com/all-of-us/workbench/pull/4049#discussion_r494014326", "createdAt": "2020-09-24T03:19:04Z", "author": {"login": "aweng98"}, "path": "e2e/tests/notebook/notebook-download.spec.ts", "diffHunk": "@@ -0,0 +1,88 @@\n+import NotebookDownloadModal from 'app/page/notebook-download-modal';\n+import WorkspaceDataPage from 'app/page/workspace-data-page';\n+import {makeRandomName} from 'utils/str-utils';\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import {waitForFn} from 'utils/waits-utils';\n+\n+describe('Jupyter notebook download test', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  const testDownloadModal = async (modal: NotebookDownloadModal): Promise<void> => {\n+    let downloadBtn = await modal.getDownloadButton();\n+    expect(await downloadBtn.getProperty('disabled')).toBeTruthy();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "007dd0999829f147ebc53dd5b94f643ad7ebf406", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/007dd0999829f147ebc53dd5b94f643ad7ebf406", "committedDate": "2020-09-26T00:00:22Z", "message": "Fixes, and drop validation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2OTE4MTY4", "url": "https://github.com/all-of-us/workbench/pull/4049#pullrequestreview-496918168", "createdAt": "2020-09-26T00:02:21Z", "commit": {"oid": "621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwMDowMjoyMVrOHYYlVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNlQwMDoyNTo0MFrOHYZI1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMzMDY0Nw==", "bodyText": "Oops thanks, fixed.", "url": "https://github.com/all-of-us/workbench/pull/4049#discussion_r495330647", "createdAt": "2020-09-26T00:02:21Z", "author": {"login": "calbach"}, "path": "e2e/tests/notebook/notebook-download.spec.ts", "diffHunk": "@@ -0,0 +1,88 @@\n+import NotebookDownloadModal from 'app/page/notebook-download-modal';\n+import WorkspaceDataPage from 'app/page/workspace-data-page';\n+import {makeRandomName} from 'utils/str-utils';\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import {waitForFn} from 'utils/waits-utils';\n+\n+describe('Jupyter notebook download test', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  const testDownloadModal = async (modal: NotebookDownloadModal): Promise<void> => {\n+    let downloadBtn = await modal.getDownloadButton();\n+    expect(await downloadBtn.getProperty('disabled')).toBeTruthy();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAxNDMyNg=="}, "originalCommit": {"oid": "621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMzMTA4NQ==", "bodyText": "Eh, I think I prefer without that. I'd rather use something like a snapshot test for something visual like this; testing for a string in the modal content I think is unlikely to protect against many regressions, and can break easily when we make changes.", "url": "https://github.com/all-of-us/workbench/pull/4049#discussion_r495331085", "createdAt": "2020-09-26T00:03:34Z", "author": {"login": "calbach"}, "path": "e2e/tests/notebook/notebook-download.spec.ts", "diffHunk": "@@ -0,0 +1,88 @@\n+import NotebookDownloadModal from 'app/page/notebook-download-modal';\n+import WorkspaceDataPage from 'app/page/workspace-data-page';\n+import {makeRandomName} from 'utils/str-utils';\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import {waitForFn} from 'utils/waits-utils';\n+\n+describe('Jupyter notebook download test', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  const testDownloadModal = async (modal: NotebookDownloadModal): Promise<void> => {\n+    let downloadBtn = await modal.getDownloadButton();\n+    expect(await downloadBtn.getProperty('disabled')).toBeTruthy();\n+\n+    await modal.clickPolicyCheckbox();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwMTk0NA=="}, "originalCommit": {"oid": "621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTMzOTczNQ==", "bodyText": "Tried this at first, file menu does not have a logical html structure or clear class/ids, so I had to use the text content matching for it. The download buttons I figured I may as well be self-consistent with, but these could have been done in CSS instead.", "url": "https://github.com/all-of-us/workbench/pull/4049#discussion_r495339735", "createdAt": "2020-09-26T00:25:40Z", "author": {"login": "calbach"}, "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -6,19 +6,28 @@ import {waitForDocumentTitle} from 'utils/waits-utils';\n import {ResourceCard} from 'app/text-labels';\n import AuthenticatedPage from './authenticated-page';\n import NotebookCell, {CellType} from './notebook-cell';\n+import NotebookDownloadModal from './notebook-download-modal';\n import WorkspaceAnalysisPage from './workspace-analysis-page';\n \n // CSS selectors\n enum CssSelector {\n   body = 'body.notebook_app',\n   notebookContainer = '#notebook-container',\n+\n   toolbarContainer = '#maintoolbar-container',\n   runCellButton = 'button[data-jupyter-action=\"jupyter-notebook:run-cell-and-select-next\"]',\n   saveNotebookButton = 'button[data-jupyter-action=\"jupyter-notebook:save-notebook\"]',\n   kernelIcon = '#kernel_indicator_icon',\n   kernelName = '.kernel_indicator_name',\n }\n \n+enum Xpath {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAwMTA1Mw=="}, "originalCommit": {"oid": "621904d7ed7f7a686a4dcc39249cdb6f8e15ebdd"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDk0MTY4", "url": "https://github.com/all-of-us/workbench/pull/4049#pullrequestreview-497094168", "createdAt": "2020-09-27T16:42:40Z", "commit": {"oid": "007dd0999829f147ebc53dd5b94f643ad7ebf406"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNjo0Mjo0MFrOHYofXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNjo0Mjo0MFrOHYofXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU5MTI2Mg==", "bodyText": "I like this code a lot. I can use same code pattern in other places.", "url": "https://github.com/all-of-us/workbench/pull/4049#discussion_r495591262", "createdAt": "2020-09-27T16:42:40Z", "author": {"login": "aweng98"}, "path": "e2e/tests/notebook/notebook-download.spec.ts", "diffHunk": "@@ -0,0 +1,75 @@\n+import NotebookDownloadModal from 'app/page/notebook-download-modal';\n+import WorkspaceDataPage from 'app/page/workspace-data-page';\n+import {makeRandomName} from 'utils/str-utils';\n+import {findWorkspace, signIn} from 'utils/test-utils';\n+import {getPropValue} from 'utils/element-utils';\n+import {waitForFn} from 'utils/waits-utils';\n+\n+describe('Jupyter notebook download test', () => {\n+\n+  beforeEach(async () => {\n+    await signIn(page);\n+  });\n+\n+  const testDownloadModal = async (modal: NotebookDownloadModal): Promise<void> => {\n+    const checkDownloadDisabledState = async (wantDisabled: boolean) => {\n+      expect(await waitForFn(async () => {\n+        let downloadBtn = await modal.getDownloadButton();\n+        return wantDisabled == await getPropValue<boolean>(downloadBtn, 'disabled');\n+      })).toBe(true);\n+    };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "007dd0999829f147ebc53dd5b94f643ad7ebf406"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4089, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}