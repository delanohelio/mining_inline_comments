{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxOTk5OTUx", "number": 4149, "title": "[RW-5599][risk=no] Update counts for cards on Concept Search homepage", "bodyText": "When searching on the concept homepage, update the counts on the domain & survey cards instead of switching to the table view\nRemove 'Standard concepts only' checkbox\nShow spinners on each card when updating counts\nFilter out cards with zero counts\n\n\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n I have run and tested this change locally\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer", "createdAt": "2020-10-13T05:47:37Z", "url": "https://github.com/all-of-us/workbench/pull/4149", "merged": true, "mergeCommit": {"oid": "4f71c3bf84782f1a5a0c8d7fe8d7e856ba06a920"}, "closed": true, "closedAt": "2020-10-13T18:19:23Z", "author": {"login": "dolbeew"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSLKhLgH2gAyNTAxOTk5OTUxOjkyMzNiNzUyMWU3N2Q5ODA3NTdmMzIxNDdlYTc1MTEyZDAxYWEyOTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSMr0uAFqTUwNzY5MzE2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9233b7521e77d980757f32147ea75112d01aa293", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/9233b7521e77d980757f32147ea75112d01aa293", "committedDate": "2020-10-13T16:28:19Z", "message": "RW-5599 update concept homepage search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5ffbd68911c34bfc1c768e8c905a1a22da16e88", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/f5ffbd68911c34bfc1c768e8c905a1a22da16e88", "committedDate": "2020-10-13T16:28:19Z", "message": "updating"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "913cf732e9fd2797bb8a4b099059bf930b8547cf", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/913cf732e9fd2797bb8a4b099059bf930b8547cf", "committedDate": "2020-10-13T16:28:19Z", "message": "adding api stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "108a83790931535c233146325e2f6491dd6e670d", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/108a83790931535c233146325e2f6491dd6e670d", "committedDate": "2020-10-13T16:28:19Z", "message": "adding survey count"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc9d325f64ee7197d4a3d38515cd0132a786d2e3", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/dc9d325f64ee7197d4a3d38515cd0132a786d2e3", "committedDate": "2020-10-13T16:28:19Z", "message": "adding cdrversion to context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7fd5e8943c359c4f9b9d3ede185494ebbeaa26d", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/c7fd5e8943c359c4f9b9d3ede185494ebbeaa26d", "committedDate": "2020-10-13T16:28:19Z", "message": "RW-5599 add spinners to cards when updating, remove standard checkbox"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d93f785a0a9c3a24f683c8cc069e5a7143ce75bd", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/d93f785a0a9c3a24f683c8cc069e5a7143ce75bd", "committedDate": "2020-10-13T16:28:19Z", "message": "RW-5599 update ui tests for new api calls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "741be51a9495064b2c14796128e0de51c2114c4c", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/741be51a9495064b2c14796128e0de51c2114c4c", "committedDate": "2020-10-13T16:28:19Z", "message": "RW-5599 enable local and test feature flags"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6bc2dc5c49a1e6a76ea9b1ef9714ffd65a0466e", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/b6bc2dc5c49a1e6a76ea9b1ef9714ffd65a0466e", "committedDate": "2020-10-13T16:28:19Z", "message": "RW-5599 fixing test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7693821593473c8f880f497779b235b58d57b51e", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/7693821593473c8f880f497779b235b58d57b51e", "committedDate": "2020-10-13T16:28:19Z", "message": "RW-5599 fix lint errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26663e0ffe7805c10b2ed0eb253328348a15fc89", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/26663e0ffe7805c10b2ed0eb253328348a15fc89", "committedDate": "2020-10-13T16:26:56Z", "message": "RW-5599 fix lint errors"}, "afterCommit": {"oid": "7693821593473c8f880f497779b235b58d57b51e", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/7693821593473c8f880f497779b235b58d57b51e", "committedDate": "2020-10-13T16:28:19Z", "message": "RW-5599 fix lint errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NjkzMTY3", "url": "https://github.com/all-of-us/workbench/pull/4149#pullrequestreview-507693167", "createdAt": "2020-10-13T17:54:54Z", "commit": {"oid": "7693821593473c8f880f497779b235b58d57b51e"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNzo1NDo1NFrOHgyzJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNzo1OTowMVrOHgy8sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0ODc3NQ==", "bodyText": "Should we add messages to each section that has no cards counts like databrowser?", "url": "https://github.com/all-of-us/workbench/pull/4149#discussion_r504148775", "createdAt": "2020-10-13T17:54:54Z", "author": {"login": "freemabd"}, "path": "ui/src/app/pages/data/concept/concept-homepage.tsx", "diffHunk": "@@ -134,31 +134,35 @@ interface ConceptCacheItem {\n }\n \n const DomainCard: React.FunctionComponent<{conceptDomainInfo: DomainInfo,\n-  standardConceptsOnly: boolean, browseInDomain: Function}> =\n-    ({conceptDomainInfo, standardConceptsOnly, browseInDomain}) => {\n+  standardConceptsOnly: boolean, browseInDomain: Function, updating: boolean}> =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7693821593473c8f880f497779b235b58d57b51e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0OTY2Nw==", "bodyText": "may have to change this to call all domains at once.", "url": "https://github.com/all-of-us/workbench/pull/4149#discussion_r504149667", "createdAt": "2020-10-13T17:56:30Z", "author": {"login": "freemabd"}, "path": "ui/src/app/pages/data/concept/concept-homepage.tsx", "diffHunk": "@@ -341,6 +354,33 @@ export const ConceptHomepage = fp.flow(withCurrentWorkspace(), withCurrentConcep\n       this.setState({loadingDomains: false});\n     }\n \n+    async updateCardCounts() {\n+      const {cdrVersionId} = this.props.workspace;\n+      const {conceptDomainList, conceptSurveysList, currentInputString} = this.state;\n+      this.setState({\n+        domainsLoading: conceptDomainList.map(domain => domain.domain),\n+        surveysLoading: conceptSurveysList.map(survey => survey.name),\n+      });\n+      const promises = [];\n+      conceptDomainList.forEach(conceptDomain => {\n+        promises.push(cohortBuilderApi().findDomainCount(+cdrVersionId, conceptDomain.domain.toString(), currentInputString)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7693821593473c8f880f497779b235b58d57b51e"}, "originalPosition": 143}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE0OTg3NQ==", "bodyText": "may have to change this to call all surveys at once.", "url": "https://github.com/all-of-us/workbench/pull/4149#discussion_r504149875", "createdAt": "2020-10-13T17:56:51Z", "author": {"login": "freemabd"}, "path": "ui/src/app/pages/data/concept/concept-homepage.tsx", "diffHunk": "@@ -341,6 +354,33 @@ export const ConceptHomepage = fp.flow(withCurrentWorkspace(), withCurrentConcep\n       this.setState({loadingDomains: false});\n     }\n \n+    async updateCardCounts() {\n+      const {cdrVersionId} = this.props.workspace;\n+      const {conceptDomainList, conceptSurveysList, currentInputString} = this.state;\n+      this.setState({\n+        domainsLoading: conceptDomainList.map(domain => domain.domain),\n+        surveysLoading: conceptSurveysList.map(survey => survey.name),\n+      });\n+      const promises = [];\n+      conceptDomainList.forEach(conceptDomain => {\n+        promises.push(cohortBuilderApi().findDomainCount(+cdrVersionId, conceptDomain.domain.toString(), currentInputString)\n+          .then(domainCount => {\n+            conceptDomain.allConceptCount = domainCount.conceptCount;\n+            this.setState({domainsLoading: this.state.domainsLoading.filter(domain => domain !== conceptDomain.domain)});\n+          })\n+        );\n+      });\n+      conceptSurveysList.forEach(conceptSurvey => {\n+        promises.push(cohortBuilderApi().findSurveyCount(+cdrVersionId, conceptSurvey.name, currentInputString)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7693821593473c8f880f497779b235b58d57b51e"}, "originalPosition": 151}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE1MDg3Mw==", "bodyText": "Depending on how fast this returns, we may need to make this endpoint run once for all domains.", "url": "https://github.com/all-of-us/workbench/pull/4149#discussion_r504150873", "createdAt": "2020-10-13T17:58:27Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/CohortBuilderController.java", "diffHunk": "@@ -187,11 +190,24 @@\n   }\n \n   @Override\n-  public ResponseEntity<DomainInfoResponse> findDomainInfos(Long cdrVersionId, String term) {\n+  public ResponseEntity<DomainCount> findDomainCount(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7693821593473c8f880f497779b235b58d57b51e"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE1MTIxOA==", "bodyText": "Again, may need to refactor this to run all surveys at once.", "url": "https://github.com/all-of-us/workbench/pull/4149#discussion_r504151218", "createdAt": "2020-10-13T17:59:01Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/CohortBuilderController.java", "diffHunk": "@@ -221,10 +237,17 @@\n   }\n \n   @Override\n-  public ResponseEntity<SurveysResponse> findSurveyModules(Long cdrVersionId, String term) {\n+  public ResponseEntity<SurveyCount> findSurveyCount(Long cdrVersionId, String name, String term) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7693821593473c8f880f497779b235b58d57b51e"}, "originalPosition": 85}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3943, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}