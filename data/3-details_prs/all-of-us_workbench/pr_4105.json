{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NjE3MzU0", "number": 4105, "title": "[no ticket][risk=no] Puppeteer test suite wait timeout reduction", "bodyText": "Set global Navigation Timeout to 60 seconds, reducing from 90 seconds.\nSet all other global Timeout to 10 seconds, reducing from 90 seconds.\nCustom longer timeout is used in targeted functions.\nThis change will shorten wait time for Puppeteer test suites to finish. Some functions could turn flaky, cause tests to fail. But I can deal them individually when flaky happens.", "createdAt": "2020-10-02T00:33:24Z", "url": "https://github.com/all-of-us/workbench/pull/4105", "merged": true, "mergeCommit": {"oid": "2ef309ca4e921dd0d96a7dfc38e87acbb6ca3f31"}, "closed": true, "closedAt": "2020-10-02T21:37:23Z", "author": {"login": "aweng98"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOZB69AH2gAyNDk2NjE3MzU0OmVhYjczNTkzZmNjMDIxMTZhYmYyOWZlOTVjZDRkMTY4YTUyOWFiMzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOtAxogFqTUwMTQ2MTQwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eab73593fcc02116abf29fe95cd4d168a529ab39", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/eab73593fcc02116abf29fe95cd4d168a529ab39", "committedDate": "2020-10-01T22:21:54Z", "message": "wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11316bdf9fbc63bcb6b96db6b56b15d86c14481e", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/11316bdf9fbc63bcb6b96db6b56b15d86c14481e", "committedDate": "2020-10-01T22:42:15Z", "message": "wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cebdd9a7285672ca1eefbc99d3f85adde62f34e2", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/cebdd9a7285672ca1eefbc99d3f85adde62f34e2", "committedDate": "2020-10-02T00:32:15Z", "message": "fix broken tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18606d53a5c49a1e33e38a7a226eaa4b95b959ff", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/18606d53a5c49a1e33e38a7a226eaa4b95b959ff", "committedDate": "2020-10-02T00:38:07Z", "message": "revert waits-utils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwODAwODcy", "url": "https://github.com/all-of-us/workbench/pull/4105#pullrequestreview-500800872", "createdAt": "2020-10-02T00:33:51Z", "commit": {"oid": "cebdd9a7285672ca1eefbc99d3f85adde62f34e2"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwMDozMzo1MVrOHbei3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwMDozNjo0M1rOHbelMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NDA0NA==", "bodyText": "not used so I'm removing them.", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r498574044", "createdAt": "2020-10-02T00:33:51Z", "author": {"login": "aweng98"}, "path": "e2e/.env.sample", "diffHunk": "@@ -2,11 +2,3 @@\n USER_NAME=??\n # Workbench login password. Alternatively, set \"PASSWORD\" environment variable in the yarn command.\n PASSWORD=??\n-\n-# Puppeteer env\n-PUPPETEER_HEADLESS=true\n-# Slows down test playback speed in milliseconds\n-PUPPETEER_SLOWMO=10\n-# Time out in milliseconds\n-PUPPETEER_NAVIGATION_TIMEOUT=90000\n-PUPPETEER_TIMEOUT=90000", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cebdd9a7285672ca1eefbc99d3f85adde62f34e2"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NDI4NA==", "bodyText": "notebook Kernel to become ready could take a long time. So setting the timeout to 2 minutes.", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r498574284", "createdAt": "2020-10-02T00:35:06Z", "author": {"login": "aweng98"}, "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -190,10 +190,11 @@ export default class NotebookPage extends AuthenticatedPage {\n     }\n     await cellInput.dispose();\n     await this.run();\n-    await this.waitForKernelIdle(opts.timeOut);\n+    const {timeOut = 120000} = opts;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cebdd9a7285672ca1eefbc99d3f85adde62f34e2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NDQzNA==", "bodyText": "To fail CI e2e job little quicker.", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r498574434", "createdAt": "2020-10-02T00:35:46Z", "author": {"login": "aweng98"}, "path": "e2e/jest.config.js", "diffHunk": "@@ -3,7 +3,7 @@ const { TEST_MODE } = process.env;\n \n module.exports = {\n   \"verbose\": true,\n-  \"bail\": 3,  // Stop running tests after `n` failures\n+  \"bail\": 2,  // Stop running tests after `n` failures", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cebdd9a7285672ca1eefbc99d3f85adde62f34e2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NDY0Mw==", "bodyText": "width:1280, height:680 is based on 15\" mac pro screen size.", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r498574643", "createdAt": "2020-10-02T00:36:43Z", "author": {"login": "aweng98"}, "path": "e2e/jest.test-setup.ts", "diffHunk": "@@ -14,9 +12,9 @@ const isDebugMode = process.argv.includes('--debug');\n  */\n beforeEach(async () => {\n   await page.setUserAgent(userAgent);\n-  // See https://github.com/puppeteer/puppeteer/blob/master/docs/api.md#pagesetdefaultnavigationtimeouttimeout\n-  page.setDefaultNavigationTimeout(navTimeOut);\n-  page.setDefaultTimeout(timeOut);\n+  await page.setViewport({width: 1280, height: 680});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cebdd9a7285672ca1eefbc99d3f85adde62f34e2"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c118fc69b5ec853252af4326f9efd7064105bd92", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/c118fc69b5ec853252af4326f9efd7064105bd92", "committedDate": "2020-10-02T14:32:13Z", "message": "login fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a8d6819d9e04d3cdc34d8815bf274889d906b0b", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/3a8d6819d9e04d3cdc34d8815bf274889d906b0b", "committedDate": "2020-10-02T14:58:48Z", "message": "wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93", "committedDate": "2020-10-02T20:55:42Z", "message": "revert non-related changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNDQ1NTA4", "url": "https://github.com/all-of-us/workbench/pull/4105#pullrequestreview-501445508", "createdAt": "2020-10-02T21:01:58Z", "commit": {"oid": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMTowMTo1OVrOHb7hJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMTowMTo1OVrOHb7hJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA0ODc0Mw==", "bodyText": "setViewport might prevents bad click in Chrome headless mode.", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499048743", "createdAt": "2020-10-02T21:01:59Z", "author": {"login": "aweng98"}, "path": "e2e/jest.test-setup.ts", "diffHunk": "@@ -14,9 +12,9 @@ const isDebugMode = process.argv.includes('--debug');\n  */\n beforeEach(async () => {\n   await page.setUserAgent(userAgent);\n-  // See https://github.com/puppeteer/puppeteer/blob/master/docs/api.md#pagesetdefaultnavigationtimeouttimeout\n-  page.setDefaultNavigationTimeout(navTimeOut);\n-  page.setDefaultTimeout(timeOut);\n+  await page.setViewport({width: 1280, height: 680});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNDQ4NjE3", "url": "https://github.com/all-of-us/workbench/pull/4105#pullrequestreview-501448617", "createdAt": "2020-10-02T21:07:48Z", "commit": {"oid": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMTowNzo0OFrOHb7qDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMToxMDo1N1rOHb7uNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MTAyMQ==", "bodyText": "My first computer only had 512x342. \ud83d\udc74 Native res on a Mac Pro 15\" is 2880 x 1800.", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499051021", "createdAt": "2020-10-02T21:07:48Z", "author": {"login": "jaycarlton"}, "path": "e2e/jest.test-setup.ts", "diffHunk": "@@ -14,9 +12,9 @@ const isDebugMode = process.argv.includes('--debug');\n  */\n beforeEach(async () => {\n   await page.setUserAgent(userAgent);\n-  // See https://github.com/puppeteer/puppeteer/blob/master/docs/api.md#pagesetdefaultnavigationtimeouttimeout\n-  page.setDefaultNavigationTimeout(navTimeOut);\n-  page.setDefaultTimeout(timeOut);\n+  await page.setViewport({width: 1280, height: 680});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODU3NDY0Mw=="}, "originalCommit": {"oid": "cebdd9a7285672ca1eefbc99d3f85adde62f34e2"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MTQ2Nw==", "bodyText": "Is there a way to collect data on how long some of these actions take? Like record them to a spreadsheet or something? It would be interesting to see if 80% were under 2 seconds or something.", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499051467", "createdAt": "2020-10-02T21:09:07Z", "author": {"login": "jaycarlton"}, "path": "e2e/jest.test-setup.ts", "diffHunk": "@@ -14,9 +12,9 @@ const isDebugMode = process.argv.includes('--debug');\n  */\n beforeEach(async () => {\n   await page.setUserAgent(userAgent);\n-  // See https://github.com/puppeteer/puppeteer/blob/master/docs/api.md#pagesetdefaultnavigationtimeouttimeout\n-  page.setDefaultNavigationTimeout(navTimeOut);\n-  page.setDefaultTimeout(timeOut);\n+  await page.setViewport({width: 1280, height: 680});\n+  page.setDefaultNavigationTimeout(60000); // Puppeteer default timeout is 30 seconds.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MTg1Mw==", "bodyText": "this still seems high for signin. I feel like if it's  going to succeed, it'll do so in 10 seconds.", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499051853", "createdAt": "2020-10-02T21:10:16Z", "author": {"login": "jaycarlton"}, "path": "e2e/utils/test-utils.ts", "diffHunk": "@@ -14,11 +14,12 @@ import {WorkspaceAccessLevel} from 'app/text-labels';\n import WorkspacesPage from 'app/page/workspaces-page';\n import {makeWorkspaceName} from './str-utils';\n \n+\n export async function signIn(page: Page, userId?: string, passwd?: string): Promise<void> {\n   const loginPage = new GoogleLoginPage(page);\n   await loginPage.login(userId, passwd);\n   // this element exists in DOM after user has logged in\n-  await page.waitForFunction(() => !!document.querySelector('app-signed-in'));\n+  await page.waitForFunction(() => !!document.querySelector('app-signed-in'), {timeout: 60000});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MjA4Nw==", "bodyText": "maybe default to 20 seconds and only go higher when timeOut is provided.", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499052087", "createdAt": "2020-10-02T21:10:57Z", "author": {"login": "jaycarlton"}, "path": "e2e/utils/test-utils.ts", "diffHunk": "@@ -44,7 +45,7 @@ export async function signInAs(userId: string, passwd: string): Promise<Page> {\n  * It usually indicates the page is ready for user interaction.\n  * </pre>\n  */\n-export async function waitWhileLoading(page: Page, timeOut?: number): Promise<void> {\n+export async function waitWhileLoading(page: Page, timeOut: number = 90000): Promise<void> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNDYxNDA0", "url": "https://github.com/all-of-us/workbench/pull/4105#pullrequestreview-501461404", "createdAt": "2020-10-02T21:37:03Z", "commit": {"oid": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMTozNzowM1rOHb8Q9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQyMTozODo0MlrOHb8TKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2MDk4Mw==", "bodyText": "The legitimate issue that's being mitigated here is that our servers are very slow on initial start up, and we're constantly pushing new versions to test. Without building some leniency into the test process, we're likely to see frequent failures from that. Reducing the server startup time or smoothing out the traffic shift on deployment are all reasonable mitigations to this that may be worth pursuing.", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499060983", "createdAt": "2020-10-02T21:37:03Z", "author": {"login": "calbach"}, "path": "e2e/utils/test-utils.ts", "diffHunk": "@@ -14,11 +14,12 @@ import {WorkspaceAccessLevel} from 'app/text-labels';\n import WorkspacesPage from 'app/page/workspaces-page';\n import {makeWorkspaceName} from './str-utils';\n \n+\n export async function signIn(page: Page, userId?: string, passwd?: string): Promise<void> {\n   const loginPage = new GoogleLoginPage(page);\n   await loginPage.login(userId, passwd);\n   // this element exists in DOM after user has logged in\n-  await page.waitForFunction(() => !!document.querySelector('app-signed-in'));\n+  await page.waitForFunction(() => !!document.querySelector('app-signed-in'), {timeout: 60000});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA1MTg1Mw=="}, "originalCommit": {"oid": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTA2MTU0Nw==", "bodyText": "Thanks for adding this  - it's probably worth removing from the handful of tests where I've explicitly called it as well.", "url": "https://github.com/all-of-us/workbench/pull/4105#discussion_r499061547", "createdAt": "2020-10-02T21:38:42Z", "author": {"login": "calbach"}, "path": "e2e/jest.test-setup.ts", "diffHunk": "@@ -14,9 +12,9 @@ const isDebugMode = process.argv.includes('--debug');\n  */\n beforeEach(async () => {\n   await page.setUserAgent(userAgent);\n-  // See https://github.com/puppeteer/puppeteer/blob/master/docs/api.md#pagesetdefaultnavigationtimeouttimeout\n-  page.setDefaultNavigationTimeout(navTimeOut);\n-  page.setDefaultTimeout(timeOut);\n+  await page.setViewport({width: 1280, height: 680});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80de2a7ce7f41f1e4bd35dbdab63a7e69f220d93"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4155, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}