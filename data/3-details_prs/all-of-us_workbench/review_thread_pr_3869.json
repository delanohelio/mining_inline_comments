{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MDc0NTYy", "number": 3869, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNToyMjoxNlrOEXQy_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNToyNjo0NVrOEXQ6_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyODI3OTAwOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/reporting/ReportingUploadServiceImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNToyMjoxNlrOG-9Dpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNToyMjoxNlrOG-9Dpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY2NTI1NA==", "bodyText": "spelling", "url": "https://github.com/all-of-us/workbench/pull/3869#discussion_r468665254", "createdAt": "2020-08-11T15:22:16Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/reporting/ReportingUploadServiceImpl.java", "diffHunk": "@@ -61,11 +64,20 @@ private TableResult executeWithTimeout(QueryJobConfiguration job) {\n \n   private List<QueryJobConfiguration> getJobs(ReportingSnapshot reportingSnapshot) {\n     final QueryParameterValue snapshotTimestamp = getTimestampValue(reportingSnapshot);\n-    return ImmutableList.of(\n-        researcherJobBuilder.build(\n-            qualifyTableName(\"researcher\"), reportingSnapshot.getResearchers(), snapshotTimestamp),\n-        workspaceJobBuilder.build(\n-            qualifyTableName(\"workspace\"), reportingSnapshot.getWorkspaces(), snapshotTimestamp));\n+    final ImmutableList.Builder<QueryJobConfiguration> resultBuilder = new Builder<>();\n+    Lists.partition(reportingSnapshot.getResearchers(), INSERT_ROW_COUNT).stream()\n+        .map(\n+            researchers ->\n+                researcherJobBuilder.build(\n+                    qualifyTableName(\"researcher\"), researchers, snapshotTimestamp))\n+        .forEach(resultBuilder::add);\n+    Lists.partition(reportingSnapshot.getWorkspaces(), INSERT_ROW_COUNT).stream()\n+        .map(\n+            workrspaces ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8323c1a853c24f5e58aa3ed4e7f96eb4cfd41afd"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyODI5OTUxOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/reporting/ReportingUploadServiceTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNToyNjo0NVrOG-9Qfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNTozOTo0OVrOG-90tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY2ODU0Mw==", "bodyText": "This assertion is for the final job and therefore should be get(5)", "url": "https://github.com/all-of-us/workbench/pull/3869#discussion_r468668543", "createdAt": "2020-08-11T15:26:45Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/reporting/ReportingUploadServiceTest.java", "diffHunk": "@@ -128,4 +129,45 @@ public void testUploadSnapshot() {\n \n     assertThat(expandedQuery).containsMatch(\"INSERT\\\\s+INTO\");\n   }\n+\n+  @Test\n+  public void testUploadSnapshot_batchInserts() {\n+    final ReportingSnapshot largeSnapshot =\n+        new ReportingSnapshot().captureTimestamp(NOW.toEpochMilli());\n+    // It's certainly possible to make the batch size an environment configuration value and\n+    // inject it so that we don't need this many rows in the test, but I didn't think that was\n+    // necessarily a good enoughh reason to add configurable state.\n+    final List<ReportingResearcher> researchers =\n+        IntStream.range(0, 2001)\n+            .mapToObj(\n+                id ->\n+                    new ReportingResearcher()\n+                        .username(\"bill@aou.biz\")\n+                        .firstName(\"Bill\")\n+                        .isDisabled(false)\n+                        .researcherId((long) id))\n+            .collect(ImmutableList.toImmutableList());\n+    largeSnapshot.setResearchers(researchers);\n+    largeSnapshot.setWorkspaces(\n+        ImmutableList.of(\n+            new ReportingWorkspace()\n+                .name(\"Circle K\")\n+                .creationTime(THEN.toEpochMilli())\n+                .fakeSize(4444L)\n+                .creatorId(101L)));\n+\n+    reportingUploadService.uploadSnapshot(largeSnapshot);\n+    verify(mockBigQueryService, times(6))\n+        .executeQuery(queryJobConfigurationCaptor.capture(), anyLong());\n+\n+    final List<QueryJobConfiguration> jobs = queryJobConfigurationCaptor.getAllValues();\n+    assertThat(jobs).hasSize(6);\n+    final int researcherColumnCount = 4;\n+    final int workspaceColumnCount = 5;\n+\n+    assertThat(jobs.get(0).getNamedParameters()).hasSize(researcherColumnCount * 500 + 1);\n+    assertThat(jobs.get(4).getNamedParameters()).hasSize(researcherColumnCount * 1 + 1);\n+\n+    assertThat(jobs.get(4).getNamedParameters()).hasSize(workspaceColumnCount * 1 + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8323c1a853c24f5e58aa3ed4e7f96eb4cfd41afd"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY3NzgxNA==", "bodyText": "Circle test is correctly failing here", "url": "https://github.com/all-of-us/workbench/pull/3869#discussion_r468677814", "createdAt": "2020-08-11T15:39:49Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/reporting/ReportingUploadServiceTest.java", "diffHunk": "@@ -128,4 +129,45 @@ public void testUploadSnapshot() {\n \n     assertThat(expandedQuery).containsMatch(\"INSERT\\\\s+INTO\");\n   }\n+\n+  @Test\n+  public void testUploadSnapshot_batchInserts() {\n+    final ReportingSnapshot largeSnapshot =\n+        new ReportingSnapshot().captureTimestamp(NOW.toEpochMilli());\n+    // It's certainly possible to make the batch size an environment configuration value and\n+    // inject it so that we don't need this many rows in the test, but I didn't think that was\n+    // necessarily a good enoughh reason to add configurable state.\n+    final List<ReportingResearcher> researchers =\n+        IntStream.range(0, 2001)\n+            .mapToObj(\n+                id ->\n+                    new ReportingResearcher()\n+                        .username(\"bill@aou.biz\")\n+                        .firstName(\"Bill\")\n+                        .isDisabled(false)\n+                        .researcherId((long) id))\n+            .collect(ImmutableList.toImmutableList());\n+    largeSnapshot.setResearchers(researchers);\n+    largeSnapshot.setWorkspaces(\n+        ImmutableList.of(\n+            new ReportingWorkspace()\n+                .name(\"Circle K\")\n+                .creationTime(THEN.toEpochMilli())\n+                .fakeSize(4444L)\n+                .creatorId(101L)));\n+\n+    reportingUploadService.uploadSnapshot(largeSnapshot);\n+    verify(mockBigQueryService, times(6))\n+        .executeQuery(queryJobConfigurationCaptor.capture(), anyLong());\n+\n+    final List<QueryJobConfiguration> jobs = queryJobConfigurationCaptor.getAllValues();\n+    assertThat(jobs).hasSize(6);\n+    final int researcherColumnCount = 4;\n+    final int workspaceColumnCount = 5;\n+\n+    assertThat(jobs.get(0).getNamedParameters()).hasSize(researcherColumnCount * 500 + 1);\n+    assertThat(jobs.get(4).getNamedParameters()).hasSize(researcherColumnCount * 1 + 1);\n+\n+    assertThat(jobs.get(4).getNamedParameters()).hasSize(workspaceColumnCount * 1 + 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY2ODU0Mw=="}, "originalCommit": {"oid": "8323c1a853c24f5e58aa3ed4e7f96eb4cfd41afd"}, "originalPosition": 60}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2519, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}