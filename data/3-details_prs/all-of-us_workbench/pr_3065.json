{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MzA1NDk5", "number": 3065, "title": "[RW-4091][RISK=NO]Fix exportWorkspace error", "bodyText": "exportToWorkspace call was throwing a lot of 404 error while collecting collaborator list, as part of this PR we now use workspaceService to collect the collaborators list as well as enclose the call in try catch to handle exception\n\nPR checklist\n\n[ X] This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n[ X] I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-01-30T21:47:34Z", "url": "https://github.com/all-of-us/workbench/pull/3065", "merged": true, "mergeCommit": {"oid": "ef54d00bc90804a982ba2ffa69461be01358256d"}, "closed": true, "closedAt": "2020-02-03T18:53:12Z", "author": {"login": "NehaBroad"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_hptbgH2gAyMzY5MzA1NDk5OjlkN2EzYzQ2Y2E5MjI5NmYxNTBhNDI1Njg1OGVhZjM0MGFhMTk0OGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcAxj_4gFqTM1MjQ4MDE5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9d7a3c46ca92296f150a4256858eaf340aa1948b", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/9d7a3c46ca92296f150a4256858eaf340aa1948b", "committedDate": "2020-01-30T21:44:35Z", "message": "Fix exportWorkspace error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMTcyOTUx", "url": "https://github.com/all-of-us/workbench/pull/3065#pullrequestreview-351172951", "createdAt": "2020-01-30T22:01:39Z", "commit": {"oid": "9d7a3c46ca92296f150a4256858eaf340aa1948b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMjowMTozOVrOFj7YOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMjowMzowNlrOFj7aog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNzMzOA==", "bodyText": "Naming nit: for consistency w/ the class name, prefer 'workspaceService' as the member variable name.", "url": "https://github.com/all-of-us/workbench/pull/3065#discussion_r373217338", "createdAt": "2020-01-30T22:01:39Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java", "diffHunk": "@@ -42,6 +41,7 @@\n   private RdrExportDao rdrExportDao;\n   private WorkspaceDao workspaceDao;\n   private UserDao userDao;\n+  private WorkspaceService workspacesApi;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d7a3c46ca92296f150a4256858eaf340aa1948b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzIxNzk1NA==", "bodyText": "Will the RDR really be happy to receive a totally-empty entry for workspace users? I might have expected here to either: (1) skip exporting this workspace entirely, since the collaborators list is pretty important to the state of the workspace, or (2) leave the collaborators list empty.", "url": "https://github.com/all-of-us/workbench/pull/3065#discussion_r373217954", "createdAt": "2020-01-30T22:03:06Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java", "diffHunk": "@@ -245,22 +247,28 @@ private RdrWorkspace toRdrWorkspace(DbWorkspace dbWorkspace) {\n     rdrWorkspace.setIntendToStudy(dbWorkspace.getIntendedStudy());\n     rdrWorkspace.setFindingsFromStudy(dbWorkspace.getAnticipatedFindings());\n \n-    // Call Firecloud to get a list of Collaborators\n-    FirecloudWorkspaceACL firecloudResponse =\n-        fireCloudService.getWorkspaceAcl(\n-            dbWorkspace.getWorkspaceNamespace(), dbWorkspace.getFirecloudName());\n-    Map<String, FirecloudWorkspaceAccessEntry> aclMap = firecloudResponse.getAcl();\n+    try {\n+      // Call Firecloud to get a list of Collaborators\n+      List<UserRole> collaboratorsMap =\n+          workspacesApi.getFirecloudUserRoles(\n+              dbWorkspace.getWorkspaceNamespace(), dbWorkspace.getFirecloudName());\n \n-    // Since the USERS cannot be deleted from workbench yet, hence sending the the status of\n-    // COLLABORATOR as ACTIVE\n-    aclMap.forEach(\n-        (email, access) -> {\n-          RdrWorkspaceUser workspaceUserMap = new RdrWorkspaceUser();\n-          workspaceUserMap.setUserId((int) userDao.findUserByUsername(email).getUserId());\n-          workspaceUserMap.setRole(RdrWorkspaceUser.RoleEnum.fromValue(access.getAccessLevel()));\n-          workspaceUserMap.setStatus(RdrWorkspaceUser.StatusEnum.ACTIVE);\n-          rdrWorkspace.addWorkspaceUsersItem(workspaceUserMap);\n-        });\n+      // Since the USERS cannot be deleted from workbench yet, hence sending the the status of\n+      // COLLABORATOR as ACTIVE\n+      collaboratorsMap.forEach(\n+          (userRole) -> {\n+            RdrWorkspaceUser workspaceUserMap = new RdrWorkspaceUser();\n+            workspaceUserMap.setUserId(\n+                (int) userDao.findUserByUsername(userRole.getEmail()).getUserId());\n+            workspaceUserMap.setRole(\n+                RdrWorkspaceUser.RoleEnum.fromValue(userRole.getRole().toString()));\n+            workspaceUserMap.setStatus(RdrWorkspaceUser.StatusEnum.ACTIVE);\n+            rdrWorkspace.addWorkspaceUsersItem(workspaceUserMap);\n+          });\n+    } catch (Exception ex) {\n+      log.warning(\"Exception while retrieving workspace Collaborators\");\n+      rdrWorkspace.addWorkspaceUsersItem(new RdrWorkspaceUser());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d7a3c46ca92296f150a4256858eaf340aa1948b"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08e2e7954cf6caf2aca3e0ed5b6cbad43f9d68a5", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/08e2e7954cf6caf2aca3e0ed5b6cbad43f9d68a5", "committedDate": "2020-01-31T02:35:36Z", "message": "variable name change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f0266bb52ae5355f2abfcdfd4458c3dbb89173e", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/3f0266bb52ae5355f2abfcdfd4458c3dbb89173e", "committedDate": "2020-02-03T15:36:22Z", "message": "In case of error while retirving collaborators list, skipping workspace from list to RDR export"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNDgwMTk3", "url": "https://github.com/all-of-us/workbench/pull/3065#pullrequestreview-352480197", "createdAt": "2020-02-03T18:50:45Z", "commit": {"oid": "3f0266bb52ae5355f2abfcdfd4458c3dbb89173e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3768, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}