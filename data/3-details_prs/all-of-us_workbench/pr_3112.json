{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNTA3MTYx", "number": 3112, "title": "[RW-4303][risk=no] Refactor datasets page and fix race conditions", "bodyText": "Key changes:\n\nConsolidate domain/value set loading through one pathway\n\nThe original trigger is setting state.selectedDomains\nSubsequent loading and autoselection of domain values is done in componentDidUpdate\n\n\nAdd a unified loading/lookup layer for domain -> valueSets\nSwitched prepackaged concept set representation from boolean -> Set<demograpics|surveys>\n\nDemo @ http://calbach-dot-all-of-us-workbench-test.appspot.com/\nAlso identified several areas for further simplification here.", "createdAt": "2020-02-11T07:19:47Z", "url": "https://github.com/all-of-us/workbench/pull/3112", "merged": true, "mergeCommit": {"oid": "37b49869dd13f1fef17205ab1171e6666e383f3d"}, "closed": true, "closedAt": "2020-02-13T02:21:48Z", "author": {"login": "calbach"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDMewzgH2gAyMzczNTA3MTYxOmU1MmVhNjBlNGFjZGQxMWZiNTNjN2U1ZGNlMTBlZDU2OGNmZWI2YWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDxPNcgFqTM1NzkxNDA4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af", "committedDate": "2020-02-11T07:20:19Z", "message": "Fix datasets freeze"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8ab6697eb2456e4e64cb2f4161eccd6f92b50fe", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/d8ab6697eb2456e4e64cb2f4161eccd6f92b50fe", "committedDate": "2020-02-11T07:13:42Z", "message": "Fix datasets freeze"}, "afterCommit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af", "committedDate": "2020-02-11T07:20:19Z", "message": "Fix datasets freeze"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NzE4NDY3", "url": "https://github.com/all-of-us/workbench/pull/3112#pullrequestreview-356718467", "createdAt": "2020-02-11T14:50:45Z", "commit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDo1MDo0NVrOFoL4Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDo1MDo0NVrOFoL4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4MTk3MQ==", "bodyText": "Is there a ticket for the refactor here? If not, we probably should file one.", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377681971", "createdAt": "2020-02-11T14:50:45Z", "author": {"login": "s-rubenstein"}, "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "diffHunk": "@@ -426,47 +444,100 @@ const DataSetPage = fp.flow(withUserProfile(), withCurrentWorkspace(), withUrlPa\n \n     async componentDidMount() {\n       const {namespace, id} = this.props.workspace;\n-      const allPromises = [];\n-      allPromises.push(this.loadResources());\n-      if (this.editing) {\n-        allPromises.push(dataSetApi().getDataSet(\n-          namespace, id, this.props.urlParams.dataSetId).then((response) => {\n-            this.setState({\n-              dataSet: response,\n-              includesAllParticipants: response.includesAllParticipants,\n-              selectedConceptSetIds: response.conceptSets.map(cs => cs.id),\n-              selectedCohortIds: response.cohorts.map(c => c.id),\n-              selectedDomainValuePairs: response.domainValuePairs,\n-              valuesLoading: true,\n-            });\n-            if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.BOTH) {\n-              this.setState({prePackagedSurvey: true, prePackagedDemographics: true});\n-            } else if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.DEMOGRAPHICS) {\n-              this.setState({prePackagedDemographics: true});\n-            } else if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.SURVEY) {\n-              this.setState({prePackagedSurvey: true});\n+      const resourcesPromise = this.loadResources();\n+      if (!this.editing) {\n+        return;\n+      }\n+\n+      const [, dataSet] = await Promise.all([\n+        resourcesPromise,\n+        dataSetApi().getDataSet(namespace, id, this.props.urlParams.dataSetId)\n+      ]);\n+\n+      const selectedPrepackagedConceptSets = this.apiEnumToPrePackageConceptSets(dataSet.prePackagedConceptSet);\n+      this.setState({\n+        dataSet,\n+        includesAllParticipants: dataSet.includesAllParticipants,\n+        selectedConceptSetIds: dataSet.conceptSets.map(cs => cs.id),\n+        selectedCohortIds: dataSet.cohorts.map(c => c.id),\n+        selectedDomainValuePairs: dataSet.domainValuePairs,\n+        selectedDomains: this.getDomainsFromConceptSets(dataSet.conceptSets, selectedPrepackagedConceptSets),\n+        selectedPrepackagedConceptSets,\n+      });\n+    }\n+\n+    async componentDidUpdate({}, prevState: State) {\n+      // After a state update, first check whether any new domains have been added.\n+      const newDomains = Array.from(this.state.selectedDomains)\n+          .filter(d => !prevState.selectedDomains.has(d));\n+      if (!newDomains.length) {\n+        return;\n+      }\n+\n+      // TODO: There is a lot of complexity here around loading domain values\n+      // which is static data for a given CDR version. Consider refactoring this", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af"}, "originalPosition": 309}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1da0e34a91b146aef4bfac947b801b37feca16c", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/d1da0e34a91b146aef4bfac947b801b37feca16c", "committedDate": "2020-02-11T18:22:10Z", "message": "link ticket"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2ODgwMjEy", "url": "https://github.com/all-of-us/workbench/pull/3112#pullrequestreview-356880212", "createdAt": "2020-02-11T18:11:49Z", "commit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxODoxMTo0OVrOFoTmPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxODoyMzoxNVrOFoT87A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwODQ0Ng==", "bodyText": "@NehaBroad @blrubenstein  I could not understand what was going on here with this .survey value. I didn't find any comments hinting at the rationale for this. I removed it in my PR because it was a potential source of bugs/inconsistency. If this is tracking a real requirement, let me know.\nRelatedly, I'm confused by this line: https://github.com/all-of-us/workbench/blob/master/ui/src/app/pages/data/data-set/dataset-page.tsx#L1010", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377808446", "createdAt": "2020-02-11T18:11:49Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "diffHunk": "@@ -919,25 +934,27 @@ const DataSetPage = fp.flow(withUserProfile(), withCurrentWorkspace(), withUrlPa\n                       </div>\n                     </div>\n                   </BoxHeader>\n-                  <div style={{height: valueSets.length > 0 ? '7.625rem' : '9rem', overflowY: 'auto'}}>\n-                    {valuesLoading && <Spinner style={{position: 'relative',\n+                  <div style={{height: selectedDomains.size > 0 ? '7.625rem' : '9rem', overflowY: 'auto'}}>\n+                    {domainValueSetIsLoading.size > 0 && <Spinner style={{position: 'relative',\n                       top: '2rem', left: 'calc(50% - 36px)'}}/>}\n-                    {valueSets.map(valueSet =>\n-                      <div key={valueSet.domain}>\n+                    {Array.from(selectedDomains).map(domain =>\n+                      domainValueSetLookup.has(domain) &&\n+                      <div key={domain}>\n                         <Subheader style={{fontWeight: 'bold'}}>\n-                          {valueSet.survey ? 'Survey' : formatDomain(valueSet.domain)}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af"}, "originalPosition": 777}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxNDI1Mg==", "bodyText": "Filed https://precisionmedicineinitiative.atlassian.net/browse/RW-4426", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377814252", "createdAt": "2020-02-11T18:23:15Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "diffHunk": "@@ -426,47 +444,100 @@ const DataSetPage = fp.flow(withUserProfile(), withCurrentWorkspace(), withUrlPa\n \n     async componentDidMount() {\n       const {namespace, id} = this.props.workspace;\n-      const allPromises = [];\n-      allPromises.push(this.loadResources());\n-      if (this.editing) {\n-        allPromises.push(dataSetApi().getDataSet(\n-          namespace, id, this.props.urlParams.dataSetId).then((response) => {\n-            this.setState({\n-              dataSet: response,\n-              includesAllParticipants: response.includesAllParticipants,\n-              selectedConceptSetIds: response.conceptSets.map(cs => cs.id),\n-              selectedCohortIds: response.cohorts.map(c => c.id),\n-              selectedDomainValuePairs: response.domainValuePairs,\n-              valuesLoading: true,\n-            });\n-            if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.BOTH) {\n-              this.setState({prePackagedSurvey: true, prePackagedDemographics: true});\n-            } else if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.DEMOGRAPHICS) {\n-              this.setState({prePackagedDemographics: true});\n-            } else if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.SURVEY) {\n-              this.setState({prePackagedSurvey: true});\n+      const resourcesPromise = this.loadResources();\n+      if (!this.editing) {\n+        return;\n+      }\n+\n+      const [, dataSet] = await Promise.all([\n+        resourcesPromise,\n+        dataSetApi().getDataSet(namespace, id, this.props.urlParams.dataSetId)\n+      ]);\n+\n+      const selectedPrepackagedConceptSets = this.apiEnumToPrePackageConceptSets(dataSet.prePackagedConceptSet);\n+      this.setState({\n+        dataSet,\n+        includesAllParticipants: dataSet.includesAllParticipants,\n+        selectedConceptSetIds: dataSet.conceptSets.map(cs => cs.id),\n+        selectedCohortIds: dataSet.cohorts.map(c => c.id),\n+        selectedDomainValuePairs: dataSet.domainValuePairs,\n+        selectedDomains: this.getDomainsFromConceptSets(dataSet.conceptSets, selectedPrepackagedConceptSets),\n+        selectedPrepackagedConceptSets,\n+      });\n+    }\n+\n+    async componentDidUpdate({}, prevState: State) {\n+      // After a state update, first check whether any new domains have been added.\n+      const newDomains = Array.from(this.state.selectedDomains)\n+          .filter(d => !prevState.selectedDomains.has(d));\n+      if (!newDomains.length) {\n+        return;\n+      }\n+\n+      // TODO: There is a lot of complexity here around loading domain values\n+      // which is static data for a given CDR version. Consider refactoring this", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4MTk3MQ=="}, "originalCommit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af"}, "originalPosition": 309}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dea23c531b4d68a822864df4815214cad0dea8e", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/9dea23c531b4d68a822864df4815214cad0dea8e", "committedDate": "2020-02-12T01:30:35Z", "message": "Add test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0280b6aceb4290241f4228b6a910131d4ce38c1", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/e0280b6aceb4290241f4228b6a910131d4ce38c1", "committedDate": "2020-02-12T02:00:03Z", "message": "another reg test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56c0a00d09272e5c5cb15f83401cb0edef9e5c54", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/56c0a00d09272e5c5cb15f83401cb0edef9e5c54", "committedDate": "2020-02-12T02:00:32Z", "message": "Drop pairs on deselection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5bbe25e03fb0c5803fa35a88f1bd597ae26d0da", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/d5bbe25e03fb0c5803fa35a88f1bd597ae26d0da", "committedDate": "2020-02-12T02:26:17Z", "message": "sort and survey domain cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a726dddeae17115d54f186bf345edfd34a88f142", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/a726dddeae17115d54f186bf345edfd34a88f142", "committedDate": "2020-02-12T02:36:41Z", "message": "fix and test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56c4d488ab536d40c9c819a4e7ebd8a4578aa1d0", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/56c4d488ab536d40c9c819a4e7ebd8a4578aa1d0", "committedDate": "2020-02-12T17:22:31Z", "message": ";"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0488b3f1d06eb309d605ac5d0207ed4192f7e3ff", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/0488b3f1d06eb309d605ac5d0207ed4192f7e3ff", "committedDate": "2020-02-12T18:30:04Z", "message": "PERSON first, the rest alpha"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71dfcf94886d69d0ed6ff07a96c3440e6c4cf91d", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/71dfcf94886d69d0ed6ff07a96c3440e6c4cf91d", "committedDate": "2020-02-12T18:48:02Z", "message": "fix value counting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a59d2ff04f84ed841ee40e8ba773049ac1b7dd3", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/0a59d2ff04f84ed841ee40e8ba773049ac1b7dd3", "committedDate": "2020-02-12T19:24:08Z", "message": "Handle select all logic, and initial dataset load"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9de82260ef941d42504b2f3db4421cfb343d20ed", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/9de82260ef941d42504b2f3db4421cfb343d20ed", "committedDate": "2020-02-12T19:39:40Z", "message": "fix ds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b442840a233c6b351a1e60ed0aef3ad2352c985", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/8b442840a233c6b351a1e60ed0aef3ad2352c985", "committedDate": "2020-02-12T22:44:35Z", "message": "lint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3OTE0MDgy", "url": "https://github.com/all-of-us/workbench/pull/3112#pullrequestreview-357914082", "createdAt": "2020-02-13T02:09:49Z", "commit": {"oid": "8b442840a233c6b351a1e60ed0aef3ad2352c985"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3553, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}