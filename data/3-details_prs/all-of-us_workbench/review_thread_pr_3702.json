{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MzM5MjAw", "number": 3702, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxOTozNDo0M1rOEIG1lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxOTo0MToxM1rOEIG9JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTM2MDg1OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/DataSetController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxOTozNDo0M1rOGn3skw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxOTozNDo0M1rOGn3skw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2MDE3OQ==", "bodyText": "I'd add a method to WorkspaceService that returns Optional so you know to handle the case where it's not found separately.", "url": "https://github.com/all-of-us/workbench/pull/3702#discussion_r444460179", "createdAt": "2020-06-23T19:34:43Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/api/DataSetController.java", "diffHunk": "@@ -525,47 +520,33 @@ private void formatTimestampValues(List<DataSetPreviewValueList> valuePreviewLis\n       String workspaceNamespace, String workspaceId, MarkDataSetRequest markDataSetRequest) {\n     workspaceService.getWorkspaceEnforceAccessLevelAndSetCdrVersion(\n         workspaceNamespace, workspaceId, WorkspaceAccessLevel.WRITER);\n-    List<DbDataset> dbDataSetList = new ArrayList<>();\n-    if (ResourceType.COHORT.equals(markDataSetRequest.getResourceType())) {\n-      dbDataSetList = dataSetDao.findDataSetsByCohortIds(markDataSetRequest.getId());\n-    } else if (ResourceType.CONCEPT_SET.equals(markDataSetRequest.getResourceType())) {\n-      dbDataSetList = dataSetDao.findDataSetsByConceptSetIds(markDataSetRequest.getId());\n-    }\n-    dbDataSetList =\n-        dbDataSetList.stream()\n-            .map(\n-                dataSet -> {\n-                  dataSet.setInvalid(true);\n-                  return dataSet;\n-                })\n-            .collect(Collectors.toList());\n-    try {\n-      dataSetDao.save(dbDataSetList);\n-    } catch (OptimisticLockException e) {\n-      throw new ConflictException(\"Failed due to concurrent data set modification\");\n-    }\n-\n+    dataSetService.markDirty(markDataSetRequest.getResourceType(), markDataSetRequest.getId());\n     return ResponseEntity.ok(true);\n   }\n \n   @Override\n   public ResponseEntity<EmptyResponse> deleteDataSet(\n       String workspaceNamespace, String workspaceId, Long dataSetId) {\n-    DbDataset dataSet =\n-        getDbDataSet(workspaceNamespace, workspaceId, dataSetId, WorkspaceAccessLevel.WRITER);\n-    dataSetDao.delete(dataSet.getDataSetId());\n+    DbWorkspace workspace =\n+        workspaceService.getWorkspaceEnforceAccessLevelAndSetCdrVersion(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142dc75ff1347e60bcd11863d64a945addaa2fb4"}, "originalPosition": 126}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTM2NTUzOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxOTozNjoyM1rOGn3vpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxOTozNjoyM1rOGn3vpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2MDk2Nw==", "bodyText": "Yeah, I'd make this one return Optional.", "url": "https://github.com/all-of-us/workbench/pull/3702#discussion_r444460967", "createdAt": "2020-06-23T19:36:23Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetService.java", "diffHunk": "@@ -46,4 +49,14 @@ DbDataset cloneDataSetToWorkspace(\n   List<DbConceptSet> getConceptSetsForDataset(DbDataset dataSet);\n \n   List<DbCohort> getCohortsForDataset(DbDataset dataSet);\n+\n+  List<DbDataset> getDataSets(ResourceType resourceType, long resourceId);\n+\n+  List<DbDataset> getInvalidDataSetsByWorkspace(DbWorkspace dbWorkspace);\n+\n+  void deleteDataSet(DbWorkspace dbWorkspace, Long dataSetId);\n+\n+  DbDataset getDbDataSet(DbWorkspace dbWorkspace, Long dataSetId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142dc75ff1347e60bcd11863d64a945addaa2fb4"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTM2NzQ0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxOTozNzowNVrOGn3w5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxOTozNzowNVrOGn3w5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2MTI4NA==", "bodyText": "nit: prefer switch statements on enum values.", "url": "https://github.com/all-of-us/workbench/pull/3702#discussion_r444461284", "createdAt": "2020-06-23T19:37:05Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -676,6 +684,59 @@ public DbDataset cloneDataSetToWorkspace(\n     return cohortDao.findAllByCohortIdIn(dataSetDao.findOne(dataSet.getDataSetId()).getCohortIds());\n   }\n \n+  @Override\n+  public List<DbDataset> getDataSets(ResourceType resourceType, long resourceId) {\n+    List<DbDataset> dbDataSets = new ArrayList<>();\n+    if (ResourceType.COHORT.equals(resourceType)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142dc75ff1347e60bcd11863d64a945addaa2fb4"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTM4MDIxOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxOTo0MToxM1rOGn34-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxOTo0MToxM1rOGn34-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ2MzM1NA==", "bodyText": "If you can, it's better to avoid overwriting variables. I'd probably give the original set a different name, or just inline it so yo have\ngetDataSets(resourceType, resourceId).stream()\n            .map(\n                dataSet -> {\n                  dataSet.setInvalid(true);\n                  return dataSet;\n                })\n            .collect(Collectors.toList());\n\nBut really I think you can just do dbDataSetList.stream().forEach(ds -> ds.setInvalid(true)); to change them in place.", "url": "https://github.com/all-of-us/workbench/pull/3702#discussion_r444463354", "createdAt": "2020-06-23T19:41:13Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/db/dao/DataSetServiceImpl.java", "diffHunk": "@@ -676,6 +684,59 @@ public DbDataset cloneDataSetToWorkspace(\n     return cohortDao.findAllByCohortIdIn(dataSetDao.findOne(dataSet.getDataSetId()).getCohortIds());\n   }\n \n+  @Override\n+  public List<DbDataset> getDataSets(ResourceType resourceType, long resourceId) {\n+    List<DbDataset> dbDataSets = new ArrayList<>();\n+    if (ResourceType.COHORT.equals(resourceType)) {\n+      dbDataSets = dataSetDao.findDataSetsByCohortIds(resourceId);\n+    } else if (ResourceType.CONCEPT_SET.equals(resourceType)) {\n+      dbDataSets = dataSetDao.findDataSetsByConceptSetIds(resourceId);\n+    }\n+    return dbDataSets;\n+  }\n+\n+  @Override\n+  public List<DbDataset> getInvalidDataSetsByWorkspace(DbWorkspace dbWorkspace) {\n+\n+    return dataSetDao.findByWorkspaceIdAndInvalid(dbWorkspace.getWorkspaceId(), false);\n+  }\n+\n+  @Override\n+  public void deleteDataSet(DbWorkspace dbWorkspace, Long dataSetId) {\n+    DbDataset dataSet = getDbDataSet(dbWorkspace, dataSetId);\n+    dataSetDao.delete(dataSet.getDataSetId());\n+  }\n+\n+  @Override\n+  public DbDataset getDbDataSet(DbWorkspace dbWorkspace, Long dataSetId) {\n+\n+    DbDataset dataSet = dataSetDao.findOne(dataSetId);\n+    if (dataSet == null || dbWorkspace.getWorkspaceId() != dataSet.getWorkspaceId()) {\n+      throw new NotFoundException(\n+          String.format(\n+              \"No data set with ID %s in workspace %s.\", dataSet, dbWorkspace.getFirecloudName()));\n+    }\n+    return dataSet;\n+  }\n+\n+  @Override\n+  public void markDirty(ResourceType resourceType, long resourceId) {\n+    List<DbDataset> dbDataSetList = getDataSets(resourceType, resourceId);\n+    dbDataSetList =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "142dc75ff1347e60bcd11863d64a945addaa2fb4"}, "originalPosition": 80}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2557, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}