{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NDM5OTkz", "number": 3159, "title": "[risk=no]refactor StorageEnumsTest and CommonStorageEnumsTest", "bodyText": "Description:\nHopefully better documents and clarifies these tests.   Also fixes a sometimes-bug I introduced in #3131\nI intentionally did not use common code here, so as not to introduce an /api -> /common-api dependency. LMK if you disagree\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-02-19T22:58:18Z", "url": "https://github.com/all-of-us/workbench/pull/3159", "merged": true, "mergeCommit": {"oid": "1333ef4ad58d220111462a4536524fe06ed2e566"}, "closed": true, "closedAt": "2020-02-21T22:32:52Z", "author": {"login": "jmthibault79"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcF-teGgFqTM2MTUwMTg5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGnQJrAH2gAyMzc3NDM5OTkzOmRjZmM2YTc3OWI3MGMxMTViMzA5NjRhNWQ2MTY2ZjI3ZTA3OGVjMjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNTAxODk1", "url": "https://github.com/all-of-us/workbench/pull/3159#pullrequestreview-361501895", "createdAt": "2020-02-19T22:59:29Z", "commit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMjo1OToyOVrOFr6z3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMjo1OToyOVrOFr6z3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU5NjYzOQ==", "bodyText": "required explicitly enumerating the maps in data() above", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r381596639", "createdAt": "2020-02-19T22:59:29Z", "author": {"login": "jmthibault79"}, "path": "common-api/src/test/java/org/pmiops/workbench/db/model/CommonStorageEnumsTest.java", "diffHunk": "@@ -4,103 +4,86 @@\n import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n-import java.util.function.Function;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n-import org.junit.runner.RunWith;\n-import org.junit.runners.Parameterized;\n-import org.junit.runners.Parameterized.Parameter;\n-import org.junit.runners.Parameterized.Parameters;\n-import org.pmiops.workbench.model.DataAccessLevel;\n import org.pmiops.workbench.model.Domain;\n \n-@RunWith(Parameterized.class)\n public class CommonStorageEnumsTest {\n-  @Parameters(name = \"{0}\")\n-  public static Object[][] data() {\n-    return new Object[][] {\n-      {\n-        DataAccessLevel.class.getSimpleName(),\n-        DataAccessLevel.values(),\n-        (Function<Short, DataAccessLevel>) CommonStorageEnums::dataAccessLevelFromStorage,\n-        (Function<DataAccessLevel, Short>) CommonStorageEnums::dataAccessLevelToStorage\n-      },\n-      {\n-        Domain.class.getSimpleName(),\n-        Domain.values(),\n-        (Function<Short, Domain>) CommonStorageEnums::domainFromStorage,\n-        (Function<Domain, Short>) CommonStorageEnums::domainToStorage\n-      }\n-    };\n-  }\n-\n-  @Parameter() public String description;\n-\n-  @Parameter(1)\n-  public Enum<?>[] enumValues;\n-\n-  @Parameter(2)\n-  public Function<Short, Enum<?>> fromStorage;\n-\n-  @Parameter(3)\n-  public Function<Enum<?>, Short> toStorage;\n-\n-  @Test\n-  public void testBijectiveStorageMapping() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNTAyMjM5", "url": "https://github.com/all-of-us/workbench/pull/3159#pullrequestreview-361502239", "createdAt": "2020-02-19T23:00:14Z", "commit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMzowMDoxNFrOFr61GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMzowMDoxNFrOFr61GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU5Njk1Mw==", "bodyText": "This was the bug in #3131 - also needed to check for domainToDomainId", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r381596953", "createdAt": "2020-02-19T23:00:14Z", "author": {"login": "jmthibault79"}, "path": "common-api/src/test/java/org/pmiops/workbench/db/model/CommonStorageEnumsTest.java", "diffHunk": "@@ -4,103 +4,86 @@\n import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n-import java.util.function.Function;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n-import org.junit.runner.RunWith;\n-import org.junit.runners.Parameterized;\n-import org.junit.runners.Parameterized.Parameter;\n-import org.junit.runners.Parameterized.Parameters;\n-import org.pmiops.workbench.model.DataAccessLevel;\n import org.pmiops.workbench.model.Domain;\n \n-@RunWith(Parameterized.class)\n public class CommonStorageEnumsTest {\n-  @Parameters(name = \"{0}\")\n-  public static Object[][] data() {\n-    return new Object[][] {\n-      {\n-        DataAccessLevel.class.getSimpleName(),\n-        DataAccessLevel.values(),\n-        (Function<Short, DataAccessLevel>) CommonStorageEnums::dataAccessLevelFromStorage,\n-        (Function<DataAccessLevel, Short>) CommonStorageEnums::dataAccessLevelToStorage\n-      },\n-      {\n-        Domain.class.getSimpleName(),\n-        Domain.values(),\n-        (Function<Short, Domain>) CommonStorageEnums::domainFromStorage,\n-        (Function<Domain, Short>) CommonStorageEnums::domainToStorage\n-      }\n-    };\n-  }\n-\n-  @Parameter() public String description;\n-\n-  @Parameter(1)\n-  public Enum<?>[] enumValues;\n-\n-  @Parameter(2)\n-  public Function<Short, Enum<?>> fromStorage;\n-\n-  @Parameter(3)\n-  public Function<Enum<?>, Short> toStorage;\n-\n-  @Test\n-  public void testBijectiveStorageMapping() {\n-    for (Enum<?> v : enumValues) {\n-      Short storageValue = toStorage.apply(v);\n-      assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n-      assertThat(v).isEqualTo(fromStorage.apply(storageValue));\n-    }\n-  }\n \n   // domain ID is stringly-typed so special-case this\n \n   @Test\n-  public void testDomainIdBijectiveStorageMapping() {\n+  public void test_domainId() {\n     for (Domain v : Domain.values()) {\n       String storageValue = CommonStorageEnums.domainToDomainId(v);\n       assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n       assertThat(v).isEqualTo(CommonStorageEnums.domainIdToDomain(storageValue));\n     }\n   }\n \n-  // copied from api/StorageEnumsTest because the above tests are not comprehensive\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : CommonStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n-\n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n-\n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : CommonStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n-\n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n-\n-      // stringly typed map - test with testDomainIdBijectiveStorageMapping instead\n-      if (enumToShort.getName().equals(\"domainIdToDomain\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 98}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNTA1MDc4", "url": "https://github.com/all-of-us/workbench/pull/3159#pullrequestreview-361505078", "createdAt": "2020-02-19T23:06:23Z", "commit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMzowNjoyM1rOFr6-gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQyMzowNjoyM1rOFr6-gA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU5OTM2MA==", "bodyText": "This is not my dark magic - it's a copy-paste.", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r381599360", "createdAt": "2020-02-19T23:06:23Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/db/model/StorageEnumsTest.java", "diffHunk": "@@ -3,40 +3,68 @@\n import static com.google.common.truth.Truth.assertThat;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n \n public class StorageEnumsTest {\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : DbStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n \n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n+  @Test\n+  public void test_noMissingMapEntries() throws Exception {\n+    final Set<Class> enumClasses = getEnumerationClasses();\n+    final Collection<Method> methods = Arrays.asList(DbStorageEnums.class.getDeclaredMethods());\n \n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : DbStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n+    // e.g. public static Short reviewStatusToStorage(ReviewStatus s)\n+    final Map<Class, Method> toStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(firstMethodParameter(m)))\n+            .collect(Collectors.toMap(this::firstMethodParameter, m -> m));\n \n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n+    // e.g. public static ReviewStatus reviewStatusFromStorage(Short s)\n+    final Map<Class, Method> fromStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(m.getReturnType()))\n+            .collect(Collectors.toMap(Method::getReturnType, m -> m));\n \n+    for (Class enumClass : enumClasses) {\n+      final Method toStorage = toStorageMethods.get(enumClass);\n+      final Method fromStorage = fromStorageMethods.get(enumClass);\n       for (Object e : enumClass.getEnumConstants()) {\n-        Short shortVal = (Short) enumToShort.invoke(null, e);\n+        Short shortVal = (Short) toStorage.invoke(null, e);\n \n         assertThat(shortVal).named(enumClass.getName() + \":\" + e.toString()).isNotNull();\n-        assertThat(shortToEnum.invoke(null, shortVal)).isEqualTo(e);\n+        assertThat(fromStorage.invoke(null, shortVal)).isEqualTo(e);\n       }\n     }\n   }\n+\n+  /**\n+   * Retrieve all Enum classes in DbStorageEnums\n+   *\n+   * <p>our convention for BiMaps in DbStorageEnums is <Enum, Short> so we retrieve the first\n+   * parameterized type\n+   *\n+   * @return\n+   */\n+  private Set<Class> getEnumerationClasses() {\n+    return Stream.of(DbStorageEnums.class.getDeclaredFields())\n+        .filter(f -> f.getType().equals(BiMap.class))\n+        .map(\n+            f ->\n+                (Class)\n+                    ((ParameterizedType) f.getAnnotatedType().getType())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMDI2NDAz", "url": "https://github.com/all-of-us/workbench/pull/3159#pullrequestreview-362026403", "createdAt": "2020-02-20T16:02:09Z", "commit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNjowMjowOVrOFsZTAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNjoxODo1OVrOFsZ7Uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA5NjEzMA==", "bodyText": "This is nifty. I might need a little more detail in the comments (especially if my reflection is rusty).\nThinking out loud, I wonder if you could refactor the Enums classes such that each matching pair of to & from methods just has the same name across the board. E.g. they could all inherit from something like\ninterface EnumMappable<T extends Enum<T>> {\n  T toEnum(Short short);\n  short toStorage(T enum);\n}", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382096130", "createdAt": "2020-02-20T16:02:09Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/db/model/StorageEnumsTest.java", "diffHunk": "@@ -3,40 +3,68 @@\n import static com.google.common.truth.Truth.assertThat;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n \n public class StorageEnumsTest {\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : DbStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n \n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n+  @Test\n+  public void test_noMissingMapEntries() throws Exception {\n+    final Set<Class> enumClasses = getEnumerationClasses();\n+    final Collection<Method> methods = Arrays.asList(DbStorageEnums.class.getDeclaredMethods());\n \n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : DbStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n+    // e.g. public static Short reviewStatusToStorage(ReviewStatus s)\n+    final Map<Class, Method> toStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(firstMethodParameter(m)))\n+            .collect(Collectors.toMap(this::firstMethodParameter, m -> m));\n \n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n+    // e.g. public static ReviewStatus reviewStatusFromStorage(Short s)\n+    final Map<Class, Method> fromStorageMethods =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA5NzU5Mw==", "bodyText": "Can you make an identifier for null in this case, like STATIC?\nI'm confused about what e is here. Maybe enumEntry or enumVal would help.", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382097593", "createdAt": "2020-02-20T16:04:36Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/db/model/StorageEnumsTest.java", "diffHunk": "@@ -3,40 +3,68 @@\n import static com.google.common.truth.Truth.assertThat;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n \n public class StorageEnumsTest {\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : DbStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n \n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n+  @Test\n+  public void test_noMissingMapEntries() throws Exception {\n+    final Set<Class> enumClasses = getEnumerationClasses();\n+    final Collection<Method> methods = Arrays.asList(DbStorageEnums.class.getDeclaredMethods());\n \n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : DbStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n+    // e.g. public static Short reviewStatusToStorage(ReviewStatus s)\n+    final Map<Class, Method> toStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(firstMethodParameter(m)))\n+            .collect(Collectors.toMap(this::firstMethodParameter, m -> m));\n \n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n+    // e.g. public static ReviewStatus reviewStatusFromStorage(Short s)\n+    final Map<Class, Method> fromStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(m.getReturnType()))\n+            .collect(Collectors.toMap(Method::getReturnType, m -> m));\n \n+    for (Class enumClass : enumClasses) {\n+      final Method toStorage = toStorageMethods.get(enumClass);\n+      final Method fromStorage = fromStorageMethods.get(enumClass);\n       for (Object e : enumClass.getEnumConstants()) {\n-        Short shortVal = (Short) enumToShort.invoke(null, e);\n+        Short shortVal = (Short) toStorage.invoke(null, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA5OTYyNA==", "bodyText": "This might be a place where making a local lambda makes things cleaner. E.g. Function<Short, enumClass> fromStorage = storageValue -> fromStorage.invoke(null, storageValue); The invoke null takes a while to get used to.", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382099624", "createdAt": "2020-02-20T16:07:57Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/db/model/StorageEnumsTest.java", "diffHunk": "@@ -3,40 +3,68 @@\n import static com.google.common.truth.Truth.assertThat;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n \n public class StorageEnumsTest {\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : DbStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n \n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n+  @Test\n+  public void test_noMissingMapEntries() throws Exception {\n+    final Set<Class> enumClasses = getEnumerationClasses();\n+    final Collection<Method> methods = Arrays.asList(DbStorageEnums.class.getDeclaredMethods());\n \n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : DbStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n+    // e.g. public static Short reviewStatusToStorage(ReviewStatus s)\n+    final Map<Class, Method> toStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(firstMethodParameter(m)))\n+            .collect(Collectors.toMap(this::firstMethodParameter, m -> m));\n \n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n+    // e.g. public static ReviewStatus reviewStatusFromStorage(Short s)\n+    final Map<Class, Method> fromStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(m.getReturnType()))\n+            .collect(Collectors.toMap(Method::getReturnType, m -> m));\n \n+    for (Class enumClass : enumClasses) {\n+      final Method toStorage = toStorageMethods.get(enumClass);\n+      final Method fromStorage = fromStorageMethods.get(enumClass);\n       for (Object e : enumClass.getEnumConstants()) {\n-        Short shortVal = (Short) enumToShort.invoke(null, e);\n+        Short shortVal = (Short) toStorage.invoke(null, e);\n \n         assertThat(shortVal).named(enumClass.getName() + \":\" + e.toString()).isNotNull();\n-        assertThat(shortToEnum.invoke(null, shortVal)).isEqualTo(e);\n+        assertThat(fromStorage.invoke(null, shortVal)).isEqualTo(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwMTQxMQ==", "bodyText": "Can you generify it so that it takes in either a type parameter or argument for the enum class to be harvested?\nI'd like to see some more comments on why it has to be copied and what each chunk is doing.", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382101411", "createdAt": "2020-02-20T16:11:01Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/db/model/StorageEnumsTest.java", "diffHunk": "@@ -3,40 +3,68 @@\n import static com.google.common.truth.Truth.assertThat;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n \n public class StorageEnumsTest {\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : DbStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n \n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n+  @Test\n+  public void test_noMissingMapEntries() throws Exception {\n+    final Set<Class> enumClasses = getEnumerationClasses();\n+    final Collection<Method> methods = Arrays.asList(DbStorageEnums.class.getDeclaredMethods());\n \n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : DbStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n+    // e.g. public static Short reviewStatusToStorage(ReviewStatus s)\n+    final Map<Class, Method> toStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(firstMethodParameter(m)))\n+            .collect(Collectors.toMap(this::firstMethodParameter, m -> m));\n \n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n+    // e.g. public static ReviewStatus reviewStatusFromStorage(Short s)\n+    final Map<Class, Method> fromStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(m.getReturnType()))\n+            .collect(Collectors.toMap(Method::getReturnType, m -> m));\n \n+    for (Class enumClass : enumClasses) {\n+      final Method toStorage = toStorageMethods.get(enumClass);\n+      final Method fromStorage = fromStorageMethods.get(enumClass);\n       for (Object e : enumClass.getEnumConstants()) {\n-        Short shortVal = (Short) enumToShort.invoke(null, e);\n+        Short shortVal = (Short) toStorage.invoke(null, e);\n \n         assertThat(shortVal).named(enumClass.getName() + \":\" + e.toString()).isNotNull();\n-        assertThat(shortToEnum.invoke(null, shortVal)).isEqualTo(e);\n+        assertThat(fromStorage.invoke(null, shortVal)).isEqualTo(e);\n       }\n     }\n   }\n+\n+  /**\n+   * Retrieve all Enum classes in DbStorageEnums\n+   *\n+   * <p>our convention for BiMaps in DbStorageEnums is <Enum, Short> so we retrieve the first\n+   * parameterized type\n+   *\n+   * @return\n+   */\n+  private Set<Class> getEnumerationClasses() {\n+    return Stream.of(DbStorageEnums.class.getDeclaredFields())\n+        .filter(f -> f.getType().equals(BiMap.class))\n+        .map(\n+            f ->\n+                (Class)\n+                    ((ParameterizedType) f.getAnnotatedType().getType())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU5OTM2MA=="}, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwMjI1OA==", "bodyText": "How do we test the reverse direction? I.e. how do we know we don't have shorts written to the db someplace that don't map back to an enum value?", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382102258", "createdAt": "2020-02-20T16:12:15Z", "author": {"login": "jaycarlton"}, "path": "common-api/src/test/java/org/pmiops/workbench/db/model/CommonStorageEnumsTest.java", "diffHunk": "@@ -4,103 +4,86 @@\n import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n-import java.util.function.Function;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n-import org.junit.runner.RunWith;\n-import org.junit.runners.Parameterized;\n-import org.junit.runners.Parameterized.Parameter;\n-import org.junit.runners.Parameterized.Parameters;\n-import org.pmiops.workbench.model.DataAccessLevel;\n import org.pmiops.workbench.model.Domain;\n \n-@RunWith(Parameterized.class)\n public class CommonStorageEnumsTest {\n-  @Parameters(name = \"{0}\")\n-  public static Object[][] data() {\n-    return new Object[][] {\n-      {\n-        DataAccessLevel.class.getSimpleName(),\n-        DataAccessLevel.values(),\n-        (Function<Short, DataAccessLevel>) CommonStorageEnums::dataAccessLevelFromStorage,\n-        (Function<DataAccessLevel, Short>) CommonStorageEnums::dataAccessLevelToStorage\n-      },\n-      {\n-        Domain.class.getSimpleName(),\n-        Domain.values(),\n-        (Function<Short, Domain>) CommonStorageEnums::domainFromStorage,\n-        (Function<Domain, Short>) CommonStorageEnums::domainToStorage\n-      }\n-    };\n-  }\n-\n-  @Parameter() public String description;\n-\n-  @Parameter(1)\n-  public Enum<?>[] enumValues;\n-\n-  @Parameter(2)\n-  public Function<Short, Enum<?>> fromStorage;\n-\n-  @Parameter(3)\n-  public Function<Enum<?>, Short> toStorage;\n-\n-  @Test\n-  public void testBijectiveStorageMapping() {\n-    for (Enum<?> v : enumValues) {\n-      Short storageValue = toStorage.apply(v);\n-      assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n-      assertThat(v).isEqualTo(fromStorage.apply(storageValue));\n-    }\n-  }\n \n   // domain ID is stringly-typed so special-case this\n \n   @Test\n-  public void testDomainIdBijectiveStorageMapping() {\n+  public void test_domainId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwMzA2Mw==", "bodyText": "Maybe this is really getFirstParameterType()?", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382103063", "createdAt": "2020-02-20T16:13:28Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/db/model/StorageEnumsTest.java", "diffHunk": "@@ -3,40 +3,68 @@\n import static com.google.common.truth.Truth.assertThat;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n \n public class StorageEnumsTest {\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : DbStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n \n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n+  @Test\n+  public void test_noMissingMapEntries() throws Exception {\n+    final Set<Class> enumClasses = getEnumerationClasses();\n+    final Collection<Method> methods = Arrays.asList(DbStorageEnums.class.getDeclaredMethods());\n \n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : DbStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n+    // e.g. public static Short reviewStatusToStorage(ReviewStatus s)\n+    final Map<Class, Method> toStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(firstMethodParameter(m)))\n+            .collect(Collectors.toMap(this::firstMethodParameter, m -> m));\n \n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n+    // e.g. public static ReviewStatus reviewStatusFromStorage(Short s)\n+    final Map<Class, Method> fromStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(m.getReturnType()))\n+            .collect(Collectors.toMap(Method::getReturnType, m -> m));\n \n+    for (Class enumClass : enumClasses) {\n+      final Method toStorage = toStorageMethods.get(enumClass);\n+      final Method fromStorage = fromStorageMethods.get(enumClass);\n       for (Object e : enumClass.getEnumConstants()) {\n-        Short shortVal = (Short) enumToShort.invoke(null, e);\n+        Short shortVal = (Short) toStorage.invoke(null, e);\n \n         assertThat(shortVal).named(enumClass.getName() + \":\" + e.toString()).isNotNull();\n-        assertThat(shortToEnum.invoke(null, shortVal)).isEqualTo(e);\n+        assertThat(fromStorage.invoke(null, shortVal)).isEqualTo(e);\n       }\n     }\n   }\n+\n+  /**\n+   * Retrieve all Enum classes in DbStorageEnums\n+   *\n+   * <p>our convention for BiMaps in DbStorageEnums is <Enum, Short> so we retrieve the first\n+   * parameterized type\n+   *\n+   * @return\n+   */\n+  private Set<Class> getEnumerationClasses() {\n+    return Stream.of(DbStorageEnums.class.getDeclaredFields())\n+        .filter(f -> f.getType().equals(BiMap.class))\n+        .map(\n+            f ->\n+                (Class)\n+                    ((ParameterizedType) f.getAnnotatedType().getType())\n+                        .getActualTypeArguments()[0])\n+        .collect(Collectors.toSet());\n+  }\n+\n+  // convenience method describing what is retrieved here\n+  private Class firstMethodParameter(Method method) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwMzQxMA==", "bodyText": "\"strongly\"?", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382103410", "createdAt": "2020-02-20T16:14:01Z", "author": {"login": "jaycarlton"}, "path": "common-api/src/test/java/org/pmiops/workbench/db/model/CommonStorageEnumsTest.java", "diffHunk": "@@ -4,103 +4,86 @@\n import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n-import java.util.function.Function;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n-import org.junit.runner.RunWith;\n-import org.junit.runners.Parameterized;\n-import org.junit.runners.Parameterized.Parameter;\n-import org.junit.runners.Parameterized.Parameters;\n-import org.pmiops.workbench.model.DataAccessLevel;\n import org.pmiops.workbench.model.Domain;\n \n-@RunWith(Parameterized.class)\n public class CommonStorageEnumsTest {\n-  @Parameters(name = \"{0}\")\n-  public static Object[][] data() {\n-    return new Object[][] {\n-      {\n-        DataAccessLevel.class.getSimpleName(),\n-        DataAccessLevel.values(),\n-        (Function<Short, DataAccessLevel>) CommonStorageEnums::dataAccessLevelFromStorage,\n-        (Function<DataAccessLevel, Short>) CommonStorageEnums::dataAccessLevelToStorage\n-      },\n-      {\n-        Domain.class.getSimpleName(),\n-        Domain.values(),\n-        (Function<Short, Domain>) CommonStorageEnums::domainFromStorage,\n-        (Function<Domain, Short>) CommonStorageEnums::domainToStorage\n-      }\n-    };\n-  }\n-\n-  @Parameter() public String description;\n-\n-  @Parameter(1)\n-  public Enum<?>[] enumValues;\n-\n-  @Parameter(2)\n-  public Function<Short, Enum<?>> fromStorage;\n-\n-  @Parameter(3)\n-  public Function<Enum<?>, Short> toStorage;\n-\n-  @Test\n-  public void testBijectiveStorageMapping() {\n-    for (Enum<?> v : enumValues) {\n-      Short storageValue = toStorage.apply(v);\n-      assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n-      assertThat(v).isEqualTo(fromStorage.apply(storageValue));\n-    }\n-  }\n \n   // domain ID is stringly-typed so special-case this\n \n   @Test\n-  public void testDomainIdBijectiveStorageMapping() {\n+  public void test_domainId() {\n     for (Domain v : Domain.values()) {\n       String storageValue = CommonStorageEnums.domainToDomainId(v);\n       assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n       assertThat(v).isEqualTo(CommonStorageEnums.domainIdToDomain(storageValue));\n     }\n   }\n \n-  // copied from api/StorageEnumsTest because the above tests are not comprehensive\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : CommonStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n-\n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n-\n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : CommonStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n-\n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n-\n-      // stringly typed map - test with testDomainIdBijectiveStorageMapping instead\n-      if (enumToShort.getName().equals(\"domainIdToDomain\")) {\n-        continue;\n-      }\n+  // this is a copy of StorageEnumsTest.test_noMissingMapEntries()\n \n+  @Test\n+  public void test_noMissingMapEntries() throws Exception {\n+    final Set<Class> enumClasses = getEnumerationClasses();\n+    final Collection<Method> methods = Arrays.asList(CommonStorageEnums.class.getDeclaredMethods());\n+\n+    // e.g. public static Short domainToStorage(Domain domain)\n+    final Map<Class, Method> toStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(firstMethodParameter(m)))\n+            // domainToDomainId is stringly typed - test with test_domainId", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwNDQ2NA==", "bodyText": "This test is extremely tightly tied to the implementation of the class. Ideally we capture enough of the functionality that migrating to something cleaner is easier. If we hold on too tightly, this could actually slow us down a bit.", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382104464", "createdAt": "2020-02-20T16:15:42Z", "author": {"login": "jaycarlton"}, "path": "common-api/src/test/java/org/pmiops/workbench/db/model/CommonStorageEnumsTest.java", "diffHunk": "@@ -4,103 +4,86 @@\n import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n-import java.util.function.Function;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n-import org.junit.runner.RunWith;\n-import org.junit.runners.Parameterized;\n-import org.junit.runners.Parameterized.Parameter;\n-import org.junit.runners.Parameterized.Parameters;\n-import org.pmiops.workbench.model.DataAccessLevel;\n import org.pmiops.workbench.model.Domain;\n \n-@RunWith(Parameterized.class)\n public class CommonStorageEnumsTest {\n-  @Parameters(name = \"{0}\")\n-  public static Object[][] data() {\n-    return new Object[][] {\n-      {\n-        DataAccessLevel.class.getSimpleName(),\n-        DataAccessLevel.values(),\n-        (Function<Short, DataAccessLevel>) CommonStorageEnums::dataAccessLevelFromStorage,\n-        (Function<DataAccessLevel, Short>) CommonStorageEnums::dataAccessLevelToStorage\n-      },\n-      {\n-        Domain.class.getSimpleName(),\n-        Domain.values(),\n-        (Function<Short, Domain>) CommonStorageEnums::domainFromStorage,\n-        (Function<Domain, Short>) CommonStorageEnums::domainToStorage\n-      }\n-    };\n-  }\n-\n-  @Parameter() public String description;\n-\n-  @Parameter(1)\n-  public Enum<?>[] enumValues;\n-\n-  @Parameter(2)\n-  public Function<Short, Enum<?>> fromStorage;\n-\n-  @Parameter(3)\n-  public Function<Enum<?>, Short> toStorage;\n-\n-  @Test\n-  public void testBijectiveStorageMapping() {\n-    for (Enum<?> v : enumValues) {\n-      Short storageValue = toStorage.apply(v);\n-      assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n-      assertThat(v).isEqualTo(fromStorage.apply(storageValue));\n-    }\n-  }\n \n   // domain ID is stringly-typed so special-case this\n \n   @Test\n-  public void testDomainIdBijectiveStorageMapping() {\n+  public void test_domainId() {\n     for (Domain v : Domain.values()) {\n       String storageValue = CommonStorageEnums.domainToDomainId(v);\n       assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n       assertThat(v).isEqualTo(CommonStorageEnums.domainIdToDomain(storageValue));\n     }\n   }\n \n-  // copied from api/StorageEnumsTest because the above tests are not comprehensive\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : CommonStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n-\n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n-\n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : CommonStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n-\n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n-\n-      // stringly typed map - test with testDomainIdBijectiveStorageMapping instead\n-      if (enumToShort.getName().equals(\"domainIdToDomain\")) {\n-        continue;\n-      }\n+  // this is a copy of StorageEnumsTest.test_noMissingMapEntries()\n \n+  @Test\n+  public void test_noMissingMapEntries() throws Exception {\n+    final Set<Class> enumClasses = getEnumerationClasses();\n+    final Collection<Method> methods = Arrays.asList(CommonStorageEnums.class.getDeclaredMethods());\n+\n+    // e.g. public static Short domainToStorage(Domain domain)\n+    final Map<Class, Method> toStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(firstMethodParameter(m)))\n+            // domainToDomainId is stringly typed - test with test_domainId\n+            .filter(m -> !m.getName().equals(\"domainToDomainId\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwNDY2NQ==", "bodyText": "Can we name this enumClassToToStorageMethod?", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382104665", "createdAt": "2020-02-20T16:16:03Z", "author": {"login": "jaycarlton"}, "path": "common-api/src/test/java/org/pmiops/workbench/db/model/CommonStorageEnumsTest.java", "diffHunk": "@@ -4,103 +4,86 @@\n import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n-import java.util.function.Function;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n-import org.junit.runner.RunWith;\n-import org.junit.runners.Parameterized;\n-import org.junit.runners.Parameterized.Parameter;\n-import org.junit.runners.Parameterized.Parameters;\n-import org.pmiops.workbench.model.DataAccessLevel;\n import org.pmiops.workbench.model.Domain;\n \n-@RunWith(Parameterized.class)\n public class CommonStorageEnumsTest {\n-  @Parameters(name = \"{0}\")\n-  public static Object[][] data() {\n-    return new Object[][] {\n-      {\n-        DataAccessLevel.class.getSimpleName(),\n-        DataAccessLevel.values(),\n-        (Function<Short, DataAccessLevel>) CommonStorageEnums::dataAccessLevelFromStorage,\n-        (Function<DataAccessLevel, Short>) CommonStorageEnums::dataAccessLevelToStorage\n-      },\n-      {\n-        Domain.class.getSimpleName(),\n-        Domain.values(),\n-        (Function<Short, Domain>) CommonStorageEnums::domainFromStorage,\n-        (Function<Domain, Short>) CommonStorageEnums::domainToStorage\n-      }\n-    };\n-  }\n-\n-  @Parameter() public String description;\n-\n-  @Parameter(1)\n-  public Enum<?>[] enumValues;\n-\n-  @Parameter(2)\n-  public Function<Short, Enum<?>> fromStorage;\n-\n-  @Parameter(3)\n-  public Function<Enum<?>, Short> toStorage;\n-\n-  @Test\n-  public void testBijectiveStorageMapping() {\n-    for (Enum<?> v : enumValues) {\n-      Short storageValue = toStorage.apply(v);\n-      assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n-      assertThat(v).isEqualTo(fromStorage.apply(storageValue));\n-    }\n-  }\n \n   // domain ID is stringly-typed so special-case this\n \n   @Test\n-  public void testDomainIdBijectiveStorageMapping() {\n+  public void test_domainId() {\n     for (Domain v : Domain.values()) {\n       String storageValue = CommonStorageEnums.domainToDomainId(v);\n       assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n       assertThat(v).isEqualTo(CommonStorageEnums.domainIdToDomain(storageValue));\n     }\n   }\n \n-  // copied from api/StorageEnumsTest because the above tests are not comprehensive\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : CommonStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n-\n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n-\n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : CommonStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n-\n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n-\n-      // stringly typed map - test with testDomainIdBijectiveStorageMapping instead\n-      if (enumToShort.getName().equals(\"domainIdToDomain\")) {\n-        continue;\n-      }\n+  // this is a copy of StorageEnumsTest.test_noMissingMapEntries()\n \n+  @Test\n+  public void test_noMissingMapEntries() throws Exception {\n+    final Set<Class> enumClasses = getEnumerationClasses();\n+    final Collection<Method> methods = Arrays.asList(CommonStorageEnums.class.getDeclaredMethods());\n+\n+    // e.g. public static Short domainToStorage(Domain domain)\n+    final Map<Class, Method> toStorageMethods =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwNTQyMg==", "bodyText": "Is it worth even fiddling with common-api if it's about to get reabsorbed?", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382105422", "createdAt": "2020-02-20T16:17:14Z", "author": {"login": "jaycarlton"}, "path": "common-api/src/test/java/org/pmiops/workbench/db/model/CommonStorageEnumsTest.java", "diffHunk": "@@ -4,103 +4,86 @@\n import static com.google.common.truth.Truth.assertWithMessage;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwNjQ1MQ==", "bodyText": "I really feel like this test knows too much about the implementation. I should ideally be able to go in and change out how we map things and the test cases should still pass if I've done it correctly. If the test expects biMap, that won't be true.", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382106451", "createdAt": "2020-02-20T16:18:59Z", "author": {"login": "jaycarlton"}, "path": "common-api/src/test/java/org/pmiops/workbench/db/model/CommonStorageEnumsTest.java", "diffHunk": "@@ -4,103 +4,86 @@\n import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n-import java.util.function.Function;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n-import org.junit.runner.RunWith;\n-import org.junit.runners.Parameterized;\n-import org.junit.runners.Parameterized.Parameter;\n-import org.junit.runners.Parameterized.Parameters;\n-import org.pmiops.workbench.model.DataAccessLevel;\n import org.pmiops.workbench.model.Domain;\n \n-@RunWith(Parameterized.class)\n public class CommonStorageEnumsTest {\n-  @Parameters(name = \"{0}\")\n-  public static Object[][] data() {\n-    return new Object[][] {\n-      {\n-        DataAccessLevel.class.getSimpleName(),\n-        DataAccessLevel.values(),\n-        (Function<Short, DataAccessLevel>) CommonStorageEnums::dataAccessLevelFromStorage,\n-        (Function<DataAccessLevel, Short>) CommonStorageEnums::dataAccessLevelToStorage\n-      },\n-      {\n-        Domain.class.getSimpleName(),\n-        Domain.values(),\n-        (Function<Short, Domain>) CommonStorageEnums::domainFromStorage,\n-        (Function<Domain, Short>) CommonStorageEnums::domainToStorage\n-      }\n-    };\n-  }\n-\n-  @Parameter() public String description;\n-\n-  @Parameter(1)\n-  public Enum<?>[] enumValues;\n-\n-  @Parameter(2)\n-  public Function<Short, Enum<?>> fromStorage;\n-\n-  @Parameter(3)\n-  public Function<Enum<?>, Short> toStorage;\n-\n-  @Test\n-  public void testBijectiveStorageMapping() {\n-    for (Enum<?> v : enumValues) {\n-      Short storageValue = toStorage.apply(v);\n-      assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n-      assertThat(v).isEqualTo(fromStorage.apply(storageValue));\n-    }\n-  }\n \n   // domain ID is stringly-typed so special-case this\n \n   @Test\n-  public void testDomainIdBijectiveStorageMapping() {\n+  public void test_domainId() {\n     for (Domain v : Domain.values()) {\n       String storageValue = CommonStorageEnums.domainToDomainId(v);\n       assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n       assertThat(v).isEqualTo(CommonStorageEnums.domainIdToDomain(storageValue));\n     }\n   }\n \n-  // copied from api/StorageEnumsTest because the above tests are not comprehensive\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : CommonStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n-\n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n-\n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : CommonStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n-\n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n-\n-      // stringly typed map - test with testDomainIdBijectiveStorageMapping instead\n-      if (enumToShort.getName().equals(\"domainIdToDomain\")) {\n-        continue;\n-      }\n+  // this is a copy of StorageEnumsTest.test_noMissingMapEntries()\n \n+  @Test\n+  public void test_noMissingMapEntries() throws Exception {\n+    final Set<Class> enumClasses = getEnumerationClasses();\n+    final Collection<Method> methods = Arrays.asList(CommonStorageEnums.class.getDeclaredMethods());\n+\n+    // e.g. public static Short domainToStorage(Domain domain)\n+    final Map<Class, Method> toStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(firstMethodParameter(m)))\n+            // domainToDomainId is stringly typed - test with test_domainId\n+            .filter(m -> !m.getName().equals(\"domainToDomainId\"))\n+            .collect(Collectors.toMap(this::firstMethodParameter, m -> m));\n+\n+    // e.g. public static Domain domainFromStorage(Short domain)\n+    final Map<Class, Method> fromStorageMethods =\n+        methods.stream()\n+            .filter(m -> enumClasses.contains(m.getReturnType()))\n+            // domainToDomainId is stringly typed - test with test_domainId\n+            .filter(m -> !m.getName().equals(\"domainIdToDomain\"))\n+            .collect(Collectors.toMap(Method::getReturnType, m -> m));\n+\n+    for (Class enumClass : enumClasses) {\n+      final Method toStorage = toStorageMethods.get(enumClass);\n+      final Method fromStorage = fromStorageMethods.get(enumClass);\n       for (Object e : enumClass.getEnumConstants()) {\n-        Short shortVal = (Short) enumToShort.invoke(null, e);\n+        Short shortVal = (Short) toStorage.invoke(null, e);\n \n         assertThat(shortVal).named(enumClass.getName() + \":\" + e.toString()).isNotNull();\n-        assertThat(shortToEnum.invoke(null, shortVal)).isEqualTo(e);\n+        assertThat(fromStorage.invoke(null, shortVal)).isEqualTo(e);\n       }\n     }\n   }\n+\n+  /**\n+   * Retrieve all Enum classes in CommonStorageEnums\n+   *\n+   * <p>our convention for BiMaps in CommonStorageEnums is <Enum, Short> so we retrieve the first", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 141}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMDQ3MDk5", "url": "https://github.com/all-of-us/workbench/pull/3159#pullrequestreview-362047099", "createdAt": "2020-02-20T16:27:15Z", "commit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNjcxMzA5", "url": "https://github.com/all-of-us/workbench/pull/3159#pullrequestreview-362671309", "createdAt": "2020-02-21T14:35:42Z", "commit": {"oid": "9a0e327f2dadf6f34e791dc184a1fca334dbb1aa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNDozNTo0MlrOFs45Ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNDozNTo0MlrOFs45Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjYxMzg0Mg==", "bodyText": "I guess by virtue of them being in a bimap it's not a problem, but the test shouldn't know that.", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382613842", "createdAt": "2020-02-21T14:35:42Z", "author": {"login": "jaycarlton"}, "path": "common-api/src/test/java/org/pmiops/workbench/db/model/CommonStorageEnumsTest.java", "diffHunk": "@@ -4,103 +4,86 @@\n import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n-import java.util.function.Function;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n-import org.junit.runner.RunWith;\n-import org.junit.runners.Parameterized;\n-import org.junit.runners.Parameterized.Parameter;\n-import org.junit.runners.Parameterized.Parameters;\n-import org.pmiops.workbench.model.DataAccessLevel;\n import org.pmiops.workbench.model.Domain;\n \n-@RunWith(Parameterized.class)\n public class CommonStorageEnumsTest {\n-  @Parameters(name = \"{0}\")\n-  public static Object[][] data() {\n-    return new Object[][] {\n-      {\n-        DataAccessLevel.class.getSimpleName(),\n-        DataAccessLevel.values(),\n-        (Function<Short, DataAccessLevel>) CommonStorageEnums::dataAccessLevelFromStorage,\n-        (Function<DataAccessLevel, Short>) CommonStorageEnums::dataAccessLevelToStorage\n-      },\n-      {\n-        Domain.class.getSimpleName(),\n-        Domain.values(),\n-        (Function<Short, Domain>) CommonStorageEnums::domainFromStorage,\n-        (Function<Domain, Short>) CommonStorageEnums::domainToStorage\n-      }\n-    };\n-  }\n-\n-  @Parameter() public String description;\n-\n-  @Parameter(1)\n-  public Enum<?>[] enumValues;\n-\n-  @Parameter(2)\n-  public Function<Short, Enum<?>> fromStorage;\n-\n-  @Parameter(3)\n-  public Function<Enum<?>, Short> toStorage;\n-\n-  @Test\n-  public void testBijectiveStorageMapping() {\n-    for (Enum<?> v : enumValues) {\n-      Short storageValue = toStorage.apply(v);\n-      assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n-      assertThat(v).isEqualTo(fromStorage.apply(storageValue));\n-    }\n-  }\n \n   // domain ID is stringly-typed so special-case this\n \n   @Test\n-  public void testDomainIdBijectiveStorageMapping() {\n+  public void test_domainId() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEwMjI1OA=="}, "originalCommit": {"oid": "cb74f6fbe52cd6f77f2e86ed7e394aee1c8293de"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f779255f1785151ca20dc31dc9b87dfc0327d0d", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/8f779255f1785151ca20dc31dc9b87dfc0327d0d", "committedDate": "2020-02-21T15:10:49Z", "message": "refactor StorageEnumsTest and CommonStorageEnumsTest"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a0e327f2dadf6f34e791dc184a1fca334dbb1aa", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/9a0e327f2dadf6f34e791dc184a1fca334dbb1aa", "committedDate": "2020-02-20T22:21:11Z", "message": "big refactor"}, "afterCommit": {"oid": "8f779255f1785151ca20dc31dc9b87dfc0327d0d", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/8f779255f1785151ca20dc31dc9b87dfc0327d0d", "committedDate": "2020-02-21T15:10:49Z", "message": "refactor StorageEnumsTest and CommonStorageEnumsTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63d72a2b2e748ac724152d31f1ac108f2b069fe6", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/63d72a2b2e748ac724152d31f1ac108f2b069fe6", "committedDate": "2020-02-21T15:13:16Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1d283bb50a1cf55f47f15d1370b6b58ba50e789", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/d1d283bb50a1cf55f47f15d1370b6b58ba50e789", "committedDate": "2020-02-21T15:13:49Z", "message": "comment fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31815dd38be5ab7247929732ea984e650d879735", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/31815dd38be5ab7247929732ea984e650d879735", "committedDate": "2020-02-21T21:55:59Z", "message": "rm CommonStorageEnumsTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccf8e4aa348b31cd70fd2be4d1baf0eb48a569cc", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/ccf8e4aa348b31cd70fd2be4d1baf0eb48a569cc", "committedDate": "2020-02-21T22:01:04Z", "message": "arraysToSet() to make it pretty"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyOTQyMjIx", "url": "https://github.com/all-of-us/workbench/pull/3159#pullrequestreview-362942221", "createdAt": "2020-02-21T21:58:35Z", "commit": {"oid": "31815dd38be5ab7247929732ea984e650d879735"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMTo1ODozNVrOFtFz7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMjowMzo0NVrOFtF7IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNTQ1Mw==", "bodyText": "nit: Iterables.concat might be easier, but this is fine", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382825453", "createdAt": "2020-02-21T21:58:35Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/db/model/StorageEnumsTest.java", "diffHunk": "@@ -1,42 +1,117 @@\n package org.pmiops.workbench.db.model;\n \n import static com.google.common.truth.Truth.assertThat;\n+import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationTargetException;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n+import java.lang.reflect.Type;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n+import org.pmiops.workbench.model.Domain;\n \n public class StorageEnumsTest {\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : DbStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n+  private final Object INDICATES_STATIC_METHOD = null;\n \n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n+  final Set<Class> enumClasses = getEnumerationClasses();\n+  final Set<Method> methods =\n+      Stream.of(\n+              DbStorageEnums.class.getDeclaredMethods(),\n+              CommonStorageEnums.class.getDeclaredMethods())\n+          .flatMap(Stream::of)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31815dd38be5ab7247929732ea984e650d879735"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNTYzMw==", "bodyText": "nit:  looks like this comment got detached", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382825633", "createdAt": "2020-02-21T21:59:09Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/db/model/StorageEnumsTest.java", "diffHunk": "@@ -1,42 +1,117 @@\n package org.pmiops.workbench.db.model;\n \n import static com.google.common.truth.Truth.assertThat;\n+import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationTargetException;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n+import java.lang.reflect.Type;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n+import org.pmiops.workbench.model.Domain;\n \n public class StorageEnumsTest {\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : DbStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n+  private final Object INDICATES_STATIC_METHOD = null;\n \n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n+  final Set<Class> enumClasses = getEnumerationClasses();\n+  final Set<Method> methods =\n+      Stream.of(\n+              DbStorageEnums.class.getDeclaredMethods(),\n+              CommonStorageEnums.class.getDeclaredMethods())\n+          .flatMap(Stream::of)\n+          .collect(Collectors.toSet());\n \n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : DbStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n+  // e.g. public static Short reviewStatusToStorage(ReviewStatus s)\n+  final Map<Class, Method> enumClassToStorageMethod =\n+      methods.stream()\n+          // domainToDomainId is stringly typed - test with test_domainId\n+          .filter(m -> !m.getName().equals(\"domainToDomainId\"))\n+          .filter(m -> enumClasses.contains(firstMethodParameterType(m)))\n+          .collect(Collectors.toMap(this::firstMethodParameterType, m -> m));\n \n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n+  // e.g. public static ReviewStatus reviewStatusFromStorage(Short s)\n+  final Map<Type, Method> storageMethodToEnumClass =\n+      methods.stream()\n+          // domainIdToDomain is stringly typed - test with test_domainId\n+          .filter(m -> !m.getName().equals(\"domainIdToDomain\"))\n+          .filter(m -> enumClasses.contains(m.getReturnType()))\n+          .collect(Collectors.toMap(Method::getReturnType, m -> m));\n \n-      for (Object e : enumClass.getEnumConstants()) {\n-        Short shortVal = (Short) enumToShort.invoke(null, e);\n+  // special-case test for domain ID round trip", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31815dd38be5ab7247929732ea984e650d879735"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNjAwMg==", "bodyText": "nit: I'd put v on the right, since it's the known quantity and not the experimental quantity.", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382826002", "createdAt": "2020-02-21T22:00:13Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/db/model/StorageEnumsTest.java", "diffHunk": "@@ -1,42 +1,117 @@\n package org.pmiops.workbench.db.model;\n \n import static com.google.common.truth.Truth.assertThat;\n+import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationTargetException;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n+import java.lang.reflect.Type;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n+import org.pmiops.workbench.model.Domain;\n \n public class StorageEnumsTest {\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : DbStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n+  private final Object INDICATES_STATIC_METHOD = null;\n \n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n+  final Set<Class> enumClasses = getEnumerationClasses();\n+  final Set<Method> methods =\n+      Stream.of(\n+              DbStorageEnums.class.getDeclaredMethods(),\n+              CommonStorageEnums.class.getDeclaredMethods())\n+          .flatMap(Stream::of)\n+          .collect(Collectors.toSet());\n \n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : DbStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n+  // e.g. public static Short reviewStatusToStorage(ReviewStatus s)\n+  final Map<Class, Method> enumClassToStorageMethod =\n+      methods.stream()\n+          // domainToDomainId is stringly typed - test with test_domainId\n+          .filter(m -> !m.getName().equals(\"domainToDomainId\"))\n+          .filter(m -> enumClasses.contains(firstMethodParameterType(m)))\n+          .collect(Collectors.toMap(this::firstMethodParameterType, m -> m));\n \n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n+  // e.g. public static ReviewStatus reviewStatusFromStorage(Short s)\n+  final Map<Type, Method> storageMethodToEnumClass =\n+      methods.stream()\n+          // domainIdToDomain is stringly typed - test with test_domainId\n+          .filter(m -> !m.getName().equals(\"domainIdToDomain\"))\n+          .filter(m -> enumClasses.contains(m.getReturnType()))\n+          .collect(Collectors.toMap(Method::getReturnType, m -> m));\n \n-      for (Object e : enumClass.getEnumConstants()) {\n-        Short shortVal = (Short) enumToShort.invoke(null, e);\n+  // special-case test for domain ID round trip\n+\n+  @Test\n+  public void test_domainId() {\n+    for (Domain v : Domain.values()) {\n+      String storageValue = CommonStorageEnums.domainToDomainId(v);\n+      assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n+      assertThat(v).isEqualTo(CommonStorageEnums.domainIdToDomain(storageValue));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31815dd38be5ab7247929732ea984e650d879735"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNjU3Nw==", "bodyText": "nit: might be easier to read if you break it into the method lookup and invocation.", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382826577", "createdAt": "2020-02-21T22:01:39Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/db/model/StorageEnumsTest.java", "diffHunk": "@@ -1,42 +1,117 @@\n package org.pmiops.workbench.db.model;\n \n import static com.google.common.truth.Truth.assertThat;\n+import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationTargetException;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n+import java.lang.reflect.Type;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n+import org.pmiops.workbench.model.Domain;\n \n public class StorageEnumsTest {\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : DbStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n+  private final Object INDICATES_STATIC_METHOD = null;\n \n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n+  final Set<Class> enumClasses = getEnumerationClasses();\n+  final Set<Method> methods =\n+      Stream.of(\n+              DbStorageEnums.class.getDeclaredMethods(),\n+              CommonStorageEnums.class.getDeclaredMethods())\n+          .flatMap(Stream::of)\n+          .collect(Collectors.toSet());\n \n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : DbStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n+  // e.g. public static Short reviewStatusToStorage(ReviewStatus s)\n+  final Map<Class, Method> enumClassToStorageMethod =\n+      methods.stream()\n+          // domainToDomainId is stringly typed - test with test_domainId\n+          .filter(m -> !m.getName().equals(\"domainToDomainId\"))\n+          .filter(m -> enumClasses.contains(firstMethodParameterType(m)))\n+          .collect(Collectors.toMap(this::firstMethodParameterType, m -> m));\n \n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n+  // e.g. public static ReviewStatus reviewStatusFromStorage(Short s)\n+  final Map<Type, Method> storageMethodToEnumClass =\n+      methods.stream()\n+          // domainIdToDomain is stringly typed - test with test_domainId\n+          .filter(m -> !m.getName().equals(\"domainIdToDomain\"))\n+          .filter(m -> enumClasses.contains(m.getReturnType()))\n+          .collect(Collectors.toMap(Method::getReturnType, m -> m));\n \n-      for (Object e : enumClass.getEnumConstants()) {\n-        Short shortVal = (Short) enumToShort.invoke(null, e);\n+  // special-case test for domain ID round trip\n+\n+  @Test\n+  public void test_domainId() {\n+    for (Domain v : Domain.values()) {\n+      String storageValue = CommonStorageEnums.domainToDomainId(v);\n+      assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n+      assertThat(v).isEqualTo(CommonStorageEnums.domainIdToDomain(storageValue));\n+    }\n+  }\n \n-        assertThat(shortVal).named(enumClass.getName() + \":\" + e.toString()).isNotNull();\n-        assertThat(shortToEnum.invoke(null, shortVal)).isEqualTo(e);\n+  @Test\n+  public void test_noMissingMapEntries() throws InvocationTargetException, IllegalAccessException {\n+    for (final Class enumClass : enumClasses) {\n+      for (final Object enumValue : enumClass.getEnumConstants()) {\n+        Short shortValue = enumToStorage(enumValue, enumClass);\n+        assertThat(shortValue).named(enumClass.getName() + \":\" + enumValue.toString()).isNotNull();\n+        assertThat(storageToEnum(shortValue, enumClass)).isEqualTo(enumValue);\n       }\n     }\n   }\n+\n+  private Short enumToStorage(Object enumValue, Class enumClass)\n+      throws InvocationTargetException, IllegalAccessException {\n+    final Object returnValue =\n+        enumClassToStorageMethod.get(enumClass).invoke(INDICATES_STATIC_METHOD, enumValue);\n+    assertThat(returnValue instanceof Short).isTrue();\n+    return (Short) returnValue;\n+  }\n+\n+  private Object storageToEnum(Short shortValue, Class enumClass)\n+      throws InvocationTargetException, IllegalAccessException {\n+    return storageMethodToEnumClass.get(enumClass).invoke(INDICATES_STATIC_METHOD, shortValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31815dd38be5ab7247929732ea984e650d879735"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNjgyNA==", "bodyText": "nit: you might (later) also look for bimaps that don't have these properties and make noise, but I think it's ok.", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382826824", "createdAt": "2020-02-21T22:02:25Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/db/model/StorageEnumsTest.java", "diffHunk": "@@ -1,42 +1,117 @@\n package org.pmiops.workbench.db.model;\n \n import static com.google.common.truth.Truth.assertThat;\n+import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationTargetException;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n+import java.lang.reflect.Type;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n+import org.pmiops.workbench.model.Domain;\n \n public class StorageEnumsTest {\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : DbStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n+  private final Object INDICATES_STATIC_METHOD = null;\n \n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n+  final Set<Class> enumClasses = getEnumerationClasses();\n+  final Set<Method> methods =\n+      Stream.of(\n+              DbStorageEnums.class.getDeclaredMethods(),\n+              CommonStorageEnums.class.getDeclaredMethods())\n+          .flatMap(Stream::of)\n+          .collect(Collectors.toSet());\n \n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : DbStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n+  // e.g. public static Short reviewStatusToStorage(ReviewStatus s)\n+  final Map<Class, Method> enumClassToStorageMethod =\n+      methods.stream()\n+          // domainToDomainId is stringly typed - test with test_domainId\n+          .filter(m -> !m.getName().equals(\"domainToDomainId\"))\n+          .filter(m -> enumClasses.contains(firstMethodParameterType(m)))\n+          .collect(Collectors.toMap(this::firstMethodParameterType, m -> m));\n \n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n+  // e.g. public static ReviewStatus reviewStatusFromStorage(Short s)\n+  final Map<Type, Method> storageMethodToEnumClass =\n+      methods.stream()\n+          // domainIdToDomain is stringly typed - test with test_domainId\n+          .filter(m -> !m.getName().equals(\"domainIdToDomain\"))\n+          .filter(m -> enumClasses.contains(m.getReturnType()))\n+          .collect(Collectors.toMap(Method::getReturnType, m -> m));\n \n-      for (Object e : enumClass.getEnumConstants()) {\n-        Short shortVal = (Short) enumToShort.invoke(null, e);\n+  // special-case test for domain ID round trip\n+\n+  @Test\n+  public void test_domainId() {\n+    for (Domain v : Domain.values()) {\n+      String storageValue = CommonStorageEnums.domainToDomainId(v);\n+      assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n+      assertThat(v).isEqualTo(CommonStorageEnums.domainIdToDomain(storageValue));\n+    }\n+  }\n \n-        assertThat(shortVal).named(enumClass.getName() + \":\" + e.toString()).isNotNull();\n-        assertThat(shortToEnum.invoke(null, shortVal)).isEqualTo(e);\n+  @Test\n+  public void test_noMissingMapEntries() throws InvocationTargetException, IllegalAccessException {\n+    for (final Class enumClass : enumClasses) {\n+      for (final Object enumValue : enumClass.getEnumConstants()) {\n+        Short shortValue = enumToStorage(enumValue, enumClass);\n+        assertThat(shortValue).named(enumClass.getName() + \":\" + enumValue.toString()).isNotNull();\n+        assertThat(storageToEnum(shortValue, enumClass)).isEqualTo(enumValue);\n       }\n     }\n   }\n+\n+  private Short enumToStorage(Object enumValue, Class enumClass)\n+      throws InvocationTargetException, IllegalAccessException {\n+    final Object returnValue =\n+        enumClassToStorageMethod.get(enumClass).invoke(INDICATES_STATIC_METHOD, enumValue);\n+    assertThat(returnValue instanceof Short).isTrue();\n+    return (Short) returnValue;\n+  }\n+\n+  private Object storageToEnum(Short shortValue, Class enumClass)\n+      throws InvocationTargetException, IllegalAccessException {\n+    return storageMethodToEnumClass.get(enumClass).invoke(INDICATES_STATIC_METHOD, shortValue);\n+  }\n+\n+  /**\n+   * Retrieve all Enum classes in DbStorageEnums and CommonStorageEnums\n+   *\n+   * <p>our convention for BiMaps in DbStorageEnums/CommonStorageEnums is <Enum, Short> so we\n+   * retrieve the first parameterized type", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31815dd38be5ab7247929732ea984e650d879735"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjgyNzI5Nw==", "bodyText": "nit: ordinarily I don't expect statements with side effects inside a map call. It's OK here.", "url": "https://github.com/all-of-us/workbench/pull/3159#discussion_r382827297", "createdAt": "2020-02-21T22:03:45Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/db/model/StorageEnumsTest.java", "diffHunk": "@@ -1,42 +1,117 @@\n package org.pmiops.workbench.db.model;\n \n import static com.google.common.truth.Truth.assertThat;\n+import static com.google.common.truth.Truth.assertWithMessage;\n \n import com.google.common.collect.BiMap;\n-import java.lang.reflect.Field;\n+import java.lang.reflect.InvocationTargetException;\n import java.lang.reflect.Method;\n import java.lang.reflect.ParameterizedType;\n+import java.lang.reflect.Type;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n import org.junit.Test;\n+import org.pmiops.workbench.model.Domain;\n \n public class StorageEnumsTest {\n-  @Test\n-  public void noMissingMapEntries() throws Exception {\n-    for (Field f : DbStorageEnums.class.getDeclaredFields()) {\n-      if (f.getType() != BiMap.class) {\n-        continue;\n-      }\n+  private final Object INDICATES_STATIC_METHOD = null;\n \n-      Class enumClass =\n-          (Class) ((ParameterizedType) f.getAnnotatedType().getType()).getActualTypeArguments()[0];\n+  final Set<Class> enumClasses = getEnumerationClasses();\n+  final Set<Method> methods =\n+      Stream.of(\n+              DbStorageEnums.class.getDeclaredMethods(),\n+              CommonStorageEnums.class.getDeclaredMethods())\n+          .flatMap(Stream::of)\n+          .collect(Collectors.toSet());\n \n-      Method enumToShort = null;\n-      Method shortToEnum = null;\n-      for (Method m : DbStorageEnums.class.getDeclaredMethods()) {\n-        if (m.getParameterTypes()[0].equals(enumClass)) {\n-          enumToShort = m;\n-        }\n+  // e.g. public static Short reviewStatusToStorage(ReviewStatus s)\n+  final Map<Class, Method> enumClassToStorageMethod =\n+      methods.stream()\n+          // domainToDomainId is stringly typed - test with test_domainId\n+          .filter(m -> !m.getName().equals(\"domainToDomainId\"))\n+          .filter(m -> enumClasses.contains(firstMethodParameterType(m)))\n+          .collect(Collectors.toMap(this::firstMethodParameterType, m -> m));\n \n-        if (m.getReturnType().equals(enumClass)) {\n-          shortToEnum = m;\n-        }\n-      }\n+  // e.g. public static ReviewStatus reviewStatusFromStorage(Short s)\n+  final Map<Type, Method> storageMethodToEnumClass =\n+      methods.stream()\n+          // domainIdToDomain is stringly typed - test with test_domainId\n+          .filter(m -> !m.getName().equals(\"domainIdToDomain\"))\n+          .filter(m -> enumClasses.contains(m.getReturnType()))\n+          .collect(Collectors.toMap(Method::getReturnType, m -> m));\n \n-      for (Object e : enumClass.getEnumConstants()) {\n-        Short shortVal = (Short) enumToShort.invoke(null, e);\n+  // special-case test for domain ID round trip\n+\n+  @Test\n+  public void test_domainId() {\n+    for (Domain v : Domain.values()) {\n+      String storageValue = CommonStorageEnums.domainToDomainId(v);\n+      assertWithMessage(\"unmapped enum value: \" + v).that(storageValue).isNotNull();\n+      assertThat(v).isEqualTo(CommonStorageEnums.domainIdToDomain(storageValue));\n+    }\n+  }\n \n-        assertThat(shortVal).named(enumClass.getName() + \":\" + e.toString()).isNotNull();\n-        assertThat(shortToEnum.invoke(null, shortVal)).isEqualTo(e);\n+  @Test\n+  public void test_noMissingMapEntries() throws InvocationTargetException, IllegalAccessException {\n+    for (final Class enumClass : enumClasses) {\n+      for (final Object enumValue : enumClass.getEnumConstants()) {\n+        Short shortValue = enumToStorage(enumValue, enumClass);\n+        assertThat(shortValue).named(enumClass.getName() + \":\" + enumValue.toString()).isNotNull();\n+        assertThat(storageToEnum(shortValue, enumClass)).isEqualTo(enumValue);\n       }\n     }\n   }\n+\n+  private Short enumToStorage(Object enumValue, Class enumClass)\n+      throws InvocationTargetException, IllegalAccessException {\n+    final Object returnValue =\n+        enumClassToStorageMethod.get(enumClass).invoke(INDICATES_STATIC_METHOD, enumValue);\n+    assertThat(returnValue instanceof Short).isTrue();\n+    return (Short) returnValue;\n+  }\n+\n+  private Object storageToEnum(Short shortValue, Class enumClass)\n+      throws InvocationTargetException, IllegalAccessException {\n+    return storageMethodToEnumClass.get(enumClass).invoke(INDICATES_STATIC_METHOD, shortValue);\n+  }\n+\n+  /**\n+   * Retrieve all Enum classes in DbStorageEnums and CommonStorageEnums\n+   *\n+   * <p>our convention for BiMaps in DbStorageEnums/CommonStorageEnums is <Enum, Short> so we\n+   * retrieve the first parameterized type\n+   *\n+   * @return\n+   */\n+  private Set<Class> getEnumerationClasses() {\n+    return Stream.of(\n+            DbStorageEnums.class.getDeclaredFields(), CommonStorageEnums.class.getDeclaredFields())\n+        .flatMap(Stream::of)\n+        .filter(field -> field.getType().equals(BiMap.class))\n+        .map(\n+            field -> {\n+              // gets the specific BiMap type including annotations\n+              final Type biMapType = field.getAnnotatedType().getType();\n+\n+              // need a ParameterizedType to access the type arguments\n+              assertThat(biMapType instanceof ParameterizedType).isTrue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31815dd38be5ab7247929732ea984e650d879735"}, "originalPosition": 122}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcfc6a779b70c115b30964a5d6166f27e078ec29", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/dcfc6a779b70c115b30964a5d6166f27e078ec29", "committedDate": "2020-02-21T22:13:34Z", "message": "PR comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3608, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}