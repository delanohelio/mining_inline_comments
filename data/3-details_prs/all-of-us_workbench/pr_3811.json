{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0MDE5ODU2", "number": 3811, "title": "[no ticket][risk=no] Puppeteer notebook test", "bodyText": "Notebook basic tests in Python 3 and R language.\n\nThree new tests: notebook-r.spec.ts, notebook-python3.spec.ts and notebook-actions.spec.ts\nRenamed analysis-page to workspace-analysis-page file name.\nUnrelated to the new tests, fixes for flaky functions\n\ntests/cohorts/cohorts-rename.spec.ts is failing due to a UI change. Test code will be addressed in new PR.", "createdAt": "2020-07-21T01:51:05Z", "url": "https://github.com/all-of-us/workbench/pull/3811", "merged": true, "mergeCommit": {"oid": "f121e09ba04a2da38865ea3a5c3e7011820cb132"}, "closed": true, "closedAt": "2020-07-24T21:07:58Z", "author": {"login": "aweng98"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc28SwZgBqjM1Njg2MTIwNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4KlULgFqTQ1NTE4NTMyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c9fa0615fcce41a301960a43328d43e18aaaf74f", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/c9fa0615fcce41a301960a43328d43e18aaaf74f", "committedDate": "2020-07-21T01:49:10Z", "message": "wip"}, "afterCommit": {"oid": "7f3a624254421426fd5c6360459a50c9cbca0b2d", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/7f3a624254421426fd5c6360459a50c9cbca0b2d", "committedDate": "2020-07-21T01:52:30Z", "message": "new notebook test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aff90e15020280fab5452ed43089a03d949b8f88", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/aff90e15020280fab5452ed43089a03d949b8f88", "committedDate": "2020-07-21T02:56:38Z", "message": "fix dataset-create test"}, "afterCommit": {"oid": "37214af429d7c724a9496d0846134a2de7e55f10", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/37214af429d7c724a9496d0846134a2de7e55f10", "committedDate": "2020-07-21T17:02:50Z", "message": "skip R notebook test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MTMxMDQ0", "url": "https://github.com/all-of-us/workbench/pull/3811#pullrequestreview-454131044", "createdAt": "2020-07-23T13:29:50Z", "commit": {"oid": "29f998dd8c646a1e9d1ad24eeb70d715e5eab498"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzoyOTo1MFrOG2KkTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzoyOTo1MFrOG2KkTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ0OTQyMg==", "bodyText": "Nice! Can we add a test for error like if the notebook name already exist?", "url": "https://github.com/all-of-us/workbench/pull/3811#discussion_r459449422", "createdAt": "2020-07-23T13:29:50Z", "author": {"login": "NehaBroad"}, "path": "e2e/app/component/new-notebook-modal.ts", "diffHunk": "@@ -0,0 +1,71 @@\n+import {Page} from 'puppeteer';\n+import {savePageToFile, takeScreenshot} from 'utils/save-file-utils';\n+import {waitForText} from 'utils/waits-utils';\n+import RadioButton from 'app/element/radiobutton';\n+import {Language, LinkText} from 'app/text-labels';\n+import Button from 'app/element/button';\n+import Textbox from 'app/element/textbox';\n+import Modal from './modal';\n+\n+const modalTitle = 'New Notebook';\n+\n+export default class NewNotebookModal extends Modal {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29f998dd8c646a1e9d1ad24eeb70d715e5eab498"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MTMzNzg2", "url": "https://github.com/all-of-us/workbench/pull/3811#pullrequestreview-454133786", "createdAt": "2020-07-23T13:32:55Z", "commit": {"oid": "29f998dd8c646a1e9d1ad24eeb70d715e5eab498"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzozMjo1NVrOG2KsLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzozMjo1NVrOG2KsLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ1MTQzOQ==", "bodyText": "Optional: We can combine these three methods by just passing 'Shift'/'Control'. 'Alt' and replacing them in keyboard.down. Or\nKeep these three methods and have each one call a common method that takes the command and do the following:\nawait this.page.bringToFront();\nawait this.page.keyboard.down(command);\nawait this.page.keyboard.press('Enter', {delay: 20});\nawait this.page.keyboard.up(command);", "url": "https://github.com/all-of-us/workbench/pull/3811#discussion_r459451439", "createdAt": "2020-07-23T13:32:55Z", "author": {"login": "NehaBroad"}, "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -0,0 +1,185 @@\n+import {ElementHandle, Frame, Page} from 'puppeteer';\n+import {waitForDocumentTitle} from 'utils/waits-utils';\n+import {getPropValue} from 'utils/element-utils';\n+import AuthenticatedPage from './authenticated-page';\n+import CodeCell, {Selector as CodeCellSelector} from './notebook-code-cell';\n+\n+// CSS selectors\n+enum CssSelector {\n+  body = 'body.notebook_app',\n+  notebookContainer = '#notebook-container',\n+  toolbarContainer = '#maintoolbar-container',\n+  runCellButton = 'button[data-jupyter-action=\"jupyter-notebook:run-cell-and-select-next\"]',\n+  saveNotebookButton = 'button[data-jupyter-action=\"jupyter-notebook:save-notebook\"]',\n+  kernelIcon = '#kernel_indicator_icon',\n+  kernelName = '.kernel_indicator_name',\n+}\n+\n+enum Mode {\n+  Command= 'command_mode',\n+  Edit = 'command_mode',\n+}\n+\n+export enum KernelStatus {\n+  notRunning = 'Kernel is not running',\n+  Idle = 'Kernel Idle',\n+}\n+\n+export default class NotebookPage extends AuthenticatedPage {\n+  private codeCell: CodeCell;\n+\n+  constructor(page: Page, private readonly documentTitle) {\n+    super(page);\n+  }\n+\n+  async isLoaded(): Promise<boolean> {\n+    try {\n+      const frame = await this.frame();\n+      this.codeCell = new CodeCell(frame);\n+      // Wait up to 2 minutes.\n+      await Promise.all([\n+        waitForDocumentTitle(this.page, this.documentTitle, 120000),\n+        frame.waitForSelector(CssSelector.runCellButton, {visible: true, timeout: 120000}),\n+        frame.waitForSelector(CodeCellSelector.codeCell, {visible: true, timeout: 120000}),\n+        frame.waitForSelector(CssSelector.kernelIcon, {visible: true, timeout: 120000})\n+      ]);\n+      return true;\n+    } catch (e) {\n+      console.log(`NotebookPage isLoaded() encountered ${e}`);\n+      return false;\n+    }\n+  }\n+\n+  async notebookLink(): Promise<ElementHandle> {\n+    const selector = '//a[text()=\"Notebooks\"]';\n+    return this.page.waitForXPath(selector, {visible: true});\n+  }\n+\n+  /**\n+   * Click Run button in toolbar. It run focused cell and insert a new cell below.\n+   */\n+  async runButton(): Promise<void> {\n+    return this.frame()\n+      .then( (iframe) => iframe.waitForSelector(CssSelector.runCellButton, {visible: true}))\n+      .then( (butn) => butn.click() );\n+  }\n+\n+  /**\n+   * Click Save button in toolbar.\n+   */\n+  async saveNotebook(): Promise<void> {\n+    return this.frame()\n+      .then( (iframe) => iframe.waitForSelector(CssSelector.saveNotebookButton, {visible: true}))\n+      .then( (butn) => butn.click() );\n+  }\n+\n+  /**\n+   * Wait for notebook kernel becomes ready (idle).\n+   */\n+  async waitForKernelIdle(timeOut: number = 60000): Promise<boolean> {\n+    const iconSelector = `${CssSelector.kernelIcon}.kernel_idle_icon`;\n+    const notifSelector = '#notification_kernel';\n+    const frame = await this.frame();\n+    try {\n+      await Promise.all([\n+        frame.waitForSelector(iconSelector, {visible: true, timeout: timeOut}),\n+        frame.waitForSelector(notifSelector, {hidden: true, timeout: timeOut}),\n+      ])\n+      return true;\n+    } catch (e) {\n+      return false;\n+    }\n+  }\n+\n+  async kernelStatus(): Promise<KernelStatus | null> {\n+    const elemt = await this.frame().then( (frame) => frame.waitForSelector(CssSelector.kernelIcon, {visible: true}));\n+    const value = await getPropValue(elemt, 'title');\n+    await elemt.dispose();\n+    Object.keys(KernelStatus).forEach(key => {\n+      if (KernelStatus[key] === value) {\n+        return key;\n+      }\n+    })\n+    return null;\n+  }\n+\n+  async getKernelName(): Promise<string> {\n+    const frame = await this.frame();\n+    const elemt = await frame.waitForSelector(CssSelector.kernelName, {visible: true});\n+    const value = await getPropValue(elemt, 'textContent');\n+    await elemt.dispose();\n+    return value;\n+  }\n+\n+  /**\n+   * Click Run button in toolbar. It run focused cell and insert a new cell below.\n+   * @param {number} cellIndex Code Cell index. (index number starts from 1)\n+   * @param {string} code New code.\n+   * @return {string} Output string.\n+   */\n+  async runCodeCell(cellIndex: number, opts: { code?: string, timeOut?: number }): Promise<string> {\n+    await this.codeCell.selectCell(cellIndex, opts.code);\n+    await this.runButton();\n+    await Promise.all([\n+      this.waitForKernelIdle(opts.timeOut),\n+      this.codeCell.waitForOutput(cellIndex, opts.timeOut),\n+    ]);\n+    return this.codeCell.waitForOutput(cellIndex);\n+  }\n+\n+\n+  // ****************************************************************************\n+\n+  /**\n+   * Active Notebook Command or Edit mode.\n+   * @param mode\n+   */\n+  async toggleMode(mode: Mode): Promise<void> {\n+    // Press Esc key to activate command mode\n+    if (mode === Mode.Command) {\n+      return this.page.keyboard.press('Escape');\n+    }\n+    // Press Enter key to activate edit mode\n+    return this.page.keyboard.press('Enter');\n+  }\n+\n+  /**\n+   * Run (Execute) cells using Shift+Enter keys.\n+   * Shortcut explanation: Shift+Enter run cells and select below.\n+   */\n+  async runCellShiftEnter(): Promise<void> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29f998dd8c646a1e9d1ad24eeb70d715e5eab498"}, "originalPosition": 150}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0MTM1OTU3", "url": "https://github.com/all-of-us/workbench/pull/3811#pullrequestreview-454135957", "createdAt": "2020-07-23T13:35:23Z", "commit": {"oid": "29f998dd8c646a1e9d1ad24eeb70d715e5eab498"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzozNToyM1rOG2Kynw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMzozNToyM1rOG2Kynw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ1MzA4Nw==", "bodyText": "Can we add a test to make sure that on clicking any Download Option from File menu we see a pop Up with AoU policy", "url": "https://github.com/all-of-us/workbench/pull/3811#discussion_r459453087", "createdAt": "2020-07-23T13:35:23Z", "author": {"login": "NehaBroad"}, "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -0,0 +1,185 @@\n+import {ElementHandle, Frame, Page} from 'puppeteer';\n+import {waitForDocumentTitle} from 'utils/waits-utils';\n+import {getPropValue} from 'utils/element-utils';\n+import AuthenticatedPage from './authenticated-page';\n+import CodeCell, {Selector as CodeCellSelector} from './notebook-code-cell';\n+\n+// CSS selectors\n+enum CssSelector {\n+  body = 'body.notebook_app',\n+  notebookContainer = '#notebook-container',\n+  toolbarContainer = '#maintoolbar-container',\n+  runCellButton = 'button[data-jupyter-action=\"jupyter-notebook:run-cell-and-select-next\"]',\n+  saveNotebookButton = 'button[data-jupyter-action=\"jupyter-notebook:save-notebook\"]',\n+  kernelIcon = '#kernel_indicator_icon',\n+  kernelName = '.kernel_indicator_name',\n+}\n+\n+enum Mode {\n+  Command= 'command_mode',\n+  Edit = 'command_mode',\n+}\n+\n+export enum KernelStatus {\n+  notRunning = 'Kernel is not running',\n+  Idle = 'Kernel Idle',\n+}\n+\n+export default class NotebookPage extends AuthenticatedPage {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29f998dd8c646a1e9d1ad24eeb70d715e5eab498"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "762b99575e83b1e1d5999af49f15347681422c5a", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/762b99575e83b1e1d5999af49f15347681422c5a", "committedDate": "2020-07-23T14:05:25Z", "message": "new notebook test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00a2efdca73b64587cb8dfcbe89a514fc0deefaf", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/00a2efdca73b64587cb8dfcbe89a514fc0deefaf", "committedDate": "2020-07-23T23:30:11Z", "message": "saving work"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "29f998dd8c646a1e9d1ad24eeb70d715e5eab498", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/29f998dd8c646a1e9d1ad24eeb70d715e5eab498", "committedDate": "2020-07-21T17:28:50Z", "message": "unskip R notebook test"}, "afterCommit": {"oid": "00a2efdca73b64587cb8dfcbe89a514fc0deefaf", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/00a2efdca73b64587cb8dfcbe89a514fc0deefaf", "committedDate": "2020-07-23T23:30:11Z", "message": "saving work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22220231067618061ee60462396988d6ff731017", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/22220231067618061ee60462396988d6ff731017", "committedDate": "2020-07-24T01:19:46Z", "message": "updated new tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f9b460c5f578d8e6b2365df3e49a510498d615c", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/2f9b460c5f578d8e6b2365df3e49a510498d615c", "committedDate": "2020-07-24T20:18:43Z", "message": "fix flaky functions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTY1NDIw", "url": "https://github.com/all-of-us/workbench/pull/3811#pullrequestreview-455165420", "createdAt": "2020-07-24T20:26:14Z", "commit": {"oid": "2f9b460c5f578d8e6b2365df3e49a510498d615c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDoyNjoxNFrOG28w1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQyMDoyNjoxNFrOG28w1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3MTgzMQ==", "bodyText": "reworked waitWhileLoading function", "url": "https://github.com/all-of-us/workbench/pull/3811#discussion_r460271831", "createdAt": "2020-07-24T20:26:14Z", "author": {"login": "aweng98"}, "path": "e2e/utils/test-utils.ts", "diffHunk": "@@ -45,36 +45,24 @@ export async function signInAs(userId: string, passwd: string): Promise<Page> {\n  * It usually indicates the page is ready for user interaction.\n  * </pre>\n  */\n-export async function waitWhileLoading(page: Page, timeOut: number = 90000): Promise<void> {\n-  // wait maximum 1 second for either spinner to show up\n-  const spinSelector = '.spinner, svg';\n-  let spinner: JSHandle;\n-  try {\n-    spinner = await page.waitFor((selector) => {\n-      return document.querySelectorAll(selector).length > 0\n-    }, {timeout: 1000}, spinSelector);\n-  } catch (err) {\n-    console.info('waitWhileLoading does not find any spin elements.');\n-  }\n-  const jValue = await spinner.jsonValue();\n+export async function waitWhileLoading(page: Page, timeOut?: number): Promise<void> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f9b460c5f578d8e6b2365df3e49a510498d615c"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1MTg1MzI1", "url": "https://github.com/all-of-us/workbench/pull/3811#pullrequestreview-455185325", "createdAt": "2020-07-24T21:05:39Z", "commit": {"oid": "2f9b460c5f578d8e6b2365df3e49a510498d615c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4482, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}