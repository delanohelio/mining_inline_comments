{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3ODcwNDA2", "number": 3338, "title": "[RW-3128][RISK=NO] local rollback command(s)", "bodyText": "Description:\nProgress toward a general rollback capability for liquibase.\n\nproject.rb support\nsupports rollback by count & tag (though currently we aren't populating the tag column for all changesets)\n\nIt's my belief that we want to use tags, because if we could count, we wouldn't have become programmers. Seriously, though, there are failure modes where prod is at changeset 100, staging is at 103, and we want to use count=4. This works on staging (taking us back to 99), but blows up the prod database because we rolled back to 96.\nHowever, we can introduce tags later.\nCall it like\n# if we manually copy an ID to the tag column for changelog-128-add-columns-workspace\n ./project.rb run-liquibase --command=rollback --argument=changelog-128-add-columns-workspace\n\n# or to use count\n./project.rb run-liquibase --command=rollbackCount --argment=5\noutput (if you cancel) is here.\nAnother experiment, adding two Liquibase tags in separate changesets to the test db nad removing them one at a time.\nIn order to run on a non-local environment do\n./project.rb run-liquibase --command=status --project=all-of-us-workbench-test\n\nwhere the project argument is the full project path (or just local)\nSince this wraps the gradle file directly, you can see all the Liquibase commands by doing\n./project.rb run-liquibase --command=tasks\n\nand looking under \"Liquibase tasks\".\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-04-03T00:15:08Z", "url": "https://github.com/all-of-us/workbench/pull/3338", "merged": true, "mergeCommit": {"oid": "81a1fc6b9b97d2dfe72c1d978621315bd71b1aea"}, "closed": true, "closedAt": "2020-04-13T19:26:19Z", "author": {"login": "jaycarlton"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTGCOLAH2gAyMzk3ODcwNDA2OmYwYWZhZDVkNmJkNjIxZTBhMjEyODc0ZTAxMjU4OTUzY2IyOGQxMTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWTrSxAH2gAyMzk3ODcwNDA2OjdmNDc0MjI3ZGZlOTQ4ODkwMTQ0YmI5MGQ4MGVhMWM2MDVlYTlkNjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f0afad5d6bd621e0a212874e01258953cb28d117", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/f0afad5d6bd621e0a212874e01258953cb28d117", "committedDate": "2020-03-31T16:52:30Z", "message": "hack migrations script for rollback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ed5d6e8db083502290f68734f8fe51783a22326", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/2ed5d6e8db083502290f68734f8fe51783a22326", "committedDate": "2020-04-02T16:23:57Z", "message": "progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/7a2215ddb4db40664e2e11accc722759b2dcb8d6", "committedDate": "2020-04-03T00:11:32Z", "message": "remove comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2ODYxNzgx", "url": "https://github.com/all-of-us/workbench/pull/3338#pullrequestreview-386861781", "createdAt": "2020-04-03T00:16:23Z", "commit": {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMDoxNjoyM1rOGAA4lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMDoyNDoyOFrOGABBag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2NzY2OQ==", "bodyText": "There's still an issue with this block, at least accorrding to IntelliJ's gradle plugin", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402667669", "createdAt": "2020-04-03T00:16:23Z", "author": {"login": "jaycarlton"}, "path": "api/db/build.gradle", "diffHunk": "@@ -11,16 +11,16 @@ apply plugin: 'org.liquibase.gradle'\n \n def db_host = System.getenv(\"DB_HOST\") ?: \"db\"\n def db_port = System.getenv(\"DB_PORT\") ?: \"3306\"\n+def liquibase_username = \"liquibase\"\n def liquibase_password = System.getenv(\"LIQUIBASE_DB_PASSWORD\") ?: \"lb-notasecret\"\n \n liquibase {\n     activities {\n         main {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2ODE3NA==", "bodyText": "I did this to make the db/build.gradle project importable in IntelliJ. I'm not sure this is the right way to do it or if I still need it. #dev-productivity thread.", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402668174", "createdAt": "2020-04-03T00:18:06Z", "author": {"login": "jaycarlton"}, "path": "api/db/gradle-wrapper.properties", "diffHunk": "@@ -0,0 +1,6 @@\n+#Wed Apr 01 12:34:20 EDT 2020\n+distributionUrl=https\\://services.gradle.org/distributions/gradle-4.6-all.zip", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2ODQ3NA==", "bodyText": "I want to break this script up into one that builds the database and one that runs a liquibase command. Even better if we can drive liquibase without Bash or Ruby.", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402668474", "createdAt": "2020-04-03T00:19:03Z", "author": {"login": "jaycarlton"}, "path": "api/db/run-migrations.sh", "diffHunk": "@@ -22,7 +16,9 @@ trap finish EXIT\n envsubst < \"$(dirname \"${BASH_SOURCE}\")/create_db.sql\" > $CREATE_DB_FILE\n \n echo \"Creating database if it does not exist...\"\n+# This command is run regardless, and we rely on the commands in CREATE_DB_FILE being idempotent.\n mysql -h ${DB_HOST} --port ${DB_PORT} -u root -p${MYSQL_ROOT_PASSWORD} < ${CREATE_DB_FILE}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2ODY1Mg==", "bodyText": "I don't actually know how this file works, but I don't remember making this change...", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402668652", "createdAt": "2020-04-03T00:19:42Z", "author": {"login": "jaycarlton"}, "path": "api/gradle/wrapper/gradle-wrapper.properties", "diffHunk": "@@ -1,6 +1,6 @@\n-#Thu May 10 14:42:28 CDT 2018\n+#Wed Apr 01 12:34:20 EDT 2020", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2ODk3MQ==", "bodyText": "This was a pain to write, and Zeus help me if I want another option. The idea is that exactly one is provided.\nAlso, I want a general liquibase command. I'll do that tomorrow just for fun.", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402668971", "createdAt": "2020-04-03T00:21:02Z", "author": {"login": "jaycarlton"}, "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,50 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def rollback_db(cmd_name, *args)\n+  puts \"in rollback_db. cmd_name: #{cmd_name} args: #{args}\"\n+  ensure_docker_sync\n+  op = WbOptionsParser.new(cmd_name, args)\n+  op.add_typed_option(\n+      \"--count=[count]\",\n+      Integer,\n+      ->(opts, c) { opts.count = c},\n+      \"Count of changesets to roll back from end.\")\n+\n+  op.add_typed_option(\n+      \"--tag [tag]\",\n+      String,\n+      ->(opts, t) { opts.tag = t},\n+      \"Liquibase changeset tag to roll back to.\")\n+  op.add_validator ->(opts) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2OTUzMw==", "bodyText": "We actually don't need to provide this explicitly (yet), since the only activity we have is main. That would simplify things considerably, though I don't want to sacrifice generality. If other activities are added later, the default is to run all of them, so semantics will change if we leave this out.\nIt would be more robust to set main as the default as well, if that's supported.", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402669533", "createdAt": "2020-04-03T00:23:03Z", "author": {"login": "jaycarlton"}, "path": "api/db/run-migrations.sh", "diffHunk": "@@ -2,15 +2,9 @@\n set -xeuo pipefail\n IFS=$'\\n\\t'\n \n-activity=\"-PrunList=$1\"\n-if [ -z ${2+x} ]\n-then\n-    context=\"\"\n-else\n-    context=\"-Pcontexts=$2\"\n-fi\n-\n-# Ruby is not installed in our dev container and this script is short, so bash is fine.\n+liquibaseCommand=\"${1-update}\"\n+runList=\"-PrunList=${2-main}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2OTkzMA==", "bodyText": "This is really gross, but it works. I.e. we are handing the liquibase plugin an empty command value, and it doesn't break anything.\nThis script is way past my Bash expertise/tolerance. If I need to keep it, I want to port to Ruby or Python, or even pure Gradle.", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402669930", "createdAt": "2020-04-03T00:24:28Z", "author": {"login": "jaycarlton"}, "path": "api/db/run-migrations.sh", "diffHunk": "@@ -2,15 +2,9 @@\n set -xeuo pipefail\n IFS=$'\\n\\t'\n \n-activity=\"-PrunList=$1\"\n-if [ -z ${2+x} ]\n-then\n-    context=\"\"\n-else\n-    context=\"-Pcontexts=$2\"\n-fi\n-\n-# Ruby is not installed in our dev container and this script is short, so bash is fine.\n+liquibaseCommand=\"${1-update}\"\n+runList=\"-PrunList=${2-main}\"\n+liquibaseArgs=\"${3--PliquibaseCommandValue=}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2ODc3MDYz", "url": "https://github.com/all-of-us/workbench/pull/3338#pullrequestreview-386877063", "createdAt": "2020-04-03T01:07:48Z", "commit": {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMTowNzo0OFrOGABvUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMTowNzo0OFrOGABvUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY4MTY4MQ==", "bodyText": "Perhaps a more specific flag name, e.g. --to-tag ; currently it's slightly ambiguous as to whether it's rolling back TO this tag, or rolling back JUST this tag.", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r402681681", "createdAt": "2020-04-03T01:07:48Z", "author": {"login": "calbach"}, "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,50 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def rollback_db(cmd_name, *args)\n+  puts \"in rollback_db. cmd_name: #{cmd_name} args: #{args}\"\n+  ensure_docker_sync\n+  op = WbOptionsParser.new(cmd_name, args)\n+  op.add_typed_option(\n+      \"--count=[count]\",\n+      Integer,\n+      ->(opts, c) { opts.count = c},\n+      \"Count of changesets to roll back from end.\")\n+\n+  op.add_typed_option(\n+      \"--tag [tag]\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "713446bcfee69b33b2f284bd7ae7e0c9c1004d6c", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/713446bcfee69b33b2f284bd7ae7e0c9c1004d6c", "committedDate": "2020-04-03T17:37:05Z", "message": "expose liquibase directly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20d78e4a5da20d1e43ade5a5f7b1a67cfafe3476", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/20d78e4a5da20d1e43ade5a5f7b1a67cfafe3476", "committedDate": "2020-04-06T15:49:25Z", "message": "don't use external runList anymore. it's not there"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e254c4c736555e4fff4582bad60ed7850111697", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/5e254c4c736555e4fff4582bad60ed7850111697", "committedDate": "2020-04-06T16:04:58Z", "message": "use a wrapper task called liquibase and confirm with user before continuing."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3501c3b240281ac3419a7c25b95948c0f50020a0", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/3501c3b240281ac3419a7c25b95948c0f50020a0", "committedDate": "2020-04-06T16:09:04Z", "message": "restore changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c17cd82f68d389b231fadcce5947d7586d4078cf", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/c17cd82f68d389b231fadcce5947d7586d4078cf", "committedDate": "2020-04-08T13:16:30Z", "message": "trying to use db context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdefe71ae8a7c9ad703c2b3ed086d60be075c1be", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/bdefe71ae8a7c9ad703c2b3ed086d60be075c1be", "committedDate": "2020-04-08T21:34:48Z", "message": "fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dffaf532319060911251d202600263d859c90bf5", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/dffaf532319060911251d202600263d859c90bf5", "committedDate": "2020-04-09T13:05:53Z", "message": "cleanup slightly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e317c18d91aaf63cb3b350d3e61185358ecaa861", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/e317c18d91aaf63cb3b350d3e61185358ecaa861", "committedDate": "2020-04-09T13:14:43Z", "message": "merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c2a3159963a5b6552b9b019e0924b73ab011c38", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/9c2a3159963a5b6552b9b019e0924b73ab011c38", "committedDate": "2020-04-09T13:34:29Z", "message": "tidy up repeated code and add a couple trace logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74626f87c6d0872bff2784f9aaa50e5a801bc71d", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/74626f87c6d0872bff2784f9aaa50e5a801bc71d", "committedDate": "2020-04-09T13:36:37Z", "message": "kill rollback-db command; it was just a different way to invoke run-liquibase in the end"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4NDAyNDgy", "url": "https://github.com/all-of-us/workbench/pull/3338#pullrequestreview-388402482", "createdAt": "2020-04-06T16:09:36Z", "commit": {"oid": "713446bcfee69b33b2f284bd7ae7e0c9c1004d6c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNjowOTozNlrOGBfMPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNjowOTozNlrOGBfMPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDIxMjc5OA==", "bodyText": "Pushed to a later task.", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r404212798", "createdAt": "2020-04-06T16:09:36Z", "author": {"login": "jaycarlton"}, "path": "api/db/run-migrations.sh", "diffHunk": "@@ -22,7 +16,9 @@ trap finish EXIT\n envsubst < \"$(dirname \"${BASH_SOURCE}\")/create_db.sql\" > $CREATE_DB_FILE\n \n echo \"Creating database if it does not exist...\"\n+# This command is run regardless, and we rely on the commands in CREATE_DB_FILE being idempotent.\n mysql -h ${DB_HOST} --port ${DB_PORT} -u root -p${MYSQL_ROOT_PASSWORD} < ${CREATE_DB_FILE}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2ODQ3NA=="}, "originalCommit": {"oid": "7a2215ddb4db40664e2e11accc722759b2dcb8d6"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b45b4771fd0c6b9040f9401d7e8492bd827707c", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/7b45b4771fd0c6b9040f9401d7e8492bd827707c", "committedDate": "2020-04-09T15:21:46Z", "message": "restore properties file and add status line to sql proxy stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc9956be93a34d5ae4ba267e73e445783b0776e2", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/fc9956be93a34d5ae4ba267e73e445783b0776e2", "committedDate": "2020-04-09T17:19:47Z", "message": "make proxy optional"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a53522d8ad82e313ea9e0b029c79651fcb46a129", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/a53522d8ad82e313ea9e0b029c79651fcb46a129", "committedDate": "2020-04-09T17:28:16Z", "message": "remove old task name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73a9d457aa1b9aa9708723c1d31195b3b5b63b2e", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/73a9d457aa1b9aa9708723c1d31195b3b5b63b2e", "committedDate": "2020-04-09T21:06:43Z", "message": "rmeove unneeded changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6cb24a0d4b6093b3ee925b53bfe4c402647a623", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/f6cb24a0d4b6093b3ee925b53bfe4c402647a623", "committedDate": "2020-04-09T21:07:17Z", "message": "remove log line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74e7fd57e96f4acb8b3b16b6cf2cff593bd69f12", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/74e7fd57e96f4acb8b3b16b6cf2cff593bd69f12", "committedDate": "2020-04-09T21:09:21Z", "message": "restore script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a26555029c4f0d19932d8c07189661fda8bbd464", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/a26555029c4f0d19932d8c07189661fda8bbd464", "committedDate": "2020-04-09T21:58:38Z", "message": "cleanup & vars"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9945de0922ad14220f06a33c928f00e628efa4ae", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/9945de0922ad14220f06a33c928f00e628efa4ae", "committedDate": "2020-04-09T22:24:53Z", "message": "unneeded stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e95e115ed36ffe583c08d98cb874a7e36ab103fc", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/e95e115ed36ffe583c08d98cb874a7e36ab103fc", "committedDate": "2020-04-09T22:28:15Z", "message": "cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwODM5NDkx", "url": "https://github.com/all-of-us/workbench/pull/3338#pullrequestreview-390839491", "createdAt": "2020-04-09T14:22:56Z", "commit": {"oid": "9c2a3159963a5b6552b9b019e0924b73ab011c38"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoyMjo1NlrOGDbAgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNToxNTo1OVrOGDdWCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MTQxMA==", "bodyText": "Arguably, I don't strictly need to make changes here anymore now that I'm calling the gradle task directly in run_liquibase. However, this does give us some flexibility later on to run arbitrary tasks without doing the user confirmation.", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406241410", "createdAt": "2020-04-09T14:22:56Z", "author": {"login": "jaycarlton"}, "path": "api/db/run-migrations.sh", "diffHunk": "@@ -2,15 +2,9 @@\n set -xeuo pipefail\n IFS=$'\\n\\t'\n \n-activity=\"-PrunList=$1\"\n-if [ -z ${2+x} ]\n-then\n-    context=\"\"\n-else\n-    context=\"-Pcontexts=$2\"\n-fi\n-\n-# Ruby is not installed in our dev container and this script is short, so bash is fine.\n+liquibaseCommand=\"${1-update}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c2a3159963a5b6552b9b019e0924b73ab011c38"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI3OTY5MA==", "bodyText": "Keeping this line in place breaks IntelliJ's gradle plugin. specifically, it can't be added to the Gradle pane as a project.", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406279690", "createdAt": "2020-04-09T15:15:59Z", "author": {"login": "jaycarlton"}, "path": "api/db-cdr/build.gradle", "diffHunk": "@@ -51,6 +51,5 @@ liquibase {\n             username \"liquibase\"\n             password \"${liquibase_password}\"\n         }\n-        runList = project.ext.runList", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c2a3159963a5b6552b9b019e0924b73ab011c38"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMjAxMDUx", "url": "https://github.com/all-of-us/workbench/pull/3338#pullrequestreview-391201051", "createdAt": "2020-04-09T23:56:18Z", "commit": {"oid": "e95e115ed36ffe583c08d98cb874a7e36ab103fc"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQyMzo1NjoxOVrOGDtGRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQwMDowNTo0OVrOGDtP2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzNzc5Nw==", "bodyText": "spelling", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406537797", "createdAt": "2020-04-09T23:56:19Z", "author": {"login": "calbach"}, "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,116 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def liquibase_gradlew_command(verification_command, argument, run_list)\n+  verificion_full_cmd = %W{../gradlew #{verification_command} -PrunList=#{run_list}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e95e115ed36ffe583c08d98cb874a7e36ab103fc"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzODU5MQ==", "bodyText": "\ud83d\ude21", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406538591", "createdAt": "2020-04-09T23:59:10Z", "author": {"login": "calbach"}, "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,116 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def liquibase_gradlew_command(verification_command, argument, run_list)\n+  verificion_full_cmd = %W{../gradlew #{verification_command} -PrunList=#{run_list}}\n+  unless argument.nil? || argument.empty?\n+    verificion_full_cmd << argument\n+  end\n+  verificion_full_cmd\n+end\n+\n+# Run a liqibase command against the specified project. Where possible, show SQL\n+# statements and ask user for verification.\n+def run_liquibase(cmd_name, *args)\n+  command_to_sql = {\n+      'changelogSync' => 'changelogSyncSQL',\n+      'markNextChangesetRan' => 'markNextChangesetRanSQL',\n+      'rollback' => 'rollbackSQL',\n+      'rollbackCount' => 'rollbackCountSQL',\n+      'rollbackToDate' => 'rollbackToDateSQL',\n+      'update' => 'updateSQL',\n+      'updateCount' => 'updateCountSql',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e95e115ed36ffe583c08d98cb874a7e36ab103fc"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzODc1NQ==", "bodyText": "argument", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406538755", "createdAt": "2020-04-09T23:59:49Z", "author": {"login": "calbach"}, "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,116 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def liquibase_gradlew_command(verification_command, argument, run_list)\n+  verificion_full_cmd = %W{../gradlew #{verification_command} -PrunList=#{run_list}}\n+  unless argument.nil? || argument.empty?\n+    verificion_full_cmd << argument\n+  end\n+  verificion_full_cmd\n+end\n+\n+# Run a liqibase command against the specified project. Where possible, show SQL\n+# statements and ask user for verification.\n+def run_liquibase(cmd_name, *args)\n+  command_to_sql = {\n+      'changelogSync' => 'changelogSyncSQL',\n+      'markNextChangesetRan' => 'markNextChangesetRanSQL',\n+      'rollback' => 'rollbackSQL',\n+      'rollbackCount' => 'rollbackCountSQL',\n+      'rollbackToDate' => 'rollbackToDateSQL',\n+      'update' => 'updateSQL',\n+      'updateCount' => 'updateCountSql',\n+      'updateToTag' => 'updateToTagSQL'\n+  }\n+\n+  common = Common.new\n+  ensure_docker(cmd_name, args)\n+\n+  op = WbOptionsParser.new(cmd_name, args)\n+  op.add_typed_option(\n+      \"--command [command]\",\n+      String,\n+      ->(opts, c) { opts.command = c},\n+      \"Liquibase command, e.g. update, rollback, tag, validate. See \"+\n+          \"https://www.liquibase.org/documentation/command_line.html\")\n+  op.add_typed_option(\n+      \"--argument [argument]\",\n+      String,\n+      ->(opts, a) { opts.argument = a},\n+      \"Liquibase command argument, e.g. count or tag value\")\n+  op.add_typed_option(\n+        \"--run-list [run_list]\",\n+        String,\n+        ->(opts, rl) { opts.run_list = rl },\n+        \"Liquibase runList, a comma-separated list of activities in the liquibase task\")\n+  op.add_typed_option(\n+        '--project [project]',\n+        String,\n+        ->(opts, p) { opts.project = p },\n+        'AoU environment GCP project full name. Used to pick MySQL instance & creadentials.'\n+  )\n+  op.add_validator ->(opts) {\n+    if opts.command.nil? || opts.command.empty?\n+      raise ArgumentError.new(\"command is required\")\n+    end\n+  }\n+  op.parse.validate\n+\n+  # Currently there's only one activity (main), and leaving out the runList arugment causes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e95e115ed36ffe583c08d98cb874a7e36ab103fc"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTM2OA==", "bodyText": "I believe it executes a subprocess, presumably it didn't say cd not found, rather it didn't have any effect?", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406539368", "createdAt": "2020-04-10T00:02:11Z", "author": {"login": "calbach"}, "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,116 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def liquibase_gradlew_command(verification_command, argument, run_list)\n+  verificion_full_cmd = %W{../gradlew #{verification_command} -PrunList=#{run_list}}\n+  unless argument.nil? || argument.empty?\n+    verificion_full_cmd << argument\n+  end\n+  verificion_full_cmd\n+end\n+\n+# Run a liqibase command against the specified project. Where possible, show SQL\n+# statements and ask user for verification.\n+def run_liquibase(cmd_name, *args)\n+  command_to_sql = {\n+      'changelogSync' => 'changelogSyncSQL',\n+      'markNextChangesetRan' => 'markNextChangesetRanSQL',\n+      'rollback' => 'rollbackSQL',\n+      'rollbackCount' => 'rollbackCountSQL',\n+      'rollbackToDate' => 'rollbackToDateSQL',\n+      'update' => 'updateSQL',\n+      'updateCount' => 'updateCountSql',\n+      'updateToTag' => 'updateToTagSQL'\n+  }\n+\n+  common = Common.new\n+  ensure_docker(cmd_name, args)\n+\n+  op = WbOptionsParser.new(cmd_name, args)\n+  op.add_typed_option(\n+      \"--command [command]\",\n+      String,\n+      ->(opts, c) { opts.command = c},\n+      \"Liquibase command, e.g. update, rollback, tag, validate. See \"+\n+          \"https://www.liquibase.org/documentation/command_line.html\")\n+  op.add_typed_option(\n+      \"--argument [argument]\",\n+      String,\n+      ->(opts, a) { opts.argument = a},\n+      \"Liquibase command argument, e.g. count or tag value\")\n+  op.add_typed_option(\n+        \"--run-list [run_list]\",\n+        String,\n+        ->(opts, rl) { opts.run_list = rl },\n+        \"Liquibase runList, a comma-separated list of activities in the liquibase task\")\n+  op.add_typed_option(\n+        '--project [project]',\n+        String,\n+        ->(opts, p) { opts.project = p },\n+        'AoU environment GCP project full name. Used to pick MySQL instance & creadentials.'\n+  )\n+  op.add_validator ->(opts) {\n+    if opts.command.nil? || opts.command.empty?\n+      raise ArgumentError.new(\"command is required\")\n+    end\n+  }\n+  op.parse.validate\n+\n+  # Currently there's only one activity (main), and leaving out the runList arugment causes\n+  # it to run that activity. However, that's not because it's detected as default or primary, but\n+  # leaving out the runList is equivalent to specifying all of the activities to run in unspecified\n+  # order.\n+  # https://github.com/liquibase/liquibase-gradle-plugin#3-configuring-the-plugin\n+  if op.opts.run_list.nil? || op.opts.run_list.empty?\n+    run_list = \"main\"\n+  else\n+    run_list = op.opts.run_list\n+  end\n+\n+  if op.opts.argument.nil? || op.opts.argument.empty?\n+    # It's safe to pass the '-PliquibaseCommand=' by itself, but it's not very clean\n+    argument = ''\n+  else\n+    argument = \"-PliquibaseCommandValue=#{op.opts.argument}\"\n+  end\n+\n+  if op.opts.project.nil? || op.opts.project.empty?\n+    op.opts.project = 'local'\n+  end\n+\n+  context = GcloudContextV2.new(op)\n+  context.validate\n+\n+  with_optional_cloud_proxy_and_db(context, nil, 'sa-key.json') do |gcc|\n+    common.status('inside with_optional_cloud_proxy_and_db')\n+    common.status(\"project: #{gcc.project}, account: #{gcc.account}, creds_file: #{gcc.creds_file}, dir: #{Dir.pwd}\")\n+    command = op.opts.command\n+\n+    Dir.chdir('db') # 'cd' isn't available to run inline apparently", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e95e115ed36ffe583c08d98cb874a7e36ab103fc"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUzOTcxNg==", "bodyText": "thanks, not a bad solution", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406539716", "createdAt": "2020-04-10T00:03:36Z", "author": {"login": "calbach"}, "path": "api/libproject/devstart.rb", "diffHunk": "@@ -1999,6 +2109,19 @@ def with_cloud_proxy_and_db(gcc, service_account = nil, key_file = nil)\n   end\n end\n \n+def with_optional_cloud_proxy_and_db(gcc, service_account = nil, key_file = nil)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e95e115ed36ffe583c08d98cb874a7e36ab103fc"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjU0MDI0OQ==", "bodyText": "Does this duplicate the effect that gradle.properties is having? I assume that's just setting a default", "url": "https://github.com/all-of-us/workbench/pull/3338#discussion_r406540249", "createdAt": "2020-04-10T00:05:49Z", "author": {"login": "calbach"}, "path": "api/libproject/devstart.rb", "diffHunk": "@@ -634,6 +634,116 @@ def run_local_all_migrations()\n   :fn => ->() { run_local_all_migrations() }\n })\n \n+def liquibase_gradlew_command(verification_command, argument, run_list)\n+  verificion_full_cmd = %W{../gradlew #{verification_command} -PrunList=#{run_list}}\n+  unless argument.nil? || argument.empty?\n+    verificion_full_cmd << argument\n+  end\n+  verificion_full_cmd\n+end\n+\n+# Run a liqibase command against the specified project. Where possible, show SQL\n+# statements and ask user for verification.\n+def run_liquibase(cmd_name, *args)\n+  command_to_sql = {\n+      'changelogSync' => 'changelogSyncSQL',\n+      'markNextChangesetRan' => 'markNextChangesetRanSQL',\n+      'rollback' => 'rollbackSQL',\n+      'rollbackCount' => 'rollbackCountSQL',\n+      'rollbackToDate' => 'rollbackToDateSQL',\n+      'update' => 'updateSQL',\n+      'updateCount' => 'updateCountSql',\n+      'updateToTag' => 'updateToTagSQL'\n+  }\n+\n+  common = Common.new\n+  ensure_docker(cmd_name, args)\n+\n+  op = WbOptionsParser.new(cmd_name, args)\n+  op.add_typed_option(\n+      \"--command [command]\",\n+      String,\n+      ->(opts, c) { opts.command = c},\n+      \"Liquibase command, e.g. update, rollback, tag, validate. See \"+\n+          \"https://www.liquibase.org/documentation/command_line.html\")\n+  op.add_typed_option(\n+      \"--argument [argument]\",\n+      String,\n+      ->(opts, a) { opts.argument = a},\n+      \"Liquibase command argument, e.g. count or tag value\")\n+  op.add_typed_option(\n+        \"--run-list [run_list]\",\n+        String,\n+        ->(opts, rl) { opts.run_list = rl },\n+        \"Liquibase runList, a comma-separated list of activities in the liquibase task\")\n+  op.add_typed_option(\n+        '--project [project]',\n+        String,\n+        ->(opts, p) { opts.project = p },\n+        'AoU environment GCP project full name. Used to pick MySQL instance & creadentials.'\n+  )\n+  op.add_validator ->(opts) {\n+    if opts.command.nil? || opts.command.empty?\n+      raise ArgumentError.new(\"command is required\")\n+    end\n+  }\n+  op.parse.validate\n+\n+  # Currently there's only one activity (main), and leaving out the runList arugment causes\n+  # it to run that activity. However, that's not because it's detected as default or primary, but\n+  # leaving out the runList is equivalent to specifying all of the activities to run in unspecified\n+  # order.\n+  # https://github.com/liquibase/liquibase-gradle-plugin#3-configuring-the-plugin\n+  if op.opts.run_list.nil? || op.opts.run_list.empty?\n+    run_list = \"main\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e95e115ed36ffe583c08d98cb874a7e36ab103fc"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f474227dfe948890144bb90d80ea1c605ea9d60", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/7f474227dfe948890144bb90d80ea1c605ea9d60", "committedDate": "2020-04-10T16:27:54Z", "message": "use longer verification string"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3344, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}