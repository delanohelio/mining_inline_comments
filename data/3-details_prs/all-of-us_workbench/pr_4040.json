{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNTczMzcx", "number": 4040, "title": "[risk=medium][RW-5481] Link Admin Notebook Preview pages from Workspace Admin page", "bodyText": "Description:\nThis is a Stacked PR branching off #4028\nAdd [Preview] buttons to notebook files in the Workspace Admin page file listing.  Enable only if the admin provides an access reason and the file size is below the maximum (5MB).\nDoes not add buttons for notebook files outside of the standard location.  (TODO RW-5626)\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test-local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-09-21T21:36:21Z", "url": "https://github.com/all-of-us/workbench/pull/4040", "merged": true, "mergeCommit": {"oid": "30d28b686599788e1342e81e0cf21b0e31c082be"}, "closed": true, "closedAt": "2020-09-24T14:54:44Z", "author": {"login": "jmthibault79"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLZhueABqjM3OTM4MTYxNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMCPyjgFqTQ5NTY0NzI0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a47adf6d10b0bd7187d242668ea565ced23ea0d", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/9a47adf6d10b0bd7187d242668ea565ced23ea0d", "committedDate": "2020-09-21T21:08:10Z", "message": "Disable preview when the file is too large"}, "afterCommit": {"oid": "462466d2babda6963c67f896cfd89c7ba3dfb1aa", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/462466d2babda6963c67f896cfd89c7ba3dfb1aa", "committedDate": "2020-09-22T15:14:35Z", "message": "Disable preview when the file is too large"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "462466d2babda6963c67f896cfd89c7ba3dfb1aa", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/462466d2babda6963c67f896cfd89c7ba3dfb1aa", "committedDate": "2020-09-22T15:14:35Z", "message": "Disable preview when the file is too large"}, "afterCommit": {"oid": "212a295e160d1bb8359ed57b472f0294c856cb14", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/212a295e160d1bb8359ed57b472f0294c856cb14", "committedDate": "2020-09-22T17:34:48Z", "message": "Disable preview when the file is too large"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzU3NjYz", "url": "https://github.com/all-of-us/workbench/pull/4040#pullrequestreview-493757663", "createdAt": "2020-09-22T18:56:39Z", "commit": {"oid": "30480713e59d2549d177b934e74360377ee75fc6"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxODo1NjozOVrOHWIJ2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMToxNjoxN1rOHWMr8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk2NDMxMw==", "bodyText": "Nice to see function components and hooks being used!", "url": "https://github.com/all-of-us/workbench/pull/4040#discussion_r492964313", "createdAt": "2020-09-22T18:56:39Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -68,19 +78,33 @@ const workspaceInfoField = (labelText: string, divContents: React.ReactFragment)\n   </FlexRow>;\n };\n \n-const FileDetailsTable = (props: {data: Array<FileDetail>, bucket: string}) => {\n-  const {data, bucket} = props;\n+const NOTEBOOKS_DIRECTORY = 'notebooks';\n+const NOTEBOOKS_SUFFIX = '.ipynb';\n+const MAX_NOTEBOOK_READ_SIZE_BYTES = 5 * 1000 * 1000; // see NotebooksServiceImpl\n+\n+interface FileDetailsProps {\n+  workspaceNamespace: string;\n+  data: Array<FileDetail>;\n+  bucket: string;\n+}\n+\n+const FileDetailsTable = (props: FileDetailsProps) => {\n+  const {workspaceNamespace, data, bucket} = props;\n \n   interface TableEntry {\n-    name: string;\n-    size: string;\n     location: string;\n+    rawName: string;\n+    nameCell: ReactFragment;\n+    size: string;\n   }\n \n+  const [tableData, setTableData] = useState<Array<TableEntry>>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30480713e59d2549d177b934e74360377ee75fc6"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk4NDUwNg==", "bodyText": "Could this be another function component, with file and accessReason as props? If not, could accessReason be factored out as a param rather than using a closure?", "url": "https://github.com/all-of-us/workbench/pull/4040#discussion_r492984506", "createdAt": "2020-09-22T19:33:41Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -92,35 +116,76 @@ const FileDetailsTable = (props: {data: Array<FileDetail>, bucket: string}) => {\n     }\n   };\n \n-  const formattedData: Array<TableEntry> = data.map(file => {\n-    return {\n-      name: file.name,\n-      size: formatMB(file.sizeInBytes),\n-      location: getLocation(file)\n+  const nameCell = (file: FileDetail): React.ReactFragment => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30480713e59d2549d177b934e74360377ee75fc6"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk5MDAxOA==", "bodyText": "It looks like these functions (getLocation, nameCell and formatMB) can be factored outside of the main function component - this would prevent redefining the function on each render call. Would there be an issue with moving them?", "url": "https://github.com/all-of-us/workbench/pull/4040#discussion_r492990018", "createdAt": "2020-09-22T19:44:23Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -68,19 +78,33 @@ const workspaceInfoField = (labelText: string, divContents: React.ReactFragment)\n   </FlexRow>;\n };\n \n-const FileDetailsTable = (props: {data: Array<FileDetail>, bucket: string}) => {\n-  const {data, bucket} = props;\n+const NOTEBOOKS_DIRECTORY = 'notebooks';\n+const NOTEBOOKS_SUFFIX = '.ipynb';\n+const MAX_NOTEBOOK_READ_SIZE_BYTES = 5 * 1000 * 1000; // see NotebooksServiceImpl\n+\n+interface FileDetailsProps {\n+  workspaceNamespace: string;\n+  data: Array<FileDetail>;\n+  bucket: string;\n+}\n+\n+const FileDetailsTable = (props: FileDetailsProps) => {\n+  const {workspaceNamespace, data, bucket} = props;\n \n   interface TableEntry {\n-    name: string;\n-    size: string;\n     location: string;\n+    rawName: string;\n+    nameCell: ReactFragment;\n+    size: string;\n   }\n \n+  const [tableData, setTableData] = useState<Array<TableEntry>>();\n+  const [accessReason, setAccessReason] = useState('');\n+\n   const getLocation = (file: FileDetail): string => {\n     const prefix = `${bucket}/`;\n     const suffix = `/${file.name}`;\n-    return file.path.replace(prefix, '').replace(suffix, '');\n+    return file.path.replace(prefix, '').replace(suffix, '').trim();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30480713e59d2549d177b934e74360377ee75fc6"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk5OTc2MA==", "bodyText": "What are your thoughts on using a fp.cond for something like this?\nSomething along the lines of:\n    return fp.cond([\n      [() => NOTEBOOKS_DIRECTORY === getLocation(file) && filename.endsWith(NOTEBOOKS_SUFFIX) && (file.sizeInBytes > MAX_NOTEBOOK_READ_SIZE_BYTES) , enablePreview],\n      [() => NOTEBOOKS_DIRECTORY === getLocation(file) && filename.endsWith(NOTEBOOKS_SUFFIX), tooLargeToPreview],\n      [() => true, () => filenameText]\n    ])(accessReason)\nWhere enablePreview and tooLargeToPreview are defined functions that return the fragment", "url": "https://github.com/all-of-us/workbench/pull/4040#discussion_r492999760", "createdAt": "2020-09-22T20:02:34Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -92,35 +116,76 @@ const FileDetailsTable = (props: {data: Array<FileDetail>, bucket: string}) => {\n     }\n   };\n \n-  const formattedData: Array<TableEntry> = data.map(file => {\n-    return {\n-      name: file.name,\n-      size: formatMB(file.sizeInBytes),\n-      location: getLocation(file)\n+  const nameCell = (file: FileDetail): React.ReactFragment => {\n+    const filename = file.name.trim();\n+    const filenameText = <span>{filename}</span>;\n+    const navigateToPreview = () => {\n+      navigate(['admin', 'workspaces', workspaceNamespace, filename],\n+          { queryParams: { accessReason: accessReason } });\n     };\n-  });\n \n-  const sortedData = formattedData.sort((a, b) => {\n-    const locCmp = a.location.localeCompare(b.location);\n-    if (locCmp === 0) {\n-      return a.name.localeCompare(b.name);\n+    // remove first check after RW-5626\n+    if (NOTEBOOKS_DIRECTORY === getLocation(file) && filename.endsWith(NOTEBOOKS_SUFFIX)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30480713e59d2549d177b934e74360377ee75fc6"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwNDQyMQ==", "bodyText": "Thoughts on making this a ternary?\n      const locCmp = a.location.localeCompare(b.location);\n      return locCmp === 0 ? a.rawName.localeCompare(b.rawName) : locCmp", "url": "https://github.com/all-of-us/workbench/pull/4040#discussion_r493004421", "createdAt": "2020-09-22T20:11:28Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -92,35 +116,76 @@ const FileDetailsTable = (props: {data: Array<FileDetail>, bucket: string}) => {\n     }\n   };\n \n-  const formattedData: Array<TableEntry> = data.map(file => {\n-    return {\n-      name: file.name,\n-      size: formatMB(file.sizeInBytes),\n-      location: getLocation(file)\n+  const nameCell = (file: FileDetail): React.ReactFragment => {\n+    const filename = file.name.trim();\n+    const filenameText = <span>{filename}</span>;\n+    const navigateToPreview = () => {\n+      navigate(['admin', 'workspaces', workspaceNamespace, filename],\n+          { queryParams: { accessReason: accessReason } });\n     };\n-  });\n \n-  const sortedData = formattedData.sort((a, b) => {\n-    const locCmp = a.location.localeCompare(b.location);\n-    if (locCmp === 0) {\n-      return a.name.localeCompare(b.name);\n+    // remove first check after RW-5626\n+    if (NOTEBOOKS_DIRECTORY === getLocation(file) && filename.endsWith(NOTEBOOKS_SUFFIX)) {\n+      if (file.sizeInBytes > MAX_NOTEBOOK_READ_SIZE_BYTES) {\n+        return <FlexRow>\n+          {filenameText}\n+          <TooltipTrigger\n+            content={`Files larger than ${formatMB(MAX_NOTEBOOK_READ_SIZE_BYTES)} MB are too large to preview`}\n+          ><Button style={styles.previewButton} disabled={true}>Preview</Button>\n+          </TooltipTrigger>\n+        </FlexRow>;\n+      } else {\n+        return <FlexRow>\n+          {filenameText}\n+          <TooltipTrigger content='Please enter an access reason below' disabled={accessReason && accessReason.trim()}>\n+            <Button style={styles.previewButton} disabled={!accessReason || !accessReason.trim()}\n+                    onClick={navigateToPreview}>Preview</Button>\n+          </TooltipTrigger>\n+        </FlexRow>;\n+      }\n     } else {\n-      return locCmp;\n+      return filenameText;\n     }\n-  });\n-\n-  return <DataTable\n-      data-test-id='object-details-table'\n-      value={sortedData}\n-      style={styles.fileDetailsTable}\n-      scrollable={true}\n-      paginator={true}\n-      paginatorTemplate='CurrentPageReport FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink RowsPerPageDropdown'\n-      currentPageReportTemplate='Showing {first} to {last} of {totalRecords} entries'>\n-    <Column field='location' header='Location'/>\n-    <Column field='name' header='Filename'/>\n-    <Column field='size' header='File size (MB)'/>\n-  </DataTable>;\n+  };\n+\n+  const setupTable = () => {\n+    setTableData(data\n+      .map(file => {\n+        return {\n+          location: getLocation(file),\n+          rawName: file.name,\n+          nameCell: nameCell(file),\n+          size: formatMB(file.sizeInBytes),\n+        }; })\n+      .sort((a, b) => {\n+        const locCmp = a.location.localeCompare(b.location);\n+        if (locCmp === 0) {\n+          return a.rawName.localeCompare(b.rawName);\n+        } else {\n+          return locCmp;\n+        }}));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30480713e59d2549d177b934e74360377ee75fc6"}, "originalPosition": 155}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAzODU3Ng==", "bodyText": "I am not seeing the connection between accessReason and setting the table data - does the table data change as the accessReason changes? If so could this be added to the onChange handler rather than as an effect?", "url": "https://github.com/all-of-us/workbench/pull/4040#discussion_r493038576", "createdAt": "2020-09-22T21:16:17Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -92,35 +116,76 @@ const FileDetailsTable = (props: {data: Array<FileDetail>, bucket: string}) => {\n     }\n   };\n \n-  const formattedData: Array<TableEntry> = data.map(file => {\n-    return {\n-      name: file.name,\n-      size: formatMB(file.sizeInBytes),\n-      location: getLocation(file)\n+  const nameCell = (file: FileDetail): React.ReactFragment => {\n+    const filename = file.name.trim();\n+    const filenameText = <span>{filename}</span>;\n+    const navigateToPreview = () => {\n+      navigate(['admin', 'workspaces', workspaceNamespace, filename],\n+          { queryParams: { accessReason: accessReason } });\n     };\n-  });\n \n-  const sortedData = formattedData.sort((a, b) => {\n-    const locCmp = a.location.localeCompare(b.location);\n-    if (locCmp === 0) {\n-      return a.name.localeCompare(b.name);\n+    // remove first check after RW-5626\n+    if (NOTEBOOKS_DIRECTORY === getLocation(file) && filename.endsWith(NOTEBOOKS_SUFFIX)) {\n+      if (file.sizeInBytes > MAX_NOTEBOOK_READ_SIZE_BYTES) {\n+        return <FlexRow>\n+          {filenameText}\n+          <TooltipTrigger\n+            content={`Files larger than ${formatMB(MAX_NOTEBOOK_READ_SIZE_BYTES)} MB are too large to preview`}\n+          ><Button style={styles.previewButton} disabled={true}>Preview</Button>\n+          </TooltipTrigger>\n+        </FlexRow>;\n+      } else {\n+        return <FlexRow>\n+          {filenameText}\n+          <TooltipTrigger content='Please enter an access reason below' disabled={accessReason && accessReason.trim()}>\n+            <Button style={styles.previewButton} disabled={!accessReason || !accessReason.trim()}\n+                    onClick={navigateToPreview}>Preview</Button>\n+          </TooltipTrigger>\n+        </FlexRow>;\n+      }\n     } else {\n-      return locCmp;\n+      return filenameText;\n     }\n-  });\n-\n-  return <DataTable\n-      data-test-id='object-details-table'\n-      value={sortedData}\n-      style={styles.fileDetailsTable}\n-      scrollable={true}\n-      paginator={true}\n-      paginatorTemplate='CurrentPageReport FirstPageLink PrevPageLink PageLinks NextPageLink LastPageLink RowsPerPageDropdown'\n-      currentPageReportTemplate='Showing {first} to {last} of {totalRecords} entries'>\n-    <Column field='location' header='Location'/>\n-    <Column field='name' header='Filename'/>\n-    <Column field='size' header='File size (MB)'/>\n-  </DataTable>;\n+  };\n+\n+  const setupTable = () => {\n+    setTableData(data\n+      .map(file => {\n+        return {\n+          location: getLocation(file),\n+          rawName: file.name,\n+          nameCell: nameCell(file),\n+          size: formatMB(file.sizeInBytes),\n+        }; })\n+      .sort((a, b) => {\n+        const locCmp = a.location.localeCompare(b.location);\n+        if (locCmp === 0) {\n+          return a.rawName.localeCompare(b.rawName);\n+        } else {\n+          return locCmp;\n+        }}));\n+  };\n+\n+  useEffect(() => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30480713e59d2549d177b934e74360377ee75fc6"}, "originalPosition": 158}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30480713e59d2549d177b934e74360377ee75fc6", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/30480713e59d2549d177b934e74360377ee75fc6", "committedDate": "2020-09-22T17:41:02Z", "message": "renaming"}, "afterCommit": {"oid": "bf8172cce472d802ea6f3a1081ea2eab2fa04b6f", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/bf8172cce472d802ea6f3a1081ea2eab2fa04b6f", "committedDate": "2020-09-23T13:32:48Z", "message": "NameCell component"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "604a3cacd1a6768461703eb94bb88c8c2a23d155", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/604a3cacd1a6768461703eb94bb88c8c2a23d155", "committedDate": "2020-09-23T22:24:10Z", "message": "Add preview links to file table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c64ca809c95d1d0f3ba517bd40e4cf04a4826856", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/c64ca809c95d1d0f3ba517bd40e4cf04a4826856", "committedDate": "2020-09-23T22:24:10Z", "message": "Disable preview when the file is too large"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "453d2f1b9c10baf309f0d47b7c47914256211315", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/453d2f1b9c10baf309f0d47b7c47914256211315", "committedDate": "2020-09-23T22:24:11Z", "message": "rebase fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51af09fdd39af1c97132cd32eef8ca4286d051a5", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/51af09fdd39af1c97132cd32eef8ca4286d051a5", "committedDate": "2020-09-23T22:24:11Z", "message": "renaming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "080263160d312d7898ed785d595b8c8a4bc0dd7c", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/080263160d312d7898ed785d595b8c8a4bc0dd7c", "committedDate": "2020-09-23T22:24:11Z", "message": "rebase fix + lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa0260e02c7338067f547d5182a30d494dbc1bc4", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/fa0260e02c7338067f547d5182a30d494dbc1bc4", "committedDate": "2020-09-23T22:24:11Z", "message": "use ternary to sort"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4dc165d5bf34e0e6a47d748330d1d7daa289c87", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/b4dc165d5bf34e0e6a47d748330d1d7daa289c87", "committedDate": "2020-09-23T22:24:12Z", "message": "move parseLocation() out of component"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2549fc4f742bcf35d28d3b26b5a203e6ac983a7", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/f2549fc4f742bcf35d28d3b26b5a203e6ac983a7", "committedDate": "2020-09-23T22:24:12Z", "message": "NameCell component"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b43dd1b869da449a40e5225086506462543f6a1e", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/b43dd1b869da449a40e5225086506462543f6a1e", "committedDate": "2020-09-23T22:24:12Z", "message": "break out fileTooLarge and fileWithPreviewButton fragments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5ccb31550fb7ffed52228410f939c9fed0bc3ed", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/f5ccb31550fb7ffed52228410f939c9fed0bc3ed", "committedDate": "2020-09-23T22:24:12Z", "message": "explicitly type nameCell"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf6cddb4c7ac535f400b73a8bfd47054b72c360a", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/bf6cddb4c7ac535f400b73a8bfd47054b72c360a", "committedDate": "2020-09-23T22:24:13Z", "message": "fp.cond"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e082a9395a20377305d5874641070794ff564e1f", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/e082a9395a20377305d5874641070794ff564e1f", "committedDate": "2020-09-23T22:24:13Z", "message": "fp.cond fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fc32fe4bfb15d5d553d1211f1262c4899cf07e3b", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/fc32fe4bfb15d5d553d1211f1262c4899cf07e3b", "committedDate": "2020-09-23T21:17:48Z", "message": "fp.cond fix"}, "afterCommit": {"oid": "e082a9395a20377305d5874641070794ff564e1f", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/e082a9395a20377305d5874641070794ff564e1f", "committedDate": "2020-09-23T22:24:13Z", "message": "fp.cond fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93a753c9f10daf07cc1976cbc893b5b0778fa342", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/93a753c9f10daf07cc1976cbc893b5b0778fa342", "committedDate": "2020-09-24T11:51:02Z", "message": "cond comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjM4NDE5", "url": "https://github.com/all-of-us/workbench/pull/4040#pullrequestreview-495638419", "createdAt": "2020-09-24T14:32:52Z", "commit": {"oid": "93a753c9f10daf07cc1976cbc893b5b0778fa342"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDozMjo1MlrOHXd5Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDozMjo1MlrOHXd5Xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM2OTExOA==", "bodyText": "Are these comments needed?", "url": "https://github.com/all-of-us/workbench/pull/4040#discussion_r494369118", "createdAt": "2020-09-24T14:32:52Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -77,53 +88,121 @@ const formatMB = (fileSize: number): string => {\n   }\n };\n \n-const FileDetailsTable = (props: {data: Array<FileDetail>, bucket: string}) => {\n-  const {data, bucket} = props;\n+const parseLocation = (file: FileDetail, bucket: string): string => {\n+  const prefixLength = bucket.length;\n+  const start = prefixLength + 1;  // slash after bucket name\n+  const suffixPos = file.path.lastIndexOf(file.name);\n+  const end = suffixPos - 1;  // slash before filename\n+\n+  return file.path.substring(start, end);\n+};\n+\n+const NOTEBOOKS_DIRECTORY = 'notebooks';\n+const NOTEBOOKS_SUFFIX = '.ipynb';\n+const MAX_NOTEBOOK_READ_SIZE_BYTES = 5 * 1000 * 1000; // see NotebooksServiceImpl\n+\n+interface NameCellProps {\n+  file: FileDetail;\n+  bucket: string;\n+  workspaceNamespace: string;\n+  accessReason: string;\n+}\n+\n+const NameCell = (props: NameCellProps) => {\n+  const {file, bucket, workspaceNamespace, accessReason} = props;\n+  const filename = file.name.trim();\n+\n+  const filenameSpan = () => <span>{filename}</span>;\n+\n+  const fileTooLarge = () => <FlexRow>\n+    {filenameSpan()}\n+    <TooltipTrigger\n+        content={`Files larger than ${formatMB(MAX_NOTEBOOK_READ_SIZE_BYTES)} MB are too large to preview`}\n+    ><Button style={styles.previewButton} disabled={true}>Preview</Button>\n+    </TooltipTrigger>\n+  </FlexRow>;\n+\n+  const navigateToPreview = () => navigate(\n+      ['admin', 'workspaces', workspaceNamespace, filename],\n+      { queryParams: { accessReason: accessReason } });\n+\n+  const fileWithPreviewButton = () => <FlexRow>\n+    {filenameSpan()}\n+    <TooltipTrigger content='Please enter an access reason below' disabled={accessReason && accessReason.trim()}>\n+      <Button style={styles.previewButton}\n+              disabled={!accessReason || !accessReason.trim()}\n+              onClick={navigateToPreview}>Preview</Button>\n+    </TooltipTrigger>\n+  </FlexRow>;\n+\n+  // remove first check after RW-5626\n+  const isNotebook = () => (NOTEBOOKS_DIRECTORY === parseLocation(file, bucket)) && filename.endsWith(NOTEBOOKS_SUFFIX);\n+  const isTooLargeNotebook = () => isNotebook() && (file.sizeInBytes > MAX_NOTEBOOK_READ_SIZE_BYTES);\n+\n+  // if (tooLarge()) fileTooLarge();\n+  // else if (isNotebook()) fileWithPreviewButton();\n+  // else filenameSpan();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93a753c9f10daf07cc1976cbc893b5b0778fa342"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjQ3MjQ4", "url": "https://github.com/all-of-us/workbench/pull/4040#pullrequestreview-495647248", "createdAt": "2020-09-24T14:41:22Z", "commit": {"oid": "93a753c9f10daf07cc1976cbc893b5b0778fa342"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDo0MToyM1rOHXeTDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNDo0MToyM1rOHXeTDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3NTY5NA==", "bodyText": "Is cond not working without the dummy parameter?", "url": "https://github.com/all-of-us/workbench/pull/4040#discussion_r494375694", "createdAt": "2020-09-24T14:41:23Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -77,53 +88,121 @@ const formatMB = (fileSize: number): string => {\n   }\n };\n \n-const FileDetailsTable = (props: {data: Array<FileDetail>, bucket: string}) => {\n-  const {data, bucket} = props;\n+const parseLocation = (file: FileDetail, bucket: string): string => {\n+  const prefixLength = bucket.length;\n+  const start = prefixLength + 1;  // slash after bucket name\n+  const suffixPos = file.path.lastIndexOf(file.name);\n+  const end = suffixPos - 1;  // slash before filename\n+\n+  return file.path.substring(start, end);\n+};\n+\n+const NOTEBOOKS_DIRECTORY = 'notebooks';\n+const NOTEBOOKS_SUFFIX = '.ipynb';\n+const MAX_NOTEBOOK_READ_SIZE_BYTES = 5 * 1000 * 1000; // see NotebooksServiceImpl\n+\n+interface NameCellProps {\n+  file: FileDetail;\n+  bucket: string;\n+  workspaceNamespace: string;\n+  accessReason: string;\n+}\n+\n+const NameCell = (props: NameCellProps) => {\n+  const {file, bucket, workspaceNamespace, accessReason} = props;\n+  const filename = file.name.trim();\n+\n+  const filenameSpan = () => <span>{filename}</span>;\n+\n+  const fileTooLarge = () => <FlexRow>\n+    {filenameSpan()}\n+    <TooltipTrigger\n+        content={`Files larger than ${formatMB(MAX_NOTEBOOK_READ_SIZE_BYTES)} MB are too large to preview`}\n+    ><Button style={styles.previewButton} disabled={true}>Preview</Button>\n+    </TooltipTrigger>\n+  </FlexRow>;\n+\n+  const navigateToPreview = () => navigate(\n+      ['admin', 'workspaces', workspaceNamespace, filename],\n+      { queryParams: { accessReason: accessReason } });\n+\n+  const fileWithPreviewButton = () => <FlexRow>\n+    {filenameSpan()}\n+    <TooltipTrigger content='Please enter an access reason below' disabled={accessReason && accessReason.trim()}>\n+      <Button style={styles.previewButton}\n+              disabled={!accessReason || !accessReason.trim()}\n+              onClick={navigateToPreview}>Preview</Button>\n+    </TooltipTrigger>\n+  </FlexRow>;\n+\n+  // remove first check after RW-5626\n+  const isNotebook = () => (NOTEBOOKS_DIRECTORY === parseLocation(file, bucket)) && filename.endsWith(NOTEBOOKS_SUFFIX);\n+  const isTooLargeNotebook = () => isNotebook() && (file.sizeInBytes > MAX_NOTEBOOK_READ_SIZE_BYTES);\n+\n+  // if (tooLarge()) fileTooLarge();\n+  // else if (isNotebook()) fileWithPreviewButton();\n+  // else filenameSpan();\n+  const requiredDummyParameter = undefined;\n+  return fp.cond([\n+    [isTooLargeNotebook, fileTooLarge],\n+    [isNotebook, fileWithPreviewButton],\n+    [fp.stubTrue, filenameSpan]\n+  ])(requiredDummyParameter);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93a753c9f10daf07cc1976cbc893b5b0778fa342"}, "originalPosition": 111}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4071, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}