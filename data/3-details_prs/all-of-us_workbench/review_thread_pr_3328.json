{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MDQ1Njgz", "number": 3328, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxODo1NToxNVrODtqdcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjo1MToxMVrODudaKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjA4MTc5OnYy", "diffSide": "LEFT", "path": "e2e/app/google-login.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxODo1NToxNVrOF_OQJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxODo1NToxNVrOF_OQJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgzODExOA==", "bodyText": "tsc compile told me to remove redundant await when return is used. :)", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401838118", "createdAt": "2020-04-01T18:55:15Z", "author": {"login": "aweng98"}, "path": "e2e/app/google-login.ts", "diffHunk": "@@ -23,41 +23,51 @@ export default class GoogleLoginPage extends BasePage {\n    * Login email input field.\n    */\n   async email(): Promise<ElementHandle> {\n-    return await this.page.waitForXPath(selectors.emailInput, {visible: true});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjE0MTEwOnYy", "diffSide": "RIGHT", "path": "e2e/app/google-login.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToxMjowNlrOF_O1ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToxMjowNlrOF_O1ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0NzcxMA==", "bodyText": "Unrelated to jest-puppeteer. This change owns thanks to the unpredictable Google authentication. Test won't fail on Google login page.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401847710", "createdAt": "2020-04-01T19:12:06Z", "author": {"login": "aweng98"}, "path": "e2e/app/google-login.ts", "diffHunk": "@@ -23,41 +23,51 @@ export default class GoogleLoginPage extends BasePage {\n    * Login email input field.\n    */\n   async email(): Promise<ElementHandle> {\n-    return await this.page.waitForXPath(selectors.emailInput, {visible: true});\n+    return this.page.waitForXPath(selectors.emailInput, {visible: true});\n   }\n \n   /**\n    * Login password input field.\n    */\n   async password(): Promise<ElementHandle> {\n-    return await this.page.waitForXPath(selectors.passwordInput, {visible: true});\n+    return this.page.waitForXPath(selectors.passwordInput, {visible: true});\n   }\n \n   /**\n    * Google login button.\n    */\n   async loginButton(): Promise<ElementHandle> {\n-    return await this.page.waitForXPath(selectors.loginButton, {visible: true});\n+    return this.page.waitForXPath(selectors.loginButton, {visible: true});\n   }\n \n   /**\n    * Enter login email and click Next button.\n    * @param email\n    */\n   async enterEmail(userEmail: string) : Promise<void> {\n-    let emailInput: ElementHandle;\n-    try {\n-      emailInput = await this.email()\n-    } catch(e) {\n-      const randomLink = await this.page.$x('//*[@role=\"link\"]//*[text()=\"Use another account\"]');\n-      if (randomLink.length > 0) {\n-        await randomLink[0].click();\n-      }\n-      emailInput = await this.email()\n+    // Handle Google \"Use another account\" dialog if it exists\n+    const useAnotherAccountXpath = '//*[@role=\"link\"]//*[text()=\"Use another account\"]';\n+    const elemt1 = await Promise.race([\n+      this.page.waitForXPath(selectors.emailInput, {visible: true, timeout: 60000}),\n+      this.page.waitForXPath(useAnotherAccountXpath, {visible: true, timeout: 60000}),\n+    ]);\n+\n+    // compare to the Use another account link\n+    const [link] = await this.page.$x(useAnotherAccountXpath);\n+    const isLink = await page.evaluate((e1, e2) => e1 === e2, elemt1, link);\n+    if (isLink) {\n+      // click \" Use another Account \" link\n+      await Promise.all([\n+        this.page.waitForNavigation(),\n+        link.click(),\n+      ]);\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjE1MzIxOnYy", "diffSide": "RIGHT", "path": "e2e/tests/user/login.spec.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToxNTozNlrOF_O9ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToxNTozNlrOF_O9ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg0OTcwNg==", "bodyText": "For now, in some tests, setUserAgent and setDefaultNavigationTimeout are still required in beforeEach. boilerplate code, not good. I have a PR in work that will remove them from tests for good. I don't want to pack more new changes in this PR.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401849706", "createdAt": "2020-04-01T19:15:36Z", "author": {"login": "aweng98"}, "path": "e2e/tests/user/login.spec.ts", "diffHunk": "@@ -1,40 +1,25 @@\n import GoogleLoginPage, {selectors} from '../../app/google-login';\n-import PuppeteerLaunch from '../../driver/puppeteer-launch';\n \n const configs = require('../../resources/workbench-config');\n \n-// set timeout globally per suite, not per test.\n-jest.setTimeout(2 * 60 * 1000);\n \n describe('Login tests:', () => {\n-  let browser;\n-  let incognitoContext;\n-  let page;\n-\n-  beforeAll(async () =>  {\n-    browser = await PuppeteerLaunch();\n-  });\n \n   beforeEach(async () => {\n-    incognitoContext = await browser.createIncognitoBrowserContext();\n-    page = await incognitoContext.newPage();\n     await page.setUserAgent(configs.puppeteerUserAgent);\n-    await page.setDefaultNavigationTimeout(60000);\n+    await page.setDefaultNavigationTimeout(120000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjE1NTYyOnYy", "diffSide": "LEFT", "path": "e2e/tests/user/registration-ui.spec.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToxNjoyM1rOF_O_FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToxNjoyM1rOF_O_FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MDEzMg==", "bodyText": "test is no longer valid due to removal of invitation key during Create Account workflow.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401850132", "createdAt": "2020-04-01T19:16:23Z", "author": {"login": "aweng98"}, "path": "e2e/tests/user/registration-ui.spec.ts", "diffHunk": "@@ -3,56 +3,19 @@ import SelectComponent from '../../app/aou-elements/select-component';\n import Textbox from '../../app/aou-elements/textbox';\n import CreateAccountPage, {FIELD_LABEL, INSTITUTION_ROLE_VALUE, INSTITUTION_VALUE} from '../../app/create-account-page';\n import GoogleLoginPage from '../../app/google-login';\n-import PuppeteerLaunch from '../../driver/puppeteer-launch';\n \n const configs = require('../../resources/workbench-config');\n \n-// set timeout globally per suite, not per test.\n-jest.setTimeout(2 * 60 * 1000);\n \n-describe.skip('User registration tests:', () => {\n-\n-  let browser;\n-  let page;\n-\n-  beforeAll(async () => {\n-    browser = await PuppeteerLaunch();\n-  });\n+describe('User registration tests:', () => {\n \n   beforeEach(async () => {\n-    page = await browser.newPage();\n-    await page.setDefaultNavigationTimeout(60000);\n+    await page.setUserAgent(configs.puppeteerUserAgent);\n+    await page.setDefaultNavigationTimeout(120000);\n   });\n \n   afterEach(async () => {\n-    await page.close();\n-  });\n-\n-  afterAll(async () => {\n-    await browser.close();\n-  });\n-\n-\n-  test('Entered invalid invitation key', async () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjE2MTUzOnYy", "diffSide": "RIGHT", "path": "e2e/tslint.json", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxOToxODoxNVrOF_PC2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMjo1OToxOVrOF__bxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MTA5Nw==", "bodyText": "changes in tslint are mostly changed by linting. real change are lines #50 - #52.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401851097", "createdAt": "2020-04-01T19:18:15Z", "author": {"login": "aweng98"}, "path": "e2e/tslint.json", "diffHunk": "@@ -1,44 +1,55 @@\n {\n-    \"defaultSeverity\": \"error\",\n-    \"extends\": [\n-        \"tslint:recommended\",\n-        \"tslint-eslint-rules\",\n-        \"tslint-config-prettier\"\n+  \"defaultSeverity\": \"error\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MTQ5NA==", "bodyText": "Is this the same as our other tslint file? We should probably just have one.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401941494", "createdAt": "2020-04-01T22:14:39Z", "author": {"login": "calbach"}, "path": "e2e/tslint.json", "diffHunk": "@@ -1,44 +1,55 @@\n {\n-    \"defaultSeverity\": \"error\",\n-    \"extends\": [\n-        \"tslint:recommended\",\n-        \"tslint-eslint-rules\",\n-        \"tslint-config-prettier\"\n+  \"defaultSeverity\": \"error\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MTA5Nw=="}, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0MzkxMQ==", "bodyText": "I did a quick comparison. Some tslint options are different. I created a ticket RW-4700 to perform this task. If I do it now in this PR, it's going to change all files' formatting.\nI recall vaguely I did this before but made it a separate file because I don't load ui project in IDE, somehow I thought \"extend\": \"../ui/tslint.json\" didn't work. I don't remember why.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r402643911", "createdAt": "2020-04-02T22:59:19Z", "author": {"login": "aweng98"}, "path": "e2e/tslint.json", "diffHunk": "@@ -1,44 +1,55 @@\n {\n-    \"defaultSeverity\": \"error\",\n-    \"extends\": [\n-        \"tslint:recommended\",\n-        \"tslint-eslint-rules\",\n-        \"tslint-config-prettier\"\n+  \"defaultSeverity\": \"error\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTg1MTA5Nw=="}, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjcwNDY5OnYy", "diffSide": "RIGHT", "path": "e2e/app/authenticated-page.ts", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjowMzo1NlrOF_USnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDozNjo1NlrOF_XceA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNzA1NQ==", "bodyText": "unused?", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401937055", "createdAt": "2020-04-01T22:03:56Z", "author": {"login": "calbach"}, "path": "e2e/app/authenticated-page.ts", "diffHunk": "@@ -2,6 +2,7 @@ import {Page} from 'puppeteer';\n import {clrIconXpath} from './aou-elements/xpath-defaults';\n import {findIcon} from './aou-elements/xpath-finder';\n import BasePage from './base-page';\n+import {performance} from 'perf_hooks';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4ODcyOA==", "bodyText": "I am not sure what changes (maybe its' the jest-puppeteer preset) is responsible for causing the error ReferenceError: performance is not defined if import is not specified. Code used to work without import it explicitly.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401988728", "createdAt": "2020-04-02T00:36:56Z", "author": {"login": "aweng98"}, "path": "e2e/app/authenticated-page.ts", "diffHunk": "@@ -2,6 +2,7 @@ import {Page} from 'puppeteer';\n import {clrIconXpath} from './aou-elements/xpath-defaults';\n import {findIcon} from './aou-elements/xpath-finder';\n import BasePage from './base-page';\n+import {performance} from 'perf_hooks';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNzA1NQ=="}, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjcwODU5OnYy", "diffSide": "RIGHT", "path": "e2e/app/base-page.ts", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjowNToyOFrOF_UVJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDozODo0NFrOF_XeRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNzcwMg==", "bodyText": "In the codebase we typically don't capitalize local variables, even if they are constants.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401937702", "createdAt": "2020-04-01T22:05:28Z", "author": {"login": "calbach"}, "path": "e2e/app/base-page.ts", "diffHunk": "@@ -232,7 +232,34 @@ export default abstract class BasePage {\n     const timestamp = new Date().getTime();\n     const screenshotFile = `${SCREENSHOT_DIR}/${fileName}_${timestamp}.png`;\n     await this.page.screenshot({path: screenshotFile, fullPage: true});\n-    console.log('screenshot taken: ' + screenshotFile);\n+    console.log('Saved screenshot ' + screenshotFile);\n+  }\n+\n+  async saveToFile(fileName, data, suffix: string = 'html') {\n+    const LOG_DIR = 'logs/html';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4OTE5MQ==", "bodyText": "renamed them to screenshotDir and logDir.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401989191", "createdAt": "2020-04-02T00:38:44Z", "author": {"login": "aweng98"}, "path": "e2e/app/base-page.ts", "diffHunk": "@@ -232,7 +232,34 @@ export default abstract class BasePage {\n     const timestamp = new Date().getTime();\n     const screenshotFile = `${SCREENSHOT_DIR}/${fileName}_${timestamp}.png`;\n     await this.page.screenshot({path: screenshotFile, fullPage: true});\n-    console.log('screenshot taken: ' + screenshotFile);\n+    console.log('Saved screenshot ' + screenshotFile);\n+  }\n+\n+  async saveToFile(fileName, data, suffix: string = 'html') {\n+    const LOG_DIR = 'logs/html';", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNzcwMg=="}, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjcyMTkyOnYy", "diffSide": "RIGHT", "path": "e2e/jest-puppeteer.config.js", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjoxMDo0NVrOF_UdiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxOTowMDozNlrOF_5TnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzOTg0OQ==", "bodyText": "How did you decide on these flags - were these copied from elsewhere? Please add a comment.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401939849", "createdAt": "2020-04-01T22:10:45Z", "author": {"login": "calbach"}, "path": "e2e/jest-puppeteer.config.js", "diffHunk": "@@ -0,0 +1,44 @@\n+const lodash = require('lodash');\n+const puppeteer = require('puppeteer');\n+const isHeadless = process.env.HEADLESS !== 'false';\n+\n+const NEW_CHROME_SWITCHES = [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU0MzUxNg==", "bodyText": "good question. I had them for a while but I can't remember whys. Thinking back, most flags are for running tests in headless mode on CircleCI docker container.\nI added some comments. Hope it helps. I need more time to dig deeper if need more info.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r402543516", "createdAt": "2020-04-02T19:00:36Z", "author": {"login": "aweng98"}, "path": "e2e/jest-puppeteer.config.js", "diffHunk": "@@ -0,0 +1,44 @@\n+const lodash = require('lodash');\n+const puppeteer = require('puppeteer');\n+const isHeadless = process.env.HEADLESS !== 'false';\n+\n+const NEW_CHROME_SWITCHES = [", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzOTg0OQ=="}, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjcyNTk5OnYy", "diffSide": "RIGHT", "path": "e2e/resources/workbench-config.ts", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjoxMjoxN1rOF_UgFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMDoyNzozOVrOF_8GjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MDUwMg==", "bodyText": "Existing issue: the rest of the codebase uses lodash/fp, our convention is to alias this as \"fp\". May want to reconcile this later", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401940502", "createdAt": "2020-04-01T22:12:17Z", "author": {"login": "calbach"}, "path": "e2e/resources/workbench-config.ts", "diffHunk": "@@ -1,5 +1,5 @@\n require('dotenv').config();\n-const _ = require('lodash');\n+const lodash = require('lodash');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4OTMyNQ==", "bodyText": "cool. I updated lodash to lodash/fp here and in jest-puppeteer.config.js.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r402589325", "createdAt": "2020-04-02T20:27:39Z", "author": {"login": "aweng98"}, "path": "e2e/resources/workbench-config.ts", "diffHunk": "@@ -1,5 +1,5 @@\n require('dotenv').config();\n-const _ = require('lodash');\n+const lodash = require('lodash');", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MDUwMg=="}, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjcyOTEwOnYy", "diffSide": "RIGHT", "path": "e2e/tests/app.ts", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjoxMzozMFrOF_Uh8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMDoyODo0M1rOF_8H3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MDk3Ng==", "bodyText": "do we need to depend on clr-icon? This seems maybe overly specific. Can we just wait for app-signed-in, for example?", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401940976", "createdAt": "2020-04-01T22:13:30Z", "author": {"login": "calbach"}, "path": "e2e/tests/app.ts", "diffHunk": "@@ -0,0 +1,9 @@\n+import {Page} from 'puppeteer';\n+import GoogleLoginPage from '../app/google-login';\n+\n+\n+export const signIn = async (page: Page) => {\n+  await GoogleLoginPage.logIn(page);\n+   // this element exists in DOM after user has logged in\n+  await page.waitFor(() => document.querySelector('app-signed-in app-nav-bar clr-icon') !== null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU4OTY2Mg==", "bodyText": "I wanted to look for the navbar icon specifically. but I think just app-signed-in element is sufficient.", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r402589662", "createdAt": "2020-04-02T20:28:43Z", "author": {"login": "aweng98"}, "path": "e2e/tests/app.ts", "diffHunk": "@@ -0,0 +1,9 @@\n+import {Page} from 'puppeteer';\n+import GoogleLoginPage from '../app/google-login';\n+\n+\n+export const signIn = async (page: Page) => {\n+  await GoogleLoginPage.logIn(page);\n+   // this element exists in DOM after user has logged in\n+  await page.waitFor(() => document.querySelector('app-signed-in app-nav-bar clr-icon') !== null);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MDk3Ng=="}, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjczMDE5OnYy", "diffSide": "RIGHT", "path": "e2e/tests/user/registration.spec.ts", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjoxMzo1N1rOF_Uikw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMjo0NToyM1rOF__IOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MTEzOQ==", "bodyText": "Fix steps", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401941139", "createdAt": "2020-04-01T22:13:57Z", "author": {"login": "calbach"}, "path": "e2e/tests/user/registration.spec.ts", "diffHunk": "@@ -44,10 +25,6 @@ describe.skip('User registration tests:', () => {\n \n     const createAccountPage = new CreateAccountPage(page);\n \n-    // Step 1: Enter invitation key.\n-    await createAccountPage.waitForTextExists('Enter your Invitation Key:');\n-    await createAccountPage.fillOutInvitationKey(process.env.INVITATION_KEY);\n-\n     // Step 2: Terms of Service.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjYzODkwNA==", "bodyText": "Done", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r402638904", "createdAt": "2020-04-02T22:45:23Z", "author": {"login": "aweng98"}, "path": "e2e/tests/user/registration.spec.ts", "diffHunk": "@@ -44,10 +25,6 @@ describe.skip('User registration tests:', () => {\n \n     const createAccountPage = new CreateAccountPage(page);\n \n-    // Step 1: Enter invitation key.\n-    await createAccountPage.waitForTextExists('Enter your Invitation Key:');\n-    await createAccountPage.fillOutInvitationKey(process.env.INVITATION_KEY);\n-\n     // Step 2: Terms of Service.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MTEzOQ=="}, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MjczMDgwOnYy", "diffSide": "RIGHT", "path": "e2e/tests/user/registration.spec.ts", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMjoxNDowNVrOF_Ui5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQyMzowNTo0NlrOF__k1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MTIyMw==", "bodyText": "Did you mean to leave this in?", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r401941223", "createdAt": "2020-04-01T22:14:05Z", "author": {"login": "calbach"}, "path": "e2e/tests/user/registration.spec.ts", "diffHunk": "@@ -1,39 +1,20 @@\n import CreateAccountPage from '../../app/create-account-page';\n import GoogleLoginPage from '../../app/google-login';\n-import PuppeteerLaunch from '../../driver/puppeteer-launch';\n-const configs = require('../../resources/workbench-config');\n \n-// set timeout globally per suite, not per test.\n-jest.setTimeout(2 * 60 * 1000);\n \n-describe.skip('User registration tests:', () => {\n-\n-  let browser;\n-  let incognitoContext;\n-  let page;\n-\n-\n-  beforeAll(async () => {\n-    browser = await PuppeteerLaunch();\n-  });\n+describe('User registration tests:', () => {\n \n   beforeEach(async () => {\n-    incognitoContext = await browser.createIncognitoBrowserContext();\n-    page = await incognitoContext.newPage();\n     await page.setUserAgent(configs.puppeteerUserAgent);\n-    await page.setDefaultNavigationTimeout(60000);\n+    await page.setDefaultNavigationTimeout(120000);\n   });\n \n   afterEach(async () => {\n-    await incognitoContext.close();\n-  });\n-\n-  afterAll(async () => {\n-    await browser.close();\n+    await jestPuppeteer.resetBrowser();\n   });\n \n \n-  test('Can register new user', async () => {\n+  test.skip('Can register new user', async () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY0NjIzMA==", "bodyText": "yes. test is still not working. I need to change ClrIconLink class for finding email validated success icon. I'm only able to fix this test partially in this PR.  ticket RW-4648", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r402646230", "createdAt": "2020-04-02T23:05:46Z", "author": {"login": "aweng98"}, "path": "e2e/tests/user/registration.spec.ts", "diffHunk": "@@ -1,39 +1,20 @@\n import CreateAccountPage from '../../app/create-account-page';\n import GoogleLoginPage from '../../app/google-login';\n-import PuppeteerLaunch from '../../driver/puppeteer-launch';\n-const configs = require('../../resources/workbench-config');\n \n-// set timeout globally per suite, not per test.\n-jest.setTimeout(2 * 60 * 1000);\n \n-describe.skip('User registration tests:', () => {\n-\n-  let browser;\n-  let incognitoContext;\n-  let page;\n-\n-\n-  beforeAll(async () => {\n-    browser = await PuppeteerLaunch();\n-  });\n+describe('User registration tests:', () => {\n \n   beforeEach(async () => {\n-    incognitoContext = await browser.createIncognitoBrowserContext();\n-    page = await incognitoContext.newPage();\n     await page.setUserAgent(configs.puppeteerUserAgent);\n-    await page.setDefaultNavigationTimeout(60000);\n+    await page.setDefaultNavigationTimeout(120000);\n   });\n \n   afterEach(async () => {\n-    await incognitoContext.close();\n-  });\n-\n-  afterAll(async () => {\n-    await browser.close();\n+    await jestPuppeteer.resetBrowser();\n   });\n \n \n-  test('Can register new user', async () => {\n+  test.skip('Can register new user', async () => {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk0MTIyMw=="}, "originalCommit": {"oid": "e1f8695d106b94a997b4c73a389a308f14d6b68e"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwMDQyOTIzOnYy", "diffSide": "RIGHT", "path": "e2e/jest-puppeteer.config.js", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjo1MToxMVrOGAdzig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjo1NzoxNVrOGAeDQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MTUxNA==", "bodyText": "remove?", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r403141514", "createdAt": "2020-04-03T16:51:11Z", "author": {"login": "calbach"}, "path": "e2e/jest-puppeteer.config.js", "diffHunk": "@@ -1,41 +1,45 @@\n-const lodash = require('lodash');\n+const fp = require('lodash/fp');\n const puppeteer = require('puppeteer');\n const isHeadless = process.env.HEADLESS !== 'false';\n \n+\n const NEW_CHROME_SWITCHES = [\n-  '--disable-web-security',\n-  '--disable-features=TranslateUI,BlinkGenPropertyTrees,IsolateOrigins,site-per-process',\n-  '--disable-gpu',\n-  '--disable-accelerated-2d-canvas', // disable gpu-accelerated 2d canvas\n-  '--no-zygote', // https://codereview.chromium.org/2384163002\n+  // Reduce cpu and memory usage. Disables one-site-per-process security policy, dedicated processes for site origins.\n+  '--disable-features=BlinkGenPropertyTrees,IsolateOrigins,site-per-process',\n+  // Page not loading Login URL when launched Chromium without this flag. It disables use of zygote process for forking child processes.\n+  // https://codereview.chromium.org/2384163002\n+  '--no-zygote',\n+  '--no-sandbox', // required for --no-zygote flag\n+  '--safebrowsing-disable-auto-update',\n   '--window-size=1920,1080',\n ];\n \n-// append to Puppeteer default chrome flags.\n+// Append to Puppeteer default chrome flags.\n // https://github.com/puppeteer/puppeteer/blob/33f1967072e07824c5bf6a8c1336f844d9efaabf/lib/Launcher.js#L261\n-const DEFAULT_SWITCHES = puppeteer.defaultArgs({devtools: false, headless: isHeadless, userDataDir: null})\n-  .concat(...NEW_CHROME_SWITCHES)\n-  .filter(flag => flag !== '--disable-background-networking'); // filter out from default arguments\n+const DEFAULT_SWITCHES = fp.concat(\n+  puppeteer.defaultArgs({devtools: false, headless: isHeadless, userDataDir: null}),\n+  NEW_CHROME_SWITCHES\n+);\n \n-// merge without changing DEFAULT_SWITCHES\n-const CI_SWITCHES = lodash.assign([], DEFAULT_SWITCHES,\n-    [\n-      '--disable-dev-shm-usage',\n-      '--no-sandbox',\n-      '--disable-setuid-sandbox',\n-    ]\n+// Need for running Puppeteer headless Chromium in docker container.\n+const CI_SWITCHES = fp.concat(\n+  DEFAULT_SWITCHES,\n+  [\n+    '--disable-gpu', // https://bugs.chromium.org/p/chromium/issues/detail?id=737678#c10\n+    '--disable-setuid-sandbox',\n+  ]\n );\n \n-// switches for Chrome launch\n const SWITCHES = (process.env.CI === 'true') ? CI_SWITCHES : DEFAULT_SWITCHES;\n \n+console.log(SWITCHES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91db88325546bb14a809a8e4113432576c256ae8"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0NTUzNg==", "bodyText": "Done", "url": "https://github.com/all-of-us/workbench/pull/3328#discussion_r403145536", "createdAt": "2020-04-03T16:57:15Z", "author": {"login": "aweng98"}, "path": "e2e/jest-puppeteer.config.js", "diffHunk": "@@ -1,41 +1,45 @@\n-const lodash = require('lodash');\n+const fp = require('lodash/fp');\n const puppeteer = require('puppeteer');\n const isHeadless = process.env.HEADLESS !== 'false';\n \n+\n const NEW_CHROME_SWITCHES = [\n-  '--disable-web-security',\n-  '--disable-features=TranslateUI,BlinkGenPropertyTrees,IsolateOrigins,site-per-process',\n-  '--disable-gpu',\n-  '--disable-accelerated-2d-canvas', // disable gpu-accelerated 2d canvas\n-  '--no-zygote', // https://codereview.chromium.org/2384163002\n+  // Reduce cpu and memory usage. Disables one-site-per-process security policy, dedicated processes for site origins.\n+  '--disable-features=BlinkGenPropertyTrees,IsolateOrigins,site-per-process',\n+  // Page not loading Login URL when launched Chromium without this flag. It disables use of zygote process for forking child processes.\n+  // https://codereview.chromium.org/2384163002\n+  '--no-zygote',\n+  '--no-sandbox', // required for --no-zygote flag\n+  '--safebrowsing-disable-auto-update',\n   '--window-size=1920,1080',\n ];\n \n-// append to Puppeteer default chrome flags.\n+// Append to Puppeteer default chrome flags.\n // https://github.com/puppeteer/puppeteer/blob/33f1967072e07824c5bf6a8c1336f844d9efaabf/lib/Launcher.js#L261\n-const DEFAULT_SWITCHES = puppeteer.defaultArgs({devtools: false, headless: isHeadless, userDataDir: null})\n-  .concat(...NEW_CHROME_SWITCHES)\n-  .filter(flag => flag !== '--disable-background-networking'); // filter out from default arguments\n+const DEFAULT_SWITCHES = fp.concat(\n+  puppeteer.defaultArgs({devtools: false, headless: isHeadless, userDataDir: null}),\n+  NEW_CHROME_SWITCHES\n+);\n \n-// merge without changing DEFAULT_SWITCHES\n-const CI_SWITCHES = lodash.assign([], DEFAULT_SWITCHES,\n-    [\n-      '--disable-dev-shm-usage',\n-      '--no-sandbox',\n-      '--disable-setuid-sandbox',\n-    ]\n+// Need for running Puppeteer headless Chromium in docker container.\n+const CI_SWITCHES = fp.concat(\n+  DEFAULT_SWITCHES,\n+  [\n+    '--disable-gpu', // https://bugs.chromium.org/p/chromium/issues/detail?id=737678#c10\n+    '--disable-setuid-sandbox',\n+  ]\n );\n \n-// switches for Chrome launch\n const SWITCHES = (process.env.CI === 'true') ? CI_SWITCHES : DEFAULT_SWITCHES;\n \n+console.log(SWITCHES);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MTUxNA=="}, "originalCommit": {"oid": "91db88325546bb14a809a8e4113432576c256ae8"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3097, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}