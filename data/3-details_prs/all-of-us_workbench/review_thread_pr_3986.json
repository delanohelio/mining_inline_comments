{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MDM2NTcz", "number": 3986, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNzo1NTozM1rOEiOrxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTozNTo1NFrOEiTQDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MzI3NjIxOnYy", "diffSide": "RIGHT", "path": "api/reporting/schemas/REPORTING-SCHEMA-TOOLS.md", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNzo1NTozM1rOHP_Yuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNzo1NTozM1rOHP_Yuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUyOTIxMQ==", "bodyText": "TODO: link here from top-level README.", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r486529211", "createdAt": "2020-09-10T17:55:33Z", "author": {"login": "jaycarlton"}, "path": "api/reporting/schemas/REPORTING-SCHEMA-TOOLS.md", "diffHunk": "@@ -0,0 +1,177 @@\n+# Reporting Schema Tools & Process", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "217f964ebb09e965d1a7aba90ca91ba5a655020b"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MzMyMTA3OnYy", "diffSide": "RIGHT", "path": "api/reporting/schemas/REPORTING-SCHEMA-TOOLS.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODowODowNFrOHP_0lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODowODowNFrOHP_0lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjUzNjM0MQ==", "bodyText": "A prototype example of this is in this PR (changing rapidly).", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r486536341", "createdAt": "2020-09-10T18:08:04Z", "author": {"login": "jaycarlton"}, "path": "api/reporting/schemas/REPORTING-SCHEMA-TOOLS.md", "diffHunk": "@@ -0,0 +1,177 @@\n+# Reporting Schema Tools & Process\n+This directory and subdirectories archive schema changes\n+and tools to generate and translate them into code. There\n+are a few different stages, but the grunt work is mostly automated\n+for repeatability and consistency.\n+\n+The ruby script `generate_all_tables.rb` will operate on all of the input CSV files (described below)\n+and produce output files in this directory structure \n+```\n+$ ls ~/scratch/reportingOut5\n+big_query_json       projection_interface projection_query     swagger_yaml\n+```\n+\n+## EXPLAIN Application DB Table\n+The `explain table` MySql [statement](https://dev.mysql.com/doc/refman/8.0/en/explain.html) generates a tabular\n+set of attributes for table. These are then saved as CSV files and placed into the `mysql_describe_csv` directory.\n+\n+For example, the output of the `explain address;` is shown below.\n+\n+| Field | Type | Null | Key | Default | Extra |\n+| :--- | :--- | :--- | :--- | :--- | :--- |\n+| id | bigint\\(20\\) | NO | PRI | NULL | auto\\_increment |\n+| street\\_address\\_1 | varchar\\(95\\) | NO |  | NULL |  |\n+| street\\_address\\_2 | varchar\\(95\\) | YES |  | NULL |  |\n+| zip\\_code | varchar\\(10\\) | YES |  | NULL |  |\n+| city | varchar\\(95\\) | NO |  | NULL |  |\n+| state | varchar\\(95\\) | NO |  | NULL |  |\n+| country | varchar\\(95\\) | NO |  | NULL |  |\n+| user\\_id | bigint\\(20\\) | NO | MUL | NULL |  |\n+\n+## Mapping to BigQuery Schema JSON Format\n+The next task is to translate the MySql table description into the [BigQuery schema format](https://cloud.google.com/bigquery/docs/schemas#specifying_a_json_schema_file). Given this CSV input, we only really care about the field name and types. The\n+relational constraints won't be preserved in BigQuery, so they're basically ignored,\n+but we do want the primary key (which would be renamed to `address_id` in this example,\n+though in this case we actually merge `address` columns into the\n+`user` table). The script generates the for each table, with the example\n+of the address table shown. All fields are marked nullable, as to do otherwise would involve\n+adding constraints on the source data and/or its snapshot & upload processes.\n+\n+```json\n+[\n+  {\n+    \"name\": \"id\",\n+    \"description\": \"\",\n+    \"type\": \"INT64\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"street_address_1\",\n+    \"description\": \"\",\n+    \"type\": \"STRING\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"street_address_2\",\n+    \"description\": \"\",\n+    \"type\": \"STRING\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"zip_code\",\n+    \"description\": \"\",\n+    \"type\": \"STRING\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"city\",\n+    \"description\": \"\",\n+    \"type\": \"STRING\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"state\",\n+    \"description\": \"\",\n+    \"type\": \"STRING\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"country\",\n+    \"description\": \"\",\n+    \"type\": \"STRING\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"user_id\",\n+    \"description\": \"\",\n+    \"type\": \"INT64\",\n+    \"mode\": \"NULLABLE\"\n+  }\n+]\n+```\n+\n+## Spring Data Projection Interface", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "217f964ebb09e965d1a7aba90ca91ba5a655020b"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MzM1MzU4OnYy", "diffSide": "RIGHT", "path": "api/curl/upload-snapshot-cron.sh", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODoxNjoxN1rOHQAJGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODoxNjoxN1rOHQAJGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0MTU5Mg==", "bodyText": "I'm not clear on what is intended by this sentence.  Also, could you rename this script to include \"local\" somewhere?", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r486541592", "createdAt": "2020-09-10T18:16:17Z", "author": {"login": "jmthibault79"}, "path": "api/curl/upload-snapshot-cron.sh", "diffHunk": "@@ -0,0 +1,7 @@\n+#!/bin/bash\n+\n+# Start hit the reporting snapshot & upload cron endpoint  locally.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a55490889d0741363394bf2e1ffea68f922c04b8"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MzM3ODQwOnYy", "diffSide": "RIGHT", "path": "api/reporting/schemas/reporting-codegen.rb", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODoyMTozNlrOHQAYwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODoyMTozNlrOHQAYwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0NTYwMQ==", "bodyText": "I don't like the name \"valid\" here.  Maybe should_include_field?", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r486545601", "createdAt": "2020-09-10T18:21:36Z", "author": {"login": "jmthibault79"}, "path": "api/reporting/schemas/reporting-codegen.rb", "diffHunk": "@@ -0,0 +1,178 @@\n+#!/usr/bin/ruby\n+require 'csv'\n+require 'json'\n+require 'yaml'\n+\n+table_name = ARGV[0]\n+input_dir = File.expand_path(ARGV[1])\n+output_dir = File.expand_path(ARGV[2])\n+puts \"Generate types for #{table_name}...\"\n+Dir.mkdir(output_dir) unless Dir.exist?(output_dir)\n+\n+def to_camel_case(snake_case, capitalize_initial)\n+  result =  snake_case.split('_').collect(&:capitalize).join\n+  unless capitalize_initial\n+    result[0] = result[0].downcase\n+  end\n+  result\n+end\n+\n+def to_input_path(dir_name, table_name, suffix)\n+  File.expand_path(File.join(dir_name, \"#{table_name}.#{suffix}\"))\n+end\n+\n+def to_output_path(dir_name, table_name, suffix)\n+  Dir.mkdir(dir_name) unless Dir.exist?(dir_name)\n+  File.expand_path(File.join(dir_name, \"#{table_name}.#{suffix}\"))\n+end\n+\n+dto_class_name = \"Reporting#{to_camel_case(table_name, true)}\"\n+\n+inputs = {\n+    :describe_csv => to_input_path(File.join(input_dir, 'mysql_describe_csv'), table_name,'csv'),\n+    :exclude_columns => to_input_path(File.join(input_dir, 'excluded_columns'), table_name,'txt')\n+}\n+\n+outputs = {\n+    :big_query_json => to_output_path(File.join(output_dir, 'big_query_json'), table_name,'json'),\n+    :swagger_yaml => to_output_path(File.join(output_dir, 'swagger_yaml'), table_name,'yaml'),\n+    :projection_interface => to_output_path(File.join(output_dir, 'projection_interface'), table_name, 'java'),\n+    :projection_query => to_output_path(File.join(output_dir, 'projection_query'), table_name,'java')\n+}\n+\n+MYSQL_TO_BIGQUERY_TYPE = {\n+    'varchar' => 'STRING',\n+    'datetime' => 'TIMESTAMP',\n+    'bigint' => 'INT64',\n+    'smallint' => 'INT64',\n+    'longtext' => 'STRING',\n+    'int' => 'INT64',\n+    'tinyint' => 'INT64',\n+    'bit' => 'BOOLEAN',\n+    'double' => 'FLOAT64',\n+    'text' => 'STRING',\n+    'mediumblob' => 'STRING'\n+}\n+\n+def to_bq_type(mysql_type)\n+  type_pattern = Regexp.new(\"(?<type>\\\\w+)(\\\\(\\\\d+\\\\))?\")\n+  match_data = mysql_type.match(type_pattern)\n+  result = MYSQL_TO_BIGQUERY_TYPE[match_data[:type]]\n+  raise \"MySQL type #{mysql_type} not recognized.\" if result.nil?\n+  result\n+end\n+\n+excluded_fields = File.exist?(inputs[:exclude_columns]) ? File.readlines(inputs[:exclude_columns]) : []\n+\n+def is_valid_field?(excluded_fields, field)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a55490889d0741363394bf2e1ffea68f922c04b8"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MzM4ODQzOnYy", "diffSide": "RIGHT", "path": "api/reporting/schemas/input/excluded_columns/address.txt", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODoyMzo1MFrOHQAfLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxODo1MzozM1rOHQqHUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0NzI0NA==", "bodyText": "How do you connect an address to a user without this?\nMore generally, how did you choose which columns to exclude?", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r486547244", "createdAt": "2020-09-10T18:23:50Z", "author": {"login": "jmthibault79"}, "path": "api/reporting/schemas/input/excluded_columns/address.txt", "diffHunk": "@@ -0,0 +1,2 @@\n+id\n+user_id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a55490889d0741363394bf2e1ffea68f922c04b8"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIyOTI2Nw==", "bodyText": "I'm manually putting it in the JOIN statement We only use the DbAddress class in UserDao.\nThe schema doesn't include columns that are implementation details and don't have user-facing or admin-facing reality.", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r487229267", "createdAt": "2020-09-11T18:53:33Z", "author": {"login": "jaycarlton"}, "path": "api/reporting/schemas/input/excluded_columns/address.txt", "diffHunk": "@@ -0,0 +1,2 @@\n+id\n+user_id", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0NzI0NA=="}, "originalCommit": {"oid": "a55490889d0741363394bf2e1ffea68f922c04b8"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MzM5NDMzOnYy", "diffSide": "RIGHT", "path": "api/reporting/sql/query-users.sql", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODoyNTowNFrOHQAivA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxODoyNTowNFrOHQAivA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjU0ODE1Ng==", "bodyText": "missing end of comment", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r486548156", "createdAt": "2020-09-10T18:25:04Z", "author": {"login": "jmthibault79"}, "path": "api/reporting/sql/query-users.sql", "diffHunk": "@@ -0,0 +1,10 @@\n+-- Fetch all users from this environment who are not", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a55490889d0741363394bf2e1ffea68f922c04b8"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MzkxOTYwOnYy", "diffSide": "RIGHT", "path": "api/reporting/sql/researcher_stats_view.sql", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTowMTozOVrOHQFnAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxODo1NToxNVrOHQqKiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYzMTE2OA==", "bodyText": "Where are these sql files used?", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r486631168", "createdAt": "2020-09-10T21:01:39Z", "author": {"login": "freemabd"}, "path": "api/reporting/sql/researcher_stats_view.sql", "diffHunk": "@@ -0,0 +1,4 @@\n+CREATE MATERIALIZED VIEW reporting_local.researcher_stats AS", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf7327da516c8bed19c634bd5e9846866ff82c2d"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIzMDA4OA==", "bodyText": "Sorry, that's confusing. They're for ad-hoc manual queries I was doing in building the system. I was going to put them into the devops repo, but they came in on this branch since I just moved over all the applicable stuff under reporting.", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r487230088", "createdAt": "2020-09-11T18:55:15Z", "author": {"login": "jaycarlton"}, "path": "api/reporting/sql/researcher_stats_view.sql", "diffHunk": "@@ -0,0 +1,4 @@\n+CREATE MATERIALIZED VIEW reporting_local.researcher_stats AS", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYzMTE2OA=="}, "originalCommit": {"oid": "bf7327da516c8bed19c634bd5e9846866ff82c2d"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MzkyOTI4OnYy", "diffSide": "RIGHT", "path": "api/reporting/schemas/REPORTING-SCHEMA-TOOLS.md", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTowNDo0MVrOHQFs3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxODo1NTo1MFrOHQqLeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYzMjY3MA==", "bodyText": "Is the csv generation manual or is there a ruby script that does this? Do the csv file names have to match the table name?", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r486632670", "createdAt": "2020-09-10T21:04:41Z", "author": {"login": "freemabd"}, "path": "api/reporting/schemas/REPORTING-SCHEMA-TOOLS.md", "diffHunk": "@@ -0,0 +1,177 @@\n+# Reporting Schema Tools & Process\n+This directory and subdirectories archive schema changes\n+and tools to generate and translate them into code. There\n+are a few different stages, but the grunt work is mostly automated\n+for repeatability and consistency.\n+\n+The ruby script `generate_all_tables.rb` will operate on all of the input CSV files (described below)\n+and produce output files in this directory structure \n+```\n+$ ls ~/scratch/reportingOut5\n+big_query_json       projection_interface projection_query     swagger_yaml\n+```\n+\n+## EXPLAIN Application DB Table\n+The `explain table` MySql [statement](https://dev.mysql.com/doc/refman/8.0/en/explain.html) generates a tabular\n+set of attributes for table. These are then saved as CSV files and placed into the `mysql_describe_csv` directory.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf7327da516c8bed19c634bd5e9846866ff82c2d"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIzMDMyOA==", "bodyText": "It's manual at the moment. Yes, it needs to match the table name.", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r487230328", "createdAt": "2020-09-11T18:55:50Z", "author": {"login": "jaycarlton"}, "path": "api/reporting/schemas/REPORTING-SCHEMA-TOOLS.md", "diffHunk": "@@ -0,0 +1,177 @@\n+# Reporting Schema Tools & Process\n+This directory and subdirectories archive schema changes\n+and tools to generate and translate them into code. There\n+are a few different stages, but the grunt work is mostly automated\n+for repeatability and consistency.\n+\n+The ruby script `generate_all_tables.rb` will operate on all of the input CSV files (described below)\n+and produce output files in this directory structure \n+```\n+$ ls ~/scratch/reportingOut5\n+big_query_json       projection_interface projection_query     swagger_yaml\n+```\n+\n+## EXPLAIN Application DB Table\n+The `explain table` MySql [statement](https://dev.mysql.com/doc/refman/8.0/en/explain.html) generates a tabular\n+set of attributes for table. These are then saved as CSV files and placed into the `mysql_describe_csv` directory.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjYzMjY3MA=="}, "originalCommit": {"oid": "bf7327da516c8bed19c634bd5e9846866ff82c2d"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDAxNTY2OnYy", "diffSide": "RIGHT", "path": "api/reporting/schemas/REPORTING-SCHEMA-TOOLS.md", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTozMjo0NFrOHQGgVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTozMjo0NFrOHQGgVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0NTg0NQ==", "bodyText": "Should put something in the readme about how the excluded columns work", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r486645845", "createdAt": "2020-09-10T21:32:44Z", "author": {"login": "freemabd"}, "path": "api/reporting/schemas/REPORTING-SCHEMA-TOOLS.md", "diffHunk": "@@ -0,0 +1,177 @@\n+# Reporting Schema Tools & Process\n+This directory and subdirectories archive schema changes\n+and tools to generate and translate them into code. There\n+are a few different stages, but the grunt work is mostly automated\n+for repeatability and consistency.\n+\n+The ruby script `generate_all_tables.rb` will operate on all of the input CSV files (described below)\n+and produce output files in this directory structure \n+```\n+$ ls ~/scratch/reportingOut5\n+big_query_json       projection_interface projection_query     swagger_yaml\n+```\n+\n+## EXPLAIN Application DB Table\n+The `explain table` MySql [statement](https://dev.mysql.com/doc/refman/8.0/en/explain.html) generates a tabular\n+set of attributes for table. These are then saved as CSV files and placed into the `mysql_describe_csv` directory.\n+\n+For example, the output of the `explain address;` is shown below.\n+\n+| Field | Type | Null | Key | Default | Extra |\n+| :--- | :--- | :--- | :--- | :--- | :--- |\n+| id | bigint\\(20\\) | NO | PRI | NULL | auto\\_increment |\n+| street\\_address\\_1 | varchar\\(95\\) | NO |  | NULL |  |\n+| street\\_address\\_2 | varchar\\(95\\) | YES |  | NULL |  |\n+| zip\\_code | varchar\\(10\\) | YES |  | NULL |  |\n+| city | varchar\\(95\\) | NO |  | NULL |  |\n+| state | varchar\\(95\\) | NO |  | NULL |  |\n+| country | varchar\\(95\\) | NO |  | NULL |  |\n+| user\\_id | bigint\\(20\\) | NO | MUL | NULL |  |\n+\n+## Mapping to BigQuery Schema JSON Format\n+The next task is to translate the MySql table description into the [BigQuery schema format](https://cloud.google.com/bigquery/docs/schemas#specifying_a_json_schema_file). Given this CSV input, we only really care about the field name and types. The\n+relational constraints won't be preserved in BigQuery, so they're basically ignored,\n+but we do want the primary key (which would be renamed to `address_id` in this example,\n+though in this case we actually merge `address` columns into the\n+`user` table). The script generates the for each table, with the example\n+of the address table shown. All fields are marked nullable, as to do otherwise would involve\n+adding constraints on the source data and/or its snapshot & upload processes.\n+\n+```json\n+[\n+  {\n+    \"name\": \"id\",\n+    \"description\": \"\",\n+    \"type\": \"INT64\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"street_address_1\",\n+    \"description\": \"\",\n+    \"type\": \"STRING\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"street_address_2\",\n+    \"description\": \"\",\n+    \"type\": \"STRING\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"zip_code\",\n+    \"description\": \"\",\n+    \"type\": \"STRING\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"city\",\n+    \"description\": \"\",\n+    \"type\": \"STRING\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"state\",\n+    \"description\": \"\",\n+    \"type\": \"STRING\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"country\",\n+    \"description\": \"\",\n+    \"type\": \"STRING\",\n+    \"mode\": \"NULLABLE\"\n+  },\n+  {\n+    \"name\": \"user_id\",\n+    \"description\": \"\",\n+    \"type\": \"INT64\",\n+    \"mode\": \"NULLABLE\"\n+  }\n+]\n+```\n+\n+## Spring Data Projection Interface\n+The Ruby script builds projection interface definitions and query\n+annotations for the DAO method to fetch the projection. Since these must match exactly, it makes sense\n+to generate them in the same script.\n+\n+We use a projection for reporting snapshots for a couple of reasons. First, it allows the schema used\n+in reporting to evolve independently of the main application schema (up to a point). Second, when doing\n+very large reads, avoiding the overhead of constructing full-fledged entities is useful. Finally, it\n+allows us to decouple the upload snapshot types (DTOs) from the MySQL return values. MapStruct should\n+allow clean convergence from the projection types to the DTOs, though the reverse isn't possible, as\n+we can't actually instantiate the projection interfaces.\n+\n+### Projection Interface\n+The output for the Address table (assuming it's a stand-alone query) is below. In practice, these fields\n+are appended (by hand) to the `PrjUser` interface and query to denormalize it.\n+```java\n+interface PrjAddress {\n+  String getCity();\n+  String getCountry();\n+  long getId();\n+  String getState();\n+  String getStreetAddress1();\n+  String getStreetAddress2();\n+  long getUserId();\n+  String getZipCode();\n+}\n+```\n+\n+### Projection Query Annotation\n+The projection interface query must match exactly in terms of type, name, and order of columns referenced.\n+Failing to do this seems to lead to runtime exceptions but rarely any compile-time warnings. Thus, it's important\n+to unit test these.\n+\n+The following annotation is generated and should be attached to a DAO method such as `List<PrjAddress> findAllAddresses();`\n+```java\n+@Query(\"SELECT\n++ \"  a.city,\"\n++ \"  a.country,\"\n++ \"  a.id,\"\n++ \"  a.state,\"\n++ \"  a.streetAddress1,\"\n++ \"  a.streetAddress2,\"\n++ \"  a.userId,\"\n++ \"  a.zipCode\"\n++ \"FROM DbAddress a\")\n+```\n+\n+## Swagger DTO Classes\n+Currently the classes for the `ReportingSnapshot` object used\n+buy the upload service are specified in the API Swagger file. This was expedient,\n+but it means we're exposing internal details of the application in the API documentation.\n+\n+The output should look something like this:\n+```yaml\n+---\n+ReportingAddress:\n+  type: object\n+  properties:\n+    id:\n+      description: ''\n+      type: integer\n+      format: int64\n+    streetAddress1:\n+      description: ''\n+      type: string\n+    streetAddress2:\n+      description: ''\n+      type: string\n+    zipCode:\n+      description: ''\n+      type: string\n+    city:\n+      description: ''\n+      type: string\n+    state:\n+      description: ''\n+      type: string\n+    country:\n+      description: ''\n+      type: string\n+    userId:\n+      description: ''\n+      type: integer\n+      format: int64\n+```", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf7327da516c8bed19c634bd5e9846866ff82c2d"}, "originalPosition": 177}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NDAyNDQ2OnYy", "diffSide": "RIGHT", "path": "api/reporting/schemas/input/mysql_describe_csv/user.csv", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQyMTozNTo1NFrOHQGlxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxODo1ODo1M1rOHQqRMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0NzIzNw==", "bodyText": "Should the csv/text files be generated somehow, instead of committing them into the project. Won't the files become stale over time as the schema evolves?", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r486647237", "createdAt": "2020-09-10T21:35:54Z", "author": {"login": "freemabd"}, "path": "api/reporting/schemas/input/mysql_describe_csv/user.csv", "diffHunk": "@@ -0,0 +1,47 @@\n+user_id,bigint(20),NO,PRI,,auto_increment", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf7327da516c8bed19c634bd5e9846866ff82c2d"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzIzMTc5Mg==", "bodyText": "Eh, there's some awkwardness here, and I'm trying to resist over-building this tool. In general, adding a new column to an app DB table does not mean it needs to show up in the reporting dataset. They're only 90% the same, so there is still some manual fixup.\nI think a good compromise would be to remove this input directory upon scripting the sql calls, but not before. That's not something that needs to happen just yet IMO, as it doesn't affect my stakeholders.", "url": "https://github.com/all-of-us/workbench/pull/3986#discussion_r487231792", "createdAt": "2020-09-11T18:58:53Z", "author": {"login": "jaycarlton"}, "path": "api/reporting/schemas/input/mysql_describe_csv/user.csv", "diffHunk": "@@ -0,0 +1,47 @@\n+user_id,bigint(20),NO,PRI,,auto_increment", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY0NzIzNw=="}, "originalCommit": {"oid": "bf7327da516c8bed19c634bd5e9846866ff82c2d"}, "originalPosition": 1}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4050, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}