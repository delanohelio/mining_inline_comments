{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NzU2NjUx", "number": 3308, "title": "[risk=no]Fix NPE in userHasFreeTierCredits", "bodyText": "Add comments and tests, rename methods\nDescription:\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-03-27T13:33:30Z", "url": "https://github.com/all-of-us/workbench/pull/3308", "merged": true, "mergeCommit": {"oid": "b5c24b79138898b640d7ba3ba98100fa86ff2a3f"}, "closed": true, "closedAt": "2020-03-27T15:24:42Z", "author": {"login": "jmthibault79"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRwv2PAH2gAyMzk0NzU2NjUxOjljMjlmOGU1YmU2NWM5NGFlOTcyMmQxZWE4NWY3MDM2NTkwMGNhYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRx4ndgFqTM4MjkyNzY4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9c29f8e5be65c94ae9722d1ea85f70365900caa7", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/9c29f8e5be65c94ae9722d1ea85f70365900caa7", "committedDate": "2020-03-27T13:30:30Z", "message": "clarify getCachedFreeTierUsage/userHasRemainingFreeTierCredits conditions and add tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODYyMTY5", "url": "https://github.com/all-of-us/workbench/pull/3308#pullrequestreview-382862169", "createdAt": "2020-03-27T13:36:32Z", "commit": {"oid": "9c29f8e5be65c94ae9722d1ea85f70365900caa7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzozNjozMlrOF8xbqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzozNjozMlrOF8xbqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2ODc3Nw==", "bodyText": "Renamed to userHasRemainingFreeTierCredits and moved below", "url": "https://github.com/all-of-us/workbench/pull/3308#discussion_r399268777", "createdAt": "2020-03-27T13:36:32Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -61,10 +62,6 @@ public FreeTierBillingService(\n     this.workbenchConfigProvider = workbenchConfigProvider;\n   }\n \n-  public boolean userHasFreeTierCredits(DbUser user) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c29f8e5be65c94ae9722d1ea85f70365900caa7"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODYzMTI3", "url": "https://github.com/all-of-us/workbench/pull/3308#pullrequestreview-382863127", "createdAt": "2020-03-27T13:37:42Z", "commit": {"oid": "9c29f8e5be65c94ae9722d1ea85f70365900caa7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzozNzo0MlrOF8xemw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzozNzo0MlrOF8xemw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2OTUzMQ==", "bodyText": "No functional change here", "url": "https://github.com/all-of-us/workbench/pull/3308#discussion_r399269531", "createdAt": "2020-03-27T13:37:42Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -245,11 +258,7 @@ public Double getUserCachedFreeTierUsage(DbUser user) {\n    * @return the US dollar amount, represented as a double\n    */\n   public double getUserFreeTierDollarLimit(DbUser user) {\n-    final Double override = user.getFreeTierCreditsLimitDollarsOverride();\n-    if (override != null) {\n-      return override;\n-    }\n-\n-    return workbenchConfigProvider.get().billing.defaultFreeCreditsDollarLimit;\n+    return Optional.ofNullable(user.getFreeTierCreditsLimitDollarsOverride())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c29f8e5be65c94ae9722d1ea85f70365900caa7"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODYzNTE1", "url": "https://github.com/all-of-us/workbench/pull/3308#pullrequestreview-382863515", "createdAt": "2020-03-27T13:38:08Z", "commit": {"oid": "9c29f8e5be65c94ae9722d1ea85f70365900caa7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzozODowOFrOF8xf1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzozODowOFrOF8xf1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2OTg0Ng==", "bodyText": "renamed: \"user\" is redundant", "url": "https://github.com/all-of-us/workbench/pull/3308#discussion_r399269846", "createdAt": "2020-03-27T13:38:08Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -230,13 +227,29 @@ private void maybeAlertOnCostThresholds(\n    * have created. This is NOT live BigQuery data: it is only as recent as the last\n    * checkFreeTierBillingUsage cron job, recorded as last_update_time in the DB.\n    *\n+   * <p>Note: return value may be null, to enable direct assignment to the nullable Profile field\n+   *\n    * @param user the user as represented in our database\n    * @return the total USD amount spent in workspaces created by this user, represented as a double\n    */\n-  public Double getUserCachedFreeTierUsage(DbUser user) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c29f8e5be65c94ae9722d1ea85f70365900caa7"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyOTI0MTU4", "url": "https://github.com/all-of-us/workbench/pull/3308#pullrequestreview-382924158", "createdAt": "2020-03-27T14:46:18Z", "commit": {"oid": "9c29f8e5be65c94ae9722d1ea85f70365900caa7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNDo0NjoxOFrOF80aHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNDo0NjoxOFrOF80aHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxNzUzNQ==", "bodyText": "nit: can it be like user: the user as represented in our database to make it more readable", "url": "https://github.com/all-of-us/workbench/pull/3308#discussion_r399317535", "createdAt": "2020-03-27T14:46:18Z", "author": {"login": "NehaBroad"}, "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -230,13 +227,29 @@ private void maybeAlertOnCostThresholds(\n    * have created. This is NOT live BigQuery data: it is only as recent as the last\n    * checkFreeTierBillingUsage cron job, recorded as last_update_time in the DB.\n    *\n+   * <p>Note: return value may be null, to enable direct assignment to the nullable Profile field\n+   *\n    * @param user the user as represented in our database\n    * @return the total USD amount spent in workspaces created by this user, represented as a double\n    */\n-  public Double getUserCachedFreeTierUsage(DbUser user) {\n+  @Nullable\n+  public Double getCachedFreeTierUsage(DbUser user) {\n     return workspaceFreeTierUsageDao.totalCostByUser(user);\n   }\n \n+  /**\n+   * Does this user have remaining free tier credits? Compare the user-specific free tier limit (may\n+   * be the system default) to the amount they have used.\n+   *\n+   * @param user the user as represented in our database", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c29f8e5be65c94ae9722d1ea85f70365900caa7"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyOTI2MTkw", "url": "https://github.com/all-of-us/workbench/pull/3308#pullrequestreview-382926190", "createdAt": "2020-03-27T14:48:26Z", "commit": {"oid": "9c29f8e5be65c94ae9722d1ea85f70365900caa7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNDo0ODoyNlrOF80gWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxNDo0ODoyNlrOF80gWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMxOTEzMQ==", "bodyText": "Why to remove ?", "url": "https://github.com/all-of-us/workbench/pull/3308#discussion_r399319131", "createdAt": "2020-03-27T14:48:26Z", "author": {"login": "NehaBroad"}, "path": "api/src/test/java/org/pmiops/workbench/workspaces/WorkspacesControllerTest.java", "diffHunk": "@@ -236,7 +236,7 @@\n           .domainId(\"Measurement\")\n           .countValue(256L)\n           .prevalence(0.4F)\n-          .conceptSynonyms(new ArrayList<String>());\n+          .conceptSynonyms(new ArrayList<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c29f8e5be65c94ae9722d1ea85f70365900caa7"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyOTI3Njg1", "url": "https://github.com/all-of-us/workbench/pull/3308#pullrequestreview-382927685", "createdAt": "2020-03-27T14:49:59Z", "commit": {"oid": "9c29f8e5be65c94ae9722d1ea85f70365900caa7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3303, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}