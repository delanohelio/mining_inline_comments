{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNTkwMDgz", "number": 2994, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNjozMzo1N1rODXlKcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo1MzowNlrODX-DeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MDUyNzIxOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/actionaudit/auditors/ClusterAuditorImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNjozMzo1N1rOFc85gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNjozMzo1N1rOFc85gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwMjIxMQ==", "bodyText": "Nitpick: I'm not sure the \"admin\" prefix is too helpful here. We have a pretty strong pattern of calling this member variable \"userProvider\". I see that locally within this package AuthDomainAuditorImpl also calls it \"adminDbUserProvider\" (which is probably where this naming came from), but I'd argue both usages are inconsistent with a pretty global pattern across our codebase. It crease more confusion than it resolves IMO, since the \"user\" is still the \"user from the current request context\" in all cases.", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r365902211", "createdAt": "2020-01-13T16:33:57Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/actionaudit/auditors/ClusterAuditorImpl.java", "diffHunk": "@@ -0,0 +1,47 @@\n+package org.pmiops.workbench.actionaudit.auditors;\n+\n+import org.pmiops.workbench.actionaudit.ActionAuditEvent;\n+import org.pmiops.workbench.actionaudit.ActionAuditService;\n+import org.pmiops.workbench.actionaudit.ActionType;\n+import org.pmiops.workbench.actionaudit.AgentType;\n+import org.pmiops.workbench.actionaudit.TargetType;\n+import org.pmiops.workbench.actionaudit.targetproperties.AccountTargetProperty;\n+import org.pmiops.workbench.actionaudit.targetproperties.values.AccountDisabledStatus;\n+import org.pmiops.workbench.db.model.DbUser;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Service;\n+\n+import javax.inject.Provider;\n+import java.time.Clock;\n+\n+@Service\n+public class ClusterAuditorImpl implements ClusterAuditor {\n+  private ActionAuditService actionAuditService;\n+  private Clock clock;\n+  private Provider<DbUser> adminDbUserProvider;\n+\n+  @Autowired\n+  public ClusterAuditorImpl(\n+      ActionAuditService actionAuditService,\n+      Clock clock,\n+      Provider<DbUser> adminDbUserProvider) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3ff3a3061220ffafb5a23fb4d39a8bd5ef298ea"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MDUzNjQ1OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ClusterController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNjozNjoyN1rOFc8--w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNjozNjoyN1rOFc8--w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwMzYxMQ==", "bodyText": "I'd be inclined to move this towards the bottom of this method, so the audit log is only sent after the Firecloud interactions are completed. Just checking how Jay set this up for other controllers, there seems to be a pretty clear pattern of \"do the work first, then fire an audit log\".", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r365903611", "createdAt": "2020-01-13T16:36:27Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/api/ClusterController.java", "diffHunk": "@@ -116,7 +123,51 @@\n   }\n \n   @Override\n-  public ResponseEntity<ClusterListResponse> listClusters(\n+  @AuthorityRequired(Authority.SECURITY_ADMIN)\n+  public ResponseEntity<List<ListClusterResponse>> deleteClustersInProject(String billingProjectId) {\n+    if (billingProjectId == null) {\n+      throw new BadRequestException(\"Must specify billing project\");\n+    }\n+    clusterAuditor.fireDeleteClustersInProject(billingProjectId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3ff3a3061220ffafb5a23fb4d39a8bd5ef298ea"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MDU0NTMwOnYy", "diffSide": "RIGHT", "path": "api/src/main/resources/workbench.yaml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNjozOTowMlrOFc9Ejw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNjozOTowMlrOFc9Ejw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwNTAzOQ==", "bodyText": "Nitpick: update summary s/pause/delete/", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r365905039", "createdAt": "2020-01-13T16:39:02Z", "author": {"login": "gjuggler"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -538,6 +538,32 @@ paths:\n \n   # Notebook clusters ####################################################################\n \n+  /v1/admin/security/clusters/{billingProjectId}/delete-clusters:\n+    post:\n+      summary: Pause all clusters in a project", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3ff3a3061220ffafb5a23fb4d39a8bd5ef298ea"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MDU0OTczOnYy", "diffSide": "RIGHT", "path": "api/src/main/resources/workbench.yaml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNjo0MDoyNVrOFc9HYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNzo1MDozN1rOFc_QXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwNTc2MA==", "bodyText": "Is there a need to return data about the clusters that were just paused? I'd be inclined to call YAGNI (you ain't gonna need this) on this piece. We can easily add more return info if required, but I don't seen an obvious use case for the client to use this data.", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r365905760", "createdAt": "2020-01-13T16:40:25Z", "author": {"login": "gjuggler"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -3634,14 +3661,44 @@ definitions:\n         format: int64\n         description: Milliseconds since the UNIX epoch.\n \n-  ClusterListResponse:\n+  DefaultClusterResponse:\n     type: object\n     required:\n       - defaultCluster\n     properties:\n       defaultCluster:\n         $ref: \"#/definitions/Cluster\"\n \n+  ListClusterResponse:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3ff3a3061220ffafb5a23fb4d39a8bd5ef298ea"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk0MDgzMQ==", "bodyText": "I am fairly confident that this is useful data, because if one cluster didn't delete for some reason, we can display information about that on the client side by filtering on cluster status on the returned values. In general, I think of deleting clusters as an 'update to be deleted asynchronously', and believe that update requests should return the new values", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r365940831", "createdAt": "2020-01-13T17:50:37Z", "author": {"login": "s-rubenstein"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -3634,14 +3661,44 @@ definitions:\n         format: int64\n         description: Milliseconds since the UNIX epoch.\n \n-  ClusterListResponse:\n+  DefaultClusterResponse:\n     type: object\n     required:\n       - defaultCluster\n     properties:\n       defaultCluster:\n         $ref: \"#/definitions/Cluster\"\n \n+  ListClusterResponse:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwNTc2MA=="}, "originalCommit": {"oid": "c3ff3a3061220ffafb5a23fb4d39a8bd5ef298ea"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MDU2MzA5OnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNjo0NDoyM1rOFc9Pqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxODo1MToyM1rOFdiHmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwNzg4Mg==", "bodyText": "The testing pattern here is a bit awkward. What I might have expected to see in a controller-level test would be to make sure all inbound parameters are correctly mapped to the service-level call, e.g.\n\nSet up any required mocks, e.g. when(notebookService).listClustersByProjectAsAdmin(...)\nCall the controller method.\nVerify that notebookService.deleteClusterAsAdmin was called with BILLING_PROJECT_ID\nVerify that clusterAuditor.fireDeleteClustersInProject is called with BILLING_PROJECT_ID", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r365907882", "createdAt": "2020-01-13T16:44:23Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -234,6 +249,27 @@ public void testListClusters() throws Exception {\n         .isEqualTo(testCluster);\n   }\n \n+  @Test\n+  public void testDeleteClustersInProject() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3ff3a3061220ffafb5a23fb4d39a8bd5ef298ea"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjM4OTgyMw==", "bodyText": "Its kinda tricky because all the notebookService stuff is calling to Leo. I will update though.", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366389823", "createdAt": "2020-01-14T15:04:51Z", "author": {"login": "s-rubenstein"}, "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -234,6 +249,27 @@ public void testListClusters() throws Exception {\n         .isEqualTo(testCluster);\n   }\n \n+  @Test\n+  public void testDeleteClustersInProject() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwNzg4Mg=="}, "originalCommit": {"oid": "c3ff3a3061220ffafb5a23fb4d39a8bd5ef298ea"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ0OTQ1Nw==", "bodyText": "I would also like to see these test cases:\n\nclusterNamesToDelete.getClustersToDelete() is null\nclusterNamesToDelete.getClustersToDelete() is an empty list\ndelete some but not all clusters\nrequest to delete cluster(s) which exist but are in a different project\nreturned cluster status is DELETED (I think there's a bug here)\nreturned cluster status is in a non-acceptable state", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366449457", "createdAt": "2020-01-14T16:43:45Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -234,6 +249,27 @@ public void testListClusters() throws Exception {\n         .isEqualTo(testCluster);\n   }\n \n+  @Test\n+  public void testDeleteClustersInProject() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwNzg4Mg=="}, "originalCommit": {"oid": "c3ff3a3061220ffafb5a23fb4d39a8bd5ef298ea"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUxMjAyNg==", "bodyText": "Talked offline, we are not adding the last two of these test cases because:\n\nWith DELETED, we don't want to receive those clusters, because we reuse names, and thus there could be many clusters with the same name in deleted.\nWe could do the non-acceptable state, but it is just testing logging, and is going to be incredibly messy to maintain that test. (And is sorta testing 'what happens if Leo fails to follow contract')", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366512026", "createdAt": "2020-01-14T18:51:23Z", "author": {"login": "s-rubenstein"}, "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -234,6 +249,27 @@ public void testListClusters() throws Exception {\n         .isEqualTo(testCluster);\n   }\n \n+  @Test\n+  public void testDeleteClustersInProject() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkwNzg4Mg=="}, "originalCommit": {"oid": "c3ff3a3061220ffafb5a23fb4d39a8bd5ef298ea"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MDYxMzY0OnYy", "diffSide": "RIGHT", "path": "api/src/main/resources/workbench.yaml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNjo1ODozOVrOFc9ugQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNzo1NTo0N1rOFc_agw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkxNTc3Nw==", "bodyText": "[Important] Per discussion on Slack, we'll want to flex the requirements to this ticket a bit and add support for deleting a specific named cluster from within the project. The easiest way to handle this would probably be to add an optional body parameter to this API method, \"cluster_names\", which allows one or more cluster names to be provided.\nThe idea is that if / when we implement auto-cluster-delete in response to high-egress events, we'll likely have the specific name of the offending cluster. To reduce the blast radius of the alert response, we'll favor deleting just the known cluster name rather than blasting all clusters from the project.\nDo you think it'll be possible to fit that into this PR without too much re-working? It could also be a follow-up \u2013\u00a0your judgement call to make.", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r365915777", "createdAt": "2020-01-13T16:58:39Z", "author": {"login": "gjuggler"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -538,6 +538,32 @@ paths:\n \n   # Notebook clusters ####################################################################\n \n+  /v1/admin/security/clusters/{billingProjectId}/delete-clusters:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3ff3a3061220ffafb5a23fb4d39a8bd5ef298ea"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk0MzQyNw==", "bodyText": "Probably, let me add that.", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r365943427", "createdAt": "2020-01-13T17:55:47Z", "author": {"login": "s-rubenstein"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -538,6 +538,32 @@ paths:\n \n   # Notebook clusters ####################################################################\n \n+  /v1/admin/security/clusters/{billingProjectId}/delete-clusters:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkxNTc3Nw=="}, "originalCommit": {"oid": "c3ff3a3061220ffafb5a23fb4d39a8bd5ef298ea"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2Mzc2OTYxOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ClusterController.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNTozNToxOFrOFdbwPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNTozNjo0M1rOFdbzcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQwNzc0Mg==", "bodyText": "wrong import", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366407742", "createdAt": "2020-01-14T15:35:18Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/api/ClusterController.java", "diffHunk": "@@ -1,12 +1,14 @@\n package org.pmiops.workbench.api;\n \n+import com.google.appengine.repackaged.com.google.common.collect.ImmutableList;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fee3de204e004115159014af8a3f873fc66a9242"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQwODU2MA==", "bodyText": "Might want to blacklist com.google.appengine.repackaged a la https://blog.jetbrains.com/idea/2009/03/excluding-classes-from-auto-import/", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366408560", "createdAt": "2020-01-14T15:36:43Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/api/ClusterController.java", "diffHunk": "@@ -1,12 +1,14 @@\n package org.pmiops.workbench.api;\n \n+import com.google.appengine.repackaged.com.google.common.collect.ImmutableList;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQwNzc0Mg=="}, "originalCommit": {"oid": "fee3de204e004115159014af8a3f873fc66a9242"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2Mzg1NDg2OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ClusterController.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNTo1NjozNVrOFdcklA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozNjo0NVrOFdjcDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyMTE0MA==", "bodyText": "This call will skip deleted clusters - see LeonardoNotebooksClientImpl line 155", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366421140", "createdAt": "2020-01-14T15:56:35Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/api/ClusterController.java", "diffHunk": "@@ -116,7 +124,65 @@\n   }\n \n   @Override\n-  public ResponseEntity<ClusterListResponse> listClusters(\n+  @AuthorityRequired(Authority.SECURITY_ADMIN)\n+  public ResponseEntity<List<ListClusterResponse>> deleteClustersInProject(\n+      String billingProjectId, ListClusterDeleteRequest clusterNamesToDelete) {\n+    if (billingProjectId == null) {\n+      throw new BadRequestException(\"Must specify billing project\");\n+    }\n+    List<org.pmiops.workbench.notebooks.model.ListClusterResponse> clustersToDelete =\n+        leonardoNotebooksClient.listClustersByProjectAsAdmin(billingProjectId).stream()\n+            .filter(\n+                cluster ->\n+                    clusterNamesToDelete.getClustersToDelete() == null\n+                        || clusterNamesToDelete\n+                            .getClustersToDelete()\n+                            .contains(cluster.getClusterName()))\n+            .collect(Collectors.toList());\n+\n+    clustersToDelete.forEach(\n+        cluster ->\n+            leonardoNotebooksClient.deleteClusterAsAdmin(\n+                cluster.getGoogleProject(), cluster.getClusterName()));\n+    List<ListClusterResponse> clustersInProjectAffected =\n+        leonardoNotebooksClient.listClustersByProjectAsAdmin(billingProjectId).stream()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fee3de204e004115159014af8a3f873fc66a9242"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ5NDkwOQ==", "bodyText": "Hmmm... I don't think we want to list all deleted clusters though, because we reuse names. We may be okay with this, because clusters probably don't delete that quickly? It will affect return value if they do delete quickly, but won't affect auditing.", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366494909", "createdAt": "2020-01-14T18:15:16Z", "author": {"login": "s-rubenstein"}, "path": "api/src/main/java/org/pmiops/workbench/api/ClusterController.java", "diffHunk": "@@ -116,7 +124,65 @@\n   }\n \n   @Override\n-  public ResponseEntity<ClusterListResponse> listClusters(\n+  @AuthorityRequired(Authority.SECURITY_ADMIN)\n+  public ResponseEntity<List<ListClusterResponse>> deleteClustersInProject(\n+      String billingProjectId, ListClusterDeleteRequest clusterNamesToDelete) {\n+    if (billingProjectId == null) {\n+      throw new BadRequestException(\"Must specify billing project\");\n+    }\n+    List<org.pmiops.workbench.notebooks.model.ListClusterResponse> clustersToDelete =\n+        leonardoNotebooksClient.listClustersByProjectAsAdmin(billingProjectId).stream()\n+            .filter(\n+                cluster ->\n+                    clusterNamesToDelete.getClustersToDelete() == null\n+                        || clusterNamesToDelete\n+                            .getClustersToDelete()\n+                            .contains(cluster.getClusterName()))\n+            .collect(Collectors.toList());\n+\n+    clustersToDelete.forEach(\n+        cluster ->\n+            leonardoNotebooksClient.deleteClusterAsAdmin(\n+                cluster.getGoogleProject(), cluster.getClusterName()));\n+    List<ListClusterResponse> clustersInProjectAffected =\n+        leonardoNotebooksClient.listClustersByProjectAsAdmin(billingProjectId).stream()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyMTE0MA=="}, "originalCommit": {"oid": "fee3de204e004115159014af8a3f873fc66a9242"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMzY0NA==", "bodyText": "agreed offline - we do not want to list deleted", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366533644", "createdAt": "2020-01-14T19:36:45Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/api/ClusterController.java", "diffHunk": "@@ -116,7 +124,65 @@\n   }\n \n   @Override\n-  public ResponseEntity<ClusterListResponse> listClusters(\n+  @AuthorityRequired(Authority.SECURITY_ADMIN)\n+  public ResponseEntity<List<ListClusterResponse>> deleteClustersInProject(\n+      String billingProjectId, ListClusterDeleteRequest clusterNamesToDelete) {\n+    if (billingProjectId == null) {\n+      throw new BadRequestException(\"Must specify billing project\");\n+    }\n+    List<org.pmiops.workbench.notebooks.model.ListClusterResponse> clustersToDelete =\n+        leonardoNotebooksClient.listClustersByProjectAsAdmin(billingProjectId).stream()\n+            .filter(\n+                cluster ->\n+                    clusterNamesToDelete.getClustersToDelete() == null\n+                        || clusterNamesToDelete\n+                            .getClustersToDelete()\n+                            .contains(cluster.getClusterName()))\n+            .collect(Collectors.toList());\n+\n+    clustersToDelete.forEach(\n+        cluster ->\n+            leonardoNotebooksClient.deleteClusterAsAdmin(\n+                cluster.getGoogleProject(), cluster.getClusterName()));\n+    List<ListClusterResponse> clustersInProjectAffected =\n+        leonardoNotebooksClient.listClustersByProjectAsAdmin(billingProjectId).stream()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyMTE0MA=="}, "originalCommit": {"oid": "fee3de204e004115159014af8a3f873fc66a9242"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2Mzg4NTk0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ClusterController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjowNDozNlrOFdc3oQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjowNDozNlrOFdc3oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyNjAxNw==", "bodyText": "This filter block is repeated below, so we can extract it as a small function", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366426017", "createdAt": "2020-01-14T16:04:36Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/api/ClusterController.java", "diffHunk": "@@ -116,7 +124,65 @@\n   }\n \n   @Override\n-  public ResponseEntity<ClusterListResponse> listClusters(\n+  @AuthorityRequired(Authority.SECURITY_ADMIN)\n+  public ResponseEntity<List<ListClusterResponse>> deleteClustersInProject(\n+      String billingProjectId, ListClusterDeleteRequest clusterNamesToDelete) {\n+    if (billingProjectId == null) {\n+      throw new BadRequestException(\"Must specify billing project\");\n+    }\n+    List<org.pmiops.workbench.notebooks.model.ListClusterResponse> clustersToDelete =\n+        leonardoNotebooksClient.listClustersByProjectAsAdmin(billingProjectId).stream()\n+            .filter(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fee3de204e004115159014af8a3f873fc66a9242"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MzkxNTY0OnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoxMjo0MlrOFddKCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoxMjo0MlrOFddKCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQzMDczMA==", "bodyText": "does not throw Exception - this can actually be removed from every method in this class", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366430730", "createdAt": "2020-01-14T16:12:42Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -234,6 +249,26 @@ public void testListClusters() throws Exception {\n         .isEqualTo(testCluster);\n   }\n \n+  @Test\n+  public void testDeleteClustersInProject() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fee3de204e004115159014af8a3f873fc66a9242"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2MzkzNTkzOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/actionaudit/auditors/ClusterAuditorTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoxNzo1OVrOFddWoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoxNzo1OVrOFddWoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQzMzk1Mg==", "bodyText": "changing this to CLUSTER_NAMES.length() would make it explicit", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366433952", "createdAt": "2020-01-14T16:17:59Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/actionaudit/auditors/ClusterAuditorTest.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package org.pmiops.workbench.actionaudit.auditors;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+import static org.mockito.Mockito.verify;\n+\n+import com.google.common.collect.ImmutableList;\n+import java.time.Clock;\n+import java.time.Instant;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+import javax.inject.Provider;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.Mock;\n+import org.pmiops.workbench.actionaudit.ActionAuditEvent;\n+import org.pmiops.workbench.actionaudit.ActionAuditService;\n+import org.pmiops.workbench.actionaudit.ActionType;\n+import org.pmiops.workbench.db.model.DbUser;\n+import org.springframework.boot.test.context.TestConfiguration;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+@RunWith(SpringRunner.class)\n+public class ClusterAuditorTest {\n+  private DbUser user1;\n+  private static final long Y2K_EPOCH_MILLIS =\n+      Instant.parse(\"2000-01-01T00:00:00.00Z\").toEpochMilli();\n+  private static final String ACTION_ID = \"58cbae08-447f-499f-95b9-7bdedc955f4d\";\n+  private static final String BILLING_PROJECT_ID = \"all-of-us-yjty\";\n+  private static final List<String> CLUSTER_NAMES =\n+      ImmutableList.of(\"all-of-us-1\", \"all-of-us-2\", \"all-of-us-3\");\n+\n+  private ClusterAuditor clusterAuditor;\n+\n+  @Captor private ArgumentCaptor<Collection<ActionAuditEvent>> eventCollectionCaptor;\n+\n+  @Mock private Provider<String> mockActionIdProvider;\n+  @Mock private ActionAuditService mockActionAuditService;\n+  @Mock private Clock mockClock;\n+  @Mock private Provider<DbUser> mockUserProvider;\n+\n+  @TestConfiguration\n+  @MockBean(value = {ActionAuditService.class})\n+  static class Configuration {}\n+\n+  @Before\n+  public void setUp() {\n+    user1 = new DbUser();\n+    user1.setUserId(101L);\n+    user1.setUsername(\"fflinstone@slate.com\");\n+    user1.setGivenName(\"Fred\");\n+    user1.setFamilyName(\"Flintstone\");\n+    doReturn(user1).when(mockUserProvider).get();\n+    clusterAuditor =\n+        new ClusterAuditorImpl(\n+            mockActionIdProvider, mockActionAuditService, mockClock, mockUserProvider);\n+\n+    doReturn(Y2K_EPOCH_MILLIS).when(mockClock).millis();\n+    doReturn(ACTION_ID).when(mockActionIdProvider).get();\n+  }\n+\n+  @Test\n+  public void testFireDeleteClustersInProject() {\n+    clusterAuditor.fireDeleteClustersInProject(BILLING_PROJECT_ID, CLUSTER_NAMES);\n+    verify(mockActionAuditService).send(eventCollectionCaptor.capture());\n+    Collection<ActionAuditEvent> eventsSent = eventCollectionCaptor.getValue();\n+    assertThat(eventsSent).hasSize(3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fee3de204e004115159014af8a3f873fc66a9242"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2Mzk3MzI3OnYy", "diffSide": "RIGHT", "path": "api/src/main/resources/workbench.yaml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoyNzo0MFrOFddt0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoyNzo0MFrOFddt0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQzOTg4OQ==", "bodyText": "good rename", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366439889", "createdAt": "2020-01-14T16:27:40Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -565,7 +597,7 @@ paths:\n         200:\n           description: Available clusters\n           schema:\n-            $ref: '#/definitions/ClusterListResponse'\n+            $ref: '#/definitions/DefaultClusterResponse'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fee3de204e004115159014af8a3f873fc66a9242"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2Mzk3ODM4OnYy", "diffSide": "RIGHT", "path": "api/src/main/resources/workbench.yaml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoyODo1NlrOFddw5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoyODo1NlrOFddw5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ0MDY3Ng==", "bodyText": "Can we change this to \"the user's cluster\" or similar?", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366440676", "createdAt": "2020-01-14T16:28:56Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -565,7 +597,7 @@ paths:\n         200:\n           description: Available clusters", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fee3de204e004115159014af8a3f873fc66a9242"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NDU0Mzc0OnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozMTo0N1rOFdjS5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo0NTowOVrOFdjrdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTMwMg==", "bodyText": "nit, optional: there's a verifyZeroCalls() (or similar) that can be used instead", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366531302", "createdAt": "2020-01-14T19:31:47Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -242,7 +294,96 @@ public void testListClusters() throws Exception {\n   }\n \n   @Test\n-  public void testListClustersUnknownStatus() throws Exception {\n+  public void testDeleteClustersInProject() {\n+    List<ListClusterResponse> listClusterResponseList = ImmutableList.of(testFcClusterListResponse);\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID,\n+        new ListClusterDeleteRequest()\n+            .clustersToDelete(ImmutableList.of(testFcCluster.getClusterName())));\n+    verify(notebookService)\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor)\n+        .fireDeleteClustersInProject(\n+            BILLING_PROJECT_ID,\n+            listClusterResponseList.stream()\n+                .map(ListClusterResponse::getClusterName)\n+                .collect(Collectors.toList()));\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectDeleteSome() {\n+    List<ListClusterResponse> listClusterResponseList =\n+        ImmutableList.of(testFcClusterListResponse, testFcClusterListResponse2);\n+    List<String> clustersToDelete = ImmutableList.of(testFcCluster.getClusterName());\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID, new ListClusterDeleteRequest().clustersToDelete(clustersToDelete));\n+    verify(notebookService, times(clustersToDelete.size()))\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor, times(1))\n+        .fireDeleteClustersInProject(BILLING_PROJECT_ID, clustersToDelete);\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectDeleteDoesNotAffectOtherProjects() {\n+    List<ListClusterResponse> listClusterResponseList =\n+        ImmutableList.of(testFcClusterListResponse, testFcClusterListResponse2);\n+    List<String> clustersToDelete =\n+        ImmutableList.of(testFcClusterDifferentProject.getClusterName());\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID, new ListClusterDeleteRequest().clustersToDelete(clustersToDelete));\n+    verify(notebookService, times(0))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fb920190539866721ec8352953d95d153ecfa6e"}, "originalPosition": 210}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzNzU5MQ==", "bodyText": "verifyZeroInteractions() is a mock level method, rather than a method level method (from what I could tell. Sticking with this.", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366537591", "createdAt": "2020-01-14T19:45:09Z", "author": {"login": "s-rubenstein"}, "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -242,7 +294,96 @@ public void testListClusters() throws Exception {\n   }\n \n   @Test\n-  public void testListClustersUnknownStatus() throws Exception {\n+  public void testDeleteClustersInProject() {\n+    List<ListClusterResponse> listClusterResponseList = ImmutableList.of(testFcClusterListResponse);\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID,\n+        new ListClusterDeleteRequest()\n+            .clustersToDelete(ImmutableList.of(testFcCluster.getClusterName())));\n+    verify(notebookService)\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor)\n+        .fireDeleteClustersInProject(\n+            BILLING_PROJECT_ID,\n+            listClusterResponseList.stream()\n+                .map(ListClusterResponse::getClusterName)\n+                .collect(Collectors.toList()));\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectDeleteSome() {\n+    List<ListClusterResponse> listClusterResponseList =\n+        ImmutableList.of(testFcClusterListResponse, testFcClusterListResponse2);\n+    List<String> clustersToDelete = ImmutableList.of(testFcCluster.getClusterName());\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID, new ListClusterDeleteRequest().clustersToDelete(clustersToDelete));\n+    verify(notebookService, times(clustersToDelete.size()))\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor, times(1))\n+        .fireDeleteClustersInProject(BILLING_PROJECT_ID, clustersToDelete);\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectDeleteDoesNotAffectOtherProjects() {\n+    List<ListClusterResponse> listClusterResponseList =\n+        ImmutableList.of(testFcClusterListResponse, testFcClusterListResponse2);\n+    List<String> clustersToDelete =\n+        ImmutableList.of(testFcClusterDifferentProject.getClusterName());\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID, new ListClusterDeleteRequest().clustersToDelete(clustersToDelete));\n+    verify(notebookService, times(0))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMTMwMg=="}, "originalCommit": {"oid": "8fb920190539866721ec8352953d95d153ecfa6e"}, "originalPosition": 210}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NDU1NDc5OnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTozNTozNFrOFdjZ1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo1MTowOVrOFdj1sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMzA3OQ==", "bodyText": "This is something I was curious about: do we want a missing param (null) to have different semantics from an empty-list param?  We should be explicit about this in the swagger, if so.", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366533079", "createdAt": "2020-01-14T19:35:34Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -242,7 +294,96 @@ public void testListClusters() throws Exception {\n   }\n \n   @Test\n-  public void testListClustersUnknownStatus() throws Exception {\n+  public void testDeleteClustersInProject() {\n+    List<ListClusterResponse> listClusterResponseList = ImmutableList.of(testFcClusterListResponse);\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID,\n+        new ListClusterDeleteRequest()\n+            .clustersToDelete(ImmutableList.of(testFcCluster.getClusterName())));\n+    verify(notebookService)\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor)\n+        .fireDeleteClustersInProject(\n+            BILLING_PROJECT_ID,\n+            listClusterResponseList.stream()\n+                .map(ListClusterResponse::getClusterName)\n+                .collect(Collectors.toList()));\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectDeleteSome() {\n+    List<ListClusterResponse> listClusterResponseList =\n+        ImmutableList.of(testFcClusterListResponse, testFcClusterListResponse2);\n+    List<String> clustersToDelete = ImmutableList.of(testFcCluster.getClusterName());\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID, new ListClusterDeleteRequest().clustersToDelete(clustersToDelete));\n+    verify(notebookService, times(clustersToDelete.size()))\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor, times(1))\n+        .fireDeleteClustersInProject(BILLING_PROJECT_ID, clustersToDelete);\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectDeleteDoesNotAffectOtherProjects() {\n+    List<ListClusterResponse> listClusterResponseList =\n+        ImmutableList.of(testFcClusterListResponse, testFcClusterListResponse2);\n+    List<String> clustersToDelete =\n+        ImmutableList.of(testFcClusterDifferentProject.getClusterName());\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID, new ListClusterDeleteRequest().clustersToDelete(clustersToDelete));\n+    verify(notebookService, times(0))\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor, times(0))\n+        .fireDeleteClustersInProject(BILLING_PROJECT_ID, clustersToDelete);\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectNoClusters() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fb920190539866721ec8352953d95d153ecfa6e"}, "originalPosition": 217}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzNjY4MQ==", "bodyText": "I think we do, because I think not providing a list should give all, but an empty list should behave the same way as any list. I can be more explicit in swagger.", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366536681", "createdAt": "2020-01-14T19:43:13Z", "author": {"login": "s-rubenstein"}, "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -242,7 +294,96 @@ public void testListClusters() throws Exception {\n   }\n \n   @Test\n-  public void testListClustersUnknownStatus() throws Exception {\n+  public void testDeleteClustersInProject() {\n+    List<ListClusterResponse> listClusterResponseList = ImmutableList.of(testFcClusterListResponse);\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID,\n+        new ListClusterDeleteRequest()\n+            .clustersToDelete(ImmutableList.of(testFcCluster.getClusterName())));\n+    verify(notebookService)\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor)\n+        .fireDeleteClustersInProject(\n+            BILLING_PROJECT_ID,\n+            listClusterResponseList.stream()\n+                .map(ListClusterResponse::getClusterName)\n+                .collect(Collectors.toList()));\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectDeleteSome() {\n+    List<ListClusterResponse> listClusterResponseList =\n+        ImmutableList.of(testFcClusterListResponse, testFcClusterListResponse2);\n+    List<String> clustersToDelete = ImmutableList.of(testFcCluster.getClusterName());\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID, new ListClusterDeleteRequest().clustersToDelete(clustersToDelete));\n+    verify(notebookService, times(clustersToDelete.size()))\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor, times(1))\n+        .fireDeleteClustersInProject(BILLING_PROJECT_ID, clustersToDelete);\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectDeleteDoesNotAffectOtherProjects() {\n+    List<ListClusterResponse> listClusterResponseList =\n+        ImmutableList.of(testFcClusterListResponse, testFcClusterListResponse2);\n+    List<String> clustersToDelete =\n+        ImmutableList.of(testFcClusterDifferentProject.getClusterName());\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID, new ListClusterDeleteRequest().clustersToDelete(clustersToDelete));\n+    verify(notebookService, times(0))\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor, times(0))\n+        .fireDeleteClustersInProject(BILLING_PROJECT_ID, clustersToDelete);\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectNoClusters() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMzA3OQ=="}, "originalCommit": {"oid": "8fb920190539866721ec8352953d95d153ecfa6e"}, "originalPosition": 217}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0MDIwOA==", "bodyText": "Basically I think there should be some default that says include all clusters, and the body parameter can't be null. We could also do this with a bool on the object that says 'deleteAll' or something, but that seems like extra that we don't need.", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366540208", "createdAt": "2020-01-14T19:51:09Z", "author": {"login": "s-rubenstein"}, "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -242,7 +294,96 @@ public void testListClusters() throws Exception {\n   }\n \n   @Test\n-  public void testListClustersUnknownStatus() throws Exception {\n+  public void testDeleteClustersInProject() {\n+    List<ListClusterResponse> listClusterResponseList = ImmutableList.of(testFcClusterListResponse);\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID,\n+        new ListClusterDeleteRequest()\n+            .clustersToDelete(ImmutableList.of(testFcCluster.getClusterName())));\n+    verify(notebookService)\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor)\n+        .fireDeleteClustersInProject(\n+            BILLING_PROJECT_ID,\n+            listClusterResponseList.stream()\n+                .map(ListClusterResponse::getClusterName)\n+                .collect(Collectors.toList()));\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectDeleteSome() {\n+    List<ListClusterResponse> listClusterResponseList =\n+        ImmutableList.of(testFcClusterListResponse, testFcClusterListResponse2);\n+    List<String> clustersToDelete = ImmutableList.of(testFcCluster.getClusterName());\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID, new ListClusterDeleteRequest().clustersToDelete(clustersToDelete));\n+    verify(notebookService, times(clustersToDelete.size()))\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor, times(1))\n+        .fireDeleteClustersInProject(BILLING_PROJECT_ID, clustersToDelete);\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectDeleteDoesNotAffectOtherProjects() {\n+    List<ListClusterResponse> listClusterResponseList =\n+        ImmutableList.of(testFcClusterListResponse, testFcClusterListResponse2);\n+    List<String> clustersToDelete =\n+        ImmutableList.of(testFcClusterDifferentProject.getClusterName());\n+    when(notebookService.listClustersByProjectAsAdmin(BILLING_PROJECT_ID))\n+        .thenReturn(listClusterResponseList);\n+\n+    clusterController.deleteClustersInProject(\n+        BILLING_PROJECT_ID, new ListClusterDeleteRequest().clustersToDelete(clustersToDelete));\n+    verify(notebookService, times(0))\n+        .deleteClusterAsAdmin(BILLING_PROJECT_ID, testFcCluster.getClusterName());\n+    verify(clusterAuditor, times(0))\n+        .fireDeleteClustersInProject(BILLING_PROJECT_ID, clustersToDelete);\n+  }\n+\n+  @Test\n+  public void testDeleteClustersInProjectNoClusters() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUzMzA3OQ=="}, "originalCommit": {"oid": "8fb920190539866721ec8352953d95d153ecfa6e"}, "originalPosition": 217}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NDYwNTM3OnYy", "diffSide": "RIGHT", "path": "api/src/main/resources/workbench.yaml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo1MzowNlrOFdj5Dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxOTo1MzowNlrOFdj5Dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjU0MTA3MQ==", "bodyText": "no longer necessarily all clusters", "url": "https://github.com/all-of-us/workbench/pull/2994#discussion_r366541071", "createdAt": "2020-01-14T19:53:06Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -538,6 +538,39 @@ paths:\n \n   # Notebook clusters ####################################################################\n \n+  /v1/admin/security/clusters/{billingProjectId}/delete-clusters:\n+    post:\n+      summary: Delete all clusters in a project", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d0c96c36ad58859871f45bc4560fc5e722dc88e"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3420, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}