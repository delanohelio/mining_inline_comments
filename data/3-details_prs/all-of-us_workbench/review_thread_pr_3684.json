{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2NDk0MjA3", "number": 3684, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNDozNzozM1rOEHI28A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTowOTo0NlrOEIA36w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTIwNjI0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/OfflineWorkspaceController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNDozNzozM1rOGmXHcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMzo0ODoyMlrOGnBaIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3NzgxMQ==", "bodyText": "What does this comment mean? Can you specify in this comment that we want to prompt when a workspace FIRST goes over 15 days old and then EVERY 365 days?", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442877811", "createdAt": "2020-06-19T14:37:33Z", "author": {"login": "als364"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineWorkspaceController.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.api;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import javax.inject.Provider;\n+import org.joda.time.DateTime;\n+import org.joda.time.DateTimeComparator;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.db.dao.WorkspaceDao;\n+import org.pmiops.workbench.db.model.DbWorkspace;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+@RestController\n+public class OfflineWorkspaceController implements OfflineWorkspaceApiDelegate {\n+\n+  private final WorkspaceDao workspaceDao;\n+  private final Provider<WorkbenchConfig> configProvider;\n+\n+  @Autowired\n+  OfflineWorkspaceController(Provider<WorkbenchConfig> configProvider, WorkspaceDao workspaceDao) {\n+    this.configProvider = configProvider;\n+    this.workspaceDao = workspaceDao;\n+  }\n+\n+  @Override\n+  public ResponseEntity<Void> updateResearchPurposeReview() {\n+    if (configProvider.get().featureFlags.enableResearchPurposePrompt) {\n+      List<DbWorkspace> workspaceList = workspaceDao.findAllByReviewResearchPurpose((short) 1);\n+\n+      // 1. Filter out workspace where creation date is 365 days or 15 days", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3MDcyMg==", "bodyText": "I will update this, earlier the requirements was eery year we will have the pop-up however ir was change to : Just first year researcher/OWNER will be getting the pop up.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r443570722", "createdAt": "2020-06-22T13:48:22Z", "author": {"login": "NehaBroad"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineWorkspaceController.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.api;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import javax.inject.Provider;\n+import org.joda.time.DateTime;\n+import org.joda.time.DateTimeComparator;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.db.dao.WorkspaceDao;\n+import org.pmiops.workbench.db.model.DbWorkspace;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+@RestController\n+public class OfflineWorkspaceController implements OfflineWorkspaceApiDelegate {\n+\n+  private final WorkspaceDao workspaceDao;\n+  private final Provider<WorkbenchConfig> configProvider;\n+\n+  @Autowired\n+  OfflineWorkspaceController(Provider<WorkbenchConfig> configProvider, WorkspaceDao workspaceDao) {\n+    this.configProvider = configProvider;\n+    this.workspaceDao = workspaceDao;\n+  }\n+\n+  @Override\n+  public ResponseEntity<Void> updateResearchPurposeReview() {\n+    if (configProvider.get().featureFlags.enableResearchPurposePrompt) {\n+      List<DbWorkspace> workspaceList = workspaceDao.findAllByReviewResearchPurpose((short) 1);\n+\n+      // 1. Filter out workspace where creation date is 365 days or 15 days", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3NzgxMQ=="}, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTI1OTM1OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/OfflineWorkspaceController.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNDo1Mzo0MFrOGmXpgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNToxNTo1MlrOGnFUwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4NjUzMA==", "bodyText": "I'm not sure what this logic is doing. Comparing against null should always fail and we don't want to always show the prompt. I also don't think we should be looking at direct equality. Per the ticket, we really want to check the following:\n\nis the workspace older than 15 days and hasn't yet had a research purpose update? if so, prompt.\nhas the workspace research purpose been updated in the past 365 days? if not, prompt.\nWe don't currently have a concept of 'when was the research purpose last updated' and we need to introduce one.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442886530", "createdAt": "2020-06-19T14:53:40Z", "author": {"login": "als364"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineWorkspaceController.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.api;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import javax.inject.Provider;\n+import org.joda.time.DateTime;\n+import org.joda.time.DateTimeComparator;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.db.dao.WorkspaceDao;\n+import org.pmiops.workbench.db.model.DbWorkspace;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+@RestController\n+public class OfflineWorkspaceController implements OfflineWorkspaceApiDelegate {\n+\n+  private final WorkspaceDao workspaceDao;\n+  private final Provider<WorkbenchConfig> configProvider;\n+\n+  @Autowired\n+  OfflineWorkspaceController(Provider<WorkbenchConfig> configProvider, WorkspaceDao workspaceDao) {\n+    this.configProvider = configProvider;\n+    this.workspaceDao = workspaceDao;\n+  }\n+\n+  @Override\n+  public ResponseEntity<Void> updateResearchPurposeReview() {\n+    if (configProvider.get().featureFlags.enableResearchPurposePrompt) {\n+      List<DbWorkspace> workspaceList = workspaceDao.findAllByReviewResearchPurpose((short) 1);\n+\n+      // 1. Filter out workspace where creation date is 365 days or 15 days\n+      // 2. set Research Purpose Review to FALSE\n+      // 3. Update workspace\n+      workspaceList =\n+          workspaceList.stream()\n+              .filter(\n+                  workspace -> {\n+                    DateTime workspaceCreationDate = new DateTime(workspace.getCreationTime());\n+                    DateTime workspaceModifiedDate = new DateTime(workspace.getLastModifiedTime());\n+                    return checkReviewDate(workspaceCreationDate, workspaceModifiedDate);\n+                  })\n+              .map(\n+                  filteredWorkspace -> {\n+                    filteredWorkspace.setResearchPurposeReviewed(false);\n+                    return filteredWorkspace;\n+                  })\n+              .collect(Collectors.toList());\n+      workspaceDao.save(workspaceList);\n+    }\n+    return ResponseEntity.noContent().build();\n+  }\n+\n+  private boolean checkReviewDate(DateTime workspaceCreationDate, DateTime workspaceModifiedDate) {\n+    DateTime creationDatePlus15 = workspaceCreationDate.plusDays(15);\n+    DateTime creationDatePlus1Year = workspaceCreationDate.plusYears(1);\n+\n+    // True if\n+    // 1. Current date is creation Date + 1 year or\n+    // 2. Current date is 15 days after creation date or\n+    // 3. Current Date is AFTER an year of creation date (in case cron job did not run/ missed\n+    // picking the workspace) and the Workspace has\n+    // not been modified after 1 year of creation date.\n+    int compareCreationDatePlus1Year =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3NTMyNQ==", "bodyText": "We need to update the story (will do it right now) the logic is as follows now and please let me know if it matches the understanding from code: it just checks if its more than 15 days/365 days. We are not implementing the update logic.\nSo this cron job will run and start marking workspaces that matches the days criteria", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r443575325", "createdAt": "2020-06-22T13:55:07Z", "author": {"login": "NehaBroad"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineWorkspaceController.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.api;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import javax.inject.Provider;\n+import org.joda.time.DateTime;\n+import org.joda.time.DateTimeComparator;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.db.dao.WorkspaceDao;\n+import org.pmiops.workbench.db.model.DbWorkspace;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+@RestController\n+public class OfflineWorkspaceController implements OfflineWorkspaceApiDelegate {\n+\n+  private final WorkspaceDao workspaceDao;\n+  private final Provider<WorkbenchConfig> configProvider;\n+\n+  @Autowired\n+  OfflineWorkspaceController(Provider<WorkbenchConfig> configProvider, WorkspaceDao workspaceDao) {\n+    this.configProvider = configProvider;\n+    this.workspaceDao = workspaceDao;\n+  }\n+\n+  @Override\n+  public ResponseEntity<Void> updateResearchPurposeReview() {\n+    if (configProvider.get().featureFlags.enableResearchPurposePrompt) {\n+      List<DbWorkspace> workspaceList = workspaceDao.findAllByReviewResearchPurpose((short) 1);\n+\n+      // 1. Filter out workspace where creation date is 365 days or 15 days\n+      // 2. set Research Purpose Review to FALSE\n+      // 3. Update workspace\n+      workspaceList =\n+          workspaceList.stream()\n+              .filter(\n+                  workspace -> {\n+                    DateTime workspaceCreationDate = new DateTime(workspace.getCreationTime());\n+                    DateTime workspaceModifiedDate = new DateTime(workspace.getLastModifiedTime());\n+                    return checkReviewDate(workspaceCreationDate, workspaceModifiedDate);\n+                  })\n+              .map(\n+                  filteredWorkspace -> {\n+                    filteredWorkspace.setResearchPurposeReviewed(false);\n+                    return filteredWorkspace;\n+                  })\n+              .collect(Collectors.toList());\n+      workspaceDao.save(workspaceList);\n+    }\n+    return ResponseEntity.noContent().build();\n+  }\n+\n+  private boolean checkReviewDate(DateTime workspaceCreationDate, DateTime workspaceModifiedDate) {\n+    DateTime creationDatePlus15 = workspaceCreationDate.plusDays(15);\n+    DateTime creationDatePlus1Year = workspaceCreationDate.plusYears(1);\n+\n+    // True if\n+    // 1. Current date is creation Date + 1 year or\n+    // 2. Current date is 15 days after creation date or\n+    // 3. Current Date is AFTER an year of creation date (in case cron job did not run/ missed\n+    // picking the workspace) and the Workspace has\n+    // not been modified after 1 year of creation date.\n+    int compareCreationDatePlus1Year =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4NjUzMA=="}, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYyNDQ3MQ==", "bodyText": "I didn't realize the requirements had been updated, thank you for letting me know.\nThe logic still won't work. You're comparing the creation date plus one year / plus fifteen days against nothing. You need to compare the creation date plus one year / plus fifteen days against the current date.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r443624471", "createdAt": "2020-06-22T15:00:53Z", "author": {"login": "als364"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineWorkspaceController.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.api;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import javax.inject.Provider;\n+import org.joda.time.DateTime;\n+import org.joda.time.DateTimeComparator;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.db.dao.WorkspaceDao;\n+import org.pmiops.workbench.db.model.DbWorkspace;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+@RestController\n+public class OfflineWorkspaceController implements OfflineWorkspaceApiDelegate {\n+\n+  private final WorkspaceDao workspaceDao;\n+  private final Provider<WorkbenchConfig> configProvider;\n+\n+  @Autowired\n+  OfflineWorkspaceController(Provider<WorkbenchConfig> configProvider, WorkspaceDao workspaceDao) {\n+    this.configProvider = configProvider;\n+    this.workspaceDao = workspaceDao;\n+  }\n+\n+  @Override\n+  public ResponseEntity<Void> updateResearchPurposeReview() {\n+    if (configProvider.get().featureFlags.enableResearchPurposePrompt) {\n+      List<DbWorkspace> workspaceList = workspaceDao.findAllByReviewResearchPurpose((short) 1);\n+\n+      // 1. Filter out workspace where creation date is 365 days or 15 days\n+      // 2. set Research Purpose Review to FALSE\n+      // 3. Update workspace\n+      workspaceList =\n+          workspaceList.stream()\n+              .filter(\n+                  workspace -> {\n+                    DateTime workspaceCreationDate = new DateTime(workspace.getCreationTime());\n+                    DateTime workspaceModifiedDate = new DateTime(workspace.getLastModifiedTime());\n+                    return checkReviewDate(workspaceCreationDate, workspaceModifiedDate);\n+                  })\n+              .map(\n+                  filteredWorkspace -> {\n+                    filteredWorkspace.setResearchPurposeReviewed(false);\n+                    return filteredWorkspace;\n+                  })\n+              .collect(Collectors.toList());\n+      workspaceDao.save(workspaceList);\n+    }\n+    return ResponseEntity.noContent().build();\n+  }\n+\n+  private boolean checkReviewDate(DateTime workspaceCreationDate, DateTime workspaceModifiedDate) {\n+    DateTime creationDatePlus15 = workspaceCreationDate.plusDays(15);\n+    DateTime creationDatePlus1Year = workspaceCreationDate.plusYears(1);\n+\n+    // True if\n+    // 1. Current date is creation Date + 1 year or\n+    // 2. Current date is 15 days after creation date or\n+    // 3. Current Date is AFTER an year of creation date (in case cron job did not run/ missed\n+    // picking the workspace) and the Workspace has\n+    // not been modified after 1 year of creation date.\n+    int compareCreationDatePlus1Year =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4NjUzMA=="}, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYzMzAwMg==", "bodyText": "null means now\n**\n* Compare two objects against only the range of date time fields as\n* specified in the constructor.\n*\n* @param lhsObj  the first object,\n*      logically on the left of a < comparison, null means now\n* @param rhsObj  the second object,\n*      logically on the right of a < comparison, null means now\n* @return zero if order does not matter,\n*      negative value if lhsObj < rhsObj, positive value otherwise.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r443633002", "createdAt": "2020-06-22T15:13:02Z", "author": {"login": "NehaBroad"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineWorkspaceController.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.api;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import javax.inject.Provider;\n+import org.joda.time.DateTime;\n+import org.joda.time.DateTimeComparator;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.db.dao.WorkspaceDao;\n+import org.pmiops.workbench.db.model.DbWorkspace;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+@RestController\n+public class OfflineWorkspaceController implements OfflineWorkspaceApiDelegate {\n+\n+  private final WorkspaceDao workspaceDao;\n+  private final Provider<WorkbenchConfig> configProvider;\n+\n+  @Autowired\n+  OfflineWorkspaceController(Provider<WorkbenchConfig> configProvider, WorkspaceDao workspaceDao) {\n+    this.configProvider = configProvider;\n+    this.workspaceDao = workspaceDao;\n+  }\n+\n+  @Override\n+  public ResponseEntity<Void> updateResearchPurposeReview() {\n+    if (configProvider.get().featureFlags.enableResearchPurposePrompt) {\n+      List<DbWorkspace> workspaceList = workspaceDao.findAllByReviewResearchPurpose((short) 1);\n+\n+      // 1. Filter out workspace where creation date is 365 days or 15 days\n+      // 2. set Research Purpose Review to FALSE\n+      // 3. Update workspace\n+      workspaceList =\n+          workspaceList.stream()\n+              .filter(\n+                  workspace -> {\n+                    DateTime workspaceCreationDate = new DateTime(workspace.getCreationTime());\n+                    DateTime workspaceModifiedDate = new DateTime(workspace.getLastModifiedTime());\n+                    return checkReviewDate(workspaceCreationDate, workspaceModifiedDate);\n+                  })\n+              .map(\n+                  filteredWorkspace -> {\n+                    filteredWorkspace.setResearchPurposeReviewed(false);\n+                    return filteredWorkspace;\n+                  })\n+              .collect(Collectors.toList());\n+      workspaceDao.save(workspaceList);\n+    }\n+    return ResponseEntity.noContent().build();\n+  }\n+\n+  private boolean checkReviewDate(DateTime workspaceCreationDate, DateTime workspaceModifiedDate) {\n+    DateTime creationDatePlus15 = workspaceCreationDate.plusDays(15);\n+    DateTime creationDatePlus1Year = workspaceCreationDate.plusYears(1);\n+\n+    // True if\n+    // 1. Current date is creation Date + 1 year or\n+    // 2. Current date is 15 days after creation date or\n+    // 3. Current Date is AFTER an year of creation date (in case cron job did not run/ missed\n+    // picking the workspace) and the Workspace has\n+    // not been modified after 1 year of creation date.\n+    int compareCreationDatePlus1Year =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4NjUzMA=="}, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYzNDg4MQ==", "bodyText": "oh my god that is the worst way for a library to default a thing that I have ever seen.\nAlright, this is fine, but can you leave a comment saying that null means now with a hyperlink to the documentation for this method call, please?", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r443634881", "createdAt": "2020-06-22T15:15:52Z", "author": {"login": "als364"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineWorkspaceController.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.api;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import javax.inject.Provider;\n+import org.joda.time.DateTime;\n+import org.joda.time.DateTimeComparator;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.db.dao.WorkspaceDao;\n+import org.pmiops.workbench.db.model.DbWorkspace;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+@RestController\n+public class OfflineWorkspaceController implements OfflineWorkspaceApiDelegate {\n+\n+  private final WorkspaceDao workspaceDao;\n+  private final Provider<WorkbenchConfig> configProvider;\n+\n+  @Autowired\n+  OfflineWorkspaceController(Provider<WorkbenchConfig> configProvider, WorkspaceDao workspaceDao) {\n+    this.configProvider = configProvider;\n+    this.workspaceDao = workspaceDao;\n+  }\n+\n+  @Override\n+  public ResponseEntity<Void> updateResearchPurposeReview() {\n+    if (configProvider.get().featureFlags.enableResearchPurposePrompt) {\n+      List<DbWorkspace> workspaceList = workspaceDao.findAllByReviewResearchPurpose((short) 1);\n+\n+      // 1. Filter out workspace where creation date is 365 days or 15 days\n+      // 2. set Research Purpose Review to FALSE\n+      // 3. Update workspace\n+      workspaceList =\n+          workspaceList.stream()\n+              .filter(\n+                  workspace -> {\n+                    DateTime workspaceCreationDate = new DateTime(workspace.getCreationTime());\n+                    DateTime workspaceModifiedDate = new DateTime(workspace.getLastModifiedTime());\n+                    return checkReviewDate(workspaceCreationDate, workspaceModifiedDate);\n+                  })\n+              .map(\n+                  filteredWorkspace -> {\n+                    filteredWorkspace.setResearchPurposeReviewed(false);\n+                    return filteredWorkspace;\n+                  })\n+              .collect(Collectors.toList());\n+      workspaceDao.save(workspaceList);\n+    }\n+    return ResponseEntity.noContent().build();\n+  }\n+\n+  private boolean checkReviewDate(DateTime workspaceCreationDate, DateTime workspaceModifiedDate) {\n+    DateTime creationDatePlus15 = workspaceCreationDate.plusDays(15);\n+    DateTime creationDatePlus1Year = workspaceCreationDate.plusYears(1);\n+\n+    // True if\n+    // 1. Current date is creation Date + 1 year or\n+    // 2. Current date is 15 days after creation date or\n+    // 3. Current Date is AFTER an year of creation date (in case cron job did not run/ missed\n+    // picking the workspace) and the Workspace has\n+    // not been modified after 1 year of creation date.\n+    int compareCreationDatePlus1Year =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4NjUzMA=="}, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTI2NjQwOnYy", "diffSide": "RIGHT", "path": "api/db/changelog/db.changelog-136-workspace-researchpurpose-review.xml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNDo1NTozNFrOGmXt_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMzo1NjowN1rOGnBuww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4NzY3OQ==", "bodyText": "What does 'research purpose review' mean? By my understanding this should be named something more like needs_rp_review_prompt. This also sounds a lot like rp_review_requested which could be confusing.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442887679", "createdAt": "2020-06-19T14:55:34Z", "author": {"login": "als364"}, "path": "api/db/changelog/db.changelog-136-workspace-researchpurpose-review.xml", "diffHunk": "@@ -0,0 +1,14 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<databaseChangeLog\n+  xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\n+                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\n+  <changeSet author=\"nsaxena\" id=\"changelog-136-workspace-add-researchpurpose-review\">\n+    <addColumn tableName=\"workspace\">\n+      <column name=\"research_purpose_review\" type=\"tinyint\" defaultValueNumeric=\"1\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3NjAwMw==", "bodyText": "yes, will change it to needs_rp_review_prompt", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r443576003", "createdAt": "2020-06-22T13:56:07Z", "author": {"login": "NehaBroad"}, "path": "api/db/changelog/db.changelog-136-workspace-researchpurpose-review.xml", "diffHunk": "@@ -0,0 +1,14 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<databaseChangeLog\n+  xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\n+                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\n+  <changeSet author=\"nsaxena\" id=\"changelog-136-workspace-add-researchpurpose-review\">\n+    <addColumn tableName=\"workspace\">\n+      <column name=\"research_purpose_review\" type=\"tinyint\" defaultValueNumeric=\"1\">", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4NzY3OQ=="}, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTMwNTE5OnYy", "diffSide": "RIGHT", "path": "api/src/main/resources/workbench-api.yaml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTowNjoyOFrOGmYGeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTowNjoyOFrOGmYGeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5Mzk0NA==", "bodyText": "This makes it sound like it's reviewing the research purpose, which is actually handled by reviewWorkspace.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442893944", "createdAt": "2020-06-19T15:06:28Z", "author": {"login": "als364"}, "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -1527,6 +1527,22 @@ paths:\n           description: Internal Error\n           schema:\n             \"$ref\": \"#/definitions/ErrorResponse\"\n+\n+  \"/v1/cron/updateResearchPurposeReview\":\n+    get:\n+      tags:\n+      - offlineWorkspace\n+      - cron\n+      description: Updates each Workspace Research Purpose Review", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTMxMjcxOnYy", "diffSide": "RIGHT", "path": "api/src/main/webapp/WEB-INF/cron_default.yaml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTowODo0N1rOGmYLHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNTowODo0N1rOGmYLHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5NTEzMw==", "bodyText": "nit: this sounds like it automatically reviews the research purpose twice. this should say something more like:\n'Marks a workspace to prompt the user to review the research purpose, if the workspace has existed for more than 15 days without research purpose review or if the research purpose has not been reviewed int he past 365 days.'", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442895133", "createdAt": "2020-06-19T15:08:47Z", "author": {"login": "als364"}, "path": "api/src/main/webapp/WEB-INF/cron_default.yaml", "diffHunk": "@@ -76,6 +76,13 @@ cron:\n     that is (1) after the close of normal business working hours, and (2) early enough in the evening that the\n     entire export (and downstream data flows) can complete before start of the next business day.\n   url: /v1/cron/exportToRdr\n+  schedule: every day 22:00\n+  timezone: America/Chicago\n+  target: api\n+- description: >\n+    Update Research Purpose Review for each workspace to true, if the workspace has been created for more than 17 or 365 days", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTMzMjQ2OnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/workspace/research-purpose.tsx", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNToxNDozM1rOGmYXMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMzo1NzozM1rOGnBy0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5ODIyNg==", "bodyText": "Ideally, we would do this logic in the WorkspaceService with a dedicated endpoint just for updating whether the user has reviewed the research purpose.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442898226", "createdAt": "2020-06-19T15:14:33Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/workspace/research-purpose.tsx", "diffHunk": "@@ -51,8 +54,26 @@ const styles = reactStyles({\n   sectionText: {\n     fontSize: '14px', lineHeight: '24px', color: colors.primary, marginTop: '0.3rem'\n   },\n+  reviewPurposeReminder: {\n+    marginTop: '0.3rem',\n+    borderStyle: 'solid',\n+    height: '2.5rem',\n+    color: colors.primary,\n+    alignItems: 'center',\n+    justifyContent: 'center',\n+    borderColor: colors.warning,\n+    borderRadius: '0.4rem',\n+    borderWidth: '0.1rem',\n+    backgroundColor: colorWithWhiteness(colors.highlight, 0.7)\n+  }\n });\n \n+function updateWorkspace(workspace) {\n+  workspace.researchPurpose.researchPurposeReviewed = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3NzA0MA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r443577040", "createdAt": "2020-06-22T13:57:33Z", "author": {"login": "NehaBroad"}, "path": "ui/src/app/pages/workspace/research-purpose.tsx", "diffHunk": "@@ -51,8 +54,26 @@ const styles = reactStyles({\n   sectionText: {\n     fontSize: '14px', lineHeight: '24px', color: colors.primary, marginTop: '0.3rem'\n   },\n+  reviewPurposeReminder: {\n+    marginTop: '0.3rem',\n+    borderStyle: 'solid',\n+    height: '2.5rem',\n+    color: colors.primary,\n+    alignItems: 'center',\n+    justifyContent: 'center',\n+    borderColor: colors.warning,\n+    borderRadius: '0.4rem',\n+    borderWidth: '0.1rem',\n+    backgroundColor: colorWithWhiteness(colors.highlight, 0.7)\n+  }\n });\n \n+function updateWorkspace(workspace) {\n+  workspace.researchPurpose.researchPurposeReviewed = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5ODIyNg=="}, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTMzOTc1OnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/workspace/research-purpose.tsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNToxNjozMlrOGmYbpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMzo1Nzo0NlrOGnBzdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5OTM2Ng==", "bodyText": "I don't have access to the design mock - does it really say 'looks good'?", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442899366", "createdAt": "2020-06-19T15:16:32Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/workspace/research-purpose.tsx", "diffHunk": "@@ -71,6 +92,21 @@ export const ResearchPurpose = withCurrentWorkspace()(\n                               style={styles.editIcon}/>\n         </Clickable>\n       </div>\n+      {isOwner && !workspace.researchPurpose.researchPurposeReviewed && <FlexRow style={styles.reviewPurposeReminder}>\n+        <ClrIcon style={{color: colors.warning, marginLeft: '0.3rem'}} className='is-solid'\n+        shape='exclamation-triangle' size='25'/>\n+        <FlexColumn style={{paddingRight: '0.5rem', paddingLeft: '0.5rem', color: colors.primary}}>\n+        <label style={{fontWeight: 600, fontSize: '14px', flex: 1}}>\n+        Please update or verify the following Research Purpose.</label>\n+        </FlexColumn>\n+        <div style={{marginLeft: 'auto', marginRight: '0.5rem'}}>\n+        <a style={{marginRight: '0.5rem'}} onClick={() => updateWorkspace(workspace)}>Looks", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3NzIwNQ==", "bodyText": "Yes", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r443577205", "createdAt": "2020-06-22T13:57:46Z", "author": {"login": "NehaBroad"}, "path": "ui/src/app/pages/workspace/research-purpose.tsx", "diffHunk": "@@ -71,6 +92,21 @@ export const ResearchPurpose = withCurrentWorkspace()(\n                               style={styles.editIcon}/>\n         </Clickable>\n       </div>\n+      {isOwner && !workspace.researchPurpose.researchPurposeReviewed && <FlexRow style={styles.reviewPurposeReminder}>\n+        <ClrIcon style={{color: colors.warning, marginLeft: '0.3rem'}} className='is-solid'\n+        shape='exclamation-triangle' size='25'/>\n+        <FlexColumn style={{paddingRight: '0.5rem', paddingLeft: '0.5rem', color: colors.primary}}>\n+        <label style={{fontWeight: 600, fontSize: '14px', flex: 1}}>\n+        Please update or verify the following Research Purpose.</label>\n+        </FlexColumn>\n+        <div style={{marginLeft: 'auto', marginRight: '0.5rem'}}>\n+        <a style={{marginRight: '0.5rem'}} onClick={() => updateWorkspace(workspace)}>Looks", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5OTM2Ng=="}, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTM0NTk5OnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/workspace/workspace-card.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNToxODoyN1rOGmYfTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNToxODoyN1rOGmYfTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkwMDMwMg==", "bodyText": "thanks for pulling this out, it was getting a bit big inline.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442900302", "createdAt": "2020-06-19T15:18:27Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/workspace/workspace-card.tsx", "diffHunk": "@@ -222,10 +225,28 @@ export class WorkspaceCard extends React.Component<WorkspaceCardProps, Workspace\n     await this.props.reload();\n   }\n \n+  handleReviewResearchPurpose() {\n+    const {workspace} = this.props;\n+    navigate(['workspaces', workspace.namespace, workspace.id, 'about']);\n+\n+  }\n+\n+  onClick() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTM0ODgzOnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNToxOToyM1rOGmYg_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxNTowMjo0NFrOGnExeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkwMDczNQ==", "bodyText": "Shouldn't this only be true if the user reviews the research purpose rather than just updating other aspects of the workspace?", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442900735", "createdAt": "2020-06-19T15:19:23Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -691,6 +691,7 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n             });\n           workspace = cloneWorkspace.workspace;\n         } else {\n+          workspace.researchPurpose.researchPurposeReviewed = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU3ODY3NA==", "bodyText": "Updating other aspect will also set the researchPurpose review to true, as the pop up as a UPDATE link that will redirect the user to Workspace Edit page.\nAnd now i am thinking if i should put this statement inside the service rather than here which will also take care in case of LOOKS GOOD", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r443578674", "createdAt": "2020-06-22T14:00:00Z", "author": {"login": "NehaBroad"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -691,6 +691,7 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n             });\n           workspace = cloneWorkspace.workspace;\n         } else {\n+          workspace.researchPurpose.researchPurposeReviewed = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkwMDczNQ=="}, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYyNTg0OQ==", "bodyText": "Right, I get that that is what the code is doing currently, but I don't think we want that - I think we only want to update this if the user actually reviews or updates the research purpose.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r443625849", "createdAt": "2020-06-22T15:02:44Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -691,6 +691,7 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n             });\n           workspace = cloneWorkspace.workspace;\n         } else {\n+          workspace.researchPurpose.researchPurposeReviewed = true;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkwMDczNQ=="}, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2ODM4Mzc5OnYy", "diffSide": "RIGHT", "path": "api/src/main/resources/workbench-api.yaml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTowOTo0NlrOGnt5Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTowOTo0NlrOGnt5Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI5OTU2Mg==", "bodyText": "nit: I would name this endpoint markResearchPurposeReviewed, so that it describes an action", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r444299562", "createdAt": "2020-06-23T15:09:46Z", "author": {"login": "als364"}, "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -790,6 +790,22 @@ paths:\n           description: Workspace deletion request accepted\n           schema:\n             \"$ref\": \"#/definitions/EmptyResponse\"\n+\n+  \"/v1/workspaces/{workspaceNamespace}/{workspaceId}/researchPurposeReviewed\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0000feed44268be07392ceb93be973b20c6ecb9"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2537, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}