{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczMjkzODg0", "number": 3914, "title": "[RW-5324][risk=no] Move ConceptSetMapper into ConceptSetService", "bodyText": "This PR finalizes separation of logic between ConceptSetController and ConceptSetService\n\nConceptSetController only has access to services and only throws request level exceptions(BadRequestException)\nConceptSetService has all daos and mappers and only throws service level/db level exceptions\n\nAlso added ConceptSetMapper#dbModelToDbModel for copy/clone of ConceptSets. Had to add an inner class ConceptSetContext to ConceptSetMapper to work around a problem with Mapstruct that throws an error: The types of @Context parameters must be unique. This was caused by having two Timestamp objects as parameters to the @afterMapping method.", "createdAt": "2020-08-25T15:41:05Z", "url": "https://github.com/all-of-us/workbench/pull/3914", "merged": true, "mergeCommit": {"oid": "df4fe865a0ea752f9c91c5bc6648d1c8eb15d5c6"}, "closed": true, "closedAt": "2020-08-26T16:33:37Z", "author": {"login": "freemabd"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCFNknAH2gAyNDczMjkzODg0OjM4ODNiMjhiOTY5YjBmMWJjMTgxNmFmMzBjNDlkZjI3MDY1MGU4OTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCuMa6gFqTQ3NTY0NzM0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3883b28b969b0f1bc1816af30c49df270650e890", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/3883b28b969b0f1bc1816af30c49df270650e890", "committedDate": "2020-08-24T16:29:26Z", "message": "RW-5324 moving conceptsetmapper to conceptsetservice"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3644519238f3d0a91a4dce5ab877115a21e8d862", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/3644519238f3d0a91a4dce5ab877115a21e8d862", "committedDate": "2020-08-24T16:49:31Z", "message": "RW-5324 merging nehas PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "859363c850f98bd2970deb3d381c3bd14d3fec3b", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/859363c850f98bd2970deb3d381c3bd14d3fec3b", "committedDate": "2020-08-25T00:20:16Z", "message": "RW-5324 cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70dac7aae9cd4752360c77d95f167b2f52c510ef", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/70dac7aae9cd4752360c77d95f167b2f52c510ef", "committedDate": "2020-08-25T14:51:38Z", "message": "RW-5324 cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ed2b590bc28a87849573625ee2bb6dcd4745413", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/0ed2b590bc28a87849573625ee2bb6dcd4745413", "committedDate": "2020-08-25T15:35:04Z", "message": "RW-5324 removed unused method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00437c4739c916aa2cbe9dbba077611bbdddf69c", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/00437c4739c916aa2cbe9dbba077611bbdddf69c", "committedDate": "2020-08-25T15:59:12Z", "message": "RW-5324 spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0Nzg4MjU2", "url": "https://github.com/all-of-us/workbench/pull/3914#pullrequestreview-474788256", "createdAt": "2020-08-25T19:29:50Z", "commit": {"oid": "00437c4739c916aa2cbe9dbba077611bbdddf69c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxOToyOTo1MFrOHGmrrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxOToyOTo1MFrOHGmrrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjY4NzI3Ng==", "bodyText": "Since both at line 120 and here toHydratedConcept is being called after updateConeptSet, how about calling   toHydratedConcept inside an conceptSetService.updateConceptSet? Or should we make the service return  Hydrated ConceptSet where ever possible like update/create?", "url": "https://github.com/all-of-us/workbench/pull/3914#discussion_r476687276", "createdAt": "2020-08-25T19:29:50Z", "author": {"login": "NehaBroad"}, "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "diffHunk": "@@ -221,18 +126,15 @@ private void addConceptsToSet(DbConceptSet dbConceptSet, List<Long> addedIds) {\n       String workspaceId,\n       Long conceptSetId,\n       UpdateConceptSetRequest request) {\n-    DbConceptSet dbConceptSet =\n-        getDbConceptSet(workspaceNamespace, workspaceId, conceptSetId, WorkspaceAccessLevel.WRITER);\n-    validateAndUpdateDbConceptSetConcept(dbConceptSet, request);\n-    Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n-    dbConceptSet.setLastModifiedTime(now);\n-    try {\n-      dbConceptSet = conceptSetService.save(dbConceptSet);\n-      return ResponseEntity.ok(toHydratedConceptSet(dbConceptSet));\n-      // TODO: add recent resource entry for concept sets [RW-1129]\n-    } catch (OptimisticLockException e) {\n-      throw new ConflictException(\"Failed due to concurrent concept set modification\");\n-    }\n+    // Fail fast if request isn't valid\n+    validateUpdateConceptSetConcepts(request);\n+\n+    workspaceService.getWorkspaceEnforceAccessLevelAndSetCdrVersion(\n+        workspaceNamespace, workspaceId, WorkspaceAccessLevel.WRITER);\n+\n+    return ResponseEntity.ok(\n+        conceptSetService.toHydratedConcepts(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00437c4739c916aa2cbe9dbba077611bbdddf69c"}, "originalPosition": 272}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "460d7edb5d0aa7987f1cdde4ed1bf73c2396848c", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/460d7edb5d0aa7987f1cdde4ed1bf73c2396848c", "committedDate": "2020-08-26T15:16:43Z", "message": "RW-5324 making toHydrate internal service method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NjQ3MzQ5", "url": "https://github.com/all-of-us/workbench/pull/3914#pullrequestreview-475647349", "createdAt": "2020-08-26T16:14:17Z", "commit": {"oid": "460d7edb5d0aa7987f1cdde4ed1bf73c2396848c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4337, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}