{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyOTgzMjcy", "number": 3738, "title": "[RW-5062][risk=no] Implement full DataSetMapper", "bodyText": "This PR addresses:\n\nImplementing DataSetMapper to allow full db model to client conversion\nRemoving DataSetController#TO_CLIENT_DATA_SET and DataSetController#TO_CLIENT_DOMAIN_VALUE  functions and using DataSetMapper\nImplementing DataSetMapperTest\nUpdating all affected test classes that use DataSetMapper\nCreation of BigQueryTableInfo enum to replace ConceptSetDao#DOMAIN_TO_TABLE_NAME", "createdAt": "2020-07-01T20:53:14Z", "url": "https://github.com/all-of-us/workbench/pull/3738", "merged": true, "mergeCommit": {"oid": "4467361318dd142c290e74b89b788affbae847b5"}, "closed": true, "closedAt": "2020-07-02T16:55:39Z", "author": {"login": "freemabd"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcw_nWlgFqTQ0MTcyNjQ4OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxBSqwAFqTQ0MTg0MzQxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNzI2NDg5", "url": "https://github.com/all-of-us/workbench/pull/3738#pullrequestreview-441726489", "createdAt": "2020-07-02T14:21:27Z", "commit": {"oid": "fb9c9d419f20c755414a86e0059392e231105ac8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNDoyMToyN1rOGsPGeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNDoyMToyN1rOGsPGeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTAzNzk0Ng==", "bodyText": "Can this be .map(cohortMapper::dbModelToClient)", "url": "https://github.com/all-of-us/workbench/pull/3738#discussion_r449037946", "createdAt": "2020-07-02T14:21:27Z", "author": {"login": "NehaBroad"}, "path": "api/src/main/java/org/pmiops/workbench/cohorts/CohortService.java", "diffHunk": "@@ -1,19 +1,28 @@\n package org.pmiops.workbench.cohorts;\n \n import java.util.List;\n+import java.util.stream.Collectors;\n import org.pmiops.workbench.db.dao.CohortDao;\n import org.pmiops.workbench.db.model.DbCohort;\n+import org.pmiops.workbench.model.Cohort;\n+import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Service;\n \n @Service\n public class CohortService {\n-  private CohortDao cohortDao;\n+  private final CohortDao cohortDao;\n+  private final CohortMapper cohortMapper;\n \n-  public CohortService(CohortDao cohortDao) {\n+  @Autowired\n+  public CohortService(CohortDao cohortDao, CohortMapper cohortMapper) {\n     this.cohortDao = cohortDao;\n+    this.cohortMapper = cohortMapper;\n   }\n \n-  public List<DbCohort> findAll(List<Long> cohortIds) {\n-    return (List<DbCohort>) cohortDao.findAll(cohortIds);\n+  public List<Cohort> findAll(List<Long> cohortIds) {\n+    return ((List<DbCohort>) cohortDao.findAll(cohortIds))\n+        .stream()\n+            .map(dbCohort -> cohortMapper.dbModelToClient(dbCohort))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb9c9d419f20c755414a86e0059392e231105ac8"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNzMzMDIz", "url": "https://github.com/all-of-us/workbench/pull/3738#pullrequestreview-441733023", "createdAt": "2020-07-02T14:28:22Z", "commit": {"oid": "fb9c9d419f20c755414a86e0059392e231105ac8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNDoyODoyMlrOGsPZ4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNDoyODoyMlrOGsPZ4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MjkxNQ==", "bodyText": "Rather than individual elements since DataDictionaryEntry has equal and hashcode can we just have assertThat(dbDataDictionaryEntry).isEqual(dataDictionaryEntry)?", "url": "https://github.com/all-of-us/workbench/pull/3738#discussion_r449042915", "createdAt": "2020-07-02T14:28:22Z", "author": {"login": "NehaBroad"}, "path": "api/src/test/java/org/pmiops/workbench/dataset/DataSetMapperTest.java", "diffHunk": "@@ -0,0 +1,194 @@\n+package org.pmiops.workbench.dataset;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static org.mockito.Mockito.doReturn;\n+\n+import com.google.common.collect.ImmutableList;\n+import java.sql.Timestamp;\n+import java.time.Instant;\n+import java.util.Collections;\n+import java.util.stream.Collectors;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.pmiops.workbench.api.Etags;\n+import org.pmiops.workbench.cdr.ConceptBigQueryService;\n+import org.pmiops.workbench.cohorts.CohortMapperImpl;\n+import org.pmiops.workbench.cohorts.CohortService;\n+import org.pmiops.workbench.concept.ConceptService;\n+import org.pmiops.workbench.conceptset.ConceptSetMapperImpl;\n+import org.pmiops.workbench.conceptset.ConceptSetService;\n+import org.pmiops.workbench.db.dao.CohortDao;\n+import org.pmiops.workbench.db.dao.ConceptSetDao;\n+import org.pmiops.workbench.db.dao.UserDao;\n+import org.pmiops.workbench.db.model.DbCdrVersion;\n+import org.pmiops.workbench.db.model.DbCohort;\n+import org.pmiops.workbench.db.model.DbConceptSet;\n+import org.pmiops.workbench.db.model.DbDataDictionaryEntry;\n+import org.pmiops.workbench.db.model.DbDataset;\n+import org.pmiops.workbench.db.model.DbDatasetValue;\n+import org.pmiops.workbench.db.model.DbStorageEnums;\n+import org.pmiops.workbench.model.Cohort;\n+import org.pmiops.workbench.model.ConceptSet;\n+import org.pmiops.workbench.model.DataDictionaryEntry;\n+import org.pmiops.workbench.model.DataSet;\n+import org.pmiops.workbench.model.Domain;\n+import org.pmiops.workbench.model.PrePackagedConceptSetEnum;\n+import org.pmiops.workbench.utils.mappers.CommonMappers;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.TestConfiguration;\n+import org.springframework.boot.test.mock.mockito.MockBean;\n+import org.springframework.context.annotation.Import;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+@RunWith(SpringRunner.class)\n+public class DataSetMapperTest {\n+\n+  private DbDataset dbDataset;\n+  private DbDataDictionaryEntry dbDataDictionaryEntry;\n+\n+  @Autowired private DataSetMapper dataSetMapper;\n+  @Autowired private ConceptSetDao mockConceptSetDao;\n+  @Autowired private CohortDao mockCohortDao;\n+\n+  @TestConfiguration\n+  @Import({\n+    DataSetMapperImpl.class,\n+    CommonMappers.class,\n+    ConceptSetService.class,\n+    ConceptSetMapperImpl.class,\n+    CohortService.class,\n+    CohortMapperImpl.class\n+  })\n+  @MockBean({\n+    ConceptSetDao.class,\n+    ConceptBigQueryService.class,\n+    ConceptService.class,\n+    CohortDao.class,\n+    UserDao.class\n+  })\n+  static class Configuration {}\n+\n+  @Before\n+  public void setUp() {\n+    dbDataset =\n+        DbDataset.builder()\n+            .addVersion(1)\n+            .addDataSetId(101L)\n+            .addName(\"All Blue-eyed Blondes\")\n+            .addIncludesAllParticipants(false)\n+            .addDescription(\"All Blue-eyed Blondes\")\n+            .addLastModifiedTime(Timestamp.from(Instant.now()))\n+            .addWorkspaceId(1L)\n+            .addPrePackagedConceptSets(\n+                DbStorageEnums.prePackagedConceptSetsToStorage(PrePackagedConceptSetEnum.NONE))\n+            .addCohortIds(ImmutableList.of(1L))\n+            .addConceptSetIds(ImmutableList.of(1L))\n+            .addValues(\n+                ImmutableList.of(\n+                    new DbDatasetValue(\n+                        DbStorageEnums.domainToStorage(Domain.CONDITION).toString(), \"value\")))\n+            .build();\n+    DbConceptSet dbConceptSet = new DbConceptSet();\n+    dbConceptSet.setConceptSetId(1L);\n+    DbCohort dbCohort = new DbCohort();\n+    dbCohort.setCohortId(1L);\n+\n+    doReturn(Collections.singletonList(dbConceptSet))\n+        .when(mockConceptSetDao)\n+        .findAll(dbDataset.getConceptSetIds());\n+    doReturn(Collections.singletonList(dbCohort))\n+        .when(mockCohortDao)\n+        .findAll(dbDataset.getCohortIds());\n+\n+    DbCdrVersion cdrVersion = new DbCdrVersion();\n+    cdrVersion.setCdrVersionId(1L);\n+    dbDataDictionaryEntry = new DbDataDictionaryEntry();\n+    dbDataDictionaryEntry.setCdrVersion(cdrVersion);\n+    dbDataDictionaryEntry.setDefinedTime(Timestamp.from(Instant.now()));\n+    dbDataDictionaryEntry.setDataProvenance(\"p\");\n+    dbDataDictionaryEntry.setRelevantOmopTable(\"person\");\n+    dbDataDictionaryEntry.setFieldName(\"field\");\n+    dbDataDictionaryEntry.setOmopCdmStandardOrCustomField(\"field\");\n+    dbDataDictionaryEntry.setDescription(\"desc\");\n+    dbDataDictionaryEntry.setFieldType(\"type\");\n+    dbDataDictionaryEntry.setSourcePpiModule(\"s\");\n+    dbDataDictionaryEntry.setTransformedByRegisteredTierPrivacyMethods(false);\n+  }\n+\n+  @Test\n+  public void dbModelToClientLight() {\n+    final DataSet toClientDataSet = dataSetMapper.dbModelToClientLight(dbDataset);\n+    assertDbModelToClientLight(toClientDataSet, dbDataset);\n+  }\n+\n+  @Test\n+  public void dbModelToClientDataSet() {\n+    final DataSet toClientDataSet = dataSetMapper.dbModelToClient(dbDataset);\n+    assertDbModelToClient(toClientDataSet, dbDataset);\n+  }\n+\n+  @Test\n+  public void dbModelToClientDataDictionaryEntry() {\n+    final DataDictionaryEntry toClientDataDictionaryEntry =\n+        dataSetMapper.dbModelToClient(dbDataDictionaryEntry);\n+    assertDbModelToClient(toClientDataDictionaryEntry, dbDataDictionaryEntry);\n+  }\n+\n+  private void assertDbModelToClient(DataSet dataSet, DbDataset dbDataset) {\n+    assertThat(dbDataset.getCohortIds())\n+        .isEqualTo(dataSet.getCohorts().stream().map(Cohort::getId).collect(Collectors.toList()));\n+    assertThat(dbDataset.getConceptSetIds())\n+        .isEqualTo(\n+            dataSet.getConceptSets().stream().map(ConceptSet::getId).collect(Collectors.toList()));\n+    assertThat(dbDataset.getValues())\n+        .isEqualTo(\n+            dataSet.getDomainValuePairs().stream()\n+                .map(\n+                    dvp ->\n+                        new DbDatasetValue(\n+                            DbStorageEnums.domainToStorage(dvp.getDomain()).toString(),\n+                            dvp.getValue()))\n+                .collect(Collectors.toList()));\n+    assertDbModelToClientLight(dataSet, dbDataset);\n+  }\n+\n+  private void assertDbModelToClientLight(DataSet dataSet, DbDataset dbDataset) {\n+    assertThat(dbDataset.getDataSetId()).isEqualTo(dataSet.getId());\n+    assertThat(dbDataset.getVersion()).isEqualTo(Etags.toVersion(dataSet.getEtag()));\n+    assertThat(dbDataset.getName()).isEqualTo(dataSet.getName());\n+    assertThat(dbDataset.getIncludesAllParticipants())\n+        .isEqualTo(dataSet.getIncludesAllParticipants());\n+    assertThat(dbDataset.getDescription()).isEqualTo(dataSet.getDescription());\n+    assertThat(dbDataset.getWorkspaceId()).isEqualTo(dataSet.getWorkspaceId());\n+    assertThat(dbDataset.getLastModifiedTime().toInstant().toEpochMilli())\n+        .isEqualTo(dataSet.getLastModifiedTime());\n+    assertThat(dbDataset.getPrePackagedConceptSet())\n+        .isEqualTo(\n+            DbStorageEnums.prePackagedConceptSetsToStorage(dataSet.getPrePackagedConceptSet()));\n+  }\n+\n+  private void assertDbModelToClient(\n+      DataDictionaryEntry dataDictionaryEntry, DbDataDictionaryEntry dbDataDictionaryEntry) {\n+    assertThat(dbDataDictionaryEntry.getCdrVersion().getCdrVersionId())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb9c9d419f20c755414a86e0059392e231105ac8"}, "originalPosition": 173}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f08feb413023798acbbacf232b542cb430ee1b1", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/4f08feb413023798acbbacf232b542cb430ee1b1", "committedDate": "2020-07-02T16:11:12Z", "message": "RW-5062 adding test for datasetmapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "682f2747a520d2f4b300ffebbbdf16f593db3158", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/682f2747a520d2f4b300ffebbbdf16f593db3158", "committedDate": "2020-07-02T16:11:12Z", "message": "RW-5062 adding test for datasetmapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a88b34a049775fcd1b0b66b429b752376a6521ca", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/a88b34a049775fcd1b0b66b429b752376a6521ca", "committedDate": "2020-07-02T16:11:12Z", "message": "RW-5062 adding test for datasetmapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebd0bd29493eeafe89f58f39358f732ff4b531ba", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/ebd0bd29493eeafe89f58f39358f732ff4b531ba", "committedDate": "2020-07-02T16:11:12Z", "message": "RW-5062 implementing mapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1937ca2b84c77d678edb3c50db06107aa5bed45d", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/1937ca2b84c77d678edb3c50db06107aa5bed45d", "committedDate": "2020-07-02T16:11:12Z", "message": "RW-5062 implemented datasetmapper and updating tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb1308eaefe8326d2402718aaa1e9a968f2742fe", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/eb1308eaefe8326d2402718aaa1e9a968f2742fe", "committedDate": "2020-07-02T16:11:12Z", "message": "RW-5062 updating tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4da561951a3fe5e727b8b4f5519f96a7507ab5e5", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/4da561951a3fe5e727b8b4f5519f96a7507ab5e5", "committedDate": "2020-07-02T16:11:12Z", "message": "RW-5062 cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "658cfb81759e1233ad1ce5abb9bd5a19905bc5da", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/658cfb81759e1233ad1ce5abb9bd5a19905bc5da", "committedDate": "2020-07-02T16:11:12Z", "message": "RW-5062 cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df36aa4220d2c18c4246f8c3d695651f88ff9c8b", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/df36aa4220d2c18c4246f8c3d695651f88ff9c8b", "committedDate": "2020-07-02T16:11:12Z", "message": "RW-5062 fixing compile error."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "655c1d4f97c7e4c7fa5538547c82578ea740b985", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/655c1d4f97c7e4c7fa5538547c82578ea740b985", "committedDate": "2020-07-02T16:11:12Z", "message": "RW-5062 removing unused services"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87b966648058746858ea24b0b489c1c18ab087cf", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/87b966648058746858ea24b0b489c1c18ab087cf", "committedDate": "2020-07-02T16:11:12Z", "message": "RW-5062 fix lambda expression"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bed84be75981804511f273233150cc241917b434", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/bed84be75981804511f273233150cc241917b434", "committedDate": "2020-07-02T14:42:33Z", "message": "RW-5062 fix lambda expression"}, "afterCommit": {"oid": "87b966648058746858ea24b0b489c1c18ab087cf", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/87b966648058746858ea24b0b489c1c18ab087cf", "committedDate": "2020-07-02T16:11:12Z", "message": "RW-5062 fix lambda expression"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxODQzNDE5", "url": "https://github.com/all-of-us/workbench/pull/3738#pullrequestreview-441843419", "createdAt": "2020-07-02T16:18:40Z", "commit": {"oid": "bed84be75981804511f273233150cc241917b434"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4664, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}