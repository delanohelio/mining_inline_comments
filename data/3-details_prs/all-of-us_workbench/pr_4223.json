{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyMDM2NDQy", "number": 4223, "title": "[RW-5797][RW-5798][RW-5800][risk=no] Bug fixes for presets and dataproc", "bodyText": "Changes:\n\nBug: bootDiskSize is an outdated property, just remove it - this caused a few bugs\nBug: dataproc master settings were ignored\nBug: preset now affects compute type\nFeature: Show genomics analysis preset IFF hasMicroarrayData\nPreset calculation performed at the end instead, this is less error prone and more future-proof\nTest coverage of form configuration through to the createRuntime call\nTest coverage of both presets", "createdAt": "2020-10-29T06:03:35Z", "url": "https://github.com/all-of-us/workbench/pull/4223", "merged": true, "mergeCommit": {"oid": "a16fa6c2aea75d359639150493347a6f68e6fa37"}, "closed": true, "closedAt": "2020-10-30T01:02:39Z", "author": {"login": "calbach"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXHZyqAH2gAyNTEyMDM2NDQyOjE4YTc2ZWFhNDQxY2FmYmFjOTFkZWQ2NTk4ZWFiYTk3N2RhMTJiMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXb0NAgFqTUyMDIyMDgyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "18a76eaa441cafbac91ded6598eaba977da12b07", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/18a76eaa441cafbac91ded6598eaba977da12b07", "committedDate": "2020-10-29T00:55:00Z", "message": "Initial preset and dataproc fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d7ca59b7056cb18b15be8b3e1c98b62db754510", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/4d7ca59b7056cb18b15be8b3e1c98b62db754510", "committedDate": "2020-10-29T05:52:05Z", "message": "Initial tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96bf867563998b7dbc8807b0301de8a63e7a1a2d", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/96bf867563998b7dbc8807b0301de8a63e7a1a2d", "committedDate": "2020-10-29T05:54:40Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "729a1ee029e011815e61106ef4feb8aed1c66bcc", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/729a1ee029e011815e61106ef4feb8aed1c66bcc", "committedDate": "2020-10-29T06:02:44Z", "message": "cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5ODA1MjQw", "url": "https://github.com/all-of-us/workbench/pull/4223#pullrequestreview-519805240", "createdAt": "2020-10-29T15:42:08Z", "commit": {"oid": "729a1ee029e011815e61106ef4feb8aed1c66bcc"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNTo0MjowOFrOHqiHJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNTo0MjowOFrOHqiHJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDM2MTEyNg==", "bodyText": "nit: remove 'from'", "url": "https://github.com/all-of-us/workbench/pull/4223#discussion_r514361126", "createdAt": "2020-10-29T15:42:08Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -141,10 +152,18 @@ const DataProcConfigSelector = ({onChange, dataprocConfig})  => {\n   } = dataprocConfig || {};\n   const initialMachine = findMachineByName(workerMachineType);\n   const [selectedNumWorkers, setSelectedNumWorkers] = useState<number>(numberOfWorkers);\n-  const [selectedPreemtible, setUpdatedPreemptible] = useState<number>(numberOfPreemptibleWorkers);\n+  const [selectedPreemtible, setSelectedPreemptible] = useState<number>(numberOfPreemptibleWorkers);\n   const [selectedWorkerMachine, setSelectedWorkerMachine] = useState<Machine>(initialMachine);\n   const [selectedDiskSize, setSelectedDiskSize] = useState<number>(workerDiskSize);\n \n+  // If the dataprocConfig prop changes from externally, reset the selectors accordingly.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "729a1ee029e011815e61106ef4feb8aed1c66bcc"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "575f07c61ff12b3f2c7adb86778248c8327d0a18", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/575f07c61ff12b3f2c7adb86778248c8327d0a18", "committedDate": "2020-10-30T00:29:30Z", "message": "tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d", "committedDate": "2020-10-30T00:31:09Z", "message": "comment fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwMjIwODIy", "url": "https://github.com/all-of-us/workbench/pull/4223#pullrequestreview-520220822", "createdAt": "2020-10-30T00:32:09Z", "commit": {"oid": "4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwMDozMjowOVrOHqzR7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwMDozNDozMlrOHqzUHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY0MjQxMw==", "bodyText": "Pulled out these helpers to reduce test boilerplate.", "url": "https://github.com/all-of-us/workbench/pull/4223#discussion_r514642413", "createdAt": "2020-10-30T00:32:09Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -51,6 +55,48 @@ describe('RuntimePanel', () => {\n     };\n   });\n \n+  const pickDropdownOption = async(wrapper, id, label) => {\n+    act(() => { wrapper.find(id).first().simulate('click') });\n+    const item = wrapper.find(`${id} .p-dropdown-item`).find({'aria-label': label}).first()\n+    expect(item.exists()).toBeTruthy();\n+\n+    act(() => { item.simulate('click') });\n+\n+    // In some cases, picking an option may require some waiting, e.g. for\n+    // rerendering of RAM options based on CPU selection.\n+    await waitOneTickAndUpdate(wrapper);\n+  };\n+\n+  const enterNumberInput = (wrapper, id, value) => {\n+    // TODO: Find a way to invoke this without props.\n+    act(() => { wrapper.find(id).first().prop('onChange')({value} as any)});\n+  };\n+\n+  const pickMainCpu = (wrapper, cpu) => pickDropdownOption(wrapper, '#runtime-cpu', cpu);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY0MjY0OQ==", "bodyText": "unit tests caught a bug of mine here", "url": "https://github.com/all-of-us/workbench/pull/4223#discussion_r514642649", "createdAt": "2020-10-30T00:33:15Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -141,10 +152,18 @@ const DataProcConfigSelector = ({onChange, dataprocConfig})  => {\n   } = dataprocConfig || {};\n   const initialMachine = findMachineByName(workerMachineType);\n   const [selectedNumWorkers, setSelectedNumWorkers] = useState<number>(numberOfWorkers);\n-  const [selectedPreemtible, setUpdatedPreemptible] = useState<number>(numberOfPreemptibleWorkers);\n+  const [selectedPreemtible, setSelectedPreemptible] = useState<number>(numberOfPreemptibleWorkers);\n   const [selectedWorkerMachine, setSelectedWorkerMachine] = useState<Machine>(initialMachine);\n   const [selectedDiskSize, setSelectedDiskSize] = useState<number>(workerDiskSize);\n \n+  // If the dataprocConfig prop changes externally, reset the selectors accordingly.\n+  useEffect(() => {\n+    setSelectedNumWorkers(numberOfWorkers);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY0MjczMw==", "bodyText": "More shadowing issues made this uglier", "url": "https://github.com/all-of-us/workbench/pull/4223#discussion_r514642733", "createdAt": "2020-10-30T00:33:39Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -232,30 +250,35 @@ export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())((\n                       <React.Fragment>\n                         {\n                           fp.flow(\n-                            fp.filter(['displayName', 'General Analysis']),\n+                            fp.filter(({runtimeTemplate}) => hasMicroarrayData || !runtimeTemplate.dataprocConfig),\n                             fp.toPairs,\n                             fp.map(([i, preset]) => {\n                               return <MenuItem\n                               style={styles.presetMenuItem}\n                               key={i}\n+                              aria-label={preset.displayName}\n                               onClick={() => {\n                                 // renaming to avoid shadowing\n                                 const {runtimeTemplate} = preset;\n-                                const {presetDiskSize, presetMachineName} = fp.cond([\n-                                  [() => !!runtimeTemplate.gceConfig, ({gceConfig: {bootDiskSize, machineType}}) => ({\n-                                    presetDiskSize: bootDiskSize,\n-                                    presetMachineName: machineType\n+                                const {presetDiskSize, presetMachineName, presetCompute} = fp.cond([\n+                                  // Can't destructure due to shadowing.\n+                                  [() => !!runtimeTemplate.gceConfig, (tmpl: Runtime) => ({", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDY0Mjk3NQ==", "bodyText": "Added this test override to allow coverage of popup UI elements.", "url": "https://github.com/all-of-us/workbench/pull/4223#discussion_r514642975", "createdAt": "2020-10-30T00:34:32Z", "author": {"login": "calbach"}, "path": "ui/src/app/components/popups.tsx", "diffHunk": "@@ -29,6 +29,22 @@ const styles = {\n   }\n };\n \n+// Enable stubbing out dimensions for testing purposes. Enzyme does not have", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f8d0351c8cee8ba4f3b7df213f4cdfa5e0c249d"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3785, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}