{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NTA4Nzgz", "number": 4200, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMTo0ODoxM1rOEw9QKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMTo1ODowMFrOEw9auA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NzcwNjY3OnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/data/data-set/new-dataset-modal.spec.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMTo0ODoxM1rOHm1FgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMTo0ODoxM1rOHm1FgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3NzY5Ng==", "bodyText": "please make relative to application, not the current file (next line also violates this, but is less offensive and existing issue)", "url": "https://github.com/all-of-us/workbench/pull/4200#discussion_r510477696", "createdAt": "2020-10-22T21:48:13Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/data/data-set/new-dataset-modal.spec.tsx", "diffHunk": "@@ -11,7 +11,10 @@ import {\n import {waitOneTickAndUpdate} from 'testing/react-test-helpers';\n import {DataSetApiStub} from 'testing/stubs/data-set-api-stub';\n import {WorkspacesApiStub} from 'testing/stubs/workspaces-api-stub';\n+import {DataSetExportRequest} from '../../../../generated/fetch';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4963aaf0f5d2a9911bb4128fca62590494ef50d1"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NzcwOTk1OnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/data/data-set/new-dataset-modal.spec.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMTo0OTozMVrOHm1HjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMTo0OTozMVrOHm1HjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3ODIyMA==", "bodyText": "interesting - I actually haven't seen this pattern before but it seems pretty nice", "url": "https://github.com/all-of-us/workbench/pull/4200#discussion_r510478220", "createdAt": "2020-10-22T21:49:31Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/data/data-set/new-dataset-modal.spec.tsx", "diffHunk": "@@ -11,7 +11,10 @@ import {\n import {waitOneTickAndUpdate} from 'testing/react-test-helpers';\n import {DataSetApiStub} from 'testing/stubs/data-set-api-stub';\n import {WorkspacesApiStub} from 'testing/stubs/workspaces-api-stub';\n+import {DataSetExportRequest} from '../../../../generated/fetch';\n import {NewDataSetModal} from './new-dataset-modal';\n+import GenomicsAnalysisToolEnum = DataSetExportRequest.GenomicsAnalysisToolEnum;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4963aaf0f5d2a9911bb4128fca62590494ef50d1"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NzcxMzc3OnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/data/data-set/new-dataset-modal.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMTo1MDo0NFrOHm1Jxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMTo1MDo0NFrOHm1Jxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ3ODc5MQ==", "bodyText": "nit: would revert these newlines", "url": "https://github.com/all-of-us/workbench/pull/4200#discussion_r510478791", "createdAt": "2020-10-22T21:50:44Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/data/data-set/new-dataset-modal.tsx", "diffHunk": "@@ -1,30 +1,36 @@\n-import * as React from 'react';\n-\n-import {validate} from 'validate.js';\n-\n-import {dataSetApi, workspacesApi} from 'app/services/swagger-fetch-clients';\n-\n import {AlertDanger} from 'app/components/alert';\n import {Button, TabButton} from 'app/components/buttons';\n import {SmallHeader, styles as headerStyles} from 'app/components/headers';\n import {CheckBox, RadioButton, Select, TextArea, TextInput} from 'app/components/inputs';\n import {Modal, ModalBody, ModalFooter, ModalTitle} from 'app/components/modals';\n import {TooltipTrigger} from 'app/components/popups';\n import {SpinnerOverlay} from 'app/components/spinners';\n+import {TextColumn} from 'app/components/text-column';\n import {appendNotebookFileSuffix} from 'app/pages/analysis/util';\n+\n+import {dataSetApi, workspacesApi} from 'app/services/swagger-fetch-clients';\n import colors from 'app/styles/colors';\n-import {summarizeErrors} from 'app/utils';\n+import {\n+  summarizeErrors", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4963aaf0f5d2a9911bb4128fca62590494ef50d1"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NzcyMjQ3OnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/data/data-set/new-dataset-modal.spec.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMTo1NDowMFrOHm1PBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMTo1NDowMFrOHm1PBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4MDEzMw==", "bodyText": "nit: indent, here and below", "url": "https://github.com/all-of-us/workbench/pull/4200#discussion_r510480133", "createdAt": "2020-10-22T21:54:00Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/data/data-set/new-dataset-modal.spec.tsx", "diffHunk": "@@ -139,17 +148,103 @@ describe('NewDataSetModal', () => {\n       dataSetRequest: dataSetRequestStub,\n       newNotebook: true,\n       notebookName: notebookNameStub,\n-      kernelType: KernelTypeEnum.Python\n+      kernelType: KernelTypeEnum.Python,\n+      genomicsDataType: GenomicsDataTypeEnum.NONE,\n+      genomicsAnalysisTool: GenomicsAnalysisToolEnum.NONE\n     });\n   });\n+\n   it ('should have default dataSet name if dataset is passed as props', () => {\n     const name = 'Update Dataset';\n     dataSet = {...dataSet, name: name, description: 'dataset'};\n     const wrapper = mount(createNewDataSetModal());\n     const dataSetName  =\n-        wrapper.find('[data-test-id=\"data-set-name-input\"]').first().prop('value');\n+      wrapper.find('[data-test-id=\"data-set-name-input\"]').first().prop('value');\n     expect(dataSetName).toBe(name);\n+  });\n+\n+  it ('should show microarray options if the display flag is true and the kernel is Python', async() => {\n+    const wrapper = mount(createNewDataSetModal());\n+    wrapper.setProps({displayMicroarrayOptions: true});\n+    wrapper.setState({kernelType: KernelTypeEnum.Python});\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find('[data-test-id=\"include-raw-microarray-data\"]').exists()).toBeTruthy();\n+  });\n+\n+  it ('should not show microarray options if the cdrVersion does not have microarray data', async() => {\n+    const wrapper = mount(createNewDataSetModal());\n+    wrapper.setProps({displayMicroarrayOptions: false});\n+    wrapper.setState({kernelType: KernelTypeEnum.Python});\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find('[data-test-id=\"include-raw-microarray-data\"]').exists()).toBeFalsy();\n+  });\n+\n+  it ('should not show microarray options if the kernel is not Python', async() => {\n+    const wrapper = mount(createNewDataSetModal());\n+    wrapper.setProps({displayMicroarrayOptions: true});\n+    wrapper.setState({kernelType: KernelTypeEnum.R});\n+    await waitOneTickAndUpdate(wrapper);\n \n+    expect(wrapper.find('[data-test-id=\"include-raw-microarray-data\"]').exists()).toBeFalsy();\n+  });\n \n+  it ('should show genomics analysis tools if include raw microarray data is checked', async() => {\n+    const wrapper = mount(createNewDataSetModal());\n+    wrapper.setProps({displayMicroarrayOptions: true});\n+    wrapper.setState({kernelType: KernelTypeEnum.Python, includeRawMicroarrayData: true});\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    expect(wrapper.find('[data-test-id=\"genomics-analysis-tool-none\"]').exists()).toBeTruthy();\n+    expect(wrapper.find('[data-test-id=\"genomics-analysis-tool-hail\"]').exists()).toBeTruthy();\n+    expect(wrapper.find('[data-test-id=\"genomics-analysis-tool-plink\"]').exists()).toBeTruthy();\n   });\n+\n+  it ('should export to notebook with the correct microarray parameters', async() => {\n+    const wrapper = mount(createNewDataSetModal());\n+    wrapper.setProps({displayMicroarrayOptions: true});\n+    wrapper.setState({kernelType: KernelTypeEnum.Python});\n+\n+    const exportSpy = jest.spyOn(dataSetApi(), 'exportToNotebook');\n+    const nameStub = 'Dataset Name';\n+    const notebookNameStub = 'Notebook Name';\n+    const dataSetRequestStub: DataSetRequest = {\n+      name: nameStub,\n+      includesAllParticipants: false,\n+      description: '',\n+      conceptSetIds: [],\n+      cohortIds: [],\n+      domainValuePairs: [],\n+      prePackagedConceptSet: PrePackagedConceptSetEnum.NONE\n+    };\n+\n+    wrapper.find('[data-test-id=\"data-set-name-input\"]')\n+    .first().simulate('change', {target: {value: nameStub}});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4963aaf0f5d2a9911bb4128fca62590494ef50d1"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NzczMzY4OnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/data/data-set/new-dataset-modal.tsx", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQyMTo1ODowMFrOHm1V0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxNToyMzo1OVrOHnSk0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4MTg3NQ==", "bodyText": "OK, forgot to flag one issue that I believe exists here: should ensure that the following doesn't 400 (leave it up to you the best method for doing so):\n\ncheck microarray\nswitch to R\nexport", "url": "https://github.com/all-of-us/workbench/pull/4200#discussion_r510481875", "createdAt": "2020-10-22T21:58:00Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/data/data-set/new-dataset-modal.tsx", "diffHunk": "@@ -339,6 +351,42 @@ class NewDataSetModal extends React.Component<Props, State> {\n                 </label>\n               )}\n           </React.Fragment>}\n+          {this.props.displayMicroarrayOptions && this.state.kernelType === KernelTypeEnum.Python &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4963aaf0f5d2a9911bb4128fca62590494ef50d1"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4MjExNA==", "bodyText": "(right now, pretty sure the includeMicroarrayData will still be true, resulting in an export failure to R)", "url": "https://github.com/all-of-us/workbench/pull/4200#discussion_r510482114", "createdAt": "2020-10-22T21:58:37Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/data/data-set/new-dataset-modal.tsx", "diffHunk": "@@ -339,6 +351,42 @@ class NewDataSetModal extends React.Component<Props, State> {\n                 </label>\n               )}\n           </React.Fragment>}\n+          {this.props.displayMicroarrayOptions && this.state.kernelType === KernelTypeEnum.Python &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4MTg3NQ=="}, "originalCommit": {"oid": "4963aaf0f5d2a9911bb4128fca62590494ef50d1"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDk2MDg1MQ==", "bodyText": "good find. fixed!", "url": "https://github.com/all-of-us/workbench/pull/4200#discussion_r510960851", "createdAt": "2020-10-23T15:23:59Z", "author": {"login": "ericsong"}, "path": "ui/src/app/pages/data/data-set/new-dataset-modal.tsx", "diffHunk": "@@ -339,6 +351,42 @@ class NewDataSetModal extends React.Component<Props, State> {\n                 </label>\n               )}\n           </React.Fragment>}\n+          {this.props.displayMicroarrayOptions && this.state.kernelType === KernelTypeEnum.Python &&", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQ4MTg3NQ=="}, "originalCommit": {"oid": "4963aaf0f5d2a9911bb4128fca62590494ef50d1"}, "originalPosition": 95}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3878, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}