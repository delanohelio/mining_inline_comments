{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0ODIzMzg0", "number": 3557, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxODo1NDozNVrOD6vlQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMjowMjo1MlrOD60seA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyOTIzNTg2OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxODo1NDozNVrOGSv-lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxODo1NDozNVrOGSv-lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMxMzYyMA==", "bodyText": "null-safe check, so it prevents addition and removal as well as updates", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r422313620", "createdAt": "2020-05-08T18:54:35Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -309,14 +318,12 @@ private void validateUpdatedProfile(Profile updatedProfile, Profile prevProfile)\n       // See RW-1488.\n       throw new BadRequestException(\"Changing username is not supported\");\n     }\n-    if (updatedProfile.getVerifiedInstitutionalAffiliation() != null\n-        && !updatedProfile\n-            .getVerifiedInstitutionalAffiliation()\n-            .getInstitutionDisplayName()\n-            .equals(\n-                prevProfile.getVerifiedInstitutionalAffiliation().getInstitutionDisplayName())) {\n-      // See RW-1488.\n-      throw new BadRequestException(\"Changing institution is not currently supported\");\n+    final VerifiedInstitutionalAffiliation updatedAffil =\n+        updatedProfile.getVerifiedInstitutionalAffiliation();\n+    final VerifiedInstitutionalAffiliation prevAffil =\n+        prevProfile.getVerifiedInstitutionalAffiliation();\n+    if (!Objects.equals(updatedAffil, prevAffil)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c45a388ec8458d739a0378fefcb7872735607ed"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyOTI0MDI0OnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/profile/profile-page.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxODo1NjowMFrOGSwBVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOFQxODo1NjowMFrOGSwBVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjMxNDMyNg==", "bodyText": "keeping the message here because it's a sign something has gone wrong if a real user sees it", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r422314326", "createdAt": "2020-05-08T18:56:00Z", "author": {"login": "jmthibault79"}, "path": "ui/src/app/pages/profile/profile-page.tsx", "diffHunk": "@@ -346,27 +338,30 @@ export const ProfilePage = withUserProfile()(class extends React.Component<\n                   valueKey: 'verifiedInstitutionalAffiliation.institutionDisplayName',\n                   disabled: true\n                 })}\n-                {!profile.verifiedInstitutionalAffiliation && <div style={{color: colors.danger}}>\n-                  Institution cannot be empty. Please contact admin\n-                </div>}\n+                {requireInstitutionalVerification && !profile.verifiedInstitutionalAffiliation &&\n+                  <div style={{color: colors.danger}}>\n+                    Institution cannot be empty. Please contact admin.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c45a388ec8458d739a0378fefcb7872735607ed"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMDA2NjcxOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMTo1MToyOVrOGS3rFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMTo1MToyOVrOGS3rFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQzOTcwMw==", "bodyText": "nit: please adopt consistent formatting with names for other tests in this file: _changeForbidden would seem best.", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r422439703", "createdAt": "2020-05-09T01:51:29Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -756,6 +756,63 @@ public void testMe_verifiedInstitutionalAffiliation_invalidEmail() {\n     createUser();\n   }\n \n+  @Test(expected = BadRequestException.class)\n+  public void updateVerifiedInstitutionalAffiliation_change_forbidden() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c45a388ec8458d739a0378fefcb7872735607ed"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMDA3MTgxOnYy", "diffSide": "LEFT", "path": "api/src/main/java/org/pmiops/workbench/db/dao/UserServiceImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMjowMDoxNlrOGS3txw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNToxNjo0OVrOGULxaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MDM5MQ==", "bodyText": "I suspect we'll eventually need to rewrite logic very similar to this when we build out API support for admins to change a user's institutional affiliation \u2013 but it's not too much code, and may well be better placed somewhere else for that purpose anyway.", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r422440391", "createdAt": "2020-05-09T02:00:16Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/db/dao/UserServiceImpl.java", "diffHunk": "@@ -412,29 +411,12 @@ public DbUser createUser(\n    * dbExistingVerifiedInstitutionalAffiliation and update it with Institution role and other text\n    *\n    * @param dbUser\n-   * @param dbVerifiedAffiliation\n    * @return\n    */\n   @Override\n-  public DbUser updateUserWithConflictHandling(\n-      DbUser dbUser, DbVerifiedInstitutionalAffiliation dbVerifiedAffiliation) {\n+  public DbUser updateUserWithConflictHandling(DbUser dbUser) {\n     try {\n       dbUser = userDao.save(dbUser);\n-      boolean requireInstitutionalVerification =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c45a388ec8458d739a0378fefcb7872735607ed"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgxNzU3OQ==", "bodyText": "agreed", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r423817579", "createdAt": "2020-05-12T15:16:49Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/db/dao/UserServiceImpl.java", "diffHunk": "@@ -412,29 +411,12 @@ public DbUser createUser(\n    * dbExistingVerifiedInstitutionalAffiliation and update it with Institution role and other text\n    *\n    * @param dbUser\n-   * @param dbVerifiedAffiliation\n    * @return\n    */\n   @Override\n-  public DbUser updateUserWithConflictHandling(\n-      DbUser dbUser, DbVerifiedInstitutionalAffiliation dbVerifiedAffiliation) {\n+  public DbUser updateUserWithConflictHandling(DbUser dbUser) {\n     try {\n       dbUser = userDao.save(dbUser);\n-      boolean requireInstitutionalVerification =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MDM5MQ=="}, "originalCommit": {"oid": "8c45a388ec8458d739a0378fefcb7872735607ed"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzMDA3MzUyOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wOVQwMjowMjo1MlrOGS3urw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNToxNzozNVrOGULzlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MDYyMw==", "bodyText": "nit: this assertion (also repeated in the 'delete' test below) seems tangential to this test's purpose, and possibly redundant. Do we lose much by removing it?", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r422440623", "createdAt": "2020-05-09T02:02:52Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -756,6 +756,63 @@ public void testMe_verifiedInstitutionalAffiliation_invalidEmail() {\n     createUser();\n   }\n \n+  @Test(expected = BadRequestException.class)\n+  public void updateVerifiedInstitutionalAffiliation_change_forbidden() {\n+    config.featureFlags.requireInstitutionalVerification = true;\n+\n+    final VerifiedInstitutionalAffiliation original = createVerifiedInstitutionalAffiliation();\n+\n+    createAccountRequest.getProfile().setVerifiedInstitutionalAffiliation(original);\n+\n+    createUser();\n+\n+    Profile profile = profileController.getMe().getBody();\n+    assertThat(profile.getVerifiedInstitutionalAffiliation()).isEqualTo(original);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c45a388ec8458d739a0378fefcb7872735607ed"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzgxODEzMw==", "bodyText": "this is a leftover from a previous version - I can remove", "url": "https://github.com/all-of-us/workbench/pull/3557#discussion_r423818133", "createdAt": "2020-05-12T15:17:35Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -756,6 +756,63 @@ public void testMe_verifiedInstitutionalAffiliation_invalidEmail() {\n     createUser();\n   }\n \n+  @Test(expected = BadRequestException.class)\n+  public void updateVerifiedInstitutionalAffiliation_change_forbidden() {\n+    config.featureFlags.requireInstitutionalVerification = true;\n+\n+    final VerifiedInstitutionalAffiliation original = createVerifiedInstitutionalAffiliation();\n+\n+    createAccountRequest.getProfile().setVerifiedInstitutionalAffiliation(original);\n+\n+    createUser();\n+\n+    Profile profile = profileController.getMe().getBody();\n+    assertThat(profile.getVerifiedInstitutionalAffiliation()).isEqualTo(original);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjQ0MDYyMw=="}, "originalCommit": {"oid": "8c45a388ec8458d739a0378fefcb7872735607ed"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2896, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}