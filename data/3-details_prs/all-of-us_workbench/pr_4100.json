{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NTI0MTAy", "number": 4100, "title": "Enable editing in runtime panel and update machine config", "bodyText": "Description:\nExplored using a hook to resolve the issue we are facing. The useRuntime hook will allow a component to get the state of the runtime, re-render on state changes and set a new runtime. All components using the hook should sync up with the same state.\nThis doesn't solve the issue where another component is not using the hook and is using the LeoRuntimeInitializer directly.\nBut we can convert the components that are doing that if we want to use this approach.\nIf we take this approach we could potentially move all of the LeoRuntimeInitializer functionality (incrementally) into the hook/file utilizing more functional state management which may simplify the initializer.\n\nMerged with Ariel's PR (very few modifications were needed).\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test-local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-10-01T20:20:49Z", "url": "https://github.com/all-of-us/workbench/pull/4100", "merged": true, "mergeCommit": {"oid": "841189f3c5885c4a9e103fd29895b0c1417d640c"}, "closed": true, "closedAt": "2020-10-13T12:23:22Z", "author": {"login": "petesantos"}, "timelineItems": {"totalCount": 35, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNzSwpAH2gAyNDk2NTI0MTAyOmMyMjAyN2ZmNmFkZjVhNjZmMjg2YmZmYzQ1MTI3Yzk2MjAyNTU2MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQ-MO9AFqTUwNjAyNjQ1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c22027ff6adf5a66f286bffc45127c9620255620", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/c22027ff6adf5a66f286bffc45127c9620255620", "committedDate": "2020-09-30T02:23:54Z", "message": "Enable changing cpu and memory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cf4914bc6bd4420d6fefd757108ecc96457275b", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/6cf4914bc6bd4420d6fefd757108ecc96457275b", "committedDate": "2020-10-01T20:12:43Z", "message": "Update runtime working"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88adad2328eed5030435b85511fb54f3283719c4", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/88adad2328eed5030435b85511fb54f3283719c4", "committedDate": "2020-10-01T20:19:15Z", "message": "Better default value for th e runtime store"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98c1794438a5a0c60afc2e7e1247861869a37107", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/98c1794438a5a0c60afc2e7e1247861869a37107", "committedDate": "2020-10-01T21:22:03Z", "message": "Clean up abort signal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNzI0NjMx", "url": "https://github.com/all-of-us/workbench/pull/4100#pullrequestreview-500724631", "createdAt": "2020-10-01T21:16:30Z", "commit": {"oid": "88adad2328eed5030435b85511fb54f3283719c4"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMToxNjozMFrOHbbGfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQyMTo1NjoyOFrOHbcCiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUxNzYyOQ==", "bodyText": "THe machine type names here are provided by GCP and the corresponding resource usage is defined by GCP. They should never change what they correspond to in terms of resources, i.e. n1-standard-4 is always 4CPU, 15GB. Not sure if this is what you were asking about here.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498517629", "createdAt": "2020-10-01T21:16:30Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -79,178 +87,227 @@ interface State {\n   // The runtime. null if none exists, or if there was an error in loading the\n   // runtime.\n   runtime: Runtime|null;\n+  // machine: Machine;\n+  selectedDiskSize: number;\n+  selectedMachine: Machine;\n }\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+ const MachineSelector = ({onChange, selectedMachine, runtime}) => {\n+  const {dataprocConfig, gceConfig} = runtime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType\n+  // What happens when a config changes? If the user chooses 4 cpus, but that that machine type is changed to 6 cpus? Can this happen?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88adad2328eed5030435b85511fb54f3283719c4"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUyMTgyOQ==", "bodyText": "I would probably generalize this to Runtime, we'll almost immediately want this after you rebase (where I've added conditional support for GCE instead), there's a default value you can grab from a helper file that I added: see runtimePresets.\nFor the purposes of this utility, I would also name this more specifically. The semantics of passing this option are a bit tricky. createRuntimePayload, runtimeToCreate, targetRuntime, runtimeToCreate, runtimeTemplate. We should also spell out whether this is a config that might be used (if the initializer needs to create), or if it's explicitly the goal of the initializer to reach the provided config state  - as currently written it's the former.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498521829", "createdAt": "2020-10-01T21:27:21Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/leo-runtime-initializer.tsx", "diffHunk": "@@ -92,7 +95,8 @@ const DEFAULT_OPTIONS: Partial<LeoRuntimeInitializerOptions> = {\n   maxCreateCount: DEFAULT_MAX_CREATE_COUNT,\n   maxDeleteCount: DEFAULT_MAX_DELETE_COUNT,\n   maxResumeCount: DEFAULT_MAX_RESUME_COUNT,\n-  maxServerErrorCount: DEFAULT_MAX_SERVER_ERROR_COUNT\n+  maxServerErrorCount: DEFAULT_MAX_SERVER_ERROR_COUNT,\n+  dataprocConfig: DEFAULT_DATAPROC_CONFIG", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98c1794438a5a0c60afc2e7e1247861869a37107"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUyNzA5NQ==", "bodyText": "I'm still concerned about subtle bugs here as a result of multiple initializers running concurrently. I think this is probably fine for now, but let me know if you have thoughts about how to centralize the management of this store more cleanly. In Angular, we would have used a singleton service to achieve this.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498527095", "createdAt": "2020-10-01T21:40:39Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/leo-runtime-initializer.tsx", "diffHunk": "@@ -309,61 +308,61 @@ export class LeoRuntimeInitializer {\n     if (this.pollAbortSignal && this.pollAbortSignal.aborted) {\n       // We'll bail out early if an abort signal was triggered while waiting for the poll cycle.\n       return this.reject(\n-        new LeoRuntimeInitializationFailedError('Request was aborted', this.currentRuntime));\n+        new LeoRuntimeInitializationFailedError('Request was aborted', currentRuntimeStore.get()));\n     }\n     if (Date.now() - this.initializeStartTime > this.overallTimeout) {\n       return this.reject(\n         new LeoRuntimeInitializationFailedError(\n           `Initialization attempt took longer than the max time allowed (${this.overallTimeout}ms)`,\n-          this.currentRuntime));\n+          currentRuntimeStore.get()));\n     }\n \n     // Fetch the current runtime status, with some graceful error handling for NOT_FOUND response\n     // and abort signals.\n     try {\n-      this.currentRuntime = await this.getRuntime();\n-      this.onStatusUpdate(this.currentRuntime.status);\n+      currentRuntimeStore.set(await this.getRuntime());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98c1794438a5a0c60afc2e7e1247861869a37107"}, "originalPosition": 144}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUyNzMwMQ==", "bodyText": "Runtime?", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498527301", "createdAt": "2020-10-01T21:41:07Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/stores.tsx", "diffHunk": "@@ -70,6 +70,9 @@ export const abortRuntimeOperationForWorkspace = (workspaceNamespace: string) =>\n   }\n };\n \n+\n+export const currentRuntimeStore = atom<any>({});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98c1794438a5a0c60afc2e7e1247861869a37107"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUyODIwMg==", "bodyText": "Noting as a reminder: per slack thread, I suggest having a tooltip here which gets displayed while this is disabled, explaining why.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498528202", "createdAt": "2020-10-01T21:43:26Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -79,178 +86,226 @@ interface State {\n   // The runtime. null if none exists, or if there was an error in loading the\n   // runtime.\n   runtime: Runtime|null;\n+  // machine: Machine;\n+  selectedDiskSize: number;\n+  selectedMachine: Machine;\n }\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+ const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType\n+  // What happens when a config changes? If the user chooses 4 cpus, but that that machine type is changed to 6 cpus? Can this happen?\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;  \n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = selectedMachine => fp.equals(selectedMachine, initialMachineType) ? null : selectedMachine;\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]), \n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={ \n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'), \n+                    fp.find({cpu: value}), \n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes) \n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={ \n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}), \n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>\n+}\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n-      try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n-          promise: promise,\n-          operation: 'get',\n-          aborter: this.aborter\n-        });\n-        runtime = await promise;\n-      } catch (e) {\n-        // 404 is expected if the runtime doesn't exist, represent this as a null\n-        // runtime rather than an error mode.\n-        if (e.status !== 404) {\n-          error = true;\n-        }\n-      }\n-      markRuntimeOperationCompleteForWorkspace(this.props.workspace.namespace);\n-      this.setState({\n-        runtime,\n-        error,\n-        loading: false\n-      });\n-    }\n+const DiskSizeSelection = ({onChange, selectedDiskSize, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize\n \n-    render() {\n-      const {runtimeOps, workspace} = this.props;\n-      const {loading, error, runtime} = this.state;\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                //  disabled={true}\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={selectedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>\n+}\n \n-      const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+const updateRuntime = async ({workspaceNamespace, currentRuntime, selectedDiskSize, selectedMachine}) => {\n+  const {dataprocConfig: {masterDiskSize, masterMachineType}} = currentRuntime;\n+  const nextMachineType = selectedMachine && selectedMachine.name;\n+  const pollAbortSignal = new AbortController();\n \n-      if (loading) {\n-        return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n-      } else if (error) {\n-        return <div>Error loading compute configuration</div>;\n-      } else if (!runtime) {\n-        // TODO(RW-5591): Create runtime page goes here.\n-        return <React.Fragment>\n-          <div>No runtime exists yet</div>\n-          {activeRuntimeOp && <hr/>}\n-          {activeRuntimeOp && <div>\n-            <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n-          </div>}\n-        </React.Fragment>;\n-      }\n+  await runtimeApi().deleteRuntime(workspaceNamespace);\n+\n+  await LeoRuntimeInitializer.initialize({\n+    workspaceNamespace,\n+    dataprocConfig: {\n+      masterMachineType: nextMachineType || masterMachineType,\n+      masterDiskSize: selectedDiskSize || masterDiskSize\n+    },\n+    pollAbortSignal: pollAbortSignal.signal,\n+    onStatusUpdate: status => status === 'Running' && pollAbortSignal.abort()\n+  });\n+}\n \n-      const isDataproc = !!runtime.dataprocConfig;\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n+  const [loading, setLoading] = useState(true);\n+  const [error, setError] = useState(false);\n+  const [selectedDiskSize, setSelectedDiskSize] = useState(null);\n+  const [selectedMachine, setselectedMachine] = useState(null);\n+  const runtimeOps = useStore(runtimeOpsStore);\n+  const currentRuntime = useStore(currentRuntimeStore);\n+  const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+  const {status = null } = currentRuntime || {};\n \n-      let masterMachineName;\n-      let masterDiskSize;\n-      if (isDataproc) {\n-        masterMachineName = runtime.dataprocConfig.masterMachineType;\n-        masterDiskSize = runtime.dataprocConfig.masterDiskSize;\n-      } else {\n-        masterMachineName = runtime.gceConfig.machineType;\n-        masterDiskSize = runtime.gceConfig.bootDiskSize;\n+  // How do we reflect the state of the runtime to the user?\n+  // How should we handle errors?\n+\n+  useEffect(() => {\n+      const aborter = new AbortController();\n+      const {namespace} = workspace;\n+      const loadRuntime = async () => {\n+        // TODO(RW-5420): Centralize a runtimeStore.\n+        try {\n+          const promise = runtimeApi().getRuntime(namespace, {signal: aborter.signal});\n+          updateRuntimeOpsStoreForWorkspaceNamespace(namespace, {\n+            promise: promise,\n+            operation: 'get',\n+            aborter: aborter\n+          });\n+          currentRuntimeStore.set(await promise);\n+        } catch (e) {\n+          // 404 is expected if the runtime doesn't exist, represent this as a null\n+          // runtime rather than an error mode.\n+          if (e.status !== 404) {\n+            setError(true);\n+          }\n+        } finally {\n+          setLoading(false);\n+        }\n+        markRuntimeOperationCompleteForWorkspace(namespace);\n       }\n-      const machineType = allMachineTypes.find(({name}) => name === masterMachineName) || defaultMachineType;\n \n-      return <div data-test-id='runtime-panel'>\n-        <h3 style={styles.sectionHeader}>Cloud analysis environment</h3>\n-        <div>\n-          Your analysis environment consists of an application and compute resources.\n-          Your cloud environment is unique to this workspace and not shared with other users.\n-        </div>\n-        {/* TODO(RW-5419): Cost estimates go here. */}\n-        <div style={styles.controlSection}>\n-          {/* Recommended runtime: pick from default templates or change the image. */}\n-          <PopupTrigger side='bottom'\n-                        closeOnClick\n-                        content={\n-                          <React.Fragment>\n-                            <MenuItem style={styles.presetMenuItem}>General purpose analysis</MenuItem>\n-                            <MenuItem style={styles.presetMenuItem}>Genomics analysis</MenuItem>\n-                          </React.Fragment>\n-                        }>\n-            <Clickable data-test-id='runtime-presets-menu'\n-                       disabled={true}>\n-              Recommended environments <ClrIcon shape='caret down'/>\n-            </Clickable>\n-          </PopupTrigger>\n-          <h3 style={styles.sectionHeader}>Application configuration</h3>\n-          {/* TODO(RW-5413): Populate the image list with server driven options. */}\n-          <Dropdown style={{width: '100%'}}\n-                    data-test-id='runtime-image-dropdown'\n-                    disabled={true}\n-                    options={[runtime.toolDockerImage]}\n-                    value={runtime.toolDockerImage}/>\n-          {/* Runtime customization: change detailed machine configuration options. */}\n-          <h3 style={styles.sectionHeader}>Cloud compute profile</h3>\n-          <FlexRow style={{justifyContent: 'space-between'}}>\n-            <div>\n-              <label htmlFor='runtime-cpu'\n-                     style={{marginRight: '.25rem'}}>CPUs</label>\n-              <Dropdown id='runtime-cpu'\n-                        disabled={true}\n-                        options={fp.flow(\n-                          // Show all CPU options.\n-                          fp.map('cpu'),\n-                          // In the event that was remove a machine type from our set of valid\n-                          // configs, we want to continue to allow rendering of the value here.\n-                          // Union also makes the CPU values unique.\n-                          fp.union([machineType.cpu]),\n-                          fp.sortBy(fp.identity)\n-                        )(validLeonardoMachineTypes)}\n-                        value={machineType.cpu}/>\n-            </div>\n-            <div>\n-              <label htmlFor='runtime-ram'\n-                     style={{marginRight: '.25rem'}}>RAM (GB)</label>\n-              <Dropdown id='runtime-ram'\n-                        disabled={true}\n-                        options={fp.flow(\n-                          // Show valid memory options as constrained by the currently selected CPU.\n-                          fp.filter(({cpu}) => cpu === machineType.cpu),\n-                          fp.map('memory'),\n-                          // See above comment on CPU union.\n-                          fp.union([machineType.memory]),\n-                          fp.sortBy(fp.identity)\n-                        )(validLeonardoMachineTypes)}\n-                        value={machineType.memory}/>\n-            </div>\n-            <div>\n-              <label htmlFor='runtime-disk'\n-                     style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-              <InputNumber id='runtime-disk'\n-                           disabled={true}\n-                           showButtons\n-                           decrementButtonClassName='p-button-secondary'\n-                           incrementButtonClassName='p-button-secondary'\n-                           value={masterDiskSize}\n-                           inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                           min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-            </div>\n-          </FlexRow>\n-          <FlexColumn style={{marginTop: '1rem'}}>\n-            <label htmlFor='runtime-compute'>Compute type</label>\n-            <Dropdown id='runtime-compute'\n-                      style={{width: '10rem'}}\n-                      disabled={true}\n-                      options={['Dataproc cluster', 'Standard VM']}\n-                      value={isDataproc ? 'Dataproc cluster' : 'Standard VM'}/>\n-          </FlexColumn>\n-        </div>\n-        <FlexRow style={{justifyContent: 'flex-end', marginTop: '.75rem'}}>\n-          <Button disabled={true}>Create</Button>\n-        </FlexRow>\n-        {activeRuntimeOp && <React.Fragment>\n-          <hr/>\n-          <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n-        </React.Fragment>}\n-      </div>;\n-    }\n+      loadRuntime()\n+      return () => aborter.abort();\n+  }, []);\n \n-    componentWillUnmount() {\n-      this.aborter.abort();\n-    }\n-  });\n+  if (loading) {\n+    return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n+  } else if (error) {\n+    return <div>Error loading compute configuration</div>;\n+  } else if (!currentRuntime) {\n+    // TODO(RW-5591): Create runtime page goes here.\n+    return <React.Fragment>\n+      <div>No runtime exists yet</div>\n+      {activeRuntimeOp && <hr/>}\n+      {activeRuntimeOp && <div>\n+        <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n+      </div>}\n+    </React.Fragment>;\n+  }\n+\n+  const isDataproc = (currentRuntime && !!currentRuntime.dataprocConfig);\n+  const runtimeChanged = selectedMachine || selectedDiskSize;\n+\n+  console.log('Status:', currentRuntime, status);\n+  return <div data-test-id='runtime-panel'>\n+    <h3 style={styles.sectionHeader}>Cloud analysis environment</h3>\n+    <div>\n+      Your analysis environment consists of an application and compute resources.\n+      Your cloud environment is unique to this workspace and not shared with other users.\n+    </div>\n+    {/* TODO(RW-5419): Cost estimates go here. */}\n+    <div style={styles.controlSection}>\n+      {/* Recommended runtime: pick from default templates or change the image. */}\n+      <PopupTrigger side='bottom'\n+                    closeOnClick\n+                    content={\n+                      <React.Fragment>\n+                        <MenuItem style={styles.presetMenuItem}>General purpose analysis</MenuItem>\n+                        <MenuItem style={styles.presetMenuItem}>Genomics analysis</MenuItem>\n+                      </React.Fragment>\n+                    }>\n+        <Clickable data-test-id='runtime-presets-menu'\n+                   disabled={true}>\n+          Recommended environments <ClrIcon shape='caret down'/>\n+        </Clickable>\n+      </PopupTrigger>\n+      <h3 style={styles.sectionHeader}>Application configuration</h3>\n+      {/* TODO(RW-5413): Populate the image list with server driven options. */}\n+      <Dropdown style={{width: '100%'}}\n+                data-test-id='runtime-image-dropdown'\n+                disabled={true}\n+                options={[currentRuntime.toolDockerImage]}\n+                value={currentRuntime.toolDockerImage}/>\n+      {/* Runtime customization: change detailed machine configuration options. */}  \n+      <h3 style={styles.sectionHeader}>Cloud compute profile</h3>\n+      <FlexRow style={{justifyContent: 'space-between'}}>\n+        <MachineSelector selectedMachine={selectedMachine} onChange={setselectedMachine} currentRuntime={currentRuntime}/>\n+        <DiskSizeSelection selectedDiskSize={selectedDiskSize} onChange={setSelectedDiskSize} currentRuntime={currentRuntime}/>\n+      </FlexRow>\n+      <FlexColumn style={{marginTop: '1rem'}}>\n+        <label htmlFor='runtime-compute'>Compute type</label>\n+        <Dropdown id='runtime-compute'\n+                  style={{width: '10rem'}}\n+                  disabled={true}\n+                  options={['Dataproc cluster', 'Standard VM']}\n+                  value={isDataproc ? 'Dataproc cluster' : 'Standard VM'}/>\n+      </FlexColumn>\n+    </div>\n+    <FlexRow style={{justifyContent: 'flex-end', marginTop: '.75rem'}}>\n+      <Button \n+        disabled={status !== 'Running' || !runtimeChanged}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98c1794438a5a0c60afc2e7e1247861869a37107"}, "originalPosition": 408}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUzMDUxMw==", "bodyText": "The aborter is not for us to manually abort the intializer on completion. Rather, the aborter should be maintained by this panel component and aborted if it gets dismounted (which should be accounted for somewhere here), thereby avoiding having this continue running in the background after we've gone elsewhere (e.g. switched to a different workspace in the app).\nThe initializer will already finish once it reaches a terminal state, i.e. running (or it fails to do so and throws an error).", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498530513", "createdAt": "2020-10-01T21:49:34Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -79,178 +86,226 @@ interface State {\n   // The runtime. null if none exists, or if there was an error in loading the\n   // runtime.\n   runtime: Runtime|null;\n+  // machine: Machine;\n+  selectedDiskSize: number;\n+  selectedMachine: Machine;\n }\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+ const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType\n+  // What happens when a config changes? If the user chooses 4 cpus, but that that machine type is changed to 6 cpus? Can this happen?\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;  \n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = selectedMachine => fp.equals(selectedMachine, initialMachineType) ? null : selectedMachine;\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]), \n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={ \n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'), \n+                    fp.find({cpu: value}), \n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes) \n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={ \n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}), \n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>\n+}\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n-      try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n-          promise: promise,\n-          operation: 'get',\n-          aborter: this.aborter\n-        });\n-        runtime = await promise;\n-      } catch (e) {\n-        // 404 is expected if the runtime doesn't exist, represent this as a null\n-        // runtime rather than an error mode.\n-        if (e.status !== 404) {\n-          error = true;\n-        }\n-      }\n-      markRuntimeOperationCompleteForWorkspace(this.props.workspace.namespace);\n-      this.setState({\n-        runtime,\n-        error,\n-        loading: false\n-      });\n-    }\n+const DiskSizeSelection = ({onChange, selectedDiskSize, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize\n \n-    render() {\n-      const {runtimeOps, workspace} = this.props;\n-      const {loading, error, runtime} = this.state;\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                //  disabled={true}\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={selectedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>\n+}\n \n-      const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+const updateRuntime = async ({workspaceNamespace, currentRuntime, selectedDiskSize, selectedMachine}) => {\n+  const {dataprocConfig: {masterDiskSize, masterMachineType}} = currentRuntime;\n+  const nextMachineType = selectedMachine && selectedMachine.name;\n+  const pollAbortSignal = new AbortController();\n \n-      if (loading) {\n-        return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n-      } else if (error) {\n-        return <div>Error loading compute configuration</div>;\n-      } else if (!runtime) {\n-        // TODO(RW-5591): Create runtime page goes here.\n-        return <React.Fragment>\n-          <div>No runtime exists yet</div>\n-          {activeRuntimeOp && <hr/>}\n-          {activeRuntimeOp && <div>\n-            <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n-          </div>}\n-        </React.Fragment>;\n-      }\n+  await runtimeApi().deleteRuntime(workspaceNamespace);\n+\n+  await LeoRuntimeInitializer.initialize({\n+    workspaceNamespace,\n+    dataprocConfig: {\n+      masterMachineType: nextMachineType || masterMachineType,\n+      masterDiskSize: selectedDiskSize || masterDiskSize\n+    },\n+    pollAbortSignal: pollAbortSignal.signal,\n+    onStatusUpdate: status => status === 'Running' && pollAbortSignal.abort()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98c1794438a5a0c60afc2e7e1247861869a37107"}, "originalPosition": 189}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUzMjA5OQ==", "bodyText": "SHould be a comment somewhere that this onChange dispatches null if the user selects the original runtime setting.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498532099", "createdAt": "2020-10-01T21:53:53Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -79,178 +86,226 @@ interface State {\n   // The runtime. null if none exists, or if there was an error in loading the\n   // runtime.\n   runtime: Runtime|null;\n+  // machine: Machine;\n+  selectedDiskSize: number;\n+  selectedMachine: Machine;\n }\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+ const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType\n+  // What happens when a config changes? If the user chooses 4 cpus, but that that machine type is changed to 6 cpus? Can this happen?\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;  \n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = selectedMachine => fp.equals(selectedMachine, initialMachineType) ? null : selectedMachine;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98c1794438a5a0c60afc2e7e1247861869a37107"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODUzMzAwMQ==", "bodyText": "RuntimeStatus.Running", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498533001", "createdAt": "2020-10-01T21:56:28Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -79,178 +86,226 @@ interface State {\n   // The runtime. null if none exists, or if there was an error in loading the\n   // runtime.\n   runtime: Runtime|null;\n+  // machine: Machine;\n+  selectedDiskSize: number;\n+  selectedMachine: Machine;\n }\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+ const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType\n+  // What happens when a config changes? If the user chooses 4 cpus, but that that machine type is changed to 6 cpus? Can this happen?\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;  \n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = selectedMachine => fp.equals(selectedMachine, initialMachineType) ? null : selectedMachine;\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]), \n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={ \n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'), \n+                    fp.find({cpu: value}), \n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes) \n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={ \n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}), \n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>\n+}\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n-      try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n-          promise: promise,\n-          operation: 'get',\n-          aborter: this.aborter\n-        });\n-        runtime = await promise;\n-      } catch (e) {\n-        // 404 is expected if the runtime doesn't exist, represent this as a null\n-        // runtime rather than an error mode.\n-        if (e.status !== 404) {\n-          error = true;\n-        }\n-      }\n-      markRuntimeOperationCompleteForWorkspace(this.props.workspace.namespace);\n-      this.setState({\n-        runtime,\n-        error,\n-        loading: false\n-      });\n-    }\n+const DiskSizeSelection = ({onChange, selectedDiskSize, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize\n \n-    render() {\n-      const {runtimeOps, workspace} = this.props;\n-      const {loading, error, runtime} = this.state;\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                //  disabled={true}\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={selectedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>\n+}\n \n-      const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+const updateRuntime = async ({workspaceNamespace, currentRuntime, selectedDiskSize, selectedMachine}) => {\n+  const {dataprocConfig: {masterDiskSize, masterMachineType}} = currentRuntime;\n+  const nextMachineType = selectedMachine && selectedMachine.name;\n+  const pollAbortSignal = new AbortController();\n \n-      if (loading) {\n-        return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n-      } else if (error) {\n-        return <div>Error loading compute configuration</div>;\n-      } else if (!runtime) {\n-        // TODO(RW-5591): Create runtime page goes here.\n-        return <React.Fragment>\n-          <div>No runtime exists yet</div>\n-          {activeRuntimeOp && <hr/>}\n-          {activeRuntimeOp && <div>\n-            <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n-          </div>}\n-        </React.Fragment>;\n-      }\n+  await runtimeApi().deleteRuntime(workspaceNamespace);\n+\n+  await LeoRuntimeInitializer.initialize({\n+    workspaceNamespace,\n+    dataprocConfig: {\n+      masterMachineType: nextMachineType || masterMachineType,\n+      masterDiskSize: selectedDiskSize || masterDiskSize\n+    },\n+    pollAbortSignal: pollAbortSignal.signal,\n+    onStatusUpdate: status => status === 'Running' && pollAbortSignal.abort()\n+  });\n+}\n \n-      const isDataproc = !!runtime.dataprocConfig;\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n+  const [loading, setLoading] = useState(true);\n+  const [error, setError] = useState(false);\n+  const [selectedDiskSize, setSelectedDiskSize] = useState(null);\n+  const [selectedMachine, setselectedMachine] = useState(null);\n+  const runtimeOps = useStore(runtimeOpsStore);\n+  const currentRuntime = useStore(currentRuntimeStore);\n+  const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+  const {status = null } = currentRuntime || {};\n \n-      let masterMachineName;\n-      let masterDiskSize;\n-      if (isDataproc) {\n-        masterMachineName = runtime.dataprocConfig.masterMachineType;\n-        masterDiskSize = runtime.dataprocConfig.masterDiskSize;\n-      } else {\n-        masterMachineName = runtime.gceConfig.machineType;\n-        masterDiskSize = runtime.gceConfig.bootDiskSize;\n+  // How do we reflect the state of the runtime to the user?\n+  // How should we handle errors?\n+\n+  useEffect(() => {\n+      const aborter = new AbortController();\n+      const {namespace} = workspace;\n+      const loadRuntime = async () => {\n+        // TODO(RW-5420): Centralize a runtimeStore.\n+        try {\n+          const promise = runtimeApi().getRuntime(namespace, {signal: aborter.signal});\n+          updateRuntimeOpsStoreForWorkspaceNamespace(namespace, {\n+            promise: promise,\n+            operation: 'get',\n+            aborter: aborter\n+          });\n+          currentRuntimeStore.set(await promise);\n+        } catch (e) {\n+          // 404 is expected if the runtime doesn't exist, represent this as a null\n+          // runtime rather than an error mode.\n+          if (e.status !== 404) {\n+            setError(true);\n+          }\n+        } finally {\n+          setLoading(false);\n+        }\n+        markRuntimeOperationCompleteForWorkspace(namespace);\n       }\n-      const machineType = allMachineTypes.find(({name}) => name === masterMachineName) || defaultMachineType;\n \n-      return <div data-test-id='runtime-panel'>\n-        <h3 style={styles.sectionHeader}>Cloud analysis environment</h3>\n-        <div>\n-          Your analysis environment consists of an application and compute resources.\n-          Your cloud environment is unique to this workspace and not shared with other users.\n-        </div>\n-        {/* TODO(RW-5419): Cost estimates go here. */}\n-        <div style={styles.controlSection}>\n-          {/* Recommended runtime: pick from default templates or change the image. */}\n-          <PopupTrigger side='bottom'\n-                        closeOnClick\n-                        content={\n-                          <React.Fragment>\n-                            <MenuItem style={styles.presetMenuItem}>General purpose analysis</MenuItem>\n-                            <MenuItem style={styles.presetMenuItem}>Genomics analysis</MenuItem>\n-                          </React.Fragment>\n-                        }>\n-            <Clickable data-test-id='runtime-presets-menu'\n-                       disabled={true}>\n-              Recommended environments <ClrIcon shape='caret down'/>\n-            </Clickable>\n-          </PopupTrigger>\n-          <h3 style={styles.sectionHeader}>Application configuration</h3>\n-          {/* TODO(RW-5413): Populate the image list with server driven options. */}\n-          <Dropdown style={{width: '100%'}}\n-                    data-test-id='runtime-image-dropdown'\n-                    disabled={true}\n-                    options={[runtime.toolDockerImage]}\n-                    value={runtime.toolDockerImage}/>\n-          {/* Runtime customization: change detailed machine configuration options. */}\n-          <h3 style={styles.sectionHeader}>Cloud compute profile</h3>\n-          <FlexRow style={{justifyContent: 'space-between'}}>\n-            <div>\n-              <label htmlFor='runtime-cpu'\n-                     style={{marginRight: '.25rem'}}>CPUs</label>\n-              <Dropdown id='runtime-cpu'\n-                        disabled={true}\n-                        options={fp.flow(\n-                          // Show all CPU options.\n-                          fp.map('cpu'),\n-                          // In the event that was remove a machine type from our set of valid\n-                          // configs, we want to continue to allow rendering of the value here.\n-                          // Union also makes the CPU values unique.\n-                          fp.union([machineType.cpu]),\n-                          fp.sortBy(fp.identity)\n-                        )(validLeonardoMachineTypes)}\n-                        value={machineType.cpu}/>\n-            </div>\n-            <div>\n-              <label htmlFor='runtime-ram'\n-                     style={{marginRight: '.25rem'}}>RAM (GB)</label>\n-              <Dropdown id='runtime-ram'\n-                        disabled={true}\n-                        options={fp.flow(\n-                          // Show valid memory options as constrained by the currently selected CPU.\n-                          fp.filter(({cpu}) => cpu === machineType.cpu),\n-                          fp.map('memory'),\n-                          // See above comment on CPU union.\n-                          fp.union([machineType.memory]),\n-                          fp.sortBy(fp.identity)\n-                        )(validLeonardoMachineTypes)}\n-                        value={machineType.memory}/>\n-            </div>\n-            <div>\n-              <label htmlFor='runtime-disk'\n-                     style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-              <InputNumber id='runtime-disk'\n-                           disabled={true}\n-                           showButtons\n-                           decrementButtonClassName='p-button-secondary'\n-                           incrementButtonClassName='p-button-secondary'\n-                           value={masterDiskSize}\n-                           inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                           min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-            </div>\n-          </FlexRow>\n-          <FlexColumn style={{marginTop: '1rem'}}>\n-            <label htmlFor='runtime-compute'>Compute type</label>\n-            <Dropdown id='runtime-compute'\n-                      style={{width: '10rem'}}\n-                      disabled={true}\n-                      options={['Dataproc cluster', 'Standard VM']}\n-                      value={isDataproc ? 'Dataproc cluster' : 'Standard VM'}/>\n-          </FlexColumn>\n-        </div>\n-        <FlexRow style={{justifyContent: 'flex-end', marginTop: '.75rem'}}>\n-          <Button disabled={true}>Create</Button>\n-        </FlexRow>\n-        {activeRuntimeOp && <React.Fragment>\n-          <hr/>\n-          <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n-        </React.Fragment>}\n-      </div>;\n-    }\n+      loadRuntime()\n+      return () => aborter.abort();\n+  }, []);\n \n-    componentWillUnmount() {\n-      this.aborter.abort();\n-    }\n-  });\n+  if (loading) {\n+    return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n+  } else if (error) {\n+    return <div>Error loading compute configuration</div>;\n+  } else if (!currentRuntime) {\n+    // TODO(RW-5591): Create runtime page goes here.\n+    return <React.Fragment>\n+      <div>No runtime exists yet</div>\n+      {activeRuntimeOp && <hr/>}\n+      {activeRuntimeOp && <div>\n+        <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n+      </div>}\n+    </React.Fragment>;\n+  }\n+\n+  const isDataproc = (currentRuntime && !!currentRuntime.dataprocConfig);\n+  const runtimeChanged = selectedMachine || selectedDiskSize;\n+\n+  console.log('Status:', currentRuntime, status);\n+  return <div data-test-id='runtime-panel'>\n+    <h3 style={styles.sectionHeader}>Cloud analysis environment</h3>\n+    <div>\n+      Your analysis environment consists of an application and compute resources.\n+      Your cloud environment is unique to this workspace and not shared with other users.\n+    </div>\n+    {/* TODO(RW-5419): Cost estimates go here. */}\n+    <div style={styles.controlSection}>\n+      {/* Recommended runtime: pick from default templates or change the image. */}\n+      <PopupTrigger side='bottom'\n+                    closeOnClick\n+                    content={\n+                      <React.Fragment>\n+                        <MenuItem style={styles.presetMenuItem}>General purpose analysis</MenuItem>\n+                        <MenuItem style={styles.presetMenuItem}>Genomics analysis</MenuItem>\n+                      </React.Fragment>\n+                    }>\n+        <Clickable data-test-id='runtime-presets-menu'\n+                   disabled={true}>\n+          Recommended environments <ClrIcon shape='caret down'/>\n+        </Clickable>\n+      </PopupTrigger>\n+      <h3 style={styles.sectionHeader}>Application configuration</h3>\n+      {/* TODO(RW-5413): Populate the image list with server driven options. */}\n+      <Dropdown style={{width: '100%'}}\n+                data-test-id='runtime-image-dropdown'\n+                disabled={true}\n+                options={[currentRuntime.toolDockerImage]}\n+                value={currentRuntime.toolDockerImage}/>\n+      {/* Runtime customization: change detailed machine configuration options. */}  \n+      <h3 style={styles.sectionHeader}>Cloud compute profile</h3>\n+      <FlexRow style={{justifyContent: 'space-between'}}>\n+        <MachineSelector selectedMachine={selectedMachine} onChange={setselectedMachine} currentRuntime={currentRuntime}/>\n+        <DiskSizeSelection selectedDiskSize={selectedDiskSize} onChange={setSelectedDiskSize} currentRuntime={currentRuntime}/>\n+      </FlexRow>\n+      <FlexColumn style={{marginTop: '1rem'}}>\n+        <label htmlFor='runtime-compute'>Compute type</label>\n+        <Dropdown id='runtime-compute'\n+                  style={{width: '10rem'}}\n+                  disabled={true}\n+                  options={['Dataproc cluster', 'Standard VM']}\n+                  value={isDataproc ? 'Dataproc cluster' : 'Standard VM'}/>\n+      </FlexColumn>\n+    </div>\n+    <FlexRow style={{justifyContent: 'flex-end', marginTop: '.75rem'}}>\n+      <Button \n+        disabled={status !== 'Running' || !runtimeChanged}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98c1794438a5a0c60afc2e7e1247861869a37107"}, "originalPosition": 408}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1321ab1e40ff546cb8213a3c267d4fee422283d1", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/1321ab1e40ff546cb8213a3c267d4fee422283d1", "committedDate": "2020-10-02T14:20:02Z", "message": "Add useRuntime hook"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d287f113ad0dcd7dfaadd7185b07ab24498599b", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/8d287f113ad0dcd7dfaadd7185b07ab24498599b", "committedDate": "2020-10-02T14:32:38Z", "message": "remove comment, add useOnMount"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0c4d36ff9cd9e1f78456d05eb5edb1c242ec7f9", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/e0c4d36ff9cd9e1f78456d05eb5edb1c242ec7f9", "committedDate": "2020-10-02T14:41:11Z", "message": "Remove logging statement"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMTg5MDY2", "url": "https://github.com/all-of-us/workbench/pull/4100#pullrequestreview-501189066", "createdAt": "2020-10-02T14:33:33Z", "commit": {"oid": "8d287f113ad0dcd7dfaadd7185b07ab24498599b"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNDozMzozM1rOHbv_2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNDo0NDoyNFrOHbwY3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg1OTk5NQ==", "bodyText": "Converted to function component", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498859995", "createdAt": "2020-10-02T14:33:33Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -79,178 +83,207 @@ interface State {\n   // The runtime. null if none exists, or if there was an error in loading the\n   // runtime.\n   runtime: Runtime|null;\n+  // machine: Machine;\n+  selectedDiskSize: number;\n+  selectedMachine: Machine;\n }\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+ const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;  \n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = selectedMachine => fp.equals(selectedMachine, initialMachineType) ? null : selectedMachine;\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]), \n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={ \n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'), \n+                    fp.find({cpu: value}), \n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes) \n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={ \n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}), \n+                    // If the selected machine is not different from the current machine return null\n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>\n+}\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n-      try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n-          promise: promise,\n-          operation: 'get',\n-          aborter: this.aborter\n-        });\n-        runtime = await promise;\n-      } catch (e) {\n-        // 404 is expected if the runtime doesn't exist, represent this as a null\n-        // runtime rather than an error mode.\n-        if (e.status !== 404) {\n-          error = true;\n-        }\n-      }\n-      markRuntimeOperationCompleteForWorkspace(this.props.workspace.namespace);\n-      this.setState({\n-        runtime,\n-        error,\n-        loading: false\n-      });\n-    }\n+const DiskSizeSelection = ({onChange, selectedDiskSize, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize\n \n-    render() {\n-      const {runtimeOps, workspace} = this.props;\n-      const {loading, error, runtime} = this.state;\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                //  disabled={true}\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={selectedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>\n+}\n+\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d287f113ad0dcd7dfaadd7185b07ab24498599b"}, "originalPosition": 158}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MjE5Mw==", "bodyText": "Usage of useRuntime.\nSupply the workspaceNamespace and recieve the currentRuntime and a setter for a new runtime.\nAny runtime updates that go through the underlying runtimeStore will trigger a render.\nIdeally all runtime changes should go through this hook. Only the LeoRuntimeInitializer this hook, and this component (I am looking to factor that out) will directly reference the store.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498862193", "createdAt": "2020-10-02T14:37:19Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -79,178 +83,207 @@ interface State {\n   // The runtime. null if none exists, or if there was an error in loading the\n   // runtime.\n   runtime: Runtime|null;\n+  // machine: Machine;\n+  selectedDiskSize: number;\n+  selectedMachine: Machine;\n }\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+ const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;  \n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = selectedMachine => fp.equals(selectedMachine, initialMachineType) ? null : selectedMachine;\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]), \n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={ \n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'), \n+                    fp.find({cpu: value}), \n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes) \n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={ \n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}), \n+                    // If the selected machine is not different from the current machine return null\n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>\n+}\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n-      try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n-          promise: promise,\n-          operation: 'get',\n-          aborter: this.aborter\n-        });\n-        runtime = await promise;\n-      } catch (e) {\n-        // 404 is expected if the runtime doesn't exist, represent this as a null\n-        // runtime rather than an error mode.\n-        if (e.status !== 404) {\n-          error = true;\n-        }\n-      }\n-      markRuntimeOperationCompleteForWorkspace(this.props.workspace.namespace);\n-      this.setState({\n-        runtime,\n-        error,\n-        loading: false\n-      });\n-    }\n+const DiskSizeSelection = ({onChange, selectedDiskSize, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize\n \n-    render() {\n-      const {runtimeOps, workspace} = this.props;\n-      const {loading, error, runtime} = this.state;\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                //  disabled={true}\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={selectedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>\n+}\n+\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n+  const [loading, setLoading] = useState(true);\n+  const [error, setError] = useState(false);\n+  const [selectedDiskSize, setSelectedDiskSize] = useState(null);\n+  const [selectedMachine, setselectedMachine] = useState(null);\n+  const runtimeOps = useStore(runtimeOpsStore);\n+  const [currentRuntime, setRequestedRuntime] = useRuntime(workspace.namespace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d287f113ad0dcd7dfaadd7185b07ab24498599b"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MjQyMQ==", "bodyText": "Setting a new runtime", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498862421", "createdAt": "2020-10-02T14:37:43Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -79,178 +83,207 @@ interface State {\n   // The runtime. null if none exists, or if there was an error in loading the\n   // runtime.\n   runtime: Runtime|null;\n+  // machine: Machine;\n+  selectedDiskSize: number;\n+  selectedMachine: Machine;\n }\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+ const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;  \n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = selectedMachine => fp.equals(selectedMachine, initialMachineType) ? null : selectedMachine;\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]), \n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={ \n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'), \n+                    fp.find({cpu: value}), \n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes) \n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={ \n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}), \n+                    // If the selected machine is not different from the current machine return null\n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>\n+}\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n-      try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n-          promise: promise,\n-          operation: 'get',\n-          aborter: this.aborter\n-        });\n-        runtime = await promise;\n-      } catch (e) {\n-        // 404 is expected if the runtime doesn't exist, represent this as a null\n-        // runtime rather than an error mode.\n-        if (e.status !== 404) {\n-          error = true;\n-        }\n-      }\n-      markRuntimeOperationCompleteForWorkspace(this.props.workspace.namespace);\n-      this.setState({\n-        runtime,\n-        error,\n-        loading: false\n-      });\n-    }\n+const DiskSizeSelection = ({onChange, selectedDiskSize, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize\n \n-    render() {\n-      const {runtimeOps, workspace} = this.props;\n-      const {loading, error, runtime} = this.state;\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                //  disabled={true}\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={selectedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>\n+}\n+\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n+  const [loading, setLoading] = useState(true);\n+  const [error, setError] = useState(false);\n+  const [selectedDiskSize, setSelectedDiskSize] = useState(null);\n+  const [selectedMachine, setselectedMachine] = useState(null);\n+  const runtimeOps = useStore(runtimeOpsStore);\n+  const [currentRuntime, setRequestedRuntime] = useRuntime(workspace.namespace);\n+  const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+  const {status = null, dataprocConfig: {masterDiskSize, masterMachineType}} = currentRuntime || { dataprocConfig: {}};\n+  const nextMachineType = selectedMachine && selectedMachine.name;\n \n-      const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+  // How do we reflect the state of the runtime to the user?\n+  // How should we handle errors?\n \n-      if (loading) {\n-        return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n-      } else if (error) {\n-        return <div>Error loading compute configuration</div>;\n-      } else if (!runtime) {\n-        // TODO(RW-5591): Create runtime page goes here.\n-        return <React.Fragment>\n-          <div>No runtime exists yet</div>\n-          {activeRuntimeOp && <hr/>}\n-          {activeRuntimeOp && <div>\n-            <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n-          </div>}\n-        </React.Fragment>;\n+  useOnMount(() => {\n+      const aborter = new AbortController();\n+      const {namespace} = workspace;\n+      const loadRuntime = async () => {\n+        // TODO(RW-5420): Centralize a runtimeStore.\n+        try {\n+          const promise = runtimeApi().getRuntime(namespace, {signal: aborter.signal});\n+          updateRuntimeOpsStoreForWorkspaceNamespace(namespace, {\n+            promise: promise,\n+            operation: 'get',\n+            aborter: aborter\n+          });\n+          runtimeStore.set(await promise);\n+        } catch (e) {\n+          // 404 is expected if the runtime doesn't exist, represent this as a null\n+          // runtime rather than an error mode.\n+          if (e.status !== 404) {\n+            setError(true);\n+          }\n+        } finally {\n+          setLoading(false);\n+        }\n+        markRuntimeOperationCompleteForWorkspace(namespace);\n       }\n \n-      const isDataproc = !!runtime.dataprocConfig;\n+      loadRuntime()\n+      return () => aborter.abort();\n+  });\n \n-      let masterMachineName;\n-      let masterDiskSize;\n-      if (isDataproc) {\n-        masterMachineName = runtime.dataprocConfig.masterMachineType;\n-        masterDiskSize = runtime.dataprocConfig.masterDiskSize;\n-      } else {\n-        masterMachineName = runtime.gceConfig.machineType;\n-        masterDiskSize = runtime.gceConfig.bootDiskSize;\n-      }\n-      const machineType = allMachineTypes.find(({name}) => name === masterMachineName) || defaultMachineType;\n+  if (loading) {\n+    return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n+  } else if (error) {\n+    return <div>Error loading compute configuration</div>;\n+  } else if (!currentRuntime) {\n+    // TODO(RW-5591): Create runtime page goes here.\n+    return <React.Fragment>\n+      <div>No runtime exists yet</div>\n+      {activeRuntimeOp && <hr/>}\n+      {activeRuntimeOp && <div>\n+        <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n+      </div>}\n+    </React.Fragment>;\n+  }\n \n-      return <div data-test-id='runtime-panel'>\n-        <h3 style={styles.sectionHeader}>Cloud analysis environment</h3>\n-        <div>\n-          Your analysis environment consists of an application and compute resources.\n-          Your cloud environment is unique to this workspace and not shared with other users.\n-        </div>\n-        {/* TODO(RW-5419): Cost estimates go here. */}\n-        <div style={styles.controlSection}>\n-          {/* Recommended runtime: pick from default templates or change the image. */}\n-          <PopupTrigger side='bottom'\n-                        closeOnClick\n-                        content={\n-                          <React.Fragment>\n-                            <MenuItem style={styles.presetMenuItem}>General purpose analysis</MenuItem>\n-                            <MenuItem style={styles.presetMenuItem}>Genomics analysis</MenuItem>\n-                          </React.Fragment>\n-                        }>\n-            <Clickable data-test-id='runtime-presets-menu'\n-                       disabled={true}>\n-              Recommended environments <ClrIcon shape='caret down'/>\n-            </Clickable>\n-          </PopupTrigger>\n-          <h3 style={styles.sectionHeader}>Application configuration</h3>\n-          {/* TODO(RW-5413): Populate the image list with server driven options. */}\n-          <Dropdown style={{width: '100%'}}\n-                    data-test-id='runtime-image-dropdown'\n-                    disabled={true}\n-                    options={[runtime.toolDockerImage]}\n-                    value={runtime.toolDockerImage}/>\n-          {/* Runtime customization: change detailed machine configuration options. */}\n-          <h3 style={styles.sectionHeader}>Cloud compute profile</h3>\n-          <FlexRow style={{justifyContent: 'space-between'}}>\n-            <div>\n-              <label htmlFor='runtime-cpu'\n-                     style={{marginRight: '.25rem'}}>CPUs</label>\n-              <Dropdown id='runtime-cpu'\n-                        disabled={true}\n-                        options={fp.flow(\n-                          // Show all CPU options.\n-                          fp.map('cpu'),\n-                          // In the event that was remove a machine type from our set of valid\n-                          // configs, we want to continue to allow rendering of the value here.\n-                          // Union also makes the CPU values unique.\n-                          fp.union([machineType.cpu]),\n-                          fp.sortBy(fp.identity)\n-                        )(validLeonardoMachineTypes)}\n-                        value={machineType.cpu}/>\n-            </div>\n-            <div>\n-              <label htmlFor='runtime-ram'\n-                     style={{marginRight: '.25rem'}}>RAM (GB)</label>\n-              <Dropdown id='runtime-ram'\n-                        disabled={true}\n-                        options={fp.flow(\n-                          // Show valid memory options as constrained by the currently selected CPU.\n-                          fp.filter(({cpu}) => cpu === machineType.cpu),\n-                          fp.map('memory'),\n-                          // See above comment on CPU union.\n-                          fp.union([machineType.memory]),\n-                          fp.sortBy(fp.identity)\n-                        )(validLeonardoMachineTypes)}\n-                        value={machineType.memory}/>\n-            </div>\n-            <div>\n-              <label htmlFor='runtime-disk'\n-                     style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-              <InputNumber id='runtime-disk'\n-                           disabled={true}\n-                           showButtons\n-                           decrementButtonClassName='p-button-secondary'\n-                           incrementButtonClassName='p-button-secondary'\n-                           value={masterDiskSize}\n-                           inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                           min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-            </div>\n-          </FlexRow>\n-          <FlexColumn style={{marginTop: '1rem'}}>\n-            <label htmlFor='runtime-compute'>Compute type</label>\n-            <Dropdown id='runtime-compute'\n-                      style={{width: '10rem'}}\n-                      disabled={true}\n-                      options={['Dataproc cluster', 'Standard VM']}\n-                      value={isDataproc ? 'Dataproc cluster' : 'Standard VM'}/>\n-          </FlexColumn>\n-        </div>\n-        <FlexRow style={{justifyContent: 'flex-end', marginTop: '.75rem'}}>\n-          <Button disabled={true}>Create</Button>\n-        </FlexRow>\n-        {activeRuntimeOp && <React.Fragment>\n-          <hr/>\n-          <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n-        </React.Fragment>}\n-      </div>;\n-    }\n+  const isDataproc = (currentRuntime && !!currentRuntime.dataprocConfig);\n+  const runtimeChanged = selectedMachine || selectedDiskSize;\n \n-    componentWillUnmount() {\n-      this.aborter.abort();\n-    }\n-  });\n+  return <div data-test-id='runtime-panel'>\n+    <h3 style={styles.sectionHeader}>Cloud analysis environment</h3>\n+    <div>\n+      Your analysis environment consists of an application and compute resources.\n+      Your cloud environment is unique to this workspace and not shared with other users.\n+    </div>\n+    {/* TODO(RW-5419): Cost estimates go here. */}\n+    <div style={styles.controlSection}>\n+      {/* Recommended runtime: pick from default templates or change the image. */}\n+      <PopupTrigger side='bottom'\n+                    closeOnClick\n+                    content={\n+                      <React.Fragment>\n+                        <MenuItem style={styles.presetMenuItem}>General purpose analysis</MenuItem>\n+                        <MenuItem style={styles.presetMenuItem}>Genomics analysis</MenuItem>\n+                      </React.Fragment>\n+                    }>\n+        <Clickable data-test-id='runtime-presets-menu'\n+                   disabled={true}>\n+          Recommended environments <ClrIcon shape='caret down'/>\n+        </Clickable>\n+      </PopupTrigger>\n+      <h3 style={styles.sectionHeader}>Application configuration</h3>\n+      {/* TODO(RW-5413): Populate the image list with server driven options. */}\n+      <Dropdown style={{width: '100%'}}\n+                data-test-id='runtime-image-dropdown'\n+                disabled={true}\n+                options={[currentRuntime.toolDockerImage]}\n+                value={currentRuntime.toolDockerImage}/>\n+      {/* Runtime customization: change detailed machine configuration options. */}  \n+      <h3 style={styles.sectionHeader}>Cloud compute profile</h3>\n+      <FlexRow style={{justifyContent: 'space-between'}}>\n+        <MachineSelector selectedMachine={selectedMachine} onChange={setselectedMachine} currentRuntime={currentRuntime}/>\n+        <DiskSizeSelection selectedDiskSize={selectedDiskSize} onChange={setSelectedDiskSize} currentRuntime={currentRuntime}/>\n+      </FlexRow>\n+      <FlexColumn style={{marginTop: '1rem'}}>\n+        <label htmlFor='runtime-compute'>Compute type</label>\n+        <Dropdown id='runtime-compute'\n+                  style={{width: '10rem'}}\n+                  disabled={true}\n+                  options={['Dataproc cluster', 'Standard VM']}\n+                  value={isDataproc ? 'Dataproc cluster' : 'Standard VM'}/>\n+      </FlexColumn>\n+    </div>\n+    <FlexRow style={{justifyContent: 'flex-end', marginTop: '.75rem'}}>\n+      <Button \n+        disabled={status !== RuntimeStatus.Running || !runtimeChanged}\n+        onClick={async () => setRequestedRuntime({dataprocConfig: {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d287f113ad0dcd7dfaadd7185b07ab24498599b"}, "originalPosition": 389}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2MzQyNA==", "bodyText": "The behavior of the panel will change before the final review.\n\nA confirm panel will show up after a runtime change is requested\nOnce confirmed the page will navigate back to the preview mode\n\nThat behavior mirrors what is happening in Terra UI", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498863424", "createdAt": "2020-10-02T14:39:26Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -6,25 +6,29 @@ import {Spinner} from 'app/components/spinners';\n import {runtimeApi} from 'app/services/swagger-fetch-clients';\n import colors, {addOpacity} from 'app/styles/colors';\n import {reactStyles, withCurrentWorkspace} from 'app/utils';\n-import {allMachineTypes, validLeonardoMachineTypes} from 'app/utils/machines';\n+import {allMachineTypes, validLeonardoMachineTypes, Machine} from 'app/utils/machines';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d287f113ad0dcd7dfaadd7185b07ab24498599b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2Mzk5Ng==", "bodyText": "All runtime state changes and reads will go through the runtime store", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498863996", "createdAt": "2020-10-02T14:40:30Z", "author": {"login": "petesantos"}, "path": "ui/src/app/utils/leo-runtime-initializer.tsx", "diffHunk": "@@ -1,12 +1,13 @@\n import {leoRuntimesApi} from 'app/services/notebooks-swagger-fetch-clients';\n import {runtimeApi} from 'app/services/swagger-fetch-clients';\n import {isAbortError, reportError} from 'app/utils/errors';\n-import {Runtime, RuntimeConfigurationType, RuntimeStatus} from 'generated/fetch';\n+import {Runtime, RuntimeConfigurationType, RuntimeStatus, DataprocConfig} from 'generated/fetch';\n import {serverConfigStore} from './navigation';\n import {\n   markRuntimeOperationCompleteForWorkspace,\n-  updateRuntimeOpsStoreForWorkspaceNamespace\n-} from './stores';\n+  updateRuntimeOpsStoreForWorkspaceNamespace,\n+  runtimeStore", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d287f113ad0dcd7dfaadd7185b07ab24498599b"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2NDg4OQ==", "bodyText": "Initialize the store if is not already populated with the runtime", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498864889", "createdAt": "2020-10-02T14:41:59Z", "author": {"login": "petesantos"}, "path": "ui/src/app/utils/runtime-utils.ts", "diffHunk": "@@ -0,0 +1,58 @@\n+import {\n+  runtimeStore,\n+  useStore\n+} from 'app/utils/stores';\n+import {useOnMount} from 'app/utils';\n+import {\n+  LeoRuntimeInitializer,\n+} from 'app/utils/leo-runtime-initializer';\n+import {Runtime} from 'generated';\n+import {runtimeApi} from 'app/services/swagger-fetch-clients';\n+import * as fp from 'lodash/fp';\n+\n+import * as React from 'react';\n+\n+const {useState, useEffect} = React;\n+\n+// Hook used to manage runtime state.\n+// The runtime can be set to null to delete a runtime, or a new runtime config\n+// The LeoRuntimeInitializer could potentially be rolled into this code to completely manage\n+// all runtime state.\n+export const useRuntime = (workspaceNamespace) => {\n+  const runtime = useStore(runtimeStore);\n+  const [requestedRuntime, setRequestedRuntime] = useState<Runtime|null>()\n+\n+  useOnMount(() => {\n+    const getRuntime = async () => {\n+      runtime === undefined && runtimeStore.set(await runtimeApi().getRuntime(workspaceNamespace));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0c4d36ff9cd9e1f78456d05eb5edb1c242ec7f9"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2NTE1NA==", "bodyText": "Allow for delete and update actions", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498865154", "createdAt": "2020-10-02T14:42:25Z", "author": {"login": "petesantos"}, "path": "ui/src/app/utils/runtime-utils.ts", "diffHunk": "@@ -0,0 +1,58 @@\n+import {\n+  runtimeStore,\n+  useStore\n+} from 'app/utils/stores';\n+import {useOnMount} from 'app/utils';\n+import {\n+  LeoRuntimeInitializer,\n+} from 'app/utils/leo-runtime-initializer';\n+import {Runtime} from 'generated';\n+import {runtimeApi} from 'app/services/swagger-fetch-clients';\n+import * as fp from 'lodash/fp';\n+\n+import * as React from 'react';\n+\n+const {useState, useEffect} = React;\n+\n+// Hook used to manage runtime state.\n+// The runtime can be set to null to delete a runtime, or a new runtime config\n+// The LeoRuntimeInitializer could potentially be rolled into this code to completely manage\n+// all runtime state.\n+export const useRuntime = (workspaceNamespace) => {\n+  const runtime = useStore(runtimeStore);\n+  const [requestedRuntime, setRequestedRuntime] = useState<Runtime|null>()\n+\n+  useOnMount(() => {\n+    const getRuntime = async () => {\n+      runtime === undefined && runtimeStore.set(await runtimeApi().getRuntime(workspaceNamespace));\n+    }\n+    getRuntime();\n+  });\n+\n+  useEffect(() => {\n+    const action = requestedRuntime === null \n+    ? async () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0c4d36ff9cd9e1f78456d05eb5edb1c242ec7f9"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODg2NjM5OA==", "bodyText": "Return the runtime and a setter. Note that the setter first sets the state of a requested runtime. The actual store is only populated with null or data returned from the runtimeApi - not directly set by the developer.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r498866398", "createdAt": "2020-10-02T14:44:24Z", "author": {"login": "petesantos"}, "path": "ui/src/app/utils/runtime-utils.ts", "diffHunk": "@@ -0,0 +1,58 @@\n+import {\n+  runtimeStore,\n+  useStore\n+} from 'app/utils/stores';\n+import {useOnMount} from 'app/utils';\n+import {\n+  LeoRuntimeInitializer,\n+} from 'app/utils/leo-runtime-initializer';\n+import {Runtime} from 'generated';\n+import {runtimeApi} from 'app/services/swagger-fetch-clients';\n+import * as fp from 'lodash/fp';\n+\n+import * as React from 'react';\n+\n+const {useState, useEffect} = React;\n+\n+// Hook used to manage runtime state.\n+// The runtime can be set to null to delete a runtime, or a new runtime config\n+// The LeoRuntimeInitializer could potentially be rolled into this code to completely manage\n+// all runtime state.\n+export const useRuntime = (workspaceNamespace) => {\n+  const runtime = useStore(runtimeStore);\n+  const [requestedRuntime, setRequestedRuntime] = useState<Runtime|null>()\n+\n+  useOnMount(() => {\n+    const getRuntime = async () => {\n+      runtime === undefined && runtimeStore.set(await runtimeApi().getRuntime(workspaceNamespace));\n+    }\n+    getRuntime();\n+  });\n+\n+  useEffect(() => {\n+    const action = requestedRuntime === null \n+    ? async () => {\n+        await runtimeApi().deleteRuntime(workspaceNamespace);\n+        await LeoRuntimeInitializer.initialize({workspaceNamespace, maxCreateCount: 0});\n+      }\n+    : async () => {\n+        await runtimeApi().deleteRuntime(workspaceNamespace);\n+        await LeoRuntimeInitializer.initialize({\n+          workspaceNamespace,\n+          dataprocConfig: runtime.dataprocConfig\n+        });\n+      }; \n+\n+    const runAction = async () => {\n+      await action();\n+      const currentRuntime = await runtimeApi().getRuntime(workspaceNamespace);\n+      runtimeStore.set(currentRuntime);\n+    }\n+\n+    requestedRuntime !== undefined && !fp.equals(requestedRuntime, runtime) && runAction();\n+  }, [requestedRuntime]);\n+\n+\n+\n+  return [runtime, setRequestedRuntime]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0c4d36ff9cd9e1f78456d05eb5edb1c242ec7f9"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84aaab7bae5420bba639a9fc1e1c93b39f0918e0", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/84aaab7bae5420bba639a9fc1e1c93b39f0918e0", "committedDate": "2020-10-05T13:29:14Z", "message": "fix more semi-random TS issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de429b15fa0de6f0d028a02a94f90768c5a941b5", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/de429b15fa0de6f0d028a02a94f90768c5a941b5", "committedDate": "2020-10-05T17:27:07Z", "message": "Merge remote-tracking branch 'origin/master' into psantos/5410-update-runtime-ui"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6ba1de5ac4873b9dfb2b834e0f01b8184c05c1f", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/c6ba1de5ac4873b9dfb2b834e0f01b8184c05c1f", "committedDate": "2020-10-05T21:14:12Z", "message": "Working update cycle - needs store type restored"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a98cde794d6ee35bfab5a123802af692a46ef36d", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/a98cde794d6ee35bfab5a123802af692a46ef36d", "committedDate": "2020-10-06T12:47:28Z", "message": "Factored out runtime state changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7bbcccf81c5a65f2150116c225b41a72a628e67", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/b7bbcccf81c5a65f2150116c225b41a72a628e67", "committedDate": "2020-10-06T13:00:12Z", "message": "Lint fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4de215adb3bc184315f878aced35df538138c996", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/4de215adb3bc184315f878aced35df538138c996", "committedDate": "2020-10-06T13:11:25Z", "message": "More lint fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDcxMDQ4", "url": "https://github.com/all-of-us/workbench/pull/4100#pullrequestreview-503071048", "createdAt": "2020-10-06T15:08:39Z", "commit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTowODo0MFrOHdMRRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTowOTozMFrOHdMUnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MTc4Mg==", "bodyText": "This hook now only manages setting a new custom runtime config", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500371782", "createdAt": "2020-10-06T15:08:40Z", "author": {"login": "petesantos"}, "path": "ui/src/app/utils/runtime-utils.ts", "diffHunk": "@@ -0,0 +1,93 @@\n+import {runtimeApi} from 'app/services/swagger-fetch-clients';\n+import {useOnMount} from 'app/utils';\n+import {switchCase} from 'app/utils';\n+import {\n+  LeoRuntimeInitializer,\n+} from 'app/utils/leo-runtime-initializer';\n+import {\n+  runtimeStore,\n+  useStore\n+} from 'app/utils/stores';\n+import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import * as fp from 'lodash/fp';\n+\n+import * as React from 'react';\n+\n+const {useState, useEffect} = React;\n+\n+export type RuntimeStatusRequest = 'Delete';\n+\n+export const RuntimeStateRequest = {\n+  Delete: 'Delete' as RuntimeStatusRequest\n+};\n+\n+// useRuntime hook is a simple hook to populate the runtime store.\n+// This is only used by other runtime hooks\n+const useRuntime = (currentWorkspaceNamespace) => {\n+  useOnMount(() => {\n+    const getRuntime = async() => {\n+      const leoRuntime = await runtimeApi().getRuntime(currentWorkspaceNamespace);\n+      runtimeStore.set({\n+        workspaceNamespace: currentWorkspaceNamespace,\n+        runtime: leoRuntime\n+      });\n+    };\n+    getRuntime();\n+  });\n+};\n+\n+// useRuntimeState hook can be used to change the state of the runtime\n+// Only 'Delete' is supported at the moment\n+export const useRuntimeState = (currentWorkspaceNamespace): [RuntimeStatus, Function]  => {\n+  const [requestedRuntimeState, setRuntimeState] = useState<RuntimeStatusRequest>();\n+  const {runtime} = useStore(runtimeStore);\n+  useRuntime(currentWorkspaceNamespace);\n+\n+  useEffect(() => {\n+    // Additional state changes can be put here\n+    if (!!requestedRuntimeState) {\n+      switchCase(requestedRuntimeState,\n+        [RuntimeStateRequest.Delete, async() => {\n+          await runtimeApi().deleteRuntime(currentWorkspaceNamespace);\n+          await LeoRuntimeInitializer.initialize({workspaceNamespace: currentWorkspaceNamespace, maxCreateCount: 0});\n+        }]);\n+    }\n+\n+  }, [requestedRuntimeState]);\n+\n+  return [runtime.status, setRuntimeState];\n+};\n+\n+// useCustomRuntime Hook can request a new runtime config\n+// The LeoRuntimeInitializer could potentially be rolled into this code to completely manage\n+// all runtime state.\n+export const useCustomRuntime = (currentWorkspaceNamespace): [Runtime, Function] => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MjYzOQ==", "bodyText": "This hook can be used to change the state of an existing runtime (e.g. delete only, pause, resume). This currently only handles \"delete\".", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500372639", "createdAt": "2020-10-06T15:09:30Z", "author": {"login": "petesantos"}, "path": "ui/src/app/utils/runtime-utils.ts", "diffHunk": "@@ -0,0 +1,93 @@\n+import {runtimeApi} from 'app/services/swagger-fetch-clients';\n+import {useOnMount} from 'app/utils';\n+import {switchCase} from 'app/utils';\n+import {\n+  LeoRuntimeInitializer,\n+} from 'app/utils/leo-runtime-initializer';\n+import {\n+  runtimeStore,\n+  useStore\n+} from 'app/utils/stores';\n+import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import * as fp from 'lodash/fp';\n+\n+import * as React from 'react';\n+\n+const {useState, useEffect} = React;\n+\n+export type RuntimeStatusRequest = 'Delete';\n+\n+export const RuntimeStateRequest = {\n+  Delete: 'Delete' as RuntimeStatusRequest\n+};\n+\n+// useRuntime hook is a simple hook to populate the runtime store.\n+// This is only used by other runtime hooks\n+const useRuntime = (currentWorkspaceNamespace) => {\n+  useOnMount(() => {\n+    const getRuntime = async() => {\n+      const leoRuntime = await runtimeApi().getRuntime(currentWorkspaceNamespace);\n+      runtimeStore.set({\n+        workspaceNamespace: currentWorkspaceNamespace,\n+        runtime: leoRuntime\n+      });\n+    };\n+    getRuntime();\n+  });\n+};\n+\n+// useRuntimeState hook can be used to change the state of the runtime\n+// Only 'Delete' is supported at the moment\n+export const useRuntimeState = (currentWorkspaceNamespace): [RuntimeStatus, Function]  => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTYzMDEy", "url": "https://github.com/all-of-us/workbench/pull/4100#pullrequestreview-503163012", "createdAt": "2020-10-06T16:44:36Z", "commit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjo0NDozNlrOHdQxzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo0NTo1MlrOHdTE-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0NTY0Nw==", "bodyText": "Can you type the Function here and above? Presumably it's a setter for the Runtime.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500445647", "createdAt": "2020-10-06T16:44:36Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/runtime-utils.ts", "diffHunk": "@@ -0,0 +1,93 @@\n+import {runtimeApi} from 'app/services/swagger-fetch-clients';\n+import {useOnMount} from 'app/utils';\n+import {switchCase} from 'app/utils';\n+import {\n+  LeoRuntimeInitializer,\n+} from 'app/utils/leo-runtime-initializer';\n+import {\n+  runtimeStore,\n+  useStore\n+} from 'app/utils/stores';\n+import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import * as fp from 'lodash/fp';\n+\n+import * as React from 'react';\n+\n+const {useState, useEffect} = React;\n+\n+export type RuntimeStatusRequest = 'Delete';\n+\n+export const RuntimeStateRequest = {\n+  Delete: 'Delete' as RuntimeStatusRequest\n+};\n+\n+// useRuntime hook is a simple hook to populate the runtime store.\n+// This is only used by other runtime hooks\n+const useRuntime = (currentWorkspaceNamespace) => {\n+  useOnMount(() => {\n+    const getRuntime = async() => {\n+      const leoRuntime = await runtimeApi().getRuntime(currentWorkspaceNamespace);\n+      runtimeStore.set({\n+        workspaceNamespace: currentWorkspaceNamespace,\n+        runtime: leoRuntime\n+      });\n+    };\n+    getRuntime();\n+  });\n+};\n+\n+// useRuntimeState hook can be used to change the state of the runtime\n+// Only 'Delete' is supported at the moment\n+export const useRuntimeState = (currentWorkspaceNamespace): [RuntimeStatus, Function]  => {\n+  const [requestedRuntimeState, setRuntimeState] = useState<RuntimeStatusRequest>();\n+  const {runtime} = useStore(runtimeStore);\n+  useRuntime(currentWorkspaceNamespace);\n+\n+  useEffect(() => {\n+    // Additional state changes can be put here\n+    if (!!requestedRuntimeState) {\n+      switchCase(requestedRuntimeState,\n+        [RuntimeStateRequest.Delete, async() => {\n+          await runtimeApi().deleteRuntime(currentWorkspaceNamespace);\n+          await LeoRuntimeInitializer.initialize({workspaceNamespace: currentWorkspaceNamespace, maxCreateCount: 0});\n+        }]);\n+    }\n+\n+  }, [requestedRuntimeState]);\n+\n+  return [runtime.status, setRuntimeState];\n+};\n+\n+// useCustomRuntime Hook can request a new runtime config\n+// The LeoRuntimeInitializer could potentially be rolled into this code to completely manage\n+// all runtime state.\n+export const useCustomRuntime = (currentWorkspaceNamespace): [Runtime, Function] => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0NjI3NQ==", "bodyText": "nit: variable names: runtimeStatus or just status as the prefix?", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500446275", "createdAt": "2020-10-06T16:45:35Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/runtime-utils.ts", "diffHunk": "@@ -0,0 +1,93 @@\n+import {runtimeApi} from 'app/services/swagger-fetch-clients';\n+import {useOnMount} from 'app/utils';\n+import {switchCase} from 'app/utils';\n+import {\n+  LeoRuntimeInitializer,\n+} from 'app/utils/leo-runtime-initializer';\n+import {\n+  runtimeStore,\n+  useStore\n+} from 'app/utils/stores';\n+import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import * as fp from 'lodash/fp';\n+\n+import * as React from 'react';\n+\n+const {useState, useEffect} = React;\n+\n+export type RuntimeStatusRequest = 'Delete';\n+\n+export const RuntimeStateRequest = {\n+  Delete: 'Delete' as RuntimeStatusRequest\n+};\n+\n+// useRuntime hook is a simple hook to populate the runtime store.\n+// This is only used by other runtime hooks\n+const useRuntime = (currentWorkspaceNamespace) => {\n+  useOnMount(() => {\n+    const getRuntime = async() => {\n+      const leoRuntime = await runtimeApi().getRuntime(currentWorkspaceNamespace);\n+      runtimeStore.set({\n+        workspaceNamespace: currentWorkspaceNamespace,\n+        runtime: leoRuntime\n+      });\n+    };\n+    getRuntime();\n+  });\n+};\n+\n+// useRuntimeState hook can be used to change the state of the runtime\n+// Only 'Delete' is supported at the moment\n+export const useRuntimeState = (currentWorkspaceNamespace): [RuntimeStatus, Function]  => {\n+  const [requestedRuntimeState, setRuntimeState] = useState<RuntimeStatusRequest>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ0NzQ4NQ==", "bodyText": "I would just take the return value from LeoRuntimeInitializer.initializer() instead. It should be equivalent", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500447485", "createdAt": "2020-10-06T16:47:39Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/runtime-utils.ts", "diffHunk": "@@ -0,0 +1,93 @@\n+import {runtimeApi} from 'app/services/swagger-fetch-clients';\n+import {useOnMount} from 'app/utils';\n+import {switchCase} from 'app/utils';\n+import {\n+  LeoRuntimeInitializer,\n+} from 'app/utils/leo-runtime-initializer';\n+import {\n+  runtimeStore,\n+  useStore\n+} from 'app/utils/stores';\n+import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import * as fp from 'lodash/fp';\n+\n+import * as React from 'react';\n+\n+const {useState, useEffect} = React;\n+\n+export type RuntimeStatusRequest = 'Delete';\n+\n+export const RuntimeStateRequest = {\n+  Delete: 'Delete' as RuntimeStatusRequest\n+};\n+\n+// useRuntime hook is a simple hook to populate the runtime store.\n+// This is only used by other runtime hooks\n+const useRuntime = (currentWorkspaceNamespace) => {\n+  useOnMount(() => {\n+    const getRuntime = async() => {\n+      const leoRuntime = await runtimeApi().getRuntime(currentWorkspaceNamespace);\n+      runtimeStore.set({\n+        workspaceNamespace: currentWorkspaceNamespace,\n+        runtime: leoRuntime\n+      });\n+    };\n+    getRuntime();\n+  });\n+};\n+\n+// useRuntimeState hook can be used to change the state of the runtime\n+// Only 'Delete' is supported at the moment\n+export const useRuntimeState = (currentWorkspaceNamespace): [RuntimeStatus, Function]  => {\n+  const [requestedRuntimeState, setRuntimeState] = useState<RuntimeStatusRequest>();\n+  const {runtime} = useStore(runtimeStore);\n+  useRuntime(currentWorkspaceNamespace);\n+\n+  useEffect(() => {\n+    // Additional state changes can be put here\n+    if (!!requestedRuntimeState) {\n+      switchCase(requestedRuntimeState,\n+        [RuntimeStateRequest.Delete, async() => {\n+          await runtimeApi().deleteRuntime(currentWorkspaceNamespace);\n+          await LeoRuntimeInitializer.initialize({workspaceNamespace: currentWorkspaceNamespace, maxCreateCount: 0});\n+        }]);\n+    }\n+\n+  }, [requestedRuntimeState]);\n+\n+  return [runtime.status, setRuntimeState];\n+};\n+\n+// useCustomRuntime Hook can request a new runtime config\n+// The LeoRuntimeInitializer could potentially be rolled into this code to completely manage\n+// all runtime state.\n+export const useCustomRuntime = (currentWorkspaceNamespace): [Runtime, Function] => {\n+  const {runtime, workspaceNamespace} = useStore(runtimeStore);\n+  const [requestedRuntime, setRequestedRuntime] = useState<Runtime>();\n+  useRuntime(currentWorkspaceNamespace);\n+\n+  useEffect(() => {\n+    const runAction = async() => {\n+      await runtimeApi().deleteRuntime(currentWorkspaceNamespace);\n+      await LeoRuntimeInitializer.initialize({\n+        workspaceNamespace,\n+        runtime: requestedRuntime\n+      });\n+\n+      const currentRuntime = await runtimeApi().getRuntime(currentWorkspaceNamespace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NjA1NA==", "bodyText": "Please add a comment about cleanup here. I was going to suggest that you should create an aborter and provide the abort callback as the useEffect cleanup function - however, I now realize there is probably a desire to keep this async operation going, even if you navigate away.\nIn my head, persistent operations would have been kept alive by the runtimeOperationStore rather than as a sole side effect of component usage - so that future components can still attach to said pending operation, and avoid generating duplicate work -  but I'm not sure if the current pattern is amenable to this.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500466054", "createdAt": "2020-10-06T17:17:26Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/runtime-utils.ts", "diffHunk": "@@ -0,0 +1,93 @@\n+import {runtimeApi} from 'app/services/swagger-fetch-clients';\n+import {useOnMount} from 'app/utils';\n+import {switchCase} from 'app/utils';\n+import {\n+  LeoRuntimeInitializer,\n+} from 'app/utils/leo-runtime-initializer';\n+import {\n+  runtimeStore,\n+  useStore\n+} from 'app/utils/stores';\n+import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import * as fp from 'lodash/fp';\n+\n+import * as React from 'react';\n+\n+const {useState, useEffect} = React;\n+\n+export type RuntimeStatusRequest = 'Delete';\n+\n+export const RuntimeStateRequest = {\n+  Delete: 'Delete' as RuntimeStatusRequest\n+};\n+\n+// useRuntime hook is a simple hook to populate the runtime store.\n+// This is only used by other runtime hooks\n+const useRuntime = (currentWorkspaceNamespace) => {\n+  useOnMount(() => {\n+    const getRuntime = async() => {\n+      const leoRuntime = await runtimeApi().getRuntime(currentWorkspaceNamespace);\n+      runtimeStore.set({\n+        workspaceNamespace: currentWorkspaceNamespace,\n+        runtime: leoRuntime\n+      });\n+    };\n+    getRuntime();\n+  });\n+};\n+\n+// useRuntimeState hook can be used to change the state of the runtime\n+// Only 'Delete' is supported at the moment\n+export const useRuntimeState = (currentWorkspaceNamespace): [RuntimeStatus, Function]  => {\n+  const [requestedRuntimeState, setRuntimeState] = useState<RuntimeStatusRequest>();\n+  const {runtime} = useStore(runtimeStore);\n+  useRuntime(currentWorkspaceNamespace);\n+\n+  useEffect(() => {\n+    // Additional state changes can be put here\n+    if (!!requestedRuntimeState) {\n+      switchCase(requestedRuntimeState,\n+        [RuntimeStateRequest.Delete, async() => {\n+          await runtimeApi().deleteRuntime(currentWorkspaceNamespace);\n+          await LeoRuntimeInitializer.initialize({workspaceNamespace: currentWorkspaceNamespace, maxCreateCount: 0});\n+        }]);\n+    }\n+\n+  }, [requestedRuntimeState]);\n+\n+  return [runtime.status, setRuntimeState];\n+};\n+\n+// useCustomRuntime Hook can request a new runtime config\n+// The LeoRuntimeInitializer could potentially be rolled into this code to completely manage\n+// all runtime state.\n+export const useCustomRuntime = (currentWorkspaceNamespace): [Runtime, Function] => {\n+  const {runtime, workspaceNamespace} = useStore(runtimeStore);\n+  const [requestedRuntime, setRequestedRuntime] = useState<Runtime>();\n+  useRuntime(currentWorkspaceNamespace);\n+\n+  useEffect(() => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NjY0OQ==", "bodyText": "nit: merge import with next line", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500466649", "createdAt": "2020-10-06T17:18:26Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/runtime-utils.ts", "diffHunk": "@@ -0,0 +1,93 @@\n+import {runtimeApi} from 'app/services/swagger-fetch-clients';\n+import {useOnMount} from 'app/utils';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2ODM0NA==", "bodyText": "opt: I think I'd prefer to just use the React library directly in this case. useOnMount is more semantically understandable, but it adds a layer of redirection which is not portable outside of our immediate codebase, and doesn't really get around the reader needing to know what useEffect does.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500468344", "createdAt": "2020-10-06T17:21:10Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/index.tsx", "diffHunk": "@@ -565,6 +565,10 @@ export const useToggle = (): [boolean, Function] => {\n   return [state, setState];\n };\n \n+export const useOnMount = (fn: Function) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2ODkzMw==", "bodyText": "rm?", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500468933", "createdAt": "2020-10-06T17:22:10Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -71,186 +73,201 @@ export interface Props {\n   workspace: WorkspaceData;\n }\n \n-interface State {\n-  // Whether the initial runtime load is still in progress.\n-  loading: boolean;\n-  // Whether there was an error in loading the runtime data.\n-  error: boolean;\n-  // The runtime. null if none exists, or if there was an error in loading the\n-  // runtime.\n-  runtime: Runtime|null;\n-}\n+const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;\n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n+\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'),\n+                    fp.find({cpu: value}),\n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes)\n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}),\n+                    // If the selected machine is not different from the current machine return null\n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>;\n+};\n+\n+const DiskSizeSelection = ({onChange, selectedDiskSize, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                //  disabled={true}\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={selectedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>;\n+};\n+\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n+  const [loading, setLoading] = useState(true);\n+  const [error, setError] = useState(false);\n+  const [selectedDiskSize, setSelectedDiskSize] = useState(null);\n+  const [selectedMachine, setselectedMachine] = useState(null);\n+  const runtimeOps = useStore(runtimeOpsStore);\n+  const [currentRuntime, setRequestedRuntime] = useCustomRuntime(workspace.namespace);\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+  const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+  const {status = RuntimeStatus.Unknown, toolDockerImage = null, dataprocConfig = {}, gceConfig = {}} = currentRuntime || {};\n+  const masterMachineType = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n+  const selectedMachineType = selectedMachine && selectedMachine.name;\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n+  useOnMount(() => {\n+    const aborter = new AbortController();\n+    const {namespace} = workspace;\n+    const loadRuntime = async() => {\n+        // TODO(RW-5420): Centralize a runtimeStore.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2OTE1OA==", "bodyText": "rm these commented out disabled lines - here and throughout", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500469158", "createdAt": "2020-10-06T17:22:32Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -71,186 +73,201 @@ export interface Props {\n   workspace: WorkspaceData;\n }\n \n-interface State {\n-  // Whether the initial runtime load is still in progress.\n-  loading: boolean;\n-  // Whether there was an error in loading the runtime data.\n-  error: boolean;\n-  // The runtime. null if none exists, or if there was an error in loading the\n-  // runtime.\n-  runtime: Runtime|null;\n-}\n+const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;\n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n+\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'),\n+                    fp.find({cpu: value}),\n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes)\n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}),\n+                    // If the selected machine is not different from the current machine return null\n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>;\n+};\n+\n+const DiskSizeSelection = ({onChange, selectedDiskSize, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                //  disabled={true}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2OTU1OQ==", "bodyText": "I wasn't expecting to see a get call here - shouldn't this just be using the store now?", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500469559", "createdAt": "2020-10-06T17:23:14Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -71,186 +73,201 @@ export interface Props {\n   workspace: WorkspaceData;\n }\n \n-interface State {\n-  // Whether the initial runtime load is still in progress.\n-  loading: boolean;\n-  // Whether there was an error in loading the runtime data.\n-  error: boolean;\n-  // The runtime. null if none exists, or if there was an error in loading the\n-  // runtime.\n-  runtime: Runtime|null;\n-}\n+const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;\n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n+\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'),\n+                    fp.find({cpu: value}),\n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes)\n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}),\n+                    // If the selected machine is not different from the current machine return null\n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>;\n+};\n+\n+const DiskSizeSelection = ({onChange, selectedDiskSize, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                //  disabled={true}\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={selectedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>;\n+};\n+\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n+  const [loading, setLoading] = useState(true);\n+  const [error, setError] = useState(false);\n+  const [selectedDiskSize, setSelectedDiskSize] = useState(null);\n+  const [selectedMachine, setselectedMachine] = useState(null);\n+  const runtimeOps = useStore(runtimeOpsStore);\n+  const [currentRuntime, setRequestedRuntime] = useCustomRuntime(workspace.namespace);\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+  const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+  const {status = RuntimeStatus.Unknown, toolDockerImage = null, dataprocConfig = {}, gceConfig = {}} = currentRuntime || {};\n+  const masterMachineType = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n+  const selectedMachineType = selectedMachine && selectedMachine.name;\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n+  useOnMount(() => {\n+    const aborter = new AbortController();\n+    const {namespace} = workspace;\n+    const loadRuntime = async() => {\n+        // TODO(RW-5420): Centralize a runtimeStore.\n       try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n+        const promise = runtimeApi().getRuntime(namespace, {signal: aborter.signal});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3MjQyOQ==", "bodyText": "opt: This leading \"_\" is not a naming convention I've seen anywhere else in our codebase, though I see why you're using it here.\nRelatedly, I think the property setter has too many side effects. I might prefer a normal method.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500472429", "createdAt": "2020-10-06T17:27:37Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/leo-runtime-initializer.tsx", "diffHunk": "@@ -134,9 +138,22 @@ export class LeoRuntimeInitializer {\n   private resumeCount = 0;\n   private serverErrorCount = 0;\n   private initializeStartTime?: number;\n+  private runtime?: Runtime;\n   // The latest runtime retrieved from getRuntime. If the last getRuntime call returned a NOT_FOUND\n   // response, this will be null.\n-  private currentRuntime?: Runtime;\n+  private _currentRuntime?: Runtime;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3Nzk5OQ==", "bodyText": "I'm not sure why runtime would start as being defined with a stub value, and in particular why it would be set to dataprocConfig. There should specifically be no runtime when we are not in a workspace context, which is the initial state. Was this for testing purposes? If so, I'd direct you here: \n  \n    \n      workbench/ui/src/test.ts\n    \n    \n         Line 30\n      in\n      f272563\n    \n    \n    \n    \n\n        \n          \n           beforeEach(() => {", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500477999", "createdAt": "2020-10-06T17:36:38Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/stores.tsx", "diffHunk": "@@ -73,11 +73,11 @@ export const abortRuntimeOperationForWorkspace = (workspaceNamespace: string) =>\n \n // runtime store states: undefined(initial state) -> Runtime (user selected) <--> null (delete only - no recreate)\n interface RuntimeStore {\n-  workspaceNamespace: string;\n+  workspaceNamespace: string | null | undefined;\n   runtime: Runtime | null | undefined;\n }\n \n-export const runtimeStore = atom<RuntimeStore>(undefined);\n+export const runtimeStore = atom<RuntimeStore>({workspaceNamespace: undefined, runtime: { dataprocConfig: {}}});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3OTI4Mw==", "bodyText": "nit: ideally the default would follow this logic, but if that requires a lot of code changes you can just leave it as is (GCE will be launched soon, so we probably won't need to worry about this):\n\n  \n    \n      workbench/ui/src/app/utils/leo-runtime-initializer.tsx\n    \n    \n        Lines 194 to 198\n      in\n      f272563\n    \n    \n    \n    \n\n        \n          \n           if (serverConfigStore.getValue().enableGceAsNotebookRuntimeDefault) { \n        \n\n        \n          \n             runtime = {...runtimePresets.generalAnalysis.runtimeTemplate}; \n        \n\n        \n          \n           } else { \n        \n\n        \n          \n             runtime = {...runtimePresets.legacyGeneralAnalysis.runtimeTemplate}; \n        \n\n        \n          \n           }", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500479283", "createdAt": "2020-10-06T17:38:52Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/leo-runtime-initializer.tsx", "diffHunk": "@@ -22,6 +23,7 @@ const DEFAULT_MAX_DELETE_COUNT = 2;\n const DEFAULT_MAX_RESUME_COUNT = 2;\n // We allow a certain # of server errors to occur before we error-out of the initialization flow.\n const DEFAULT_MAX_SERVER_ERROR_COUNT = 10;\n+const DEFAULT_RUNTIME_CONFIG = runtimePresets.generalAnalysis.runtimeTemplate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4MzMyMw==", "bodyText": "I'm confused as to why these two values are needed - can you just have a single enum?", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500483323", "createdAt": "2020-10-06T17:45:52Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/runtime-utils.ts", "diffHunk": "@@ -0,0 +1,93 @@\n+import {runtimeApi} from 'app/services/swagger-fetch-clients';\n+import {useOnMount} from 'app/utils';\n+import {switchCase} from 'app/utils';\n+import {\n+  LeoRuntimeInitializer,\n+} from 'app/utils/leo-runtime-initializer';\n+import {\n+  runtimeStore,\n+  useStore\n+} from 'app/utils/stores';\n+import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import * as fp from 'lodash/fp';\n+\n+import * as React from 'react';\n+\n+const {useState, useEffect} = React;\n+\n+export type RuntimeStatusRequest = 'Delete';\n+\n+export const RuntimeStateRequest = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjQ5NTMw", "url": "https://github.com/all-of-us/workbench/pull/4100#pullrequestreview-503249530", "createdAt": "2020-10-06T18:31:28Z", "commit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODozMToyOFrOHdU07Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODo1ODoxNVrOHdVyXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUxMTk4MQ==", "bodyText": "remove commented out code", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500511981", "createdAt": "2020-10-06T18:31:28Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -71,186 +73,201 @@ export interface Props {\n   workspace: WorkspaceData;\n }\n \n-interface State {\n-  // Whether the initial runtime load is still in progress.\n-  loading: boolean;\n-  // Whether there was an error in loading the runtime data.\n-  error: boolean;\n-  // The runtime. null if none exists, or if there was an error in loading the\n-  // runtime.\n-  runtime: Runtime|null;\n-}\n+const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;\n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n+\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'),\n+                    fp.find({cpu: value}),\n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes)\n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                // disabled={true}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUxODQ2NA==", "bodyText": "If you're using the CurrentRuntimeStore to get information about the runtime, then loading, error, etc. state should become unnecessary; instead you'd want to look at whether the runtime store is null / undefined", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500518464", "createdAt": "2020-10-06T18:42:11Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -71,186 +73,201 @@ export interface Props {\n   workspace: WorkspaceData;\n }\n \n-interface State {\n-  // Whether the initial runtime load is still in progress.\n-  loading: boolean;\n-  // Whether there was an error in loading the runtime data.\n-  error: boolean;\n-  // The runtime. null if none exists, or if there was an error in loading the\n-  // runtime.\n-  runtime: Runtime|null;\n-}\n+const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;\n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n+\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'),\n+                    fp.find({cpu: value}),\n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes)\n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}),\n+                    // If the selected machine is not different from the current machine return null\n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>;\n+};\n+\n+const DiskSizeSelection = ({onChange, selectedDiskSize, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                //  disabled={true}\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={selectedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>;\n+};\n+\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n+  const [loading, setLoading] = useState(true);\n+  const [error, setError] = useState(false);\n+  const [selectedDiskSize, setSelectedDiskSize] = useState(null);\n+  const [selectedMachine, setselectedMachine] = useState(null);\n+  const runtimeOps = useStore(runtimeOpsStore);\n+  const [currentRuntime, setRequestedRuntime] = useCustomRuntime(workspace.namespace);\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+  const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+  const {status = RuntimeStatus.Unknown, toolDockerImage = null, dataprocConfig = {}, gceConfig = {}} = currentRuntime || {};\n+  const masterMachineType = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n+  const selectedMachineType = selectedMachine && selectedMachine.name;\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n+  useOnMount(() => {\n+    const aborter = new AbortController();\n+    const {namespace} = workspace;\n+    const loadRuntime = async() => {\n+        // TODO(RW-5420): Centralize a runtimeStore.\n       try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n+        const promise = runtimeApi().getRuntime(namespace, {signal: aborter.signal});\n+        updateRuntimeOpsStoreForWorkspaceNamespace(namespace, {\n           promise: promise,\n           operation: 'get',\n-          aborter: this.aborter\n+          aborter: aborter\n         });\n-        runtime = await promise;\n       } catch (e) {\n         // 404 is expected if the runtime doesn't exist, represent this as a null\n         // runtime rather than an error mode.\n         if (e.status !== 404) {\n-          error = true;\n+          setError(true);\n         }\n+      } finally {\n+        setLoading(false);\n       }\n-      markRuntimeOperationCompleteForWorkspace(this.props.workspace.namespace);\n-      this.setState({\n-        runtime,\n-        error,\n-        loading: false\n-      });\n-    }\n-\n-    render() {\n-      const {runtimeOps, workspace} = this.props;\n-      const {loading, error, runtime} = this.state;\n+      markRuntimeOperationCompleteForWorkspace(namespace);\n+    };\n \n-      const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n-\n-      if (loading) {\n-        return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n-      } else if (error) {\n-        return <div>Error loading compute configuration</div>;\n-      } else if (!runtime) {\n-        // TODO(RW-5591): Create runtime page goes here.\n-        return <React.Fragment>\n-          <div>No runtime exists yet</div>\n-          {activeRuntimeOp && <hr/>}\n-          {activeRuntimeOp && <div>\n-            <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n-          </div>}\n-        </React.Fragment>;\n-      }\n+    loadRuntime();\n+    return () => aborter.abort();\n+  });\n \n-      const isDataproc = !!runtime.dataprocConfig;\n+  if (loading) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 209}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyMTI0Mw==", "bodyText": "ty for factoring these out!", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500521243", "createdAt": "2020-10-06T18:47:09Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -71,186 +73,201 @@ export interface Props {\n   workspace: WorkspaceData;\n }\n \n-interface State {\n-  // Whether the initial runtime load is still in progress.\n-  loading: boolean;\n-  // Whether there was an error in loading the runtime data.\n-  error: boolean;\n-  // The runtime. null if none exists, or if there was an error in loading the\n-  // runtime.\n-  runtime: Runtime|null;\n-}\n+const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyMTgxNQ==", "bodyText": "Won't this still be true if the user sets it to a different machine or disk size and then sets it back to what it was before?", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500521815", "createdAt": "2020-10-06T18:48:10Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -71,186 +73,201 @@ export interface Props {\n   workspace: WorkspaceData;\n }\n \n-interface State {\n-  // Whether the initial runtime load is still in progress.\n-  loading: boolean;\n-  // Whether there was an error in loading the runtime data.\n-  error: boolean;\n-  // The runtime. null if none exists, or if there was an error in loading the\n-  // runtime.\n-  runtime: Runtime|null;\n-}\n+const MachineSelector = ({onChange, selectedMachine, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterMachineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const initialMachineType = fp.find(({name}) => name === masterMachineName, allMachineTypes) || defaultMachineType;\n+  const {cpu, memory} = selectedMachine || initialMachineType;\n+  const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n+\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'),\n+                    fp.find({cpu: value}),\n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes)\n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                // disabled={true}\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}),\n+                    // If the selected machine is not different from the current machine return null\n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>;\n+};\n+\n+const DiskSizeSelection = ({onChange, selectedDiskSize, currentRuntime}) => {\n+  const {dataprocConfig, gceConfig} = currentRuntime;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                //  disabled={true}\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={selectedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>;\n+};\n+\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n+  const [loading, setLoading] = useState(true);\n+  const [error, setError] = useState(false);\n+  const [selectedDiskSize, setSelectedDiskSize] = useState(null);\n+  const [selectedMachine, setselectedMachine] = useState(null);\n+  const runtimeOps = useStore(runtimeOpsStore);\n+  const [currentRuntime, setRequestedRuntime] = useCustomRuntime(workspace.namespace);\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+  const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+  const {status = RuntimeStatus.Unknown, toolDockerImage = null, dataprocConfig = {}, gceConfig = {}} = currentRuntime || {};\n+  const masterMachineType = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n+  const selectedMachineType = selectedMachine && selectedMachine.name;\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n+  useOnMount(() => {\n+    const aborter = new AbortController();\n+    const {namespace} = workspace;\n+    const loadRuntime = async() => {\n+        // TODO(RW-5420): Centralize a runtimeStore.\n       try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n+        const promise = runtimeApi().getRuntime(namespace, {signal: aborter.signal});\n+        updateRuntimeOpsStoreForWorkspaceNamespace(namespace, {\n           promise: promise,\n           operation: 'get',\n-          aborter: this.aborter\n+          aborter: aborter\n         });\n-        runtime = await promise;\n       } catch (e) {\n         // 404 is expected if the runtime doesn't exist, represent this as a null\n         // runtime rather than an error mode.\n         if (e.status !== 404) {\n-          error = true;\n+          setError(true);\n         }\n+      } finally {\n+        setLoading(false);\n       }\n-      markRuntimeOperationCompleteForWorkspace(this.props.workspace.namespace);\n-      this.setState({\n-        runtime,\n-        error,\n-        loading: false\n-      });\n-    }\n-\n-    render() {\n-      const {runtimeOps, workspace} = this.props;\n-      const {loading, error, runtime} = this.state;\n+      markRuntimeOperationCompleteForWorkspace(namespace);\n+    };\n \n-      const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n-\n-      if (loading) {\n-        return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n-      } else if (error) {\n-        return <div>Error loading compute configuration</div>;\n-      } else if (!runtime) {\n-        // TODO(RW-5591): Create runtime page goes here.\n-        return <React.Fragment>\n-          <div>No runtime exists yet</div>\n-          {activeRuntimeOp && <hr/>}\n-          {activeRuntimeOp && <div>\n-            <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n-          </div>}\n-        </React.Fragment>;\n-      }\n+    loadRuntime();\n+    return () => aborter.abort();\n+  });\n \n-      const isDataproc = !!runtime.dataprocConfig;\n+  if (loading) {\n+    return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n+  } else if (error) {\n+    return <div>Error loading compute configuration</div>;\n+  } else if (!currentRuntime) {\n+    // TODO(RW-5591): Create runtime page goes here.\n+    return <React.Fragment>\n+      <div>No runtime exists yet</div>\n+      {activeRuntimeOp && <hr/>}\n+      {activeRuntimeOp && <div>\n+        <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n+      </div>}\n+    </React.Fragment>;\n+  }\n \n-      let masterMachineName;\n-      let masterDiskSize;\n-      if (isDataproc) {\n-        masterMachineName = runtime.dataprocConfig.masterMachineType;\n-        masterDiskSize = runtime.dataprocConfig.masterDiskSize;\n-      } else {\n-        masterMachineName = runtime.gceConfig.machineType;\n-        masterDiskSize = runtime.gceConfig.bootDiskSize;\n-      }\n-      const machineType = allMachineTypes.find(({name}) => name === masterMachineName) || defaultMachineType;\n+  const isDataproc = (currentRuntime && !!currentRuntime.dataprocConfig);\n+  const runtimeChanged = selectedMachine || selectedDiskSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 235}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUyNzcwOA==", "bodyText": "Could you explain how this is enforced?", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r500527708", "createdAt": "2020-10-06T18:58:15Z", "author": {"login": "als364"}, "path": "ui/src/app/utils/runtime-utils.ts", "diffHunk": "@@ -0,0 +1,93 @@\n+import {runtimeApi} from 'app/services/swagger-fetch-clients';\n+import {useOnMount} from 'app/utils';\n+import {switchCase} from 'app/utils';\n+import {\n+  LeoRuntimeInitializer,\n+} from 'app/utils/leo-runtime-initializer';\n+import {\n+  runtimeStore,\n+  useStore\n+} from 'app/utils/stores';\n+import {Runtime, RuntimeStatus} from 'generated/fetch';\n+import * as fp from 'lodash/fp';\n+\n+import * as React from 'react';\n+\n+const {useState, useEffect} = React;\n+\n+export type RuntimeStatusRequest = 'Delete';\n+\n+export const RuntimeStateRequest = {\n+  Delete: 'Delete' as RuntimeStatusRequest\n+};\n+\n+// useRuntime hook is a simple hook to populate the runtime store.\n+// This is only used by other runtime hooks", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77823ab2fffbb04f000d507502c5dfe295fd2dbf", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/77823ab2fffbb04f000d507502c5dfe295fd2dbf", "committedDate": "2020-10-06T21:24:22Z", "message": "Update test to work with useEffect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d1ffedb6ee743a73158512b9b4c4bbf2ea16810", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/9d1ffedb6ee743a73158512b9b4c4bbf2ea16810", "committedDate": "2020-10-07T13:01:49Z", "message": "PR Feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bddcc0449a096e538e35dd80d46b6ab5ffcd17c", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/6bddcc0449a096e538e35dd80d46b6ab5ffcd17c", "committedDate": "2020-10-07T15:42:59Z", "message": "PR Feedback - some state cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8a6d33b940b9428cda7d140b0695726d5ebad15", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/a8a6d33b940b9428cda7d140b0695726d5ebad15", "committedDate": "2020-10-07T18:51:49Z", "message": "More PR Feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "761a0f8626344adbca7eb3288fe3ffbd898be14c", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/761a0f8626344adbca7eb3288fe3ffbd898be14c", "committedDate": "2020-10-07T20:55:44Z", "message": "Add tests for runtime-panel"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MjkyMTc0", "url": "https://github.com/all-of-us/workbench/pull/4100#pullrequestreview-504292174", "createdAt": "2020-10-07T21:49:20Z", "commit": {"oid": "761a0f8626344adbca7eb3288fe3ffbd898be14c"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMTo0OToyMFrOHeGvMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QyMjowMzoxMVrOHeHGUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyOTcxNQ==", "bodyText": "This is interesting - I'm surprised we haven't had to use this previously. Is it specifically critical for hooks etc?", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r501329715", "createdAt": "2020-10-07T21:49:20Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -21,20 +24,27 @@ describe('RuntimePanel', () => {\n     return mount(<RuntimePanel {...props}/>);\n   };\n \n+  const handleUseEffect = async (component) => {\n+    await act(async () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761a0f8626344adbca7eb3288fe3ffbd898be14c"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMzMDY2NA==", "bodyText": "I'm failing to understand the purpose of this line. Is this just a cute way to accept a parameter (component) which may or may not be a promise, and if it is a promise - wait for it to complete?", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r501330664", "createdAt": "2020-10-07T21:51:22Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -21,20 +24,27 @@ describe('RuntimePanel', () => {\n     return mount(<RuntimePanel {...props}/>);\n   };\n \n+  const handleUseEffect = async (component) => {\n+    await act(async () => {\n+      await Promise.resolve(component);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761a0f8626344adbca7eb3288fe3ffbd898be14c"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMzMDg5Nw==", "bodyText": "opt: Consider putting this into our test-utils and adding some documentation on usage", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r501330897", "createdAt": "2020-10-07T21:51:51Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -21,20 +24,27 @@ describe('RuntimePanel', () => {\n     return mount(<RuntimePanel {...props}/>);\n   };\n \n+  const handleUseEffect = async (component) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761a0f8626344adbca7eb3288fe3ffbd898be14c"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMzMjA1NQ==", "bodyText": "Please document this. In particular, it seems to require that fn return a promise - which cannot be inferred from the method name or type signature.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r501332055", "createdAt": "2020-10-07T21:54:31Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/index.tsx", "diffHunk": "@@ -565,6 +565,15 @@ export const useToggle = (): [boolean, Function] => {\n   return [state, setState];\n };\n \n+export const withErrorHandling = fp.curry((handler, fn) => async(...args) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761a0f8626344adbca7eb3288fe3ffbd898be14c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMzNTYzNA==", "bodyText": "Don't bother with this anymore, I don't think, since I've already started enabling GCE by default. The way you have it now should work fine.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r501335634", "createdAt": "2020-10-07T22:03:11Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/leo-runtime-initializer.tsx", "diffHunk": "@@ -22,6 +23,7 @@ const DEFAULT_MAX_DELETE_COUNT = 2;\n const DEFAULT_MAX_RESUME_COUNT = 2;\n // We allow a certain # of server errors to occur before we error-out of the initialization flow.\n const DEFAULT_MAX_SERVER_ERROR_COUNT = 10;\n+const DEFAULT_RUNTIME_CONFIG = runtimePresets.generalAnalysis.runtimeTemplate;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3OTI4Mw=="}, "originalCommit": {"oid": "4de215adb3bc184315f878aced35df538138c996"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MzUxNTQ2", "url": "https://github.com/all-of-us/workbench/pull/4100#pullrequestreview-504351546", "createdAt": "2020-10-08T00:17:23Z", "commit": {"oid": "761a0f8626344adbca7eb3288fe3ffbd898be14c"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDoxNzoyNFrOHeJ2nQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwMDoyMjozNVrOHeJ7vA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4MDc2NQ==", "bodyText": "Could you drop this for now? It is flashing in and out of existence on the page, which is quite jarring.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r501380765", "createdAt": "2020-10-08T00:17:24Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -67,190 +64,165 @@ const ActiveRuntimeOp = ({operation, workspaceNamespace}) => {\n };\n \n export interface Props {\n-  runtimeOps: RuntimeOpsStore;\n   workspace: WorkspaceData;\n }\n \n-interface State {\n-  // Whether the initial runtime load is still in progress.\n-  loading: boolean;\n-  // Whether there was an error in loading the runtime data.\n-  error: boolean;\n-  // The runtime. null if none exists, or if there was an error in loading the\n-  // runtime.\n-  runtime: Runtime|null;\n-}\n+const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+  const {cpu, memory} = updatedMachine || initialMachineType;\n+  const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n+\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'),\n+                    fp.find({cpu: value}),\n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes)\n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}),\n+                    // If the selected machine is not different from the current machine return null\n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>;\n+};\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={updatedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>;\n+};\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(null);\n+  const [updatedMachine, setUpdatedMachine] = useState(null);\n+  const runtimeOps = useStore(runtimeOpsStore);\n+  const [currentRuntime, setRequestedRuntime] = useCustomRuntime(workspace.namespace);\n+\n+  const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+  const {status = RuntimeStatus.Unknown, toolDockerImage = '', dataprocConfig = null, gceConfig = {}} = currentRuntime || {};\n+  const masterMachineType = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n+  const updatedMachineType = updatedMachine && updatedMachine.name;\n+\n+  const isDataproc = (currentRuntime && !!currentRuntime.dataprocConfig);\n+  const runtimeChanged = updatedMachine || updatedDiskSize;\n+\n+  if (currentRuntime === undefined) {\n+    return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n+  } else if (currentRuntime === null) {\n+    // TODO(RW-5591): Create runtime page goes here.\n+    return <React.Fragment>\n+      <div>No runtime exists yet</div>\n+      {activeRuntimeOp && <hr/>}\n+      {activeRuntimeOp && <div>\n+        <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n+      </div>}\n+    </React.Fragment>;\n+  }\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n-      try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n-          promise: promise,\n-          operation: 'get',\n-          aborter: this.aborter\n-        });\n-        runtime = await promise;\n-      } catch (e) {\n-        // 404 is expected if the runtime doesn't exist, represent this as a null\n-        // runtime rather than an error mode.\n-        if (e.status !== 404) {\n-          error = true;\n+  return <div data-test-id='runtime-panel'>\n+    <h3 style={styles.sectionHeader}>Cloud analysis environment</h3>\n+    <div>\n+      Your analysis environment consists of an application and compute resources.\n+      Your cloud environment is unique to this workspace and not shared with other users.\n+    </div>\n+    {/* TODO(RW-5419): Cost estimates go here. */}\n+    <div style={styles.controlSection}>\n+      {/* Recommended runtime: pick from default templates or change the image. */}\n+      <PopupTrigger side='bottom'\n+                    closeOnClick\n+                    content={\n+                      <React.Fragment>\n+                        <MenuItem style={styles.presetMenuItem}>General purpose analysis</MenuItem>\n+                        <MenuItem style={styles.presetMenuItem}>Genomics analysis</MenuItem>\n+                      </React.Fragment>\n+                    }>\n+        <Clickable data-test-id='runtime-presets-menu'\n+                   disabled={true}>\n+          Recommended environments <ClrIcon shape='caret down'/>\n+        </Clickable>\n+      </PopupTrigger>\n+      <h3 style={styles.sectionHeader}>Application configuration</h3>\n+      {/* TODO(RW-5413): Populate the image list with server driven options. */}\n+      <Dropdown style={{width: '100%'}}\n+                data-test-id='runtime-image-dropdown'\n+                disabled={true}\n+                options={[toolDockerImage]}\n+                value={toolDockerImage}/>\n+      {/* Runtime customization: change detailed machine configuration options. */}\n+      <h3 style={styles.sectionHeader}>Cloud compute profile</h3>\n+      <FlexRow style={{justifyContent: 'space-between'}}>\n+        <MachineSelector updatedMachine={updatedMachine} onChange={setUpdatedMachine} masterMachineType={masterMachineType}/>\n+        <DiskSizeSelection updatedDiskSize={updatedDiskSize} onChange={setUpdatedDiskSize} masterDiskSize={masterDiskSize}/>\n+      </FlexRow>\n+      <FlexColumn style={{marginTop: '1rem'}}>\n+        <label htmlFor='runtime-compute'>Compute type</label>\n+        <Dropdown id='runtime-compute'\n+                  style={{width: '10rem'}}\n+                  disabled={true}\n+                  options={['Dataproc cluster', 'Standard VM']}\n+                  value={isDataproc ? 'Dataproc cluster' : 'Standard VM'}/>\n+      </FlexColumn>\n+    </div>\n+    <FlexRow style={{justifyContent: 'flex-end', marginTop: '.75rem'}}>\n+      <Button\n+        aria-label={currentRuntime ? 'Update' : 'Create'}\n+        disabled={status !== RuntimeStatus.Running || !runtimeChanged}\n+        onClick={() =>\n+          setRequestedRuntime({dataprocConfig: {\n+            masterMachineType: updatedMachineType || masterMachineType,\n+            masterDiskSize: updatedDiskSize || masterDiskSize\n+          }})\n         }\n-      }\n-      markRuntimeOperationCompleteForWorkspace(this.props.workspace.namespace);\n-      this.setState({\n-        runtime,\n-        error,\n-        loading: false\n-      });\n-    }\n-\n-    render() {\n-      const {runtimeOps, workspace} = this.props;\n-      const {loading, error, runtime} = this.state;\n-\n-      const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n-\n-      if (loading) {\n-        return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n-      } else if (error) {\n-        return <div>Error loading compute configuration</div>;\n-      } else if (!runtime) {\n-        // TODO(RW-5591): Create runtime page goes here.\n-        return <React.Fragment>\n-          <div>No runtime exists yet</div>\n-          {activeRuntimeOp && <hr/>}\n-          {activeRuntimeOp && <div>\n-            <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n-          </div>}\n-        </React.Fragment>;\n-      }\n-\n-      const isDataproc = !!runtime.dataprocConfig;\n-\n-      let masterMachineName;\n-      let masterDiskSize;\n-      if (isDataproc) {\n-        masterMachineName = runtime.dataprocConfig.masterMachineType;\n-        masterDiskSize = runtime.dataprocConfig.masterDiskSize;\n-      } else {\n-        masterMachineName = runtime.gceConfig.machineType;\n-        masterDiskSize = runtime.gceConfig.bootDiskSize;\n-      }\n-      const machineType = allMachineTypes.find(({name}) => name === masterMachineName) || defaultMachineType;\n-\n-      return <div data-test-id='runtime-panel'>\n-        <h3 style={styles.sectionHeader}>Cloud analysis environment</h3>\n-        <div>\n-          Your analysis environment consists of an application and compute resources.\n-          Your cloud environment is unique to this workspace and not shared with other users.\n-        </div>\n-        {/* TODO(RW-5419): Cost estimates go here. */}\n-        <div style={styles.controlSection}>\n-          {/* Recommended runtime: pick from default templates or change the image. */}\n-          <PopupTrigger side='bottom'\n-                        closeOnClick\n-                        content={\n-                          <React.Fragment>\n-                            <MenuItem style={styles.presetMenuItem}>General purpose analysis</MenuItem>\n-                            <MenuItem style={styles.presetMenuItem}>Genomics analysis</MenuItem>\n-                          </React.Fragment>\n-                        }>\n-            <Clickable data-test-id='runtime-presets-menu'\n-                       disabled={true}>\n-              Recommended environments <ClrIcon shape='caret down'/>\n-            </Clickable>\n-          </PopupTrigger>\n-          <h3 style={styles.sectionHeader}>Application configuration</h3>\n-          {/* TODO(RW-5413): Populate the image list with server driven options. */}\n-          <Dropdown style={{width: '100%'}}\n-                    data-test-id='runtime-image-dropdown'\n-                    disabled={true}\n-                    options={[runtime.toolDockerImage]}\n-                    value={runtime.toolDockerImage}/>\n-          {/* Runtime customization: change detailed machine configuration options. */}\n-          <h3 style={styles.sectionHeader}>Cloud compute profile</h3>\n-          <FlexRow style={{justifyContent: 'space-between'}}>\n-            <div>\n-              <label htmlFor='runtime-cpu'\n-                     style={{marginRight: '.25rem'}}>CPUs</label>\n-              <Dropdown id='runtime-cpu'\n-                        disabled={true}\n-                        options={fp.flow(\n-                          // Show all CPU options.\n-                          fp.map('cpu'),\n-                          // In the event that was remove a machine type from our set of valid\n-                          // configs, we want to continue to allow rendering of the value here.\n-                          // Union also makes the CPU values unique.\n-                          fp.union([machineType.cpu]),\n-                          fp.sortBy(fp.identity)\n-                        )(validLeonardoMachineTypes)}\n-                        value={machineType.cpu}/>\n-            </div>\n-            <div>\n-              <label htmlFor='runtime-ram'\n-                     style={{marginRight: '.25rem'}}>RAM (GB)</label>\n-              <Dropdown id='runtime-ram'\n-                        disabled={true}\n-                        options={fp.flow(\n-                          // Show valid memory options as constrained by the currently selected CPU.\n-                          fp.filter(({cpu}) => cpu === machineType.cpu),\n-                          fp.map('memory'),\n-                          // See above comment on CPU union.\n-                          fp.union([machineType.memory]),\n-                          fp.sortBy(fp.identity)\n-                        )(validLeonardoMachineTypes)}\n-                        value={machineType.memory}/>\n-            </div>\n-            <div>\n-              <label htmlFor='runtime-disk'\n-                     style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-              <InputNumber id='runtime-disk'\n-                           disabled={true}\n-                           showButtons\n-                           decrementButtonClassName='p-button-secondary'\n-                           incrementButtonClassName='p-button-secondary'\n-                           value={masterDiskSize}\n-                           inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                           min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-            </div>\n-          </FlexRow>\n-          <FlexColumn style={{marginTop: '1rem'}}>\n-            <label htmlFor='runtime-compute'>Compute type</label>\n-            <Dropdown id='runtime-compute'\n-                      style={{width: '10rem'}}\n-                      disabled={true}\n-                      options={['Dataproc cluster', 'Standard VM']}\n-                      value={isDataproc ? 'Dataproc cluster' : 'Standard VM'}/>\n-          </FlexColumn>\n-        </div>\n-        <FlexRow style={{justifyContent: 'flex-end', marginTop: '.75rem'}}>\n-          <Button disabled={true}>Create</Button>\n-        </FlexRow>\n-        {activeRuntimeOp && <React.Fragment>\n-          <hr/>\n-          <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n-        </React.Fragment>}\n-      </div>;\n-    }\n+      >{currentRuntime ? 'Update' : 'Create'}</Button>\n+    </FlexRow>\n+    {activeRuntimeOp && <React.Fragment>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761a0f8626344adbca7eb3288fe3ffbd898be14c"}, "originalPosition": 367}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4MTE0Nw==", "bodyText": "Please change this to gceConfig, since this panel is currently for modifying a standard VM and GCE is now the default (in test/local)", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r501381147", "createdAt": "2020-10-08T00:19:02Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -67,190 +64,165 @@ const ActiveRuntimeOp = ({operation, workspaceNamespace}) => {\n };\n \n export interface Props {\n-  runtimeOps: RuntimeOpsStore;\n   workspace: WorkspaceData;\n }\n \n-interface State {\n-  // Whether the initial runtime load is still in progress.\n-  loading: boolean;\n-  // Whether there was an error in loading the runtime data.\n-  error: boolean;\n-  // The runtime. null if none exists, or if there was an error in loading the\n-  // runtime.\n-  runtime: Runtime|null;\n-}\n+const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+  const {cpu, memory} = updatedMachine || initialMachineType;\n+  const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n+\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'),\n+                    fp.find({cpu: value}),\n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes)\n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}),\n+                    // If the selected machine is not different from the current machine return null\n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>;\n+};\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={updatedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>;\n+};\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(null);\n+  const [updatedMachine, setUpdatedMachine] = useState(null);\n+  const runtimeOps = useStore(runtimeOpsStore);\n+  const [currentRuntime, setRequestedRuntime] = useCustomRuntime(workspace.namespace);\n+\n+  const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+  const {status = RuntimeStatus.Unknown, toolDockerImage = '', dataprocConfig = null, gceConfig = {}} = currentRuntime || {};\n+  const masterMachineType = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n+  const updatedMachineType = updatedMachine && updatedMachine.name;\n+\n+  const isDataproc = (currentRuntime && !!currentRuntime.dataprocConfig);\n+  const runtimeChanged = updatedMachine || updatedDiskSize;\n+\n+  if (currentRuntime === undefined) {\n+    return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n+  } else if (currentRuntime === null) {\n+    // TODO(RW-5591): Create runtime page goes here.\n+    return <React.Fragment>\n+      <div>No runtime exists yet</div>\n+      {activeRuntimeOp && <hr/>}\n+      {activeRuntimeOp && <div>\n+        <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n+      </div>}\n+    </React.Fragment>;\n+  }\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n-      try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n-          promise: promise,\n-          operation: 'get',\n-          aborter: this.aborter\n-        });\n-        runtime = await promise;\n-      } catch (e) {\n-        // 404 is expected if the runtime doesn't exist, represent this as a null\n-        // runtime rather than an error mode.\n-        if (e.status !== 404) {\n-          error = true;\n+  return <div data-test-id='runtime-panel'>\n+    <h3 style={styles.sectionHeader}>Cloud analysis environment</h3>\n+    <div>\n+      Your analysis environment consists of an application and compute resources.\n+      Your cloud environment is unique to this workspace and not shared with other users.\n+    </div>\n+    {/* TODO(RW-5419): Cost estimates go here. */}\n+    <div style={styles.controlSection}>\n+      {/* Recommended runtime: pick from default templates or change the image. */}\n+      <PopupTrigger side='bottom'\n+                    closeOnClick\n+                    content={\n+                      <React.Fragment>\n+                        <MenuItem style={styles.presetMenuItem}>General purpose analysis</MenuItem>\n+                        <MenuItem style={styles.presetMenuItem}>Genomics analysis</MenuItem>\n+                      </React.Fragment>\n+                    }>\n+        <Clickable data-test-id='runtime-presets-menu'\n+                   disabled={true}>\n+          Recommended environments <ClrIcon shape='caret down'/>\n+        </Clickable>\n+      </PopupTrigger>\n+      <h3 style={styles.sectionHeader}>Application configuration</h3>\n+      {/* TODO(RW-5413): Populate the image list with server driven options. */}\n+      <Dropdown style={{width: '100%'}}\n+                data-test-id='runtime-image-dropdown'\n+                disabled={true}\n+                options={[toolDockerImage]}\n+                value={toolDockerImage}/>\n+      {/* Runtime customization: change detailed machine configuration options. */}\n+      <h3 style={styles.sectionHeader}>Cloud compute profile</h3>\n+      <FlexRow style={{justifyContent: 'space-between'}}>\n+        <MachineSelector updatedMachine={updatedMachine} onChange={setUpdatedMachine} masterMachineType={masterMachineType}/>\n+        <DiskSizeSelection updatedDiskSize={updatedDiskSize} onChange={setUpdatedDiskSize} masterDiskSize={masterDiskSize}/>\n+      </FlexRow>\n+      <FlexColumn style={{marginTop: '1rem'}}>\n+        <label htmlFor='runtime-compute'>Compute type</label>\n+        <Dropdown id='runtime-compute'\n+                  style={{width: '10rem'}}\n+                  disabled={true}\n+                  options={['Dataproc cluster', 'Standard VM']}\n+                  value={isDataproc ? 'Dataproc cluster' : 'Standard VM'}/>\n+      </FlexColumn>\n+    </div>\n+    <FlexRow style={{justifyContent: 'flex-end', marginTop: '.75rem'}}>\n+      <Button\n+        aria-label={currentRuntime ? 'Update' : 'Create'}\n+        disabled={status !== RuntimeStatus.Running || !runtimeChanged}\n+        onClick={() =>\n+          setRequestedRuntime({dataprocConfig: {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761a0f8626344adbca7eb3288fe3ffbd898be14c"}, "originalPosition": 223}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4MTgxOQ==", "bodyText": "I would also pass configurationType: RuntimeConfigurationType.UserOverride ; later this will be derived from whether or not this matches one of the presets, but that can just be a TODO for now.", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r501381819", "createdAt": "2020-10-08T00:21:37Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -67,190 +64,165 @@ const ActiveRuntimeOp = ({operation, workspaceNamespace}) => {\n };\n \n export interface Props {\n-  runtimeOps: RuntimeOpsStore;\n   workspace: WorkspaceData;\n }\n \n-interface State {\n-  // Whether the initial runtime load is still in progress.\n-  loading: boolean;\n-  // Whether there was an error in loading the runtime data.\n-  error: boolean;\n-  // The runtime. null if none exists, or if there was an error in loading the\n-  // runtime.\n-  runtime: Runtime|null;\n-}\n+const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+  const {cpu, memory} = updatedMachine || initialMachineType;\n+  const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n+\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'),\n+                    fp.find({cpu: value}),\n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes)\n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}),\n+                    // If the selected machine is not different from the current machine return null\n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>;\n+};\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={updatedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>;\n+};\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(null);\n+  const [updatedMachine, setUpdatedMachine] = useState(null);\n+  const runtimeOps = useStore(runtimeOpsStore);\n+  const [currentRuntime, setRequestedRuntime] = useCustomRuntime(workspace.namespace);\n+\n+  const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+  const {status = RuntimeStatus.Unknown, toolDockerImage = '', dataprocConfig = null, gceConfig = {}} = currentRuntime || {};\n+  const masterMachineType = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n+  const updatedMachineType = updatedMachine && updatedMachine.name;\n+\n+  const isDataproc = (currentRuntime && !!currentRuntime.dataprocConfig);\n+  const runtimeChanged = updatedMachine || updatedDiskSize;\n+\n+  if (currentRuntime === undefined) {\n+    return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n+  } else if (currentRuntime === null) {\n+    // TODO(RW-5591): Create runtime page goes here.\n+    return <React.Fragment>\n+      <div>No runtime exists yet</div>\n+      {activeRuntimeOp && <hr/>}\n+      {activeRuntimeOp && <div>\n+        <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n+      </div>}\n+    </React.Fragment>;\n+  }\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n-      try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n-          promise: promise,\n-          operation: 'get',\n-          aborter: this.aborter\n-        });\n-        runtime = await promise;\n-      } catch (e) {\n-        // 404 is expected if the runtime doesn't exist, represent this as a null\n-        // runtime rather than an error mode.\n-        if (e.status !== 404) {\n-          error = true;\n+  return <div data-test-id='runtime-panel'>\n+    <h3 style={styles.sectionHeader}>Cloud analysis environment</h3>\n+    <div>\n+      Your analysis environment consists of an application and compute resources.\n+      Your cloud environment is unique to this workspace and not shared with other users.\n+    </div>\n+    {/* TODO(RW-5419): Cost estimates go here. */}\n+    <div style={styles.controlSection}>\n+      {/* Recommended runtime: pick from default templates or change the image. */}\n+      <PopupTrigger side='bottom'\n+                    closeOnClick\n+                    content={\n+                      <React.Fragment>\n+                        <MenuItem style={styles.presetMenuItem}>General purpose analysis</MenuItem>\n+                        <MenuItem style={styles.presetMenuItem}>Genomics analysis</MenuItem>\n+                      </React.Fragment>\n+                    }>\n+        <Clickable data-test-id='runtime-presets-menu'\n+                   disabled={true}>\n+          Recommended environments <ClrIcon shape='caret down'/>\n+        </Clickable>\n+      </PopupTrigger>\n+      <h3 style={styles.sectionHeader}>Application configuration</h3>\n+      {/* TODO(RW-5413): Populate the image list with server driven options. */}\n+      <Dropdown style={{width: '100%'}}\n+                data-test-id='runtime-image-dropdown'\n+                disabled={true}\n+                options={[toolDockerImage]}\n+                value={toolDockerImage}/>\n+      {/* Runtime customization: change detailed machine configuration options. */}\n+      <h3 style={styles.sectionHeader}>Cloud compute profile</h3>\n+      <FlexRow style={{justifyContent: 'space-between'}}>\n+        <MachineSelector updatedMachine={updatedMachine} onChange={setUpdatedMachine} masterMachineType={masterMachineType}/>\n+        <DiskSizeSelection updatedDiskSize={updatedDiskSize} onChange={setUpdatedDiskSize} masterDiskSize={masterDiskSize}/>\n+      </FlexRow>\n+      <FlexColumn style={{marginTop: '1rem'}}>\n+        <label htmlFor='runtime-compute'>Compute type</label>\n+        <Dropdown id='runtime-compute'\n+                  style={{width: '10rem'}}\n+                  disabled={true}\n+                  options={['Dataproc cluster', 'Standard VM']}\n+                  value={isDataproc ? 'Dataproc cluster' : 'Standard VM'}/>\n+      </FlexColumn>\n+    </div>\n+    <FlexRow style={{justifyContent: 'flex-end', marginTop: '.75rem'}}>\n+      <Button\n+        aria-label={currentRuntime ? 'Update' : 'Create'}\n+        disabled={status !== RuntimeStatus.Running || !runtimeChanged}\n+        onClick={() =>\n+          setRequestedRuntime({dataprocConfig: {\n+            masterMachineType: updatedMachineType || masterMachineType,\n+            masterDiskSize: updatedDiskSize || masterDiskSize", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761a0f8626344adbca7eb3288fe3ffbd898be14c"}, "originalPosition": 225}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTM4MjA3Ng==", "bodyText": "I did the following test:\n\nOpened existing runtime\nobserve n1-standard-4 settings\nswitch cpu to 2\nswitch ram to 7.5\nwait\nobserve runtime deleted\nobserved runtime created; network request shows a request for n1-standard-4; expected n1-standard-2", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r501382076", "createdAt": "2020-10-08T00:22:35Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -67,190 +64,165 @@ const ActiveRuntimeOp = ({operation, workspaceNamespace}) => {\n };\n \n export interface Props {\n-  runtimeOps: RuntimeOpsStore;\n   workspace: WorkspaceData;\n }\n \n-interface State {\n-  // Whether the initial runtime load is still in progress.\n-  loading: boolean;\n-  // Whether there was an error in loading the runtime data.\n-  error: boolean;\n-  // The runtime. null if none exists, or if there was an error in loading the\n-  // runtime.\n-  runtime: Runtime|null;\n-}\n+const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+  const {cpu, memory} = updatedMachine || initialMachineType;\n+  const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n+\n+  return <Fragment>\n+    <div>\n+      <label htmlFor='runtime-cpu'\n+            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <Dropdown id='runtime-cpu'\n+                options={fp.flow(\n+                  // Show all CPU options.\n+                  fp.map('cpu'),\n+                  // In the event that was remove a machine type from our set of valid\n+                  // configs, we want to continue to allow rendering of the value here.\n+                  // Union also makes the CPU values unique.\n+                  fp.union([cpu]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.sortBy('memory'),\n+                    fp.find({cpu: value}),\n+                    maybeGetMachine,\n+                    onChange)(validLeonardoMachineTypes)\n+                }\n+                value={cpu}/>\n+    </div>\n+    <div>\n+      <label htmlFor='runtime-ram'\n+            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+      <Dropdown id='runtime-ram'\n+                options={fp.flow(\n+                  // Show valid memory options as constrained by the currently selected CPU.\n+                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+                  fp.map('memory'),\n+                  // See above comment on CPU union.\n+                  fp.union([memory]),\n+                  fp.sortBy(fp.identity)\n+                )(validLeonardoMachineTypes)}\n+                onChange={\n+                  ({value}) => fp.flow(\n+                    fp.find({cpu, memory: value}),\n+                    // If the selected machine is not different from the current machine return null\n+                    maybeGetMachine,\n+                    onChange\n+                    )(validLeonardoMachineTypes) }\n+                value={memory}\n+                />\n+    </div>\n+  </Fragment>;\n+};\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withStore(runtimeOpsStore, 'runtimeOps'))(\n-  class extends React.Component<Props, State> {\n-    private aborter = new AbortController();\n+const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n+  return <div>\n+    <label htmlFor='runtime-disk'\n+          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+      <InputNumber id='runtime-disk'\n+                showButtons\n+                decrementButtonClassName='p-button-secondary'\n+                incrementButtonClassName='p-button-secondary'\n+                value={updatedDiskSize || masterDiskSize}\n+                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n+                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </div>;\n+};\n \n-    constructor(props: Props) {\n-      super(props);\n-      this.state = {\n-        loading: true,\n-        error: false,\n-        runtime: null\n-      };\n-    }\n+export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(null);\n+  const [updatedMachine, setUpdatedMachine] = useState(null);\n+  const runtimeOps = useStore(runtimeOpsStore);\n+  const [currentRuntime, setRequestedRuntime] = useCustomRuntime(workspace.namespace);\n+\n+  const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n+  const {status = RuntimeStatus.Unknown, toolDockerImage = '', dataprocConfig = null, gceConfig = {}} = currentRuntime || {};\n+  const masterMachineType = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n+  const updatedMachineType = updatedMachine && updatedMachine.name;\n+\n+  const isDataproc = (currentRuntime && !!currentRuntime.dataprocConfig);\n+  const runtimeChanged = updatedMachine || updatedDiskSize;\n+\n+  if (currentRuntime === undefined) {\n+    return <Spinner style={{width: '100%', marginTop: '5rem'}}/>;\n+  } else if (currentRuntime === null) {\n+    // TODO(RW-5591): Create runtime page goes here.\n+    return <React.Fragment>\n+      <div>No runtime exists yet</div>\n+      {activeRuntimeOp && <hr/>}\n+      {activeRuntimeOp && <div>\n+        <ActiveRuntimeOp operation={activeRuntimeOp.operation} workspaceNamespace={workspace.namespace}/>\n+      </div>}\n+    </React.Fragment>;\n+  }\n \n-    async componentDidMount() {\n-      // TODO(RW-5420): Centralize a runtimeStore.\n-      let runtime = null;\n-      let error = false;\n-      try {\n-        const promise = runtimeApi().getRuntime(this.props.workspace.namespace, {signal: this.aborter.signal});\n-        updateRuntimeOpsStoreForWorkspaceNamespace(this.props.workspace.namespace, {\n-          promise: promise,\n-          operation: 'get',\n-          aborter: this.aborter\n-        });\n-        runtime = await promise;\n-      } catch (e) {\n-        // 404 is expected if the runtime doesn't exist, represent this as a null\n-        // runtime rather than an error mode.\n-        if (e.status !== 404) {\n-          error = true;\n+  return <div data-test-id='runtime-panel'>\n+    <h3 style={styles.sectionHeader}>Cloud analysis environment</h3>\n+    <div>\n+      Your analysis environment consists of an application and compute resources.\n+      Your cloud environment is unique to this workspace and not shared with other users.\n+    </div>\n+    {/* TODO(RW-5419): Cost estimates go here. */}\n+    <div style={styles.controlSection}>\n+      {/* Recommended runtime: pick from default templates or change the image. */}\n+      <PopupTrigger side='bottom'\n+                    closeOnClick\n+                    content={\n+                      <React.Fragment>\n+                        <MenuItem style={styles.presetMenuItem}>General purpose analysis</MenuItem>\n+                        <MenuItem style={styles.presetMenuItem}>Genomics analysis</MenuItem>\n+                      </React.Fragment>\n+                    }>\n+        <Clickable data-test-id='runtime-presets-menu'\n+                   disabled={true}>\n+          Recommended environments <ClrIcon shape='caret down'/>\n+        </Clickable>\n+      </PopupTrigger>\n+      <h3 style={styles.sectionHeader}>Application configuration</h3>\n+      {/* TODO(RW-5413): Populate the image list with server driven options. */}\n+      <Dropdown style={{width: '100%'}}\n+                data-test-id='runtime-image-dropdown'\n+                disabled={true}\n+                options={[toolDockerImage]}\n+                value={toolDockerImage}/>\n+      {/* Runtime customization: change detailed machine configuration options. */}\n+      <h3 style={styles.sectionHeader}>Cloud compute profile</h3>\n+      <FlexRow style={{justifyContent: 'space-between'}}>\n+        <MachineSelector updatedMachine={updatedMachine} onChange={setUpdatedMachine} masterMachineType={masterMachineType}/>\n+        <DiskSizeSelection updatedDiskSize={updatedDiskSize} onChange={setUpdatedDiskSize} masterDiskSize={masterDiskSize}/>\n+      </FlexRow>\n+      <FlexColumn style={{marginTop: '1rem'}}>\n+        <label htmlFor='runtime-compute'>Compute type</label>\n+        <Dropdown id='runtime-compute'\n+                  style={{width: '10rem'}}\n+                  disabled={true}\n+                  options={['Dataproc cluster', 'Standard VM']}\n+                  value={isDataproc ? 'Dataproc cluster' : 'Standard VM'}/>\n+      </FlexColumn>\n+    </div>\n+    <FlexRow style={{justifyContent: 'flex-end', marginTop: '.75rem'}}>\n+      <Button\n+        aria-label={currentRuntime ? 'Update' : 'Create'}\n+        disabled={status !== RuntimeStatus.Running || !runtimeChanged}\n+        onClick={() =>\n+          setRequestedRuntime({dataprocConfig: {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761a0f8626344adbca7eb3288fe3ffbd898be14c"}, "originalPosition": 223}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "977692489f1d9c5d0060976f10942be33aa5f21e", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/977692489f1d9c5d0060976f10942be33aa5f21e", "committedDate": "2020-10-08T19:12:10Z", "message": "Add runtime-utils test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18ea935a1a31862d1a832adffa29d76435cf7ad8", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/18ea935a1a31862d1a832adffa29d76435cf7ad8", "committedDate": "2020-10-09T14:40:01Z", "message": "PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae67ca6d5b2f90400613aedfd721ed96ef8ec246", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/ae67ca6d5b2f90400613aedfd721ed96ef8ec246", "committedDate": "2020-10-09T15:36:48Z", "message": "Merge remote-tracking branch 'origin/master' into psantos/5410-update-runtime-ui"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b8d5797b468c35d292ccc1feca59e317ebfbfe8", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/8b8d5797b468c35d292ccc1feca59e317ebfbfe8", "committedDate": "2020-10-09T18:49:27Z", "message": "Change  to gceConfig, update tests 1 merge change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eadc35d9af07233301931aa895b22d04b86cf9b3", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/eadc35d9af07233301931aa895b22d04b86cf9b3", "committedDate": "2020-10-09T20:23:11Z", "message": "Add typing to error handler, comments to test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5085320693f95549dd1e3159791e2577d0f09f66", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/5085320693f95549dd1e3159791e2577d0f09f66", "committedDate": "2020-10-09T20:54:59Z", "message": "Fix linting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDAwMTU3", "url": "https://github.com/all-of-us/workbench/pull/4100#pullrequestreview-506000157", "createdAt": "2020-10-09T21:30:39Z", "commit": {"oid": "5085320693f95549dd1e3159791e2577d0f09f66"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTozMDozOVrOHfZJog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMTozMDozOVrOHfZJog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY3OTk3MA==", "bodyText": "please remove these two lines as well; I noticed the hr/ flashing into existence during the demo", "url": "https://github.com/all-of-us/workbench/pull/4100#discussion_r502679970", "createdAt": "2020-10-09T21:30:39Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -141,7 +140,6 @@ export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n       <div>No runtime exists yet</div>\n       {activeRuntimeOp && <hr/>}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5085320693f95549dd1e3159791e2577d0f09f66"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc0f85aa1cd9ccd6135ff376248b6734a72843a0", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/bc0f85aa1cd9ccd6135ff376248b6734a72843a0", "committedDate": "2020-10-09T22:01:17Z", "message": "Switched conditional for custom runtime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "443368f6cdb3cdbf2762ac3fa389bd45f877782c", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/443368f6cdb3cdbf2762ac3fa389bd45f877782c", "committedDate": "2020-10-09T22:02:49Z", "message": "Skip test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2MDI2NDU4", "url": "https://github.com/all-of-us/workbench/pull/4100#pullrequestreview-506026458", "createdAt": "2020-10-09T22:47:30Z", "commit": {"oid": "443368f6cdb3cdbf2762ac3fa389bd45f877782c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4149, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}