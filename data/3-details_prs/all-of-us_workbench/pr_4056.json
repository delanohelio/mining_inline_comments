{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMTcxMzQ0", "number": 4056, "title": "[RW-5466][risk=no] Add versions to COPE survey attributes", "bodyText": "Implement UI for categorical (versions) and numerical attributes for COPE survey nodes.\nCOPE attributes form with categorical and numerical attributes\n\nCOPE attributes form with 'Any version' and 'Any value' selected\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n I have run and tested this change locally\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer", "createdAt": "2020-09-24T04:16:38Z", "url": "https://github.com/all-of-us/workbench/pull/4056", "merged": true, "mergeCommit": {"oid": "959d28198cd80fb3ac0c451b35bb6f4b2574fb51"}, "closed": true, "closedAt": "2020-09-29T22:32:30Z", "author": {"login": "dolbeew"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMDAkoAFqTQ5NTcwMDc0MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNrmVBAH2gAyNDkyMTcxMzQ0OmIyMzE5NjZmN2NlMTFiZjc2NjJhYWQ5OTc4ZTc5Y2ZhNmQ5MzMzNTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NzAwNzQx", "url": "https://github.com/all-of-us/workbench/pull/4056#pullrequestreview-495700741", "createdAt": "2020-09-24T15:34:40Z", "commit": {"oid": "31f22ec13ae788436b34f6bae2195b79388bb184"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNTozNDo0MFrOHXgxag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNTozNDo0MFrOHXgxag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQxNjIzNA==", "bodyText": "nit: We can get rid of else if have, form.anyValue = checked", "url": "https://github.com/all-of-us/workbench/pull/4056#discussion_r494416234", "createdAt": "2020-09-24T15:34:40Z", "author": {"login": "NehaBroad"}, "path": "ui/src/app/cohort-search/attributes-page-v2/attributes-page-v2.component.tsx", "diffHunk": "@@ -258,21 +339,30 @@ export const AttributesPageV2 = fp.flow(withCurrentWorkspace(), withCurrentCohor\n       });\n     }\n \n-    toggleCheckbox(checked: boolean) {\n+    toggleAnyValueCheckbox(checked: boolean) {\n       const {form} = this.state;\n       let {node: {count}} = this.props;\n       if (checked) {\n-        form.exists = true;\n+        form.anyValue = true;\n         form.num = form.num.map(attr =>\n           ({...attr, operator: this.isPhysicalMeasurement ? 'ANY' : null, operands: []}));\n         form.cat = form.cat.map(attr => ({...attr, checked: false}));\n       } else {\n+        form.anyValue = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31f22ec13ae788436b34f6bae2195b79388bb184"}, "originalPosition": 221}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NzA0MTIz", "url": "https://github.com/all-of-us/workbench/pull/4056#pullrequestreview-495704123", "createdAt": "2020-09-24T15:38:21Z", "commit": {"oid": "31f22ec13ae788436b34f6bae2195b79388bb184"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNTozODoyMlrOHXg75A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNTozODoyMlrOHXg75A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQxODkxNg==", "bodyText": "!isCOPESurvey  will always be true", "url": "https://github.com/all-of-us/workbench/pull/4056#discussion_r494418916", "createdAt": "2020-09-24T15:38:22Z", "author": {"login": "NehaBroad"}, "path": "ui/src/app/cohort-search/attributes-page-v2/attributes-page-v2.component.tsx", "diffHunk": "@@ -522,18 +614,102 @@ export const AttributesPageV2 = fp.flow(withCurrentWorkspace(), withCurrentCohor\n       return this.isMeasurement || this.isSurvey;\n     }\n \n+    renderNumericalAttributes() {\n+      const {node: {count, subtype}} = this.props;\n+      const {form, isCOPESurvey, options} = this.state;\n+      return form.num.length > 0 && <React.Fragment>\n+        {this.isMeasurement && <div style={styles.label}>Numeric Values</div>}\n+        {isCOPESurvey && <div>\n+          <CheckBox onChange={(v) => this.toggleAnyValueCheckbox(v)}/> Any value\n+          {count > -1 && <span style={styles.badge}> {count.toLocaleString()}</span>}\n+        </div>}\n+        {!(isCOPESurvey && form.anyValue) && form.num.map((attr, a) => <div key={a}>\n+          {this.isBloodPressure && <div style={styles.label}>{attr.name}</div>}\n+          {isCOPESurvey && <div style={styles.orCircle}>OR</div>}\n+          <Dropdown style={{marginBottom: '0.5rem', width: '100%'}}\n+                    value={attr.operator}\n+                    options={options}\n+                    placeholder='Select Operator'\n+                    onChange={(e) => this.selectChange(a, e.value)}/>\n+          <FlexRowWrap>\n+            {![null, 'ANY'].includes(attr.operator) && <div style={{width: '33%'}}>\n+              <NumberInput style={{padding: '0 0.25rem', ...(this.hasUnits ? {width: '70%'} : {})}}\n+                           value={attr.operands[0] || ''}\n+                           min={attr.MIN} max={attr.MAX}\n+                           onChange={(v) => this.inputChange(v, a, 0)}/>\n+              {this.hasUnits && <span> {PM_UNITS[subtype]}</span>}\n+            </div>}\n+            {attr.operator === Operator.BETWEEN && <React.Fragment>\n+              <div style={{padding: '0.2rem 1.5rem 0 1rem'}}>and</div>\n+              <div style={{width: '33%'}}>\n+                <NumberInput style={{padding: '0 0.25rem', ...(this.hasUnits ? {width: '70%'} : {})}}\n+                             value={attr.operands[1] || ''}\n+                             min={attr.MIN} max={attr.MAX}\n+                             onChange={(v) => this.inputChange(v, a, 1)}/>\n+                {this.hasUnits && <span> {PM_UNITS[subtype]}</span>}\n+              </div>\n+            </React.Fragment>}\n+          </FlexRowWrap>\n+          {this.hasRange && ![null, 'ANY'].includes(attr.operator) && <div style={{paddingTop: '0.2rem'}}>\n+            Range: {attr.MIN.toLocaleString()} - {attr.MAX.toLocaleString()}\n+          </div>}\n+        </div>)}\n+      </React.Fragment>;\n+    }\n+\n+    renderCategoricalAttributes() {\n+      const {node: {count}} = this.props;\n+      const {form, isCOPESurvey} = this.state;\n+      return form.cat.length > 0 && <React.Fragment>\n+        {isCOPESurvey && <div>\n+          <CheckBox onChange={(v) => this.toggleAnyVersionCheckbox(v)}/> Any version\n+          {count > -1 && <span style={styles.badge}>{count.toLocaleString()}</span>}\n+        </div>}\n+        {!(isCOPESurvey && form.anyVersion) && <React.Fragment>\n+          <div style={styles.orCircle}>OR</div>\n+          {!isCOPESurvey && <div style={styles.label}>Categorical Values</div>}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31f22ec13ae788436b34f6bae2195b79388bb184"}, "originalPosition": 362}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NzA1NjI1", "url": "https://github.com/all-of-us/workbench/pull/4056#pullrequestreview-495705625", "createdAt": "2020-09-24T15:39:58Z", "commit": {"oid": "31f22ec13ae788436b34f6bae2195b79388bb184"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNTozOTo1OFrOHXhAYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNTozOTo1OFrOHXhAYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQyMDA2Nw==", "bodyText": "Can you move this to a method just so its easier to read?", "url": "https://github.com/all-of-us/workbench/pull/4056#discussion_r494420067", "createdAt": "2020-09-24T15:39:58Z", "author": {"login": "NehaBroad"}, "path": "ui/src/app/cohort-search/attributes-page-v2/attributes-page-v2.component.tsx", "diffHunk": "@@ -522,18 +614,102 @@ export const AttributesPageV2 = fp.flow(withCurrentWorkspace(), withCurrentCohor\n       return this.isMeasurement || this.isSurvey;\n     }\n \n+    renderNumericalAttributes() {\n+      const {node: {count, subtype}} = this.props;\n+      const {form, isCOPESurvey, options} = this.state;\n+      return form.num.length > 0 && <React.Fragment>\n+        {this.isMeasurement && <div style={styles.label}>Numeric Values</div>}\n+        {isCOPESurvey && <div>\n+          <CheckBox onChange={(v) => this.toggleAnyValueCheckbox(v)}/> Any value\n+          {count > -1 && <span style={styles.badge}> {count.toLocaleString()}</span>}\n+        </div>}\n+        {!(isCOPESurvey && form.anyValue) && form.num.map((attr, a) => <div key={a}>\n+          {this.isBloodPressure && <div style={styles.label}>{attr.name}</div>}\n+          {isCOPESurvey && <div style={styles.orCircle}>OR</div>}\n+          <Dropdown style={{marginBottom: '0.5rem', width: '100%'}}\n+                    value={attr.operator}\n+                    options={options}\n+                    placeholder='Select Operator'\n+                    onChange={(e) => this.selectChange(a, e.value)}/>\n+          <FlexRowWrap>\n+            {![null, 'ANY'].includes(attr.operator) && <div style={{width: '33%'}}>\n+              <NumberInput style={{padding: '0 0.25rem', ...(this.hasUnits ? {width: '70%'} : {})}}\n+                           value={attr.operands[0] || ''}\n+                           min={attr.MIN} max={attr.MAX}\n+                           onChange={(v) => this.inputChange(v, a, 0)}/>\n+              {this.hasUnits && <span> {PM_UNITS[subtype]}</span>}\n+            </div>}\n+            {attr.operator === Operator.BETWEEN && <React.Fragment>\n+              <div style={{padding: '0.2rem 1.5rem 0 1rem'}}>and</div>\n+              <div style={{width: '33%'}}>\n+                <NumberInput style={{padding: '0 0.25rem', ...(this.hasUnits ? {width: '70%'} : {})}}\n+                             value={attr.operands[1] || ''}\n+                             min={attr.MIN} max={attr.MAX}\n+                             onChange={(v) => this.inputChange(v, a, 1)}/>\n+                {this.hasUnits && <span> {PM_UNITS[subtype]}</span>}\n+              </div>\n+            </React.Fragment>}\n+          </FlexRowWrap>\n+          {this.hasRange && ![null, 'ANY'].includes(attr.operator) && <div style={{paddingTop: '0.2rem'}}>\n+            Range: {attr.MIN.toLocaleString()} - {attr.MAX.toLocaleString()}\n+          </div>}\n+        </div>)}\n+      </React.Fragment>;\n+    }\n+\n+    renderCategoricalAttributes() {\n+      const {node: {count}} = this.props;\n+      const {form, isCOPESurvey} = this.state;\n+      return form.cat.length > 0 && <React.Fragment>\n+        {isCOPESurvey && <div>\n+          <CheckBox onChange={(v) => this.toggleAnyVersionCheckbox(v)}/> Any version\n+          {count > -1 && <span style={styles.badge}>{count.toLocaleString()}</span>}\n+        </div>}\n+        {!(isCOPESurvey && form.anyVersion) && <React.Fragment>\n+          <div style={styles.orCircle}>OR</div>\n+          {!isCOPESurvey && <div style={styles.label}>Categorical Values</div>}\n+          {form.cat.map((attr, a) => <div key={a} style={styles.categorical}>\n+            <CheckBox checked={attr.checked} style={{marginRight: '3px'}}\n+                      onChange={(v) => this.checkboxChange(v, a)}/>\n+            {attr.conceptName}\n+            <span style={styles.badge}>{parseInt(attr.estCount, 10).toLocaleString()}</span>\n+          </div>)}\n+        </React.Fragment>}\n+      </React.Fragment>;\n+    }\n+\n     render() {\n       const {close, node: {domainId, name, parentId, subtype}} = this.props;\n-      const {calculating, count, countError, form, loading, options} = this.state;\n+      const {calculating, count, countError, form, isCOPESurvey, loading} = this.state;\n       const {formErrors, formValid} = this.validateForm();\n       const disableAdd = calculating || !formValid;\n-      const disableCalculate = disableAdd || form.exists || form.num.every(attr => attr.operator === 'ANY');\n+      const disableCalculate = disableAdd\n+        || (form.anyValue && count !== null)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31f22ec13ae788436b34f6bae2195b79388bb184"}, "originalPosition": 381}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NjI2NTQ5", "url": "https://github.com/all-of-us/workbench/pull/4056#pullrequestreview-498626549", "createdAt": "2020-09-29T15:39:18Z", "commit": {"oid": "e9bd83f68fb93f558b46ddc51ef826e1ad04fe7c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e578a1f9554967102aff83add86f6ed8a90dfd0", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/5e578a1f9554967102aff83add86f6ed8a90dfd0", "committedDate": "2020-09-29T16:30:10Z", "message": "RW-5466 get cope survey versions for attributes page"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca77b15ce5ab19d4da4cb5e04de9d1c26600768b", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/ca77b15ce5ab19d4da4cb5e04de9d1c26600768b", "committedDate": "2020-09-29T16:30:10Z", "message": "RW-5466 add call for cope survey answers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c381e964e7b697f4ad498d898eefc31a8dbd3c0a", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/c381e964e7b697f4ad498d898eefc31a8dbd3c0a", "committedDate": "2020-09-29T16:30:10Z", "message": "RW-5466 add call for numerical attributes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10971527308cc7de16d272d04c33523d0634f37a", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/10971527308cc7de16d272d04c33523d0634f37a", "committedDate": "2020-09-29T16:30:10Z", "message": "RW-5466 add cope boolean to state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6e521bbd5ef81f676811617a50788c6bb4ba791", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/a6e521bbd5ef81f676811617a50788c6bb4ba791", "committedDate": "2020-09-29T16:30:11Z", "message": "RW-5466 update template for cope attributes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2ab9ea7d5479d8cb3d2adc9034479979a5ef485", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/f2ab9ea7d5479d8cb3d2adc9034479979a5ef485", "committedDate": "2020-09-29T16:30:11Z", "message": "RW-5466 update request for answer attributes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07cd98b0b82c3d60b45bc059ac1e6e56d9cab7f1", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/07cd98b0b82c3d60b45bc059ac1e6e56d9cab7f1", "committedDate": "2020-09-29T16:33:32Z", "message": "RW-5466 update COPE attribute form layout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b630a49dd5882b85859815d7fcbc9183e80b471e", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/b630a49dd5882b85859815d7fcbc9183e80b471e", "committedDate": "2020-09-29T16:33:32Z", "message": "RW-5466 update layout for COPE attributes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a9fb304004ab9bca30c9b0baa233eaf8a7cc839", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/8a9fb304004ab9bca30c9b0baa233eaf8a7cc839", "committedDate": "2020-09-29T16:33:32Z", "message": "RW-5466 fix form validation for COPE attributes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05907741746342a0b5ad45d1b5dd49b69a4408b9", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/05907741746342a0b5ad45d1b5dd49b69a4408b9", "committedDate": "2020-09-29T16:33:32Z", "message": "RW-5466 remove mocked data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d21df631003b66de953e6359e725f4949bc88aff", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/d21df631003b66de953e6359e725f4949bc88aff", "committedDate": "2020-09-29T16:35:44Z", "message": "RW-5466 pr feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9bd83f68fb93f558b46ddc51ef826e1ad04fe7c", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/e9bd83f68fb93f558b46ddc51ef826e1ad04fe7c", "committedDate": "2020-09-24T20:05:45Z", "message": "RW-5466 pr feedback"}, "afterCommit": {"oid": "d21df631003b66de953e6359e725f4949bc88aff", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/d21df631003b66de953e6359e725f4949bc88aff", "committedDate": "2020-09-29T16:35:44Z", "message": "RW-5466 pr feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b231966f7ce11bf7662aad9978e79cfa6d933358", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/b231966f7ce11bf7662aad9978e79cfa6d933358", "committedDate": "2020-09-29T17:26:02Z", "message": "RW-5466 fix switch between survey attribute types"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4093, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}