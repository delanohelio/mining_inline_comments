{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MzQxOTM4", "number": 3833, "title": "[no ticket][risk=no] Puppeteer: modal clickButton function with optional waitFor parameters", "bodyText": "Sometimes, click a button in modal should close the modal or/and causes page to change/navigate away. User has to remember to call waitUntilClose or/and this.page.navigation functions explicitly in order to keep test steps and UI in sync. The refactoredclickButton function will make it easy to read and write lesser code when click a button in modal.\nNew function signature is clickButton(buttonLabel: LinkText, waitOptions: {waitForNav?: boolean, waitForClose?: boolean} = {}).\nAll tests verified to pass.", "createdAt": "2020-07-27T18:56:02Z", "url": "https://github.com/all-of-us/workbench/pull/3833", "merged": true, "mergeCommit": {"oid": "8185ffc14d59bc6111b37b15d8b953d49ead2731"}, "closed": true, "closedAt": "2020-08-03T22:09:33Z", "author": {"login": "aweng98"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7VON8gFqTQ2MDE0OTczMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7ZEhngBqjM2MTc2OTEzNzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMTQ5NzMz", "url": "https://github.com/all-of-us/workbench/pull/3833#pullrequestreview-460149733", "createdAt": "2020-08-03T16:02:31Z", "commit": {"oid": "924e3cb7615d75d449a5060670968b8de01c8a9d"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNjowMjozMVrOG6_YNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNjo0NDoyMlrOG7AzCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUwODk4MA==", "bodyText": "promisesArray needs the spread operator, otherwise the Promise.all will resolve after button.click", "url": "https://github.com/all-of-us/workbench/pull/3833#discussion_r464508980", "createdAt": "2020-08-03T16:02:31Z", "author": {"login": "petesantos"}, "path": "e2e/app/component/modal.ts", "diffHunk": "@@ -39,10 +39,26 @@ export default class Modal extends Container {\n     return modalText.toString();\n   }\n \n-  async clickButton(buttonLabel: LinkText): Promise<void> {\n+  /**\n+   * Click a button.\n+   * @param {string} buttonLabel The button text label.\n+   * @param waitOptions Wait for navigation or/and modal close after click button.\n+   */\n+  async clickButton(buttonLabel: LinkText, waitOptions: {waitForNav?: boolean, waitForClose?: boolean} = {}): Promise<void> {\n+    const { waitForNav = false, waitForClose = false } = waitOptions;\n     const button = await this.waitForButton(buttonLabel);\n     await button.waitUntilEnabled();\n-    return button.click();\n+    const promisesArray = [];\n+    if (waitForClose) {\n+      promisesArray.push(this.waitUntilClose());\n+    }\n+    if (waitForNav) {\n+      promisesArray.push(this.page.waitForNavigation({waitUntil: ['domcontentloaded', 'networkidle0']}));\n+    }\n+    await Promise.all([\n+      promisesArray,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "924e3cb7615d75d449a5060670968b8de01c8a9d"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUxMDc3NA==", "bodyText": "nit: Would setting the default/false values in the signature work, simplifying the code a bit?", "url": "https://github.com/all-of-us/workbench/pull/3833#discussion_r464510774", "createdAt": "2020-08-03T16:05:42Z", "author": {"login": "petesantos"}, "path": "e2e/app/component/modal.ts", "diffHunk": "@@ -39,10 +39,26 @@ export default class Modal extends Container {\n     return modalText.toString();\n   }\n \n-  async clickButton(buttonLabel: LinkText): Promise<void> {\n+  /**\n+   * Click a button.\n+   * @param {string} buttonLabel The button text label.\n+   * @param waitOptions Wait for navigation or/and modal close after click button.\n+   */\n+  async clickButton(buttonLabel: LinkText, waitOptions: {waitForNav?: boolean, waitForClose?: boolean} = {}): Promise<void> {\n+    const { waitForNav = false, waitForClose = false } = waitOptions;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "924e3cb7615d75d449a5060670968b8de01c8a9d"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUxNzA2Mg==", "bodyText": "Did anyone use the waitUntilClosed parameter / should this continue to be passed through?", "url": "https://github.com/all-of-us/workbench/pull/3833#discussion_r464517062", "createdAt": "2020-08-03T16:16:40Z", "author": {"login": "petesantos"}, "path": "e2e/app/page/cohort-criteria-modal.ts", "diffHunk": "@@ -123,12 +123,8 @@ export default class CohortCriteriaModal extends Modal {\n   /**\n    * Click FINISH button.\n    */\n-  async clickFinishButton(opt: {waitUntilClosed?: boolean} = {}): Promise<void> {\n-    const { waitUntilClosed = true } = opt\n-    await this.clickButton(LinkText.Finish);\n-    if (waitUntilClosed) {\n-      await this.waitUntilClose();\n-    }\n+  async clickFinishButton(): Promise<void> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "924e3cb7615d75d449a5060670968b8de01c8a9d"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyMDM3Mg==", "bodyText": "TOL - without the context of this change I am not sure why the additional code is no longer needed", "url": "https://github.com/all-of-us/workbench/pull/3833#discussion_r464520372", "createdAt": "2020-08-03T16:22:33Z", "author": {"login": "petesantos"}, "path": "e2e/app/page/conceptset-page.ts", "diffHunk": "@@ -35,11 +35,7 @@ export default class ConceptsetPage extends AuthenticatedPage {\n   async openCopyToWorkspaceModal(conceptName: string): Promise<ConceptsetCopyModal> {\n     const ellipsis = this.getEllipsisMenu(conceptName);\n     await ellipsis.clickAction(EllipsisMenuAction.CopyToAnotherWorkspace, {waitForNav: false});\n-    const modal = new ConceptsetCopyModal(this.page);\n-    await modal.waitUntilVisible();\n-    await modal.getDestinationTextbox();\n-    await modal.getNameTextbox();\n-    return modal;\n+    return new ConceptsetCopyModal(this.page);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "924e3cb7615d75d449a5060670968b8de01c8a9d"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUzMjIzMw==", "bodyText": "What are your thoughts on an alternative approach - something like:\n    await Promise.all( fp.flow(\n      fp.filter('shouldWait'),\n      fp.map(({waitFn}) => waitFn()),\n      fp.concat([button.click()])\n    )([\n      {shouldWait: waitForNav, waitFn: () => this.page.waitForNavigation({waitUntil: ['domcontentloaded', 'networkidle0']})}, \n      {shouldWait: waitForClose, waitFn: () => this.waitUntilClose()}\n      ])\n\u00a0\u00a0)\nThis will prevent the need for creating and mutating the array an also eliminates the imperative conditionals. If you want to add a new option later it would just be an addition to the array.", "url": "https://github.com/all-of-us/workbench/pull/3833#discussion_r464532233", "createdAt": "2020-08-03T16:44:22Z", "author": {"login": "petesantos"}, "path": "e2e/app/component/modal.ts", "diffHunk": "@@ -39,10 +39,26 @@ export default class Modal extends Container {\n     return modalText.toString();\n   }\n \n-  async clickButton(buttonLabel: LinkText): Promise<void> {\n+  /**\n+   * Click a button.\n+   * @param {string} buttonLabel The button text label.\n+   * @param waitOptions Wait for navigation or/and modal close after click button.\n+   */\n+  async clickButton(buttonLabel: LinkText, waitOptions: {waitForNav?: boolean, waitForClose?: boolean} = {}): Promise<void> {\n+    const { waitForNav = false, waitForClose = false } = waitOptions;\n     const button = await this.waitForButton(buttonLabel);\n     await button.waitUntilEnabled();\n-    return button.click();\n+    const promisesArray = [];\n+    if (waitForClose) {\n+      promisesArray.push(this.waitUntilClose());\n+    }\n+    if (waitForNav) {\n+      promisesArray.push(this.page.waitForNavigation({waitUntil: ['domcontentloaded', 'networkidle0']}));\n+    }\n+    await Promise.all([\n+      promisesArray,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "924e3cb7615d75d449a5060670968b8de01c8a9d"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70ea0ba4adfe04cf4c9db61e1353f88ae3c202fe", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/70ea0ba4adfe04cf4c9db61e1353f88ae3c202fe", "committedDate": "2020-08-03T21:39:03Z", "message": "dialog button with optional waitFor parameters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8857ba12b955a2ded82b5f1ca684d5575e9ab9d3", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/8857ba12b955a2ded82b5f1ca684d5575e9ab9d3", "committedDate": "2020-08-03T21:39:03Z", "message": "minor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e68deac823116211f4bc141eeaa93fe272cebe5", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/4e68deac823116211f4bc141eeaa93fe272cebe5", "committedDate": "2020-08-03T21:39:03Z", "message": "PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6f3db3fca58e5c683ce2c222ad310e9ca110fd4", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/b6f3db3fca58e5c683ce2c222ad310e9ca110fd4", "committedDate": "2020-08-03T21:39:03Z", "message": "PR feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cdb8d4cc0bde557ab4f25a5e3a6b0712cd2779ad", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/cdb8d4cc0bde557ab4f25a5e3a6b0712cd2779ad", "committedDate": "2020-08-03T21:35:49Z", "message": "PR feedback"}, "afterCommit": {"oid": "b6f3db3fca58e5c683ce2c222ad310e9ca110fd4", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/b6f3db3fca58e5c683ce2c222ad310e9ca110fd4", "committedDate": "2020-08-03T21:39:03Z", "message": "PR feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4506, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}