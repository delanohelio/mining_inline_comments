{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5ODk5NzY3", "number": 3493, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNTo1NzowOFrOD3CDgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMDo0MToxN1rOD3IjZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MDMxOTM5OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNTo1NzowOFrOGND02g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMDoyNjo1MVrOGNNYJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM0NzM1NA==", "bodyText": "Not related to this Story but i noticed this information was not being send as part of exportResearcher hence updated it as well", "url": "https://github.com/all-of-us/workbench/pull/3493#discussion_r416347354", "createdAt": "2020-04-28T05:57:08Z", "author": {"login": "NehaBroad"}, "path": "api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java", "diffHunk": "@@ -258,10 +258,11 @@ private RdrResearcher toRdrResearcher(DbUser dbUser) {\n                       ? verifiedInstitutionalAffiliation.getInstitutionalRoleOtherText()\n                       : roleEnum.toString();\n \n-              new ResearcherVerifiedInstitutionalAffiliation()\n-                  .institutionShortName(\n-                      verifiedInstitutionalAffiliation.getInstitution().getShortName())\n-                  .institutionalRole(role);\n+              researcher.setVerifiedInstitutionalAffiliation(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c57c5eb587423a6d7aac5722198c92e25f811863"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUwMzg0Ng==", "bodyText": "good catch, that seems important :)", "url": "https://github.com/all-of-us/workbench/pull/3493#discussion_r416503846", "createdAt": "2020-04-28T10:26:51Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java", "diffHunk": "@@ -258,10 +258,11 @@ private RdrResearcher toRdrResearcher(DbUser dbUser) {\n                       ? verifiedInstitutionalAffiliation.getInstitutionalRoleOtherText()\n                       : roleEnum.toString();\n \n-              new ResearcherVerifiedInstitutionalAffiliation()\n-                  .institutionShortName(\n-                      verifiedInstitutionalAffiliation.getInstitution().getShortName())\n-                  .institutionalRole(role);\n+              researcher.setVerifiedInstitutionalAffiliation(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjM0NzM1NA=="}, "originalCommit": {"oid": "c57c5eb587423a6d7aac5722198c92e25f811863"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MTM4NDA2OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMDo0MToxN1rOGNN4PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMDo0MToxN1rOGNN4PQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUxMjA2MQ==", "bodyText": "Please make this a file-level constant. Or, better yet, most of this method might be better placed within the institution service, e.g. institutionService.isOperationalUser(dbUser user). That would centralize the logic within the institution package, and I don't think it would require adding any new deps to the institution service.\nSlightly tangential thought: I'm concerned that we're at risk of putting load-bearing system weight on the shortName identifier, which can be changed by operational end-users via the Institution UI at any time. This is a pretty serious red flag, and we should think about ways to make sure far-flung business logic can't be impacted by someone deciding in an admin UI that \"AouOps\" should be capitalized differently, or have a space added, etc. etc.\nI filed https://precisionmedicineinitiative.atlassian.net/browse/RW-4844 to track \u2013\u00a0I'd suggest following up with Joel & Karthik to align on a solution for this.", "url": "https://github.com/all-of-us/workbench/pull/3493#discussion_r416512061", "createdAt": "2020-04-28T10:41:17Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/rdr/RdrExportServiceImpl.java", "diffHunk": "@@ -435,4 +436,25 @@ public void updateDbRdrExport(RdrEntity entity, List<Long> idList) {\n             .collect(Collectors.toList());\n     rdrExportDao.save(exportList);\n   }\n+\n+  /**\n+   * Set excludeFromPublicDirectory to true if the workspace creator is an operational user i.e has\n+   * Institution as All of Us Program operational Use\n+   *\n+   * @param creatorUser\n+   * @param rdrWorkspace\n+   */\n+  void setExcludeFromPublicDirectory(DbUser creatorUser, RdrWorkspace rdrWorkspace) {\n+    rdrWorkspace.setExcludeFromPublicDirectory(false);\n+    verifiedInstitutionalAffiliationDao\n+        .findFirstByUser(creatorUser)\n+        .ifPresent(\n+            verifiedInstitutionalAffiliation -> {\n+              rdrWorkspace.setExcludeFromPublicDirectory(\n+                  verifiedInstitutionalAffiliation\n+                      .getInstitution()\n+                      .getShortName()\n+                      .equals(\"AouOps\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c57c5eb587423a6d7aac5722198c92e25f811863"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2823, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}