{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzOTU5NDI5", "number": 3985, "title": "[risk=low][RW-3627] Delete project when deleting workspace", "bodyText": "Description:\nDRAFT.  This will fail until broadinstitute/firecloud-orchestration#799 is live\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test:local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-09-10T14:53:26Z", "url": "https://github.com/all-of-us/workbench/pull/3985", "merged": true, "mergeCommit": {"oid": "b3d0ecafc70efb7a8b38cb9fe7dd1ec3a54c3532"}, "closed": true, "closedAt": "2020-09-17T21:06:21Z", "author": {"login": "jmthibault79"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHq4D0gBqjM3NTM4MTk2NTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJ1-IPgBqjM3Nzk1MjE4OTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3ed10c50b3cf03f4d8b20a8cfb6cae4e6a137c7f", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/3ed10c50b3cf03f4d8b20a8cfb6cae4e6a137c7f", "committedDate": "2020-09-10T14:50:06Z", "message": "fix imports"}, "afterCommit": {"oid": "bb82c25d8b451b7819038402dd1f232448578371", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/bb82c25d8b451b7819038402dd1f232448578371", "committedDate": "2020-09-11T01:09:50Z", "message": "Correct endpoint auth"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bb82c25d8b451b7819038402dd1f232448578371", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/bb82c25d8b451b7819038402dd1f232448578371", "committedDate": "2020-09-11T01:09:50Z", "message": "Correct endpoint auth"}, "afterCommit": {"oid": "b729b9eef7f634407a7541c7fc68d7ca14af0271", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/b729b9eef7f634407a7541c7fc68d7ca14af0271", "committedDate": "2020-09-14T21:12:25Z", "message": "Audit-log Billing Project Deletion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjA0MDY0", "url": "https://github.com/all-of-us/workbench/pull/3985#pullrequestreview-488204064", "createdAt": "2020-09-14T22:40:32Z", "commit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMjo0MDozMlrOHRqAiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQyMjo0MDozMlrOHRqAiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODI3NjEwNw==", "bodyText": "I needed to add this MockBean to a lot of tests after adding it to the WorkspaceServiceImpl constructor.", "url": "https://github.com/all-of-us/workbench/pull/3985#discussion_r488276107", "createdAt": "2020-09-14T22:40:32Z", "author": {"login": "jmthibault79"}, "path": "api/src/bigquerytest/java/org/pmiops/workbench/api/CohortReviewControllerBQTest.java", "diffHunk": "@@ -21,6 +21,7 @@\n import org.junit.Before;\n import org.junit.Test;\n import org.junit.runner.RunWith;\n+import org.pmiops.workbench.actionaudit.auditors.BillingProjectAuditor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMDIwOTg3", "url": "https://github.com/all-of-us/workbench/pull/3985#pullrequestreview-490020987", "createdAt": "2020-09-16T21:06:48Z", "commit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNTk3NDc1", "url": "https://github.com/all-of-us/workbench/pull/3985#pullrequestreview-490597475", "createdAt": "2020-09-17T13:31:43Z", "commit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzozMTo0M1rOHTiWoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzozOTo0NVrOHTivGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI0Nzg0MA==", "bodyText": "Maybe for later, but if you find bundles of dependencies that are frequently needed together, you can make a stand-alone test configuration class with them and import that.", "url": "https://github.com/all-of-us/workbench/pull/3985#discussion_r490247840", "createdAt": "2020-09-17T13:31:43Z", "author": {"login": "jaycarlton"}, "path": "api/src/bigquerytest/java/org/pmiops/workbench/api/CohortReviewControllerBQTest.java", "diffHunk": "@@ -103,30 +104,31 @@\n     CohortMapperImpl.class,\n     CohortQueryBuilder.class,\n     CohortReviewMapperImpl.class,\n+    CohortReviewMapperImpl.class,\n     CohortReviewServiceImpl.class,\n     CommonMappers.class,\n+    CommonMappers.class,\n     ConceptSetMapperImpl.class,\n     DataSetMapperImpl.class,\n     FirecloudMapperImpl.class,\n+    ParticipantCohortAnnotationMapperImpl.class,\n+    ParticipantCohortStatusMapperImpl.class,\n     ReviewQueryBuilder.class,\n     SearchGroupItemQueryBuilder.class,\n     UserMapperImpl.class,\n     WorkspaceMapperImpl.class,\n     WorkspaceServiceImpl.class,\n-    ParticipantCohortStatusMapperImpl.class,\n-    CohortReviewMapperImpl.class,\n-    ParticipantCohortAnnotationMapperImpl.class,\n-    CommonMappers.class\n   })\n   @MockBean({\n-    CohortFactory.class,\n+    BillingProjectAuditor.class,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI0OTM2Ng==", "bodyText": "nit: you should be able to omit the return statement.", "url": "https://github.com/all-of-us/workbench/pull/3985#discussion_r490249366", "createdAt": "2020-09-17T13:33:26Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/firecloud/FireCloudServiceImpl.java", "diffHunk": "@@ -270,6 +270,16 @@ public void createAllOfUsBillingProject(String projectName) {\n         });\n   }\n \n+  @Override\n+  public void deleteBillingProject(String billingProject) {\n+    BillingApi billingApi = billingApiProvider.get();\n+    retryHandler.run(\n+        (context) -> {\n+          billingApi.deleteBillingProject(billingProject);\n+          return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MDEwOQ==", "bodyText": "What happens if it's not found? Do we want  the delete method to throw an exception, or just return success (i.e. be idempotent)?", "url": "https://github.com/all-of-us/workbench/pull/3985#discussion_r490250109", "createdAt": "2020-09-17T13:34:16Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/firecloud/FireCloudServiceImpl.java", "diffHunk": "@@ -270,6 +270,16 @@ public void createAllOfUsBillingProject(String projectName) {\n         });\n   }\n \n+  @Override\n+  public void deleteBillingProject(String billingProject) {\n+    BillingApi billingApi = billingApiProvider.get();\n+    retryHandler.run(\n+        (context) -> {\n+          billingApi.deleteBillingProject(billingProject);\n+          return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI0OTM2Ng=="}, "originalCommit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MTAxNQ==", "bodyText": "Have you thought through the transactionality of errors here? If we succeed in deleting the workspace, but fail to delete the project, are we happy?", "url": "https://github.com/all-of-us/workbench/pull/3985#discussion_r490251015", "createdAt": "2020-09-17T13:35:27Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java", "diffHunk": "@@ -306,6 +310,10 @@ public void deleteWorkspace(DbWorkspace dbWorkspace) {\n     dbWorkspace.setWorkspaceActiveStatusEnum(WorkspaceActiveStatus.DELETED);\n     dbWorkspace = saveWithLastModified(dbWorkspace);\n     maybeDeleteRecentWorkspace(dbWorkspace.getWorkspaceId());\n+\n+    String billingProjectName = dbWorkspace.getWorkspaceNamespace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MTYwNA==", "bodyText": "Does this immediately expunge the GCP project, or does it get put into a queue for deletion? There's no wrong answer, as long as everyone understands the behavior.", "url": "https://github.com/all-of-us/workbench/pull/3985#discussion_r490251604", "createdAt": "2020-09-17T13:36:14Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/firecloud/FireCloudServiceImpl.java", "diffHunk": "@@ -270,6 +270,16 @@ public void createAllOfUsBillingProject(String projectName) {\n         });\n   }\n \n+  @Override\n+  public void deleteBillingProject(String billingProject) {\n+    BillingApi billingApi = billingApiProvider.get();\n+    retryHandler.run(\n+        (context) -> {\n+          billingApi.deleteBillingProject(billingProject);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MjEzMA==", "bodyText": "Please elaborate on this, potentially for folks who haven't worked with the billing system or have forgotten what a billing project is.", "url": "https://github.com/all-of-us/workbench/pull/3985#discussion_r490252130", "createdAt": "2020-09-17T13:36:57Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/resources/firecloud.yaml", "diffHunk": "@@ -264,6 +264,39 @@ paths:\n           - openid\n           - email\n           - profile\n+  /api/user/billing/{projectName}:\n+    delete:\n+      tags:\n+        - Billing\n+      summary: delete billing project\n+      description: delete billing project", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1Mjk3Ng==", "bodyText": "Does this behave the same for user-provided billing projects and free tier billing projects/accounts? Do we need to update spend totals before killing it?", "url": "https://github.com/all-of-us/workbench/pull/3985#discussion_r490252976", "createdAt": "2020-09-17T13:38:09Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/firecloud/FireCloudServiceImpl.java", "diffHunk": "@@ -270,6 +270,16 @@ public void createAllOfUsBillingProject(String projectName) {\n         });\n   }\n \n+  @Override\n+  public void deleteBillingProject(String billingProject) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MzY3OQ==", "bodyText": "please add tests showing all the failure modes (exceptions) and their handling (if any).", "url": "https://github.com/all-of-us/workbench/pull/3985#discussion_r490253679", "createdAt": "2020-09-17T13:39:07Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/workspaces/WorkspaceServiceTest.java", "diffHunk": "@@ -389,4 +390,16 @@ public void enforceFirecloudAclsInRecentWorkspaces() {\n     assertThat(recentWorkspaces.size()).isEqualTo(1);\n     assertThat(recentWorkspaces.get(0).getWorkspaceId()).isEqualTo(ownedId);\n   }\n+\n+  @Test\n+  public void deleteWorkspace() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1NDEwNw==", "bodyText": "Also, is there a ticket for a simple cron to find orphaned billing projects?", "url": "https://github.com/all-of-us/workbench/pull/3985#discussion_r490254107", "createdAt": "2020-09-17T13:39:45Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/firecloud/FireCloudServiceImpl.java", "diffHunk": "@@ -270,6 +270,16 @@ public void createAllOfUsBillingProject(String projectName) {\n         });\n   }\n \n+  @Override\n+  public void deleteBillingProject(String billingProject) {\n+    BillingApi billingApi = billingApiProvider.get();\n+    retryHandler.run(\n+        (context) -> {\n+          billingApi.deleteBillingProject(billingProject);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1MTYwNA=="}, "originalCommit": {"oid": "f98f0f69afdcf36e9105033e530526855bb7cce5"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwODI4OTYy", "url": "https://github.com/all-of-us/workbench/pull/3985#pullrequestreview-490828962", "createdAt": "2020-09-17T17:26:31Z", "commit": {"oid": "0aba33c6d85278203768d09cbd4172316484fc8e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f713d9b609fdde668d6a21fadaf13f3721afc73", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/6f713d9b609fdde668d6a21fadaf13f3721afc73", "committedDate": "2020-09-17T19:13:58Z", "message": "Add new Firecloud endpoint for Project Deletion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59aea69109c73b2d6109cf828e147a89c052169c", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/59aea69109c73b2d6109cf828e147a89c052169c", "committedDate": "2020-09-17T19:13:58Z", "message": "Delete billing project after deleting workspace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af2f9ec530f91416bb3bbd56b172dda85670228e", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/af2f9ec530f91416bb3bbd56b172dda85670228e", "committedDate": "2020-09-17T19:13:59Z", "message": "Add basic deleteWorkspace() test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "370d9e599d2d47769c807b95c46a2351777d6f56", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/370d9e599d2d47769c807b95c46a2351777d6f56", "committedDate": "2020-09-17T19:13:59Z", "message": "fix imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51f7c61b62d4f4282a394e18fe92943fb967ef21", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/51f7c61b62d4f4282a394e18fe92943fb967ef21", "committedDate": "2020-09-17T19:13:59Z", "message": "Correct endpoint auth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8197de65dca1a00ffbee33fe4c876072c69030d4", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/8197de65dca1a00ffbee33fe4c876072c69030d4", "committedDate": "2020-09-17T19:14:00Z", "message": "Audit-log Billing Project Deletion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61acd591c10819dbfb3d57aa920860d1894bb703", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/61acd591c10819dbfb3d57aa920860d1894bb703", "committedDate": "2020-09-17T19:14:00Z", "message": "add MockBean to fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a32f13109d8b9e1b796eb0728fbdaeda86d62a9", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/5a32f13109d8b9e1b796eb0728fbdaeda86d62a9", "committedDate": "2020-09-17T19:15:08Z", "message": "more MockBeans for great justice"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fe2c59400e866f18275b1f455c85916aed0416e", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/9fe2c59400e866f18275b1f455c85916aed0416e", "committedDate": "2020-09-17T19:15:10Z", "message": "more MockBeans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dde9992dd6a747eb2d558d4781da1ba5a808d8d", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/0dde9992dd6a747eb2d558d4781da1ba5a808d8d", "committedDate": "2020-09-17T19:15:11Z", "message": "Move delete BP into a try/catch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69f440c4fe0448791d37b7af58ad8c4171b9d55a", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/69f440c4fe0448791d37b7af58ad8c4171b9d55a", "committedDate": "2020-09-17T19:15:11Z", "message": "Add failed project deletion test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f022e9c40da20d673dbb710e17752227c03aec5", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/5f022e9c40da20d673dbb710e17752227c03aec5", "committedDate": "2020-09-17T19:15:11Z", "message": "update deleteBillingProject text"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0aba33c6d85278203768d09cbd4172316484fc8e", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/0aba33c6d85278203768d09cbd4172316484fc8e", "committedDate": "2020-09-17T17:22:56Z", "message": "update deleteBillingProject text"}, "afterCommit": {"oid": "5f022e9c40da20d673dbb710e17752227c03aec5", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/5f022e9c40da20d673dbb710e17752227c03aec5", "committedDate": "2020-09-17T19:15:11Z", "message": "update deleteBillingProject text"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4191, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}