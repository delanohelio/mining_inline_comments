{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2NzE1MTQ0", "number": 3688, "title": "[risk=low] Only lock out free tier workspaces on credit expiration", "bodyText": "Description:\nWe were disabling all workspaces, not just free tier.\nNo ticket, just happened to see this while looking elsewhere.\nNote: Not addressed here, but there are two possibilities for determining if a Workspace is Free Tier.  We should fix that: https://precisionmedicineinitiative.atlassian.net/browse/RW-5107\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test-local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-06-18T19:21:21Z", "url": "https://github.com/all-of-us/workbench/pull/3688", "merged": true, "mergeCommit": {"oid": "641423337e261f224dc024327faec31d6aa32c14"}, "closed": true, "closedAt": "2020-06-19T21:35:20Z", "author": {"login": "jmthibault79"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsjhe8AFqTQzMzU3ODc5Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcs5a4ZABqjM0NjM4NTgyMjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNTc4Nzk2", "url": "https://github.com/all-of-us/workbench/pull/3688#pullrequestreview-433578796", "createdAt": "2020-06-18T19:22:00Z", "commit": {"oid": "151f4961cb53faa6c0ce4421991d2465cb553229"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxOToyMjowMFrOGl8-yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOFQxOToyMjowMFrOGl8-yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ0OTYxMQ==", "bodyText": "This signature update also helps with billing un-lock-out, which I'm working on", "url": "https://github.com/all-of-us/workbench/pull/3688#discussion_r442449611", "createdAt": "2020-06-18T19:22:00Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -140,11 +140,18 @@ private boolean expiredByCost(final DbUser user, final double currentCost) {\n     return compareCosts(currentCost, getUserFreeTierDollarLimit(user)) > 0;\n   }\n \n-  private void deactivateUserWorkspaces(final DbUser user) {\n-    final Set<DbWorkspace> toDeactivate = workspaceDao.findAllByCreator(user);\n-    for (final DbWorkspace workspace : toDeactivate) {\n-      workspaceDao.updateBillingStatus(workspace.getWorkspaceId(), BillingStatus.INACTIVE);\n-    }\n+  // TODO: move to DbWorkspace?  RW-5107\n+  private boolean isFreeTier(final DbWorkspace workspace) {\n+    return workspace\n+        .getBillingAccountName()\n+        .equals(workbenchConfigProvider.get().billing.freeTierBillingAccountName());\n+  }\n+\n+  private void setActiveStatusForCreatedWorkspaces(final DbUser user, final BillingStatus status) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "151f4961cb53faa6c0ce4421991d2465cb553229"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MzI0NDQ4", "url": "https://github.com/all-of-us/workbench/pull/3688#pullrequestreview-434324448", "createdAt": "2020-06-19T20:25:41Z", "commit": {"oid": "151f4961cb53faa6c0ce4421991d2465cb553229"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQyMDoyNTo0MVrOGmgZxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQyMDoyNTo0MVrOGmgZxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzAyOTk1Ng==", "bodyText": "I hate to ask for more characters in this verbose method name, but seems like this should probably specify FreeTierWorkspaces", "url": "https://github.com/all-of-us/workbench/pull/3688#discussion_r443029956", "createdAt": "2020-06-19T20:25:41Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -140,11 +140,18 @@ private boolean expiredByCost(final DbUser user, final double currentCost) {\n     return compareCosts(currentCost, getUserFreeTierDollarLimit(user)) > 0;\n   }\n \n-  private void deactivateUserWorkspaces(final DbUser user) {\n-    final Set<DbWorkspace> toDeactivate = workspaceDao.findAllByCreator(user);\n-    for (final DbWorkspace workspace : toDeactivate) {\n-      workspaceDao.updateBillingStatus(workspace.getWorkspaceId(), BillingStatus.INACTIVE);\n-    }\n+  // TODO: move to DbWorkspace?  RW-5107\n+  private boolean isFreeTier(final DbWorkspace workspace) {\n+    return workspace\n+        .getBillingAccountName()\n+        .equals(workbenchConfigProvider.get().billing.freeTierBillingAccountName());\n+  }\n+\n+  private void setActiveStatusForCreatedWorkspaces(final DbUser user, final BillingStatus status) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "151f4961cb53faa6c0ce4421991d2465cb553229"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56e1c3a248e1d4d9e65b96878606aaae07471d22", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/56e1c3a248e1d4d9e65b96878606aaae07471d22", "committedDate": "2020-06-19T20:51:58Z", "message": "Don't deactivate billing-upgraded Workspaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f95d896c5e4ee5c958b9f85bd703d3ecdb468ad", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/0f95d896c5e4ee5c958b9f85bd703d3ecdb468ad", "committedDate": "2020-06-19T20:51:58Z", "message": "test for only disable free tier"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5427b0aa5eeb7d285ed825d0b0dff2505974d70", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/f5427b0aa5eeb7d285ed825d0b0dff2505974d70", "committedDate": "2020-06-19T20:51:59Z", "message": "rename"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "151f4961cb53faa6c0ce4421991d2465cb553229", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/151f4961cb53faa6c0ce4421991d2465cb553229", "committedDate": "2020-06-18T19:14:07Z", "message": "test for only disable free tier"}, "afterCommit": {"oid": "f5427b0aa5eeb7d285ed825d0b0dff2505974d70", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/f5427b0aa5eeb7d285ed825d0b0dff2505974d70", "committedDate": "2020-06-19T20:51:59Z", "message": "rename"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4585, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}