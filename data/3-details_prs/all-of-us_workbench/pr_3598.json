{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwMjYwNjQ4", "number": 3598, "title": "[RW-4976][risk=no] Running Puppeteer tests on local UI in CircleCI", "bodyText": "PR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test-local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-05-19T17:28:10Z", "url": "https://github.com/all-of-us/workbench/pull/3598", "merged": true, "mergeCommit": {"oid": "9e039e198b6901d5f5fe9858b7f9a996499d0252"}, "closed": true, "closedAt": "2020-05-21T19:48:35Z", "author": {"login": "aweng98"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABci3oPDAH2gAyNDIwMjYwNjQ4OjhlMmRkMzQ4ZTA0ZjI0MTUyN2RhNTRhMGZjOGJjODY3Y2YyZDYxMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci-pcEgFqTQxNDkyODgzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8e2dd348e04f241527da54a0fc8bc867cf2d6108", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/8e2dd348e04f241527da54a0fc8bc867cf2d6108", "committedDate": "2020-05-19T17:08:14Z", "message": "run puppeteer tests on local ui server"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fc54652be3b1b322f0ea3e316b8d4455dd9de1b", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/8fc54652be3b1b322f0ea3e316b8d4455dd9de1b", "committedDate": "2020-05-19T17:17:47Z", "message": "run puppeteer tests on local ui server"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Njk1MTE4", "url": "https://github.com/all-of-us/workbench/pull/3598#pullrequestreview-414695118", "createdAt": "2020-05-19T18:01:52Z", "commit": {"oid": "8fc54652be3b1b322f0ea3e316b8d4455dd9de1b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODowMTo1MlrOGXsUXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODowMjo1NFrOGXsXIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NjU0Mg==", "bodyText": "Better to just skip on master. This logic is not consistent with the other tests, and causes problems because it won't run again when a PR is opened.\nSpecifically consider the following PR flow:\n\ngit push # this logic runs, skips since there's no PR yet\ncreate PR # nothing happens, Circle continues running the other steps as normal, puppeteer will show green since it skipped\n(may or may not happen, depending on PR) git push # follow-up commit, now it will run properly", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427496542", "createdAt": "2020-05-19T18:01:52Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -488,6 +533,71 @@ jobs:\n       - manage_api_cache:\n           save: true\n \n+  # Run Puppeteer e2e UI tests on deployed \"test\" environment.\n+  puppeteer-e2e-test:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: dev\n+    working_directory: ~/workbench\n+    parallelism: 3\n+    steps:\n+      - browser-tools/install-browser-tools\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - run_e2e_test\n+\n+  # Deploy UI local server then run Puppeteer e2e tests on deployed \"local\" environment.\n+  puppeteer-e2e-local-ui:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: local\n+    resource_class: medium+\n+    working_directory: ~/workbench\n+    parallelism: 1\n+    steps:\n+      - run:\n+          name: Check if it is a pull request", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fc54652be3b1b322f0ea3e316b8d4455dd9de1b"}, "originalPosition": 310}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NzI1MA==", "bodyText": "Note: one optimization you could make, if these things take a while, is to start the servers early, then put the dockerize wait as late as possible. i.e.\n- start_api\n- start_ui\n- setup_for_puppeteer\n- wait_api\n- wait_ui\n- puppeteer\n\nThere's no real need to block immediately", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427497250", "createdAt": "2020-05-19T18:02:54Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -196,13 +214,72 @@ commands:\n           name: Run puppeteer e2e tests\n           working_directory: ~/workbench/e2e\n           # parallelism used to run e2e tests\n-          command: yarn test:ci $(circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings --timings-type=classname --show-counts)\n+          command: |\n+            circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n+            yarn test:ci $(cat /tmp/tests-to-run)\n+          no_output_timeout: 15m\n       - store_artifacts:\n           path: e2e/logs\n           destination: logs\n       - store_test_results:\n           path: ~/workbench/e2e/logs\n \n+\n+  start_local_api:\n+    description: \"Start local API server\"\n+    steps:\n+      - manage_api_cache:\n+          restore: true\n+      - run:\n+          # MySQL sometimes refuses connections by the time we attempt to apply\n+          # data migrations. Watch the port for 2m for startup.\n+          name: Await MySQL startup\n+          command: dockerize -wait tcp://127.0.0.1:3306 -timeout 2m\n+      - run:\n+          name: Run Local Migrations\n+          working_directory: ~/workbench/api\n+          command: ./project.rb run-local-migrations\n+      - run:\n+          name: Launch local API server\n+          working_directory: ~/workbench/api\n+          # tail -f is important here, it keeps this process running indefinitely\n+          command: ./project.rb start-local-api && tail -f build/dev-appserver-out/dev_appserver.out\n+          background: true\n+      - run:\n+          name: Wait for local API server to start", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fc54652be3b1b322f0ea3e316b8d4455dd9de1b"}, "originalPosition": 159}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "636738d90b68fbac0fa70be99fca04e0828c578d", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/636738d90b68fbac0fa70be99fca04e0828c578d", "committedDate": "2020-05-19T18:24:45Z", "message": "skip local ui tests on master branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/9db34d2937cb61abaa572679a265d7ec95033bcb", "committedDate": "2020-05-19T19:04:06Z", "message": "revert page changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NzQ0Mjk1", "url": "https://github.com/all-of-us/workbench/pull/3598#pullrequestreview-414744295", "createdAt": "2020-05-19T19:08:50Z", "commit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxOTowODo1MFrOGXuvbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxOToxMDozM1rOGXuzxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUzNjIzOQ==", "bodyText": "That's good strategy. But I think it's best for me that I don't make this change to keep focus only getting local ui + \"test\" api servers to work.\nI will incorporate that in future PR.", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427536239", "createdAt": "2020-05-19T19:08:50Z", "author": {"login": "aweng98"}, "path": ".circleci/config.yml", "diffHunk": "@@ -196,13 +214,72 @@ commands:\n           name: Run puppeteer e2e tests\n           working_directory: ~/workbench/e2e\n           # parallelism used to run e2e tests\n-          command: yarn test:ci $(circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings --timings-type=classname --show-counts)\n+          command: |\n+            circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n+            yarn test:ci $(cat /tmp/tests-to-run)\n+          no_output_timeout: 15m\n       - store_artifacts:\n           path: e2e/logs\n           destination: logs\n       - store_test_results:\n           path: ~/workbench/e2e/logs\n \n+\n+  start_local_api:\n+    description: \"Start local API server\"\n+    steps:\n+      - manage_api_cache:\n+          restore: true\n+      - run:\n+          # MySQL sometimes refuses connections by the time we attempt to apply\n+          # data migrations. Watch the port for 2m for startup.\n+          name: Await MySQL startup\n+          command: dockerize -wait tcp://127.0.0.1:3306 -timeout 2m\n+      - run:\n+          name: Run Local Migrations\n+          working_directory: ~/workbench/api\n+          command: ./project.rb run-local-migrations\n+      - run:\n+          name: Launch local API server\n+          working_directory: ~/workbench/api\n+          # tail -f is important here, it keeps this process running indefinitely\n+          command: ./project.rb start-local-api && tail -f build/dev-appserver-out/dev_appserver.out\n+          background: true\n+      - run:\n+          name: Wait for local API server to start", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzQ5NzI1MA=="}, "originalCommit": {"oid": "8fc54652be3b1b322f0ea3e316b8d4455dd9de1b"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUzNzM1MA==", "bodyText": "Good thinking on using master branch for skip filtering. Updated command accordingly.", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427537350", "createdAt": "2020-05-19T19:10:33Z", "author": {"login": "aweng98"}, "path": ".circleci/config.yml", "diffHunk": "@@ -488,6 +533,70 @@ jobs:\n       - manage_api_cache:\n           save: true\n \n+  # Run Puppeteer e2e UI tests on deployed \"test\" environment.\n+  puppeteer-e2e-test:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: dev\n+    working_directory: ~/workbench\n+    parallelism: 3\n+    steps:\n+      - browser-tools/install-browser-tools\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - run_e2e_test\n+\n+  # Deploy UI local server then run Puppeteer e2e tests on deployed \"local\" environment.\n+  puppeteer-e2e-local-ui:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: local\n+    resource_class: medium+\n+    working_directory: ~/workbench\n+    parallelism: 1\n+    steps:\n+      - run:\n+          name: Skip job if this is not a pull request\n+          command: |\n+            echo \"PR: $CI_PULL_REQUEST\"\n+            if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} == \"master\" ] ; then\n+              echo \"Not a PR, skipping Puppeteer tests\"\n+              circleci-agent step halt\n+            fi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "originalPosition": 334}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef141ab4dcdc4896dc700b15f525267dbadd80a9", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/ef141ab4dcdc4896dc700b15f525267dbadd80a9", "committedDate": "2020-05-19T19:36:14Z", "message": "move install-browser after skip job"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0ODk2ODQ1", "url": "https://github.com/all-of-us/workbench/pull/3598#pullrequestreview-414896845", "createdAt": "2020-05-19T23:41:38Z", "commit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMzo0MTozOFrOGX2VvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMzo0ODowNVrOGX2eog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MDczMw==", "bodyText": "nit: I prefer the previous description", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427660733", "createdAt": "2020-05-19T23:41:38Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -84,7 +101,7 @@ commands:\n           command: git submodule update --init --recursive\n \n   halt_job_noncode_changes:\n-    description: \"Halt job and succeed early if no code changes on master branch\"\n+    description: \"Skip job if no code changes on master branch\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MTA0MQ==", "bodyText": "nit: this feels implicit to me - what else would we be caching? I don't think the change is needed", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427661041", "createdAt": "2020-05-19T23:42:37Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -140,9 +157,9 @@ commands:\n       - restore_cache:\n           name: \"restore e2e cache\"\n           keys:\n-            - v1-e2e-cache-{{ .Branch }}-{{ checksum \"~/workbench/e2e/yarn.lock\" }}\n-            - v1-e2e-cache-master\n-            - v1-e2e-cache-\n+            - v1-e2e-dependency-cache-{{ .Branch }}-{{ checksum \"~/workbench/e2e/yarn.lock\" }}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2Mjc2NA==", "bodyText": "this checks the api directory by default. That doesn't seem desirable here", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427662764", "createdAt": "2020-05-19T23:47:28Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -488,6 +533,70 @@ jobs:\n       - manage_api_cache:\n           save: true\n \n+  # Run Puppeteer e2e UI tests on deployed \"test\" environment.\n+  puppeteer-e2e-test:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: dev\n+    working_directory: ~/workbench\n+    parallelism: 3\n+    steps:\n+      - browser-tools/install-browser-tools\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - run_e2e_test\n+\n+  # Deploy UI local server then run Puppeteer e2e tests on deployed \"local\" environment.\n+  puppeteer-e2e-local-ui:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: local\n+    resource_class: medium+\n+    working_directory: ~/workbench\n+    parallelism: 1\n+    steps:\n+      - run:\n+          name: Skip job if this is not a pull request\n+          command: |\n+            echo \"PR: $CI_PULL_REQUEST\"\n+            if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} == \"master\" ] ; then\n+              echo \"Not a PR, skipping Puppeteer tests\"\n+              circleci-agent step halt\n+            fi\n+      - checkout_init_git\n+      - halt_job_noncode_changes", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "originalPosition": 336}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MzAxMA==", "bodyText": "Did you mean to leave this in? Or are you actively debugging this and hoping to merge it with this PR? I dislike dead code so I would probably just leave this in a branch for now if it's not connected to anything.", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427663010", "createdAt": "2020-05-19T23:48:05Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -488,6 +533,70 @@ jobs:\n       - manage_api_cache:\n           save: true\n \n+  # Run Puppeteer e2e UI tests on deployed \"test\" environment.\n+  puppeteer-e2e-test:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: dev\n+    working_directory: ~/workbench\n+    parallelism: 3\n+    steps:\n+      - browser-tools/install-browser-tools\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - run_e2e_test\n+\n+  # Deploy UI local server then run Puppeteer e2e tests on deployed \"local\" environment.\n+  puppeteer-e2e-local-ui:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: local\n+    resource_class: medium+\n+    working_directory: ~/workbench\n+    parallelism: 1\n+    steps:\n+      - run:\n+          name: Skip job if this is not a pull request\n+          command: |\n+            echo \"PR: $CI_PULL_REQUEST\"\n+            if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} == \"master\" ] ; then\n+              echo \"Not a PR, skipping Puppeteer tests\"\n+              circleci-agent step halt\n+            fi\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - browser-tools/install-browser-tools\n+      - start_local_ui\n+      - run_e2e_test\n+\n+  # NOT READY!!", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "originalPosition": 341}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71a83703f8b0000f4b34ad8cbad6dfca59571eca", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/71a83703f8b0000f4b34ad8cbad6dfca59571eca", "committedDate": "2020-05-20T00:49:50Z", "message": "PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTE0NTg2", "url": "https://github.com/all-of-us/workbench/pull/3598#pullrequestreview-414914586", "createdAt": "2020-05-20T00:31:48Z", "commit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMDozMTo0OFrOGX3RRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMDo1MjoyNVrOGX3m1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3NTk3NA==", "bodyText": "reverted.", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427675974", "createdAt": "2020-05-20T00:31:48Z", "author": {"login": "aweng98"}, "path": ".circleci/config.yml", "diffHunk": "@@ -84,7 +101,7 @@ commands:\n           command: git submodule update --init --recursive\n \n   halt_job_noncode_changes:\n-    description: \"Halt job and succeed early if no code changes on master branch\"\n+    description: \"Skip job if no code changes on master branch\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MDczMw=="}, "originalCommit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3NjMyMg==", "bodyText": "reverted. thought it would be good to match command name install_e2e_dependencies.", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427676322", "createdAt": "2020-05-20T00:33:10Z", "author": {"login": "aweng98"}, "path": ".circleci/config.yml", "diffHunk": "@@ -140,9 +157,9 @@ commands:\n       - restore_cache:\n           name: \"restore e2e cache\"\n           keys:\n-            - v1-e2e-cache-{{ .Branch }}-{{ checksum \"~/workbench/e2e/yarn.lock\" }}\n-            - v1-e2e-cache-master\n-            - v1-e2e-cache-\n+            - v1-e2e-dependency-cache-{{ .Branch }}-{{ checksum \"~/workbench/e2e/yarn.lock\" }}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MTA0MQ=="}, "originalCommit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3NzIxOA==", "bodyText": "It is removed now. So close to have it working. I am saving it in a local file.", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427677218", "createdAt": "2020-05-20T00:36:13Z", "author": {"login": "aweng98"}, "path": ".circleci/config.yml", "diffHunk": "@@ -488,6 +533,70 @@ jobs:\n       - manage_api_cache:\n           save: true\n \n+  # Run Puppeteer e2e UI tests on deployed \"test\" environment.\n+  puppeteer-e2e-test:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: dev\n+    working_directory: ~/workbench\n+    parallelism: 3\n+    steps:\n+      - browser-tools/install-browser-tools\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - run_e2e_test\n+\n+  # Deploy UI local server then run Puppeteer e2e tests on deployed \"local\" environment.\n+  puppeteer-e2e-local-ui:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: local\n+    resource_class: medium+\n+    working_directory: ~/workbench\n+    parallelism: 1\n+    steps:\n+      - run:\n+          name: Skip job if this is not a pull request\n+          command: |\n+            echo \"PR: $CI_PULL_REQUEST\"\n+            if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} == \"master\" ] ; then\n+              echo \"Not a PR, skipping Puppeteer tests\"\n+              circleci-agent step halt\n+            fi\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - browser-tools/install-browser-tools\n+      - start_local_ui\n+      - run_e2e_test\n+\n+  # NOT READY!!", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2MzAxMA=="}, "originalCommit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "originalPosition": 341}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY3ODg2OQ==", "bodyText": "halt_job_noncode_changes has no parameter. It skips job if only *.md or *.pdf files changed. I think you mean ensure_branch_has_changes command. But it has no default value for dir parameter. This was the change requested from you in last PR.", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427678869", "createdAt": "2020-05-20T00:42:13Z", "author": {"login": "aweng98"}, "path": ".circleci/config.yml", "diffHunk": "@@ -488,6 +533,70 @@ jobs:\n       - manage_api_cache:\n           save: true\n \n+  # Run Puppeteer e2e UI tests on deployed \"test\" environment.\n+  puppeteer-e2e-test:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: dev\n+    working_directory: ~/workbench\n+    parallelism: 3\n+    steps:\n+      - browser-tools/install-browser-tools\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - run_e2e_test\n+\n+  # Deploy UI local server then run Puppeteer e2e tests on deployed \"local\" environment.\n+  puppeteer-e2e-local-ui:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: local\n+    resource_class: medium+\n+    working_directory: ~/workbench\n+    parallelism: 1\n+    steps:\n+      - run:\n+          name: Skip job if this is not a pull request\n+          command: |\n+            echo \"PR: $CI_PULL_REQUEST\"\n+            if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} == \"master\" ] ; then\n+              echo \"Not a PR, skipping Puppeteer tests\"\n+              circleci-agent step halt\n+            fi\n+      - checkout_init_git\n+      - halt_job_noncode_changes", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2Mjc2NA=="}, "originalCommit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "originalPosition": 336}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4MTEyMQ==", "bodyText": "to match halt_job_noncode_changes description.", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427681121", "createdAt": "2020-05-20T00:50:49Z", "author": {"login": "aweng98"}, "path": ".circleci/config.yml", "diffHunk": "@@ -84,20 +101,20 @@ commands:\n           command: git submodule update --init --recursive\n \n   halt_job_noncode_changes:\n-    description: \"Halt job and succeed early if no code changes on master branch\"\n+    description: \"Halt job and succeed early if no code changes on non-master branch\"\n     steps:\n       - run:\n           command: |\n             if [ ${CIRCLE_BRANCH} != \"\" ] &&\n               [ ${CIRCLE_BRANCH} != \"master\" ] &&\n               ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvE '(.md$)|(.pdf$)'; then\n-                echo \"No code changes in non-master branch. halting job.\"\n+                echo \"No code changes on non-master branch. halting job.\"\n                 circleci step halt\n             fi\n-          name: Halt job and succeed early if no code changes on master branch\n+          name: Halt job and succeed early if no code changes on non-master branch\n \n   ensure_branch_has_changes:\n-    description: \"Ensure branch has changes to code in specified directory\"\n+    description: Halt job and succeed early if no code changes in << parameters.dir_name >> directory on non-master branch", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71a83703f8b0000f4b34ad8cbad6dfca59571eca"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4MTQ5Mg==", "bodyText": "I believe it should be worded as non-master.", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427681492", "createdAt": "2020-05-20T00:52:25Z", "author": {"login": "aweng98"}, "path": ".circleci/config.yml", "diffHunk": "@@ -84,20 +101,20 @@ commands:\n           command: git submodule update --init --recursive\n \n   halt_job_noncode_changes:\n-    description: \"Halt job and succeed early if no code changes on master branch\"\n+    description: \"Halt job and succeed early if no code changes on non-master branch\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71a83703f8b0000f4b34ad8cbad6dfca59571eca"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTI4ODM3", "url": "https://github.com/all-of-us/workbench/pull/3598#pullrequestreview-414928837", "createdAt": "2020-05-20T01:18:41Z", "commit": {"oid": "71a83703f8b0000f4b34ad8cbad6dfca59571eca"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMToxODo0MVrOGX4ApA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQwMToxODo0MVrOGX4ApA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY4ODEwMA==", "bodyText": "Oops, yep - way off. Thanks.", "url": "https://github.com/all-of-us/workbench/pull/3598#discussion_r427688100", "createdAt": "2020-05-20T01:18:41Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -488,6 +533,70 @@ jobs:\n       - manage_api_cache:\n           save: true\n \n+  # Run Puppeteer e2e UI tests on deployed \"test\" environment.\n+  puppeteer-e2e-test:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: dev\n+    working_directory: ~/workbench\n+    parallelism: 3\n+    steps:\n+      - browser-tools/install-browser-tools\n+      - checkout_init_git\n+      - halt_job_noncode_changes\n+      - run_e2e_test\n+\n+  # Deploy UI local server then run Puppeteer e2e tests on deployed \"local\" environment.\n+  puppeteer-e2e-local-ui:\n+    <<: *defaults\n+    environment:\n+      <<: *e2e_env\n+      WORKBENCH_ENV: local\n+    resource_class: medium+\n+    working_directory: ~/workbench\n+    parallelism: 1\n+    steps:\n+      - run:\n+          name: Skip job if this is not a pull request\n+          command: |\n+            echo \"PR: $CI_PULL_REQUEST\"\n+            if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} == \"master\" ] ; then\n+              echo \"Not a PR, skipping Puppeteer tests\"\n+              circleci-agent step halt\n+            fi\n+      - checkout_init_git\n+      - halt_job_noncode_changes", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzY2Mjc2NA=="}, "originalCommit": {"oid": "9db34d2937cb61abaa572679a265d7ec95033bcb"}, "originalPosition": 336}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4751, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}