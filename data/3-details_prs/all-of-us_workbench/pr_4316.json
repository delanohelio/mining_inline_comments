{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MTk4NTg2", "number": 4316, "title": "[RW-5641][risk=no] Start/Stop button", "bodyText": "2 minute video posted in Slack instead of here. Ping me for the link.\nWill do as much in the way of unit tests as I can before I sign off for the day\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test-local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-11-19T20:03:25Z", "url": "https://github.com/all-of-us/workbench/pull/4316", "merged": true, "mergeCommit": {"oid": "b78cbf96490b9ae4d50be7198a3dcd82f1995b94"}, "closed": true, "closedAt": "2020-12-01T16:01:45Z", "author": {"login": "als364"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeJHumgBqjQwMTc4NTAzNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh71czgH2gAyNTI0MTk4NTg2OmUxYzBiN2MwYmQyOTA2M2RmNWE3MDI2OGVjMmEyMDk5YjIyZmQ4NmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98256d6786f27b4c89a21d212e829704943fe9f3", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/98256d6786f27b4c89a21d212e829704943fe9f3", "committedDate": "2020-11-19T20:00:49Z", "message": "cleanup"}, "afterCommit": {"oid": "4b94c25c0f8176289e8ce69be406041e8686d956", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/4b94c25c0f8176289e8ce69be406041e8686d956", "committedDate": "2020-11-19T20:51:58Z", "message": "tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b2d86d49aad9498f2b798ef87af4bb41cb0bda1", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/6b2d86d49aad9498f2b798ef87af4bb41cb0bda1", "committedDate": "2020-11-30T15:51:17Z", "message": "shelving! leo borked"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f9dfe56da0e1979b4a19c47819eedd56b148182", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/9f9dfe56da0e1979b4a19c47819eedd56b148182", "committedDate": "2020-11-30T15:57:35Z", "message": "works"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5592c20a85d0d8adb2fcf30b945fd6c4ac94a8cc", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/5592c20a85d0d8adb2fcf30b945fd6c4ac94a8cc", "committedDate": "2020-11-30T15:57:35Z", "message": "revert api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57177dbe9afb98dae6b849710cc8f008dc15a5c6", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/57177dbe9afb98dae6b849710cc8f008dc15a5c6", "committedDate": "2020-11-30T15:57:35Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfc0c89a2bb0bcfb591807f2cf93bf902f6bc313", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/bfc0c89a2bb0bcfb591807f2cf93bf902f6bc313", "committedDate": "2020-11-30T15:57:46Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4dbfb1dea0f24c0e0b7a27df852defdea4ecc6c", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/a4dbfb1dea0f24c0e0b7a27df852defdea4ecc6c", "committedDate": "2020-11-30T15:57:46Z", "message": "tooltip / alt text"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93e39e78e0b12a71ca30f6177cbcd42929048256", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/93e39e78e0b12a71ca30f6177cbcd42929048256", "committedDate": "2020-11-30T15:57:46Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dee249b580381247a03307db80e0e5a939678ea0", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/dee249b580381247a03307db80e0e5a939678ea0", "committedDate": "2020-11-30T15:57:46Z", "message": "tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eabba91d94821a90d18f10703c302b13396484be", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/eabba91d94821a90d18f10703c302b13396484be", "committedDate": "2020-11-30T17:19:30Z", "message": "tidying after rebase"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4b94c25c0f8176289e8ce69be406041e8686d956", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/4b94c25c0f8176289e8ce69be406041e8686d956", "committedDate": "2020-11-19T20:51:58Z", "message": "tests"}, "afterCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/eabba91d94821a90d18f10703c302b13396484be", "committedDate": "2020-11-30T17:19:30Z", "message": "tidying after rebase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTc5MDMy", "url": "https://github.com/all-of-us/workbench/pull/4316#pullrequestreview-541179032", "createdAt": "2020-11-30T18:26:41Z", "commit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "state": "COMMENTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxODoyNjo0MlrOH8IDKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxOToyMzowMVrOH8KFFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwODQ4OA==", "bodyText": "nit: component() already does this now, so I'd be surprised if you need to tick again here", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532808488", "createdAt": "2020-11-30T18:26:42Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -626,4 +628,19 @@ describe('RuntimePanel', () => {\n     expect(runtimeApiStub.runtime.status).toEqual(RuntimeStatus.Running);\n     expect(wrapper.find(ConfirmDelete).exists()).toBeFalsy();\n   });\n+\n+  it('should display the Running runtime status icon in state Running', async() => {\n+    const wrapper = await component();\n+\n+    const runtimeStatusIcon = () => wrapper.find('[data-test-id=\"runtime-status-icon\"]').first();\n+    expect(runtimeStatusIcon().prop('src')).toBe(`${iconsDir}/compute-running.svg`);\n+  });\n+\n+  it('should display a compute-none when there is no runtime', async() => {\n+    runtimeApiStub.runtime = null;\n+    act(() => { runtimeStore.set({runtime: null, workspaceNamespace: workspaceStubs[0].namespace}) });\n+    const wrapper = await component();\n+    await waitOneTickAndUpdate(wrapper);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwOTI5NA==", "bodyText": "nit: would use a consistent pattern here and below - this one uses an anonymous helper, the other inlines", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532809294", "createdAt": "2020-11-30T18:27:57Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -626,4 +628,19 @@ describe('RuntimePanel', () => {\n     expect(runtimeApiStub.runtime.status).toEqual(RuntimeStatus.Running);\n     expect(wrapper.find(ConfirmDelete).exists()).toBeFalsy();\n   });\n+\n+  it('should display the Running runtime status icon in state Running', async() => {\n+    const wrapper = await component();\n+\n+    const runtimeStatusIcon = () => wrapper.find('[data-test-id=\"runtime-status-icon\"]').first();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxMDUxOA==", "bodyText": "opt: maybe cleaner to use the switchCase utility instead, which is basically the same but you could replace this line with just RuntimeStatus.Creating", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532810518", "createdAt": "2020-11-30T18:30:00Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -390,6 +389,146 @@ const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMach\n   </PopupTrigger>;\n };\n \n+const StartStopRuntimeButton = ({workspace, containerStyle}) => {\n+  const [status, setRuntimeStatus] = useRuntimeStatus(workspace.namespace);\n+\n+  const rotateStyle = {animation: 'rotation 2s infinite linear'};\n+  const {altText, clickable = false, iconShape = null, styleOverrides = {}, onClick = () => {}, } = fp.cond([\n+    [\n+      (s) => s === RuntimeStatus.Creating,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxNjYzOA==", "bodyText": "nit: seems like it would be a bug if clickable and onClick being a no-op diverged. If so, may want to just treat null / omission of onClick as an indication that it should not be clickable.", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532816638", "createdAt": "2020-11-30T18:40:31Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -390,6 +389,146 @@ const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMach\n   </PopupTrigger>;\n };\n \n+const StartStopRuntimeButton = ({workspace, containerStyle}) => {\n+  const [status, setRuntimeStatus] = useRuntimeStatus(workspace.namespace);\n+\n+  const rotateStyle = {animation: 'rotation 2s infinite linear'};\n+  const {altText, clickable = false, iconShape = null, styleOverrides = {}, onClick = () => {}, } = fp.cond([\n+    [\n+      (s) => s === RuntimeStatus.Creating,\n+      () => ({\n+        altText: 'Runtime creation in progress',\n+        clickable: false,\n+        iconShape: 'compute-starting',\n+        styleOverrides: rotateStyle,\n+        onClick: () => {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxNzU0MA==", "bodyText": "nit: I would probably just omit these values where you are just accepting the default - would remove some boilerplate and makes this easier to scan", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532817540", "createdAt": "2020-11-30T18:42:06Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -390,6 +389,146 @@ const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMach\n   </PopupTrigger>;\n };\n \n+const StartStopRuntimeButton = ({workspace, containerStyle}) => {\n+  const [status, setRuntimeStatus] = useRuntimeStatus(workspace.namespace);\n+\n+  const rotateStyle = {animation: 'rotation 2s infinite linear'};\n+  const {altText, clickable = false, iconShape = null, styleOverrides = {}, onClick = () => {}, } = fp.cond([\n+    [\n+      (s) => s === RuntimeStatus.Creating,\n+      () => ({\n+        altText: 'Runtime creation in progress',\n+        clickable: false,\n+        iconShape: 'compute-starting',\n+        styleOverrides: rotateStyle,\n+        onClick: () => {}\n+      })\n+    ],\n+    [\n+      (s) => s === RuntimeStatus.Running,\n+      () => ({\n+        altText: 'Runtime running, click to pause',\n+        clickable: true,\n+        iconShape: 'compute-running',\n+        styleOverrides: {},", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgxOTI4OA==", "bodyText": "nit: If this just uses the namespace, I'd probably have the parameter just be namespace instead", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532819288", "createdAt": "2020-11-30T18:45:09Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -390,6 +389,146 @@ const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMach\n   </PopupTrigger>;\n };\n \n+const StartStopRuntimeButton = ({workspace, containerStyle}) => {\n+  const [status, setRuntimeStatus] = useRuntimeStatus(workspace.namespace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyMDg3Mw==", "bodyText": "Why does the conditional currentRuntime && exist here, but not on the create page?", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532820873", "createdAt": "2020-11-30T18:47:44Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -811,13 +953,15 @@ export const RuntimePanel = fp.flow(\n       />],\n       [PanelContent.Customize, () => <Fragment>\n         <div style={styles.controlSection}>\n-          <CostInfo runtimeChanged={runtimeChanged}\n-                                runtimeConfig={newRuntimeConfig}\n-                                currentUser={profile.username}\n-                                workspace={workspace}\n-                                creatorFreeCreditsRemaining={creatorFreeCreditsRemaining}\n-          />\n-\n+          <FlexRow style={styles.costPredictorWrapper}>\n+            {currentRuntime && <StartStopRuntimeButton workspace={workspace} containerStyle={{borderRadius: '5px 0 0 5px'}}/>}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 252}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyMTE4Mg==", "bodyText": "containerStyle is identical in both usages. Should this parameter just be removed and consolidated?", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532821182", "createdAt": "2020-11-30T18:48:19Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -530,12 +669,15 @@ const CreatePanel = ({creatorFreeCreditsRemaining, preset, profile, setPanelCont\n   const workerDiskSize = computeType === ComputeType.Dataproc ? dataprocConfig.workerDiskSize : null;\n \n   return <div style={styles.controlSection}>\n-    <CostInfo runtimeChanged={false}\n-              runtimeConfig={runtimeConfig}\n-              currentUser={profile.username}\n-              workspace={workspace}\n-              creatorFreeCreditsRemaining={creatorFreeCreditsRemaining}\n-    />\n+    <FlexRow style={styles.costPredictorWrapper}>\n+      <StartStopRuntimeButton workspace={workspace} containerStyle={{borderRadius: '5px 0 0 5px'}}/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 204}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgyNDE3NA==", "bodyText": "Existing issue with other test cases, but this is flawed because if await runInitializerAndTimers(); does not throw an error, the test passes.", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532824174", "createdAt": "2020-11-30T18:53:27Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/leo-runtime-initializer.spec.tsx", "diffHunk": "@@ -315,4 +317,27 @@ describe('RuntimeInitializer', () => {\n       expect(error.message).toMatch(/max runtime resume count/i);\n     }\n   });\n+\n+  it('should respect the maxPauseCount default', async() => {\n+    mockGetRuntimeCalls([\n+      {status: RuntimeStatus.Running},\n+    ]);\n+    try {\n+      await runInitializerAndTimers();\n+    } catch (error) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgzMTkyNQ==", "bodyText": "This breaks the functionality Eric added, since his resolutionCondition is status !== Running. I believe the correct logic here instead would be:\n} else if (this.reachedResolution()) {\n  ...\n} else if (this.isRuntimeRunning() && this.pauseCount < this.maxPauseCount) {\n  await this.pauseRuntime();\n}\n\nYou should also adjust the resolutionCondition in your case to instead look for the Stopped status, otherwise it will just hang indefinitely.", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532831925", "createdAt": "2020-11-30T19:06:28Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/leo-runtime-initializer.tsx", "diffHunk": "@@ -343,9 +363,13 @@ export class LeoRuntimeInitializer {\n           `Runtime ${this.currentRuntime.googleProject}/${this.currentRuntime.runtimeName}` +\n           ` has reached an ERROR status`);\n         await this.deleteRuntime();\n-      } else if (this.reachedResolution()) {\n-        // We've reached the goal - resolve the Promise.\n-        return this.resolve(this.currentRuntime);\n+      } else if (this.isRuntimeRunning()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgzMjY5Mw==", "bodyText": "nit: Please use a consistent verb throughout - would prefer stop over pause, since it matches Leo's terminology.  I realize this is somewhat of an existing issue, since we already used resume in this file.", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532832693", "createdAt": "2020-11-30T19:07:46Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/leo-runtime-initializer.tsx", "diffHunk": "@@ -343,9 +363,13 @@ export class LeoRuntimeInitializer {\n           `Runtime ${this.currentRuntime.googleProject}/${this.currentRuntime.runtimeName}` +\n           ` has reached an ERROR status`);\n         await this.deleteRuntime();\n-      } else if (this.reachedResolution()) {\n-        // We've reached the goal - resolve the Promise.\n-        return this.resolve(this.currentRuntime);\n+      } else if (this.isRuntimeRunning()) {\n+        if (this.pauseCount < this.maxPauseCount) {\n+          await this.pauseRuntime();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg0MDE4Ng==", "bodyText": "On further review, I don't think we need this at all. Just issue the Stop manually (you're already doing this, in runtime-utils), then use the initializer to wait for it to reach the Stopped status via the custom resolutionCondition. You'll also need to move the resolutionCond check higher in the list of checks, so we don't try to for example, startRuntime when we're actually done. The initializer itself has no need that I can see to invoke Stop.", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532840186", "createdAt": "2020-11-30T19:20:24Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/leo-runtime-initializer.tsx", "diffHunk": "@@ -80,6 +82,7 @@ export interface LeoRuntimeInitializerOptions {\n   overallTimeout?: number;\n   maxCreateCount?: number;\n   maxDeleteCount?: number;\n+  maxPauseCount?: number;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg0MTc0OA==", "bodyText": "If you remove maxPauseCount per my other comment, I would consolidate all of these. Only the resolutionCondition should need to vary between these different options.", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532841748", "createdAt": "2020-11-30T19:23:01Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -277,17 +279,51 @@ export const useRuntimeStatus = (currentWorkspaceNamespace): [\n               throw e;\n             }\n           }\n-        }]);\n+        }],\n+        [RuntimeStatusRequest.Start, async() => {\n+          try {\n+            await LeoRuntimeInitializer.initialize({workspaceNamespace: currentWorkspaceNamespace, maxCreateCount: 0, maxPauseCount: 0});\n+          } catch (e) {\n+            // ExceededActionCountError is expected, as we exceed our create limit of 0.\n+            if (!(e instanceof ExceededActionCountError ||\n+                e instanceof LeoRuntimeInitializationAbortedError)) {\n+              throw e;\n+            }\n+          }\n+        }],\n+        [RuntimeStatusRequest.Stop, async() => {\n+          try {\n+            await LeoRuntimeInitializer.initialize({\n+              workspaceNamespace: currentWorkspaceNamespace,\n+              maxCreateCount: 0,\n+              maxPauseCount: 1,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eabba91d94821a90d18f10703c302b13396484be"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bccaccbfbd8fce8452f3fc16c94972c70a94995", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/6bccaccbfbd8fce8452f3fc16c94972c70a94995", "committedDate": "2020-11-30T21:49:05Z", "message": "review feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzcwMDA4", "url": "https://github.com/all-of-us/workbench/pull/4316#pullrequestreview-541370008", "createdAt": "2020-11-30T23:14:27Z", "commit": {"oid": "6bccaccbfbd8fce8452f3fc16c94972c70a94995"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMzoxNDoyN1rOH8RmFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMzoyNzowOFrOH8R6HQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2NDg4NQ==", "bodyText": "nit: accidental trailing comma after onClick?", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532964885", "createdAt": "2020-11-30T23:14:27Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -390,6 +390,121 @@ const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMach\n   </PopupTrigger>;\n };\n \n+const StartStopRuntimeButton = ({workspaceNamespace}) => {\n+  const [status, setRuntimeStatus] = useRuntimeStatus(workspaceNamespace);\n+\n+  const rotateStyle = {animation: 'rotation 2s infinite linear'};\n+  const {altText, iconShape = null, styleOverrides = {}, onClick = null, } = switchCase(status,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bccaccbfbd8fce8452f3fc16c94972c70a94995"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2NTI4MQ==", "bodyText": "I notice in the video that the alt text is bouncing with the rotation animation as the effective width/position of the icon changes. Would be good to fix this", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532965281", "createdAt": "2020-11-30T23:15:29Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -390,6 +390,121 @@ const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMach\n   </PopupTrigger>;\n };\n \n+const StartStopRuntimeButton = ({workspaceNamespace}) => {\n+  const [status, setRuntimeStatus] = useRuntimeStatus(workspaceNamespace);\n+\n+  const rotateStyle = {animation: 'rotation 2s infinite linear'};\n+  const {altText, iconShape = null, styleOverrides = {}, onClick = null, } = switchCase(status,\n+    [\n+      RuntimeStatus.Creating,\n+      () => ({\n+        altText: 'Runtime creation in progress',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bccaccbfbd8fce8452f3fc16c94972c70a94995"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2ODIzMw==", "bodyText": "maxCreateCount: 0  should probably still be set here", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532968233", "createdAt": "2020-11-30T23:22:52Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -265,29 +267,42 @@ export const useRuntimeStatus = (currentWorkspaceNamespace): [\n \n   useEffect(() => {\n     // Additional status changes can be put here\n-    if (!!runtimeStatus) {\n-      switchCase(runtimeStatus,\n-        [RuntimeStatusRequest.Delete, async() => {\n-          try {\n-            await LeoRuntimeInitializer.initialize({workspaceNamespace: currentWorkspaceNamespace, maxCreateCount: 0});\n-          } catch (e) {\n-            // ExceededActionCountError is expected, as we exceed our create limit of 0.\n-            if (!(e instanceof ExceededActionCountError ||\n-                  e instanceof LeoRuntimeInitializationAbortedError)) {\n-              throw e;\n-            }\n+    const targetStatus = switchCase(runtimeStatus,\n+        [RuntimeStatusRequest.Delete, () => RuntimeStatus.Deleted],\n+        [RuntimeStatusRequest.Start, () => RuntimeStatus.Running],\n+        [RuntimeStatusRequest.Stop, () => RuntimeStatus.Stopped]\n+    );\n+    const initializePolling = async() => {\n+      if (!!runtimeStatus) {\n+        try {\n+          await LeoRuntimeInitializer.initialize({\n+            workspaceNamespace: currentWorkspaceNamespace,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bccaccbfbd8fce8452f3fc16c94972c70a94995"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2ODU1Mw==", "bodyText": "The goal in the deleted case should technically be runtime === null OR status is Deleted", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532968553", "createdAt": "2020-11-30T23:23:42Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/runtime-utils.tsx", "diffHunk": "@@ -265,29 +267,42 @@ export const useRuntimeStatus = (currentWorkspaceNamespace): [\n \n   useEffect(() => {\n     // Additional status changes can be put here\n-    if (!!runtimeStatus) {\n-      switchCase(runtimeStatus,\n-        [RuntimeStatusRequest.Delete, async() => {\n-          try {\n-            await LeoRuntimeInitializer.initialize({workspaceNamespace: currentWorkspaceNamespace, maxCreateCount: 0});\n-          } catch (e) {\n-            // ExceededActionCountError is expected, as we exceed our create limit of 0.\n-            if (!(e instanceof ExceededActionCountError ||\n-                  e instanceof LeoRuntimeInitializationAbortedError)) {\n-              throw e;\n-            }\n+    const targetStatus = switchCase(runtimeStatus,\n+        [RuntimeStatusRequest.Delete, () => RuntimeStatus.Deleted],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bccaccbfbd8fce8452f3fc16c94972c70a94995"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk3MDAxMw==", "bodyText": "The previous logic was correct. It will need to be updated once https://precisionmedicineinitiative.atlassian.net/browse/RW-5922 is fixed, but it would be looking at the labels instead in that case. As it currently stands, you'll only see Deleted on the client side if the deleted runtime was a user override (in which case, we want to show the customize page instead).", "url": "https://github.com/all-of-us/workbench/pull/4316#discussion_r532970013", "createdAt": "2020-11-30T23:27:08Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -666,7 +784,7 @@ export const RuntimePanel = fp.flow(\n   const initialPanelContent = fp.cond([\n     // currentRuntime being undefined means the first `getRuntime` has still not completed.\n     [([r, ]) => r === undefined, () => PanelContent.Customize],\n-    [([r, s]) => r === null || s === RuntimeStatus.Unknown, () => PanelContent.Create],\n+    [([r, s]) => r === null || s === RuntimeStatus.Unknown || s === RuntimeStatus.Deleted, () => PanelContent.Create],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bccaccbfbd8fce8452f3fc16c94972c70a94995"}, "originalPosition": 219}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87b4a4cb76e1187d563dabcdfdbeab19dab2e551", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/87b4a4cb76e1187d563dabcdfdbeab19dab2e551", "committedDate": "2020-12-01T14:07:13Z", "message": "delete delete delete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cac7ea7c8f5eb29350a3fe8f8bb21cc5c061f4ad", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/cac7ea7c8f5eb29350a3fe8f8bb21cc5c061f4ad", "committedDate": "2020-12-01T15:09:49Z", "message": "most comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f270ffc60344c48f7bbcb23e179ff9e2887763e9", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/f270ffc60344c48f7bbcb23e179ff9e2887763e9", "committedDate": "2020-12-01T15:20:34Z", "message": "one would think webdev would not require me to remember middle school math but there you go"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1c0b7c0bd29063df5a70268ec2a2099b22fd86a", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/e1c0b7c0bd29063df5a70268ec2a2099b22fd86a", "committedDate": "2020-12-01T15:39:31Z", "message": "lint"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3904, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}