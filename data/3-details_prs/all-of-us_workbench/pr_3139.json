{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1ODM0NjEz", "number": 3139, "title": "[risk=low][RW-4259]Enforce Verified Institutional Affiliation for new account creation if feature flag is set", "bodyText": "Description:\nAdd verified_institutional_affiliation DB table and VerifiedInstitutionalAffiliation.\nAdd Feature Flag requireInstitutionalVerification: when set, requires a VerifiedInstitutionalAffiliation in the Profile passed into the createAccount endpoint, and validates the user's contactEmail against the Institution's email patterns.\nPrevents deletion of Institutions with affiliations.\nAdd InstitutionMapper and VerifiedInstitutionalAffiliationMapper\nAdd a ResearcherVerifiedInstitutionalAffiliation to the Researcher Directory if a VerifiedInstitutionalAffiliation is in the user's Profile\nJIRA to add feature flag everywhere: https://precisionmedicineinitiative.atlassian.net/browse/RW-4465\nJIRA to remove feature flag: https://precisionmedicineinitiative.atlassian.net/browse/RW-4361\nSpring/Hibernate questions I could use some help with:\n\nHow do I determine whether I should use Lazy or Eager fetching?  I had a LazyInitializationException bug that was fixed by turning off a transitive Eager fetch\nWhen do I need to @Import interface impls, and when will @Autowired or @MockBean handle this for me?\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-02-16T14:52:35Z", "url": "https://github.com/all-of-us/workbench/pull/3139", "merged": true, "mergeCommit": {"oid": "a25e3b68dae7550bd8c5368f5f095b9d9b823914"}, "closed": true, "closedAt": "2020-02-20T22:41:04Z", "author": {"login": "jmthibault79"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcE6BqEgFqTM1OTQwOTA1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGSxVGAFqTM2MjIwOTUxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDA5MDU0", "url": "https://github.com/all-of-us/workbench/pull/3139#pullrequestreview-359409054", "createdAt": "2020-02-16T14:58:04Z", "commit": {"oid": "c7c0461728be4df83df20e6f3a35d751ad3f43f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNDo1ODowNFrOFqT0og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNDo1ODowNFrOFqT0og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkwOTI4Mg==", "bodyText": "These 3 are strictly for the UI.  They might fit better as typescript enums in the UI code", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r379909282", "createdAt": "2020-02-16T14:58:04Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -4324,3 +4327,76 @@ definitions:\n         type: \"array\"\n         items:\n           $ref: \"#/definitions/Institution\"\n+\n+  OrganizationType:\n+    type: string\n+    description: A categorization of institutions, derived from CAPS requirements\n+    enum: [ACADEMIC_RESEARCH_INSTITUTION, INDUSTRY, EDUCATIONAL_INSTITUTION, HEALTH_CENTER_NON_PROFIT, OTHER]\n+\n+  InstitutionalRole:\n+    type: string\n+    description: >\n+      The union of the roles researchers can have at Institutions of all OrganizationTypes,\n+      derived from CAPS requirements.\n+      InstitutionalRole_ARI, InstitutionalRole_IND_HCNP, and InstitutionalRole_EDU are\n+      subsets of this enum, implemented using the same short-int values.\n+    enum: [\n+      UNDERGRADUATE, TRAINEE, FELLOW, EARLY_CAREER, MID_CAREER, LATE_CAREER,\n+      PRE_DOCTORAL, POST_DOCTORAL, PI,\n+      TEACHER, STUDENT, ADMIN,\n+      PROJECT_PERSONNEL, OTHER\n+    ]\n+\n+  InstitutionalRole_ARI:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7c0461728be4df83df20e6f3a35d751ad3f43f4"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDA5Mjg5", "url": "https://github.com/all-of-us/workbench/pull/3139#pullrequestreview-359409289", "createdAt": "2020-02-16T15:01:33Z", "commit": {"oid": "c7c0461728be4df83df20e6f3a35d751ad3f43f4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNTowMTozM1rOFqT1wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNTowMTozM1rOFqT1wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkwOTU3MA==", "bodyText": "I chose 409 but I'm open to discussion here - will remove the comments when we come to consensus", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r379909570", "createdAt": "2020-02-16T15:01:33Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/api/InstitutionController.java", "diffHunk": "@@ -29,11 +31,24 @@\n   @Override\n   @AuthorityRequired({Authority.INSTITUTION_ADMIN})\n   public ResponseEntity<Void> deleteInstitution(final String shortName) {\n-    if (institutionService.deleteInstitution(shortName)) {\n-      return ResponseEntity.noContent().build();\n-    } else {\n-      throw new NotFoundException(String.format(\"Could not delete Institution %s\", shortName));\n+    final DeletionResult result = institutionService.deleteInstitution(shortName);\n+\n+    // I wanted to use a switch here but Java complained about lacking a return value\n+    if (result == DeletionResult.HAS_VERIFIED_AFFILIATIONS) {\n+      // TODO: 405 or 409?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c7c0461728be4df83df20e6f3a35d751ad3f43f4"}, "originalPosition": 23}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7c0461728be4df83df20e6f3a35d751ad3f43f4", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/c7c0461728be4df83df20e6f3a35d751ad3f43f4", "committedDate": "2020-02-15T15:06:45Z", "message": "mapper update"}, "afterCommit": {"oid": "843e226490b4afa6d1ab1887140e913d50a824c5", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/843e226490b4afa6d1ab1887140e913d50a824c5", "committedDate": "2020-02-16T15:39:41Z", "message": "RW-4259 User model updates for Verified Inst Affil"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDEyNTk5", "url": "https://github.com/all-of-us/workbench/pull/3139#pullrequestreview-359412599", "createdAt": "2020-02-16T15:57:13Z", "commit": {"oid": "843e226490b4afa6d1ab1887140e913d50a824c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNTo1NzoxM1rOFqUEvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNTo1NzoxM1rOFqUEvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkxMzQwNw==", "bodyText": "EAGER fetching became problematic when this was fetched transitively by VerifiedInstitutionalAffiliation.\nTODO: try to understand the Hibernate fetching model better to understand why this was the case", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r379913407", "createdAt": "2020-02-16T15:57:13Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/db/model/DbInstitution.java", "diffHunk": "@@ -81,7 +81,7 @@ public DbInstitution setOrganizationTypeOtherText(String organizationTypeOtherTe\n     return this;\n   }\n \n-  @OneToMany(mappedBy = \"institution\", cascade = CascadeType.ALL, fetch = FetchType.EAGER)\n+  @OneToMany(mappedBy = \"institution\", cascade = CascadeType.ALL)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "843e226490b4afa6d1ab1887140e913d50a824c5"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDEyNjUy", "url": "https://github.com/all-of-us/workbench/pull/3139#pullrequestreview-359412652", "createdAt": "2020-02-16T15:58:06Z", "commit": {"oid": "843e226490b4afa6d1ab1887140e913d50a824c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNTo1ODowNlrOFqUE_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNTo1ODowNlrOFqUE_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkxMzQ2OQ==", "bodyText": "since we make any input into a set we can relax the requirement", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r379913469", "createdAt": "2020-02-16T15:58:06Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/db/model/DbInstitution.java", "diffHunk": "@@ -96,20 +96,22 @@ public DbInstitution setOrganizationTypeOtherText(String organizationTypeOtherTe\n    *\n    * <p>https://stackoverflow.com/questions/5587482/hibernate-a-collection-with-cascade-all-delete-orphan-was-no-longer-referenc\n    *\n-   * @param emailDomains the new set of domains for this Institution\n+   * @param emailDomains the new collection of domains for this Institution", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "843e226490b4afa6d1ab1887140e913d50a824c5"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDE0NTA4", "url": "https://github.com/all-of-us/workbench/pull/3139#pullrequestreview-359414508", "createdAt": "2020-02-16T16:31:25Z", "commit": {"oid": "497db9234d24effffb9f926d3540e9c2137cffa4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNjozMToyNVrOFqUNgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNjozMToyNVrOFqUNgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkxNTY0OQ==", "bodyText": "@Context lets us use the service in @AfterMapping below", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r379915649", "createdAt": "2020-02-16T16:31:25Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/institution/VerifiedInstitutionalAffiliationMapper.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package org.pmiops.workbench.institution;\n+\n+import org.mapstruct.AfterMapping;\n+import org.mapstruct.Context;\n+import org.mapstruct.Mapper;\n+import org.mapstruct.Mapping;\n+import org.mapstruct.MappingTarget;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n+import org.pmiops.workbench.model.VerifiedInstitutionalAffiliation;\n+\n+@Mapper(componentModel = \"spring\")\n+public interface VerifiedInstitutionalAffiliationMapper {\n+  @Mapping(target = \"verifiedInstitutionalAffiliationId\", ignore = true)\n+  @Mapping(target = \"institution\", ignore = true) // set by setDbInstitution()\n+  @Mapping(target = \"user\", ignore = true) // set by caller\n+  DbVerifiedInstitutionalAffiliation modelToDbWithoutUser(\n+      VerifiedInstitutionalAffiliation modelObject, @Context InstitutionService institutionService);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "497db9234d24effffb9f926d3540e9c2137cffa4"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDE0Njky", "url": "https://github.com/all-of-us/workbench/pull/3139#pullrequestreview-359414692", "createdAt": "2020-02-16T16:34:21Z", "commit": {"oid": "497db9234d24effffb9f926d3540e9c2137cffa4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNjozNDoyMVrOFqUOZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNjozNDoyMVrOFqUOZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkxNTg3OQ==", "bodyText": "was not used", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r379915879", "createdAt": "2020-02-16T16:34:21Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -88,14 +91,12 @@\n   private static final String CONTACT_EMAIL = \"bob@example.com\";\n   private static final String INVITATION_KEY = \"secretpassword\";\n   private static final String PRIMARY_EMAIL = \"bob@researchallofus.org\";\n-  private static final String BILLING_PROJECT_PREFIX = \"all-of-us-free-\";\n   private static final String ORGANIZATION = \"Test\";\n   private static final String CURRENT_POSITION = \"Tester\";\n   private static final String RESEARCH_PURPOSE = \"To test things\";\n   private static final int DUA_VERSION = 2;\n \n   @MockBean private FireCloudService fireCloudService;\n-  @MockBean private LeonardoNotebooksClient leonardoNotebooksClient;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "497db9234d24effffb9f926d3540e9c2137cffa4"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDM1NzMz", "url": "https://github.com/all-of-us/workbench/pull/3139#pullrequestreview-359435733", "createdAt": "2020-02-16T22:49:18Z", "commit": {"oid": "23a4ff32909ed1f892408c385e2ae53324ebeb7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQyMjo0OToxOFrOFqVuzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQyMjo0OToxOFrOFqVuzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTk0MDU1Nw==", "bodyText": "moved slightly below for more sensible grouping", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r379940557", "createdAt": "2020-02-16T22:49:18Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -4277,11 +4285,6 @@ definitions:\n       type: integer\n       format: int64\n \n-  OrganizationType:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a4ff32909ed1f892408c385e2ae53324ebeb7f"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDg2MDg2", "url": "https://github.com/all-of-us/workbench/pull/3139#pullrequestreview-360486086", "createdAt": "2020-02-18T16:29:09Z", "commit": {"oid": "d1ecd06dec7d95ab949bd096622fc4ff72506714"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjoyOTowOVrOFrJZbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjoyOTowOVrOFrJZbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc4NzA1Mw==", "bodyText": "Could just repeat the feature flag check here instead of saving a local boolean", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380787053", "createdAt": "2020-02-18T16:29:09Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/db/dao/UserServiceImpl.java", "diffHunk": "@@ -360,8 +375,23 @@ public DbUser createUser(\n             finalDbUserReference.addInstitutionalAffiliation(affiliation);\n           });\n     }\n+    // set via the newer Verified Institutional Affiliation flow\n+    boolean requireInstitutionalVerification =\n+        configProvider.get().featureFlags.requireInstitutionalVerification;\n+    if (requireInstitutionalVerification\n+        && !institutionService.validate(verifiedInstitutionalAffiliation, contactEmail)) {\n+      final String msg =\n+          String.format(\n+              \"Cannot create user %s: invalid Verified Institutional Affiliation\", contactEmail);\n+      throw new BadRequestException(msg);\n+    }\n+\n     try {\n       dbUser = userDao.save(dbUser);\n+      if (requireInstitutionalVerification) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1ecd06dec7d95ab949bd096622fc4ff72506714"}, "originalPosition": 106}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjA5MTI1", "url": "https://github.com/all-of-us/workbench/pull/3139#pullrequestreview-360609125", "createdAt": "2020-02-18T19:25:03Z", "commit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "state": "COMMENTED", "comments": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxOToyNTowM1rOFrPWEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMjoxMjowN1rOFrUW0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg4NDQ5OA==", "bodyText": "Is there a reason for the -tmp- interstitial in the changeset id?", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380884498", "createdAt": "2020-02-18T19:25:03Z", "author": {"login": "gjuggler"}, "path": "api/db/changelog/db.changelog-127-verified-institutional-affiliation.xml", "diffHunk": "@@ -0,0 +1,38 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<databaseChangeLog\n+  xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\n+                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\n+  <changeSet author=\"thibault\" id=\"dchangelog-127-tmp-verified-institutional-affiliation\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg4NTE3Ng==", "bodyText": "[maybe opt] IIRC, most of our other tables associated with the DbUser model and the Profile API have a \"user_\" prefix. Would you be opposed to including that here too?", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380885176", "createdAt": "2020-02-18T19:26:16Z", "author": {"login": "gjuggler"}, "path": "api/db/changelog/db.changelog-127-verified-institutional-affiliation.xml", "diffHunk": "@@ -0,0 +1,38 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<databaseChangeLog\n+  xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\n+                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\n+  <changeSet author=\"thibault\" id=\"dchangelog-127-tmp-verified-institutional-affiliation\">\n+\n+    <createTable tableName=\"verified_institutional_affiliation\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg4NjI2Mw==", "bodyText": "Is there existing precedent for this type of a pattern (returning an enum value to signal the result of some service-level operation)? It's not a bad pattern necessarily (somewhat unix-like), but it's a little surprising to see in Java. I would argue, by consistency alone, we should probably be throwing exceptions for non-success cases instead.\nMore generally: IMO a service class is like a mini internal-only API. We should probably have much clearer documentation on the interface methods (e.g. in this file) specifying when and why certain potential exceptions may be thrown, similar to what we do in our Swagger.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380886263", "createdAt": "2020-02-18T19:28:12Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/institution/InstitutionService.java", "diffHunk": "@@ -2,17 +2,38 @@\n \n import java.util.List;\n import java.util.Optional;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.model.Institution;\n \n public interface InstitutionService {\n   List<Institution> getInstitutions();\n \n   Optional<Institution> getInstitution(final String shortName);\n \n+  Optional<DbInstitution> getDbInstitution(final String shortName);\n+\n   Institution createInstitution(final Institution institutionToCreate);\n \n-  boolean deleteInstitution(final String shortName);\n+  enum DeletionResult {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg4NzkyNg==", "bodyText": "[no action req] I forget if we already hashed this out somewhere, but where does the 80-char limit come from?", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380887926", "createdAt": "2020-02-18T19:31:18Z", "author": {"login": "gjuggler"}, "path": "api/db/changelog/db.changelog-127-verified-institutional-affiliation.xml", "diffHunk": "@@ -0,0 +1,38 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<databaseChangeLog\n+  xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\n+                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\n+  <changeSet author=\"thibault\" id=\"dchangelog-127-tmp-verified-institutional-affiliation\">\n+\n+    <createTable tableName=\"verified_institutional_affiliation\">\n+      <column name=\"verified_institutional_affiliation_id\" type=\"bigint\" autoIncrement=\"true\">\n+        <constraints primaryKey=\"true\" nullable=\"false\"/>\n+      </column>\n+      <column name=\"user_id\" type=\"bigint\">\n+        <constraints\n+          unique=\"true\"\n+          nullable=\"false\"\n+          foreignKeyName=\"fk_verified_institutional_affiliation_user\"\n+          references=\"user(user_id)\"\n+          deleteCascade=\"true\"\n+          />\n+      </column>\n+      <column name=\"institution_id\" type=\"bigint\">\n+        <constraints\n+          nullable=\"false\"\n+          foreignKeyName=\"fk_verified_institutional_affiliation_institution\"\n+          references=\"institution(institution_id)\"\n+          deleteCascade=\"true\"\n+        />\n+      </column>\n+      <column name=\"institutional_role_enum\" type=\"tinyint\">\n+        <constraints nullable=\"false\"/>\n+      </column>\n+      <column name=\"institutional_role_other_text\" type=\"VARCHAR(80)\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5MDU2MQ==", "bodyText": "Interesting question \u2013\u00a0thanks for the references. I'm pretty sold on 409.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380890561", "createdAt": "2020-02-18T19:36:32Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/api/InstitutionController.java", "diffHunk": "@@ -29,10 +30,22 @@\n   @Override\n   @AuthorityRequired({Authority.INSTITUTION_ADMIN})\n   public ResponseEntity<Void> deleteInstitution(final String shortName) {\n-    if (institutionService.deleteInstitution(shortName)) {\n-      return ResponseEntity.noContent().build();\n-    } else {\n-      throw new NotFoundException(String.format(\"Could not delete Institution %s\", shortName));\n+    switch (institutionService.deleteInstitution(shortName)) {\n+      case HAS_VERIFIED_AFFILIATIONS:\n+        // TODO: 405 or 409?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5MDk2Ng==", "bodyText": "Missing closing single-quotation mark?", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380890966", "createdAt": "2020-02-18T19:37:17Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/api/InstitutionController.java", "diffHunk": "@@ -44,7 +57,7 @@\n             .orElseThrow(\n                 () ->\n                     new NotFoundException(\n-                        String.format(\"Could not find Institution %s\", shortName)));\n+                        String.format(\"Could not find Institution '%s\", shortName)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NTY5OA==", "bodyText": "[non-opt] Almost all of our other dao classes have a \"Dao\" suffix. This one should too. This caught me a handful of times while reading through other code that relies on this class \u2013\u00a0it's a useful suffix IMO.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380895698", "createdAt": "2020-02-18T19:46:19Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/db/dao/VerifiedInstitutionalAffiliation.java", "diffHunk": "@@ -0,0 +1,15 @@\n+package org.pmiops.workbench.db.dao;\n+\n+import java.util.Collection;\n+import java.util.Optional;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbUser;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n+import org.springframework.data.repository.CrudRepository;\n+\n+public interface VerifiedInstitutionalAffiliation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NzcwMg==", "bodyText": "Yeah, it shouldn't be necessary to import an actual implementation class from here. I'm digging through our codebase trying to find a direct example of this pattern, but I haven't found anything perfect to point at yet. I'd be happy to sit down and debug some bean loading exceptions, though...\n[Later addition] What I think we generally end up having to do is add impl-class import statements to any test classes which use this service, rather than to the service class itself. That has the disadvantage that if ProfileService is used by multiple tests, you'd have to add this import statement in all places.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380897702", "createdAt": "2020-02-18T19:49:54Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/auth/ProfileService.java", "diffHunk": "@@ -8,22 +8,27 @@\n import org.pmiops.workbench.billing.FreeTierBillingService;\n import org.pmiops.workbench.db.dao.UserDao;\n import org.pmiops.workbench.db.dao.UserTermsOfServiceDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.db.model.DbAddress;\n import org.pmiops.workbench.db.model.DbDemographicSurvey;\n import org.pmiops.workbench.db.model.DbInstitutionalAffiliation;\n import org.pmiops.workbench.db.model.DbPageVisit;\n import org.pmiops.workbench.db.model.DbUser;\n import org.pmiops.workbench.db.model.DbUserTermsOfService;\n+import org.pmiops.workbench.institution.VerifiedInstitutionalAffiliationMapper;\n+import org.pmiops.workbench.institution.VerifiedInstitutionalAffiliationMapperImpl;\n import org.pmiops.workbench.model.Address;\n import org.pmiops.workbench.model.DemographicSurvey;\n import org.pmiops.workbench.model.Disability;\n import org.pmiops.workbench.model.InstitutionalAffiliation;\n import org.pmiops.workbench.model.PageVisit;\n import org.pmiops.workbench.model.Profile;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Import;\n import org.springframework.stereotype.Service;\n \n @Service\n+@Import({VerifiedInstitutionalAffiliationMapperImpl.class})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkwNDI5Ng==", "bodyText": "[nitpick] The wording here may be somewhat unclear: the \"invalid\" error here is that the user's email isn't considered a member of the specified institution, right? Maybe slightly improved wording could be \"Cannot create user {username}: contact email {contactEmail} is not a valid member of the {institutionName} institution.\"", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380904296", "createdAt": "2020-02-18T20:02:00Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/db/dao/UserServiceImpl.java", "diffHunk": "@@ -360,8 +375,23 @@ public DbUser createUser(\n             finalDbUserReference.addInstitutionalAffiliation(affiliation);\n           });\n     }\n+    // set via the newer Verified Institutional Affiliation flow\n+    boolean requireInstitutionalVerification =\n+        configProvider.get().featureFlags.requireInstitutionalVerification;\n+    if (requireInstitutionalVerification\n+        && !institutionService.validate(verifiedInstitutionalAffiliation, contactEmail)) {\n+      final String msg =\n+          String.format(\n+              \"Cannot create user %s: invalid Verified Institutional Affiliation\", contactEmail);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkwNTYwNA==", "bodyText": "Was this change to the jetbrains annotation class intentional?", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380905604", "createdAt": "2020-02-18T20:04:40Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/db/model/DbInstitution.java", "diffHunk": "@@ -1,18 +1,18 @@\n package org.pmiops.workbench.db.model;\n \n import com.google.common.collect.Sets;\n+import java.util.Collection;\n import java.util.Set;\n import java.util.stream.Collectors;\n import javax.persistence.CascadeType;\n import javax.persistence.Column;\n import javax.persistence.Entity;\n-import javax.persistence.FetchType;\n import javax.persistence.GeneratedValue;\n import javax.persistence.GenerationType;\n import javax.persistence.Id;\n import javax.persistence.OneToMany;\n import javax.persistence.Table;\n-import javax.validation.constraints.NotNull;\n+import org.jetbrains.annotations.NotNull;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkxMjA3NQ==", "bodyText": "Does @NotNull annotation have any functional or compile-time impact on our system?\nSomeday we might consider adding something like https://checkerframework.org/manual/#nullness-checker (probably via https://github.com/kelloggm/checkerframework-gradle-plugin) to our build.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380912075", "createdAt": "2020-02-18T20:18:08Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/db/model/DbInstitution.java", "diffHunk": "@@ -96,20 +96,22 @@ public DbInstitution setOrganizationTypeOtherText(String organizationTypeOtherTe\n    *\n    * <p>https://stackoverflow.com/questions/5587482/hibernate-a-collection-with-cascade-all-delete-orphan-was-no-longer-referenc\n    *\n-   * @param emailDomains the new set of domains for this Institution\n+   * @param emailDomains the new collection of domains for this Institution\n    */\n-  public DbInstitution setEmailDomains(final Set<DbInstitutionEmailDomain> emailDomains) {\n+  public DbInstitution setEmailDomains(\n+      @NotNull final Collection<DbInstitutionEmailDomain> emailDomains) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkxNTI3NQ==", "bodyText": "[naming nit] I think validateInstitution would make this read a bit more clearly on the usage side.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380915275", "createdAt": "2020-02-18T20:25:14Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/institution/InstitutionService.java", "diffHunk": "@@ -2,17 +2,38 @@\n \n import java.util.List;\n import java.util.Optional;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.model.Institution;\n \n public interface InstitutionService {\n   List<Institution> getInstitutions();\n \n   Optional<Institution> getInstitution(final String shortName);\n \n+  Optional<DbInstitution> getDbInstitution(final String shortName);\n+\n   Institution createInstitution(final Institution institutionToCreate);\n \n-  boolean deleteInstitution(final String shortName);\n+  enum DeletionResult {\n+    SUCCESS,\n+    NOT_FOUND,\n+    HAS_VERIFIED_AFFILIATIONS\n+  }\n+\n+  DeletionResult deleteInstitution(final String shortName);\n \n   Optional<Institution> updateInstitution(\n       final String shortName, final Institution institutionToUpdate);\n+\n+  /**\n+   * Validates that the user's institutional affiliation is valid, by pattern-matching the user's\n+   * contact email against the institution's set of whitelisted email domains or addresses.\n+   *\n+   * @param verifiedInstitutionalAffiliation the user's declared affiliation\n+   * @param contactEmail the contact email to verify\n+   * @return boolean - does the affiliation pass validation?\n+   */\n+  boolean validate(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkzNzM2Ng==", "bodyText": "[nitpick, unrelated to this PR] It feels a little redundant to have a shortName parameter, when the institutionToUpdate object has a shortName property as well. What would be the expected behavior if shortName=\"foo\" but institutionToUpdate.getShortName()=\"bar\"? Removing shortName as a param might be clearer, but it's obviously not a blocker for this PR (and I clearly haven't thought too carefully about the ramifications).", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380937366", "createdAt": "2020-02-18T21:11:52Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/institution/InstitutionServiceImpl.java", "diffHunk": "@@ -1,103 +1,113 @@\n package org.pmiops.workbench.institution;\n \n-import java.util.Collections;\n import java.util.List;\n import java.util.Optional;\n import java.util.stream.Collectors;\n import java.util.stream.StreamSupport;\n+import javax.mail.internet.AddressException;\n+import javax.mail.internet.InternetAddress;\n import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.db.model.DbInstitution;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailAddress;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailDomain;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.model.Institution;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Import;\n import org.springframework.stereotype.Service;\n \n @Service\n+@Import({InstitutionMapperImpl.class})\n public class InstitutionServiceImpl implements InstitutionService {\n \n   private final InstitutionDao institutionDao;\n+  private final InstitutionMapper institutionMapper;\n+  private final VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation;\n \n   @Autowired\n-  InstitutionServiceImpl(InstitutionDao institutionDao) {\n+  InstitutionServiceImpl(\n+      InstitutionDao institutionDao,\n+      InstitutionMapper institutionMapper,\n+      VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation) {\n     this.institutionDao = institutionDao;\n+    this.institutionMapper = institutionMapper;\n+    this.verifiedInstitutionalAffiliation = verifiedInstitutionalAffiliation;\n   }\n \n   @Override\n   public List<Institution> getInstitutions() {\n     return StreamSupport.stream(institutionDao.findAll().spliterator(), false)\n-        .map(this::toModel)\n+        .map(institutionMapper::dbToModel)\n         .collect(Collectors.toList());\n   }\n \n   @Override\n   public Optional<Institution> getInstitution(final String shortName) {\n-    return getDbInstitution(shortName).map(this::toModel);\n+    return getDbInstitution(shortName).map(institutionMapper::dbToModel);\n+  }\n+\n+  @Override\n+  public Optional<DbInstitution> getDbInstitution(final String shortName) {\n+    return institutionDao.findOneByShortName(shortName);\n   }\n \n   @Override\n   public Institution createInstitution(final Institution institutionToCreate) {\n-    return toModel(institutionDao.save(newDbObject(institutionToCreate)));\n+    return institutionMapper.dbToModel(\n+        institutionDao.save(institutionMapper.modelToDb(institutionToCreate)));\n   }\n \n   @Override\n-  public boolean deleteInstitution(final String shortName) {\n+  public DeletionResult deleteInstitution(final String shortName) {\n     return getDbInstitution(shortName)\n         .map(\n             dbInst -> {\n-              institutionDao.delete(dbInst);\n-              return true;\n+              if (verifiedInstitutionalAffiliation.findAllByInstitution(dbInst).isEmpty()) {\n+                // no verified user affiliations: safe to delete\n+                institutionDao.delete(dbInst);\n+                return DeletionResult.SUCCESS;\n+              } else {\n+                return DeletionResult.HAS_VERIFIED_AFFILIATIONS;\n+              }\n             })\n-        .orElse(false);\n+        .orElse(DeletionResult.NOT_FOUND);\n   }\n \n   @Override\n   public Optional<Institution> updateInstitution(\n       final String shortName, final Institution institutionToUpdate) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkzODI5MQ==", "bodyText": "[naming nit] the use of \"new\" in the variable name confuses things more than it helps, IMO.\nOther options:\n\ndbInstitution\ndbInstitutionToUpdate (bit of a mouthful, but better parallels the input model object)\ndbObjectToUpdate\ndbObject", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380938291", "createdAt": "2020-02-18T21:13:37Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/institution/InstitutionServiceImpl.java", "diffHunk": "@@ -1,103 +1,113 @@\n package org.pmiops.workbench.institution;\n \n-import java.util.Collections;\n import java.util.List;\n import java.util.Optional;\n import java.util.stream.Collectors;\n import java.util.stream.StreamSupport;\n+import javax.mail.internet.AddressException;\n+import javax.mail.internet.InternetAddress;\n import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.db.model.DbInstitution;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailAddress;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailDomain;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.model.Institution;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Import;\n import org.springframework.stereotype.Service;\n \n @Service\n+@Import({InstitutionMapperImpl.class})\n public class InstitutionServiceImpl implements InstitutionService {\n \n   private final InstitutionDao institutionDao;\n+  private final InstitutionMapper institutionMapper;\n+  private final VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation;\n \n   @Autowired\n-  InstitutionServiceImpl(InstitutionDao institutionDao) {\n+  InstitutionServiceImpl(\n+      InstitutionDao institutionDao,\n+      InstitutionMapper institutionMapper,\n+      VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation) {\n     this.institutionDao = institutionDao;\n+    this.institutionMapper = institutionMapper;\n+    this.verifiedInstitutionalAffiliation = verifiedInstitutionalAffiliation;\n   }\n \n   @Override\n   public List<Institution> getInstitutions() {\n     return StreamSupport.stream(institutionDao.findAll().spliterator(), false)\n-        .map(this::toModel)\n+        .map(institutionMapper::dbToModel)\n         .collect(Collectors.toList());\n   }\n \n   @Override\n   public Optional<Institution> getInstitution(final String shortName) {\n-    return getDbInstitution(shortName).map(this::toModel);\n+    return getDbInstitution(shortName).map(institutionMapper::dbToModel);\n+  }\n+\n+  @Override\n+  public Optional<DbInstitution> getDbInstitution(final String shortName) {\n+    return institutionDao.findOneByShortName(shortName);\n   }\n \n   @Override\n   public Institution createInstitution(final Institution institutionToCreate) {\n-    return toModel(institutionDao.save(newDbObject(institutionToCreate)));\n+    return institutionMapper.dbToModel(\n+        institutionDao.save(institutionMapper.modelToDb(institutionToCreate)));\n   }\n \n   @Override\n-  public boolean deleteInstitution(final String shortName) {\n+  public DeletionResult deleteInstitution(final String shortName) {\n     return getDbInstitution(shortName)\n         .map(\n             dbInst -> {\n-              institutionDao.delete(dbInst);\n-              return true;\n+              if (verifiedInstitutionalAffiliation.findAllByInstitution(dbInst).isEmpty()) {\n+                // no verified user affiliations: safe to delete\n+                institutionDao.delete(dbInst);\n+                return DeletionResult.SUCCESS;\n+              } else {\n+                return DeletionResult.HAS_VERIFIED_AFFILIATIONS;\n+              }\n             })\n-        .orElse(false);\n+        .orElse(DeletionResult.NOT_FOUND);\n   }\n \n   @Override\n   public Optional<Institution> updateInstitution(\n       final String shortName, final Institution institutionToUpdate) {\n     return getDbInstitution(shortName)\n-        .map(dbInst -> toModel(institutionDao.save(updateDbObject(dbInst, institutionToUpdate))));\n+        .map(DbInstitution::getInstitutionId)\n+        .map(\n+            dbId -> {\n+              // create new DB object, but mark it with the original's ID to indicate that this is\n+              // an update\n+              final DbInstitution newDbObj =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkzOTU2MA==", "bodyText": "This might be a nice place to add a @nullable annotation, to clarify that we are explicitly handling the null case within the method.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380939560", "createdAt": "2020-02-18T21:16:24Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/institution/InstitutionServiceImpl.java", "diffHunk": "@@ -1,103 +1,113 @@\n package org.pmiops.workbench.institution;\n \n-import java.util.Collections;\n import java.util.List;\n import java.util.Optional;\n import java.util.stream.Collectors;\n import java.util.stream.StreamSupport;\n+import javax.mail.internet.AddressException;\n+import javax.mail.internet.InternetAddress;\n import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.db.model.DbInstitution;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailAddress;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailDomain;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.model.Institution;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Import;\n import org.springframework.stereotype.Service;\n \n @Service\n+@Import({InstitutionMapperImpl.class})\n public class InstitutionServiceImpl implements InstitutionService {\n \n   private final InstitutionDao institutionDao;\n+  private final InstitutionMapper institutionMapper;\n+  private final VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation;\n \n   @Autowired\n-  InstitutionServiceImpl(InstitutionDao institutionDao) {\n+  InstitutionServiceImpl(\n+      InstitutionDao institutionDao,\n+      InstitutionMapper institutionMapper,\n+      VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation) {\n     this.institutionDao = institutionDao;\n+    this.institutionMapper = institutionMapper;\n+    this.verifiedInstitutionalAffiliation = verifiedInstitutionalAffiliation;\n   }\n \n   @Override\n   public List<Institution> getInstitutions() {\n     return StreamSupport.stream(institutionDao.findAll().spliterator(), false)\n-        .map(this::toModel)\n+        .map(institutionMapper::dbToModel)\n         .collect(Collectors.toList());\n   }\n \n   @Override\n   public Optional<Institution> getInstitution(final String shortName) {\n-    return getDbInstitution(shortName).map(this::toModel);\n+    return getDbInstitution(shortName).map(institutionMapper::dbToModel);\n+  }\n+\n+  @Override\n+  public Optional<DbInstitution> getDbInstitution(final String shortName) {\n+    return institutionDao.findOneByShortName(shortName);\n   }\n \n   @Override\n   public Institution createInstitution(final Institution institutionToCreate) {\n-    return toModel(institutionDao.save(newDbObject(institutionToCreate)));\n+    return institutionMapper.dbToModel(\n+        institutionDao.save(institutionMapper.modelToDb(institutionToCreate)));\n   }\n \n   @Override\n-  public boolean deleteInstitution(final String shortName) {\n+  public DeletionResult deleteInstitution(final String shortName) {\n     return getDbInstitution(shortName)\n         .map(\n             dbInst -> {\n-              institutionDao.delete(dbInst);\n-              return true;\n+              if (verifiedInstitutionalAffiliation.findAllByInstitution(dbInst).isEmpty()) {\n+                // no verified user affiliations: safe to delete\n+                institutionDao.delete(dbInst);\n+                return DeletionResult.SUCCESS;\n+              } else {\n+                return DeletionResult.HAS_VERIFIED_AFFILIATIONS;\n+              }\n             })\n-        .orElse(false);\n+        .orElse(DeletionResult.NOT_FOUND);\n   }\n \n   @Override\n   public Optional<Institution> updateInstitution(\n       final String shortName, final Institution institutionToUpdate) {\n     return getDbInstitution(shortName)\n-        .map(dbInst -> toModel(institutionDao.save(updateDbObject(dbInst, institutionToUpdate))));\n+        .map(DbInstitution::getInstitutionId)\n+        .map(\n+            dbId -> {\n+              // create new DB object, but mark it with the original's ID to indicate that this is\n+              // an update\n+              final DbInstitution newDbObj =\n+                  institutionMapper.modelToDb(institutionToUpdate).setInstitutionId(dbId);\n+              return institutionMapper.dbToModel(institutionDao.save(newDbObj));\n+            });\n   }\n \n-  private Optional<DbInstitution> getDbInstitution(String shortName) {\n-    return institutionDao.findOneByShortName(shortName);\n-  }\n+  @Override\n+  public boolean validate(\n+      DbVerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation, String contactEmail) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MDgwNQ==", "bodyText": "I'm not sure this really belongs here... is it the responsibility of the institution service to validate that the contact email address is valid? I would have expected this logic to live in UserService, since it has nothing to do with institutions. Unless I'm missing some scenario where it does?", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380940805", "createdAt": "2020-02-18T21:18:54Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/institution/InstitutionServiceImpl.java", "diffHunk": "@@ -1,103 +1,113 @@\n package org.pmiops.workbench.institution;\n \n-import java.util.Collections;\n import java.util.List;\n import java.util.Optional;\n import java.util.stream.Collectors;\n import java.util.stream.StreamSupport;\n+import javax.mail.internet.AddressException;\n+import javax.mail.internet.InternetAddress;\n import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.db.model.DbInstitution;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailAddress;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailDomain;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.model.Institution;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Import;\n import org.springframework.stereotype.Service;\n \n @Service\n+@Import({InstitutionMapperImpl.class})\n public class InstitutionServiceImpl implements InstitutionService {\n \n   private final InstitutionDao institutionDao;\n+  private final InstitutionMapper institutionMapper;\n+  private final VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation;\n \n   @Autowired\n-  InstitutionServiceImpl(InstitutionDao institutionDao) {\n+  InstitutionServiceImpl(\n+      InstitutionDao institutionDao,\n+      InstitutionMapper institutionMapper,\n+      VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation) {\n     this.institutionDao = institutionDao;\n+    this.institutionMapper = institutionMapper;\n+    this.verifiedInstitutionalAffiliation = verifiedInstitutionalAffiliation;\n   }\n \n   @Override\n   public List<Institution> getInstitutions() {\n     return StreamSupport.stream(institutionDao.findAll().spliterator(), false)\n-        .map(this::toModel)\n+        .map(institutionMapper::dbToModel)\n         .collect(Collectors.toList());\n   }\n \n   @Override\n   public Optional<Institution> getInstitution(final String shortName) {\n-    return getDbInstitution(shortName).map(this::toModel);\n+    return getDbInstitution(shortName).map(institutionMapper::dbToModel);\n+  }\n+\n+  @Override\n+  public Optional<DbInstitution> getDbInstitution(final String shortName) {\n+    return institutionDao.findOneByShortName(shortName);\n   }\n \n   @Override\n   public Institution createInstitution(final Institution institutionToCreate) {\n-    return toModel(institutionDao.save(newDbObject(institutionToCreate)));\n+    return institutionMapper.dbToModel(\n+        institutionDao.save(institutionMapper.modelToDb(institutionToCreate)));\n   }\n \n   @Override\n-  public boolean deleteInstitution(final String shortName) {\n+  public DeletionResult deleteInstitution(final String shortName) {\n     return getDbInstitution(shortName)\n         .map(\n             dbInst -> {\n-              institutionDao.delete(dbInst);\n-              return true;\n+              if (verifiedInstitutionalAffiliation.findAllByInstitution(dbInst).isEmpty()) {\n+                // no verified user affiliations: safe to delete\n+                institutionDao.delete(dbInst);\n+                return DeletionResult.SUCCESS;\n+              } else {\n+                return DeletionResult.HAS_VERIFIED_AFFILIATIONS;\n+              }\n             })\n-        .orElse(false);\n+        .orElse(DeletionResult.NOT_FOUND);\n   }\n \n   @Override\n   public Optional<Institution> updateInstitution(\n       final String shortName, final Institution institutionToUpdate) {\n     return getDbInstitution(shortName)\n-        .map(dbInst -> toModel(institutionDao.save(updateDbObject(dbInst, institutionToUpdate))));\n+        .map(DbInstitution::getInstitutionId)\n+        .map(\n+            dbId -> {\n+              // create new DB object, but mark it with the original's ID to indicate that this is\n+              // an update\n+              final DbInstitution newDbObj =\n+                  institutionMapper.modelToDb(institutionToUpdate).setInstitutionId(dbId);\n+              return institutionMapper.dbToModel(institutionDao.save(newDbObj));\n+            });\n   }\n \n-  private Optional<DbInstitution> getDbInstitution(String shortName) {\n-    return institutionDao.findOneByShortName(shortName);\n-  }\n+  @Override\n+  public boolean validate(\n+      DbVerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation, String contactEmail) {\n+    if (verifiedInstitutionalAffiliation == null) {\n+      return false;\n+    }\n \n-  private DbInstitution newDbObject(final Institution modelObject) {\n-    return updateDbObject(new DbInstitution(), modelObject);\n-  }\n+    final Institution inst =\n+        institutionMapper.dbToModel(verifiedInstitutionalAffiliation.getInstitution());\n \n-  private DbInstitution updateDbObject(\n-      final DbInstitution dbObject, final Institution modelObject) {\n-    return dbObject\n-        .setShortName(modelObject.getShortName())\n-        .setDisplayName(modelObject.getDisplayName())\n-        .setOrganizationTypeEnum(modelObject.getOrganizationTypeEnum())\n-        .setOrganizationTypeOtherText(modelObject.getOrganizationTypeOtherText())\n-        .setEmailDomains(\n-            Optional.ofNullable(modelObject.getEmailDomains()).orElse(Collections.emptyList())\n-                .stream()\n-                .map(domain -> new DbInstitutionEmailDomain().setEmailDomain(domain))\n-                .collect(Collectors.toSet()))\n-        .setEmailAddresses(\n-            Optional.ofNullable(modelObject.getEmailAddresses()).orElse(Collections.emptyList())\n-                .stream()\n-                .map(address -> new DbInstitutionEmailAddress().setEmailAddress(address))\n-                .collect(Collectors.toSet()));\n-  }\n+    try {\n+      new InternetAddress(contactEmail).validate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0Mjk4OA==", "bodyText": "[naming nit] I got a little caught up by the fact that this Db-model parameter was named without a \"db\" prefix. I know we're not super consistent about this (partly because much of the codebase existed before we'd added the db prefix to the class names), so I'll leave it to you to decide whether or not to change, but I would probably find it easier to read if it were \"DbVerifiedInstitutionalAffiliation dbVerifiedInstitutionalAffiliation\", or maybe \"dbAffiliation\" to save on chars since it's becoming a mouthful.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380942988", "createdAt": "2020-02-18T21:23:28Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/institution/InstitutionServiceImpl.java", "diffHunk": "@@ -1,103 +1,113 @@\n package org.pmiops.workbench.institution;\n \n-import java.util.Collections;\n import java.util.List;\n import java.util.Optional;\n import java.util.stream.Collectors;\n import java.util.stream.StreamSupport;\n+import javax.mail.internet.AddressException;\n+import javax.mail.internet.InternetAddress;\n import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.db.model.DbInstitution;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailAddress;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailDomain;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.model.Institution;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Import;\n import org.springframework.stereotype.Service;\n \n @Service\n+@Import({InstitutionMapperImpl.class})\n public class InstitutionServiceImpl implements InstitutionService {\n \n   private final InstitutionDao institutionDao;\n+  private final InstitutionMapper institutionMapper;\n+  private final VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation;\n \n   @Autowired\n-  InstitutionServiceImpl(InstitutionDao institutionDao) {\n+  InstitutionServiceImpl(\n+      InstitutionDao institutionDao,\n+      InstitutionMapper institutionMapper,\n+      VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation) {\n     this.institutionDao = institutionDao;\n+    this.institutionMapper = institutionMapper;\n+    this.verifiedInstitutionalAffiliation = verifiedInstitutionalAffiliation;\n   }\n \n   @Override\n   public List<Institution> getInstitutions() {\n     return StreamSupport.stream(institutionDao.findAll().spliterator(), false)\n-        .map(this::toModel)\n+        .map(institutionMapper::dbToModel)\n         .collect(Collectors.toList());\n   }\n \n   @Override\n   public Optional<Institution> getInstitution(final String shortName) {\n-    return getDbInstitution(shortName).map(this::toModel);\n+    return getDbInstitution(shortName).map(institutionMapper::dbToModel);\n+  }\n+\n+  @Override\n+  public Optional<DbInstitution> getDbInstitution(final String shortName) {\n+    return institutionDao.findOneByShortName(shortName);\n   }\n \n   @Override\n   public Institution createInstitution(final Institution institutionToCreate) {\n-    return toModel(institutionDao.save(newDbObject(institutionToCreate)));\n+    return institutionMapper.dbToModel(\n+        institutionDao.save(institutionMapper.modelToDb(institutionToCreate)));\n   }\n \n   @Override\n-  public boolean deleteInstitution(final String shortName) {\n+  public DeletionResult deleteInstitution(final String shortName) {\n     return getDbInstitution(shortName)\n         .map(\n             dbInst -> {\n-              institutionDao.delete(dbInst);\n-              return true;\n+              if (verifiedInstitutionalAffiliation.findAllByInstitution(dbInst).isEmpty()) {\n+                // no verified user affiliations: safe to delete\n+                institutionDao.delete(dbInst);\n+                return DeletionResult.SUCCESS;\n+              } else {\n+                return DeletionResult.HAS_VERIFIED_AFFILIATIONS;\n+              }\n             })\n-        .orElse(false);\n+        .orElse(DeletionResult.NOT_FOUND);\n   }\n \n   @Override\n   public Optional<Institution> updateInstitution(\n       final String shortName, final Institution institutionToUpdate) {\n     return getDbInstitution(shortName)\n-        .map(dbInst -> toModel(institutionDao.save(updateDbObject(dbInst, institutionToUpdate))));\n+        .map(DbInstitution::getInstitutionId)\n+        .map(\n+            dbId -> {\n+              // create new DB object, but mark it with the original's ID to indicate that this is\n+              // an update\n+              final DbInstitution newDbObj =\n+                  institutionMapper.modelToDb(institutionToUpdate).setInstitutionId(dbId);\n+              return institutionMapper.dbToModel(institutionDao.save(newDbObj));\n+            });\n   }\n \n-  private Optional<DbInstitution> getDbInstitution(String shortName) {\n-    return institutionDao.findOneByShortName(shortName);\n-  }\n+  @Override\n+  public boolean validate(\n+      DbVerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation, String contactEmail) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0Mzg0NQ==", "bodyText": "I have to be honest, I don't really know what I should be looking for when reviewing mapper code. So I haven't left too many comments, or frankly dug too deep into the details of this file.\nOne thing that would help me understand better (and have more confidence) would be some test cases. Should there be a test case for this mapper class? (I see ones for CohortMapper and WorkspaceMapper, but I'm not super clear on whether we're requiring unit tests for mapper classes.).", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380943845", "createdAt": "2020-02-18T21:25:24Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/institution/VerifiedInstitutionalAffiliationMapper.java", "diffHunk": "@@ -0,0 +1,37 @@\n+package org.pmiops.workbench.institution;\n+\n+import org.mapstruct.AfterMapping;\n+import org.mapstruct.Context;\n+import org.mapstruct.Mapper;\n+import org.mapstruct.Mapping;\n+import org.mapstruct.MappingTarget;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n+import org.pmiops.workbench.model.VerifiedInstitutionalAffiliation;\n+\n+@Mapper(componentModel = \"spring\")\n+public interface VerifiedInstitutionalAffiliationMapper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0NTQzMA==", "bodyText": "Can you provide an example of a short name, to anchor a user's expectation of what they will find here? e.g. is this \"VUMC\" or \"Vanderbilt University Medical Center\"? It may help us understand whether the RDR may require the longer name as well in order to satisfy their researcher display requirements.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380945430", "createdAt": "2020-02-18T21:28:39Z", "author": {"login": "gjuggler"}, "path": "api/src/main/resources/rdr.yaml", "diffHunk": "@@ -223,6 +225,19 @@ definitions:\n       nonAcademicAffiliation:\n         type: boolean\n \n+  ResearcherVerifiedInstitutionalAffiliation:\n+    type: object\n+    required:\n+      - institutionShortName\n+      - institutionalRole\n+    properties:\n+      institutionShortName:\n+        type: string\n+        description: The unique Short Name of the Institution where the user has a Verified Affiliation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1MTg0MQ==", "bodyText": "nit: it's a bit awkward that PI is abbreviated while nothing else is. Unless there's some external reason here, I'd expand it to \"PRINCIPAL_INVESTIGATOR\"", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380951841", "createdAt": "2020-02-18T21:41:36Z", "author": {"login": "gjuggler"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -4324,3 +4329,76 @@ definitions:\n         type: \"array\"\n         items:\n           $ref: \"#/definitions/Institution\"\n+\n+  OrganizationType:\n+    type: string\n+    description: A categorization of institutions, derived from CAPS requirements\n+    enum: [ACADEMIC_RESEARCH_INSTITUTION, INDUSTRY, EDUCATIONAL_INSTITUTION, HEALTH_CENTER_NON_PROFIT, OTHER]\n+\n+  InstitutionalRole:\n+    type: string\n+    description: >\n+      The union of the roles researchers can have at Institutions of all OrganizationTypes,\n+      derived from CAPS requirements.\n+      InstitutionalRole_ARI, InstitutionalRole_IND_HCNP, and InstitutionalRole_EDU are\n+      subsets of this enum, implemented using the same short-int values.\n+    enum: [\n+      UNDERGRADUATE, TRAINEE, FELLOW, EARLY_CAREER, MID_CAREER, LATE_CAREER,\n+      PRE_DOCTORAL, POST_DOCTORAL, PI,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1MjMxMg==", "bodyText": "Yeah, I think this fits better in the UI code only. That way we can make it more clear that these are never stored, and should only be in reference to the Swagger-defined enum values.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380952312", "createdAt": "2020-02-18T21:42:40Z", "author": {"login": "gjuggler"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -4324,3 +4327,76 @@ definitions:\n         type: \"array\"\n         items:\n           $ref: \"#/definitions/Institution\"\n+\n+  OrganizationType:\n+    type: string\n+    description: A categorization of institutions, derived from CAPS requirements\n+    enum: [ACADEMIC_RESEARCH_INSTITUTION, INDUSTRY, EDUCATIONAL_INSTITUTION, HEALTH_CENTER_NON_PROFIT, OTHER]\n+\n+  InstitutionalRole:\n+    type: string\n+    description: >\n+      The union of the roles researchers can have at Institutions of all OrganizationTypes,\n+      derived from CAPS requirements.\n+      InstitutionalRole_ARI, InstitutionalRole_IND_HCNP, and InstitutionalRole_EDU are\n+      subsets of this enum, implemented using the same short-int values.\n+    enum: [\n+      UNDERGRADUATE, TRAINEE, FELLOW, EARLY_CAREER, MID_CAREER, LATE_CAREER,\n+      PRE_DOCTORAL, POST_DOCTORAL, PI,\n+      TEACHER, STUDENT, ADMIN,\n+      PROJECT_PERSONNEL, OTHER\n+    ]\n+\n+  InstitutionalRole_ARI:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkwOTI4Mg=="}, "originalCommit": {"oid": "c7c0461728be4df83df20e6f3a35d751ad3f43f4"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1MzA0Mw==", "bodyText": "[no action] Not saying you should do it here, but one thing I've started doing in PRs is trying to Autowire a service like this when I find myself having to update constructors in random, unrelated places. It does have a fully-expected side effect of blowing up the scope of a PR though... :)", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380953043", "createdAt": "2020-02-18T21:44:10Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/api/AuthDomainControllerTest.java", "diffHunk": "@@ -88,7 +92,9 @@ public void setUp() {\n             Providers.of(config),\n             complianceService,\n             directoryService,\n-            mockUserServiceAuditAdapter);\n+            mockUserServiceAuditAdapter,\n+            institutionService,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1Mzk3OA==", "bodyText": "I would probably expect to see a test that when the flag is true, and the profile is saved without any valid institution, an exception is thrown.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380953978", "createdAt": "2020-02-18T21:46:11Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -416,6 +443,29 @@ public void testMe_removeAllInstitutionalAffiliations() throws Exception {\n     assertThat(result.getInstitutionalAffiliations().size()).isEqualTo(0);\n   }\n \n+  @Test\n+  public void testMe_verifiedInstitutionalAffiliation() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1Nzk2Mg==", "bodyText": "I'm not sure whether this assertion and the two verify calls below this are strictly necessary. Is there a particular reason you included them, or was it mostly leftover from copying the existing tests?\nMaybe it's a little too minimal, but I wouldn't argue against just keeping the last check, so this case is really centered on ensuring the verified institution is stored and returned correctly.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380957962", "createdAt": "2020-02-18T21:53:50Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -416,6 +443,29 @@ public void testMe_removeAllInstitutionalAffiliations() throws Exception {\n     assertThat(result.getInstitutionalAffiliations().size()).isEqualTo(0);\n   }\n \n+  @Test\n+  public void testMe_verifiedInstitutionalAffiliation() throws Exception {\n+    // set feature flag\n+    config.featureFlags.requireInstitutionalVerification = true;\n+\n+    createUser();\n+    Profile profile = profileController.getMe().getBody();\n+    assertProfile(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1ODUwOA==", "bodyText": "I'm not immediately getting why this change was necessary. Can you comment?", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380958508", "createdAt": "2020-02-18T21:55:01Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/auth/ProfileServiceTest.java", "diffHunk": "@@ -35,14 +39,15 @@\n \n   @Test\n   public void testGetProfile_empty() {\n-    assertThat(profileService.getProfile(new DbUser())).isNotNull();\n+    assertThat(profileService.getProfile(userDao.save(new DbUser()))).isNotNull();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2MDc3NA==", "bodyText": "Interesting \u2013 I didn't expect to see so much test coverage for the DAO object! Not that this is a bad thing, but given that DAOs are mostly implemented via Spring/Hibernate internals, and we have many existing DAO classes without unit tests, I'd sort of built up a mental model that we don't require test coverage for these, since we \"trust\" our frameworks to do their thing, and there's also implicit coverage via the controller tests.\nShould I update my understanding? Where or when would you decide that a DAO is complex enough to warrant test coverage?", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380960774", "createdAt": "2020-02-18T21:59:32Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/db/dao/VerifiedInstitutionalAffiliationTest.java", "diffHunk": "@@ -0,0 +1,227 @@\n+package org.pmiops.workbench.db.dao;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2MjIzOQ==", "bodyText": "[style consistency] I think to use ALL_CAPS, these should be static final variables. At least that's what I'm finding from digging around our codebase for a minute.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380962239", "createdAt": "2020-02-18T22:02:39Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/institution/InstitutionServiceTest.java", "diffHunk": "@@ -20,71 +27,89 @@\n \n @RunWith(SpringRunner.class)\n @DataJpaTest\n-@Import({InstitutionServiceImpl.class})\n+@Import({InstitutionServiceImpl.class, InstitutionMapperImpl.class})\n public class InstitutionServiceTest {\n   @Autowired private InstitutionService service;\n+  @Autowired private UserDao userDao;\n+  @Autowired private VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation;\n \n-  private final Institution testInst =\n+  private final Institution TEST_INST =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2MjczMA==", "bodyText": "[super nit] personally I'd expand RT to ROUNDTRIP or ROUND_TRIP to save someone the effort of parsing out what this means.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380962730", "createdAt": "2020-02-18T22:03:35Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/institution/InstitutionServiceTest.java", "diffHunk": "@@ -20,71 +27,89 @@\n \n @RunWith(SpringRunner.class)\n @DataJpaTest\n-@Import({InstitutionServiceImpl.class})\n+@Import({InstitutionServiceImpl.class, InstitutionMapperImpl.class})\n public class InstitutionServiceTest {\n   @Autowired private InstitutionService service;\n+  @Autowired private UserDao userDao;\n+  @Autowired private VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation;\n \n-  private final Institution testInst =\n+  private final Institution TEST_INST =\n       new Institution().shortName(\"test\").displayName(\"this is a test\");\n \n-  // the DB converts nulls to empty lists\n-  private final Institution testInstAfterRT =\n+  // the mapper converts nulls to empty sets\n+  private final Institution TEST_INST_AFTER_RT =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2MzYyNQ==", "bodyText": "It's not obvious to me what this addition to the test case is checking. It feels like we've actually munged two tests into one here, which can sometimes be a net negative for clarity / maintainability. Either add a comment to clarify why this is part of the \"base\" createInstitution test method, or otherwise split out to a separate method with a name which clarifies the intent.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380963625", "createdAt": "2020-02-18T22:05:31Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/institution/InstitutionServiceTest.java", "diffHunk": "@@ -20,71 +27,89 @@\n \n @RunWith(SpringRunner.class)\n @DataJpaTest\n-@Import({InstitutionServiceImpl.class})\n+@Import({InstitutionServiceImpl.class, InstitutionMapperImpl.class})\n public class InstitutionServiceTest {\n   @Autowired private InstitutionService service;\n+  @Autowired private UserDao userDao;\n+  @Autowired private VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation;\n \n-  private final Institution testInst =\n+  private final Institution TEST_INST =\n       new Institution().shortName(\"test\").displayName(\"this is a test\");\n \n-  // the DB converts nulls to empty lists\n-  private final Institution testInstAfterRT =\n+  // the mapper converts nulls to empty sets\n+  private final Institution TEST_INST_AFTER_RT =\n       new Institution()\n-          .shortName(testInst.getShortName())\n-          .displayName(testInst.getDisplayName())\n+          .shortName(TEST_INST.getShortName())\n+          .displayName(TEST_INST.getDisplayName())\n           .emailDomains(Collections.emptyList())\n           .emailAddresses(Collections.emptyList());\n \n   @Before\n   public void setUp() {\n-    service.createInstitution(testInst);\n+    // will be retrieved as TEST_INST_AFTER_RT\n+    service.createInstitution(TEST_INST);\n   }\n \n   @Test\n   public void test_createInstitution() {\n-    assertThat(service.getInstitutions()).hasSize(1);\n+    assertThat(service.getInstitutions()).containsExactly(TEST_INST_AFTER_RT);\n \n-    service.createInstitution(\n-        new Institution().shortName(\"otherInst\").displayName(\"The Institution of testing\"));\n-    assertThat(service.getInstitutions()).hasSize(2);\n+    final Institution otherInst =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2MzkxOA==", "bodyText": "[nit] This seems like a redundant assertion which is checked in earlier tests. I'd probably remove.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380963918", "createdAt": "2020-02-18T22:06:08Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/institution/InstitutionServiceTest.java", "diffHunk": "@@ -20,71 +27,89 @@\n \n @RunWith(SpringRunner.class)\n @DataJpaTest\n-@Import({InstitutionServiceImpl.class})\n+@Import({InstitutionServiceImpl.class, InstitutionMapperImpl.class})\n public class InstitutionServiceTest {\n   @Autowired private InstitutionService service;\n+  @Autowired private UserDao userDao;\n+  @Autowired private VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation;\n \n-  private final Institution testInst =\n+  private final Institution TEST_INST =\n       new Institution().shortName(\"test\").displayName(\"this is a test\");\n \n-  // the DB converts nulls to empty lists\n-  private final Institution testInstAfterRT =\n+  // the mapper converts nulls to empty sets\n+  private final Institution TEST_INST_AFTER_RT =\n       new Institution()\n-          .shortName(testInst.getShortName())\n-          .displayName(testInst.getDisplayName())\n+          .shortName(TEST_INST.getShortName())\n+          .displayName(TEST_INST.getDisplayName())\n           .emailDomains(Collections.emptyList())\n           .emailAddresses(Collections.emptyList());\n \n   @Before\n   public void setUp() {\n-    service.createInstitution(testInst);\n+    // will be retrieved as TEST_INST_AFTER_RT\n+    service.createInstitution(TEST_INST);\n   }\n \n   @Test\n   public void test_createInstitution() {\n-    assertThat(service.getInstitutions()).hasSize(1);\n+    assertThat(service.getInstitutions()).containsExactly(TEST_INST_AFTER_RT);\n \n-    service.createInstitution(\n-        new Institution().shortName(\"otherInst\").displayName(\"The Institution of testing\"));\n-    assertThat(service.getInstitutions()).hasSize(2);\n+    final Institution otherInst =\n+        new Institution()\n+            .shortName(\"otherInst\")\n+            .displayName(\"The Institution of testing\")\n+            .emailDomains(Collections.emptyList())\n+            .emailAddresses(Collections.emptyList());\n+    assertThat(service.createInstitution(otherInst)).isEqualTo(otherInst);\n+\n+    assertThat(service.getInstitutions()).containsExactly(TEST_INST_AFTER_RT, otherInst);\n   }\n \n   @Test\n   public void test_deleteInstitution() {\n-    assertThat(service.getInstitutions()).hasSize(1);\n+    assertThat(service.getInstitutions()).containsExactly(TEST_INST_AFTER_RT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2NDMwMw==", "bodyText": "Same general point as before \u2013\u00a0this should probably be a new test method, since you're starting fresh again. This will help future readers & maintainers of the code by keeping things simple.\nPlus, when you isolate the \"failure case\" into its own test method, you can use the @test(expected = ExceptionClass.class) annotation to do the heavy lifting of verification for you, which I find really easy to follow.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380964303", "createdAt": "2020-02-18T22:06:55Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/institution/InstitutionServiceTest.java", "diffHunk": "@@ -20,71 +27,89 @@\n \n @RunWith(SpringRunner.class)\n @DataJpaTest\n-@Import({InstitutionServiceImpl.class})\n+@Import({InstitutionServiceImpl.class, InstitutionMapperImpl.class})\n public class InstitutionServiceTest {\n   @Autowired private InstitutionService service;\n+  @Autowired private UserDao userDao;\n+  @Autowired private VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation;\n \n-  private final Institution testInst =\n+  private final Institution TEST_INST =\n       new Institution().shortName(\"test\").displayName(\"this is a test\");\n \n-  // the DB converts nulls to empty lists\n-  private final Institution testInstAfterRT =\n+  // the mapper converts nulls to empty sets\n+  private final Institution TEST_INST_AFTER_RT =\n       new Institution()\n-          .shortName(testInst.getShortName())\n-          .displayName(testInst.getDisplayName())\n+          .shortName(TEST_INST.getShortName())\n+          .displayName(TEST_INST.getDisplayName())\n           .emailDomains(Collections.emptyList())\n           .emailAddresses(Collections.emptyList());\n \n   @Before\n   public void setUp() {\n-    service.createInstitution(testInst);\n+    // will be retrieved as TEST_INST_AFTER_RT\n+    service.createInstitution(TEST_INST);\n   }\n \n   @Test\n   public void test_createInstitution() {\n-    assertThat(service.getInstitutions()).hasSize(1);\n+    assertThat(service.getInstitutions()).containsExactly(TEST_INST_AFTER_RT);\n \n-    service.createInstitution(\n-        new Institution().shortName(\"otherInst\").displayName(\"The Institution of testing\"));\n-    assertThat(service.getInstitutions()).hasSize(2);\n+    final Institution otherInst =\n+        new Institution()\n+            .shortName(\"otherInst\")\n+            .displayName(\"The Institution of testing\")\n+            .emailDomains(Collections.emptyList())\n+            .emailAddresses(Collections.emptyList());\n+    assertThat(service.createInstitution(otherInst)).isEqualTo(otherInst);\n+\n+    assertThat(service.getInstitutions()).containsExactly(TEST_INST_AFTER_RT, otherInst);\n   }\n \n   @Test\n   public void test_deleteInstitution() {\n-    assertThat(service.getInstitutions()).hasSize(1);\n+    assertThat(service.getInstitutions()).containsExactly(TEST_INST_AFTER_RT);\n+\n+    assertThat(service.deleteInstitution(TEST_INST.getShortName()))\n+        .isEqualTo(DeletionResult.SUCCESS);\n+    assertThat(service.getInstitutions()).isEmpty();\n+\n+    service.createInstitution(TEST_INST);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk2NjYwOA==", "bodyText": "This might be made more realistic / meaningful by having a user with a valid email address which doesn't exist in the institution's list. None of the tests explicitly checks this important negative case yet, while a totally-empty dbUser object is less-likely to exist in our system.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r380966608", "createdAt": "2020-02-18T22:12:07Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/institution/InstitutionServiceTest.java", "diffHunk": "@@ -153,4 +178,84 @@ public void test_nonUniqueIds() {\n         new Institution().shortName(\"test\").displayName(\"We are all individuals\"));\n     service.createInstitution(new Institution().shortName(\"test\").displayName(\"I'm not\"));\n   }\n+\n+  @Test\n+  public void test_emailValidation_domain() {\n+    final Institution inst =\n+        service.createInstitution(\n+            new Institution()\n+                .shortName(\"Broad\")\n+                .displayName(\"The Broad Institute\")\n+                .emailDomains(Lists.newArrayList(\"broad.org\", \"lab.broad.org\")));\n+\n+    final DbUser user = createUser(\"user@broad.org\");\n+    final DbVerifiedInstitutionalAffiliation affiliation =\n+        createAffiliation(user, inst.getShortName());\n+\n+    assertThat(service.validate(affiliation, user.getContactEmail())).isTrue();\n+  }\n+\n+  @Test\n+  public void test_emailValidation_address() {\n+    final Institution inst =\n+        service.createInstitution(\n+            new Institution()\n+                .shortName(\"Broad\")\n+                .displayName(\"The Broad Institute\")\n+                .emailDomains(Lists.newArrayList(\"broad.org\", \"mit.edu\"))\n+                .emailAddresses(\n+                    Lists.newArrayList(\"external-researcher@sanger.uk\", \"science@aol.com\")));\n+\n+    final DbUser user = createUser(\"external-researcher@sanger.uk\");\n+    final DbVerifiedInstitutionalAffiliation affiliation =\n+        createAffiliation(user, inst.getShortName());\n+\n+    assertThat(service.validate(affiliation, user.getContactEmail())).isTrue();\n+  }\n+\n+  @Test\n+  public void test_emailValidation_null() {\n+    final Institution inst =\n+        service.createInstitution(\n+            new Institution().shortName(\"Broad\").displayName(\"The Broad Institute\"));\n+\n+    final DbUser user = userDao.save(new DbUser());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 201}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7413db90d90b4d50185bdad03df6fc995d3d7fb4", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/7413db90d90b4d50185bdad03df6fc995d3d7fb4", "committedDate": "2020-02-19T19:45:51Z", "message": "another @Import"}, "afterCommit": {"oid": "cdfe87d1ece45554886de7e885c0a88eb073f9d0", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/cdfe87d1ece45554886de7e885c0a88eb073f9d0", "committedDate": "2020-02-20T04:12:54Z", "message": "VerifiedInstitutionalAffiliationMapperTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87adf8371653428c147e8a9b54b1c62af62b1b2d", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/87adf8371653428c147e8a9b54b1c62af62b1b2d", "committedDate": "2020-02-20T18:03:16Z", "message": "RW-4259 User model updates for Verified Inst Affil"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f41366703ec97a46413d280e3ba88b6615a1fa41", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/f41366703ec97a46413d280e3ba88b6615a1fa41", "committedDate": "2020-02-20T18:05:11Z", "message": "PR feedback\n\nadd delete inst 409 description\n\nrm InstitutionalRole subtypes\n\npropagate requireInstitutionalVerification to the UI\n\nfix quote\n\nthrow deleteInstitution() exceptions at Service level\n\nouch - forgot the Dao from the name\n\nmove @Imports from services to tests\n\nbetter error message\n\ninstitutionService.validate() -> validateAffiliation()\n\nbetter update tests\n\nlint and missed one @Import\n\nrename DB table to user_verified_institutional_affiliation\n\nanother @Import\n\nreview comments\n\nrename params/variables to make it clear they're the DB versions\n\nmore\n\nlint\n\nadd RW-4489 comment\n\ntmp need to pause to fix a bug\n\nInstitutionMapperTest\n\nVerifiedInstitutionalAffiliationMapperTest\n\ndescriptions of short name and display name\n\nbetter ProfileControllerTests and some bugfixes\n\nInstitutionServiceTest improvements"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bfc7e6ab4868c2a31083209566025a5044300e13", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/bfc7e6ab4868c2a31083209566025a5044300e13", "committedDate": "2020-02-20T17:57:55Z", "message": "InstitutionServiceTest improvements"}, "afterCommit": {"oid": "f41366703ec97a46413d280e3ba88b6615a1fa41", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/f41366703ec97a46413d280e3ba88b6615a1fa41", "committedDate": "2020-02-20T18:05:11Z", "message": "PR feedback\n\nadd delete inst 409 description\n\nrm InstitutionalRole subtypes\n\npropagate requireInstitutionalVerification to the UI\n\nfix quote\n\nthrow deleteInstitution() exceptions at Service level\n\nouch - forgot the Dao from the name\n\nmove @Imports from services to tests\n\nbetter error message\n\ninstitutionService.validate() -> validateAffiliation()\n\nbetter update tests\n\nlint and missed one @Import\n\nrename DB table to user_verified_institutional_affiliation\n\nanother @Import\n\nreview comments\n\nrename params/variables to make it clear they're the DB versions\n\nmore\n\nlint\n\nadd RW-4489 comment\n\ntmp need to pause to fix a bug\n\nInstitutionMapperTest\n\nVerifiedInstitutionalAffiliationMapperTest\n\ndescriptions of short name and display name\n\nbetter ProfileControllerTests and some bugfixes\n\nInstitutionServiceTest improvements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2020459543d5403c59abc23d859bc4daeb2c3bbc", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/2020459543d5403c59abc23d859bc4daeb2c3bbc", "committedDate": "2020-02-20T19:59:30Z", "message": "comment fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "087bd09ac1bebf0ae6c3aa6f28d24acb9cf47c4f", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/087bd09ac1bebf0ae6c3aa6f28d24acb9cf47c4f", "committedDate": "2020-02-20T20:17:22Z", "message": "Apparently we need to observe the DB to ensure the transaction is complete? hmmmmm"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjA5NTE0", "url": "https://github.com/all-of-us/workbench/pull/3139#pullrequestreview-362209514", "createdAt": "2020-02-20T20:26:47Z", "commit": {"oid": "087bd09ac1bebf0ae6c3aa6f28d24acb9cf47c4f"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMDoyNjo0N1rOFsiBhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQyMjoxNzo0OFrOFslGNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjIzOTEwOQ==", "bodyText": "Thanks \u2013\u00a0that clarification helps!\n[Note: everything below is not for this PR, just general discussion and/or potential follow-up]\nI'm still not sold that including the shortName parameter here is necessary or helpful. I feel like it would be simpler & maybe clearer to update the shortName of the object by passing just the Institution object, e.g.\nupdate(inst(shortName=\"TheBroadInst\", id=1234))\nsince the database ID is immutable, that can always be used by the implementation to identify the object to be updated.\nLooking further up the stack, I see that our workbench.yaml API surface includes the institution short-name in some of the API calls. So I can see how that naturally propagated down here to the service level.\nMaybe that's the part that is causing me some unease, that we're using a mutable key as an identifier in one of our CRUD APIs. That's usually a red flag to me \u2014\u00a0especially when we have a database ID to serve as an immutable key \u2014 but maybe there's an important reason we opted for that approach?\nAnyway, there's clearly no action for this PR here. Let's close the loop offline and figure out if there's anything worth doing as follow-up.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r382239109", "createdAt": "2020-02-20T20:26:47Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/institution/InstitutionServiceImpl.java", "diffHunk": "@@ -1,103 +1,113 @@\n package org.pmiops.workbench.institution;\n \n-import java.util.Collections;\n import java.util.List;\n import java.util.Optional;\n import java.util.stream.Collectors;\n import java.util.stream.StreamSupport;\n+import javax.mail.internet.AddressException;\n+import javax.mail.internet.InternetAddress;\n import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.db.model.DbInstitution;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailAddress;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailDomain;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.model.Institution;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Import;\n import org.springframework.stereotype.Service;\n \n @Service\n+@Import({InstitutionMapperImpl.class})\n public class InstitutionServiceImpl implements InstitutionService {\n \n   private final InstitutionDao institutionDao;\n+  private final InstitutionMapper institutionMapper;\n+  private final VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation;\n \n   @Autowired\n-  InstitutionServiceImpl(InstitutionDao institutionDao) {\n+  InstitutionServiceImpl(\n+      InstitutionDao institutionDao,\n+      InstitutionMapper institutionMapper,\n+      VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation) {\n     this.institutionDao = institutionDao;\n+    this.institutionMapper = institutionMapper;\n+    this.verifiedInstitutionalAffiliation = verifiedInstitutionalAffiliation;\n   }\n \n   @Override\n   public List<Institution> getInstitutions() {\n     return StreamSupport.stream(institutionDao.findAll().spliterator(), false)\n-        .map(this::toModel)\n+        .map(institutionMapper::dbToModel)\n         .collect(Collectors.toList());\n   }\n \n   @Override\n   public Optional<Institution> getInstitution(final String shortName) {\n-    return getDbInstitution(shortName).map(this::toModel);\n+    return getDbInstitution(shortName).map(institutionMapper::dbToModel);\n+  }\n+\n+  @Override\n+  public Optional<DbInstitution> getDbInstitution(final String shortName) {\n+    return institutionDao.findOneByShortName(shortName);\n   }\n \n   @Override\n   public Institution createInstitution(final Institution institutionToCreate) {\n-    return toModel(institutionDao.save(newDbObject(institutionToCreate)));\n+    return institutionMapper.dbToModel(\n+        institutionDao.save(institutionMapper.modelToDb(institutionToCreate)));\n   }\n \n   @Override\n-  public boolean deleteInstitution(final String shortName) {\n+  public DeletionResult deleteInstitution(final String shortName) {\n     return getDbInstitution(shortName)\n         .map(\n             dbInst -> {\n-              institutionDao.delete(dbInst);\n-              return true;\n+              if (verifiedInstitutionalAffiliation.findAllByInstitution(dbInst).isEmpty()) {\n+                // no verified user affiliations: safe to delete\n+                institutionDao.delete(dbInst);\n+                return DeletionResult.SUCCESS;\n+              } else {\n+                return DeletionResult.HAS_VERIFIED_AFFILIATIONS;\n+              }\n             })\n-        .orElse(false);\n+        .orElse(DeletionResult.NOT_FOUND);\n   }\n \n   @Override\n   public Optional<Institution> updateInstitution(\n       final String shortName, final Institution institutionToUpdate) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkzNzM2Ng=="}, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4ODE4MQ==", "bodyText": "Thanks! Sounds reasonable.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r382288181", "createdAt": "2020-02-20T22:14:41Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/institution/InstitutionServiceImpl.java", "diffHunk": "@@ -1,103 +1,113 @@\n package org.pmiops.workbench.institution;\n \n-import java.util.Collections;\n import java.util.List;\n import java.util.Optional;\n import java.util.stream.Collectors;\n import java.util.stream.StreamSupport;\n+import javax.mail.internet.AddressException;\n+import javax.mail.internet.InternetAddress;\n import org.pmiops.workbench.db.dao.InstitutionDao;\n+import org.pmiops.workbench.db.dao.VerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.db.model.DbInstitution;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailAddress;\n-import org.pmiops.workbench.db.model.DbInstitutionEmailDomain;\n+import org.pmiops.workbench.db.model.DbVerifiedInstitutionalAffiliation;\n import org.pmiops.workbench.model.Institution;\n import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Import;\n import org.springframework.stereotype.Service;\n \n @Service\n+@Import({InstitutionMapperImpl.class})\n public class InstitutionServiceImpl implements InstitutionService {\n \n   private final InstitutionDao institutionDao;\n+  private final InstitutionMapper institutionMapper;\n+  private final VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation;\n \n   @Autowired\n-  InstitutionServiceImpl(InstitutionDao institutionDao) {\n+  InstitutionServiceImpl(\n+      InstitutionDao institutionDao,\n+      InstitutionMapper institutionMapper,\n+      VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation) {\n     this.institutionDao = institutionDao;\n+    this.institutionMapper = institutionMapper;\n+    this.verifiedInstitutionalAffiliation = verifiedInstitutionalAffiliation;\n   }\n \n   @Override\n   public List<Institution> getInstitutions() {\n     return StreamSupport.stream(institutionDao.findAll().spliterator(), false)\n-        .map(this::toModel)\n+        .map(institutionMapper::dbToModel)\n         .collect(Collectors.toList());\n   }\n \n   @Override\n   public Optional<Institution> getInstitution(final String shortName) {\n-    return getDbInstitution(shortName).map(this::toModel);\n+    return getDbInstitution(shortName).map(institutionMapper::dbToModel);\n+  }\n+\n+  @Override\n+  public Optional<DbInstitution> getDbInstitution(final String shortName) {\n+    return institutionDao.findOneByShortName(shortName);\n   }\n \n   @Override\n   public Institution createInstitution(final Institution institutionToCreate) {\n-    return toModel(institutionDao.save(newDbObject(institutionToCreate)));\n+    return institutionMapper.dbToModel(\n+        institutionDao.save(institutionMapper.modelToDb(institutionToCreate)));\n   }\n \n   @Override\n-  public boolean deleteInstitution(final String shortName) {\n+  public DeletionResult deleteInstitution(final String shortName) {\n     return getDbInstitution(shortName)\n         .map(\n             dbInst -> {\n-              institutionDao.delete(dbInst);\n-              return true;\n+              if (verifiedInstitutionalAffiliation.findAllByInstitution(dbInst).isEmpty()) {\n+                // no verified user affiliations: safe to delete\n+                institutionDao.delete(dbInst);\n+                return DeletionResult.SUCCESS;\n+              } else {\n+                return DeletionResult.HAS_VERIFIED_AFFILIATIONS;\n+              }\n             })\n-        .orElse(false);\n+        .orElse(DeletionResult.NOT_FOUND);\n   }\n \n   @Override\n   public Optional<Institution> updateInstitution(\n       final String shortName, final Institution institutionToUpdate) {\n     return getDbInstitution(shortName)\n-        .map(dbInst -> toModel(institutionDao.save(updateDbObject(dbInst, institutionToUpdate))));\n+        .map(DbInstitution::getInstitutionId)\n+        .map(\n+            dbId -> {\n+              // create new DB object, but mark it with the original's ID to indicate that this is\n+              // an update\n+              final DbInstitution newDbObj =\n+                  institutionMapper.modelToDb(institutionToUpdate).setInstitutionId(dbId);\n+              return institutionMapper.dbToModel(institutionDao.save(newDbObj));\n+            });\n   }\n \n-  private Optional<DbInstitution> getDbInstitution(String shortName) {\n-    return institutionDao.findOneByShortName(shortName);\n-  }\n+  @Override\n+  public boolean validate(\n+      DbVerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation, String contactEmail) {\n+    if (verifiedInstitutionalAffiliation == null) {\n+      return false;\n+    }\n \n-  private DbInstitution newDbObject(final Institution modelObject) {\n-    return updateDbObject(new DbInstitution(), modelObject);\n-  }\n+    final Institution inst =\n+        institutionMapper.dbToModel(verifiedInstitutionalAffiliation.getInstitution());\n \n-  private DbInstitution updateDbObject(\n-      final DbInstitution dbObject, final Institution modelObject) {\n-    return dbObject\n-        .setShortName(modelObject.getShortName())\n-        .setDisplayName(modelObject.getDisplayName())\n-        .setOrganizationTypeEnum(modelObject.getOrganizationTypeEnum())\n-        .setOrganizationTypeOtherText(modelObject.getOrganizationTypeOtherText())\n-        .setEmailDomains(\n-            Optional.ofNullable(modelObject.getEmailDomains()).orElse(Collections.emptyList())\n-                .stream()\n-                .map(domain -> new DbInstitutionEmailDomain().setEmailDomain(domain))\n-                .collect(Collectors.toSet()))\n-        .setEmailAddresses(\n-            Optional.ofNullable(modelObject.getEmailAddresses()).orElse(Collections.emptyList())\n-                .stream()\n-                .map(address -> new DbInstitutionEmailAddress().setEmailAddress(address))\n-                .collect(Collectors.toSet()));\n-  }\n+    try {\n+      new InternetAddress(contactEmail).validate();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MDgwNQ=="}, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4ODU3MA==", "bodyText": "Thanks, makes sense. Maybe add a comment or some addition to the description pointing readers to common_api.yaml (unless that's slated for removal in the near term).", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r382288570", "createdAt": "2020-02-20T22:15:39Z", "author": {"login": "gjuggler"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -4324,3 +4329,76 @@ definitions:\n         type: \"array\"\n         items:\n           $ref: \"#/definitions/Institution\"\n+\n+  OrganizationType:\n+    type: string\n+    description: A categorization of institutions, derived from CAPS requirements\n+    enum: [ACADEMIC_RESEARCH_INSTITUTION, INDUSTRY, EDUCATIONAL_INSTITUTION, HEALTH_CENTER_NON_PROFIT, OTHER]\n+\n+  InstitutionalRole:\n+    type: string\n+    description: >\n+      The union of the roles researchers can have at Institutions of all OrganizationTypes,\n+      derived from CAPS requirements.\n+      InstitutionalRole_ARI, InstitutionalRole_IND_HCNP, and InstitutionalRole_EDU are\n+      subsets of this enum, implemented using the same short-int values.\n+    enum: [\n+      UNDERGRADUATE, TRAINEE, FELLOW, EARLY_CAREER, MID_CAREER, LATE_CAREER,\n+      PRE_DOCTORAL, POST_DOCTORAL, PI,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1MTg0MQ=="}, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjI4OTQ2MA==", "bodyText": "That makes total sense \u2013 thanks for walking me through.", "url": "https://github.com/all-of-us/workbench/pull/3139#discussion_r382289460", "createdAt": "2020-02-20T22:17:48Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/auth/ProfileServiceTest.java", "diffHunk": "@@ -35,14 +39,15 @@\n \n   @Test\n   public void testGetProfile_empty() {\n-    assertThat(profileService.getProfile(new DbUser())).isNotNull();\n+    assertThat(profileService.getProfile(userDao.save(new DbUser()))).isNotNull();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk1ODUwOA=="}, "originalCommit": {"oid": "b5381fb30a0bc4cda586a060925dca39811b3721"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3595, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}