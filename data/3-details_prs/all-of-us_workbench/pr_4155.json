{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyNzgyMDE4", "number": 4155, "title": "[risk=no][RW-5566] Add CDR Version to dataset query export comment", "bodyText": "Description:\nBefore:\n\nAfter:\n\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test-local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-10-13T20:10:46Z", "url": "https://github.com/all-of-us/workbench/pull/4155", "merged": true, "mergeCommit": {"oid": "c7bafbd7e3cd7351f40f55810a0b7d1f4003ecd9"}, "closed": true, "closedAt": "2020-10-15T21:11:19Z", "author": {"login": "jmthibault79"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSfwSGAFqTUwODUyMTUwMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS4ZvIAFqTUwOTgxMTk1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4NTIxNTAy", "url": "https://github.com/all-of-us/workbench/pull/4155#pullrequestreview-508521502", "createdAt": "2020-10-14T16:23:54Z", "commit": {"oid": "dc7d449a519aeb7ee0c0d9055fe1e507b7615840"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNjoyMzo1NFrOHhbNYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNjoyNjo0OFrOHhbUvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDgxMDg0OQ==", "bodyText": "Scope creep, but I would recommend just using a JSON blob in the comment, since it's easier for us to scan later if we need to, and we can .add fields more easily without ti becoming unwieldy to change.\nOr maybe we add an invisible .aou/queryManifest.json to the bucket and do this there.\nI'm just really uncomfortable embedding such time-sensitive information in a user-writable place.", "url": "https://github.com/all-of-us/workbench/pull/4155#discussion_r504810849", "createdAt": "2020-10-14T16:23:54Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java", "diffHunk": "@@ -908,12 +911,9 @@ private static String generateNotebookUserCode(\n     String namespace = \"dataset_\" + qualifier + \"_\" + domainAsString + \"_\";\n     // Comments in R and Python have the same syntax\n     String descriptiveComment =\n-        new StringBuilder(\"# This query represents dataset \\\"\")\n-            .append(dataSetName)\n-            .append(\"\\\" for domain \\\"\")\n-            .append(domainAsString)\n-            .append(\"\\\"\")\n-            .toString();\n+        String.format(\n+            \"# This query represents dataset \\\"%s\\\" for domain \\\"%s\\\" and was generated for %s\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc7d449a519aeb7ee0c0d9055fe1e507b7615840"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDgxMjczNA==", "bodyText": "We should also include the workspace and notebook name in the comment, as this will get copied and pasted. The email of the researcher would also be helpful in order to establish provenance.\nAs written, they'll have to contact support to find the actual source of the query, and if we only include names, it's going to be even harder (since they don't uniquely identify datasets and domain names may change from one CDR version to the next (though rarely)).", "url": "https://github.com/all-of-us/workbench/pull/4155#discussion_r504812734", "createdAt": "2020-10-14T16:26:48Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java", "diffHunk": "@@ -908,12 +911,9 @@ private static String generateNotebookUserCode(\n     String namespace = \"dataset_\" + qualifier + \"_\" + domainAsString + \"_\";\n     // Comments in R and Python have the same syntax\n     String descriptiveComment =\n-        new StringBuilder(\"# This query represents dataset \\\"\")\n-            .append(dataSetName)\n-            .append(\"\\\" for domain \\\"\")\n-            .append(domainAsString)\n-            .append(\"\\\"\")\n-            .toString();\n+        String.format(\n+            \"# This query represents dataset \\\"%s\\\" for domain \\\"%s\\\" and was generated for %s\",\n+            dataSetName, domainAsString, cdrVersionName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc7d449a519aeb7ee0c0d9055fe1e507b7615840"}, "originalPosition": 36}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc7d449a519aeb7ee0c0d9055fe1e507b7615840", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/dc7d449a519aeb7ee0c0d9055fe1e507b7615840", "committedDate": "2020-10-14T15:04:47Z", "message": "Fix DataSetControllerBQTest"}, "afterCommit": {"oid": "a63f62b57f203028258d96ac5b660609d9d8d851", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/a63f62b57f203028258d96ac5b660609d9d8d851", "committedDate": "2020-10-14T18:25:37Z", "message": "Fix DataSetControllerBQTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MzIzODYy", "url": "https://github.com/all-of-us/workbench/pull/4155#pullrequestreview-509323862", "createdAt": "2020-10-15T12:29:00Z", "commit": {"oid": "3e597a44544985e64d2a987146353cf0d67d0fcf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxMjoyOTowMFrOHiFUMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxMjoyOTowMFrOHiFUMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUwMDcyMg==", "bodyText": "Can we name this something other than \"null\"? That's confusing me.", "url": "https://github.com/all-of-us/workbench/pull/4155#discussion_r505500722", "createdAt": "2020-10-15T12:29:00Z", "author": {"login": "jaycarlton"}, "path": "api/src/bigquerytest/java/org/pmiops/workbench/api/DataSetControllerBQTest.java", "diffHunk": "@@ -374,6 +374,13 @@ public void testGenerateCodePython() {\n \n   @Test\n   public void testGenerateCodeR() {\n+    String expected =\n+        String.format(\n+            \"library(bigrquery)\\n\"\n+                + \"\\n# This query represents dataset \\\"null\\\" for domain \\\"condition\\\" and was generated for %s\\n\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e597a44544985e64d2a987146353cf0d67d0fcf"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41c48c63ec3205d905a8ea2e02db1166ab40e64e", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/41c48c63ec3205d905a8ea2e02db1166ab40e64e", "committedDate": "2020-10-15T12:45:59Z", "message": "Add CDR Version to dataset query export comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c06ac55147eaa0e2f5a4b48602f5068d9da85f9a", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/c06ac55147eaa0e2f5a4b48602f5068d9da85f9a", "committedDate": "2020-10-15T12:45:59Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e48661e4d3762767dd0fb11df4a6c65d2096d797", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/e48661e4d3762767dd0fb11df4a6c65d2096d797", "committedDate": "2020-10-15T12:45:59Z", "message": "Fix DataSetControllerBQTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21488c0e24348dbc2d282e82628e84fab958704e", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/21488c0e24348dbc2d282e82628e84fab958704e", "committedDate": "2020-10-15T12:46:00Z", "message": "string.format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "492a1eef62c22d1d04f289ab53ec3cda8951cb3a", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/492a1eef62c22d1d04f289ab53ec3cda8951cb3a", "committedDate": "2020-10-15T12:46:00Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ec942e61b56377ddd63312beca035b220e75269", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/9ec942e61b56377ddd63312beca035b220e75269", "committedDate": "2020-10-15T12:46:00Z", "message": "give the dataset a name"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e597a44544985e64d2a987146353cf0d67d0fcf", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/3e597a44544985e64d2a987146353cf0d67d0fcf", "committedDate": "2020-10-14T19:18:42Z", "message": "lint"}, "afterCommit": {"oid": "9ec942e61b56377ddd63312beca035b220e75269", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/9ec942e61b56377ddd63312beca035b220e75269", "committedDate": "2020-10-15T12:46:00Z", "message": "give the dataset a name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODExOTUw", "url": "https://github.com/all-of-us/workbench/pull/4155#pullrequestreview-509811950", "createdAt": "2020-10-15T21:10:40Z", "commit": {"oid": "9ec942e61b56377ddd63312beca035b220e75269"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3949, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}