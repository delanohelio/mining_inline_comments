{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4NzE5MzY1", "number": 2957, "title": "[RW-3932][Risk=low] Add the admin banner page", "bodyText": "Description:\nThis adds the admin page for banners. Here's a screenshot of the page:\n\nI took the opportunity to do some refactoring of state on the sidenav, because we had a bunch of profile object items separately, so I moved that into being wrapped by the profile object.\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-01-02T16:40:19Z", "url": "https://github.com/all-of-us/workbench/pull/2957", "merged": true, "mergeCommit": {"oid": "19495b34c2e603b15b8afb9d4880572a33aa0cf7"}, "closed": true, "closedAt": "2020-01-02T20:51:57Z", "author": {"login": "s-rubenstein"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2ce-igH2gAyMzU4NzE5MzY1OmM1NzU2YjFhNjA3YTk1ZmRiNTA1YjQyMmNlZTQzMDMxMDA2NDJmYzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb2f0BTgH2gAyMzU4NzE5MzY1OmNiN2VkMTA0MmYzZDFiMzZlODVjZjRkNDk1YmJkZmUxMmI5NmU4YzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c5756b1a607a95fdb505b422cee4303100642fc5", "author": {"user": {"login": "s-rubenstein", "name": "Sky Rubenstein"}}, "url": "https://github.com/all-of-us/workbench/commit/c5756b1a607a95fdb505b422cee4303100642fc5", "committedDate": "2020-01-02T16:38:01Z", "message": "Add the admin banner page"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c555d4e840f6677802132718393108e40c2e1b72", "author": {"user": {"login": "s-rubenstein", "name": "Sky Rubenstein"}}, "url": "https://github.com/all-of-us/workbench/commit/c555d4e840f6677802132718393108e40c2e1b72", "committedDate": "2020-01-02T17:25:11Z", "message": "Fix linting and add banner active"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e438e30a575f1df783e442f6fa7a54092658fb7", "author": {"user": {"login": "s-rubenstein", "name": "Sky Rubenstein"}}, "url": "https://github.com/all-of-us/workbench/commit/4e438e30a575f1df783e442f6fa7a54092658fb7", "committedDate": "2020-01-02T17:34:16Z", "message": "Fix UI linting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02d671bd274f41800e37c3aab236c01c19e8d8b5", "author": {"user": {"login": "s-rubenstein", "name": "Sky Rubenstein"}}, "url": "https://github.com/all-of-us/workbench/commit/02d671bd274f41800e37c3aab236c01c19e8d8b5", "committedDate": "2020-01-02T18:19:58Z", "message": "Add validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4304973a668f0ab019832763126cb9f239069907", "author": {"user": {"login": "s-rubenstein", "name": "Sky Rubenstein"}}, "url": "https://github.com/all-of-us/workbench/commit/4304973a668f0ab019832763126cb9f239069907", "committedDate": "2020-01-02T19:39:57Z", "message": "Add API tests for status alert controllers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8482d90c1555eb6acde43c2f0a38744e9dda781", "author": {"user": {"login": "s-rubenstein", "name": "Sky Rubenstein"}}, "url": "https://github.com/all-of-us/workbench/commit/e8482d90c1555eb6acde43c2f0a38744e9dda781", "committedDate": "2020-01-02T19:40:34Z", "message": "Fix linting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5a906967ed8cb6442da40f2d7746a425b1bc2ad", "author": {"user": {"login": "s-rubenstein", "name": "Sky Rubenstein"}}, "url": "https://github.com/all-of-us/workbench/commit/d5a906967ed8cb6442da40f2d7746a425b1bc2ad", "committedDate": "2020-01-02T20:10:45Z", "message": "Fix linting again"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM3ODI1NTE4", "url": "https://github.com/all-of-us/workbench/pull/2957#pullrequestreview-337825518", "createdAt": "2020-01-02T19:45:58Z", "commit": {"oid": "4304973a668f0ab019832763126cb9f239069907"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMlQxOTo0NTo1OFrOFZznbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wMlQyMDoxNzo1OFrOFZ0QXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYwNDM5Nw==", "bodyText": "I assume the things removed and not replaced were duplicative with the things in profile? And I don't suppose anyone remembers why they were pulled out...", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362604397", "createdAt": "2020-01-02T19:45:58Z", "author": {"login": "als364"}, "path": "ui/src/app/components/side-nav.tsx", "diffHunk": "@@ -197,36 +198,35 @@ class SideNavItem extends React.Component<SideNavItemProps, SideNavItemState> {\n }\n \n export interface SideNavProps {\n+  profile: Profile;\n+  bannerAdminActive: boolean;\n   homeActive: boolean;\n-  workspacesActive: boolean;\n   libraryActive: boolean;\n+  onToggleSideNav: Function;\n   profileActive: boolean;\n   userAdminActive: boolean;\n-  hasDataAccess: boolean;\n-  hasAccessModuleAdmin: boolean;\n-  aouAccountEmailAddress: string;\n-  contactEmailAddress: string;\n-  givenName: string;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4304973a668f0ab019832763126cb9f239069907"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYwNTEwNA==", "bodyText": "nice!", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362605104", "createdAt": "2020-01-02T19:47:54Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/admin/admin-banner.tsx", "diffHunk": "@@ -0,0 +1,133 @@\n+import {Component} from '@angular/core';\n+import {BoldHeader, Header} from 'app/components/headers';\n+import {TextArea, TextInput} from 'app/components/inputs';\n+import {statusAlertApi} from 'app/services/swagger-fetch-clients';\n+import colors from 'app/styles/colors';\n+import {ReactWrapperBase} from 'app/utils';\n+import * as React from 'react';\n+import ReactSwitch from 'react-switch';\n+import * as validate from 'validate.js';\n+import {TooltipTrigger} from \"../../components/popups\";\n+\n+const styles = {\n+  smallHeaderStyles: {\n+    fontSize: 14,\n+    fontWeight: 600\n+  }\n+};\n+\n+\n+interface AdminBannerState {\n+  bannerDescription: string;\n+  bannerEnabled: boolean;\n+  bannerHeadline: string;\n+  readMoreLink: string;\n+}\n+const required = {presence: {allowEmpty: false}};\n+const notTooLong = maxLength => ({", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4304973a668f0ab019832763126cb9f239069907"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYwNzg4MQ==", "bodyText": "Is the linter enforcing this formatting? I'd rather see something like\n    {\n        bannerDescription,\n        bannerHeadline,\n        readMoreLink\n    },\n    validators,\n    {\n        [...]\n    }\n)```", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362607881", "createdAt": "2020-01-02T19:55:52Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/admin/admin-banner.tsx", "diffHunk": "@@ -0,0 +1,133 @@\n+import {Component} from '@angular/core';\n+import {BoldHeader, Header} from 'app/components/headers';\n+import {TextArea, TextInput} from 'app/components/inputs';\n+import {statusAlertApi} from 'app/services/swagger-fetch-clients';\n+import colors from 'app/styles/colors';\n+import {ReactWrapperBase} from 'app/utils';\n+import * as React from 'react';\n+import ReactSwitch from 'react-switch';\n+import * as validate from 'validate.js';\n+import {TooltipTrigger} from \"../../components/popups\";\n+\n+const styles = {\n+  smallHeaderStyles: {\n+    fontSize: 14,\n+    fontWeight: 600\n+  }\n+};\n+\n+\n+interface AdminBannerState {\n+  bannerDescription: string;\n+  bannerEnabled: boolean;\n+  bannerHeadline: string;\n+  readMoreLink: string;\n+}\n+const required = {presence: {allowEmpty: false}};\n+const notTooLong = maxLength => ({\n+  length: {\n+    maximum: maxLength,\n+    tooLong: 'must be %{count} characters or less'\n+  }\n+});\n+const validators = {\n+  bannerDescription: {...required, ...notTooLong(4000)},\n+  bannerHeadline: {...required, ...notTooLong(200)},\n+  readMoreLink: {...notTooLong(200)},\n+};\n+export class AdminBanner extends React.Component<{}, AdminBannerState> {\n+  constructor(props) {\n+    super(props);\n+    this.state = {\n+      bannerDescription: '',\n+      bannerEnabled: false,\n+      bannerHeadline: '',\n+      readMoreLink: ''\n+    };\n+  }\n+\n+  componentDidMount(): void {\n+    statusAlertApi().getStatusAlert()\n+      .then(statusAlert => this.setState({\n+        bannerDescription: statusAlert.message,\n+        bannerEnabled: statusAlert.title !== null && statusAlert.title !== '',\n+        bannerHeadline: statusAlert.title,\n+        readMoreLink: statusAlert.link\n+      }));\n+  }\n+\n+  handleBannerToggle(checked: boolean) {\n+    this.setState({bannerEnabled: !this.state.bannerEnabled});\n+    if (checked) {\n+      statusAlertApi().postStatusAlert({\n+        title: this.state.bannerHeadline,\n+        message: this.state.bannerDescription,\n+        link: this.state.readMoreLink\n+      });\n+    } else {\n+      statusAlertApi().postStatusAlert({\n+        title: '',\n+        message: '',\n+        link: ''\n+      });\n+      this.setState({\n+        bannerDescription: '',\n+        bannerHeadline: '',\n+        readMoreLink: ''\n+      });\n+    }\n+  }\n+\n+  render() {\n+    const {bannerDescription, bannerEnabled, bannerHeadline, readMoreLink} = this.state;\n+    const errors = validate({", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4304973a668f0ab019832763126cb9f239069907"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNDU5Ng==", "bodyText": "What does this multiple-as-in-a-row do?", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362614596", "createdAt": "2020-01-02T20:16:58Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/signed-in/component.ts", "diffHunk": "@@ -84,21 +74,12 @@ export class SignedInComponent implements OnInit, OnDestroy, AfterViewInit {\n   ngOnInit(): void {\n     this.serverConfigService.getConfig().subscribe((config) => {\n       this.profileLoadingSub = this.profileStorageService.profile$.subscribe((profile) => {\n-        this.hasDataAccess = hasRegisteredAccess(profile.dataAccessLevel);\n-        if (this.hasDataAccess) {\n+        this.profile = profile as unknown as FetchProfile;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4304973a668f0ab019832763126cb9f239069907"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjYxNDg3OA==", "bodyText": "I know you didn't name this in this PR but this function name is confusing and I'm wondering if there's a better name for it", "url": "https://github.com/all-of-us/workbench/pull/2957#discussion_r362614878", "createdAt": "2020-01-02T20:17:58Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/signed-in/component.ts", "diffHunk": "@@ -84,21 +74,12 @@ export class SignedInComponent implements OnInit, OnDestroy, AfterViewInit {\n   ngOnInit(): void {\n     this.serverConfigService.getConfig().subscribe((config) => {\n       this.profileLoadingSub = this.profileStorageService.profile$.subscribe((profile) => {\n-        this.hasDataAccess = hasRegisteredAccess(profile.dataAccessLevel);\n-        if (this.hasDataAccess) {\n+        this.profile = profile as unknown as FetchProfile;\n+        if (hasRegisteredAccessFetch(this.profile.dataAccessLevel)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4304973a668f0ab019832763126cb9f239069907"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb7ed1042f3d1b36e85cf4d495bbdfe12b96e8c3", "author": {"user": {"login": "s-rubenstein", "name": "Sky Rubenstein"}}, "url": "https://github.com/all-of-us/workbench/commit/cb7ed1042f3d1b36e85cf4d495bbdfe12b96e8c3", "committedDate": "2020-01-02T20:30:43Z", "message": "PR feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3803, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}