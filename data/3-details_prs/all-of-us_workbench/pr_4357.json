{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyODkzMzUz", "number": 4357, "title": "[no ticket][risk=no] Puppeteer: Flaky tests fixes", "bodyText": "Puppeteer tests have started to fail often in CircleCI recently. Fixes in this PR should stabilize tests again.\nImplement workarounds for two open issues that made tests flaky:\n1: https://precisionmedicineinitiative.atlassian.net/browse/RW-6002\n2: https://precisionmedicineinitiative.atlassian.net/browse/RW-6005\nIncreased timeout for wait-for functions.", "createdAt": "2020-12-05T04:04:02Z", "url": "https://github.com/all-of-us/workbench/pull/4357", "merged": true, "mergeCommit": {"oid": "26697c11d1aee65854ea76efc2b04f1205f0ffab"}, "closed": true, "closedAt": "2020-12-07T23:49:57Z", "author": {"login": "aweng98"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjlvpfgFqTU0NTczNzI2NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj9b_ZAFqTU0NjU5ODI2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NzM3MjY1", "url": "https://github.com/all-of-us/workbench/pull/4357#pullrequestreview-545737265", "createdAt": "2020-12-06T18:57:07Z", "commit": {"oid": "1392d8863e2d7772fa5ff06683fa373bdbe50d0a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQxODo1NzowN1rOIAOERQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNlQxODo1OToyN1rOIAOFuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEwMTM4MQ==", "bodyText": "refactored isLoaded function for RW-6005 workaround.", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537101381", "createdAt": "2020-12-06T18:57:07Z", "author": {"login": "aweng98"}, "path": "e2e/app/page/home-page.ts", "diffHunk": "@@ -20,24 +20,25 @@ export default class HomePage extends AuthenticatedPage {\n   }\n \n   async isLoaded(): Promise<boolean> {\n-    await Promise.all([\n-      waitForDocumentTitle(this.page, PageTitle),\n-      waitWhileLoading(this.page)\n+    await waitForDocumentTitle(this.page, PageTitle);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1392d8863e2d7772fa5ff06683fa373bdbe50d0a"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEwMTU0Nw==", "bodyText": "waitForKernelIdle already is in waitForLoad", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537101547", "createdAt": "2020-12-06T18:58:05Z", "author": {"login": "aweng98"}, "path": "e2e/app/page/notebook-preview-page.ts", "diffHunk": "@@ -37,7 +37,6 @@ export default class NotebookPreviewPage extends AuthenticatedPage {\n \n     const notebookPage = new NotebookPage(this.page, notebookName);\n     await notebookPage.waitForLoad();\n-    await notebookPage.waitForKernelIdle();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1392d8863e2d7772fa5ff06683fa373bdbe50d0a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzEwMTc1NQ==", "bodyText": "Fix signInAs function to remove unused page parameter", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537101755", "createdAt": "2020-12-06T18:59:27Z", "author": {"login": "aweng98"}, "path": "e2e/utils/test-utils.ts", "diffHunk": "@@ -27,17 +27,15 @@ export async function signIn(page: Page, userId?: string, passwd?: string): Prom\n \n /**\n  * Login in new Incognito page.\n- * @param page\n  * @param {string} userId\n  * @param {string} passwd\n  */\n-// @ts-ignore\n-export async function signInAs(page: Page, userId: string, passwd: string, opts: {reset?: boolean} = {}): Promise<Page> {\n+export async function signInAs(userId: string, passwd: string, opts: {reset?: boolean} = {}): Promise<Page> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1392d8863e2d7772fa5ff06683fa373bdbe50d0a"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MjkxNzgx", "url": "https://github.com/all-of-us/workbench/pull/4357#pullrequestreview-546291781", "createdAt": "2020-12-07T16:01:41Z", "commit": {"oid": "ff49f854f70a0908624eec2723270f35368e38ce"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNjowMTo0MlrOIAt5dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNjowNzo1N1rOIAuNZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMjkwMA==", "bodyText": "nit: I don't think O needs to be uppercased.\nAlso, I would add the time unit suffix so it's clear if this is milliseconds, seconds, nanoseconds, etc.", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537622900", "createdAt": "2020-12-07T16:01:42Z", "author": {"login": "ericsong"}, "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -237,6 +243,11 @@ export default class NotebookPage extends AuthenticatedPage {\n     return frame.contentFrame();\n   }\n \n+  private async findRunButton(timeOut?: number): Promise<ElementHandle> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff49f854f70a0908624eec2723270f35368e38ce"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMzc3Mw==", "bodyText": "nit: Reload*ing* seems a little more accurate since it's going to execute the action itself (and it's not asking the user to do so).", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537623773", "createdAt": "2020-12-07T16:02:47Z", "author": {"login": "ericsong"}, "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -45,7 +45,13 @@ export default class NotebookPage extends AuthenticatedPage {\n \n   async isLoaded(): Promise<boolean> {\n     await waitForDocumentTitle(this.page, this.documentTitle);\n-    await this.waitForKernelIdle(30000);\n+    try {\n+      await this.findRunButton(120000);\n+    } catch (err) {\n+      console.log(`Reload \"${this.documentTitle}\" because cannot find the Run button`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff49f854f70a0908624eec2723270f35368e38ce"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyNTM3OA==", "bodyText": "does this need to be changed to let?", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537625378", "createdAt": "2020-12-07T16:04:49Z", "author": {"login": "ericsong"}, "path": "e2e/tests/notebook/reader-copy-to-workspace.spec.ts", "diffHunk": "@@ -33,7 +34,7 @@ describe('Workspace reader Jupyter notebook action tests', () => {\n   test('Workspace reader copy notebook to another workspace', async () => {\n     const workspaceName = await createWorkspace(page).then(card => card.clickWorkspaceName());\n \n-    const dataPage = new WorkspaceDataPage(page);\n+    let dataPage = new WorkspaceDataPage(page);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff49f854f70a0908624eec2723270f35368e38ce"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyODAwNw==", "bodyText": "should we just create/find a workspace in a beforeAll function? I'm not sure if its always the case that tests will run in sequence, especially if we add parallelization.", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537628007", "createdAt": "2020-12-07T16:07:57Z", "author": {"login": "ericsong"}, "path": "e2e/tests/workspace/workspace-edit.spec.ts", "diffHunk": "@@ -11,6 +11,10 @@ describe('Editing workspace via workspace card snowman menu', () => {\n     await signIn(page);\n   });\n \n+  // Reuse same Workspace for all tests in this file to reduce test playback time.\n+  // Workspace to be created in first test. If first test fails, next test will create it.\n+  let workspaceName: string;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bf63c920175bb17fd5ff3baa7a8b4c35c3634b1"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MzcxMzEz", "url": "https://github.com/all-of-us/workbench/pull/4357#pullrequestreview-546371313", "createdAt": "2020-12-07T17:27:01Z", "commit": {"oid": "067a8c07faa677ef753d793d4492f8cc065089c2"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzoyNzowMVrOIAx7RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzozMjowNVrOIAyJXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY4ODkwMA==", "bodyText": "right, done!", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537688900", "createdAt": "2020-12-07T17:27:01Z", "author": {"login": "aweng98"}, "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -45,7 +45,13 @@ export default class NotebookPage extends AuthenticatedPage {\n \n   async isLoaded(): Promise<boolean> {\n     await waitForDocumentTitle(this.page, this.documentTitle);\n-    await this.waitForKernelIdle(30000);\n+    try {\n+      await this.findRunButton(120000);\n+    } catch (err) {\n+      console.log(`Reload \"${this.documentTitle}\" because cannot find the Run button`);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMzc3Mw=="}, "originalCommit": {"oid": "ff49f854f70a0908624eec2723270f35368e38ce"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5MTA5MQ==", "bodyText": "parameter timeout is in a lot of functions. to keep it consistent, I'll make a separate PR to append the suffix.", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537691091", "createdAt": "2020-12-07T17:30:03Z", "author": {"login": "aweng98"}, "path": "e2e/app/page/notebook-page.ts", "diffHunk": "@@ -237,6 +243,11 @@ export default class NotebookPage extends AuthenticatedPage {\n     return frame.contentFrame();\n   }\n \n+  private async findRunButton(timeOut?: number): Promise<ElementHandle> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyMjkwMA=="}, "originalCommit": {"oid": "ff49f854f70a0908624eec2723270f35368e38ce"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5MjExMA==", "bodyText": "it is initiated twice. at line 55.", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537692110", "createdAt": "2020-12-07T17:31:30Z", "author": {"login": "aweng98"}, "path": "e2e/tests/notebook/reader-copy-to-workspace.spec.ts", "diffHunk": "@@ -33,7 +34,7 @@ describe('Workspace reader Jupyter notebook action tests', () => {\n   test('Workspace reader copy notebook to another workspace', async () => {\n     const workspaceName = await createWorkspace(page).then(card => card.clickWorkspaceName());\n \n-    const dataPage = new WorkspaceDataPage(page);\n+    let dataPage = new WorkspaceDataPage(page);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyNTM3OA=="}, "originalCommit": {"oid": "ff49f854f70a0908624eec2723270f35368e38ce"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzY5MjUwOQ==", "bodyText": "In Jest, tests in same file will always run. in serial order.", "url": "https://github.com/all-of-us/workbench/pull/4357#discussion_r537692509", "createdAt": "2020-12-07T17:32:05Z", "author": {"login": "aweng98"}, "path": "e2e/tests/workspace/workspace-edit.spec.ts", "diffHunk": "@@ -11,6 +11,10 @@ describe('Editing workspace via workspace card snowman menu', () => {\n     await signIn(page);\n   });\n \n+  // Reuse same Workspace for all tests in this file to reduce test playback time.\n+  // Workspace to be created in first test. If first test fails, next test will create it.\n+  let workspaceName: string;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYyODAwNw=="}, "originalCommit": {"oid": "6bf63c920175bb17fd5ff3baa7a8b4c35c3634b1"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d141b88aed1f1ef5bab5f19770ca0cc86e7049eb", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/d141b88aed1f1ef5bab5f19770ca0cc86e7049eb", "committedDate": "2020-12-07T17:32:40Z", "message": "address PR feedback"}, "afterCommit": {"oid": "2689d914c66e4b26ae338966785fc093940237c1", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/2689d914c66e4b26ae338966785fc093940237c1", "committedDate": "2020-12-07T17:42:44Z", "message": "fix flaky tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4dcf1b7639d0e7f69fa108575e3fd9b389b8940", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/e4dcf1b7639d0e7f69fa108575e3fd9b389b8940", "committedDate": "2020-12-07T17:46:50Z", "message": "fix flaky tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ad3eec98855a4cb91f0f8fecd01c8624db655df", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/4ad3eec98855a4cb91f0f8fecd01c8624db655df", "committedDate": "2020-12-07T17:47:34Z", "message": "rebase master"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2689d914c66e4b26ae338966785fc093940237c1", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/2689d914c66e4b26ae338966785fc093940237c1", "committedDate": "2020-12-07T17:42:44Z", "message": "fix flaky tests"}, "afterCommit": {"oid": "4ad3eec98855a4cb91f0f8fecd01c8624db655df", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/4ad3eec98855a4cb91f0f8fecd01c8624db655df", "committedDate": "2020-12-07T17:47:34Z", "message": "rebase master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f35bf4c6def48773da0b0330ab387e11f7c9194f", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/f35bf4c6def48773da0b0330ab387e11f7c9194f", "committedDate": "2020-12-07T17:53:24Z", "message": "timeOut parameter renamed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NTk4MjY1", "url": "https://github.com/all-of-us/workbench/pull/4357#pullrequestreview-546598265", "createdAt": "2020-12-07T22:39:22Z", "commit": {"oid": "f35bf4c6def48773da0b0330ab387e11f7c9194f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3708, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}