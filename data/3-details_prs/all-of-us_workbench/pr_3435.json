{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1Mzc0MTk1", "number": 3435, "title": "[no ticket][risk=no] CircleCI Names and anchors for common steps", "bodyText": "New CircleCI UI makes heavy use of the optional name attribute on job steps. I've added more, and tweaked a few existing ones for clarity. I condensed a couple of common steps into YAML anchors. There is support for more first-class reuse with parameterization in v2.1. This ticket  covers taking advantage of the new features and migrating to 2.1.\nCheck CircleCI run for new titles.\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-04-17T22:56:25Z", "url": "https://github.com/all-of-us/workbench/pull/3435", "merged": true, "mergeCommit": {"oid": "f491c78962ee45a42ec2104fcba67eb3dd81bcd8"}, "closed": true, "closedAt": "2020-04-20T19:47:14Z", "author": {"login": "jaycarlton"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYpgexgFqTM5NTgxNzEwMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZh_1lgFqTM5NjYzNTEyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1ODE3MTAy", "url": "https://github.com/all-of-us/workbench/pull/3435#pullrequestreview-395817102", "createdAt": "2020-04-17T22:59:37Z", "commit": {"oid": "2e3cd9e3f74b17d61fba4818ec96bfd5ded2afb7"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMjo1OTozN1rOGHfXkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QyMzowMToxOVrOGHfZIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzE1NA==", "bodyText": "This comment is probably what originally lead to confusion here. This is talking about a very specific issue the original implementer probably hit, to explain why an extra parameter is needed below, but does little to explain what this check is actually doing.\nI'd just delete this comment and update the name to match your variable \"Ensure branch has API source changes\"", "url": "https://github.com/all-of-us/workbench/pull/3435#discussion_r410507154", "createdAt": "2020-04-17T22:59:37Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -1,35 +1,39 @@\n version: 2\n \n-defaults: &defaults\n-  docker:\n-    - image: allofustest/workbench:buildimage-0.0.16\n-  working_directory: ~/workbench\n-java_defaults: &java_defaults\n-  <<: *defaults\n-  environment:\n-    # As best I can tell (dmohs, 7 Feb '17), this is the only way to set a memory limit that Java\n-    # processes executed within CircleCI's docker containers will respect. Very helpful resource:\n-    # https://circleci.com/blog/how-to-handle-java-oom-errors/\n-    #\n-    # In Feb 2017, this was set to 3G. But in Feb 2019 (RW-2194) we started seeing OOM errors,\n-    # so we bumped this down further to 2G.\n-    JAVA_TOOL_OPTIONS: -Xmx2g\n-    TERM: dumb\n-\n+anchors:\n+  defaults: &defaults\n+    docker:\n+      - image: allofustest/workbench:buildimage-0.0.16\n+    working_directory: ~/workbench\n+  ensure_branch_has_api_changes: &ensure_branch_has_api_changes\n+    name: Ensure Branch is on Origin\n+    #Circle is bad about setting up your remotes for you, you must use origin/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e3cd9e3f74b17d61fba4818ec96bfd5ded2afb7"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzQ1Nw==", "bodyText": "was this backtick intentional?", "url": "https://github.com/all-of-us/workbench/pull/3435#discussion_r410507457", "createdAt": "2020-04-17T23:00:55Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -154,25 +155,15 @@ jobs:\n     <<: *java_defaults\n     steps:\n       - checkout\n-      - run:\n-          name: Fetch Submodules\n-          command: git submodule update --init --recursive\n-      - run:\n-          #Circle is bad about setting up your remotes for you, you must use origin/\n-          command: |\n-            if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} != \"master\" ] && [ $(git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep api/ | wc -l | xargs) == 0 ]; then\n-              echo No relevant changes on non-master branch, skipping\n-              circleci step halt\n-            fi\n+      - run: *update_git_submodules\n+      - run: *ensure_branch_has_api_changes\n       - restore_cache:\n           keys:\n           - api-integration-cache-{{ checksum \"~/workbench/api/build.gradle\" }}\n-          - api-integration-cache-\n-      - run:\n-          working_directory: ~/workbench\n-          # Used to call gsutil from the circle environment.\n-          command: ci/activate_creds.sh api/circle-sa-key.json\n+          - api-integration-cache-`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e3cd9e3f74b17d61fba4818ec96bfd5ded2afb7"}, "originalPosition": 159}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUwNzU1Mg==", "bodyText": "anchor?", "url": "https://github.com/all-of-us/workbench/pull/3435#discussion_r410507552", "createdAt": "2020-04-17T23:01:19Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -295,21 +275,22 @@ jobs:\n     steps:\n       - checkout\n       - run:\n-          name: Fetch Submodules\n+          name: Update Git Submodules", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e3cd9e3f74b17d61fba4818ec96bfd5ded2afb7"}, "originalPosition": 267}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a315ed19efcda37d6b67b893022e78e675173c00", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/a315ed19efcda37d6b67b893022e78e675173c00", "committedDate": "2020-04-19T19:44:21Z", "message": "add names to steps for Circle UI labels"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d32c71963757c3000053c463117d70c69c5feb3", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/1d32c71963757c3000053c463117d70c69c5feb3", "committedDate": "2020-04-19T19:44:21Z", "message": "sp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2f6271620ba7f87acf6192786b726346832f3d4", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/c2f6271620ba7f87acf6192786b726346832f3d4", "committedDate": "2020-04-19T19:44:21Z", "message": "moar anchors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77ee27db6adedbfd359cc36e6cd675165807795c", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/77ee27db6adedbfd359cc36e6cd675165807795c", "committedDate": "2020-04-19T19:44:21Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa45efe83f6ee909c0a479d78527fd59ad4ece24", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/aa45efe83f6ee909c0a479d78527fd59ad4ece24", "committedDate": "2020-04-19T19:44:21Z", "message": "better title"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adea528bf32a28b38da46f4347a06a1be1d55ebb", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/adea528bf32a28b38da46f4347a06a1be1d55ebb", "committedDate": "2020-04-19T19:47:28Z", "message": "review fixes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f38b237c9f4f9a4182f3351d94393dabc748ec4", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/2f38b237c9f4f9a4182f3351d94393dabc748ec4", "committedDate": "2020-04-17T23:02:01Z", "message": "better title"}, "afterCommit": {"oid": "adea528bf32a28b38da46f4347a06a1be1d55ebb", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/adea528bf32a28b38da46f4347a06a1be1d55ebb", "committedDate": "2020-04-19T19:47:28Z", "message": "review fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjM1MTI2", "url": "https://github.com/all-of-us/workbench/pull/3435#pullrequestreview-396635126", "createdAt": "2020-04-20T16:50:47Z", "commit": {"oid": "adea528bf32a28b38da46f4347a06a1be1d55ebb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3207, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}