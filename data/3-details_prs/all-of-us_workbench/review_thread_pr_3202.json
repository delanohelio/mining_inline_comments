{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNTE4ODQw", "number": 3202, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODoyNjozM1rODj6MYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODozNDo0NlrODj6VqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTgwMTk0OnYy", "diffSide": "RIGHT", "path": "api/db-cdr/generate-cdr/generate-cb-criteria-tables.sh", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODoyNjozM1rOFv-iNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODoyNjozM1rOFv-iNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg1MTk1OA==", "bodyText": "Updated the max results. We probably need to look at purging some dataset in the near future and how to automate it.", "url": "https://github.com/all-of-us/workbench/pull/3202#discussion_r385851958", "createdAt": "2020-02-28T18:26:33Z", "author": {"login": "freemabd"}, "path": "api/db-cdr/generate-cdr/generate-cb-criteria-tables.sh", "diffHunk": "@@ -39,7 +39,7 @@ then\n fi\n \n # Check that bq_project exists and exit if not\n-datasets=$(bq --project=$BQ_PROJECT ls --max_results=150)\n+datasets=$(bq --project=$BQ_PROJECT ls --max_results=1000)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c4fdcdd14f6cc1d1d0b77600f02858fc46cb67b"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTgwNTIxOnYy", "diffSide": "RIGHT", "path": "api/db-cdr/generate-cdr/make-bq-denormalized-search.sh", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODoyNzo0MVrOFv-kKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODoyNzo0MVrOFv-kKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg1MjQ1Ng==", "bodyText": "Not sure what happened but this was removed and shouldn't have been.", "url": "https://github.com/all-of-us/workbench/pull/3202#discussion_r385852456", "createdAt": "2020-02-28T18:27:41Z", "author": {"login": "freemabd"}, "path": "api/db-cdr/generate-cdr/make-bq-denormalized-search.sh", "diffHunk": "@@ -25,22 +25,47 @@ fi\n # Create bq tables we have json schema for\n schema_path=generate-cdr/bq-schemas\n \n+bq --project=$BQ_PROJECT rm -f $BQ_DATASET.cb_search_person\n+bq --quiet --project=$BQ_PROJECT mk --schema=$schema_path/cb_search_person.json --time_partitioning_type=DAY --clustering_fields person_id $BQ_DATASET.cb_search_person\n+\n+bq --project=$BQ_PROJECT rm -f $BQ_DATASET.cb_search_all_events\n+bq --quiet --project=$BQ_PROJECT mk --schema=$schema_path/cb_search_all_events.json --time_partitioning_type=DAY --clustering_fields concept_id $BQ_DATASET.cb_search_all_events\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c4fdcdd14f6cc1d1d0b77600f02858fc46cb67b"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTgwNzczOnYy", "diffSide": "RIGHT", "path": "api/db-cdr/generate-cdr/make-bq-denormalized-search.sh", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODoyODozM1rOFv-lvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODoyODozM1rOFv-lvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg1Mjg2Mg==", "bodyText": "Synth dataset doesn't have sex at birth, so we just populate that column with gender to compensate.", "url": "https://github.com/all-of-us/workbench/pull/3202#discussion_r385852862", "createdAt": "2020-02-28T18:28:33Z", "author": {"login": "freemabd"}, "path": "api/db-cdr/generate-cdr/make-bq-denormalized-search.sh", "diffHunk": "@@ -25,22 +25,47 @@ fi\n # Create bq tables we have json schema for\n schema_path=generate-cdr/bq-schemas\n \n+bq --project=$BQ_PROJECT rm -f $BQ_DATASET.cb_search_person\n+bq --quiet --project=$BQ_PROJECT mk --schema=$schema_path/cb_search_person.json --time_partitioning_type=DAY --clustering_fields person_id $BQ_DATASET.cb_search_person\n+\n+bq --project=$BQ_PROJECT rm -f $BQ_DATASET.cb_search_all_events\n+bq --quiet --project=$BQ_PROJECT mk --schema=$schema_path/cb_search_all_events.json --time_partitioning_type=DAY --clustering_fields concept_id $BQ_DATASET.cb_search_all_events\n+\n ################################################\n # insert person data into cb_search_person\n ################################################\n echo \"Inserting person data into cb_search_person\"\n-bq --quiet --project=$BQ_PROJECT query --nouse_legacy_sql \\\n-\"INSERT INTO \\`$BQ_PROJECT.$BQ_DATASET.cb_search_person\\`\n-    (person_id, gender, race, ethnicity, dob)\n-SELECT p.person_id,\n+if [ \"$BQ_PROJECT:$BQ_DATASET\" == \"all-of-us-ehr-dev:synthetic_cdr20180606\" ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c4fdcdd14f6cc1d1d0b77600f02858fc46cb67b"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTgxMTMzOnYy", "diffSide": "RIGHT", "path": "api/db-cdr/generate-cdr/make-bq-denormalized-search.sh", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODoyOTo0NlrOFv-oGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODoyOTo0NlrOFv-oGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg1MzQ2Ng==", "bodyText": "Again Synth dataset doesn't have any of the OMOP *_ext tables. This is how we determine if data is EHR or not", "url": "https://github.com/all-of-us/workbench/pull/3202#discussion_r385853466", "createdAt": "2020-02-28T18:29:46Z", "author": {"login": "freemabd"}, "path": "api/db-cdr/generate-cdr/make-bq-denormalized-search.sh", "diffHunk": "@@ -158,53 +183,102 @@ WHERE x.person_id = y.person_id\"\n # set has EHR data flag\n ################################################\n echo \"set has EHR data flag in cb_search_person\"\n-bq --quiet --project=$BQ_PROJECT query --nouse_legacy_sql \\\n-\"UPDATE \\`$BQ_PROJECT.$BQ_DATASET.cb_search_person\\` x\n-SET x.has_ehr_data = y.has_data\n-FROM\n-    (\n-        SELECT a.person_id, CASE WHEN b.person_id is not null THEN 1 ELSE 0 END AS has_data\n-        FROM \\`$BQ_PROJECT.$BQ_DATASET.person\\` a\n-        LEFT JOIN\n-            (\n-                SELECT DISTINCT person_id\n-                FROM \\`$BQ_PROJECT.$BQ_DATASET.measurement\\` as a\n-                LEFT JOIN \\`$BQ_PROJECT.$BQ_DATASET.measurement_ext\\` as b on a.measurement_id = b.measurement_id\n-                WHERE lower(b.src_id) like 'ehr site%'\n-                UNION DISTINCT\n-                SELECT DISTINCT person_id\n-                FROM \\`$BQ_PROJECT.$BQ_DATASET.condition_occurrence\\` as a\n-                LEFT JOIN \\`$BQ_PROJECT.$BQ_DATASET.condition_occurrence_ext\\` as b on a.condition_occurrence_id = b.condition_occurrence_id\n-                WHERE lower(b.src_id) like 'ehr site%'\n-                UNION DISTINCT\n-                SELECT DISTINCT person_id\n-                FROM \\`$BQ_PROJECT.$BQ_DATASET.device_exposure\\` as a\n-                LEFT JOIN \\`$BQ_PROJECT.$BQ_DATASET.device_exposure_ext\\` as b on a.device_exposure_id = b.device_exposure_id\n-                WHERE lower(b.src_id) like 'ehr site%'\n-                UNION DISTINCT\n-                SELECT DISTINCT person_id\n-                FROM \\`$BQ_PROJECT.$BQ_DATASET.drug_exposure\\` as a\n-                LEFT JOIN \\`$BQ_PROJECT.$BQ_DATASET.drug_exposure_ext\\` as b on a.drug_exposure_id = b.drug_exposure_id\n-                WHERE lower(b.src_id) like 'ehr site%'\n-                UNION DISTINCT\n-                SELECT DISTINCT person_id\n-                FROM \\`$BQ_PROJECT.$BQ_DATASET.observation\\` as a\n-                LEFT JOIN \\`$BQ_PROJECT.$BQ_DATASET.observation_ext\\` as b on a.observation_id = b.observation_id\n-                WHERE lower(b.src_id) like 'ehr site%'\n-                UNION DISTINCT\n-                SELECT DISTINCT person_id\n-                FROM \\`$BQ_PROJECT.$BQ_DATASET.procedure_occurrence\\` as a\n-                LEFT JOIN \\`$BQ_PROJECT.$BQ_DATASET.procedure_occurrence_ext\\` as b on a.procedure_occurrence_id = b.procedure_occurrence_id\n-                WHERE lower(b.src_id) like 'ehr site%'\n-                UNION DISTINCT\n-                SELECT DISTINCT person_id\n-                FROM \\`$BQ_PROJECT.$BQ_DATASET.visit_occurrence\\` as a\n-                LEFT JOIN \\`$BQ_PROJECT.$BQ_DATASET.visit_occurrence_ext\\` as b on a.visit_occurrence_id = b.visit_occurrence_id\n-                WHERE lower(b.src_id) like 'ehr site%'\n-            ) b on a.person_id = b.person_id\n-    ) y\n-WHERE x.person_id = y.person_id\"\n-\n+if [ \"$BQ_PROJECT:$BQ_DATASET\" == \"all-of-us-ehr-dev:synthetic_cdr20180606\" ]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c4fdcdd14f6cc1d1d0b77600f02858fc46cb67b"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTgxMjgyOnYy", "diffSide": "RIGHT", "path": "api/src/bigquerytest/java/org/pmiops/workbench/api/CohortBuilderControllerBQTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODozMDoyNFrOFv-pHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODozMDoyNFrOFv-pHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg1MzcyNQ==", "bodyText": "Updated this property to name, which will hold gender or sex at birth.", "url": "https://github.com/all-of-us/workbench/pull/3202#discussion_r385853725", "createdAt": "2020-02-28T18:30:24Z", "author": {"login": "freemabd"}, "path": "api/src/bigquerytest/java/org/pmiops/workbench/api/CohortBuilderControllerBQTest.java", "diffHunk": "@@ -1923,13 +1925,67 @@ public void getDemoChartInfo() {\n             DomainType.PHYSICAL_MEASUREMENT.toString(), ImmutableList.of(pm), new ArrayList<>());\n \n     DemoChartInfoListResponse response =\n-        controller.getDemoChartInfo(cdrVersion.getCdrVersionId(), searchRequest).getBody();\n+        controller\n+            .getDemoChartInfo(\n+                cdrVersion.getCdrVersionId(),\n+                GenderOrSexType.GENDER.toString(),\n+                AgeType.AGE.toString(),\n+                searchRequest)\n+            .getBody();\n     assertEquals(2, response.getItems().size());\n     assertEquals(\n-        new DemoChartInfo().gender(\"MALE\").race(\"Asian\").ageRange(\"45-64\").count(1L),\n+        new DemoChartInfo().name(\"MALE\").race(\"Asian\").ageRange(\"45-64\").count(1L),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c4fdcdd14f6cc1d1d0b77600f02858fc46cb67b"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTgxNjY3OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/cohortbuilder/CohortQueryBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODozMTozNlrOFv-rdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODozMTozNlrOFv-rdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg1NDMyNQ==", "bodyText": "No reason to dynamically set the table when it was always the same and it improves readability", "url": "https://github.com/all-of-us/workbench/pull/3202#discussion_r385854325", "createdAt": "2020-02-28T18:31:36Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/cohortbuilder/CohortQueryBuilder.java", "diffHunk": "@@ -23,38 +24,31 @@\n @Service\n public class CohortQueryBuilder {\n   private static final String REVIEW_TABLE = \"cb_review_all_events\";\n+  private static final String SEARCH_PERSON_TABLE = \"cb_search_person\";\n+  private static final String PERSON_TABLE = \"person\";\n+\n   private static final String COUNT_SQL_TEMPLATE =\n       \"select count(*) as count\\n\"\n-          + \"from `${projectId}.${dataSetId}.${table}` ${table}\\n\"\n+          + \"from `${projectId}.${dataSetId}.cb_search_person` cb_search_person\\n\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c4fdcdd14f6cc1d1d0b77600f02858fc46cb67b"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTgyNTY5OnYy", "diffSide": "RIGHT", "path": "ui/src/app/cohort-search/overview/overview.component.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODozNDo0NlrOFv-xHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODozNDo0NlrOFv-xHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg1NTc3Mw==", "bodyText": "For now i defaulted graphs to gender and age.", "url": "https://github.com/all-of-us/workbench/pull/3202#discussion_r385855773", "createdAt": "2020-02-28T18:34:46Z", "author": {"login": "freemabd"}, "path": "ui/src/app/cohort-search/overview/overview.component.tsx", "diffHunk": "@@ -168,15 +168,16 @@ export const ListOverview = withCurrentWorkspace()(\n         const {cdrVersionId} = currentWorkspaceStore.getValue();\n         const request = mapRequest(searchRequest);\n         if (request.includes.length > 0) {\n-          cohortBuilderApi().getDemoChartInfo(+cdrVersionId, request).then(response => {\n-            if (localCheck === this.state.apiCallCheck) {\n-              this.setState({\n-                chartData: response.items,\n-                total: response.items.reduce((sum, data) => sum + data.count, 0),\n-                loading: false\n-              });\n-            }\n-          });\n+          cohortBuilderApi().getDemoChartInfo(+cdrVersionId, GenderOrSexType[GenderOrSexType.GENDER],\n+            AgeType[AgeType.AGE], request).then(response => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c4fdcdd14f6cc1d1d0b77600f02858fc46cb67b"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3174, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}