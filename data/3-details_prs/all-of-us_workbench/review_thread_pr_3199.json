{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNDIzNTk3", "number": 3199, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNTozMDoyNVrODj2k_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODo0Nzo0OFrODj6kxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTIwOTU3OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNTozMDoyNVrOFv46ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODo0NTo1NFrOFv_FYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1OTg4Mg==", "bodyText": "This is one minor functional change I made along the way... I felt we should probably have more of the profile object validation centralized in this method, which is called during both the createProfile and updateProfile flows.", "url": "https://github.com/all-of-us/workbench/pull/3199#discussion_r385759882", "createdAt": "2020-02-28T15:30:25Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -247,15 +247,25 @@ private void validateStringLength(String field, String fieldName, int max, int m\n     }\n   }\n \n-  private void validateProfileFields(Profile profile) {\n+  private void validateAndCleanProfile(Profile profile) throws BadRequestException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd50ebebc59b5bcc9f5bd78a56fae6d4cda9da05"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg2MDk2Mg==", "bodyText": "This seems reasonable.", "url": "https://github.com/all-of-us/workbench/pull/3199#discussion_r385860962", "createdAt": "2020-02-28T18:45:54Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -247,15 +247,25 @@ private void validateStringLength(String field, String fieldName, int max, int m\n     }\n   }\n \n-  private void validateProfileFields(Profile profile) {\n+  private void validateAndCleanProfile(Profile profile) throws BadRequestException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1OTg4Mg=="}, "originalCommit": {"oid": "dd50ebebc59b5bcc9f5bd78a56fae6d4cda9da05"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTU1ODkzOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzowOTowMFrOFv8Rbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzowOTowMFrOFv8Rbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgxNDg5NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (profile.getDemographicSurvey() == null) {\n          \n          \n            \n                  profile.setDemographicSurvey(new DemographicSurvey());\n          \n          \n            \n                }\n          \n          \n            \n                profile.setDemographicSurvey(Optional.ofNullable(profile.getDemographicSurvey()).orElse(new DemographicSurvey()));", "url": "https://github.com/all-of-us/workbench/pull/3199#discussion_r385814895", "createdAt": "2020-02-28T17:09:00Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -247,15 +247,25 @@ private void validateStringLength(String field, String fieldName, int max, int m\n     }\n   }\n \n-  private void validateProfileFields(Profile profile) {\n+  private void validateAndCleanProfile(Profile profile) throws BadRequestException {\n+    if (profile.getDemographicSurvey() == null) {\n+      profile.setDemographicSurvey(new DemographicSurvey());\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd50ebebc59b5bcc9f5bd78a56fae6d4cda9da05"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTU2MTA5OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzowOTo1M1rOFv8S6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzowOTo1M1rOFv8S6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgxNTI3NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (profile.getInstitutionalAffiliations() == null) {\n          \n          \n            \n                  profile.setInstitutionalAffiliations(new ArrayList<>());\n          \n          \n            \n                }\n          \n          \n            \n                profile.setInstitutionalAffiliations(Optional.ofNullable(profile.getInstitutionalAffiliations()).orElse(new ArrayList()));", "url": "https://github.com/all-of-us/workbench/pull/3199#discussion_r385815274", "createdAt": "2020-02-28T17:09:53Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -247,15 +247,25 @@ private void validateStringLength(String field, String fieldName, int max, int m\n     }\n   }\n \n-  private void validateProfileFields(Profile profile) {\n+  private void validateAndCleanProfile(Profile profile) throws BadRequestException {\n+    if (profile.getDemographicSurvey() == null) {\n+      profile.setDemographicSurvey(new DemographicSurvey());\n+    }\n+    if (profile.getInstitutionalAffiliations() == null) {\n+      profile.setInstitutionalAffiliations(new ArrayList<>());\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd50ebebc59b5bcc9f5bd78a56fae6d4cda9da05"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTYxODQ5OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzoyMDo1M1rOFv8wGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNzoyMDo1M1rOFv8wGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgyMjc0Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (profile.getAddress() == null) {\n          \n          \n            \n                  throw new BadRequestException(\"Address must not be empty\");\n          \n          \n            \n                }\n          \n          \n            \n                Optional.ofNullable(profile.getAddress()).orElseThrow(() -> new BadRequestException(\"Address must not be empty\"));", "url": "https://github.com/all-of-us/workbench/pull/3199#discussion_r385822746", "createdAt": "2020-02-28T17:20:53Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -323,28 +333,22 @@ private DbUser initializeUserIfNeeded() {\n       verifyInvitationKey(request.getInvitationKey());\n     }\n \n-    String userName = request.getProfile().getUsername();\n-    if (userName == null || userName.length() < 3 || userName.length() > 64)\n-      throw new BadRequestException(\n-          \"Username should be at least 3 characters and not more than 64 characters\");\n-    request.getProfile().setUsername(request.getProfile().getUsername().toLowerCase());\n-    validateProfileFields(request.getProfile());\n-    // This check will be removed once enableNewAccountCreation flag is turned on.\n-    if (request.getProfile().getAddress() == null) {\n-      request.getProfile().setAddress(new Address());\n-    }\n-    if (request.getProfile().getDemographicSurvey() == null) {\n-      request.getProfile().setDemographicSurvey(new DemographicSurvey());\n-    }\n-    if (request.getProfile().getInstitutionalAffiliations() == null) {\n-      request.getProfile().setInstitutionalAffiliations(new ArrayList<>());\n+    final Profile profile = request.getProfile();\n+\n+    // We don't include this check in validateAndCleanProfile since some existing user profiles\n+    // may have empty addresses. So we only check this on user creation, not update.\n+    if (profile.getAddress() == null) {\n+      throw new BadRequestException(\"Address must not be empty\");\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd50ebebc59b5bcc9f5bd78a56fae6d4cda9da05"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4OTg2NDM5OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxODo0Nzo0OFrOFv_ImA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMDoyNToxNFrOFwB1pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg2MTc4NA==", "bodyText": "Let's make this check first.", "url": "https://github.com/all-of-us/workbench/pull/3199#discussion_r385861784", "createdAt": "2020-02-28T18:47:48Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -247,15 +248,23 @@ private void validateStringLength(String field, String fieldName, int max, int m\n     }\n   }\n \n-  private void validateProfileFields(Profile profile) {\n+  private void validateAndCleanProfile(Profile profile) throws BadRequestException {\n+    profile.setDemographicSurvey(\n+        Optional.ofNullable(profile.getDemographicSurvey()).orElse(new DemographicSurvey()));\n+    profile.setInstitutionalAffiliations(\n+        Optional.ofNullable(profile.getInstitutionalAffiliations()).orElse(new ArrayList()));\n+\n+    String userName = profile.getUsername();\n+    if (userName == null || userName.length() < 3 || userName.length() > 64) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df786872dbd172e9f1d7558bfd31e3d719103ecb"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwMjA2MA==", "bodyText": "I'm not 100% sure what you meant, but I reshuffled things so the \"validation\" steps and the \"cleanup\" steps are more clearly delineated.", "url": "https://github.com/all-of-us/workbench/pull/3199#discussion_r385902060", "createdAt": "2020-02-28T20:14:56Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -247,15 +248,23 @@ private void validateStringLength(String field, String fieldName, int max, int m\n     }\n   }\n \n-  private void validateProfileFields(Profile profile) {\n+  private void validateAndCleanProfile(Profile profile) throws BadRequestException {\n+    profile.setDemographicSurvey(\n+        Optional.ofNullable(profile.getDemographicSurvey()).orElse(new DemographicSurvey()));\n+    profile.setInstitutionalAffiliations(\n+        Optional.ofNullable(profile.getInstitutionalAffiliations()).orElse(new ArrayList()));\n+\n+    String userName = profile.getUsername();\n+    if (userName == null || userName.length() < 3 || userName.length() > 64) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg2MTc4NA=="}, "originalCommit": {"oid": "df786872dbd172e9f1d7558bfd31e3d719103ecb"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwNjA4Ng==", "bodyText": "thanks - was just a nit, no worries", "url": "https://github.com/all-of-us/workbench/pull/3199#discussion_r385906086", "createdAt": "2020-02-28T20:25:14Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -247,15 +248,23 @@ private void validateStringLength(String field, String fieldName, int max, int m\n     }\n   }\n \n-  private void validateProfileFields(Profile profile) {\n+  private void validateAndCleanProfile(Profile profile) throws BadRequestException {\n+    profile.setDemographicSurvey(\n+        Optional.ofNullable(profile.getDemographicSurvey()).orElse(new DemographicSurvey()));\n+    profile.setInstitutionalAffiliations(\n+        Optional.ofNullable(profile.getInstitutionalAffiliations()).orElse(new ArrayList()));\n+\n+    String userName = profile.getUsername();\n+    if (userName == null || userName.length() < 3 || userName.length() > 64) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg2MTc4NA=="}, "originalCommit": {"oid": "df786872dbd172e9f1d7558bfd31e3d719103ecb"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3168, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}