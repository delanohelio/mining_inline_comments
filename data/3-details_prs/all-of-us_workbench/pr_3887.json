{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NTY0NTU2", "number": 3887, "title": "[RW-5323][risk=no] API - Move ConceptSetController#fromClientConceptSet into a method in ConceptSetMapper", "bodyText": "PR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test:local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-08-17T03:58:58Z", "url": "https://github.com/all-of-us/workbench/pull/3887", "merged": true, "mergeCommit": {"oid": "00986d687946adeda83b5e7796feab8a167b7a53"}, "closed": true, "closedAt": "2020-08-24T15:56:21Z", "author": {"login": "NehaBroad"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_qQt5gH2gAyNDY4NTY0NTU2OjA0YTdhN2U3ZWQ3M2NiMGYyZjgwNjZiOTNmMzJjNzg1OWI5OWM3ZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCEscfgFqTQ3MzYzMzYwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "04a7a7e7ed73cb0f2f8066b93f32c7859b99c7e3", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/04a7a7e7ed73cb0f2f8066b93f32c7859b99c7e3", "committedDate": "2020-08-17T03:57:35Z", "message": "Concept Set use Mapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "517e847b35b5505f27029b0751814151ce096a9f", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/517e847b35b5505f27029b0751814151ce096a9f", "committedDate": "2020-08-17T04:04:27Z", "message": "remove commented out code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d98fc094053defaf5a1f36c599f90de4f83a9a6b", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/d98fc094053defaf5a1f36c599f90de4f83a9a6b", "committedDate": "2020-08-17T04:25:24Z", "message": "Fix Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1171408a487597312fe95d6fa5259056fa26ff7a", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/1171408a487597312fe95d6fa5259056fa26ff7a", "committedDate": "2020-08-17T04:52:00Z", "message": "Fix Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7440b5787ba9109703321999caa7dfcf60066a87", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/7440b5787ba9109703321999caa7dfcf60066a87", "committedDate": "2020-08-17T04:58:10Z", "message": "Fix Big Query Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8ae759b513a73bba61d112bf9c742beef93eb4b", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/b8ae759b513a73bba61d112bf9c742beef93eb4b", "committedDate": "2020-08-17T05:11:00Z", "message": "rebase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "064cd9b74c64973aa6169133e59b3a4ef0f35336", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/064cd9b74c64973aa6169133e59b3a4ef0f35336", "committedDate": "2020-08-17T05:34:29Z", "message": "Clean up and fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7a5a8f1e7218bdf41fe3a3fb9cbb8a3ea5d7267", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/d7a5a8f1e7218bdf41fe3a3fb9cbb8a3ea5d7267", "committedDate": "2020-08-17T05:56:29Z", "message": "Revert clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0793c911eb6bf1ac8135d8ae541b109b71f0e4ce", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/0793c911eb6bf1ac8135d8ae541b109b71f0e4ce", "committedDate": "2020-08-17T06:06:52Z", "message": "Add Dependency class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/4f10baed985f927664e17d85e540f9bfb141f2e3", "committedDate": "2020-08-17T06:17:57Z", "message": "Spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NDk3OTA2", "url": "https://github.com/all-of-us/workbench/pull/3887#pullrequestreview-468497906", "createdAt": "2020-08-17T14:10:44Z", "commit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDoxMDo0NFrOHBqanw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTowNjozNVrOHBsuUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUwNTU2Nw==", "bodyText": "Mock would imply that we're mimicking behavior. Not sure it applies here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private DbConceptSet createMockConceptSet(Domain domain, long workspaceId) {\n          \n          \n            \n              private DbConceptSet createConceptSet(Domain domain, long workspaceId) {", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471505567", "createdAt": "2020-08-17T14:10:44Z", "author": {"login": "freemabd"}, "path": "api/src/bigquerytest/java/org/pmiops/workbench/api/DataSetControllerBQTest.java", "diffHunk": "@@ -231,6 +220,14 @@ public void setUp() {\n     when(controller.generateRandomEightCharacterQualifier()).thenReturn(\"00000000\");\n   }\n \n+  private DbConceptSet createMockConceptSet(Domain domain, long workspaceId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUxMjA3Nw==", "bodyText": "nit: can we name the test method to match the mapper method\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void clientToDb() {\n          \n          \n            \n              public void clientToDbModel() {", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471512077", "createdAt": "2020-08-17T14:20:21Z", "author": {"login": "freemabd"}, "path": "api/src/test/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapperTest.java", "diffHunk": "@@ -69,4 +77,28 @@ public void dbModelToClient() {\n     assertThat(clientConceptSet.getCreator()).isEqualTo(dbConceptSet.getCreator().getUsername());\n     assertThat(clientConceptSet.getConcepts()).isNull();\n   }\n+\n+  @Test\n+  public void clientToDb() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUyMTQ3Mw==", "bodyText": "We should probably move this line into the createConceptSet method. It's not good practice to change object state in a validation method.", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471521473", "createdAt": "2020-08-17T14:33:57Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "diffHunk": "@@ -369,35 +375,11 @@ public ConceptSet toHydratedConceptSet(DbConceptSet dbConceptSet) {\n         conceptService.findAll(dbConceptSet.getConceptIds(), CONCEPT_NAME_ORDERING));\n   }\n \n-  private DbConceptSet fromClientConceptSet(CreateConceptSetRequest request, long workspaceId) {\n-    ConceptSet conceptSet = request.getConceptSet();\n-    Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n-    DbConceptSet dbConceptSet = new DbConceptSet();\n-    dbConceptSet.setDomainEnum(conceptSet.getDomain());\n-    if (conceptSet.getSurvey() != null) {\n-      dbConceptSet.setSurveysEnum(conceptSet.getSurvey());\n-    }\n-    if (dbConceptSet.getDomainEnum() == null) {\n-      throw new BadRequestException(\n-          \"Domain \" + conceptSet.getDomain() + \" is not allowed for concept sets\");\n-    }\n-    Optional.ofNullable(conceptSet.getEtag())\n-        .ifPresent(etag -> dbConceptSet.setVersion(Etags.toVersion(etag)));\n-    dbConceptSet.setDescription(conceptSet.getDescription());\n-    dbConceptSet.setName(conceptSet.getName());\n-    dbConceptSet.setCreator(userProvider.get());\n-    dbConceptSet.setWorkspaceId(workspaceId);\n-    dbConceptSet.setCreationTime(now);\n-    dbConceptSet.setLastModifiedTime(now);\n-    dbConceptSet.setVersion(INITIAL_VERSION);\n-    addConceptsToSet(dbConceptSet, request.getAddedIds());\n-    if (dbConceptSet.getConceptIds().size() > maxConceptsPerSet) {\n+  private DbConceptSet validateConceptSize(DbConceptSet requestDbConceptSet) {\n+    requestDbConceptSet.setVersion(INITIAL_VERSION);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzMDI5Nw==", "bodyText": "The validate method should really be validating the request object -> CreateConceptSetRequest#getAddedIds.  If the size check fails we fail fast instead of doing all the processing to convert it to a db object.", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471530297", "createdAt": "2020-08-17T14:47:02Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "diffHunk": "@@ -97,7 +96,14 @@\n     if (request.getAddedIds() == null || request.getAddedIds().size() == 0) {\n       throw new BadRequestException(\"Cannot create a concept set with no concepts\");\n     }\n-    DbConceptSet dbConceptSet = fromClientConceptSet(request, workspace.getWorkspaceId());\n+    DbConceptSet dbConceptSet =\n+        validateConceptSize(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzMTg4NQ==", "bodyText": "This can be removed. This is already happening in the ConceptSetController: \n  \n    \n      workbench/api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java\n    \n    \n         Line 100\n      in\n      4f10bae\n    \n    \n    \n    \n\n        \n          \n           validateConceptSize(", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471531885", "createdAt": "2020-08-17T14:49:24Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "diffHunk": "@@ -18,4 +34,80 @@\n   @Mapping(target = \"etag\", source = \"version\", qualifiedByName = \"cdrVersionToEtag\")\n   @Mapping(target = \"concepts\", ignore = true)\n   ConceptSet dbModelToClient(DbConceptSet source);\n+\n+  @Mapping(target = \"conceptSetId\", source = \"conceptSet.id\")\n+  @Mapping(target = \"domainEnum\", source = \"conceptSet.domain\")\n+  @Mapping(target = \"name\", source = \"conceptSet.name\")\n+  @Mapping(target = \"description\", source = \"conceptSet.description\")\n+  @Mapping(\n+      target = \"creationTime\",\n+      source = \"conceptSet.creationTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(\n+      target = \"lastModifiedTime\",\n+      source = \"conceptSet.lastModifiedTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(target = \"participantCount\", source = \"conceptSet.participantCount\")\n+  @Mapping(target = \"domain\", ignore = true)\n+  @Mapping(target = \"survey\", ignore = true)\n+  @Mapping(target = \"creator\", ignore = true)\n+  @Mapping(target = \"surveysEnum\", source = \"conceptSet.survey\")\n+  @Mapping(target = \"version\", source = \"conceptSet.etag\", qualifiedByName = \"etagToCdrVersion\")\n+  @Mapping(target = \"workspaceId\", ignore = true)\n+  @Mapping(target = \"conceptIds\", ignore = true)\n+  DbConceptSet clientToDbModel(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService);\n+\n+  @AfterMapping\n+  default void addConceptIdsToSet(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @MappingTarget DbConceptSet dbConceptSet,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService) {\n+    dbConceptSet.setWorkspaceId(workspaceId);\n+    dbConceptSet.setCreator(creator);\n+    Domain domainEnum = dbConceptSet.getDomainEnum();\n+    if (domainEnum == null) {\n+      throw new BadRequestException(\n+          \"Domain \" + source.getConceptSet().getDomain() + \" is not allowed for concept sets\");\n+    }\n+    Iterable<DbConcept> concepts = conceptService.findAll(source.getAddedIds());\n+    if (dbConceptSet.getConceptIds().size() > 1000) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzNDIxMg==", "bodyText": "Can we rename this to something more descriptive. It's doing more than just adding adding concept ids. It's setting the workspaceId, domain as well as the participantCount", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471534212", "createdAt": "2020-08-17T14:52:53Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "diffHunk": "@@ -18,4 +34,80 @@\n   @Mapping(target = \"etag\", source = \"version\", qualifiedByName = \"cdrVersionToEtag\")\n   @Mapping(target = \"concepts\", ignore = true)\n   ConceptSet dbModelToClient(DbConceptSet source);\n+\n+  @Mapping(target = \"conceptSetId\", source = \"conceptSet.id\")\n+  @Mapping(target = \"domainEnum\", source = \"conceptSet.domain\")\n+  @Mapping(target = \"name\", source = \"conceptSet.name\")\n+  @Mapping(target = \"description\", source = \"conceptSet.description\")\n+  @Mapping(\n+      target = \"creationTime\",\n+      source = \"conceptSet.creationTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(\n+      target = \"lastModifiedTime\",\n+      source = \"conceptSet.lastModifiedTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(target = \"participantCount\", source = \"conceptSet.participantCount\")\n+  @Mapping(target = \"domain\", ignore = true)\n+  @Mapping(target = \"survey\", ignore = true)\n+  @Mapping(target = \"creator\", ignore = true)\n+  @Mapping(target = \"surveysEnum\", source = \"conceptSet.survey\")\n+  @Mapping(target = \"version\", source = \"conceptSet.etag\", qualifiedByName = \"etagToCdrVersion\")\n+  @Mapping(target = \"workspaceId\", ignore = true)\n+  @Mapping(target = \"conceptIds\", ignore = true)\n+  DbConceptSet clientToDbModel(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService);\n+\n+  @AfterMapping\n+  default void addConceptIdsToSet(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzNzY1OQ==", "bodyText": "This should happen in the validate method in the ConceptSetController when validating the request object. We should not be throwing BadRequestExceptions from a mapper.", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471537659", "createdAt": "2020-08-17T14:58:00Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "diffHunk": "@@ -18,4 +34,80 @@\n   @Mapping(target = \"etag\", source = \"version\", qualifiedByName = \"cdrVersionToEtag\")\n   @Mapping(target = \"concepts\", ignore = true)\n   ConceptSet dbModelToClient(DbConceptSet source);\n+\n+  @Mapping(target = \"conceptSetId\", source = \"conceptSet.id\")\n+  @Mapping(target = \"domainEnum\", source = \"conceptSet.domain\")\n+  @Mapping(target = \"name\", source = \"conceptSet.name\")\n+  @Mapping(target = \"description\", source = \"conceptSet.description\")\n+  @Mapping(\n+      target = \"creationTime\",\n+      source = \"conceptSet.creationTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(\n+      target = \"lastModifiedTime\",\n+      source = \"conceptSet.lastModifiedTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(target = \"participantCount\", source = \"conceptSet.participantCount\")\n+  @Mapping(target = \"domain\", ignore = true)\n+  @Mapping(target = \"survey\", ignore = true)\n+  @Mapping(target = \"creator\", ignore = true)\n+  @Mapping(target = \"surveysEnum\", source = \"conceptSet.survey\")\n+  @Mapping(target = \"version\", source = \"conceptSet.etag\", qualifiedByName = \"etagToCdrVersion\")\n+  @Mapping(target = \"workspaceId\", ignore = true)\n+  @Mapping(target = \"conceptIds\", ignore = true)\n+  DbConceptSet clientToDbModel(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService);\n+\n+  @AfterMapping\n+  default void addConceptIdsToSet(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @MappingTarget DbConceptSet dbConceptSet,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService) {\n+    dbConceptSet.setWorkspaceId(workspaceId);\n+    dbConceptSet.setCreator(creator);\n+    Domain domainEnum = dbConceptSet.getDomainEnum();\n+    if (domainEnum == null) {\n+      throw new BadRequestException(\n+          \"Domain \" + source.getConceptSet().getDomain() + \" is not allowed for concept sets\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU0MzM3Ng==", "bodyText": "Not sure any of this code is necessary. A CreateConceptSetRequest has a ConceptSet which can have only 1 domain. If we really feel like we need to validate that the concept ids all belong in the same domain, then we should check this in the controller. Also, there is a much easier way to validate this, just query the concept table for domain count.", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471543376", "createdAt": "2020-08-17T15:06:35Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "diffHunk": "@@ -18,4 +34,80 @@\n   @Mapping(target = \"etag\", source = \"version\", qualifiedByName = \"cdrVersionToEtag\")\n   @Mapping(target = \"concepts\", ignore = true)\n   ConceptSet dbModelToClient(DbConceptSet source);\n+\n+  @Mapping(target = \"conceptSetId\", source = \"conceptSet.id\")\n+  @Mapping(target = \"domainEnum\", source = \"conceptSet.domain\")\n+  @Mapping(target = \"name\", source = \"conceptSet.name\")\n+  @Mapping(target = \"description\", source = \"conceptSet.description\")\n+  @Mapping(\n+      target = \"creationTime\",\n+      source = \"conceptSet.creationTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(\n+      target = \"lastModifiedTime\",\n+      source = \"conceptSet.lastModifiedTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(target = \"participantCount\", source = \"conceptSet.participantCount\")\n+  @Mapping(target = \"domain\", ignore = true)\n+  @Mapping(target = \"survey\", ignore = true)\n+  @Mapping(target = \"creator\", ignore = true)\n+  @Mapping(target = \"surveysEnum\", source = \"conceptSet.survey\")\n+  @Mapping(target = \"version\", source = \"conceptSet.etag\", qualifiedByName = \"etagToCdrVersion\")\n+  @Mapping(target = \"workspaceId\", ignore = true)\n+  @Mapping(target = \"conceptIds\", ignore = true)\n+  DbConceptSet clientToDbModel(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService);\n+\n+  @AfterMapping\n+  default void addConceptIdsToSet(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @MappingTarget DbConceptSet dbConceptSet,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService) {\n+    dbConceptSet.setWorkspaceId(workspaceId);\n+    dbConceptSet.setCreator(creator);\n+    Domain domainEnum = dbConceptSet.getDomainEnum();\n+    if (domainEnum == null) {\n+      throw new BadRequestException(\n+          \"Domain \" + source.getConceptSet().getDomain() + \" is not allowed for concept sets\");\n+    }\n+    Iterable<DbConcept> concepts = conceptService.findAll(source.getAddedIds());\n+    if (dbConceptSet.getConceptIds().size() > 1000) {\n+      throw new BadRequestException(\"Exceeded 1000 in concept set\");\n+    }\n+    List<DbConcept> mismatchedConcepts =\n+        ImmutableList.copyOf(concepts).stream()\n+            .filter(concept -> !concept.getConceptClassId().equals(\"Question\"))\n+            .filter(\n+                concept -> {\n+                  Domain domain =\n+                      Domain.PHYSICALMEASUREMENT.equals(domainEnum)\n+                          ? Domain.PHYSICALMEASUREMENT\n+                          : DbStorageEnums.domainIdToDomain(concept.getDomainId());\n+                  return !domainEnum.equals(domain);\n+                })\n+            .collect(Collectors.toList());\n+    if (!mismatchedConcepts.isEmpty()) {\n+      String mismatchedConceptIds =\n+          Joiner.on(\", \")\n+              .join(\n+                  mismatchedConcepts.stream()\n+                      .map(DbConcept::getConceptId)\n+                      .collect(Collectors.toList()));\n+      throw new BadRequestException(\n+          String.format(\"Concepts [%s] are not in domain %s\", mismatchedConceptIds, domainEnum));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 98}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2f5fb32713005ec187271958f94114d592b993f", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/b2f5fb32713005ec187271958f94114d592b993f", "committedDate": "2020-08-20T17:26:27Z", "message": "Addressing PR Comments: Moving validate method in controller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c147fa4e3061db91c0575534444f9a7d3d5db49a", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/c147fa4e3061db91c0575534444f9a7d3d5db49a", "committedDate": "2020-08-20T17:32:40Z", "message": "Remove concept Service from Mapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "494de773ec6a8e54063c046dbd5605cc1e006627", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/494de773ec6a8e54063c046dbd5605cc1e006627", "committedDate": "2020-08-20T17:33:48Z", "message": "Merge branch 'master' into nsaxena/RW-5323"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa4c4fbd025d08dae6436dd05ad0ee0bc69b6e8c", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/fa4c4fbd025d08dae6436dd05ad0ee0bc69b6e8c", "committedDate": "2020-08-20T18:01:05Z", "message": "Removing Check for different domains"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ed2efcac3c414eda830e6d27c9f71966a70b479", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/3ed2efcac3c414eda830e6d27c9f71966a70b479", "committedDate": "2020-08-20T18:51:29Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d99025ec45956fbad639f0c2f78c7c628f53751c", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/d99025ec45956fbad639f0c2f78c7c628f53751c", "committedDate": "2020-08-21T02:51:31Z", "message": "Fix ParticipantCohortAnnotationMapperTest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f688acb42af44fe7cda92c8a8c15b57644ce15e", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/2f688acb42af44fe7cda92c8a8c15b57644ce15e", "committedDate": "2020-08-21T03:57:55Z", "message": "Fix Test : Concept Set with 0 Concepts cannot be saved/update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac16d5ac5cfbf2c085e22f8c5ed3e19303d68c14", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/ac16d5ac5cfbf2c085e22f8c5ed3e19303d68c14", "committedDate": "2020-08-21T14:37:29Z", "message": "Fix Test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNTQ4NDM4", "url": "https://github.com/all-of-us/workbench/pull/3887#pullrequestreview-473548438", "createdAt": "2020-08-24T14:33:39Z", "commit": {"oid": "ac16d5ac5cfbf2c085e22f8c5ed3e19303d68c14"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNDozMzozOVrOHFnzrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNDozMzozOVrOHFnzrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY1NzEzMw==", "bodyText": "Please remove duplicate line of code\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                dbConceptSet.getConceptIds().addAll(source.getAddedIds());\n          \n          \n            \n                String omopTable = BigQueryTableInfo.getTableName(source.getConceptSet().getDomain());\n          \n          \n            \n                dbConceptSet.setParticipantCount(\n          \n          \n            \n                    conceptBigQueryService.getParticipantCountForConcepts(\n          \n          \n            \n                        dbConceptSet.getDomainEnum(), omopTable, dbConceptSet.getConceptIds()));\n          \n          \n            \n                dbConceptSet.getConceptIds().addAll(source.getAddedIds());\n          \n          \n            \n                dbConceptSet.getConceptIds().addAll(source.getAddedIds());\n          \n          \n            \n                String omopTable = BigQueryTableInfo.getTableName(source.getConceptSet().getDomain());\n          \n          \n            \n                dbConceptSet.setParticipantCount(\n          \n          \n            \n                    conceptBigQueryService.getParticipantCountForConcepts(\n          \n          \n            \n                        dbConceptSet.getDomainEnum(), omopTable, dbConceptSet.getConceptIds()));", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r475657133", "createdAt": "2020-08-24T14:33:39Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "diffHunk": "@@ -18,4 +25,47 @@\n   @Mapping(target = \"etag\", source = \"version\", qualifiedByName = \"cdrVersionToEtag\")\n   @Mapping(target = \"concepts\", ignore = true)\n   ConceptSet dbModelToClient(DbConceptSet source);\n+\n+  @Mapping(target = \"conceptSetId\", source = \"conceptSet.id\")\n+  @Mapping(target = \"domainEnum\", source = \"conceptSet.domain\")\n+  @Mapping(target = \"name\", source = \"conceptSet.name\")\n+  @Mapping(target = \"description\", source = \"conceptSet.description\")\n+  @Mapping(\n+      target = \"creationTime\",\n+      source = \"conceptSet.creationTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(\n+      target = \"lastModifiedTime\",\n+      source = \"conceptSet.lastModifiedTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(target = \"participantCount\", source = \"conceptSet.participantCount\")\n+  @Mapping(target = \"domain\", ignore = true)\n+  @Mapping(target = \"survey\", ignore = true)\n+  @Mapping(target = \"creator\", ignore = true)\n+  @Mapping(target = \"surveysEnum\", source = \"conceptSet.survey\")\n+  @Mapping(target = \"version\", source = \"conceptSet.etag\", qualifiedByName = \"etagToCdrVersion\")\n+  @Mapping(target = \"workspaceId\", ignore = true)\n+  @Mapping(target = \"conceptIds\", ignore = true)\n+  DbConceptSet clientToDbModel(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @Context ConceptBigQueryService conceptBigQueryService);\n+\n+  @AfterMapping\n+  default void updateConceptSetFields(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @MappingTarget DbConceptSet dbConceptSet,\n+      @Context ConceptBigQueryService conceptBigQueryService) {\n+    dbConceptSet.setWorkspaceId(workspaceId);\n+    dbConceptSet.setCreator(creator);\n+    dbConceptSet.getConceptIds().addAll(source.getAddedIds());\n+    String omopTable = BigQueryTableInfo.getTableName(source.getConceptSet().getDomain());\n+    dbConceptSet.setParticipantCount(\n+        conceptBigQueryService.getParticipantCountForConcepts(\n+            dbConceptSet.getDomainEnum(), omopTable, dbConceptSet.getConceptIds()));\n+    dbConceptSet.getConceptIds().addAll(source.getAddedIds());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac16d5ac5cfbf2c085e22f8c5ed3e19303d68c14"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d6b056625a9cf2ab7e4444816e349a0f74332da", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/3d6b056625a9cf2ab7e4444816e349a0f74332da", "committedDate": "2020-08-24T14:40:24Z", "message": "Remove Duplicate Line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNTk3NzI5", "url": "https://github.com/all-of-us/workbench/pull/3887#pullrequestreview-473597729", "createdAt": "2020-08-24T15:11:31Z", "commit": {"oid": "ac16d5ac5cfbf2c085e22f8c5ed3e19303d68c14"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNToxMTozMlrOHFpuvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNToxMTozMlrOHFpuvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY4ODYzNg==", "bodyText": "When renaming a concept set it calls this method and conceptSet.getConcepts throws a null pointer exception. Please wrap this in a null/empty check\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                validateConceptSet(\n          \n          \n            \n                    dbConceptSet,\n          \n          \n            \n                    conceptSet.getConcepts().stream()\n          \n          \n            \n                        .map(concept -> concept.getConceptId())\n          \n          \n            \n                        .collect(Collectors.toList()));\n          \n          \n            \n               if (!CollectionUtils.isEmpty(conceptSet.getConcepts())) {\n          \n          \n            \n                  validateConceptSet(\n          \n          \n            \n                      dbConceptSet,\n          \n          \n            \n                      conceptSet.getConcepts().stream()\n          \n          \n            \n                          .map(concept -> concept.getConceptId())\n          \n          \n            \n                          .collect(Collectors.toList()));\n          \n          \n            \n                }", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r475688636", "createdAt": "2020-08-24T15:11:32Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "diffHunk": "@@ -369,35 +317,79 @@ public ConceptSet toHydratedConceptSet(DbConceptSet dbConceptSet) {\n         conceptService.findAll(dbConceptSet.getConceptIds(), CONCEPT_NAME_ORDERING));\n   }\n \n-  private DbConceptSet fromClientConceptSet(CreateConceptSetRequest request, long workspaceId) {\n-    ConceptSet conceptSet = request.getConceptSet();\n-    Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n-    DbConceptSet dbConceptSet = new DbConceptSet();\n-    dbConceptSet.setDomainEnum(conceptSet.getDomain());\n-    if (conceptSet.getSurvey() != null) {\n-      dbConceptSet.setSurveysEnum(conceptSet.getSurvey());\n+  private void validateAndUpdateDbConceptSet(DbConceptSet dbConceptSet, ConceptSet conceptSet) {\n+    if (Strings.isNullOrEmpty(conceptSet.getEtag())) {\n+      throw new BadRequestException(\"missing required update field 'etag'\");\n     }\n-    if (dbConceptSet.getDomainEnum() == null) {\n-      throw new BadRequestException(\n-          \"Domain \" + conceptSet.getDomain() + \" is not allowed for concept sets\");\n+    int version = Etags.toVersion(conceptSet.getEtag());\n+    if (dbConceptSet.getVersion() != version) {\n+      throw new ConflictException(\"Attempted to modify outdated concept set version\");\n     }\n-    Optional.ofNullable(conceptSet.getEtag())\n-        .ifPresent(etag -> dbConceptSet.setVersion(Etags.toVersion(etag)));\n-    dbConceptSet.setDescription(conceptSet.getDescription());\n-    dbConceptSet.setName(conceptSet.getName());\n-    dbConceptSet.setCreator(userProvider.get());\n-    dbConceptSet.setWorkspaceId(workspaceId);\n-    dbConceptSet.setCreationTime(now);\n-    dbConceptSet.setLastModifiedTime(now);\n-    dbConceptSet.setVersion(INITIAL_VERSION);\n-    addConceptsToSet(dbConceptSet, request.getAddedIds());\n+    if (conceptSet.getName() != null) {\n+      dbConceptSet.setName(conceptSet.getName());\n+    }\n+    if (conceptSet.getDescription() != null) {\n+      dbConceptSet.setDescription(conceptSet.getDescription());\n+    }\n+    if (conceptSet.getDomain() != null && conceptSet.getDomain() != dbConceptSet.getDomainEnum()) {\n+      throw new BadRequestException(\"Cannot modify the domain of an existing concept set\");\n+    }\n+    validateConceptSet(\n+        dbConceptSet,\n+        conceptSet.getConcepts().stream()\n+            .map(concept -> concept.getConceptId())\n+            .collect(Collectors.toList()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac16d5ac5cfbf2c085e22f8c5ed3e19303d68c14"}, "originalPosition": 139}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5aac657c4eda1c2ea3523558f9d5523b7e70ed9", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/f5aac657c4eda1c2ea3523558f9d5523b7e70ed9", "committedDate": "2020-08-24T15:28:53Z", "message": "Fix Rename null pointer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjE5MTgw", "url": "https://github.com/all-of-us/workbench/pull/3887#pullrequestreview-473619180", "createdAt": "2020-08-24T15:35:49Z", "commit": {"oid": "f5aac657c4eda1c2ea3523558f9d5523b7e70ed9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNTozNTo0OVrOHFqxQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNTozNTo0OVrOHFqxQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcwNTY2NQ==", "bodyText": "Think we should use CollectionUtils.isEmpty here. It does a null and empty check. If the code changes and we passed an empty list during the rename we would still throw a BadRequestException in that case and rename would fail\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (conceptSet.getConcepts() != null) {\n          \n          \n            \n                if (!CollectionUtils.isEmpty(conceptSet.getConcepts())) {", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r475705665", "createdAt": "2020-08-24T15:35:49Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "diffHunk": "@@ -369,35 +317,82 @@ public ConceptSet toHydratedConceptSet(DbConceptSet dbConceptSet) {\n         conceptService.findAll(dbConceptSet.getConceptIds(), CONCEPT_NAME_ORDERING));\n   }\n \n-  private DbConceptSet fromClientConceptSet(CreateConceptSetRequest request, long workspaceId) {\n-    ConceptSet conceptSet = request.getConceptSet();\n-    Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n-    DbConceptSet dbConceptSet = new DbConceptSet();\n-    dbConceptSet.setDomainEnum(conceptSet.getDomain());\n-    if (conceptSet.getSurvey() != null) {\n-      dbConceptSet.setSurveysEnum(conceptSet.getSurvey());\n+  private void validateAndUpdateDbConceptSet(DbConceptSet dbConceptSet, ConceptSet conceptSet) {\n+    if (Strings.isNullOrEmpty(conceptSet.getEtag())) {\n+      throw new BadRequestException(\"missing required update field 'etag'\");\n     }\n-    if (dbConceptSet.getDomainEnum() == null) {\n-      throw new BadRequestException(\n-          \"Domain \" + conceptSet.getDomain() + \" is not allowed for concept sets\");\n+    int version = Etags.toVersion(conceptSet.getEtag());\n+    if (dbConceptSet.getVersion() != version) {\n+      throw new ConflictException(\"Attempted to modify outdated concept set version\");\n     }\n-    Optional.ofNullable(conceptSet.getEtag())\n-        .ifPresent(etag -> dbConceptSet.setVersion(Etags.toVersion(etag)));\n-    dbConceptSet.setDescription(conceptSet.getDescription());\n-    dbConceptSet.setName(conceptSet.getName());\n-    dbConceptSet.setCreator(userProvider.get());\n-    dbConceptSet.setWorkspaceId(workspaceId);\n-    dbConceptSet.setCreationTime(now);\n-    dbConceptSet.setLastModifiedTime(now);\n-    dbConceptSet.setVersion(INITIAL_VERSION);\n-    addConceptsToSet(dbConceptSet, request.getAddedIds());\n+    if (conceptSet.getName() != null) {\n+      dbConceptSet.setName(conceptSet.getName());\n+    }\n+    if (conceptSet.getDescription() != null) {\n+      dbConceptSet.setDescription(conceptSet.getDescription());\n+    }\n+    if (conceptSet.getDomain() != null && conceptSet.getDomain() != dbConceptSet.getDomainEnum()) {\n+      throw new BadRequestException(\"Cannot modify the domain of an existing concept set\");\n+    }\n+    // In case of rename ConceptDet does not have concepts\n+    if (conceptSet.getConcepts() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5aac657c4eda1c2ea3523558f9d5523b7e70ed9"}, "originalPosition": 136}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ab6c958b9bbe2add49ee523fd75478718a0e5ff", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/8ab6c958b9bbe2add49ee523fd75478718a0e5ff", "committedDate": "2020-08-24T15:43:33Z", "message": "PR Comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjMzNjA5", "url": "https://github.com/all-of-us/workbench/pull/3887#pullrequestreview-473633609", "createdAt": "2020-08-24T15:53:15Z", "commit": {"oid": "8ab6c958b9bbe2add49ee523fd75478718a0e5ff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4286, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}