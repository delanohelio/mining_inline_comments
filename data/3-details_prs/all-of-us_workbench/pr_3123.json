{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0NTQ4Nzg5", "number": 3123, "title": "[RW-4386][risk=low] Set correct billing status after updating a workspace's billing account", "bodyText": "Correctly sets the billing account status after a new billing account is set on a workspace.\nEffectively, it does the following\n\nSetting a workspace to an open billing account will reactive its billing status\nUsers cannot set a workspace to a closed billing account\nUsers that set a workspace to free tier\n\nWith free credits remaining - workspace is set to billing active\nWith no credits remaining - workspace is set to billing inactive\n\n\n\nTIL\n\nJavascript exceptions thrown by API requests need to be deserialized\nExceptionAdvice.java has the logic for our catch all exception -> API mapping. There's a bug where the top level exception is ignored if there are nested exceptions.\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-02-12T21:38:33Z", "url": "https://github.com/all-of-us/workbench/pull/3123", "merged": true, "mergeCommit": {"oid": "65a411c8bd649c79af2fa58149fc5ea5f1e1f57c"}, "closed": true, "closedAt": "2020-02-13T23:04:40Z", "author": {"login": "ericsong"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCCRgqAH2gAyMzc0NTQ4Nzg5OjkwZTIzNTFkYWExMzMyY2I0ZjNhYjA5MTc2ZjczMGU0NzliYWYwNTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEDAU1gH2gAyMzc0NTQ4Nzg5OmU2YjljMDY0NzI0M2VmNzI5YmM2MWFjNjIzMTlhNTE2OGQyYWU1ZTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "90e2351daa1332cb4f3ab09176f730e479baf051", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/90e2351daa1332cb4f3ab09176f730e479baf051", "committedDate": "2020-02-07T16:52:52Z", "message": "add failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5d32ab38adfd7eaeec75b1879ab81917f4a99af", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/b5d32ab38adfd7eaeec75b1879ab81917f4a99af", "committedDate": "2020-02-12T20:01:10Z", "message": "passing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6eb9d57ccd2e849ca0d2f683c976bbbb0102cd40", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/6eb9d57ccd2e849ca0d2f683c976bbbb0102cd40", "committedDate": "2020-02-12T21:40:18Z", "message": "remove log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d622c644f43d09cb42db5b87d7c5bc8cf44fba8", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/5d622c644f43d09cb42db5b87d7c5bc8cf44fba8", "committedDate": "2020-02-12T21:40:49Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f23c930c55bf6ddf3cdd5cecdb39399a274e0d4c", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/f23c930c55bf6ddf3cdd5cecdb39399a274e0d4c", "committedDate": "2020-02-12T22:02:52Z", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-4386"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a97f1c6b8aef54a489aa24b948f99a0eb971ccf0", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/a97f1c6b8aef54a489aa24b948f99a0eb971ccf0", "committedDate": "2020-02-12T23:47:45Z", "message": "show user a specific error message. recheck banner state on workspace reload"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62e15ba794c79d2061e68b922b1e0d5a6b3a7142", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/62e15ba794c79d2061e68b922b1e0d5a6b3a7142", "committedDate": "2020-02-12T23:48:17Z", "message": "exception handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8270a75f9a48dbdd193f85c5e45bc17523d06d5", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/d8270a75f9a48dbdd193f85c5e45bc17523d06d5", "committedDate": "2020-02-12T23:50:02Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62af3a13a979a5cd570824f094532795f751fe4d", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/62af3a13a979a5cd570824f094532795f751fe4d", "committedDate": "2020-02-13T17:12:32Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f300030f9fe7c9ac1f7e9b1a988fcb23a3566959", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/f300030f9fe7c9ac1f7e9b1a988fcb23a3566959", "committedDate": "2020-02-13T17:18:44Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9955cf854708837dfc38a3f3e87b164bf699fba8", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/9955cf854708837dfc38a3f3e87b164bf699fba8", "committedDate": "2020-02-13T17:28:20Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7669c17b0a5f8ac39381a7bf4458de254a4f2ca8", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/7669c17b0a5f8ac39381a7bf4458de254a4f2ca8", "committedDate": "2020-02-13T17:40:14Z", "message": "fix bq test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "775a6b7f12308fb15688c1fccb3b786497656473", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/775a6b7f12308fb15688c1fccb3b786497656473", "committedDate": "2020-02-13T18:10:46Z", "message": "comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDQ3MjUw", "url": "https://github.com/all-of-us/workbench/pull/3123#pullrequestreview-358447250", "createdAt": "2020-02-13T18:22:41Z", "commit": {"oid": "775a6b7f12308fb15688c1fccb3b786497656473"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxODoyMjo0MlrOFpemcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxOTo0OToxMVrOFphWeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAzNzI5OA==", "bodyText": "[nit] May be marginally more readable to replace orElse(false) with isPresent()", "url": "https://github.com/all-of-us/workbench/pull/3123#discussion_r379037298", "createdAt": "2020-02-13T18:22:42Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspaceServiceImpl.java", "diffHunk": "@@ -694,6 +698,16 @@ public void updateWorkspaceBillingAccount(DbWorkspace workspace, String newBilli\n       cloudbilling = serviceAccountCloudbillingProvider.get();\n     } else {\n       cloudbilling = endUserCloudbillingProvider.get();\n+      try {\n+        if (!Optional.ofNullable(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "775a6b7f12308fb15688c1fccb3b786497656473"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA0MDIwNQ==", "bodyText": "I'm just sad for whoever (at Google?) decided that \"Cloudbilling\" shouldn't have a capital \"B\"... \ud83d\ude44", "url": "https://github.com/all-of-us/workbench/pull/3123#discussion_r379040205", "createdAt": "2020-02-13T18:28:08Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/workspaces/WorkspacesControllerTest.java", "diffHunk": "@@ -246,6 +247,9 @@\n   @Autowired\n   private Provider<Cloudbilling> serviceAccountCloudbillingProvider;\n \n+  private static Cloudbilling endUserCloudbilling;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "775a6b7f12308fb15688c1fccb3b786497656473"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA3Nzg5MA==", "bodyText": "[opt] I tend to try to avoid abbreviations for var names in Java, though they're prevalent enough in our codebase I wouldn't block on this.", "url": "https://github.com/all-of-us/workbench/pull/3123#discussion_r379077890", "createdAt": "2020-02-13T19:40:19Z", "author": {"login": "gjuggler"}, "path": "api/src/test/java/org/pmiops/workbench/workspaces/WorkspacesControllerTest.java", "diffHunk": "@@ -787,22 +793,156 @@ public void testUpdateWorkspace() throws Exception {\n   }\n \n   @Test\n-  public void testUpdateWorkspace_freeTierBilling() throws Exception {\n+  public void testUpdateWorkspace_freeTierBilling_usesCorrectProvider() throws Exception {\n     Workspace ws = createWorkspace();\n     ws = workspacesController.createWorkspace(ws).getBody();\n \n-    verify(endUserCloudbillingProvider.get()).projects();\n-    verifyZeroInteractions(serviceAccountCloudbillingProvider.get());\n+    // Creating the workspace with a user provided billing account\n+    endUserCloudbilling = TestMockFactory.createMockedCloudbilling();\n+    serviceAccountCloudbilling = TestMockFactory.createMockedCloudbilling();\n \n     UpdateWorkspaceRequest request = new UpdateWorkspaceRequest();\n     ws.setBillingAccountName(workbenchConfig.billing.freeTierBillingAccountName());\n     request.setWorkspace(ws);\n     workspacesController.updateWorkspace(ws.getNamespace(), ws.getId(), request);\n \n-    verifyNoMoreInteractions(endUserCloudbillingProvider.get());\n+    verifyZeroInteractions(endUserCloudbillingProvider.get());\n     verify(serviceAccountCloudbillingProvider.get()).projects();\n   }\n \n+  @Test\n+  public void testUpdateWorkspace_freeTierBilling_noCreditsRemaining() throws Exception {\n+    Workspace ws = createWorkspace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "775a6b7f12308fb15688c1fccb3b786497656473"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA4MjM2MA==", "bodyText": "[No action] I haven't come up against the breadcrumb code before, so it's a little surprising to see some very workspace & billing specific logic showing up in a component that otherwise seems to be very generic. Could you imagine (not for this PR, or not anytime soon) a better home for this? Or is there a a strong reason that this logic belongs in this component?", "url": "https://github.com/all-of-us/workbench/pull/3123#discussion_r379082360", "createdAt": "2020-02-13T19:49:11Z", "author": {"login": "gjuggler"}, "path": "ui/src/app/components/breadcrumb.tsx", "diffHunk": "@@ -167,10 +167,13 @@ export const Breadcrumb = fp.flow(\n       if (!prevProps.workspace && this.props.workspace &&\n         this.props.workspace.billingStatus === BillingStatus.INACTIVE) {\n         this.setState({showInvalidBillingBanner: true});\n-      }\n-\n-      if (prevProps.workspace && !this.props.workspace) {\n+      } else if (prevProps.workspace && !this.props.workspace) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "775a6b7f12308fb15688c1fccb3b786497656473"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6b9c0647243ef729bc61ac62319a5168d2ae5e4", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/e6b9c0647243ef729bc61ac62319a5168d2ae5e4", "committedDate": "2020-02-13T22:51:51Z", "message": "spotless"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3570, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}