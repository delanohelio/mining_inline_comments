{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MTY1OTU0", "number": 2969, "title": "[RW-4235][risk=no] Log when a user observes a held notebook lock", "bodyText": "Description:\nThis was requested to establish a rough estimate of the effect of how often users are affect by notebook locking.\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-01-04T00:44:03Z", "url": "https://github.com/all-of-us/workbench/pull/2969", "merged": true, "mergeCommit": {"oid": "cb6d39808082a130c536a653420de6842655e375"}, "closed": true, "closedAt": "2020-01-22T20:00:58Z", "author": {"login": "calbach"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb3ulpXgFqTMzODczODgwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8uLfRABqjI5Njg2NjExMjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NzM4ODA4", "url": "https://github.com/all-of-us/workbench/pull/2969#pullrequestreview-338738808", "createdAt": "2020-01-06T16:17:31Z", "commit": {"oid": "35e9244876a9d63045471fc9d08d6257834f255d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxNjoxNzozMVrOFaiCSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxNjoxNzozMVrOFaiCSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM2NDkzOA==", "bodyText": "If it's useful, we can either fire an event metric for this to StackDriver, or add a log-based metric.", "url": "https://github.com/all-of-us/workbench/pull/2969#discussion_r363364938", "createdAt": "2020-01-06T16:17:31Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -703,6 +703,20 @@ private Boolean copyBlob(String bucketName, Blob b) {\n       }\n     }\n \n+    // If a lock is held by another user, log this to establish a rough estimate of how often\n+    // locked notebooks are encountered. Note that this only covers locks encountered from the\n+    // Workbench - any Jupyter UI-based lock detection does not touch this code path.\n+    if (response.getLockExpirationTime() != null && response.getLastLockedBy() != null) {\n+      String currentUsername = userProvider.get().getUsername();\n+      if (clock.millis() < response.getLockExpirationTime()\n+          && !response.getLastLockedBy().equals(currentUsername)) {\n+        log.info(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35e9244876a9d63045471fc9d08d6257834f255d"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4ODA2NDI3", "url": "https://github.com/all-of-us/workbench/pull/2969#pullrequestreview-338806427", "createdAt": "2020-01-06T18:18:20Z", "commit": {"oid": "35e9244876a9d63045471fc9d08d6257834f255d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNTIyODg5", "url": "https://github.com/all-of-us/workbench/pull/2969#pullrequestreview-340522889", "createdAt": "2020-01-09T13:37:00Z", "commit": {"oid": "f5b26c9eb2767fcfc0ca915af61ebd4821e2bb00"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMzozNzowMFrOFb2AnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMzozOTozN1rOFb2FrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc0MDc2NA==", "bodyText": "Looks good as of this writing. Thanks for being the first guinea pig.\nIn terms of timing, I might hold off and use a single metric that has attachments after #2934 is in. The paradigm there is a metric like NOTEBOOK_CHECK_BY_LOCK_STATUS and then a key like AttachmentKey.NOTEBOOK_LOCK_STATUS with values locked and unlocked. (This would be an EventMetric instead of a GaugeMetric in the new scheme.)\nNo harm in leaving this in place in the meantime and adding rather than replacing these, especially since I can't yet guarantee the above functionality is in the next build. And of course, now that you've gone through the process here, any comments on the other PR are doubly appreciated.", "url": "https://github.com/all-of-us/workbench/pull/2969#discussion_r364740764", "createdAt": "2020-01-09T13:37:00Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/monitoring/views/MonitoringViews.java", "diffHunk": "@@ -29,6 +29,11 @@\n   NOTEBOOK_SAVE(\"notebook_save\", \"Save (or create) a notebook\"),\n   NOTEBOOK_CLONE(\"notebook_clone\", \"Clone (duplicate) a notebook\"),\n   NOTEBOOK_DELETE(\"notebook_delete\", \"Delete a notebook\"),\n+  NOTEBOOK_CHECK_LOCKED(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5b26c9eb2767fcfc0ca915af61ebd4821e2bb00"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc0MTgyOA==", "bodyText": "style nit/trick: if you just have a line that just says final MonitoringViews lockMetric;, the compiler will keep you honest that it's initialized exactly once, taking all branches into account. That way if someone adds another branch later, they won't forget to assign it as appropriate.", "url": "https://github.com/all-of-us/workbench/pull/2969#discussion_r364741828", "createdAt": "2020-01-09T13:39:07Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -703,6 +708,23 @@ private Boolean copyBlob(String bucketName, Blob b) {\n       }\n     }\n \n+    // If a lock is held by another user, log this to establish a rough estimate of how often\n+    // locked notebooks are encountered. Note that this only covers locks encountered from the\n+    // Workbench - any Jupyter UI-based lock detection does not touch this code path.\n+    MonitoringViews lockMetric = MonitoringViews.NOTEBOOK_CHECK_AVAILABLE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5b26c9eb2767fcfc0ca915af61ebd4821e2bb00"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc0MjA2MA==", "bodyText": "Thanks for the test updates.", "url": "https://github.com/all-of-us/workbench/pull/2969#discussion_r364742060", "createdAt": "2020-01-09T13:39:37Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/workspaces/WorkspacesControllerTest.java", "diffHunk": "@@ -2622,6 +2628,7 @@ public void testNotebookLockingNullMetadata() {\n \n     final NotebookLockingMetadataResponse expectedResponse = new NotebookLockingMetadataResponse();\n     assertNotebookLockingMetadata(gcsMetadata, expectedResponse, fcWorkspaceAcl);\n+    verify(mockMonitoringService).recordIncrement(MonitoringViews.NOTEBOOK_CHECK_AVAILABLE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5b26c9eb2767fcfc0ca915af61ebd4821e2bb00"}, "originalPosition": 70}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5b26c9eb2767fcfc0ca915af61ebd4821e2bb00", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/f5b26c9eb2767fcfc0ca915af61ebd4821e2bb00", "committedDate": "2020-01-07T19:54:14Z", "message": "Fix tests"}, "afterCommit": {"oid": "57abcc3f43ca0f07ae33bfa3499c6b2b2bd3543d", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/57abcc3f43ca0f07ae33bfa3499c6b2b2bd3543d", "committedDate": "2020-01-17T01:59:53Z", "message": "Refactor to use attachment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0ODc5MTQz", "url": "https://github.com/all-of-us/workbench/pull/2969#pullrequestreview-344879143", "createdAt": "2020-01-17T22:39:54Z", "commit": {"oid": "57abcc3f43ca0f07ae33bfa3499c6b2b2bd3543d"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMjozOTo1NFrOFfHCtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QyMjo0Mjo0M1rOFfHFiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2NTU1Ng==", "bodyText": "Looks good.", "url": "https://github.com/all-of-us/workbench/pull/2969#discussion_r368165556", "createdAt": "2020-01-17T22:39:54Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/monitoring/views/GaugeMetric.java", "diffHunk": "@@ -19,6 +19,10 @@\n       \"dataset_count_2\",\n       \"Count of all datasets in existence\",\n       ImmutableList.of(MetricLabel.DATASET_INVALID)),\n+  NOTEBOOK_LOCK_CHECK(\n+      \"notebook_lock_check\",\n+      \"Counts of notebook availability due to locking, as observed by the caller\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57abcc3f43ca0f07ae33bfa3499c6b2b2bd3543d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODE2NjI4MA==", "bodyText": "Just a heads up: I'm about 75% sure that Stackdriver considers the Labels (tags) list to be part of the metric descriptor, so if you want to add another tag in the future, we have to either drop this one and replace it, or add a new one. I'll put this in the docs.", "url": "https://github.com/all-of-us/workbench/pull/2969#discussion_r368166280", "createdAt": "2020-01-17T22:42:43Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -703,6 +710,27 @@ private Boolean copyBlob(String bucketName, Blob b) {\n       }\n     }\n \n+    // If a lock is held by another user, log this to establish a rough estimate of how often\n+    // locked notebooks are encountered. Note that this only covers locks encountered from the\n+    // Workbench - any Jupyter UI-based lock detection does not touch this code path.\n+    String currentUsername = userProvider.get().getUsername();\n+    boolean notebookAvailable =\n+        response.getLockExpirationTime() == null\n+            || response.getLastLockedBy() == null\n+            || response.getLockExpirationTime() < clock.millis()\n+            || response.getLastLockedBy().equals(currentUsername);\n+    if (notebookAvailable) {\n+      log.info(\n+          String.format(\n+              \"user '%s' observed notebook locked by '%s'\",\n+              currentUsername, response.getLastLockedBy()));\n+    }\n+    monitoringService.recordBundle(\n+        MeasurementBundle.builder()\n+            .addEvent(GaugeMetric.NOTEBOOK_LOCK_CHECK)\n+            .addTag(MetricLabel.NOTEBOOK_AVAILABLE_TO_USER, Boolean.toString(notebookAvailable))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57abcc3f43ca0f07ae33bfa3499c6b2b2bd3543d"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f34b92bea887bfc78e23cf97a904ccff616eb9b", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/3f34b92bea887bfc78e23cf97a904ccff616eb9b", "committedDate": "2020-01-22T04:38:27Z", "message": "Log lock status"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3eb7c09d14729ae0da3635eb70cf1733a0334670", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/3eb7c09d14729ae0da3635eb70cf1733a0334670", "committedDate": "2020-01-18T00:42:04Z", "message": "Invert clause"}, "afterCommit": {"oid": "3f34b92bea887bfc78e23cf97a904ccff616eb9b", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/3f34b92bea887bfc78e23cf97a904ccff616eb9b", "committedDate": "2020-01-22T04:38:27Z", "message": "Log lock status"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3815, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}