{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NTY0NTU2", "number": 3887, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDoxMDo0NFrOEZD_qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNTozNTo0OVrOEboNaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NzE1MzA1OnYy", "diffSide": "RIGHT", "path": "api/src/bigquerytest/java/org/pmiops/workbench/api/DataSetControllerBQTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDoxMDo0NFrOHBqanw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDoxMDo0NFrOHBqanw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUwNTU2Nw==", "bodyText": "Mock would imply that we're mimicking behavior. Not sure it applies here.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private DbConceptSet createMockConceptSet(Domain domain, long workspaceId) {\n          \n          \n            \n              private DbConceptSet createConceptSet(Domain domain, long workspaceId) {", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471505567", "createdAt": "2020-08-17T14:10:44Z", "author": {"login": "freemabd"}, "path": "api/src/bigquerytest/java/org/pmiops/workbench/api/DataSetControllerBQTest.java", "diffHunk": "@@ -231,6 +220,14 @@ public void setUp() {\n     when(controller.generateRandomEightCharacterQualifier()).thenReturn(\"00000000\");\n   }\n \n+  private DbConceptSet createMockConceptSet(Domain domain, long workspaceId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NzE5NDYyOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapperTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDoyMDoyMVrOHBq0DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDoyMDoyMVrOHBq0DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUxMjA3Nw==", "bodyText": "nit: can we name the test method to match the mapper method\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void clientToDb() {\n          \n          \n            \n              public void clientToDbModel() {", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471512077", "createdAt": "2020-08-17T14:20:21Z", "author": {"login": "freemabd"}, "path": "api/src/test/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapperTest.java", "diffHunk": "@@ -69,4 +77,28 @@ public void dbModelToClient() {\n     assertThat(clientConceptSet.getCreator()).isEqualTo(dbConceptSet.getCreator().getUsername());\n     assertThat(clientConceptSet.getConcepts()).isNull();\n   }\n+\n+  @Test\n+  public void clientToDb() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NzI1NTQxOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDozMzo1N1rOHBrYwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDozMzo1N1rOHBrYwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUyMTQ3Mw==", "bodyText": "We should probably move this line into the createConceptSet method. It's not good practice to change object state in a validation method.", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471521473", "createdAt": "2020-08-17T14:33:57Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "diffHunk": "@@ -369,35 +375,11 @@ public ConceptSet toHydratedConceptSet(DbConceptSet dbConceptSet) {\n         conceptService.findAll(dbConceptSet.getConceptIds(), CONCEPT_NAME_ORDERING));\n   }\n \n-  private DbConceptSet fromClientConceptSet(CreateConceptSetRequest request, long workspaceId) {\n-    ConceptSet conceptSet = request.getConceptSet();\n-    Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n-    DbConceptSet dbConceptSet = new DbConceptSet();\n-    dbConceptSet.setDomainEnum(conceptSet.getDomain());\n-    if (conceptSet.getSurvey() != null) {\n-      dbConceptSet.setSurveysEnum(conceptSet.getSurvey());\n-    }\n-    if (dbConceptSet.getDomainEnum() == null) {\n-      throw new BadRequestException(\n-          \"Domain \" + conceptSet.getDomain() + \" is not allowed for concept sets\");\n-    }\n-    Optional.ofNullable(conceptSet.getEtag())\n-        .ifPresent(etag -> dbConceptSet.setVersion(Etags.toVersion(etag)));\n-    dbConceptSet.setDescription(conceptSet.getDescription());\n-    dbConceptSet.setName(conceptSet.getName());\n-    dbConceptSet.setCreator(userProvider.get());\n-    dbConceptSet.setWorkspaceId(workspaceId);\n-    dbConceptSet.setCreationTime(now);\n-    dbConceptSet.setLastModifiedTime(now);\n-    dbConceptSet.setVersion(INITIAL_VERSION);\n-    addConceptsToSet(dbConceptSet, request.getAddedIds());\n-    if (dbConceptSet.getConceptIds().size() > maxConceptsPerSet) {\n+  private DbConceptSet validateConceptSize(DbConceptSet requestDbConceptSet) {\n+    requestDbConceptSet.setVersion(INITIAL_VERSION);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NzMxMTUyOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDo0NzowMlrOHBr7OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDo0NzowMlrOHBr7OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzMDI5Nw==", "bodyText": "The validate method should really be validating the request object -> CreateConceptSetRequest#getAddedIds.  If the size check fails we fail fast instead of doing all the processing to convert it to a db object.", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471530297", "createdAt": "2020-08-17T14:47:02Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "diffHunk": "@@ -97,7 +96,14 @@\n     if (request.getAddedIds() == null || request.getAddedIds().size() == 0) {\n       throw new BadRequestException(\"Cannot create a concept set with no concepts\");\n     }\n-    DbConceptSet dbConceptSet = fromClientConceptSet(request, workspace.getWorkspaceId());\n+    DbConceptSet dbConceptSet =\n+        validateConceptSize(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NzMyMTYwOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDo0OToyNFrOHBsBbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDo0OToyNFrOHBsBbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzMTg4NQ==", "bodyText": "This can be removed. This is already happening in the ConceptSetController: \n  \n    \n      workbench/api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java\n    \n    \n         Line 100\n      in\n      4f10bae\n    \n    \n    \n    \n\n        \n          \n           validateConceptSize(", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471531885", "createdAt": "2020-08-17T14:49:24Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "diffHunk": "@@ -18,4 +34,80 @@\n   @Mapping(target = \"etag\", source = \"version\", qualifiedByName = \"cdrVersionToEtag\")\n   @Mapping(target = \"concepts\", ignore = true)\n   ConceptSet dbModelToClient(DbConceptSet source);\n+\n+  @Mapping(target = \"conceptSetId\", source = \"conceptSet.id\")\n+  @Mapping(target = \"domainEnum\", source = \"conceptSet.domain\")\n+  @Mapping(target = \"name\", source = \"conceptSet.name\")\n+  @Mapping(target = \"description\", source = \"conceptSet.description\")\n+  @Mapping(\n+      target = \"creationTime\",\n+      source = \"conceptSet.creationTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(\n+      target = \"lastModifiedTime\",\n+      source = \"conceptSet.lastModifiedTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(target = \"participantCount\", source = \"conceptSet.participantCount\")\n+  @Mapping(target = \"domain\", ignore = true)\n+  @Mapping(target = \"survey\", ignore = true)\n+  @Mapping(target = \"creator\", ignore = true)\n+  @Mapping(target = \"surveysEnum\", source = \"conceptSet.survey\")\n+  @Mapping(target = \"version\", source = \"conceptSet.etag\", qualifiedByName = \"etagToCdrVersion\")\n+  @Mapping(target = \"workspaceId\", ignore = true)\n+  @Mapping(target = \"conceptIds\", ignore = true)\n+  DbConceptSet clientToDbModel(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService);\n+\n+  @AfterMapping\n+  default void addConceptIdsToSet(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @MappingTarget DbConceptSet dbConceptSet,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService) {\n+    dbConceptSet.setWorkspaceId(workspaceId);\n+    dbConceptSet.setCreator(creator);\n+    Domain domainEnum = dbConceptSet.getDomainEnum();\n+    if (domainEnum == null) {\n+      throw new BadRequestException(\n+          \"Domain \" + source.getConceptSet().getDomain() + \" is not allowed for concept sets\");\n+    }\n+    Iterable<DbConcept> concepts = conceptService.findAll(source.getAddedIds());\n+    if (dbConceptSet.getConceptIds().size() > 1000) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NzMzNjU0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDo1Mjo1M1rOHBsKhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDo1Mjo1M1rOHBsKhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzNDIxMg==", "bodyText": "Can we rename this to something more descriptive. It's doing more than just adding adding concept ids. It's setting the workspaceId, domain as well as the participantCount", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471534212", "createdAt": "2020-08-17T14:52:53Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "diffHunk": "@@ -18,4 +34,80 @@\n   @Mapping(target = \"etag\", source = \"version\", qualifiedByName = \"cdrVersionToEtag\")\n   @Mapping(target = \"concepts\", ignore = true)\n   ConceptSet dbModelToClient(DbConceptSet source);\n+\n+  @Mapping(target = \"conceptSetId\", source = \"conceptSet.id\")\n+  @Mapping(target = \"domainEnum\", source = \"conceptSet.domain\")\n+  @Mapping(target = \"name\", source = \"conceptSet.name\")\n+  @Mapping(target = \"description\", source = \"conceptSet.description\")\n+  @Mapping(\n+      target = \"creationTime\",\n+      source = \"conceptSet.creationTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(\n+      target = \"lastModifiedTime\",\n+      source = \"conceptSet.lastModifiedTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(target = \"participantCount\", source = \"conceptSet.participantCount\")\n+  @Mapping(target = \"domain\", ignore = true)\n+  @Mapping(target = \"survey\", ignore = true)\n+  @Mapping(target = \"creator\", ignore = true)\n+  @Mapping(target = \"surveysEnum\", source = \"conceptSet.survey\")\n+  @Mapping(target = \"version\", source = \"conceptSet.etag\", qualifiedByName = \"etagToCdrVersion\")\n+  @Mapping(target = \"workspaceId\", ignore = true)\n+  @Mapping(target = \"conceptIds\", ignore = true)\n+  DbConceptSet clientToDbModel(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService);\n+\n+  @AfterMapping\n+  default void addConceptIdsToSet(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NzM1ODM5OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDo1ODowMFrOHBsX-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNDo1ODowMFrOHBsX-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTUzNzY1OQ==", "bodyText": "This should happen in the validate method in the ConceptSetController when validating the request object. We should not be throwing BadRequestExceptions from a mapper.", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471537659", "createdAt": "2020-08-17T14:58:00Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "diffHunk": "@@ -18,4 +34,80 @@\n   @Mapping(target = \"etag\", source = \"version\", qualifiedByName = \"cdrVersionToEtag\")\n   @Mapping(target = \"concepts\", ignore = true)\n   ConceptSet dbModelToClient(DbConceptSet source);\n+\n+  @Mapping(target = \"conceptSetId\", source = \"conceptSet.id\")\n+  @Mapping(target = \"domainEnum\", source = \"conceptSet.domain\")\n+  @Mapping(target = \"name\", source = \"conceptSet.name\")\n+  @Mapping(target = \"description\", source = \"conceptSet.description\")\n+  @Mapping(\n+      target = \"creationTime\",\n+      source = \"conceptSet.creationTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(\n+      target = \"lastModifiedTime\",\n+      source = \"conceptSet.lastModifiedTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(target = \"participantCount\", source = \"conceptSet.participantCount\")\n+  @Mapping(target = \"domain\", ignore = true)\n+  @Mapping(target = \"survey\", ignore = true)\n+  @Mapping(target = \"creator\", ignore = true)\n+  @Mapping(target = \"surveysEnum\", source = \"conceptSet.survey\")\n+  @Mapping(target = \"version\", source = \"conceptSet.etag\", qualifiedByName = \"etagToCdrVersion\")\n+  @Mapping(target = \"workspaceId\", ignore = true)\n+  @Mapping(target = \"conceptIds\", ignore = true)\n+  DbConceptSet clientToDbModel(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService);\n+\n+  @AfterMapping\n+  default void addConceptIdsToSet(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @MappingTarget DbConceptSet dbConceptSet,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService) {\n+    dbConceptSet.setWorkspaceId(workspaceId);\n+    dbConceptSet.setCreator(creator);\n+    Domain domainEnum = dbConceptSet.getDomainEnum();\n+    if (domainEnum == null) {\n+      throw new BadRequestException(\n+          \"Domain \" + source.getConceptSet().getDomain() + \" is not allowed for concept sets\");\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NzM5NDc2OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTowNjozNVrOHBsuUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTowNjozNVrOHBsuUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU0MzM3Ng==", "bodyText": "Not sure any of this code is necessary. A CreateConceptSetRequest has a ConceptSet which can have only 1 domain. If we really feel like we need to validate that the concept ids all belong in the same domain, then we should check this in the controller. Also, there is a much easier way to validate this, just query the concept table for domain count.", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r471543376", "createdAt": "2020-08-17T15:06:35Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "diffHunk": "@@ -18,4 +34,80 @@\n   @Mapping(target = \"etag\", source = \"version\", qualifiedByName = \"cdrVersionToEtag\")\n   @Mapping(target = \"concepts\", ignore = true)\n   ConceptSet dbModelToClient(DbConceptSet source);\n+\n+  @Mapping(target = \"conceptSetId\", source = \"conceptSet.id\")\n+  @Mapping(target = \"domainEnum\", source = \"conceptSet.domain\")\n+  @Mapping(target = \"name\", source = \"conceptSet.name\")\n+  @Mapping(target = \"description\", source = \"conceptSet.description\")\n+  @Mapping(\n+      target = \"creationTime\",\n+      source = \"conceptSet.creationTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(\n+      target = \"lastModifiedTime\",\n+      source = \"conceptSet.lastModifiedTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(target = \"participantCount\", source = \"conceptSet.participantCount\")\n+  @Mapping(target = \"domain\", ignore = true)\n+  @Mapping(target = \"survey\", ignore = true)\n+  @Mapping(target = \"creator\", ignore = true)\n+  @Mapping(target = \"surveysEnum\", source = \"conceptSet.survey\")\n+  @Mapping(target = \"version\", source = \"conceptSet.etag\", qualifiedByName = \"etagToCdrVersion\")\n+  @Mapping(target = \"workspaceId\", ignore = true)\n+  @Mapping(target = \"conceptIds\", ignore = true)\n+  DbConceptSet clientToDbModel(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService);\n+\n+  @AfterMapping\n+  default void addConceptIdsToSet(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @MappingTarget DbConceptSet dbConceptSet,\n+      @Context ConceptService conceptService,\n+      @Context ConceptBigQueryService conceptBigQueryService) {\n+    dbConceptSet.setWorkspaceId(workspaceId);\n+    dbConceptSet.setCreator(creator);\n+    Domain domainEnum = dbConceptSet.getDomainEnum();\n+    if (domainEnum == null) {\n+      throw new BadRequestException(\n+          \"Domain \" + source.getConceptSet().getDomain() + \" is not allowed for concept sets\");\n+    }\n+    Iterable<DbConcept> concepts = conceptService.findAll(source.getAddedIds());\n+    if (dbConceptSet.getConceptIds().size() > 1000) {\n+      throw new BadRequestException(\"Exceeded 1000 in concept set\");\n+    }\n+    List<DbConcept> mismatchedConcepts =\n+        ImmutableList.copyOf(concepts).stream()\n+            .filter(concept -> !concept.getConceptClassId().equals(\"Question\"))\n+            .filter(\n+                concept -> {\n+                  Domain domain =\n+                      Domain.PHYSICALMEASUREMENT.equals(domainEnum)\n+                          ? Domain.PHYSICALMEASUREMENT\n+                          : DbStorageEnums.domainIdToDomain(concept.getDomainId());\n+                  return !domainEnum.equals(domain);\n+                })\n+            .collect(Collectors.toList());\n+    if (!mismatchedConcepts.isEmpty()) {\n+      String mismatchedConceptIds =\n+          Joiner.on(\", \")\n+              .join(\n+                  mismatchedConcepts.stream()\n+                      .map(DbConcept::getConceptId)\n+                      .collect(Collectors.toList()));\n+      throw new BadRequestException(\n+          String.format(\"Concepts [%s] are not in domain %s\", mismatchedConceptIds, domainEnum));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f10baed985f927664e17d85e540f9bfb141f2e3"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3Mzc1MzQ5OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNDozMzozOVrOHFnzrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNDozMzozOVrOHFnzrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY1NzEzMw==", "bodyText": "Please remove duplicate line of code\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                dbConceptSet.getConceptIds().addAll(source.getAddedIds());\n          \n          \n            \n                String omopTable = BigQueryTableInfo.getTableName(source.getConceptSet().getDomain());\n          \n          \n            \n                dbConceptSet.setParticipantCount(\n          \n          \n            \n                    conceptBigQueryService.getParticipantCountForConcepts(\n          \n          \n            \n                        dbConceptSet.getDomainEnum(), omopTable, dbConceptSet.getConceptIds()));\n          \n          \n            \n                dbConceptSet.getConceptIds().addAll(source.getAddedIds());\n          \n          \n            \n                dbConceptSet.getConceptIds().addAll(source.getAddedIds());\n          \n          \n            \n                String omopTable = BigQueryTableInfo.getTableName(source.getConceptSet().getDomain());\n          \n          \n            \n                dbConceptSet.setParticipantCount(\n          \n          \n            \n                    conceptBigQueryService.getParticipantCountForConcepts(\n          \n          \n            \n                        dbConceptSet.getDomainEnum(), omopTable, dbConceptSet.getConceptIds()));", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r475657133", "createdAt": "2020-08-24T14:33:39Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/conceptset/mapper/ConceptSetMapper.java", "diffHunk": "@@ -18,4 +25,47 @@\n   @Mapping(target = \"etag\", source = \"version\", qualifiedByName = \"cdrVersionToEtag\")\n   @Mapping(target = \"concepts\", ignore = true)\n   ConceptSet dbModelToClient(DbConceptSet source);\n+\n+  @Mapping(target = \"conceptSetId\", source = \"conceptSet.id\")\n+  @Mapping(target = \"domainEnum\", source = \"conceptSet.domain\")\n+  @Mapping(target = \"name\", source = \"conceptSet.name\")\n+  @Mapping(target = \"description\", source = \"conceptSet.description\")\n+  @Mapping(\n+      target = \"creationTime\",\n+      source = \"conceptSet.creationTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(\n+      target = \"lastModifiedTime\",\n+      source = \"conceptSet.lastModifiedTime\",\n+      qualifiedByName = \"toTimestampCurrentIfNull\")\n+  @Mapping(target = \"participantCount\", source = \"conceptSet.participantCount\")\n+  @Mapping(target = \"domain\", ignore = true)\n+  @Mapping(target = \"survey\", ignore = true)\n+  @Mapping(target = \"creator\", ignore = true)\n+  @Mapping(target = \"surveysEnum\", source = \"conceptSet.survey\")\n+  @Mapping(target = \"version\", source = \"conceptSet.etag\", qualifiedByName = \"etagToCdrVersion\")\n+  @Mapping(target = \"workspaceId\", ignore = true)\n+  @Mapping(target = \"conceptIds\", ignore = true)\n+  DbConceptSet clientToDbModel(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @Context ConceptBigQueryService conceptBigQueryService);\n+\n+  @AfterMapping\n+  default void updateConceptSetFields(\n+      CreateConceptSetRequest source,\n+      @Context Long workspaceId,\n+      @Context DbUser creator,\n+      @MappingTarget DbConceptSet dbConceptSet,\n+      @Context ConceptBigQueryService conceptBigQueryService) {\n+    dbConceptSet.setWorkspaceId(workspaceId);\n+    dbConceptSet.setCreator(creator);\n+    dbConceptSet.getConceptIds().addAll(source.getAddedIds());\n+    String omopTable = BigQueryTableInfo.getTableName(source.getConceptSet().getDomain());\n+    dbConceptSet.setParticipantCount(\n+        conceptBigQueryService.getParticipantCountForConcepts(\n+            dbConceptSet.getDomainEnum(), omopTable, dbConceptSet.getConceptIds()));\n+    dbConceptSet.getConceptIds().addAll(source.getAddedIds());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac16d5ac5cfbf2c085e22f8c5ed3e19303d68c14"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3Mzk0OTk1OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNToxMTozMlrOHFpuvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNToxMTozMlrOHFpuvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY4ODYzNg==", "bodyText": "When renaming a concept set it calls this method and conceptSet.getConcepts throws a null pointer exception. Please wrap this in a null/empty check\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                validateConceptSet(\n          \n          \n            \n                    dbConceptSet,\n          \n          \n            \n                    conceptSet.getConcepts().stream()\n          \n          \n            \n                        .map(concept -> concept.getConceptId())\n          \n          \n            \n                        .collect(Collectors.toList()));\n          \n          \n            \n               if (!CollectionUtils.isEmpty(conceptSet.getConcepts())) {\n          \n          \n            \n                  validateConceptSet(\n          \n          \n            \n                      dbConceptSet,\n          \n          \n            \n                      conceptSet.getConcepts().stream()\n          \n          \n            \n                          .map(concept -> concept.getConceptId())\n          \n          \n            \n                          .collect(Collectors.toList()));\n          \n          \n            \n                }", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r475688636", "createdAt": "2020-08-24T15:11:32Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "diffHunk": "@@ -369,35 +317,79 @@ public ConceptSet toHydratedConceptSet(DbConceptSet dbConceptSet) {\n         conceptService.findAll(dbConceptSet.getConceptIds(), CONCEPT_NAME_ORDERING));\n   }\n \n-  private DbConceptSet fromClientConceptSet(CreateConceptSetRequest request, long workspaceId) {\n-    ConceptSet conceptSet = request.getConceptSet();\n-    Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n-    DbConceptSet dbConceptSet = new DbConceptSet();\n-    dbConceptSet.setDomainEnum(conceptSet.getDomain());\n-    if (conceptSet.getSurvey() != null) {\n-      dbConceptSet.setSurveysEnum(conceptSet.getSurvey());\n+  private void validateAndUpdateDbConceptSet(DbConceptSet dbConceptSet, ConceptSet conceptSet) {\n+    if (Strings.isNullOrEmpty(conceptSet.getEtag())) {\n+      throw new BadRequestException(\"missing required update field 'etag'\");\n     }\n-    if (dbConceptSet.getDomainEnum() == null) {\n-      throw new BadRequestException(\n-          \"Domain \" + conceptSet.getDomain() + \" is not allowed for concept sets\");\n+    int version = Etags.toVersion(conceptSet.getEtag());\n+    if (dbConceptSet.getVersion() != version) {\n+      throw new ConflictException(\"Attempted to modify outdated concept set version\");\n     }\n-    Optional.ofNullable(conceptSet.getEtag())\n-        .ifPresent(etag -> dbConceptSet.setVersion(Etags.toVersion(etag)));\n-    dbConceptSet.setDescription(conceptSet.getDescription());\n-    dbConceptSet.setName(conceptSet.getName());\n-    dbConceptSet.setCreator(userProvider.get());\n-    dbConceptSet.setWorkspaceId(workspaceId);\n-    dbConceptSet.setCreationTime(now);\n-    dbConceptSet.setLastModifiedTime(now);\n-    dbConceptSet.setVersion(INITIAL_VERSION);\n-    addConceptsToSet(dbConceptSet, request.getAddedIds());\n+    if (conceptSet.getName() != null) {\n+      dbConceptSet.setName(conceptSet.getName());\n+    }\n+    if (conceptSet.getDescription() != null) {\n+      dbConceptSet.setDescription(conceptSet.getDescription());\n+    }\n+    if (conceptSet.getDomain() != null && conceptSet.getDomain() != dbConceptSet.getDomainEnum()) {\n+      throw new BadRequestException(\"Cannot modify the domain of an existing concept set\");\n+    }\n+    validateConceptSet(\n+        dbConceptSet,\n+        conceptSet.getConcepts().stream()\n+            .map(concept -> concept.getConceptId())\n+            .collect(Collectors.toList()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac16d5ac5cfbf2c085e22f8c5ed3e19303d68c14"}, "originalPosition": 139}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3NDA1ODAzOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNTozNTo0OVrOHFqxQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNTozNTo0OVrOHFqxQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcwNTY2NQ==", "bodyText": "Think we should use CollectionUtils.isEmpty here. It does a null and empty check. If the code changes and we passed an empty list during the rename we would still throw a BadRequestException in that case and rename would fail\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if (conceptSet.getConcepts() != null) {\n          \n          \n            \n                if (!CollectionUtils.isEmpty(conceptSet.getConcepts())) {", "url": "https://github.com/all-of-us/workbench/pull/3887#discussion_r475705665", "createdAt": "2020-08-24T15:35:49Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/ConceptSetsController.java", "diffHunk": "@@ -369,35 +317,82 @@ public ConceptSet toHydratedConceptSet(DbConceptSet dbConceptSet) {\n         conceptService.findAll(dbConceptSet.getConceptIds(), CONCEPT_NAME_ORDERING));\n   }\n \n-  private DbConceptSet fromClientConceptSet(CreateConceptSetRequest request, long workspaceId) {\n-    ConceptSet conceptSet = request.getConceptSet();\n-    Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n-    DbConceptSet dbConceptSet = new DbConceptSet();\n-    dbConceptSet.setDomainEnum(conceptSet.getDomain());\n-    if (conceptSet.getSurvey() != null) {\n-      dbConceptSet.setSurveysEnum(conceptSet.getSurvey());\n+  private void validateAndUpdateDbConceptSet(DbConceptSet dbConceptSet, ConceptSet conceptSet) {\n+    if (Strings.isNullOrEmpty(conceptSet.getEtag())) {\n+      throw new BadRequestException(\"missing required update field 'etag'\");\n     }\n-    if (dbConceptSet.getDomainEnum() == null) {\n-      throw new BadRequestException(\n-          \"Domain \" + conceptSet.getDomain() + \" is not allowed for concept sets\");\n+    int version = Etags.toVersion(conceptSet.getEtag());\n+    if (dbConceptSet.getVersion() != version) {\n+      throw new ConflictException(\"Attempted to modify outdated concept set version\");\n     }\n-    Optional.ofNullable(conceptSet.getEtag())\n-        .ifPresent(etag -> dbConceptSet.setVersion(Etags.toVersion(etag)));\n-    dbConceptSet.setDescription(conceptSet.getDescription());\n-    dbConceptSet.setName(conceptSet.getName());\n-    dbConceptSet.setCreator(userProvider.get());\n-    dbConceptSet.setWorkspaceId(workspaceId);\n-    dbConceptSet.setCreationTime(now);\n-    dbConceptSet.setLastModifiedTime(now);\n-    dbConceptSet.setVersion(INITIAL_VERSION);\n-    addConceptsToSet(dbConceptSet, request.getAddedIds());\n+    if (conceptSet.getName() != null) {\n+      dbConceptSet.setName(conceptSet.getName());\n+    }\n+    if (conceptSet.getDescription() != null) {\n+      dbConceptSet.setDescription(conceptSet.getDescription());\n+    }\n+    if (conceptSet.getDomain() != null && conceptSet.getDomain() != dbConceptSet.getDomainEnum()) {\n+      throw new BadRequestException(\"Cannot modify the domain of an existing concept set\");\n+    }\n+    // In case of rename ConceptDet does not have concepts\n+    if (conceptSet.getConcepts() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5aac657c4eda1c2ea3523558f9d5523b7e70ed9"}, "originalPosition": 136}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2277, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}