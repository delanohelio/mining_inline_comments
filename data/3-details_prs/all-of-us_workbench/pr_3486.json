{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5NjY1MTQ1", "number": 3486, "title": "[risk=low]Enforce DUCC version for registered tier", "bodyText": "Description:\nWhen we check the user's access level (on every 2FA sync cron run, as well as triggered by certain events) enforce that the user has signed the current version of the Data User Code of Conduct (DUCC)\nNot renaming any \"DUA\" code to DUCC here.  Filed https://precisionmedicineinitiative.atlassian.net/browse/RW-4838\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-04-27T18:19:51Z", "url": "https://github.com/all-of-us/workbench/pull/3486", "merged": true, "mergeCommit": {"oid": "cb450507cbec330841825701bb09c6acefd244dc"}, "closed": true, "closedAt": "2020-04-27T19:01:09Z", "author": {"login": "jmthibault79"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbx1FVAH2gAyNDA5NjY1MTQ1OmYzMjljMDczMmM4MGQ2NGFhNDRiMzE3NGM3ZjMxMTA4YmUzM2ZmNTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbz5-NgFqTQwMTIzMzAwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f329c0732c80d64aa44b3174c7f31108be33ff54", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/f329c0732c80d64aa44b3174c7f31108be33ff54", "committedDate": "2020-04-27T16:25:22Z", "message": "WIP enforce DUA version for registration state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcadeebf0d7e68e34c178a3890e86738193e538e", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/bcadeebf0d7e68e34c178a3890e86738193e538e", "committedDate": "2020-04-27T17:21:26Z", "message": "test for DUA version enforcement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72cffd42d0249d6faee0c013ae7156be12677441", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/72cffd42d0249d6faee0c013ae7156be12677441", "committedDate": "2020-04-27T18:10:45Z", "message": "test fix and null check for user.getDataUseAgreementSignedVersion()"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjE2MDMx", "url": "https://github.com/all-of-us/workbench/pull/3486#pullrequestreview-401216031", "createdAt": "2020-04-27T18:27:05Z", "commit": {"oid": "72cffd42d0249d6faee0c013ae7156be12677441"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODoyNzowNlrOGMxn6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxODoyNzowNlrOGMxn6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjA0OTEzMA==", "bodyText": "comparing Integer to int involves unboxing, and thus a potential NPE", "url": "https://github.com/all-of-us/workbench/pull/3486#discussion_r416049130", "createdAt": "2020-04-27T18:27:06Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/db/dao/UserServiceImpl.java", "diffHunk": "@@ -237,10 +237,16 @@ private void addToRegisteredTierGroupIdempotent(DbUser user) {\n   }\n \n   private boolean shouldUserBeRegistered(DbUser user) {\n-    boolean dataUseAgreementCompliant =\n-        user.getDataUseAgreementCompletionTime() != null\n-            || user.getDataUseAgreementBypassTime() != null\n-            || !configProvider.get().access.enableDataUseAgreement;\n+    boolean dataUseAgreementCompliant = false;\n+    if (user.getDataUseAgreementBypassTime() != null\n+        || !configProvider.get().access.enableDataUseAgreement) {\n+      // Data use agreement version may be ignored, since it's bypassed on the user or env level.\n+      dataUseAgreementCompliant = true;\n+    } else if (user.getDataUseAgreementSignedVersion() != null\n+        && user.getDataUseAgreementSignedVersion() == getCurrentDuccVersion()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72cffd42d0249d6faee0c013ae7156be12677441"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjE3Mzg0", "url": "https://github.com/all-of-us/workbench/pull/3486#pullrequestreview-401217384", "createdAt": "2020-04-27T18:28:50Z", "commit": {"oid": "72cffd42d0249d6faee0c013ae7156be12677441"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMjMzMDA3", "url": "https://github.com/all-of-us/workbench/pull/3486#pullrequestreview-401233007", "createdAt": "2020-04-27T18:50:31Z", "commit": {"oid": "72cffd42d0249d6faee0c013ae7156be12677441"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4897, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}