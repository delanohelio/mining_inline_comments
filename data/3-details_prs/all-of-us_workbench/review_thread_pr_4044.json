{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxMTEwMDgx", "number": 4044, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMToyNjoxN1rOEmydMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMTozMjo1NVrOEnOhug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MTA4MDE3OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMToyNjoxN1rOHXBj-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNzo0NDoyOVrOHXl1vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwNDg4OA==", "bodyText": "Shouldn't this check be after the stream/filter?", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r493904888", "createdAt": "2020-09-23T21:26:17Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +175,51 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      List<LeonardoListRuntimeResponse> runtimes =\n+          leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace);\n+      if (runtimes.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f76535037b039060f38087b0ff729433b93a7ad"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQ5OTI2MQ==", "bodyText": "I put it here since I'm not filtering anything but I suppose I can just check for the mostRecentRuntime optional and that should work.", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r494499261", "createdAt": "2020-09-24T17:44:29Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +175,51 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      List<LeonardoListRuntimeResponse> runtimes =\n+          leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace);\n+      if (runtimes.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwNDg4OA=="}, "originalCommit": {"oid": "7f76535037b039060f38087b0ff729433b93a7ad"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MTA4NTQyOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClient.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMToyODowM1rOHXBnFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMToyODowM1rOHXBnFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwNTY4Ng==", "bodyText": "I would clarify that this includes deleted runtimes, e.g. listRuntimesByProjectWithDeleted(); or else plumb the boolean through. Distinction is otherwise unclear between these two methods", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r493905686", "createdAt": "2020-09-23T21:28:03Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClient.java", "diffHunk": "@@ -16,6 +16,8 @@\n   /** lists all notebook runtimes as the appengine SA, to be used only for admin operations */\n   List<LeonardoListRuntimeResponse> listRuntimesByProjectAsService(String googleProject);\n \n+  List<LeonardoListRuntimeResponse> listRuntimesByProject(String googleProject);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f76535037b039060f38087b0ff729433b93a7ad"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MTA5NjAxOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMTozMTozM1rOHXBteQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxODo0MjozNFrOHXoD3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwNzMyMQ==", "bodyText": "I don't know if there's an elegant way of doing this, but if we encounter an old and invalid runtime, it would be nice to bail here and just return a 404. I'm not sure if we can expect that manifest as an NPE out of the mapper, or perhaps as a malformed runtime.", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r493907321", "createdAt": "2020-09-23T21:31:33Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +175,51 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      List<LeonardoListRuntimeResponse> runtimes =\n+          leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace);\n+      if (runtimes.isEmpty()) {\n+        throw e;\n+      }\n+\n+      LeonardoListRuntimeResponse mostRecentRuntime =\n+          runtimes.stream()\n+              .sorted(\n+                  (a, b) ->\n+                      b.getAuditInfo()\n+                          .getCreatedDate()\n+                          .compareTo(a.getAuditInfo().getCreatedDate()))\n+              .findFirst()\n+              .get();\n+\n+      final String OVERRIDE_LABEL =\n+          LeonardoMapper.RUNTIME_CONFIGURATION_TYPE_ENUM_TO_STORAGE_MAP.get(\n+              RuntimeConfigurationType.USEROVERRIDE);\n+      Map<String, String> runtimeLabels = (Map<String, String>) mostRecentRuntime.getLabels();\n+      if (runtimeLabels != null\n+          && OVERRIDE_LABEL.equals(runtimeLabels.get(LeonardoMapper.RUNTIME_LABEL_AOU_CONFIG))) {\n+        Runtime runtime = leonardoMapper.toApiRuntime(mostRecentRuntime);\n+        if (!runtime.getStatus().equals(RuntimeStatus.DELETED)) {\n+          log.warning(\n+              \"Runtimes returned from ListRuntimes should be DELETED but found \"\n+                  + runtime.getStatus());\n+        }\n+\n+        return ResponseEntity.ok(\n+            leonardoMapper.toApiRuntime(mostRecentRuntime).status(RuntimeStatus.DELETED));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f76535037b039060f38087b0ff729433b93a7ad"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUzNTY0NA==", "bodyText": "I can just catch RuntimeExceptions for now? it will cover some cases like invalid configuration types. It should also continue to work as we add more validation checks.\nI'm not too worried about catching exceptions over eagerly either. I think anything that throws here is fine to 404.", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r494535644", "createdAt": "2020-09-24T18:42:34Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +175,51 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      List<LeonardoListRuntimeResponse> runtimes =\n+          leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace);\n+      if (runtimes.isEmpty()) {\n+        throw e;\n+      }\n+\n+      LeonardoListRuntimeResponse mostRecentRuntime =\n+          runtimes.stream()\n+              .sorted(\n+                  (a, b) ->\n+                      b.getAuditInfo()\n+                          .getCreatedDate()\n+                          .compareTo(a.getAuditInfo().getCreatedDate()))\n+              .findFirst()\n+              .get();\n+\n+      final String OVERRIDE_LABEL =\n+          LeonardoMapper.RUNTIME_CONFIGURATION_TYPE_ENUM_TO_STORAGE_MAP.get(\n+              RuntimeConfigurationType.USEROVERRIDE);\n+      Map<String, String> runtimeLabels = (Map<String, String>) mostRecentRuntime.getLabels();\n+      if (runtimeLabels != null\n+          && OVERRIDE_LABEL.equals(runtimeLabels.get(LeonardoMapper.RUNTIME_LABEL_AOU_CONFIG))) {\n+        Runtime runtime = leonardoMapper.toApiRuntime(mostRecentRuntime);\n+        if (!runtime.getStatus().equals(RuntimeStatus.DELETED)) {\n+          log.warning(\n+              \"Runtimes returned from ListRuntimes should be DELETED but found \"\n+                  + runtime.getStatus());\n+        }\n+\n+        return ResponseEntity.ok(\n+            leonardoMapper.toApiRuntime(mostRecentRuntime).status(RuntimeStatus.DELETED));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwNzMyMQ=="}, "originalCommit": {"oid": "7f76535037b039060f38087b0ff729433b93a7ad"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MTA5OTI0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMTozMjo0MlrOHXBvTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxODozMDo1OVrOHXnmWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwNzc5MQ==", "bodyText": "opt_nit: should there just be mapper methods between the enum and storage string ? Feels like this could provide better isolation", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r493907791", "createdAt": "2020-09-23T21:32:42Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +175,51 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      List<LeonardoListRuntimeResponse> runtimes =\n+          leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace);\n+      if (runtimes.isEmpty()) {\n+        throw e;\n+      }\n+\n+      LeonardoListRuntimeResponse mostRecentRuntime =\n+          runtimes.stream()\n+              .sorted(\n+                  (a, b) ->\n+                      b.getAuditInfo()\n+                          .getCreatedDate()\n+                          .compareTo(a.getAuditInfo().getCreatedDate()))\n+              .findFirst()\n+              .get();\n+\n+      final String OVERRIDE_LABEL =\n+          LeonardoMapper.RUNTIME_CONFIGURATION_TYPE_ENUM_TO_STORAGE_MAP.get(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f76535037b039060f38087b0ff729433b93a7ad"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDUyODA4OA==", "bodyText": "hmm, the main reason I didn't do a mapper method is b/c Mapstruct wouldn't be able to pick it up anyways. I think the way it is now is fine but we can refactor later if we need the isolation.", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r494528088", "createdAt": "2020-09-24T18:30:59Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +175,51 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      List<LeonardoListRuntimeResponse> runtimes =\n+          leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace);\n+      if (runtimes.isEmpty()) {\n+        throw e;\n+      }\n+\n+      LeonardoListRuntimeResponse mostRecentRuntime =\n+          runtimes.stream()\n+              .sorted(\n+                  (a, b) ->\n+                      b.getAuditInfo()\n+                          .getCreatedDate()\n+                          .compareTo(a.getAuditInfo().getCreatedDate()))\n+              .findFirst()\n+              .get();\n+\n+      final String OVERRIDE_LABEL =\n+          LeonardoMapper.RUNTIME_CONFIGURATION_TYPE_ENUM_TO_STORAGE_MAP.get(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwNzc5MQ=="}, "originalCommit": {"oid": "7f76535037b039060f38087b0ff729433b93a7ad"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MTEwMzQwOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMTozNDoxMlrOHXBx0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMTozNDoxMlrOHXBx0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwODQzNQ==", "bodyText": "nit: would put constant first", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r493908435", "createdAt": "2020-09-23T21:34:12Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +175,51 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      List<LeonardoListRuntimeResponse> runtimes =\n+          leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace);\n+      if (runtimes.isEmpty()) {\n+        throw e;\n+      }\n+\n+      LeonardoListRuntimeResponse mostRecentRuntime =\n+          runtimes.stream()\n+              .sorted(\n+                  (a, b) ->\n+                      b.getAuditInfo()\n+                          .getCreatedDate()\n+                          .compareTo(a.getAuditInfo().getCreatedDate()))\n+              .findFirst()\n+              .get();\n+\n+      final String OVERRIDE_LABEL =\n+          LeonardoMapper.RUNTIME_CONFIGURATION_TYPE_ENUM_TO_STORAGE_MAP.get(\n+              RuntimeConfigurationType.USEROVERRIDE);\n+      Map<String, String> runtimeLabels = (Map<String, String>) mostRecentRuntime.getLabels();\n+      if (runtimeLabels != null\n+          && OVERRIDE_LABEL.equals(runtimeLabels.get(LeonardoMapper.RUNTIME_LABEL_AOU_CONFIG))) {\n+        Runtime runtime = leonardoMapper.toApiRuntime(mostRecentRuntime);\n+        if (!runtime.getStatus().equals(RuntimeStatus.DELETED)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f76535037b039060f38087b0ff729433b93a7ad"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MTExMTk3OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMTozNzoxNVrOHXB29w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMTozNzoxNVrOHXB29w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkwOTc1MQ==", "bodyText": "It's possible there are some degenerate entries missing this  - I would make this sort method immune to null auditInfo and createdDate (treat these as older)", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r493909751", "createdAt": "2020-09-23T21:37:15Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +175,51 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      List<LeonardoListRuntimeResponse> runtimes =\n+          leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace);\n+      if (runtimes.isEmpty()) {\n+        throw e;\n+      }\n+\n+      LeonardoListRuntimeResponse mostRecentRuntime =\n+          runtimes.stream()\n+              .sorted(\n+                  (a, b) ->\n+                      b.getAuditInfo()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f76535037b039060f38087b0ff729433b93a7ad"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5MTExNTU0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/utils/mappers/LeonardoMapper.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMTozODozN1rOHXB5GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxOTowNjo0NFrOHXo4bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkxMDI5Ng==", "bodyText": "What's the status on this? Is it intentionally omitted by Leo?", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r493910296", "createdAt": "2020-09-23T21:38:37Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/utils/mappers/LeonardoMapper.java", "diffHunk": "@@ -59,27 +72,55 @@ ListRuntimeResponse toApiListRuntimeResponse(\n   @Mapping(target = \"dataprocConfig\", ignore = true)\n   Runtime toApiRuntime(LeonardoGetRuntimeResponse runtime);\n \n+  @Mapping(target = \"createdDate\", source = \"auditInfo.createdDate\")\n+  @Mapping(target = \"autopauseThreshold\", ignore = true)\n+  @Mapping(target = \"toolDockerImage\", ignore = true)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f76535037b039060f38087b0ff729433b93a7ad"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU0OTEwMg==", "bodyText": "I verified that it is not actually sent through in the JSON response. Just shot off a message to the Leo team about it.", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r494549102", "createdAt": "2020-09-24T19:06:44Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/utils/mappers/LeonardoMapper.java", "diffHunk": "@@ -59,27 +72,55 @@ ListRuntimeResponse toApiListRuntimeResponse(\n   @Mapping(target = \"dataprocConfig\", ignore = true)\n   Runtime toApiRuntime(LeonardoGetRuntimeResponse runtime);\n \n+  @Mapping(target = \"createdDate\", source = \"auditInfo.createdDate\")\n+  @Mapping(target = \"autopauseThreshold\", ignore = true)\n+  @Mapping(target = \"toolDockerImage\", ignore = true)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzkxMDI5Ng=="}, "originalCommit": {"oid": "7f76535037b039060f38087b0ff729433b93a7ad"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTI3MDE5OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxOToyNjoxOVrOHXpgKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxOToyNjoxOVrOHXpgKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU1OTI3NQ==", "bodyText": "This should at least be logged", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r494559275", "createdAt": "2020-09-24T19:26:19Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +176,69 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      try {\n+        return ResponseEntity.ok(getOverrideFromListRuntimes(workspaceNamespace));\n+      } catch (RuntimeException e2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89facb2814c95dfa5edaac135e3b51274cfb3039"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTI3Mzk1OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxOToyNzoyNVrOHXpiZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxOToyNzoyNVrOHXpiZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU1OTg0Ng==", "bodyText": "I would scope this as tightly as possible, i.e. directly around the mapper call - RuntimeException catch-alls are problematic in that they may mask programming errors.", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r494559846", "createdAt": "2020-09-24T19:27:25Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +176,69 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      try {\n+        return ResponseEntity.ok(getOverrideFromListRuntimes(workspaceNamespace));\n+      } catch (RuntimeException e2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89facb2814c95dfa5edaac135e3b51274cfb3039"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTI4Mzk0OnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/api/RuntimeControllerTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxOTozMDoyN1rOHXpoyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMzo1Njo0NlrOHYEu8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2MTQ4Mw==", "bodyText": "opt_nit: I would just exercise the LeonardoMapper here. If you're also trying to cover conversion testing here, probably I'd split that out into a LeonardoMapperTest", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r494561483", "createdAt": "2020-09-24T19:30:27Z", "author": {"login": "calbach"}, "path": "api/src/test/java/org/pmiops/workbench/api/RuntimeControllerTest.java", "diffHunk": "@@ -247,17 +255,25 @@ public void setUp() {\n \n     String createdDate = Date.fromYearMonthDay(1988, 12, 26).toString();\n \n-    DataprocConfig dataprocConfig =\n+    dataprocConfig =\n         new DataprocConfig()\n             .numberOfWorkers(0)\n             .masterMachineType(\"n1-standard-4\")\n             .masterDiskSize(50);\n \n-    LinkedTreeMap<String, Object> dataProcConfigObj = new LinkedTreeMap<>();\n-    dataProcConfigObj.put(\"cloudService\", \"DATAPROC\");\n-    dataProcConfigObj.put(\"numberOfWorkers\", 0);\n-    dataProcConfigObj.put(\"masterMachineType\", \"n1-standard-4\");\n-    dataProcConfigObj.put(\"masterDiskSize\", 50.0);\n+    dataprocConfigObj = new LinkedTreeMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89facb2814c95dfa5edaac135e3b51274cfb3039"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAwNTQyNw==", "bodyText": "wasn't sure if this is what you had in mind but I could only use LeonardoMapper to map dataprocConfigObj to dataprocConfig. Not as ideal as going the other direction but I also don't have that code implemented right now since we're not doing Runtime -> Leonardo mapping atm.", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r495005427", "createdAt": "2020-09-25T13:56:46Z", "author": {"login": "ericsong"}, "path": "api/src/test/java/org/pmiops/workbench/api/RuntimeControllerTest.java", "diffHunk": "@@ -247,17 +255,25 @@ public void setUp() {\n \n     String createdDate = Date.fromYearMonthDay(1988, 12, 26).toString();\n \n-    DataprocConfig dataprocConfig =\n+    dataprocConfig =\n         new DataprocConfig()\n             .numberOfWorkers(0)\n             .masterMachineType(\"n1-standard-4\")\n             .masterDiskSize(50);\n \n-    LinkedTreeMap<String, Object> dataProcConfigObj = new LinkedTreeMap<>();\n-    dataProcConfigObj.put(\"cloudService\", \"DATAPROC\");\n-    dataProcConfigObj.put(\"numberOfWorkers\", 0);\n-    dataProcConfigObj.put(\"masterMachineType\", \"n1-standard-4\");\n-    dataProcConfigObj.put(\"masterDiskSize\", 50.0);\n+    dataprocConfigObj = new LinkedTreeMap<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2MTQ4Mw=="}, "originalCommit": {"oid": "89facb2814c95dfa5edaac135e3b51274cfb3039"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTI4OTc2OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/utils/mappers/LeonardoMapper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxOTozMjowNVrOHXpsYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxOTozMjowNVrOHXpsYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDU2MjQwMA==", "bodyText": "Please add a comment here. I believe this logic exists because older runtimes without the label can only be default dataproc configs.", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r494562400", "createdAt": "2020-09-24T19:32:05Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/utils/mappers/LeonardoMapper.java", "diffHunk": "@@ -59,27 +72,55 @@ ListRuntimeResponse toApiListRuntimeResponse(\n   @Mapping(target = \"dataprocConfig\", ignore = true)\n   Runtime toApiRuntime(LeonardoGetRuntimeResponse runtime);\n \n+  @Mapping(target = \"createdDate\", source = \"auditInfo.createdDate\")\n+  @Mapping(target = \"autopauseThreshold\", ignore = true)\n+  @Mapping(target = \"toolDockerImage\", ignore = true)\n+  @Mapping(target = \"configurationType\", ignore = true)\n+  @Mapping(target = \"gceConfig\", ignore = true)\n+  @Mapping(target = \"dataprocConfig\", ignore = true)\n+  Runtime toApiRuntime(LeonardoListRuntimeResponse runtime);\n+\n   @AfterMapping\n-  default void mapRuntimeConfig(\n+  default void getRuntimeAfterMapper(\n       @MappingTarget Runtime runtime, LeonardoGetRuntimeResponse leonardoGetRuntimeResponse) {\n+    mapLabels(runtime, (Map<String, String>) leonardoGetRuntimeResponse.getLabels());\n+    mapRuntimeConfig(runtime, leonardoGetRuntimeResponse.getRuntimeConfig());\n+  }\n+\n+  @AfterMapping\n+  default void listRuntimeAfterMapper(\n+      @MappingTarget Runtime runtime, LeonardoListRuntimeResponse leonardoListRuntimeResponse) {\n+    mapLabels(runtime, (Map<String, String>) leonardoListRuntimeResponse.getLabels());\n+    mapRuntimeConfig(runtime, leonardoListRuntimeResponse.getRuntimeConfig());\n+  }\n+\n+  default void mapLabels(Runtime runtime, Map<String, String> runtimeLabels) {\n+    if (runtimeLabels == null || runtimeLabels.get(RUNTIME_LABEL_AOU_CONFIG) == null) {\n+      runtime.setConfigurationType(RuntimeConfigurationType.DEFAULTDATAPROC);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89facb2814c95dfa5edaac135e3b51274cfb3039"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTY3NzM4OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMTozMjoxNlrOHXtXvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMTozMjoxNlrOHXtXvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyMjY1NA==", "bodyText": "nit: generally java local vars should not have underscores in them", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r494622654", "createdAt": "2020-09-24T21:32:16Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +176,69 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      try {\n+        return ResponseEntity.ok(getOverrideFromListRuntimes(workspaceNamespace));\n+      } catch (RuntimeException e2) {\n+        throw e;\n+      }\n+    }\n+  }\n+\n+  private Runtime getOverrideFromListRuntimes(String workspaceNamespace) {\n+    Optional<LeonardoListRuntimeResponse> mostRecentRuntimeMaybe =\n+        leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace, true).stream()\n+            .sorted(\n+                (a, b) -> {\n+                  String a_createdDate, b_createdDate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89facb2814c95dfa5edaac135e3b51274cfb3039"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NTY3OTMwOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQyMTozMjo1NVrOHXtY-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxODozNToyOVrOHYOedQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyMjk3MA==", "bodyText": "Wait - these are strings? If so, I don't think the comparison below is going to work as expected. Probably need a date / instant parsing step in here.", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r494622970", "createdAt": "2020-09-24T21:32:55Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +176,69 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      try {\n+        return ResponseEntity.ok(getOverrideFromListRuntimes(workspaceNamespace));\n+      } catch (RuntimeException e2) {\n+        throw e;\n+      }\n+    }\n+  }\n+\n+  private Runtime getOverrideFromListRuntimes(String workspaceNamespace) {\n+    Optional<LeonardoListRuntimeResponse> mostRecentRuntimeMaybe =\n+        leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace, true).stream()\n+            .sorted(\n+                (a, b) -> {\n+                  String a_createdDate, b_createdDate;\n+                  if (a.getAuditInfo() == null || a.getAuditInfo().getCreatedDate() == null) {\n+                    a_createdDate = \"\";\n+                  } else {\n+                    a_createdDate = a.getAuditInfo().getCreatedDate();\n+                  }\n+\n+                  if (b.getAuditInfo() == null || b.getAuditInfo().getCreatedDate() == null) {\n+                    b_createdDate = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89facb2814c95dfa5edaac135e3b51274cfb3039"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk4ODgzMQ==", "bodyText": "I think it works as long as we receive the timestamps in a consistent timezone.\n\"easily comparable and sortable with a trivial string comparison\"\nhttps://fits.gsfc.nasa.gov/iso-time.html", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r494988831", "createdAt": "2020-09-25T13:31:02Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +176,69 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      try {\n+        return ResponseEntity.ok(getOverrideFromListRuntimes(workspaceNamespace));\n+      } catch (RuntimeException e2) {\n+        throw e;\n+      }\n+    }\n+  }\n+\n+  private Runtime getOverrideFromListRuntimes(String workspaceNamespace) {\n+    Optional<LeonardoListRuntimeResponse> mostRecentRuntimeMaybe =\n+        leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace, true).stream()\n+            .sorted(\n+                (a, b) -> {\n+                  String a_createdDate, b_createdDate;\n+                  if (a.getAuditInfo() == null || a.getAuditInfo().getCreatedDate() == null) {\n+                    a_createdDate = \"\";\n+                  } else {\n+                    a_createdDate = a.getAuditInfo().getCreatedDate();\n+                  }\n+\n+                  if (b.getAuditInfo() == null || b.getAuditInfo().getCreatedDate() == null) {\n+                    b_createdDate = \"\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyMjk3MA=="}, "originalCommit": {"oid": "89facb2814c95dfa5edaac135e3b51274cfb3039"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAzMTA3Mw==", "bodyText": "going to merge since I have approval and tests are passing but I can add something later if this is still a concern", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r495031073", "createdAt": "2020-09-25T14:34:28Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +176,69 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      try {\n+        return ResponseEntity.ok(getOverrideFromListRuntimes(workspaceNamespace));\n+      } catch (RuntimeException e2) {\n+        throw e;\n+      }\n+    }\n+  }\n+\n+  private Runtime getOverrideFromListRuntimes(String workspaceNamespace) {\n+    Optional<LeonardoListRuntimeResponse> mostRecentRuntimeMaybe =\n+        leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace, true).stream()\n+            .sorted(\n+                (a, b) -> {\n+                  String a_createdDate, b_createdDate;\n+                  if (a.getAuditInfo() == null || a.getAuditInfo().getCreatedDate() == null) {\n+                    a_createdDate = \"\";\n+                  } else {\n+                    a_createdDate = a.getAuditInfo().getCreatedDate();\n+                  }\n+\n+                  if (b.getAuditInfo() == null || b.getAuditInfo().getCreatedDate() == null) {\n+                    b_createdDate = \"\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyMjk3MA=="}, "originalCommit": {"oid": "89facb2814c95dfa5edaac135e3b51274cfb3039"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE2NTA0NQ==", "bodyText": "Oh wow, wasn't aware of that property. That's quite useful, thanks.", "url": "https://github.com/all-of-us/workbench/pull/4044#discussion_r495165045", "createdAt": "2020-09-25T18:35:29Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/api/RuntimeController.java", "diffHunk": "@@ -173,10 +176,69 @@ private DbWorkspace lookupWorkspace(String workspaceNamespace) throws NotFoundEx\n         workspaceNamespace, firecloudWorkspaceName, WorkspaceAccessLevel.WRITER);\n     workspaceService.validateActiveBilling(workspaceNamespace, firecloudWorkspaceName);\n \n-    return ResponseEntity.ok(\n-        leonardoMapper.toApiRuntime(\n-            leonardoNotebooksClient.getRuntime(\n-                workspaceNamespace, userProvider.get().getRuntimeName())));\n+    try {\n+      return ResponseEntity.ok(\n+          leonardoMapper.toApiRuntime(\n+              leonardoNotebooksClient.getRuntime(\n+                  workspaceNamespace, userProvider.get().getRuntimeName())));\n+    } catch (NotFoundException e) {\n+      if (!workbenchConfigProvider.get().featureFlags.enableCustomRuntimes) {\n+        throw e;\n+      }\n+\n+      try {\n+        return ResponseEntity.ok(getOverrideFromListRuntimes(workspaceNamespace));\n+      } catch (RuntimeException e2) {\n+        throw e;\n+      }\n+    }\n+  }\n+\n+  private Runtime getOverrideFromListRuntimes(String workspaceNamespace) {\n+    Optional<LeonardoListRuntimeResponse> mostRecentRuntimeMaybe =\n+        leonardoNotebooksClient.listRuntimesByProject(workspaceNamespace, true).stream()\n+            .sorted(\n+                (a, b) -> {\n+                  String a_createdDate, b_createdDate;\n+                  if (a.getAuditInfo() == null || a.getAuditInfo().getCreatedDate() == null) {\n+                    a_createdDate = \"\";\n+                  } else {\n+                    a_createdDate = a.getAuditInfo().getCreatedDate();\n+                  }\n+\n+                  if (b.getAuditInfo() == null || b.getAuditInfo().getCreatedDate() == null) {\n+                    b_createdDate = \"\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDYyMjk3MA=="}, "originalCommit": {"oid": "89facb2814c95dfa5edaac135e3b51274cfb3039"}, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3942, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}