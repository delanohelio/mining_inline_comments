{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNjgyMDAw", "number": 2984, "title": "[RW-4228][Risk=no] Add cluster resources to static hosted files", "bodyText": "Description:\nThis adds the cluster resources to statically hosted files, to get around gcs enforcement. To test, go to srubenst-dot-api-dot-all-of-us-workbench-test.appspot.com/static/activity-checker-extension.js\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-01-08T22:21:49Z", "url": "https://github.com/all-of-us/workbench/pull/2984", "merged": true, "mergeCommit": {"oid": "b69921df926a53742aa98012396a48459497463d"}, "closed": true, "closedAt": "2020-01-09T19:18:14Z", "author": {"login": "s-rubenstein"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4c_PFAH2gAyMzYwNjgyMDAwOjg5MTYwMTRkODA3YzdiMTJjN2NhMDdhMmU5NDViZTIyODkzZGE1N2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4uqvGAFqTM0MDc0Mzg3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8916014d807c7b12c7ca07a2e945be22893da57f", "author": {"user": {"login": "s-rubenstein", "name": "Sky Rubenstein"}}, "url": "https://github.com/all-of-us/workbench/commit/8916014d807c7b12c7ca07a2e945be22893da57f", "committedDate": "2020-01-08T22:21:06Z", "message": "Add to static hosted files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMTg0OTM5", "url": "https://github.com/all-of-us/workbench/pull/2984#pullrequestreview-340184939", "createdAt": "2020-01-08T22:25:03Z", "commit": {"oid": "8916014d807c7b12c7ca07a2e945be22893da57f"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMjoyNTowM1rOFbltwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQyMjozMjo1MVrOFbl4nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3Mzc5NA==", "bodyText": "We should either remove the files from /cluster-resources, or copy the files here as part of the build step and .gitignore these. Currently the file is duplicated in source.", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364473794", "createdAt": "2020-01-08T22:25:03Z", "author": {"login": "calbach"}, "path": "api/src/main/webapp/static/activity-checker-extension.js", "diffHunk": "@@ -0,0 +1,45 @@\n+// Sends a message to the parent frame every second that user activity is detected", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8916014d807c7b12c7ca07a2e945be22893da57f"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NDQ3OQ==", "bodyText": "I don't think this one will be needed anymore.", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364474479", "createdAt": "2020-01-08T22:26:58Z", "author": {"login": "calbach"}, "path": "api/cluster-resources/build.rb", "diffHunk": "@@ -27,6 +27,9 @@ def build_snippets_menu()\n \n   FileUtils.mkdir_p \"generated\"\n   File.write(\"generated/aou-snippets-menu.js\", tmpl)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8916014d807c7b12c7ca07a2e945be22893da57f"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NjU3NQ==", "bodyText": "I just remembered we should probably include this set of http headers: \n  \n    \n      workbench/ui/app.yaml\n    \n    \n        Lines 11 to 15\n      in\n      e70ef35\n    \n    \n    \n    \n\n        \n          \n           http_headers: \n        \n\n        \n          \n             Strict-Transport-Security: \"max-age=31536000; includeSubDomains; preload\" \n        \n\n        \n          \n             X-XSS-Protection: 1 \n        \n\n        \n          \n             X-Content-Type-Options: \"nosniff\" \n        \n\n        \n          \n             Content-Security-Policy: \"default-src 'none'; frame-ancestors 'none'; report-uri /content-security-report\" \n        \n    \n  \n\n\nThis would probably push us towards pulling in the whole static/ directory to avoid repeating these on every include element.", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364476575", "createdAt": "2020-01-08T22:32:51Z", "author": {"login": "calbach"}, "path": "api/src/main/webapp/WEB-INF/appengine-web.xml.template", "diffHunk": "@@ -26,6 +25,15 @@\n     <handler file=\"server_unavailable.html\" />\n   </static-error-handlers>\n \n+  <static-files>\n+    <include path=\"static/activity-checker-extension.js\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8916014d807c7b12c7ca07a2e945be22893da57f"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "006edaaf6340fa1f161bbd701139cc7fdea17762", "author": {"user": {"login": "s-rubenstein", "name": "Sky Rubenstein"}}, "url": "https://github.com/all-of-us/workbench/commit/006edaaf6340fa1f161bbd701139cc7fdea17762", "committedDate": "2020-01-09T15:31:45Z", "message": "Copy on build and ignore files to avoid duplication"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55d297c329ed541c025f7c1989167e5fb544afb7", "author": {"user": {"login": "s-rubenstein", "name": "Sky Rubenstein"}}, "url": "https://github.com/all-of-us/workbench/commit/55d297c329ed541c025f7c1989167e5fb544afb7", "committedDate": "2020-01-09T16:09:30Z", "message": "Add policy headers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNjgxMzEw", "url": "https://github.com/all-of-us/workbench/pull/2984#pullrequestreview-340681310", "createdAt": "2020-01-09T17:12:00Z", "commit": {"oid": "55d297c329ed541c025f7c1989167e5fb544afb7"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzoxMjowMFrOFb9UoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzoyMDo1NVrOFb9lBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2MDU3Nw==", "bodyText": "I would move this into deploy_app instead, somewhere around L1579 (before appengineStage). This copy needs to happen every time before we build the GAE app for deployment, so it should be more closely coupled to that step", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364860577", "createdAt": "2020-01-09T17:12:00Z", "author": {"login": "calbach"}, "path": "api/libproject/devstart.rb", "diffHunk": "@@ -1503,6 +1503,7 @@ def deploy_gcs_artifacts(cmd_name, args)\n \n   Dir.chdir(\"cluster-resources\") do\n     common.run_inline(%W{./build.rb build-snippets-menu})\n+    common.run_inline(%W{./build.rb generate-static-files})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55d297c329ed541c025f7c1989167e5fb544afb7"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2MTQyOQ==", "bodyText": "Thanks for adding the README", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364861429", "createdAt": "2020-01-09T17:13:43Z", "author": {"login": "calbach"}, "path": "api/src/main/webapp/static/README.md", "diffHunk": "@@ -0,0 +1,8 @@\n+#Static Files in AppEngine", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55d297c329ed541c025f7c1989167e5fb544afb7"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2MzE5NA==", "bodyText": "Can you verify that this is picking up aou-snippets-menu.js? Pretty sure you need ** to pickup subdirs. Alternative fix would be to just to not mirror the generated/ dir there, just copy it straight into /static. That seems fine, if not correct to me, since all of these static files are copied in during the build time anyways - the fact that this one file is generated is no longer relevant.", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364863194", "createdAt": "2020-01-09T17:17:38Z", "author": {"login": "calbach"}, "path": "api/src/main/webapp/WEB-INF/appengine-web.xml.template", "diffHunk": "@@ -26,6 +25,20 @@\n     <handler file=\"server_unavailable.html\" />\n   </static-error-handlers>\n \n+  <static-files>\n+    <include path=\"static/*\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55d297c329ed541c025f7c1989167e5fb544afb7"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2MzkwMA==", "bodyText": "Since we're globbig the directory, won't this be served as a static resource? If so, I might suggest moving this to either api/doc or cluster-resources/README.md", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364863900", "createdAt": "2020-01-09T17:19:09Z", "author": {"login": "calbach"}, "path": "api/src/main/webapp/static/README.md", "diffHunk": "@@ -0,0 +1,8 @@\n+#Static Files in AppEngine\n+We host a number of public static files in GAE for cluster creation. These files are copied at build time from our cluster resources directory. Eventually (when we no longer support bucket extensions), these files should move into this directory and we should no longer gitignore them from here.\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55d297c329ed541c025f7c1989167e5fb544afb7"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2NDc3Mg==", "bodyText": "nit: if you move the README out, you can just ignore the whole directory", "url": "https://github.com/all-of-us/workbench/pull/2984#discussion_r364864772", "createdAt": "2020-01-09T17:20:55Z", "author": {"login": "calbach"}, "path": ".gitignore", "diffHunk": "@@ -20,6 +20,11 @@ cron-emulator-err.log\n /api/src/main/webapp/WEB-INF/cron.yaml\n /api/src/main/webapp/WEB-INF/sa-key.json\n /api/src/main/webapp/WEB-INF/gsuite-admin-sa.json\n+/api/src/main/webapp/static/generated/*\n+/api/src/main/webapp/static/activity-checker-extension.js", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55d297c329ed541c025f7c1989167e5fb544afb7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fb5de42d3e8e0b1a3567aff5bf6774bfdbe5ffc", "author": {"user": {"login": "s-rubenstein", "name": "Sky Rubenstein"}}, "url": "https://github.com/all-of-us/workbench/commit/1fb5de42d3e8e0b1a3567aff5bf6774bfdbe5ffc", "committedDate": "2020-01-09T18:22:11Z", "message": "Exclude readme and move static file copying"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwNzQzODcx", "url": "https://github.com/all-of-us/workbench/pull/2984#pullrequestreview-340743871", "createdAt": "2020-01-09T18:57:00Z", "commit": {"oid": "1fb5de42d3e8e0b1a3567aff5bf6774bfdbe5ffc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3832, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}