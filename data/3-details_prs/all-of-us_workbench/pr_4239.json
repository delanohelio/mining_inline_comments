{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MjE5ODY3", "number": 4239, "title": "[no ticket][risk=no] Create Puppeteer test results JSON file with jest-stare", "bodyText": "Test Results Monitoring:\nStep 1: Upload Puppeteer test results JSON files from CircleCI to Google storage bucket.\nApproach: Use jest-stare to automate saving of test results in JSON format. Then use gsutil CLI to upload JSON files from CircleCI to storage bucket.\nstorage bucket: gs://circleci-puppeteer-test-results\nproject: all-of-us-workbench-test\nExample:\nhttps://app.circleci.com/pipelines/github/all-of-us/workbench/5438/workflows/e86e0895-2178-4c75-ad6a-34a5b9f8ff0c/jobs/107658/artifacts\nTwo JSON files to be uploaded to the storage bucket. circleci-build-107658-0-test-results.json and circleci-build-107658-0-test-results.json", "createdAt": "2020-11-02T17:43:37Z", "url": "https://github.com/all-of-us/workbench/pull/4239", "merged": true, "mergeCommit": {"oid": "4c64d7e895c930cef4c0397bd4d44f9c0e30e0f1"}, "closed": true, "closedAt": "2020-11-05T18:28:46Z", "author": {"login": "aweng98"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYoN9WAH2gAyNTE0MjE5ODY3OjM5ODM2ZDc0MGJkODQ1MDA3NmQxYjM3ODBlZTJjZDljYTRjMTdhNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZmAnAAH2gAyNTE0MjE5ODY3OmU1NTNhZDk1YTQyNjU3ZTBhOTg4YzAyZTIxMDE3MTY1YTdlNDY5YWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "39836d740bd8450076d1b3780ee2cd9ca4c17a44", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/39836d740bd8450076d1b3780ee2cd9ca4c17a44", "committedDate": "2020-11-02T17:42:52Z", "message": "jest-stare lib"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3310868e53c2aa7ef527e0f159dc990eb7a2214c", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/3310868e53c2aa7ef527e0f159dc990eb7a2214c", "committedDate": "2020-11-02T19:53:40Z", "message": "skip most tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70a52fd9feb0a5b3e0427e747af6a0058367b26f", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/70a52fd9feb0a5b3e0427e747af6a0058367b26f", "committedDate": "2020-11-02T20:05:54Z", "message": "mv combined json"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTc5MjU0", "url": "https://github.com/all-of-us/workbench/pull/4239#pullrequestreview-521979254", "createdAt": "2020-11-02T20:45:09Z", "commit": {"oid": "70a52fd9feb0a5b3e0427e747af6a0058367b26f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDo0NTowOVrOHsVA4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDo0NTowOVrOHsVA4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0MzY4MA==", "bodyText": "skipped most tests for testing quicker. Changes will be reverted back before merge.", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r516243680", "createdAt": "2020-11-02T20:45:09Z", "author": {"login": "aweng98"}, "path": "e2e/tests/cohorts/cohorts-create.spec.ts", "diffHunk": "@@ -11,7 +11,7 @@ import {findOrCreateWorkspace, signIn} from 'utils/test-utils';\n import {waitForText, waitWhileLoading} from 'utils/waits-utils';\n \n \n-describe('User can create new Cohorts', () => {\n+describe.skip('User can create new Cohorts', () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70a52fd9feb0a5b3e0427e747af6a0058367b26f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a0bf146f0901b7629cd3cb8b5bdedd5d3ba25ea", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/1a0bf146f0901b7629cd3cb8b5bdedd5d3ba25ea", "committedDate": "2020-11-02T21:21:07Z", "message": "remove jest-junit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "663110a8c94e3caf0569d2a65c7b1ec25cd6cb34", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/663110a8c94e3caf0569d2a65c7b1ec25cd6cb34", "committedDate": "2020-11-02T21:33:55Z", "message": "unskip tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66e3fc1778619bb7690c7f31ee2b3b649ed54c5b", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/66e3fc1778619bb7690c7f31ee2b3b649ed54c5b", "committedDate": "2020-11-02T21:35:05Z", "message": "unskip tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22076d41433b09122f2981d6b1ae4e9bcaacab87", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/22076d41433b09122f2981d6b1ae4e9bcaacab87", "committedDate": "2020-11-02T21:36:44Z", "message": "ci config format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxOTg1ODEx", "url": "https://github.com/all-of-us/workbench/pull/4239#pullrequestreview-521985811", "createdAt": "2020-11-02T20:55:59Z", "commit": {"oid": "3310868e53c2aa7ef527e0f159dc990eb7a2214c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMDo1NTo1OVrOHsVVSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQyMTozOTowMlrOHsWlnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0ODkwNA==", "bodyText": "FYI: ftest or fdescribe I believe should work here, i.e. \"focus\" this test and skip the others - probably a lot easier than skipping all", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r516248904", "createdAt": "2020-11-02T20:55:59Z", "author": {"login": "calbach"}, "path": "e2e/tests/cohorts/cohorts-create.spec.ts", "diffHunk": "@@ -11,7 +11,7 @@ import {findOrCreateWorkspace, signIn} from 'utils/test-utils';\n import {waitForText, waitWhileLoading} from 'utils/waits-utils';\n \n \n-describe('User can create new Cohorts', () => {\n+describe.skip('User can create new Cohorts', () => {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0MzY4MA=="}, "originalCommit": {"oid": "70a52fd9feb0a5b3e0427e747af6a0058367b26f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0OTI3Mg==", "bodyText": "nit: please line wrap", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r516249272", "createdAt": "2020-11-02T20:56:40Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -301,6 +301,16 @@ commands:\n             circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n             yarn test:ci $(cat /tmp/tests-to-run)\n           no_output_timeout: 15m\n+      - run:\n+          name: Create circleci_parameters.json\n+          working_directory: ~/workbench/e2e\n+          command: |\n+            echo \"{ \\\"circleBranch\\\": \\\"${CIRCLE_BRANCH}\\\", \\\"circleJob\\\": \\\"${CIRCLE_JOB}\\\", \\\"circleBuild\\\": \\\"${CIRCLE_BUILD_NUM}\\\", \\\"circleBuildUrl\\\": \\\"${CIRCLE_BUILD_URL}\\\", \\\"circleNodeIndex\\\": \\\"${CIRCLE_NODE_INDEX}\\\" }\" \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3310868e53c2aa7ef527e0f159dc990eb7a2214c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI2OTQ3MQ==", "bodyText": "nit: I would not re-encode the file names here in the description, e.g. \"Add CircleCI job data to Junit test results\".", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r516269471", "createdAt": "2020-11-02T21:39:02Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -301,6 +301,16 @@ commands:\n             circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n             yarn test:ci $(cat /tmp/tests-to-run)\n           no_output_timeout: 15m\n+      - run:\n+          name: Create circleci_parameters.json\n+          working_directory: ~/workbench/e2e\n+          command: |\n+            echo \"{ \\\"circleBranch\\\": \\\"${CIRCLE_BRANCH}\\\", \\\"circleJob\\\": \\\"${CIRCLE_JOB}\\\", \\\"circleBuild\\\": \\\"${CIRCLE_BUILD_NUM}\\\", \\\"circleBuildUrl\\\": \\\"${CIRCLE_BUILD_URL}\\\", \\\"circleNodeIndex\\\": \\\"${CIRCLE_NODE_INDEX}\\\" }\" \\\n+              > ./logs/circleci_parameters.json\n+      - run:\n+          name: Combine circleci_parameters.json and test-results.json", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3310868e53c2aa7ef527e0f159dc990eb7a2214c"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNTk0MTU1", "url": "https://github.com/all-of-us/workbench/pull/4239#pullrequestreview-522594155", "createdAt": "2020-11-03T15:11:18Z", "commit": {"oid": "22076d41433b09122f2981d6b1ae4e9bcaacab87"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNToxMToxOFrOHszStA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNToxMjoxOFrOHszVig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjczOTc2NA==", "bodyText": "Done", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r516739764", "createdAt": "2020-11-03T15:11:18Z", "author": {"login": "aweng98"}, "path": ".circleci/config.yml", "diffHunk": "@@ -301,6 +301,16 @@ commands:\n             circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n             yarn test:ci $(cat /tmp/tests-to-run)\n           no_output_timeout: 15m\n+      - run:\n+          name: Create circleci_parameters.json\n+          working_directory: ~/workbench/e2e\n+          command: |\n+            echo \"{ \\\"circleBranch\\\": \\\"${CIRCLE_BRANCH}\\\", \\\"circleJob\\\": \\\"${CIRCLE_JOB}\\\", \\\"circleBuild\\\": \\\"${CIRCLE_BUILD_NUM}\\\", \\\"circleBuildUrl\\\": \\\"${CIRCLE_BUILD_URL}\\\", \\\"circleNodeIndex\\\": \\\"${CIRCLE_NODE_INDEX}\\\" }\" \\", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI0OTI3Mg=="}, "originalCommit": {"oid": "3310868e53c2aa7ef527e0f159dc990eb7a2214c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc0MDQ5MA==", "bodyText": "Done", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r516740490", "createdAt": "2020-11-03T15:12:18Z", "author": {"login": "aweng98"}, "path": ".circleci/config.yml", "diffHunk": "@@ -301,6 +301,16 @@ commands:\n             circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n             yarn test:ci $(cat /tmp/tests-to-run)\n           no_output_timeout: 15m\n+      - run:\n+          name: Create circleci_parameters.json\n+          working_directory: ~/workbench/e2e\n+          command: |\n+            echo \"{ \\\"circleBranch\\\": \\\"${CIRCLE_BRANCH}\\\", \\\"circleJob\\\": \\\"${CIRCLE_JOB}\\\", \\\"circleBuild\\\": \\\"${CIRCLE_BUILD_NUM}\\\", \\\"circleBuildUrl\\\": \\\"${CIRCLE_BUILD_URL}\\\", \\\"circleNodeIndex\\\": \\\"${CIRCLE_NODE_INDEX}\\\" }\" \\\n+              > ./logs/circleci_parameters.json\n+      - run:\n+          name: Combine circleci_parameters.json and test-results.json", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjI2OTQ3MQ=="}, "originalCommit": {"oid": "3310868e53c2aa7ef527e0f159dc990eb7a2214c"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1ffaba57cf434f9a78cab324e7d9b57cb9b2581", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/b1ffaba57cf434f9a78cab324e7d9b57cb9b2581", "committedDate": "2020-11-03T15:16:53Z", "message": "PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ca8bfeafe4afd4cad869bc68cdeefeb8c483e46", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/2ca8bfeafe4afd4cad869bc68cdeefeb8c483e46", "committedDate": "2020-11-03T17:28:58Z", "message": "add arg when: always in run-puppeteer-job"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d33c6c323b10d2ab6f998fca2856abc60b1ffb0", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/9d33c6c323b10d2ab6f998fca2856abc60b1ffb0", "committedDate": "2020-11-04T20:46:26Z", "message": "remove whitespaces in json"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzODIxMDgw", "url": "https://github.com/all-of-us/workbench/pull/4239#pullrequestreview-523821080", "createdAt": "2020-11-04T23:56:12Z", "commit": {"oid": "9d33c6c323b10d2ab6f998fca2856abc60b1ffb0"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzo1NjoxMlrOHtt9JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQyMzo1Nzo0NlrOHtt_Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwMDkwMA==", "bodyText": "Why? If you really need to do this, can you just pass the \"-c\" flag to fq instead?", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r517700900", "createdAt": "2020-11-04T23:56:12Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -300,6 +301,33 @@ commands:\n             circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n             yarn test:ci $(cat /tmp/tests-to-run)\n           no_output_timeout: 15m\n+      - run:\n+          name: Create circleci_parameters.json\n+          working_directory: ~/workbench/e2e\n+          command: |\n+            echo \"{ \\\n+              \\\"circleBranch\\\": \\\"${CIRCLE_BRANCH}\\\", \\\n+              \\\"circleJob\\\": \\\"${CIRCLE_JOB}\\\", \\\n+              \\\"circleBuild\\\": \\\"${CIRCLE_BUILD_NUM}\\\", \\\n+              \\\"circleBuildUrl\\\": \\\"${CIRCLE_BUILD_URL}\\\", \\\n+              \\\"circleNodeIndex\\\": \\\"${CIRCLE_NODE_INDEX}\\\" \\\n+              }\" \\\n+              > ./logs/circleci_parameters.json\n+          when: always\n+      - run:\n+          name: Add CircleCI job data to test results json before upload json to storage bucket\n+          working_directory: ~/workbench/e2e/logs\n+          command: |\n+            NEW_JSON=circleci-build-${CIRCLE_BUILD_NUM}-${CIRCLE_NODE_INDEX}-test-results.json\n+            jq -s '.[0] * .[1]' test-results.json circleci_parameters.json > ${NEW_JSON}\n+            # Remove all whitespaces", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d33c6c323b10d2ab6f998fca2856abc60b1ffb0"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcwMTM5NQ==", "bodyText": "This has implicit side-effects on other gcloud commands, in general I recommend avoiding setting this in most cases. This line also should not be necessary at all for running the following gsutil command. I would remove it and the project name.\nIf you still have problems after this, please let me know, but you can instead pass an explicit project ID flag to gsutil.", "url": "https://github.com/all-of-us/workbench/pull/4239#discussion_r517701395", "createdAt": "2020-11-04T23:57:46Z", "author": {"login": "calbach"}, "path": ".circleci/config.yml", "diffHunk": "@@ -300,6 +301,33 @@ commands:\n             circleci tests glob \"tests/**/*.spec.ts\" | circleci tests split --split-by=timings > /tmp/tests-to-run\n             yarn test:ci $(cat /tmp/tests-to-run)\n           no_output_timeout: 15m\n+      - run:\n+          name: Create circleci_parameters.json\n+          working_directory: ~/workbench/e2e\n+          command: |\n+            echo \"{ \\\n+              \\\"circleBranch\\\": \\\"${CIRCLE_BRANCH}\\\", \\\n+              \\\"circleJob\\\": \\\"${CIRCLE_JOB}\\\", \\\n+              \\\"circleBuild\\\": \\\"${CIRCLE_BUILD_NUM}\\\", \\\n+              \\\"circleBuildUrl\\\": \\\"${CIRCLE_BUILD_URL}\\\", \\\n+              \\\"circleNodeIndex\\\": \\\"${CIRCLE_NODE_INDEX}\\\" \\\n+              }\" \\\n+              > ./logs/circleci_parameters.json\n+          when: always\n+      - run:\n+          name: Add CircleCI job data to test results json before upload json to storage bucket\n+          working_directory: ~/workbench/e2e/logs\n+          command: |\n+            NEW_JSON=circleci-build-${CIRCLE_BUILD_NUM}-${CIRCLE_NODE_INDEX}-test-results.json\n+            jq -s '.[0] * .[1]' test-results.json circleci_parameters.json > ${NEW_JSON}\n+            # Remove all whitespaces\n+            cat ${NEW_JSON} | tr '\\n' ' ' > tmp.json && mv tmp.json ${NEW_JSON}\n+            # Upload json to storage bucket\n+            PROJECT_NAME=all-of-us-workbench-test\n+            STORAGE_BUCKET=gs://circleci-puppeteer-test-results\n+            gcloud config set project ${PROJECT_NAME}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d33c6c323b10d2ab6f998fca2856abc60b1ffb0"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e553ad95a42657e0a988c02e21017165a7e469ac", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/e553ad95a42657e0a988c02e21017165a7e469ac", "committedDate": "2020-11-05T17:42:24Z", "message": "remove set project_id"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3813, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}