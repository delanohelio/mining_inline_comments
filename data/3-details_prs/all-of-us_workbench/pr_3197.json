{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMDI3Nzcy", "number": 3197, "title": "[RW-4246][RISK=LOW] Captcha requirement at the time of Registration", "bodyText": "Adds Captcha Checkbox at the end of demographic survey page and do\nclient validation and server validation\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later\n\nStory for Prod Feature Flag and key: https://precisionmedicineinitiative.atlassian.net/browse/RW-4555", "createdAt": "2020-02-27T19:23:46Z", "url": "https://github.com/all-of-us/workbench/pull/3197", "merged": true, "mergeCommit": {"oid": "fe4564d4c3e4c2dff8fc2ecb6360c37936876bfa"}, "closed": true, "closedAt": "2020-03-05T19:30:23Z", "author": {"login": "NehaBroad"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIgX_1gH2gAyMzgxMDI3NzcyOjJmNmRmMjhhM2U3MjlkODdjMGI1YWE0OTIyMzgzMDNlMThjMzFmNTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKvb3bAFqTM2OTc5MjQ4Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2f6df28a3e729d87c0b5aa492238303e18c31f58", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/2f6df28a3e729d87c0b5aa492238303e18c31f58", "committedDate": "2020-02-27T19:20:39Z", "message": "Add captcha Demographic Survey page"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "347617fba4ce0949e6e6d070884eed057c457027", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/347617fba4ce0949e6e6d070884eed057c457027", "committedDate": "2020-02-27T19:55:52Z", "message": "Captcha conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3030c8215c3834fc9de9cdf933471c27c654134c", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/3030c8215c3834fc9de9cdf933471c27c654134c", "committedDate": "2020-02-27T19:59:59Z", "message": "Set captcha only if its enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c146418e197a36ad7c0af67606fa3a2baae66581", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/c146418e197a36ad7c0af67606fa3a2baae66581", "committedDate": "2020-02-27T20:15:26Z", "message": "fix test add comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d666ff5e16c7def1755501edaf2a3d4aa477a205", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/d666ff5e16c7def1755501edaf2a3d4aa477a205", "committedDate": "2020-02-27T20:18:59Z", "message": "yarn lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6913393a8ccb8b3f115f6ef62a9d43faa21cc22", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/e6913393a8ccb8b3f115f6ef62a9d43faa21cc22", "committedDate": "2020-02-27T20:20:45Z", "message": "blank captcha key if captcha is not enabled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTY2NzI4", "url": "https://github.com/all-of-us/workbench/pull/3197#pullrequestreview-365966728", "createdAt": "2020-02-27T20:14:07Z", "commit": {"oid": "3030c8215c3834fc9de9cdf933471c27c654134c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMDoxNDowN1rOFvfulg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMDoyMTozNlrOFvf76A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM0NzIyMg==", "bodyText": "Nit: Please use specific imports as opposed to * imports.", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385347222", "createdAt": "2020-02-27T20:14:07Z", "author": {"login": "s-rubenstein"}, "path": "api/src/main/java/org/pmiops/workbench/captcha/CaptchaServerVerificationResponse.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package org.pmiops.workbench.captcha;\n+\n+import com.fasterxml.jackson.annotation.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3030c8215c3834fc9de9cdf933471c27c654134c"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM1MDYzMg==", "bodyText": "Opt: Could either of these files be generated with Swagger? Assuming I understand and this is an api response object and a caller to the captcha API?\nThis is opt because this is a small number of methods and is unlikely to change, but may be worth considering.", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385350632", "createdAt": "2020-02-27T20:21:36Z", "author": {"login": "s-rubenstein"}, "path": "api/src/main/java/org/pmiops/workbench/captcha/CaptchaServerVerificationResponse.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package org.pmiops.workbench.captcha;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c146418e197a36ad7c0af67606fa3a2baae66581"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDM0NjMy", "url": "https://github.com/all-of-us/workbench/pull/3197#pullrequestreview-366034632", "createdAt": "2020-02-27T22:08:00Z", "commit": {"oid": "e6913393a8ccb8b3f115f6ef62a9d43faa21cc22"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMjowODowMFrOFvi8EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QyMjowODowMFrOFvi8EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5OTgyNQ==", "bodyText": "Drive-by comment: I think I lost the last round of \"battle\" over this topic in a PR from a couple months back (@als364 and @jaycarlton were on that one), but I still don't believe that filenames like this really belong in our per-environment config. Our convention has always been to have consistent filenames across environments, with just the bucket name changing (see credentialsBucketName). Most of our key / credential filenames are code-constants in CloudStorageServiceImpl\nI'm more than happy to be overruled if folks strongly disagree with that pattern. But it's important to note that we're actively introducing inconsistency in our system by storing key filenames in our config: some filenames will be stored in WorkbenchConfig, while most others continue to be code constants.\nIf we think there's benefit to migrating to the other approach, we should track a tech debt ticket & acknowledge the cost of migrating everything to the config pattern.", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385399825", "createdAt": "2020-02-27T22:08:00Z", "author": {"login": "gjuggler"}, "path": "api/config/config_local.json", "diffHunk": "@@ -105,5 +105,9 @@\n     \"host\": \"pmi-drc-api-test.appspot.com\",\n     \"queueName\": \"rdrQueueTest\",\n     \"exportObjectsPerTask\" : 10\n+  },\n+  \"captcha\": {\n+    \"enableCaptcha\": true,\n+    \"serverKeyFileName\": \"captcha-server-key.txt\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6913393a8ccb8b3f115f6ef62a9d43faa21cc22"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d482772b69b8c70bfef72d50ca975f3a3d2752f", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/6d482772b69b8c70bfef72d50ca975f3a3d2752f", "committedDate": "2020-02-28T04:46:02Z", "message": "swagger for captcha"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56cc939d7f4215804b5f50e2d677eaaa82245146", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/56cc939d7f4215804b5f50e2d677eaaa82245146", "committedDate": "2020-02-28T05:09:08Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "703045182875144b04cac17b485b5a37bf547ab1", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/703045182875144b04cac17b485b5a37bf547ab1", "committedDate": "2020-02-28T05:11:31Z", "message": "remove CaptchaServerVerificationResponse"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NjY1NjEx", "url": "https://github.com/all-of-us/workbench/pull/3197#pullrequestreview-366665611", "createdAt": "2020-02-28T20:27:52Z", "commit": {"oid": "703045182875144b04cac17b485b5a37bf547ab1"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMDoyNzo1MlrOFwB5vA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQyMDo0MDo0MlrOFwCNRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwNzEzMg==", "bodyText": "I agree we should migrate to the other approach, I don't think creating this new pattern should block this ticket, I do think creating said tech debt ticket should block this ticket.", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385907132", "createdAt": "2020-02-28T20:27:52Z", "author": {"login": "als364"}, "path": "api/config/config_local.json", "diffHunk": "@@ -105,5 +105,9 @@\n     \"host\": \"pmi-drc-api-test.appspot.com\",\n     \"queueName\": \"rdrQueueTest\",\n     \"exportObjectsPerTask\" : 10\n+  },\n+  \"captcha\": {\n+    \"enableCaptcha\": true,\n+    \"serverKeyFileName\": \"captcha-server-key.txt\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTM5OTgyNQ=="}, "originalCommit": {"oid": "e6913393a8ccb8b3f115f6ef62a9d43faa21cc22"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkwOTYyMg==", "bodyText": "This looks more like a ServiceImpl than a service - please pull out the Service interface.", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385909622", "createdAt": "2020-02-28T20:34:16Z", "author": {"login": "als364"}, "path": "api/src/main/java/org/pmiops/workbench/captcha/CaptchaVerificationService.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.pmiops.workbench.captcha;\n+\n+import java.util.logging.Level;\n+import java.util.logging.Logger;\n+import java.util.stream.Collectors;\n+import javax.inject.Provider;\n+import org.pmiops.workbench.captcha.api.CaptchaApi;\n+import org.pmiops.workbench.captcha.model.CaptchaVerificationResponse;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.google.CloudStorageService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+/** Service to verify Captcha */\n+@Service\n+public class CaptchaVerificationService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "703045182875144b04cac17b485b5a37bf547ab1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkxMDAwMA==", "bodyText": "nit: either camelcase this or make it all lowercase", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385910000", "createdAt": "2020-02-28T20:35:17Z", "author": {"login": "als364"}, "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -94,6 +96,8 @@\n   private static final String FAMILY_NAME = \"Bobberson\";\n   private static final String CONTACT_EMAIL = \"bob@example.com\";\n   private static final String INVITATION_KEY = \"secretpassword\";\n+  private static final String CAPTCHA_TOKEN = \"captchaToken\";\n+  private static final String WRONG_CAPTCHA_TOKEN = \"WrongcaptchaToken\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "703045182875144b04cac17b485b5a37bf547ab1"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkxMTYzMg==", "bodyText": "jeez is this really how they cased it", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385911632", "createdAt": "2020-02-28T20:39:21Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/login/account-creation/account-creation-survey.tsx", "diffHunk": "@@ -13,7 +13,9 @@ import {SpinnerOverlay} from 'app/components/spinners';\n import {profileApi} from 'app/services/swagger-fetch-clients';\n import colors from 'app/styles/colors';\n import {toggleIncludes} from 'app/utils';\n+import {environment} from 'environments/environment';\n import {Profile} from 'generated/fetch';\n+import ReCAPTCHA from 'react-google-recaptcha';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "703045182875144b04cac17b485b5a37bf547ab1"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkxMTgyMw==", "bodyText": "nit: can you move this TODO up to line 93?", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385911823", "createdAt": "2020-02-28T20:39:50Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/login/account-creation/account-creation-survey.tsx", "diffHunk": "@@ -83,11 +91,21 @@ export class AccountCreationSurvey extends React.Component<AccountCreationSurvey\n         onComplete(savedProfile);\n       }).catch(error => {\n         console.log(error);\n-        this.setState({creatingAccount: false});\n+        if (environment.enableCaptcha) {\n+          // Reset captcha\n+          this.captchaRef.current.reset();\n+          this.setState({captcha: false});\n+        }\n         // TODO: we need to show some user-facing error message when this fails.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "703045182875144b04cac17b485b5a37bf547ab1"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTkxMjEzMw==", "bodyText": "If you're not going to enable this straight away, please file a ticket to enable captcha in prod.", "url": "https://github.com/all-of-us/workbench/pull/3197#discussion_r385912133", "createdAt": "2020-02-28T20:40:42Z", "author": {"login": "als364"}, "path": "ui/src/environments/environment.prod.ts", "diffHunk": "@@ -4,6 +4,7 @@ export const environment: Environment = {\n   displayTag: '',\n   shouldShowDisplayTag: false,\n   allOfUsApiUrl: 'https://api.workbench.researchallofus.org',\n+  captchaSiteKey: '',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "703045182875144b04cac17b485b5a37bf547ab1"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2943ca86b9d7e4834d7b2c055ef130cdbbb6362", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/a2943ca86b9d7e4834d7b2c055ef130cdbbb6362", "committedDate": "2020-03-05T16:28:30Z", "message": "PR Comments Add serviceImpl remove filename from config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d06f6d5b84f1a8aac3f11f668fc4292098cc8edc", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/d06f6d5b84f1a8aac3f11f668fc4292098cc8edc", "committedDate": "2020-03-05T16:35:26Z", "message": "resolve file conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddf9cf60a94aa9c136a1a88f3f74f3b5656d42e4", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/ddf9cf60a94aa9c136a1a88f3f74f3b5656d42e4", "committedDate": "2020-03-05T16:58:29Z", "message": "spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NzkyNDg3", "url": "https://github.com/all-of-us/workbench/pull/3197#pullrequestreview-369792487", "createdAt": "2020-03-05T18:01:18Z", "commit": {"oid": "ddf9cf60a94aa9c136a1a88f3f74f3b5656d42e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3397, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}