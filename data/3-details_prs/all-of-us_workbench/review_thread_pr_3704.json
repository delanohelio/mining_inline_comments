{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4NTk5NTQz", "number": 3704, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyMzowMFrOEH_hEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNTozMjo1OVrOEIa28g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2ODE2MTQ1OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyMzowMFrOGnrsTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyMzowMFrOGnrsTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2MzUwMg==", "bodyText": "I kinda want to take this logic out of this file and put it in a script that we just call here.\nIt's conceivable that a .txt file could influence the behavior of the product, though I don't know of any current examples of this.\nEventually I'd like to move to a model where the first job determines what future jobs to run. That is, we wouldn't see a green checkmark for halted jobs; it would just never have run at all.\nIs there a way to halt with another symbol (like it does for skipped tests)? Seems like I looked at one point.", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444263502", "createdAt": "2020-06-23T14:23:00Z", "author": {"login": "jaycarlton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -107,7 +107,9 @@ commands:\n           command: |\n             if [ ${CIRCLE_BRANCH} != \"\" ] &&\n               [ ${CIRCLE_BRANCH} != \"master\" ] &&\n-              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvE '(.md$)|(.pdf$)'; then\n+              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) \\\n+                | grep -qvE '(.md)|(.pdf)|(.png)|(.svg)|(Test.java)|(Test.kt)|(.mp4)|(.log)|(.txt)'; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52de7348ff238cfce3738ee45bb7191fc1e620d1"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2ODE2NjM3OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyMzo1MVrOGnrvHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyMzo1MVrOGnrvHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2NDIyMA==", "bodyText": "Have you tested what happens when we make a PR against a non-master branch? I've occasionally felt the need to do this (e.g. when lots of reviewers are on vacation). Do we just not run CircleCI jobs?", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444264220", "createdAt": "2020-06-23T14:23:51Z", "author": {"login": "jaycarlton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -107,7 +107,9 @@ commands:\n           command: |\n             if [ ${CIRCLE_BRANCH} != \"\" ] &&\n               [ ${CIRCLE_BRANCH} != \"master\" ] &&\n-              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvE '(.md$)|(.pdf$)'; then\n+              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) \\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52de7348ff238cfce3738ee45bb7191fc1e620d1"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2ODE3NzMyOnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyNjowMVrOGnr1wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNDoyNjowMVrOGnr1wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI2NTkyMA==", "bodyText": "Can you put all these extensions into an environment var called E2E_IGNORE_PATTERNS? Can we use this approach for all our jobs?", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444265920", "createdAt": "2020-06-23T14:26:01Z", "author": {"login": "jaycarlton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -107,7 +107,9 @@ commands:\n           command: |\n             if [ ${CIRCLE_BRANCH} != \"\" ] &&\n               [ ${CIRCLE_BRANCH} != \"master\" ] &&\n-              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvE '(.md$)|(.pdf$)'; then\n+              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) \\\n+                | grep -qvE '(.md)|(.pdf)|(.png)|(.svg)|(Test.java)|(Test.kt)|(.mp4)|(.log)|(.txt)'; then", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52de7348ff238cfce3738ee45bb7191fc1e620d1"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDAxNDg2OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMzozODo0MFrOGn-IUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNTo0ODozOVrOGoYVog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2NTU4Ng==", "bodyText": "Checking for PR branch if [ ${CIRCLE_BRANCH} != \"\" ] && [ ${CIRCLE_BRANCH} != \"master\" ] is now replaced by pr-skip-ci.sh.\nThe grep regex patterns is in e2e-job-ignore-patterns.txt.", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444565586", "createdAt": "2020-06-23T23:38:40Z", "author": {"login": "aweng98"}, "path": ".circleci/config.yml", "diffHunk": "@@ -100,18 +100,19 @@ commands:\n           name: Update git submodules\n           command: git submodule update --init --recursive\n \n-  halt_job_noncode_changes:\n-    description: \"Halt job and succeed early if no code changes on non-master branch\"\n+  halt_if_code_unchanged:\n+    description: \"Halt job if no code changed\"\n     steps:\n       - run:\n           command: |\n-            if [ ${CIRCLE_BRANCH} != \"\" ] &&\n-              [ ${CIRCLE_BRANCH} != \"master\" ] &&\n-              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvE '(.md$)|(.pdf$)'; then\n-                echo \"No code changes on non-master branch. halting job.\"\n-                circleci step halt\n+            if ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvFf .circleci/e2e-job-ignore-patterns.txt; then\n+              echo \"Application code have not changed. halting job.\"\n+              circleci step halt\n+            else\n+              git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -vFf .circleci/e2e-job-ignore-patterns.txt\n+              echo \"job continuing.\"\n             fi", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac14b44bab1745104fb252f1d2513e05995b5754"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MzMzMQ==", "bodyText": "Very nice. I like how you didn't have to update a docker image to add your script. I was worried it would be worse.", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444983331", "createdAt": "2020-06-24T15:31:24Z", "author": {"login": "jaycarlton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -100,18 +100,19 @@ commands:\n           name: Update git submodules\n           command: git submodule update --init --recursive\n \n-  halt_job_noncode_changes:\n-    description: \"Halt job and succeed early if no code changes on non-master branch\"\n+  halt_if_code_unchanged:\n+    description: \"Halt job if no code changed\"\n     steps:\n       - run:\n           command: |\n-            if [ ${CIRCLE_BRANCH} != \"\" ] &&\n-              [ ${CIRCLE_BRANCH} != \"master\" ] &&\n-              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvE '(.md$)|(.pdf$)'; then\n-                echo \"No code changes on non-master branch. halting job.\"\n-                circleci step halt\n+            if ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvFf .circleci/e2e-job-ignore-patterns.txt; then\n+              echo \"Application code have not changed. halting job.\"\n+              circleci step halt\n+            else\n+              git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -vFf .circleci/e2e-job-ignore-patterns.txt\n+              echo \"job continuing.\"\n             fi", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2NTU4Ng=="}, "originalCommit": {"oid": "ac14b44bab1745104fb252f1d2513e05995b5754"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5NDk3OA==", "bodyText": "So, the else part in shell script is just to show you that non-matching files are the reason job is continuing. I can remove it if you like.", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444994978", "createdAt": "2020-06-24T15:48:39Z", "author": {"login": "aweng98"}, "path": ".circleci/config.yml", "diffHunk": "@@ -100,18 +100,19 @@ commands:\n           name: Update git submodules\n           command: git submodule update --init --recursive\n \n-  halt_job_noncode_changes:\n-    description: \"Halt job and succeed early if no code changes on non-master branch\"\n+  halt_if_code_unchanged:\n+    description: \"Halt job if no code changed\"\n     steps:\n       - run:\n           command: |\n-            if [ ${CIRCLE_BRANCH} != \"\" ] &&\n-              [ ${CIRCLE_BRANCH} != \"master\" ] &&\n-              ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvE '(.md$)|(.pdf$)'; then\n-                echo \"No code changes on non-master branch. halting job.\"\n-                circleci step halt\n+            if ! git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -qvFf .circleci/e2e-job-ignore-patterns.txt; then\n+              echo \"Application code have not changed. halting job.\"\n+              circleci step halt\n+            else\n+              git diff --name-only $(git merge-base origin/master ${CIRCLE_BRANCH}) | grep -vFf .circleci/e2e-job-ignore-patterns.txt\n+              echo \"job continuing.\"\n             fi", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2NTU4Ng=="}, "originalCommit": {"oid": "ac14b44bab1745104fb252f1d2513e05995b5754"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MDAxNjkyOnYy", "diffSide": "RIGHT", "path": "e2e/package.json", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMzo0MDowMFrOGn-Jng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMzo0MDowMFrOGn-Jng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2NTkxOA==", "bodyText": "Unrelated to CircleCI config change, but it's related to running e2e tests in CircleCI. Abort job early if 3 tests have failed.", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444565918", "createdAt": "2020-06-23T23:40:00Z", "author": {"login": "aweng98"}, "path": "e2e/package.json", "diffHunk": "@@ -9,7 +9,7 @@\n     \"test\": \"cross-env WORKBENCH_ENV=dev jest --maxWorkers=3\",\n     \"test:debug\": \"cross-env WORKBENCH_ENV=dev HEADLESS=false jest --detectOpenHandles\",\n     \"test-local\": \"cross-env WORKBENCH_ENV=local jest --maxWorkers=2\",\n-    \"test:ci\": \"cross-env NODE_ENV=development CI=true jest --ci --maxWorkers=2 --forceExit\",\n+    \"test:ci\": \"cross-env NODE_ENV=development CI=true jest --ci --maxWorkers=1\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac14b44bab1745104fb252f1d2513e05995b5754"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MjYxNDE1OnYy", "diffSide": "RIGHT", "path": ".circleci/config.yml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNToyNjo1NVrOGoXazg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNToyODoxOVrOGoXe9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3OTkxOA==", "bodyText": "Awesome! I didn't see where you checked this in.", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444979918", "createdAt": "2020-06-24T15:26:55Z", "author": {"login": "jaycarlton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -604,11 +604,11 @@ workflows:\n           requires:\n             - ui-unit-test\n       # On master merges, run Puppeteer e2e tests after ui and api deployed to \"test\" env successfully.\n-      # - puppeteer-e2e-test:\n-          # filters: *filter_only_master_branch\n-          # requires:\n-            # - api-deploy-to-test\n-            # - ui-deploy-to-test\n+      - puppeteer-e2e-test:\n+          filters: *filter_only_master_branch", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17191d79d9099e45a620add54746e38f63a9af66"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MDk4Mg==", "bodyText": "Oh, it's the same PR.", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444980982", "createdAt": "2020-06-24T15:28:19Z", "author": {"login": "jaycarlton"}, "path": ".circleci/config.yml", "diffHunk": "@@ -604,11 +604,11 @@ workflows:\n           requires:\n             - ui-unit-test\n       # On master merges, run Puppeteer e2e tests after ui and api deployed to \"test\" env successfully.\n-      # - puppeteer-e2e-test:\n-          # filters: *filter_only_master_branch\n-          # requires:\n-            # - api-deploy-to-test\n-            # - ui-deploy-to-test\n+      - puppeteer-e2e-test:\n+          filters: *filter_only_master_branch", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk3OTkxOA=="}, "originalCommit": {"oid": "17191d79d9099e45a620add54746e38f63a9af66"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MjYyOTQzOnYy", "diffSide": "RIGHT", "path": ".circleci/pr-skip-ci.sh", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNTozMDoxN1rOGoXk0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNTo0NDozN1rOGoYK_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MjQ4Mw==", "bodyText": "Are you scanning the PR description for a Jira Ticket number?\nI thought CircleCI already had a away to disable it for all but pull requests, but I remember we decided not to do that anymore for some reason.", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444982483", "createdAt": "2020-06-24T15:30:17Z", "author": {"login": "jaycarlton"}, "path": ".circleci/pr-skip-ci.sh", "diffHunk": "@@ -0,0 +1,15 @@\n+#!/bin/bash\n+set -e\n+\n+# This script makes CircleCI exit a non pull-request job.\n+\n+echo \"CIRCLE_PULL_REQUEST: ${CIRCLE_PULL_REQUEST}\"\n+regexp=\"[[:digit:]]\\+$\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17191d79d9099e45a620add54746e38f63a9af66"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5MjI1Mw==", "bodyText": "No, not scanning PR description for ticket number.\nThe CircleCI setting to pull on PR only is still enabled, no change there.", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444992253", "createdAt": "2020-06-24T15:44:37Z", "author": {"login": "aweng98"}, "path": ".circleci/pr-skip-ci.sh", "diffHunk": "@@ -0,0 +1,15 @@\n+#!/bin/bash\n+set -e\n+\n+# This script makes CircleCI exit a non pull-request job.\n+\n+echo \"CIRCLE_PULL_REQUEST: ${CIRCLE_PULL_REQUEST}\"\n+regexp=\"[[:digit:]]\\+$\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MjQ4Mw=="}, "originalCommit": {"oid": "17191d79d9099e45a620add54746e38f63a9af66"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3MjY0MTE0OnYy", "diffSide": "RIGHT", "path": ".circleci/e2e-job-ignore-patterns.txt", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNTozMjo1OVrOGoXsTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNTo0NzowMFrOGoYRgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4NDM5OQ==", "bodyText": "If you're doing any screenshot comparison tests (which are kind of a pain), then some of these formats might need to be included. Likewise, if an image's dimensions change, it could make a button inaccessible, etc. So this may be a little strict.", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444984399", "createdAt": "2020-06-24T15:32:59Z", "author": {"login": "jaycarlton"}, "path": ".circleci/e2e-job-ignore-patterns.txt", "diffHunk": "@@ -0,0 +1,10 @@\n+.md\n+.jpg", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17191d79d9099e45a620add54746e38f63a9af66"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk5MzkyMw==", "bodyText": "Good point. Screenshot comparison testing is on the longer term road map.", "url": "https://github.com/all-of-us/workbench/pull/3704#discussion_r444993923", "createdAt": "2020-06-24T15:47:00Z", "author": {"login": "aweng98"}, "path": ".circleci/e2e-job-ignore-patterns.txt", "diffHunk": "@@ -0,0 +1,10 @@\n+.md\n+.jpg", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4NDM5OQ=="}, "originalCommit": {"oid": "17191d79d9099e45a620add54746e38f63a9af66"}, "originalPosition": 2}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2564, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}