{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MTM0NTc1", "number": 3565, "title": "[no ticket][risk=no] Allow RDR export cron failures to throw a server error", "bodyText": "This is a small follow-up based on Jay's observation that exceptions in the RDR export cronjob handler aren't causing the service to return a 500 response.\nScreenshot demonstrating this issue (see the line with a severe error log but a 204 response):\n\nTESTING: I haven't tested locally. I'm willing to try and set up some unit tests for RDR export controller (no test file exists yet), but it will take some DI finagling to get working correctly, so I've punted on this for a first cut of this PR.", "createdAt": "2020-05-11T14:17:51Z", "url": "https://github.com/all-of-us/workbench/pull/3565", "merged": true, "mergeCommit": {"oid": "49b293e10583d5bbb047daf87f70bc6d45aa24cf"}, "closed": true, "closedAt": "2020-05-19T20:00:06Z", "author": {"login": "gjuggler"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgP4aRgH2gAyNDE2MTM0NTc1OmM4NWRiNDlkOGJmYmNlZmU1ODg4YjhkZGM0NGVkYzBhZDM0YjEyNmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci5JvSAFqTQxNDczMjA2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c85db49d8bfbcefe5888b8ddc44edc0ad34b126a", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/c85db49d8bfbcefe5888b8ddc44edc0ad34b126a", "committedDate": "2020-05-11T13:41:51Z", "message": "Return a 500 response code if any part of RDR export task creation fails."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b19b9e73be8f8f57ed4ba2b6da90e59fdc1219e3", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/b19b9e73be8f8f57ed4ba2b6da90e59fdc1219e3", "committedDate": "2020-05-11T13:46:09Z", "message": "Add some clarifying comments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93ac816461781523350922cef1631ebed194e3da", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/93ac816461781523350922cef1631ebed194e3da", "committedDate": "2020-05-11T14:21:44Z", "message": "Spotless fixes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MjkzMzYy", "url": "https://github.com/all-of-us/workbench/pull/3565#pullrequestreview-409293362", "createdAt": "2020-05-11T15:40:26Z", "commit": {"oid": "93ac816461781523350922cef1631ebed194e3da"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNTo0MDoyNlrOGTh-Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxNTo0NjowOVrOGTiNEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEzMjczMQ==", "bodyText": "In a controller you might want to throw a more specific error here and let the handler translate it into a 500, but I'm not sure if that happens with crons. This is fine.", "url": "https://github.com/all-of-us/workbench/pull/3565#discussion_r423132731", "createdAt": "2020-05-11T15:40:26Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineRdrExportController.java", "diffHunk": "@@ -63,14 +68,15 @@\n       try {\n         groupIdsAndPushTask(rdrExportService.findAllUserIdsToExport(), EXPORT_RESEARCHER_PATH);\n       } catch (Exception ex) {\n-        log.severe(\n-            String.format(\"Error while exporting researcher data to RDR: %s\", ex.getMessage()));\n+        throw new ServerErrorException(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ac816461781523350922cef1631ebed194e3da"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEzMzA0OQ==", "bodyText": "If you use this constructor that takes the throwable itself, you keep the stack trace.", "url": "https://github.com/all-of-us/workbench/pull/3565#discussion_r423133049", "createdAt": "2020-05-11T15:40:55Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineRdrExportController.java", "diffHunk": "@@ -63,14 +68,15 @@\n       try {\n         groupIdsAndPushTask(rdrExportService.findAllUserIdsToExport(), EXPORT_RESEARCHER_PATH);\n       } catch (Exception ex) {\n-        log.severe(\n-            String.format(\"Error while exporting researcher data to RDR: %s\", ex.getMessage()));\n+        throw new ServerErrorException(\n+            String.format(\"Error creating RDR export Cloud Tasks for users: %s\", ex.getMessage()));\n       }\n       try {\n         groupIdsAndPushTask(rdrExportService.findAllWorkspacesIdsToExport(), EXPORT_USER_PATH);\n       } catch (Exception ex) {\n-        log.severe(\n-            String.format(\"Error while exporting workspace data to RDR: %s\", ex.getMessage()));\n+        throw new ServerErrorException(\n+            String.format(\n+                \"Error creating RDR export Cloud Tasks for workspaces: %s\", ex.getMessage()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ac816461781523350922cef1631ebed194e3da"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzEzNjUyOA==", "bodyText": "drive-by nit: Above, I'd declare a TaskBuilder and then use taskBuilder.build() in the cal to createTask(). Or just inline the builder.", "url": "https://github.com/all-of-us/workbench/pull/3565#discussion_r423136528", "createdAt": "2020-05-11T15:46:09Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineRdrExportController.java", "diffHunk": "@@ -127,8 +134,10 @@ private void createAndPushTask(List<Long> ids, String queuePath, String taskUri)\n     } catch (IOException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93ac816461781523350922cef1631ebed194e3da"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43b4cba5b437295d45371fd941bb2e46e1f97cd7", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/43b4cba5b437295d45371fd941bb2e46e1f97cd7", "committedDate": "2020-05-19T18:23:19Z", "message": "PR feedback."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NzMyMDY0", "url": "https://github.com/all-of-us/workbench/pull/3565#pullrequestreview-414732064", "createdAt": "2020-05-19T18:51:40Z", "commit": {"oid": "43b4cba5b437295d45371fd941bb2e46e1f97cd7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODo1MTo0MFrOGXuJRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODo1MzowN1rOGXuMTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNjQ2OQ==", "bodyText": "So we need to trigger an alert on the tasks failing in the queue. I bet I can get that from logs somewhere, assuming the tasks live in our GCP-space.", "url": "https://github.com/all-of-us/workbench/pull/3565#discussion_r427526469", "createdAt": "2020-05-19T18:51:40Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineRdrExportController.java", "diffHunk": "@@ -17,13 +17,18 @@\n import javax.inject.Provider;\n import org.pmiops.workbench.config.WorkbenchConfig;\n import org.pmiops.workbench.config.WorkbenchLocationConfigService;\n+import org.pmiops.workbench.exceptions.ServerErrorException;\n import org.pmiops.workbench.rdr.RdrExportService;\n import org.springframework.http.ResponseEntity;\n import org.springframework.web.bind.annotation.RestController;\n \n /**\n- * This offline process is responsible to daily sync up with RDR by creating/pushing multiple task\n- * with eligible user Ids and workspace Ids to cloud task queue\n+ * This offline process is responsible to daily sync up with RDR by creating/pushing multiple Cloud\n+ * Task tasks with eligible user Ids and workspace Ids to cloud task queue.\n+ *\n+ * <p>None of the actual RDR communication occurs from within this cron job handler, so this cron\n+ * may succeed even though the actual export tasks to RDR are failing. See\n+ * CloudTaskRdrExportController for the handlers which do the actual RDR export work.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43b4cba5b437295d45371fd941bb2e46e1f97cd7"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUyNzI0Nw==", "bodyText": "nit: Should the IDs be a Set? Alternatively, just take in a Collection<Long>.", "url": "https://github.com/all-of-us/workbench/pull/3565#discussion_r427527247", "createdAt": "2020-05-19T18:53:07Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineRdrExportController.java", "diffHunk": "@@ -83,7 +86,7 @@\n    * @param idList : Lis of Ids\n    * @param taskUri: The destination URL the task will be calling with group of 10 ids\n    */\n-  private void groupIdsAndPushTask(List<Long> idList, String taskUri) {\n+  private void groupIdsAndPushTask(List<Long> idList, String taskUri) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43b4cba5b437295d45371fd941bb2e46e1f97cd7"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4992, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}