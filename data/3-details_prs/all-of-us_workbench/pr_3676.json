{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MjU4ODIz", "number": 3676, "title": "[RW-4257][risk=moderate] Add support for the new Shibboleth service", "bodyText": "Description\nThis PR adds a feature-flagged connection to the new Shibboleth service, which is operated by Terra as a separate API endpoint from the existing Firecloud-Orchestration API that we currently connect to.\nMost lines of code are boilerplate in support of the new API client and supporting services & config. Only two new pieces of logic are introduced: (1) ProfileController checks the feature flag before deciding which service to call in order to update the Shibboleth token, and (2) registration-dashboard checks the feature flag to decide where to redirect the user for the Shibboleth-eRA Commons login flow.\nI tested this from a local server, and both the login flow and token submission worked as expected. Note that in the dev environment, a user is not auto-redirected to the Workbench page. Instead, you land on a debug-style endpoint with the token and other details.\n*Rollout plan\n\nThis PR enables the new service in test, perf, and staging. This will allow us to QA in the dev environment this week, and QA against the prod Terra environment (via RW staging) before next week's release goes out.\nIf that QA is successful next week, we can cherry-pick a flag-flip PR into the higher environments, potentially in line with the weekly release.\n\nStep-by-step screenshots:\n\n\n\n\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked a new JIRA ticket to remove it later.", "createdAt": "2020-06-16T14:34:35Z", "url": "https://github.com/all-of-us/workbench/pull/3676", "merged": true, "mergeCommit": {"oid": "d2b6435fc8afc8447769f21bfded310b800e3858"}, "closed": true, "closedAt": "2020-06-16T19:36:00Z", "author": {"login": "gjuggler"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcr2XSSAFqTQzMTU3MjA0NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsLCshgFqTQzMjQ4Mjk3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNTcyMDQ1", "url": "https://github.com/all-of-us/workbench/pull/3676#pullrequestreview-431572045", "createdAt": "2020-06-16T14:35:49Z", "commit": {"oid": "875dc72a107cd8a4e9541e62187285079eb8353e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDozNTo0OVrOGkecNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNDozODo1M1rOGkelZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkwMDY2MQ==", "bodyText": "This is a somewhat opportunistic change / cleanup: the return value from postNihCallback was never used.", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r440900661", "createdAt": "2020-06-16T14:35:49Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/firecloud/FireCloudService.java", "diffHunk": "@@ -111,7 +111,9 @@ FirecloudWorkspaceACLUpdateResponseList updateWorkspaceACL(\n    */\n   FirecloudNihStatus getNihStatus();\n \n-  FirecloudNihStatus postNihCallback(FirecloudJWTWrapper wrapper);\n+  // Submits a Shibboleth JWT for verification and update using the old-style Shibboleth service\n+  // (via Firecloud Orchestration API).\n+  void postNihCallback(FirecloudJWTWrapper wrapper);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "875dc72a107cd8a4e9541e62187285079eb8353e"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkwMjI4MA==", "bodyText": "I opted to use the standard \"firecloud\" API client config variables here. Even though Shibboleth is a distinct service, I felt it was simpler to use this standard set of API client variables rather than either (1) proliferate with add'l Shibboleth-specific configs or (2) use the ApiClient defaults. I'm open to objections here.", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r440902280", "createdAt": "2020-06-16T14:37:55Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/shibboleth/ShibbolethConfig.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.pmiops.workbench.shibboleth;\n+\n+import java.util.concurrent.TimeUnit;\n+import org.pmiops.workbench.auth.UserAuthentication;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.shibboleth.api.ShibbolethApi;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.ScopedProxyMode;\n+import org.springframework.web.context.annotation.RequestScope;\n+\n+@org.springframework.context.annotation.Configuration\n+public class ShibbolethConfig {\n+  public static final String X_APP_ID_HEADER = \"X-App-ID\";\n+\n+  @Bean\n+  @RequestScope(proxyMode = ScopedProxyMode.DEFAULT)\n+  public ShibbolethApi shibbolethApi(\n+      UserAuthentication userAuthentication, WorkbenchConfig workbenchConfig) {\n+    ApiClient apiClient = new ApiClient();\n+    apiClient.setBasePath(workbenchConfig.firecloud.shibbolethApiBaseUrl);\n+    apiClient.addDefaultHeader(X_APP_ID_HEADER, workbenchConfig.firecloud.xAppIdValue);\n+    apiClient.setDebugging(workbenchConfig.firecloud.debugEndpoints);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "875dc72a107cd8a4e9541e62187285079eb8353e"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkwMzAxNA==", "bodyText": "I basically copied this from FirecloudRetryHandler. It felt like an awful lot of boilerplate for a single new API call, but I didn't see an obvious alternative.", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r440903014", "createdAt": "2020-06-16T14:38:53Z", "author": {"login": "gjuggler"}, "path": "api/src/main/java/org/pmiops/workbench/shibboleth/ShibbolethRetryHandler.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package org.pmiops.workbench.shibboleth;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "875dc72a107cd8a4e9541e62187285079eb8353e"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57e34c6da3cd22fc9c66f47f57cb3ae46d87da2a", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/57e34c6da3cd22fc9c66f47f57cb3ae46d87da2a", "committedDate": "2020-06-16T16:19:16Z", "message": "Create a new Shibboleth service YAML and package."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "868b2c3d4dc8ef87f571107c08c9c67ac9362f36", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/868b2c3d4dc8ef87f571107c08c9c67ac9362f36", "committedDate": "2020-06-16T16:19:17Z", "message": "Self-review fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf3c670d176268d8df2861f452663b0de6889561", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/cf3c670d176268d8df2861f452663b0de6889561", "committedDate": "2020-06-16T16:19:17Z", "message": "Small fix to deafult server config."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40161e0dd345d15d7e5ef7e7702d6d858c2fc596", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/40161e0dd345d15d7e5ef7e7702d6d858c2fc596", "committedDate": "2020-06-16T16:19:17Z", "message": "Revert capitalization change (changed my mind)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c59f712c3d8880c200dde12ebd49377788b31a86", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/c59f712c3d8880c200dde12ebd49377788b31a86", "committedDate": "2020-06-16T16:19:17Z", "message": "Add missing @Service annotation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cbf6ea3d8aa2e164bf045855a347bb44e2a36c1", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/2cbf6ea3d8aa2e164bf045855a347bb44e2a36c1", "committedDate": "2020-06-16T16:40:38Z", "message": "Flip feature on in test / perf / staging."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNzUwMTQ1", "url": "https://github.com/all-of-us/workbench/pull/3676#pullrequestreview-431750145", "createdAt": "2020-06-16T17:49:15Z", "commit": {"oid": "f85483987a94aa5851ba63591dd80342894ea6f4"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxNzo0OToxNVrOGkmjUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxODowMDoyM1rOGkm9gA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzMzU1NQ==", "bodyText": "Should this go inside the try?  Alternately, should we remove the try/catch since all it does is rethrow?", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441033555", "createdAt": "2020-06-16T17:49:15Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/api/ProfileController.java", "diffHunk": "@@ -833,9 +837,14 @@ private void updateInstitutionalAffiliations(Profile updatedProfile, DbUser user\n     if (token == null || token.getJwt() == null) {\n       throw new BadRequestException(\"Token is required.\");\n     }\n-    FirecloudJWTWrapper wrapper = new FirecloudJWTWrapper().jwt(token.getJwt());\n+\n+    if (workbenchConfigProvider.get().featureFlags.useNewShibbolethService) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f85483987a94aa5851ba63591dd80342894ea6f4"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNTUzMA==", "bodyText": "interesting path here.  Just want to confirm: \"prod/dev\" is right?", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441035530", "createdAt": "2020-06-16T17:52:32Z", "author": {"login": "jmthibault79"}, "path": "api/config/config_local.json", "diffHunk": "@@ -13,7 +13,9 @@\n     \"vpcServicePerimeterName\": \"accessPolicies/228353087260/servicePerimeters/terra_dev_aou_test\",\n     \"timeoutInSeconds\": 60,\n     \"jupyterDockerImage\": \"broadinstitute/terra-jupyter-aou:0.0.1\",\n-    \"welderDockerImage\": \"broadinstitute/welder-server:7ae1a62\"\n+    \"welderDockerImage\": \"broadinstitute/welder-server:7ae1a62\",\n+    \"shibbolethApiBaseUrl\": \"https:\\/\\/profile-dot-broad-shibboleth-prod.appspot.com/dev\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f85483987a94aa5851ba63591dd80342894ea6f4"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNTc1Nw==", "bodyText": "add /dev here?", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441035757", "createdAt": "2020-06-16T17:52:55Z", "author": {"login": "jmthibault79"}, "path": "api/config/config_perf.json", "diffHunk": "@@ -13,7 +13,9 @@\n     \"vpcServicePerimeterName\": \"accessPolicies/228353087260/servicePerimeters/terra_perf_aou_perf\",\n     \"timeoutInSeconds\": 60,\n     \"jupyterDockerImage\": \"broadinstitute/terra-jupyter-aou:0.0.1\",\n-    \"welderDockerImage\": \"broadinstitute/welder-server:7ae1a62\"\n+    \"welderDockerImage\": \"broadinstitute/welder-server:7ae1a62\",\n+    \"shibbolethApiBaseUrl\": \"https:\\/\\/profile-dot-broad-shibboleth-prod.appspot.com/dev\",\n+    \"shibbolethUiBaseUrl\": \"https:\\/\\/broad-shibboleth-prod.appspot.com\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f85483987a94aa5851ba63591dd80342894ea6f4"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTAzNjEwOA==", "bodyText": "/dev here?", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441036108", "createdAt": "2020-06-16T17:53:33Z", "author": {"login": "jmthibault79"}, "path": "api/config/config_test.json", "diffHunk": "@@ -13,7 +13,9 @@\n     \"vpcServicePerimeterName\": \"accessPolicies/228353087260/servicePerimeters/terra_dev_aou_test\",\n     \"timeoutInSeconds\": 60,\n     \"jupyterDockerImage\": \"broadinstitute/terra-jupyter-aou:0.0.1\",\n-    \"welderDockerImage\": \"broadinstitute/welder-server:7ae1a62\"\n+    \"welderDockerImage\": \"broadinstitute/welder-server:7ae1a62\",\n+    \"shibbolethApiBaseUrl\": \"https:\\/\\/profile-dot-broad-shibboleth-prod.appspot.com/dev\",\n+    \"shibbolethUiBaseUrl\": \"https:\\/\\/broad-shibboleth-prod.appspot.com\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f85483987a94aa5851ba63591dd80342894ea6f4"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA0MDI1Ng==", "bodyText": "This is probably fine", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441040256", "createdAt": "2020-06-16T18:00:23Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/shibboleth/ShibbolethConfig.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.pmiops.workbench.shibboleth;\n+\n+import java.util.concurrent.TimeUnit;\n+import org.pmiops.workbench.auth.UserAuthentication;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.shibboleth.api.ShibbolethApi;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.ScopedProxyMode;\n+import org.springframework.web.context.annotation.RequestScope;\n+\n+@org.springframework.context.annotation.Configuration\n+public class ShibbolethConfig {\n+  public static final String X_APP_ID_HEADER = \"X-App-ID\";\n+\n+  @Bean\n+  @RequestScope(proxyMode = ScopedProxyMode.DEFAULT)\n+  public ShibbolethApi shibbolethApi(\n+      UserAuthentication userAuthentication, WorkbenchConfig workbenchConfig) {\n+    ApiClient apiClient = new ApiClient();\n+    apiClient.setBasePath(workbenchConfig.firecloud.shibbolethApiBaseUrl);\n+    apiClient.addDefaultHeader(X_APP_ID_HEADER, workbenchConfig.firecloud.xAppIdValue);\n+    apiClient.setDebugging(workbenchConfig.firecloud.debugEndpoints);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDkwMjI4MA=="}, "originalCommit": {"oid": "875dc72a107cd8a4e9541e62187285079eb8353e"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ac0ce660ed0a23cbdc192e057947dcb1e5d2c63", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/1ac0ce660ed0a23cbdc192e057947dcb1e5d2c63", "committedDate": "2020-06-16T18:44:05Z", "message": "PR feedback."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f85483987a94aa5851ba63591dd80342894ea6f4", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/f85483987a94aa5851ba63591dd80342894ea6f4", "committedDate": "2020-06-16T16:04:45Z", "message": "Add missing @Service annotation"}, "afterCommit": {"oid": "1ac0ce660ed0a23cbdc192e057947dcb1e5d2c63", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/1ac0ce660ed0a23cbdc192e057947dcb1e5d2c63", "committedDate": "2020-06-16T18:44:05Z", "message": "PR feedback."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc17527542a86a9fdde1a87168f7e87b2273a18b", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/dc17527542a86a9fdde1a87168f7e87b2273a18b", "committedDate": "2020-06-16T19:21:07Z", "message": "Token template char is angle bracket, not curly brace."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxODI2MDI1", "url": "https://github.com/all-of-us/workbench/pull/3676#pullrequestreview-431826025", "createdAt": "2020-06-16T19:27:58Z", "commit": {"oid": "dc17527542a86a9fdde1a87168f7e87b2273a18b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNDgyOTc5", "url": "https://github.com/all-of-us/workbench/pull/3676#pullrequestreview-432482979", "createdAt": "2020-06-17T14:50:38Z", "commit": {"oid": "dc17527542a86a9fdde1a87168f7e87b2273a18b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNDo1MDozOFrOGlJe-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNDo1MDozOFrOGlJe-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwNTg4Mw==", "bodyText": "Something I learned recently for you to consider: The \"X-\" prefix is no longer recommended [1].\n[1] https://tools.ietf.org/html/rfc6648", "url": "https://github.com/all-of-us/workbench/pull/3676#discussion_r441605883", "createdAt": "2020-06-17T14:50:38Z", "author": {"login": "dmohs"}, "path": "api/src/main/java/org/pmiops/workbench/shibboleth/ShibbolethConfig.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package org.pmiops.workbench.shibboleth;\n+\n+import java.util.concurrent.TimeUnit;\n+import org.pmiops.workbench.auth.UserAuthentication;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.shibboleth.api.ShibbolethApi;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.ScopedProxyMode;\n+import org.springframework.web.context.annotation.RequestScope;\n+\n+@Configuration\n+public class ShibbolethConfig {\n+  public static final String X_APP_ID_HEADER = \"X-App-ID\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc17527542a86a9fdde1a87168f7e87b2273a18b"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4566, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}