{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2NDk0MjA3", "number": 3684, "title": "[RW-2400][RISK=HIGH] Prompt to update research purpose", "bodyText": "If the workspace is 15 days or an year old : When the user clicks on the workspace card show the following pop up\n\nReview Now will take the researcher to About tab  (with DATA AND ANALYSIS TAB disabled)\n\nClicking Looks Good will reload the page , remove the banner and enable DATA/ANALYSIS tab\nClicking Update will redirect to workspace edit page\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test-local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-06-18T14:00:59Z", "url": "https://github.com/all-of-us/workbench/pull/3684", "merged": true, "mergeCommit": {"oid": "cd5b5e28f3fdb8704994ef7a35ccb0fae1b08bbd"}, "closed": true, "closedAt": "2020-06-23T18:20:34Z", "author": {"login": "NehaBroad"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrh8jbAH2gAyNDM2NDk0MjA3OjM4MDM4YjgyMzkyMDM4NzBhMGE3MGZmZmYyOGZkZGNlYjgwOWYxOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuJWivAH2gAyNDM2NDk0MjA3OjU1NmNlMDUwZjQyNWJiMGEzODM4NGQ4ODlmOWYzZmYxZmY3NGM5ZGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "38038b8239203870a0a70ffff28fddceb809f191", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/38038b8239203870a0a70ffff28fddceb809f191", "committedDate": "2020-06-15T14:57:50Z", "message": "Prompt research purpose review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1707d51c86fe113266d1852b5cfdfc7fa4639cc2", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/1707d51c86fe113266d1852b5cfdfc7fa4639cc2", "committedDate": "2020-06-16T17:42:24Z", "message": "Comments from Karthik"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab02b6e52bb44b56ea7b293225457f5bb31b616e", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/ab02b6e52bb44b56ea7b293225457f5bb31b616e", "committedDate": "2020-06-18T13:48:48Z", "message": "Feature flag and other feedback from Lou"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "676c04e7f3ccc7f011f30b1f219b844e82791f8b", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/676c04e7f3ccc7f011f30b1f219b844e82791f8b", "committedDate": "2020-06-19T05:46:27Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dbaa5c38bfff5d2a2e296d64c22c2a31941e2b2", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/7dbaa5c38bfff5d2a2e296d64c22c2a31941e2b2", "committedDate": "2020-06-19T05:55:36Z", "message": "removing test as its no longer needed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f7735f3dbffe4f50d61973e5e5705262847a9e8", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/6f7735f3dbffe4f50d61973e5e5705262847a9e8", "committedDate": "2020-06-19T13:47:02Z", "message": "Fix Api test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8c7c9756e943e966ca07ccb3d7452d2372010ee", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/d8c7c9756e943e966ca07ccb3d7452d2372010ee", "committedDate": "2020-06-19T14:08:01Z", "message": "Merge branch 'master' into nsaxena/PromptResearchPurpose"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/05c4a92b121355144ed843b3bc1f4bae232d303a", "committedDate": "2020-06-19T14:12:13Z", "message": "Fix config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ccbeceaafd6f3b2fd26761c53e52d54f9ea639a", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/5ccbeceaafd6f3b2fd26761c53e52d54f9ea639a", "committedDate": "2020-06-19T14:29:40Z", "message": "too many review attributes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MTI4Mjg3", "url": "https://github.com/all-of-us/workbench/pull/3684#pullrequestreview-434128287", "createdAt": "2020-06-19T14:37:33Z", "commit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNDozNzozM1rOGmXHcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNToxOToyM1rOGmYg_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg3NzgxMQ==", "bodyText": "What does this comment mean? Can you specify in this comment that we want to prompt when a workspace FIRST goes over 15 days old and then EVERY 365 days?", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442877811", "createdAt": "2020-06-19T14:37:33Z", "author": {"login": "als364"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineWorkspaceController.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.api;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import javax.inject.Provider;\n+import org.joda.time.DateTime;\n+import org.joda.time.DateTimeComparator;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.db.dao.WorkspaceDao;\n+import org.pmiops.workbench.db.model.DbWorkspace;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+@RestController\n+public class OfflineWorkspaceController implements OfflineWorkspaceApiDelegate {\n+\n+  private final WorkspaceDao workspaceDao;\n+  private final Provider<WorkbenchConfig> configProvider;\n+\n+  @Autowired\n+  OfflineWorkspaceController(Provider<WorkbenchConfig> configProvider, WorkspaceDao workspaceDao) {\n+    this.configProvider = configProvider;\n+    this.workspaceDao = workspaceDao;\n+  }\n+\n+  @Override\n+  public ResponseEntity<Void> updateResearchPurposeReview() {\n+    if (configProvider.get().featureFlags.enableResearchPurposePrompt) {\n+      List<DbWorkspace> workspaceList = workspaceDao.findAllByReviewResearchPurpose((short) 1);\n+\n+      // 1. Filter out workspace where creation date is 365 days or 15 days", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4NjUzMA==", "bodyText": "I'm not sure what this logic is doing. Comparing against null should always fail and we don't want to always show the prompt. I also don't think we should be looking at direct equality. Per the ticket, we really want to check the following:\n\nis the workspace older than 15 days and hasn't yet had a research purpose update? if so, prompt.\nhas the workspace research purpose been updated in the past 365 days? if not, prompt.\nWe don't currently have a concept of 'when was the research purpose last updated' and we need to introduce one.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442886530", "createdAt": "2020-06-19T14:53:40Z", "author": {"login": "als364"}, "path": "api/src/main/java/org/pmiops/workbench/api/OfflineWorkspaceController.java", "diffHunk": "@@ -0,0 +1,71 @@\n+package org.pmiops.workbench.api;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import javax.inject.Provider;\n+import org.joda.time.DateTime;\n+import org.joda.time.DateTimeComparator;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.db.dao.WorkspaceDao;\n+import org.pmiops.workbench.db.model.DbWorkspace;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.http.ResponseEntity;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+@RestController\n+public class OfflineWorkspaceController implements OfflineWorkspaceApiDelegate {\n+\n+  private final WorkspaceDao workspaceDao;\n+  private final Provider<WorkbenchConfig> configProvider;\n+\n+  @Autowired\n+  OfflineWorkspaceController(Provider<WorkbenchConfig> configProvider, WorkspaceDao workspaceDao) {\n+    this.configProvider = configProvider;\n+    this.workspaceDao = workspaceDao;\n+  }\n+\n+  @Override\n+  public ResponseEntity<Void> updateResearchPurposeReview() {\n+    if (configProvider.get().featureFlags.enableResearchPurposePrompt) {\n+      List<DbWorkspace> workspaceList = workspaceDao.findAllByReviewResearchPurpose((short) 1);\n+\n+      // 1. Filter out workspace where creation date is 365 days or 15 days\n+      // 2. set Research Purpose Review to FALSE\n+      // 3. Update workspace\n+      workspaceList =\n+          workspaceList.stream()\n+              .filter(\n+                  workspace -> {\n+                    DateTime workspaceCreationDate = new DateTime(workspace.getCreationTime());\n+                    DateTime workspaceModifiedDate = new DateTime(workspace.getLastModifiedTime());\n+                    return checkReviewDate(workspaceCreationDate, workspaceModifiedDate);\n+                  })\n+              .map(\n+                  filteredWorkspace -> {\n+                    filteredWorkspace.setResearchPurposeReviewed(false);\n+                    return filteredWorkspace;\n+                  })\n+              .collect(Collectors.toList());\n+      workspaceDao.save(workspaceList);\n+    }\n+    return ResponseEntity.noContent().build();\n+  }\n+\n+  private boolean checkReviewDate(DateTime workspaceCreationDate, DateTime workspaceModifiedDate) {\n+    DateTime creationDatePlus15 = workspaceCreationDate.plusDays(15);\n+    DateTime creationDatePlus1Year = workspaceCreationDate.plusYears(1);\n+\n+    // True if\n+    // 1. Current date is creation Date + 1 year or\n+    // 2. Current date is 15 days after creation date or\n+    // 3. Current Date is AFTER an year of creation date (in case cron job did not run/ missed\n+    // picking the workspace) and the Workspace has\n+    // not been modified after 1 year of creation date.\n+    int compareCreationDatePlus1Year =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg4NzY3OQ==", "bodyText": "What does 'research purpose review' mean? By my understanding this should be named something more like needs_rp_review_prompt. This also sounds a lot like rp_review_requested which could be confusing.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442887679", "createdAt": "2020-06-19T14:55:34Z", "author": {"login": "als364"}, "path": "api/db/changelog/db.changelog-136-workspace-researchpurpose-review.xml", "diffHunk": "@@ -0,0 +1,14 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<databaseChangeLog\n+  xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\n+                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\n+  <changeSet author=\"nsaxena\" id=\"changelog-136-workspace-add-researchpurpose-review\">\n+    <addColumn tableName=\"workspace\">\n+      <column name=\"research_purpose_review\" type=\"tinyint\" defaultValueNumeric=\"1\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5Mzk0NA==", "bodyText": "This makes it sound like it's reviewing the research purpose, which is actually handled by reviewWorkspace.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442893944", "createdAt": "2020-06-19T15:06:28Z", "author": {"login": "als364"}, "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -1527,6 +1527,22 @@ paths:\n           description: Internal Error\n           schema:\n             \"$ref\": \"#/definitions/ErrorResponse\"\n+\n+  \"/v1/cron/updateResearchPurposeReview\":\n+    get:\n+      tags:\n+      - offlineWorkspace\n+      - cron\n+      description: Updates each Workspace Research Purpose Review", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5NTEzMw==", "bodyText": "nit: this sounds like it automatically reviews the research purpose twice. this should say something more like:\n'Marks a workspace to prompt the user to review the research purpose, if the workspace has existed for more than 15 days without research purpose review or if the research purpose has not been reviewed int he past 365 days.'", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442895133", "createdAt": "2020-06-19T15:08:47Z", "author": {"login": "als364"}, "path": "api/src/main/webapp/WEB-INF/cron_default.yaml", "diffHunk": "@@ -76,6 +76,13 @@ cron:\n     that is (1) after the close of normal business working hours, and (2) early enough in the evening that the\n     entire export (and downstream data flows) can complete before start of the next business day.\n   url: /v1/cron/exportToRdr\n+  schedule: every day 22:00\n+  timezone: America/Chicago\n+  target: api\n+- description: >\n+    Update Research Purpose Review for each workspace to true, if the workspace has been created for more than 17 or 365 days", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5ODIyNg==", "bodyText": "Ideally, we would do this logic in the WorkspaceService with a dedicated endpoint just for updating whether the user has reviewed the research purpose.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442898226", "createdAt": "2020-06-19T15:14:33Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/workspace/research-purpose.tsx", "diffHunk": "@@ -51,8 +54,26 @@ const styles = reactStyles({\n   sectionText: {\n     fontSize: '14px', lineHeight: '24px', color: colors.primary, marginTop: '0.3rem'\n   },\n+  reviewPurposeReminder: {\n+    marginTop: '0.3rem',\n+    borderStyle: 'solid',\n+    height: '2.5rem',\n+    color: colors.primary,\n+    alignItems: 'center',\n+    justifyContent: 'center',\n+    borderColor: colors.warning,\n+    borderRadius: '0.4rem',\n+    borderWidth: '0.1rem',\n+    backgroundColor: colorWithWhiteness(colors.highlight, 0.7)\n+  }\n });\n \n+function updateWorkspace(workspace) {\n+  workspace.researchPurpose.researchPurposeReviewed = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg5OTM2Ng==", "bodyText": "I don't have access to the design mock - does it really say 'looks good'?", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442899366", "createdAt": "2020-06-19T15:16:32Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/workspace/research-purpose.tsx", "diffHunk": "@@ -71,6 +92,21 @@ export const ResearchPurpose = withCurrentWorkspace()(\n                               style={styles.editIcon}/>\n         </Clickable>\n       </div>\n+      {isOwner && !workspace.researchPurpose.researchPurposeReviewed && <FlexRow style={styles.reviewPurposeReminder}>\n+        <ClrIcon style={{color: colors.warning, marginLeft: '0.3rem'}} className='is-solid'\n+        shape='exclamation-triangle' size='25'/>\n+        <FlexColumn style={{paddingRight: '0.5rem', paddingLeft: '0.5rem', color: colors.primary}}>\n+        <label style={{fontWeight: 600, fontSize: '14px', flex: 1}}>\n+        Please update or verify the following Research Purpose.</label>\n+        </FlexColumn>\n+        <div style={{marginLeft: 'auto', marginRight: '0.5rem'}}>\n+        <a style={{marginRight: '0.5rem'}} onClick={() => updateWorkspace(workspace)}>Looks", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkwMDMwMg==", "bodyText": "thanks for pulling this out, it was getting a bit big inline.", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442900302", "createdAt": "2020-06-19T15:18:27Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/workspace/workspace-card.tsx", "diffHunk": "@@ -222,10 +225,28 @@ export class WorkspaceCard extends React.Component<WorkspaceCardProps, Workspace\n     await this.props.reload();\n   }\n \n+  handleReviewResearchPurpose() {\n+    const {workspace} = this.props;\n+    navigate(['workspaces', workspace.namespace, workspace.id, 'about']);\n+\n+  }\n+\n+  onClick() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjkwMDczNQ==", "bodyText": "Shouldn't this only be true if the user reviews the research purpose rather than just updating other aspects of the workspace?", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r442900735", "createdAt": "2020-06-19T15:19:23Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -691,6 +691,7 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n             });\n           workspace = cloneWorkspace.workspace;\n         } else {\n+          workspace.researchPurpose.researchPurposeReviewed = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c4a92b121355144ed843b3bc1f4bae232d303a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0000feed44268be07392ceb93be973b20c6ecb9", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/b0000feed44268be07392ceb93be973b20c6ecb9", "committedDate": "2020-06-23T03:58:45Z", "message": "PR Comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1ODgyNzA3", "url": "https://github.com/all-of-us/workbench/pull/3684#pullrequestreview-435882707", "createdAt": "2020-06-23T15:09:46Z", "commit": {"oid": "b0000feed44268be07392ceb93be973b20c6ecb9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTowOTo0NlrOGnt5Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTowOTo0NlrOGnt5Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI5OTU2Mg==", "bodyText": "nit: I would name this endpoint markResearchPurposeReviewed, so that it describes an action", "url": "https://github.com/all-of-us/workbench/pull/3684#discussion_r444299562", "createdAt": "2020-06-23T15:09:46Z", "author": {"login": "als364"}, "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -790,6 +790,22 @@ paths:\n           description: Workspace deletion request accepted\n           schema:\n             \"$ref\": \"#/definitions/EmptyResponse\"\n+\n+  \"/v1/workspaces/{workspaceNamespace}/{workspaceId}/researchPurposeReviewed\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0000feed44268be07392ceb93be973b20c6ecb9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "556ce050f425bb0a38384d889f9f3ff1ff74c9db", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/556ce050f425bb0a38384d889f9f3ff1ff74c9db", "committedDate": "2020-06-23T18:00:22Z", "message": "PR Comment endpoint name change and text change for popup and banner"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4582, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}