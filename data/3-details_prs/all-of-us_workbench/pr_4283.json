{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMDcxMTEz", "number": 4283, "title": "[risk=low][RW-5564] Default to latest CDR on Workspace dupe and show upgrade message", "bodyText": "Description:\nThis is only a partial completion of RW-5564.  The warning modal for non-latest CDR Version is not implemented here.\nThis also changes the Workspace Duplication UX to always choose the latest CDR Version for duplication.  It does not prevent choosing an older version intentionally.  It also does not warn when doing so - that will be part of the next RW-5564 PR.\n\nNote: \"v3 with Microarray\" is the older version of the CDR in my local environment.  In production it will likely look more like \"you are upgrading from v5 to v8\"\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test-local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-11-12T18:21:55Z", "url": "https://github.com/all-of-us/workbench/pull/4283", "merged": true, "mergeCommit": {"oid": "6d6124883de68fa95ac3b8a0f5e471aa3b5af2c9"}, "closed": true, "closedAt": "2020-11-13T22:12:56Z", "author": {"login": "jmthibault79"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdb13eQgH2gAyNTIwMDcxMTEzOmZiYmQ3ZWQ1YWEyZjRhNmIwYWMyMTVhYTY1NDgwNWRmZDk0ZTc5MzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdcOJr_AH2gAyNTIwMDcxMTEzOjlmM2RiOTQ1ZWZkNDVlYmViMDMwNjcyZjkzNzdiODU4NTY5OTMxZmY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fbbd7ed5aa2f4a6b0ac215aa654805dfd94e7933", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/fbbd7ed5aa2f4a6b0ac215aa654805dfd94e7933", "committedDate": "2020-11-12T17:18:45Z", "message": "copy props and always preselect the default CDR Version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1c547a34a94262a5c4bdc1227a51a2b53a766d3", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/d1c547a34a94262a5c4bdc1227a51a2b53a766d3", "committedDate": "2020-11-12T17:46:49Z", "message": "app/utils/cdr-versions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1585bd96b6ff10b8a05e88802688f80e7776f801", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/1585bd96b6ff10b8a05e88802688f80e7776f801", "committedDate": "2020-11-12T17:46:54Z", "message": "New CdrVersionUpgrade component"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61b2a737b4a74b68af28a8f712322f439e508eec", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/61b2a737b4a74b68af28a8f712322f439e508eec", "committedDate": "2020-11-12T18:07:27Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56", "committedDate": "2020-11-12T18:10:48Z", "message": "rm extraneous warning components - TBD!"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5Mzc4NjQ3", "url": "https://github.com/all-of-us/workbench/pull/4283#pullrequestreview-529378647", "createdAt": "2020-11-12T18:36:53Z", "commit": {"oid": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODozNjo1M1rOHyIcmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODozNjo1M1rOHyIcmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMyOTI0Mg==", "bodyText": "the next PR will also look for a new \"are you sure?\" popup here", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r522329242", "createdAt": "2020-11-12T18:36:53Z", "author": {"login": "jmthibault79"}, "path": "e2e/tests/workspace/workspace-duplicate.spec.ts", "diffHunk": "@@ -76,4 +77,85 @@ describe('Duplicate workspace', () => {\n       await dataPage.deleteWorkspace();\n     });\n \n+  test('OWNER can duplicate workspace to an older CDR Version via Workspace card', async () => {\n+    const workspaceCard: WorkspaceCard = await createWorkspace(page, config.defaultCdrVersionName);\n+    const originalWorkspaceName = await workspaceCard.getWorkspaceName();\n+\n+    await workspaceCard.asElementHandle().hover();\n+    // Click on Ellipsis menu \"Duplicate\" option.\n+    await workspaceCard.selectSnowmanMenu(Option.Duplicate);\n+\n+    // Fill out Workspace Name should be just enough for successful duplication\n+    const workspacesPage = new WorkspacesPage(page);\n+    await (await workspacesPage.getWorkspaceNameTextbox()).clear();\n+    const duplicateWorkspaceName = await workspacesPage.fillOutWorkspaceName();\n+\n+    // change CDR Version\n+    await workspacesPage.selectCdrVersion(config.altCdrVersionName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3841d3cd74f5de394885597f20364c4cb2279ca0", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/3841d3cd74f5de394885597f20364c4cb2279ca0", "committedDate": "2020-11-12T18:40:02Z", "message": "spacing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MzgxNjQ2", "url": "https://github.com/all-of-us/workbench/pull/4283#pullrequestreview-529381646", "createdAt": "2020-11-12T18:40:55Z", "commit": {"oid": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MDo1NlrOHyImow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MDo1NlrOHyImow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMTgxMQ==", "bodyText": "Also fixes a bug: Duplication screen showed \"Duplicate of Duplicate of My Workspace\"", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r522331811", "createdAt": "2020-11-12T18:40:56Z", "author": {"login": "jmthibault79"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -315,7 +346,8 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n      * \"reviewRequested\" flag, which depend on the workspace state & edit mode.\n      */\n     createInitialWorkspaceState(): Workspace {\n-      let workspace: Workspace = this.props.workspace;\n+      // copy the props into a new object so our modifications here don't affect them\n+      let workspace: Workspace = {...this.props.workspace};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MzgyODg1", "url": "https://github.com/all-of-us/workbench/pull/4283#pullrequestreview-529382885", "createdAt": "2020-11-12T18:42:31Z", "commit": {"oid": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MjozMlrOHyIqNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MjozMlrOHyIqNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMjcyNQ==", "bodyText": "unrelated", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r522332725", "createdAt": "2020-11-12T18:42:32Z", "author": {"login": "jmthibault79"}, "path": "ui/src/app/utils/authorities.spec.tsx", "diffHunk": "@@ -10,7 +10,7 @@ const accessAuth = {...ProfileStubVariables.PROFILE_STUB, authorities: [Authorit\n const devAuth = {...ProfileStubVariables.PROFILE_STUB, authorities: [Authority.DEVELOPER]}\n const featuredWsAuth = {...ProfileStubVariables.PROFILE_STUB, authorities: [Authority.FEATUREDWORKSPACEADMIN]}\n \n-describe('auth', () => {\n+describe('authorities', () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59161b85e8ee49b22c94ddf62933c5fc6e3501fa", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/59161b85e8ee49b22c94ddf62933c5fc6e3501fa", "committedDate": "2020-11-12T18:45:45Z", "message": "lint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNDAwMDM4", "url": "https://github.com/all-of-us/workbench/pull/4283#pullrequestreview-530400038", "createdAt": "2020-11-13T20:38:27Z", "commit": {"oid": "59161b85e8ee49b22c94ddf62933c5fc6e3501fa"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMDozODoyN1rOHy-QaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToxOTo0N1rOHy_6ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIxMDg1Nw==", "bodyText": "nit: are the extra parens needed?", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r523210857", "createdAt": "2020-11-13T20:38:27Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -366,13 +398,9 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n         workspace.researchPurpose.reviewRequested = false;\n       }\n \n-      const selectedCdrIsLive = this.getLiveCdrVersions().some(\n-        cdr => cdr.cdrVersionId === workspace.cdrVersionId);\n       // We preselect the default CDR version when a new workspace is being\n-      // created (via create or duplicate), but leave as-is if the selected CDR\n-      // version is live.\n-      if (this.isMode(WorkspaceEditMode.Create) ||\n-        (this.isMode(WorkspaceEditMode.Duplicate) && !selectedCdrIsLive)) {\n+      // created (via create or duplicate)\n+      if (this.isMode(WorkspaceEditMode.Create) || (this.isMode(WorkspaceEditMode.Duplicate))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59161b85e8ee49b22c94ddf62933c5fc6e3501fa"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNDA4MA==", "bodyText": "nit: is the full text needed for the test? Would the originalWorkspaceName be enough?", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r523234080", "createdAt": "2020-11-13T21:10:32Z", "author": {"login": "petesantos"}, "path": "e2e/tests/workspace/workspace-duplicate.spec.ts", "diffHunk": "@@ -76,4 +77,85 @@ describe('Duplicate workspace', () => {\n       await dataPage.deleteWorkspace();\n     });\n \n+  test('OWNER can duplicate workspace to an older CDR Version via Workspace card', async () => {\n+    const workspaceCard: WorkspaceCard = await createWorkspace(page, config.defaultCdrVersionName);\n+    const originalWorkspaceName = await workspaceCard.getWorkspaceName();\n+\n+    await workspaceCard.asElementHandle().hover();\n+    // Click on Ellipsis menu \"Duplicate\" option.\n+    await workspaceCard.selectSnowmanMenu(Option.Duplicate);\n+\n+    // Fill out Workspace Name should be just enough for successful duplication\n+    const workspacesPage = new WorkspacesPage(page);\n+    await (await workspacesPage.getWorkspaceNameTextbox()).clear();\n+    const duplicateWorkspaceName = await workspacesPage.fillOutWorkspaceName();\n+\n+    // change CDR Version\n+    await workspacesPage.selectCdrVersion(config.altCdrVersionName);\n+\n+    const finishButton = await workspacesPage.getDuplicateWorkspaceButton();\n+    await finishButton.waitUntilEnabled();\n+    await workspacesPage.clickCreateFinishButton(finishButton);\n+\n+    // Duplicate workspace Data page is loaded.\n+    const dataPage = new WorkspaceDataPage(page);\n+    await dataPage.waitForLoad();\n+    expect(page.url()).toContain(duplicateWorkspaceName.replace(/-/g, '')); // Remove dash from workspace name\n+\n+    // Delete duplicate workspace via Workspace card in Your Workspaces page.\n+    await Navigation.navMenu(page, NavLink.YOUR_WORKSPACES);\n+    await workspacesPage.waitForLoad();\n+\n+    await WorkspaceCard.deleteWorkspace(page, duplicateWorkspaceName);\n+\n+    // Verify Delete action was successful.\n+    expect(await WorkspaceCard.findCard(page, duplicateWorkspaceName)).toBeFalsy();\n+\n+    // Delete original workspace via Workspace card\n+    await WorkspaceCard.deleteWorkspace(page, originalWorkspaceName);\n+    expect(await WorkspaceCard.findCard(page, originalWorkspaceName)).toBeFalsy();\n+  });\n+\n+  test('OWNER can duplicate workspace to a newer CDR Version via Workspace card', async () => {\n+    const workspaceCard: WorkspaceCard = await createWorkspace(page, config.altCdrVersionName);\n+    const originalWorkspaceName = await workspaceCard.getWorkspaceName();\n+\n+    await workspaceCard.asElementHandle().hover();\n+    // Click on Ellipsis menu \"Duplicate\" option.\n+    await workspaceCard.selectSnowmanMenu(Option.Duplicate);\n+\n+    // Fill out Workspace Name should be just enough for successful duplication\n+    const workspacesPage = new WorkspacesPage(page);\n+    await (await workspacesPage.getWorkspaceNameTextbox()).clear();\n+    const duplicateWorkspaceName = await workspacesPage.fillOutWorkspaceName();\n+\n+    // change CDR Version\n+    await workspacesPage.selectCdrVersion(config.defaultCdrVersionName);\n+\n+    const upgradeMessage = await workspacesPage.getCdrVersionUpgradeMessage();\n+    expect(upgradeMessage).toContain(`You're duplicating the workspace \"${originalWorkspaceName}\" to upgrade from`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59161b85e8ee49b22c94ddf62933c5fc6e3501fa"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNzk4OA==", "bodyText": "nit: Same comment as above. The only reason I call it out is to prevent needing to change the test for minor language changes.", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r523237988", "createdAt": "2020-11-13T21:19:47Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/workspace/workspace-edit.spec.tsx", "diffHunk": "@@ -216,6 +215,43 @@ describe('WorkspaceEdit', () => {\n     expect(navigate).toHaveBeenCalledTimes(1);\n   });\n \n+  it('defaults to upgrading the CDR Version when duplicating a workspace with an older CDR Version', async() => {\n+    // init the workspace to a non-default CDR version value\n+    const altCdrWorkspace = {...workspace, cdrVersionId: CdrVersionsStubVariables.ALT_WORKSPACE_CDR_VERSION_ID}\n+    currentWorkspaceStore.next(altCdrWorkspace);\n+\n+    // duplication will involve a CDR version upgrade by default\n+    routeConfigDataStore.next({mode: WorkspaceEditMode.Duplicate});\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    const cdrSelection = wrapper.find('[data-test-id=\"select-cdr-version\"]').find('select').props().value;\n+\n+    // default CDR version, not the existing workspace's alt CDR version\n+    expect(cdrSelection).toBe(CdrVersionsStubVariables.DEFAULT_WORKSPACE_CDR_VERSION_ID);\n+\n+    const expectedUpgradeMessage1 = `You're duplicating the workspace \"${altCdrWorkspace.name}\" to upgrade from`;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59161b85e8ee49b22c94ddf62933c5fc6e3501fa"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5dc108ddd596da6c3ad9dee7da875f84a3eb847", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/e5dc108ddd596da6c3ad9dee7da875f84a3eb847", "committedDate": "2020-11-13T21:34:33Z", "message": "don't need these parens"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f3db945efd45ebeb030672f9377b858569931ff", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/9f3db945efd45ebeb030672f9377b858569931ff", "committedDate": "2020-11-13T21:36:22Z", "message": "small test updates"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3865, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}