{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNTA3MTYx", "number": 3112, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDo1MDo0NVrODe1R6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxODoxMTo0OVrODe6HfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzNjU2ODExOnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDo1MDo0NVrOFoL4Mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxODoyMzoxNVrOFoT87A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4MTk3MQ==", "bodyText": "Is there a ticket for the refactor here? If not, we probably should file one.", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377681971", "createdAt": "2020-02-11T14:50:45Z", "author": {"login": "s-rubenstein"}, "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "diffHunk": "@@ -426,47 +444,100 @@ const DataSetPage = fp.flow(withUserProfile(), withCurrentWorkspace(), withUrlPa\n \n     async componentDidMount() {\n       const {namespace, id} = this.props.workspace;\n-      const allPromises = [];\n-      allPromises.push(this.loadResources());\n-      if (this.editing) {\n-        allPromises.push(dataSetApi().getDataSet(\n-          namespace, id, this.props.urlParams.dataSetId).then((response) => {\n-            this.setState({\n-              dataSet: response,\n-              includesAllParticipants: response.includesAllParticipants,\n-              selectedConceptSetIds: response.conceptSets.map(cs => cs.id),\n-              selectedCohortIds: response.cohorts.map(c => c.id),\n-              selectedDomainValuePairs: response.domainValuePairs,\n-              valuesLoading: true,\n-            });\n-            if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.BOTH) {\n-              this.setState({prePackagedSurvey: true, prePackagedDemographics: true});\n-            } else if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.DEMOGRAPHICS) {\n-              this.setState({prePackagedDemographics: true});\n-            } else if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.SURVEY) {\n-              this.setState({prePackagedSurvey: true});\n+      const resourcesPromise = this.loadResources();\n+      if (!this.editing) {\n+        return;\n+      }\n+\n+      const [, dataSet] = await Promise.all([\n+        resourcesPromise,\n+        dataSetApi().getDataSet(namespace, id, this.props.urlParams.dataSetId)\n+      ]);\n+\n+      const selectedPrepackagedConceptSets = this.apiEnumToPrePackageConceptSets(dataSet.prePackagedConceptSet);\n+      this.setState({\n+        dataSet,\n+        includesAllParticipants: dataSet.includesAllParticipants,\n+        selectedConceptSetIds: dataSet.conceptSets.map(cs => cs.id),\n+        selectedCohortIds: dataSet.cohorts.map(c => c.id),\n+        selectedDomainValuePairs: dataSet.domainValuePairs,\n+        selectedDomains: this.getDomainsFromConceptSets(dataSet.conceptSets, selectedPrepackagedConceptSets),\n+        selectedPrepackagedConceptSets,\n+      });\n+    }\n+\n+    async componentDidUpdate({}, prevState: State) {\n+      // After a state update, first check whether any new domains have been added.\n+      const newDomains = Array.from(this.state.selectedDomains)\n+          .filter(d => !prevState.selectedDomains.has(d));\n+      if (!newDomains.length) {\n+        return;\n+      }\n+\n+      // TODO: There is a lot of complexity here around loading domain values\n+      // which is static data for a given CDR version. Consider refactoring this", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af"}, "originalPosition": 309}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgxNDI1Mg==", "bodyText": "Filed https://precisionmedicineinitiative.atlassian.net/browse/RW-4426", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377814252", "createdAt": "2020-02-11T18:23:15Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "diffHunk": "@@ -426,47 +444,100 @@ const DataSetPage = fp.flow(withUserProfile(), withCurrentWorkspace(), withUrlPa\n \n     async componentDidMount() {\n       const {namespace, id} = this.props.workspace;\n-      const allPromises = [];\n-      allPromises.push(this.loadResources());\n-      if (this.editing) {\n-        allPromises.push(dataSetApi().getDataSet(\n-          namespace, id, this.props.urlParams.dataSetId).then((response) => {\n-            this.setState({\n-              dataSet: response,\n-              includesAllParticipants: response.includesAllParticipants,\n-              selectedConceptSetIds: response.conceptSets.map(cs => cs.id),\n-              selectedCohortIds: response.cohorts.map(c => c.id),\n-              selectedDomainValuePairs: response.domainValuePairs,\n-              valuesLoading: true,\n-            });\n-            if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.BOTH) {\n-              this.setState({prePackagedSurvey: true, prePackagedDemographics: true});\n-            } else if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.DEMOGRAPHICS) {\n-              this.setState({prePackagedDemographics: true});\n-            } else if (response.prePackagedConceptSet === PrePackagedConceptSetEnum.SURVEY) {\n-              this.setState({prePackagedSurvey: true});\n+      const resourcesPromise = this.loadResources();\n+      if (!this.editing) {\n+        return;\n+      }\n+\n+      const [, dataSet] = await Promise.all([\n+        resourcesPromise,\n+        dataSetApi().getDataSet(namespace, id, this.props.urlParams.dataSetId)\n+      ]);\n+\n+      const selectedPrepackagedConceptSets = this.apiEnumToPrePackageConceptSets(dataSet.prePackagedConceptSet);\n+      this.setState({\n+        dataSet,\n+        includesAllParticipants: dataSet.includesAllParticipants,\n+        selectedConceptSetIds: dataSet.conceptSets.map(cs => cs.id),\n+        selectedCohortIds: dataSet.cohorts.map(c => c.id),\n+        selectedDomainValuePairs: dataSet.domainValuePairs,\n+        selectedDomains: this.getDomainsFromConceptSets(dataSet.conceptSets, selectedPrepackagedConceptSets),\n+        selectedPrepackagedConceptSets,\n+      });\n+    }\n+\n+    async componentDidUpdate({}, prevState: State) {\n+      // After a state update, first check whether any new domains have been added.\n+      const newDomains = Array.from(this.state.selectedDomains)\n+          .filter(d => !prevState.selectedDomains.has(d));\n+      if (!newDomains.length) {\n+        return;\n+      }\n+\n+      // TODO: There is a lot of complexity here around loading domain values\n+      // which is static data for a given CDR version. Consider refactoring this", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4MTk3MQ=="}, "originalCommit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af"}, "originalPosition": 309}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzNzM2MDYwOnYy", "diffSide": "LEFT", "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxODoxMTo0OVrOFoTmPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQyMjo1MTo1NFrOFpBbsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwODQ0Ng==", "bodyText": "@NehaBroad @blrubenstein  I could not understand what was going on here with this .survey value. I didn't find any comments hinting at the rationale for this. I removed it in my PR because it was a potential source of bugs/inconsistency. If this is tracking a real requirement, let me know.\nRelatedly, I'm confused by this line: https://github.com/all-of-us/workbench/blob/master/ui/src/app/pages/data/data-set/dataset-page.tsx#L1010", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377808446", "createdAt": "2020-02-11T18:11:49Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "diffHunk": "@@ -919,25 +934,27 @@ const DataSetPage = fp.flow(withUserProfile(), withCurrentWorkspace(), withUrlPa\n                       </div>\n                     </div>\n                   </BoxHeader>\n-                  <div style={{height: valueSets.length > 0 ? '7.625rem' : '9rem', overflowY: 'auto'}}>\n-                    {valuesLoading && <Spinner style={{position: 'relative',\n+                  <div style={{height: selectedDomains.size > 0 ? '7.625rem' : '9rem', overflowY: 'auto'}}>\n+                    {domainValueSetIsLoading.size > 0 && <Spinner style={{position: 'relative',\n                       top: '2rem', left: 'calc(50% - 36px)'}}/>}\n-                    {valueSets.map(valueSet =>\n-                      <div key={valueSet.domain}>\n+                    {Array.from(selectedDomains).map(domain =>\n+                      domainValueSetLookup.has(domain) &&\n+                      <div key={domain}>\n                         <Subheader style={{fontWeight: 'bold'}}>\n-                          {valueSet.survey ? 'Survey' : formatDomain(valueSet.domain)}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af"}, "originalPosition": 777}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5MDA4Nw==", "bodyText": "It might be because Survey was not initially not a DOMAIN hence we were checking if survey object is populated treat it as SURVEY", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377990087", "createdAt": "2020-02-12T01:06:16Z", "author": {"login": "NehaBroad"}, "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "diffHunk": "@@ -919,25 +934,27 @@ const DataSetPage = fp.flow(withUserProfile(), withCurrentWorkspace(), withUrlPa\n                       </div>\n                     </div>\n                   </BoxHeader>\n-                  <div style={{height: valueSets.length > 0 ? '7.625rem' : '9rem', overflowY: 'auto'}}>\n-                    {valuesLoading && <Spinner style={{position: 'relative',\n+                  <div style={{height: selectedDomains.size > 0 ? '7.625rem' : '9rem', overflowY: 'auto'}}>\n+                    {domainValueSetIsLoading.size > 0 && <Spinner style={{position: 'relative',\n                       top: '2rem', left: 'calc(50% - 36px)'}}/>}\n-                    {valueSets.map(valueSet =>\n-                      <div key={valueSet.domain}>\n+                    {Array.from(selectedDomains).map(domain =>\n+                      domainValueSetLookup.has(domain) &&\n+                      <div key={domain}>\n                         <Subheader style={{fontWeight: 'bold'}}>\n-                          {valueSet.survey ? 'Survey' : formatDomain(valueSet.domain)}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwODQ0Ng=="}, "originalCommit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af"}, "originalPosition": 777}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk5MzE1MQ==", "bodyText": "Could the OBSERVATION thing be because of api/src/main/java/org/pmiops/workbench/db/dao/ConceptSetDao.java L26?\n.put(Domain.SURVEY, \"observation\")", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r377993151", "createdAt": "2020-02-12T01:18:30Z", "author": {"login": "NehaBroad"}, "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "diffHunk": "@@ -919,25 +934,27 @@ const DataSetPage = fp.flow(withUserProfile(), withCurrentWorkspace(), withUrlPa\n                       </div>\n                     </div>\n                   </BoxHeader>\n-                  <div style={{height: valueSets.length > 0 ? '7.625rem' : '9rem', overflowY: 'auto'}}>\n-                    {valuesLoading && <Spinner style={{position: 'relative',\n+                  <div style={{height: selectedDomains.size > 0 ? '7.625rem' : '9rem', overflowY: 'auto'}}>\n+                    {domainValueSetIsLoading.size > 0 && <Spinner style={{position: 'relative',\n                       top: '2rem', left: 'calc(50% - 36px)'}}/>}\n-                    {valueSets.map(valueSet =>\n-                      <div key={valueSet.domain}>\n+                    {Array.from(selectedDomains).map(domain =>\n+                      domainValueSetLookup.has(domain) &&\n+                      <div key={domain}>\n                         <Subheader style={{fontWeight: 'bold'}}>\n-                          {valueSet.survey ? 'Survey' : formatDomain(valueSet.domain)}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwODQ0Ng=="}, "originalCommit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af"}, "originalPosition": 777}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU1OTQxMQ==", "bodyText": "Surveys used to be in the Observation domain, I've removed the special handling of this for now, since presumably we could have a concept set in the observation domain as well, and we'd want it to be labeled accordingly.", "url": "https://github.com/all-of-us/workbench/pull/3112#discussion_r378559411", "createdAt": "2020-02-12T22:51:54Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/data/data-set/dataset-page.tsx", "diffHunk": "@@ -919,25 +934,27 @@ const DataSetPage = fp.flow(withUserProfile(), withCurrentWorkspace(), withUrlPa\n                       </div>\n                     </div>\n                   </BoxHeader>\n-                  <div style={{height: valueSets.length > 0 ? '7.625rem' : '9rem', overflowY: 'auto'}}>\n-                    {valuesLoading && <Spinner style={{position: 'relative',\n+                  <div style={{height: selectedDomains.size > 0 ? '7.625rem' : '9rem', overflowY: 'auto'}}>\n+                    {domainValueSetIsLoading.size > 0 && <Spinner style={{position: 'relative',\n                       top: '2rem', left: 'calc(50% - 36px)'}}/>}\n-                    {valueSets.map(valueSet =>\n-                      <div key={valueSet.domain}>\n+                    {Array.from(selectedDomains).map(domain =>\n+                      domainValueSetLookup.has(domain) &&\n+                      <div key={domain}>\n                         <Subheader style={{fontWeight: 'bold'}}>\n-                          {valueSet.survey ? 'Survey' : formatDomain(valueSet.domain)}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzgwODQ0Ng=="}, "originalCommit": {"oid": "e52ea60e4acdd11fb53c7e5dce10ed568cfeb6af"}, "originalPosition": 777}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3308, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}