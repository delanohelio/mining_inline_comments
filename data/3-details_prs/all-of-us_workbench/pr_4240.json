{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MjQzMTcx", "number": 4240, "title": "[RW-5419][risk=no] Runtime cost estimator widget", "bodyText": "PR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test-local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-11-02T18:29:40Z", "url": "https://github.com/all-of-us/workbench/pull/4240", "merged": true, "mergeCommit": {"oid": "8b691990de6c2dd26bda1b9a0fc4155c900310db"}, "closed": true, "closedAt": "2020-11-05T20:35:26Z", "author": {"login": "als364"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYrb-5ABqjM5NTAxNDY2MjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZow1UgFqTUyNDY1ODQ5Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "893fc36b100e5a160ab77cfc4b7b5322221da289", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/893fc36b100e5a160ab77cfc4b7b5322221da289", "committedDate": "2020-11-02T21:15:43Z", "message": "dryerful of lint"}, "afterCommit": {"oid": "8a73b4effabcfbf7a27f396b48e9caa9313c5668", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/8a73b4effabcfbf7a27f396b48e9caa9313c5668", "committedDate": "2020-11-02T21:27:33Z", "message": "dryerful of lint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNzg0NTgy", "url": "https://github.com/all-of-us/workbench/pull/4240#pullrequestreview-522784582", "createdAt": "2020-11-03T18:48:34Z", "commit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "state": "COMMENTED", "comments": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxODo0ODozNVrOHs8Elg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxOToyNTo0MVrOHs9T6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4MzYwNg==", "bodyText": "opt nit: I would probably just inline this below, but personal preference", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516883606", "createdAt": "2020-11-03T18:48:35Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/api/WorkspacesController.java", "diffHunk": "@@ -963,4 +964,17 @@ private void recordOperationTime(Runnable operation, String operationName) {\n         DistributionMetric.WORKSPACE_OPERATION_TIME,\n         operation);\n   }\n+\n+  public ResponseEntity<WorkspaceCreatorFreeCreditsRemainingResponse>\n+      getWorkspaceCreatorFreeCreditsRemaining(String workspaceNamespace, String workspaceId) {\n+    workspaceService.enforceWorkspaceAccessLevelAndRegisteredAuthDomain(\n+        workspaceNamespace, workspaceId, WorkspaceAccessLevel.WRITER);\n+    DbWorkspace dbWorkspace = workspaceService.getRequired(workspaceNamespace, workspaceId);\n+    double freeCreditsRemaining =\n+        freeTierBillingService.getWorkspaceCreatorFreeCreditsRemaining(dbWorkspace);\n+    WorkspaceCreatorFreeCreditsRemainingResponse response =\n+        new WorkspaceCreatorFreeCreditsRemainingResponse()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4NDc4Mg==", "bodyText": "opt: Math.max(creatorFreeCreditsRemaining, 0); probably more readable than the ternary", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516884782", "createdAt": "2020-11-03T18:50:40Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -348,4 +348,21 @@ public boolean maybeSetDollarLimitOverride(DbUser user, double newDollarLimit) {\n   public Map<Long, Double> getUserIdToTotalCost() {\n     return workspaceFreeTierUsageDao.getUserIdToTotalCost();\n   }\n+\n+  /**\n+   * Given a workspace, find the amount of free credits that the workspace creator has left.\n+   *\n+   * @param dbWorkspace The workspace for which to find its creator's free credits remaining\n+   * @return The amount of free credits in USD the workspace creator has left, represented as a\n+   *     double\n+   */\n+  public double getWorkspaceCreatorFreeCreditsRemaining(DbWorkspace dbWorkspace) {\n+    Double creatorCachedFreeTierUsage = this.getCachedFreeTierUsage(dbWorkspace.getCreator());\n+    Double creatorFreeTierDollarLimit = this.getUserFreeTierDollarLimit(dbWorkspace.getCreator());\n+    double creatorFreeCreditsRemaining =\n+        creatorCachedFreeTierUsage == null\n+            ? creatorFreeTierDollarLimit\n+            : creatorFreeTierDollarLimit - creatorCachedFreeTierUsage;\n+    return creatorFreeCreditsRemaining > 0 ? creatorFreeCreditsRemaining : 0.0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4NzMwNg==", "bodyText": "nit: destructuring would make these two lines a bit shorter", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516887306", "createdAt": "2020-11-03T18:55:17Z", "author": {"login": "calbach"}, "path": "ui/src/app/components/help-sidebar.tsx", "diffHunk": "@@ -382,14 +385,17 @@ export const HelpSidebar = fp.flow(\n       }\n     });\n \n-    componentDidMount(): void {\n+    async componentDidMount() {\n+      const {namespace, id} = this.props.workspace;\n       this.subscription = participantStore.subscribe(participant => this.setState({participant}));\n       this.subscription.add(setSidebarActiveIconStore.subscribe(activeIcon => {\n         if (activeIcon !== null) {\n           this.setState({activeIcon});\n           this.props.setSidebarState(!!activeIcon);\n         }\n       }));\n+      const workspaceCreatorFreeCreditsRemainingResponse = await workspacesApi().getWorkspaceCreatorFreeCreditsRemaining(namespace, id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4ODExNA==", "bodyText": "I'm worried this may be a bit chatty - can you try watching the network tab while navigating around a bit locally? If this only gets triggered across workspace changes, that's probably fine. If it's more frequently than that we may want to move this", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516888114", "createdAt": "2020-11-03T18:56:51Z", "author": {"login": "calbach"}, "path": "ui/src/app/components/help-sidebar.tsx", "diffHunk": "@@ -382,14 +385,17 @@ export const HelpSidebar = fp.flow(\n       }\n     });\n \n-    componentDidMount(): void {\n+    async componentDidMount() {\n+      const {namespace, id} = this.props.workspace;\n       this.subscription = participantStore.subscribe(participant => this.setState({participant}));\n       this.subscription.add(setSidebarActiveIconStore.subscribe(activeIcon => {\n         if (activeIcon !== null) {\n           this.setState({activeIcon});\n           this.props.setSidebarState(!!activeIcon);\n         }\n       }));\n+      const workspaceCreatorFreeCreditsRemainingResponse = await workspacesApi().getWorkspaceCreatorFreeCreditsRemaining(namespace, id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg4ODU1MQ==", "bodyText": "Why put the state here rather than just in the runtime panel?", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516888551", "createdAt": "2020-11-03T18:57:38Z", "author": {"login": "calbach"}, "path": "ui/src/app/components/help-sidebar.tsx", "diffHunk": "@@ -382,14 +385,17 @@ export const HelpSidebar = fp.flow(\n       }\n     });\n \n-    componentDidMount(): void {\n+    async componentDidMount() {\n+      const {namespace, id} = this.props.workspace;\n       this.subscription = participantStore.subscribe(participant => this.setState({participant}));\n       this.subscription.add(setSidebarActiveIconStore.subscribe(activeIcon => {\n         if (activeIcon !== null) {\n           this.setState({activeIcon});\n           this.props.setSidebarState(!!activeIcon);\n         }\n       }));\n+      const workspaceCreatorFreeCreditsRemainingResponse = await workspacesApi().getWorkspaceCreatorFreeCreditsRemaining(namespace, id);\n+      this.setState({workspaceCreatorFreeCreditsRemaining: workspaceCreatorFreeCreditsRemainingResponse.freeCreditsRemaining});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5MDAxMg==", "bodyText": "opt: I like the word Estimator from your PR description slightly better than Predictor.", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516890012", "createdAt": "2020-11-03T19:00:16Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -211,24 +226,149 @@ const DataProcConfigSelector = ({onChange, dataprocConfig})  => {\n   </fieldset>;\n };\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())(({workspace, cdrVersionListResponse}) => {\n+const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMachine, setSelectedCompute, setSelectedDataprocConfig}) => {\n+  {/* Recommended runtime: pick from default templates or change the image. */}\n+  return <PopupTrigger side='bottom'\n+                closeOnClick\n+                content={\n+                  <React.Fragment>\n+                    {\n+                      fp.flow(\n+                        fp.filter(({runtimeTemplate}) => hasMicroarrayData || !runtimeTemplate.dataprocConfig),\n+                        fp.toPairs,\n+                        fp.map(([i, preset]) => {\n+                          return <MenuItem\n+                                style={styles.presetMenuItem}\n+                                key={i}\n+                                aria-label={preset.displayName}\n+                                onClick={() => {\n+                                  // renaming to avoid shadowing\n+                                  const {runtimeTemplate} = preset;\n+                                  const {presetDiskSize, presetMachineName, presetCompute} = fp.cond([\n+                                    // Can't destructure due to shadowing.\n+                                    [() => !!runtimeTemplate.gceConfig, (tmpl: Runtime) => ({\n+                                      presetDiskSize: tmpl.gceConfig.diskSize,\n+                                      presetMachineName: tmpl.gceConfig.machineType,\n+                                      presetCompute: ComputeType.Standard\n+                                    })],\n+                                    [() => !!runtimeTemplate.dataprocConfig, ({dataprocConfig: {masterDiskSize, masterMachineType}}) => ({\n+                                      presetDiskSize: masterDiskSize,\n+                                      presetMachineName: masterMachineType,\n+                                      presetCompute: ComputeType.Dataproc\n+                                    })]\n+                                  ])(runtimeTemplate);\n+                                  const presetMachineType = fp.find(({name}) => name === presetMachineName, validLeonardoMachineTypes);\n+\n+                                  setSelectedDiskSize(presetDiskSize);\n+                                  setSelectedMachine(presetMachineType);\n+                                  setSelectedCompute(presetCompute);\n+                                  setSelectedDataprocConfig(runtimeTemplate.dataprocConfig);\n+                                }}>\n+                              {preset.displayName}\n+                            </MenuItem>;\n+                        })\n+                      )(runtimePresets)\n+                    }\n+                  </React.Fragment>\n+                }>\n+    <Clickable data-test-id='runtime-presets-menu'>\n+      Recommended environments <ClrIcon shape='caret down'/>\n+    </Clickable>\n+  </PopupTrigger>;\n+};\n+\n+const CostPredictor = ({", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5MDgyMQ==", "bodyText": "s/owner/creator/", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516890821", "createdAt": "2020-11-03T19:01:44Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -211,24 +226,149 @@ const DataProcConfigSelector = ({onChange, dataprocConfig})  => {\n   </fieldset>;\n };\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())(({workspace, cdrVersionListResponse}) => {\n+const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMachine, setSelectedCompute, setSelectedDataprocConfig}) => {\n+  {/* Recommended runtime: pick from default templates or change the image. */}\n+  return <PopupTrigger side='bottom'\n+                closeOnClick\n+                content={\n+                  <React.Fragment>\n+                    {\n+                      fp.flow(\n+                        fp.filter(({runtimeTemplate}) => hasMicroarrayData || !runtimeTemplate.dataprocConfig),\n+                        fp.toPairs,\n+                        fp.map(([i, preset]) => {\n+                          return <MenuItem\n+                                style={styles.presetMenuItem}\n+                                key={i}\n+                                aria-label={preset.displayName}\n+                                onClick={() => {\n+                                  // renaming to avoid shadowing\n+                                  const {runtimeTemplate} = preset;\n+                                  const {presetDiskSize, presetMachineName, presetCompute} = fp.cond([\n+                                    // Can't destructure due to shadowing.\n+                                    [() => !!runtimeTemplate.gceConfig, (tmpl: Runtime) => ({\n+                                      presetDiskSize: tmpl.gceConfig.diskSize,\n+                                      presetMachineName: tmpl.gceConfig.machineType,\n+                                      presetCompute: ComputeType.Standard\n+                                    })],\n+                                    [() => !!runtimeTemplate.dataprocConfig, ({dataprocConfig: {masterDiskSize, masterMachineType}}) => ({\n+                                      presetDiskSize: masterDiskSize,\n+                                      presetMachineName: masterMachineType,\n+                                      presetCompute: ComputeType.Dataproc\n+                                    })]\n+                                  ])(runtimeTemplate);\n+                                  const presetMachineType = fp.find(({name}) => name === presetMachineName, validLeonardoMachineTypes);\n+\n+                                  setSelectedDiskSize(presetDiskSize);\n+                                  setSelectedMachine(presetMachineType);\n+                                  setSelectedCompute(presetCompute);\n+                                  setSelectedDataprocConfig(runtimeTemplate.dataprocConfig);\n+                                }}>\n+                              {preset.displayName}\n+                            </MenuItem>;\n+                        })\n+                      )(runtimePresets)\n+                    }\n+                  </React.Fragment>\n+                }>\n+    <Clickable data-test-id='runtime-presets-menu'>\n+      Recommended environments <ClrIcon shape='caret down'/>\n+    </Clickable>\n+  </PopupTrigger>;\n+};\n+\n+const CostPredictor = ({\n+  freeCreditsRemaining,\n+  profile,\n+  runningCost,\n+  runningCostBreakdown,\n+  runtimeChanged,\n+  storageCost,\n+  storageCostBreakdown,\n+  workspace\n+}) => {\n+  const wrapperStyle = runtimeChanged\n+    ? {...styles.costPredictorWrapper, backgroundColor: colorWithWhiteness(colors.warning, .9), borderColor: colors.warning}\n+    : styles.costPredictorWrapper;\n+  return <FlexRow\n+    style={wrapperStyle}\n+  >\n+    <FlexRow style={{minWidth: '250px', margin: '.33rem .5rem'}}>\n+      <FlexColumn style={{marginRight: '1rem'}}>\n+        <div style={{fontSize: '10px', fontWeight: 600}}>Cost when running</div>\n+        <TooltipTrigger content={\n+          <div>\n+            <div>Cost Breakdown</div>\n+            {runningCostBreakdown.map((lineItem, i) => <div key={i}>{lineItem}</div>)}\n+          </div>\n+        }>\n+          <div style={{fontSize: '20px', color: colors.accent}}>{formatUsd(runningCost)}/hr</div>\n+        </TooltipTrigger>\n+      </FlexColumn>\n+      <FlexColumn>\n+        <div style={{fontSize: '10px', fontWeight: 600}}>Cost when paused</div>\n+        <TooltipTrigger content={\n+          <div>\n+            <div>Cost Breakdown</div>\n+            {storageCostBreakdown.map((lineItem, i) => <div key={i}>{lineItem}</div>)}\n+          </div>\n+        }>\n+          <div style={{fontSize: '20px', color: colors.accent}}>{formatUsd(storageCost)}/hr</div>\n+        </TooltipTrigger>\n+      </FlexColumn>\n+    </FlexRow>\n+    {\n+      workspace.billingAccountType === BillingAccountType.FREETIER\n+      && profile.username === workspace.creator\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will draw from your remaining {formatUsd(freeCreditsRemaining)} of free credits.\n+      </div>\n+    }\n+    {\n+      workspace.billingAccountType === BillingAccountType.FREETIER\n+      && profile.username !== workspace.creator\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will draw from workspace owner's remaining {formatUsd(freeCreditsRemaining)} of free credits.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 184}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5MTI4OA==", "bodyText": "nit: wrap div?", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516891288", "createdAt": "2020-11-03T19:02:36Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -211,24 +226,149 @@ const DataProcConfigSelector = ({onChange, dataprocConfig})  => {\n   </fieldset>;\n };\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())(({workspace, cdrVersionListResponse}) => {\n+const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMachine, setSelectedCompute, setSelectedDataprocConfig}) => {\n+  {/* Recommended runtime: pick from default templates or change the image. */}\n+  return <PopupTrigger side='bottom'\n+                closeOnClick\n+                content={\n+                  <React.Fragment>\n+                    {\n+                      fp.flow(\n+                        fp.filter(({runtimeTemplate}) => hasMicroarrayData || !runtimeTemplate.dataprocConfig),\n+                        fp.toPairs,\n+                        fp.map(([i, preset]) => {\n+                          return <MenuItem\n+                                style={styles.presetMenuItem}\n+                                key={i}\n+                                aria-label={preset.displayName}\n+                                onClick={() => {\n+                                  // renaming to avoid shadowing\n+                                  const {runtimeTemplate} = preset;\n+                                  const {presetDiskSize, presetMachineName, presetCompute} = fp.cond([\n+                                    // Can't destructure due to shadowing.\n+                                    [() => !!runtimeTemplate.gceConfig, (tmpl: Runtime) => ({\n+                                      presetDiskSize: tmpl.gceConfig.diskSize,\n+                                      presetMachineName: tmpl.gceConfig.machineType,\n+                                      presetCompute: ComputeType.Standard\n+                                    })],\n+                                    [() => !!runtimeTemplate.dataprocConfig, ({dataprocConfig: {masterDiskSize, masterMachineType}}) => ({\n+                                      presetDiskSize: masterDiskSize,\n+                                      presetMachineName: masterMachineType,\n+                                      presetCompute: ComputeType.Dataproc\n+                                    })]\n+                                  ])(runtimeTemplate);\n+                                  const presetMachineType = fp.find(({name}) => name === presetMachineName, validLeonardoMachineTypes);\n+\n+                                  setSelectedDiskSize(presetDiskSize);\n+                                  setSelectedMachine(presetMachineType);\n+                                  setSelectedCompute(presetCompute);\n+                                  setSelectedDataprocConfig(runtimeTemplate.dataprocConfig);\n+                                }}>\n+                              {preset.displayName}\n+                            </MenuItem>;\n+                        })\n+                      )(runtimePresets)\n+                    }\n+                  </React.Fragment>\n+                }>\n+    <Clickable data-test-id='runtime-presets-menu'>\n+      Recommended environments <ClrIcon shape='caret down'/>\n+    </Clickable>\n+  </PopupTrigger>;\n+};\n+\n+const CostPredictor = ({\n+  freeCreditsRemaining,\n+  profile,\n+  runningCost,\n+  runningCostBreakdown,\n+  runtimeChanged,\n+  storageCost,\n+  storageCostBreakdown,\n+  workspace\n+}) => {\n+  const wrapperStyle = runtimeChanged\n+    ? {...styles.costPredictorWrapper, backgroundColor: colorWithWhiteness(colors.warning, .9), borderColor: colors.warning}\n+    : styles.costPredictorWrapper;\n+  return <FlexRow\n+    style={wrapperStyle}\n+  >\n+    <FlexRow style={{minWidth: '250px', margin: '.33rem .5rem'}}>\n+      <FlexColumn style={{marginRight: '1rem'}}>\n+        <div style={{fontSize: '10px', fontWeight: 600}}>Cost when running</div>\n+        <TooltipTrigger content={\n+          <div>\n+            <div>Cost Breakdown</div>\n+            {runningCostBreakdown.map((lineItem, i) => <div key={i}>{lineItem}</div>)}\n+          </div>\n+        }>\n+          <div style={{fontSize: '20px', color: colors.accent}}>{formatUsd(runningCost)}/hr</div>\n+        </TooltipTrigger>\n+      </FlexColumn>\n+      <FlexColumn>\n+        <div style={{fontSize: '10px', fontWeight: 600}}>Cost when paused</div>\n+        <TooltipTrigger content={\n+          <div>\n+            <div>Cost Breakdown</div>\n+            {storageCostBreakdown.map((lineItem, i) => <div key={i}>{lineItem}</div>)}\n+          </div>\n+        }>\n+          <div style={{fontSize: '20px', color: colors.accent}}>{formatUsd(storageCost)}/hr</div>\n+        </TooltipTrigger>\n+      </FlexColumn>\n+    </FlexRow>\n+    {\n+      workspace.billingAccountType === BillingAccountType.FREETIER\n+      && profile.username === workspace.creator\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will draw from your remaining {formatUsd(freeCreditsRemaining)} of free credits.\n+      </div>\n+    }\n+    {\n+      workspace.billingAccountType === BillingAccountType.FREETIER\n+      && profile.username !== workspace.creator\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will draw from workspace owner's remaining {formatUsd(freeCreditsRemaining)} of free credits.\n+      </div>\n+    }\n+    {workspace.billingAccountType === BillingAccountType.USERPROVIDED && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 187}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5NDQ0MQ==", "bodyText": "Thanks for adding this. Technically this should probably be in @ericsong 's UI PR, since currently all changes induce restarts until we have Update integration - but I'm fine adding it here since you already did the styling.\nThe logic for runtimeNeedsRestart is also not quite correct, e.g. shrinking the disk size is illegal via Update, and will require a restart. I don't know if that's the only issue, part of the update ticket was to identify exactly which config changes are supported.\nAlternatively, just drop runtimeNeedsRestart and only show this dialog with runtimeChanged - which would currently be accurate.", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516894441", "createdAt": "2020-11-03T19:08:04Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -323,6 +458,25 @@ export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())((\n         }\n       </FlexColumn>\n     </div>\n+    {runtimeNeedsRestart && <FlexRow\n+        style={{\n+          alignItems: 'center',\n+          backgroundColor: colorWithWhiteness(colors.warning, .9),\n+          border: `1px solid ${colors.warning}`,\n+          borderRadius: '5px',\n+          color: colors.dark,\n+          marginTop: '.5rem',\n+          padding: '.5rem 0px'\n+        }}\n+    >\n+      <ClrIcon\n+          style={{color: colors.warning, marginLeft: '.5rem'}}\n+          shape={'warning-standard'}\n+          size={16}\n+          class={'is-solid'}\n+      />\n+      <div style={{marginLeft: '.5rem'}}>You've made changes that require recreating your environment to take effect.</div>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 353}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5NjIxMQ==", "bodyText": "While our UI doesn't currently support 0 node Dataproc clusters, they are legal, so I would probably handle this case", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516896211", "createdAt": "2020-11-03T19:10:59Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/machines.ts", "diffHunk": "@@ -45,5 +51,92 @@ export const allMachineTypes = fp.map(({ price, preemptiblePrice, ...details })\n // See https://broadworkbench.atlassian.net/browse/SATURN-1337\n export const validLeonardoMachineTypes = allMachineTypes.filter(({memory}) => memory >= 4);\n \n+export const findMachineByName = (machineToFind: string) => fp.find(({name}) => name === machineToFind, allMachineTypes);\n+\n export const diskPrice = 0.04 / 730; // per GB hour, from https://cloud.google.com/compute/pricing\n export const dataprocCpuPrice = 0.01; // dataproc costs $0.01 per cpu per hour\n+\n+export const machineStoragePrice = ({masterDiskSize, numberOfWorkers, workerDiskSize }) => {\n+  if (numberOfWorkers && workerDiskSize) {\n+    return (masterDiskSize + numberOfWorkers * workerDiskSize) * diskPrice;\n+  } else {\n+    return masterDiskSize * diskPrice;\n+  }\n+};\n+\n+export const machineStorageCostBreakdown = ({masterDiskSize, numberOfWorkers, workerDiskSize}) => {\n+  const costs = [];\n+  if (numberOfWorkers && workerDiskSize) {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Master Disk`);\n+    costs.push(`${formatUsd((numberOfWorkers * workerDiskSize) * diskPrice)}/hr Worker Disks`);\n+  } else {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Disk`);\n+  }\n+  return costs;\n+};\n+\n+export const machineRunningPrice = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+\n+  if (computeType === ComputeType.Dataproc && !workerMachine) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5ODA2MA==", "bodyText": "See above comment, returning [] here implies 0 cost for a 0 node cluster, which is not correct (though it can also never happen in the current UI)", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516898060", "createdAt": "2020-11-03T19:14:29Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/machines.ts", "diffHunk": "@@ -45,5 +51,92 @@ export const allMachineTypes = fp.map(({ price, preemptiblePrice, ...details })\n // See https://broadworkbench.atlassian.net/browse/SATURN-1337\n export const validLeonardoMachineTypes = allMachineTypes.filter(({memory}) => memory >= 4);\n \n+export const findMachineByName = (machineToFind: string) => fp.find(({name}) => name === machineToFind, allMachineTypes);\n+\n export const diskPrice = 0.04 / 730; // per GB hour, from https://cloud.google.com/compute/pricing\n export const dataprocCpuPrice = 0.01; // dataproc costs $0.01 per cpu per hour\n+\n+export const machineStoragePrice = ({masterDiskSize, numberOfWorkers, workerDiskSize }) => {\n+  if (numberOfWorkers && workerDiskSize) {\n+    return (masterDiskSize + numberOfWorkers * workerDiskSize) * diskPrice;\n+  } else {\n+    return masterDiskSize * diskPrice;\n+  }\n+};\n+\n+export const machineStorageCostBreakdown = ({masterDiskSize, numberOfWorkers, workerDiskSize}) => {\n+  const costs = [];\n+  if (numberOfWorkers && workerDiskSize) {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Master Disk`);\n+    costs.push(`${formatUsd((numberOfWorkers * workerDiskSize) * diskPrice)}/hr Worker Disks`);\n+  } else {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Disk`);\n+  }\n+  return costs;\n+};\n+\n+export const machineRunningPrice = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+\n+  if (computeType === ComputeType.Dataproc && !workerMachine) {\n+    return NaN;\n+  }\n+\n+  const dataprocPrice = computeType === ComputeType.Dataproc\n+    ? fp.sum([\n+      (masterMachine.cpu + ((numberOfWorkers + numberOfPreemptibleWorkers) * workerMachine.cpu)) * dataprocCpuPrice,\n+      numberOfWorkers * workerMachine.price,\n+      numberOfPreemptibleWorkers * workerMachine.preemptiblePrice,\n+    ])\n+    : 0;\n+  return fp.sum([\n+    dataprocPrice,\n+    masterMachine.price,\n+    machineStoragePrice({masterDiskSize: masterDiskSize, numberOfWorkers: numberOfWorkers, workerDiskSize: workerDiskSize})\n+  ]);\n+};\n+\n+export const machineRunningCostBreakdown = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const costs = [];\n+  if (computeType === ComputeType.Dataproc) {\n+    const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+    if (!workerMachine) {\n+      return costs;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg5ODYxMQ==", "bodyText": "nit: pull this out into a helper? This computation is duplicated here and above", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516898611", "createdAt": "2020-11-03T19:15:25Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/machines.ts", "diffHunk": "@@ -45,5 +51,92 @@ export const allMachineTypes = fp.map(({ price, preemptiblePrice, ...details })\n // See https://broadworkbench.atlassian.net/browse/SATURN-1337\n export const validLeonardoMachineTypes = allMachineTypes.filter(({memory}) => memory >= 4);\n \n+export const findMachineByName = (machineToFind: string) => fp.find(({name}) => name === machineToFind, allMachineTypes);\n+\n export const diskPrice = 0.04 / 730; // per GB hour, from https://cloud.google.com/compute/pricing\n export const dataprocCpuPrice = 0.01; // dataproc costs $0.01 per cpu per hour\n+\n+export const machineStoragePrice = ({masterDiskSize, numberOfWorkers, workerDiskSize }) => {\n+  if (numberOfWorkers && workerDiskSize) {\n+    return (masterDiskSize + numberOfWorkers * workerDiskSize) * diskPrice;\n+  } else {\n+    return masterDiskSize * diskPrice;\n+  }\n+};\n+\n+export const machineStorageCostBreakdown = ({masterDiskSize, numberOfWorkers, workerDiskSize}) => {\n+  const costs = [];\n+  if (numberOfWorkers && workerDiskSize) {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Master Disk`);\n+    costs.push(`${formatUsd((numberOfWorkers * workerDiskSize) * diskPrice)}/hr Worker Disks`);\n+  } else {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Disk`);\n+  }\n+  return costs;\n+};\n+\n+export const machineRunningPrice = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+\n+  if (computeType === ComputeType.Dataproc && !workerMachine) {\n+    return NaN;\n+  }\n+\n+  const dataprocPrice = computeType === ComputeType.Dataproc\n+    ? fp.sum([\n+      (masterMachine.cpu + ((numberOfWorkers + numberOfPreemptibleWorkers) * workerMachine.cpu)) * dataprocCpuPrice,\n+      numberOfWorkers * workerMachine.price,\n+      numberOfPreemptibleWorkers * workerMachine.preemptiblePrice,\n+    ])\n+    : 0;\n+  return fp.sum([\n+    dataprocPrice,\n+    masterMachine.price,\n+    machineStoragePrice({masterDiskSize: masterDiskSize, numberOfWorkers: numberOfWorkers, workerDiskSize: workerDiskSize})\n+  ]);\n+};\n+\n+export const machineRunningCostBreakdown = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const costs = [];\n+  if (computeType === ComputeType.Dataproc) {\n+    const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+    if (!workerMachine) {\n+      return costs;\n+    }\n+    costs.push(`${formatUsd(masterMachine.price)}/hr Master VM`);\n+    if (numberOfWorkers > 0) {\n+      costs.push(`${formatUsd(workerMachine.price  * numberOfWorkers)}/hr Worker VM(s) (${numberOfWorkers})`);\n+    }\n+    if (numberOfPreemptibleWorkers > 0) {\n+      costs.push(\n+        `${formatUsd(workerMachine.preemptiblePrice * numberOfPreemptibleWorkers)}/hr Preemptible Worker VM(s) (${numberOfPreemptibleWorkers})`\n+      );\n+    }\n+    const dataprocPrice = (masterMachine.cpu + ((numberOfWorkers + numberOfPreemptibleWorkers) * workerMachine.cpu)) * dataprocCpuPrice;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMDA5Nw==", "bodyText": "number of preemptible workers is not considered in this calculation - is that intentional?", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516900097", "createdAt": "2020-11-03T19:18:22Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/machines.ts", "diffHunk": "@@ -45,5 +51,92 @@ export const allMachineTypes = fp.map(({ price, preemptiblePrice, ...details })\n // See https://broadworkbench.atlassian.net/browse/SATURN-1337\n export const validLeonardoMachineTypes = allMachineTypes.filter(({memory}) => memory >= 4);\n \n+export const findMachineByName = (machineToFind: string) => fp.find(({name}) => name === machineToFind, allMachineTypes);\n+\n export const diskPrice = 0.04 / 730; // per GB hour, from https://cloud.google.com/compute/pricing\n export const dataprocCpuPrice = 0.01; // dataproc costs $0.01 per cpu per hour\n+\n+export const machineStoragePrice = ({masterDiskSize, numberOfWorkers, workerDiskSize }) => {\n+  if (numberOfWorkers && workerDiskSize) {\n+    return (masterDiskSize + numberOfWorkers * workerDiskSize) * diskPrice;\n+  } else {\n+    return masterDiskSize * diskPrice;\n+  }\n+};\n+\n+export const machineStorageCostBreakdown = ({masterDiskSize, numberOfWorkers, workerDiskSize}) => {\n+  const costs = [];\n+  if (numberOfWorkers && workerDiskSize) {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Master Disk`);\n+    costs.push(`${formatUsd((numberOfWorkers * workerDiskSize) * diskPrice)}/hr Worker Disks`);\n+  } else {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Disk`);\n+  }\n+  return costs;\n+};\n+\n+export const machineRunningPrice = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+\n+  if (computeType === ComputeType.Dataproc && !workerMachine) {\n+    return NaN;\n+  }\n+\n+  const dataprocPrice = computeType === ComputeType.Dataproc\n+    ? fp.sum([\n+      (masterMachine.cpu + ((numberOfWorkers + numberOfPreemptibleWorkers) * workerMachine.cpu)) * dataprocCpuPrice,\n+      numberOfWorkers * workerMachine.price,\n+      numberOfPreemptibleWorkers * workerMachine.preemptiblePrice,\n+    ])\n+    : 0;\n+  return fp.sum([\n+    dataprocPrice,\n+    masterMachine.price,\n+    machineStoragePrice({masterDiskSize: masterDiskSize, numberOfWorkers: numberOfWorkers, workerDiskSize: workerDiskSize})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMDQyOQ==", "bodyText": "nit: rm trailing param space", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516900429", "createdAt": "2020-11-03T19:19:03Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/machines.ts", "diffHunk": "@@ -45,5 +51,92 @@ export const allMachineTypes = fp.map(({ price, preemptiblePrice, ...details })\n // See https://broadworkbench.atlassian.net/browse/SATURN-1337\n export const validLeonardoMachineTypes = allMachineTypes.filter(({memory}) => memory >= 4);\n \n+export const findMachineByName = (machineToFind: string) => fp.find(({name}) => name === machineToFind, allMachineTypes);\n+\n export const diskPrice = 0.04 / 730; // per GB hour, from https://cloud.google.com/compute/pricing\n export const dataprocCpuPrice = 0.01; // dataproc costs $0.01 per cpu per hour\n+\n+export const machineStoragePrice = ({masterDiskSize, numberOfWorkers, workerDiskSize }) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjkwMzkxNQ==", "bodyText": "Nice work on these utilities. Did you reference the Terra UI's implementation at all? If not - it would be good to do so now so we're aware of any discrepancies.", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r516903915", "createdAt": "2020-11-03T19:25:41Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/machines.ts", "diffHunk": "@@ -45,5 +51,92 @@ export const allMachineTypes = fp.map(({ price, preemptiblePrice, ...details })\n // See https://broadworkbench.atlassian.net/browse/SATURN-1337\n export const validLeonardoMachineTypes = allMachineTypes.filter(({memory}) => memory >= 4);\n \n+export const findMachineByName = (machineToFind: string) => fp.find(({name}) => name === machineToFind, allMachineTypes);\n+\n export const diskPrice = 0.04 / 730; // per GB hour, from https://cloud.google.com/compute/pricing\n export const dataprocCpuPrice = 0.01; // dataproc costs $0.01 per cpu per hour\n+\n+export const machineStoragePrice = ({masterDiskSize, numberOfWorkers, workerDiskSize }) => {\n+  if (numberOfWorkers && workerDiskSize) {\n+    return (masterDiskSize + numberOfWorkers * workerDiskSize) * diskPrice;\n+  } else {\n+    return masterDiskSize * diskPrice;\n+  }\n+};\n+\n+export const machineStorageCostBreakdown = ({masterDiskSize, numberOfWorkers, workerDiskSize}) => {\n+  const costs = [];\n+  if (numberOfWorkers && workerDiskSize) {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Master Disk`);\n+    costs.push(`${formatUsd((numberOfWorkers * workerDiskSize) * diskPrice)}/hr Worker Disks`);\n+  } else {\n+    costs.push(`${formatUsd(masterDiskSize * diskPrice)}/hr Disk`);\n+  }\n+  return costs;\n+};\n+\n+export const machineRunningPrice = ({\n+  computeType,\n+  masterDiskSize,\n+  masterMachineName,\n+  numberOfWorkers = 0,\n+  numberOfPreemptibleWorkers = 0,\n+  workerDiskSize,\n+  workerMachineName\n+}) => {\n+  const masterMachine = findMachineByName(masterMachineName);\n+  const workerMachine = workerMachineName && findMachineByName(workerMachineName);\n+\n+  if (computeType === ComputeType.Dataproc && !workerMachine) {\n+    return NaN;\n+  }\n+\n+  const dataprocPrice = computeType === ComputeType.Dataproc\n+    ? fp.sum([\n+      (masterMachine.cpu + ((numberOfWorkers + numberOfPreemptibleWorkers) * workerMachine.cpu)) * dataprocCpuPrice,\n+      numberOfWorkers * workerMachine.price,\n+      numberOfPreemptibleWorkers * workerMachine.preemptiblePrice,\n+    ])\n+    : 0;\n+  return fp.sum([\n+    dataprocPrice,\n+    masterMachine.price,\n+    machineStoragePrice({masterDiskSize: masterDiskSize, numberOfWorkers: numberOfWorkers, workerDiskSize: workerDiskSize})\n+  ]);\n+};\n+\n+export const machineRunningCostBreakdown = ({", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "088c63f7e172c2fb53f3ec227ccfc689f1070f30"}, "originalPosition": 81}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzODM2MzM4", "url": "https://github.com/all-of-us/workbench/pull/4240#pullrequestreview-523836338", "createdAt": "2020-11-05T00:38:59Z", "commit": {"oid": "06a131a31895b23659e9628b311dfee2849ba047"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMDozODo1OVrOHtuv1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwMDo1MjowMVrOHtu-9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcxMzg3OA==", "bodyText": "nit: single quotes", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517713878", "createdAt": "2020-11-05T00:38:59Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.spec.tsx", "diffHunk": "@@ -17,6 +17,7 @@ import {runtimeStore} from 'app/utils/stores';\n import {cdrVersionListResponse, CdrVersionsStubVariables} from 'testing/stubs/cdr-versions-api-stub';\n import {cdrVersionStore, serverConfigStore} from 'app/utils/navigation';\n import { RuntimeConfigurationType } from 'generated/fetch';\n+import {ComputeType} from \"app/utils/machines\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06a131a31895b23659e9628b311dfee2849ba047"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcxNTkwMA==", "bodyText": "nit: correct pattern here is probably to create a new AbortController(), pass {signal: aborter.signal} on the API fetch, then return () => aborter.abort() from this useEffect callback as a cleanup.\nThis way, if the component gets dismounted, we cancel the fetch.", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517715900", "createdAt": "2020-11-05T00:45:52Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -211,24 +227,159 @@ const DataProcConfigSelector = ({onChange, dataprocConfig})  => {\n   </fieldset>;\n };\n \n-export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())(({workspace, cdrVersionListResponse}) => {\n-  const {namespace, cdrVersionId} = workspace;\n+const PresetSelector = ({hasMicroarrayData, setSelectedDiskSize, setSelectedMachine, setSelectedCompute, setSelectedDataprocConfig}) => {\n+  {/* Recommended runtime: pick from default templates or change the image. */}\n+  return <PopupTrigger side='bottom'\n+                closeOnClick\n+                content={\n+                  <React.Fragment>\n+                    {\n+                      fp.flow(\n+                        fp.filter(({runtimeTemplate}) => hasMicroarrayData || !runtimeTemplate.dataprocConfig),\n+                        fp.toPairs,\n+                        fp.map(([i, preset]) => {\n+                          return <MenuItem\n+                                style={styles.presetMenuItem}\n+                                key={i}\n+                                aria-label={preset.displayName}\n+                                onClick={() => {\n+                                  // renaming to avoid shadowing\n+                                  const {runtimeTemplate} = preset;\n+                                  const {presetDiskSize, presetMachineName, presetCompute} = fp.cond([\n+                                    // Can't destructure due to shadowing.\n+                                    [() => !!runtimeTemplate.gceConfig, (tmpl: Runtime) => ({\n+                                      presetDiskSize: tmpl.gceConfig.diskSize,\n+                                      presetMachineName: tmpl.gceConfig.machineType,\n+                                      presetCompute: ComputeType.Standard\n+                                    })],\n+                                    [() => !!runtimeTemplate.dataprocConfig, ({dataprocConfig: {masterDiskSize, masterMachineType}}) => ({\n+                                      presetDiskSize: masterDiskSize,\n+                                      presetMachineName: masterMachineType,\n+                                      presetCompute: ComputeType.Dataproc\n+                                    })]\n+                                  ])(runtimeTemplate);\n+                                  const presetMachineType = fp.find(({name}) => name === presetMachineName, validLeonardoMachineTypes);\n+\n+                                  setSelectedDiskSize(presetDiskSize);\n+                                  setSelectedMachine(presetMachineType);\n+                                  setSelectedCompute(presetCompute);\n+                                  setSelectedDataprocConfig(runtimeTemplate.dataprocConfig);\n+                                }}>\n+                              {preset.displayName}\n+                            </MenuItem>;\n+                        })\n+                      )(runtimePresets)\n+                    }\n+                  </React.Fragment>\n+                }>\n+    <Clickable data-test-id='runtime-presets-menu'>\n+      Recommended environments <ClrIcon shape='caret down'/>\n+    </Clickable>\n+  </PopupTrigger>;\n+};\n+\n+const CostEstimator = ({\n+  freeCreditsRemaining,\n+  profile,\n+  runningCost,\n+  runningCostBreakdown,\n+  runtimeChanged,\n+  storageCost,\n+  storageCostBreakdown,\n+  workspace\n+}) => {\n+  const wrapperStyle = runtimeChanged\n+    ? {...styles.costPredictorWrapper, backgroundColor: colorWithWhiteness(colors.warning, .9), borderColor: colors.warning}\n+    : styles.costPredictorWrapper;\n+  return <FlexRow\n+    style={wrapperStyle}\n+  >\n+    <FlexRow style={{minWidth: '250px', margin: '.33rem .5rem'}}>\n+      <FlexColumn style={{marginRight: '1rem'}}>\n+        <div style={{fontSize: '10px', fontWeight: 600}}>Cost when running</div>\n+        <TooltipTrigger content={\n+          <div>\n+            <div>Cost Breakdown</div>\n+            {runningCostBreakdown.map((lineItem, i) => <div key={i}>{lineItem}</div>)}\n+          </div>\n+        }>\n+          <div style={{fontSize: '20px', color: colors.accent}}>{formatUsd(runningCost)}/hr</div>\n+        </TooltipTrigger>\n+      </FlexColumn>\n+      <FlexColumn>\n+        <div style={{fontSize: '10px', fontWeight: 600}}>Cost when paused</div>\n+        <TooltipTrigger content={\n+          <div>\n+            <div>Cost Breakdown</div>\n+            {storageCostBreakdown.map((lineItem, i) => <div key={i}>{lineItem}</div>)}\n+          </div>\n+        }>\n+          <div style={{fontSize: '20px', color: colors.accent}}>{formatUsd(storageCost)}/hr</div>\n+        </TooltipTrigger>\n+      </FlexColumn>\n+    </FlexRow>\n+    {\n+      workspace.billingAccountType === BillingAccountType.FREETIER\n+      && profile.username === workspace.creator\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will draw from your remaining {formatUsd(freeCreditsRemaining)} of free credits.\n+      </div>\n+    }\n+    {\n+      workspace.billingAccountType === BillingAccountType.FREETIER\n+      && profile.username !== workspace.creator\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will draw from workspace creator's remaining {formatUsd(freeCreditsRemaining)} of free credits.\n+      </div>\n+    }\n+    {\n+      workspace.billingAccountType === BillingAccountType.USERPROVIDED\n+      && <div style={{borderLeft: `1px solid ${colorWithWhiteness(colors.dark, .5)}`, padding: '.33rem .5rem'}}>\n+        Costs will be charged to billing account {workspace.billingAccountName}.\n+      </div>\n+    }\n+  </FlexRow>;\n+};\n+\n+export const RuntimePanel = fp.flow(\n+  withCdrVersions(),\n+  withCurrentWorkspace(),\n+  withUserProfile()\n+)(({cdrVersionListResponse, workspace, profileState}) => {\n+  const {namespace, id, cdrVersionId} = workspace;\n+\n+  const {profile} = profileState;\n+\n   const {hasMicroarrayData} = fp.find({cdrVersionId}, cdrVersionListResponse.items) || {hasMicroarrayData: false};\n   const [currentRuntime, setRequestedRuntime] = useCustomRuntime(namespace);\n+\n   const {status = null, dataprocConfig = null, gceConfig = {diskSize: defaultDiskSize}} = currentRuntime || {} as Partial<Runtime>;\n-  const machineName = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n-  const diskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.diskSize;\n-  const initialMasterMachine = findMachineByName(machineName);\n+  const diskSize = dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.diskSize;\n+  const machineName = dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n+  const initialMasterMachine = findMachineByName(machineName) || defaultMachineType;\n+  const initialCompute = dataprocConfig ? ComputeType.Dataproc : ComputeType.Standard;\n+\n   const [selectedDiskSize, setSelectedDiskSize] = useState(diskSize);\n   const [selectedMachine, setSelectedMachine] = useState(initialMasterMachine);\n-  const [selectedCompute, setSelectedCompute] = useState<ComputeType>(dataprocConfig ? ComputeType.Dataproc : ComputeType.Standard);\n+  const [selectedCompute, setSelectedCompute] = useState<ComputeType>(initialCompute);\n   const [selectedDataprocConfig, setSelectedDataprocConfig] = useState<DataprocConfig | null>(dataprocConfig);\n \n   const selectedMachineType = selectedMachine && selectedMachine.name;\n   const runtimeExists = status && status !== RuntimeStatus.Deleted;\n   const runtimeChanged = !fp.equals(selectedMachine, initialMasterMachine) ||\n     selectedDiskSize !== diskSize ||\n-    !fp.equals(selectedDataprocConfig, dataprocConfig);\n+    !fp.equals(selectedDataprocConfig, dataprocConfig) ||\n+    !fp.equals(selectedCompute, initialCompute);\n+\n+  const [creatorFreeCreditsRemaining, setCreatorFreeCreditsRemaining] = useState(0);\n+  useEffect(() => {\n+    const fetchFreeCredits = async() => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06a131a31895b23659e9628b311dfee2849ba047"}, "originalPosition": 235}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcxNzI2OA==", "bodyText": "Lots of repeated code here with these 4 parameters, perhaps this should just be a single object payload, then let the CostEstimator pass these through to the utilities?", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517717268", "createdAt": "2020-11-05T00:50:30Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -243,55 +394,52 @@ export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())((\n     </div>\n     {/* TODO(RW-5419): Cost estimates go here. */}\n     <div style={styles.controlSection}>\n-      {/* Recommended runtime: pick from default templates or change the image. */}\n-      <PopupTrigger side='bottom'\n-                    closeOnClick\n-                    content={\n-                      <React.Fragment>\n-                        {\n-                          fp.flow(\n-                            fp.filter(({runtimeTemplate}) => hasMicroarrayData || !runtimeTemplate.dataprocConfig),\n-                            fp.toPairs,\n-                            fp.map(([i, preset]) => {\n-                              return <MenuItem\n-                              style={styles.presetMenuItem}\n-                              key={i}\n-                              aria-label={preset.displayName}\n-                              onClick={() => {\n-                                // renaming to avoid shadowing\n-                                const {runtimeTemplate} = preset;\n-                                const {presetDiskSize, presetMachineName, presetCompute} = fp.cond([\n-                                  // Can't destructure due to shadowing.\n-                                  [() => !!runtimeTemplate.gceConfig, (tmpl: Runtime) => ({\n-                                    presetDiskSize: tmpl.gceConfig.diskSize,\n-                                    presetMachineName: tmpl.gceConfig.machineType,\n-                                    presetCompute: ComputeType.Standard\n-                                  })],\n-                                  [() => !!runtimeTemplate.dataprocConfig, ({dataprocConfig: {masterDiskSize, masterMachineType}}) => ({\n-                                    presetDiskSize: masterDiskSize,\n-                                    presetMachineName: masterMachineType,\n-                                    presetCompute: ComputeType.Dataproc\n-                                  })]\n-                                ])(runtimeTemplate);\n-                                const presetMachineType = fp.find(({name}) => name === presetMachineName, validLeonardoMachineTypes);\n+      <CostEstimator\n+          freeCreditsRemaining={creatorFreeCreditsRemaining}\n+          profile={profile}\n+          runningCost={machineRunningPrice({\n+            computeType: selectedCompute,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06a131a31895b23659e9628b311dfee2849ba047"}, "originalPosition": 284}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzcxNzc0OA==", "bodyText": "note: reminder to rebase this, since I changed this a bit in my PR", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r517717748", "createdAt": "2020-11-05T00:52:01Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/leo-runtime-initializer.tsx", "diffHunk": "@@ -13,8 +13,11 @@ import {serverConfigStore} from './navigation';\n // We're only willing to wait 20 minutes total for a runtime to initialize. After that we return\n // a rejected promise no matter what.\n const DEFAULT_OVERALL_TIMEOUT = 1000 * 60 * 20;\n-const DEFAULT_INITIAL_POLLING_DELAY = 2000;\n+// XXX: Hack for unit testing.\n+let DEFAULT_INITIAL_POLLING_DELAY = 2000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06a131a31895b23659e9628b311dfee2849ba047"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdb049eb02b945a5883aba1a769b6d76bdfc6d2f", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/cdb049eb02b945a5883aba1a769b6d76bdfc6d2f", "committedDate": "2020-11-05T16:49:41Z", "message": "Initial preset and dataproc fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4c04094e835a62d1a5cc7014d1e0965c832c14b", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/d4c04094e835a62d1a5cc7014d1e0965c832c14b", "committedDate": "2020-11-05T16:49:42Z", "message": "first pass"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff12bc635157fc5702c7db32cdabaf733458952d", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/ff12bc635157fc5702c7db32cdabaf733458952d", "committedDate": "2020-11-05T16:49:42Z", "message": "dynamic update styling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b68da8d3131377ae92ea6ba8e7ccc1bbea53b3d", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/0b68da8d3131377ae92ea6ba8e7ccc1bbea53b3d", "committedDate": "2020-11-05T16:49:42Z", "message": "shelving"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0aba36ed19766561b60690d57e5cc70152cb849e", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/0aba36ed19766561b60690d57e5cc70152cb849e", "committedDate": "2020-11-05T16:49:42Z", "message": "free credits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba08455e2e3261471d03f5b48c2a87df3e5f3ef4", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/ba08455e2e3261471d03f5b48c2a87df3e5f3ef4", "committedDate": "2020-11-05T16:49:42Z", "message": "billing account name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "880d4ac8258b32a50230b2306dbf55ae70fb62ec", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/880d4ac8258b32a50230b2306dbf55ae70fb62ec", "committedDate": "2020-11-05T16:49:42Z", "message": "shelving - tooltips"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87cc2f834fe372a95bac7525bfd1bbe1595e8c51", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/87cc2f834fe372a95bac7525bfd1bbe1595e8c51", "committedDate": "2020-11-05T16:49:42Z", "message": "shelving for debugging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0432560500777424eb0c78e72c6a01b99b7392bc", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/0432560500777424eb0c78e72c6a01b99b7392bc", "committedDate": "2020-11-05T16:49:42Z", "message": "per hour"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77e1ed5811e856338cb57573859d1b058f86fadb", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/77e1ed5811e856338cb57573859d1b058f86fadb", "committedDate": "2020-11-05T16:49:42Z", "message": "dryerful of lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19efeba7e7dca2b4cd5913e5c6793856750b4b4e", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/19efeba7e7dca2b4cd5913e5c6793856750b4b4e", "committedDate": "2020-11-05T16:49:42Z", "message": "implement api stub"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6da5617e3d4383f1a2bd1a9bec44e8c239dfa700", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/6da5617e3d4383f1a2bd1a9bec44e8c239dfa700", "committedDate": "2020-11-05T16:49:42Z", "message": "spotless........."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "349724cb90889fd5936b9ef90f6615cc862d0d05", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/349724cb90889fd5936b9ef90f6615cc862d0d05", "committedDate": "2020-11-05T16:49:42Z", "message": "use api stub"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c64603f6cb782c8463879d3af0a404e2e467c9c", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/0c64603f6cb782c8463879d3af0a404e2e467c9c", "committedDate": "2020-11-05T16:49:42Z", "message": "lint & lint & lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fcc33fbc39c7118ddf3d3a18cbb80815ca2b81d", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/3fcc33fbc39c7118ddf3d3a18cbb80815ca2b81d", "committedDate": "2020-11-05T16:49:42Z", "message": "fix ui tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "954226363296c8b4f21055102a6c71e5ea48852f", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/954226363296c8b4f21055102a6c71e5ea48852f", "committedDate": "2020-11-05T16:49:42Z", "message": "unfuck tests for real this time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f64bd1df82fef0db712efb126e69398d6ca8574", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/2f64bd1df82fef0db712efb126e69398d6ca8574", "committedDate": "2020-11-05T16:53:18Z", "message": "review feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38a38218e51df86f1fa9d3f3f8e70b69c626c7a0", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/38a38218e51df86f1fa9d3f3f8e70b69c626c7a0", "committedDate": "2020-11-05T16:53:18Z", "message": "oy geVALT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f888badf753cbb3d48404f3eae3d92149798b16", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/3f888badf753cbb3d48404f3eae3d92149798b16", "committedDate": "2020-11-05T16:53:18Z", "message": "further revisions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef6efd2c37bdb7d495ff079a3f04953b214ce1ef", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/ef6efd2c37bdb7d495ff079a3f04953b214ce1ef", "committedDate": "2020-11-05T20:18:12Z", "message": "unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "06a131a31895b23659e9628b311dfee2849ba047", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/06a131a31895b23659e9628b311dfee2849ba047", "committedDate": "2020-11-04T21:06:21Z", "message": "oy geVALT"}, "afterCommit": {"oid": "ef6efd2c37bdb7d495ff079a3f04953b214ce1ef", "author": {"user": null}, "url": "https://github.com/all-of-us/workbench/commit/ef6efd2c37bdb7d495ff079a3f04953b214ce1ef", "committedDate": "2020-11-05T20:18:12Z", "message": "unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NjQxMDg3", "url": "https://github.com/all-of-us/workbench/pull/4240#pullrequestreview-524641087", "createdAt": "2020-11-05T20:28:47Z", "commit": {"oid": "ef6efd2c37bdb7d495ff079a3f04953b214ce1ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NjU4NDkz", "url": "https://github.com/all-of-us/workbench/pull/4240#pullrequestreview-524658493", "createdAt": "2020-11-05T20:54:53Z", "commit": {"oid": "ef6efd2c37bdb7d495ff079a3f04953b214ce1ef"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMDo1NDo1M1rOHuWGPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMDo1NDo1M1rOHuWGPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODM1ODU4OQ==", "bodyText": "Just noticed this diff..", "url": "https://github.com/all-of-us/workbench/pull/4240#discussion_r518358589", "createdAt": "2020-11-05T20:54:53Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -311,7 +499,7 @@ export const RuntimePanel = fp.flow(withCurrentWorkspace(), withCdrVersions())((\n       <FlexColumn style={{marginTop: '1rem'}}>\n         <label htmlFor='runtime-compute'>Compute type</label>\n         <Dropdown id='runtime-compute'\n-                  disabled={!hasMicroarrayData}\n+                  // disabled={!hasMicroarrayData}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef6efd2c37bdb7d495ff079a3f04953b214ce1ef"}, "originalPosition": 392}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3816, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}