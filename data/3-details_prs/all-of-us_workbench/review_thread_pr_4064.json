{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyNzY0MDQ0", "number": 4064, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMDo1MzowNFrOEnRM7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNDowODo1NlrOEtgNhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NjExNzU2OnYy", "diffSide": "RIGHT", "path": "ui/src/app/components/copy-modal.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMDo1MzowNFrOHXxXLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQwMDo1MzowNFrOHXxXLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDY4ODA0NQ==", "bodyText": "mostly copied from the mocks", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r494688045", "createdAt": "2020-09-25T00:53:04Z", "author": {"login": "jmthibault79"}, "path": "ui/src/app/components/copy-modal.tsx", "diffHunk": "@@ -21,54 +24,127 @@ const ResourceTypeHomeTabs = new Map()\n   .set(ResourceType.DATASET, 'data');\n \n export interface Props {\n+  cdrVersionListResponse: CdrVersionListResponse;\n   fromWorkspaceNamespace: string;\n-  fromWorkspaceName: string;\n+  fromWorkspaceFCName: string;\n   fromResourceName: string;\n+  fromCdrVersionId: string;\n   onClose: Function;\n   onCopy: Function;\n   resourceType: ResourceType;\n   saveFunction: (CopyRequest) => Promise<FileDetail | ConceptSet>;\n }\n \n interface State {\n-  writeableWorkspaces: Array<Workspace>;\n+  workspaceOptions: Array<Object>;\n   destination: Workspace;\n   newName: string;\n   requestState: RequestState;\n-  errorMsg: string;\n+  saveErrorMsg: string;\n   loading: boolean;\n+  cdrMismatch: string;\n }\n \n-const boldStyle = {\n-  fontWeight: 600\n-};\n+const styles = reactStyles({\n+  bold: {\n+    fontWeight: 600\n+  },\n+  conceptSetCdrMismatch: {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4f0c7adf9eeae1a7025c6948a71d82cf76fb54"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NzY0MzQzOnYy", "diffSide": "RIGHT", "path": "e2e/tests/conceptsets/copy-to-workspace.spec.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNjo1NDo1N1rOHgwoIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNjo1NDo1N1rOHgwoIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDExMzE4NA==", "bodyText": "extracted from the existing test, for reuse", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504113184", "createdAt": "2020-10-13T16:54:57Z", "author": {"login": "jmthibault79"}, "path": "e2e/tests/conceptsets/copy-to-workspace.spec.ts", "diffHunk": "@@ -7,8 +7,30 @@ import {SaveOption} from 'app/page/conceptset-save-modal';\n import WorkspaceDataPage from 'app/page/workspace-data-page';\n import {LinkText, ResourceCard} from 'app/text-labels';\n import {makeRandomName} from 'utils/str-utils';\n-import {findWorkspace, signIn} from 'utils/test-utils';\n-\n+import {createWorkspace, signIn} from 'utils/test-utils';\n+import {config} from 'resources/workbench-config';\n+\n+async function createConceptSet(srcWorkspaceCard: WorkspaceCard) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9edfafe3d98017d220ce1bf15ead82c26ee08399"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1Nzk3OTc2OnYy", "diffSide": "RIGHT", "path": "e2e/app/component/copy-modal.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODoyMDowOFrOHgz3JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODoyMDowOFrOHgz3JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2NjE4MA==", "bodyText": "So this can be used for successful and attempted copies", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504166180", "createdAt": "2020-10-13T18:20:08Z", "author": {"login": "jmthibault79"}, "path": "e2e/app/component/copy-modal.ts", "diffHunk": "@@ -19,12 +19,12 @@ export default class CopyModal extends Modal {\n     return new Textbox(this.page, `${this.getXpath()}//*[contains(text(), \"Name\")]/ancestor::node()[1]/input[@type=\"text\"]`);\n   }\n \n- /**\n-  *\n-  * @param {string} workspaceName Destination Workspace name.\n-  * @param {string} newName New name.\n-  */\n-  async copyToAnotherWorkspace(workspaceName: string, newName?: string): Promise<void> {\n+  /**\n+   *\n+   * @param {string} workspaceName Destination Workspace name.\n+   * @param {string} newName New name.\n+   */\n+  async beginCopyToAnotherWorkspace(workspaceName: string, newName?: string): Promise<void> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc8c5cba10802657abf00f66c0e9fe4d7fae6ed"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1Nzk4MzI3OnYy", "diffSide": "LEFT", "path": "e2e/tests/conceptsets/copy-to-workspace.spec.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODoyMToxMVrOHgz5Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODoyMToxMVrOHgz5Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2NjcyNw==", "bodyText": "TODO: refactor the kitchen-sink findWorkspace().  All we are using it for here is workspace creation.", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504166727", "createdAt": "2020-10-13T18:21:11Z", "author": {"login": "jmthibault79"}, "path": "e2e/tests/conceptsets/copy-to-workspace.spec.ts", "diffHunk": "@@ -18,41 +40,26 @@ describe('Copy Concept Set to another workspace', () => {\n \n   /**\n    * Test:\n-   * - Copy Concept Set from one workspace to another workspace.\n+   * - Copy Concept Set from one workspace to another workspace when both have the same CDR Version.\n    */\n-  test('Workspace OWNER can copy Concept Set', async () => {\n+  test('Workspace OWNER can copy Concept Set when CDR Versions match', async () => {\n \n-    // Need a source and a destination workspace.\n+    // Create a source and a destination workspace with the same CDR Version.\n \n-    const destWorkspaceCard: WorkspaceCard = await findWorkspace(page, {create: true});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc8c5cba10802657abf00f66c0e9fe4d7fae6ed"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1Nzk4NTY3OnYy", "diffSide": "RIGHT", "path": "e2e/tests/notebook/owner-copy-to-workspace.spec.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODoyMTo1MFrOHgz6tQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODoyMTo1MFrOHgz6tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2NzA5Mw==", "bodyText": "common code for two tests, copied from the original test", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504167093", "createdAt": "2020-10-13T18:21:50Z", "author": {"login": "jmthibault79"}, "path": "e2e/tests/notebook/owner-copy-to-workspace.spec.ts", "diffHunk": "@@ -3,73 +3,79 @@ import Modal from 'app/component/modal';\n import WorkspaceDataPage from 'app/page/workspace-data-page';\n import {LinkText, ResourceCard} from 'app/text-labels';\n import {makeRandomName} from 'utils/str-utils';\n-import {findWorkspace, signIn} from 'utils/test-utils';\n+import {createWorkspace, findWorkspace, signIn} from 'utils/test-utils';\n+import {config} from 'resources/workbench-config';\n \n // Notebook server start may take a long time. Set maximum test running time to 20 minutes.\n jest.setTimeout(20 * 60 * 1000);\n \n+/**\n+ * Test:\n+ * - Create new Workspace as the copy-to destination Workspace.\n+ * - Create new Workspace as copy-from Workspace and create new notebook in this Workspace.\n+ * - Run code to print WORKSPACE_NAMESPACE. It should match Workspace namespace from Workspace URL.\n+ * - Copy notebook to destination Workspace and give copied notebook a new name.\n+ * - Verify copied notebook is in destination Workspace.\n+ * - Open copied notebook and run code to print WORKSPACE_NAMESPACE. It should match destination Workspace namespace.\n+ * - Delete notebooks.\n+ */\n+async function copyNotebookTest(srcCdrVersionName: string, destCdrVersionName: string) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc8c5cba10802657abf00f66c0e9fe4d7fae6ed"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1Nzk4NzM5OnYy", "diffSide": "RIGHT", "path": "e2e/utils/test-utils.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODoyMjoyMFrOHgz7uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxODoyMjoyMFrOHgz7uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE2NzM1NQ==", "bodyText": "Adapted from the creation path of findWorkspace()", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504167355", "createdAt": "2020-10-13T18:22:20Z", "author": {"login": "jmthibault79"}, "path": "e2e/utils/test-utils.ts", "diffHunk": "@@ -178,6 +179,20 @@ export async function performAction(\n \n }\n \n+export async function createWorkspace(page: Page, cdrVersionName: string = config.defaultCdrVersionName): Promise<WorkspaceCard> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fc8c5cba10802657abf00f66c0e9fe4d7fae6ed"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MTQ5MTI2OnYy", "diffSide": "RIGHT", "path": "ui/src/app/components/copy-modal.tsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNDowODo1NlrOHhU88w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxNTo0NToxOFrOHhZkXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwODMzOQ==", "bodyText": "opt: consider using an fp.cond here - I believe it would eliminate the need for an early return and would tie together the 3 conditions as \"one of these can occur\"", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504708339", "createdAt": "2020-10-14T14:08:56Z", "author": {"login": "petesantos"}, "path": "ui/src/app/components/copy-modal.tsx", "diffHunk": "@@ -218,27 +276,57 @@ class CopyModalComponent extends React.Component<Props, State> {\n     }\n   }\n \n-  setDestination(destination: Workspace) {\n+  // OK to copy a notebook with a mismatch, but show a warning message\n+  setNotebookCdrMismatchWarning(destination: Workspace, fromCdrVersionId: string) {\n+    const warningMsg = `The selected destination workspace uses a different dataset version ` +\n+        `(${this.cdrName(destination.cdrVersionId)}) than the current workspace (${this.cdrName(fromCdrVersionId)}). ` +\n+        'Edits may be required to ensure your analysis is functional and accurate.';\n+    this.setState({ cdrMismatch: warningMsg, destination: destination });\n+  }\n+\n+  // not OK to copy a Concept Set with a mismatch.  Show an error message and prevent copy\n+  setConceptSetCdrMismatchError(destination: Workspace, fromCdrVersionId: string) {\n+    const errorMsg = `Can\u2019t copy to that workspace. It uses a different dataset version ` +\n+        `(${this.cdrName(destination.cdrVersionId)}) than the current workspace (${this.cdrName(fromCdrVersionId)}).`;\n+    this.setState({ cdrMismatch: errorMsg, destination: null });\n+  }\n+\n+  validateAndSetDestination(destination: Workspace) {\n+    const {fromCdrVersionId, resourceType} = this.props;\n+\n     this.clearCopyError();\n-    this.setState({destination: destination});\n+\n+    if (fromCdrVersionId === destination.cdrVersionId) {\n+      this.setState({cdrMismatch: '', destination: destination});\n+      return;\n+    }\n+\n+    if (resourceType === ResourceType.NOTEBOOK) {\n+      this.setNotebookCdrMismatchWarning(destination, fromCdrVersionId);\n+    } else if (resourceType === ResourceType.CONCEPTSET) {\n+      this.setConceptSetCdrMismatchError(destination, fromCdrVersionId);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06c224880f5350ff4f10db12498d646c62c9e7a4"}, "originalPosition": 139}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDc4Mzk2NQ==", "bodyText": "I attempted to do so, but this caused my e2e tests to fail.  This attempt is commit ea710b5", "url": "https://github.com/all-of-us/workbench/pull/4064#discussion_r504783965", "createdAt": "2020-10-14T15:45:18Z", "author": {"login": "jmthibault79"}, "path": "ui/src/app/components/copy-modal.tsx", "diffHunk": "@@ -218,27 +276,57 @@ class CopyModalComponent extends React.Component<Props, State> {\n     }\n   }\n \n-  setDestination(destination: Workspace) {\n+  // OK to copy a notebook with a mismatch, but show a warning message\n+  setNotebookCdrMismatchWarning(destination: Workspace, fromCdrVersionId: string) {\n+    const warningMsg = `The selected destination workspace uses a different dataset version ` +\n+        `(${this.cdrName(destination.cdrVersionId)}) than the current workspace (${this.cdrName(fromCdrVersionId)}). ` +\n+        'Edits may be required to ensure your analysis is functional and accurate.';\n+    this.setState({ cdrMismatch: warningMsg, destination: destination });\n+  }\n+\n+  // not OK to copy a Concept Set with a mismatch.  Show an error message and prevent copy\n+  setConceptSetCdrMismatchError(destination: Workspace, fromCdrVersionId: string) {\n+    const errorMsg = `Can\u2019t copy to that workspace. It uses a different dataset version ` +\n+        `(${this.cdrName(destination.cdrVersionId)}) than the current workspace (${this.cdrName(fromCdrVersionId)}).`;\n+    this.setState({ cdrMismatch: errorMsg, destination: null });\n+  }\n+\n+  validateAndSetDestination(destination: Workspace) {\n+    const {fromCdrVersionId, resourceType} = this.props;\n+\n     this.clearCopyError();\n-    this.setState({destination: destination});\n+\n+    if (fromCdrVersionId === destination.cdrVersionId) {\n+      this.setState({cdrMismatch: '', destination: destination});\n+      return;\n+    }\n+\n+    if (resourceType === ResourceType.NOTEBOOK) {\n+      this.setNotebookCdrMismatchWarning(destination, fromCdrVersionId);\n+    } else if (resourceType === ResourceType.CONCEPTSET) {\n+      this.setConceptSetCdrMismatchError(destination, fromCdrVersionId);\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDcwODMzOQ=="}, "originalCommit": {"oid": "06c224880f5350ff4f10db12498d646c62c9e7a4"}, "originalPosition": 139}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3962, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}