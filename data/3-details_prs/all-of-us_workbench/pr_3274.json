{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMTM5NTg3", "number": 3274, "title": "[RW-4626][risk=no] Puppeteer: Fix Registration tests", "bodyText": "Updated tests to work with new Create Account UI and removed non-working code.\nUnrelated to broken test, I also saw some flaky behavior while running tests repeatedly. I refactored few lines of code that should remove flaky behavior.", "createdAt": "2020-03-19T17:30:01Z", "url": "https://github.com/all-of-us/workbench/pull/3274", "merged": true, "mergeCommit": {"oid": "05f2b02381977071f21ae52fd1696dc6e202445e"}, "closed": true, "closedAt": "2020-03-20T16:12:01Z", "author": {"login": "aweng98"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPPWhFgH2gAyMzkxMTM5NTg3Ojg1ODQwMmIwNGUwMDU5N2JhODIxNjU2NzJiZmNlYjc1ZjkzNmQzZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPi2ZWAFqTM3ODYyMDEzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/858402b04e00597ba82165672bfceb75f936d3e6", "committedDate": "2020-03-19T17:28:07Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTA4NTAz", "url": "https://github.com/all-of-us/workbench/pull/3274#pullrequestreview-378508503", "createdAt": "2020-03-20T14:01:53Z", "commit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDowMTo1M1rOF5U8Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDowMTo1M1rOF5U8Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY1NjIzMA==", "bodyText": "Can we add comments here to // Step 2: Terms of service?", "url": "https://github.com/all-of-us/workbench/pull/3274#discussion_r395656230", "createdAt": "2020-03-20T14:01:53Z", "author": {"login": "NehaBroad"}, "path": "e2e/tests/user/registration.spec.ts", "diffHunk": "@@ -54,16 +55,22 @@ describe('User registration tests:', () => {\n \n     await createAccountPage.acceptTermsOfUseAgreement();\n     let nextButton = await createAccountPage.getNextButton();\n+    await nextButton.waitUntilEnabled();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTEwODcz", "url": "https://github.com/all-of-us/workbench/pull/3274#pullrequestreview-378510873", "createdAt": "2020-03-20T14:04:54Z", "commit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDowNDo1NFrOF5VDgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDowNDo1NFrOF5VDgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY1ODExNA==", "bodyText": "Do we add negative test too? Like invalid email etc", "url": "https://github.com/all-of-us/workbench/pull/3274#discussion_r395658114", "createdAt": "2020-03-20T14:04:54Z", "author": {"login": "NehaBroad"}, "path": "e2e/tests/user/registration-ui.spec.ts", "diffHunk": "@@ -133,35 +135,47 @@ describe('User registration tests:', () => {\n     const agreementPageButton = await createAccountPage.getNextButton();\n     await agreementPageButton.click();\n \n-    // Step 3: Enter user information. Should be on Create your account: Step 1 of 2 page\n-    expect(await createAccountPage.waitForTextExists('Create your account')).toBeTruthy();\n+    // Step 1 of 3: Enter Institution information\n+    const nextButton = await createAccountPage.getNextButton();\n+    expect(await nextButton.isCursorNotAllowed()).toEqual(true);\n \n-    // the NEXT button on User Information page should be disabled until all required fields are filled\n-    const userInforPageButton = await createAccountPage.getNextButton();\n-    const cursor = await userInforPageButton.isCursorNotAllowed();\n-    expect(cursor).toEqual(true);\n+    const institutionSelect = new SelectComponent(page, 'Select your institution');\n+    await institutionSelect.select(INSTITUTION_VALUE.VANDERBILT);\n+\n+    const emailAddress = await Textbox.forLabel(page, {textContains: FIELD_LABEL.INSTITUTION_EMAIL, ancestorNodeLevel: 2});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTE1MDA5", "url": "https://github.com/all-of-us/workbench/pull/3274#pullrequestreview-378515009", "createdAt": "2020-03-20T14:10:11Z", "commit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxMDoxMVrOF5VPkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxMDoxMVrOF5VPkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2MTIwMQ==", "bodyText": "super nit: change variable name from str to textContent", "url": "https://github.com/all-of-us/workbench/pull/3274#discussion_r395661201", "createdAt": "2020-03-20T14:10:11Z", "author": {"login": "NehaBroad"}, "path": "e2e/app/aou-elements/select-component.ts", "diffHunk": "@@ -1,30 +1,35 @@\n import {Page} from 'puppeteer';\n+import BaseElement from './base-element';\n \n export default class SelectComponent {\n \n-  constructor(private readonly page: Page, private readonly label?: string) {\n+  constructor(private readonly page: Page, private readonly label?: string, private readonly nodeLevel?: number) {\n     this.page = page;\n     this.label = label || undefined;\n+    this.nodeLevel = nodeLevel || 1;\n   }\n \n-  async select(textValue: string) {\n+  async select(textValue: string): Promise<string> {\n     await this.open(2); // with 2 retries\n-    const selector = this.componentXpath() + `//li[@class='p-dropdown-item'][normalize-space(.)=\"${textValue}\"]`;\n+    const selector = this.dropdownXpath() + `//li[contains(normalize-space(text()), \"${textValue}\")]`;\n     const selectValue = await this.page.waitForXPath(selector, { visible: true });\n+    const selectElement = new BaseElement(this.page, selectValue);\n+    const str = await selectElement.getTextContent();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTE1Njg1", "url": "https://github.com/all-of-us/workbench/pull/3274#pullrequestreview-378515685", "createdAt": "2020-03-20T14:11:01Z", "commit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxMTowMVrOF5VRpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxMTowMVrOF5VRpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2MTczNA==", "bodyText": "nice!", "url": "https://github.com/all-of-us/workbench/pull/3274#discussion_r395661734", "createdAt": "2020-03-20T14:11:01Z", "author": {"login": "NehaBroad"}, "path": "e2e/app/base-page.ts", "diffHunk": "@@ -221,4 +222,19 @@ export default abstract class BasePage {\n     }, element);\n   }\n \n+  /**\n+   * Take a full-page screenshot, save file in .png format in logs/screenshot directory.\n+   * @param fileName\n+   */\n+  async takeScreenshot(fileName: string) {\n+    const dir = 'logs/screenshot';\n+    if (!fs.existsSync(dir)) {\n+      fs.mkdirSync(dir);\n+    }\n+    const timestamp = new Date().getTime();\n+    const screenshotFile = `${dir}/${fileName}_${timestamp}.png`;\n+    await this.page.screenshot({path: screenshotFile, fullPage: true});\n+    console.log('screenshot taken: ' + screenshotFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTE2Nzky", "url": "https://github.com/all-of-us/workbench/pull/3274#pullrequestreview-378516792", "createdAt": "2020-03-20T14:12:17Z", "commit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxMjoxOFrOF5VU3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxMjoxOFrOF5VU3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2MjU1OA==", "bodyText": "nit: Fill out institution details - to clarify its just not institution name but email and role as well", "url": "https://github.com/all-of-us/workbench/pull/3274#discussion_r395662558", "createdAt": "2020-03-20T14:12:18Z", "author": {"login": "NehaBroad"}, "path": "e2e/app/create-account-page.ts", "diffHunk": "@@ -129,27 +127,37 @@ export default class CreateAccountPage extends BasePage {\n \n   // select Education Level from a dropdown\n   async selectEducationLevel(selectTextValue: string) {\n-    const dropdown = new SelectComponent(this.page, FIELD_LABEL.EDUCATION_LEVEL);\n+    const dropdown = new SelectComponent(this.page, FIELD_LABEL.EDUCATION_LEVEL, 2);\n     await dropdown.select(selectTextValue);\n   }\n \n   // select Year of Birth from a dropdown\n   async selectYearOfBirth(year: string) {\n-    const dropdown = new SelectComponent(this.page, FIELD_LABEL.YEAR_OF_BIRTH);\n+    const dropdown = new SelectComponent(this.page, FIELD_LABEL.YEAR_OF_BIRTH, 2);\n     await dropdown.select(year);\n   }\n \n   // Combined steps to make test code cleaner and shorter\n \n-  // Step 1: Enter Invitation key\n+  // Step 1: Fill out Institution", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTE5MjU0", "url": "https://github.com/all-of-us/workbench/pull/3274#pullrequestreview-378519254", "createdAt": "2020-03-20T14:15:07Z", "commit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxNTowN1rOF5Vb8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxNTowN1rOF5Vb8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2NDM3MA==", "bodyText": "May not be part of this PR but it will be nice to have a util method to handle errors where in we can just pass the flow name say invitation key -> it will print error and take a screen shot with file name invitation key", "url": "https://github.com/all-of-us/workbench/pull/3274#discussion_r395664370", "createdAt": "2020-03-20T14:15:07Z", "author": {"login": "NehaBroad"}, "path": "e2e/app/google-login.ts", "diffHunk": "@@ -89,8 +89,13 @@ export default class GoogleLoginPage extends BasePage {\n   /**\n    * Open All-of-Us Google login page.\n    */\n-  async goto(): Promise<void> {\n-    await this.page.goto(configs.uiBaseUrl + configs.loginUrlPath, {waitUntil: ['networkidle0', 'domcontentloaded'], timeout: 0});\n+  async load(): Promise<void> {\n+    const url = configs.uiBaseUrl + configs.loginUrlPath;\n+    await this.page.goto(url, {waitUntil: ['networkidle0', 'domcontentloaded'], timeout: 30000}).catch((err) => {\n+      console.error('Google login page not found. ' + err);\n+      this.takeScreenshot('GoogleLoginNotFound');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "858402b04e00597ba82165672bfceb75f936d3e6"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56486147c7b7b9dde64d5229e8bf55c85dbc4aef", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/56486147c7b7b9dde64d5229e8bf55c85dbc4aef", "committedDate": "2020-03-20T14:25:02Z", "message": "PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NjIwMTM3", "url": "https://github.com/all-of-us/workbench/pull/3274#pullrequestreview-378620137", "createdAt": "2020-03-20T16:11:08Z", "commit": {"oid": "56486147c7b7b9dde64d5229e8bf55c85dbc4aef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3251, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}