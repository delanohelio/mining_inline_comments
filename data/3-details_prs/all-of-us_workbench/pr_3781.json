{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5MDI4NjI3", "number": 3781, "title": "[RW-5166][risk=no] inject DataSetMapper into DataSetServiceImpl", "bodyText": "This PR addresses:\n\nmoving DataSetMapper from DataSetController to DataSetServiceImpl\nmoving DataDictionaryEntryDao from DataSetController to DataSetServiceImpl\nupdating affected test cases.", "createdAt": "2020-07-14T17:59:28Z", "url": "https://github.com/all-of-us/workbench/pull/3781", "merged": true, "mergeCommit": {"oid": "8bf52035d9394e353c99a771bf4b92a88056d762"}, "closed": true, "closedAt": "2020-07-15T20:18:35Z", "author": {"login": "freemabd"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc058A2gH2gAyNDQ5MDI4NjI3OjJiMTViNDllMGI4NmExZDRjZThhMWVhYTc1MjM3YTUzNzM2NTg3NWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1PWHYAFqTQ0OTI0MzczNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2b15b49e0b86a1d4ce8a1eaa75237a537365875c", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/2b15b49e0b86a1d4ce8a1eaa75237a537365875c", "committedDate": "2020-07-14T18:00:17Z", "message": "RW-5166 moving mapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "015aa0792945358529809a03d1f633ae6c9ab204", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/015aa0792945358529809a03d1f633ae6c9ab204", "committedDate": "2020-07-14T18:00:17Z", "message": "RW-5166 cleanup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef32f7a292698419d8004e4209e2f6bb8887547a", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/ef32f7a292698419d8004e4209e2f6bb8887547a", "committedDate": "2020-07-13T22:06:27Z", "message": "RW-5166 cleanup"}, "afterCommit": {"oid": "015aa0792945358529809a03d1f633ae6c9ab204", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/015aa0792945358529809a03d1f633ae6c9ab204", "committedDate": "2020-07-14T18:00:17Z", "message": "RW-5166 cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80ad42a5f302027a232d80722274b671d9fef018", "author": {"user": {"login": "freemabd", "name": "Brian Freeman"}}, "url": "https://github.com/all-of-us/workbench/commit/80ad42a5f302027a232d80722274b671d9fef018", "committedDate": "2020-07-14T20:58:24Z", "message": "RW-5166 fixing test case."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MjQwMjMz", "url": "https://github.com/all-of-us/workbench/pull/3781#pullrequestreview-449240233", "createdAt": "2020-07-15T18:52:05Z", "commit": {"oid": "80ad42a5f302027a232d80722274b671d9fef018"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODo1MjowNlrOGyLfSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODo1MjowNlrOGyLfSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI3MDIxNw==", "bodyText": "Not part of this story, but we should add validation for createRequest to be sure we have cohort/conceptsets and values information in data set Request", "url": "https://github.com/all-of-us/workbench/pull/3781#discussion_r455270217", "createdAt": "2020-07-15T18:52:06Z", "author": {"login": "NehaBroad"}, "path": "api/src/main/java/org/pmiops/workbench/api/DataSetController.java", "diffHunk": "@@ -124,18 +107,14 @@\n   public ResponseEntity<DataSet> createDataSet(\n       String workspaceNamespace, String workspaceFirecloudName, DataSetRequest dataSetRequest) {\n     validateDataSetCreateRequest(dataSetRequest);\n-    final Timestamp now = new Timestamp(clock.instant().toEpochMilli());\n-    workspaceService.getWorkspaceEnforceAccessLevelAndSetCdrVersion(\n-        workspaceNamespace, workspaceFirecloudName, WorkspaceAccessLevel.WRITER);\n     final long workspaceId =\n-        workspaceService.get(workspaceNamespace, workspaceFirecloudName).getWorkspaceId();\n+        workspaceService\n+            .getWorkspaceEnforceAccessLevelAndSetCdrVersion(\n+                workspaceNamespace, workspaceFirecloudName, WorkspaceAccessLevel.WRITER)\n+            .getWorkspaceId();\n     dataSetRequest.setWorkspaceId(workspaceId);\n-    DbDataset datasetToSave = dataSetMapper.dataSetRequestToDb(dataSetRequest, null);\n-    datasetToSave.setCreationTime(now);\n-    datasetToSave.setCreatorId(userProvider.get().getUserId());\n-    datasetToSave.setInvalid(false);\n-    DbDataset savedDataSet = dataSetService.saveDataSet(datasetToSave);\n-    return ResponseEntity.ok(dataSetMapper.dbModelToClient(savedDataSet));\n+    return ResponseEntity.ok(\n+        dataSetService.saveDataSet(dataSetRequest, userProvider.get().getUserId()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80ad42a5f302027a232d80722274b671d9fef018"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MjQxMTQ1", "url": "https://github.com/all-of-us/workbench/pull/3781#pullrequestreview-449241145", "createdAt": "2020-07-15T18:53:21Z", "commit": {"oid": "80ad42a5f302027a232d80722274b671d9fef018"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODo1MzoyMVrOGyLiCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODo1MzoyMVrOGyLiCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI3MDkyMw==", "bodyText": "Should this also be Optional?", "url": "https://github.com/all-of-us/workbench/pull/3781#discussion_r455270923", "createdAt": "2020-07-15T18:53:21Z", "author": {"login": "NehaBroad"}, "path": "api/src/main/java/org/pmiops/workbench/dataset/DataSetService.java", "diffHunk": "@@ -37,11 +44,13 @@ DbDataset cloneDataSetToWorkspace(\n \n   List<DbCohort> getCohortsForDataset(DbDataset dataSet);\n \n-  List<DbDataset> getDataSets(ResourceType resourceType, long resourceId);\n+  List<DataSet> getDataSets(ResourceType resourceType, long resourceId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80ad42a5f302027a232d80722274b671d9fef018"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MjQyNzM4", "url": "https://github.com/all-of-us/workbench/pull/3781#pullrequestreview-449242738", "createdAt": "2020-07-15T18:55:27Z", "commit": {"oid": "80ad42a5f302027a232d80722274b671d9fef018"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODo1NToyN1rOGyLm-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODo1NToyN1rOGyLm-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI3MjE4NA==", "bodyText": "Again we can create another story: But should this throw an exception if no data sets are found for resourceType and Id ?", "url": "https://github.com/all-of-us/workbench/pull/3781#discussion_r455272184", "createdAt": "2020-07-15T18:55:27Z", "author": {"login": "NehaBroad"}, "path": "api/src/main/java/org/pmiops/workbench/dataset/DataSetServiceImpl.java", "diffHunk": "@@ -683,19 +732,18 @@ public DbDataset cloneDataSetToWorkspace(\n   }\n \n   @Override\n-  public void deleteDataSet(DbWorkspace dbWorkspace, Long dataSetId) {\n-    long dbDataSetId = getDbDataSet(dbWorkspace, dataSetId).get().getDataSetId();\n-    dataSetDao.delete(dbDataSetId);\n+  public void deleteDataSet(Long dataSetId) {\n+    dataSetDao.delete(dataSetId);\n   }\n \n   @Override\n-  public Optional<DbDataset> getDbDataSet(DbWorkspace dbWorkspace, Long dataSetId) {\n-    return Optional.of(dataSetDao.findOne(dataSetId));\n+  public Optional<DataSet> getDbDataSet(Long dataSetId) {\n+    return Optional.of(dataSetMapper.dbModelToClient(dataSetDao.findOne(dataSetId)));\n   }\n \n   @Override\n   public void markDirty(ResourceType resourceType, long resourceId) {\n-    List<DbDataset> dbDataSetList = getDataSets(resourceType, resourceId);\n+    List<DbDataset> dbDataSetList = getDbDataSets(resourceType, resourceId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80ad42a5f302027a232d80722274b671d9fef018"}, "originalPosition": 168}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MjQzNzM0", "url": "https://github.com/all-of-us/workbench/pull/3781#pullrequestreview-449243734", "createdAt": "2020-07-15T18:56:48Z", "commit": {"oid": "80ad42a5f302027a232d80722274b671d9fef018"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4458, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}