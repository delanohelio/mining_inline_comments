{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzODkxMTYw", "number": 3009, "title": "[risk=no][RW-3175] (Part 1) Track billing account names being used by workspaces", "bodyText": "Splitting out a small piece of work to prep for the billing lockout stuff. This adds a field to the workspace that tracks the billing account that is currently being used.\nNotes\n\nI used Name instead of Id because that is what Google calls it in their API\nI dropped the BillingAccountType field because we can infer the type by comparing the billing account name field to the environment's free tier account. This will simplify some of our upcoming update billing account code.\n\nTIL\n\nMySQL has a function parse JSON\n\nDescription:\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-01-16T23:13:16Z", "url": "https://github.com/all-of-us/workbench/pull/3009", "merged": true, "mergeCommit": {"oid": "666ab806afe4b7090fa90e0ff0a4ec3467265c8d"}, "closed": true, "closedAt": "2020-01-22T17:39:53Z", "author": {"login": "ericsong"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7CcbFgH2gAyMzYzODkxMTYwOmViZDg2NWU4YTA2ZmI4MGFjNDFiMzhiMGViYzMzNDIzNWQzODFiMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb83nELAFqTM0NjY4Mjk4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ebd865e8a06fb80ac41b38b0ebc334235d381b23", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/ebd865e8a06fb80ac41b38b0ebc334235d381b23", "committedDate": "2020-01-16T23:07:19Z", "message": "add field for billing account name to workspace. drop billing account type in favor of account name comparison"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0Mjk4MjY1", "url": "https://github.com/all-of-us/workbench/pull/3009#pullrequestreview-344298265", "createdAt": "2020-01-17T00:15:39Z", "commit": {"oid": "ebd865e8a06fb80ac41b38b0ebc334235d381b23"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMDoxNTozOVrOFergCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMDoxNTozOVrOFergCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzcxNDMxMw==", "bodyText": "I misunderstood, I thought the proposal was null (free tier) OR user_billing_account_name. I think this would be preferred as it makes the usage of free tier a more explicit, separate state and avoids reencoding the exact free tier billing name for each workspace.", "url": "https://github.com/all-of-us/workbench/pull/3009#discussion_r367714313", "createdAt": "2020-01-17T00:15:39Z", "author": {"login": "calbach"}, "path": "api/db/changelog/db.changelog-116-add-billing-account-to-workspaces.xml", "diffHunk": "@@ -0,0 +1,18 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<databaseChangeLog\n+    xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\n+    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+    xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\n+                    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\n+  <changeSet author=\"ericsong\" id=\"db.changelog-116-add-billing-account-to-workspaces\">\n+    <addColumn tableName=\"workspace\">\n+      <column name=\"billing_account_name\" type=\"varchar(100)\">\n+        <constraints nullable=\"false\"/>\n+      </column>\n+    </addColumn>\n+\n+    <sql>update workspace set billing_account_name=(SELECT JSON_UNQUOTE(JSON_EXTRACT(configuration, '$.billing.accountId')) from config where config_id='main');</sql>\n+\n+    <dropColumn tableName=\"workspace\" columnName=\"billing_account_type\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd865e8a06fb80ac41b38b0ebc334235d381b23"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NTQ5MTcx", "url": "https://github.com/all-of-us/workbench/pull/3009#pullrequestreview-344549171", "createdAt": "2020-01-17T12:34:08Z", "commit": {"oid": "ebd865e8a06fb80ac41b38b0ebc334235d381b23"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMjozNDowOFrOFe3sWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMjozNDowOFrOFe3sWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkxNDA3Mw==", "bodyText": "thinking out loud: Currently, there's no capability or plan for our support to be able to give someone enough free credits to a customer with a billing account to get through a couple of days while they sort out a billing or config issue with Google? I.e. you can only ever get free credits on a free tier account.", "url": "https://github.com/all-of-us/workbench/pull/3009#discussion_r367914073", "createdAt": "2020-01-17T12:34:08Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -62,6 +62,12 @@ public FreeTierBillingService(\n     this.clock = clock;\n   }\n \n+  public boolean isUsingFreeTier(DbWorkspace workspace) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebd865e8a06fb80ac41b38b0ebc334235d381b23"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "390e720f5d20f181280bdf75c7b46317f2213f99", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/390e720f5d20f181280bdf75c7b46317f2213f99", "committedDate": "2020-01-21T22:26:56Z", "message": "Revert \"add field for billing account name to workspace. drop billing account type in favor of account name comparison\"\n\nThis reverts commit ebd865e8a06fb80ac41b38b0ebc334235d381b23."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d34dd213c0bac501ff290bcfb0d7221eba7269c", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/6d34dd213c0bac501ff290bcfb0d7221eba7269c", "committedDate": "2020-01-21T22:29:13Z", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-3175-part-1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dd7001adc1ec4ec7835491f9789c8220cf23ad4", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/2dd7001adc1ec4ec7835491f9789c8220cf23ad4", "committedDate": "2020-01-21T22:33:54Z", "message": "add billing account name column"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NjY5MzYw", "url": "https://github.com/all-of-us/workbench/pull/3009#pullrequestreview-346669360", "createdAt": "2020-01-22T15:20:01Z", "commit": {"oid": "2dd7001adc1ec4ec7835491f9789c8220cf23ad4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NjgxODkz", "url": "https://github.com/all-of-us/workbench/pull/3009#pullrequestreview-346681893", "createdAt": "2020-01-22T15:35:01Z", "commit": {"oid": "2dd7001adc1ec4ec7835491f9789c8220cf23ad4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNTozNTowMVrOFggkGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNTozNTowMVrOFggkGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYzMjI4Mg==", "bodyText": "If you want to be a bit more conservative (e.g. if you think perhaps some config objects might not have what you need), then you can use a temp table to hold {workspaceId, billing_acct} pairs and verify that looks good before committing a new column to the main table. I.e. if we get stuck, it's only this temporary (non-application) table that is in bad shape.\nOf course if you've already vetted the configs interactively, then you're probably OK. Reading this I don't know what happens if JSON_EXTRACT() fails on the last workspace.", "url": "https://github.com/all-of-us/workbench/pull/3009#discussion_r369632282", "createdAt": "2020-01-22T15:35:01Z", "author": {"login": "jaycarlton"}, "path": "api/db/changelog/db.changelog-118-add-billing-account-to-workspaces.xml", "diffHunk": "@@ -0,0 +1,16 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<databaseChangeLog\n+  xmlns=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\"\n+  xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+  xsi:schemaLocation=\"http://www.liquibase.org/xml/ns/dbchangelog/1.9\n+                    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd\">\n+  <changeSet author=\"ericsong\" id=\"db.changelog-118-add-billing-account-to-workspaces\">\n+    <addColumn tableName=\"workspace\">\n+      <column name=\"billing_account_name\" type=\"varchar(100)\">\n+        <constraints nullable=\"false\"/>\n+      </column>\n+    </addColumn>\n+\n+    <sql>update workspace set billing_account_name=(SELECT JSON_UNQUOTE(JSON_EXTRACT(configuration, '$.billing.accountId')) from config where config_id='main');</sql>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dd7001adc1ec4ec7835491f9789c8220cf23ad4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NjgyOTg2", "url": "https://github.com/all-of-us/workbench/pull/3009#pullrequestreview-346682986", "createdAt": "2020-01-22T15:36:22Z", "commit": {"oid": "2dd7001adc1ec4ec7835491f9789c8220cf23ad4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNTozNjoyMlrOFggnZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNTozNzoyOVrOFggp6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYzMzEyNA==", "bodyText": "So this will always be a gcp project id?", "url": "https://github.com/all-of-us/workbench/pull/3009#discussion_r369633124", "createdAt": "2020-01-22T15:36:22Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/db/model/DbWorkspace.java", "diffHunk": "@@ -569,6 +570,15 @@ public void setBillingStatus(BillingStatus billingStatus) {\n     this.billingStatus = DbStorageEnums.billingStatusToStorage(billingStatus);\n   }\n \n+  @Column(name = \"billing_account_name\")\n+  public String getBillingAccountName() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dd7001adc1ec4ec7835491f9789c8220cf23ad4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYzMzc2OQ==", "bodyText": "Re: the mapping between account names and project names, is that something guaranteed by the structure of one or the other name, or something we have to maintain with application code? Do all APIs that have access to change the name get checked against this invariant?", "url": "https://github.com/all-of-us/workbench/pull/3009#discussion_r369633769", "createdAt": "2020-01-22T15:37:29Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/db/model/DbWorkspace.java", "diffHunk": "@@ -569,6 +570,15 @@ public void setBillingStatus(BillingStatus billingStatus) {\n     this.billingStatus = DbStorageEnums.billingStatusToStorage(billingStatus);\n   }\n \n+  @Column(name = \"billing_account_name\")\n+  public String getBillingAccountName() {\n+    return billingAccountName;\n+  }\n+\n+  public void setBillingAccountName(String billingAccountName) {\n+    this.billingAccountName = billingAccountName;\n+  }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2dd7001adc1ec4ec7835491f9789c8220cf23ad4"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3684, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}