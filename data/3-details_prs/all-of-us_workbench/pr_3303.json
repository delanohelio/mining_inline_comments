{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MzI3NzYz", "number": 3303, "title": "[no ticket][risk=no]Find out why waitUntilNoSpinner fails in CircleCI jobs", "bodyText": "Speculative fix and log to prove works: Increase timeout to 90 seconds and capture screenshot if failed.\nReason: circleci jobs experiencing random test failures due to spinner timeout.\nTimeoutError: waiting for function failed: timeout 60000ms exceeded\n\n      165 |     const selectr2 = 'svg[style*=\"spin\"], .spinner:empty';\n      166 |     if (jValue) {\n    > 167 |       await this.page.waitFor((selector) => {\n          |                       ^\n      168 |         return document.querySelectorAll(selector).length === 0\n      169 |       }, {timeout: 60000}, selectr2);\n      170 |     }\n\n      at new WaitTask (node_modules/puppeteer/lib/DOMWorld.js:549:28)\n      at DOMWorld.waitForFunction (node_modules/puppeteer/lib/DOMWorld.js:454:12)\n      at Frame.waitForFunction (node_modules/puppeteer/lib/FrameManager.js:657:28)\n      at Frame.waitFor (node_modules/puppeteer/lib/FrameManager.js:617:19)\n      at Page.waitFor (node_modules/puppeteer/lib/Page.js:1113:29)\n      at HomePage.<anonymous> (app/authenticated-page.ts:167:23)\n      at fulfilled (node_modules/tslib/tslib.js:110:62)", "createdAt": "2020-03-26T17:56:24Z", "url": "https://github.com/all-of-us/workbench/pull/3303", "merged": true, "mergeCommit": {"oid": "a6cbb1af5f16254539858dbd2396e63bbed36e43"}, "closed": true, "closedAt": "2020-03-26T19:49:13Z", "author": {"login": "aweng98"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRewW7AH2gAyMzk0MzI3NzYzOjcxN2U3ZTE3NzRmY2Y3YmZjMjRlZjE3ZTBiMzcwM2ZhOWVhNzdkOTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRhi9lgFqTM4MjM2MDUxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "717e7e1774fcf7bfc24ef17e0b3703fa9ea77d97", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/717e7e1774fcf7bfc24ef17e0b3703fa9ea77d97", "committedDate": "2020-03-26T16:32:46Z", "message": "debug logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "021eadfa7e49fd0f27b89d8e7fa7516d6894afb4", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/021eadfa7e49fd0f27b89d8e7fa7516d6894afb4", "committedDate": "2020-03-26T16:33:33Z", "message": "debug logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "902535d2e998485a1282dfd47a8b9686659d6825", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/902535d2e998485a1282dfd47a8b9686659d6825", "committedDate": "2020-03-26T17:45:33Z", "message": "spinner timeout 90 seconds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7753eac0b6bae03e1d50d03ce6cfee2003bf168b", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/7753eac0b6bae03e1d50d03ce6cfee2003bf168b", "committedDate": "2020-03-26T18:23:14Z", "message": "log time in seconds"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzQ4NDQ3", "url": "https://github.com/all-of-us/workbench/pull/3303#pullrequestreview-382348447", "createdAt": "2020-03-26T19:32:57Z", "commit": {"oid": "7753eac0b6bae03e1d50d03ce6cfee2003bf168b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxOTozMjo1OFrOF8XOCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxOTozMjo1OFrOF8XOCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgzOTMwNg==", "bodyText": "nit: change len to selectorLength", "url": "https://github.com/all-of-us/workbench/pull/3303#discussion_r398839306", "createdAt": "2020-03-26T19:32:58Z", "author": {"login": "NehaBroad"}, "path": "e2e/app/authenticated-page.ts", "diffHunk": "@@ -161,12 +161,28 @@ export default abstract class AuthenticatedPage extends BasePage {\n     }, {timeout: 1000}, selectr1);\n     const jValue = await spinner.jsonValue();\n \n-    // wait maximum 60 seconds for spinner disappear if spinner existed\n+    // wait maximum 90 seconds for spinner disappear if spinner existed\n     const selectr2 = 'svg[style*=\"spin\"], .spinner:empty';\n-    if (jValue) {\n-      await this.page.waitFor((selector) => {\n-        return document.querySelectorAll(selector).length === 0\n-      }, {timeout: 60000}, selectr2);\n+    const startTime = performance.now();\n+    try {\n+      if (jValue) {\n+        await this.page.waitFor((selector) => {\n+          const len = document.querySelectorAll(selector).length;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7753eac0b6bae03e1d50d03ce6cfee2003bf168b"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzQ5MDQw", "url": "https://github.com/all-of-us/workbench/pull/3303#pullrequestreview-382349040", "createdAt": "2020-03-26T19:33:49Z", "commit": {"oid": "7753eac0b6bae03e1d50d03ce6cfee2003bf168b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxOTozMzo0OVrOF8XP1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxOTozMzo0OVrOF8XP1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgzOTc2NA==", "bodyText": "should this be 60 or 90?", "url": "https://github.com/all-of-us/workbench/pull/3303#discussion_r398839764", "createdAt": "2020-03-26T19:33:49Z", "author": {"login": "NehaBroad"}, "path": "e2e/app/authenticated-page.ts", "diffHunk": "@@ -161,12 +161,28 @@ export default abstract class AuthenticatedPage extends BasePage {\n     }, {timeout: 1000}, selectr1);\n     const jValue = await spinner.jsonValue();\n \n-    // wait maximum 60 seconds for spinner disappear if spinner existed\n+    // wait maximum 90 seconds for spinner disappear if spinner existed\n     const selectr2 = 'svg[style*=\"spin\"], .spinner:empty';\n-    if (jValue) {\n-      await this.page.waitFor((selector) => {\n-        return document.querySelectorAll(selector).length === 0\n-      }, {timeout: 60000}, selectr2);\n+    const startTime = performance.now();\n+    try {\n+      if (jValue) {\n+        await this.page.waitFor((selector) => {\n+          const len = document.querySelectorAll(selector).length;\n+          return len === 0\n+        }, {timeout: 90000}, selectr2);\n+      }\n+    } catch (err) {\n+      await this.takeScreenshot('TimedOutWaitForSpinnerStop');\n+      throw err;\n+    } finally {\n+      const finishTime = performance.now();\n+      const diff = Math.floor(((finishTime - startTime) / 1000) % 60);\n+      if (diff > 60) {\n+        // if timeout exceeds 60 seconds without error thrown, it shows page loading is slow", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7753eac0b6bae03e1d50d03ce6cfee2003bf168b"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5de0ea76ce1a8f9244dfd5f409ef60f3b0314e2", "author": {"user": {"login": "aweng98", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/a5de0ea76ce1a8f9244dfd5f409ef60f3b0314e2", "committedDate": "2020-03-26T19:40:59Z", "message": "PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzYwNTE4", "url": "https://github.com/all-of-us/workbench/pull/3303#pullrequestreview-382360518", "createdAt": "2020-03-26T19:47:51Z", "commit": {"oid": "a5de0ea76ce1a8f9244dfd5f409ef60f3b0314e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3295, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}