{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwMjkyOTE1", "number": 3188, "title": "[RW-4462][risk=low] Add GCS traffic and hook up delete-cluster button to WS admin page.", "bodyText": "The main addition in this PR is to pipe cloud storage metrics into our Workspace admin page. I also made a handful of drive-by changes to the styling, and hooked up the button to delete a cluster. This gets us 95% of the way there to be able to respond quickly to an egress event. (The remaining piece is probably to change the routing to create a per-workspace page.)\nI manually tested a full cluster deletion cycle:\n\nOpen a second tab with a notebook running, copying a large file to the bucket.\nRefresh the ws-admin page, see the spike in GCS traffic.\n(In the real-world, that signal would indicate that we should not shut down the cluster.)\nTo test the delete-cluster, I clicked \"Delete\" on the active cluster.\nMy notebook in the other tab stopped working after around ~10 seconds.\n\nScreenshots:\n\n\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally", "createdAt": "2020-02-26T14:10:46Z", "url": "https://github.com/all-of-us/workbench/pull/3188", "merged": true, "mergeCommit": {"oid": "e2bdb93c92020df0e4ce103154e430a261f92f03"}, "closed": true, "closedAt": "2020-02-27T15:48:31Z", "author": {"login": "gjuggler"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcII3c0gFqTM2NDk3MjE2Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIc8SUAFqTM2NTc1MTI0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0OTcyMTYy", "url": "https://github.com/all-of-us/workbench/pull/3188#pullrequestreview-364972162", "createdAt": "2020-02-26T15:02:39Z", "commit": {"oid": "47fe5de63c5626e7d93071e6d516dcb73f9966f1"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTowMjozOVrOFuvBsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTo1NTozOVrOFuxUPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0OTI5Nw==", "bodyText": "This header is going to show up even if we haven't searched a project. When I wrote this page I deliberately made sure it wouldn't. Not the biggest deal for an internal page though.", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384549297", "createdAt": "2020-02-26T15:02:39Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -130,23 +199,14 @@ export class AdminWorkspace extends React.Component<{}, State> {\n           Search\n         </Button>\n       </FlexRow>\n-      {\n-        workspace && <FlexColumn>\n-          <h3>Workspace Admin Actions</h3>\n-          <FlexRow style={{justifyContent: 'space-between'}}>\n-            <Button>Shut down all VMs</Button>\n-            <Button>Disable workspace</Button>\n-            <Button>Disable all collaborators</Button>\n-            <Button>Exclude from public directory</Button>\n-            <Button>Log administrative comment</Button>\n-            <Button>Publish workspace</Button>\n-          </FlexRow>\n-        </FlexColumn>\n-      }\n-      {workspace && resources.workspaceObjects && resources.cloudStorage && collaborators &&\n-        <FlexRow>\n-          <FlexColumn style={styles.wideWithMargin}>\n-            <h3>Basic Information</h3>\n+\n+      {loadingData && <SpinnerOverlay />}\n+\n+      <h2>Workspace</h2>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47fe5de63c5626e7d93071e6d516dcb73f9966f1"}, "originalPosition": 242}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3NTM1OA==", "bodyText": "Why six hours specifically?", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384575358", "createdAt": "2020-02-26T15:39:52Z", "author": {"login": "als364"}, "path": "api/src/main/java/org/pmiops/workbench/workspaceadmin/WorkspaceAdminController.java", "diffHunk": "@@ -26,6 +35,10 @@\n \n @RestController\n public class WorkspaceAdminController implements WorkspaceAdminApiDelegate {\n+\n+  private static final Duration TRAILING_TIME_TO_QUERY = Duration.ofHours(6);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47fe5de63c5626e7d93071e6d516dcb73f9966f1"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3NTUxMA==", "bodyText": "Extraneous (unless you meant to put javadoc and forgot)", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384575510", "createdAt": "2020-02-26T15:40:06Z", "author": {"login": "als364"}, "path": "api/src/main/java/org/pmiops/workbench/workspaceadmin/WorkspaceAdminController.java", "diffHunk": "@@ -34,18 +47,43 @@\n \n   @Autowired\n   public WorkspaceAdminController(\n+      CloudMonitoringService cloudMonitoringService,\n       FireCloudService fireCloudService,\n       LeonardoNotebooksClient leonardoNotebooksClient,\n       WorkspaceAdminService workspaceAdminService,\n       WorkspaceMapper workspaceMapper,\n       WorkspaceService workspaceService) {\n+    this.cloudMonitoringService = cloudMonitoringService;\n     this.fireCloudService = fireCloudService;\n     this.leonardoNotebooksClient = leonardoNotebooksClient;\n     this.workspaceAdminService = workspaceAdminService;\n     this.workspaceMapper = workspaceMapper;\n     this.workspaceService = workspaceService;\n   }\n \n+  /** */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47fe5de63c5626e7d93071e6d516dcb73f9966f1"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU3ODcyMg==", "bodyText": "At least one of these could probably done as a stream instead of an old-school foreach loop. Though I do vaguely recall nested streams being obnoxious to deal with.", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384578722", "createdAt": "2020-02-26T15:44:32Z", "author": {"login": "als364"}, "path": "api/src/main/java/org/pmiops/workbench/workspaceadmin/WorkspaceAdminController.java", "diffHunk": "@@ -34,18 +47,43 @@\n \n   @Autowired\n   public WorkspaceAdminController(\n+      CloudMonitoringService cloudMonitoringService,\n       FireCloudService fireCloudService,\n       LeonardoNotebooksClient leonardoNotebooksClient,\n       WorkspaceAdminService workspaceAdminService,\n       WorkspaceMapper workspaceMapper,\n       WorkspaceService workspaceService) {\n+    this.cloudMonitoringService = cloudMonitoringService;\n     this.fireCloudService = fireCloudService;\n     this.leonardoNotebooksClient = leonardoNotebooksClient;\n     this.workspaceAdminService = workspaceAdminService;\n     this.workspaceMapper = workspaceMapper;\n     this.workspaceService = workspaceService;\n   }\n \n+  /** */\n+  @Override\n+  @AuthorityRequired({Authority.WORKSPACES_VIEW})\n+  public ResponseEntity<CloudStorageTraffic> getCloudStorageTraffic(String workspaceNamespace) {\n+    CloudStorageTraffic response = new CloudStorageTraffic().receivedBytes(new ArrayList<>());\n+\n+    for (TimeSeries timeSeries :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47fe5de63c5626e7d93071e6d516dcb73f9966f1"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4MTE3OA==", "bodyText": "oh god is this really how spotless wants it", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384581178", "createdAt": "2020-02-26T15:47:54Z", "author": {"login": "als364"}, "path": "api/src/test/java/org/pmiops/workbench/workspaceadmin/WorkspaceAdminControllerTest.java", "diffHunk": "@@ -157,6 +158,31 @@ public void getFederatedWorkspaceDetails_404sWhenNotFound() {\n     assertThat(response.getStatusCodeValue()).isEqualTo(404);\n   }\n \n+  @Test\n+  public void getCloudStorageTraffic_sortsPointsByTimestamp() {\n+    TimeSeries timeSeries =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47fe5de63c5626e7d93071e6d516dcb73f9966f1"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4MTQ0MQ==", "bodyText": "If it is, could you at least put a full blank line between statements for readability", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384581441", "createdAt": "2020-02-26T15:48:21Z", "author": {"login": "als364"}, "path": "api/src/test/java/org/pmiops/workbench/workspaceadmin/WorkspaceAdminControllerTest.java", "diffHunk": "@@ -157,6 +158,31 @@ public void getFederatedWorkspaceDetails_404sWhenNotFound() {\n     assertThat(response.getStatusCodeValue()).isEqualTo(404);\n   }\n \n+  @Test\n+  public void getCloudStorageTraffic_sortsPointsByTimestamp() {\n+    TimeSeries timeSeries =", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4MTE3OA=="}, "originalCommit": {"oid": "47fe5de63c5626e7d93071e6d516dcb73f9966f1"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4NDY3Ng==", "bodyText": "This should also be disabled if the person doesn't have the authority to delete clusters (SECURITY_ADMIN).", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384584676", "createdAt": "2020-02-26T15:52:52Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -267,17 +335,39 @@ export class AdminWorkspace extends React.Component<{}, State> {\n             <PurpleLabel style={styles.narrowWithMargin}>Status</PurpleLabel>\n           </FlexRow>\n           {resources.clusters.map((cluster, i) =>\n-              <FlexRow>\n+              <FlexRow key={i}>\n                 <div style={styles.narrowWithMargin}>{cluster.clusterName}</div>\n                 <div style={styles.narrowWithMargin}>{cluster.googleProject}</div>\n                 <div style={styles.narrowWithMargin}>{new Date(cluster.createdDate).toDateString()}</div>\n                 <div style={styles.narrowWithMargin}>{new Date(cluster.dateAccessed).toDateString()}</div>\n                 <div style={styles.narrowWithMargin}>{cluster.status}</div>\n-                <Button>Disable</Button>\n+                <Button onClick={() =>\n+                  this.setState({clusterToDelete: cluster, confirmDeleteCluster: true})}\n+                  disabled={clusterToDelete && clusterToDelete.clusterName === cluster.clusterName}>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47fe5de63c5626e7d93071e6d516dcb73f9966f1"}, "originalPosition": 378}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4NjgxNA==", "bodyText": "If one of these 503s, this function will short circuit and we will get an infinite spinner. Again as it's an internal page it's not that big a deal, but it could be nice to have it say 'oops it 503'd' instead of just spinning forever when you're looking at it at 3am.", "url": "https://github.com/all-of-us/workbench/pull/3188#discussion_r384586814", "createdAt": "2020-02-26T15:55:39Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/admin/admin-workspace.tsx", "diffHunk": "@@ -56,22 +54,24 @@ export class AdminWorkspace extends React.Component<{}, State> {\n \n     this.state = {\n       googleProject: '',\n-      workspace: null,\n-      collaborators: [],\n-      resources: {},\n+      workspaceDetails: {},\n+      cloudStorageTraffic: null,\n     };\n   }\n \n-  getFederatedWorkspaceInformation() {\n-    workspaceAdminApi().getFederatedWorkspaceDetails(this.state.googleProject).then(\n-      response => {\n-        this.setState({\n-          workspace: response.workspace,\n-          collaborators: response.collaborators,\n-          resources: response.resources\n-        });\n-      }\n-    );\n+  async getFederatedWorkspaceInformation() {\n+    this.setState({\n+      loadingData: true,\n+    });\n+\n+    // Fire off both requests in parallel\n+    const workspaceDetailsPromise = workspaceAdminApi().getFederatedWorkspaceDetails(this.state.googleProject);\n+    const cloudStorageTrafficPromise = workspaceAdminApi().getCloudStorageTraffic(this.state.googleProject);\n+    // Wait for both promises to complete before updating state.\n+    const workspaceDetails = await workspaceDetailsPromise;\n+    const cloudStorageTraffic = await cloudStorageTrafficPromise;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47fe5de63c5626e7d93071e6d516dcb73f9966f1"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28bbdccefaa5d32ab3aa39a8cc8e206a3e7662e1", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/28bbdccefaa5d32ab3aa39a8cc8e206a3e7662e1", "committedDate": "2020-02-27T03:30:50Z", "message": "WS admin page: add GCS traffic graph and support for deleting a cluster."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e59c689cfcc6a6aa18cdc68bdce0a7452338a45", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/7e59c689cfcc6a6aa18cdc68bdce0a7452338a45", "committedDate": "2020-02-27T03:30:50Z", "message": "Move GCS query duration into the service method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c4ec30c9d7881f74ab7cb799dc10f5486e4cbbc", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/9c4ec30c9d7881f74ab7cb799dc10f5486e4cbbc", "committedDate": "2020-02-27T03:30:50Z", "message": "A couple more fixes found during self-review."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd70bdb3f55ab0bd8d592e3ca697c68bc92af4f0", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/bd70bdb3f55ab0bd8d592e3ca697c68bc92af4f0", "committedDate": "2020-02-27T03:30:50Z", "message": "More tweaks from self-review."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e9974bda8bb09c214fa4d1a2dc3d23e83b309ce", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/9e9974bda8bb09c214fa4d1a2dc3d23e83b309ce", "committedDate": "2020-02-27T03:30:51Z", "message": "PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b6ad31b4508c435247da710957806385a772bc6", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/0b6ad31b4508c435247da710957806385a772bc6", "committedDate": "2020-02-27T03:50:22Z", "message": "Post-rebase fixes."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2eaefa334e27ab2628b4676251acb6574d39c78", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/d2eaefa334e27ab2628b4676251acb6574d39c78", "committedDate": "2020-02-27T03:27:10Z", "message": "PR feedback"}, "afterCommit": {"oid": "0b6ad31b4508c435247da710957806385a772bc6", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/0b6ad31b4508c435247da710957806385a772bc6", "committedDate": "2020-02-27T03:50:22Z", "message": "Post-rebase fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab96aa60a63d6d805423f19f72c1b2ef86b0bbc4", "author": {"user": {"login": "gjuggler", "name": "Greg Jordan"}}, "url": "https://github.com/all-of-us/workbench/commit/ab96aa60a63d6d805423f19f72c1b2ef86b0bbc4", "committedDate": "2020-02-27T14:43:07Z", "message": "Small build fix."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NzUxMjQ4", "url": "https://github.com/all-of-us/workbench/pull/3188#pullrequestreview-365751248", "createdAt": "2020-02-27T15:20:40Z", "commit": {"oid": "0b6ad31b4508c435247da710957806385a772bc6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3382, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}