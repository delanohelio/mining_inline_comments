{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2NTk2OTkz", "number": 3035, "title": "[RW-3175][risk=low] User provided billing accounts", "bodyText": "I may have gone a little overboard in exception checking but I wanted to make it highly unlikely for a user to unknowingly have their billing account associated with a dead billing project in the case of failed calls.\nNote - this PR does not include the ability to switch a workspace back to the free tier. That will come in a follow up.\nTIL\n\n\nWe are able to use the User client's credentials from the backend. This is done by grabbing their OAuth tokens from the request headers and creating new API clients that use it. We typically set this up through Spring dependency injection\n\n\ndoAnswer(invocation -> ()) is a powerful way to mock external dependencies. I use this for the Cloudbilling client to emulate API calls with dynamic responses.\n\n\nit is possible to verify multiples calls to Mockito mocks as well the arguments passed into each call using ArgumentCaptor\n\n\n**@SpyBean annotation can be used to wrap an autowired dependency with a Mockito spy. This is super useful is verifying calls or overriding behavior of classes that are difficult to mock like the Daos.\n\n\nmodules imported into UI tests can be mocked using jest\n\n\nusing a new API from a React component will typically involve adding a Stub into its test file\n\n\nsetting the property on a nested state object will require a speial setter function. We leverage fp.set() to do this\n\n\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-01-23T22:24:34Z", "url": "https://github.com/all-of-us/workbench/pull/3035", "merged": true, "mergeCommit": {"oid": "26ba799ec7325cf53550f05a3805baaafa22903e"}, "closed": true, "closedAt": "2020-01-28T17:29:21Z", "author": {"login": "ericsong"}, "timelineItems": {"totalCount": 59, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6B38kgH2gAyMzY2NTk2OTkzOjRlNzc4YzdkYTczNDlkNjg2MGRlOTEyMzc1ZDQ3MzMzZGFhODZmMzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-z-70AH2gAyMzY2NTk2OTkzOjBhMzIzOTc4NzQzNDA1ZDNjYzQwZWIzMTlhYjAyZjJmMWE2NGNjNjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4e778c7da7349d6860de912375d47333daa86f31", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/4e778c7da7349d6860de912375d47333daa86f31", "committedDate": "2020-01-13T19:53:33Z", "message": "WIP: can make billing list call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fdf233bc4475e01fed6b79fd7c30ff05408631f", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/0fdf233bc4475e01fed6b79fd7c30ff05408631f", "committedDate": "2020-01-14T21:34:12Z", "message": "WIP: add dropdown and text"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39660aec7e8e7c37dd9ebbffecb4761f867938ff", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/39660aec7e8e7c37dd9ebbffecb4761f867938ff", "committedDate": "2020-01-14T22:27:09Z", "message": "WIP - dynamically load billing accounts in dropdown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56a37d1dd3201a86e9a87b8837cae1bbb9d025b9", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/56a37d1dd3201a86e9a87b8837cae1bbb9d025b9", "committedDate": "2020-01-15T17:18:22Z", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-3175"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a8217338f17dce46a36d3b6f5caa7b986613a5f", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/6a8217338f17dce46a36d3b6f5caa7b986613a5f", "committedDate": "2020-01-15T20:10:04Z", "message": "fix compilation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "653bed1a58bdfb713c6dedaf16967b8f45622f1a", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/653bed1a58bdfb713c6dedaf16967b8f45622f1a", "committedDate": "2020-01-16T19:37:14Z", "message": "make list billing accounts call from backend"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9e5ba9448bb7cef069fee6ff375b2a514c686d6", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/b9e5ba9448bb7cef069fee6ff375b2a514c686d6", "committedDate": "2020-01-16T19:44:46Z", "message": "add billingAccount to WS api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e7bf93bf11313ba7b5277b02b0997d1e365ea3c", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/7e7bf93bf11313ba7b5277b02b0997d1e365ea3c", "committedDate": "2020-01-16T19:51:05Z", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-3175"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a563de70458e0b3ccd7ddfa01a0fb46b439307c1", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/a563de70458e0b3ccd7ddfa01a0fb46b439307c1", "committedDate": "2020-01-16T23:23:09Z", "message": "add field for billing account name to workspace. drop billing account type in favor of account name comparison"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43362f362a5fc89b75a77045ed3ec3dd8eda25bc", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/43362f362a5fc89b75a77045ed3ec3dd8eda25bc", "committedDate": "2020-01-16T23:44:21Z", "message": "send billing account to front end and pick correct one in dropdown"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee2bc4ea34d11959af6f4dfdc60a914c6efec366", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/ee2bc4ea34d11959af6f4dfdc60a914c6efec366", "committedDate": "2020-01-17T17:56:16Z", "message": "can select billing account in UI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3444331744ffe2c9a7866c09ff2ec8350ccf2085", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/3444331744ffe2c9a7866c09ff2ec8350ccf2085", "committedDate": "2020-01-17T18:17:06Z", "message": "add front end validation for billing account"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0575c9194b2749e09b58c76d4cda8a05ed7d8e36", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/0575c9194b2749e09b58c76d4cda8a05ed7d8e36", "committedDate": "2020-01-17T23:01:13Z", "message": "grant ownership to user on billing project"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d96a92106467bf59305b4e36507e7f13cb2ccba", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/7d96a92106467bf59305b4e36507e7f13cb2ccba", "committedDate": "2020-01-22T18:21:21Z", "message": "merging - WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b715a2263985280c7539b71b2b14f5c376a29f15", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/b715a2263985280c7539b71b2b14f5c376a29f15", "committedDate": "2020-01-23T01:11:28Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eab84bb8334be6d7700344e7fb7d579eba8c3001", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/eab84bb8334be6d7700344e7fb7d579eba8c3001", "committedDate": "2020-01-23T05:14:35Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2587e5ad3f3b78740c7ea870af9c3b2b316c63b", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/c2587e5ad3f3b78740c7ea870af9c3b2b316c63b", "committedDate": "2020-01-23T06:19:15Z", "message": "super cool spy test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c332e05615c7fd771c120d1fbfc05a6c9cfac3cb", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/c332e05615c7fd771c120d1fbfc05a6c9cfac3cb", "committedDate": "2020-01-23T06:53:18Z", "message": "add remaining tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3910cfdb967f889bbbfd82667abe5f4ccdc8630a", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/3910cfdb967f889bbbfd82667abe5f4ccdc8630a", "committedDate": "2020-01-23T15:55:46Z", "message": "Merge branch 'master' of github.com:all-of-us/workbench into songe/RW-3175"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e80365d8ce3d1098adbf61342e5a15a0378470c", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/5e80365d8ce3d1098adbf61342e5a15a0378470c", "committedDate": "2020-01-23T16:11:42Z", "message": "restore billing account name code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b391b9b7c8345dce04463f275a498f439d34c574", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/b391b9b7c8345dce04463f275a498f439d34c574", "committedDate": "2020-01-23T16:36:48Z", "message": "actually execute update call. works manually"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dfdf81829745ba862240220b01a4620c0f539b6", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/6dfdf81829745ba862240220b01a4620c0f539b6", "committedDate": "2020-01-23T18:54:52Z", "message": "grab billing info on workspace edit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70c0c086df427750ec753025f57dd1791af12552", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/70c0c086df427750ec753025f57dd1791af12552", "committedDate": "2020-01-23T18:58:49Z", "message": "fix changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec1e0379fe0302f83ec370fbda5cd21a81501d1a", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/ec1e0379fe0302f83ec370fbda5cd21a81501d1a", "committedDate": "2020-01-23T20:06:05Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1b20fd06b9f92cf76b44d4b39a1f9910c3dd505", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/c1b20fd06b9f92cf76b44d4b39a1f9910c3dd505", "committedDate": "2020-01-23T20:48:30Z", "message": "fix UI tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8843dfe70d7eba04ef7f8c6914f2803c01ef81d8", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/8843dfe70d7eba04ef7f8c6914f2803c01ef81d8", "committedDate": "2020-01-23T22:10:15Z", "message": "add feature flag gating"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbd0076675d2bf7537d19ddf07fb61b587237622", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/fbd0076675d2bf7537d19ddf07fb61b587237622", "committedDate": "2020-01-23T22:12:18Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba8bdcbd48aaf4ef94a3d1c3c51bce34ce6e0076", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/ba8bdcbd48aaf4ef94a3d1c3c51bce34ce6e0076", "committedDate": "2020-01-23T22:15:04Z", "message": "ui lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da5eef924a76605fe19c8e6164e0b79107a73849", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/da5eef924a76605fe19c8e6164e0b79107a73849", "committedDate": "2020-01-23T22:42:01Z", "message": "fix cloud api bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2fea88084d43f33c7cd8e2259b0819985d91f58", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/f2fea88084d43f33c7cd8e2259b0819985d91f58", "committedDate": "2020-01-23T22:42:20Z", "message": "prefix free tier back fill with billingAccounts/"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "837ed2b37dacebfcdbaa6f38b67bd9df07d2db8b", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/837ed2b37dacebfcdbaa6f38b67bd9df07d2db8b", "committedDate": "2020-01-23T23:30:44Z", "message": "fix prefix bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33d3adfbe6b096f1fce685a61708bc84f193c648", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/33d3adfbe6b096f1fce685a61708bc84f193c648", "committedDate": "2020-01-23T23:42:19Z", "message": "fix api tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cb2af41abfed0cac03ce02e03ad780548f3c40d", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/5cb2af41abfed0cac03ce02e03ad780548f3c40d", "committedDate": "2020-01-23T23:59:13Z", "message": "fix UI tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f5017fb481a7d45ccebf79f5098b4cc4648ce1f", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/2f5017fb481a7d45ccebf79f5098b4cc4648ce1f", "committedDate": "2020-01-24T00:20:58Z", "message": "add retryer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fa89be9613c68f122e39e246458262a46ee9eff", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/2fa89be9613c68f122e39e246458262a46ee9eff", "committedDate": "2020-01-24T00:25:09Z", "message": "comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c9b03b3234059dcbbeace44d1ee59ba561c312b", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/1c9b03b3234059dcbbeace44d1ee59ba561c312b", "committedDate": "2020-01-24T00:25:41Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22bf17fde17485df992c4066f2028a3ac9850db7", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/22bf17fde17485df992c4066f2028a3ac9850db7", "committedDate": "2020-01-24T05:06:12Z", "message": "ui touch ups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/bcb09156164e0a8fa4adc098e4f3e07a4249c878", "committedDate": "2020-01-24T05:37:03Z", "message": "reset config local"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4Mjk0NTQ2", "url": "https://github.com/all-of-us/workbench/pull/3035#pullrequestreview-348294546", "createdAt": "2020-01-25T00:45:28Z", "commit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNVQwMDo0NToyOVrOFht13g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNVQwMTowNDozMFrOFhuALg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5ODM5OA==", "bodyText": "Can a bean provider not just throw an exception? i.e. add throws to the method signature for this? That seems more natural than rethrowing a runtime exception.\nIf you can't do this for some reason, then please at least include the exception here, as it stands the original exception is swallowed here", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r370898398", "createdAt": "2020-01-25T00:45:29Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/billing/GoogleApisConfig.java", "diffHunk": "@@ -0,0 +1,42 @@\n+package org.pmiops.workbench.billing;\n+\n+import com.google.api.client.googleapis.auth.oauth2.GoogleCredential;\n+import com.google.api.client.googleapis.javanet.GoogleNetHttpTransport;\n+import com.google.api.client.json.JsonFactory;\n+import com.google.api.services.cloudbilling.Cloudbilling;\n+import java.io.IOException;\n+import java.security.GeneralSecurityException;\n+import java.util.Collections;\n+import javax.inject.Provider;\n+import org.pmiops.workbench.auth.UserAuthentication;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.ScopedProxyMode;\n+import org.springframework.web.context.annotation.RequestScope;\n+\n+@Configuration\n+public class GoogleApisConfig {\n+\n+  @Bean\n+  @RequestScope(proxyMode = ScopedProxyMode.DEFAULT)\n+  public Cloudbilling googleCloudBillingApi(\n+      UserAuthentication userAuthentication,\n+      JsonFactory jsonFactory,\n+      Provider<WorkbenchConfig> workbenchConfigProvider) {\n+    GoogleCredential credential =\n+        new GoogleCredential()\n+            .setAccessToken(userAuthentication.getCredentials())\n+            .createScoped(\n+                Collections.singletonList(\"https://www.googleapis.com/auth/cloud-platform\"));\n+\n+    try {\n+      return new Cloudbilling.Builder(\n+              GoogleNetHttpTransport.newTrustedTransport(), jsonFactory, credential)\n+          .setApplicationName(workbenchConfigProvider.get().server.projectId)\n+          .build();\n+    } catch (GeneralSecurityException | IOException e) {\n+      throw new RuntimeException(\"Could not construct Cloudbilling API client\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5ODY3Nw==", "bodyText": "I would add a log.severe() here; we will want to pay attention if this happens, since this call might fail as well.", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r370898677", "createdAt": "2020-01-25T00:47:14Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -244,12 +252,76 @@ private FirecloudWorkspace attemptFirecloudWorkspaceCreation(FirecloudWorkspaceI\n \n     dbWorkspace.setBillingMigrationStatusEnum(BillingMigrationStatus.NEW);\n \n-    dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n+    updateWorkspaceBillingAccount(dbWorkspace, workspace.getBillingAccountName());\n+\n+    try {\n+      dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n+    } catch (Exception e) {\n+      // Tell Google to set the billing account back to the free tier if the workspace creation\n+      // fails\n+      updateWorkspaceBillingAccount(dbWorkspace, workbenchConfigProvider.get().billing.accountId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5ODg4Nw==", "bodyText": "Perhaps instead just update the billing account after you save the workspace. that way it is already on free tier if either step fails", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r370898887", "createdAt": "2020-01-25T00:48:41Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -244,12 +252,76 @@ private FirecloudWorkspace attemptFirecloudWorkspaceCreation(FirecloudWorkspaceI\n \n     dbWorkspace.setBillingMigrationStatusEnum(BillingMigrationStatus.NEW);\n \n-    dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n+    updateWorkspaceBillingAccount(dbWorkspace, workspace.getBillingAccountName());\n+\n+    try {\n+      dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n+    } catch (Exception e) {\n+      // Tell Google to set the billing account back to the free tier if the workspace creation", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5OTIxMg==", "bodyText": "Please use something with jitter and/or backoff, fixed wait is not very graceful.", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r370899212", "createdAt": "2020-01-25T00:50:58Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -244,12 +252,76 @@ private FirecloudWorkspace attemptFirecloudWorkspaceCreation(FirecloudWorkspaceI\n \n     dbWorkspace.setBillingMigrationStatusEnum(BillingMigrationStatus.NEW);\n \n-    dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n+    updateWorkspaceBillingAccount(dbWorkspace, workspace.getBillingAccountName());\n+\n+    try {\n+      dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n+    } catch (Exception e) {\n+      // Tell Google to set the billing account back to the free tier if the workspace creation\n+      // fails\n+      updateWorkspaceBillingAccount(dbWorkspace, workbenchConfigProvider.get().billing.accountId);\n+      throw e;\n+    }\n+\n     Workspace createdWorkspace = WorkspaceConversionUtils.toApiWorkspace(dbWorkspace, fcWorkspace);\n     workspaceAuditor.fireCreateAction(createdWorkspace, dbWorkspace.getWorkspaceId());\n     return ResponseEntity.ok(createdWorkspace);\n   }\n \n+  private Retryer<ProjectBillingInfo> cloudBillingRetryer =\n+      RetryerBuilder.<ProjectBillingInfo>newBuilder()\n+          .retryIfException(\n+              e ->\n+                  e instanceof GoogleJsonResponseException\n+                      && ((GoogleJsonResponseException) e).getStatusCode() == 403)\n+          .withWaitStrategy(WaitStrategies.fixedWait(5, TimeUnit.SECONDS))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5OTQzOQ==", "bodyText": "fix here and below", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r370899439", "createdAt": "2020-01-25T00:52:48Z", "author": {"login": "calbach"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -536,6 +536,18 @@ paths:\n           type: string\n           required: false\n \n+  /v1/user/billingAccounts:\n+    get:\n+      tags:\n+        - user\n+      description: Placeholder", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkwMDUxOQ==", "bodyText": "Some cases to make sure are handled here:\n\nThe user is an editor (not an owner). We expect this call to 403.\nThe user is an owner, but doesn't have access to the billing account (i.e. the workspace billing account is not present in the dropdown).", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r370900519", "createdAt": "2020-01-25T01:00:46Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -450,6 +465,22 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n         // workspace which references a non-default, non-archived CDR version.\n         this.setState(fp.set(['workspace', 'cdrVersionId'], cdrResp.defaultCdrVersionId));\n       }\n+\n+      if (serverConfigStore.getValue().enableBillingLockout) {\n+        userApi().listBillingAccounts().then(response =>\n+          this.setState({billingAccounts: response.billingAccounts})\n+        );\n+\n+        if (this.isMode(WorkspaceEditMode.Edit)) {\n+          getBillingAccountName(this.props.workspace.namespace).then(billingAccountName =>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkwMDc1Ng==", "bodyText": "This seems slightly overfit to me. I'd probably have it return the full JSON response structure, then have the client pick out billingAccountName", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r370900756", "createdAt": "2020-01-25T01:02:32Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/workbench-gapi-client.ts", "diffHunk": "@@ -0,0 +1,13 @@\n+declare const gapi: any;\n+\n+export async function getBillingAccountName(workspaceNamespace: string) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkwMTAzOA==", "bodyText": "Noting we'll need to keep this in sync with the actual value. Probably fine for now", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r370901038", "createdAt": "2020-01-25T01:04:30Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -201,6 +209,10 @@ export const specificPopulations = [\n   }\n ];\n \n+const billingDescription = <div>The <i>All of Us</i> Program provides $200 in free credits per user.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "934a6ee3abe8da8e549b68299a5f3d19e17fa094", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/934a6ee3abe8da8e549b68299a5f3d19e17fa094", "committedDate": "2020-01-27T17:29:05Z", "message": "graceful retry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8eb3ace35ed296c59eba4465dd566addf22dad76", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/8eb3ace35ed296c59eba4465dd566addf22dad76", "committedDate": "2020-01-27T17:29:32Z", "message": "dynamic free tier limit in description. return larger json object"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f93dcb8d90c6ea23e582d9c9dc7e0b77057443d5", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/f93dcb8d90c6ea23e582d9c9dc7e0b77057443d5", "committedDate": "2020-01-27T19:23:27Z", "message": "handle reader/writer case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08aca38d590ef474fb85c2baffe70982707d7edb", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/08aca38d590ef474fb85c2baffe70982707d7edb", "committedDate": "2020-01-27T19:28:15Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6555c350215a9ee0544103e53380b9b5f47fe10c", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/6555c350215a9ee0544103e53380b9b5f47fe10c", "committedDate": "2020-01-27T19:28:53Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d72bbf1159be2496eb401496b522f165a8e52f5", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/6d72bbf1159be2496eb401496b522f165a8e52f5", "committedDate": "2020-01-27T19:36:06Z", "message": "add logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81292378acdc7b9851d40c1dbe714703df2c0692", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/81292378acdc7b9851d40c1dbe714703df2c0692", "committedDate": "2020-01-27T19:36:47Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e21e64dfc8ccae06b61f997c10ed7a5788ad1825", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/e21e64dfc8ccae06b61f997c10ed7a5788ad1825", "committedDate": "2020-01-27T19:45:58Z", "message": "merge master"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4ODA3NTQ3", "url": "https://github.com/all-of-us/workbench/pull/3035#pullrequestreview-348807547", "createdAt": "2020-01-27T16:39:20Z", "commit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNjozOToyMFrOFiJc0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxOToyMDozOFrOFiOcxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM1MDczNw==", "bodyText": "If I am saving the workspace with the updates billing account, I believe I still need to make a try/catch call to update the db if the Google call fails.\nProposed\n\nsave db w/ new billing account (succeeds)\ncall google (fails)\nsave db w/ old billing account to keep state in sync OR delete the workspace b/c the create call didn't fully complete successfully.\n\nCurrent\n\ncall google w/ new billing account (succeeds)\nsave db (fails)\ncall google w/ old billing account to keep state in sync\n\nMy reasoning for going with the current workflow was that I felt like a db save call is less likely to fail than an API call. There's also the effect of having a partially successful workspace entry in our database. I could see a case for not failing the entire call if the updateBillingInfo call fails since the entire call is quite expensive but I view that more of a feature add on that we can talk to product about.", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371350737", "createdAt": "2020-01-27T16:39:20Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -244,12 +252,76 @@ private FirecloudWorkspace attemptFirecloudWorkspaceCreation(FirecloudWorkspaceI\n \n     dbWorkspace.setBillingMigrationStatusEnum(BillingMigrationStatus.NEW);\n \n-    dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n+    updateWorkspaceBillingAccount(dbWorkspace, workspace.getBillingAccountName());\n+\n+    try {\n+      dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n+    } catch (Exception e) {\n+      // Tell Google to set the billing account back to the free tier if the workspace creation", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5ODg4Nw=="}, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2NDE1OQ==", "bodyText": "I can add it. I'm thinking it makes more sense for this value to follow the default free credits value and not the user overridden one. thoughts?", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371364159", "createdAt": "2020-01-27T17:01:55Z", "author": {"login": "ericsong"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -201,6 +209,10 @@ export const specificPopulations = [\n   }\n ];\n \n+const billingDescription = <div>The <i>All of Us</i> Program provides $200 in free credits per user.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkwMTAzOA=="}, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQzMjY0Ng==", "bodyText": "It looks like the user is able to call getBillingInfo on the project when they're a writer but they are NOT able to update the billing info. Is this OK? Fixing the permissions so that they can't call getBillingInfo might be non trivial since I think that is managed on FC's side based on how they interpret the writer role.\nFrom AoU's standpoint, they will not be able to update the workspace since only owners can edit Workspace details. We can also just remove the dropdown for writers if we do not want them to be able to see the billing info.\nWith regards to #2, the logic here got a bit tricky but I think I have something reasonable and there's enough comments that it should be readable. LMK what you think.", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371432646", "createdAt": "2020-01-27T19:20:38Z", "author": {"login": "ericsong"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -450,6 +465,22 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n         // workspace which references a non-default, non-archived CDR version.\n         this.setState(fp.set(['workspace', 'cdrVersionId'], cdrResp.defaultCdrVersionId));\n       }\n+\n+      if (serverConfigStore.getValue().enableBillingLockout) {\n+        userApi().listBillingAccounts().then(response =>\n+          this.setState({billingAccounts: response.billingAccounts})\n+        );\n+\n+        if (this.isMode(WorkspaceEditMode.Edit)) {\n+          getBillingAccountName(this.props.workspace.namespace).then(billingAccountName =>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkwMDUxOQ=="}, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 93}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4OTMxMTcz", "url": "https://github.com/all-of-us/workbench/pull/3035#pullrequestreview-348931173", "createdAt": "2020-01-27T19:51:12Z", "commit": {"oid": "e21e64dfc8ccae06b61f997c10ed7a5788ad1825"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxOTo1MToxMlrOFiPZ0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMDowOTowN1rOFiP68Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ0ODI3Mw==", "bodyText": "nit: combine this with the exception log.log(Level.SEVERE, \"Could not...\", e)", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371448273", "createdAt": "2020-01-27T19:51:12Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -244,12 +252,78 @@ private FirecloudWorkspace attemptFirecloudWorkspaceCreation(FirecloudWorkspaceI\n \n     dbWorkspace.setBillingMigrationStatusEnum(BillingMigrationStatus.NEW);\n \n-    dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n+    updateWorkspaceBillingAccount(dbWorkspace, workspace.getBillingAccountName());\n+    try {\n+      dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n+    } catch (Exception e) {\n+      // Tell Google to set the billing account back to the free tier if the workspace creation\n+      // fails\n+      log.severe(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e21e64dfc8ccae06b61f997c10ed7a5788ad1825"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1MTAwOQ==", "bodyText": "With backtick newlines, you're getting this whitespace embedded into the string - I'm guessing this is not desired, so should probably concat multiple backticked strings instead", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371451009", "createdAt": "2020-01-27T19:56:29Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -377,9 +373,61 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n         loading: false,\n         showUnderservedPopulationDetails: false,\n         showStigmatizationDetails: false,\n+        billingAccounts: []\n       };\n     }\n \n+    async componentDidMount() {\n+      if (serverConfigStore.getValue().enableBillingLockout) {\n+        const billingAccounts = (await userApi().listBillingAccounts()).billingAccounts;\n+\n+        if (this.isMode(WorkspaceEditMode.Edit)) {\n+          const fetchedBillingInfo = await getBillingAccountInfo(this.props.workspace.namespace);\n+\n+          if (!billingAccounts.find(billingAccount => billingAccount.name === fetchedBillingInfo.billingAccountName)) {\n+            // If the user has owner access on the workspace but does not have access to the billing account\n+            // that it is attached to, keep the server's current value for billingAccountName and add a shim\n+            // entry into billingAccounts so the dropdown entry is not empty.\n+            //\n+            // The server will not perform an updateBillingInfo call if the received billingAccountName\n+            // is the same as what is currently stored.\n+            //\n+            // This can happen if a workspace is shared to another researcher as an owner.\n+            billingAccounts.push({\n+              name: this.props.workspace.billingAccountName,\n+              displayName: 'User Provided Billing Account',\n+              isFreeTier: false,\n+              isOpen: true\n+            });\n+\n+            if (fetchedBillingInfo.billingAccountName !== this.props.workspace.billingAccountName) {\n+              // This should never happen but it means the database is out of sync with Google\n+              // and does not have the correct billing account stored.\n+              // We cannot send over the correct billing account info since the current user\n+              // does not have permissions to set it.\n+\n+              reportError({\n+                name: 'Out of date billing account name',\n+                message: `Workspace ${this.props.workspace.namespace} has an out of date billing account name.\n+                Stored value is ${this.props.workspace.billingAccountName}. True value is ${fetchedBillingInfo.billingAccountName}`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e21e64dfc8ccae06b61f997c10ed7a5788ad1825"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1Mzc3NA==", "bodyText": "Where did this go?", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371453774", "createdAt": "2020-01-27T20:02:32Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -416,40 +464,15 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n             socialBehavioral: false,\n             reasonForAllOfUs: '',\n           }\n-        },\n-        workspaceCreationConflictError: false,\n-        workspaceCreationError: false,\n-        workspaceCreationErrorMessage: '',\n-        workspaceNewAclDelayed: false,\n-        workspaceNewAclDelayedContinueFn: () => {},\n-        cloneUserRole: false,\n-        loading: false,\n-        showUnderservedPopulationDetails: false,\n-        showStigmatizationDetails: false,\n-        billingAccounts: []\n-      };\n-    }\n-\n-    async componentDidMount() {\n-      if (!this.isMode(WorkspaceEditMode.Create)) {\n-        this.setState({workspace : {\n-          ...this.props.workspace,\n-            // Replace potential nulls with empty string or empty array\n-          researchPurpose: {\n-            ...this.props.workspace.researchPurpose,\n-            populationDetails: !this.props.workspace.researchPurpose.populationDetails ?\n-              [] : this.props.workspace.researchPurpose.populationDetails,\n-            diseaseOfFocus: !this.props.workspace.researchPurpose.diseaseOfFocus ?\n-              '' : this.props.workspace.researchPurpose.diseaseOfFocus}\n-        }});\n+        };\n+      }\n \n-        if (this.isMode(WorkspaceEditMode.Duplicate)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e21e64dfc8ccae06b61f997c10ed7a5788ad1825"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1NDcwNQ==", "bodyText": "In the clone case, we should just default to the free tier billing account.", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371454705", "createdAt": "2020-01-27T20:04:31Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -377,9 +373,61 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n         loading: false,\n         showUnderservedPopulationDetails: false,\n         showStigmatizationDetails: false,\n+        billingAccounts: []\n       };\n     }\n \n+    async componentDidMount() {\n+      if (serverConfigStore.getValue().enableBillingLockout) {\n+        const billingAccounts = (await userApi().listBillingAccounts()).billingAccounts;\n+\n+        if (this.isMode(WorkspaceEditMode.Edit)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e21e64dfc8ccae06b61f997c10ed7a5788ad1825"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1NTU1MA==", "bodyText": "Yes, default makes sense. It would also be very confusing to explain which user this is referring to (since it depends on the creator, not necesarily the current user's free tier credits).", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371455550", "createdAt": "2020-01-27T20:06:24Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -201,6 +209,10 @@ export const specificPopulations = [\n   }\n ];\n \n+const billingDescription = <div>The <i>All of Us</i> Program provides $200 in free credits per user.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkwMTAzOA=="}, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1NjA2MQ==", "bodyText": "Only owners should be able to change the billing information, so the dropdown should ideally just be disabled for non-owners.", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371456061", "createdAt": "2020-01-27T20:07:35Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -450,6 +465,22 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n         // workspace which references a non-default, non-archived CDR version.\n         this.setState(fp.set(['workspace', 'cdrVersionId'], cdrResp.defaultCdrVersionId));\n       }\n+\n+      if (serverConfigStore.getValue().enableBillingLockout) {\n+        userApi().listBillingAccounts().then(response =>\n+          this.setState({billingAccounts: response.billingAccounts})\n+        );\n+\n+        if (this.isMode(WorkspaceEditMode.Edit)) {\n+          getBillingAccountName(this.props.workspace.namespace).then(billingAccountName =>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDkwMDUxOQ=="}, "originalCommit": {"oid": "bcb09156164e0a8fa4adc098e4f3e07a4249c878"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ1Njc1Mw==", "bodyText": "nit: pretty heavy nesting. I might at least break out this first case into an inverted flag check + early return to eliminate one level.", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371456753", "createdAt": "2020-01-27T20:09:07Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -377,9 +373,61 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n         loading: false,\n         showUnderservedPopulationDetails: false,\n         showStigmatizationDetails: false,\n+        billingAccounts: []\n       };\n     }\n \n+    async componentDidMount() {\n+      if (serverConfigStore.getValue().enableBillingLockout) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e21e64dfc8ccae06b61f997c10ed7a5788ad1825"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e12241c0fe35ee1b137c40a36190b80811ee30eb", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/e12241c0fe35ee1b137c40a36190b80811ee30eb", "committedDate": "2020-01-27T21:01:57Z", "message": "code review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dc4886ffc68932720e7ff051ea4f24a32b25404", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/9dc4886ffc68932720e7ff051ea4f24a32b25404", "committedDate": "2020-01-27T21:03:37Z", "message": "lint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2aa51fac7006785ef3f9d2abe79d680a4f4c226", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/a2aa51fac7006785ef3f9d2abe79d680a4f4c226", "committedDate": "2020-01-27T21:31:22Z", "message": "fix tests and workspace state bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84290cfd8a5a60f83e7638410c98c2510e018055", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/84290cfd8a5a60f83e7638410c98c2510e018055", "committedDate": "2020-01-27T21:32:24Z", "message": "spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4OTk0NDg3", "url": "https://github.com/all-of-us/workbench/pull/3035#pullrequestreview-348994487", "createdAt": "2020-01-27T21:40:52Z", "commit": {"oid": "9dc4886ffc68932720e7ff051ea4f24a32b25404"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4OTk1MDA2", "url": "https://github.com/all-of-us/workbench/pull/3035#pullrequestreview-348995006", "createdAt": "2020-01-27T21:41:47Z", "commit": {"oid": "84290cfd8a5a60f83e7638410c98c2510e018055"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMTo0MTo0N1rOFiSccw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QyMTo0NzoyNlrOFiSm2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ5ODA5OQ==", "bodyText": "Could you add a comment about what it means for a Billing Account to be \"open\" ?", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371498099", "createdAt": "2020-01-27T21:41:47Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -2789,6 +2811,33 @@ definitions:\n         items:\n           $ref: \"#/definitions/CohortReview\"\n \n+  WorkbenchListBillingAccountsResponse:\n+    type: object\n+    required:\n+      - billingAccounts\n+    properties:\n+      billingAccounts:\n+        type: \"array\"\n+        items:\n+          $ref: \"#/definitions/BillingAccount\"\n+\n+  BillingAccount:\n+    type: object\n+    required:\n+      - isFreeTier\n+      - name\n+      - displayName\n+      - isOpen\n+    properties:\n+      isFreeTier:\n+        type: boolean\n+      name:\n+        type: string\n+      displayName:\n+        type: string\n+      isOpen:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84290cfd8a5a60f83e7638410c98c2510e018055"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwMDI2Ng==", "bodyText": "GoogleCredential is deprecated.  Can this be rewritten with GoogleCredentials ?", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371500266", "createdAt": "2020-01-27T21:46:24Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/billing/GoogleApisConfig.java", "diffHunk": "@@ -0,0 +1,39 @@\n+package org.pmiops.workbench.billing;\n+\n+import com.google.api.client.googleapis.auth.oauth2.GoogleCredential;\n+import com.google.api.client.googleapis.javanet.GoogleNetHttpTransport;\n+import com.google.api.client.json.JsonFactory;\n+import com.google.api.services.cloudbilling.Cloudbilling;\n+import java.io.IOException;\n+import java.security.GeneralSecurityException;\n+import java.util.Collections;\n+import javax.inject.Provider;\n+import org.pmiops.workbench.auth.UserAuthentication;\n+import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.ScopedProxyMode;\n+import org.springframework.web.context.annotation.RequestScope;\n+\n+@Configuration\n+public class GoogleApisConfig {\n+\n+  @Bean\n+  @RequestScope(proxyMode = ScopedProxyMode.DEFAULT)\n+  public Cloudbilling googleCloudBillingApi(\n+      UserAuthentication userAuthentication,\n+      JsonFactory jsonFactory,\n+      Provider<WorkbenchConfig> workbenchConfigProvider)\n+      throws GeneralSecurityException, IOException {\n+    GoogleCredential credential =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84290cfd8a5a60f83e7638410c98c2510e018055"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwMDYyMA==", "bodyText": "can be .call(request::execute) instead", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371500620", "createdAt": "2020-01-27T21:47:07Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -244,12 +252,80 @@ private FirecloudWorkspace attemptFirecloudWorkspaceCreation(FirecloudWorkspaceI\n \n     dbWorkspace.setBillingMigrationStatusEnum(BillingMigrationStatus.NEW);\n \n-    dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n+    updateWorkspaceBillingAccount(dbWorkspace, workspace.getBillingAccountName());\n+    try {\n+      dbWorkspace = workspaceService.getDao().save(dbWorkspace);\n+    } catch (Exception e) {\n+      // Tell Google to set the billing account back to the free tier if the workspace creation\n+      // fails\n+      log.log(\n+          Level.SEVERE,\n+          \"Could not save new workspace to database. Calling Google Cloud billing to update the failed billing project's billing account back to the free tier.\",\n+          e);\n+\n+      updateWorkspaceBillingAccount(dbWorkspace, workbenchConfigProvider.get().billing.accountId);\n+      throw e;\n+    }\n+\n     Workspace createdWorkspace = WorkspaceConversionUtils.toApiWorkspace(dbWorkspace, fcWorkspace);\n     workspaceAuditor.fireCreateAction(createdWorkspace, dbWorkspace.getWorkspaceId());\n     return ResponseEntity.ok(createdWorkspace);\n   }\n \n+  private Retryer<ProjectBillingInfo> cloudBillingRetryer =\n+      RetryerBuilder.<ProjectBillingInfo>newBuilder()\n+          .retryIfException(\n+              e ->\n+                  e instanceof GoogleJsonResponseException\n+                      && ((GoogleJsonResponseException) e).getStatusCode() == 403)\n+          .withWaitStrategy(WaitStrategies.exponentialWait())\n+          .withStopStrategy(StopStrategies.stopAfterDelay(60, TimeUnit.SECONDS))\n+          .build();\n+\n+  private void updateWorkspaceBillingAccount(DbWorkspace workspace, String newBillingAccountName) {\n+    if (!workbenchConfigProvider.get().featureFlags.enableBillingLockout) {\n+      // If billing lockout / upgrade is not enabled, ignore the normal logic\n+      // and set the billing account to the free tier\n+      workspace.setBillingAccountName(\n+          \"billingAccounts/\" + workbenchConfigProvider.get().billing.accountId);\n+      return;\n+    }\n+\n+    if (newBillingAccountName.equals(workspace.getBillingAccountName())) {\n+      return;\n+    }\n+\n+    try {\n+      UpdateBillingInfo request =\n+          cloudbillingProvider\n+              .get()\n+              .projects()\n+              .updateBillingInfo(\n+                  \"projects/\" + workspace.getWorkspaceNamespace(),\n+                  new ProjectBillingInfo().setBillingAccountName(newBillingAccountName));\n+\n+      ProjectBillingInfo response;\n+\n+      try {\n+        // this is necessary because the grant ownership call in create/clone\n+        // may not have propagated. Adding a few retries drastically reduces\n+        // the likely of failing due to slow propagation\n+        response = cloudBillingRetryer.call(() -> request.execute());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84290cfd8a5a60f83e7638410c98c2510e018055"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTUwMDc2MA==", "bodyText": "Could you go into more detail here?", "url": "https://github.com/all-of-us/workbench/pull/3035#discussion_r371500760", "createdAt": "2020-01-27T21:47:26Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/workspaces/WorkspacesController.java", "diffHunk": "@@ -460,9 +545,18 @@ private void setDbWorkspaceFields(\n \n     dbWorkspace.setBillingMigrationStatusEnum(BillingMigrationStatus.NEW);\n \n-    DbWorkspace savedDbWorkspace =\n-        workspaceService.saveAndCloneCohortsConceptSetsAndDataSets(fromWorkspace, dbWorkspace);\n+    updateWorkspaceBillingAccount(dbWorkspace, body.getWorkspace().getBillingAccountName());\n+\n+    try {\n+      dbWorkspace =\n+          workspaceService.saveAndCloneCohortsConceptSetsAndDataSets(fromWorkspace, dbWorkspace);\n+    } catch (Exception e) {\n+      // Tell Google to set the billing account back to the free tier if our clone fails\n+      updateWorkspaceBillingAccount(dbWorkspace, workbenchConfigProvider.get().billing.accountId);\n+      throw e;\n+    }\n \n+    // TODO: File a bug about this. Can create a workspace", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84290cfd8a5a60f83e7638410c98c2510e018055"}, "originalPosition": 175}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd6d7542823190ce1b1e7a567794dc6cac3e2e0e", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/bd6d7542823190ce1b1e7a567794dc6cac3e2e0e", "committedDate": "2020-01-27T22:18:42Z", "message": "various cleanup and fixes. use non deprecated google credentials library"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NDk3MDI4", "url": "https://github.com/all-of-us/workbench/pull/3035#pullrequestreview-349497028", "createdAt": "2020-01-28T16:03:29Z", "commit": {"oid": "bd6d7542823190ce1b1e7a567794dc6cac3e2e0e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a690e486dc2fc195b1464503d17357f31e04ba2", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/2a690e486dc2fc195b1464503d17357f31e04ba2", "committedDate": "2020-01-28T16:31:43Z", "message": "remove test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a323978743405d3cc40eb319ab02f2f1a64cc69", "author": {"user": {"login": "ericsong", "name": "Eric Song"}}, "url": "https://github.com/all-of-us/workbench/commit/0a323978743405d3cc40eb319ab02f2f1a64cc69", "committedDate": "2020-01-28T16:32:08Z", "message": "remove test code"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3726, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}