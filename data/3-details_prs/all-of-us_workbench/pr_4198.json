{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3OTAzOTAw", "number": 4198, "title": "[risk=moderate][RW-4852] New auth utils to centralize all Authority checks", "bodyText": "Description:\nAlso resolve a bug where we were showing Workspace Audit for the wrong Authority: ACCESS_CONTROL_ADMIN instead of RESEARCHER_DATA_VIEW.  NOTE: no data was inappropriately exposed because the API call was correctly guarded.\nDEVELOPER Authority now exposes all Authority-controlled UI elements.\nThis PR does NOT cover routing: navigating to one of these pages manually remains possible without appropriate Authority.  The underlying data remains controlled by the API and will still not be available.\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test-local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-10-21T22:40:46Z", "url": "https://github.com/all-of-us/workbench/pull/4198", "merged": true, "mergeCommit": {"oid": "48bca329df2b9c7e7204b61d2bf6f238e77bc43f"}, "closed": true, "closedAt": "2020-10-22T18:49:45Z", "author": {"login": "jmthibault79"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdU1TAdgFqTUxNDI0MDI3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVFrOZgH2gAyNTA3OTAzOTAwOmM0ZjNlYWFhMTExMWQ2ZTljNDgxNzMxNjI1Yjk1MDMzYTE1Y2I4NWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MjQwMjc5", "url": "https://github.com/all-of-us/workbench/pull/4198#pullrequestreview-514240279", "createdAt": "2020-10-21T22:41:27Z", "commit": {"oid": "91c0371f86d2dae1795a34bc7b74b10f67476493"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjo0MToyN1rOHmJ-dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjo0MToyN1rOHmJ-dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc3MTM4Mg==", "bodyText": "Corrected this one to be RESEARCHERDATAVIEW", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r509771382", "createdAt": "2020-10-21T22:41:27Z", "author": {"login": "jmthibault79"}, "path": "ui/src/app/components/side-nav.tsx", "diffHunk": "@@ -331,47 +332,47 @@ export class SideNav extends React.Component<SideNavProps, SideNavState> {\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.ACCESSCONTROLADMIN) && this.state.showAdminOptions && <SideNavItem\n+        hasAuthorityForPage(profile, AuthGuardedPage.USER_ADMIN) && this.state.showAdminOptions && <SideNavItem\n           content={'User Admin'}\n           onToggleSideNav={() => this.props.onToggleSideNav()}\n           href={'/admin/user'}\n           active={this.props.userAdminActive}\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.ACCESSCONTROLADMIN) && this.state.showAdminOptions && <SideNavItem\n+        hasAuthorityForPage(profile, AuthGuardedPage.USER_AUDIT) && this.state.showAdminOptions && <SideNavItem\n             content={'User Audit'}\n             onToggleSideNav={() => this.props.onToggleSideNav()}\n             href={'/admin/user-audit/'}\n             active={this.props.userAuditActive}\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.COMMUNICATIONSADMIN) && this.state.showAdminOptions && <SideNavItem\n+        hasAuthorityForPage(profile, AuthGuardedPage.SERVICE_BANNER) && this.state.showAdminOptions && <SideNavItem\n             content={'Service Banners'}\n             onToggleSideNav={() => this.props.onToggleSideNav()}\n             href={'/admin/banner'}\n             active={this.props.bannerAdminActive}\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.RESEARCHERDATAVIEW) && this.state.showAdminOptions && <SideNavItem\n+        hasAuthorityForPage(profile, AuthGuardedPage.WORKSPACE_ADMIN) && this.state.showAdminOptions && <SideNavItem\n             content={'Workspaces'}\n             onToggleSideNav={() => this.props.onToggleSideNav()}\n             href={'admin/workspaces'}\n             active={this.props.workspaceAdminActive}\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.ACCESSCONTROLADMIN) && this.state.showAdminOptions && <SideNavItem", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c0371f86d2dae1795a34bc7b74b10f67476493"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MjQxNjMy", "url": "https://github.com/all-of-us/workbench/pull/4198#pullrequestreview-514241632", "createdAt": "2020-10-21T22:44:27Z", "commit": {"oid": "91c0371f86d2dae1795a34bc7b74b10f67476493"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjo0NDoyOFrOHmKFOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjo0NDoyOFrOHmKFOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc3MzExMg==", "bodyText": "Thank you for centralizing this. Could you also add the following logic while we're here to address this long-standing UI bug? https://precisionmedicineinitiative.atlassian.net/browse/RW-4852\nprofile.authorities.includes(Authority.DEVELOPER) || ...", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r509773112", "createdAt": "2020-10-21T22:44:28Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,30 @@\n+// utilities around Authority and page-based authorization\n+\n+import {Authority, Profile} from 'generated/fetch';\n+\n+// Admin pages guarded by a particular Authority\n+enum AuthGuardedPage {\n+    USER_ADMIN,\n+    USER_AUDIT,\n+    WORKSPACE_ADMIN,\n+    WORKSPACE_AUDIT,\n+    SERVICE_BANNER,\n+    INSTITUTION_ADMIN,\n+}\n+\n+const authorityByPage: Map<AuthGuardedPage, Authority> = new Map([\n+    [AuthGuardedPage.USER_ADMIN, Authority.ACCESSCONTROLADMIN],\n+    [AuthGuardedPage.USER_AUDIT, Authority.ACCESSCONTROLADMIN],\n+    [AuthGuardedPage.WORKSPACE_ADMIN, Authority.RESEARCHERDATAVIEW],\n+    [AuthGuardedPage.WORKSPACE_AUDIT, Authority.RESEARCHERDATAVIEW],\n+    [AuthGuardedPage.SERVICE_BANNER, Authority.COMMUNICATIONSADMIN],\n+    [AuthGuardedPage.INSTITUTION_ADMIN, Authority.INSTITUTIONADMIN],\n+]);\n+\n+const hasAuthorityForPage = (profile: Profile, page: AuthGuardedPage): boolean =>\n+    profile.authorities.includes(authorityByPage.get(page));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c0371f86d2dae1795a34bc7b74b10f67476493"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e94a750d006bbd553171e502a6d9a5215a64236", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/9e94a750d006bbd553171e502a6d9a5215a64236", "committedDate": "2020-10-22T15:33:50Z", "message": "Guard all actions by hasAuthorityForAction() and include DEVELOPER\nupdate side-nav to use new auth utils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/96d41dfc49abe1692fe583f766132d657aee6595", "committedDate": "2020-10-22T15:34:01Z", "message": "workspace-about-spec"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d4eb546376462135b28ee1f4a143656b5d81b22", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/2d4eb546376462135b28ee1f4a143656b5d81b22", "committedDate": "2020-10-22T14:26:40Z", "message": "oops"}, "afterCommit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/96d41dfc49abe1692fe583f766132d657aee6595", "committedDate": "2020-10-22T15:34:01Z", "message": "workspace-about-spec"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODkzNzMz", "url": "https://github.com/all-of-us/workbench/pull/4198#pullrequestreview-514893733", "createdAt": "2020-10-22T16:08:14Z", "commit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjowODoxNFrOHmpS2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjowODoxNFrOHmpS2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI4NDUwNQ==", "bodyText": "can't simplify to .some(adminMenuAuthorities.has) because the default signature for some() has extra params", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510284505", "createdAt": "2020-10-22T16:08:14Z", "author": {"login": "jmthibault79"}, "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,52 @@\n+// utilities around Authority and page-based authorization\n+\n+import {Authority, Profile} from 'generated/fetch';\n+\n+// Admin actions guarded by a particular Authority\n+enum AuthGuardedAction {\n+    SHOW_ADMIN_MENU,\n+    USER_ADMIN,\n+    USER_AUDIT,\n+    WORKSPACE_ADMIN,\n+    WORKSPACE_AUDIT,\n+    SERVICE_BANNER,\n+    INSTITUTION_ADMIN,\n+    PUBLISH_WORKSPACE,\n+}\n+\n+// The full set of Authorities which guard admin-menu actions\n+const adminMenuAuthorities = new Set([\n+  Authority.ACCESSCONTROLADMIN,\n+  Authority.RESEARCHERDATAVIEW,\n+  Authority.COMMUNICATIONSADMIN,\n+  Authority.INSTITUTIONADMIN,\n+]);\n+\n+const authorityByPage: Map<AuthGuardedAction, Authority> = new Map([\n+    [AuthGuardedAction.USER_ADMIN, Authority.ACCESSCONTROLADMIN],\n+    [AuthGuardedAction.USER_AUDIT, Authority.ACCESSCONTROLADMIN],\n+    [AuthGuardedAction.WORKSPACE_ADMIN, Authority.RESEARCHERDATAVIEW],\n+    [AuthGuardedAction.WORKSPACE_AUDIT, Authority.RESEARCHERDATAVIEW],\n+    [AuthGuardedAction.SERVICE_BANNER, Authority.COMMUNICATIONSADMIN],\n+    [AuthGuardedAction.INSTITUTION_ADMIN, Authority.INSTITUTIONADMIN],\n+    [AuthGuardedAction.PUBLISH_WORKSPACE, Authority.FEATUREDWORKSPACEADMIN],\n+]);\n+\n+const hasAuthorityForAction = (profile: Profile, action: AuthGuardedAction): boolean => {\n+  // DEVELOPER is the super-Authority which includes all others\n+  if (profile.authorities.includes(Authority.DEVELOPER)) {\n+    return true;\n+  }\n+\n+  // return true if we have any of the menu-displaying authorities\n+  if (action === AuthGuardedAction.SHOW_ADMIN_MENU) {\n+    return profile.authorities.some(auth => adminMenuAuthorities.has(auth));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0OTUyMzQz", "url": "https://github.com/all-of-us/workbench/pull/4198#pullrequestreview-514952343", "createdAt": "2020-10-22T17:17:22Z", "commit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzoxNzoyMlrOHmsBHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzoxOToxN1rOHmsFkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMyOTExNw==", "bodyText": "We should move this to the workspace admin page eventually - I filed https://precisionmedicineinitiative.atlassian.net/browse/RW-5786", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510329117", "createdAt": "2020-10-22T17:17:22Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/workspace/workspace-about.tsx", "diffHunk": "@@ -204,12 +204,16 @@ export const WorkspaceAbout = fp.flow(withUserProfile(), withUrlParams(), withCd\n     return <div style={styles.mainPage}>\n       <FlexColumn style={{margin: '1rem', width: '98%'}}>\n         <ResearchPurpose data-test-id='researchPurpose'/>\n-        {profile.authorities.includes(Authority.FEATUREDWORKSPACEADMIN) &&\n-        <div style={{display: 'flex', justifyContent: 'flex-end'}}>\n-            <Button disabled={publishing} type='secondary'\n-                    onClick={() => this.publishUnpublishWorkspace(false)}>Unpublish</Button>\n-            <Button onClick={() => this.publishUnpublishWorkspace(true)}\n-                    disabled={publishing} style={{marginLeft: '0.5rem'}}>Publish</Button>\n+        {hasAuthorityForAction(profile, AuthGuardedAction.PUBLISH_WORKSPACE) &&\n+          <div style={{display: 'flex', justifyContent: 'flex-end'}}>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzMDExMA==", "bodyText": "nit: auth usually means authentication, authorization, or both. Here I think it means authority instead, I would probably rename the file to authorities.tsx to be more explicit and avoid a third disambiguation", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510330110", "createdAt": "2020-10-22T17:19:01Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,52 @@\n+// utilities around Authority and page-based authorization", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzMDI1OA==", "bodyText": "nit: per above comment, I would spell this out as AuthorityGuardedAction", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510330258", "createdAt": "2020-10-22T17:19:17Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,52 @@\n+// utilities around Authority and page-based authorization\n+\n+import {Authority, Profile} from 'generated/fetch';\n+\n+// Admin actions guarded by a particular Authority\n+enum AuthGuardedAction {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4f3eaaa1111d6e9c481731625b95033a15cb85d", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/c4f3eaaa1111d6e9c481731625b95033a15cb85d", "committedDate": "2020-10-22T17:46:23Z", "message": "better naming"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4009, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}