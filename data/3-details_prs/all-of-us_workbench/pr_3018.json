{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NDYxNjMw", "number": 3018, "title": "[risk=low]Refactoring to make RW-3661 easier", "bodyText": "Description:\nSplitting off some independent work from the (forthcoming) main RW-3661 PR\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-01-21T19:04:59Z", "url": "https://github.com/all-of-us/workbench/pull/3018", "merged": true, "mergeCommit": {"oid": "bd4a698007ae8eb8ea829d2df202e9abf7885660"}, "closed": true, "closedAt": "2020-01-21T22:53:10Z", "author": {"login": "jmthibault79"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8luB8gH2gAyMzY1NDYxNjMwOjFhYWY5NWI4OTYxZTY0YjIyOTJkY2UwNGIwNzY0NTlkNmMyZWFjZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8oiSFAH2gAyMzY1NDYxNjMwOmZhNzBlMDY3Mjk5NjVkMWU1Y2VmM2Y5ZTQ4MjdmNTA0Zjk5OThhZDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1aaf95b8961e64b2292dce04b076459d6c2eacf3", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/1aaf95b8961e64b2292dce04b076459d6c2eacf3", "committedDate": "2020-01-21T18:47:09Z", "message": "StrSubstitutor is deprecated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c62cc6bf8dc28cbd24cce446ddbff6461baae99c", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/c62cc6bf8dc28cbd24cce446ddbff6461baae99c", "committedDate": "2020-01-21T18:47:10Z", "message": "better alert check logic and test cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/270f296cd61fa70ec2dc37f5a15c70b547c416bc", "committedDate": "2020-01-21T18:47:10Z", "message": "MailServiceImpl refactor for DRY"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTE5Njg2", "url": "https://github.com/all-of-us/workbench/pull/3018#pullrequestreview-346119686", "createdAt": "2020-01-21T19:06:20Z", "commit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTowNjoyMFrOFgFbGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTowNjoyMFrOFgFbGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE4NzYxMA==", "bodyText": "Includes StringSubstitutor which replaces the deprecated StrSubstitutor", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369187610", "createdAt": "2020-01-21T19:06:20Z", "author": {"login": "jmthibault79"}, "path": "api/build.gradle", "diffHunk": "@@ -436,6 +436,7 @@ dependencies {\n   compile 'javax.inject:javax.inject:1'\n   compile 'io.swagger:swagger-annotations:1.5.16'\n   compile 'org.apache.commons:commons-lang3:3.6'\n+  compile 'org.apache.commons:commons-text:1.8'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTIxOTcz", "url": "https://github.com/all-of-us/workbench/pull/3018#pullrequestreview-346121973", "createdAt": "2020-01-21T19:10:01Z", "commit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToxMDowMlrOFgFh_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToxMDowMlrOFgFh_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE4OTM3Mw==", "bodyText": "This is a change: previously we would run this cost check for users with null registration times.\nHowever it is not very meaningful because any user who actually logs into the system will not have a null registration time.\nI decided to make this change because it makes the logic a little simpler.", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369189373", "createdAt": "2020-01-21T19:10:02Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/billing/FreeTierBillingService.java", "diffHunk": "@@ -110,8 +110,13 @@ public void checkFreeTierBillingUsage() {\n       deactivateUserWorkspaces(user);\n     }\n \n-    sendAlertsForCostThresholds(previousUserCosts, userCosts, currentExpiredUsers);\n-    sendAlertsForTimeThresholds(userCosts, currentExpiredUsers);\n+    final Set<DbUser> usersWithNonNullRegistration =\n+        userDao.findByFirstRegistrationCompletionTimeNotNull();\n+    final Set<DbUser> usersToThresholdCheck =\n+        Sets.difference(usersWithNonNullRegistration, currentExpiredUsers);\n+\n+    sendAlertsForCostThresholds(usersToThresholdCheck, previousUserCosts, userCosts);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTIyNTA3", "url": "https://github.com/all-of-us/workbench/pull/3018#pullrequestreview-346122507", "createdAt": "2020-01-21T19:10:52Z", "commit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToxMDo1MlrOFgFjjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToxMDo1MlrOFgFjjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE4OTc3NA==", "bodyText": "this was deprecated", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369189774", "createdAt": "2020-01-21T19:10:52Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -13,8 +13,8 @@\n import javax.mail.MessagingException;\n import javax.mail.internet.AddressException;\n import javax.mail.internet.InternetAddress;\n-import org.apache.commons.lang3.text.StrSubstitutor;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTIzNjQ1", "url": "https://github.com/all-of-us/workbench/pull/3018#pullrequestreview-346123645", "createdAt": "2020-01-21T19:12:41Z", "commit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToxMjo0MVrOFgFnAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToxMjo0MVrOFgFnAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5MDY1Nw==", "bodyText": "There was a lot of duplication in the buildXMessage and buildXHtml methods, so I made this process more generic.  I'll need to add 3 more of these for RW-3661.", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369190657", "createdAt": "2020-01-21T19:12:41Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTI0MTA2", "url": "https://github.com/all-of-us/workbench/pull/3018#pullrequestreview-346124106", "createdAt": "2020-01-21T19:13:26Z", "commit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToxMzoyNlrOFgFoTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToxMzoyNlrOFgFoTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5MDk5MQ==", "bodyText": "new method to replace some common validation logic", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369190991", "createdAt": "2020-01-21T19:13:26Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);\n+    final String msgHtml =\n+        buildHtml(WELCOME_RESOURCE, welcomeMessageSubstitutionMap(password, user));\n+    final MandrillMessage msg = buildMessage(contactEmail, msgHtml, \"Your new All of Us Account\");\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n   @Override\n-  public void sendBetaAccessCompleteEmail(String contactEmail, String username)\n+  public void sendBetaAccessCompleteEmail(final String contactEmail, final String username)\n       throws MessagingException {\n+    final String msgHtml = buildHtml(BETA_ACCESS_RESOURCE, betaAccessSubstitutionMap(username));\n+    final MandrillMessage msg =\n+        buildMessage(contactEmail, msgHtml, \"All of Us ID Verification Complete\");\n+    sendWithRetries(msg, String.format(\"BetaAccess Complete for %s\", contactEmail));\n+  }\n+\n+  private ImmutableMap<String, String> welcomeMessageSubstitutionMap(\n+      final String password, final User user) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"USERNAME\", user.getPrimaryEmail())\n+        .put(\"PASSWORD\", password)\n+        .put(\"URL\", workbenchConfigProvider.get().admin.loginUrl)\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"BULLET_1\", cloudStorageService.getImageUrl(\"bullet_1.png\"))\n+        .put(\"BULLET_2\", cloudStorageService.getImageUrl(\"bullet_2.png\"))\n+        .build();\n+  }\n+\n+  private ImmutableMap<String, String> betaAccessSubstitutionMap(final String username) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+\n+    final String action =\n+        \"login to the workbench via <a class=\\\"link\\\" href=\\\"\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"\\\">\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"</a>\";\n+\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"ACTION\", action)\n+        .put(\"BETA_ACCESS_REPORT\", \"approved for use\")\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"USERNAME\", username)\n+        .build();\n+  }\n+\n+  private String buildHtml(final String resource, final ImmutableMap<String, String> replacementMap)\n+      throws MessagingException {\n+    final URL emailContent = Resources.getResource(resource);\n+    final StringBuilder contentBuilder = new StringBuilder();\n+\n+    try {\n+      Resources.readLines(emailContent, StandardCharsets.UTF_8)\n+          .forEach(s -> contentBuilder.append(s).append(\"\\n\"));\n+    } catch (IOException e) {\n+      throw new MessagingException(\"Error reading in email\");\n+    }\n+\n+    return new StringSubstitutor(replacementMap).replace(contentBuilder.toString());\n+  }\n+\n+  private MandrillMessage buildMessage(\n+      final String contactEmail, final String msgHtml, final String subject)\n+      throws MessagingException {\n+    return new MandrillMessage()\n+        .to(Collections.singletonList(validatedRecipient(contactEmail)))\n+        .html(msgHtml)\n+        .subject(subject)\n+        .fromEmail(workbenchConfigProvider.get().mandrill.fromEmail);\n+  }\n+\n+  private RecipientAddress validatedRecipient(final String contactEmail) throws MessagingException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 105}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTI0NDUw", "url": "https://github.com/all-of-us/workbench/pull/3018#pullrequestreview-346124450", "createdAt": "2020-01-21T19:13:59Z", "commit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToxMzo1OVrOFgFpWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToxMzo1OVrOFgFpWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5MTI1OA==", "bodyText": "set some defaults for tests", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369191258", "createdAt": "2020-01-21T19:13:59Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/billing/FreeTierBillingServiceTest.java", "diffHunk": "@@ -104,6 +104,11 @@ public void setUp() {\n     workbenchConfig = WorkbenchConfig.createEmptyConfig();\n     workbenchConfig.billing.freeTierCostAlertThresholds = new ArrayList<>(Doubles.asList(.5, .75));\n     workbenchConfig.billing.freeTierTimeAlertThresholds = new ArrayList<>(Doubles.asList(.5, .75));\n+    workbenchConfig.billing.defaultFreeCreditsDollarLimit = 1000.0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTI0ODA1", "url": "https://github.com/all-of-us/workbench/pull/3018#pullrequestreview-346124805", "createdAt": "2020-01-21T19:14:31Z", "commit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToxNDozMlrOFgFqZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToxNDozMlrOFgFqZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5MTUyNA==", "bodyText": "since we now only check if the user has a valid registration time", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369191524", "createdAt": "2020-01-21T19:14:32Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/billing/FreeTierBillingServiceTest.java", "diffHunk": "@@ -936,6 +933,7 @@ private void assertSingleWorkspaceTestDbState(\n   private DbUser createUser(String email) {\n     DbUser user = new DbUser();\n     user.setUsername(email);\n+    user.setFirstRegistrationCompletionTime(Timestamp.from(START_INSTANT));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTI5NzU0", "url": "https://github.com/all-of-us/workbench/pull/3018#pullrequestreview-346129754", "createdAt": "2020-01-21T19:22:34Z", "commit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOToyMjozNFrOFgF5oQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxOTozMDowMFrOFgGH7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5NTQyNQ==", "bodyText": "Can you define these string constants in an Enum like EmailTemplateKey.USERNAME?", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369195425", "createdAt": "2020-01-21T19:22:34Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);\n+    final String msgHtml =\n+        buildHtml(WELCOME_RESOURCE, welcomeMessageSubstitutionMap(password, user));\n+    final MandrillMessage msg = buildMessage(contactEmail, msgHtml, \"Your new All of Us Account\");\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n   @Override\n-  public void sendBetaAccessCompleteEmail(String contactEmail, String username)\n+  public void sendBetaAccessCompleteEmail(final String contactEmail, final String username)\n       throws MessagingException {\n+    final String msgHtml = buildHtml(BETA_ACCESS_RESOURCE, betaAccessSubstitutionMap(username));\n+    final MandrillMessage msg =\n+        buildMessage(contactEmail, msgHtml, \"All of Us ID Verification Complete\");\n+    sendWithRetries(msg, String.format(\"BetaAccess Complete for %s\", contactEmail));\n+  }\n+\n+  private ImmutableMap<String, String> welcomeMessageSubstitutionMap(\n+      final String password, final User user) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"USERNAME\", user.getPrimaryEmail())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5NjE2OQ==", "bodyText": "This is getting close to content management in a Java file. Ideally we'd allow authors and graphic designers a more accessible place to compose content.", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369196169", "createdAt": "2020-01-21T19:24:04Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);\n+    final String msgHtml =\n+        buildHtml(WELCOME_RESOURCE, welcomeMessageSubstitutionMap(password, user));\n+    final MandrillMessage msg = buildMessage(contactEmail, msgHtml, \"Your new All of Us Account\");\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n   @Override\n-  public void sendBetaAccessCompleteEmail(String contactEmail, String username)\n+  public void sendBetaAccessCompleteEmail(final String contactEmail, final String username)\n       throws MessagingException {\n+    final String msgHtml = buildHtml(BETA_ACCESS_RESOURCE, betaAccessSubstitutionMap(username));\n+    final MandrillMessage msg =\n+        buildMessage(contactEmail, msgHtml, \"All of Us ID Verification Complete\");\n+    sendWithRetries(msg, String.format(\"BetaAccess Complete for %s\", contactEmail));\n+  }\n+\n+  private ImmutableMap<String, String> welcomeMessageSubstitutionMap(\n+      final String password, final User user) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"USERNAME\", user.getPrimaryEmail())\n+        .put(\"PASSWORD\", password)\n+        .put(\"URL\", workbenchConfigProvider.get().admin.loginUrl)\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5NjYwNA==", "bodyText": "nit: for private methods this is OK, but generally the guidance is to declare your function to return Map (for compatibility), even when using an ImmutableMap under the hood. Which seems scary.", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369196604", "createdAt": "2020-01-21T19:24:58Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);\n+    final String msgHtml =\n+        buildHtml(WELCOME_RESOURCE, welcomeMessageSubstitutionMap(password, user));\n+    final MandrillMessage msg = buildMessage(contactEmail, msgHtml, \"Your new All of Us Account\");\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n   @Override\n-  public void sendBetaAccessCompleteEmail(String contactEmail, String username)\n+  public void sendBetaAccessCompleteEmail(final String contactEmail, final String username)\n       throws MessagingException {\n+    final String msgHtml = buildHtml(BETA_ACCESS_RESOURCE, betaAccessSubstitutionMap(username));\n+    final MandrillMessage msg =\n+        buildMessage(contactEmail, msgHtml, \"All of Us ID Verification Complete\");\n+    sendWithRetries(msg, String.format(\"BetaAccess Complete for %s\", contactEmail));\n+  }\n+\n+  private ImmutableMap<String, String> welcomeMessageSubstitutionMap(\n+      final String password, final User user) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"USERNAME\", user.getPrimaryEmail())\n+        .put(\"PASSWORD\", password)\n+        .put(\"URL\", workbenchConfigProvider.get().admin.loginUrl)\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"BULLET_1\", cloudStorageService.getImageUrl(\"bullet_1.png\"))\n+        .put(\"BULLET_2\", cloudStorageService.getImageUrl(\"bullet_2.png\"))\n+        .build();\n+  }\n+\n+  private ImmutableMap<String, String> betaAccessSubstitutionMap(final String username) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5Njk4OQ==", "bodyText": "You can just close the <a/> if you don't want to give separate anchor text from the href.", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369196989", "createdAt": "2020-01-21T19:25:46Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);\n+    final String msgHtml =\n+        buildHtml(WELCOME_RESOURCE, welcomeMessageSubstitutionMap(password, user));\n+    final MandrillMessage msg = buildMessage(contactEmail, msgHtml, \"Your new All of Us Account\");\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n   @Override\n-  public void sendBetaAccessCompleteEmail(String contactEmail, String username)\n+  public void sendBetaAccessCompleteEmail(final String contactEmail, final String username)\n       throws MessagingException {\n+    final String msgHtml = buildHtml(BETA_ACCESS_RESOURCE, betaAccessSubstitutionMap(username));\n+    final MandrillMessage msg =\n+        buildMessage(contactEmail, msgHtml, \"All of Us ID Verification Complete\");\n+    sendWithRetries(msg, String.format(\"BetaAccess Complete for %s\", contactEmail));\n+  }\n+\n+  private ImmutableMap<String, String> welcomeMessageSubstitutionMap(\n+      final String password, final User user) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"USERNAME\", user.getPrimaryEmail())\n+        .put(\"PASSWORD\", password)\n+        .put(\"URL\", workbenchConfigProvider.get().admin.loginUrl)\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"BULLET_1\", cloudStorageService.getImageUrl(\"bullet_1.png\"))\n+        .put(\"BULLET_2\", cloudStorageService.getImageUrl(\"bullet_2.png\"))\n+        .build();\n+  }\n+\n+  private ImmutableMap<String, String> betaAccessSubstitutionMap(final String username) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+\n+    final String action =\n+        \"login to the workbench via <a class=\\\"link\\\" href=\\\"\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"\\\">\"\n+            + workbenchConfigProvider.get().admin.loginUrl", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5Nzc4MQ==", "bodyText": "I'd name this contactInternetAddress", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369197781", "createdAt": "2020-01-21T19:27:20Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);\n+    final String msgHtml =\n+        buildHtml(WELCOME_RESOURCE, welcomeMessageSubstitutionMap(password, user));\n+    final MandrillMessage msg = buildMessage(contactEmail, msgHtml, \"Your new All of Us Account\");\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n   @Override\n-  public void sendBetaAccessCompleteEmail(String contactEmail, String username)\n+  public void sendBetaAccessCompleteEmail(final String contactEmail, final String username)\n       throws MessagingException {\n+    final String msgHtml = buildHtml(BETA_ACCESS_RESOURCE, betaAccessSubstitutionMap(username));\n+    final MandrillMessage msg =\n+        buildMessage(contactEmail, msgHtml, \"All of Us ID Verification Complete\");\n+    sendWithRetries(msg, String.format(\"BetaAccess Complete for %s\", contactEmail));\n+  }\n+\n+  private ImmutableMap<String, String> welcomeMessageSubstitutionMap(\n+      final String password, final User user) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"USERNAME\", user.getPrimaryEmail())\n+        .put(\"PASSWORD\", password)\n+        .put(\"URL\", workbenchConfigProvider.get().admin.loginUrl)\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"BULLET_1\", cloudStorageService.getImageUrl(\"bullet_1.png\"))\n+        .put(\"BULLET_2\", cloudStorageService.getImageUrl(\"bullet_2.png\"))\n+        .build();\n+  }\n+\n+  private ImmutableMap<String, String> betaAccessSubstitutionMap(final String username) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+\n+    final String action =\n+        \"login to the workbench via <a class=\\\"link\\\" href=\\\"\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"\\\">\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"</a>\";\n+\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"ACTION\", action)\n+        .put(\"BETA_ACCESS_REPORT\", \"approved for use\")\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"USERNAME\", username)\n+        .build();\n+  }\n+\n+  private String buildHtml(final String resource, final ImmutableMap<String, String> replacementMap)\n+      throws MessagingException {\n+    final URL emailContent = Resources.getResource(resource);\n+    final StringBuilder contentBuilder = new StringBuilder();\n+\n+    try {\n+      Resources.readLines(emailContent, StandardCharsets.UTF_8)\n+          .forEach(s -> contentBuilder.append(s).append(\"\\n\"));\n+    } catch (IOException e) {\n+      throw new MessagingException(\"Error reading in email\");\n+    }\n+\n+    return new StringSubstitutor(replacementMap).replace(contentBuilder.toString());\n+  }\n+\n+  private MandrillMessage buildMessage(\n+      final String contactEmail, final String msgHtml, final String subject)\n+      throws MessagingException {\n+    return new MandrillMessage()\n+        .to(Collections.singletonList(validatedRecipient(contactEmail)))\n+        .html(msgHtml)\n+        .subject(subject)\n+        .fromEmail(workbenchConfigProvider.get().mandrill.fromEmail);\n+  }\n+\n+  private RecipientAddress validatedRecipient(final String contactEmail) throws MessagingException {\n     try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n+      final InternetAddress email = new InternetAddress(contactEmail);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5OTA4NQ==", "bodyText": "aside: We ought to revisit the user data model. We could have a separate registration table that holds . the start, end, repeat count, etc. This is a couple of degrees removed from the actual user's core state.", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369199085", "createdAt": "2020-01-21T19:30:00Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/billing/FreeTierBillingServiceTest.java", "diffHunk": "@@ -936,6 +933,7 @@ private void assertSingleWorkspaceTestDbState(\n   private DbUser createUser(String email) {\n     DbUser user = new DbUser();\n     user.setUsername(email);\n+    user.setFirstRegistrationCompletionTime(Timestamp.from(START_INSTANT));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE5MTUyNA=="}, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74a858c2e44b32dc9f66ff616c66618be941f3da", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/74a858c2e44b32dc9f66ff616c66618be941f3da", "committedDate": "2020-01-21T21:47:08Z", "message": "use an enum and don't return immutables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8a15c3dc23a96f0d0a28736c181c28356670f01", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/c8a15c3dc23a96f0d0a28736c181c28356670f01", "committedDate": "2020-01-21T21:49:46Z", "message": "contactInternetAddress"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MjA0MTk3", "url": "https://github.com/all-of-us/workbench/pull/3018#pullrequestreview-346204197", "createdAt": "2020-01-21T21:29:18Z", "commit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMToyOToxOFrOFgJY-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMTo0Nzo0N1rOFgJ4ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI1MjYwMA==", "bodyText": "mega nit: I feel like subject, body parameter order is more intuitive than body, subject", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369252600", "createdAt": "2020-01-21T21:29:18Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);\n+    final String msgHtml =\n+        buildHtml(WELCOME_RESOURCE, welcomeMessageSubstitutionMap(password, user));\n+    final MandrillMessage msg = buildMessage(contactEmail, msgHtml, \"Your new All of Us Account\");\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n   @Override\n-  public void sendBetaAccessCompleteEmail(String contactEmail, String username)\n+  public void sendBetaAccessCompleteEmail(final String contactEmail, final String username)\n       throws MessagingException {\n+    final String msgHtml = buildHtml(BETA_ACCESS_RESOURCE, betaAccessSubstitutionMap(username));\n+    final MandrillMessage msg =\n+        buildMessage(contactEmail, msgHtml, \"All of Us ID Verification Complete\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI1MjY2OQ==", "bodyText": "Beta Access?", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369252669", "createdAt": "2020-01-21T21:29:27Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);\n+    final String msgHtml =\n+        buildHtml(WELCOME_RESOURCE, welcomeMessageSubstitutionMap(password, user));\n+    final MandrillMessage msg = buildMessage(contactEmail, msgHtml, \"Your new All of Us Account\");\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n   @Override\n-  public void sendBetaAccessCompleteEmail(String contactEmail, String username)\n+  public void sendBetaAccessCompleteEmail(final String contactEmail, final String username)\n       throws MessagingException {\n+    final String msgHtml = buildHtml(BETA_ACCESS_RESOURCE, betaAccessSubstitutionMap(username));\n+    final MandrillMessage msg =\n+        buildMessage(contactEmail, msgHtml, \"All of Us ID Verification Complete\");\n+    sendWithRetries(msg, String.format(\"BetaAccess Complete for %s\", contactEmail));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI1NTYzNQ==", "bodyText": "nit: I like to relax the type for arguments down to the superclass that has the interface that I need. In this case, I'm guessing a Map<String, String> will do.", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369255635", "createdAt": "2020-01-21T21:36:12Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);\n+    final String msgHtml =\n+        buildHtml(WELCOME_RESOURCE, welcomeMessageSubstitutionMap(password, user));\n+    final MandrillMessage msg = buildMessage(contactEmail, msgHtml, \"Your new All of Us Account\");\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n   @Override\n-  public void sendBetaAccessCompleteEmail(String contactEmail, String username)\n+  public void sendBetaAccessCompleteEmail(final String contactEmail, final String username)\n       throws MessagingException {\n+    final String msgHtml = buildHtml(BETA_ACCESS_RESOURCE, betaAccessSubstitutionMap(username));\n+    final MandrillMessage msg =\n+        buildMessage(contactEmail, msgHtml, \"All of Us ID Verification Complete\");\n+    sendWithRetries(msg, String.format(\"BetaAccess Complete for %s\", contactEmail));\n+  }\n+\n+  private ImmutableMap<String, String> welcomeMessageSubstitutionMap(\n+      final String password, final User user) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"USERNAME\", user.getPrimaryEmail())\n+        .put(\"PASSWORD\", password)\n+        .put(\"URL\", workbenchConfigProvider.get().admin.loginUrl)\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"BULLET_1\", cloudStorageService.getImageUrl(\"bullet_1.png\"))\n+        .put(\"BULLET_2\", cloudStorageService.getImageUrl(\"bullet_2.png\"))\n+        .build();\n+  }\n+\n+  private ImmutableMap<String, String> betaAccessSubstitutionMap(final String username) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+\n+    final String action =\n+        \"login to the workbench via <a class=\\\"link\\\" href=\\\"\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"\\\">\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"</a>\";\n+\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"ACTION\", action)\n+        .put(\"BETA_ACCESS_REPORT\", \"approved for use\")\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"USERNAME\", username)\n+        .build();\n+  }\n+\n+  private String buildHtml(final String resource, final ImmutableMap<String, String> replacementMap)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI1NjQ0Mg==", "bodyText": "nit: my first thought on reading emailContent as a name was that it contained the email data.", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369256442", "createdAt": "2020-01-21T21:38:05Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);\n+    final String msgHtml =\n+        buildHtml(WELCOME_RESOURCE, welcomeMessageSubstitutionMap(password, user));\n+    final MandrillMessage msg = buildMessage(contactEmail, msgHtml, \"Your new All of Us Account\");\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n   @Override\n-  public void sendBetaAccessCompleteEmail(String contactEmail, String username)\n+  public void sendBetaAccessCompleteEmail(final String contactEmail, final String username)\n       throws MessagingException {\n+    final String msgHtml = buildHtml(BETA_ACCESS_RESOURCE, betaAccessSubstitutionMap(username));\n+    final MandrillMessage msg =\n+        buildMessage(contactEmail, msgHtml, \"All of Us ID Verification Complete\");\n+    sendWithRetries(msg, String.format(\"BetaAccess Complete for %s\", contactEmail));\n+  }\n+\n+  private ImmutableMap<String, String> welcomeMessageSubstitutionMap(\n+      final String password, final User user) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"USERNAME\", user.getPrimaryEmail())\n+        .put(\"PASSWORD\", password)\n+        .put(\"URL\", workbenchConfigProvider.get().admin.loginUrl)\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"BULLET_1\", cloudStorageService.getImageUrl(\"bullet_1.png\"))\n+        .put(\"BULLET_2\", cloudStorageService.getImageUrl(\"bullet_2.png\"))\n+        .build();\n+  }\n+\n+  private ImmutableMap<String, String> betaAccessSubstitutionMap(final String username) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+\n+    final String action =\n+        \"login to the workbench via <a class=\\\"link\\\" href=\\\"\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"\\\">\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"</a>\";\n+\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"ACTION\", action)\n+        .put(\"BETA_ACCESS_REPORT\", \"approved for use\")\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"USERNAME\", username)\n+        .build();\n+  }\n+\n+  private String buildHtml(final String resource, final ImmutableMap<String, String> replacementMap)\n+      throws MessagingException {\n+    final URL emailContent = Resources.getResource(resource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI1ODYzMQ==", "bodyText": "nit: I think we can 1 line this with something like\n    return new StringSubstitutor(replacementMap)\n        .replace(Resources.readLines(null, StandardCharsets.UTF_8)\n            .stream()\n            .collect(Collectors.joining(\"\\n\")));\n\nTBD if that's actually more readable but maybe there's something in the middle that you like.", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369258631", "createdAt": "2020-01-21T21:43:04Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);\n+    final String msgHtml =\n+        buildHtml(WELCOME_RESOURCE, welcomeMessageSubstitutionMap(password, user));\n+    final MandrillMessage msg = buildMessage(contactEmail, msgHtml, \"Your new All of Us Account\");\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n   @Override\n-  public void sendBetaAccessCompleteEmail(String contactEmail, String username)\n+  public void sendBetaAccessCompleteEmail(final String contactEmail, final String username)\n       throws MessagingException {\n+    final String msgHtml = buildHtml(BETA_ACCESS_RESOURCE, betaAccessSubstitutionMap(username));\n+    final MandrillMessage msg =\n+        buildMessage(contactEmail, msgHtml, \"All of Us ID Verification Complete\");\n+    sendWithRetries(msg, String.format(\"BetaAccess Complete for %s\", contactEmail));\n+  }\n+\n+  private ImmutableMap<String, String> welcomeMessageSubstitutionMap(\n+      final String password, final User user) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"USERNAME\", user.getPrimaryEmail())\n+        .put(\"PASSWORD\", password)\n+        .put(\"URL\", workbenchConfigProvider.get().admin.loginUrl)\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"BULLET_1\", cloudStorageService.getImageUrl(\"bullet_1.png\"))\n+        .put(\"BULLET_2\", cloudStorageService.getImageUrl(\"bullet_2.png\"))\n+        .build();\n+  }\n+\n+  private ImmutableMap<String, String> betaAccessSubstitutionMap(final String username) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+\n+    final String action =\n+        \"login to the workbench via <a class=\\\"link\\\" href=\\\"\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"\\\">\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"</a>\";\n+\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"ACTION\", action)\n+        .put(\"BETA_ACCESS_REPORT\", \"approved for use\")\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"USERNAME\", username)\n+        .build();\n+  }\n+\n+  private String buildHtml(final String resource, final ImmutableMap<String, String> replacementMap)\n+      throws MessagingException {\n+    final URL emailContent = Resources.getResource(resource);\n+    final StringBuilder contentBuilder = new StringBuilder();\n+\n+    try {\n+      Resources.readLines(emailContent, StandardCharsets.UTF_8)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI2MDY4Mg==", "bodyText": "nit: I actually find it easier to just read the implementation of this function. There isn't too much abstraction here and if anything, I need to jump to a definition to find out what the arguments of buildMessage do. The implementation has it declared in a fairly succinct and readable way.", "url": "https://github.com/all-of-us/workbench/pull/3018#discussion_r369260682", "createdAt": "2020-01-21T21:47:47Z", "author": {"login": "ericsong"}, "path": "api/src/main/java/org/pmiops/workbench/mail/MailServiceImpl.java", "diffHunk": "@@ -69,29 +69,89 @@ public void sendBetaAccessRequestEmail(String userName) throws MessagingExceptio\n   }\n \n   @Override\n-  public void sendWelcomeEmail(String contactEmail, String password, User user)\n+  public void sendWelcomeEmail(final String contactEmail, final String password, final User user)\n       throws MessagingException {\n-    try {\n-      InternetAddress email = new InternetAddress(contactEmail);\n-      email.validate();\n-    } catch (AddressException e) {\n-      throw new MessagingException(\"Email: \" + contactEmail + \" is invalid.\");\n-    }\n-    MandrillMessage msg = buildWelcomeMessage(contactEmail, password, user);\n+    final String msgHtml =\n+        buildHtml(WELCOME_RESOURCE, welcomeMessageSubstitutionMap(password, user));\n+    final MandrillMessage msg = buildMessage(contactEmail, msgHtml, \"Your new All of Us Account\");\n     sendWithRetries(msg, String.format(\"Welcome for %s\", user.getName()));\n   }\n \n   @Override\n-  public void sendBetaAccessCompleteEmail(String contactEmail, String username)\n+  public void sendBetaAccessCompleteEmail(final String contactEmail, final String username)\n       throws MessagingException {\n+    final String msgHtml = buildHtml(BETA_ACCESS_RESOURCE, betaAccessSubstitutionMap(username));\n+    final MandrillMessage msg =\n+        buildMessage(contactEmail, msgHtml, \"All of Us ID Verification Complete\");\n+    sendWithRetries(msg, String.format(\"BetaAccess Complete for %s\", contactEmail));\n+  }\n+\n+  private ImmutableMap<String, String> welcomeMessageSubstitutionMap(\n+      final String password, final User user) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"USERNAME\", user.getPrimaryEmail())\n+        .put(\"PASSWORD\", password)\n+        .put(\"URL\", workbenchConfigProvider.get().admin.loginUrl)\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"BULLET_1\", cloudStorageService.getImageUrl(\"bullet_1.png\"))\n+        .put(\"BULLET_2\", cloudStorageService.getImageUrl(\"bullet_2.png\"))\n+        .build();\n+  }\n+\n+  private ImmutableMap<String, String> betaAccessSubstitutionMap(final String username) {\n+    final CloudStorageService cloudStorageService = cloudStorageServiceProvider.get();\n+\n+    final String action =\n+        \"login to the workbench via <a class=\\\"link\\\" href=\\\"\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"\\\">\"\n+            + workbenchConfigProvider.get().admin.loginUrl\n+            + \"</a>\";\n+\n+    return new ImmutableMap.Builder<String, String>()\n+        .put(\"ACTION\", action)\n+        .put(\"BETA_ACCESS_REPORT\", \"approved for use\")\n+        .put(\"HEADER_IMG\", cloudStorageService.getImageUrl(\"all_of_us_logo.png\"))\n+        .put(\"USERNAME\", username)\n+        .build();\n+  }\n+\n+  private String buildHtml(final String resource, final ImmutableMap<String, String> replacementMap)\n+      throws MessagingException {\n+    final URL emailContent = Resources.getResource(resource);\n+    final StringBuilder contentBuilder = new StringBuilder();\n+\n+    try {\n+      Resources.readLines(emailContent, StandardCharsets.UTF_8)\n+          .forEach(s -> contentBuilder.append(s).append(\"\\n\"));\n+    } catch (IOException e) {\n+      throw new MessagingException(\"Error reading in email\");\n+    }\n+\n+    return new StringSubstitutor(replacementMap).replace(contentBuilder.toString());\n+  }\n+\n+  private MandrillMessage buildMessage(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "270f296cd61fa70ec2dc37f5a15c70b547c416bc"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa70e06729965d1e5cef3f9e4827f504f9998ad2", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/fa70e06729965d1e5cef3f9e4827f504f9998ad2", "committedDate": "2020-01-21T22:04:02Z", "message": "review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3704, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}