{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczNTU0NTI5", "number": 3919, "title": "[RW-4847][risk=low] Support Swagger 3 codegen, partially migrate notebooks.yaml", "bodyText": "Part 2 of 2 for supporting Swagger3 (follow-up to #3907).\nChanges\n\nThis PR should be a no-op in terms of application behavior\nSupport Swagger 3 codegen, in parallel with swagger 2\nFork and rebase our custom swagger2 templates onto the Swagger 3 templates\n\nNote: some changes to the files and file locations were needed to support the template renderer\n\n\nImport the new Leo OAS3 yaml with some noted modifications\nMigrate our server-side usage of the Cluster APIs to the new spec, removing overlapping sections of notebooks.yaml\nContinues to use the \"Cluster\" APIs, this PR does not yet switch us to the \"Runtime\" APIs\nFixed status check API to actually use the proper baseUrl for the current environment\n\nFollow-up work\n\nInvestigate typescript codegen for Swagger 3; currently client code still depends on some cluster/notebook APIs.\nSwitch to the new \"Runtime\" API variants\nModel prefixes appear to be broken for Swagger3 codegen, would be nice to use this for Leo's APIs.\nDeal with oneOfs in the Leo spec\nConsider better distinguishing between Leo and Jupyter/Welder APIs.", "createdAt": "2020-08-25T23:17:34Z", "url": "https://github.com/all-of-us/workbench/pull/3919", "merged": true, "mergeCommit": {"oid": "654f7a5a4d4dad5b09f80ebdd16be6a333737c08"}, "closed": true, "closedAt": "2020-08-26T22:31:17Z", "author": {"login": "calbach"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCac5rgH2gAyNDczNTU0NTI5OjBjZDMwM2RkOTM3Y2U5MTRkNDk2NTg3MWIwNDkyNDE3YjliNmRjMjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCy0XWAFqTQ3NTg3MTAwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0cd303dd937ce914d4965871b0492417b9b6dc28", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/0cd303dd937ce914d4965871b0492417b9b6dc28", "committedDate": "2020-08-25T17:14:11Z", "message": "Support swagger3 plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab948c3f02090c96935bfbe399205fc56663d812", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/ab948c3f02090c96935bfbe399205fc56663d812", "committedDate": "2020-08-25T23:01:55Z", "message": "Switch to Leo Swagger 3 API"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MDQ5MTU1", "url": "https://github.com/all-of-us/workbench/pull/3919#pullrequestreview-475049155", "createdAt": "2020-08-25T23:19:27Z", "commit": {"oid": "ab948c3f02090c96935bfbe399205fc56663d812"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQyMzoxOToyN1rOHGwZtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQyMzoxOToyN1rOHGwZtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Njg0NjUxOQ==", "bodyText": "@gjuggler FYI, I have spawned an additional set of templates here to support swagger 3. The patch was relatively straightforward to apply against the swagger3 codegen - these templates didn't change much.", "url": "https://github.com/all-of-us/workbench/pull/3919#discussion_r476846519", "createdAt": "2020-08-25T23:19:27Z", "author": {"login": "calbach"}, "path": "api/src/main/resources/swagger3codegen/aouTracedMethodCall.mustache", "diffHunk": "@@ -0,0 +1,34 @@\n+        // Generate an OpenCensus tracing span for this API method call.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab948c3f02090c96935bfbe399205fc56663d812"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bff86631f6415966f40af16ee46e8b8b33750f9", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/6bff86631f6415966f40af16ee46e8b8b33750f9", "committedDate": "2020-08-26T00:19:18Z", "message": "Fix test compilation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e640e94d639ff85aa2ba588834839e9f53a2943", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/1e640e94d639ff85aa2ba588834839e9f53a2943", "committedDate": "2020-08-26T00:43:10Z", "message": "skip swagger3 validation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODM0MDUy", "url": "https://github.com/all-of-us/workbench/pull/3919#pullrequestreview-475834052", "createdAt": "2020-08-26T20:27:59Z", "commit": {"oid": "1e640e94d639ff85aa2ba588834839e9f53a2943"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDoyNzo1OVrOHHchjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDoyNzo1OVrOHHchjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU2OTQyMA==", "bodyText": "so... are we using one API for the Jupyter/Welder proxy calls and a different one for the non-proxy Leonardo endpoints?", "url": "https://github.com/all-of-us/workbench/pull/3919#discussion_r477569420", "createdAt": "2020-08-26T20:27:59Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/notebooks/NotebooksConfig.java", "diffHunk": "@@ -20,8 +20,13 @@\n public class NotebooksConfig {\n   public static final String USER_CLUSTER_API = \"userClusterApi\";\n   public static final String SERVICE_CLUSTER_API = \"svcClusterApi\";\n+\n+  // Identifiers for the older Swagger2 APIs for Jupyter and Welder.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1e640e94d639ff85aa2ba588834839e9f53a2943"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67bdffe847333720aae7317e1d51c1cef3e6b832", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/67bdffe847333720aae7317e1d51c1cef3e6b832", "committedDate": "2020-08-26T21:34:10Z", "message": "PR feedback, fix integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7476b488ed7a36ffb18392723f8a75dfc8e5dfc2", "author": {"user": {"login": "calbach", "name": "CH Albach"}}, "url": "https://github.com/all-of-us/workbench/commit/7476b488ed7a36ffb18392723f8a75dfc8e5dfc2", "committedDate": "2020-08-26T21:36:13Z", "message": "rename the retry policy too"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODcxMDA2", "url": "https://github.com/all-of-us/workbench/pull/3919#pullrequestreview-475871006", "createdAt": "2020-08-26T21:26:06Z", "commit": {"oid": "1e640e94d639ff85aa2ba588834839e9f53a2943"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMToyNjowN1rOHHeUpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMTozNzoyNlrOHHeojw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU5ODg4NA==", "bodyText": "Yep, clarified comment.", "url": "https://github.com/all-of-us/workbench/pull/3919#discussion_r477598884", "createdAt": "2020-08-26T21:26:07Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/notebooks/NotebooksConfig.java", "diffHunk": "@@ -20,8 +20,13 @@\n public class NotebooksConfig {\n   public static final String USER_CLUSTER_API = \"userClusterApi\";\n   public static final String SERVICE_CLUSTER_API = \"svcClusterApi\";\n+\n+  // Identifiers for the older Swagger2 APIs for Jupyter and Welder.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU2OTQyMA=="}, "originalCommit": {"oid": "1e640e94d639ff85aa2ba588834839e9f53a2943"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYwMzAyMQ==", "bodyText": "RE generateSwaggerCode: see new comment here", "url": "https://github.com/all-of-us/workbench/pull/3919#discussion_r477603021", "createdAt": "2020-08-26T21:35:13Z", "author": {"login": "calbach"}, "path": "api/build.gradle", "diffHunk": "@@ -299,15 +339,18 @@ classes.dependsOn 'generatedClasses'\n project.tasks.ideaModule.dependsOn(generateSwaggerCode)\n \n // Java plugin's Generated Source Set gives us the compileGeneratedJava task.\n-// We need to provide it with the swagger-codegen tasks that output Java.\n+// We need to provide it with the swagger-codegen tasks that output Java; this", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67bdffe847333720aae7317e1d51c1cef3e6b832"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYwMzY4Mg==", "bodyText": "RE notebooks.yaml: good catch, fixed.", "url": "https://github.com/all-of-us/workbench/pull/3919#discussion_r477603682", "createdAt": "2020-08-26T21:36:48Z", "author": {"login": "calbach"}, "path": "api/src/main/resources/notebooks.yaml", "diffHunk": "@@ -1,7 +1,11 @@\n # This file is a hand-crafted combination of Leo and its proxy APIs.\n-#  - All of Leo: https://github.com/broadinstitute/leonardo/blob/develop/src/main/resources/swagger/api-docs.yaml\n #  - A subset of Welder (modified for cluster/path prefix): https://github.com/DataBiosphere/welder/blob/master/server/src/main/resources/api-docs.yaml\n #  - A subset of Jupyter (modified for cluster/path prefix): https://github.com/jupyter/notebook/blob/master/notebook/services/api/api.yaml\n+#\n+# TODO(calbach): Remove the following once the client-side codegen can support", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67bdffe847333720aae7317e1d51c1cef3e6b832"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYwMzk4Mw==", "bodyText": "APparently this status API was exclusively checking prod... nice... Fixed that, which should resolve the integration test issues.", "url": "https://github.com/all-of-us/workbench/pull/3919#discussion_r477603983", "createdAt": "2020-08-26T21:37:26Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/notebooks/LeonardoNotebooksClientImpl.java", "diffHunk": "@@ -214,15 +222,15 @@ public void localize(String googleProject, String clusterName, Map<String, Strin\n   public StorageLink createStorageLink(\n       String googleProject, String clusterName, StorageLink storageLink) {\n     NotebooksApi notebooksApi = notebooksApiProvider.get();\n-    return retryHandler.run(\n+    return notebooksRetryHandler.run(\n         (context) -> notebooksApi.welderCreateStorageLink(googleProject, clusterName, storageLink));\n   }\n \n   @Override\n   public boolean getNotebooksStatus() {\n     try {\n-      new StatusApi().getSystemStatus();\n-    } catch (ApiException e) {\n+      serviceInfoApiProvider.get().getSystemStatus();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67bdffe847333720aae7317e1d51c1cef3e6b832"}, "originalPosition": 150}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4349, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}