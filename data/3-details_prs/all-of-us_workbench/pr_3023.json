{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1OTY2MDY0", "number": 3023, "title": "[RW-4314][risk=no] Gauge metric for GSuite Domain Account Count", "bodyText": "The closest API I could find for this information was the Users List API. There's no count or summary I could find, so I'm hitting it with the max page size of 500 and then fetching more. I might be able to reduce the size of each user returned using the fields attribute.\nI put a label on the gauge for the domain name. This is both a reminder and for future-proofness, in case we wanted to have multiple domains per environment or somehow look at multiple environments in the same chart someday. We don't expect either of those to happen yet.\nHere's a screen shot with it in action.\n\nStackdriver dashboard link.\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-01-22T17:07:00Z", "url": "https://github.com/all-of-us/workbench/pull/3023", "merged": true, "mergeCommit": {"oid": "500b88169400626c3851901cf3ce58fb1174cece"}, "closed": true, "closedAt": "2020-01-30T18:42:50Z", "author": {"login": "jaycarlton"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb84x7MAH2gAyMzY1OTY2MDY0OjY5MDgwNWQxNWRhYTkyYjExMDMzOGJiYjk5MjhkYmI3N2IzNmE4ZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_eMs5gFqTM1MTAxMzAzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "690805d15daa92b110338bbb9928dbb77b36a8d1", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/690805d15daa92b110338bbb9928dbb77b36a8d1", "committedDate": "2020-01-22T16:59:36Z", "message": "implement gsuite user count gauge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NzU1ODgx", "url": "https://github.com/all-of-us/workbench/pull/3023#pullrequestreview-346755881", "createdAt": "2020-01-22T17:08:25Z", "commit": {"oid": "690805d15daa92b110338bbb9928dbb77b36a8d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNzowODoyNVrOFgkAqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNzowODoyNVrOFgkAqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY4ODc0Ng==", "bodyText": "I don't know of a good way to write a reasonable test case for this logic", "url": "https://github.com/all-of-us/workbench/pull/3023#discussion_r369688746", "createdAt": "2020-01-22T17:08:25Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/google/DirectoryServiceImpl.java", "diffHunk": "@@ -239,6 +252,38 @@ public void deleteUser(String username) {\n     }\n   }\n \n+  @Override\n+  public Collection<MeasurementBundle> getGaugeData() {\n+    long userCount = 0;\n+    try {\n+      final Directory directoryService = getGoogleDirectoryService();\n+      Optional<String> nextPageToken = Optional.empty();\n+      do {\n+        final Directory.Users.List listQuery = directoryService", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "690805d15daa92b110338bbb9928dbb77b36a8d1"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/c789edace4200b8ceae2f7e42e57b6c115c9cf89", "committedDate": "2020-01-22T17:13:16Z", "message": "spotlless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NzYwMDYz", "url": "https://github.com/all-of-us/workbench/pull/3023#pullrequestreview-346760063", "createdAt": "2020-01-22T17:14:37Z", "commit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNzoxNDozN1rOFgkNPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNzoxNDozN1rOFgkNPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY5MTk2Ng==", "bodyText": "Do we have a place in the GSuite Admin UI where I can verify this value? Looks like 660 for fake-research-aou.org.", "url": "https://github.com/all-of-us/workbench/pull/3023#discussion_r369691966", "createdAt": "2020-01-22T17:14:37Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/google/DirectoryServiceImpl.java", "diffHunk": "@@ -239,6 +252,40 @@ public void deleteUser(String username) {\n     }\n   }\n \n+  @Override\n+  public Collection<MeasurementBundle> getGaugeData() {\n+    long userCount = 0;\n+    try {\n+      final Directory directoryService = getGoogleDirectoryService();\n+      Optional<String> nextPageToken = Optional.empty();\n+      do {\n+        final Directory.Users.List listQuery =\n+            directoryService\n+                .users()\n+                .list()\n+                .setDomain(gSuiteDomain())\n+                .setViewType(USER_VIEW_TYPE)\n+                .setMaxResults(MAX_USERS_LIST_PAGE_SIZE)\n+                .setOrderBy(EMAIL_USER_FIELD);\n+        nextPageToken.ifPresent(listQuery::setPageToken);\n+\n+        final Users usersQueryResult = listQuery.execute();\n+\n+        userCount += usersQueryResult.getUsers().size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTIwMTUy", "url": "https://github.com/all-of-us/workbench/pull/3023#pullrequestreview-348120152", "createdAt": "2020-01-24T17:49:45Z", "commit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNzo0OTo0NlrOFhldxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxODowMDowOVrOFhlu7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2MTE1OQ==", "bodyText": "custom view type with a projection of just primaryEmail is probably better, as you mention in your PR description - especially if this is running frequently. I also don't see a better API for counting", "url": "https://github.com/all-of-us/workbench/pull/3023#discussion_r370761159", "createdAt": "2020-01-24T17:49:46Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/google/DirectoryServiceImpl.java", "diffHunk": "@@ -239,6 +252,40 @@ public void deleteUser(String username) {\n     }\n   }\n \n+  @Override\n+  public Collection<MeasurementBundle> getGaugeData() {\n+    long userCount = 0;\n+    try {\n+      final Directory directoryService = getGoogleDirectoryService();\n+      Optional<String> nextPageToken = Optional.empty();\n+      do {\n+        final Directory.Users.List listQuery =\n+            directoryService\n+                .users()\n+                .list()\n+                .setDomain(gSuiteDomain())\n+                .setViewType(USER_VIEW_TYPE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2MzMxMg==", "bodyText": "I don't see an easy way - best thing I found is to go to the users page, then \"download users\" to get them as CSV:", "url": "https://github.com/all-of-us/workbench/pull/3023#discussion_r370763312", "createdAt": "2020-01-24T17:54:46Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/google/DirectoryServiceImpl.java", "diffHunk": "@@ -239,6 +252,40 @@ public void deleteUser(String username) {\n     }\n   }\n \n+  @Override\n+  public Collection<MeasurementBundle> getGaugeData() {\n+    long userCount = 0;\n+    try {\n+      final Directory directoryService = getGoogleDirectoryService();\n+      Optional<String> nextPageToken = Optional.empty();\n+      do {\n+        final Directory.Users.List listQuery =\n+            directoryService\n+                .users()\n+                .list()\n+                .setDomain(gSuiteDomain())\n+                .setViewType(USER_VIEW_TYPE)\n+                .setMaxResults(MAX_USERS_LIST_PAGE_SIZE)\n+                .setOrderBy(EMAIL_USER_FIELD);\n+        nextPageToken.ifPresent(listQuery::setPageToken);\n+\n+        final Users usersQueryResult = listQuery.execute();\n+\n+        userCount += usersQueryResult.getUsers().size();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTY5MTk2Ng=="}, "originalCommit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2NDg1Mw==", "bodyText": "This domain restriction is correct, but not the target we want to directly alert on. The gsuite user capacity is dictated by the total number of users in a gsuite domain - which for fake-research-aou.org covers test, perf, staging, stable. So the alert would need to be driven on the sum of those user counts. So you'd need to either sum these values together across projects and alert on that (if that's possible), or just remove the domain restriction here, or else export both of these metrics but only alert on the total gsuite count.", "url": "https://github.com/all-of-us/workbench/pull/3023#discussion_r370764853", "createdAt": "2020-01-24T17:58:27Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/google/DirectoryServiceImpl.java", "diffHunk": "@@ -239,6 +252,40 @@ public void deleteUser(String username) {\n     }\n   }\n \n+  @Override\n+  public Collection<MeasurementBundle> getGaugeData() {\n+    long userCount = 0;\n+    try {\n+      final Directory directoryService = getGoogleDirectoryService();\n+      Optional<String> nextPageToken = Optional.empty();\n+      do {\n+        final Directory.Users.List listQuery =\n+            directoryService\n+                .users()\n+                .list()\n+                .setDomain(gSuiteDomain())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2NTU0OA==", "bodyText": "the formatter butchered this a bit, probably move the comment before the enum value instead", "url": "https://github.com/all-of-us/workbench/pull/3023#discussion_r370765548", "createdAt": "2020-01-24T18:00:09Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/monitoring/attachments/MetricLabel.java", "diffHunk": "@@ -10,9 +10,12 @@\n public enum MetricLabel implements MetricLabelBase {\n   BUFFER_ENTRY_STATUS(\"BufferEntryStatus\", Enums.getValueStrings(BufferEntryStatus.class)),\n   DATASET_INVALID(\"Invalid\", Booleans.VALUE_STRINGS),\n+  DATA_ACCESS_LEVEL(\"DataAccessLevel\", Enums.getValueStrings(DataAccessLevel.class)),\n+  GSUITE_DOMAIN(\n+      \"gsuite_domain\"), // provide this (slightly redundant) in case we ever merge time series", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24f4ade57be2badf99bb0719f7b17bf34897ce5f", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/24f4ade57be2badf99bb0719f7b17bf34897ce5f", "committedDate": "2020-01-24T19:22:52Z", "message": "Merge branch 'master' into jaycarlton/RW-4314"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0622d9b66cf382545fba1a19cb7f2e88a932c22d", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/0622d9b66cf382545fba1a19cb7f2e88a932c22d", "committedDate": "2020-01-24T21:50:31Z", "message": "report both lower-level and upper-level domains, if present"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d24456338d9a7bf6a3a3b27545d348dcbcf8e24", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/9d24456338d9a7bf6a3a3b27545d348dcbcf8e24", "committedDate": "2020-01-28T15:51:30Z", "message": "merge master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bcd1463cd1e530f3c4fd7c76b6a9240cf122028", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/6bcd1463cd1e530f3c4fd7c76b6a9240cf122028", "committedDate": "2020-01-28T16:00:16Z", "message": "factor out a bit of common code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTc0MTQ5", "url": "https://github.com/all-of-us/workbench/pull/3023#pullrequestreview-348174149", "createdAt": "2020-01-24T19:27:17Z", "commit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxOToyNzoxN1rOFhoDRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxNTo1Mzo1NlrOFiqX6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgwMzUyNQ==", "bodyText": "I can give both with different labels.\nFor perf, instead of perf.fake-research-aou.org, you would just get fake-research-aou.org.", "url": "https://github.com/all-of-us/workbench/pull/3023#discussion_r370803525", "createdAt": "2020-01-24T19:27:17Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/google/DirectoryServiceImpl.java", "diffHunk": "@@ -239,6 +252,40 @@ public void deleteUser(String username) {\n     }\n   }\n \n+  @Override\n+  public Collection<MeasurementBundle> getGaugeData() {\n+    long userCount = 0;\n+    try {\n+      final Directory directoryService = getGoogleDirectoryService();\n+      Optional<String> nextPageToken = Optional.empty();\n+      do {\n+        final Directory.Users.List listQuery =\n+            directoryService\n+                .users()\n+                .list()\n+                .setDomain(gSuiteDomain())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2NDg1Mw=="}, "originalCommit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg4MjY0Mg==", "bodyText": "I don't see a way to use only a subset fo the basic fields. Looks like projection and customFieldMask only deal with hiding selected custom fields.\nhttps://developers.google.com/admin-sdk/directory/v1/reference/users/list\nThis only runs every minute. I don't see a rate limit specifically for this list API or any other read-only operations at https://developers.google.com/admin-sdk/directory/v1/limits", "url": "https://github.com/all-of-us/workbench/pull/3023#discussion_r371882642", "createdAt": "2020-01-28T15:43:08Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/google/DirectoryServiceImpl.java", "diffHunk": "@@ -239,6 +252,40 @@ public void deleteUser(String username) {\n     }\n   }\n \n+  @Override\n+  public Collection<MeasurementBundle> getGaugeData() {\n+    long userCount = 0;\n+    try {\n+      final Directory directoryService = getGoogleDirectoryService();\n+      Optional<String> nextPageToken = Optional.empty();\n+      do {\n+        final Directory.Users.List listQuery =\n+            directoryService\n+                .users()\n+                .list()\n+                .setDomain(gSuiteDomain())\n+                .setViewType(USER_VIEW_TYPE)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2MTE1OQ=="}, "originalCommit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTg5MDE1Mw==", "bodyText": "I'll have to wait for this to deploy to another environment where the top isn't the same as the environment domain to verify this logic.", "url": "https://github.com/all-of-us/workbench/pull/3023#discussion_r371890153", "createdAt": "2020-01-28T15:53:56Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/google/DirectoryServiceImpl.java", "diffHunk": "@@ -252,6 +275,60 @@ public void deleteUser(String username) {\n     }\n   }\n \n+  @Override\n+  public Collection<MeasurementBundle> getGaugeData() {\n+    ImmutableSet.Builder<MeasurementBundle> resultBuilder = ImmutableSet.builder();\n+\n+    final String localDomain = gSuiteDomain();\n+    final long localDomainUserCount = countUsersInDomain(localDomain);\n+    resultBuilder.add(\n+        MeasurementBundle.builder()\n+            .addMeasurement(GaugeMetric.GSUITE_USER_COUNT, localDomainUserCount)\n+            .addTag(MetricLabel.GSUITE_DOMAIN, localDomain)\n+            .build());\n+\n+    final String topLevelDomain = getTopLevelGSuiteDomain();\n+    // Avoid creating duplicate data point if the local domain is the top domain\n+    if (!localDomain.equals(topLevelDomain)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d24456338d9a7bf6a3a3b27545d348dcbcf8e24"}, "originalPosition": 90}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMDEzMDM0", "url": "https://github.com/all-of-us/workbench/pull/3023#pullrequestreview-351013034", "createdAt": "2020-01-30T17:37:51Z", "commit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNzozNzo1MVrOFjzy1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNzozNzo1MVrOFjzy1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA5MzA3OQ==", "bodyText": "Ah, I see that it doesn't apply to the basic fields - misunderstood the docs for this. Yeah - sounds fine.", "url": "https://github.com/all-of-us/workbench/pull/3023#discussion_r373093079", "createdAt": "2020-01-30T17:37:51Z", "author": {"login": "calbach"}, "path": "api/src/main/java/org/pmiops/workbench/google/DirectoryServiceImpl.java", "diffHunk": "@@ -239,6 +252,40 @@ public void deleteUser(String username) {\n     }\n   }\n \n+  @Override\n+  public Collection<MeasurementBundle> getGaugeData() {\n+    long userCount = 0;\n+    try {\n+      final Directory directoryService = getGoogleDirectoryService();\n+      Optional<String> nextPageToken = Optional.empty();\n+      do {\n+        final Directory.Users.List listQuery =\n+            directoryService\n+                .users()\n+                .list()\n+                .setDomain(gSuiteDomain())\n+                .setViewType(USER_VIEW_TYPE)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc2MTE1OQ=="}, "originalCommit": {"oid": "c789edace4200b8ceae2f7e42e57b6c115c9cf89"}, "originalPosition": 70}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3715, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}