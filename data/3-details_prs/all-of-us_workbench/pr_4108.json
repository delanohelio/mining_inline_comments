{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2OTkwOTYx", "number": 4108, "title": "[RW-5494][risk=no] Reporting SQL queries for  ad hoc analysis in  BigQuery", "bodyText": "See markdown file included in this  PR for description and sample outputs.\nSome graphical outputs in  BQ:\n\n\n\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test-local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-10-02T15:48:27Z", "url": "https://github.com/all-of-us/workbench/pull/4108", "merged": true, "mergeCommit": {"oid": "95532592f14d5e8cab3be01b3d0a122651033df9"}, "closed": true, "closedAt": "2020-10-02T20:56:59Z", "author": {"login": "jaycarlton"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOoXt6gFqTUwMTI2NDg3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOsL43gBqjM4MzU1ODAyMTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjY0ODc5", "url": "https://github.com/all-of-us/workbench/pull/4108#pullrequestreview-501264879", "createdAt": "2020-10-02T16:07:15Z", "commit": {"oid": "d9911d49b97bc8d4d6fbac421941094951122c29"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjowNzoxNVrOHbzUOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxNjoxMzozMFrOHbzgtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNDM2MQ==", "bodyText": "Is there a reason to refer to the user table here instead of the cohort table for pulling the latest snapshot timestamp? It might be clearer to keep the subquery within the same table.", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r498914361", "createdAt": "2020-10-02T16:07:15Z", "author": {"login": "gjuggler"}, "path": "api/reporting/queries/live/latest_table_views/latest_cohorts.sql", "diffHunk": "@@ -0,0 +1,13 @@\n+-- All cohorts from the most recent snapshot\n+SELECT\n+    c.*\n+FROM\n+    reporting_test.cohort c\n+WHERE\n+        c.snapshot_timestamp = (\n+        SELECT\n+            MAX(u2.snapshot_timestamp)\n+        FROM\n+            reporting_test.user u2)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9911d49b97bc8d4d6fbac421941094951122c29"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNTAxMA==", "bodyText": "nit: remove extra 'i'", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r498915010", "createdAt": "2020-10-02T16:08:29Z", "author": {"login": "gjuggler"}, "path": "api/reporting/queries/live/restructured_results/latest_users_structured.sql", "diffHunk": "@@ -0,0 +1,40 @@\n+SELECT\n+    TIMESTAMP_MILLIS(u.snapshot_timestamp) AS snapshot,\n+    STRUCT( u.user_id,\n+            u.username,\n+            u.disabled,\n+            u.creation_time,\n+            u.first_sign_in_time,\n+            u.first_registration_completion_time,\n+            u.last_modified_time) AS account,\n+    STRUCT( u.given_name,\n+            u.family_name,\n+            u.about_you,\n+            u.area_of_research,\n+            u.current_position,\n+            u.demographic_survey_completion_time) AS profile,\n+    STRUCT(u.contact_email,\n+           u.street_address_1,\n+           u.street_address_2,\n+           u.city,\n+           u.state,\n+           u.zip_code,\n+           u.country,\n+           u.professional_url) AS contact_info,\n+    STRUCT( STRUCT(u.compliance_training_completion_time AS completion_time,\n+                   u.compliance_training_bypass_time AS bypass_time,\n+                   u.compliance_training_expiration_time AS expiration_time) AS compliance_training,\n+            STRUCT(data_use_agreement_signed_version AS signed_version,\n+                   data_use_agreement_completion_time AS completion_timei,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9911d49b97bc8d4d6fbac421941094951122c29"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNTI3MA==", "bodyText": "nit: not sure how free tier credits fits under the \"compliance\" banner", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r498915270", "createdAt": "2020-10-02T16:08:57Z", "author": {"login": "gjuggler"}, "path": "api/reporting/queries/live/restructured_results/latest_users_structured.sql", "diffHunk": "@@ -0,0 +1,40 @@\n+SELECT\n+    TIMESTAMP_MILLIS(u.snapshot_timestamp) AS snapshot,\n+    STRUCT( u.user_id,\n+            u.username,\n+            u.disabled,\n+            u.creation_time,\n+            u.first_sign_in_time,\n+            u.first_registration_completion_time,\n+            u.last_modified_time) AS account,\n+    STRUCT( u.given_name,\n+            u.family_name,\n+            u.about_you,\n+            u.area_of_research,\n+            u.current_position,\n+            u.demographic_survey_completion_time) AS profile,\n+    STRUCT(u.contact_email,\n+           u.street_address_1,\n+           u.street_address_2,\n+           u.city,\n+           u.state,\n+           u.zip_code,\n+           u.country,\n+           u.professional_url) AS contact_info,\n+    STRUCT( STRUCT(u.compliance_training_completion_time AS completion_time,\n+                   u.compliance_training_bypass_time AS bypass_time,\n+                   u.compliance_training_expiration_time AS expiration_time) AS compliance_training,\n+            STRUCT(data_use_agreement_signed_version AS signed_version,\n+                   data_use_agreement_completion_time AS completion_timei,\n+                   data_use_agreement_bypass_time AS bypass_time) AS data_use_agreement,\n+            STRUCT(u.era_commons_completion_time AS completion_time,\n+                   u.era_commons_bypass_time AS bypass_time) AS era_commons,\n+            STRUCT(u.two_factor_auth_completion_time AS completion_time,\n+                   u.two_factor_auth_bypass_time AS bypass_time) AS two_factor_auth,\n+            u.data_access_level,\n+            STRUCT(u.free_tier_credits_limit_days_override AS days,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9911d49b97bc8d4d6fbac421941094951122c29"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNzAwNA==", "bodyText": "Nifty!\nI worry a small bit about \"give a mouse a cookie\" here, where there may become an expectation that all of our underlying data is structured this way, when it's really a manually crafted facade. Not necessarily a bad thing \u2013\u00a0it's just worth being clear about what this is and isn't.\nWe also got a pretty signal early on (from the PDR folks I believe) that their Tableau connector wouldn't be able to make use of BigQuery's nested / struct rows. Not sure whether that's still the case.\nAnyhow, those are just points to keep in mind. Seems useful and worth keeping around, at least as a POC of how one might add some structure to the BQ version of this reporting data.", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r498917004", "createdAt": "2020-10-02T16:12:27Z", "author": {"login": "gjuggler"}, "path": "api/reporting/queries/live/restructured_results/latest_users_structured.sql", "diffHunk": "@@ -0,0 +1,40 @@\n+SELECT\n+    TIMESTAMP_MILLIS(u.snapshot_timestamp) AS snapshot,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9911d49b97bc8d4d6fbac421941094951122c29"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODkxNzU1Ng==", "bodyText": "This one feels like a bit too much of a straight rename \u2013 which IIRC you'd tried to avoid doing, to reduce schema drift / random name-mapping challenges.", "url": "https://github.com/all-of-us/workbench/pull/4108#discussion_r498917556", "createdAt": "2020-10-02T16:13:30Z", "author": {"login": "gjuggler"}, "path": "api/reporting/queries/live/restructured_results/latest_workspaces_structured.sql", "diffHunk": "@@ -0,0 +1,38 @@\n+-- latest workspaces, broken into logical structs for easier comprehension.\n+SELECT\n+    STRUCT(w.workspace_id,\n+           w.name,\n+           w.creator_id,\n+           w.cdr_version_id,\n+           w.creation_time) AS metadata,\n+    STRUCT(w.creation_time,\n+           w.last_accessed_time,\n+           w.last_modified_time) AS history,\n+    STRUCT( w.rp_additional_notes AS additional_notes,\n+            w.rp_ancestry AS ancestry,\n+            w.rp_anticipated_findings AS anticipated_findings,\n+            w.rp_approved AS approved,\n+            w.rp_commercial_purpose AS commercial_purpose,\n+            w.rp_control_set AS control_set,\n+            w.rp_disease_focused_research AS disease_focused_research,\n+            w.rp_disease_of_focus AS disease_of_focus,\n+            w.disseminate_research_other,\n+            w.rp_drug_development AS drug_development,\n+            w.rp_educational AS educational,\n+            w.rp_ethics AS ethics,\n+            w.rp_intended_study AS intended_study,\n+            w.rp_methods_development AS methods_development,\n+            w.rp_other_population_details AS other_population_details,\n+            w.rp_other_purpose AS other_purpose,\n+            w.rp_other_purpose_details AS other_purpose_details,\n+            w.rp_population_health AS population_health,\n+            w.rp_reason_for_all_of_us AS reason_for_all_of_us,\n+            w.rp_review_requested AS review_requested,\n+            w.rp_scientific_approach AS scientific_approach,\n+            w.rp_social_behavioral AS social_behavioral,\n+            w.rp_time_requested AS time_requested ) AS research_purpose,\n+    STRUCT(w.billing_status AS status,\n+           w.billing_account_type AS account_type ) AS billing,\n+    STRUCT(w.needs_rp_review_prompt) AS process_status", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9911d49b97bc8d4d6fbac421941094951122c29"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMjkwNTky", "url": "https://github.com/all-of-us/workbench/pull/4108#pullrequestreview-501290592", "createdAt": "2020-10-02T16:45:04Z", "commit": {"oid": "d9911d49b97bc8d4d6fbac421941094951122c29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d4c0f354ac12f6ad41bfbe4a15e99ae0785f964", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/1d4c0f354ac12f6ad41bfbe4a15e99ae0785f964", "committedDate": "2020-10-02T20:05:42Z", "message": "first batch of queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "900f42acdd63fb0b62790db4d627b07cd5420ff7", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/900f42acdd63fb0b62790db4d627b07cd5420ff7", "committedDate": "2020-10-02T20:05:42Z", "message": "reorganize and   add a  doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5bc8e44e97b4b9be917ec0f3747fa75feb4d86a", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/a5bc8e44e97b4b9be917ec0f3747fa75feb4d86a", "committedDate": "2020-10-02T20:05:43Z", "message": "more  docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08141fb8d0e171dcb32f0531a263fdd37a7e231e", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/08141fb8d0e171dcb32f0531a263fdd37a7e231e", "committedDate": "2020-10-02T20:05:43Z", "message": "link  from  top-level README"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04be070fa2590e141a203e55f2087d2984dfa1cf", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/04be070fa2590e141a203e55f2087d2984dfa1cf", "committedDate": "2020-10-02T20:29:48Z", "message": "updated with PR notes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "299d66d46e966c7942b8c300ca380e146e2a17b0", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/299d66d46e966c7942b8c300ca380e146e2a17b0", "committedDate": "2020-10-02T20:40:36Z", "message": "update README"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9911d49b97bc8d4d6fbac421941094951122c29", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/d9911d49b97bc8d4d6fbac421941094951122c29", "committedDate": "2020-10-02T15:43:35Z", "message": "link  from  top-level README"}, "afterCommit": {"oid": "299d66d46e966c7942b8c300ca380e146e2a17b0", "author": {"user": {"login": "jaycarlton", "name": "Jay Carlton"}}, "url": "https://github.com/all-of-us/workbench/commit/299d66d46e966c7942b8c300ca380e146e2a17b0", "committedDate": "2020-10-02T20:40:36Z", "message": "update README"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4165, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}