{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0OTM5OTM0", "number": 4180, "title": "[risk=no][RW-5411]Add dataproc config to runtime panel", "bodyText": "Description:\nAdds ability to select and customize a dataproc config to the runtime panel.\nSome indentation changes were made - ignoring whitespace will clean up the diff a bit.\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on this change against my local UI + API server with yarn test-local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-10-16T15:48:22Z", "url": "https://github.com/all-of-us/workbench/pull/4180", "merged": true, "mergeCommit": {"oid": "a0b8e8967eabe1543b5e05350676058797ec0660"}, "closed": true, "closedAt": "2020-10-22T12:06:10Z", "author": {"login": "petesantos"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTGNS-gH2gAyNTA0OTM5OTM0OmY5ZWFhYmUzMzNhMDBiYTNjYzhkNjVlYTlhZWY4ZTIyOTk2ZGZjZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVAW8FAH2gAyNTA0OTM5OTM0OmQ3MDUxOGYzYTczODVlMjM3NDUwOTAxOGQzM2Y3ZTBkN2ViM2Q3NDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f9eaabe333a00ba3cc8d65ea9aef8e22996dfcf6", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/f9eaabe333a00ba3cc8d65ea9aef8e22996dfcf6", "committedDate": "2020-10-16T13:15:45Z", "message": "Add dataproc cluster UI fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1124da5a534d6c535552b3d74f1100af869d354", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/d1124da5a534d6c535552b3d74f1100af869d354", "committedDate": "2020-10-16T13:47:38Z", "message": "Correct disabling of the update button"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c13f3b2ac377f3ee2d3686834cc11b2edbc9f694", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/c13f3b2ac377f3ee2d3686834cc11b2edbc9f694", "committedDate": "2020-10-16T14:26:58Z", "message": "Dataproc config requests enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7a7f65b76e958cfd07216bb92da54e425c471aa", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/c7a7f65b76e958cfd07216bb92da54e425c471aa", "committedDate": "2020-10-16T15:34:57Z", "message": "Styling updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f559dd13ea71209eb45f66fa832fd0b49e8673fd", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/f559dd13ea71209eb45f66fa832fd0b49e8673fd", "committedDate": "2020-10-16T15:46:37Z", "message": "linting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/c42240e4a505338e2e97aa6e29791d63e290c0d5", "committedDate": "2020-10-16T17:06:23Z", "message": "Clean up dataproc config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNzg0MzE1", "url": "https://github.com/all-of-us/workbench/pull/4180#pullrequestreview-510784315", "createdAt": "2020-10-16T20:38:37Z", "commit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMDozODozN1rOHjPH1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMDo0MToxNlrOHjPMCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcwOTk3NQ==", "bodyText": "should this not be useState(masterMachineType)?", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506709975", "createdAt": "2020-10-16T20:38:37Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {\n+  return <Fragment>\n+    <label htmlFor='runtime-disk' style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+    <InputNumber id='runtime-disk'\n+      showButtons\n+      decrementButtonClassName='p-button-secondary'\n+      incrementButtonClassName='p-button-secondary'\n+      value={updatedDiskSize || diskSize}\n+      inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+      onChange={({value}) => onChange(value)}\n+      min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </Fragment>;\n+};\n+\n+const DataProcConfig = ({onChange, dataprocConfig}) => {\n+  const {\n+    workerMachineType = defaultMachineType,\n+    workerDiskSize = 50,\n+    numberOfWorkers = 2,\n+    numberOfPreemptibleWorkers = 0\n+  } = dataprocConfig || {};\n+  const [updatedNumWorkers, setUpdatedNumWorkers] = useState(numberOfWorkers);\n+  const [updatedPreemtible, setUpdatedPreemptible] = useState(numberOfPreemptibleWorkers);\n+  const [updatedWorkerMachine, setUpdatedWorkerMachine] = useState(null);\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(workerDiskSize);\n+\n+  useEffect(() => {\n+    const machineType = updatedWorkerMachine && updatedWorkerMachine.name;\n+    const dataprocConfigChanged = updatedNumWorkers !== numberOfWorkers ||\n+    updatedPreemtible !== numberOfPreemptibleWorkers ||\n+    updatedDiskSize !== workerDiskSize ||\n+    updatedWorkerMachine ||\n+    !dataprocConfig;\n+\n+    onChange(dataprocConfigChanged ? {\n+      workerMachineType: machineType,\n+      workerDiskSize: updatedDiskSize,\n+      numberOfWorkers: updatedNumWorkers,\n+      numberOfPreemptibleWorkers: updatedPreemtible\n+    } : null);\n+\n+    return () => onChange(null);\n+  }, [updatedNumWorkers, updatedPreemtible, updatedWorkerMachine, updatedDiskSize]);\n+\n+\n+  return <fieldset style={{marginTop: '0.75rem'}}>\n+    <legend style={styles.workerConfigLabel}>Worker Config</legend>\n+    <div style={styles.formGrid}>\n+      <label htmlFor='num-workers' style={{marginRight: '.25rem'}}>Workers</label>\n+      <InputNumber id='num-workers'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers}\n+        inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+        onChange={({value}) => {\n+          setUpdatedNumWorkers(value);\n+          if (updatedNumWorkers < updatedPreemtible) {\n+            setUpdatedPreemptible(updatedNumWorkers);\n+          }\n+        }}\n+        min={2}/>\n+      <label htmlFor='num-preemptible' style={{marginRight: '.25rem'}}>Preemptible</label>\n+      <InputNumber id='num-preemptible'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers < updatedPreemtible ? updatedNumWorkers : updatedPreemtible}\n+        inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+        onChange={({value}) => setUpdatedPreemptible(value)}\n+        min={0}\n+        max={updatedNumWorkers}/>\n+      <div style={{gridColumnEnd: 'span 2'}}/>\n+      <MachineSelector machineType={workerMachineType} onChange={setUpdatedWorkerMachine} updatedMachine={updatedWorkerMachine}/>\n+      <DiskSizeSelection diskSize={workerDiskSize} onChange={setUpdatedDiskSize} updatedDiskSize={updatedDiskSize} />\n+    </div>\n+  </fieldset>;\n };\n \n export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n-  const [updatedDiskSize, setUpdatedDiskSize] = useState(null);\n-  const [updatedMachine, setUpdatedMachine] = useState(null);\n   const runtimeOps = useStore(runtimeOpsStore);\n   const [currentRuntime, setRequestedRuntime] = useCustomRuntime(workspace.namespace);\n \n   const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n   const {status = RuntimeStatus.Unknown, toolDockerImage = '', dataprocConfig = null, gceConfig = {}} = currentRuntime || {};\n   const masterMachineType = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n   const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n-  const updatedMachineType = updatedMachine && updatedMachine.name;\n \n-  const isDataproc = (currentRuntime && !!currentRuntime.dataprocConfig);\n-  const runtimeChanged = updatedMachine || updatedDiskSize;\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(masterDiskSize);\n+  const [updatedMachine, setUpdatedMachine] = useState(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 234}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjcxMTA0OA==", "bodyText": "Outside of the scope of this ticket, but it would be nice to clean up how we track whether gce config has changed so that it can work the same as what you're doing... on Monday I'll take a look at what tickets we have for the epic and what else we need", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506711048", "createdAt": "2020-10-16T20:41:16Z", "author": {"login": "als364"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {\n+  return <Fragment>\n+    <label htmlFor='runtime-disk' style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+    <InputNumber id='runtime-disk'\n+      showButtons\n+      decrementButtonClassName='p-button-secondary'\n+      incrementButtonClassName='p-button-secondary'\n+      value={updatedDiskSize || diskSize}\n+      inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+      onChange={({value}) => onChange(value)}\n+      min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </Fragment>;\n+};\n+\n+const DataProcConfig = ({onChange, dataprocConfig}) => {\n+  const {\n+    workerMachineType = defaultMachineType,\n+    workerDiskSize = 50,\n+    numberOfWorkers = 2,\n+    numberOfPreemptibleWorkers = 0\n+  } = dataprocConfig || {};\n+  const [updatedNumWorkers, setUpdatedNumWorkers] = useState(numberOfWorkers);\n+  const [updatedPreemtible, setUpdatedPreemptible] = useState(numberOfPreemptibleWorkers);\n+  const [updatedWorkerMachine, setUpdatedWorkerMachine] = useState(null);\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(workerDiskSize);\n+\n+  useEffect(() => {\n+    const machineType = updatedWorkerMachine && updatedWorkerMachine.name;\n+    const dataprocConfigChanged = updatedNumWorkers !== numberOfWorkers ||\n+    updatedPreemtible !== numberOfPreemptibleWorkers ||\n+    updatedDiskSize !== workerDiskSize ||\n+    updatedWorkerMachine ||\n+    !dataprocConfig;\n+\n+    onChange(dataprocConfigChanged ? {\n+      workerMachineType: machineType,\n+      workerDiskSize: updatedDiskSize,\n+      numberOfWorkers: updatedNumWorkers,\n+      numberOfPreemptibleWorkers: updatedPreemtible\n+    } : null);\n+\n+    return () => onChange(null);\n+  }, [updatedNumWorkers, updatedPreemtible, updatedWorkerMachine, updatedDiskSize]);\n+\n+\n+  return <fieldset style={{marginTop: '0.75rem'}}>\n+    <legend style={styles.workerConfigLabel}>Worker Config</legend>\n+    <div style={styles.formGrid}>\n+      <label htmlFor='num-workers' style={{marginRight: '.25rem'}}>Workers</label>\n+      <InputNumber id='num-workers'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers}\n+        inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+        onChange={({value}) => {\n+          setUpdatedNumWorkers(value);\n+          if (updatedNumWorkers < updatedPreemtible) {\n+            setUpdatedPreemptible(updatedNumWorkers);\n+          }\n+        }}\n+        min={2}/>\n+      <label htmlFor='num-preemptible' style={{marginRight: '.25rem'}}>Preemptible</label>\n+      <InputNumber id='num-preemptible'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers < updatedPreemtible ? updatedNumWorkers : updatedPreemtible}\n+        inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+        onChange={({value}) => setUpdatedPreemptible(value)}\n+        min={0}\n+        max={updatedNumWorkers}/>\n+      <div style={{gridColumnEnd: 'span 2'}}/>\n+      <MachineSelector machineType={workerMachineType} onChange={setUpdatedWorkerMachine} updatedMachine={updatedWorkerMachine}/>\n+      <DiskSizeSelection diskSize={workerDiskSize} onChange={setUpdatedDiskSize} updatedDiskSize={updatedDiskSize} />\n+    </div>\n+  </fieldset>;\n };\n \n export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n-  const [updatedDiskSize, setUpdatedDiskSize] = useState(null);\n-  const [updatedMachine, setUpdatedMachine] = useState(null);\n   const runtimeOps = useStore(runtimeOpsStore);\n   const [currentRuntime, setRequestedRuntime] = useCustomRuntime(workspace.namespace);\n \n   const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n   const {status = RuntimeStatus.Unknown, toolDockerImage = '', dataprocConfig = null, gceConfig = {}} = currentRuntime || {};\n   const masterMachineType = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n   const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n-  const updatedMachineType = updatedMachine && updatedMachine.name;\n \n-  const isDataproc = (currentRuntime && !!currentRuntime.dataprocConfig);\n-  const runtimeChanged = updatedMachine || updatedDiskSize;\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(masterDiskSize);\n+  const [updatedMachine, setUpdatedMachine] = useState(null);\n+  const [updatedCompute, setUpdatedCompute] = useState<ComputeType>(dataprocConfig ? ComputeType.dataproc : ComputeType.standard);\n+  const [updatedDataprocConfig, setUpdatedDataprocConfig] = useState();\n+\n+  const updatedMachineType = updatedMachine && updatedMachine.name;\n+  const runtimeChanged = updatedMachine || updatedDiskSize !== masterDiskSize || updatedDataprocConfig;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 239}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODE5MzI5", "url": "https://github.com/all-of-us/workbench/pull/4180#pullrequestreview-510819329", "createdAt": "2020-10-16T21:55:49Z", "commit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "state": "COMMENTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMTo1NTo0OVrOHjQ1zw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQyMjo0Mjo0M1rOHjRorQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczODEyNw==", "bodyText": "nit: We're not consistent in the codebase, but I'd say most commonly we upper camelCase enum values. In a few cases, we  do constant-style uppercase, but that's less common. Full lower case enum values are barely used", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506738127", "createdAt": "2020-10-16T21:55:49Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczOTI0MQ==", "bodyText": "Please type this; consider typing the others as well for clarity, if not obvious from the context (useState<number>(workerDiskSize);)", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506739241", "createdAt": "2020-10-16T21:59:17Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {\n+  return <Fragment>\n+    <label htmlFor='runtime-disk' style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+    <InputNumber id='runtime-disk'\n+      showButtons\n+      decrementButtonClassName='p-button-secondary'\n+      incrementButtonClassName='p-button-secondary'\n+      value={updatedDiskSize || diskSize}\n+      inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+      onChange={({value}) => onChange(value)}\n+      min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </Fragment>;\n+};\n+\n+const DataProcConfig = ({onChange, dataprocConfig}) => {\n+  const {\n+    workerMachineType = defaultMachineType,\n+    workerDiskSize = 50,\n+    numberOfWorkers = 2,\n+    numberOfPreemptibleWorkers = 0\n+  } = dataprocConfig || {};\n+  const [updatedNumWorkers, setUpdatedNumWorkers] = useState(numberOfWorkers);\n+  const [updatedPreemtible, setUpdatedPreemptible] = useState(numberOfPreemptibleWorkers);\n+  const [updatedWorkerMachine, setUpdatedWorkerMachine] = useState(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjczOTk1OQ==", "bodyText": "Type? Also consistency of initial values: why (presumably) undefined here, and  null elsewhere?", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506739959", "createdAt": "2020-10-16T22:01:43Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {\n+  return <Fragment>\n+    <label htmlFor='runtime-disk' style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+    <InputNumber id='runtime-disk'\n+      showButtons\n+      decrementButtonClassName='p-button-secondary'\n+      incrementButtonClassName='p-button-secondary'\n+      value={updatedDiskSize || diskSize}\n+      inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+      onChange={({value}) => onChange(value)}\n+      min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </Fragment>;\n+};\n+\n+const DataProcConfig = ({onChange, dataprocConfig}) => {\n+  const {\n+    workerMachineType = defaultMachineType,\n+    workerDiskSize = 50,\n+    numberOfWorkers = 2,\n+    numberOfPreemptibleWorkers = 0\n+  } = dataprocConfig || {};\n+  const [updatedNumWorkers, setUpdatedNumWorkers] = useState(numberOfWorkers);\n+  const [updatedPreemtible, setUpdatedPreemptible] = useState(numberOfPreemptibleWorkers);\n+  const [updatedWorkerMachine, setUpdatedWorkerMachine] = useState(null);\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(workerDiskSize);\n+\n+  useEffect(() => {\n+    const machineType = updatedWorkerMachine && updatedWorkerMachine.name;\n+    const dataprocConfigChanged = updatedNumWorkers !== numberOfWorkers ||\n+    updatedPreemtible !== numberOfPreemptibleWorkers ||\n+    updatedDiskSize !== workerDiskSize ||\n+    updatedWorkerMachine ||\n+    !dataprocConfig;\n+\n+    onChange(dataprocConfigChanged ? {\n+      workerMachineType: machineType,\n+      workerDiskSize: updatedDiskSize,\n+      numberOfWorkers: updatedNumWorkers,\n+      numberOfPreemptibleWorkers: updatedPreemtible\n+    } : null);\n+\n+    return () => onChange(null);\n+  }, [updatedNumWorkers, updatedPreemtible, updatedWorkerMachine, updatedDiskSize]);\n+\n+\n+  return <fieldset style={{marginTop: '0.75rem'}}>\n+    <legend style={styles.workerConfigLabel}>Worker Config</legend>\n+    <div style={styles.formGrid}>\n+      <label htmlFor='num-workers' style={{marginRight: '.25rem'}}>Workers</label>\n+      <InputNumber id='num-workers'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers}\n+        inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+        onChange={({value}) => {\n+          setUpdatedNumWorkers(value);\n+          if (updatedNumWorkers < updatedPreemtible) {\n+            setUpdatedPreemptible(updatedNumWorkers);\n+          }\n+        }}\n+        min={2}/>\n+      <label htmlFor='num-preemptible' style={{marginRight: '.25rem'}}>Preemptible</label>\n+      <InputNumber id='num-preemptible'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers < updatedPreemtible ? updatedNumWorkers : updatedPreemtible}\n+        inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+        onChange={({value}) => setUpdatedPreemptible(value)}\n+        min={0}\n+        max={updatedNumWorkers}/>\n+      <div style={{gridColumnEnd: 'span 2'}}/>\n+      <MachineSelector machineType={workerMachineType} onChange={setUpdatedWorkerMachine} updatedMachine={updatedWorkerMachine}/>\n+      <DiskSizeSelection diskSize={workerDiskSize} onChange={setUpdatedDiskSize} updatedDiskSize={updatedDiskSize} />\n+    </div>\n+  </fieldset>;\n };\n \n export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n-  const [updatedDiskSize, setUpdatedDiskSize] = useState(null);\n-  const [updatedMachine, setUpdatedMachine] = useState(null);\n   const runtimeOps = useStore(runtimeOpsStore);\n   const [currentRuntime, setRequestedRuntime] = useCustomRuntime(workspace.namespace);\n \n   const activeRuntimeOp: RuntimeOperation = runtimeOps.opsByWorkspaceNamespace[workspace.namespace];\n   const {status = RuntimeStatus.Unknown, toolDockerImage = '', dataprocConfig = null, gceConfig = {}} = currentRuntime || {};\n   const masterMachineType = !!dataprocConfig ? dataprocConfig.masterMachineType : gceConfig.machineType;\n   const masterDiskSize = !!dataprocConfig ? dataprocConfig.masterDiskSize : gceConfig.bootDiskSize;\n-  const updatedMachineType = updatedMachine && updatedMachine.name;\n \n-  const isDataproc = (currentRuntime && !!currentRuntime.dataprocConfig);\n-  const runtimeChanged = updatedMachine || updatedDiskSize;\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(masterDiskSize);\n+  const [updatedMachine, setUpdatedMachine] = useState(null);\n+  const [updatedCompute, setUpdatedCompute] = useState<ComputeType>(dataprocConfig ? ComputeType.dataproc : ComputeType.standard);\n+  const [updatedDataprocConfig, setUpdatedDataprocConfig] = useState();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 236}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0MDEwNg==", "bodyText": "Indent (does the linter actually allow this?)", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506740106", "createdAt": "2020-10-16T22:02:08Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {\n+  return <Fragment>\n+    <label htmlFor='runtime-disk' style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+    <InputNumber id='runtime-disk'\n+      showButtons\n+      decrementButtonClassName='p-button-secondary'\n+      incrementButtonClassName='p-button-secondary'\n+      value={updatedDiskSize || diskSize}\n+      inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+      onChange={({value}) => onChange(value)}\n+      min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </Fragment>;\n+};\n+\n+const DataProcConfig = ({onChange, dataprocConfig}) => {\n+  const {\n+    workerMachineType = defaultMachineType,\n+    workerDiskSize = 50,\n+    numberOfWorkers = 2,\n+    numberOfPreemptibleWorkers = 0\n+  } = dataprocConfig || {};\n+  const [updatedNumWorkers, setUpdatedNumWorkers] = useState(numberOfWorkers);\n+  const [updatedPreemtible, setUpdatedPreemptible] = useState(numberOfPreemptibleWorkers);\n+  const [updatedWorkerMachine, setUpdatedWorkerMachine] = useState(null);\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(workerDiskSize);\n+\n+  useEffect(() => {\n+    const machineType = updatedWorkerMachine && updatedWorkerMachine.name;\n+    const dataprocConfigChanged = updatedNumWorkers !== numberOfWorkers ||\n+    updatedPreemtible !== numberOfPreemptibleWorkers ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 169}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0MDU3Mg==", "bodyText": "Can you explain this - possibly via code comment? Why do we want to dispatch an onChange(null) on cleanup? Does this handle the scenario where the user switches the cloud service back to GCE?", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506740572", "createdAt": "2020-10-16T22:03:59Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {\n+  return <Fragment>\n+    <label htmlFor='runtime-disk' style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+    <InputNumber id='runtime-disk'\n+      showButtons\n+      decrementButtonClassName='p-button-secondary'\n+      incrementButtonClassName='p-button-secondary'\n+      value={updatedDiskSize || diskSize}\n+      inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+      onChange={({value}) => onChange(value)}\n+      min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </Fragment>;\n+};\n+\n+const DataProcConfig = ({onChange, dataprocConfig}) => {\n+  const {\n+    workerMachineType = defaultMachineType,\n+    workerDiskSize = 50,\n+    numberOfWorkers = 2,\n+    numberOfPreemptibleWorkers = 0\n+  } = dataprocConfig || {};\n+  const [updatedNumWorkers, setUpdatedNumWorkers] = useState(numberOfWorkers);\n+  const [updatedPreemtible, setUpdatedPreemptible] = useState(numberOfPreemptibleWorkers);\n+  const [updatedWorkerMachine, setUpdatedWorkerMachine] = useState(null);\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(workerDiskSize);\n+\n+  useEffect(() => {\n+    const machineType = updatedWorkerMachine && updatedWorkerMachine.name;\n+    const dataprocConfigChanged = updatedNumWorkers !== numberOfWorkers ||\n+    updatedPreemtible !== numberOfPreemptibleWorkers ||\n+    updatedDiskSize !== workerDiskSize ||\n+    updatedWorkerMachine ||\n+    !dataprocConfig;\n+\n+    onChange(dataprocConfigChanged ? {\n+      workerMachineType: machineType,\n+      workerDiskSize: updatedDiskSize,\n+      numberOfWorkers: updatedNumWorkers,\n+      numberOfPreemptibleWorkers: updatedPreemtible\n+    } : null);\n+\n+    return () => onChange(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 181}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0MTExMQ==", "bodyText": "Please document the semantics somewhere. Specifically - onChange(null) as a sentinel to indicate \"no change from current runtime\" requires deep code inspection to understand.", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506741111", "createdAt": "2020-10-16T22:05:33Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {\n+  return <Fragment>\n+    <label htmlFor='runtime-disk' style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+    <InputNumber id='runtime-disk'\n+      showButtons\n+      decrementButtonClassName='p-button-secondary'\n+      incrementButtonClassName='p-button-secondary'\n+      value={updatedDiskSize || diskSize}\n+      inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+      onChange={({value}) => onChange(value)}\n+      min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </Fragment>;\n+};\n+\n+const DataProcConfig = ({onChange, dataprocConfig}) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 154}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0NTI1MA==", "bodyText": "Nice. I actually did not think it worked this way (I think later we might need to slightly clarify our UX to make this clearer). I'm asking Leo team to clarify their docs on this, since I actually didn't find a definitive answer (but I assume this is correct, since Terra UI does it this way).", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506745250", "createdAt": "2020-10-16T22:19:51Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {\n+  return <Fragment>\n+    <label htmlFor='runtime-disk' style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+    <InputNumber id='runtime-disk'\n+      showButtons\n+      decrementButtonClassName='p-button-secondary'\n+      incrementButtonClassName='p-button-secondary'\n+      value={updatedDiskSize || diskSize}\n+      inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+      onChange={({value}) => onChange(value)}\n+      min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </Fragment>;\n+};\n+\n+const DataProcConfig = ({onChange, dataprocConfig}) => {\n+  const {\n+    workerMachineType = defaultMachineType,\n+    workerDiskSize = 50,\n+    numberOfWorkers = 2,\n+    numberOfPreemptibleWorkers = 0\n+  } = dataprocConfig || {};\n+  const [updatedNumWorkers, setUpdatedNumWorkers] = useState(numberOfWorkers);\n+  const [updatedPreemtible, setUpdatedPreemptible] = useState(numberOfPreemptibleWorkers);\n+  const [updatedWorkerMachine, setUpdatedWorkerMachine] = useState(null);\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(workerDiskSize);\n+\n+  useEffect(() => {\n+    const machineType = updatedWorkerMachine && updatedWorkerMachine.name;\n+    const dataprocConfigChanged = updatedNumWorkers !== numberOfWorkers ||\n+    updatedPreemtible !== numberOfPreemptibleWorkers ||\n+    updatedDiskSize !== workerDiskSize ||\n+    updatedWorkerMachine ||\n+    !dataprocConfig;\n+\n+    onChange(dataprocConfigChanged ? {\n+      workerMachineType: machineType,\n+      workerDiskSize: updatedDiskSize,\n+      numberOfWorkers: updatedNumWorkers,\n+      numberOfPreemptibleWorkers: updatedPreemtible\n+    } : null);\n+\n+    return () => onChange(null);\n+  }, [updatedNumWorkers, updatedPreemtible, updatedWorkerMachine, updatedDiskSize]);\n+\n+\n+  return <fieldset style={{marginTop: '0.75rem'}}>\n+    <legend style={styles.workerConfigLabel}>Worker Config</legend>\n+    <div style={styles.formGrid}>\n+      <label htmlFor='num-workers' style={{marginRight: '.25rem'}}>Workers</label>\n+      <InputNumber id='num-workers'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers}\n+        inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+        onChange={({value}) => {\n+          setUpdatedNumWorkers(value);\n+          if (updatedNumWorkers < updatedPreemtible) {\n+            setUpdatedPreemptible(updatedNumWorkers);\n+          }\n+        }}\n+        min={2}/>\n+      <label htmlFor='num-preemptible' style={{marginRight: '.25rem'}}>Preemptible</label>\n+      <InputNumber id='num-preemptible'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers < updatedPreemtible ? updatedNumWorkers : updatedPreemtible}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 207}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0NjAzMg==", "bodyText": "If it works - I'd like to use 0 as the min here. Note that we decided to deviate from Terra UI in the mocks by not having an option of \"Spark master node\" - this is because it's redundant with just setting workers to 0. The \"2\" requirement is throwing me off - I don't think there's any reason we can't have a 1 worker cluster (though it's not very useful), so I'm not sure why that was the chosen minimum.", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506746032", "createdAt": "2020-10-16T22:22:40Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {\n+  return <Fragment>\n+    <label htmlFor='runtime-disk' style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+    <InputNumber id='runtime-disk'\n+      showButtons\n+      decrementButtonClassName='p-button-secondary'\n+      incrementButtonClassName='p-button-secondary'\n+      value={updatedDiskSize || diskSize}\n+      inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+      onChange={({value}) => onChange(value)}\n+      min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </Fragment>;\n+};\n+\n+const DataProcConfig = ({onChange, dataprocConfig}) => {\n+  const {\n+    workerMachineType = defaultMachineType,\n+    workerDiskSize = 50,\n+    numberOfWorkers = 2,\n+    numberOfPreemptibleWorkers = 0\n+  } = dataprocConfig || {};\n+  const [updatedNumWorkers, setUpdatedNumWorkers] = useState(numberOfWorkers);\n+  const [updatedPreemtible, setUpdatedPreemptible] = useState(numberOfPreemptibleWorkers);\n+  const [updatedWorkerMachine, setUpdatedWorkerMachine] = useState(null);\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(workerDiskSize);\n+\n+  useEffect(() => {\n+    const machineType = updatedWorkerMachine && updatedWorkerMachine.name;\n+    const dataprocConfigChanged = updatedNumWorkers !== numberOfWorkers ||\n+    updatedPreemtible !== numberOfPreemptibleWorkers ||\n+    updatedDiskSize !== workerDiskSize ||\n+    updatedWorkerMachine ||\n+    !dataprocConfig;\n+\n+    onChange(dataprocConfigChanged ? {\n+      workerMachineType: machineType,\n+      workerDiskSize: updatedDiskSize,\n+      numberOfWorkers: updatedNumWorkers,\n+      numberOfPreemptibleWorkers: updatedPreemtible\n+    } : null);\n+\n+    return () => onChange(null);\n+  }, [updatedNumWorkers, updatedPreemtible, updatedWorkerMachine, updatedDiskSize]);\n+\n+\n+  return <fieldset style={{marginTop: '0.75rem'}}>\n+    <legend style={styles.workerConfigLabel}>Worker Config</legend>\n+    <div style={styles.formGrid}>\n+      <label htmlFor='num-workers' style={{marginRight: '.25rem'}}>Workers</label>\n+      <InputNumber id='num-workers'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers}\n+        inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+        onChange={({value}) => {\n+          setUpdatedNumWorkers(value);\n+          if (updatedNumWorkers < updatedPreemtible) {\n+            setUpdatedPreemptible(updatedNumWorkers);\n+          }\n+        }}\n+        min={2}/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 201}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0NjU4Ng==", "bodyText": "Nice", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506746586", "createdAt": "2020-10-16T22:24:49Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0NzAzNg==", "bodyText": "opt_nit: DiskSizeSelector?", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506747036", "createdAt": "2020-10-16T22:26:24Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0ODkwNQ==", "bodyText": "Reusing this for the worker nodes is nice. This brings up an interesting point, as to whether we need to be as strict about machine types for different scenarios., The case they were definitely worried about with Terra UI was spark master nodes. However, the same hasn't been validated for GCE or worker nodes.\nCould you add a TODO which references this ticket (which I just filed) here? https://precisionmedicineinitiative.atlassian.net/browse/RW-5763", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506748905", "createdAt": "2020-10-16T22:33:26Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {\n+  return <Fragment>\n+    <label htmlFor='runtime-disk' style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+    <InputNumber id='runtime-disk'\n+      showButtons\n+      decrementButtonClassName='p-button-secondary'\n+      incrementButtonClassName='p-button-secondary'\n+      value={updatedDiskSize || diskSize}\n+      inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+      onChange={({value}) => onChange(value)}\n+      min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </Fragment>;\n+};\n+\n+const DataProcConfig = ({onChange, dataprocConfig}) => {\n+  const {\n+    workerMachineType = defaultMachineType,\n+    workerDiskSize = 50,\n+    numberOfWorkers = 2,\n+    numberOfPreemptibleWorkers = 0\n+  } = dataprocConfig || {};\n+  const [updatedNumWorkers, setUpdatedNumWorkers] = useState(numberOfWorkers);\n+  const [updatedPreemtible, setUpdatedPreemptible] = useState(numberOfPreemptibleWorkers);\n+  const [updatedWorkerMachine, setUpdatedWorkerMachine] = useState(null);\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(workerDiskSize);\n+\n+  useEffect(() => {\n+    const machineType = updatedWorkerMachine && updatedWorkerMachine.name;\n+    const dataprocConfigChanged = updatedNumWorkers !== numberOfWorkers ||\n+    updatedPreemtible !== numberOfPreemptibleWorkers ||\n+    updatedDiskSize !== workerDiskSize ||\n+    updatedWorkerMachine ||\n+    !dataprocConfig;\n+\n+    onChange(dataprocConfigChanged ? {\n+      workerMachineType: machineType,\n+      workerDiskSize: updatedDiskSize,\n+      numberOfWorkers: updatedNumWorkers,\n+      numberOfPreemptibleWorkers: updatedPreemtible\n+    } : null);\n+\n+    return () => onChange(null);\n+  }, [updatedNumWorkers, updatedPreemtible, updatedWorkerMachine, updatedDiskSize]);\n+\n+\n+  return <fieldset style={{marginTop: '0.75rem'}}>\n+    <legend style={styles.workerConfigLabel}>Worker Config</legend>\n+    <div style={styles.formGrid}>\n+      <label htmlFor='num-workers' style={{marginRight: '.25rem'}}>Workers</label>\n+      <InputNumber id='num-workers'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers}\n+        inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+        onChange={({value}) => {\n+          setUpdatedNumWorkers(value);\n+          if (updatedNumWorkers < updatedPreemtible) {\n+            setUpdatedPreemptible(updatedNumWorkers);\n+          }\n+        }}\n+        min={2}/>\n+      <label htmlFor='num-preemptible' style={{marginRight: '.25rem'}}>Preemptible</label>\n+      <InputNumber id='num-preemptible'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers < updatedPreemtible ? updatedNumWorkers : updatedPreemtible}\n+        inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+        onChange={({value}) => setUpdatedPreemptible(value)}\n+        min={0}\n+        max={updatedNumWorkers}/>\n+      <div style={{gridColumnEnd: 'span 2'}}/>\n+      <MachineSelector machineType={workerMachineType} onChange={setUpdatedWorkerMachine} updatedMachine={updatedWorkerMachine}/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 213}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc1MTE0OQ==", "bodyText": "Per the ticket AC: dataproc should only be shown for genomics-enabled workspaces.\nHow? A little bit tricky actually, now that I look at it..\n\nuse the withCdrVersions() HOC\njoin this against the current workspace.cdrVersionId\ncheck cdrVersion.hasMicroarrayData\n\nIf that HOC can't be used with RuntimePanel, this could also happen one level up in the help-sidebar. The help-sidebar could then pass allowDataproc (or similar) as a prop here.", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r506751149", "createdAt": "2020-10-16T22:42:43Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -175,30 +249,33 @@ export const RuntimePanel = withCurrentWorkspace()(({workspace}) => {\n                 value={toolDockerImage}/>\n       {/* Runtime customization: change detailed machine configuration options. */}\n       <h3 style={styles.sectionHeader}>Cloud compute profile</h3>\n-      <FlexRow style={{justifyContent: 'space-between'}}>\n-        <MachineSelector updatedMachine={updatedMachine} onChange={setUpdatedMachine} masterMachineType={masterMachineType}/>\n-        <DiskSizeSelection updatedDiskSize={updatedDiskSize} onChange={setUpdatedDiskSize} masterDiskSize={masterDiskSize}/>\n-      </FlexRow>\n+      <div style={styles.formGrid}>\n+        <MachineSelector updatedMachine={updatedMachine} onChange={setUpdatedMachine} machineType={masterMachineType}/>\n+        <DiskSizeSelection updatedDiskSize={updatedDiskSize} onChange={setUpdatedDiskSize} diskSize={masterDiskSize}/>\n+      </div>\n       <FlexColumn style={{marginTop: '1rem'}}>\n         <label htmlFor='runtime-compute'>Compute type</label>\n         <Dropdown id='runtime-compute'\n                   style={{width: '10rem'}}\n-                  disabled={true}\n-                  options={['Dataproc cluster', 'Standard VM']}\n-                  value={isDataproc ? 'Dataproc cluster' : 'Standard VM'}/>\n+                  options={[ComputeType.dataproc, ComputeType.standard]}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 262}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69460b39e45e692df37ac3fdfb3d2572a39e7dca", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/69460b39e45e692df37ac3fdfb3d2572a39e7dca", "committedDate": "2020-10-19T19:18:27Z", "message": "Cleaner machine update handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c123f3eb5e964b59d637e3d72154ef8abc143e84", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/c123f3eb5e964b59d637e3d72154ef8abc143e84", "committedDate": "2020-10-19T19:25:28Z", "message": "rename \"update\" variables to \"selected\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyMTkyMTQw", "url": "https://github.com/all-of-us/workbench/pull/4180#pullrequestreview-512192140", "createdAt": "2020-10-19T22:03:14Z", "commit": {"oid": "c123f3eb5e964b59d637e3d72154ef8abc143e84"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQyMjowMzoxNFrOHkjSvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQyMjowNToxMFrOHkjV4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA4OTAyMg==", "bodyText": "Update: lets just go with what you have now (min=2). Apparently the rules are : It\u2019s also not possible to have a cluster with only preemptible nodes in it. You must have at least 3 regular nodes: the master and the first 2 workers.. I don't want to confuse users by offering this edge case third configuration, when we have GCE already available to them as an option.\nIf it gets requested later, probably we can just go with the Terra UI route, and add the \"master only\" version to the dropdown.", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r508089022", "createdAt": "2020-10-19T22:03:14Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {\n+  return <Fragment>\n+    <label htmlFor='runtime-disk' style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+    <InputNumber id='runtime-disk'\n+      showButtons\n+      decrementButtonClassName='p-button-secondary'\n+      incrementButtonClassName='p-button-secondary'\n+      value={updatedDiskSize || diskSize}\n+      inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+      onChange={({value}) => onChange(value)}\n+      min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </Fragment>;\n+};\n+\n+const DataProcConfig = ({onChange, dataprocConfig}) => {\n+  const {\n+    workerMachineType = defaultMachineType,\n+    workerDiskSize = 50,\n+    numberOfWorkers = 2,\n+    numberOfPreemptibleWorkers = 0\n+  } = dataprocConfig || {};\n+  const [updatedNumWorkers, setUpdatedNumWorkers] = useState(numberOfWorkers);\n+  const [updatedPreemtible, setUpdatedPreemptible] = useState(numberOfPreemptibleWorkers);\n+  const [updatedWorkerMachine, setUpdatedWorkerMachine] = useState(null);\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(workerDiskSize);\n+\n+  useEffect(() => {\n+    const machineType = updatedWorkerMachine && updatedWorkerMachine.name;\n+    const dataprocConfigChanged = updatedNumWorkers !== numberOfWorkers ||\n+    updatedPreemtible !== numberOfPreemptibleWorkers ||\n+    updatedDiskSize !== workerDiskSize ||\n+    updatedWorkerMachine ||\n+    !dataprocConfig;\n+\n+    onChange(dataprocConfigChanged ? {\n+      workerMachineType: machineType,\n+      workerDiskSize: updatedDiskSize,\n+      numberOfWorkers: updatedNumWorkers,\n+      numberOfPreemptibleWorkers: updatedPreemtible\n+    } : null);\n+\n+    return () => onChange(null);\n+  }, [updatedNumWorkers, updatedPreemtible, updatedWorkerMachine, updatedDiskSize]);\n+\n+\n+  return <fieldset style={{marginTop: '0.75rem'}}>\n+    <legend style={styles.workerConfigLabel}>Worker Config</legend>\n+    <div style={styles.formGrid}>\n+      <label htmlFor='num-workers' style={{marginRight: '.25rem'}}>Workers</label>\n+      <InputNumber id='num-workers'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers}\n+        inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+        onChange={({value}) => {\n+          setUpdatedNumWorkers(value);\n+          if (updatedNumWorkers < updatedPreemtible) {\n+            setUpdatedPreemptible(updatedNumWorkers);\n+          }\n+        }}\n+        min={2}/>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0NjAzMg=="}, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 201}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODA4OTgyNw==", "bodyText": "Implications per slack updates: just let the preemtible worker count update independently of numWorkers.", "url": "https://github.com/all-of-us/workbench/pull/4180#discussion_r508089827", "createdAt": "2020-10-19T22:05:10Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/analysis/runtime-panel.tsx", "diffHunk": "@@ -40,97 +40,171 @@ const styles = reactStyles({\n   presetMenuItem: {\n     color: colors.primary,\n     fontSize: '14px'\n+  },\n+  formGrid: {\n+    display: 'grid',\n+    gridTemplateColumns: '1fr 1fr 1fr 1fr 3rem 1fr',\n+    gridGap: '1rem',\n+    alignItems: 'center'\n+  },\n+  workerConfigLabel: {\n+    fontWeight: 600,\n+    marginBottom: '0.5rem'\n   }\n });\n \n const defaultMachineType = allMachineTypes.find(({name}) => name === 'n1-standard-4');\n+enum ComputeType {\n+  standard = 'Standard VM',\n+  dataproc = 'Dataproc Cluster'\n+}\n \n export interface Props {\n   workspace: WorkspaceData;\n }\n \n-const MachineSelector = ({onChange, updatedMachine, masterMachineType}) => {\n-  const initialMachineType = fp.find(({name}) => name === masterMachineType, allMachineTypes) || defaultMachineType;\n+const MachineSelector = ({onChange, updatedMachine, machineType}) => {\n+  const initialMachineType = fp.find(({name}) => name === machineType, allMachineTypes) || defaultMachineType;\n   const {cpu, memory} = updatedMachine || initialMachineType;\n   const maybeGetMachine = machineRequested => fp.equals(machineRequested, initialMachineType) ? null : machineRequested;\n \n   return <Fragment>\n-    <div>\n-      <label htmlFor='runtime-cpu'\n-            style={{marginRight: '.25rem'}}>CPUs</label>\n+      <label htmlFor='runtime-cpu' style={{marginRight: '.25rem'}}>CPUs</label>\n       <Dropdown id='runtime-cpu'\n-                options={fp.flow(\n-                  // Show all CPU options.\n-                  fp.map('cpu'),\n-                  // In the event that was remove a machine type from our set of valid\n-                  // configs, we want to continue to allow rendering of the value here.\n-                  // Union also makes the CPU values unique.\n-                  fp.union([cpu]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.sortBy('memory'),\n-                    fp.find({cpu: value}),\n-                    maybeGetMachine,\n-                    onChange)(validLeonardoMachineTypes)\n-                }\n-                value={cpu}/>\n-    </div>\n-    <div>\n-      <label htmlFor='runtime-ram'\n-            style={{marginRight: '.25rem'}}>RAM (GB)</label>\n+        options={fp.flow(\n+          // Show all CPU options.\n+          fp.map('cpu'),\n+          // In the event that was remove a machine type from our set of valid\n+          // configs, we want to continue to allow rendering of the value here.\n+          // Union also makes the CPU values unique.\n+          fp.union([cpu]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.sortBy('memory'),\n+            fp.find({cpu: value}),\n+            maybeGetMachine,\n+            onChange)(validLeonardoMachineTypes)\n+        }\n+        value={cpu}/>\n+      <label htmlFor='runtime-ram' style={{marginRight: '.25rem'}}>RAM (GB)</label>\n       <Dropdown id='runtime-ram'\n-                options={fp.flow(\n-                  // Show valid memory options as constrained by the currently selected CPU.\n-                  fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n-                  fp.map('memory'),\n-                  // See above comment on CPU union.\n-                  fp.union([memory]),\n-                  fp.sortBy(fp.identity)\n-                )(validLeonardoMachineTypes)}\n-                onChange={\n-                  ({value}) => fp.flow(\n-                    fp.find({cpu, memory: value}),\n-                    // If the selected machine is not different from the current machine return null\n-                    maybeGetMachine,\n-                    onChange\n-                    )(validLeonardoMachineTypes) }\n-                value={memory}\n-                />\n-    </div>\n+        options={fp.flow(\n+          // Show valid memory options as constrained by the currently selected CPU.\n+          fp.filter(({cpu: availableCpu}) => availableCpu === cpu),\n+          fp.map('memory'),\n+          // See above comment on CPU union.\n+          fp.union([memory]),\n+          fp.sortBy(fp.identity)\n+        )(validLeonardoMachineTypes)}\n+        onChange={\n+          ({value}) => fp.flow(\n+            fp.find({cpu, memory: value}),\n+            // If the selected machine is not different from the current machine return null\n+            maybeGetMachine,\n+            onChange\n+            )(validLeonardoMachineTypes) }\n+        value={memory}\n+        />\n   </Fragment>;\n };\n \n-const DiskSizeSelection = ({onChange, updatedDiskSize, masterDiskSize}) => {\n-  return <div>\n-    <label htmlFor='runtime-disk'\n-          style={{marginRight: '.25rem'}}>Disk (GB)</label>\n-      <InputNumber id='runtime-disk'\n-                showButtons\n-                decrementButtonClassName='p-button-secondary'\n-                incrementButtonClassName='p-button-secondary'\n-                value={updatedDiskSize || masterDiskSize}\n-                inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n-                onChange={({value}) => onChange(value === masterDiskSize ? null : value)}\n-                min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n-  </div>;\n+const DiskSizeSelection = ({onChange, updatedDiskSize, diskSize}) => {\n+  return <Fragment>\n+    <label htmlFor='runtime-disk' style={{marginRight: '.25rem'}}>Disk (GB)</label>\n+    <InputNumber id='runtime-disk'\n+      showButtons\n+      decrementButtonClassName='p-button-secondary'\n+      incrementButtonClassName='p-button-secondary'\n+      value={updatedDiskSize || diskSize}\n+      inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+      onChange={({value}) => onChange(value)}\n+      min={50 /* Runtime API has a minimum 50GB requirement. */}/>\n+  </Fragment>;\n+};\n+\n+const DataProcConfig = ({onChange, dataprocConfig}) => {\n+  const {\n+    workerMachineType = defaultMachineType,\n+    workerDiskSize = 50,\n+    numberOfWorkers = 2,\n+    numberOfPreemptibleWorkers = 0\n+  } = dataprocConfig || {};\n+  const [updatedNumWorkers, setUpdatedNumWorkers] = useState(numberOfWorkers);\n+  const [updatedPreemtible, setUpdatedPreemptible] = useState(numberOfPreemptibleWorkers);\n+  const [updatedWorkerMachine, setUpdatedWorkerMachine] = useState(null);\n+  const [updatedDiskSize, setUpdatedDiskSize] = useState(workerDiskSize);\n+\n+  useEffect(() => {\n+    const machineType = updatedWorkerMachine && updatedWorkerMachine.name;\n+    const dataprocConfigChanged = updatedNumWorkers !== numberOfWorkers ||\n+    updatedPreemtible !== numberOfPreemptibleWorkers ||\n+    updatedDiskSize !== workerDiskSize ||\n+    updatedWorkerMachine ||\n+    !dataprocConfig;\n+\n+    onChange(dataprocConfigChanged ? {\n+      workerMachineType: machineType,\n+      workerDiskSize: updatedDiskSize,\n+      numberOfWorkers: updatedNumWorkers,\n+      numberOfPreemptibleWorkers: updatedPreemtible\n+    } : null);\n+\n+    return () => onChange(null);\n+  }, [updatedNumWorkers, updatedPreemtible, updatedWorkerMachine, updatedDiskSize]);\n+\n+\n+  return <fieldset style={{marginTop: '0.75rem'}}>\n+    <legend style={styles.workerConfigLabel}>Worker Config</legend>\n+    <div style={styles.formGrid}>\n+      <label htmlFor='num-workers' style={{marginRight: '.25rem'}}>Workers</label>\n+      <InputNumber id='num-workers'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers}\n+        inputStyle={{padding: '.75rem .5rem', width: '2rem'}}\n+        onChange={({value}) => {\n+          setUpdatedNumWorkers(value);\n+          if (updatedNumWorkers < updatedPreemtible) {\n+            setUpdatedPreemptible(updatedNumWorkers);\n+          }\n+        }}\n+        min={2}/>\n+      <label htmlFor='num-preemptible' style={{marginRight: '.25rem'}}>Preemptible</label>\n+      <InputNumber id='num-preemptible'\n+        showButtons\n+        decrementButtonClassName='p-button-secondary'\n+        incrementButtonClassName='p-button-secondary'\n+        value={updatedNumWorkers < updatedPreemtible ? updatedNumWorkers : updatedPreemtible}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc0NTI1MA=="}, "originalCommit": {"oid": "c42240e4a505338e2e97aa6e29791d63e290c0d5"}, "originalPosition": 207}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "938c9eecd65d208ada6bef1bcc29aa513c3cb6d0", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/938c9eecd65d208ada6bef1bcc29aa513c3cb6d0", "committedDate": "2020-10-19T22:16:13Z", "message": "Code cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "981ed7519d5770f504a0dbecbea9d2d1269908a3", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/981ed7519d5770f504a0dbecbea9d2d1269908a3", "committedDate": "2020-10-19T22:21:29Z", "message": "Added precision to dataproc diff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bb80f0911ff7589c6a18d85f99bfa0e91cba9f5", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/9bb80f0911ff7589c6a18d85f99bfa0e91cba9f5", "committedDate": "2020-10-20T15:13:27Z", "message": "Correct preemptible behavior"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "175e0cbfa4f8f5e9bde108ae15226ab70cc8cb03", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/175e0cbfa4f8f5e9bde108ae15226ab70cc8cb03", "committedDate": "2020-10-20T15:41:04Z", "message": "linting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dd4501e94373a67bbb5169e54102a7dccc0445e", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/9dd4501e94373a67bbb5169e54102a7dccc0445e", "committedDate": "2020-10-21T13:25:03Z", "message": "Add unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed18f176d7a2866d779f54978a753d70ee1b26a9", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/ed18f176d7a2866d779f54978a753d70ee1b26a9", "committedDate": "2020-10-21T14:17:48Z", "message": "Merge remote-tracking branch 'origin/master' into psantos/5411-create-update-panel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "781f35727b8e2b8ce95cfa8dc51d99955767365a", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/781f35727b8e2b8ce95cfa8dc51d99955767365a", "committedDate": "2020-10-21T15:22:32Z", "message": "linting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "980e32386c3986d6accca577e7c61de33bd00055", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/980e32386c3986d6accca577e7c61de33bd00055", "committedDate": "2020-10-21T15:54:06Z", "message": "Add check for microarray data / genomics enabled"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MjU4ODUw", "url": "https://github.com/all-of-us/workbench/pull/4180#pullrequestreview-514258850", "createdAt": "2020-10-21T23:26:47Z", "commit": {"oid": "781f35727b8e2b8ce95cfa8dc51d99955767365a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb804b687e7de43fd0970c03e31d3d9d338832de", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/cb804b687e7de43fd0970c03e31d3d9d338832de", "committedDate": "2020-10-22T11:31:41Z", "message": "Add cdr check, update tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecfad6a47d8f9aefa96869cefca3e479876f25ee", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/ecfad6a47d8f9aefa96869cefca3e479876f25ee", "committedDate": "2020-10-22T11:31:44Z", "message": "Merge branch 'psantos/5411-create-update-panel' of https://github.com/all-of-us/workbench into psantos/5411-create-update-panel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d70518f3a7385e2374509018d33f7e0d7eb3d747", "author": {"user": {"login": "petesantos", "name": "Pete Santos"}}, "url": "https://github.com/all-of-us/workbench/commit/d70518f3a7385e2374509018d33f7e0d7eb3d747", "committedDate": "2020-10-22T11:34:42Z", "message": "linting"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3981, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}