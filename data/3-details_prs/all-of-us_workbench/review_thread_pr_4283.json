{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwMDcxMTEz", "number": 4283, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODozNjo1M1rOE4S79Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToxOTo0N1rOE41tVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDY1OTczOnYy", "diffSide": "RIGHT", "path": "e2e/tests/workspace/workspace-duplicate.spec.ts", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODozNjo1M1rOHyIcmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODozNjo1M1rOHyIcmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMyOTI0Mg==", "bodyText": "the next PR will also look for a new \"are you sure?\" popup here", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r522329242", "createdAt": "2020-11-12T18:36:53Z", "author": {"login": "jmthibault79"}, "path": "e2e/tests/workspace/workspace-duplicate.spec.ts", "diffHunk": "@@ -76,4 +77,85 @@ describe('Duplicate workspace', () => {\n       await dataPage.deleteWorkspace();\n     });\n \n+  test('OWNER can duplicate workspace to an older CDR Version via Workspace card', async () => {\n+    const workspaceCard: WorkspaceCard = await createWorkspace(page, config.defaultCdrVersionName);\n+    const originalWorkspaceName = await workspaceCard.getWorkspaceName();\n+\n+    await workspaceCard.asElementHandle().hover();\n+    // Click on Ellipsis menu \"Duplicate\" option.\n+    await workspaceCard.selectSnowmanMenu(Option.Duplicate);\n+\n+    // Fill out Workspace Name should be just enough for successful duplication\n+    const workspacesPage = new WorkspacesPage(page);\n+    await (await workspacesPage.getWorkspaceNameTextbox()).clear();\n+    const duplicateWorkspaceName = await workspacesPage.fillOutWorkspaceName();\n+\n+    // change CDR Version\n+    await workspacesPage.selectCdrVersion(config.altCdrVersionName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDY3NzA1OnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MDo1NlrOHyImow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MDo1NlrOHyImow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMTgxMQ==", "bodyText": "Also fixes a bug: Duplication screen showed \"Duplicate of Duplicate of My Workspace\"", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r522331811", "createdAt": "2020-11-12T18:40:56Z", "author": {"login": "jmthibault79"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -315,7 +346,8 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n      * \"reviewRequested\" flag, which depend on the workspace state & edit mode.\n      */\n     createInitialWorkspaceState(): Workspace {\n-      let workspace: Workspace = this.props.workspace;\n+      // copy the props into a new object so our modifications here don't affect them\n+      let workspace: Workspace = {...this.props.workspace};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3NDY4MjQ0OnYy", "diffSide": "RIGHT", "path": "ui/src/app/utils/authorities.spec.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MjozMlrOHyIqNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxODo0MjozMlrOHyIqNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjMzMjcyNQ==", "bodyText": "unrelated", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r522332725", "createdAt": "2020-11-12T18:42:32Z", "author": {"login": "jmthibault79"}, "path": "ui/src/app/utils/authorities.spec.tsx", "diffHunk": "@@ -10,7 +10,7 @@ const accessAuth = {...ProfileStubVariables.PROFILE_STUB, authorities: [Authorit\n const devAuth = {...ProfileStubVariables.PROFILE_STUB, authorities: [Authority.DEVELOPER]}\n const featuredWsAuth = {...ProfileStubVariables.PROFILE_STUB, authorities: [Authority.FEATUREDWORKSPACEADMIN]}\n \n-describe('auth', () => {\n+describe('authorities', () => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5872b5e7a0f4c4cfd7ce1290dfecb10069a93e56"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDE4OTMyOnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMDozODoyN1rOHy-QaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMDozODoyN1rOHy-QaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIxMDg1Nw==", "bodyText": "nit: are the extra parens needed?", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r523210857", "createdAt": "2020-11-13T20:38:27Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/workspace/workspace-edit.tsx", "diffHunk": "@@ -366,13 +398,9 @@ export const WorkspaceEdit = fp.flow(withRouteConfigData(), withCurrentWorkspace\n         workspace.researchPurpose.reviewRequested = false;\n       }\n \n-      const selectedCdrIsLive = this.getLiveCdrVersions().some(\n-        cdr => cdr.cdrVersionId === workspace.cdrVersionId);\n       // We preselect the default CDR version when a new workspace is being\n-      // created (via create or duplicate), but leave as-is if the selected CDR\n-      // version is live.\n-      if (this.isMode(WorkspaceEditMode.Create) ||\n-        (this.isMode(WorkspaceEditMode.Duplicate) && !selectedCdrIsLive)) {\n+      // created (via create or duplicate)\n+      if (this.isMode(WorkspaceEditMode.Create) || (this.isMode(WorkspaceEditMode.Duplicate))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59161b85e8ee49b22c94ddf62933c5fc6e3501fa"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDMzMDY3OnYy", "diffSide": "RIGHT", "path": "e2e/tests/workspace/workspace-duplicate.spec.ts", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToxMDozMlrOHy_rIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToxMDozMlrOHy_rIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNDA4MA==", "bodyText": "nit: is the full text needed for the test? Would the originalWorkspaceName be enough?", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r523234080", "createdAt": "2020-11-13T21:10:32Z", "author": {"login": "petesantos"}, "path": "e2e/tests/workspace/workspace-duplicate.spec.ts", "diffHunk": "@@ -76,4 +77,85 @@ describe('Duplicate workspace', () => {\n       await dataPage.deleteWorkspace();\n     });\n \n+  test('OWNER can duplicate workspace to an older CDR Version via Workspace card', async () => {\n+    const workspaceCard: WorkspaceCard = await createWorkspace(page, config.defaultCdrVersionName);\n+    const originalWorkspaceName = await workspaceCard.getWorkspaceName();\n+\n+    await workspaceCard.asElementHandle().hover();\n+    // Click on Ellipsis menu \"Duplicate\" option.\n+    await workspaceCard.selectSnowmanMenu(Option.Duplicate);\n+\n+    // Fill out Workspace Name should be just enough for successful duplication\n+    const workspacesPage = new WorkspacesPage(page);\n+    await (await workspacesPage.getWorkspaceNameTextbox()).clear();\n+    const duplicateWorkspaceName = await workspacesPage.fillOutWorkspaceName();\n+\n+    // change CDR Version\n+    await workspacesPage.selectCdrVersion(config.altCdrVersionName);\n+\n+    const finishButton = await workspacesPage.getDuplicateWorkspaceButton();\n+    await finishButton.waitUntilEnabled();\n+    await workspacesPage.clickCreateFinishButton(finishButton);\n+\n+    // Duplicate workspace Data page is loaded.\n+    const dataPage = new WorkspaceDataPage(page);\n+    await dataPage.waitForLoad();\n+    expect(page.url()).toContain(duplicateWorkspaceName.replace(/-/g, '')); // Remove dash from workspace name\n+\n+    // Delete duplicate workspace via Workspace card in Your Workspaces page.\n+    await Navigation.navMenu(page, NavLink.YOUR_WORKSPACES);\n+    await workspacesPage.waitForLoad();\n+\n+    await WorkspaceCard.deleteWorkspace(page, duplicateWorkspaceName);\n+\n+    // Verify Delete action was successful.\n+    expect(await WorkspaceCard.findCard(page, duplicateWorkspaceName)).toBeFalsy();\n+\n+    // Delete original workspace via Workspace card\n+    await WorkspaceCard.deleteWorkspace(page, originalWorkspaceName);\n+    expect(await WorkspaceCard.findCard(page, originalWorkspaceName)).toBeFalsy();\n+  });\n+\n+  test('OWNER can duplicate workspace to a newer CDR Version via Workspace card', async () => {\n+    const workspaceCard: WorkspaceCard = await createWorkspace(page, config.altCdrVersionName);\n+    const originalWorkspaceName = await workspaceCard.getWorkspaceName();\n+\n+    await workspaceCard.asElementHandle().hover();\n+    // Click on Ellipsis menu \"Duplicate\" option.\n+    await workspaceCard.selectSnowmanMenu(Option.Duplicate);\n+\n+    // Fill out Workspace Name should be just enough for successful duplication\n+    const workspacesPage = new WorkspacesPage(page);\n+    await (await workspacesPage.getWorkspaceNameTextbox()).clear();\n+    const duplicateWorkspaceName = await workspacesPage.fillOutWorkspaceName();\n+\n+    // change CDR Version\n+    await workspacesPage.selectCdrVersion(config.defaultCdrVersionName);\n+\n+    const upgradeMessage = await workspacesPage.getCdrVersionUpgradeMessage();\n+    expect(upgradeMessage).toContain(`You're duplicating the workspace \"${originalWorkspaceName}\" to upgrade from`);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59161b85e8ee49b22c94ddf62933c5fc6e3501fa"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4MDM1NjY5OnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/workspace/workspace-edit.spec.tsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToxOTo0N1rOHy_6ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QyMToxOTo0N1rOHy_6ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzIzNzk4OA==", "bodyText": "nit: Same comment as above. The only reason I call it out is to prevent needing to change the test for minor language changes.", "url": "https://github.com/all-of-us/workbench/pull/4283#discussion_r523237988", "createdAt": "2020-11-13T21:19:47Z", "author": {"login": "petesantos"}, "path": "ui/src/app/pages/workspace/workspace-edit.spec.tsx", "diffHunk": "@@ -216,6 +215,43 @@ describe('WorkspaceEdit', () => {\n     expect(navigate).toHaveBeenCalledTimes(1);\n   });\n \n+  it('defaults to upgrading the CDR Version when duplicating a workspace with an older CDR Version', async() => {\n+    // init the workspace to a non-default CDR version value\n+    const altCdrWorkspace = {...workspace, cdrVersionId: CdrVersionsStubVariables.ALT_WORKSPACE_CDR_VERSION_ID}\n+    currentWorkspaceStore.next(altCdrWorkspace);\n+\n+    // duplication will involve a CDR version upgrade by default\n+    routeConfigDataStore.next({mode: WorkspaceEditMode.Duplicate});\n+\n+    const wrapper = component();\n+    await waitOneTickAndUpdate(wrapper);\n+\n+    const cdrSelection = wrapper.find('[data-test-id=\"select-cdr-version\"]').find('select').props().value;\n+\n+    // default CDR version, not the existing workspace's alt CDR version\n+    expect(cdrSelection).toBe(CdrVersionsStubVariables.DEFAULT_WORKSPACE_CDR_VERSION_ID);\n+\n+    const expectedUpgradeMessage1 = `You're duplicating the workspace \"${altCdrWorkspace.name}\" to upgrade from`;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59161b85e8ee49b22c94ddf62933c5fc6e3501fa"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3738, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}