{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3OTAzOTAw", "number": 4198, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjo0MToyN1rOEwhtjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzoxOToxN1rOEw3h2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MzE5NDM3OnYy", "diffSide": "LEFT", "path": "ui/src/app/components/side-nav.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjo0MToyN1rOHmJ-dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjo0MToyN1rOHmJ-dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc3MTM4Mg==", "bodyText": "Corrected this one to be RESEARCHERDATAVIEW", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r509771382", "createdAt": "2020-10-21T22:41:27Z", "author": {"login": "jmthibault79"}, "path": "ui/src/app/components/side-nav.tsx", "diffHunk": "@@ -331,47 +332,47 @@ export class SideNav extends React.Component<SideNavProps, SideNavState> {\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.ACCESSCONTROLADMIN) && this.state.showAdminOptions && <SideNavItem\n+        hasAuthorityForPage(profile, AuthGuardedPage.USER_ADMIN) && this.state.showAdminOptions && <SideNavItem\n           content={'User Admin'}\n           onToggleSideNav={() => this.props.onToggleSideNav()}\n           href={'/admin/user'}\n           active={this.props.userAdminActive}\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.ACCESSCONTROLADMIN) && this.state.showAdminOptions && <SideNavItem\n+        hasAuthorityForPage(profile, AuthGuardedPage.USER_AUDIT) && this.state.showAdminOptions && <SideNavItem\n             content={'User Audit'}\n             onToggleSideNav={() => this.props.onToggleSideNav()}\n             href={'/admin/user-audit/'}\n             active={this.props.userAuditActive}\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.COMMUNICATIONSADMIN) && this.state.showAdminOptions && <SideNavItem\n+        hasAuthorityForPage(profile, AuthGuardedPage.SERVICE_BANNER) && this.state.showAdminOptions && <SideNavItem\n             content={'Service Banners'}\n             onToggleSideNav={() => this.props.onToggleSideNav()}\n             href={'/admin/banner'}\n             active={this.props.bannerAdminActive}\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.RESEARCHERDATAVIEW) && this.state.showAdminOptions && <SideNavItem\n+        hasAuthorityForPage(profile, AuthGuardedPage.WORKSPACE_ADMIN) && this.state.showAdminOptions && <SideNavItem\n             content={'Workspaces'}\n             onToggleSideNav={() => this.props.onToggleSideNav()}\n             href={'admin/workspaces'}\n             active={this.props.workspaceAdminActive}\n         />\n       }\n       {\n-        profile.authorities.includes(Authority.ACCESSCONTROLADMIN) && this.state.showAdminOptions && <SideNavItem", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c0371f86d2dae1795a34bc7b74b10f67476493"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MzIwNDg3OnYy", "diffSide": "RIGHT", "path": "ui/src/app/utils/auth.tsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjo0NDoyOFrOHmKFOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMjo0NDoyOFrOHmKFOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTc3MzExMg==", "bodyText": "Thank you for centralizing this. Could you also add the following logic while we're here to address this long-standing UI bug? https://precisionmedicineinitiative.atlassian.net/browse/RW-4852\nprofile.authorities.includes(Authority.DEVELOPER) || ...", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r509773112", "createdAt": "2020-10-21T22:44:28Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,30 @@\n+// utilities around Authority and page-based authorization\n+\n+import {Authority, Profile} from 'generated/fetch';\n+\n+// Admin pages guarded by a particular Authority\n+enum AuthGuardedPage {\n+    USER_ADMIN,\n+    USER_AUDIT,\n+    WORKSPACE_ADMIN,\n+    WORKSPACE_AUDIT,\n+    SERVICE_BANNER,\n+    INSTITUTION_ADMIN,\n+}\n+\n+const authorityByPage: Map<AuthGuardedPage, Authority> = new Map([\n+    [AuthGuardedPage.USER_ADMIN, Authority.ACCESSCONTROLADMIN],\n+    [AuthGuardedPage.USER_AUDIT, Authority.ACCESSCONTROLADMIN],\n+    [AuthGuardedPage.WORKSPACE_ADMIN, Authority.RESEARCHERDATAVIEW],\n+    [AuthGuardedPage.WORKSPACE_AUDIT, Authority.RESEARCHERDATAVIEW],\n+    [AuthGuardedPage.SERVICE_BANNER, Authority.COMMUNICATIONSADMIN],\n+    [AuthGuardedPage.INSTITUTION_ADMIN, Authority.INSTITUTIONADMIN],\n+]);\n+\n+const hasAuthorityForPage = (profile: Profile, page: AuthGuardedPage): boolean =>\n+    profile.authorities.includes(authorityByPage.get(page));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91c0371f86d2dae1795a34bc7b74b10f67476493"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5NjQ4MjA4OnYy", "diffSide": "RIGHT", "path": "ui/src/app/utils/auth.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjowODoxNFrOHmpS2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNjowODoxNFrOHmpS2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDI4NDUwNQ==", "bodyText": "can't simplify to .some(adminMenuAuthorities.has) because the default signature for some() has extra params", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510284505", "createdAt": "2020-10-22T16:08:14Z", "author": {"login": "jmthibault79"}, "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,52 @@\n+// utilities around Authority and page-based authorization\n+\n+import {Authority, Profile} from 'generated/fetch';\n+\n+// Admin actions guarded by a particular Authority\n+enum AuthGuardedAction {\n+    SHOW_ADMIN_MENU,\n+    USER_ADMIN,\n+    USER_AUDIT,\n+    WORKSPACE_ADMIN,\n+    WORKSPACE_AUDIT,\n+    SERVICE_BANNER,\n+    INSTITUTION_ADMIN,\n+    PUBLISH_WORKSPACE,\n+}\n+\n+// The full set of Authorities which guard admin-menu actions\n+const adminMenuAuthorities = new Set([\n+  Authority.ACCESSCONTROLADMIN,\n+  Authority.RESEARCHERDATAVIEW,\n+  Authority.COMMUNICATIONSADMIN,\n+  Authority.INSTITUTIONADMIN,\n+]);\n+\n+const authorityByPage: Map<AuthGuardedAction, Authority> = new Map([\n+    [AuthGuardedAction.USER_ADMIN, Authority.ACCESSCONTROLADMIN],\n+    [AuthGuardedAction.USER_AUDIT, Authority.ACCESSCONTROLADMIN],\n+    [AuthGuardedAction.WORKSPACE_ADMIN, Authority.RESEARCHERDATAVIEW],\n+    [AuthGuardedAction.WORKSPACE_AUDIT, Authority.RESEARCHERDATAVIEW],\n+    [AuthGuardedAction.SERVICE_BANNER, Authority.COMMUNICATIONSADMIN],\n+    [AuthGuardedAction.INSTITUTION_ADMIN, Authority.INSTITUTIONADMIN],\n+    [AuthGuardedAction.PUBLISH_WORKSPACE, Authority.FEATUREDWORKSPACEADMIN],\n+]);\n+\n+const hasAuthorityForAction = (profile: Profile, action: AuthGuardedAction): boolean => {\n+  // DEVELOPER is the super-Authority which includes all others\n+  if (profile.authorities.includes(Authority.DEVELOPER)) {\n+    return true;\n+  }\n+\n+  // return true if we have any of the menu-displaying authorities\n+  if (action === AuthGuardedAction.SHOW_ADMIN_MENU) {\n+    return profile.authorities.some(auth => adminMenuAuthorities.has(auth));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5Njc2MTQ3OnYy", "diffSide": "RIGHT", "path": "ui/src/app/pages/workspace/workspace-about.tsx", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzoxNzoyMlrOHmsBHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzoxNzoyMlrOHmsBHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMyOTExNw==", "bodyText": "We should move this to the workspace admin page eventually - I filed https://precisionmedicineinitiative.atlassian.net/browse/RW-5786", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510329117", "createdAt": "2020-10-22T17:17:22Z", "author": {"login": "calbach"}, "path": "ui/src/app/pages/workspace/workspace-about.tsx", "diffHunk": "@@ -204,12 +204,16 @@ export const WorkspaceAbout = fp.flow(withUserProfile(), withUrlParams(), withCd\n     return <div style={styles.mainPage}>\n       <FlexColumn style={{margin: '1rem', width: '98%'}}>\n         <ResearchPurpose data-test-id='researchPurpose'/>\n-        {profile.authorities.includes(Authority.FEATUREDWORKSPACEADMIN) &&\n-        <div style={{display: 'flex', justifyContent: 'flex-end'}}>\n-            <Button disabled={publishing} type='secondary'\n-                    onClick={() => this.publishUnpublishWorkspace(false)}>Unpublish</Button>\n-            <Button onClick={() => this.publishUnpublishWorkspace(true)}\n-                    disabled={publishing} style={{marginLeft: '0.5rem'}}>Publish</Button>\n+        {hasAuthorityForAction(profile, AuthGuardedAction.PUBLISH_WORKSPACE) &&\n+          <div style={{display: 'flex', justifyContent: 'flex-end'}}>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5Njc2NzgxOnYy", "diffSide": "RIGHT", "path": "ui/src/app/utils/auth.tsx", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzoxOTowMVrOHmsE_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzo0MTowOFrOHms6Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzMDExMA==", "bodyText": "nit: auth usually means authentication, authorization, or both. Here I think it means authority instead, I would probably rename the file to authorities.tsx to be more explicit and avoid a third disambiguation", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510330110", "createdAt": "2020-10-22T17:19:01Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,52 @@\n+// utilities around Authority and page-based authorization", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM0Mzc0Mw==", "bodyText": "good call", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510343743", "createdAt": "2020-10-22T17:41:08Z", "author": {"login": "jmthibault79"}, "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,52 @@\n+// utilities around Authority and page-based authorization", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzMDExMA=="}, "originalCommit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5Njc2ODg4OnYy", "diffSide": "RIGHT", "path": "ui/src/app/utils/auth.tsx", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzoxOToxN1rOHmsFkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNzoxOToxN1rOHmsFkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDMzMDI1OA==", "bodyText": "nit: per above comment, I would spell this out as AuthorityGuardedAction", "url": "https://github.com/all-of-us/workbench/pull/4198#discussion_r510330258", "createdAt": "2020-10-22T17:19:17Z", "author": {"login": "calbach"}, "path": "ui/src/app/utils/auth.tsx", "diffHunk": "@@ -0,0 +1,52 @@\n+// utilities around Authority and page-based authorization\n+\n+import {Authority, Profile} from 'generated/fetch';\n+\n+// Admin actions guarded by a particular Authority\n+enum AuthGuardedAction {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96d41dfc49abe1692fe583f766132d657aee6595"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3875, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}