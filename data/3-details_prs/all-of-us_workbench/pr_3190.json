{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwMzkzMzY4", "number": 3190, "title": "[risk=low] Back end updates for RW-4160 which we need for RW-4161", "bodyText": "Description:\nRW-4160 (Inst Affil user model) did not quite match the needs of RW-4161 (Inst Affil UI).  This is why we do API and UI work together!\nI'm more confident in this version because my UI PR actually uses it.  This PR is included in #3194\nThe current endpoints should be restricted to INSTITUTION_ADMIN users, because they reveal email patterns, which are sensitive.  Non-admin users do not need any direct access, because the relevant details (shortName and displayName) for their Verified Institutional Affiliation are available as part of the V.I.A. model.  Instead, we need a non-authenticated endpoint to list all institutions without emails, to enable institution selection as part of the signup process.\n\nPR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-02-26T16:50:16Z", "url": "https://github.com/all-of-us/workbench/pull/3190", "merged": true, "mergeCommit": {"oid": "a4c7c6e5e434e8da675cb647521991994ad2bb24"}, "closed": true, "closedAt": "2020-02-27T16:00:20Z", "author": {"login": "jmthibault79"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIJc2YAH2gAyMzgwMzkzMzY4OmMyNmQ1MmI1NTc2MDY2NmJkNjFmYTI1OGRiN2M3YzhjMzE1OTBmODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIdboLAFqTM2NTc2NzkxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c26d52b55760666bd61fa258db7c7c8c31590f84", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/c26d52b55760666bd61fa258db7c7c8c31590f84", "committedDate": "2020-02-26T16:38:08Z", "message": "Add institutionDisplayName to VerifiedInstitutionalAffiliation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ab27d296ddc10d1a0d376705ec276799598445f", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/2ab27d296ddc10d1a0d376705ec276799598445f", "committedDate": "2020-02-26T16:38:08Z", "message": "Add getPublicInstitutionDetails() and lock down existing endpoints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "873d0341516e1e1c55f82275971fe643efa9ccfb", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/873d0341516e1e1c55f82275971fe643efa9ccfb", "committedDate": "2020-02-26T16:42:37Z", "message": "I'm getting really sick of having to @Import my new classes everywhere"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f", "author": {"user": {"login": "jmthibault79", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/9fdf3a27a89081410b66b7a793bcae32a578373f", "committedDate": "2020-02-26T16:42:37Z", "message": "Rename PI like Greg suggested recently"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MDcwODIz", "url": "https://github.com/all-of-us/workbench/pull/3190#pullrequestreview-365070823", "createdAt": "2020-02-26T16:53:46Z", "commit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo1Mzo0NlrOFuzwqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo1Mzo0NlrOFuzwqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYyNjg1OA==", "bodyText": "Regular users should not be able to see the Inst's list of approved individual email addrs", "url": "https://github.com/all-of-us/workbench/pull/3190#discussion_r384626858", "createdAt": "2020-02-26T16:53:46Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/api/InstitutionController.java", "diffHunk": "@@ -34,6 +35,7 @@\n   }\n \n   @Override\n+  @AuthorityRequired({Authority.INSTITUTION_ADMIN})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MDcxNDM1", "url": "https://github.com/all-of-us/workbench/pull/3190#pullrequestreview-365071435", "createdAt": "2020-02-26T16:54:28Z", "commit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo1NDoyOFrOFuzyuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo1NDoyOFrOFuzyuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYyNzM4NA==", "bodyText": "OK Greg you were right", "url": "https://github.com/all-of-us/workbench/pull/3190#discussion_r384627384", "createdAt": "2020-02-26T16:54:28Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/db/model/DbStorageEnums.java", "diffHunk": "@@ -344,7 +344,7 @@ public static Short organizationTypeToStorage(OrganizationType organizationType)\n           .put(InstitutionalRole.LATE_CAREER, (short) 5)\n           .put(InstitutionalRole.PRE_DOCTORAL, (short) 6)\n           .put(InstitutionalRole.POST_DOCTORAL, (short) 7)\n-          .put(InstitutionalRole.PI, (short) 8)\n+          .put(InstitutionalRole.SENIOR_RESEARCHER, (short) 8)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MDcyNDk2", "url": "https://github.com/all-of-us/workbench/pull/3190#pullrequestreview-365072496", "createdAt": "2020-02-26T16:55:44Z", "commit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo1NTo0NFrOFuz2EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo1NTo0NFrOFuz2EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYyODI0MQ==", "bodyText": "Don't even need to specify the mappings!\nThis is because it's a subset and the names and types are the same.", "url": "https://github.com/all-of-us/workbench/pull/3190#discussion_r384628241", "createdAt": "2020-02-26T16:55:44Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/institution/PublicInstitutionDetailsMapper.java", "diffHunk": "@@ -0,0 +1,10 @@\n+package org.pmiops.workbench.institution;\n+\n+import org.mapstruct.Mapper;\n+import org.pmiops.workbench.db.model.DbInstitution;\n+import org.pmiops.workbench.model.PublicInstitutionDetails;\n+\n+@Mapper(componentModel = \"spring\")\n+public interface PublicInstitutionDetailsMapper {\n+  PublicInstitutionDetails dbToModel(DbInstitution dbObject);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MDc0NjY0", "url": "https://github.com/all-of-us/workbench/pull/3190#pullrequestreview-365074664", "createdAt": "2020-02-26T16:58:24Z", "commit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo1ODoyNFrOFuz8fQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo1ODoyNFrOFuz8fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYyOTg4NQ==", "bodyText": "well.  OTHER is still one of these types.  Maybe I should just remove this.", "url": "https://github.com/all-of-us/workbench/pull/3190#discussion_r384629885", "createdAt": "2020-02-26T16:58:24Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -4407,6 +4426,28 @@ definitions:\n         items:\n           type: string\n \n+  PublicInstitutionDetails:\n+    type: object\n+    description: >\n+      Represents an institution which has been approved to validate researchers who wish to use the system.\n+      Does not include the sensitive email patterns used to validate users.\n+    required:\n+      - shortName\n+      - displayName\n+      - organizationTypeEnum\n+    properties:\n+      shortName:\n+        type: string\n+        description: A short unique name for the Institution used as an identifier, such as 'VUMC'\n+      displayName:\n+        type: string\n+        description: A more descriptive name for the Institution, such as 'Vanderbilt University Medical Center'\n+      organizationTypeEnum:\n+        $ref: '#/definitions/OrganizationType'\n+        description: >\n+          The Organization Type of this institution if it is one of the enumerated\n+          OrganizationTypes, or OrganizationType.OTHER if it is not", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MDc1Nzc1", "url": "https://github.com/all-of-us/workbench/pull/3190#pullrequestreview-365075775", "createdAt": "2020-02-26T16:59:40Z", "commit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo1OTo0MFrOFuz_vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNjo1OTo0MFrOFuz_vQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYzMDcxNw==", "bodyText": "These are ultimately due to the inclusion of UserService", "url": "https://github.com/all-of-us/workbench/pull/3190#discussion_r384630717", "createdAt": "2020-02-26T16:59:40Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/api/ClusterControllerTest.java", "diffHunk": "@@ -108,7 +109,8 @@\n     ClusterController.class,\n     UserServiceImpl.class,\n     InstitutionServiceImpl.class,\n-    InstitutionMapperImpl.class\n+    InstitutionMapperImpl.class,\n+    PublicInstitutionDetailsMapperImpl.class", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MDc2NTA1", "url": "https://github.com/all-of-us/workbench/pull/3190#pullrequestreview-365076505", "createdAt": "2020-02-26T17:00:34Z", "commit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNzowMDozNFrOFu0B3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNzowMDozNFrOFu0B3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDYzMTI2MA==", "bodyText": "yes there are a few actual test changes down here", "url": "https://github.com/all-of-us/workbench/pull/3190#discussion_r384631260", "createdAt": "2020-02-26T17:00:34Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/api/ProfileControllerTest.java", "diffHunk": "@@ -446,6 +448,7 @@ public void testMe_verifiedInstitutionalAffiliation() {\n     final VerifiedInstitutionalAffiliation verifiedInstitutionalAffiliation =\n         new VerifiedInstitutionalAffiliation()\n             .institutionShortName(broad.getShortName())\n+            .institutionDisplayName(broad.getDisplayName())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NzY3OTE2", "url": "https://github.com/all-of-us/workbench/pull/3190#pullrequestreview-365767916", "createdAt": "2020-02-27T15:40:41Z", "commit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNTo0MDo0MlrOFvWVvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNTo0MDo0MlrOFvWVvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE5MzQwNw==", "bodyText": "Could this contain an institution with minimal details? It feels like there's some overlap which implies we could build a hierarchy?", "url": "https://github.com/all-of-us/workbench/pull/3190#discussion_r385193407", "createdAt": "2020-02-27T15:40:42Z", "author": {"login": "s-rubenstein"}, "path": "api/src/main/resources/workbench.yaml", "diffHunk": "@@ -4407,6 +4426,28 @@ definitions:\n         items:\n           type: string\n \n+  PublicInstitutionDetails:\n+    type: object\n+    description: >\n+      Represents an institution which has been approved to validate researchers who wish to use the system.\n+      Does not include the sensitive email patterns used to validate users.\n+    required:\n+      - shortName", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fdf3a27a89081410b66b7a793bcae32a578373f"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3388, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}