{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczNTk1NTM4", "number": 3921, "title": "[RW-5380][risk=no] API - CohortReviewController should use CohortBuilderService instead of CBCriteriaDao", "bodyText": "PR checklist\n\n This PR meets the Acceptance Criteria in the JIRA story\n The JIRA story has been moved to Dev Review\n This PR includes appropriate unit tests\n I have run and tested this change locally\n I have run the E2E tests on ths change against my local UI + API server with yarn test:local\n If this includes a UI change, I have taken screen recordings or screenshots of the new behavior and notified the PO and UX designer\n If this includes an API change, I have updated the appropriate Swagger definitions and notified API consumers\n If this includes a new feature flag, I have created and linked new JIRA tickets to (a) turn on the feature flag and (b) remove it later", "createdAt": "2020-08-26T01:55:09Z", "url": "https://github.com/all-of-us/workbench/pull/3921", "merged": true, "mergeCommit": {"oid": "24029089bcc406f69bdf88fe4bf97f8a0f2a37f2"}, "closed": true, "closedAt": "2020-08-27T18:28:59Z", "author": {"login": "NehaBroad"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCh4kEAH2gAyNDczNTk1NTM4OjJlNjMzNGQ5MDU3ZWRjZjdiOThlMDg5NWVjNmJlMDNjMDg4ZjA0Yzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDEKaUAH2gAyNDczNTk1NTM4OjNlNTdiMDkzY2UzZmExNTk3MjA5ZmQxMzRjMmE4NTZmZTkyNWU4YzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2e6334d9057edcf7b98e0895ec6be03c088f04c7", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/2e6334d9057edcf7b98e0895ec6be03c088f04c7", "committedDate": "2020-08-26T01:53:44Z", "message": "Use Service not CbCriteriaDao"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaa30853244c32bac9896040342a9c8941d43832", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/aaa30853244c32bac9896040342a9c8941d43832", "committedDate": "2020-08-26T02:42:08Z", "message": "Fix BQ and Api test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NjE1Mjg2", "url": "https://github.com/all-of-us/workbench/pull/3921#pullrequestreview-475615286", "createdAt": "2020-08-26T15:38:35Z", "commit": {"oid": "aaa30853244c32bac9896040342a9c8941d43832"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNTozODozNVrOHHSC4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNTozODozNVrOHHSC4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM5NzcyOA==", "bodyText": "I was thinking about moving the logic to update PageRequest inside cohortBuilderService as well, replacing the entire method. Let me know what you think", "url": "https://github.com/all-of-us/workbench/pull/3921#discussion_r477397728", "createdAt": "2020-08-26T15:38:35Z", "author": {"login": "NehaBroad"}, "path": "api/src/main/java/org/pmiops/workbench/api/CohortReviewController.java", "diffHunk": "@@ -745,25 +732,10 @@ private DbCohortReview createNewCohortReview(\n   private void convertGenderRaceEthnicitySortOrder(PageRequest pageRequest) {\n     String sortColumn = pageRequest.getSortColumn();\n     String sortName = pageRequest.getSortOrder().name();\n-    Sort sort =\n-        sortName.equalsIgnoreCase(Direction.ASC.toString())\n-            ? new Sort(Direction.ASC, \"name\")\n-            : new Sort(Direction.DESC, \"name\");\n     if (GENDER_RACE_ETHNICITY_TYPES.contains(sortColumn)) {\n-      List<DbCriteria> criteriaList =\n-          cbCriteriaDao.findByDomainIdAndTypeAndParentIdNotIn(\n-              DomainType.PERSON.toString(), sortColumn, 0L, sort);\n-      Map<String, Map<Long, String>> concepts = new HashMap<>();\n       List<String> demoList =\n-          criteriaList.stream()\n-              .map(\n-                  c ->\n-                      new ConceptIdName()\n-                          .conceptId(new Long(c.getConceptId()))\n-                          .conceptName(c.getName()))\n-              .sorted(Comparator.comparing(ConceptIdName::getConceptName))\n-              .map(c -> c.getConceptId().toString())\n-              .collect(Collectors.toList());\n+          cohortBuilderService.findSortedConceptIdsByDomainIdAndTypeAndParentIdNotIn(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aaa30853244c32bac9896040342a9c8941d43832"}, "originalPosition": 156}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2ODkwMjk0", "url": "https://github.com/all-of-us/workbench/pull/3921#pullrequestreview-476890294", "createdAt": "2020-08-27T16:29:24Z", "commit": {"oid": "aaa30853244c32bac9896040342a9c8941d43832"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxNjoyOToyNFrOHIYKqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxNjoyOToyNFrOHIYKqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU0NjYwMw==", "bodyText": "That seems fine.", "url": "https://github.com/all-of-us/workbench/pull/3921#discussion_r478546603", "createdAt": "2020-08-27T16:29:24Z", "author": {"login": "freemabd"}, "path": "api/src/main/java/org/pmiops/workbench/api/CohortReviewController.java", "diffHunk": "@@ -745,25 +732,10 @@ private DbCohortReview createNewCohortReview(\n   private void convertGenderRaceEthnicitySortOrder(PageRequest pageRequest) {\n     String sortColumn = pageRequest.getSortColumn();\n     String sortName = pageRequest.getSortOrder().name();\n-    Sort sort =\n-        sortName.equalsIgnoreCase(Direction.ASC.toString())\n-            ? new Sort(Direction.ASC, \"name\")\n-            : new Sort(Direction.DESC, \"name\");\n     if (GENDER_RACE_ETHNICITY_TYPES.contains(sortColumn)) {\n-      List<DbCriteria> criteriaList =\n-          cbCriteriaDao.findByDomainIdAndTypeAndParentIdNotIn(\n-              DomainType.PERSON.toString(), sortColumn, 0L, sort);\n-      Map<String, Map<Long, String>> concepts = new HashMap<>();\n       List<String> demoList =\n-          criteriaList.stream()\n-              .map(\n-                  c ->\n-                      new ConceptIdName()\n-                          .conceptId(new Long(c.getConceptId()))\n-                          .conceptName(c.getName()))\n-              .sorted(Comparator.comparing(ConceptIdName::getConceptName))\n-              .map(c -> c.getConceptId().toString())\n-              .collect(Collectors.toList());\n+          cohortBuilderService.findSortedConceptIdsByDomainIdAndTypeAndParentIdNotIn(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM5NzcyOA=="}, "originalCommit": {"oid": "aaa30853244c32bac9896040342a9c8941d43832"}, "originalPosition": 156}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e57b093ce3fa1597209fd134c2a856fe925e8c6", "author": {"user": {"login": "NehaBroad", "name": null}}, "url": "https://github.com/all-of-us/workbench/commit/3e57b093ce3fa1597209fd134c2a856fe925e8c6", "committedDate": "2020-08-27T17:50:00Z", "message": "Merge"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4354, "cost": 1, "resetAt": "2021-10-29T17:30:11Z"}}}