{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MDE5MDcz", "number": 4116, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1Mjo0OVrOEq2xCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjowOTozNVrOErzs9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzcyOTM5OnYy", "diffSide": "RIGHT", "path": "api/reporting/schemas/latest/user.json", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1Mjo0OVrOHdTVnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1Mjo0OVrOHdTVnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NzU4MA==", "bodyText": "These mean the same thing, but BigQuery is increasingly favoring INTEGER. Additionally, using INT64 causes Terraform to get into a loop, as BQ always accepts it but shows INTEGER, and TF always thinks it needs to make a change.", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r500487580", "createdAt": "2020-10-06T17:52:49Z", "author": {"login": "jaycarlton"}, "path": "api/reporting/schemas/latest/user.json", "diffHunk": "@@ -61,7 +61,7 @@\n   },\n   {\n     \"name\": \"data_use_agreement_signed_version\",\n-    \"type\": \"INT64\",\n+    \"type\": \"INTEGER\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e29fcb773af97303955d915878a716c9253e07f6"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzczMTk2OnYy", "diffSide": "RIGHT", "path": "api/reporting/schemas/reporting-wizard.rb", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1MzozNVrOHdTXUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1MzozNVrOHdTXUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4ODAxNw==", "bodyText": "This override stuff should be pulled out into an input file soon. I have a ticket for that.", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r500488017", "createdAt": "2020-10-06T17:53:35Z", "author": {"login": "jaycarlton"}, "path": "api/reporting/schemas/reporting-wizard.rb", "diffHunk": "@@ -172,6 +179,29 @@ def to_output_path(subdir_name, suffix)\n              :bigquery => 'STRING',\n              :default_constant_value => 1 # REGISTERED\n          }\n+     },\n+     # Unlike some other entity  classes, DbInstitution exposes typed enum values.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e29fcb773af97303955d915878a716c9253e07f6"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzczNTU0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/db/dao/projection/ProjectedReportingInstitution.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1NDoyOVrOHdTZmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1NDoyOVrOHdTZmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4ODYwMg==", "bodyText": "Since the entity class does these enums the \"right way\", I had to make sure not to drop back to Short in the generated code.", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r500488602", "createdAt": "2020-10-06T17:54:29Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/db/dao/projection/ProjectedReportingInstitution.java", "diffHunk": "@@ -0,0 +1,29 @@\n+package org.pmiops.workbench.db.dao.projection;\n+\n+// This is a Spring Data projection interface for the Hibernate entity\n+// class DbInstitution. The properties listed correspond to query results\n+// that will be mapped into BigQuery rows in a (mostly) 1:1 fashion.\n+// Fields may not be renamed or reordered or have their types\n+// changed unless both the entity class and any queries returning\n+// this projection type are in complete agreement.\n+\n+// This code was generated using reporting-wizard.rb at 2020-10-05T09:51:25-04:00.\n+// Manual modification should be avoided if possible as this is a one-time generation\n+// and does not run on every build and updates must be merged manually for now.\n+\n+import org.pmiops.workbench.model.DuaType;\n+import org.pmiops.workbench.model.OrganizationType;\n+\n+public interface ProjectedReportingInstitution {\n+  String getDisplayName();\n+\n+  DuaType getDuaTypeEnum();\n+\n+  Long getInstitutionId();\n+\n+  OrganizationType getOrganizationTypeEnum();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e29fcb773af97303955d915878a716c9253e07f6"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzc0MDI0OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/reporting/ReportingService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1NTozNlrOHdTccQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1NTozNlrOHdTccQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4OTMyOQ==", "bodyText": "Since cron jobs only report 204 or 500, the enum wasn't making much sense. However, I do continue jobs as far as I can before throwing an exception today.", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r500489329", "createdAt": "2020-10-06T17:55:36Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/reporting/ReportingService.java", "diffHunk": "@@ -6,5 +6,5 @@\n  * daily) uploads, and aggregate and time-series metrics are computed in BigQuery.\n  */\n public interface ReportingService {\n-  ReportingJobResult takeAndUploadSnapshot();\n+  void takeAndUploadSnapshot();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e29fcb773af97303955d915878a716c9253e07f6"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzc0NzAzOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/reporting/ReportingUploadServiceDmlImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1NzoxNVrOHdTgcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1NzoxNVrOHdTgcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5MDM1NA==", "bodyText": "These are easy to forget, especially when there are two upload service implementations. I'm thinking about consolidating them into their own thing, like an enum to rule the enums. It could hold the table name and have a method to fetch the extractor values from the other enum.", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r500490354", "createdAt": "2020-10-06T17:57:15Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/reporting/ReportingUploadServiceDmlImpl.java", "diffHunk": "@@ -3,58 +3,88 @@\n import com.google.cloud.bigquery.QueryJobConfiguration;\n import com.google.cloud.bigquery.QueryParameterValue;\n import com.google.cloud.bigquery.TableResult;\n+import com.google.common.base.Stopwatch;\n import com.google.common.collect.ImmutableList;\n import com.google.common.collect.ImmutableList.Builder;\n-import com.google.common.collect.ImmutableMap;\n import com.google.common.collect.Lists;\n import java.time.Duration;\n import java.util.List;\n-import java.util.Map;\n-import java.util.function.Function;\n+import java.util.Optional;\n import java.util.logging.Logger;\n+import java.util.regex.Pattern;\n import javax.inject.Provider;\n import org.pmiops.workbench.api.BigQueryService;\n import org.pmiops.workbench.config.WorkbenchConfig;\n+import org.pmiops.workbench.model.ReportingCohort;\n+import org.pmiops.workbench.model.ReportingInstitution;\n import org.pmiops.workbench.model.ReportingSnapshot;\n import org.pmiops.workbench.model.ReportingUser;\n import org.pmiops.workbench.model.ReportingWorkspace;\n+import org.pmiops.workbench.reporting.insertion.CohortColumnValueExtractor;\n import org.pmiops.workbench.reporting.insertion.DmlInsertJobBuilder;\n+import org.pmiops.workbench.reporting.insertion.InstitutionColumnValueExtractor;\n import org.pmiops.workbench.reporting.insertion.UserColumnValueExtractor;\n import org.pmiops.workbench.reporting.insertion.WorkspaceColumnValueExtractor;\n+import org.pmiops.workbench.utils.LogFormatters;\n+import org.pmiops.workbench.utils.Matchers;\n import org.springframework.context.annotation.Primary;\n import org.springframework.stereotype.Service;\n \n @Service(\"REPORTING_UPLOAD_SERVICE_DML_IMPL\")\n @Primary\n public class ReportingUploadServiceDmlImpl implements ReportingUploadService {\n \n-  private static final Logger logger = Logger.getLogger(\"ReportingUploadServiceInsertQueryImpl\");\n+  private static final Logger logger =\n+      Logger.getLogger(ReportingUploadServiceDmlImpl.class.getName());\n   private static final long MAX_WAIT_TIME = Duration.ofSeconds(60).toMillis();\n \n   private final BigQueryService bigQueryService;\n+  private final Provider<Stopwatch> stopwatchProvider;\n   private final Provider<WorkbenchConfig> workbenchConfigProvider;\n \n   private static final DmlInsertJobBuilder<ReportingUser> userJobBuilder =\n       UserColumnValueExtractor::values;\n+\n+  private static final DmlInsertJobBuilder<ReportingCohort> cohortJobBuilder =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e29fcb773af97303955d915878a716c9253e07f6"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzYwNjY1OnYy", "diffSide": "RIGHT", "path": "api/reporting/schemas/reporting-wizard.rb", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMTozMToxMFrOHexIJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjozNTowMFrOHfHzqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyNDIzMQ==", "bodyText": "The other 2 defaults are reasonable, but I'm not sure about this one.  I'd go with OTHER probably", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502024231", "createdAt": "2020-10-08T21:31:10Z", "author": {"login": "jmthibault79"}, "path": "api/reporting/schemas/reporting-wizard.rb", "diffHunk": "@@ -172,6 +179,29 @@ def to_output_path(subdir_name, suffix)\n              :bigquery => 'STRING',\n              :default_constant_value => 1 # REGISTERED\n          }\n+     },\n+     # Unlike some other entity  classes, DbInstitution exposes typed enum values.\n+     'institution' => {\n+         'dua_type_enum' => {\n+             :projection => 'DuaType',\n+             :swagger => 'DuaType',\n+             :bigquery => 'STRING',\n+             :default_constant_value => 'DuaType.MASTER'\n+         },\n+         'organization_type_enum' => {\n+             :projection => 'OrganizationType',\n+             :swagger => 'OrganizationType',\n+             :bigquery => 'STRING',\n+             :default_constant_value => 'OrganizationType.ACADEMIC_RESEARCH_INSTITUTION'\n+         }\n+     },\n+     'user_verified_institutional_affiliation' => {\n+         'institutional_role_enum' => {\n+             :projection => 'InstitutionalRole',\n+             :swagger => 'InstitutionalRole',\n+             :bigquery => 'STRING',\n+             :default_constant_value => 'InstitutionalRole.UNDERGRADUATE'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5NTgxNg==", "bodyText": "These defaults only apply to unit test object instantiation. Only thing we care about is that it's a valid value.\nThis whole script is on life support until we do https://precisionmedicineinitiative.atlassian.net/browse/RW-5695, so I don't want to pull any threads if we can help it.", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502395816", "createdAt": "2020-10-09T12:35:00Z", "author": {"login": "jaycarlton"}, "path": "api/reporting/schemas/reporting-wizard.rb", "diffHunk": "@@ -172,6 +179,29 @@ def to_output_path(subdir_name, suffix)\n              :bigquery => 'STRING',\n              :default_constant_value => 1 # REGISTERED\n          }\n+     },\n+     # Unlike some other entity  classes, DbInstitution exposes typed enum values.\n+     'institution' => {\n+         'dua_type_enum' => {\n+             :projection => 'DuaType',\n+             :swagger => 'DuaType',\n+             :bigquery => 'STRING',\n+             :default_constant_value => 'DuaType.MASTER'\n+         },\n+         'organization_type_enum' => {\n+             :projection => 'OrganizationType',\n+             :swagger => 'OrganizationType',\n+             :bigquery => 'STRING',\n+             :default_constant_value => 'OrganizationType.ACADEMIC_RESEARCH_INSTITUTION'\n+         }\n+     },\n+     'user_verified_institutional_affiliation' => {\n+         'institutional_role_enum' => {\n+             :projection => 'InstitutionalRole',\n+             :swagger => 'InstitutionalRole',\n+             :bigquery => 'STRING',\n+             :default_constant_value => 'InstitutionalRole.UNDERGRADUATE'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyNDIzMQ=="}, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzYxNTM2OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/reporting/ReportingMapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMTozNDoxMFrOHexNUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjo0MDowM1rOHfH9uQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyNTU1NA==", "bodyText": "spellllling", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502025554", "createdAt": "2020-10-08T21:34:10Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/reporting/ReportingMapper.java", "diffHunk": "@@ -17,16 +20,68 @@\n     config = MapStructConfig.class,\n     uses = {CommonMappers.class, DbStorageEnums.class})\n public interface ReportingMapper {\n-  ReportingUser toDto(ProjectedReportingUser prjUser);\n+\n+  ReportingInstitution toReporrtingInstitution(ProjectedReportingInstitution prjInstitution);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5ODM5Mw==", "bodyText": "My laptop keyboard is over-correcting for not being able to type keys by auto-repeating (even with the key repeat feature disabled). If I weren't an Alphabet shareholder I'd requisition a new one.", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502398393", "createdAt": "2020-10-09T12:40:03Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/reporting/ReportingMapper.java", "diffHunk": "@@ -17,16 +20,68 @@\n     config = MapStructConfig.class,\n     uses = {CommonMappers.class, DbStorageEnums.class})\n public interface ReportingMapper {\n-  ReportingUser toDto(ProjectedReportingUser prjUser);\n+\n+  ReportingInstitution toReporrtingInstitution(ProjectedReportingInstitution prjInstitution);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAyNTU1NA=="}, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzY0NDkxOnYy", "diffSide": "RIGHT", "path": "api/src/main/resources/workbench-api.yaml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMTo0NDozN1rOHexfEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzowNDoxMVrOHfIzjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMDA5OA==", "bodyText": "Error: the type field has no type.  This causes the UI to fail compilation.", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502030098", "createdAt": "2020-10-08T21:44:37Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -8446,9 +8467,46 @@ definitions:\n       name:\n         type: string\n         description: User-provided human-readable name for this cohort.\n+      type:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQxMjE3Mg==", "bodyText": "Good catch. Another good argument for moving these non-API classes into their own Swagger file and output directory.\n@aweng98 Here's a good example of what we were talking about the other day: a Swagger change the UI but doesn't force the UI unit tests to run. I thought at one point we had a bandaid for this in the circle config.\nNo relevant changes in ui directory on non-master branch. halting job.\n\nIt looks like it passes yarn codegen and then fails at runtime \ud83e\udd37 .\nIt would also be awesome if a skipped job showed up as skipped/cancelled instead of passed, though that might break the github presubmit gate. \ud83e\udd14", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502412172", "createdAt": "2020-10-09T13:04:11Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/resources/workbench-api.yaml", "diffHunk": "@@ -8446,9 +8467,46 @@ definitions:\n       name:\n         type: string\n         description: User-provided human-readable name for this cohort.\n+      type:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMDA5OA=="}, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzY2MDM3OnYy", "diffSide": "RIGHT", "path": "api/src/main/java/org/pmiops/workbench/reporting/ReportingMapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMTo1MDowNVrOHexoYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjozNjo0N1rOHfH3UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMjQ4Mw==", "bodyText": "does this need to be contained within the ReportingMapper class?", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502032483", "createdAt": "2020-10-08T21:50:05Z", "author": {"login": "jmthibault79"}, "path": "api/src/main/java/org/pmiops/workbench/reporting/ReportingMapper.java", "diffHunk": "@@ -17,16 +20,68 @@\n     config = MapStructConfig.class,\n     uses = {CommonMappers.class, DbStorageEnums.class})\n public interface ReportingMapper {\n-  ReportingUser toDto(ProjectedReportingUser prjUser);\n+\n+  ReportingInstitution toReporrtingInstitution(ProjectedReportingInstitution prjInstitution);\n+\n+  List<ReportingInstitution> toReportingInstitutionList(\n+      Collection<ProjectedReportingInstitution> institutions);\n+\n+  ReportingUser toReportingUser(ProjectedReportingUser prjUser);\n \n   List<ReportingUser> toReportingUserList(Collection<ProjectedReportingUser> users);\n \n-  ReportingWorkspace toDto(ProjectedReportingWorkspace prjWorkspace);\n+  ReportingWorkspace toReportingWorkspace(ProjectedReportingWorkspace prjWorkspace);\n \n   List<ReportingWorkspace> toReportingWorkspaceList(\n       Collection<ProjectedReportingWorkspace> dbWorkspace);\n \n-  ReportingCohort toDto(ProjectedReportingCohort cohort);\n+  ReportingCohort toReportingCohort(ProjectedReportingCohort cohort);\n \n   List<ReportingCohort> toModelList(Collection<ProjectedReportingCohort> cohorts);\n+\n+  default ReportingSnapshot toReportingSnapshot(\n+      QueryResultBundle queryResultBundle, long snapshotTimestamp) {\n+    return new ReportingSnapshot()\n+        .captureTimestamp(snapshotTimestamp)\n+        .cohorts(toModelList(queryResultBundle.getCohorts()))\n+        .institutions(toReportingInstitutionList(queryResultBundle.getInstitutions()))\n+        .users(toReportingUserList(queryResultBundle.getUsers()))\n+        .workspaces(toReportingWorkspaceList(queryResultBundle.getWorkspaces()));\n+  }\n+\n+  // Define immutable value class to hold results of queries within a transaction. Mapping to\n+  // Reporting DTO classes will happen outside the transaction.\n+  class QueryResultBundle {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM5Njc1Mw==", "bodyText": "Good question. It's an intermediate object that only exists to make timings easier, and it's its only reason to exist is to support mapping reporting inputs.\nI tried it in the impl class, but then it had to be public instead of package private somehow, at which point it makes more sense to give it its own class.", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502396753", "createdAt": "2020-10-09T12:36:47Z", "author": {"login": "jaycarlton"}, "path": "api/src/main/java/org/pmiops/workbench/reporting/ReportingMapper.java", "diffHunk": "@@ -17,16 +20,68 @@\n     config = MapStructConfig.class,\n     uses = {CommonMappers.class, DbStorageEnums.class})\n public interface ReportingMapper {\n-  ReportingUser toDto(ProjectedReportingUser prjUser);\n+\n+  ReportingInstitution toReporrtingInstitution(ProjectedReportingInstitution prjInstitution);\n+\n+  List<ReportingInstitution> toReportingInstitutionList(\n+      Collection<ProjectedReportingInstitution> institutions);\n+\n+  ReportingUser toReportingUser(ProjectedReportingUser prjUser);\n \n   List<ReportingUser> toReportingUserList(Collection<ProjectedReportingUser> users);\n \n-  ReportingWorkspace toDto(ProjectedReportingWorkspace prjWorkspace);\n+  ReportingWorkspace toReportingWorkspace(ProjectedReportingWorkspace prjWorkspace);\n \n   List<ReportingWorkspace> toReportingWorkspaceList(\n       Collection<ProjectedReportingWorkspace> dbWorkspace);\n \n-  ReportingCohort toDto(ProjectedReportingCohort cohort);\n+  ReportingCohort toReportingCohort(ProjectedReportingCohort cohort);\n \n   List<ReportingCohort> toModelList(Collection<ProjectedReportingCohort> cohorts);\n+\n+  default ReportingSnapshot toReportingSnapshot(\n+      QueryResultBundle queryResultBundle, long snapshotTimestamp) {\n+    return new ReportingSnapshot()\n+        .captureTimestamp(snapshotTimestamp)\n+        .cohorts(toModelList(queryResultBundle.getCohorts()))\n+        .institutions(toReportingInstitutionList(queryResultBundle.getInstitutions()))\n+        .users(toReportingUserList(queryResultBundle.getUsers()))\n+        .workspaces(toReportingWorkspaceList(queryResultBundle.getWorkspaces()));\n+  }\n+\n+  // Define immutable value class to hold results of queries within a transaction. Mapping to\n+  // Reporting DTO classes will happen outside the transaction.\n+  class QueryResultBundle {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzMjQ4Mw=="}, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzY5ODMyOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/db/dao/InstitutionDaoTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjowMzo1NVrOHex-fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzoxODo1OVrOHfJWIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzODE0MA==", "bodyText": "does getOrganizationTypeOtherText() return NULL or '' for inst 2?  Add an assert for the correct one", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502038140", "createdAt": "2020-10-08T22:03:55Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/db/dao/InstitutionDaoTest.java", "diffHunk": "@@ -106,4 +112,55 @@ public void test_uniqueDisplayNameRequired() {\n         new DbInstitution().setShortName(\"Inst2\").setDisplayName(\"Not Unique\");\n     institutionDao.save(snowflake2);\n   }\n+\n+  @Test\n+  public void testGetReportingInstitutions() {\n+    DbInstitution institution = ReportingTestUtils.createDbInstitution();\n+    institutionDao.deleteAll();\n+    institution = institutionDao.save(institution);\n+\n+    final List<ProjectedReportingInstitution> institutions =\n+        institutionDao.getReportingInstitutions();\n+    assertThat(institutions).hasSize(1);\n+    ReportingTestUtils.assertInstitutionFields(institutions.get(0));\n+  }\n+\n+  @Test\n+  public void testGetReportingInstitutions_empty() {\n+    institutionDao.deleteAll();\n+    assertThat(institutionDao.getReportingInstitutions()).isEmpty();\n+  }\n+\n+  @Test\n+  public void testGetReportingInstitutions_multiple() {\n+    institutionDao.deleteAll();\n+\n+    DbInstitution institution1 = ReportingTestUtils.createDbInstitution();\n+    institution1.setDisplayName(\"Cairo Consulting\");\n+    institution1.setDuaTypeEnum(DuaType.RESTRICTED);\n+    institution1.setOrganizationTypeEnum(OrganizationType.OTHER);\n+    institution1.setOrganizationTypeOtherText(\"Pyramid Scheme\");\n+\n+    DbInstitution institution2 = new DbInstitution();\n+    institution2.setShortName(\"mash\");\n+    institution2.setDisplayName(\"MASH\");\n+    institution2.setDuaTypeEnum(DuaType.MASTER);\n+    institution2.setOrganizationTypeEnum(OrganizationType.HEALTH_CENTER_NON_PROFIT);\n+\n+    institutionDao.save(ImmutableList.of(institution1, institution2));\n+\n+    final List<ProjectedReportingInstitution> institutions =\n+        institutionDao.getReportingInstitutions();\n+    assertThat(institutions).hasSize(2);\n+    assertThat(institutions.get(0).getDisplayName()).isEqualTo(\"Cairo Consulting\");\n+    assertThat(institutions.get(0).getDuaTypeEnum()).isEqualTo(DuaType.RESTRICTED);\n+    assertThat(institutions.get(0).getOrganizationTypeEnum()).isEqualTo(OrganizationType.OTHER);\n+    assertThat(institutions.get(0).getOrganizationTypeOtherText()).isEqualTo(\"Pyramid Scheme\");\n+\n+    assertThat(institutions.get(1).getDisplayName()).isEqualTo(\"MASH\");\n+    assertThat(institutions.get(1).getDuaTypeEnum()).isEqualTo(DuaType.MASTER);\n+    assertThat(institutions.get(1).getOrganizationTypeEnum())\n+        .isEqualTo(OrganizationType.HEALTH_CENTER_NON_PROFIT);\n+    assertThat(institutions.get(1).getDisplayName()).isEqualTo(\"MASH\");\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwOTIwMg==", "bodyText": "Projections don't do any conversion at all to what's in the DB, so you get whatever is in the table. If the application enforces nullity, that's great, but I don't think we need tests to show that all nullable columns can be null.\nIf we're going to tackle null vs empty, I'd prefer to have a standalone story for that to do it app-wide, maybe even in an interceptor \ud83d\ude08 .", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502409202", "createdAt": "2020-10-09T12:58:50Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/db/dao/InstitutionDaoTest.java", "diffHunk": "@@ -106,4 +112,55 @@ public void test_uniqueDisplayNameRequired() {\n         new DbInstitution().setShortName(\"Inst2\").setDisplayName(\"Not Unique\");\n     institutionDao.save(snowflake2);\n   }\n+\n+  @Test\n+  public void testGetReportingInstitutions() {\n+    DbInstitution institution = ReportingTestUtils.createDbInstitution();\n+    institutionDao.deleteAll();\n+    institution = institutionDao.save(institution);\n+\n+    final List<ProjectedReportingInstitution> institutions =\n+        institutionDao.getReportingInstitutions();\n+    assertThat(institutions).hasSize(1);\n+    ReportingTestUtils.assertInstitutionFields(institutions.get(0));\n+  }\n+\n+  @Test\n+  public void testGetReportingInstitutions_empty() {\n+    institutionDao.deleteAll();\n+    assertThat(institutionDao.getReportingInstitutions()).isEmpty();\n+  }\n+\n+  @Test\n+  public void testGetReportingInstitutions_multiple() {\n+    institutionDao.deleteAll();\n+\n+    DbInstitution institution1 = ReportingTestUtils.createDbInstitution();\n+    institution1.setDisplayName(\"Cairo Consulting\");\n+    institution1.setDuaTypeEnum(DuaType.RESTRICTED);\n+    institution1.setOrganizationTypeEnum(OrganizationType.OTHER);\n+    institution1.setOrganizationTypeOtherText(\"Pyramid Scheme\");\n+\n+    DbInstitution institution2 = new DbInstitution();\n+    institution2.setShortName(\"mash\");\n+    institution2.setDisplayName(\"MASH\");\n+    institution2.setDuaTypeEnum(DuaType.MASTER);\n+    institution2.setOrganizationTypeEnum(OrganizationType.HEALTH_CENTER_NON_PROFIT);\n+\n+    institutionDao.save(ImmutableList.of(institution1, institution2));\n+\n+    final List<ProjectedReportingInstitution> institutions =\n+        institutionDao.getReportingInstitutions();\n+    assertThat(institutions).hasSize(2);\n+    assertThat(institutions.get(0).getDisplayName()).isEqualTo(\"Cairo Consulting\");\n+    assertThat(institutions.get(0).getDuaTypeEnum()).isEqualTo(DuaType.RESTRICTED);\n+    assertThat(institutions.get(0).getOrganizationTypeEnum()).isEqualTo(OrganizationType.OTHER);\n+    assertThat(institutions.get(0).getOrganizationTypeOtherText()).isEqualTo(\"Pyramid Scheme\");\n+\n+    assertThat(institutions.get(1).getDisplayName()).isEqualTo(\"MASH\");\n+    assertThat(institutions.get(1).getDuaTypeEnum()).isEqualTo(DuaType.MASTER);\n+    assertThat(institutions.get(1).getOrganizationTypeEnum())\n+        .isEqualTo(OrganizationType.HEALTH_CENTER_NON_PROFIT);\n+    assertThat(institutions.get(1).getDisplayName()).isEqualTo(\"MASH\");\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzODE0MA=="}, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQyMTAyNw==", "bodyText": "ok", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502421027", "createdAt": "2020-10-09T13:18:59Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/db/dao/InstitutionDaoTest.java", "diffHunk": "@@ -106,4 +112,55 @@ public void test_uniqueDisplayNameRequired() {\n         new DbInstitution().setShortName(\"Inst2\").setDisplayName(\"Not Unique\");\n     institutionDao.save(snowflake2);\n   }\n+\n+  @Test\n+  public void testGetReportingInstitutions() {\n+    DbInstitution institution = ReportingTestUtils.createDbInstitution();\n+    institutionDao.deleteAll();\n+    institution = institutionDao.save(institution);\n+\n+    final List<ProjectedReportingInstitution> institutions =\n+        institutionDao.getReportingInstitutions();\n+    assertThat(institutions).hasSize(1);\n+    ReportingTestUtils.assertInstitutionFields(institutions.get(0));\n+  }\n+\n+  @Test\n+  public void testGetReportingInstitutions_empty() {\n+    institutionDao.deleteAll();\n+    assertThat(institutionDao.getReportingInstitutions()).isEmpty();\n+  }\n+\n+  @Test\n+  public void testGetReportingInstitutions_multiple() {\n+    institutionDao.deleteAll();\n+\n+    DbInstitution institution1 = ReportingTestUtils.createDbInstitution();\n+    institution1.setDisplayName(\"Cairo Consulting\");\n+    institution1.setDuaTypeEnum(DuaType.RESTRICTED);\n+    institution1.setOrganizationTypeEnum(OrganizationType.OTHER);\n+    institution1.setOrganizationTypeOtherText(\"Pyramid Scheme\");\n+\n+    DbInstitution institution2 = new DbInstitution();\n+    institution2.setShortName(\"mash\");\n+    institution2.setDisplayName(\"MASH\");\n+    institution2.setDuaTypeEnum(DuaType.MASTER);\n+    institution2.setOrganizationTypeEnum(OrganizationType.HEALTH_CENTER_NON_PROFIT);\n+\n+    institutionDao.save(ImmutableList.of(institution1, institution2));\n+\n+    final List<ProjectedReportingInstitution> institutions =\n+        institutionDao.getReportingInstitutions();\n+    assertThat(institutions).hasSize(2);\n+    assertThat(institutions.get(0).getDisplayName()).isEqualTo(\"Cairo Consulting\");\n+    assertThat(institutions.get(0).getDuaTypeEnum()).isEqualTo(DuaType.RESTRICTED);\n+    assertThat(institutions.get(0).getOrganizationTypeEnum()).isEqualTo(OrganizationType.OTHER);\n+    assertThat(institutions.get(0).getOrganizationTypeOtherText()).isEqualTo(\"Pyramid Scheme\");\n+\n+    assertThat(institutions.get(1).getDisplayName()).isEqualTo(\"MASH\");\n+    assertThat(institutions.get(1).getDuaTypeEnum()).isEqualTo(DuaType.MASTER);\n+    assertThat(institutions.get(1).getOrganizationTypeEnum())\n+        .isEqualTo(OrganizationType.HEALTH_CENTER_NON_PROFIT);\n+    assertThat(institutions.get(1).getDisplayName()).isEqualTo(\"MASH\");\n+  }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzODE0MA=="}, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzcwMjAxOnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/reporting/ReportingMapperTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjowNToxNFrOHeyAhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMjo1OTo0MlrOHfIp6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzODY2Mg==", "bodyText": "?", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502038662", "createdAt": "2020-10-08T22:05:14Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/reporting/ReportingMapperTest.java", "diffHunk": "@@ -26,16 +30,33 @@\n   public static class conifg {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQwOTcwNw==", "bodyText": "renamed. These classes are basically never used by name (since annotation finds them), but Configuration is our standard name.", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502409707", "createdAt": "2020-10-09T12:59:42Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/reporting/ReportingMapperTest.java", "diffHunk": "@@ -26,16 +30,33 @@\n   public static class conifg {}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjAzODY2Mg=="}, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzcxMjY1OnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/testconfig/FakeTicker.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjowOToyMVrOHeyGpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxMzowMToxN1rOHfItVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDIyOQ==", "bodyText": "no", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502040229", "createdAt": "2020-10-08T22:09:21Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/testconfig/FakeTicker.java", "diffHunk": "@@ -1,17 +1,19 @@\n package org.pmiops.workbench.testconfig;\n \n import com.google.common.base.Ticker;\n+import java.util.concurrent.TimeUnit;\n \n public class FakeTicker extends Ticker {\n-  private final long elapsedMillis;\n+  private long elapsedMillis;\n \n-  protected FakeTicker(long elapsedMillis) {\n+  protected FakeTicker(long tickNanos) {\n     super();\n-    this.elapsedMillis = elapsedMillis;\n+    this.elapsedMillis = tickNanos;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQxMDU4MA==", "bodyText": "If I had a dollar for every timestamp and duration type I've had to use in this project, I'd have $150 Eastern/$149 Central.", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502410580", "createdAt": "2020-10-09T13:01:17Z", "author": {"login": "jaycarlton"}, "path": "api/src/test/java/org/pmiops/workbench/testconfig/FakeTicker.java", "diffHunk": "@@ -1,17 +1,19 @@\n package org.pmiops.workbench.testconfig;\n \n import com.google.common.base.Ticker;\n+import java.util.concurrent.TimeUnit;\n \n public class FakeTicker extends Ticker {\n-  private final long elapsedMillis;\n+  private long elapsedMillis;\n \n-  protected FakeTicker(long elapsedMillis) {\n+  protected FakeTicker(long tickNanos) {\n     super();\n-    this.elapsedMillis = elapsedMillis;\n+    this.elapsedMillis = tickNanos;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDIyOQ=="}, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MzcxMzE4OnYy", "diffSide": "RIGHT", "path": "api/src/test/java/org/pmiops/workbench/testconfig/FakeTicker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjowOTozNVrOHeyG-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMjowOTozNVrOHeyG-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA0MDMxNA==", "bodyText": "also no", "url": "https://github.com/all-of-us/workbench/pull/4116#discussion_r502040314", "createdAt": "2020-10-08T22:09:35Z", "author": {"login": "jmthibault79"}, "path": "api/src/test/java/org/pmiops/workbench/testconfig/FakeTicker.java", "diffHunk": "@@ -1,17 +1,19 @@\n package org.pmiops.workbench.testconfig;\n \n import com.google.common.base.Ticker;\n+import java.util.concurrent.TimeUnit;\n \n public class FakeTicker extends Ticker {\n-  private final long elapsedMillis;\n+  private long elapsedMillis;\n \n-  protected FakeTicker(long elapsedMillis) {\n+  protected FakeTicker(long tickNanos) {\n     super();\n-    this.elapsedMillis = elapsedMillis;\n+    this.elapsedMillis = tickNanos;\n   }\n \n   @Override\n   public long read() {\n+    elapsedMillis += TimeUnit.MILLISECONDS.toNanos(200);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d25a3f231d25e90c87f862ceb8a3b9f83c9afc7"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4026, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}