{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NDEyNjkw", "number": 347, "title": "chore: update DirectPath tests", "bodyText": "Update DirectPath tests to use the new opt-in method instead of env var\nChange fallback tests to blackhole all ipv4 and ipv6 DP addresses\n\nQ: This change depends on v0.8.0 google-cloud-shared-dependencies, so do I need to wait for #338 to be merged?", "createdAt": "2020-06-16T19:06:36Z", "url": "https://github.com/googleapis/java-bigtable/pull/347", "merged": true, "mergeCommit": {"oid": "b4edbd5cf420c652dec71ecccc236dbe823cfa4c"}, "closed": true, "closedAt": "2020-07-06T21:32:53Z", "author": {"login": "WeiranFang"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrkbADAH2gAyNDM1NDEyNjkwOmVhZjE3YmUzNzUwNjdkNGU2NTc4Y2Q2ODI4YmZlNjBkNGIwM2I0YTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwFxbvAFqTQzOTQxNzMxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "eaf17be375067d4e6578cd6828bfe60d4b03b4a5", "author": {"user": {"login": "WeiranFang", "name": "Weiran Fang"}}, "url": "https://github.com/googleapis/java-bigtable/commit/eaf17be375067d4e6578cd6828bfe60d4b03b4a5", "committedDate": "2020-06-15T17:50:54Z", "message": "Update DirectPath tests to use the new opt-in method instead of env var; Change fallback tests to blackhole all ipv4 and ipv6 DP addresses"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxODMxMDAz", "url": "https://github.com/googleapis/java-bigtable/pull/347#pullrequestreview-431831003", "createdAt": "2020-06-16T19:35:29Z", "commit": {"oid": "eaf17be375067d4e6578cd6828bfe60d4b03b4a5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxOTozNToyOVrOGkqTTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxOTozNToyOVrOGkqTTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTA5NDk4OA==", "bodyText": "this is already up to 0.8.1, so I think if you rebase to the latest you should be all set for this dep: f0314a1#diff-2c948b36b2a278766864c47aecd503e1", "url": "https://github.com/googleapis/java-bigtable/pull/347#discussion_r441094988", "createdAt": "2020-06-16T19:35:29Z", "author": {"login": "kolea2"}, "path": "google-cloud-bigtable-deps-bom/pom.xml", "diffHunk": "@@ -79,7 +79,7 @@\n       <dependency>\n         <groupId>com.google.cloud</groupId>\n         <artifactId>google-cloud-shared-dependencies</artifactId>\n-        <version>0.7.0</version>\n+        <version>0.8.0</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf17be375067d4e6578cd6828bfe60d4b03b4a5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxODgzNzIx", "url": "https://github.com/googleapis/java-bigtable/pull/347#pullrequestreview-431883721", "createdAt": "2020-06-16T20:54:27Z", "commit": {"oid": "eaf17be375067d4e6578cd6828bfe60d4b03b4a5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMDo1NDoyN1rOGkszKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQyMToxMDo0NFrOGktTpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzNTkxNQ==", "bodyText": "Please remove this println", "url": "https://github.com/googleapis/java-bigtable/pull/347#discussion_r441135915", "createdAt": "2020-06-16T20:54:27Z", "author": {"login": "igorbernstein2"}, "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/it/DirectPathFallbackIT.java", "diffHunk": "@@ -225,23 +230,30 @@ public void connect(\n         ChannelPromise promise)\n         throws Exception {\n \n-      this.isIPv6 =\n-          (remoteAddress instanceof InetSocketAddress)\n-              && ((InetSocketAddress) remoteAddress).getAddress() instanceof Inet6Address;\n+      if (remoteAddress instanceof InetSocketAddress) {\n+        InetAddress inetAddress = ((InetSocketAddress) remoteAddress).getAddress();\n+        String addr = inetAddress.getHostAddress();\n+        if ((inetAddress instanceof Inet6Address && addr.startsWith(DP_IPV6_PREFIX))\n+          || (inetAddress instanceof Inet4Address && addr.startsWith(DP_IPV4_PREFIX))) {\n+          isDpAddr = true;\n+        }\n+      }\n \n-      if (!(isIPv6 && blackholeIPv6.get())) {\n+      if (!(isDpAddr && blackholeDpAddr.get())) {\n         super.connect(ctx, remoteAddress, localAddress, promise);\n       } else {\n         // Fail the connection fast\n+        System.out.println(\">>>>>>>>>>>>>>>>>>>>>>>>>>> Failing connection\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf17be375067d4e6578cd6828bfe60d4b03b4a5"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzNzYwNA==", "bodyText": "return BigtableStubSettings.defaultGrpcTransportProviderBuilder()\n  //...\n  // TODO(weiranf): Remove this once DirectPath goes to public beta\n  .setAttemptDirectPath(isDirectPathEnabled())", "url": "https://github.com/googleapis/java-bigtable/pull/347#discussion_r441137604", "createdAt": "2020-06-16T20:57:32Z", "author": {"login": "igorbernstein2"}, "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStubSettings.java", "diffHunk": "@@ -229,9 +229,20 @@ public boolean isRefreshingChannel() {\n \n   /** Returns a builder for the default ChannelProvider for this service. */\n   public static InstantiatingGrpcChannelProvider.Builder defaultGrpcTransportProviderBuilder() {\n-    return BigtableStubSettings.defaultGrpcTransportProviderBuilder()\n+    InstantiatingGrpcChannelProvider.Builder builder =\n+        BigtableStubSettings.defaultGrpcTransportProviderBuilder()\n         .setPoolSize(getDefaultChannelPoolSize())\n         .setMaxInboundMessageSize(MAX_MESSAGE_SIZE);\n+    // TODO(weiranf): Remove this once DirectPath goes to public beta\n+    if (isDirectPathEnabled()) {\n+      builder.setAttemptDirectPath(true);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf17be375067d4e6578cd6828bfe60d4b03b4a5"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzODg0NA==", "bodyText": "Please cleanup the constants as well:\n\nremove DIRECT_PATH_ENV_VAR\nupdate comment for DIRECT_PATH_ENDPOINT", "url": "https://github.com/googleapis/java-bigtable/pull/347#discussion_r441138844", "createdAt": "2020-06-16T21:00:07Z", "author": {"login": "igorbernstein2"}, "path": "google-cloud-bigtable/src/main/java/com/google/cloud/bigtable/data/v2/stub/EnhancedBigtableStubSettings.java", "diffHunk": "@@ -229,9 +229,20 @@ public boolean isRefreshingChannel() {\n \n   /** Returns a builder for the default ChannelProvider for this service. */\n   public static InstantiatingGrpcChannelProvider.Builder defaultGrpcTransportProviderBuilder() {\n-    return BigtableStubSettings.defaultGrpcTransportProviderBuilder()\n+    InstantiatingGrpcChannelProvider.Builder builder =\n+        BigtableStubSettings.defaultGrpcTransportProviderBuilder()\n         .setPoolSize(getDefaultChannelPoolSize())\n         .setMaxInboundMessageSize(MAX_MESSAGE_SIZE);\n+    // TODO(weiranf): Remove this once DirectPath goes to public beta\n+    if (isDirectPathEnabled()) {\n+      builder.setAttemptDirectPath(true);\n+    }\n+    return builder;\n+  }\n+\n+  // TODO(weiranf): Remove this once DirectPath goes to public beta\n+  private static boolean isDirectPathEnabled() {\n+    return Boolean.getBoolean(\"bigtable.attempt-directpath\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf17be375067d4e6578cd6828bfe60d4b03b4a5"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0MDM2OQ==", "bodyText": "Please add a comment explaining where these magic subnets came from.", "url": "https://github.com/googleapis/java-bigtable/pull/347#discussion_r441140369", "createdAt": "2020-06-16T21:03:08Z", "author": {"login": "igorbernstein2"}, "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/it/DirectPathFallbackIT.java", "diffHunk": "@@ -66,12 +68,14 @@\n   // This was determined experimentally to account for both gRPC-LB RPCs and Bigtable api RPCs.\n   private static final int MIN_COMPLETE_READ_CALLS = 40;\n   private static final int NUM_RPCS_TO_SEND = 20;\n+  private static final String DP_IPV6_PREFIX = \"2001:4860:8040\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf17be375067d4e6578cd6828bfe60d4b03b4a5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0MTk0OQ==", "bodyText": "Make sure to update AbstractTestEnv as well:\n\n  \n    \n      java-bigtable/google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/test_helpers/env/AbstractTestEnv.java\n    \n    \n         Line 78\n      in\n      7b7b2f2\n    \n    \n    \n    \n\n        \n          \n           return \"bigtable\".equals(System.getenv(\"GOOGLE_CLOUD_ENABLE_DIRECT_PATH\"));", "url": "https://github.com/googleapis/java-bigtable/pull/347#discussion_r441141949", "createdAt": "2020-06-16T21:06:18Z", "author": {"login": "igorbernstein2"}, "path": "google-cloud-bigtable/pom.xml", "diffHunk": "@@ -323,11 +323,8 @@\n                     <bigtable.data-endpoint>${bigtable.directpath-data-endpoint}</bigtable.data-endpoint>\n                     <bigtable.admin-endpoint>${bigtable.directpath-admin-endpoint}</bigtable.admin-endpoint>\n                     <bigtable.grpc-log-dir>${project.build.directory}/test-grpc-logs/directpath-it</bigtable.grpc-log-dir>\n+                    <bigtable.attempt-directpath>true</bigtable.attempt-directpath>\n                   </systemPropertyVariables>\n-                  <!-- Enable directpath for bigtable -->\n-                  <environmentVariables>\n-                    <GOOGLE_CLOUD_ENABLE_DIRECT_PATH>bigtable</GOOGLE_CLOUD_ENABLE_DIRECT_PATH>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf17be375067d4e6578cd6828bfe60d4b03b4a5"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0MjY5NQ==", "bodyText": "Maybe simplify to:\nisDpAddr = addr.startsWith(DP_IPV6_PREFIX) ||  addr.startsWith(DP_IPV4_PREFIX));", "url": "https://github.com/googleapis/java-bigtable/pull/347#discussion_r441142695", "createdAt": "2020-06-16T21:07:48Z", "author": {"login": "igorbernstein2"}, "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/it/DirectPathFallbackIT.java", "diffHunk": "@@ -225,23 +230,30 @@ public void connect(\n         ChannelPromise promise)\n         throws Exception {\n \n-      this.isIPv6 =\n-          (remoteAddress instanceof InetSocketAddress)\n-              && ((InetSocketAddress) remoteAddress).getAddress() instanceof Inet6Address;\n+      if (remoteAddress instanceof InetSocketAddress) {\n+        InetAddress inetAddress = ((InetSocketAddress) remoteAddress).getAddress();\n+        String addr = inetAddress.getHostAddress();\n+        if ((inetAddress instanceof Inet6Address && addr.startsWith(DP_IPV6_PREFIX))\n+          || (inetAddress instanceof Inet4Address && addr.startsWith(DP_IPV4_PREFIX))) {\n+          isDpAddr = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf17be375067d4e6578cd6828bfe60d4b03b4a5"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTE0NDIyOA==", "bodyText": "Please remove the printlns.\nIf they are needed then maybe convert them into log.trace() or debug()", "url": "https://github.com/googleapis/java-bigtable/pull/347#discussion_r441144228", "createdAt": "2020-06-16T21:10:44Z", "author": {"login": "igorbernstein2"}, "path": "google-cloud-bigtable/src/test/java/com/google/cloud/bigtable/data/v2/it/DirectPathFallbackIT.java", "diffHunk": "@@ -225,23 +230,30 @@ public void connect(\n         ChannelPromise promise)\n         throws Exception {\n \n-      this.isIPv6 =\n-          (remoteAddress instanceof InetSocketAddress)\n-              && ((InetSocketAddress) remoteAddress).getAddress() instanceof Inet6Address;\n+      if (remoteAddress instanceof InetSocketAddress) {\n+        InetAddress inetAddress = ((InetSocketAddress) remoteAddress).getAddress();\n+        String addr = inetAddress.getHostAddress();\n+        if ((inetAddress instanceof Inet6Address && addr.startsWith(DP_IPV6_PREFIX))\n+          || (inetAddress instanceof Inet4Address && addr.startsWith(DP_IPV4_PREFIX))) {\n+          isDpAddr = true;\n+        }\n+      }\n \n-      if (!(isIPv6 && blackholeIPv6.get())) {\n+      if (!(isDpAddr && blackholeDpAddr.get())) {\n         super.connect(ctx, remoteAddress, localAddress, promise);\n       } else {\n         // Fail the connection fast\n+        System.out.println(\">>>>>>>>>>>>>>>>>>>>>>>>>>> Failing connection\");\n         promise.setFailure(new IOException(\"fake error\"));\n       }\n     }\n \n     @Override\n     public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception {\n-      boolean dropCall = isIPv6 && blackholeIPv6.get();\n+      boolean dropCall = isDpAddr && blackholeDpAddr.get();\n \n       if (dropCall) {\n+        System.out.println(\">>>>>>>>>>>>>>>>>>>>>>> Dropping call.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf17be375067d4e6578cd6828bfe60d4b03b4a5"}, "originalPosition": 113}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a895aee086fd074326c093150de333153cbb7966", "author": {"user": {"login": "WeiranFang", "name": "Weiran Fang"}}, "url": "https://github.com/googleapis/java-bigtable/commit/a895aee086fd074326c093150de333153cbb7966", "committedDate": "2020-06-16T23:24:37Z", "message": "Resolve comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcd4545580a8db4fdd2cd2ead1f06cabb9b518ae", "author": {"user": {"login": "WeiranFang", "name": "Weiran Fang"}}, "url": "https://github.com/googleapis/java-bigtable/commit/bcd4545580a8db4fdd2cd2ead1f06cabb9b518ae", "committedDate": "2020-06-16T22:58:43Z", "message": "resolve comments"}, "afterCommit": {"oid": "a895aee086fd074326c093150de333153cbb7966", "author": {"user": {"login": "WeiranFang", "name": "Weiran Fang"}}, "url": "https://github.com/googleapis/java-bigtable/commit/a895aee086fd074326c093150de333153cbb7966", "committedDate": "2020-06-16T23:24:37Z", "message": "Resolve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ec0b60abbf6caed28ff833a4839ca3c5178bac2", "author": {"user": {"login": "WeiranFang", "name": "Weiran Fang"}}, "url": "https://github.com/googleapis/java-bigtable/commit/0ec0b60abbf6caed28ff833a4839ca3c5178bac2", "committedDate": "2020-06-16T23:30:40Z", "message": "Merge branch 'master' into directpath"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MDYyMTQw", "url": "https://github.com/googleapis/java-bigtable/pull/347#pullrequestreview-435062140", "createdAt": "2020-06-22T15:56:37Z", "commit": {"oid": "0ec0b60abbf6caed28ff833a4839ca3c5178bac2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MjE2NDY1", "url": "https://github.com/googleapis/java-bigtable/pull/347#pullrequestreview-435216465", "createdAt": "2020-06-22T19:35:53Z", "commit": {"oid": "0ec0b60abbf6caed28ff833a4839ca3c5178bac2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6327736cd7ef852a3a949288702f131730c58a15", "author": {"user": {"login": "WeiranFang", "name": "Weiran Fang"}}, "url": "https://github.com/googleapis/java-bigtable/commit/6327736cd7ef852a3a949288702f131730c58a15", "committedDate": "2020-06-23T06:26:01Z", "message": "fix lint error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "364118f79581402a7867cc92a49ff2b4106b02d2", "author": {"user": {"login": "WeiranFang", "name": "Weiran Fang"}}, "url": "https://github.com/googleapis/java-bigtable/commit/364118f79581402a7867cc92a49ff2b4106b02d2", "committedDate": "2020-06-23T21:50:41Z", "message": "update directpath test endpoint"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NDE3MzE1", "url": "https://github.com/googleapis/java-bigtable/pull/347#pullrequestreview-439417315", "createdAt": "2020-06-29T18:57:58Z", "commit": {"oid": "364118f79581402a7867cc92a49ff2b4106b02d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1056, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}