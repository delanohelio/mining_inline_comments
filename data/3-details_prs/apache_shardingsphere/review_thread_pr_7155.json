{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1OTAyMzY2", "number": 7155, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNToyNTo1N1rOEeFDuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNToyODozNVrOEeFEeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5OTc1NjA4OnYy", "diffSide": "RIGHT", "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/test/java/org/apache/shardingsphere/driver/orchestration/api/OrchestrationShardingSphereDataSourceFactoryTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNToyNTo1N1rOHJjoZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNToyNTo1N1rOHJjoZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4MzAxNQ==", "bodyText": "Please add final if the class is not design for extension", "url": "https://github.com/apache/shardingsphere/pull/7155#discussion_r479783015", "createdAt": "2020-08-30T15:25:57Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/test/java/org/apache/shardingsphere/driver/orchestration/api/OrchestrationShardingSphereDataSourceFactoryTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.driver.orchestration.api;\n+\n+import lombok.SneakyThrows;\n+import org.apache.shardingsphere.cluster.configuration.config.ClusterConfiguration;\n+import org.apache.shardingsphere.driver.orchestration.internal.datasource.OrchestrationShardingSphereDataSource;\n+import org.apache.shardingsphere.infra.config.RuleConfiguration;\n+import org.apache.shardingsphere.metrics.configuration.config.MetricsConfiguration;\n+import org.apache.shardingsphere.orchestration.repository.api.config.OrchestrationCenterConfiguration;\n+import org.apache.shardingsphere.orchestration.repository.api.config.OrchestrationConfiguration;\n+import org.junit.Test;\n+\n+import javax.sql.DataSource;\n+\n+import java.sql.Connection;\n+import java.sql.DatabaseMetaData;\n+import java.sql.ResultSet;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class OrchestrationShardingSphereDataSourceFactoryTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569650ce05efee75a0a8aa751a7080542d39a781"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5OTc1Njk2OnYy", "diffSide": "RIGHT", "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/test/java/org/apache/shardingsphere/driver/orchestration/api/OrchestrationShardingSphereDataSourceFactoryTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNToyNzowOVrOHJjozg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNToyNzowOVrOHJjozg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4MzExOA==", "bodyText": "The return value should name as result", "url": "https://github.com/apache/shardingsphere/pull/7155#discussion_r479783118", "createdAt": "2020-08-30T15:27:09Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/test/java/org/apache/shardingsphere/driver/orchestration/api/OrchestrationShardingSphereDataSourceFactoryTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.driver.orchestration.api;\n+\n+import lombok.SneakyThrows;\n+import org.apache.shardingsphere.cluster.configuration.config.ClusterConfiguration;\n+import org.apache.shardingsphere.driver.orchestration.internal.datasource.OrchestrationShardingSphereDataSource;\n+import org.apache.shardingsphere.infra.config.RuleConfiguration;\n+import org.apache.shardingsphere.metrics.configuration.config.MetricsConfiguration;\n+import org.apache.shardingsphere.orchestration.repository.api.config.OrchestrationCenterConfiguration;\n+import org.apache.shardingsphere.orchestration.repository.api.config.OrchestrationConfiguration;\n+import org.junit.Test;\n+\n+import javax.sql.DataSource;\n+\n+import java.sql.Connection;\n+import java.sql.DatabaseMetaData;\n+import java.sql.ResultSet;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class OrchestrationShardingSphereDataSourceFactoryTest {\n+    private static final String TABLE_TYPE = \"TABLE\";\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWhenRuleConfigurationsNotEmpty() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSourceMap(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig(), mock(ClusterConfiguration.class), mock(MetricsConfiguration.class));\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWhenRuleConfigurationsNotEmptyWithClusterConfigurationAndMetricsConfigurationBothDefault() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSourceMap(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig());\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWithGivenDataSource() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSource(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig(), mock(ClusterConfiguration.class), mock(MetricsConfiguration.class));\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWithGivenDataSourceWithClusterConfigurationAndMetricsConfigurationBothDefault() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSource(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig());\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    private Map<String, DataSource> createDataSourceMap() {\n+        Map<String, DataSource> dataSourceMap = new HashMap<>();\n+        dataSourceMap.put(\"dataSourceMapKey\", createDataSource());\n+        return dataSourceMap;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569650ce05efee75a0a8aa751a7080542d39a781"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5OTc1NzU5OnYy", "diffSide": "RIGHT", "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/test/java/org/apache/shardingsphere/driver/orchestration/api/OrchestrationShardingSphereDataSourceFactoryTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNToyNzo1MFrOHJjpEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNToyNzo1MFrOHJjpEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4MzE4Ng==", "bodyText": "The return value should name as result", "url": "https://github.com/apache/shardingsphere/pull/7155#discussion_r479783186", "createdAt": "2020-08-30T15:27:50Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/test/java/org/apache/shardingsphere/driver/orchestration/api/OrchestrationShardingSphereDataSourceFactoryTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.driver.orchestration.api;\n+\n+import lombok.SneakyThrows;\n+import org.apache.shardingsphere.cluster.configuration.config.ClusterConfiguration;\n+import org.apache.shardingsphere.driver.orchestration.internal.datasource.OrchestrationShardingSphereDataSource;\n+import org.apache.shardingsphere.infra.config.RuleConfiguration;\n+import org.apache.shardingsphere.metrics.configuration.config.MetricsConfiguration;\n+import org.apache.shardingsphere.orchestration.repository.api.config.OrchestrationCenterConfiguration;\n+import org.apache.shardingsphere.orchestration.repository.api.config.OrchestrationConfiguration;\n+import org.junit.Test;\n+\n+import javax.sql.DataSource;\n+\n+import java.sql.Connection;\n+import java.sql.DatabaseMetaData;\n+import java.sql.ResultSet;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class OrchestrationShardingSphereDataSourceFactoryTest {\n+    private static final String TABLE_TYPE = \"TABLE\";\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWhenRuleConfigurationsNotEmpty() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSourceMap(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig(), mock(ClusterConfiguration.class), mock(MetricsConfiguration.class));\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWhenRuleConfigurationsNotEmptyWithClusterConfigurationAndMetricsConfigurationBothDefault() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSourceMap(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig());\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWithGivenDataSource() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSource(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig(), mock(ClusterConfiguration.class), mock(MetricsConfiguration.class));\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWithGivenDataSourceWithClusterConfigurationAndMetricsConfigurationBothDefault() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSource(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig());\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    private Map<String, DataSource> createDataSourceMap() {\n+        Map<String, DataSource> dataSourceMap = new HashMap<>();\n+        dataSourceMap.put(\"dataSourceMapKey\", createDataSource());\n+        return dataSourceMap;\n+    }\n+    \n+    @SneakyThrows\n+    private DataSource createDataSource() {\n+        DataSource baseDataSource = mock(DataSource.class);\n+        Connection connection = mock(Connection.class);\n+        DatabaseMetaData databaseMetaData = mock(DatabaseMetaData.class);\n+        when(connection.getMetaData()).thenReturn(databaseMetaData);\n+        when(databaseMetaData.getURL()).thenReturn(\"jdbc:mysql://localhost:3306/mysql?serverTimezone=GMT%2B8\");\n+        ResultSet resultSet = mock(ResultSet.class);\n+        when(databaseMetaData.getTables(null, null, null, new String[]{TABLE_TYPE})).thenReturn(resultSet);\n+        when(resultSet.next()).thenReturn(false);\n+        when(baseDataSource.getConnection()).thenReturn(connection);\n+        return baseDataSource;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569650ce05efee75a0a8aa751a7080542d39a781"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5OTc1NzczOnYy", "diffSide": "RIGHT", "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/test/java/org/apache/shardingsphere/driver/orchestration/api/OrchestrationShardingSphereDataSourceFactoryTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNToyODoxN1rOHJjpKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNToyODoxN1rOHJjpKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4MzIwOA==", "bodyText": "It is unnecessary to mock return false", "url": "https://github.com/apache/shardingsphere/pull/7155#discussion_r479783208", "createdAt": "2020-08-30T15:28:17Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/test/java/org/apache/shardingsphere/driver/orchestration/api/OrchestrationShardingSphereDataSourceFactoryTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.driver.orchestration.api;\n+\n+import lombok.SneakyThrows;\n+import org.apache.shardingsphere.cluster.configuration.config.ClusterConfiguration;\n+import org.apache.shardingsphere.driver.orchestration.internal.datasource.OrchestrationShardingSphereDataSource;\n+import org.apache.shardingsphere.infra.config.RuleConfiguration;\n+import org.apache.shardingsphere.metrics.configuration.config.MetricsConfiguration;\n+import org.apache.shardingsphere.orchestration.repository.api.config.OrchestrationCenterConfiguration;\n+import org.apache.shardingsphere.orchestration.repository.api.config.OrchestrationConfiguration;\n+import org.junit.Test;\n+\n+import javax.sql.DataSource;\n+\n+import java.sql.Connection;\n+import java.sql.DatabaseMetaData;\n+import java.sql.ResultSet;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class OrchestrationShardingSphereDataSourceFactoryTest {\n+    private static final String TABLE_TYPE = \"TABLE\";\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWhenRuleConfigurationsNotEmpty() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSourceMap(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig(), mock(ClusterConfiguration.class), mock(MetricsConfiguration.class));\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWhenRuleConfigurationsNotEmptyWithClusterConfigurationAndMetricsConfigurationBothDefault() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSourceMap(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig());\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWithGivenDataSource() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSource(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig(), mock(ClusterConfiguration.class), mock(MetricsConfiguration.class));\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWithGivenDataSourceWithClusterConfigurationAndMetricsConfigurationBothDefault() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSource(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig());\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    private Map<String, DataSource> createDataSourceMap() {\n+        Map<String, DataSource> dataSourceMap = new HashMap<>();\n+        dataSourceMap.put(\"dataSourceMapKey\", createDataSource());\n+        return dataSourceMap;\n+    }\n+    \n+    @SneakyThrows\n+    private DataSource createDataSource() {\n+        DataSource baseDataSource = mock(DataSource.class);\n+        Connection connection = mock(Connection.class);\n+        DatabaseMetaData databaseMetaData = mock(DatabaseMetaData.class);\n+        when(connection.getMetaData()).thenReturn(databaseMetaData);\n+        when(databaseMetaData.getURL()).thenReturn(\"jdbc:mysql://localhost:3306/mysql?serverTimezone=GMT%2B8\");\n+        ResultSet resultSet = mock(ResultSet.class);\n+        when(databaseMetaData.getTables(null, null, null, new String[]{TABLE_TYPE})).thenReturn(resultSet);\n+        when(resultSet.next()).thenReturn(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569650ce05efee75a0a8aa751a7080542d39a781"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5OTc1ODAxOnYy", "diffSide": "RIGHT", "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/test/java/org/apache/shardingsphere/driver/orchestration/api/OrchestrationShardingSphereDataSourceFactoryTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNToyODozNVrOHJjpSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNToyODozNVrOHJjpSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4MzI0Mw==", "bodyText": "The return value should name as result", "url": "https://github.com/apache/shardingsphere/pull/7155#discussion_r479783243", "createdAt": "2020-08-30T15:28:35Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-orchestration/src/test/java/org/apache/shardingsphere/driver/orchestration/api/OrchestrationShardingSphereDataSourceFactoryTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.driver.orchestration.api;\n+\n+import lombok.SneakyThrows;\n+import org.apache.shardingsphere.cluster.configuration.config.ClusterConfiguration;\n+import org.apache.shardingsphere.driver.orchestration.internal.datasource.OrchestrationShardingSphereDataSource;\n+import org.apache.shardingsphere.infra.config.RuleConfiguration;\n+import org.apache.shardingsphere.metrics.configuration.config.MetricsConfiguration;\n+import org.apache.shardingsphere.orchestration.repository.api.config.OrchestrationCenterConfiguration;\n+import org.apache.shardingsphere.orchestration.repository.api.config.OrchestrationConfiguration;\n+import org.junit.Test;\n+\n+import javax.sql.DataSource;\n+\n+import java.sql.Connection;\n+import java.sql.DatabaseMetaData;\n+import java.sql.ResultSet;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class OrchestrationShardingSphereDataSourceFactoryTest {\n+    private static final String TABLE_TYPE = \"TABLE\";\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWhenRuleConfigurationsNotEmpty() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSourceMap(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig(), mock(ClusterConfiguration.class), mock(MetricsConfiguration.class));\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWhenRuleConfigurationsNotEmptyWithClusterConfigurationAndMetricsConfigurationBothDefault() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSourceMap(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig());\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWithGivenDataSource() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSource(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig(), mock(ClusterConfiguration.class), mock(MetricsConfiguration.class));\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    @SneakyThrows\n+    @Test\n+    public void assertCreateDataSourceWithGivenDataSourceWithClusterConfigurationAndMetricsConfigurationBothDefault() {\n+        DataSource dataSource = OrchestrationShardingSphereDataSourceFactory.createDataSource(createDataSource(), Collections.singletonList(mock(RuleConfiguration.class)),\n+                new Properties(), createOrchestrationConfig());\n+        assertTrue(dataSource instanceof OrchestrationShardingSphereDataSource);\n+    }\n+    \n+    private Map<String, DataSource> createDataSourceMap() {\n+        Map<String, DataSource> dataSourceMap = new HashMap<>();\n+        dataSourceMap.put(\"dataSourceMapKey\", createDataSource());\n+        return dataSourceMap;\n+    }\n+    \n+    @SneakyThrows\n+    private DataSource createDataSource() {\n+        DataSource baseDataSource = mock(DataSource.class);\n+        Connection connection = mock(Connection.class);\n+        DatabaseMetaData databaseMetaData = mock(DatabaseMetaData.class);\n+        when(connection.getMetaData()).thenReturn(databaseMetaData);\n+        when(databaseMetaData.getURL()).thenReturn(\"jdbc:mysql://localhost:3306/mysql?serverTimezone=GMT%2B8\");\n+        ResultSet resultSet = mock(ResultSet.class);\n+        when(databaseMetaData.getTables(null, null, null, new String[]{TABLE_TYPE})).thenReturn(resultSet);\n+        when(resultSet.next()).thenReturn(false);\n+        when(baseDataSource.getConnection()).thenReturn(connection);\n+        return baseDataSource;\n+    }\n+    \n+    private OrchestrationConfiguration createOrchestrationConfig() {\n+        OrchestrationConfiguration orchestrationConfig = mock(OrchestrationConfiguration.class);\n+        OrchestrationCenterConfiguration orchestrationCenterConfiguration = mock(OrchestrationCenterConfiguration.class);\n+        when(orchestrationConfig.getRegistryCenterConfiguration()).thenReturn(orchestrationCenterConfiguration);\n+        when(orchestrationCenterConfiguration.getType()).thenReturn(\"REG_TEST\");\n+        return orchestrationConfig;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "569650ce05efee75a0a8aa751a7080542d39a781"}, "originalPosition": 103}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 304, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}