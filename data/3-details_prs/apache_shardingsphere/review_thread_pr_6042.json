{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MzM0Njgy", "number": 6042, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMTo0NzoxNFrOEFwM3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNzozNTo1N1rOEF0Tqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDY4MDYzOnYy", "diffSide": "RIGHT", "path": "examples/shardingsphere-jdbc-example/transaction-example/transaction-2pc-xa-bitronix-raw-jdbc-example/src/main/java/org/apache/shardingsphere/example/transaction/xa/bitronix/raw/jdbc/OrderServiceImpl.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMTo0NzoxNFrOGkIZ3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNDozODo0NFrOGkK92w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzOTYxMw==", "bodyText": "ThreadLocal value will be cleared in connection.close method, see more detail in AbstractConndectionAdapter#close", "url": "https://github.com/apache/shardingsphere/pull/6042#discussion_r440539613", "createdAt": "2020-06-16T01:47:14Z", "author": {"login": "cherrylzhao"}, "path": "examples/shardingsphere-jdbc-example/transaction-example/transaction-2pc-xa-bitronix-raw-jdbc-example/src/main/java/org/apache/shardingsphere/example/transaction/xa/bitronix/raw/jdbc/OrderServiceImpl.java", "diffHunk": "@@ -65,6 +65,8 @@ public void processSuccess() throws SQLException {\n             doInsert(preparedStatement);\n             connection.commit();\n             System.out.println(\"INSERT 10 orders success\");\n+        } finally {\n+            TransactionTypeHolder.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fe424e314838fa37d3cff64b4366a1a1c687360"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU2NzQ3NQ==", "bodyText": "I removed TransactionTypeHolder.clear() of AbstractConndectionAdapter#close, I think this is not the behavior of connnection.\nTransactionTypeHolder set and clear are symmetrical behaviors, and the caller should maintain them together.", "url": "https://github.com/apache/shardingsphere/pull/6042#discussion_r440567475", "createdAt": "2020-06-16T03:36:16Z", "author": {"login": "zjinlei"}, "path": "examples/shardingsphere-jdbc-example/transaction-example/transaction-2pc-xa-bitronix-raw-jdbc-example/src/main/java/org/apache/shardingsphere/example/transaction/xa/bitronix/raw/jdbc/OrderServiceImpl.java", "diffHunk": "@@ -65,6 +65,8 @@ public void processSuccess() throws SQLException {\n             doInsert(preparedStatement);\n             connection.commit();\n             System.out.println(\"INSERT 10 orders success\");\n+        } finally {\n+            TransactionTypeHolder.clear();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzOTYxMw=="}, "originalCommit": {"oid": "0fe424e314838fa37d3cff64b4366a1a1c687360"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4MTU5NQ==", "bodyText": "agree with it", "url": "https://github.com/apache/shardingsphere/pull/6042#discussion_r440581595", "createdAt": "2020-06-16T04:38:44Z", "author": {"login": "cherrylzhao"}, "path": "examples/shardingsphere-jdbc-example/transaction-example/transaction-2pc-xa-bitronix-raw-jdbc-example/src/main/java/org/apache/shardingsphere/example/transaction/xa/bitronix/raw/jdbc/OrderServiceImpl.java", "diffHunk": "@@ -65,6 +65,8 @@ public void processSuccess() throws SQLException {\n             doInsert(preparedStatement);\n             connection.commit();\n             System.out.println(\"INSERT 10 orders success\");\n+        } finally {\n+            TransactionTypeHolder.clear();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzOTYxMw=="}, "originalCommit": {"oid": "0fe424e314838fa37d3cff64b4366a1a1c687360"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDY4MTkyOnYy", "diffSide": "RIGHT", "path": "shardingsphere-jdbc/shardingsphere-jdbc-core/src/main/java/org/apache/shardingsphere/driver/jdbc/adapter/AbstractConnectionAdapter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMTo0ODowMlrOGkIatg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMTo0ODowMlrOGkIatg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUzOTgzMA==", "bodyText": "should keep incident in new line", "url": "https://github.com/apache/shardingsphere/pull/6042#discussion_r440539830", "createdAt": "2020-06-16T01:48:02Z", "author": {"login": "cherrylzhao"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-core/src/main/java/org/apache/shardingsphere/driver/jdbc/adapter/AbstractConnectionAdapter.java", "diffHunk": "@@ -74,7 +73,7 @@\n     private volatile boolean closed;\n     \n     private int transactionIsolation = TRANSACTION_READ_UNCOMMITTED;\n-    \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fe424e314838fa37d3cff64b4366a1a1c687360"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDY5MzgzOnYy", "diffSide": "RIGHT", "path": "shardingsphere-jdbc/shardingsphere-jdbc-spring/shardingsphere-jdbc-transaction-spring/src/main/java/org/apache/shardingsphere/spring/transaction/ShardingTransactionTypeInterceptor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMTo1NToxOVrOGkIiKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMTo1NToxOVrOGkIiKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU0MTczOQ==", "bodyText": "for checkstyle: preTransactionType != null => null != preTransactionType", "url": "https://github.com/apache/shardingsphere/pull/6042#discussion_r440541739", "createdAt": "2020-06-16T01:55:19Z", "author": {"login": "cherrylzhao"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-spring/shardingsphere-jdbc-transaction-spring/src/main/java/org/apache/shardingsphere/spring/transaction/ShardingTransactionTypeInterceptor.java", "diffHunk": "@@ -37,8 +38,16 @@\n     public Object invoke(final MethodInvocation methodInvocation) throws Throwable {\n         ShardingTransactionType shardingTransactionType = getAnnotation(methodInvocation);\n         Objects.requireNonNull(shardingTransactionType, \"could not found sharding transaction type annotation\");\n+        TransactionType preTransactionType = TransactionTypeHolder.get();\n         TransactionTypeHolder.set(shardingTransactionType.value());\n-        return methodInvocation.proceed();\n+        try {\n+            return methodInvocation.proceed();\n+        } finally {\n+            TransactionTypeHolder.clear();\n+            if (preTransactionType != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fe424e314838fa37d3cff64b4366a1a1c687360"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NDcwNDE1OnYy", "diffSide": "RIGHT", "path": "shardingsphere-jdbc/shardingsphere-jdbc-spring/shardingsphere-jdbc-transaction-spring/src/main/java/org/apache/shardingsphere/spring/transaction/ShardingTransactionTypeInterceptor.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwMjowMToxOFrOGkIonA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNTowNTo0OVrOGkLXpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU0MzM4OA==", "bodyText": "it's better to add a unit test to verify this feature. current implementation will not work in multiple @ShardingTransactionType ?", "url": "https://github.com/apache/shardingsphere/pull/6042#discussion_r440543388", "createdAt": "2020-06-16T02:01:18Z", "author": {"login": "cherrylzhao"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-spring/shardingsphere-jdbc-transaction-spring/src/main/java/org/apache/shardingsphere/spring/transaction/ShardingTransactionTypeInterceptor.java", "diffHunk": "@@ -37,8 +38,16 @@\n     public Object invoke(final MethodInvocation methodInvocation) throws Throwable {\n         ShardingTransactionType shardingTransactionType = getAnnotation(methodInvocation);\n         Objects.requireNonNull(shardingTransactionType, \"could not found sharding transaction type annotation\");\n+        TransactionType preTransactionType = TransactionTypeHolder.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fe424e314838fa37d3cff64b4366a1a1c687360"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU2ODM4OQ==", "bodyText": "@ShardingTransactionType does not support multiple connections, because the TransactionType will be removed from the thread when the connection is closed.\nE.g:\n@ShardingTransactionType(value=BASE)\npublic void test (){\nconn1 execute;(here is BASE)\nconn2(or conn1) execute; (The expectation here is BASE, but is LOCAl)\n}", "url": "https://github.com/apache/shardingsphere/pull/6042#discussion_r440568389", "createdAt": "2020-06-16T03:40:45Z", "author": {"login": "zjinlei"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-spring/shardingsphere-jdbc-transaction-spring/src/main/java/org/apache/shardingsphere/spring/transaction/ShardingTransactionTypeInterceptor.java", "diffHunk": "@@ -37,8 +38,16 @@\n     public Object invoke(final MethodInvocation methodInvocation) throws Throwable {\n         ShardingTransactionType shardingTransactionType = getAnnotation(methodInvocation);\n         Objects.requireNonNull(shardingTransactionType, \"could not found sharding transaction type annotation\");\n+        TransactionType preTransactionType = TransactionTypeHolder.get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU0MzM4OA=="}, "originalCommit": {"oid": "0fe424e314838fa37d3cff64b4366a1a1c687360"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU4ODE5Nw==", "bodyText": "Got it, @ShardingTransactionType was designed together with @transactional before.\nthis feature will provide a raw jdbc way to support multiple connection transaction in shardingpshere.\nappreciate you add a unit test to verify above code will be work fine.", "url": "https://github.com/apache/shardingsphere/pull/6042#discussion_r440588197", "createdAt": "2020-06-16T05:05:49Z", "author": {"login": "cherrylzhao"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-spring/shardingsphere-jdbc-transaction-spring/src/main/java/org/apache/shardingsphere/spring/transaction/ShardingTransactionTypeInterceptor.java", "diffHunk": "@@ -37,8 +38,16 @@\n     public Object invoke(final MethodInvocation methodInvocation) throws Throwable {\n         ShardingTransactionType shardingTransactionType = getAnnotation(methodInvocation);\n         Objects.requireNonNull(shardingTransactionType, \"could not found sharding transaction type annotation\");\n+        TransactionType preTransactionType = TransactionTypeHolder.get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDU0MzM4OA=="}, "originalCommit": {"oid": "0fe424e314838fa37d3cff64b4366a1a1c687360"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTI4MDU2OnYy", "diffSide": "RIGHT", "path": "shardingsphere-jdbc/shardingsphere-jdbc-core/src/test/java/org/apache/shardingsphere/driver/jdbc/adapter/ConnectionAdapterTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNzoxNDowNFrOGkOKSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNzoxNDowNFrOGkOKSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDYzMzkyOA==", "bodyText": "actual.close() can be removed, try() statement will invoke close method automatically", "url": "https://github.com/apache/shardingsphere/pull/6042#discussion_r440633928", "createdAt": "2020-06-16T07:14:04Z", "author": {"login": "cherrylzhao"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-core/src/test/java/org/apache/shardingsphere/driver/jdbc/adapter/ConnectionAdapterTest.java", "diffHunk": "@@ -172,6 +169,17 @@ private void assertClose(final ShardingSphereConnection actual) {\n         assertTrue(cachedConnections.isEmpty());\n     }\n     \n+    @Test\n+    public void assertCloseShouldNotClearTransactionType() throws SQLException {\n+        TransactionTypeHolder.set(TransactionType.XA);\n+        TransactionType currentTransactionType = TransactionTypeHolder.get();\n+        try (ShardingSphereConnection actual = getShardingSphereDataSource().getConnection()) {\n+            actual.createStatement().executeQuery(sql);\n+            actual.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99ecba13d7e63f3500fce61b2c1d5bdcdd3d765f"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTMzMjYyOnYy", "diffSide": "RIGHT", "path": "shardingsphere-jdbc/shardingsphere-jdbc-core/src/test/java/org/apache/shardingsphere/driver/jdbc/adapter/ConnectionAdapterTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNzozMDoxN1rOGkOrLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNzo1NDo0M1rOGkPiaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY0MjM0OQ==", "bodyText": "we usually use assertThat(TransactionTypeHolder.get(), is(Transactiontype.XA)) to do assert. you can see more detail in our test case requirement from https://shardingsphere.apache.org/community/cn/contribute/code-conduct/", "url": "https://github.com/apache/shardingsphere/pull/6042#discussion_r440642349", "createdAt": "2020-06-16T07:30:17Z", "author": {"login": "cherrylzhao"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-core/src/test/java/org/apache/shardingsphere/driver/jdbc/adapter/ConnectionAdapterTest.java", "diffHunk": "@@ -172,6 +169,17 @@ private void assertClose(final ShardingSphereConnection actual) {\n         assertTrue(cachedConnections.isEmpty());\n     }\n     \n+    @Test\n+    public void assertCloseShouldNotClearTransactionType() throws SQLException {\n+        TransactionTypeHolder.set(TransactionType.XA);\n+        TransactionType currentTransactionType = TransactionTypeHolder.get();\n+        try (ShardingSphereConnection actual = getShardingSphereDataSource().getConnection()) {\n+            actual.createStatement().executeQuery(sql);\n+            actual.close();\n+        }\n+        assertEquals(currentTransactionType, TransactionTypeHolder.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99ecba13d7e63f3500fce61b2c1d5bdcdd3d765f"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY1NjQ5MQ==", "bodyText": "done\nI will read the specification carefully", "url": "https://github.com/apache/shardingsphere/pull/6042#discussion_r440656491", "createdAt": "2020-06-16T07:54:43Z", "author": {"login": "zjinlei"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-core/src/test/java/org/apache/shardingsphere/driver/jdbc/adapter/ConnectionAdapterTest.java", "diffHunk": "@@ -172,6 +169,17 @@ private void assertClose(final ShardingSphereConnection actual) {\n         assertTrue(cachedConnections.isEmpty());\n     }\n     \n+    @Test\n+    public void assertCloseShouldNotClearTransactionType() throws SQLException {\n+        TransactionTypeHolder.set(TransactionType.XA);\n+        TransactionType currentTransactionType = TransactionTypeHolder.get();\n+        try (ShardingSphereConnection actual = getShardingSphereDataSource().getConnection()) {\n+            actual.createStatement().executeQuery(sql);\n+            actual.close();\n+        }\n+        assertEquals(currentTransactionType, TransactionTypeHolder.get());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY0MjM0OQ=="}, "originalCommit": {"oid": "99ecba13d7e63f3500fce61b2c1d5bdcdd3d765f"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0NTM1MzM5OnYy", "diffSide": "RIGHT", "path": "shardingsphere-jdbc/shardingsphere-jdbc-spring/shardingsphere-jdbc-transaction-spring/src/test/java/org/apache/shardingsphere/spring/transaction/ShardingTransactionTypeScannerTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNzozNTo1N1rOGkO30g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwNzozNTo1N1rOGkO30g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY0NTU4Ng==", "bodyText": "I think we can assertThat a precise value here, i.g. asserThat(TransactionTypeHolder.get(), is(TransactionType.LOCAL)).", "url": "https://github.com/apache/shardingsphere/pull/6042#discussion_r440645586", "createdAt": "2020-06-16T07:35:57Z", "author": {"login": "cherrylzhao"}, "path": "shardingsphere-jdbc/shardingsphere-jdbc-spring/shardingsphere-jdbc-transaction-spring/src/test/java/org/apache/shardingsphere/spring/transaction/ShardingTransactionTypeScannerTest.java", "diffHunk": "@@ -42,4 +44,15 @@ public void assertShardingTransaction() {\n         assertThat(mockService.executeBase(), is(TransactionType.BASE));\n         assertThat(mockService.execute(), is(TransactionType.XA));\n     }\n+    \n+    @Test\n+    public void assertShardingTransactionType() {\n+        TransactionType preTransactionType = TransactionTypeHolder.get();\n+        mockService.executeLocal();\n+        assertEquals(preTransactionType, TransactionTypeHolder.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99ecba13d7e63f3500fce61b2c1d5bdcdd3d765f"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 799, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}