{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxODI4MzU2", "number": 4531, "title": "Add unit test case for sharding-orchestration-center-apollo module #4451", "bodyText": "Fixes #4451.\nChanges proposed in this pull request:", "createdAt": "2020-02-29T10:01:00Z", "url": "https://github.com/apache/shardingsphere/pull/4531", "merged": true, "mergeCommit": {"oid": "eb7da05dcd5970446bced06530eb3a0e34c7be2e"}, "closed": true, "closedAt": "2020-03-04T10:07:32Z", "author": {"login": "gongsiran"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJBgDbgH2gAyMzgxODI4MzU2OjU1NmRjNTI5NzhhOWIwZWJmZWY3MjIyNDQxMTllY2Y3MWU1Zjc1OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKUA98gFqTM2ODUyMzc4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "556dc52978a9b0ebfef722244119ecf71e5f7591", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/556dc52978a9b0ebfef722244119ecf71e5f7591", "committedDate": "2020-02-29T09:56:19Z", "message": "Add unit test case for sharding-orchestration-center-apollo module #4451"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2ODM1MTM2", "url": "https://github.com/apache/shardingsphere/pull/4531#pullrequestreview-366835136", "createdAt": "2020-03-01T04:51:59Z", "commit": {"oid": "556dc52978a9b0ebfef722244119ecf71e5f7591"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwNDo1MTo1OVrOFwMRIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwNTowMjozMVrOFwMS4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA3Njk2Mw==", "bodyText": "Please keep the blank character.", "url": "https://github.com/apache/shardingsphere/pull/4531#discussion_r386076963", "createdAt": "2020-03-01T04:51:59Z", "author": {"login": "dongzl"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-apollo/src/test/java/org/apache/shardingsphere/orchestration/center/instance/ApolloInstanceTest.java", "diffHunk": "@@ -46,18 +51,22 @@\n     \n     @ClassRule\n     public static EmbeddedApollo embeddedApollo = new EmbeddedApollo();\n-    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "556dc52978a9b0ebfef722244119ecf71e5f7591"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA3NzA0OQ==", "bodyText": "If assert null, we can assert directly, no need when ... thenReturn.", "url": "https://github.com/apache/shardingsphere/pull/4531#discussion_r386077049", "createdAt": "2020-03-01T04:53:58Z", "author": {"login": "dongzl"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-apollo/src/test/java/org/apache/shardingsphere/orchestration/center/instance/ApolloInstanceTest.java", "diffHunk": "@@ -82,4 +91,65 @@ public void onChange(final DataChangedEvent dataChangedEvent) {\n         assertThat(changeEvent.getValue(), is(\"value3\"));\n         assertThat(changeEvent.getChangedType(), is(DataChangedEvent.ChangedType.UPDATED));\n     }\n+\n+    @Test\n+    @SneakyThrows\n+    public void assertGetWithNonExistentKey() {\n+        when(openApiWrapper.getValue(eq(\"test.nonExistentKey\"))).thenReturn(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "556dc52978a9b0ebfef722244119ecf71e5f7591"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA3NzI2NQ==", "bodyText": "Keep four blank characters.", "url": "https://github.com/apache/shardingsphere/pull/4531#discussion_r386077265", "createdAt": "2020-03-01T05:00:01Z", "author": {"login": "dongzl"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-apollo/src/test/java/org/apache/shardingsphere/orchestration/center/instance/ApolloInstanceTest.java", "diffHunk": "@@ -82,4 +91,65 @@ public void onChange(final DataChangedEvent dataChangedEvent) {\n         assertThat(changeEvent.getValue(), is(\"value3\"));\n         assertThat(changeEvent.getChangedType(), is(DataChangedEvent.ChangedType.UPDATED));\n     }\n+\n+    @Test\n+    @SneakyThrows\n+    public void assertGetWithNonExistentKey() {\n+        when(openApiWrapper.getValue(eq(\"test.nonExistentKey\"))).thenReturn(null);\n+        assertNull(configCenterRepository.get(\"/test/nonExistentKey\"));\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "556dc52978a9b0ebfef722244119ecf71e5f7591"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA3NzQxMA==", "bodyText": "Keep four blank characters. Please check every method.", "url": "https://github.com/apache/shardingsphere/pull/4531#discussion_r386077410", "createdAt": "2020-03-01T05:02:31Z", "author": {"login": "dongzl"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-apollo/src/test/java/org/apache/shardingsphere/orchestration/center/instance/ApolloInstanceTest.java", "diffHunk": "@@ -82,4 +91,65 @@ public void onChange(final DataChangedEvent dataChangedEvent) {\n         assertThat(changeEvent.getValue(), is(\"value3\"));\n         assertThat(changeEvent.getChangedType(), is(DataChangedEvent.ChangedType.UPDATED));\n     }\n+\n+    @Test\n+    @SneakyThrows\n+    public void assertGetWithNonExistentKey() {\n+        when(openApiWrapper.getValue(eq(\"test.nonExistentKey\"))).thenReturn(null);\n+        assertNull(configCenterRepository.get(\"/test/nonExistentKey\"));\n+    }\n+\n+    @Test\n+    @SneakyThrows\n+    public void assertUpdate() {\n+        final SettableFuture<DataChangedEvent> future = SettableFuture.create();\n+        configCenterRepository.watch(\"/test/children/1\", new DataChangedEventListener() {\n+\n+            @Override\n+            public void onChange(final DataChangedEvent dataChangedEvent) {\n+                future.set(dataChangedEvent);\n+            }\n+        });\n+        embeddedApollo.addOrModifyProperty(\"orchestration\", \"test.children.1\", \"newValue1\");\n+        DataChangedEvent changeEvent = future.get(5, TimeUnit.SECONDS);\n+        assertThat(changeEvent.getKey(), is(\"/test/children/1\"));\n+        assertThat(changeEvent.getValue(), is(\"newValue1\"));\n+        assertThat(changeEvent.getChangedType(), is(DataChangedEvent.ChangedType.UPDATED));\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "556dc52978a9b0ebfef722244119ecf71e5f7591"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2ODM3Nzcx", "url": "https://github.com/apache/shardingsphere/pull/4531#pullrequestreview-366837771", "createdAt": "2020-03-01T06:19:41Z", "commit": {"oid": "556dc52978a9b0ebfef722244119ecf71e5f7591"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwNjoxOTo0MVrOFwMgKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMVQwNjoxOTo0MVrOFwMgKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA4MDgxMA==", "bodyText": "now we support delete?", "url": "https://github.com/apache/shardingsphere/pull/4531#discussion_r386080810", "createdAt": "2020-03-01T06:19:41Z", "author": {"login": "kimmking"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-apollo/src/test/java/org/apache/shardingsphere/orchestration/center/instance/ApolloInstanceTest.java", "diffHunk": "@@ -82,4 +91,65 @@ public void onChange(final DataChangedEvent dataChangedEvent) {\n         assertThat(changeEvent.getValue(), is(\"value3\"));\n         assertThat(changeEvent.getChangedType(), is(DataChangedEvent.ChangedType.UPDATED));\n     }\n+\n+    @Test\n+    @SneakyThrows\n+    public void assertGetWithNonExistentKey() {\n+        when(openApiWrapper.getValue(eq(\"test.nonExistentKey\"))).thenReturn(null);\n+        assertNull(configCenterRepository.get(\"/test/nonExistentKey\"));\n+    }\n+\n+    @Test\n+    @SneakyThrows\n+    public void assertUpdate() {\n+        final SettableFuture<DataChangedEvent> future = SettableFuture.create();\n+        configCenterRepository.watch(\"/test/children/1\", new DataChangedEventListener() {\n+\n+            @Override\n+            public void onChange(final DataChangedEvent dataChangedEvent) {\n+                future.set(dataChangedEvent);\n+            }\n+        });\n+        embeddedApollo.addOrModifyProperty(\"orchestration\", \"test.children.1\", \"newValue1\");\n+        DataChangedEvent changeEvent = future.get(5, TimeUnit.SECONDS);\n+        assertThat(changeEvent.getKey(), is(\"/test/children/1\"));\n+        assertThat(changeEvent.getValue(), is(\"newValue1\"));\n+        assertThat(changeEvent.getChangedType(), is(DataChangedEvent.ChangedType.UPDATED));\n+    }\n+\n+    @Test\n+    @SneakyThrows\n+    public void assertWatchDeletedChangedType() {\n+        final SettableFuture<DataChangedEvent> future = SettableFuture.create();\n+        configCenterRepository.watch(\"/test/children/1\", new DataChangedEventListener() {\n+\n+            @Override\n+            public void onChange(final DataChangedEvent dataChangedEvent) {\n+                future.set(dataChangedEvent);\n+            }\n+        });\n+        embeddedApollo.deleteProperty(\"orchestration\", \"test.children.1\");\n+        DataChangedEvent changeEvent = future.get(5, TimeUnit.SECONDS);\n+        assertThat(changeEvent.getKey(), is(\"/test/children/1\"));\n+        assertNull(changeEvent.getValue());\n+        assertThat(changeEvent.getChangedType(), is(DataChangedEvent.ChangedType.DELETED));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "556dc52978a9b0ebfef722244119ecf71e5f7591"}, "originalPosition": 90}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20e20ce17ef7084d17c760a86f8a27ad2fed2a59", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/20e20ce17ef7084d17c760a86f8a27ad2fed2a59", "committedDate": "2020-03-01T07:55:11Z", "message": "Add unit test case for sharding-orchestration-center-apollo module #4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf927ada7a2783d1026bf12a0a7c88dc359a5c62", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/bf927ada7a2783d1026bf12a0a7c88dc359a5c62", "committedDate": "2020-03-01T08:03:27Z", "message": "Merge branch 'temp' into issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "546adcbcf0df45e5e1b0793f83bc55a9e7bb0ecf", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/546adcbcf0df45e5e1b0793f83bc55a9e7bb0ecf", "committedDate": "2020-03-01T08:11:02Z", "message": "issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4a186a535710e792b7bd77038f86a3b8c4c607f", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/b4a186a535710e792b7bd77038f86a3b8c4c607f", "committedDate": "2020-03-01T08:14:04Z", "message": "issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd3061731e073f75d6febe3619bd6cf61c2a50b0", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/fd3061731e073f75d6febe3619bd6cf61c2a50b0", "committedDate": "2020-03-01T08:15:17Z", "message": "issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "577c3cec6041bdab5a73aeeb3886fbb7657d7dd1", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/577c3cec6041bdab5a73aeeb3886fbb7657d7dd1", "committedDate": "2020-03-02T03:31:26Z", "message": "Merge branch 'temp' into issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "174355b237cb30ac55d58d8ab41ea2de2d477f9b", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/174355b237cb30ac55d58d8ab41ea2de2d477f9b", "committedDate": "2020-03-02T04:41:42Z", "message": "Merge branch 'temp' into issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73659a2aa89bd8de1ce62040f89bac54f860aa47", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/73659a2aa89bd8de1ce62040f89bac54f860aa47", "committedDate": "2020-03-02T04:43:27Z", "message": "Fixes_issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44039c73b912554191d2627427075f2302e8ec05", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/44039c73b912554191d2627427075f2302e8ec05", "committedDate": "2020-03-02T04:44:34Z", "message": "Merge branch 'issues4451' of github.com:gongsiran/incubator-shardingsphere into issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f317f3d54897263557778acd85d2b603a6ec8e6d", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/f317f3d54897263557778acd85d2b603a6ec8e6d", "committedDate": "2020-03-02T06:04:00Z", "message": "Fixes_issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf8af9457be6ea30e01349254127a34cb57ca4a7", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/bf8af9457be6ea30e01349254127a34cb57ca4a7", "committedDate": "2020-03-03T11:04:49Z", "message": "Merge branch 'temp' into issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32ac1395a3a7332ff28dc557433c3f7da8d469cb", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/32ac1395a3a7332ff28dc557433c3f7da8d469cb", "committedDate": "2020-03-03T11:05:11Z", "message": "issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "462b33d28a9a600a59bcfecc2d0e108e334f8357", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/462b33d28a9a600a59bcfecc2d0e108e334f8357", "committedDate": "2020-03-03T11:43:34Z", "message": "issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46e713a69ed7b94589a6b6b3988c6d60689b3e8c", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/46e713a69ed7b94589a6b6b3988c6d60689b3e8c", "committedDate": "2020-03-03T12:29:16Z", "message": "issues4451"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NDg1MDc0", "url": "https://github.com/apache/shardingsphere/pull/4531#pullrequestreview-368485074", "createdAt": "2020-03-04T03:35:02Z", "commit": {"oid": "46e713a69ed7b94589a6b6b3988c6d60689b3e8c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMzozNTowMlrOFxfAdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMzozODo1MFrOFxfDiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzMjU2NQ==", "bodyText": "Why delete the property and then add it right now?", "url": "https://github.com/apache/shardingsphere/pull/4531#discussion_r387432565", "createdAt": "2020-03-04T03:35:02Z", "author": {"login": "dongzl"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-apollo/src/test/java/org/apache/shardingsphere/orchestration/center/instance/ApolloInstanceTest.java", "diffHunk": "@@ -67,12 +78,62 @@ public void assertGet() {\n     @Test\n     @SneakyThrows\n     public void assertWatch() {\n+        assertWatchUpdateChangedType(\"/test/children/1\", \"value3\");\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertGetWithNonExistentKey() {\n+        assertNull(configCenterRepository.get(\"/test/nonExistentKey\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertUpdate() {\n+        assertWatchUpdateChangedType(\"/test/children/1\", \"newValue1\");\n+        assertThat(configCenterRepository.get(\"/test/children/1\"), is(\"newValue1\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertWatchDeletedChangedType() {\n         final SettableFuture<DataChangedEvent> future = SettableFuture.create();\n-        configCenterRepository.watch(\"/test/children/1\", future::set);\n+        configCenterRepository.watch(\"/test/children/1\", new DataChangedEventListener() {\n+    \n+            @Override\n+            public void onChange(final DataChangedEvent dataChangedEvent) {\n+                future.set(dataChangedEvent);\n+            }\n+        });\n+        embeddedApollo.deleteProperty(\"orchestration\", \"test.children.1\");\n         embeddedApollo.addOrModifyProperty(\"orchestration\", \"test.children.1\", \"value3\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46e713a69ed7b94589a6b6b3988c6d60689b3e8c"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzMzM1Mw==", "bodyText": "It's not a good idea for using assertWatchUpdateChangedType  method  at assertWatchAddChangedType  method, maybe we should rename these methods and make them more meaningful.\nI suggest this method rename assertWatchUpdateChangedTypeWithNotExistedKey", "url": "https://github.com/apache/shardingsphere/pull/4531#discussion_r387433353", "createdAt": "2020-03-04T03:38:50Z", "author": {"login": "dongzl"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-apollo/src/test/java/org/apache/shardingsphere/orchestration/center/instance/ApolloInstanceTest.java", "diffHunk": "@@ -67,12 +78,62 @@ public void assertGet() {\n     @Test\n     @SneakyThrows\n     public void assertWatch() {\n+        assertWatchUpdateChangedType(\"/test/children/1\", \"value3\");\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertGetWithNonExistentKey() {\n+        assertNull(configCenterRepository.get(\"/test/nonExistentKey\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertUpdate() {\n+        assertWatchUpdateChangedType(\"/test/children/1\", \"newValue1\");\n+        assertThat(configCenterRepository.get(\"/test/children/1\"), is(\"newValue1\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertWatchDeletedChangedType() {\n         final SettableFuture<DataChangedEvent> future = SettableFuture.create();\n-        configCenterRepository.watch(\"/test/children/1\", future::set);\n+        configCenterRepository.watch(\"/test/children/1\", new DataChangedEventListener() {\n+    \n+            @Override\n+            public void onChange(final DataChangedEvent dataChangedEvent) {\n+                future.set(dataChangedEvent);\n+            }\n+        });\n+        embeddedApollo.deleteProperty(\"orchestration\", \"test.children.1\");\n         embeddedApollo.addOrModifyProperty(\"orchestration\", \"test.children.1\", \"value3\");\n         DataChangedEvent changeEvent = future.get(5, TimeUnit.SECONDS);\n         assertThat(changeEvent.getKey(), is(\"/test/children/1\"));\n-        assertThat(changeEvent.getValue(), is(\"value3\"));\n+        assertNull(changeEvent.getValue());\n+        assertThat(changeEvent.getChangedType(), is(DataChangedEvent.ChangedType.DELETED));\n+        assertNull(configCenterRepository.get(\"/test/children/1\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertWatchAddChangedType() {\n+        assertWatchUpdateChangedType(\"/test/children/newKey\", \"newVaule\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46e713a69ed7b94589a6b6b3988c6d60689b3e8c"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NDg2NTE1", "url": "https://github.com/apache/shardingsphere/pull/4531#pullrequestreview-368486515", "createdAt": "2020-03-04T03:41:00Z", "commit": {"oid": "46e713a69ed7b94589a6b6b3988c6d60689b3e8c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMzo0MTowMFrOFxfFKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwMzo0MToxNFrOFxfFVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzMzc3MQ==", "bodyText": "Keep this line's blank character with @Override.", "url": "https://github.com/apache/shardingsphere/pull/4531#discussion_r387433771", "createdAt": "2020-03-04T03:41:00Z", "author": {"login": "dongzl"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-apollo/src/test/java/org/apache/shardingsphere/orchestration/center/instance/ApolloInstanceTest.java", "diffHunk": "@@ -67,12 +78,62 @@ public void assertGet() {\n     @Test\n     @SneakyThrows\n     public void assertWatch() {\n+        assertWatchUpdateChangedType(\"/test/children/1\", \"value3\");\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertGetWithNonExistentKey() {\n+        assertNull(configCenterRepository.get(\"/test/nonExistentKey\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertUpdate() {\n+        assertWatchUpdateChangedType(\"/test/children/1\", \"newValue1\");\n+        assertThat(configCenterRepository.get(\"/test/children/1\"), is(\"newValue1\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertWatchDeletedChangedType() {\n         final SettableFuture<DataChangedEvent> future = SettableFuture.create();\n-        configCenterRepository.watch(\"/test/children/1\", future::set);\n+        configCenterRepository.watch(\"/test/children/1\", new DataChangedEventListener() {\n+    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46e713a69ed7b94589a6b6b3988c6d60689b3e8c"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQzMzgxMg==", "bodyText": "Keep this line's blank character with @Override.", "url": "https://github.com/apache/shardingsphere/pull/4531#discussion_r387433812", "createdAt": "2020-03-04T03:41:14Z", "author": {"login": "dongzl"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-apollo/src/test/java/org/apache/shardingsphere/orchestration/center/instance/ApolloInstanceTest.java", "diffHunk": "@@ -67,12 +78,62 @@ public void assertGet() {\n     @Test\n     @SneakyThrows\n     public void assertWatch() {\n+        assertWatchUpdateChangedType(\"/test/children/1\", \"value3\");\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertGetWithNonExistentKey() {\n+        assertNull(configCenterRepository.get(\"/test/nonExistentKey\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertUpdate() {\n+        assertWatchUpdateChangedType(\"/test/children/1\", \"newValue1\");\n+        assertThat(configCenterRepository.get(\"/test/children/1\"), is(\"newValue1\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertWatchDeletedChangedType() {\n         final SettableFuture<DataChangedEvent> future = SettableFuture.create();\n-        configCenterRepository.watch(\"/test/children/1\", future::set);\n+        configCenterRepository.watch(\"/test/children/1\", new DataChangedEventListener() {\n+    \n+            @Override\n+            public void onChange(final DataChangedEvent dataChangedEvent) {\n+                future.set(dataChangedEvent);\n+            }\n+        });\n+        embeddedApollo.deleteProperty(\"orchestration\", \"test.children.1\");\n         embeddedApollo.addOrModifyProperty(\"orchestration\", \"test.children.1\", \"value3\");\n         DataChangedEvent changeEvent = future.get(5, TimeUnit.SECONDS);\n         assertThat(changeEvent.getKey(), is(\"/test/children/1\"));\n-        assertThat(changeEvent.getValue(), is(\"value3\"));\n+        assertNull(changeEvent.getValue());\n+        assertThat(changeEvent.getChangedType(), is(DataChangedEvent.ChangedType.DELETED));\n+        assertNull(configCenterRepository.get(\"/test/children/1\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertWatchAddChangedType() {\n+        assertWatchUpdateChangedType(\"/test/children/newKey\", \"newVaule\");\n+    }\n+    \n+    @SneakyThrows\n+    private void assertWatchUpdateChangedType(final String key, final String newVaule) {\n+        final SettableFuture<DataChangedEvent> future = SettableFuture.create();\n+        configCenterRepository.watch(key, new DataChangedEventListener() {\n+        ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46e713a69ed7b94589a6b6b3988c6d60689b3e8c"}, "originalPosition": 95}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5b7646034708ed1f2e8f4d4469eba74bd370f07", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/b5b7646034708ed1f2e8f4d4469eba74bd370f07", "committedDate": "2020-03-04T08:01:11Z", "message": "Merge branch 'temp' into issues4451"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af499752942fd5367267ba9cc5677a3e541a47ee", "author": {"user": {"login": "gongsiran", "name": "gongsiran"}}, "url": "https://github.com/apache/shardingsphere/commit/af499752942fd5367267ba9cc5677a3e541a47ee", "committedDate": "2020-03-04T08:01:43Z", "message": "issues4451"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTIzNzg5", "url": "https://github.com/apache/shardingsphere/pull/4531#pullrequestreview-368523789", "createdAt": "2020-03-04T06:07:25Z", "commit": {"oid": "46e713a69ed7b94589a6b6b3988c6d60689b3e8c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjowNzoyNVrOFxg-Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwNjowNzoyNVrOFxg-Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzQ2NDc3OQ==", "bodyText": "I suggest this method rename assertWatchUpdateChangedTypeWithExistedKey.", "url": "https://github.com/apache/shardingsphere/pull/4531#discussion_r387464779", "createdAt": "2020-03-04T06:07:25Z", "author": {"login": "dongzl"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-apollo/src/test/java/org/apache/shardingsphere/orchestration/center/instance/ApolloInstanceTest.java", "diffHunk": "@@ -67,12 +78,62 @@ public void assertGet() {\n     @Test\n     @SneakyThrows\n     public void assertWatch() {\n+        assertWatchUpdateChangedType(\"/test/children/1\", \"value3\");\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertGetWithNonExistentKey() {\n+        assertNull(configCenterRepository.get(\"/test/nonExistentKey\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertUpdate() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "46e713a69ed7b94589a6b6b3988c6d60689b3e8c"}, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3875, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}