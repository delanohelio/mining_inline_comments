{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMTMzMzg0", "number": 3959, "title": "Get ciphertext column as a string", "bodyText": "Encrypt the field, and take the value of string type directly. For example, after digital encryption, the database can be saved as varchar, and the corresponding field of bean can still be number\nplease see #3934", "createdAt": "2020-01-13T14:01:53Z", "url": "https://github.com/apache/shardingsphere/pull/3959", "merged": true, "mergeCommit": {"oid": "a4d5766769ebc60790f40e94634e95c83d60c656"}, "closed": true, "closedAt": "2020-01-21T04:39:15Z", "author": {"login": "longjy"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb58RA5AH2gAyMzYyMTMzMzg0OjE2Njg3ODE5ZTc3NmY3ZmM2OTliYjBkY2FlYWVkYTgxYzBiNzg0N2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8Zk6mAFqTM0NTYzMDk1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "16687819e776f7fc699bb0dcaeaeda81c0b7847d", "author": {"user": {"login": "longjy", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/16687819e776f7fc699bb0dcaeaeda81c0b7847d", "committedDate": "2020-01-13T13:21:30Z", "message": "Get ciphertext column as a string"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MDUzNDY0", "url": "https://github.com/apache/shardingsphere/pull/3959#pullrequestreview-345053464", "createdAt": "2020-01-20T02:20:26Z", "commit": {"oid": "16687819e776f7fc699bb0dcaeaeda81c0b7847d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwMjoyMDoyNlrOFfSL4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwMjoyMjowMlrOFfSMvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM0ODEyOQ==", "bodyText": "Please keep origin indent", "url": "https://github.com/apache/shardingsphere/pull/3959#discussion_r368348129", "createdAt": "2020-01-20T02:20:26Z", "author": {"login": "terrymanu"}, "path": "encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dql/EncryptMergedResult.java", "diffHunk": "@@ -44,15 +44,15 @@\n     public boolean next() throws SQLException {\n         return mergedResult.next();\n     }\n-    \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16687819e776f7fc699bb0dcaeaeda81c0b7847d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM0ODM1MQ==", "bodyText": "The logic below may better:\n\njudge queryWithCipherColumn or not\n\nif !queryWithCipherColumn, return mergedResult.getValue(columnIndex, type)\nif queryWithCipherColumn,  get value via mergedResult.getValue(columnIndex, String.class)\n\nif value is null, return null\nif value is not null, findEncryptor and return decrypt value", "url": "https://github.com/apache/shardingsphere/pull/3959#discussion_r368348351", "createdAt": "2020-01-20T02:22:02Z", "author": {"login": "terrymanu"}, "path": "encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dql/EncryptMergedResult.java", "diffHunk": "@@ -44,15 +44,15 @@\n     public boolean next() throws SQLException {\n         return mergedResult.next();\n     }\n-    \n+\n     @Override\n     public Object getValue(final int columnIndex, final Class<?> type) throws SQLException {\n-        Object value = mergedResult.getValue(columnIndex, type);\n-        if (null == value || !queryWithCipherColumn) {\n-            return value;\n+        Optional<Encryptor> encryptor;\n+        if (!queryWithCipherColumn || !(encryptor = metaData.findEncryptor(columnIndex)).isPresent()) {\n+            return mergedResult.getValue(columnIndex, type);\n         }\n-        Optional<Encryptor> encryptor = metaData.findEncryptor(columnIndex);\n-        return encryptor.isPresent() ? encryptor.get().decrypt(value.toString()) : value;\n+        String ciphertext = (String) mergedResult.getValue(columnIndex, String.class);\n+        return null == ciphertext ? null : encryptor.get().decrypt(ciphertext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16687819e776f7fc699bb0dcaeaeda81c0b7847d"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5311b57a830509968b659ad38697be9197d23a18", "author": {"user": null}, "url": "https://github.com/apache/shardingsphere/commit/5311b57a830509968b659ad38697be9197d23a18", "committedDate": "2020-01-21T03:47:39Z", "message": "code style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f2c2926f2851c34234ec16626868d375137c281", "author": {"user": null}, "url": "https://github.com/apache/shardingsphere/commit/2f2c2926f2851c34234ec16626868d375137c281", "committedDate": "2020-01-21T03:56:21Z", "message": "code style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NjMwOTU3", "url": "https://github.com/apache/shardingsphere/pull/3959#pullrequestreview-345630957", "createdAt": "2020-01-21T04:38:20Z", "commit": {"oid": "2f2c2926f2851c34234ec16626868d375137c281"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4205, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}