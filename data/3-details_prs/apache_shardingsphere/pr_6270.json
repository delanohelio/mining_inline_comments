{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NTE2MjM2", "number": 6270, "title": "Fix 6239", "bodyText": "For #6239\nChanges proposed in this pull request:\n\nmake the version of sharding-proxy and db cluster consistent, update server info version when proxy startup", "createdAt": "2020-07-06T03:26:54Z", "url": "https://github.com/apache/shardingsphere/pull/6270", "merged": true, "mergeCommit": {"oid": "7809caa085355a81f81544f7101aab42a01d37fa"}, "closed": true, "closedAt": "2020-07-06T07:11:21Z", "author": {"login": "xbkaishui"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxlVqNgH2gAyNDQ0NTE2MjM2OjEyNWQxM2Y5MzI2NTZiOGRkZjE5OGNhODMyZTUwODc4NTRhMDliOWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyL26lAFqTQ0MjgyMzc2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "125d13f932656b8ddf198ca832e5087854a09b9d", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/125d13f932656b8ddf198ca832e5087854a09b9d", "committedDate": "2020-07-04T10:18:31Z", "message": "add usage for proxy startup command"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7593a06f1373e70d9e64f675a324a50f880c6a2", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/d7593a06f1373e70d9e64f675a324a50f880c6a2", "committedDate": "2020-07-06T03:25:02Z", "message": "dynamic set server version when proxy startup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36ea446dfb55e2f3bbf0ba476f7aae1ecf39001d", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/36ea446dfb55e2f3bbf0ba476f7aae1ecf39001d", "committedDate": "2020-07-06T03:30:26Z", "message": "merge master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/a824485738666d9a93676f30448f3a14e9f5cad6", "committedDate": "2020-07-06T04:26:29Z", "message": "fix check style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNzczNTMz", "url": "https://github.com/apache/shardingsphere/pull/6270#pullrequestreview-442773533", "createdAt": "2020-07-06T04:55:30Z", "commit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwNDo1NTozMFrOGtIywA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwNTozNToyOVrOGtJXKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4MzE2OA==", "bodyText": "Should delete if only use for serverVersion once.", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449983168", "createdAt": "2020-07-06T04:55:30Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-mysql/src/main/java/org/apache/shardingsphere/db/protocol/mysql/constant/MySQLServerInfo.java", "diffHunk": "@@ -31,13 +31,33 @@\n      */\n     public static final int PROTOCOL_VERSION = 0x0A;\n     \n+    /**\n+     * Charset code 0x21 is utf8_general_ci.\n+     */\n+    public static final int CHARSET = 0x21;\n+    \n+    private static final String DEFAULT_SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4Mzg0NA==", "bodyText": "follow an empty line.", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449983844", "createdAt": "2020-07-06T04:58:39Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-mysql/src/main/java/org/apache/shardingsphere/db/protocol/mysql/constant/MySQLServerInfo.java", "diffHunk": "@@ -31,13 +31,33 @@\n      */\n     public static final int PROTOCOL_VERSION = 0x0A;\n     \n+    /**\n+     * Charset code 0x21 is utf8_general_ci.\n+     */\n+    public static final int CHARSET = 0x21;\n+    \n+    private static final String DEFAULT_SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    \n     /**\n      * Server version.\n      */\n-    public static final String SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    private static String serverVersion = DEFAULT_SERVER_VERSION;\n     \n     /**\n-     * Charset code 0x21 is utf8_general_ci.\n+     *  set server version.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4Mzk5NQ==", "bodyText": "null != version", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449983995", "createdAt": "2020-07-06T04:59:30Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-mysql/src/main/java/org/apache/shardingsphere/db/protocol/mysql/constant/MySQLServerInfo.java", "diffHunk": "@@ -31,13 +31,33 @@\n      */\n     public static final int PROTOCOL_VERSION = 0x0A;\n     \n+    /**\n+     * Charset code 0x21 is utf8_general_ci.\n+     */\n+    public static final int CHARSET = 0x21;\n+    \n+    private static final String DEFAULT_SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    \n     /**\n      * Server version.\n      */\n-    public static final String SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    private static String serverVersion = DEFAULT_SERVER_VERSION;\n     \n     /**\n-     * Charset code 0x21 is utf8_general_ci.\n+     *  set server version.\n+     * @param version version\n      */\n-    public static final int CHARSET = 0x21;\n+    public static void setServerVersion(final String version) {\n+        if (version != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4NTczNA==", "bodyText": "set should be capitalized.", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449985734", "createdAt": "2020-07-06T05:07:22Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-mysql/src/main/java/org/apache/shardingsphere/db/protocol/mysql/constant/MySQLServerInfo.java", "diffHunk": "@@ -31,13 +31,33 @@\n      */\n     public static final int PROTOCOL_VERSION = 0x0A;\n     \n+    /**\n+     * Charset code 0x21 is utf8_general_ci.\n+     */\n+    public static final int CHARSET = 0x21;\n+    \n+    private static final String DEFAULT_SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    \n     /**\n      * Server version.\n      */\n-    public static final String SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    private static String serverVersion = DEFAULT_SERVER_VERSION;\n     \n     /**\n-     * Charset code 0x21 is utf8_general_ci.\n+     *  set server version.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4NTgyOQ==", "bodyText": "server version", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449985829", "createdAt": "2020-07-06T05:07:47Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-mysql/src/main/java/org/apache/shardingsphere/db/protocol/mysql/constant/MySQLServerInfo.java", "diffHunk": "@@ -31,13 +31,33 @@\n      */\n     public static final int PROTOCOL_VERSION = 0x0A;\n     \n+    /**\n+     * Charset code 0x21 is utf8_general_ci.\n+     */\n+    public static final int CHARSET = 0x21;\n+    \n+    private static final String DEFAULT_SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    \n     /**\n      * Server version.\n      */\n-    public static final String SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    private static String serverVersion = DEFAULT_SERVER_VERSION;\n     \n     /**\n-     * Charset code 0x21 is utf8_general_ci.\n+     *  set server version.\n+     * @param version version", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4NjAyMg==", "bodyText": "get should be capitalized.", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449986022", "createdAt": "2020-07-06T05:08:46Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-mysql/src/main/java/org/apache/shardingsphere/db/protocol/mysql/constant/MySQLServerInfo.java", "diffHunk": "@@ -31,13 +31,33 @@\n      */\n     public static final int PROTOCOL_VERSION = 0x0A;\n     \n+    /**\n+     * Charset code 0x21 is utf8_general_ci.\n+     */\n+    public static final int CHARSET = 0x21;\n+    \n+    private static final String DEFAULT_SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    \n     /**\n      * Server version.\n      */\n-    public static final String SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    private static String serverVersion = DEFAULT_SERVER_VERSION;\n     \n     /**\n-     * Charset code 0x21 is utf8_general_ci.\n+     *  set server version.\n+     * @param version version\n      */\n-    public static final int CHARSET = 0x21;\n+    public static void setServerVersion(final String version) {\n+        if (version != null) {\n+            serverVersion = String.format(\"%s-ShardingSphere-Proxy 5.0.0-RC1\", version);\n+        }\n+    }\n+    \n+    /**\n+     * get current server version.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4NjA1MQ==", "bodyText": "follow an empty line.", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449986051", "createdAt": "2020-07-06T05:08:59Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-mysql/src/main/java/org/apache/shardingsphere/db/protocol/mysql/constant/MySQLServerInfo.java", "diffHunk": "@@ -31,13 +31,33 @@\n      */\n     public static final int PROTOCOL_VERSION = 0x0A;\n     \n+    /**\n+     * Charset code 0x21 is utf8_general_ci.\n+     */\n+    public static final int CHARSET = 0x21;\n+    \n+    private static final String DEFAULT_SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    \n     /**\n      * Server version.\n      */\n-    public static final String SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    private static String serverVersion = DEFAULT_SERVER_VERSION;\n     \n     /**\n-     * Charset code 0x21 is utf8_general_ci.\n+     *  set server version.\n+     * @param version version\n      */\n-    public static final int CHARSET = 0x21;\n+    public static void setServerVersion(final String version) {\n+        if (version != null) {\n+            serverVersion = String.format(\"%s-ShardingSphere-Proxy 5.0.0-RC1\", version);\n+        }\n+    }\n+    \n+    /**\n+     * get current server version.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4NzAxOA==", "bodyText": "What's this for?  I suggest delete it from this pr. If you would like to add help, please create a new issue to do this.", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449987018", "createdAt": "2020-07-06T05:13:08Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-distribution/shardingsphere-proxy-distribution/src/main/resources/bin/start.sh", "diffHunk": "@@ -38,6 +38,17 @@ JAVA_MEM_OPTS=\" -server -Xmx2g -Xms2g -Xmn1g -Xss256k -XX:+DisableExplicitGC -XX\n \n MAIN_CLASS=org.apache.shardingsphere.proxy.Bootstrap\n \n+print_usage() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk4OTI0Ng==", "bodyText": "remove meaningless empty line.", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449989246", "createdAt": "2020-07-06T05:22:09Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-proxy/shardingsphere-proxy-bootstrap/src/main/java/org/apache/shardingsphere/proxy/Bootstrap.java", "diffHunk": "@@ -157,6 +162,26 @@ private static void initialize(final Authentication authentication, final Proper\n         log(authentication, properties);\n         initControlPanelFacade(metricsConfiguration);\n         initCluster(cluster);\n+        updateServerInfo();\n+    }\n+    \n+    private static void updateServerInfo() {\n+        List<String> schemaNames = ProxySchemaContexts.getInstance().getSchemaNames();\n+        if (CollectionUtils.isEmpty(schemaNames)) {\n+            return;\n+        }\n+        Map<String, DataSource> dataSources = ProxySchemaContexts.getInstance().getSchema(schemaNames.get(0)).getSchema().getDataSources();\n+        DataSource singleDataSource = dataSources.values().iterator().next();\n+        try (Connection connection = singleDataSource.getConnection()) {\n+            DatabaseMetaData meta = connection.getMetaData();\n+            String name = meta.getDatabaseProductName();\n+            String version = meta.getDatabaseProductVersion();\n+            log.info(\"server name {} , server version {}\", name, version);\n+            MySQLServerInfo.setServerVersion(version);\n+        } catch (SQLException e) {\n+            log.error(e.getMessage(), e);\n+        }\n+    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk5MDA4MQ==", "bodyText": "meta -> databaseMetaData, note that we rarely use abbreviation.", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449990081", "createdAt": "2020-07-06T05:25:42Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-proxy/shardingsphere-proxy-bootstrap/src/main/java/org/apache/shardingsphere/proxy/Bootstrap.java", "diffHunk": "@@ -157,6 +162,26 @@ private static void initialize(final Authentication authentication, final Proper\n         log(authentication, properties);\n         initControlPanelFacade(metricsConfiguration);\n         initCluster(cluster);\n+        updateServerInfo();\n+    }\n+    \n+    private static void updateServerInfo() {\n+        List<String> schemaNames = ProxySchemaContexts.getInstance().getSchemaNames();\n+        if (CollectionUtils.isEmpty(schemaNames)) {\n+            return;\n+        }\n+        Map<String, DataSource> dataSources = ProxySchemaContexts.getInstance().getSchema(schemaNames.get(0)).getSchema().getDataSources();\n+        DataSource singleDataSource = dataSources.values().iterator().next();\n+        try (Connection connection = singleDataSource.getConnection()) {\n+            DatabaseMetaData meta = connection.getMetaData();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk5MDcwMg==", "bodyText": "throw a ShardingSphereException instead of print log.", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449990702", "createdAt": "2020-07-06T05:28:11Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-proxy/shardingsphere-proxy-bootstrap/src/main/java/org/apache/shardingsphere/proxy/Bootstrap.java", "diffHunk": "@@ -157,6 +162,26 @@ private static void initialize(final Authentication authentication, final Proper\n         log(authentication, properties);\n         initControlPanelFacade(metricsConfiguration);\n         initCluster(cluster);\n+        updateServerInfo();\n+    }\n+    \n+    private static void updateServerInfo() {\n+        List<String> schemaNames = ProxySchemaContexts.getInstance().getSchemaNames();\n+        if (CollectionUtils.isEmpty(schemaNames)) {\n+            return;\n+        }\n+        Map<String, DataSource> dataSources = ProxySchemaContexts.getInstance().getSchema(schemaNames.get(0)).getSchema().getDataSources();\n+        DataSource singleDataSource = dataSources.values().iterator().next();\n+        try (Connection connection = singleDataSource.getConnection()) {\n+            DatabaseMetaData meta = connection.getMetaData();\n+            String name = meta.getDatabaseProductName();\n+            String version = meta.getDatabaseProductVersion();\n+            log.info(\"server name {} , server version {}\", name, version);\n+            MySQLServerInfo.setServerVersion(version);\n+        } catch (SQLException e) {\n+            log.error(e.getMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk5MDgxMA==", "bodyText": "SQLException e -> final SQLException ex", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449990810", "createdAt": "2020-07-06T05:28:42Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-proxy/shardingsphere-proxy-bootstrap/src/main/java/org/apache/shardingsphere/proxy/Bootstrap.java", "diffHunk": "@@ -157,6 +162,26 @@ private static void initialize(final Authentication authentication, final Proper\n         log(authentication, properties);\n         initControlPanelFacade(metricsConfiguration);\n         initCluster(cluster);\n+        updateServerInfo();\n+    }\n+    \n+    private static void updateServerInfo() {\n+        List<String> schemaNames = ProxySchemaContexts.getInstance().getSchemaNames();\n+        if (CollectionUtils.isEmpty(schemaNames)) {\n+            return;\n+        }\n+        Map<String, DataSource> dataSources = ProxySchemaContexts.getInstance().getSchema(schemaNames.get(0)).getSchema().getDataSources();\n+        DataSource singleDataSource = dataSources.values().iterator().next();\n+        try (Connection connection = singleDataSource.getConnection()) {\n+            DatabaseMetaData meta = connection.getMetaData();\n+            String name = meta.getDatabaseProductName();\n+            String version = meta.getDatabaseProductVersion();\n+            log.info(\"server name {} , server version {}\", name, version);\n+            MySQLServerInfo.setServerVersion(version);\n+        } catch (SQLException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk5MjQ5MA==", "bodyText": "remove this change if it's not about the server version.", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r449992490", "createdAt": "2020-07-06T05:35:29Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-proxy/shardingsphere-proxy-common/src/main/java/org/apache/shardingsphere/proxy/config/ShardingConfigurationLoader.java", "diffHunk": "@@ -52,9 +53,10 @@\n      * @throws IOException IO exception\n      */\n     public ShardingConfiguration load(final String path) throws IOException {\n+        //this is just check for schemaName duplication", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a824485738666d9a93676f30448f3a14e9f5cad6"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2c8f52658a82312948736ff68ae3ed83978a57f", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/a2c8f52658a82312948736ff68ae3ed83978a57f", "committedDate": "2020-07-06T06:02:01Z", "message": "fix code review suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODA4ODcy", "url": "https://github.com/apache/shardingsphere/pull/6270#pullrequestreview-442808872", "createdAt": "2020-07-06T06:42:24Z", "commit": {"oid": "a2c8f52658a82312948736ff68ae3ed83978a57f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwNjo0MjoyNFrOGtKnBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwNjo1MDowMVrOGtKyfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxMjkzMg==", "bodyText": "version server version -> server version", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r450012932", "createdAt": "2020-07-06T06:42:24Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-mysql/src/main/java/org/apache/shardingsphere/db/protocol/mysql/constant/MySQLServerInfo.java", "diffHunk": "@@ -31,13 +31,33 @@\n      */\n     public static final int PROTOCOL_VERSION = 0x0A;\n     \n+    /**\n+     * Charset code 0x21 is utf8_general_ci.\n+     */\n+    public static final int CHARSET = 0x21;\n+    \n     /**\n      * Server version.\n      */\n-    public static final String SERVER_VERSION = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n+    private static String serverVersion = \"8.0.20-ShardingSphere-Proxy 5.0.0-RC1\";\n     \n     /**\n-     * Charset code 0x21 is utf8_general_ci.\n+     * Set server version.\n+     *\n+     * @param version server version", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2c8f52658a82312948736ff68ae3ed83978a57f"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxMzk4Mg==", "bodyText": "move @slf4j after constructor", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r450013982", "createdAt": "2020-07-06T06:45:08Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-proxy/shardingsphere-proxy-bootstrap/src/main/java/org/apache/shardingsphere/proxy/Bootstrap.java", "diffHunk": "@@ -77,6 +81,7 @@\n /**\n  * ShardingSphere-Proxy Bootstrap.\n  */\n+@Slf4j", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2c8f52658a82312948736ff68ae3ed83978a57f"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxNTIxNA==", "bodyText": "Database name/Database version is better.", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r450015214", "createdAt": "2020-07-06T06:48:28Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-proxy/shardingsphere-proxy-bootstrap/src/main/java/org/apache/shardingsphere/proxy/Bootstrap.java", "diffHunk": "@@ -157,6 +162,25 @@ private static void initialize(final Authentication authentication, final Proper\n         log(authentication, properties);\n         initControlPanelFacade(metricsConfiguration);\n         initCluster(cluster);\n+        updateServerInfo();\n+    }\n+    \n+    private static void updateServerInfo() {\n+        List<String> schemaNames = ProxySchemaContexts.getInstance().getSchemaNames();\n+        if (CollectionUtils.isEmpty(schemaNames)) {\n+            return;\n+        }\n+        Map<String, DataSource> dataSources = ProxySchemaContexts.getInstance().getSchema(schemaNames.get(0)).getSchema().getDataSources();\n+        DataSource singleDataSource = dataSources.values().iterator().next();\n+        try (Connection connection = singleDataSource.getConnection()) {\n+            DatabaseMetaData databaseMetaData = connection.getMetaData();\n+            String name = databaseMetaData.getDatabaseProductName();\n+            String version = databaseMetaData.getDatabaseProductVersion();\n+            log.info(\"server name {} , server version {}\", name, version);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2c8f52658a82312948736ff68ae3ed83978a57f"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAxNTg3MA==", "bodyText": "e -> ex", "url": "https://github.com/apache/shardingsphere/pull/6270#discussion_r450015870", "createdAt": "2020-07-06T06:50:01Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-proxy/shardingsphere-proxy-bootstrap/src/main/java/org/apache/shardingsphere/proxy/Bootstrap.java", "diffHunk": "@@ -157,6 +162,25 @@ private static void initialize(final Authentication authentication, final Proper\n         log(authentication, properties);\n         initControlPanelFacade(metricsConfiguration);\n         initCluster(cluster);\n+        updateServerInfo();\n+    }\n+    \n+    private static void updateServerInfo() {\n+        List<String> schemaNames = ProxySchemaContexts.getInstance().getSchemaNames();\n+        if (CollectionUtils.isEmpty(schemaNames)) {\n+            return;\n+        }\n+        Map<String, DataSource> dataSources = ProxySchemaContexts.getInstance().getSchema(schemaNames.get(0)).getSchema().getDataSources();\n+        DataSource singleDataSource = dataSources.values().iterator().next();\n+        try (Connection connection = singleDataSource.getConnection()) {\n+            DatabaseMetaData databaseMetaData = connection.getMetaData();\n+            String name = databaseMetaData.getDatabaseProductName();\n+            String version = databaseMetaData.getDatabaseProductVersion();\n+            log.info(\"server name {} , server version {}\", name, version);\n+            MySQLServerInfo.setServerVersion(version);\n+        } catch (final SQLException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2c8f52658a82312948736ff68ae3ed83978a57f"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20242332e365c065c561d1fe03aeebc60f260bff", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/20242332e365c065c561d1fe03aeebc60f260bff", "committedDate": "2020-07-06T06:57:31Z", "message": "fix code review suggestions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c463fe0cb74625acc4230aff9c2b607d95888806", "author": {"user": {"login": "xbkaishui", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/c463fe0cb74625acc4230aff9c2b607d95888806", "committedDate": "2020-07-06T07:02:59Z", "message": "fix code review suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODIzNzY2", "url": "https://github.com/apache/shardingsphere/pull/6270#pullrequestreview-442823766", "createdAt": "2020-07-06T07:11:14Z", "commit": {"oid": "c463fe0cb74625acc4230aff9c2b607d95888806"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4863, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}