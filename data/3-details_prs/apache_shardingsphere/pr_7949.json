{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNjQxNTUz", "number": 7949, "title": "fix some sql parse exception and ddl, dcl route logic", "bodyText": "Fixes #7918.\nChanges proposed in this pull request:\n\nfix start slave and stop slave statements parse error\nfix set character statement parse error\nfix ddl and dcl statement route wrong result when table without sharding rule\nfix UnknownFormatConversionException when sql parse error which include % sign", "createdAt": "2020-10-28T15:36:51Z", "url": "https://github.com/apache/shardingsphere/pull/7949", "merged": true, "mergeCommit": {"oid": "e549d5d4c81222f6c91458d38e6c96ffdad095ee"}, "closed": true, "closedAt": "2020-10-30T06:23:27Z", "author": {"login": "strongduanmu"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdW2hfAgH2gAyNTExNjQxNTUzOmVmNDE1YTgzN2I5MDUwZThmZGM3NGJhNjBiYzM3NjMxZmFmNzNlYzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXgssCAFqTUyMDQwMTMzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ef415a837b9050e8fdc74ba60bc37631faf73ec5", "author": {"user": {"login": "strongduanmu", "name": "Zhengqiang Duan"}}, "url": "https://github.com/apache/shardingsphere/commit/ef415a837b9050e8fdc74ba60bc37631faf73ec5", "committedDate": "2020-10-28T05:15:01Z", "message": "fix some sql parse exception and ddl, dcl route logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92955db6824d62c685b9194246d7e9fe6373b372", "author": {"user": {"login": "strongduanmu", "name": "Zhengqiang Duan"}}, "url": "https://github.com/apache/shardingsphere/commit/92955db6824d62c685b9194246d7e9fe6373b372", "committedDate": "2020-10-28T15:23:22Z", "message": "add sharding route engine test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "703895989c92d518da7b60c9101855db5542df7c", "author": {"user": {"login": "strongduanmu", "name": "Zhengqiang Duan"}}, "url": "https://github.com/apache/shardingsphere/commit/703895989c92d518da7b60c9101855db5542df7c", "committedDate": "2020-10-29T00:44:05Z", "message": "fix UnknownFormatConversionException when sql include % sign"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01b4740d1649c3ab3816d05a0fc7093721495d5c", "author": {"user": {"login": "strongduanmu", "name": "Zhengqiang Duan"}}, "url": "https://github.com/apache/shardingsphere/commit/01b4740d1649c3ab3816d05a0fc7093721495d5c", "committedDate": "2020-10-29T00:47:56Z", "message": "Resolve conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de4eff46c599daa6e0b9fc15f09ca64b9b1f229b", "author": {"user": {"login": "strongduanmu", "name": "Zhengqiang Duan"}}, "url": "https://github.com/apache/shardingsphere/commit/de4eff46c599daa6e0b9fc15f09ca64b9b1f229b", "committedDate": "2020-10-29T01:27:45Z", "message": "fix set statement parse error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MzA3OTY1", "url": "https://github.com/apache/shardingsphere/pull/7949#pullrequestreview-519307965", "createdAt": "2020-10-29T03:36:28Z", "commit": {"oid": "de4eff46c599daa6e0b9fc15f09ca64b9b1f229b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwMzozNjoyOFrOHqHX5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwMzozOTowOFrOHqHdsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzkyMzA0Nw==", "bodyText": "Could you give a SQL example involving ShardingInstanceBroadcastRoutingEngine", "url": "https://github.com/apache/shardingsphere/pull/7949#discussion_r513923047", "createdAt": "2020-10-29T03:36:28Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-route/src/main/java/org/apache/shardingsphere/sharding/route/engine/type/ShardingRouteEngineFactory.java", "diffHunk": "@@ -140,10 +131,16 @@ private static ShardingRouteEngine getDALRoutingEngine(final ShardingRule shardi\n         return new ShardingDataSourceGroupBroadcastRoutingEngine();\n     }\n     \n-    private static ShardingRouteEngine getDCLRoutingEngine(final SQLStatementContext sqlStatementContext, final ShardingSphereMetaData metaData) {\n-        return isDCLForSingleTable(sqlStatementContext) \n-                ? new ShardingTableBroadcastRoutingEngine(metaData.getSchemaMetaData().getConfiguredSchemaMetaData(), sqlStatementContext)\n-                : new ShardingInstanceBroadcastRoutingEngine(metaData.getDataSourcesMetaData());\n+    private static ShardingRouteEngine getDCLRoutingEngine(final ShardingRule shardingRule, final Map<String, Collection<String>> unconfiguredSchemaMetaDataMap,\n+                                                           final SQLStatementContext sqlStatementContext, final ShardingSphereMetaData metaData) {\n+        if (isDCLForSingleTable(sqlStatementContext)) {\n+            Collection<String> tableNames = sqlStatementContext.getTablesContext().getTableNames();\n+            return !shardingRule.tableRuleExists(tableNames)\n+                    ? new ShardingUnconfiguredTablesRoutingEngine(tableNames, unconfiguredSchemaMetaDataMap, sqlStatementContext.getSqlStatement()) \n+                    : new ShardingTableBroadcastRoutingEngine(metaData.getSchemaMetaData().getConfiguredSchemaMetaData(), sqlStatementContext);\n+        } else {\n+            return new ShardingInstanceBroadcastRoutingEngine(metaData.getDataSourcesMetaData());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de4eff46c599daa6e0b9fc15f09ca64b9b1f229b"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzkyNDUyOQ==", "bodyText": "Why is replaceAll(\"%\", \"%%\") needed?", "url": "https://github.com/apache/shardingsphere/pull/7949#discussion_r513924529", "createdAt": "2020-10-29T03:39:08Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-engine/src/main/java/org/apache/shardingsphere/sql/parser/api/parser/SQLParserEngine.java", "diffHunk": "@@ -64,7 +64,7 @@ public ParseTree parse(final String sql, final boolean useCache) {\n     private ParseTree parse(final String sql) {\n         ParseASTNode result = twoPhaseParse(sql);\n         if (result.getRootNode() instanceof ErrorNode) {\n-            throw new SQLParsingException(String.format(\"Unsupported SQL of `%s`\", sql));\n+            throw new SQLParsingException(String.format(\"Unsupported SQL of `%s`\", sql).replaceAll(\"%\", \"%%\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de4eff46c599daa6e0b9fc15f09ca64b9b1f229b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f2cc09bbab32d53e4cd3850bf6dd404672f9df5", "author": {"user": {"login": "strongduanmu", "name": "Zhengqiang Duan"}}, "url": "https://github.com/apache/shardingsphere/commit/6f2cc09bbab32d53e4cd3850bf6dd404672f9df5", "committedDate": "2020-10-29T05:40:30Z", "message": "resolve conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c19dc6af2afe18be3a28141421122efbca467c2", "author": {"user": {"login": "strongduanmu", "name": "Zhengqiang Duan"}}, "url": "https://github.com/apache/shardingsphere/commit/9c19dc6af2afe18be3a28141421122efbca467c2", "committedDate": "2020-10-29T11:02:14Z", "message": "resolve conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b26ba31879dbe7699b5d8114f894c96e0973f68", "author": {"user": {"login": "strongduanmu", "name": "Zhengqiang Duan"}}, "url": "https://github.com/apache/shardingsphere/commit/4b26ba31879dbe7699b5d8114f894c96e0973f68", "committedDate": "2020-10-29T11:13:43Z", "message": "add a constructor to solve UnknownFormatConversionException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0d0e13a415701bd68943e8fe4be3fe3a67a5457", "author": {"user": {"login": "strongduanmu", "name": "Zhengqiang Duan"}}, "url": "https://github.com/apache/shardingsphere/commit/a0d0e13a415701bd68943e8fe4be3fe3a67a5457", "committedDate": "2020-10-29T15:05:03Z", "message": "support password function in set password statement"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDAxMzMy", "url": "https://github.com/apache/shardingsphere/pull/7949#pullrequestreview-520401332", "createdAt": "2020-10-30T06:23:16Z", "commit": {"oid": "a0d0e13a415701bd68943e8fe4be3fe3a67a5457"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3940, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}