{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNDUwNDg1", "number": 3906, "title": "Make the shadow feature more complete", "bodyText": "Changes proposed in this pull request:\n\nmake the shadow connection and statement more complete\nrefactor shadow condition and judgement engine\nadd test for shadow judgement engine", "createdAt": "2020-01-08T13:08:39Z", "url": "https://github.com/apache/shardingsphere/pull/3906", "merged": true, "mergeCommit": {"oid": "8b62ceb6b615b2c228f45c9bbdb96b01b2f999fc"}, "closed": true, "closedAt": "2020-01-10T11:25:23Z", "author": {"login": "yanyzy"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4P7gwAH2gAyMzYwNDUwNDg1OjgwOWFkZjA0OTcxZGFjYTUwZWZiODk4NTI2M2MyYTRlY2FiNDI0MWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb48zhWAFqTM0MTEwNDAzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "809adf04971daca50efb8985263c2a4ecab4241d", "author": {"user": {"login": "yanyzy", "name": "zhyee"}}, "url": "https://github.com/apache/shardingsphere/commit/809adf04971daca50efb8985263c2a4ecab4241d", "committedDate": "2020-01-08T07:08:16Z", "message": "make the shadow connection and statement more complete"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e7bdbdf5e94cc8e99bf082a73ae819b15328d8e", "author": {"user": {"login": "yanyzy", "name": "zhyee"}}, "url": "https://github.com/apache/shardingsphere/commit/4e7bdbdf5e94cc8e99bf082a73ae819b15328d8e", "committedDate": "2020-01-08T07:58:58Z", "message": "refactor shadow condition and judgement engine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01c5eb8001cbe24ed7271ab4aef9b0c7b50f528f", "author": {"user": {"login": "yanyzy", "name": "zhyee"}}, "url": "https://github.com/apache/shardingsphere/commit/01c5eb8001cbe24ed7271ab4aef9b0c7b50f528f", "committedDate": "2020-01-08T13:05:55Z", "message": "add test for shadow judgement engine"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMzE3Mjky", "url": "https://github.com/apache/shardingsphere/pull/3906#pullrequestreview-340317292", "createdAt": "2020-01-09T06:52:58Z", "commit": {"oid": "01c5eb8001cbe24ed7271ab4aef9b0c7b50f528f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwNjo1Mjo1OFrOFbsR_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwNjo1Mjo1OFrOFbsR_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU4MTM3NQ==", "bodyText": "isShadowSql should name as isShadowSQL", "url": "https://github.com/apache/shardingsphere/pull/3906#discussion_r364581375", "createdAt": "2020-01-09T06:52:58Z", "author": {"login": "terrymanu"}, "path": "sharding-jdbc/sharding-jdbc-core/src/main/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShadowPreparedStatement.java", "diffHunk": "@@ -66,11 +66,11 @@\n     \n     private final String sql;\n     \n-    private ShadowJudgementEngine shadowJudgementEngine;\n-    \n     private PreparedStatement preparedStatement;\n     \n     private ResultSet resultSet;\n+\n+    private boolean isShadowSql;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01c5eb8001cbe24ed7271ab4aef9b0c7b50f528f"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fad9b32a6f38d175f972e8caa6724a6975dcf57", "author": {"user": {"login": "yanyzy", "name": "zhyee"}}, "url": "https://github.com/apache/shardingsphere/commit/9fad9b32a6f38d175f972e8caa6724a6975dcf57", "committedDate": "2020-01-09T07:48:11Z", "message": "rename isShadowSql to isShadowSQL;\ndisable show sql for integration test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMzkyNjIx", "url": "https://github.com/apache/shardingsphere/pull/3906#pullrequestreview-340392621", "createdAt": "2020-01-09T09:39:21Z", "commit": {"oid": "9fad9b32a6f38d175f972e8caa6724a6975dcf57"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwOTozOToyMVrOFbv2UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwOTo0MTozM1rOFbv6mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDYzOTgyNA==", "bodyText": "We need a blank line for the end of file", "url": "https://github.com/apache/shardingsphere/pull/3906#discussion_r364639824", "createdAt": "2020-01-09T09:39:21Z", "author": {"login": "terrymanu"}, "path": "sharding-integration-test/sharding-jdbc-test/src/test/resources/integrate/env/shadow/sharding-rule.yaml", "diffHunk": "@@ -36,7 +36,4 @@ shadowRule:\n           column: item_id\n     defaultDataSourceName: db\n     defaultTableStrategy:\n-      none:\n-\n-props:\n-  sql.show: true\n\\ No newline at end of file\n+      none:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fad9b32a6f38d175f972e8caa6724a6975dcf57"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY0MDE2Mw==", "bodyText": "Can we use lombok's @getter to instead of it?", "url": "https://github.com/apache/shardingsphere/pull/3906#discussion_r364640163", "createdAt": "2020-01-09T09:40:03Z", "author": {"login": "terrymanu"}, "path": "sharding-jdbc/sharding-jdbc-core/src/main/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/connection/ShadowConnection.java", "diffHunk": "@@ -93,13 +102,14 @@ public PreparedStatement prepareStatement(final String sql, final String[] colum\n     \n     @Override\n     public void setAutoCommit(final boolean autoCommit) throws SQLException {\n+        this.autoCommit = autoCommit;\n         actualConnection.setAutoCommit(autoCommit);\n         shadowConnection.setAutoCommit(autoCommit);\n     }\n     \n     @Override\n     public boolean getAutoCommit() {\n-        return false;\n+        return autoCommit;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fad9b32a6f38d175f972e8caa6724a6975dcf57"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY0MDI2NA==", "bodyText": "Can we use lombok's @getter to instead of it?", "url": "https://github.com/apache/shardingsphere/pull/3906#discussion_r364640264", "createdAt": "2020-01-09T09:40:11Z", "author": {"login": "terrymanu"}, "path": "sharding-jdbc/sharding-jdbc-core/src/main/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/connection/ShadowConnection.java", "diffHunk": "@@ -116,13 +126,14 @@ public void rollback() throws SQLException {\n     \n     @Override\n     public void close() throws SQLException {\n+        closed = true;\n         actualConnection.close();\n         shadowConnection.close();\n     }\n     \n     @Override\n     public boolean isClosed() {\n-        return false;\n+        return closed;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fad9b32a6f38d175f972e8caa6724a6975dcf57"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY0MDMwMQ==", "bodyText": "Can we use lombok's @getter to instead of it?", "url": "https://github.com/apache/shardingsphere/pull/3906#discussion_r364640301", "createdAt": "2020-01-09T09:40:17Z", "author": {"login": "terrymanu"}, "path": "sharding-jdbc/sharding-jdbc-core/src/main/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/connection/ShadowConnection.java", "diffHunk": "@@ -132,24 +143,26 @@ public DatabaseMetaData getMetaData() throws SQLException {\n     \n     @Override\n     public void setReadOnly(final boolean readOnly) throws SQLException {\n+        this.readOnly = readOnly;\n         actualConnection.setReadOnly(readOnly);\n         shadowConnection.setReadOnly(readOnly);\n     }\n     \n     @Override\n     public boolean isReadOnly() {\n-        return false;\n+        return readOnly;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fad9b32a6f38d175f972e8caa6724a6975dcf57"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY0MDM0NA==", "bodyText": "Can we use lombok's @getter to instead of it?", "url": "https://github.com/apache/shardingsphere/pull/3906#discussion_r364640344", "createdAt": "2020-01-09T09:40:23Z", "author": {"login": "terrymanu"}, "path": "sharding-jdbc/sharding-jdbc-core/src/main/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/connection/ShadowConnection.java", "diffHunk": "@@ -132,24 +143,26 @@ public DatabaseMetaData getMetaData() throws SQLException {\n     \n     @Override\n     public void setReadOnly(final boolean readOnly) throws SQLException {\n+        this.readOnly = readOnly;\n         actualConnection.setReadOnly(readOnly);\n         shadowConnection.setReadOnly(readOnly);\n     }\n     \n     @Override\n     public boolean isReadOnly() {\n-        return false;\n+        return readOnly;\n     }\n \n     @Override\n     public void setTransactionIsolation(final int level) throws SQLException {\n+        transactionIsolation = level;\n         actualConnection.setTransactionIsolation(level);\n         shadowConnection.setTransactionIsolation(level);\n     }\n     \n     @Override\n     public int getTransactionIsolation() {\n-        return 0;\n+        return transactionIsolation;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fad9b32a6f38d175f972e8caa6724a6975dcf57"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY0MDYyMQ==", "bodyText": "Is it correct for default value forever?", "url": "https://github.com/apache/shardingsphere/pull/3906#discussion_r364640621", "createdAt": "2020-01-09T09:40:54Z", "author": {"login": "terrymanu"}, "path": "sharding-jdbc/sharding-jdbc-core/src/main/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/connection/ShadowConnection.java", "diffHunk": "@@ -169,6 +182,6 @@ public void setHoldability(final int holdability) throws SQLException {\n     \n     @Override\n     public int getHoldability() {\n-        return 0;\n+        return ResultSet.CLOSE_CURSORS_AT_COMMIT;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fad9b32a6f38d175f972e8caa6724a6975dcf57"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDY0MDkyMA==", "bodyText": "We should name as result for return value", "url": "https://github.com/apache/shardingsphere/pull/3906#discussion_r364640920", "createdAt": "2020-01-09T09:41:33Z", "author": {"login": "terrymanu"}, "path": "sharding-jdbc/sharding-jdbc-core/src/main/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShadowStatement.java", "diffHunk": "@@ -181,7 +183,8 @@ private Statement getStatementAndReplay(final String sql) throws SQLException {\n         SQLStatement sqlStatement = connection.getRuntimeContext().getParseEngine().parse(sql, false);\n         sqlStatementContext = SQLStatementContextFactory.newInstance(getRelationMetas(connection.getRuntimeContext().getMetaData().getTables()), sql, Collections.emptyList(), sqlStatement);\n         ShadowJudgementEngine shadowJudgementEngine = new SimpleJudgementEngine(connection.getRuntimeContext().getRule(), sqlStatementContext);\n-        statement = shadowStatementGenerator.createStatement(shadowJudgementEngine);\n+        isShadowSQL = shadowJudgementEngine.isShadowSQL();\n+        statement = shadowStatementGenerator.createStatement();\n         return statement;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fad9b32a6f38d175f972e8caa6724a6975dcf57"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c0287d15855cf3ac93299cec9ba5ff9ef8cc7bd", "author": {"user": {"login": "yanyzy", "name": "zhyee"}}, "url": "https://github.com/apache/shardingsphere/commit/6c0287d15855cf3ac93299cec9ba5ff9ef8cc7bd", "committedDate": "2020-01-10T06:56:38Z", "message": "keep code style consistent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6b01334180eb4f234157d7e47ed327b4630d24f", "author": {"user": {"login": "yanyzy", "name": "zhyee"}}, "url": "https://github.com/apache/shardingsphere/commit/e6b01334180eb4f234157d7e47ed327b4630d24f", "committedDate": "2020-01-10T09:58:09Z", "message": "remove unnecessary get method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMTA0MDM3", "url": "https://github.com/apache/shardingsphere/pull/3906#pullrequestreview-341104037", "createdAt": "2020-01-10T11:25:16Z", "commit": {"oid": "e6b01334180eb4f234157d7e47ed327b4630d24f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4191, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}