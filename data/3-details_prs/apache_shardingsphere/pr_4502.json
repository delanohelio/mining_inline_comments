{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNzcwODA5", "number": 4502, "title": "#4501, Identify MySQL syntax allowed in Prepared Statements", "bodyText": "Fixes #4501.", "createdAt": "2020-02-27T10:52:45Z", "url": "https://github.com/apache/shardingsphere/pull/4502", "merged": true, "mergeCommit": {"oid": "e4c154a8402e54bb9b29971a86a03ddc5a426c6c"}, "closed": true, "closedAt": "2020-03-03T11:42:32Z", "author": {"login": "tuohai666"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIZDVsgH2gAyMzgwNzcwODA5OjRhN2FmMmUzMTE1ZmJlMzhmZmRlYjBkMzgwMzVlMTZmMDVkOTI0MDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKA0MWAFqTM2NzkwOTMyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4a7af2e3115fbe38ffdeb0d38035e16f05d92404", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/4a7af2e3115fbe38ffdeb0d38035e16f05d92404", "committedDate": "2020-02-27T10:48:45Z", "message": "#4501, Identify MySQL syntax allowed in Prepared Statements"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjMyNTkx", "url": "https://github.com/apache/shardingsphere/pull/4502#pullrequestreview-365632591", "createdAt": "2020-02-27T12:14:37Z", "commit": {"oid": "4a7af2e3115fbe38ffdeb0d38035e16f05d92404"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjoxNDozOFrOFvP_NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjoxNDozOFrOFvP_NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4OTMzMw==", "bodyText": "Can we move the SQL parser logic into parser module?", "url": "https://github.com/apache/shardingsphere/pull/4502#discussion_r385089333", "createdAt": "2020-02-27T12:14:38Z", "author": {"login": "terrymanu"}, "path": "sharding-proxy/sharding-proxy-frontend/sharding-proxy-frontend-mysql/src/main/java/org/apache/shardingsphere/shardingproxy/frontend/mysql/command/query/binary/prepare/MySQLComStmtPrepareExecutor.java", "diffHunk": "@@ -17,38 +17,79 @@\n \n package org.apache.shardingsphere.shardingproxy.frontend.mysql.command.query.binary.prepare;\n \n-import org.apache.shardingsphere.sql.parser.sql.statement.SQLStatement;\n import org.apache.shardingsphere.shardingproxy.backend.communication.jdbc.connection.BackendConnection;\n import org.apache.shardingsphere.shardingproxy.backend.schema.LogicSchema;\n import org.apache.shardingsphere.shardingproxy.frontend.api.CommandExecutor;\n import org.apache.shardingsphere.shardingproxy.transport.mysql.constant.MySQLColumnType;\n+import org.apache.shardingsphere.shardingproxy.transport.mysql.constant.MySQLServerErrorCode;\n import org.apache.shardingsphere.shardingproxy.transport.mysql.packet.command.query.MySQLColumnDefinition41Packet;\n import org.apache.shardingsphere.shardingproxy.transport.mysql.packet.command.query.binary.MySQLBinaryStatementRegistry;\n import org.apache.shardingsphere.shardingproxy.transport.mysql.packet.command.query.binary.prepare.MySQLComStmtPrepareOKPacket;\n import org.apache.shardingsphere.shardingproxy.transport.mysql.packet.command.query.binary.prepare.MySQLComStmtPreparePacket;\n import org.apache.shardingsphere.shardingproxy.transport.mysql.packet.generic.MySQLEofPacket;\n+import org.apache.shardingsphere.shardingproxy.transport.mysql.packet.generic.MySQLErrPacket;\n import org.apache.shardingsphere.shardingproxy.transport.packet.DatabasePacket;\n+import org.apache.shardingsphere.sql.parser.sql.statement.SQLStatement;\n import org.apache.shardingsphere.sql.parser.sql.statement.dml.SelectStatement;\n \n+import java.util.Arrays;\n import java.util.Collection;\n+import java.util.HashSet;\n import java.util.LinkedList;\n+import java.util.Set;\n \n /**\n  * COM_STMT_PREPARE command executor for MySQL.\n+ *\n+ * @see <a href=\"https://dev.mysql.com/doc/refman/5.7/en/sql-prepared-statements.html\">SQL Syntax Allowed in Prepared Statements</a>\n  */\n public final class MySQLComStmtPrepareExecutor implements CommandExecutor {\n     \n+    private static final Set<String> SQL_SYNTAX_ALLOWED = new HashSet<>();\n+    \n+    private static final int MAX_CHECK_TOKENS = \"FLUSH TABLES WITH READ LOCK\".split(\"\\\\W+\").length;\n+    \n     private static final MySQLBinaryStatementRegistry PREPARED_STATEMENT_REGISTRY = MySQLBinaryStatementRegistry.getInstance();\n     \n     private final MySQLComStmtPreparePacket packet;\n     \n     private final LogicSchema logicSchema;\n     \n+    static {\n+        SQL_SYNTAX_ALLOWED.addAll(Arrays.asList(\"ALTER\" + \"TABLE\", \"ALTER\" + \"USER\", \"ANALYZE\" + \"TABLE\",\n+            \"CACHE\" + \"INDEX\", \"CALL\", \"CHANGE\" + \"MASTER\", \"CHECKSUM\" + \"TABLE\", \"CHECKSUM\" + \"TABLES\",\n+            \"COMMIT\", \"CREATE\" + \"INDEX\", \"DROP\" + \"INDEX\", \"CREATE\" + \"DATABASE\", \"RENAME\" + \"DATABASE\",\n+            \"DROP\" + \"DATABASE\", \"CREATE\" + \"TABLE\", \"DROP\" + \"TABLE\", \"CREATE\" + \"USER\", \"RENAME\" + \"USER\",\n+            \"DROP\" + \"USER\", \"CREATE\" + \"VIEW\", \"DROP\" + \"VIEW\", \"DELETE\", \"DO\", \"FLUSH\" + \"TABLE\",\n+            \"FLUSH\" + \"TABLES\", \"FLUSH\" + \"TABLES\" + \"WITH\" + \"READ\" + \"LOCK\", \"FLUSH\" + \"HOSTS\",\n+            \"FLUSH\" + \"PRIVILEGES\", \"FLUSH\" + \"LOGS\", \"FLUSH\" + \"STATUS\", \"FLUSH\" + \"MASTER\", \"FLUSH\" + \"SLAVE\",\n+            \"FLUSH\" + \"DES_KEY_FILE\", \"FLUSH\" + \"USER\" + \"RESOURCES\", \"GRANT\", \"INSERT\", \"INSTALL\" + \"PLUGIN\",\n+            \"KILL\", \"LOAD\" + \"INDEX\" + \"INTO\" + \"CACHE\", \"OPTIMIZE\" + \"TABLE\", \"RENAME\" + \"TABLE\",\n+            \"REPAIR\" + \"TABLE\", \"REPLACE\", \"RESET\" + \"MASTER\", \"RESET\" + \"SLAVE\", \"RESET\" + \"QUERY CACHE\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7af2e3115fbe38ffdeb0d38035e16f05d92404"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1475d18fe238909fa83d01c1040aeedb8f54d53e", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/1475d18fe238909fa83d01c1040aeedb8f54d53e", "committedDate": "2020-02-28T07:19:37Z", "message": "#4501, revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "463108e791ac8d1e52aab6c91334e62f80b4d616", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/463108e791ac8d1e52aab6c91334e62f80b4d616", "committedDate": "2020-02-28T09:51:22Z", "message": "#4501, add Statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82ebcf3552c81ff79ed010d3a65408f06dd01198", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/82ebcf3552c81ff79ed010d3a65408f06dd01198", "committedDate": "2020-03-01T13:50:59Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-shardingsphere into issue4501"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac2f51f4dfebe93aa7a9adc6e2f824c2a702c65b", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/ac2f51f4dfebe93aa7a9adc6e2f824c2a702c65b", "committedDate": "2020-03-03T05:21:59Z", "message": "#4501, add Statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ae037dd57f5165b1d5e72e091d7eb74af09064e", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/8ae037dd57f5165b1d5e72e091d7eb74af09064e", "committedDate": "2020-03-03T07:02:58Z", "message": "#4501, add Statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5044f5d7bcfe5292b8669a1025d68f6a5e3e5ebf", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/5044f5d7bcfe5292b8669a1025d68f6a5e3e5ebf", "committedDate": "2020-03-03T08:30:35Z", "message": "#4501, add Statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "456b1861c81bb801f460876c57258adf17f89590", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/456b1861c81bb801f460876c57258adf17f89590", "committedDate": "2020-03-03T08:34:34Z", "message": "#4501, add Statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fb3a3f1196c0e0fb943f100d7501b050a4d8422", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/0fb3a3f1196c0e0fb943f100d7501b050a4d8422", "committedDate": "2020-03-03T08:36:04Z", "message": "Merge branch 'master' of https://github.com/apache/incubator-shardingsphere into issue4501"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b893524b037f60f07b42ca87a340f830f4050c4", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/1b893524b037f60f07b42ca87a340f830f4050c4", "committedDate": "2020-03-03T09:38:56Z", "message": "#4501, add Statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9eff8ebb2235d20fcb62417eca3688bd859c51b1", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/9eff8ebb2235d20fcb62417eca3688bd859c51b1", "committedDate": "2020-03-03T09:57:58Z", "message": "#4501, add Statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "555794b6e12b543d5a3ccd98c4d173c0307a857b", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/555794b6e12b543d5a3ccd98c4d173c0307a857b", "committedDate": "2020-03-03T10:08:02Z", "message": "#4501, add MySQLComStmtPrepareChecker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "602b521e712235a6a6d63c0d0fa401d73a32935b", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/602b521e712235a6a6d63c0d0fa401d73a32935b", "committedDate": "2020-03-03T10:30:15Z", "message": "#4501, for checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcd9ef884a802ef0bcd2460e01d6bac6158c0478", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/bcd9ef884a802ef0bcd2460e01d6bac6158c0478", "committedDate": "2020-03-03T10:30:49Z", "message": "#4501, for checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da69dac501abfaff1d665f114121b2cee3984b3d", "author": {"user": {"login": "tuohai666", "name": "Zhang Yonglun"}}, "url": "https://github.com/apache/shardingsphere/commit/da69dac501abfaff1d665f114121b2cee3984b3d", "committedDate": "2020-03-03T10:40:25Z", "message": "#4501, refine"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3OTA5MzIw", "url": "https://github.com/apache/shardingsphere/pull/4502#pullrequestreview-367909320", "createdAt": "2020-03-03T11:42:20Z", "commit": {"oid": "da69dac501abfaff1d665f114121b2cee3984b3d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3867, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}