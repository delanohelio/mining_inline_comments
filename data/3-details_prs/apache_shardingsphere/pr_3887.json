{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5ODE4OTA3", "number": 3887, "title": "Feature 3185 add nacos center", "bodyText": "Fixes #3185.\nChanges proposed in this pull request:\n\nadd nacos center for new orchestration.", "createdAt": "2020-01-07T04:33:43Z", "url": "https://github.com/apache/shardingsphere/pull/3887", "merged": true, "mergeCommit": {"oid": "e57a730b302d0e52e6f56ccc9d55257d616727ea"}, "closed": true, "closedAt": "2020-01-08T06:38:37Z", "author": {"login": "sunbufu"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb34P3xgH2gAyMzU5ODE4OTA3OjUxOWFjOWNhOTdkZmI4ZDExMDg5ZWU4YjliNzc2N2UzNzRlM2MxYmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4PgPogFqTMzOTY2ODg4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "519ac9ca97dfb8d11089ee8b9b7767e374e3c1bf", "author": {"user": {"login": "sunbufu", "name": "\u5b59\u4e0d\u670d"}}, "url": "https://github.com/apache/shardingsphere/commit/519ac9ca97dfb8d11089ee8b9b7767e374e3c1bf", "committedDate": "2020-01-07T03:32:47Z", "message": "add sharding-orchestration-center-nacos module for new orchestration."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74614f4ee9b77faf49d894ce2a26d95100d61d42", "author": {"user": {"login": "sunbufu", "name": "\u5b59\u4e0d\u670d"}}, "url": "https://github.com/apache/shardingsphere/commit/74614f4ee9b77faf49d894ce2a26d95100d61d42", "committedDate": "2020-01-07T03:48:12Z", "message": "add sharding-orchestration-center-nacos module in sharding-orchestration-center pom."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTgxNDU4", "url": "https://github.com/apache/shardingsphere/pull/3887#pullrequestreview-339181458", "createdAt": "2020-01-07T11:30:42Z", "commit": {"oid": "74614f4ee9b77faf49d894ce2a26d95100d61d42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMTozMDo0M1rOFa25iA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMTozMDo0M1rOFa25iA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwNjc2MA==", "bodyText": "If return \"null\", whether there will be problems.", "url": "https://github.com/apache/shardingsphere/pull/3887#discussion_r363706760", "createdAt": "2020-01-07T11:30:43Z", "author": {"login": "wgy8283335"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-nacos/src/main/java/org/apache/shardingsphere/orchestration/center/instance/NacosInstance.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.orchestration.center.instance;\n+\n+import com.alibaba.nacos.api.NacosFactory;\n+import com.alibaba.nacos.api.config.ConfigService;\n+import com.alibaba.nacos.api.config.listener.Listener;\n+import com.alibaba.nacos.api.exception.NacosException;\n+import java.util.List;\n+import java.util.Properties;\n+import java.util.concurrent.Executor;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.shardingsphere.orchestration.center.api.ConfigCenter;\n+import org.apache.shardingsphere.orchestration.center.configuration.InstanceConfiguration;\n+import org.apache.shardingsphere.orchestration.center.listener.DataChangedEvent;\n+import org.apache.shardingsphere.orchestration.center.listener.DataChangedEventListener;\n+\n+/**\n+ * The nacos instance for ConfigCenter.\n+ *\n+ * @author huangjian\n+ * @author sunbufu\n+ */\n+@Slf4j\n+public class NacosInstance implements ConfigCenter {\n+    \n+    private final String defaultGroup = \"SHARDING_SPHERE_DEFAULT_GROUP\";\n+    \n+    private ConfigService configService;\n+    \n+    @Getter\n+    @Setter\n+    private Properties properties = new Properties();\n+    \n+    /**\n+     * Initialize nacos instance.\n+     *\n+     * @param config config center configuration\n+     */\n+    @Override\n+    public void init(final InstanceConfiguration config) {\n+        try {\n+            Properties properties = new Properties();\n+            properties.put(\"serverAddr\", config.getServerLists());\n+            properties.put(\"namespace\", null == config.getNamespace() ? \"\" : config.getNamespace());\n+            configService = NacosFactory.createConfigService(properties);\n+        } catch (final NacosException ex) {\n+            log.debug(\"exception for: {}\", ex.toString());\n+        }\n+    }\n+    \n+    /**\n+     * Get data from nacos instance.\n+     *\n+     * @param key key of data\n+     * @return value of data\n+     */\n+    @Override\n+    public String get(final String key) {\n+        return getDirectly(key);\n+    }\n+    \n+    private String getDirectly(final String key) {\n+        try {\n+            String dataId = key.replace(\"/\", \".\");\n+            String group = properties.getProperty(\"group\", defaultGroup);\n+            long timeoutMs = Long.parseLong(properties.getProperty(\"timeout\", \"3000\"));\n+            return configService.getConfig(dataId, group, timeoutMs);\n+        } catch (final NacosException ex) {\n+            log.debug(\"exception for: {}\", ex.toString());\n+            return null;\n+        }\n+    }\n+    \n+    /**\n+     * Get node's sub-nodes list.\n+     *\n+     * @param key key of data\n+     * @return sub-nodes name list\n+     */\n+    @Override\n+    public List<String> getChildrenKeys(final String key) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74614f4ee9b77faf49d894ce2a26d95100d61d42"}, "originalPosition": 99}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTgxOTQw", "url": "https://github.com/apache/shardingsphere/pull/3887#pullrequestreview-339181940", "createdAt": "2020-01-07T11:31:52Z", "commit": {"oid": "74614f4ee9b77faf49d894ce2a26d95100d61d42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMTozMTo1M1rOFa27Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMTozMTo1M1rOFa27Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcwNzE3MA==", "bodyText": "Where is follow items:\norg.apache.shardingsphere.orchestration.center.instance.CuratorZookeeperInstance\norg.apache.shardingsphere.orchestration.center.instance.ApolloInstance", "url": "https://github.com/apache/shardingsphere/pull/3887#discussion_r363707170", "createdAt": "2020-01-07T11:31:53Z", "author": {"login": "wgy8283335"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-nacos/src/main/resources/META-INF/services/org.apache.shardingsphere.orchestration.center.api.ConfigCenter", "diffHunk": "@@ -0,0 +1,18 @@\n+#\n+# Licensed to the Apache Software Foundation (ASF) under one or more\n+# contributor license agreements.  See the NOTICE file distributed with\n+# this work for additional information regarding copyright ownership.\n+# The ASF licenses this file to You under the Apache License, Version 2.0\n+# (the \"License\"); you may not use this file except in compliance with\n+# the License.  You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+\n+org.apache.shardingsphere.orchestration.center.instance.NacosInstance", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74614f4ee9b77faf49d894ce2a26d95100d61d42"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTg3NTI0", "url": "https://github.com/apache/shardingsphere/pull/3887#pullrequestreview-339187524", "createdAt": "2020-01-07T11:45:19Z", "commit": {"oid": "74614f4ee9b77faf49d894ce2a26d95100d61d42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMTo0NToyMFrOFa3MmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMTo0NToyMFrOFa3MmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcxMTY0MQ==", "bodyText": "\u201cx.x.x.\u201d or \"192.168.1.2\"?", "url": "https://github.com/apache/shardingsphere/pull/3887#discussion_r363711641", "createdAt": "2020-01-07T11:45:20Z", "author": {"login": "wgy8283335"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-nacos/src/test/java/org/apache/shardingsphere/orchestration/center/instance/NacosInstanceTest.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.orchestration.center.instance;\n+\n+import com.alibaba.nacos.api.config.ConfigService;\n+import com.alibaba.nacos.api.config.listener.Listener;\n+import java.lang.reflect.Field;\n+import java.util.Properties;\n+import lombok.SneakyThrows;\n+import org.apache.shardingsphere.orchestration.center.api.ConfigCenter;\n+import org.apache.shardingsphere.orchestration.center.configuration.InstanceConfiguration;\n+import org.apache.shardingsphere.orchestration.center.listener.DataChangedEvent;\n+import org.apache.shardingsphere.orchestration.center.listener.DataChangedEventListener;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.invocation.InvocationOnMock;\n+import org.mockito.stubbing.Answer;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyLong;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+public class NacosInstanceTest {\n+    \n+    private static ConfigCenter nacosConfigCenter = new NacosInstance();\n+    \n+    private ConfigService configService = mock(ConfigService.class);\n+    \n+    private String group = \"SHARDING_SPHERE_DEFAULT_GROUP\";\n+    \n+    @Before\n+    public void init() {\n+        Properties properties = new Properties();\n+        properties.setProperty(\"group\", group);\n+        properties.setProperty(\"timeout\", \"3000\");\n+        InstanceConfiguration configuration = new InstanceConfiguration(nacosConfigCenter.getType(), properties);\n+        configuration.setServerLists(\"x.x.x.:8848\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74614f4ee9b77faf49d894ce2a26d95100d61d42"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTg3ODY0", "url": "https://github.com/apache/shardingsphere/pull/3887#pullrequestreview-339187864", "createdAt": "2020-01-07T11:46:09Z", "commit": {"oid": "74614f4ee9b77faf49d894ce2a26d95100d61d42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMTo0NjowOVrOFa3Ntw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxMTo0NjowOVrOFa3Ntw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzcxMTkyNw==", "bodyText": "Why null?", "url": "https://github.com/apache/shardingsphere/pull/3887#discussion_r363711927", "createdAt": "2020-01-07T11:46:09Z", "author": {"login": "wgy8283335"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-nacos/src/test/java/org/apache/shardingsphere/orchestration/center/instance/NacosInstanceTest.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.orchestration.center.instance;\n+\n+import com.alibaba.nacos.api.config.ConfigService;\n+import com.alibaba.nacos.api.config.listener.Listener;\n+import java.lang.reflect.Field;\n+import java.util.Properties;\n+import lombok.SneakyThrows;\n+import org.apache.shardingsphere.orchestration.center.api.ConfigCenter;\n+import org.apache.shardingsphere.orchestration.center.configuration.InstanceConfiguration;\n+import org.apache.shardingsphere.orchestration.center.listener.DataChangedEvent;\n+import org.apache.shardingsphere.orchestration.center.listener.DataChangedEventListener;\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.invocation.InvocationOnMock;\n+import org.mockito.stubbing.Answer;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyLong;\n+import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.eq;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+public class NacosInstanceTest {\n+    \n+    private static ConfigCenter nacosConfigCenter = new NacosInstance();\n+    \n+    private ConfigService configService = mock(ConfigService.class);\n+    \n+    private String group = \"SHARDING_SPHERE_DEFAULT_GROUP\";\n+    \n+    @Before\n+    public void init() {\n+        Properties properties = new Properties();\n+        properties.setProperty(\"group\", group);\n+        properties.setProperty(\"timeout\", \"3000\");\n+        InstanceConfiguration configuration = new InstanceConfiguration(nacosConfigCenter.getType(), properties);\n+        configuration.setServerLists(\"x.x.x.:8848\");\n+        nacosConfigCenter.init(configuration);\n+        setConfigService(configService);\n+    }\n+    \n+    @SneakyThrows\n+    private void setConfigService(final ConfigService configService) {\n+        Field configServiceField = NacosInstance.class.getDeclaredField(\"configService\");\n+        configServiceField.setAccessible(true);\n+        configServiceField.set(nacosConfigCenter, configService);\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertPersist() {\n+        String value = \"value\";\n+        nacosConfigCenter.persist(\"sharding/test\", value);\n+        verify(configService).publishConfig(\"sharding.test\", group, value);\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertGet() {\n+        String value = \"value\";\n+        when(configService.getConfig(eq(\"sharding.test\"), eq(group), anyLong())).thenReturn(value);\n+        Assert.assertEquals(value, nacosConfigCenter.get(\"sharding/test\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertWatch() {\n+        final String expectValue = \"expectValue\";\n+        final String[] actualValue = {null};\n+        doAnswer(getListenerAnswer(expectValue)).when(configService).addListener(anyString(), anyString(), any(Listener.class));\n+        DataChangedEventListener listener = new DataChangedEventListener() {\n+            @Override\n+            public void onChange(final DataChangedEvent dataChangedEvent) {\n+                actualValue[0] = dataChangedEvent.getValue();\n+            }\n+        };\n+        nacosConfigCenter.watch(\"sharding/test\", listener);\n+        Assert.assertEquals(expectValue, actualValue[0]);\n+    }\n+    \n+    private Answer getListenerAnswer(final String expectValue) {\n+        return new Answer() {\n+            @Override\n+            public Object answer(final InvocationOnMock invocation) {\n+                Listener listener = invocation.getArgument(2);\n+                listener.receiveConfigInfo(expectValue);\n+                return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74614f4ee9b77faf49d894ce2a26d95100d61d42"}, "originalPosition": 108}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTg4MTgy", "url": "https://github.com/apache/shardingsphere/pull/3887#pullrequestreview-339188182", "createdAt": "2020-01-07T11:46:56Z", "commit": {"oid": "74614f4ee9b77faf49d894ce2a26d95100d61d42"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b33bc4cef2d6bcf667791588cff934acf4d6dae", "author": {"user": {"login": "sunbufu", "name": "\u5b59\u4e0d\u670d"}}, "url": "https://github.com/apache/shardingsphere/commit/2b33bc4cef2d6bcf667791588cff934acf4d6dae", "committedDate": "2020-01-08T05:13:31Z", "message": "modify NacosInstanceTest."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NjY1ODIy", "url": "https://github.com/apache/shardingsphere/pull/3887#pullrequestreview-339665822", "createdAt": "2020-01-08T06:26:44Z", "commit": {"oid": "2b33bc4cef2d6bcf667791588cff934acf4d6dae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NjY4ODg4", "url": "https://github.com/apache/shardingsphere/pull/3887#pullrequestreview-339668888", "createdAt": "2020-01-08T06:38:29Z", "commit": {"oid": "2b33bc4cef2d6bcf667791588cff934acf4d6dae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4224, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}