{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MTUxMzU3", "number": 4964, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjowMjo1NVrODrt0SA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjowNDo1OVrODrt4WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MTY2MDI0OnYy", "diffSide": "RIGHT", "path": "encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dal/impl/EncryptColumnsMergedResult.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjowMjo1NVrOF8ONTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMjoyMDozNlrOF8uwaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5MTY2MQ==", "bodyText": "Please do not use Map.Entry, just use Entry", "url": "https://github.com/apache/shardingsphere/pull/4964#discussion_r398691661", "createdAt": "2020-03-26T16:02:55Z", "author": {"login": "terrymanu"}, "path": "encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dal/impl/EncryptColumnsMergedResult.java", "diffHunk": "@@ -66,19 +70,50 @@ public final boolean next() throws SQLException {\n         return true;\n     }\n     \n+    private Collection<String> getAssistedQueryColumns() {\n+        return getTableEncryptColumnMetaDatas().stream().map(EncryptColumnMetaData::getAssistedQueryColumnName)\n+                .collect(Collectors.toList());\n+    }\n+    \n+    private Collection<String> getPlainColumns() {\n+        return getTableEncryptColumnMetaDatas().stream().map(EncryptColumnMetaData::getPlainColumnName)\n+                .collect(Collectors.toList());\n+    }\n+    \n+    private Collection<EncryptColumnMetaData> getTableEncryptColumnMetaDatas() {\n+        Collection<EncryptColumnMetaData> result = new LinkedList<>();\n+        for (Map.Entry<String, ColumnMetaData> entry : schemaMetaData.get(tableName).getColumns().entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76561b6a4d5412027e0eac39d1e19683f7f1657c"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyNDkzNg==", "bodyText": "OK, I fix it. Thanks.", "url": "https://github.com/apache/shardingsphere/pull/4964#discussion_r399224936", "createdAt": "2020-03-27T12:20:36Z", "author": {"login": "dongzl"}, "path": "encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dal/impl/EncryptColumnsMergedResult.java", "diffHunk": "@@ -66,19 +70,50 @@ public final boolean next() throws SQLException {\n         return true;\n     }\n     \n+    private Collection<String> getAssistedQueryColumns() {\n+        return getTableEncryptColumnMetaDatas().stream().map(EncryptColumnMetaData::getAssistedQueryColumnName)\n+                .collect(Collectors.toList());\n+    }\n+    \n+    private Collection<String> getPlainColumns() {\n+        return getTableEncryptColumnMetaDatas().stream().map(EncryptColumnMetaData::getPlainColumnName)\n+                .collect(Collectors.toList());\n+    }\n+    \n+    private Collection<EncryptColumnMetaData> getTableEncryptColumnMetaDatas() {\n+        Collection<EncryptColumnMetaData> result = new LinkedList<>();\n+        for (Map.Entry<String, ColumnMetaData> entry : schemaMetaData.get(tableName).getColumns().entrySet()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5MTY2MQ=="}, "originalCommit": {"oid": "76561b6a4d5412027e0eac39d1e19683f7f1657c"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MTY2NTE3OnYy", "diffSide": "RIGHT", "path": "encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dal/impl/EncryptColumnsMergedResult.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjowMzo1MFrOF8OQSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMjoyMDo0OFrOF8uwww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5MjQyNw==", "bodyText": "It is better to change to:\nif (entry.getValue() instanceof EncryptColumnMetaData) {\n    result.add((EncryptColumnMetaData) entry.getValue());\n}", "url": "https://github.com/apache/shardingsphere/pull/4964#discussion_r398692427", "createdAt": "2020-03-26T16:03:50Z", "author": {"login": "terrymanu"}, "path": "encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dal/impl/EncryptColumnsMergedResult.java", "diffHunk": "@@ -66,19 +70,50 @@ public final boolean next() throws SQLException {\n         return true;\n     }\n     \n+    private Collection<String> getAssistedQueryColumns() {\n+        return getTableEncryptColumnMetaDatas().stream().map(EncryptColumnMetaData::getAssistedQueryColumnName)\n+                .collect(Collectors.toList());\n+    }\n+    \n+    private Collection<String> getPlainColumns() {\n+        return getTableEncryptColumnMetaDatas().stream().map(EncryptColumnMetaData::getPlainColumnName)\n+                .collect(Collectors.toList());\n+    }\n+    \n+    private Collection<EncryptColumnMetaData> getTableEncryptColumnMetaDatas() {\n+        Collection<EncryptColumnMetaData> result = new LinkedList<>();\n+        for (Map.Entry<String, ColumnMetaData> entry : schemaMetaData.get(tableName).getColumns().entrySet()) {\n+            if (!(entry.getValue() instanceof EncryptColumnMetaData)) {\n+                continue;\n+            }\n+            result.add((EncryptColumnMetaData) entry.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76561b6a4d5412027e0eac39d1e19683f7f1657c"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIyNTAyNw==", "bodyText": "OK, I fix it. Thanks.", "url": "https://github.com/apache/shardingsphere/pull/4964#discussion_r399225027", "createdAt": "2020-03-27T12:20:48Z", "author": {"login": "dongzl"}, "path": "encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dal/impl/EncryptColumnsMergedResult.java", "diffHunk": "@@ -66,19 +70,50 @@ public final boolean next() throws SQLException {\n         return true;\n     }\n     \n+    private Collection<String> getAssistedQueryColumns() {\n+        return getTableEncryptColumnMetaDatas().stream().map(EncryptColumnMetaData::getAssistedQueryColumnName)\n+                .collect(Collectors.toList());\n+    }\n+    \n+    private Collection<String> getPlainColumns() {\n+        return getTableEncryptColumnMetaDatas().stream().map(EncryptColumnMetaData::getPlainColumnName)\n+                .collect(Collectors.toList());\n+    }\n+    \n+    private Collection<EncryptColumnMetaData> getTableEncryptColumnMetaDatas() {\n+        Collection<EncryptColumnMetaData> result = new LinkedList<>();\n+        for (Map.Entry<String, ColumnMetaData> entry : schemaMetaData.get(tableName).getColumns().entrySet()) {\n+            if (!(entry.getValue() instanceof EncryptColumnMetaData)) {\n+                continue;\n+            }\n+            result.add((EncryptColumnMetaData) entry.getValue());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5MjQyNw=="}, "originalCommit": {"oid": "76561b6a4d5412027e0eac39d1e19683f7f1657c"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ3MTY3MDY0OnYy", "diffSide": "RIGHT", "path": "encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dal/impl/EncryptColumnsMergedResult.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjowNDo1OVrOF8OTtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxNjowNDo1OVrOF8OTtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODY5MzMwMQ==", "bodyText": "Please do not use Map.Entry, just use Entry", "url": "https://github.com/apache/shardingsphere/pull/4964#discussion_r398693301", "createdAt": "2020-03-26T16:04:59Z", "author": {"login": "terrymanu"}, "path": "encrypt-core/encrypt-core-merge/src/main/java/org/apache/shardingsphere/encrypt/merge/dal/impl/EncryptColumnsMergedResult.java", "diffHunk": "@@ -66,19 +70,50 @@ public final boolean next() throws SQLException {\n         return true;\n     }\n     \n+    private Collection<String> getAssistedQueryColumns() {\n+        return getTableEncryptColumnMetaDatas().stream().map(EncryptColumnMetaData::getAssistedQueryColumnName)\n+                .collect(Collectors.toList());\n+    }\n+    \n+    private Collection<String> getPlainColumns() {\n+        return getTableEncryptColumnMetaDatas().stream().map(EncryptColumnMetaData::getPlainColumnName)\n+                .collect(Collectors.toList());\n+    }\n+    \n+    private Collection<EncryptColumnMetaData> getTableEncryptColumnMetaDatas() {\n+        Collection<EncryptColumnMetaData> result = new LinkedList<>();\n+        for (Map.Entry<String, ColumnMetaData> entry : schemaMetaData.get(tableName).getColumns().entrySet()) {\n+            if (!(entry.getValue() instanceof EncryptColumnMetaData)) {\n+                continue;\n+            }\n+            result.add((EncryptColumnMetaData) entry.getValue());\n+        }\n+        return result;\n+    }\n+    \n     @Override\n     public final Object getValue(final int columnIndex, final Class<?> type) throws SQLException {\n         if (1 == columnIndex) {\n             String columnName = getOriginalValue(columnIndex, type).toString();\n-            Optional<EncryptTable> encryptTable = encryptRule.findEncryptTable(tableName);\n-            if (encryptTable.isPresent() && encryptTable.get().getCipherColumns().contains(columnName)) {\n-                return encryptTable.get().getLogicColumnOfCipher(columnName);\n-            }\n-            return columnName;\n+            Optional<String> logicColumn = getLogicColumnOfCipher(columnName);\n+            return logicColumn.isPresent() ? logicColumn.get() : columnName;\n         }\n         return getOriginalValue(columnIndex, type);\n     }\n     \n+    private Optional<String> getLogicColumnOfCipher(final String cipherColumn) {\n+        for (Map.Entry<String, ColumnMetaData> entry : schemaMetaData.get(tableName).getColumns().entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76561b6a4d5412027e0eac39d1e19683f7f1657c"}, "originalPosition": 101}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1102, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}