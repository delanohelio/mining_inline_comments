{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3NzYzMDE1", "number": 7476, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTowMToyOVrOEj9ZuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNTo1NzozN1rOElBvjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MTQxNjI0OnYy", "diffSide": "RIGHT", "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/generator/impl/ProjectionsTokenGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTowMToyOVrOHSnQ7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTo0MzoyN1rOHSo56g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI3OTcyNw==", "bodyText": "The code's cyclomatic complexity is pretty high, it is better to extract serval private method for nested loop and if statement", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489279727", "createdAt": "2020-09-16T09:01:29Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/generator/impl/ProjectionsTokenGenerator.java", "diffHunk": "@@ -44,17 +60,26 @@ public boolean isGenerateSQLToken(final SQLStatementContext sqlStatementContext)\n     \n     @Override\n     public ProjectionsToken generateSQLToken(final SelectStatementContext selectStatementContext) {\n-        Collection<String> derivedProjectionTexts = getDerivedProjectionTexts(selectStatementContext);\n+        Map<RouteUnit, Collection<String>> derivedProjectionTexts = getDerivedProjectionTexts(selectStatementContext);\n         return new ProjectionsToken(selectStatementContext.getProjectionsContext().getStopIndex() + 1 + \" \".length(), derivedProjectionTexts);\n     }\n     \n-    private Collection<String> getDerivedProjectionTexts(final SelectStatementContext selectStatementContext) {\n-        Collection<String> result = new LinkedList<>();\n-        for (Projection each : selectStatementContext.getProjectionsContext().getProjections()) {\n-            if (each instanceof AggregationProjection && !((AggregationProjection) each).getDerivedAggregationProjections().isEmpty()) {\n-                result.addAll(((AggregationProjection) each).getDerivedAggregationProjections().stream().map(this::getDerivedProjectionText).collect(Collectors.toList()));\n-            } else if (each instanceof DerivedProjection) {\n-                result.add(getDerivedProjectionText(each));\n+    private Map<RouteUnit, Collection<String>> getDerivedProjectionTexts(final SelectStatementContext selectStatementContext) {\n+        Map<RouteUnit, Collection<String>> result = new HashMap<>();\n+        for (RouteUnit routeUnit : routeContext.getRouteResult().getRouteUnits()) {\n+            result.put(routeUnit, new LinkedList<>());\n+            for (Projection each : selectStatementContext.getProjectionsContext().getProjections()) {\n+                if (each instanceof AggregationProjection && !((AggregationProjection) each).getDerivedAggregationProjections().isEmpty()) {\n+                    result.get(routeUnit).addAll(((AggregationProjection) each).getDerivedAggregationProjections().stream().map(this::getDerivedProjectionText).collect(Collectors.toList()));\n+                } else if (each instanceof DerivedProjection) {\n+                    if (!(((DerivedProjection) each).getRealProjection() instanceof ColumnOrderByItemSegment)) {\n+                        result.get(routeUnit).add(getDerivedProjectionText(each));\n+                        continue;\n+                    }\n+                    TableExtractUtils utils = new TableExtractUtils();\n+                    utils.extractTablesFromSelect(selectStatementContext.getSqlStatement());\n+                    result.get(routeUnit).add(getDerivedProjectionTextFromColumnOrderByItemSegment((DerivedProjection) each, utils, routeUnit));\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwNjYwMg==", "bodyText": "Ok", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489306602", "createdAt": "2020-09-16T09:43:27Z", "author": {"login": "jingshanglu"}, "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/generator/impl/ProjectionsTokenGenerator.java", "diffHunk": "@@ -44,17 +60,26 @@ public boolean isGenerateSQLToken(final SQLStatementContext sqlStatementContext)\n     \n     @Override\n     public ProjectionsToken generateSQLToken(final SelectStatementContext selectStatementContext) {\n-        Collection<String> derivedProjectionTexts = getDerivedProjectionTexts(selectStatementContext);\n+        Map<RouteUnit, Collection<String>> derivedProjectionTexts = getDerivedProjectionTexts(selectStatementContext);\n         return new ProjectionsToken(selectStatementContext.getProjectionsContext().getStopIndex() + 1 + \" \".length(), derivedProjectionTexts);\n     }\n     \n-    private Collection<String> getDerivedProjectionTexts(final SelectStatementContext selectStatementContext) {\n-        Collection<String> result = new LinkedList<>();\n-        for (Projection each : selectStatementContext.getProjectionsContext().getProjections()) {\n-            if (each instanceof AggregationProjection && !((AggregationProjection) each).getDerivedAggregationProjections().isEmpty()) {\n-                result.addAll(((AggregationProjection) each).getDerivedAggregationProjections().stream().map(this::getDerivedProjectionText).collect(Collectors.toList()));\n-            } else if (each instanceof DerivedProjection) {\n-                result.add(getDerivedProjectionText(each));\n+    private Map<RouteUnit, Collection<String>> getDerivedProjectionTexts(final SelectStatementContext selectStatementContext) {\n+        Map<RouteUnit, Collection<String>> result = new HashMap<>();\n+        for (RouteUnit routeUnit : routeContext.getRouteResult().getRouteUnits()) {\n+            result.put(routeUnit, new LinkedList<>());\n+            for (Projection each : selectStatementContext.getProjectionsContext().getProjections()) {\n+                if (each instanceof AggregationProjection && !((AggregationProjection) each).getDerivedAggregationProjections().isEmpty()) {\n+                    result.get(routeUnit).addAll(((AggregationProjection) each).getDerivedAggregationProjections().stream().map(this::getDerivedProjectionText).collect(Collectors.toList()));\n+                } else if (each instanceof DerivedProjection) {\n+                    if (!(((DerivedProjection) each).getRealProjection() instanceof ColumnOrderByItemSegment)) {\n+                        result.get(routeUnit).add(getDerivedProjectionText(each));\n+                        continue;\n+                    }\n+                    TableExtractUtils utils = new TableExtractUtils();\n+                    utils.extractTablesFromSelect(selectStatementContext.getSqlStatement());\n+                    result.get(routeUnit).add(getDerivedProjectionTextFromColumnOrderByItemSegment((DerivedProjection) each, utils, routeUnit));\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI3OTcyNw=="}, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MTQxOTc5OnYy", "diffSide": "RIGHT", "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/generator/impl/ProjectionsTokenGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTowMjoxM1rOHSnS_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTowMjoxM1rOHSnS_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MDI1NQ==", "bodyText": "The return value should be newColumnOrderByItem", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489280255", "createdAt": "2020-09-16T09:02:13Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/generator/impl/ProjectionsTokenGenerator.java", "diffHunk": "@@ -67,4 +92,40 @@ private String getDerivedProjectionText(final Projection projection) {\n         }\n         return projection.getExpression() + \" AS \" + projection.getAlias().get() + \" \";\n     }\n+    \n+    private String getDerivedProjectionTextFromColumnOrderByItemSegment(final DerivedProjection projection, final TableExtractUtils utils, final RouteUnit routeUnit) {\n+        Preconditions.checkState(projection.getAlias().isPresent());\n+        Preconditions.checkState(projection.getRealProjection() instanceof ColumnOrderByItemSegment);\n+        ColumnOrderByItemSegment columnOrderByItemSegment = (ColumnOrderByItemSegment) projection.getRealProjection();\n+        ColumnOrderByItemSegment newColumnOrderByItem = generateNewColumnOrderByItem(columnOrderByItemSegment, routeUnit, utils);\n+        return newColumnOrderByItem.getText() + \" AS \" + projection.getAlias().get() + \" \";\n+    }\n+    \n+    private Optional<String> getActualTables(final RouteUnit routeUnit, final String logicalTableName) {\n+        for (RouteMapper each : routeUnit.getTableMappers()) {\n+            if (each.getLogicName().equalsIgnoreCase(logicalTableName)) {\n+                return Optional.of(each.getActualName());\n+            }\n+        }\n+        return Optional.empty();\n+    }\n+\n+    private ColumnOrderByItemSegment generateNewColumnOrderByItem(final ColumnOrderByItemSegment old, final RouteUnit routeUnit, final TableExtractUtils utils) {\n+        Optional<OwnerSegment> ownerSegment = old.getColumn().getOwner();\n+        if (!ownerSegment.isPresent()) {\n+            return old;\n+        }\n+        if (!utils.needRewrite(ownerSegment.get())) {\n+            return old;\n+        }\n+        Optional<String> actualTableName = getActualTables(routeUnit, ownerSegment.get().getIdentifier().getValue());\n+        Preconditions.checkState(actualTableName.isPresent());\n+        ColumnSegment newColumnSegment = new ColumnSegment(0, 0, old.getColumn().getIdentifier());\n+        IdentifierValue newOwnerIdentifier = new IdentifierValue(ownerSegment.get().getIdentifier().getQuoteCharacter().getStartDelimiter()\n+                + actualTableName.get() + ownerSegment.get().getIdentifier().getQuoteCharacter().getEndDelimiter());\n+        OwnerSegment newOwner = new OwnerSegment(0, 0, newOwnerIdentifier);\n+        newColumnSegment.setOwner(newOwner);\n+        ColumnOrderByItemSegment newColumnOrderByItem = new ColumnOrderByItemSegment(newColumnSegment, old.getOrderDirection());\n+        return newColumnOrderByItem;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MTQyMzUyOnYy", "diffSide": "RIGHT", "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/generator/impl/ProjectionsTokenGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTowMzowOVrOHSnVSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTo0MTowMlrOHSoz-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MDg0Mw==", "bodyText": "String with + is not good practice, it is better to replace to String.format or StringBuilder", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489280843", "createdAt": "2020-09-16T09:03:09Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/generator/impl/ProjectionsTokenGenerator.java", "diffHunk": "@@ -67,4 +92,40 @@ private String getDerivedProjectionText(final Projection projection) {\n         }\n         return projection.getExpression() + \" AS \" + projection.getAlias().get() + \" \";\n     }\n+    \n+    private String getDerivedProjectionTextFromColumnOrderByItemSegment(final DerivedProjection projection, final TableExtractUtils utils, final RouteUnit routeUnit) {\n+        Preconditions.checkState(projection.getAlias().isPresent());\n+        Preconditions.checkState(projection.getRealProjection() instanceof ColumnOrderByItemSegment);\n+        ColumnOrderByItemSegment columnOrderByItemSegment = (ColumnOrderByItemSegment) projection.getRealProjection();\n+        ColumnOrderByItemSegment newColumnOrderByItem = generateNewColumnOrderByItem(columnOrderByItemSegment, routeUnit, utils);\n+        return newColumnOrderByItem.getText() + \" AS \" + projection.getAlias().get() + \" \";\n+    }\n+    \n+    private Optional<String> getActualTables(final RouteUnit routeUnit, final String logicalTableName) {\n+        for (RouteMapper each : routeUnit.getTableMappers()) {\n+            if (each.getLogicName().equalsIgnoreCase(logicalTableName)) {\n+                return Optional.of(each.getActualName());\n+            }\n+        }\n+        return Optional.empty();\n+    }\n+\n+    private ColumnOrderByItemSegment generateNewColumnOrderByItem(final ColumnOrderByItemSegment old, final RouteUnit routeUnit, final TableExtractUtils utils) {\n+        Optional<OwnerSegment> ownerSegment = old.getColumn().getOwner();\n+        if (!ownerSegment.isPresent()) {\n+            return old;\n+        }\n+        if (!utils.needRewrite(ownerSegment.get())) {\n+            return old;\n+        }\n+        Optional<String> actualTableName = getActualTables(routeUnit, ownerSegment.get().getIdentifier().getValue());\n+        Preconditions.checkState(actualTableName.isPresent());\n+        ColumnSegment newColumnSegment = new ColumnSegment(0, 0, old.getColumn().getIdentifier());\n+        IdentifierValue newOwnerIdentifier = new IdentifierValue(ownerSegment.get().getIdentifier().getQuoteCharacter().getStartDelimiter()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwNTA4Mw==", "bodyText": "Ok, i change it to String.format.", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489305083", "createdAt": "2020-09-16T09:41:02Z", "author": {"login": "jingshanglu"}, "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/generator/impl/ProjectionsTokenGenerator.java", "diffHunk": "@@ -67,4 +92,40 @@ private String getDerivedProjectionText(final Projection projection) {\n         }\n         return projection.getExpression() + \" AS \" + projection.getAlias().get() + \" \";\n     }\n+    \n+    private String getDerivedProjectionTextFromColumnOrderByItemSegment(final DerivedProjection projection, final TableExtractUtils utils, final RouteUnit routeUnit) {\n+        Preconditions.checkState(projection.getAlias().isPresent());\n+        Preconditions.checkState(projection.getRealProjection() instanceof ColumnOrderByItemSegment);\n+        ColumnOrderByItemSegment columnOrderByItemSegment = (ColumnOrderByItemSegment) projection.getRealProjection();\n+        ColumnOrderByItemSegment newColumnOrderByItem = generateNewColumnOrderByItem(columnOrderByItemSegment, routeUnit, utils);\n+        return newColumnOrderByItem.getText() + \" AS \" + projection.getAlias().get() + \" \";\n+    }\n+    \n+    private Optional<String> getActualTables(final RouteUnit routeUnit, final String logicalTableName) {\n+        for (RouteMapper each : routeUnit.getTableMappers()) {\n+            if (each.getLogicName().equalsIgnoreCase(logicalTableName)) {\n+                return Optional.of(each.getActualName());\n+            }\n+        }\n+        return Optional.empty();\n+    }\n+\n+    private ColumnOrderByItemSegment generateNewColumnOrderByItem(final ColumnOrderByItemSegment old, final RouteUnit routeUnit, final TableExtractUtils utils) {\n+        Optional<OwnerSegment> ownerSegment = old.getColumn().getOwner();\n+        if (!ownerSegment.isPresent()) {\n+            return old;\n+        }\n+        if (!utils.needRewrite(ownerSegment.get())) {\n+            return old;\n+        }\n+        Optional<String> actualTableName = getActualTables(routeUnit, ownerSegment.get().getIdentifier().getValue());\n+        Preconditions.checkState(actualTableName.isPresent());\n+        ColumnSegment newColumnSegment = new ColumnSegment(0, 0, old.getColumn().getIdentifier());\n+        IdentifierValue newOwnerIdentifier = new IdentifierValue(ownerSegment.get().getIdentifier().getQuoteCharacter().getStartDelimiter()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MDg0Mw=="}, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MTQyNjc4OnYy", "diffSide": "RIGHT", "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/pojo/ProjectionsToken.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTowNDowN1rOHSnXbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwMjo0NzoyNVrOHTNaQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MTM5MA==", "bodyText": "The object Map<RouteUnit, Collection> it too hard to understand, can you consider about to create a new object to describe it?", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489281390", "createdAt": "2020-09-16T09:04:07Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/pojo/ProjectionsToken.java", "diffHunk": "@@ -18,26 +18,29 @@\n package org.apache.shardingsphere.sharding.rewrite.token.pojo;\n \n import org.apache.shardingsphere.infra.rewrite.sql.token.pojo.Attachable;\n+import org.apache.shardingsphere.infra.rewrite.sql.token.pojo.RouteUnitAware;\n import org.apache.shardingsphere.infra.rewrite.sql.token.pojo.SQLToken;\n+import org.apache.shardingsphere.infra.route.context.RouteUnit;\n \n import java.util.Collection;\n+import java.util.Map;\n \n /**\n  * Projections token.\n  */\n-public final class ProjectionsToken extends SQLToken implements Attachable {\n+public final class ProjectionsToken extends SQLToken implements Attachable, RouteUnitAware {\n     \n-    private final Collection<String> projections;\n+    private final Map<RouteUnit, Collection<String>> projections;\n     \n-    public ProjectionsToken(final int startIndex, final Collection<String> projections) {\n+    public ProjectionsToken(final int startIndex, final Map<RouteUnit, Collection<String>> projections) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwMTgyMA==", "bodyText": "The struct just a result for all RouteUnit, different routeUnit correspond to different rewrited projection, if create a new object,it maybe a little heavy.", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489301820", "createdAt": "2020-09-16T09:35:48Z", "author": {"login": "jingshanglu"}, "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/pojo/ProjectionsToken.java", "diffHunk": "@@ -18,26 +18,29 @@\n package org.apache.shardingsphere.sharding.rewrite.token.pojo;\n \n import org.apache.shardingsphere.infra.rewrite.sql.token.pojo.Attachable;\n+import org.apache.shardingsphere.infra.rewrite.sql.token.pojo.RouteUnitAware;\n import org.apache.shardingsphere.infra.rewrite.sql.token.pojo.SQLToken;\n+import org.apache.shardingsphere.infra.route.context.RouteUnit;\n \n import java.util.Collection;\n+import java.util.Map;\n \n /**\n  * Projections token.\n  */\n-public final class ProjectionsToken extends SQLToken implements Attachable {\n+public final class ProjectionsToken extends SQLToken implements Attachable, RouteUnitAware {\n     \n-    private final Collection<String> projections;\n+    private final Map<RouteUnit, Collection<String>> projections;\n     \n-    public ProjectionsToken(final int startIndex, final Collection<String> projections) {\n+    public ProjectionsToken(final int startIndex, final Map<RouteUnit, Collection<String>> projections) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MTM5MA=="}, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQxNzk0NQ==", "bodyText": "t too hard to understand, what is the Collection?\nIt is better to make the code for read easier.", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489417945", "createdAt": "2020-09-16T13:01:12Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/pojo/ProjectionsToken.java", "diffHunk": "@@ -18,26 +18,29 @@\n package org.apache.shardingsphere.sharding.rewrite.token.pojo;\n \n import org.apache.shardingsphere.infra.rewrite.sql.token.pojo.Attachable;\n+import org.apache.shardingsphere.infra.rewrite.sql.token.pojo.RouteUnitAware;\n import org.apache.shardingsphere.infra.rewrite.sql.token.pojo.SQLToken;\n+import org.apache.shardingsphere.infra.route.context.RouteUnit;\n \n import java.util.Collection;\n+import java.util.Map;\n \n /**\n  * Projections token.\n  */\n-public final class ProjectionsToken extends SQLToken implements Attachable {\n+public final class ProjectionsToken extends SQLToken implements Attachable, RouteUnitAware {\n     \n-    private final Collection<String> projections;\n+    private final Map<RouteUnit, Collection<String>> projections;\n     \n-    public ProjectionsToken(final int startIndex, final Collection<String> projections) {\n+    public ProjectionsToken(final int startIndex, final Map<RouteUnit, Collection<String>> projections) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MTM5MA=="}, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTkwNDcwNA==", "bodyText": "The original struct is Collection<String> projections,it's a list of rewrited derived projection string,such as generate from order by, how about add some comments?", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489904704", "createdAt": "2020-09-17T02:47:25Z", "author": {"login": "jingshanglu"}, "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/pojo/ProjectionsToken.java", "diffHunk": "@@ -18,26 +18,29 @@\n package org.apache.shardingsphere.sharding.rewrite.token.pojo;\n \n import org.apache.shardingsphere.infra.rewrite.sql.token.pojo.Attachable;\n+import org.apache.shardingsphere.infra.rewrite.sql.token.pojo.RouteUnitAware;\n import org.apache.shardingsphere.infra.rewrite.sql.token.pojo.SQLToken;\n+import org.apache.shardingsphere.infra.route.context.RouteUnit;\n \n import java.util.Collection;\n+import java.util.Map;\n \n /**\n  * Projections token.\n  */\n-public final class ProjectionsToken extends SQLToken implements Attachable {\n+public final class ProjectionsToken extends SQLToken implements Attachable, RouteUnitAware {\n     \n-    private final Collection<String> projections;\n+    private final Map<RouteUnit, Collection<String>> projections;\n     \n-    public ProjectionsToken(final int startIndex, final Collection<String> projections) {\n+    public ProjectionsToken(final int startIndex, final Map<RouteUnit, Collection<String>> projections) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MTM5MA=="}, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MTQzMzg3OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/segment/select/projection/impl/DerivedProjection.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTowNTo1M1rOHSnbtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTowNTo1M1rOHSnbtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MjQ4Ng==", "bodyText": "what mean of realProjection? For my understanding, derived projection do not have real projection, can you rename it as correct name?", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489282486", "createdAt": "2020-09-16T09:05:53Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/segment/select/projection/impl/DerivedProjection.java", "diffHunk": "@@ -38,6 +39,8 @@\n     \n     private final String alias;\n     \n+    private final SQLSegment realProjection;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MTQzODEyOnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/common/util/TableExtractUtils.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTowNzowM1rOHSnecQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwMToyMDoxNFrOHTKFEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MzE4NQ==", "bodyText": "Util class should be final and static", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489283185", "createdAt": "2020-09-16T09:07:03Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/common/util/TableExtractUtils.java", "diffHunk": "@@ -198,7 +198,12 @@ public void extractTablesFromUpdate(final UpdateStatement updateStatement) {\n         }\n     }\n     \n-    private boolean needRewrite(final OwnerSegment owner) {\n+    /**", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI5NzAwNA==", "bodyText": "This util have state,can not call it directly by classname.", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489297004", "createdAt": "2020-09-16T09:28:14Z", "author": {"login": "jingshanglu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/common/util/TableExtractUtils.java", "diffHunk": "@@ -198,7 +198,12 @@ public void extractTablesFromUpdate(final UpdateStatement updateStatement) {\n         }\n     }\n     \n-    private boolean needRewrite(final OwnerSegment owner) {\n+    /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MzE4NQ=="}, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQxNjc0NQ==", "bodyText": "It is invalid if util class has state, please consider change class name", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489416745", "createdAt": "2020-09-16T12:59:34Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/common/util/TableExtractUtils.java", "diffHunk": "@@ -198,7 +198,12 @@ public void extractTablesFromUpdate(final UpdateStatement updateStatement) {\n         }\n     }\n     \n-    private boolean needRewrite(final OwnerSegment owner) {\n+    /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MzE4NQ=="}, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTg1MDEyOA==", "bodyText": "Ok,I'll change the class name.", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489850128", "createdAt": "2020-09-17T01:20:14Z", "author": {"login": "jingshanglu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/common/util/TableExtractUtils.java", "diffHunk": "@@ -198,7 +198,12 @@ public void extractTablesFromUpdate(final UpdateStatement updateStatement) {\n         }\n     }\n     \n-    private boolean needRewrite(final OwnerSegment owner) {\n+    /**", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MzE4NQ=="}, "originalCommit": {"oid": "3f47333d785beee245e5bf63646ee0693280c796"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MjI4NjE1OnYy", "diffSide": "RIGHT", "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/generator/impl/ProjectionsTokenGenerator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMjo1ODowNFrOHSvkEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMjo1ODowNFrOHSvkEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQxNTY5OA==", "bodyText": "How about to avoid using + with string", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489415698", "createdAt": "2020-09-16T12:58:04Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-features/shardingsphere-sharding/shardingsphere-sharding-rewrite/src/main/java/org/apache/shardingsphere/sharding/rewrite/token/generator/impl/ProjectionsTokenGenerator.java", "diffHunk": "@@ -67,4 +90,41 @@ private String getDerivedProjectionText(final Projection projection) {\n         }\n         return projection.getExpression() + \" AS \" + projection.getAlias().get() + \" \";\n     }\n+    \n+    private String getDerivedProjectionTextFromColumnOrderByItemSegment(final DerivedProjection projection, final TableExtractUtils utils, final RouteUnit routeUnit) {\n+        Preconditions.checkState(projection.getAlias().isPresent());\n+        Preconditions.checkState(projection.getProjection() instanceof ColumnOrderByItemSegment);\n+        ColumnOrderByItemSegment columnOrderByItemSegment = (ColumnOrderByItemSegment) projection.getProjection();\n+        ColumnOrderByItemSegment newColumnOrderByItem = generateNewColumnOrderByItem(columnOrderByItemSegment, routeUnit, utils);\n+        return newColumnOrderByItem.getText() + \" AS \" + projection.getAlias().get() + \" \";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e97226878a90b17a986cc4f6e2a30748fba1aba8"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MjI5NTM1OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/segment/select/projection/impl/DerivedProjection.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMzowMDowNVrOHSvpzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMzowMDowNVrOHSvpzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQxNzE2Nw==", "bodyText": "original projection maybe a better name", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r489417167", "createdAt": "2020-09-16T13:00:05Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/segment/select/projection/impl/DerivedProjection.java", "diffHunk": "@@ -38,6 +39,8 @@\n     \n     private final String alias;\n     \n+    private final SQLSegment projection;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e97226878a90b17a986cc4f6e2a30748fba1aba8"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2ODU2ODkyOnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/statement/dml/UpdateStatementContext.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzowMzo0MlrOHTs4PQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMTowNzowNlrOHT6e-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyMDI4NQ==", "bodyText": "Please rename variable name utils because of there is no any relationship with variable name and class type.", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r490420285", "createdAt": "2020-09-17T17:03:42Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/statement/dml/UpdateStatementContext.java", "diffHunk": "@@ -42,16 +42,16 @@\n     \n     public UpdateStatementContext(final UpdateStatement sqlStatement) {\n         super(sqlStatement);\n-        TableExtractUtils utils = new TableExtractUtils();\n+        TableExtractor utils = new TableExtractor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c462ca50f5ab5a8984ca352516be777e371bcc53"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0MzE5NQ==", "bodyText": "Ok", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r490643195", "createdAt": "2020-09-18T01:07:06Z", "author": {"login": "jingshanglu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/statement/dml/UpdateStatementContext.java", "diffHunk": "@@ -42,16 +42,16 @@\n     \n     public UpdateStatementContext(final UpdateStatement sqlStatement) {\n         super(sqlStatement);\n-        TableExtractUtils utils = new TableExtractUtils();\n+        TableExtractor utils = new TableExtractor();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQyMDI4NQ=="}, "originalCommit": {"oid": "c462ca50f5ab5a8984ca352516be777e371bcc53"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MjYxMzI0OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/common/util/TableExtractor.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNTo1NzozN1rOHUS8VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTo1MzoyMFrOHVIYww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0MzkyNQ==", "bodyText": "Is the class TableExtractor suitable in util package?\nif it is not an util class, please move it to correct package.", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r491043925", "createdAt": "2020-09-18T15:57:37Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/common/util/TableExtractor.java", "diffHunk": "@@ -46,7 +46,7 @@\n import java.util.LinkedList;\n import java.util.Optional;\n \n-public final class TableExtractUtils {\n+public final class TableExtractor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0368b3e2b40a17d22a3025dd86499e5df675da"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY1ODU0NQ==", "bodyText": "I think it is just a util class with status, what package do you think is more appropriate?", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r491658545", "createdAt": "2020-09-20T06:24:20Z", "author": {"login": "jingshanglu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/common/util/TableExtractor.java", "diffHunk": "@@ -46,7 +46,7 @@\n import java.util.LinkedList;\n import java.util.Optional;\n \n-public final class TableExtractUtils {\n+public final class TableExtractor {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0MzkyNQ=="}, "originalCommit": {"oid": "5d0368b3e2b40a17d22a3025dd86499e5df675da"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTg3NzU1MA==", "bodyText": "maybe extractor is a better name", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r491877550", "createdAt": "2020-09-21T08:42:58Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/common/util/TableExtractor.java", "diffHunk": "@@ -46,7 +46,7 @@\n import java.util.LinkedList;\n import java.util.Optional;\n \n-public final class TableExtractUtils {\n+public final class TableExtractor {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0MzkyNQ=="}, "originalCommit": {"oid": "5d0368b3e2b40a17d22a3025dd86499e5df675da"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxOTU1NQ==", "bodyText": "Ok", "url": "https://github.com/apache/shardingsphere/pull/7476#discussion_r491919555", "createdAt": "2020-09-21T09:53:20Z", "author": {"login": "jingshanglu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-statement/src/main/java/org/apache/shardingsphere/sql/parser/sql/common/util/TableExtractor.java", "diffHunk": "@@ -46,7 +46,7 @@\n import java.util.LinkedList;\n import java.util.Optional;\n \n-public final class TableExtractUtils {\n+public final class TableExtractor {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA0MzkyNQ=="}, "originalCommit": {"oid": "5d0368b3e2b40a17d22a3025dd86499e5df675da"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 695, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}