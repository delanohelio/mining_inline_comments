{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMzM5OTI1", "number": 3899, "title": "[Sharding Scaling]Refactor to support PostgreSQL", "bodyText": "For #3699.", "createdAt": "2020-01-08T08:34:23Z", "url": "https://github.com/apache/shardingsphere/pull/3899", "merged": true, "mergeCommit": {"oid": "03f67135a03468e93290d9e4faa43505355c4eb2"}, "closed": true, "closedAt": "2020-01-09T07:11:39Z", "author": {"login": "avalon566"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4BJAlAH2gAyMzYwMzM5OTI1OjhjNDFhNTFmYmY1MzIxOGIyZTIyZWI2MmM0YzExYWYyNmYzMWM2NTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4kk2LgFqTM0MDMyMjc4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8c41a51fbf53218b2e22eb62c4c11af26f31c652", "author": {"user": {"login": "avalon566", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/8c41a51fbf53218b2e22eb62c4c11af26f31c652", "committedDate": "2020-01-07T13:54:26Z", "message": "Refactor AbstractJdbcReader & Fix stream resultset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "072f4f6ee077f78898ea5e6c7a5c4d1ac3302190", "author": {"user": {"login": "avalon566", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/072f4f6ee077f78898ea5e6c7a5c4d1ac3302190", "committedDate": "2020-01-07T13:55:00Z", "message": "Support PostgreSQL identifier quote string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41d83d4189ba4930a2fa5cf4e41a2169f60dbd4a", "author": {"user": {"login": "avalon566", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/41d83d4189ba4930a2fa5cf4e41a2169f60dbd4a", "committedDate": "2020-01-07T13:55:22Z", "message": "Refactor DistributionChannel, avoid deadlock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NzE1OTM4", "url": "https://github.com/apache/shardingsphere/pull/3899#pullrequestreview-339715938", "createdAt": "2020-01-08T08:49:12Z", "commit": {"oid": "41d83d4189ba4930a2fa5cf4e41a2169f60dbd4a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwODo0OToxM1rOFbQBPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQwODo1MTowM1rOFbQETA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExODMzMg==", "bodyText": "Abstract class should not perceive the specific type, it can use abstract method replace, and let subClass to implement.", "url": "https://github.com/apache/shardingsphere/pull/3899#discussion_r364118332", "createdAt": "2020-01-08T08:49:13Z", "author": {"login": "KomachiSion"}, "path": "sharding-scaling/sharding-scaling-core/src/main/java/org/apache/shardingsphere/shardingscaling/core/execute/executor/reader/AbstractJdbcReader.java", "diffHunk": "@@ -48,46 +48,44 @@\n  */\n @Slf4j\n public abstract class AbstractJdbcReader extends AbstractSyncRunner implements JdbcReader {\n-\n+    \n     @Getter(AccessLevel.PROTECTED)\n     private final RdbmsConfiguration rdbmsConfiguration;\n     \n     private final DataSourceFactory dataSourceFactory;\n-\n+    \n     @Setter\n     private Channel channel;\n-\n+    \n     public AbstractJdbcReader(final RdbmsConfiguration rdbmsConfiguration, final DataSourceFactory dataSourceFactory) {\n         if (!JdbcDataSourceConfiguration.class.equals(rdbmsConfiguration.getDataSourceConfiguration().getClass())) {\n             throw new UnsupportedOperationException(\"AbstractJdbcReader only support JdbcDataSourceConfiguration\");\n         }\n         this.rdbmsConfiguration = rdbmsConfiguration;\n         this.dataSourceFactory = dataSourceFactory;\n     }\n-\n+    \n     @Override\n     public final void run() {\n         start();\n         read(channel);\n     }\n-\n+    \n     @Override\n     public final void read(final Channel channel) {\n         try (Connection conn = dataSourceFactory.getDataSource(rdbmsConfiguration.getDataSourceConfiguration()).getConnection()) {\n             String sql = String.format(\"select * from %s %s\", rdbmsConfiguration.getTableName(), rdbmsConfiguration.getWhereCondition());\n             PreparedStatement ps = conn.prepareStatement(sql, java.sql.ResultSet.TYPE_FORWARD_ONLY, ResultSet.CONCUR_READ_ONLY);\n-            ps.setFetchSize(100);\n-            ps.setFetchDirection(ResultSet.FETCH_REVERSE);\n+            ps.setFetchSize(Integer.MIN_VALUE);\n             ResultSet rs = ps.executeQuery();\n             ResultSetMetaData metaData = rs.getMetaData();\n             while (isRunning() && rs.next()) {\n                 DataRecord record = new DataRecord(new NopLogPosition(), metaData.getColumnCount());\n                 record.setType(\"bootstrap-insert\");\n                 record.setTableName(rdbmsConfiguration.getTableNameMap().get(rdbmsConfiguration.getTableName()));\n                 for (int i = 1; i <= metaData.getColumnCount(); i++) {\n-                    if (Types.TIME == rs.getMetaData().getColumnType(i)\n-                            || Types.DATE == rs.getMetaData().getColumnType(i)\n-                            || Types.TIMESTAMP == rs.getMetaData().getColumnType(i)) {\n+                    if (\"MySQL\".equals(rdbmsConfiguration.getDataSourceConfiguration().getDatabaseType().getName())\n+                            && isDateTimeValue(rs.getMetaData().getColumnType(i))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41d83d4189ba4930a2fa5cf4e41a2169f60dbd4a"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDExOTExNg==", "bodyText": "Similar problem as AbstractJdbcReader.\nThis can abstract a protect method, and let subClass to implement.\nOr create a new interface to handle this situation.\neach type database has implement, SQLBuilder only call interface.", "url": "https://github.com/apache/shardingsphere/pull/3899#discussion_r364119116", "createdAt": "2020-01-08T08:51:03Z", "author": {"login": "KomachiSion"}, "path": "sharding-scaling/sharding-scaling-core/src/main/java/org/apache/shardingsphere/shardingscaling/core/execute/executor/writer/SqlBuilder.java", "diffHunk": "@@ -66,6 +66,23 @@ public String load(final String key) {\n                     }\n                 });\n     }\n+    \n+    private void initIdentifierQuoteString(final String databaseType) {\n+        switch (databaseType) {\n+            case \"MySQL\":\n+                leftIdentifierQuoteString = \"`\";\n+                rightIdentifierQuoteString = \"`\";\n+                break;\n+            case \"PostgreSQL\":\n+                leftIdentifierQuoteString = \"\\\"\";\n+                rightIdentifierQuoteString = \"\\\"\";\n+                break;\n+            default:\n+                leftIdentifierQuoteString = \"\";\n+                rightIdentifierQuoteString = \"\";\n+                break;\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41d83d4189ba4930a2fa5cf4e41a2169f60dbd4a"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eae4fe54906f4f9d2874b0d777fc353c1e6ac173", "author": {"user": {"login": "avalon566", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/eae4fe54906f4f9d2874b0d777fc353c1e6ac173", "committedDate": "2020-01-08T13:15:19Z", "message": "Refactor AbstractJdbcReader"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "893d9784912a755cba9d470062d433226737ecf8", "author": {"user": {"login": "avalon566", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/893d9784912a755cba9d470062d433226737ecf8", "committedDate": "2020-01-08T12:51:16Z", "message": "Refactor AbstractJdbcReader"}, "afterCommit": {"oid": "eae4fe54906f4f9d2874b0d777fc353c1e6ac173", "author": {"user": {"login": "avalon566", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/eae4fe54906f4f9d2874b0d777fc353c1e6ac173", "committedDate": "2020-01-08T13:15:19Z", "message": "Refactor AbstractJdbcReader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afa5224364259e2c4675fc48e6355b4ccb73c73f", "author": {"user": {"login": "avalon566", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/afa5224364259e2c4675fc48e6355b4ccb73c73f", "committedDate": "2020-01-08T13:44:56Z", "message": "Refactor SqlBuilder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMjM5NjIx", "url": "https://github.com/apache/shardingsphere/pull/3899#pullrequestreview-340239621", "createdAt": "2020-01-09T01:06:51Z", "commit": {"oid": "afa5224364259e2c4675fc48e6355b4ccb73c73f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMTowNjo1MVrOFbocqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwMToxNDo0NFrOFbojmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxODU2OA==", "bodyText": "protected may be enough.", "url": "https://github.com/apache/shardingsphere/pull/3899#discussion_r364518568", "createdAt": "2020-01-09T01:06:51Z", "author": {"login": "KomachiSion"}, "path": "sharding-scaling/sharding-scaling-core/src/main/java/org/apache/shardingsphere/shardingscaling/core/execute/executor/reader/AbstractJdbcReader.java", "diffHunk": "@@ -102,7 +93,19 @@ public final void read(final Channel channel) {\n             pushRecord(new FinishedRecord(new NopLogPosition()));\n         }\n     }\n-\n+    \n+    /**\n+     * Read value from {@code ResultSet}.\n+     *\n+     * @param resultSet result set\n+     * @param index of read column\n+     * @return value\n+     * @throws SQLException sql exception\n+     */\n+    public Object readValue(final ResultSet resultSet, final int index) throws SQLException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afa5224364259e2c4675fc48e6355b4ccb73c73f"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxOTAwNQ==", "bodyText": "Should we rename the class?", "url": "https://github.com/apache/shardingsphere/pull/3899#discussion_r364519005", "createdAt": "2020-01-09T01:08:42Z", "author": {"login": "KomachiSion"}, "path": "sharding-scaling/sharding-scaling-core/src/main/java/org/apache/shardingsphere/shardingscaling/core/execute/executor/writer/SqlBuilder.java", "diffHunk": "@@ -20,33 +20,28 @@\n import com.google.common.cache.CacheBuilder;\n import com.google.common.cache.CacheLoader;\n import com.google.common.cache.LoadingCache;\n+import org.apache.shardingsphere.shardingscaling.core.metadata.ColumnMetaData;\n+import org.apache.shardingsphere.shardingscaling.core.util.DbMetaDataUtil;\n \n import javax.sql.DataSource;\n import java.util.List;\n import java.util.concurrent.ExecutionException;\n \n-import org.apache.shardingsphere.shardingscaling.core.util.DbMetaDataUtil;\n-import org.apache.shardingsphere.shardingscaling.core.metadata.ColumnMetaData;\n-\n /**\n  * Sql builder.\n  *\n  * @author avalon566\n  */\n-public final class SqlBuilder {\n-    \n-    private static final String LEFT_ESCAPE_QUOTE = \"`\";\n-\n-    private static final String RIGHT_ESCAPE_QUOTE = \"`\";\n+public abstract class SqlBuilder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afa5224364259e2c4675fc48e6355b4ccb73c73f"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUyMDM0NA==", "bodyText": "protected may be enough.", "url": "https://github.com/apache/shardingsphere/pull/3899#discussion_r364520344", "createdAt": "2020-01-09T01:14:44Z", "author": {"login": "KomachiSion"}, "path": "sharding-scaling/sharding-scaling-core/src/main/java/org/apache/shardingsphere/shardingscaling/core/execute/executor/writer/SqlBuilder.java", "diffHunk": "@@ -66,6 +61,20 @@ public String load(final String key) {\n                     }\n                 });\n     }\n+    \n+    /**\n+     * Get left identifier quote string.\n+     *\n+     * @return string\n+     */\n+    public abstract String getLeftIdentifierQuoteString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afa5224364259e2c4675fc48e6355b4ccb73c73f"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1078f6b81f75f73963816678f7e6f6989b77fba5", "author": {"user": {"login": "avalon566", "name": null}}, "url": "https://github.com/apache/shardingsphere/commit/1078f6b81f75f73963816678f7e6f6989b77fba5", "committedDate": "2020-01-09T03:56:34Z", "message": "Refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMzIyNzg1", "url": "https://github.com/apache/shardingsphere/pull/3899#pullrequestreview-340322785", "createdAt": "2020-01-09T07:11:31Z", "commit": {"oid": "1078f6b81f75f73963816678f7e6f6989b77fba5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4185, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}