{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NTQwMzI4", "number": 5590, "reviewThreads": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo1MDo1N1rOD8YjMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOTo1OToyM1rOD8z1Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQzMzc3OnYy", "diffSide": "RIGHT", "path": "shardingsphere-underlying/shardingsphere-rewrite/shardingsphere-rewrite-engine/src/main/java/org/apache/shardingsphere/underlying/rewrite/parameter/builder/impl/GroupedParameterBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo1MDo1N1rOGVSXVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo1MDo1N1rOGVSXVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk3NDE2NA==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424974164", "createdAt": "2020-05-14T08:50:57Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-underlying/shardingsphere-rewrite/shardingsphere-rewrite-engine/src/main/java/org/apache/shardingsphere/underlying/rewrite/parameter/builder/impl/GroupedParameterBuilder.java", "diffHunk": "@@ -35,16 +35,18 @@\n     private final List<StandardParameterBuilder> parameterBuilders;\n     \n     @Getter\n-    private final List<Object> onDuplicateKeyUpdateAddedParameters = new LinkedList<>();\n+    private final StandardParameterBuilder onDuplicateKeyUpdateParametersBuilder;\n     \n     @Setter\n     private String derivedColumnName;\n     \n-    public GroupedParameterBuilder(final List<List<Object>> groupedParameters) {\n+    public GroupedParameterBuilder(final List<List<Object>> groupedParameters, final List<Object> onDuplicateKeyUpdateParameters) {\n         parameterBuilders = new ArrayList<>(groupedParameters.size());\n         for (List<Object> each : groupedParameters) {\n             parameterBuilders.add(new StandardParameterBuilder(each));\n         }\n+    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQzNTAxOnYy", "diffSide": "RIGHT", "path": "shardingsphere-underlying/shardingsphere-rewrite/shardingsphere-rewrite-engine/src/main/java/org/apache/shardingsphere/underlying/rewrite/parameter/builder/impl/GroupedParameterBuilder.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo1MToxNVrOGVSYJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo1MToxNVrOGVSYJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk3NDM3NA==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424974374", "createdAt": "2020-05-14T08:51:15Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-underlying/shardingsphere-rewrite/shardingsphere-rewrite-engine/src/main/java/org/apache/shardingsphere/underlying/rewrite/parameter/builder/impl/GroupedParameterBuilder.java", "diffHunk": "@@ -53,9 +55,7 @@ public GroupedParameterBuilder(final List<List<Object>> groupedParameters) {\n         for (int i = 0; i < parameterBuilders.size(); i++) {\n             result.addAll(getParameters(i));\n         }\n-        if (!onDuplicateKeyUpdateAddedParameters.isEmpty()) {\n-            result.addAll(onDuplicateKeyUpdateAddedParameters);\n-        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQzNzY0OnYy", "diffSide": "RIGHT", "path": "shardingsphere-underlying/shardingsphere-rewrite/shardingsphere-rewrite-engine/src/main/java/org/apache/shardingsphere/underlying/rewrite/engine/RouteSQLRewriteEngine.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo1MTo1N1rOGVSZ1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo1MTo1N1rOGVSZ1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk3NDgwNg==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424974806", "createdAt": "2020-05-14T08:51:57Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-underlying/shardingsphere-rewrite/shardingsphere-rewrite-engine/src/main/java/org/apache/shardingsphere/underlying/rewrite/engine/RouteSQLRewriteEngine.java", "diffHunk": "@@ -66,6 +77,8 @@ public RouteSQLRewriteResult rewrite(final SQLRewriteContext sqlRewriteContext,\n             }\n             count++;\n         }\n+        result.addAll(((GroupedParameterBuilder) parameterBuilder).getOnDuplicateKeyUpdateParametersBuilder().getParameters());\n+    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQ2MjcyOnYy", "diffSide": "RIGHT", "path": "shardingsphere-underlying/shardingsphere-rewrite/shardingsphere-rewrite-engine/src/main/java/org/apache/shardingsphere/underlying/rewrite/engine/RouteSQLRewriteEngine.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo1Nzo1MVrOGVSqFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo1Nzo1MVrOGVSqFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk3ODk2NQ==", "bodyText": "I prefer if to else if.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424978965", "createdAt": "2020-05-14T08:57:51Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-underlying/shardingsphere-rewrite/shardingsphere-rewrite-engine/src/main/java/org/apache/shardingsphere/underlying/rewrite/engine/RouteSQLRewriteEngine.java", "diffHunk": "@@ -55,9 +55,20 @@ public RouteSQLRewriteResult rewrite(final SQLRewriteContext sqlRewriteContext,\n     }\n     \n     private List<Object> getParameters(final ParameterBuilder parameterBuilder, final RouteResult routeResult, final RouteUnit routeUnit) {\n-        if (parameterBuilder instanceof StandardParameterBuilder || routeResult.getOriginalDataNodes().isEmpty() || parameterBuilder.getParameters().isEmpty()) {\n+        if (parameterBuilder instanceof StandardParameterBuilder) {\n             return parameterBuilder.getParameters();\n+        } else if (routeResult.getOriginalDataNodes().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQ3OTk1OnYy", "diffSide": "RIGHT", "path": "shardingsphere-underlying/shardingsphere-rewrite/shardingsphere-rewrite-engine/src/main/java/org/apache/shardingsphere/underlying/rewrite/engine/GenericSQLRewriteEngine.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowMjowNVrOGVS08Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowMjowNVrOGVS08Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4MTc0NQ==", "bodyText": "It is preferable to move the content in else {} to the parent level.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424981745", "createdAt": "2020-05-14T09:02:05Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-underlying/shardingsphere-rewrite/shardingsphere-rewrite-engine/src/main/java/org/apache/shardingsphere/underlying/rewrite/engine/GenericSQLRewriteEngine.java", "diffHunk": "@@ -34,6 +40,22 @@\n      * @return SQL rewrite result\n      */\n     public GenericSQLRewriteResult rewrite(final SQLRewriteContext sqlRewriteContext) {\n-        return new GenericSQLRewriteResult(new SQLRewriteUnit(new DefaultSQLBuilder(sqlRewriteContext).toSQL(), sqlRewriteContext.getParameterBuilder().getParameters()));\n+        return new GenericSQLRewriteResult(new SQLRewriteUnit(new DefaultSQLBuilder(sqlRewriteContext).toSQL(), getParameters(sqlRewriteContext.getParameterBuilder())));\n+    }\n+    \n+    private List<Object> getParameters(final ParameterBuilder parameterBuilder) {\n+        if (parameterBuilder instanceof StandardParameterBuilder) {\n+            return parameterBuilder.getParameters();\n+        } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQ5MTE3OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/statement/impl/InsertStatementContextTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNTowNlrOGVS8Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNTowNlrOGVS8Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4MzY1NA==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424983654", "createdAt": "2020-05-14T09:05:06Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/statement/impl/InsertStatementContextTest.java", "diffHunk": "@@ -79,6 +98,22 @@ private void setUpInsertValues(final InsertStatement insertStatement) {\n                 new ParameterMarkerExpressionSegment(0, 0, 3), new ParameterMarkerExpressionSegment(0, 0, 4), new LiteralExpressionSegment(0, 0, \"init\"))));\n     }\n     \n+    private void setUpOnDuplicateValues(final InsertStatement insertStatement) {\n+        AssignmentSegment parameterMarkerExpressionAssignment = new AssignmentSegment(0, 0,\n+                new ColumnSegment(0, 0, new IdentifierValue(\"on_duplicate_key_update_column_1\")),\n+                new ParameterMarkerExpressionSegment(0, 0, 4)\n+        );\n+        AssignmentSegment literalExpressionAssignment = new AssignmentSegment(0, 0,\n+                new ColumnSegment(0, 0, new IdentifierValue(\"on_duplicate_key_update_column_2\")),\n+                new LiteralExpressionSegment(0, 0, 5)\n+        );\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQ5MzE0OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNTozNlrOGVS9rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNTozNlrOGVS9rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4Mzk4Mw==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424983983", "createdAt": "2020-05-14T09:05:36Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.SimpleExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.value.identifier.IdentifierValue;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class OnDuplicateUpdateContextTest {\n+    \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void assertInstanceConstructedOk() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+\n+        Method calculateParametersCountMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"calculateParametersCount\", Collection.class);\n+        calculateParametersCountMethod.setAccessible(true);\n+        int calculateParametersCountResult = (int) calculateParametersCountMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getParametersCount(), is(calculateParametersCountResult));\n+\n+        Method getValueExpressionsMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getValueExpressions\", Collection.class);\n+        getValueExpressionsMethod.setAccessible(true);\n+        List<ExpressionSegment> getValueExpressionsResult = (List<ExpressionSegment>) getValueExpressionsMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getValueExpressions(), is(getValueExpressionsResult));\n+\n+        Method getParametersMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getParameters\", List.class, int.class);\n+        getParametersMethod.setAccessible(true);\n+        List<Object> getParametersResult = (List<Object>) getParametersMethod.invoke(onDuplicateUpdateContext, new Object[]{parameters, parametersOffset});\n+        assertThat(onDuplicateUpdateContext.getParameters(), is(getParametersResult));\n+    }\n+    \n+    @Test\n+    public void assertGetValueWhenParameterMarker() {\n+        Collection<AssignmentSegment> assignments = makeParameterMarkerExpressionAssignmentSegment();\n+        String parameterValue1 = \"test1\";\n+        String parameterValue2 = \"test2\";\n+        List<Object> parameters = Lists.newArrayList(parameterValue1, parameterValue2);\n+        int parametersOffset = 0;\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+        Object valueFromInsertValueContext1 = onDuplicateUpdateContext.getValue(0);\n+        assertThat(valueFromInsertValueContext1, is(parameterValue1));\n+\n+        Object valueFromInsertValueContext2 = onDuplicateUpdateContext.getValue(1);\n+        assertThat(valueFromInsertValueContext2, is(parameterValue2));\n+    }\n+    \n+    private Collection<AssignmentSegment> makeParameterMarkerExpressionAssignmentSegment() {\n+        ParameterMarkerExpressionSegment parameterMarkerExpressionSegment = new ParameterMarkerExpressionSegment(0, 10, 5);\n+        AssignmentSegment assignmentSegment1 = makeAssignmentSegment(parameterMarkerExpressionSegment);\n+\n+        ParameterMarkerExpressionSegment parameterMarkerExpressionSegment2 = new ParameterMarkerExpressionSegment(0, 10, 6);\n+        AssignmentSegment assignmentSegment2 = makeAssignmentSegment(parameterMarkerExpressionSegment2);\n+        return Lists.newArrayList(assignmentSegment1, assignmentSegment2);\n+    }\n+    \n+    @Test\n+    public void assertGetValueWhenLiteralExpressionSegment() {\n+        Object literalObject = new Object();\n+        Collection<AssignmentSegment> assignments = makeLiteralExpressionSegment(literalObject);\n+        List<Object> parameters = Collections.emptyList();\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, 0);\n+        Object valueFromInsertValueContext = onDuplicateUpdateContext.getValue(0);\n+        assertThat(valueFromInsertValueContext, is(literalObject));\n+    }\n+    \n+    private Collection<AssignmentSegment> makeLiteralExpressionSegment(final Object literalObject) {\n+        LiteralExpressionSegment parameterLiteralExpression = new LiteralExpressionSegment(0, 10, literalObject);\n+        AssignmentSegment assignmentSegment = makeAssignmentSegment(parameterLiteralExpression);\n+        return Collections.singleton(assignmentSegment);\n+    }\n+    \n+    private AssignmentSegment makeAssignmentSegment(final SimpleExpressionSegment expressionSegment) {\n+        int doesNotMatterLexicalIndex = 0;\n+        String doesNotMatterColumnName = \"columnNameStr\";\n+\n+        ColumnSegment column = new ColumnSegment(doesNotMatterLexicalIndex, doesNotMatterLexicalIndex, new IdentifierValue(doesNotMatterColumnName));\n+        return new AssignmentSegment(doesNotMatterLexicalIndex, doesNotMatterLexicalIndex, column, expressionSegment);\n+    }\n+    \n+    @Test\n+    public void assertGetParameterIndex() throws NoSuchMethodException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+\n+        Method getParameterIndexMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getParameterIndex\", ExpressionSegment.class);\n+        getParameterIndexMethod.setAccessible(true);\n+        ParameterMarkerExpressionSegment notExistsExpressionSegment = new ParameterMarkerExpressionSegment(0, 0, 0);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQ5MzY0OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNTo0M1rOGVS-Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNTo0M1rOGVS-Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4NDA2Ng==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424984066", "createdAt": "2020-05-14T09:05:43Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.SimpleExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.value.identifier.IdentifierValue;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class OnDuplicateUpdateContextTest {\n+    \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void assertInstanceConstructedOk() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+\n+        Method calculateParametersCountMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"calculateParametersCount\", Collection.class);\n+        calculateParametersCountMethod.setAccessible(true);\n+        int calculateParametersCountResult = (int) calculateParametersCountMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getParametersCount(), is(calculateParametersCountResult));\n+\n+        Method getValueExpressionsMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getValueExpressions\", Collection.class);\n+        getValueExpressionsMethod.setAccessible(true);\n+        List<ExpressionSegment> getValueExpressionsResult = (List<ExpressionSegment>) getValueExpressionsMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getValueExpressions(), is(getValueExpressionsResult));\n+\n+        Method getParametersMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getParameters\", List.class, int.class);\n+        getParametersMethod.setAccessible(true);\n+        List<Object> getParametersResult = (List<Object>) getParametersMethod.invoke(onDuplicateUpdateContext, new Object[]{parameters, parametersOffset});\n+        assertThat(onDuplicateUpdateContext.getParameters(), is(getParametersResult));\n+    }\n+    \n+    @Test\n+    public void assertGetValueWhenParameterMarker() {\n+        Collection<AssignmentSegment> assignments = makeParameterMarkerExpressionAssignmentSegment();\n+        String parameterValue1 = \"test1\";\n+        String parameterValue2 = \"test2\";\n+        List<Object> parameters = Lists.newArrayList(parameterValue1, parameterValue2);\n+        int parametersOffset = 0;\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+        Object valueFromInsertValueContext1 = onDuplicateUpdateContext.getValue(0);\n+        assertThat(valueFromInsertValueContext1, is(parameterValue1));\n+\n+        Object valueFromInsertValueContext2 = onDuplicateUpdateContext.getValue(1);\n+        assertThat(valueFromInsertValueContext2, is(parameterValue2));\n+    }\n+    \n+    private Collection<AssignmentSegment> makeParameterMarkerExpressionAssignmentSegment() {\n+        ParameterMarkerExpressionSegment parameterMarkerExpressionSegment = new ParameterMarkerExpressionSegment(0, 10, 5);\n+        AssignmentSegment assignmentSegment1 = makeAssignmentSegment(parameterMarkerExpressionSegment);\n+\n+        ParameterMarkerExpressionSegment parameterMarkerExpressionSegment2 = new ParameterMarkerExpressionSegment(0, 10, 6);\n+        AssignmentSegment assignmentSegment2 = makeAssignmentSegment(parameterMarkerExpressionSegment2);\n+        return Lists.newArrayList(assignmentSegment1, assignmentSegment2);\n+    }\n+    \n+    @Test\n+    public void assertGetValueWhenLiteralExpressionSegment() {\n+        Object literalObject = new Object();\n+        Collection<AssignmentSegment> assignments = makeLiteralExpressionSegment(literalObject);\n+        List<Object> parameters = Collections.emptyList();\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, 0);\n+        Object valueFromInsertValueContext = onDuplicateUpdateContext.getValue(0);\n+        assertThat(valueFromInsertValueContext, is(literalObject));\n+    }\n+    \n+    private Collection<AssignmentSegment> makeLiteralExpressionSegment(final Object literalObject) {\n+        LiteralExpressionSegment parameterLiteralExpression = new LiteralExpressionSegment(0, 10, literalObject);\n+        AssignmentSegment assignmentSegment = makeAssignmentSegment(parameterLiteralExpression);\n+        return Collections.singleton(assignmentSegment);\n+    }\n+    \n+    private AssignmentSegment makeAssignmentSegment(final SimpleExpressionSegment expressionSegment) {\n+        int doesNotMatterLexicalIndex = 0;\n+        String doesNotMatterColumnName = \"columnNameStr\";\n+\n+        ColumnSegment column = new ColumnSegment(doesNotMatterLexicalIndex, doesNotMatterLexicalIndex, new IdentifierValue(doesNotMatterColumnName));\n+        return new AssignmentSegment(doesNotMatterLexicalIndex, doesNotMatterLexicalIndex, column, expressionSegment);\n+    }\n+    \n+    @Test\n+    public void assertGetParameterIndex() throws NoSuchMethodException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 123}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQ5NDM5OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNTo1NFrOGVS-fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNTo1NFrOGVS-fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4NDE5MQ==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424984191", "createdAt": "2020-05-14T09:05:54Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.SimpleExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.value.identifier.IdentifierValue;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class OnDuplicateUpdateContextTest {\n+    \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void assertInstanceConstructedOk() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+\n+        Method calculateParametersCountMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"calculateParametersCount\", Collection.class);\n+        calculateParametersCountMethod.setAccessible(true);\n+        int calculateParametersCountResult = (int) calculateParametersCountMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getParametersCount(), is(calculateParametersCountResult));\n+\n+        Method getValueExpressionsMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getValueExpressions\", Collection.class);\n+        getValueExpressionsMethod.setAccessible(true);\n+        List<ExpressionSegment> getValueExpressionsResult = (List<ExpressionSegment>) getValueExpressionsMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getValueExpressions(), is(getValueExpressionsResult));\n+\n+        Method getParametersMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getParameters\", List.class, int.class);\n+        getParametersMethod.setAccessible(true);\n+        List<Object> getParametersResult = (List<Object>) getParametersMethod.invoke(onDuplicateUpdateContext, new Object[]{parameters, parametersOffset});\n+        assertThat(onDuplicateUpdateContext.getParameters(), is(getParametersResult));\n+    }\n+    \n+    @Test\n+    public void assertGetValueWhenParameterMarker() {\n+        Collection<AssignmentSegment> assignments = makeParameterMarkerExpressionAssignmentSegment();\n+        String parameterValue1 = \"test1\";\n+        String parameterValue2 = \"test2\";\n+        List<Object> parameters = Lists.newArrayList(parameterValue1, parameterValue2);\n+        int parametersOffset = 0;\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+        Object valueFromInsertValueContext1 = onDuplicateUpdateContext.getValue(0);\n+        assertThat(valueFromInsertValueContext1, is(parameterValue1));\n+\n+        Object valueFromInsertValueContext2 = onDuplicateUpdateContext.getValue(1);\n+        assertThat(valueFromInsertValueContext2, is(parameterValue2));\n+    }\n+    \n+    private Collection<AssignmentSegment> makeParameterMarkerExpressionAssignmentSegment() {\n+        ParameterMarkerExpressionSegment parameterMarkerExpressionSegment = new ParameterMarkerExpressionSegment(0, 10, 5);\n+        AssignmentSegment assignmentSegment1 = makeAssignmentSegment(parameterMarkerExpressionSegment);\n+\n+        ParameterMarkerExpressionSegment parameterMarkerExpressionSegment2 = new ParameterMarkerExpressionSegment(0, 10, 6);\n+        AssignmentSegment assignmentSegment2 = makeAssignmentSegment(parameterMarkerExpressionSegment2);\n+        return Lists.newArrayList(assignmentSegment1, assignmentSegment2);\n+    }\n+    \n+    @Test\n+    public void assertGetValueWhenLiteralExpressionSegment() {\n+        Object literalObject = new Object();\n+        Collection<AssignmentSegment> assignments = makeLiteralExpressionSegment(literalObject);\n+        List<Object> parameters = Collections.emptyList();\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, 0);\n+        Object valueFromInsertValueContext = onDuplicateUpdateContext.getValue(0);\n+        assertThat(valueFromInsertValueContext, is(literalObject));\n+    }\n+    \n+    private Collection<AssignmentSegment> makeLiteralExpressionSegment(final Object literalObject) {\n+        LiteralExpressionSegment parameterLiteralExpression = new LiteralExpressionSegment(0, 10, literalObject);\n+        AssignmentSegment assignmentSegment = makeAssignmentSegment(parameterLiteralExpression);\n+        return Collections.singleton(assignmentSegment);\n+    }\n+    \n+    private AssignmentSegment makeAssignmentSegment(final SimpleExpressionSegment expressionSegment) {\n+        int doesNotMatterLexicalIndex = 0;\n+        String doesNotMatterColumnName = \"columnNameStr\";\n+\n+        ColumnSegment column = new ColumnSegment(doesNotMatterLexicalIndex, doesNotMatterLexicalIndex, new IdentifierValue(doesNotMatterColumnName));\n+        return new AssignmentSegment(doesNotMatterLexicalIndex, doesNotMatterLexicalIndex, column, expressionSegment);\n+    }\n+    \n+    @Test\n+    public void assertGetParameterIndex() throws NoSuchMethodException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 121}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQ5NDc3OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNjowMlrOGVS-yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNjowMlrOGVS-yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4NDI2NA==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424984264", "createdAt": "2020-05-14T09:06:02Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.SimpleExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.value.identifier.IdentifierValue;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class OnDuplicateUpdateContextTest {\n+    \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void assertInstanceConstructedOk() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+\n+        Method calculateParametersCountMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"calculateParametersCount\", Collection.class);\n+        calculateParametersCountMethod.setAccessible(true);\n+        int calculateParametersCountResult = (int) calculateParametersCountMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getParametersCount(), is(calculateParametersCountResult));\n+\n+        Method getValueExpressionsMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getValueExpressions\", Collection.class);\n+        getValueExpressionsMethod.setAccessible(true);\n+        List<ExpressionSegment> getValueExpressionsResult = (List<ExpressionSegment>) getValueExpressionsMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getValueExpressions(), is(getValueExpressionsResult));\n+\n+        Method getParametersMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getParameters\", List.class, int.class);\n+        getParametersMethod.setAccessible(true);\n+        List<Object> getParametersResult = (List<Object>) getParametersMethod.invoke(onDuplicateUpdateContext, new Object[]{parameters, parametersOffset});\n+        assertThat(onDuplicateUpdateContext.getParameters(), is(getParametersResult));\n+    }\n+    \n+    @Test\n+    public void assertGetValueWhenParameterMarker() {\n+        Collection<AssignmentSegment> assignments = makeParameterMarkerExpressionAssignmentSegment();\n+        String parameterValue1 = \"test1\";\n+        String parameterValue2 = \"test2\";\n+        List<Object> parameters = Lists.newArrayList(parameterValue1, parameterValue2);\n+        int parametersOffset = 0;\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+        Object valueFromInsertValueContext1 = onDuplicateUpdateContext.getValue(0);\n+        assertThat(valueFromInsertValueContext1, is(parameterValue1));\n+\n+        Object valueFromInsertValueContext2 = onDuplicateUpdateContext.getValue(1);\n+        assertThat(valueFromInsertValueContext2, is(parameterValue2));\n+    }\n+    \n+    private Collection<AssignmentSegment> makeParameterMarkerExpressionAssignmentSegment() {\n+        ParameterMarkerExpressionSegment parameterMarkerExpressionSegment = new ParameterMarkerExpressionSegment(0, 10, 5);\n+        AssignmentSegment assignmentSegment1 = makeAssignmentSegment(parameterMarkerExpressionSegment);\n+\n+        ParameterMarkerExpressionSegment parameterMarkerExpressionSegment2 = new ParameterMarkerExpressionSegment(0, 10, 6);\n+        AssignmentSegment assignmentSegment2 = makeAssignmentSegment(parameterMarkerExpressionSegment2);\n+        return Lists.newArrayList(assignmentSegment1, assignmentSegment2);\n+    }\n+    \n+    @Test\n+    public void assertGetValueWhenLiteralExpressionSegment() {\n+        Object literalObject = new Object();\n+        Collection<AssignmentSegment> assignments = makeLiteralExpressionSegment(literalObject);\n+        List<Object> parameters = Collections.emptyList();\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, 0);\n+        Object valueFromInsertValueContext = onDuplicateUpdateContext.getValue(0);\n+        assertThat(valueFromInsertValueContext, is(literalObject));\n+    }\n+    \n+    private Collection<AssignmentSegment> makeLiteralExpressionSegment(final Object literalObject) {\n+        LiteralExpressionSegment parameterLiteralExpression = new LiteralExpressionSegment(0, 10, literalObject);\n+        AssignmentSegment assignmentSegment = makeAssignmentSegment(parameterLiteralExpression);\n+        return Collections.singleton(assignmentSegment);\n+    }\n+    \n+    private AssignmentSegment makeAssignmentSegment(final SimpleExpressionSegment expressionSegment) {\n+        int doesNotMatterLexicalIndex = 0;\n+        String doesNotMatterColumnName = \"columnNameStr\";\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 111}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQ5NTI4OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNjowOVrOGVS_GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNjowOVrOGVS_GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4NDM0NQ==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424984345", "createdAt": "2020-05-14T09:06:09Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.SimpleExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.value.identifier.IdentifierValue;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class OnDuplicateUpdateContextTest {\n+    \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void assertInstanceConstructedOk() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+\n+        Method calculateParametersCountMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"calculateParametersCount\", Collection.class);\n+        calculateParametersCountMethod.setAccessible(true);\n+        int calculateParametersCountResult = (int) calculateParametersCountMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getParametersCount(), is(calculateParametersCountResult));\n+\n+        Method getValueExpressionsMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getValueExpressions\", Collection.class);\n+        getValueExpressionsMethod.setAccessible(true);\n+        List<ExpressionSegment> getValueExpressionsResult = (List<ExpressionSegment>) getValueExpressionsMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getValueExpressions(), is(getValueExpressionsResult));\n+\n+        Method getParametersMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getParameters\", List.class, int.class);\n+        getParametersMethod.setAccessible(true);\n+        List<Object> getParametersResult = (List<Object>) getParametersMethod.invoke(onDuplicateUpdateContext, new Object[]{parameters, parametersOffset});\n+        assertThat(onDuplicateUpdateContext.getParameters(), is(getParametersResult));\n+    }\n+    \n+    @Test\n+    public void assertGetValueWhenParameterMarker() {\n+        Collection<AssignmentSegment> assignments = makeParameterMarkerExpressionAssignmentSegment();\n+        String parameterValue1 = \"test1\";\n+        String parameterValue2 = \"test2\";\n+        List<Object> parameters = Lists.newArrayList(parameterValue1, parameterValue2);\n+        int parametersOffset = 0;\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+        Object valueFromInsertValueContext1 = onDuplicateUpdateContext.getValue(0);\n+        assertThat(valueFromInsertValueContext1, is(parameterValue1));\n+\n+        Object valueFromInsertValueContext2 = onDuplicateUpdateContext.getValue(1);\n+        assertThat(valueFromInsertValueContext2, is(parameterValue2));\n+    }\n+    \n+    private Collection<AssignmentSegment> makeParameterMarkerExpressionAssignmentSegment() {\n+        ParameterMarkerExpressionSegment parameterMarkerExpressionSegment = new ParameterMarkerExpressionSegment(0, 10, 5);\n+        AssignmentSegment assignmentSegment1 = makeAssignmentSegment(parameterMarkerExpressionSegment);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQ5NjcyOnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNjoyN1rOGVS_9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNTo0NTowMVrOGViiiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4NDU2Nw==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424984567", "createdAt": "2020-05-14T09:06:27Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.SimpleExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.value.identifier.IdentifierValue;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class OnDuplicateUpdateContextTest {\n+    \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void assertInstanceConstructedOk() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+\n+        Method calculateParametersCountMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"calculateParametersCount\", Collection.class);\n+        calculateParametersCountMethod.setAccessible(true);\n+        int calculateParametersCountResult = (int) calculateParametersCountMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getParametersCount(), is(calculateParametersCountResult));\n+\n+        Method getValueExpressionsMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getValueExpressions\", Collection.class);\n+        getValueExpressionsMethod.setAccessible(true);\n+        List<ExpressionSegment> getValueExpressionsResult = (List<ExpressionSegment>) getValueExpressionsMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getValueExpressions(), is(getValueExpressionsResult));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIzOTE3OQ==", "bodyText": "IMO,it's better to keep the different method call with assertion separately.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425239179", "createdAt": "2020-05-14T15:45:01Z", "author": {"login": "neil4dong"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.SimpleExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.value.identifier.IdentifierValue;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class OnDuplicateUpdateContextTest {\n+    \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void assertInstanceConstructedOk() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+\n+        Method calculateParametersCountMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"calculateParametersCount\", Collection.class);\n+        calculateParametersCountMethod.setAccessible(true);\n+        int calculateParametersCountResult = (int) calculateParametersCountMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getParametersCount(), is(calculateParametersCountResult));\n+\n+        Method getValueExpressionsMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getValueExpressions\", Collection.class);\n+        getValueExpressionsMethod.setAccessible(true);\n+        List<ExpressionSegment> getValueExpressionsResult = (List<ExpressionSegment>) getValueExpressionsMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getValueExpressions(), is(getValueExpressionsResult));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4NDU2Nw=="}, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQ5NjgyOnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNjoyOVrOGVTACw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNTo0NDo1MlrOGViiEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4NDU4Nw==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424984587", "createdAt": "2020-05-14T09:06:29Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.SimpleExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.value.identifier.IdentifierValue;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class OnDuplicateUpdateContextTest {\n+    \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void assertInstanceConstructedOk() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+\n+        Method calculateParametersCountMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"calculateParametersCount\", Collection.class);\n+        calculateParametersCountMethod.setAccessible(true);\n+        int calculateParametersCountResult = (int) calculateParametersCountMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getParametersCount(), is(calculateParametersCountResult));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTIzOTA1OQ==", "bodyText": "IMO,it's better to keep the different method call with assertion separately.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425239059", "createdAt": "2020-05-14T15:44:52Z", "author": {"login": "neil4dong"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "diffHunk": "@@ -0,0 +1,147 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.SimpleExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.value.identifier.IdentifierValue;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class OnDuplicateUpdateContextTest {\n+    \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void assertInstanceConstructedOk() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+\n+        Method calculateParametersCountMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"calculateParametersCount\", Collection.class);\n+        calculateParametersCountMethod.setAccessible(true);\n+        int calculateParametersCountResult = (int) calculateParametersCountMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getParametersCount(), is(calculateParametersCountResult));\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4NDU4Nw=="}, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQ5ODU2OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/statement/dml/InsertStatementContext.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNjo1OVrOGVTBIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNjo1OVrOGVTBIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4NDg2Ng==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424984866", "createdAt": "2020-05-14T09:06:59Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/statement/dml/InsertStatementContext.java", "diffHunk": "@@ -93,9 +114,21 @@ public InsertStatementContext(final SchemaMetaData schemaMetaData, final List<Ob\n         return result;\n     }\n     \n+    /**\n+     * Get OnDuplicateKeyUpdateParameters.\n+     * @return OnDuplicateKeyUpdateParameters\n+     */\n+    public List<Object> getOnDuplicateKeyUpdateParameters() {\n+        if (null == onDuplicateKeyUpdateValueContext) {\n+            return new ArrayList<>(0);\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjQ5OTkwOnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/statement/dml/InsertStatementContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNzoyMFrOGVTCAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOTowNzoyMFrOGVTCAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4NTA4OA==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424985088", "createdAt": "2020-05-14T09:07:20Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/statement/dml/InsertStatementContext.java", "diffHunk": "@@ -50,30 +54,47 @@\n     \n     private final List<InsertValueContext> insertValueContexts;\n     \n+    private final OnDuplicateUpdateContext onDuplicateKeyUpdateValueContext;\n+    \n     private final GeneratedKeyContext generatedKeyContext;\n     \n     public InsertStatementContext(final SchemaMetaData schemaMetaData, final List<Object> parameters, final InsertStatement sqlStatement) {\n         super(sqlStatement);\n         tablesContext = new TablesContext(sqlStatement.getTable());\n         columnNames = sqlStatement.useDefaultColumns() ? schemaMetaData.getAllColumnNames(sqlStatement.getTable().getTableName().getIdentifier().getValue()) : sqlStatement.getColumnNames();\n-        insertValueContexts = getInsertValueContexts(parameters);\n+\n+        AtomicInteger parametersOffset = new AtomicInteger(0);\n+        insertValueContexts = getInsertValueContexts(parameters, parametersOffset);\n+        onDuplicateKeyUpdateValueContext = getOnDuplicateKeyUpdateValueContext(parameters, parametersOffset).orElse(null);\n+\n         generatedKeyContext = new GeneratedKeyContextEngine(schemaMetaData).createGenerateKeyContext(parameters, sqlStatement).orElse(null);\n     }\n     \n-    private List<InsertValueContext> getInsertValueContexts(final List<Object> parameters) {\n+    private List<InsertValueContext> getInsertValueContexts(final List<Object> parameters, final AtomicInteger parametersOffset) {\n         List<InsertValueContext> result = new LinkedList<>();\n-        int parametersOffset = 0;\n         for (Collection<ExpressionSegment> each : getSqlStatement().getAllValueExpressions()) {\n-            InsertValueContext insertValueContext = new InsertValueContext(each, parameters, parametersOffset);\n+            InsertValueContext insertValueContext = new InsertValueContext(each, parameters, parametersOffset.get());\n             result.add(insertValueContext);\n-            parametersOffset += insertValueContext.getParametersCount();\n+            parametersOffset.addAndGet(insertValueContext.getParametersCount());\n         }\n         return result;\n     }\n     \n+    private Optional<OnDuplicateUpdateContext> getOnDuplicateKeyUpdateValueContext(final List<Object> parameters, final AtomicInteger parametersOffset) {\n+\n+        if (!getSqlStatement().getOnDuplicateKeyColumns().isPresent()) {\n+            return Optional.empty();\n+        }\n+        Collection<AssignmentSegment> onDuplicateKeyColumns = getSqlStatement().getOnDuplicateKeyColumns().get().getColumns();\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(onDuplicateKeyColumns, parameters, parametersOffset.get());\n+        parametersOffset.addAndGet(onDuplicateUpdateContext.getParametersCount());\n+        return Optional.of(onDuplicateUpdateContext);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjUxNTgzOnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/statement/dml/InsertStatementContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOToxMTozNlrOGVTMgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOToxMTozNlrOGVTMgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4Nzc3Nw==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424987777", "createdAt": "2020-05-14T09:11:36Z", "author": {"login": "tristaZero"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/statement/dml/InsertStatementContext.java", "diffHunk": "@@ -50,30 +54,47 @@\n     \n     private final List<InsertValueContext> insertValueContexts;\n     \n+    private final OnDuplicateUpdateContext onDuplicateKeyUpdateValueContext;\n+    \n     private final GeneratedKeyContext generatedKeyContext;\n     \n     public InsertStatementContext(final SchemaMetaData schemaMetaData, final List<Object> parameters, final InsertStatement sqlStatement) {\n         super(sqlStatement);\n         tablesContext = new TablesContext(sqlStatement.getTable());\n         columnNames = sqlStatement.useDefaultColumns() ? schemaMetaData.getAllColumnNames(sqlStatement.getTable().getTableName().getIdentifier().getValue()) : sqlStatement.getColumnNames();\n-        insertValueContexts = getInsertValueContexts(parameters);\n+\n+        AtomicInteger parametersOffset = new AtomicInteger(0);\n+        insertValueContexts = getInsertValueContexts(parameters, parametersOffset);\n+        onDuplicateKeyUpdateValueContext = getOnDuplicateKeyUpdateValueContext(parameters, parametersOffset).orElse(null);\n+\n         generatedKeyContext = new GeneratedKeyContextEngine(schemaMetaData).createGenerateKeyContext(parameters, sqlStatement).orElse(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjUxOTM4OnYy", "diffSide": "RIGHT", "path": "sharding-jdbc/sharding-jdbc-core/src/test/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShardingSpherePreparedStatementTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOToxMjozM1rOGVTO4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOToxMjozM1rOGVTO4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4ODM4Ng==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424988386", "createdAt": "2020-05-14T09:12:33Z", "author": {"login": "tristaZero"}, "path": "sharding-jdbc/sharding-jdbc-core/src/test/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShardingSpherePreparedStatementTest.java", "diffHunk": "@@ -316,6 +320,79 @@ public void assertAddBatchWithGenerateKeyColumn() throws SQLException {\n         }\n     }\n     \n+    @Test\n+    public void assertAddOnDuplicateKey() throws SQLException {\n+        int itemId = 1;\n+        int userId1 = 101;\n+        int userId2 = 102;\n+        int orderId = 200;\n+        String status = \"init\";\n+        \n+        String updatedStatus = \"updated on duplicate key\";\n+        ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjUzNDgxOnYy", "diffSide": "RIGHT", "path": "encrypt-core/encrypt-core-rewrite/src/main/java/org/apache/shardingsphere/encrypt/rewrite/parameter/impl/EncryptInsertOnDuplicateKeyUpdateValueParameterRewriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOToxNjozNVrOGVTYyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOToxNjozNVrOGVTYyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk5MDkyMg==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424990922", "createdAt": "2020-05-14T09:16:35Z", "author": {"login": "tristaZero"}, "path": "encrypt-core/encrypt-core-rewrite/src/main/java/org/apache/shardingsphere/encrypt/rewrite/parameter/impl/EncryptInsertOnDuplicateKeyUpdateValueParameterRewriter.java", "diffHunk": "@@ -51,30 +47,36 @@ protected boolean isNeedRewriteForEncrypt(final SQLStatementContext sqlStatement\n     @Override\n     public void rewrite(final ParameterBuilder parameterBuilder, final InsertStatementContext insertStatementContext, final List<Object> parameters) {\n         String tableName = insertStatementContext.getSqlStatement().getTable().getTableName().getIdentifier().getValue();\n-        Preconditions.checkState(insertStatementContext.getSqlStatement().getOnDuplicateKeyColumns().isPresent());\n-        OnDuplicateKeyColumnsSegment onDuplicateKeyColumnsSegment = insertStatementContext.getSqlStatement().getOnDuplicateKeyColumns().get();\n-        Collection<AssignmentSegment> onDuplicateKeyColumnsSegments = onDuplicateKeyColumnsSegment.getColumns();\n-        if (onDuplicateKeyColumnsSegments.isEmpty()) {\n-            return;\n-        }\n+\n         GroupedParameterBuilder groupedParameterBuilder = (GroupedParameterBuilder) parameterBuilder;\n-        for (AssignmentSegment each : onDuplicateKeyColumnsSegments) {\n-            ExpressionSegment expressionSegment = each.getValue();\n-            Object cipherColumnValue;\n-            Object plainColumnValue = null;\n-            if (expressionSegment instanceof ParameterMarkerExpressionSegment) {\n-                plainColumnValue = parameters.get(((ParameterMarkerExpressionSegment) expressionSegment).getParameterMarkerIndex());\n-            }\n-            if (queryWithCipherColumn) {\n-                Optional<Encryptor> encryptor = getEncryptRule().findEncryptor(tableName, each.getColumn().getIdentifier().getValue());\n-                if (encryptor.isPresent()) {\n-                    cipherColumnValue = encryptor.get().encrypt(plainColumnValue);\n-                    groupedParameterBuilder.getOnDuplicateKeyUpdateAddedParameters().add(cipherColumnValue);\n+        OnDuplicateUpdateContext onDuplicateKeyUpdateValueContext = insertStatementContext.getOnDuplicateKeyUpdateValueContext();\n+        for (int index = 0; index < onDuplicateKeyUpdateValueContext.getValueExpressions().size(); index++) {\n+            final int columnIndex = index;\n+            String encryptLogicColumnName = onDuplicateKeyUpdateValueContext.getColumn(columnIndex).getIdentifier().getValue();\n+            Optional<Encryptor> encryptorOptional = getEncryptRule().findEncryptor(tableName, encryptLogicColumnName);\n+            encryptorOptional.ifPresent(encryptor -> {\n+                Object plainColumnValue = onDuplicateKeyUpdateValueContext.getValue(columnIndex);\n+                Object cipherColumnValue = encryptorOptional.get().encrypt(plainColumnValue);\n+                groupedParameterBuilder.getOnDuplicateKeyUpdateParametersBuilder().addReplacedParameters(columnIndex, cipherColumnValue);\n+                Collection<Object> addedParameters = new LinkedList<>();\n+                if (encryptor instanceof QueryAssistedEncryptor) {\n+                    Optional<String> assistedColumnName = getEncryptRule().findAssistedQueryColumn(tableName, encryptLogicColumnName);\n+                    Preconditions.checkArgument(assistedColumnName.isPresent(), \"Can not find assisted query Column Name\");\n+                    addedParameters.add(((QueryAssistedEncryptor) encryptor).queryAssistedEncrypt(plainColumnValue.toString()));\n+                }\n+\n+                if (getEncryptRule().findPlainColumn(tableName, encryptLogicColumnName).isPresent()) {\n+                    addedParameters.add(plainColumnValue);\n+                }\n+\n+                if (!addedParameters.isEmpty()) {\n+                    if (!groupedParameterBuilder.getOnDuplicateKeyUpdateParametersBuilder().getAddedIndexAndParameters().containsKey(columnIndex + 1)) {\n+                        groupedParameterBuilder.getOnDuplicateKeyUpdateParametersBuilder().getAddedIndexAndParameters().put(columnIndex + 1, new LinkedList<>());\n+                    }\n+                    groupedParameterBuilder.getOnDuplicateKeyUpdateParametersBuilder().getAddedIndexAndParameters().get(columnIndex + 1).addAll(addedParameters);\n                 }\n-            }\n-            if (null != plainColumnValue) {\n-                groupedParameterBuilder.getOnDuplicateKeyUpdateAddedParameters().add(plainColumnValue);\n-            }\n+            });\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NjUzNTQyOnYy", "diffSide": "RIGHT", "path": "encrypt-core/encrypt-core-rewrite/src/main/java/org/apache/shardingsphere/encrypt/rewrite/parameter/impl/EncryptInsertOnDuplicateKeyUpdateValueParameterRewriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOToxNjo0NFrOGVTZMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOToxNjo0NFrOGVTZMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk5MTAyNA==", "bodyText": "Please remove this redundant blank line.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r424991024", "createdAt": "2020-05-14T09:16:44Z", "author": {"login": "tristaZero"}, "path": "encrypt-core/encrypt-core-rewrite/src/main/java/org/apache/shardingsphere/encrypt/rewrite/parameter/impl/EncryptInsertOnDuplicateKeyUpdateValueParameterRewriter.java", "diffHunk": "@@ -51,30 +47,36 @@ protected boolean isNeedRewriteForEncrypt(final SQLStatementContext sqlStatement\n     @Override\n     public void rewrite(final ParameterBuilder parameterBuilder, final InsertStatementContext insertStatementContext, final List<Object> parameters) {\n         String tableName = insertStatementContext.getSqlStatement().getTable().getTableName().getIdentifier().getValue();\n-        Preconditions.checkState(insertStatementContext.getSqlStatement().getOnDuplicateKeyColumns().isPresent());\n-        OnDuplicateKeyColumnsSegment onDuplicateKeyColumnsSegment = insertStatementContext.getSqlStatement().getOnDuplicateKeyColumns().get();\n-        Collection<AssignmentSegment> onDuplicateKeyColumnsSegments = onDuplicateKeyColumnsSegment.getColumns();\n-        if (onDuplicateKeyColumnsSegments.isEmpty()) {\n-            return;\n-        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399a922becd34eed573e2bbd04c7ee692761c5a"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTk0MjA0OnYy", "diffSide": "RIGHT", "path": "sharding-jdbc/sharding-jdbc-core/src/test/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShardingSpherePreparedStatementTest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMzoxOTozMlrOGV1JDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOTo0MTo0OFrOGV94qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0Mzk0OA==", "bodyText": "Please keep original indent", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425543948", "createdAt": "2020-05-15T03:19:32Z", "author": {"login": "terrymanu"}, "path": "sharding-jdbc/sharding-jdbc-core/src/test/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShardingSpherePreparedStatementTest.java", "diffHunk": "@@ -126,7 +130,7 @@ public void assertMultiValuesWithGenerateShardingKeyColumn() throws SQLException\n             }\n         }\n     }\n-\n+    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13062b4ab12ab24687b1f88830c3b7e54c08d4af"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU1MjEyMg==", "bodyText": "It's wired , there is two kinds of ident, some files no indent ,some files has ident .  which one should I use?", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425552122", "createdAt": "2020-05-15T03:54:55Z", "author": {"login": "neil4dong"}, "path": "sharding-jdbc/sharding-jdbc-core/src/test/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShardingSpherePreparedStatementTest.java", "diffHunk": "@@ -126,7 +130,7 @@ public void assertMultiValuesWithGenerateShardingKeyColumn() throws SQLException\n             }\n         }\n     }\n-\n+    ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0Mzk0OA=="}, "originalCommit": {"oid": "13062b4ab12ab24687b1f88830c3b7e54c08d4af"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY2NzU0NA==", "bodyText": "we prefer just keep 4 spaces", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425667544", "createdAt": "2020-05-15T09:06:39Z", "author": {"login": "terrymanu"}, "path": "sharding-jdbc/sharding-jdbc-core/src/test/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShardingSpherePreparedStatementTest.java", "diffHunk": "@@ -126,7 +130,7 @@ public void assertMultiValuesWithGenerateShardingKeyColumn() throws SQLException\n             }\n         }\n     }\n-\n+    ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0Mzk0OA=="}, "originalCommit": {"oid": "13062b4ab12ab24687b1f88830c3b7e54c08d4af"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY4NzIwOA==", "bodyText": "use 4 spaces.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425687208", "createdAt": "2020-05-15T09:41:48Z", "author": {"login": "neil4dong"}, "path": "sharding-jdbc/sharding-jdbc-core/src/test/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShardingSpherePreparedStatementTest.java", "diffHunk": "@@ -126,7 +130,7 @@ public void assertMultiValuesWithGenerateShardingKeyColumn() throws SQLException\n             }\n         }\n     }\n-\n+    ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0Mzk0OA=="}, "originalCommit": {"oid": "13062b4ab12ab24687b1f88830c3b7e54c08d4af"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTk0MjEwOnYy", "diffSide": "RIGHT", "path": "sharding-jdbc/sharding-jdbc-core/src/test/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShardingSpherePreparedStatementTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMzoxOTozNVrOGV1JFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOTo0MTo0N1rOGV94nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0Mzk1OQ==", "bodyText": "Please keep original indent", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425543959", "createdAt": "2020-05-15T03:19:35Z", "author": {"login": "terrymanu"}, "path": "sharding-jdbc/sharding-jdbc-core/src/test/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShardingSpherePreparedStatementTest.java", "diffHunk": "@@ -83,7 +87,7 @@ public void assertAddBatch() throws SQLException {\n             }\n         }\n     }\n-\n+    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13062b4ab12ab24687b1f88830c3b7e54c08d4af"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY4NzE5OQ==", "bodyText": "use 4 spaces.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425687199", "createdAt": "2020-05-15T09:41:47Z", "author": {"login": "neil4dong"}, "path": "sharding-jdbc/sharding-jdbc-core/src/test/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShardingSpherePreparedStatementTest.java", "diffHunk": "@@ -83,7 +87,7 @@ public void assertAddBatch() throws SQLException {\n             }\n         }\n     }\n-\n+    ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0Mzk1OQ=="}, "originalCommit": {"oid": "13062b4ab12ab24687b1f88830c3b7e54c08d4af"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTk0MzY0OnYy", "diffSide": "RIGHT", "path": "sharding-jdbc/sharding-jdbc-core/src/test/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShardingSpherePreparedStatementTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMzoyMDozNVrOGV1KGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMzoyMDozNVrOGV1KGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0NDIxNg==", "bodyText": "Please remove useless blank lines.\nIf we think use blank line to separate diff logic block, it is better extract them as a new private method.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425544216", "createdAt": "2020-05-15T03:20:35Z", "author": {"login": "terrymanu"}, "path": "sharding-jdbc/sharding-jdbc-core/src/test/java/org/apache/shardingsphere/shardingjdbc/jdbc/core/statement/ShardingSpherePreparedStatementTest.java", "diffHunk": "@@ -316,6 +320,77 @@ public void assertAddBatchWithGenerateKeyColumn() throws SQLException {\n         }\n     }\n     \n+    @Test\n+    public void assertAddOnDuplicateKey() throws SQLException {\n+        int itemId = 1;\n+        int userId1 = 101;\n+        int userId2 = 102;\n+        int orderId = 200;\n+        String status = \"init\";\n+        String updatedStatus = \"updated on duplicate key\";\n+        try (Connection connection = getShardingSphereDataSource().getConnection();\n+             PreparedStatement preparedStatement = connection.prepareStatement(INSERT_ON_DUPLICATE_KEY_SQL);\n+             PreparedStatement queryStatement = connection.prepareStatement(SELECT_SQL_WITH_PARAMETER_MARKER_RETURN_STATUS)) {\n+            preparedStatement.setInt(1, itemId);\n+            preparedStatement.setInt(2, orderId);\n+            preparedStatement.setInt(3, userId1);\n+            preparedStatement.setString(4, status);\n+            preparedStatement.setInt(5, itemId);\n+            preparedStatement.setInt(6, orderId);\n+            preparedStatement.setInt(7, userId2);\n+            preparedStatement.setString(8, status);\n+            preparedStatement.setString(9, updatedStatus);\n+            int result = preparedStatement.executeUpdate();\n+            assertThat(result, is(2));\n+            ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13062b4ab12ab24687b1f88830c3b7e54c08d4af"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0OTk0NTE1OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/statement/dml/InsertStatementContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMzoyMTozOVrOGV1LFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwMzoyMTozOVrOGV1LFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTU0NDQ3MA==", "bodyText": "Please fix javadoc, use words or {@code } to label class name", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425544470", "createdAt": "2020-05-15T03:21:39Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/statement/dml/InsertStatementContext.java", "diffHunk": "@@ -93,9 +110,20 @@ public InsertStatementContext(final SchemaMetaData schemaMetaData, final List<Ob\n         return result;\n     }\n     \n+    /**\n+     * Get OnDuplicateKeyUpdateParameters.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13062b4ab12ab24687b1f88830c3b7e54c08d4af"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MDczMzE5OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOTowODoyOVrOGV8wGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOTowODoyOVrOGV8wGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY2ODYzNA==", "bodyText": "Please use upper case for the first letter of java doc.", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425668634", "createdAt": "2020-05-15T09:08:29Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContext.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import lombok.Getter;\n+import lombok.ToString;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Getter\n+@ToString\n+public class OnDuplicateUpdateContext {\n+    private final int parametersCount;\n+    \n+    private final List<ExpressionSegment> valueExpressions;\n+    \n+    private final List<Object> parameters;\n+    \n+    private final List<ColumnSegment> columns;\n+    \n+    public OnDuplicateUpdateContext(final Collection<AssignmentSegment> assignments, final List<Object> parameters, final int parametersOffset) {\n+        List<ExpressionSegment> expressionSegments = assignments.stream().map(AssignmentSegment::getValue).collect(Collectors.toList());\n+        parametersCount = calculateParametersCount(expressionSegments);\n+        valueExpressions = getValueExpressions(expressionSegments);\n+        this.parameters = getParameters(parameters, parametersOffset);\n+        columns = assignments.stream().map(AssignmentSegment::getColumn).collect(Collectors.toList());\n+    }\n+    \n+    private int calculateParametersCount(final Collection<ExpressionSegment> assignments) {\n+        int result = 0;\n+        for (ExpressionSegment each : assignments) {\n+            if (each instanceof ParameterMarkerExpressionSegment) {\n+                result++;\n+            }\n+        }\n+        return result;\n+    }\n+    \n+    private List<ExpressionSegment> getValueExpressions(final Collection<ExpressionSegment> assignments) {\n+        List<ExpressionSegment> result = new ArrayList<>(assignments.size());\n+        result.addAll(assignments);\n+        return result;\n+    }\n+    \n+    private List<Object> getParameters(final List<Object> parameters, final int parametersOffset) {\n+        if (0 == parametersCount) {\n+            return Collections.emptyList();\n+        }\n+        List<Object> result = new ArrayList<>(parametersCount);\n+        result.addAll(parameters.subList(parametersOffset, parametersOffset + parametersCount));\n+        return result;\n+    }\n+    \n+    /**\n+     * Get value.\n+     *\n+     * @param index index\n+     * @return value\n+     */\n+    public Object getValue(final int index) {\n+        ExpressionSegment valueExpression = valueExpressions.get(index);\n+        return valueExpression instanceof ParameterMarkerExpressionSegment ? parameters.get(getParameterIndex(valueExpression)) : ((LiteralExpressionSegment) valueExpression).getLiterals();\n+    }\n+    \n+    private int getParameterIndex(final ExpressionSegment valueExpression) {\n+        int result = 0;\n+        for (ExpressionSegment each : valueExpressions) {\n+            if (valueExpression == each) {\n+                return result;\n+            }\n+            if (each instanceof ParameterMarkerExpressionSegment) {\n+                result++;\n+            }\n+        }\n+        throw new IllegalArgumentException(\"Can not get parameter index.\");\n+    }\n+    \n+    /**\n+     * get on duplicate key update column by index of this clause.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baf64d603bcb914432a8863d5da4f09032953e69"}, "originalPosition": 103}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MDczNDA1OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOTowODo0N1rOGV8wrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOTowODo0N1rOGV8wrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY2ODc4Mg==", "bodyText": "please remove . in @param", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425668782", "createdAt": "2020-05-15T09:08:47Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContext.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import lombok.Getter;\n+import lombok.ToString;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Getter\n+@ToString\n+public class OnDuplicateUpdateContext {\n+    private final int parametersCount;\n+    \n+    private final List<ExpressionSegment> valueExpressions;\n+    \n+    private final List<Object> parameters;\n+    \n+    private final List<ColumnSegment> columns;\n+    \n+    public OnDuplicateUpdateContext(final Collection<AssignmentSegment> assignments, final List<Object> parameters, final int parametersOffset) {\n+        List<ExpressionSegment> expressionSegments = assignments.stream().map(AssignmentSegment::getValue).collect(Collectors.toList());\n+        parametersCount = calculateParametersCount(expressionSegments);\n+        valueExpressions = getValueExpressions(expressionSegments);\n+        this.parameters = getParameters(parameters, parametersOffset);\n+        columns = assignments.stream().map(AssignmentSegment::getColumn).collect(Collectors.toList());\n+    }\n+    \n+    private int calculateParametersCount(final Collection<ExpressionSegment> assignments) {\n+        int result = 0;\n+        for (ExpressionSegment each : assignments) {\n+            if (each instanceof ParameterMarkerExpressionSegment) {\n+                result++;\n+            }\n+        }\n+        return result;\n+    }\n+    \n+    private List<ExpressionSegment> getValueExpressions(final Collection<ExpressionSegment> assignments) {\n+        List<ExpressionSegment> result = new ArrayList<>(assignments.size());\n+        result.addAll(assignments);\n+        return result;\n+    }\n+    \n+    private List<Object> getParameters(final List<Object> parameters, final int parametersOffset) {\n+        if (0 == parametersCount) {\n+            return Collections.emptyList();\n+        }\n+        List<Object> result = new ArrayList<>(parametersCount);\n+        result.addAll(parameters.subList(parametersOffset, parametersOffset + parametersCount));\n+        return result;\n+    }\n+    \n+    /**\n+     * Get value.\n+     *\n+     * @param index index\n+     * @return value\n+     */\n+    public Object getValue(final int index) {\n+        ExpressionSegment valueExpression = valueExpressions.get(index);\n+        return valueExpression instanceof ParameterMarkerExpressionSegment ? parameters.get(getParameterIndex(valueExpression)) : ((LiteralExpressionSegment) valueExpression).getLiterals();\n+    }\n+    \n+    private int getParameterIndex(final ExpressionSegment valueExpression) {\n+        int result = 0;\n+        for (ExpressionSegment each : valueExpressions) {\n+            if (valueExpression == each) {\n+                return result;\n+            }\n+            if (each instanceof ParameterMarkerExpressionSegment) {\n+                result++;\n+            }\n+        }\n+        throw new IllegalArgumentException(\"Can not get parameter index.\");\n+    }\n+    \n+    /**\n+     * get on duplicate key update column by index of this clause.\n+     * @param index index.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baf64d603bcb914432a8863d5da4f09032953e69"}, "originalPosition": 104}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MDczOTM3OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContext.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOToxMDoxNlrOGV80CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOToxMDoxNlrOGV80CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY2OTY0MA==", "bodyText": "please keep one line between with java doc and @param", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425669640", "createdAt": "2020-05-15T09:10:16Z", "author": {"login": "terrymanu"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/main/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContext.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import lombok.Getter;\n+import lombok.ToString;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@Getter\n+@ToString\n+public class OnDuplicateUpdateContext {\n+    private final int parametersCount;\n+    \n+    private final List<ExpressionSegment> valueExpressions;\n+    \n+    private final List<Object> parameters;\n+    \n+    private final List<ColumnSegment> columns;\n+    \n+    public OnDuplicateUpdateContext(final Collection<AssignmentSegment> assignments, final List<Object> parameters, final int parametersOffset) {\n+        List<ExpressionSegment> expressionSegments = assignments.stream().map(AssignmentSegment::getValue).collect(Collectors.toList());\n+        parametersCount = calculateParametersCount(expressionSegments);\n+        valueExpressions = getValueExpressions(expressionSegments);\n+        this.parameters = getParameters(parameters, parametersOffset);\n+        columns = assignments.stream().map(AssignmentSegment::getColumn).collect(Collectors.toList());\n+    }\n+    \n+    private int calculateParametersCount(final Collection<ExpressionSegment> assignments) {\n+        int result = 0;\n+        for (ExpressionSegment each : assignments) {\n+            if (each instanceof ParameterMarkerExpressionSegment) {\n+                result++;\n+            }\n+        }\n+        return result;\n+    }\n+    \n+    private List<ExpressionSegment> getValueExpressions(final Collection<ExpressionSegment> assignments) {\n+        List<ExpressionSegment> result = new ArrayList<>(assignments.size());\n+        result.addAll(assignments);\n+        return result;\n+    }\n+    \n+    private List<Object> getParameters(final List<Object> parameters, final int parametersOffset) {\n+        if (0 == parametersCount) {\n+            return Collections.emptyList();\n+        }\n+        List<Object> result = new ArrayList<>(parametersCount);\n+        result.addAll(parameters.subList(parametersOffset, parametersOffset + parametersCount));\n+        return result;\n+    }\n+    \n+    /**\n+     * Get value.\n+     *\n+     * @param index index\n+     * @return value\n+     */\n+    public Object getValue(final int index) {\n+        ExpressionSegment valueExpression = valueExpressions.get(index);\n+        return valueExpression instanceof ParameterMarkerExpressionSegment ? parameters.get(getParameterIndex(valueExpression)) : ((LiteralExpressionSegment) valueExpression).getLiterals();\n+    }\n+    \n+    private int getParameterIndex(final ExpressionSegment valueExpression) {\n+        int result = 0;\n+        for (ExpressionSegment each : valueExpressions) {\n+            if (valueExpression == each) {\n+                return result;\n+            }\n+            if (each instanceof ParameterMarkerExpressionSegment) {\n+                result++;\n+            }\n+        }\n+        throw new IllegalArgumentException(\"Can not get parameter index.\");\n+    }\n+    \n+    /**\n+     * get on duplicate key update column by index of this clause.\n+     * @param index index.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "baf64d603bcb914432a8863d5da4f09032953e69"}, "originalPosition": 104}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MDkwMDQ2OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOTo1ODoxMFrOGV-aLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOTo1ODoxMFrOGV-aLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY5NTc4OA==", "bodyText": "remove this empty line", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425695788", "createdAt": "2020-05-15T09:58:10Z", "author": {"login": "neil4dong"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.SimpleExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.value.identifier.IdentifierValue;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class OnDuplicateUpdateContextTest {\n+    \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void assertInstanceConstructedOk() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+\n+        Method calculateParametersCountMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"calculateParametersCount\", Collection.class);\n+        calculateParametersCountMethod.setAccessible(true);\n+        int calculateParametersCountResult = (int) calculateParametersCountMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getParametersCount(), is(calculateParametersCountResult));\n+\n+        Method getValueExpressionsMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getValueExpressions\", Collection.class);\n+        getValueExpressionsMethod.setAccessible(true);\n+        List<ExpressionSegment> getValueExpressionsResult = (List<ExpressionSegment>) getValueExpressionsMethod.invoke(onDuplicateUpdateContext, new Object[]{assignments});\n+        assertThat(onDuplicateUpdateContext.getValueExpressions(), is(getValueExpressionsResult));\n+\n+        Method getParametersMethod = OnDuplicateUpdateContext.class.getDeclaredMethod(\"getParameters\", List.class, int.class);\n+        getParametersMethod.setAccessible(true);\n+        List<Object> getParametersResult = (List<Object>) getParametersMethod.invoke(onDuplicateUpdateContext, new Object[]{parameters, parametersOffset});\n+        assertThat(onDuplicateUpdateContext.getParameters(), is(getParametersResult));\n+    }\n+    \n+    @Test\n+    public void assertGetValueWhenParameterMarker() {\n+        Collection<AssignmentSegment> assignments = makeParameterMarkerExpressionAssignmentSegment();\n+        String parameterValue1 = \"test1\";\n+        String parameterValue2 = \"test2\";\n+        List<Object> parameters = Lists.newArrayList(parameterValue1, parameterValue2);\n+        int parametersOffset = 0;\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+        Object valueFromInsertValueContext1 = onDuplicateUpdateContext.getValue(0);\n+        assertThat(valueFromInsertValueContext1, is(parameterValue1));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1721184aa9b632d5b0dde4feeb88a82c4bbc03d8"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MDkwMzc4OnYy", "diffSide": "RIGHT", "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOTo1OToyM1rOGV-cfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOTo1OToyM1rOGV-cfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY5NjM4Mg==", "bodyText": "remove this empty line", "url": "https://github.com/apache/shardingsphere/pull/5590#discussion_r425696382", "createdAt": "2020-05-15T09:59:23Z", "author": {"login": "neil4dong"}, "path": "shardingsphere-sql-parser/shardingsphere-sql-parser-binder/src/test/java/org/apache/shardingsphere/sql/parser/binder/segment/insert/values/OnDuplicateUpdateContextTest.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.sql.parser.binder.segment.insert.values;\n+\n+import com.google.common.collect.Lists;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.assignment.AssignmentSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.column.ColumnSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.ExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.LiteralExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.ParameterMarkerExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.segment.dml.expr.simple.SimpleExpressionSegment;\n+import org.apache.shardingsphere.sql.parser.sql.value.identifier.IdentifierValue;\n+import org.junit.Assert;\n+import org.junit.Test;\n+\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public final class OnDuplicateUpdateContextTest {\n+    \n+    @SuppressWarnings(\"unchecked\")\n+    @Test\n+    public void assertInstanceConstructedOk() throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {\n+        Collection<AssignmentSegment> assignments = Lists.newArrayList();\n+        List<Object> parameters = Collections.emptyList();\n+        int parametersOffset = 0;\n+        OnDuplicateUpdateContext onDuplicateUpdateContext = new OnDuplicateUpdateContext(assignments, parameters, parametersOffset);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1721184aa9b632d5b0dde4feeb88a82c4bbc03d8"}, "originalPosition": 50}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 876, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}