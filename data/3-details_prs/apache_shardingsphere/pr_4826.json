{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwMzQwMzI0", "number": 4826, "title": "issue-4785: Check uniformed with all actual tables' meta data in once when loading them", "bodyText": "Fixes #4785.", "createdAt": "2020-03-18T10:08:22Z", "url": "https://github.com/apache/shardingsphere/pull/4826", "merged": true, "mergeCommit": {"oid": "ed1603ac06089539042798ec14aa055cb45aef7c"}, "closed": true, "closedAt": "2020-03-19T05:19:06Z", "author": {"login": "JasonKing168"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO0ar5AH2gAyMzkwMzQwMzI0OmE3NDFiYWY0NDg1ZWVlYTI3ODI4ZWYzNzg3OGQ3ZjcxZjM3YmQzMmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPE6m_gFqTM3NzQzMDMxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a741baf4485eeea27828ef37878d7f71f37bd32b", "author": {"user": {"login": "JasonKing168", "name": "Jason King"}}, "url": "https://github.com/apache/shardingsphere/commit/a741baf4485eeea27828ef37878d7f71f37bd32b", "committedDate": "2020-03-18T10:05:14Z", "message": "issue-4785: Check uniformed with all actual tables' meta data in once when loading them."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2NzUyNzI3", "url": "https://github.com/apache/shardingsphere/pull/4826#pullrequestreview-376752727", "createdAt": "2020-03-18T10:53:04Z", "commit": {"oid": "a741baf4485eeea27828ef37878d7f71f37bd32b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDo1MzowNFrOF3_pQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMDo1NTozN1rOF3_vGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI1ODc1NQ==", "bodyText": "Please remove useless blank line", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394258755", "createdAt": "2020-03-18T10:53:04Z", "author": {"login": "terrymanu"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/ShardingMetaDataLoader.java", "diffHunk": "@@ -103,17 +104,25 @@ private SchemaMetaData loadDefaultSchemaMetaData() throws SQLException {\n         return actualDefaultDataSourceName.isPresent()\n                 ? SchemaMetaDataLoader.load(dataSourceMap.get(actualDefaultDataSourceName.get()), maxConnectionsSizePerQuery) : new SchemaMetaData(Collections.emptyMap());\n     }\n-    \n-    // TODO check all meta data in once\n+\n     private void checkUniformed(final String logicTableName, final Map<String, TableMetaData> actualTableMetaDataMap) {\n         ShardingTableMetaDataDecorator decorator = new ShardingTableMetaDataDecorator();\n         TableMetaData sample = decorator.decorate(actualTableMetaDataMap.values().iterator().next(), logicTableName, shardingRule);\n+        List<String[]> errorMetaDataList = new LinkedList<>();\n         for (Entry<String, TableMetaData> entry : actualTableMetaDataMap.entrySet()) {\n-            if (!sample.equals(decorator.decorate(entry.getValue(), logicTableName, shardingRule))) {\n-                throw new ShardingSphereException(\n-                        \"Cannot get uniformed table structure for logic table `%s` and actual table `%s`. The different meta data of actual tables are as follows:\\n%s\\n%s.\",\n-                        logicTableName, entry.getKey(), sample, entry.getValue());\n+            TableMetaData entryValue = entry.getValue();\n+            if (!sample.equals(decorator.decorate(entryValue, logicTableName, shardingRule))) {\n+                errorMetaDataList.add(new String[] {entry.getKey(), entryValue.toString()});\n+            }\n+        }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a741baf4485eeea27828ef37878d7f71f37bd32b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI2MDI1MA==", "bodyText": "The design List<String[]> is not clear, could you consider about define an object to process it?", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394260250", "createdAt": "2020-03-18T10:55:37Z", "author": {"login": "terrymanu"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/ShardingMetaDataLoader.java", "diffHunk": "@@ -103,17 +104,25 @@ private SchemaMetaData loadDefaultSchemaMetaData() throws SQLException {\n         return actualDefaultDataSourceName.isPresent()\n                 ? SchemaMetaDataLoader.load(dataSourceMap.get(actualDefaultDataSourceName.get()), maxConnectionsSizePerQuery) : new SchemaMetaData(Collections.emptyMap());\n     }\n-    \n-    // TODO check all meta data in once\n+\n     private void checkUniformed(final String logicTableName, final Map<String, TableMetaData> actualTableMetaDataMap) {\n         ShardingTableMetaDataDecorator decorator = new ShardingTableMetaDataDecorator();\n         TableMetaData sample = decorator.decorate(actualTableMetaDataMap.values().iterator().next(), logicTableName, shardingRule);\n+        List<String[]> errorMetaDataList = new LinkedList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a741baf4485eeea27828ef37878d7f71f37bd32b"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a4459d23ce44e7d83567bc759a6f8eb20a0a419", "author": {"user": {"login": "JasonKing168", "name": "Jason King"}}, "url": "https://github.com/apache/shardingsphere/commit/9a4459d23ce44e7d83567bc759a6f8eb20a0a419", "committedDate": "2020-03-18T11:48:24Z", "message": "issue-4785: Add Object for holding error meta data while checking uniformed table meta data configuration."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODI0NTQ1", "url": "https://github.com/apache/shardingsphere/pull/4826#pullrequestreview-376824545", "createdAt": "2020-03-18T12:41:29Z", "commit": {"oid": "9a4459d23ce44e7d83567bc759a6f8eb20a0a419"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMjo0MToyOVrOF4DKCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMjo0MToyOVrOF4DKCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMxNjI5OQ==", "bodyText": "why add a new class?", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394316299", "createdAt": "2020-03-18T12:41:29Z", "author": {"login": "kimmking"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/TableMetaDataViolation.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.core.metadata;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import org.apache.shardingsphere.sql.parser.binder.metadata.table.TableMetaData;\n+\n+/**\n+ * Violations holder for checking uniformed table meta data.\n+ */\n+@AllArgsConstructor\n+@Getter\n+class TableMetaDataViolation {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a4459d23ce44e7d83567bc759a6f8eb20a0a419"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODI2MzY2", "url": "https://github.com/apache/shardingsphere/pull/4826#pullrequestreview-376826366", "createdAt": "2020-03-18T12:44:06Z", "commit": {"oid": "9a4459d23ce44e7d83567bc759a6f8eb20a0a419"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMjo0NDowN1rOF4DPkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMjo0NDowN1rOF4DPkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMxNzcxNQ==", "bodyText": "This entity only used in one method, an inner class is better.", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394317715", "createdAt": "2020-03-18T12:44:07Z", "author": {"login": "kimmking"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/TableMetaDataViolation.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.core.metadata;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import org.apache.shardingsphere.sql.parser.binder.metadata.table.TableMetaData;\n+\n+/**\n+ * Violations holder for checking uniformed table meta data.\n+ */\n+@AllArgsConstructor\n+@Getter\n+class TableMetaDataViolation {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMxNjI5OQ=="}, "originalCommit": {"oid": "9a4459d23ce44e7d83567bc759a6f8eb20a0a419"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2ODQxMjA2", "url": "https://github.com/apache/shardingsphere/pull/4826#pullrequestreview-376841206", "createdAt": "2020-03-18T13:04:02Z", "commit": {"oid": "9a4459d23ce44e7d83567bc759a6f8eb20a0a419"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzowNDowMlrOF4D9iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxMzowODoyMFrOF4EHyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMyOTQ4Mw==", "bodyText": "How about use @RequiredArgsConstructor? It is better for final with fields.", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394329483", "createdAt": "2020-03-18T13:04:02Z", "author": {"login": "terrymanu"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/TableMetaDataViolation.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.core.metadata;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Getter;\n+import org.apache.shardingsphere.sql.parser.binder.metadata.table.TableMetaData;\n+\n+/**\n+ * Violations holder for checking uniformed table meta data.\n+ */\n+@AllArgsConstructor\n+@Getter\n+class TableMetaDataViolation {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a4459d23ce44e7d83567bc759a6f8eb20a0a419"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMzMDIyNw==", "bodyText": "It is better to add a space after symbol, such as , and :", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394330227", "createdAt": "2020-03-18T13:05:14Z", "author": {"login": "terrymanu"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/ShardingMetaDataLoader.java", "diffHunk": "@@ -103,17 +104,25 @@ private SchemaMetaData loadDefaultSchemaMetaData() throws SQLException {\n         return actualDefaultDataSourceName.isPresent()\n                 ? SchemaMetaDataLoader.load(dataSourceMap.get(actualDefaultDataSourceName.get()), maxConnectionsSizePerQuery) : new SchemaMetaData(Collections.emptyMap());\n     }\n-    \n-    // TODO check all meta data in once\n+\n     private void checkUniformed(final String logicTableName, final Map<String, TableMetaData> actualTableMetaDataMap) {\n         ShardingTableMetaDataDecorator decorator = new ShardingTableMetaDataDecorator();\n         TableMetaData sample = decorator.decorate(actualTableMetaDataMap.values().iterator().next(), logicTableName, shardingRule);\n+        List<TableMetaDataViolation> metaDataViolationList = new LinkedList<>();\n         for (Entry<String, TableMetaData> entry : actualTableMetaDataMap.entrySet()) {\n-            if (!sample.equals(decorator.decorate(entry.getValue(), logicTableName, shardingRule))) {\n-                throw new ShardingSphereException(\n-                        \"Cannot get uniformed table structure for logic table `%s` and actual table `%s`. The different meta data of actual tables are as follows:\\n%s\\n%s.\",\n-                        logicTableName, entry.getKey(), sample, entry.getValue());\n+            TableMetaData entryValue = entry.getValue();\n+            if (!sample.equals(decorator.decorate(entryValue, logicTableName, shardingRule))) {\n+                metaDataViolationList.add(new TableMetaDataViolation(entry.getKey(), entryValue));\n+            }\n+        }\n+        if (!metaDataViolationList.isEmpty()) {\n+            StringBuilder exceptionMessageBuilder = new StringBuilder(\"Cannot get uniformed table structure for logic table `%s`\"\n+                    + \",it has different meta data of actual tables are as follows:\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a4459d23ce44e7d83567bc759a6f8eb20a0a419"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMzMDkwOA==", "bodyText": "If for each only, maybe we can replace List as Collection", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394330908", "createdAt": "2020-03-18T13:06:24Z", "author": {"login": "terrymanu"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/ShardingMetaDataLoader.java", "diffHunk": "@@ -103,17 +104,25 @@ private SchemaMetaData loadDefaultSchemaMetaData() throws SQLException {\n         return actualDefaultDataSourceName.isPresent()\n                 ? SchemaMetaDataLoader.load(dataSourceMap.get(actualDefaultDataSourceName.get()), maxConnectionsSizePerQuery) : new SchemaMetaData(Collections.emptyMap());\n     }\n-    \n-    // TODO check all meta data in once\n+\n     private void checkUniformed(final String logicTableName, final Map<String, TableMetaData> actualTableMetaDataMap) {\n         ShardingTableMetaDataDecorator decorator = new ShardingTableMetaDataDecorator();\n         TableMetaData sample = decorator.decorate(actualTableMetaDataMap.values().iterator().next(), logicTableName, shardingRule);\n+        List<TableMetaDataViolation> metaDataViolationList = new LinkedList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a4459d23ce44e7d83567bc759a6f8eb20a0a419"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMzMTE0OQ==", "bodyText": "violations is better than metaDataViolationList", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394331149", "createdAt": "2020-03-18T13:06:49Z", "author": {"login": "terrymanu"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/ShardingMetaDataLoader.java", "diffHunk": "@@ -103,17 +104,25 @@ private SchemaMetaData loadDefaultSchemaMetaData() throws SQLException {\n         return actualDefaultDataSourceName.isPresent()\n                 ? SchemaMetaDataLoader.load(dataSourceMap.get(actualDefaultDataSourceName.get()), maxConnectionsSizePerQuery) : new SchemaMetaData(Collections.emptyMap());\n     }\n-    \n-    // TODO check all meta data in once\n+\n     private void checkUniformed(final String logicTableName, final Map<String, TableMetaData> actualTableMetaDataMap) {\n         ShardingTableMetaDataDecorator decorator = new ShardingTableMetaDataDecorator();\n         TableMetaData sample = decorator.decorate(actualTableMetaDataMap.values().iterator().next(), logicTableName, shardingRule);\n+        List<TableMetaDataViolation> metaDataViolationList = new LinkedList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a4459d23ce44e7d83567bc759a6f8eb20a0a419"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMzMTY2NA==", "bodyText": "How about just named entryValue as tableMetaData directly?", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394331664", "createdAt": "2020-03-18T13:07:40Z", "author": {"login": "terrymanu"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/ShardingMetaDataLoader.java", "diffHunk": "@@ -103,17 +104,25 @@ private SchemaMetaData loadDefaultSchemaMetaData() throws SQLException {\n         return actualDefaultDataSourceName.isPresent()\n                 ? SchemaMetaDataLoader.load(dataSourceMap.get(actualDefaultDataSourceName.get()), maxConnectionsSizePerQuery) : new SchemaMetaData(Collections.emptyMap());\n     }\n-    \n-    // TODO check all meta data in once\n+\n     private void checkUniformed(final String logicTableName, final Map<String, TableMetaData> actualTableMetaDataMap) {\n         ShardingTableMetaDataDecorator decorator = new ShardingTableMetaDataDecorator();\n         TableMetaData sample = decorator.decorate(actualTableMetaDataMap.values().iterator().next(), logicTableName, shardingRule);\n+        List<TableMetaDataViolation> metaDataViolationList = new LinkedList<>();\n         for (Entry<String, TableMetaData> entry : actualTableMetaDataMap.entrySet()) {\n-            if (!sample.equals(decorator.decorate(entry.getValue(), logicTableName, shardingRule))) {\n-                throw new ShardingSphereException(\n-                        \"Cannot get uniformed table structure for logic table `%s` and actual table `%s`. The different meta data of actual tables are as follows:\\n%s\\n%s.\",\n-                        logicTableName, entry.getKey(), sample, entry.getValue());\n+            TableMetaData entryValue = entry.getValue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a4459d23ce44e7d83567bc759a6f8eb20a0a419"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDMzMjEwNg==", "bodyText": "It is better to extract a new private method here", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394332106", "createdAt": "2020-03-18T13:08:20Z", "author": {"login": "terrymanu"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/ShardingMetaDataLoader.java", "diffHunk": "@@ -103,17 +104,25 @@ private SchemaMetaData loadDefaultSchemaMetaData() throws SQLException {\n         return actualDefaultDataSourceName.isPresent()\n                 ? SchemaMetaDataLoader.load(dataSourceMap.get(actualDefaultDataSourceName.get()), maxConnectionsSizePerQuery) : new SchemaMetaData(Collections.emptyMap());\n     }\n-    \n-    // TODO check all meta data in once\n+\n     private void checkUniformed(final String logicTableName, final Map<String, TableMetaData> actualTableMetaDataMap) {\n         ShardingTableMetaDataDecorator decorator = new ShardingTableMetaDataDecorator();\n         TableMetaData sample = decorator.decorate(actualTableMetaDataMap.values().iterator().next(), logicTableName, shardingRule);\n+        List<TableMetaDataViolation> metaDataViolationList = new LinkedList<>();\n         for (Entry<String, TableMetaData> entry : actualTableMetaDataMap.entrySet()) {\n-            if (!sample.equals(decorator.decorate(entry.getValue(), logicTableName, shardingRule))) {\n-                throw new ShardingSphereException(\n-                        \"Cannot get uniformed table structure for logic table `%s` and actual table `%s`. The different meta data of actual tables are as follows:\\n%s\\n%s.\",\n-                        logicTableName, entry.getKey(), sample, entry.getValue());\n+            TableMetaData entryValue = entry.getValue();\n+            if (!sample.equals(decorator.decorate(entryValue, logicTableName, shardingRule))) {\n+                metaDataViolationList.add(new TableMetaDataViolation(entry.getKey(), entryValue));\n+            }\n+        }\n+        if (!metaDataViolationList.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a4459d23ce44e7d83567bc759a6f8eb20a0a419"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "574420f43c042f3243e7af63c8daf067b791dadc", "author": {"user": {"login": "JasonKing168", "name": "Jason King"}}, "url": "https://github.com/apache/shardingsphere/commit/574420f43c042f3243e7af63c8daf067b791dadc", "committedDate": "2020-03-18T14:18:50Z", "message": "issue-4785: Move the new class as inner class; extract private method and rename some variables."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2OTI4NTAw", "url": "https://github.com/apache/shardingsphere/pull/4826#pullrequestreview-376928500", "createdAt": "2020-03-18T14:40:07Z", "commit": {"oid": "574420f43c042f3243e7af63c8daf067b791dadc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNDo0MDowN1rOF4IFhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNDo0MDowN1rOF4IFhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM5NzA2Mg==", "bodyText": "why add accessLevel", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394397062", "createdAt": "2020-03-18T14:40:07Z", "author": {"login": "kimmking"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/ShardingMetaDataLoader.java", "diffHunk": "@@ -103,17 +108,43 @@ private SchemaMetaData loadDefaultSchemaMetaData() throws SQLException {\n         return actualDefaultDataSourceName.isPresent()\n                 ? SchemaMetaDataLoader.load(dataSourceMap.get(actualDefaultDataSourceName.get()), maxConnectionsSizePerQuery) : new SchemaMetaData(Collections.emptyMap());\n     }\n-    \n-    // TODO check all meta data in once\n+\n     private void checkUniformed(final String logicTableName, final Map<String, TableMetaData> actualTableMetaDataMap) {\n         ShardingTableMetaDataDecorator decorator = new ShardingTableMetaDataDecorator();\n         TableMetaData sample = decorator.decorate(actualTableMetaDataMap.values().iterator().next(), logicTableName, shardingRule);\n+        Collection<TableMetaDataViolation> metaDataViolations = new LinkedList<>();\n+        compareAllTableMetaData(metaDataViolations, sample, decorator, logicTableName, actualTableMetaDataMap);\n+        throwExceptionIfNecessary(metaDataViolations, logicTableName);\n+    }\n+\n+    private void compareAllTableMetaData(final Collection<TableMetaDataViolation> metaDataViolations, final TableMetaData sample,\n+                      final ShardingTableMetaDataDecorator decorator, final String logicTableName, final Map<String, TableMetaData> actualTableMetaDataMap) {\n         for (Entry<String, TableMetaData> entry : actualTableMetaDataMap.entrySet()) {\n-            if (!sample.equals(decorator.decorate(entry.getValue(), logicTableName, shardingRule))) {\n-                throw new ShardingSphereException(\n-                        \"Cannot get uniformed table structure for logic table `%s` and actual table `%s`. The different meta data of actual tables are as follows:\\n%s\\n%s.\",\n-                        logicTableName, entry.getKey(), sample, entry.getValue());\n+            TableMetaData tableMetaData = entry.getValue();\n+            if (!sample.equals(decorator.decorate(tableMetaData, logicTableName, shardingRule))) {\n+                metaDataViolations.add(new TableMetaDataViolation(entry.getKey(), tableMetaData));\n             }\n         }\n     }\n+\n+    private void throwExceptionIfNecessary(final Collection<TableMetaDataViolation> metaDataViolations, final String logicTableName) {\n+        if (!metaDataViolations.isEmpty()) {\n+            StringBuilder exceptionMessageBuilder = new StringBuilder(\"Cannot get uniformed table structure for logic table `%s`,\"\n+                    + \" it has different meta data of actual tables are as follows: \");\n+            for (TableMetaDataViolation each : metaDataViolations) {\n+                exceptionMessageBuilder.append(\"\\nactual table: \").append(each.getActualTableName())\n+                        .append(\", meta data: \").append(each.getTableMetaData());\n+            }\n+            throw new ShardingSphereException(exceptionMessageBuilder.toString(), logicTableName);\n+        }\n+    }\n+\n+    @AllArgsConstructor(access = AccessLevel.PACKAGE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "574420f43c042f3243e7af63c8daf067b791dadc"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2OTMxNjM3", "url": "https://github.com/apache/shardingsphere/pull/4826#pullrequestreview-376931637", "createdAt": "2020-03-18T14:43:14Z", "commit": {"oid": "574420f43c042f3243e7af63c8daf067b791dadc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNDo0MzoxNVrOF4IPAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOFQxNDo0MzoxNVrOF4IPAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDM5OTQ4OQ==", "bodyText": "Collection should be LinkedList.", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394399489", "createdAt": "2020-03-18T14:43:15Z", "author": {"login": "kimmking"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/ShardingMetaDataLoader.java", "diffHunk": "@@ -103,17 +108,43 @@ private SchemaMetaData loadDefaultSchemaMetaData() throws SQLException {\n         return actualDefaultDataSourceName.isPresent()\n                 ? SchemaMetaDataLoader.load(dataSourceMap.get(actualDefaultDataSourceName.get()), maxConnectionsSizePerQuery) : new SchemaMetaData(Collections.emptyMap());\n     }\n-    \n-    // TODO check all meta data in once\n+\n     private void checkUniformed(final String logicTableName, final Map<String, TableMetaData> actualTableMetaDataMap) {\n         ShardingTableMetaDataDecorator decorator = new ShardingTableMetaDataDecorator();\n         TableMetaData sample = decorator.decorate(actualTableMetaDataMap.values().iterator().next(), logicTableName, shardingRule);\n+        Collection<TableMetaDataViolation> metaDataViolations = new LinkedList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "574420f43c042f3243e7af63c8daf067b791dadc"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b84ee3d878206685b4d0545f25ca5c13c319864f", "author": {"user": {"login": "JasonKing168", "name": "Jason King"}}, "url": "https://github.com/apache/shardingsphere/commit/b84ee3d878206685b4d0545f25ca5c13c319864f", "committedDate": "2020-03-18T14:57:01Z", "message": "issue-4785: Add final for class and its fields; remove inner class accessLevel, etc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75905b0b2cf7228218e07bfc647e0063120a5a01", "author": {"user": {"login": "JasonKing168", "name": "Jason King"}}, "url": "https://github.com/apache/shardingsphere/commit/75905b0b2cf7228218e07bfc647e0063120a5a01", "committedDate": "2020-03-18T14:59:05Z", "message": "issue-4785: Add final for class and its fields; remove inner class accessLevel, etc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae9343ba555e4a474487faf56df59f549732d366", "author": {"user": {"login": "JasonKing168", "name": "Jason King"}}, "url": "https://github.com/apache/shardingsphere/commit/ae9343ba555e4a474487faf56df59f549732d366", "committedDate": "2020-03-18T16:00:47Z", "message": "issue-4785: A few more better readable optimizations."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MDQ0NTgy", "url": "https://github.com/apache/shardingsphere/pull/4826#pullrequestreview-377044582", "createdAt": "2020-03-18T16:40:55Z", "commit": {"oid": "ae9343ba555e4a474487faf56df59f549732d366"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76735b3e36a1108075e6d1e890d24384f9f24ad0", "author": {"user": {"login": "JasonKing168", "name": "Jason King"}}, "url": "https://github.com/apache/shardingsphere/commit/76735b3e36a1108075e6d1e890d24384f9f24ad0", "committedDate": "2020-03-18T17:04:51Z", "message": "issue-4785: Optimize exception details."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3Mzc5MTg5", "url": "https://github.com/apache/shardingsphere/pull/4826#pullrequestreview-377379189", "createdAt": "2020-03-19T02:22:00Z", "commit": {"oid": "76735b3e36a1108075e6d1e890d24384f9f24ad0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwMjoyMjowMFrOF4d6FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQwMjoyMjowMFrOF4d6FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDc1NDU4MA==", "bodyText": "unnecessary variable", "url": "https://github.com/apache/shardingsphere/pull/4826#discussion_r394754580", "createdAt": "2020-03-19T02:22:00Z", "author": {"login": "kimmking"}, "path": "sharding-core/sharding-core-common/src/main/java/org/apache/shardingsphere/core/metadata/ShardingMetaDataLoader.java", "diffHunk": "@@ -103,17 +108,37 @@ private SchemaMetaData loadDefaultSchemaMetaData() throws SQLException {\n         return actualDefaultDataSourceName.isPresent()\n                 ? SchemaMetaDataLoader.load(dataSourceMap.get(actualDefaultDataSourceName.get()), maxConnectionsSizePerQuery) : new SchemaMetaData(Collections.emptyMap());\n     }\n-    \n-    // TODO check all meta data in once\n+\n     private void checkUniformed(final String logicTableName, final Map<String, TableMetaData> actualTableMetaDataMap) {\n         ShardingTableMetaDataDecorator decorator = new ShardingTableMetaDataDecorator();\n         TableMetaData sample = decorator.decorate(actualTableMetaDataMap.values().iterator().next(), logicTableName, shardingRule);\n+        Collection<TableMetaDataViolation> violations = new LinkedList<>();\n         for (Entry<String, TableMetaData> entry : actualTableMetaDataMap.entrySet()) {\n-            if (!sample.equals(decorator.decorate(entry.getValue(), logicTableName, shardingRule))) {\n-                throw new ShardingSphereException(\n-                        \"Cannot get uniformed table structure for logic table `%s` and actual table `%s`. The different meta data of actual tables are as follows:\\n%s\\n%s.\",\n-                        logicTableName, entry.getKey(), sample, entry.getValue());\n+            TableMetaData tableMetaData = entry.getValue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "76735b3e36a1108075e6d1e890d24384f9f24ad0"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21eef818f4340a0eecb1a861360b0562289f6f6a", "author": {"user": {"login": "JasonKing168", "name": "Jason King"}}, "url": "https://github.com/apache/shardingsphere/commit/21eef818f4340a0eecb1a861360b0562289f6f6a", "committedDate": "2020-03-19T02:41:46Z", "message": "issue-4785: Remove unnecessary local variable."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f70bbb5ba1dc00f28f73e7a374b419cdc81b092b", "author": {"user": {"login": "JasonKing168", "name": "Jason King"}}, "url": "https://github.com/apache/shardingsphere/commit/f70bbb5ba1dc00f28f73e7a374b419cdc81b092b", "committedDate": "2020-03-19T03:59:50Z", "message": "issue-4785: Remove an unnecessary append operation for initializing error message."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3NDMwMzEz", "url": "https://github.com/apache/shardingsphere/pull/4826#pullrequestreview-377430313", "createdAt": "2020-03-19T05:18:35Z", "commit": {"oid": "f70bbb5ba1dc00f28f73e7a374b419cdc81b092b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3797, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}