{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MzAwOTM2", "number": 6860, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNDozODozNlrOEY42xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzo1NTozNFrOEY7-OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTMyODA2OnYy", "diffSide": "RIGHT", "path": "shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLMd5Digest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNDozODozNlrOHBZdKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNDozODozNlrOHBZdKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIyNzY4OQ==", "bodyText": "We can't replace BSD-2-Clause License header with Apache 2.0 License.\nBSD-2-Clause License requests: Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.\nThe actual PasswordMessage can be computed in SQL as concat('md5', md5(concat(md5(concat(password, username)), random-salt))). (Keep in mind the md5() function returns its result as a hex string.)", "url": "https://github.com/apache/shardingsphere/pull/6860#discussion_r471227689", "createdAt": "2020-08-17T04:38:36Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLMd5Digest.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c4bc6ab8b282f171128dd5ec738774b658e121"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTUwNDg3OnYy", "diffSide": "RIGHT", "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLAuthenticationMD5PasswordPacket.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjoyMDo1N1rOHBbC3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjoyMDo1N1rOHBbC3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1MzcyNA==", "bodyText": "What does (B) mean? If it means back end, please don't use abbreviation.", "url": "https://github.com/apache/shardingsphere/pull/6860#discussion_r471253724", "createdAt": "2020-08-17T06:20:57Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLAuthenticationMD5PasswordPacket.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.db.protocol.postgresql.packet.handshake;\n+\n+import lombok.Getter;\n+import org.apache.shardingsphere.db.protocol.postgresql.packet.PostgreSQLPacket;\n+import org.apache.shardingsphere.db.protocol.postgresql.packet.command.PostgreSQLCommandPacketType;\n+import org.apache.shardingsphere.db.protocol.postgresql.payload.PostgreSQLPacketPayload;\n+\n+/**\n+ * AuthenticationMD5Password (B) packet for PostgreSQL.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d90bf8f3ee592f8f43970317c745c53018803128"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTUwNTU1OnYy", "diffSide": "RIGHT", "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLPasswordMessagePacket.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjoyMToxNlrOHBbDRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjoyMToxNlrOHBbDRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1MzgyOA==", "bodyText": "What does (F) mean?", "url": "https://github.com/apache/shardingsphere/pull/6860#discussion_r471253828", "createdAt": "2020-08-17T06:21:16Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLPasswordMessagePacket.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.db.protocol.postgresql.packet.handshake;\n+\n+import lombok.Getter;\n+import org.apache.shardingsphere.db.protocol.postgresql.packet.PostgreSQLPacket;\n+import org.apache.shardingsphere.db.protocol.postgresql.packet.command.PostgreSQLCommandPacketType;\n+import org.apache.shardingsphere.db.protocol.postgresql.payload.PostgreSQLPacketPayload;\n+\n+/**\n+ * PasswordMessage (F) packet for PostgreSQL.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d90bf8f3ee592f8f43970317c745c53018803128"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTU3MzU3OnYy", "diffSide": "RIGHT", "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/constant/PostgreSQLErrorCode.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo1MDo0OVrOHBbrfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo1MDo0OVrOHBbrfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2NDEyNw==", "bodyText": "When will this function be called?", "url": "https://github.com/apache/shardingsphere/pull/6860#discussion_r471264127", "createdAt": "2020-08-17T06:50:49Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/constant/PostgreSQLErrorCode.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.db.protocol.postgresql.constant;\n+\n+/**\n+ * PostgreSQL error code.\n+ *\n+ * @see <a href=\"https://www.postgresql.org/docs/12/errcodes-appendix.html\">Appendix A. PostgreSQL Error Codes</a>\n+ */\n+public enum PostgreSQLErrorCode {\n+    \n+    SUCCESSFUL_COMPLETION(\"00000\", \"successful_completion\"),\n+    WARNING(\"01000\", \"warning\"),\n+    DYNAMIC_RESULT_SETS_RETURNED(\"0100C\", \"dynamic_result_sets_returned\"),\n+    IMPLICIT_ZERO_BIT_PADDING(\"01008\", \"implicit_zero_bit_padding\"),\n+    NULL_VALUE_ELIMINATED_IN_SET_FUNCTION(\"01003\", \"null_value_eliminated_in_set_function\"),\n+    PRIVILEGE_NOT_GRANTED(\"01007\", \"privilege_not_granted\"),\n+    PRIVILEGE_NOT_REVOKED(\"01006\", \"privilege_not_revoked\"),\n+    STRING_DATA_RIGHT_TRUNCATION(\"01004\", \"string_data_right_truncation\"),\n+    DEPRECATED_FEATURE(\"01P01\", \"deprecated_feature\"),\n+    CONNECTION_EXCEPTION(\"08000\", \"connection_exception\"),\n+    CONNECTION_DOES_NOT_EXIST(\"08003\", \"connection_does_not_exist\"),\n+    CONNECTION_FAILURE(\"08006\", \"connection_failure\"),\n+    SQLCLIENT_UNABLE_TO_ESTABLISH_SQLCONNECTION(\"08001\", \"sqlclient_unable_to_establish_sqlconnection\"),\n+    SQLSERVER_REJECTED_ESTABLISHMENT_OF_SQLCONNECTION(\"08004\", \"sqlserver_rejected_establishment_of_sqlconnection\"),\n+    TRANSACTION_RESOLUTION_UNKNOWN(\"08007\", \"transaction_resolution_unknown\"),\n+    PROTOCOL_VIOLATION(\"08P01\", \"protocol_violation\"),\n+    INVALID_AUTHORIZATION_SPECIFICATION(\"28000\", \"invalid_authorization_specification\"),\n+    INVALID_PASSWORD(\"28P01\", \"invalid_password\"),\n+    INVALID_CATALOG_NAME(\"3D000\", \"invalid_catalog_name\"),\n+    INVALID_SCHEMA_NAME(\"3F000\", \"invalid_schema_name\"),;\n+    \n+    private final String errorCode;\n+    \n+    private final String conditionName;\n+    \n+    PostgreSQLErrorCode(final String errorCode, final String conditionName) {\n+        this.errorCode = errorCode;\n+        this.conditionName = conditionName;\n+    }\n+    \n+    /**\n+     * Get error code.\n+     *\n+     * @return error code\n+     */\n+    public String getErrorCode() {\n+        return errorCode;\n+    }\n+    \n+    /**\n+     * Get condition name.\n+     *\n+     * @return condition name\n+     */\n+    public String getConditionName() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d90bf8f3ee592f8f43970317c745c53018803128"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTU4NDgzOnYy", "diffSide": "RIGHT", "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLAuthenticationMD5PasswordPacket.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo1NDo1NVrOHBbx4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo1NDo1NVrOHBbx4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2NTc2MA==", "bodyText": "To a final class", "url": "https://github.com/apache/shardingsphere/pull/6860#discussion_r471265760", "createdAt": "2020-08-17T06:54:55Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLAuthenticationMD5PasswordPacket.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.db.protocol.postgresql.packet.handshake;\n+\n+import lombok.Getter;\n+import org.apache.shardingsphere.db.protocol.postgresql.packet.PostgreSQLPacket;\n+import org.apache.shardingsphere.db.protocol.postgresql.packet.command.PostgreSQLCommandPacketType;\n+import org.apache.shardingsphere.db.protocol.postgresql.payload.PostgreSQLPacketPayload;\n+\n+/**\n+ * AuthenticationMD5Password (B) packet for PostgreSQL.\n+ */\n+public class PostgreSQLAuthenticationMD5PasswordPacket implements PostgreSQLPacket {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d90bf8f3ee592f8f43970317c745c53018803128"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTU4Njc1OnYy", "diffSide": "RIGHT", "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLPasswordMessagePacket.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo1NTozNVrOHBbzAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo1NTozNVrOHBbzAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2NjA0OA==", "bodyText": "To a final class", "url": "https://github.com/apache/shardingsphere/pull/6860#discussion_r471266048", "createdAt": "2020-08-17T06:55:35Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLPasswordMessagePacket.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.db.protocol.postgresql.packet.handshake;\n+\n+import lombok.Getter;\n+import org.apache.shardingsphere.db.protocol.postgresql.packet.PostgreSQLPacket;\n+import org.apache.shardingsphere.db.protocol.postgresql.packet.command.PostgreSQLCommandPacketType;\n+import org.apache.shardingsphere.db.protocol.postgresql.payload.PostgreSQLPacketPayload;\n+\n+/**\n+ * PasswordMessage (F) packet for PostgreSQL.\n+ */\n+public class PostgreSQLPasswordMessagePacket implements PostgreSQLPacket {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d90bf8f3ee592f8f43970317c745c53018803128"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTU5MDQwOnYy", "diffSide": "RIGHT", "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLRandomGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo1Njo1MVrOHBb1Lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo1Njo1MVrOHBb1Lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2NjYwNg==", "bodyText": "To a final class", "url": "https://github.com/apache/shardingsphere/pull/6860#discussion_r471266606", "createdAt": "2020-08-17T06:56:51Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-db-protocol/shardingsphere-db-protocol-postgresql/src/main/java/org/apache/shardingsphere/db/protocol/postgresql/packet/handshake/PostgreSQLRandomGenerator.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.db.protocol.postgresql.packet.handshake;\n+\n+import java.util.concurrent.ThreadLocalRandom;\n+import lombok.AccessLevel;\n+import lombok.NoArgsConstructor;\n+\n+/**\n+ * Random generator for PostgreSQL.\n+ */\n+@NoArgsConstructor(access = AccessLevel.PRIVATE)\n+public class PostgreSQLRandomGenerator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d90bf8f3ee592f8f43970317c745c53018803128"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTc3ODczOnYy", "diffSide": "RIGHT", "path": "shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLAuthenticationEngine.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzozNzowNFrOHBdnqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzozNzowNFrOHBdnqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5NTkxNQ==", "bodyText": "Don't have to use final for local variable.", "url": "https://github.com/apache/shardingsphere/pull/6860#discussion_r471295915", "createdAt": "2020-08-17T07:37:04Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLAuthenticationEngine.java", "diffHunk": "@@ -58,23 +69,64 @@ public boolean auth(final ChannelHandlerContext context, final PacketPayload pay\n             return false;\n         }\n         payload.getByteBuf().resetReaderIndex();\n-        PostgreSQLComStartupPacket comStartupPacket = new PostgreSQLComStartupPacket((PostgreSQLPacketPayload) payload);\n-        String databaseName = comStartupPacket.getParametersMap().get(DATABASE_NAME_KEYWORD);\n-        if (!Strings.isNullOrEmpty(databaseName) && !ProxySchemaContexts.getInstance().schemaExists(databaseName)) {\n-            PostgreSQLErrorResponsePacket responsePacket = new PostgreSQLErrorResponsePacket();\n-            responsePacket.addField(PostgreSQLErrorResponsePacket.FIELD_TYPE_SEVERITY, \"FATAL\");\n-            responsePacket.addField(PostgreSQLErrorResponsePacket.FIELD_TYPE_CODE, \"3D000\");\n-            responsePacket.addField(PostgreSQLErrorResponsePacket.FIELD_TYPE_MESSAGE, String.format(\"database \\\"%s\\\" does not exist\", databaseName));\n-            context.writeAndFlush(responsePacket);\n+        if (!startupMessageReceived.get()) {\n+            PostgreSQLComStartupPacket comStartupPacket = new PostgreSQLComStartupPacket((PostgreSQLPacketPayload) payload);\n+            startupMessageReceived.set(true);\n+            String databaseName = comStartupPacket.getParametersMap().get(DATABASE_NAME_KEYWORD);\n+            if (!Strings.isNullOrEmpty(databaseName) && !ProxySchemaContexts.getInstance().schemaExists(databaseName)) {\n+                PostgreSQLErrorResponsePacket responsePacket = createPostgreSQLErrorResponsePacket(PostgreSQLErrorCode.INVALID_CATALOG_NAME,\n+                    String.format(\"database \\\"%s\\\" does not exist\", databaseName));\n+                context.writeAndFlush(responsePacket);\n+                context.close();\n+                return false;\n+            }\n+            backendConnection.setCurrentSchema(databaseName);\n+            String userName = comStartupPacket.getParametersMap().get(USER_NAME_KEYWORD);\n+            if (null == userName || userName.isEmpty()) {\n+                PostgreSQLErrorResponsePacket responsePacket = createPostgreSQLErrorResponsePacket(PostgreSQLErrorCode.SQLSERVER_REJECTED_ESTABLISHMENT_OF_SQLCONNECTION,\n+                    \"user not set in StartupMessage\");\n+                context.writeAndFlush(responsePacket);\n+                context.close();\n+                return false;\n+            }\n+            backendConnection.setUserName(userName);\n+            md5Salt = PostgreSQLRandomGenerator.getInstance().generateRandomBytes(4);\n+            context.writeAndFlush(new PostgreSQLAuthenticationMD5PasswordPacket(md5Salt));\n             return false;\n+        } else {\n+            final char messageType = (char) ((PostgreSQLPacketPayload) payload).readInt1();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d90bf8f3ee592f8f43970317c745c53018803128"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTc5MjY1OnYy", "diffSide": "RIGHT", "path": "shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLAuthenticationHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzo0MToxNlrOHBdvwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzo0MToxNlrOHBdvwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5Nzk4NQ==", "bodyText": "Please don't use abbreviation.", "url": "https://github.com/apache/shardingsphere/pull/6860#discussion_r471297985", "createdAt": "2020-08-17T07:41:16Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLAuthenticationHandler.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.shardingsphere.proxy.frontend.postgresql.auth;\n+\n+import java.security.MessageDigest;\n+import java.util.Map;\n+import org.apache.commons.codec.binary.Hex;\n+import org.apache.commons.codec.digest.DigestUtils;\n+import org.apache.shardingsphere.db.protocol.postgresql.constant.PostgreSQLErrorCode;\n+import org.apache.shardingsphere.db.protocol.postgresql.packet.handshake.PostgreSQLPasswordMessagePacket;\n+import org.apache.shardingsphere.infra.auth.ProxyUser;\n+import org.apache.shardingsphere.proxy.backend.schema.ProxySchemaContexts;\n+\n+/**\n+ * Authentication handler for PostgreSQL.\n+ */\n+public class PostgreSQLAuthenticationHandler {\n+    \n+    /**\n+     * Login.\n+     *\n+     * @param userName              user name\n+     * @param databaseName          database name\n+     * @param md5Salt               md5 salt\n+     * @param passwordMessagePacket password message packet\n+     * @return PostgreSQLLoginResult\n+     */\n+    public static PostgreSQLLoginResult loginWithMd5Password(final String userName, final String databaseName, final byte[] md5Salt, final PostgreSQLPasswordMessagePacket passwordMessagePacket) {\n+        ProxyUser proxyUser = null;\n+        for (Map.Entry<String, ProxyUser> entry : ProxySchemaContexts.getInstance().getSchemaContexts().getAuthentication().getUsers().entrySet()) {\n+            if (entry.getKey().equals(userName)) {\n+                proxyUser = entry.getValue();\n+                break;\n+            }\n+        }\n+        if (null == proxyUser) {\n+            return new PostgreSQLLoginResult(PostgreSQLErrorCode.INVALID_AUTHORIZATION_SPECIFICATION, \"unknown userName: \" + userName);\n+        }\n+        \n+        String md5Digest = passwordMessagePacket.getMd5Digest();\n+        String expectedMd5Digest = md5Encode(userName, proxyUser.getPassword(), md5Salt);\n+        if (!expectedMd5Digest.equals(md5Digest)) {\n+            return new PostgreSQLLoginResult(PostgreSQLErrorCode.INVALID_PASSWORD, \"bad md5 password\");\n+        }\n+        \n+        if (!proxyUser.getAuthorizedSchemas().contains(databaseName)) {\n+            return new PostgreSQLLoginResult(PostgreSQLErrorCode.PRIVILEGE_NOT_GRANTED, String.format(\"%s has no configured %s in authorizedSchemas\", userName, databaseName));\n+        }\n+        \n+        return new PostgreSQLLoginResult(PostgreSQLErrorCode.SUCCESSFUL_COMPLETION, null);\n+    }\n+    \n+    private static String md5Encode(final String userName, final String password, final byte[] md5Salt) {\n+        String pwdHash = new String(Hex.encodeHex(DigestUtils.md5(password + userName), true));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d90bf8f3ee592f8f43970317c745c53018803128"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTgzODY0OnYy", "diffSide": "RIGHT", "path": "shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLAuthenticationEngine.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzo1NTozNFrOHBeLaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzo1NTozNFrOHBeLaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMwNTA2NQ==", "bodyText": "Add a TODO comment here to implement PostgreSQLServerInfo like MySQLServerInfo\u3002", "url": "https://github.com/apache/shardingsphere/pull/6860#discussion_r471305065", "createdAt": "2020-08-17T07:55:34Z", "author": {"login": "tuohai666"}, "path": "shardingsphere-proxy/shardingsphere-proxy-frontend/shardingsphere-proxy-frontend-postgresql/src/main/java/org/apache/shardingsphere/proxy/frontend/postgresql/auth/PostgreSQLAuthenticationEngine.java", "diffHunk": "@@ -58,23 +69,64 @@ public boolean auth(final ChannelHandlerContext context, final PacketPayload pay\n             return false;\n         }\n         payload.getByteBuf().resetReaderIndex();\n-        PostgreSQLComStartupPacket comStartupPacket = new PostgreSQLComStartupPacket((PostgreSQLPacketPayload) payload);\n-        String databaseName = comStartupPacket.getParametersMap().get(DATABASE_NAME_KEYWORD);\n-        if (!Strings.isNullOrEmpty(databaseName) && !ProxySchemaContexts.getInstance().schemaExists(databaseName)) {\n-            PostgreSQLErrorResponsePacket responsePacket = new PostgreSQLErrorResponsePacket();\n-            responsePacket.addField(PostgreSQLErrorResponsePacket.FIELD_TYPE_SEVERITY, \"FATAL\");\n-            responsePacket.addField(PostgreSQLErrorResponsePacket.FIELD_TYPE_CODE, \"3D000\");\n-            responsePacket.addField(PostgreSQLErrorResponsePacket.FIELD_TYPE_MESSAGE, String.format(\"database \\\"%s\\\" does not exist\", databaseName));\n-            context.writeAndFlush(responsePacket);\n+        if (!startupMessageReceived.get()) {\n+            PostgreSQLComStartupPacket comStartupPacket = new PostgreSQLComStartupPacket((PostgreSQLPacketPayload) payload);\n+            startupMessageReceived.set(true);\n+            String databaseName = comStartupPacket.getParametersMap().get(DATABASE_NAME_KEYWORD);\n+            if (!Strings.isNullOrEmpty(databaseName) && !ProxySchemaContexts.getInstance().schemaExists(databaseName)) {\n+                PostgreSQLErrorResponsePacket responsePacket = createPostgreSQLErrorResponsePacket(PostgreSQLErrorCode.INVALID_CATALOG_NAME,\n+                    String.format(\"database \\\"%s\\\" does not exist\", databaseName));\n+                context.writeAndFlush(responsePacket);\n+                context.close();\n+                return false;\n+            }\n+            backendConnection.setCurrentSchema(databaseName);\n+            String userName = comStartupPacket.getParametersMap().get(USER_NAME_KEYWORD);\n+            if (null == userName || userName.isEmpty()) {\n+                PostgreSQLErrorResponsePacket responsePacket = createPostgreSQLErrorResponsePacket(PostgreSQLErrorCode.SQLSERVER_REJECTED_ESTABLISHMENT_OF_SQLCONNECTION,\n+                    \"user not set in StartupMessage\");\n+                context.writeAndFlush(responsePacket);\n+                context.close();\n+                return false;\n+            }\n+            backendConnection.setUserName(userName);\n+            md5Salt = PostgreSQLRandomGenerator.getInstance().generateRandomBytes(4);\n+            context.writeAndFlush(new PostgreSQLAuthenticationMD5PasswordPacket(md5Salt));\n             return false;\n+        } else {\n+            final char messageType = (char) ((PostgreSQLPacketPayload) payload).readInt1();\n+            if ('p' != messageType) {\n+                PostgreSQLErrorResponsePacket responsePacket = createPostgreSQLErrorResponsePacket(PostgreSQLErrorCode.SQLSERVER_REJECTED_ESTABLISHMENT_OF_SQLCONNECTION,\n+                    \"PasswordMessage is expected, message type 'p', but not '\" + messageType + \"'\");\n+                context.writeAndFlush(responsePacket);\n+                context.close();\n+                return false;\n+            }\n+            PostgreSQLPasswordMessagePacket passwordMessagePacket = new PostgreSQLPasswordMessagePacket((PostgreSQLPacketPayload) payload);\n+            PostgreSQLLoginResult loginResult = PostgreSQLAuthenticationHandler.loginWithMd5Password(\n+                backendConnection.getUserName(), backendConnection.getSchema().getName(), md5Salt, passwordMessagePacket);\n+            if (PostgreSQLErrorCode.SUCCESSFUL_COMPLETION != loginResult.getErrorCode()) {\n+                PostgreSQLErrorResponsePacket responsePacket = createPostgreSQLErrorResponsePacket(loginResult.getErrorCode(),\n+                    loginResult.getErrorMessage());\n+                context.writeAndFlush(responsePacket);\n+                context.close();\n+                return false;\n+            } else {\n+                context.write(new PostgreSQLAuthenticationOKPacket(true));\n+                context.write(new PostgreSQLParameterStatusPacket(\"server_version\", \"12.3\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d90bf8f3ee592f8f43970317c745c53018803128"}, "originalPosition": 90}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 354, "cost": 1, "resetAt": "2021-11-11T21:28:48Z"}}}