{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzNTA5MTQy", "number": 4599, "title": "add unit tests for zookeeper orchestration center", "bodyText": "For #4439\nChanges proposed in this pull request:\n\nadd zookeeper unit tests", "createdAt": "2020-03-04T11:57:48Z", "url": "https://github.com/apache/shardingsphere/pull/4599", "merged": true, "mergeCommit": {"oid": "b6d4a31d58a6dcf8b29dc5e1d1aa842bf2528656"}, "closed": true, "closedAt": "2020-03-05T09:56:58Z", "author": {"login": "menghaoranss"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKVLFHAH2gAyMzgzNTA5MTQyOjc2YTYyYTQyMTc2NjNjYmZhYzQzZDVkNTA5NGExNzkyYjQwODQzMDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKofWNAFqTM2OTQzMDg0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "76a62a4217663cbfac43d5d5094a1792b4084305", "author": {"user": {"login": "menghaoranss", "name": "Haoran Meng"}}, "url": "https://github.com/apache/shardingsphere/commit/76a62a4217663cbfac43d5d5094a1792b4084305", "committedDate": "2020-03-04T11:25:26Z", "message": "add unit tests for zk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b5bd4db783c649e5a397b50a61b2136fa5a4fa2", "author": {"user": {"login": "menghaoranss", "name": "Haoran Meng"}}, "url": "https://github.com/apache/shardingsphere/commit/9b5bd4db783c649e5a397b50a61b2136fa5a4fa2", "committedDate": "2020-03-04T11:26:47Z", "message": "Merge remote-tracking branch 'origin/master' into zookeeper-ut"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4OTA4NTEy", "url": "https://github.com/apache/shardingsphere/pull/4599#pullrequestreview-368908512", "createdAt": "2020-03-04T16:04:28Z", "commit": {"oid": "9b5bd4db783c649e5a397b50a61b2136fa5a4fa2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNjowNDoyOFrOFxzaTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNjowNjo1NFrOFxzgvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2Njg2Mg==", "bodyText": "Please add final if the class is not for extend", "url": "https://github.com/apache/shardingsphere/pull/4599#discussion_r387766862", "createdAt": "2020-03-04T16:04:28Z", "author": {"login": "terrymanu"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-zookeeper-curator/src/test/java/org/apache/shardingsphere/orchestration/center/instance/CuratorZookeeperInstanceTest.java", "diffHunk": "@@ -17,28 +17,44 @@\n \n package org.apache.shardingsphere.orchestration.center.instance;\n \n+import com.google.common.util.concurrent.SettableFuture;\n+import lombok.SneakyThrows;\n+import org.apache.curator.framework.CuratorFramework;\n+import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.retry.ExponentialBackoffRetry;\n import org.apache.shardingsphere.orchestration.center.configuration.InstanceConfiguration;\n \n+import org.apache.shardingsphere.orchestration.center.listener.DataChangedEvent;\n import org.apache.shardingsphere.orchestration.center.util.EmbedTestingServer;\n import org.junit.BeforeClass;\n import org.junit.Test;\n \n import java.util.List;\n import java.util.Properties;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n \n import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertNotNull;\n import static org.junit.Assert.assertThat;\n \n public class CuratorZookeeperInstanceTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5bd4db783c649e5a397b50a61b2136fa5a4fa2"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2ODAxNQ==", "bodyText": "Just throw exception from method signature, @SneakyThrows should use only in the situation for exception never occur", "url": "https://github.com/apache/shardingsphere/pull/4599#discussion_r387768015", "createdAt": "2020-03-04T16:06:11Z", "author": {"login": "terrymanu"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-zookeeper-curator/src/test/java/org/apache/shardingsphere/orchestration/center/instance/CuratorZookeeperInstanceTest.java", "diffHunk": "@@ -67,4 +83,114 @@ public void assertGetChildrenKeys() {\n         List<String> childrenKeys = curatorZookeeperInstance.getChildrenKeys(\"/test/children\");\n         assertThat(childrenKeys.size(), is(3));\n     }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertWatchUpdatedChangedType() {\n+        curatorZookeeperInstance.persist(\"/test/children/1\", \"value1\");\n+        final SettableFuture<DataChangedEvent> future = SettableFuture.create();\n+        curatorZookeeperInstance.watch(\"/test/children\", dataChangedEvent -> future.set(dataChangedEvent));\n+        curatorZookeeperInstance.persist(\"/test/children/1\", \"value2\");\n+        DataChangedEvent dataChangedEvent = future.get(5, TimeUnit.SECONDS);\n+        assertNotNull(dataChangedEvent);\n+        assertThat(dataChangedEvent.getChangedType(), is(DataChangedEvent.ChangedType.UPDATED));\n+        assertThat(dataChangedEvent.getKey(), is(\"/test/children/1\"));\n+        assertThat(dataChangedEvent.getValue(), is(\"value2\"));\n+        assertThat(curatorZookeeperInstance.get(\"/test/children/1\"), is(\"value2\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertWatchDeletedChangedType() {\n+        curatorZookeeperInstance.persist(\"/test/children/5\", \"value5\");\n+        final SettableFuture<DataChangedEvent> future = SettableFuture.create();\n+        curatorZookeeperInstance.watch(\"/test/children/5\", dataChangedEvent -> future.set(dataChangedEvent));\n+        client.delete().forPath(\"/test/children/5\");\n+        DataChangedEvent dataChangedEvent = future.get(5, TimeUnit.SECONDS);\n+        assertNotNull(dataChangedEvent);\n+        assertThat(dataChangedEvent.getChangedType(), is(DataChangedEvent.ChangedType.DELETED));\n+        assertThat(dataChangedEvent.getKey(), is(\"/test/children/5\"));\n+        assertThat(dataChangedEvent.getValue(), is(\"value5\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5bd4db783c649e5a397b50a61b2136fa5a4fa2"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc2ODUxMA==", "bodyText": "Please add L is the number is long type", "url": "https://github.com/apache/shardingsphere/pull/4599#discussion_r387768510", "createdAt": "2020-03-04T16:06:54Z", "author": {"login": "terrymanu"}, "path": "sharding-orchestration/sharding-orchestration-center/sharding-orchestration-center-zookeeper-curator/src/test/java/org/apache/shardingsphere/orchestration/center/instance/CuratorZookeeperInstanceTest.java", "diffHunk": "@@ -67,4 +83,114 @@ public void assertGetChildrenKeys() {\n         List<String> childrenKeys = curatorZookeeperInstance.getChildrenKeys(\"/test/children\");\n         assertThat(childrenKeys.size(), is(3));\n     }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertWatchUpdatedChangedType() {\n+        curatorZookeeperInstance.persist(\"/test/children/1\", \"value1\");\n+        final SettableFuture<DataChangedEvent> future = SettableFuture.create();\n+        curatorZookeeperInstance.watch(\"/test/children\", dataChangedEvent -> future.set(dataChangedEvent));\n+        curatorZookeeperInstance.persist(\"/test/children/1\", \"value2\");\n+        DataChangedEvent dataChangedEvent = future.get(5, TimeUnit.SECONDS);\n+        assertNotNull(dataChangedEvent);\n+        assertThat(dataChangedEvent.getChangedType(), is(DataChangedEvent.ChangedType.UPDATED));\n+        assertThat(dataChangedEvent.getKey(), is(\"/test/children/1\"));\n+        assertThat(dataChangedEvent.getValue(), is(\"value2\"));\n+        assertThat(curatorZookeeperInstance.get(\"/test/children/1\"), is(\"value2\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertWatchDeletedChangedType() {\n+        curatorZookeeperInstance.persist(\"/test/children/5\", \"value5\");\n+        final SettableFuture<DataChangedEvent> future = SettableFuture.create();\n+        curatorZookeeperInstance.watch(\"/test/children/5\", dataChangedEvent -> future.set(dataChangedEvent));\n+        client.delete().forPath(\"/test/children/5\");\n+        DataChangedEvent dataChangedEvent = future.get(5, TimeUnit.SECONDS);\n+        assertNotNull(dataChangedEvent);\n+        assertThat(dataChangedEvent.getChangedType(), is(DataChangedEvent.ChangedType.DELETED));\n+        assertThat(dataChangedEvent.getKey(), is(\"/test/children/5\"));\n+        assertThat(dataChangedEvent.getValue(), is(\"value5\"));\n+    }\n+    \n+    @Test\n+    @SneakyThrows\n+    public void assertWatchAddedChangedType() {\n+        curatorZookeeperInstance.persist(\"/test/children/4\", \"value4\");\n+        final AtomicReference<DataChangedEvent> actualDataChangedEvent = new AtomicReference<>();\n+        curatorZookeeperInstance.watch(\"/test/children\", dataChangedEvent -> actualDataChangedEvent.set(dataChangedEvent));\n+        Thread.sleep(2000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b5bd4db783c649e5a397b50a61b2136fa5a4fa2"}, "originalPosition": 86}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cfa8ea8423ea9ac7162e0c162726ea5880cbd2a", "author": {"user": {"login": "menghaoranss", "name": "Haoran Meng"}}, "url": "https://github.com/apache/shardingsphere/commit/1cfa8ea8423ea9ac7162e0c162726ea5880cbd2a", "committedDate": "2020-03-05T02:35:23Z", "message": "resolve review problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f26a6931982c9ff6abb54ba337b86913f22cf6f", "author": {"user": {"login": "menghaoranss", "name": "Haoran Meng"}}, "url": "https://github.com/apache/shardingsphere/commit/1f26a6931982c9ff6abb54ba337b86913f22cf6f", "committedDate": "2020-03-05T05:34:15Z", "message": "resolve review problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49d1e3f0e60ff7bc6b61d398410db661910e1ddb", "author": {"user": {"login": "menghaoranss", "name": "Haoran Meng"}}, "url": "https://github.com/apache/shardingsphere/commit/49d1e3f0e60ff7bc6b61d398410db661910e1ddb", "committedDate": "2020-03-05T07:31:28Z", "message": "Merge remote-tracking branch 'origin/master' into zookeeper-ut"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDMwODQx", "url": "https://github.com/apache/shardingsphere/pull/4599#pullrequestreview-369430841", "createdAt": "2020-03-05T09:55:46Z", "commit": {"oid": "49d1e3f0e60ff7bc6b61d398410db661910e1ddb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3896, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}