{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0MzExOTUw", "number": 1471, "title": "Disabled user account handling", "bodyText": "Description\nLEARNER-7913\n\nLog out the learner on receiving the error code user_is_disabled.\nShow a proper error when a disabled user tries to log in.\n\nTest the PR:\n\n If the Learner is signed-in and marked as disabled, the user should be sign-out on the server response.\n Learner should not be able to sign-in with the social account if the user account is disabled and Show the proper error message with the option of contact to customer support.\n\nScreenshots:\n ----- \nConfig\nAPI_HOST_URL: 'https://mobileapitest.sandbox.edx.org'\nOAUTH_CLIENT_ID: 'PBVYdCMfkbwhnxDL0vQiQ2cKndRkqolFqPYKfvfl'\n\nManage User account by the following link: https://mobileapitest.sandbox.edx.org/support/manage_user\nNote: Back-end code is not deployed on the PROD/STAGE server till now.", "createdAt": "2020-10-15T18:58:51Z", "url": "https://github.com/edx/edx-app-android/pull/1471", "merged": true, "mergeCommit": {"oid": "5847a6b1c5f1de15a6f5ef4c8afdbc654a9b5fe4"}, "closed": true, "closedAt": "2020-10-17T14:43:33Z", "author": {"login": "farhan-arshad-dev"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdS2RH9gH2gAyNTA0MzExOTUwOmU0NjZhYTJjNTE3NDNjMGM0NmE2YWYyNjU2NzJlNDJlMGJhYmUxYzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTLJpEgFqTUxMDcyOTczNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e466aa2c51743c0c46a6af265672e42e0babe1c4", "author": {"user": {"login": "farhan-arshad-dev", "name": "Farhan Arshad"}}, "url": "https://github.com/edx/edx-app-android/commit/e466aa2c51743c0c46a6af265672e42e0babe1c4", "committedDate": "2020-10-15T18:41:27Z", "message": "Disabled user account handling\n- LEARNER-7913\n- Log out learner on receiving the error code `user_is_disabled`.\n- Show a proper error when a disable user tries to login."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMzc4NTM4", "url": "https://github.com/edx/edx-app-android/pull/1471#pullrequestreview-510378538", "createdAt": "2020-10-16T11:19:52Z", "commit": {"oid": "e466aa2c51743c0c46a6af265672e42e0babe1c4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMToxOTo1MlrOHi2w6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTo0NjowOVrOHi4BWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxMDg5MQ==", "bodyText": "please change the name string into small letters", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506310891", "createdAt": "2020-10-16T11:19:52Z", "author": {"login": "omerhabib26"}, "path": "OpenEdXMobile/res/values/labels.xml", "diffHunk": "@@ -42,4 +42,6 @@\n     <string name=\"label_undo\">Undo</string>\n     <!-- Label denoting an error -->\n     <string name=\"label_error\">Error</string>\n+    <!-- Customer support text, using as button title for disabled user-->\n+    <string name=\"CUSTOMER_SUPPORT\">Customer Support</string>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e466aa2c51743c0c46a6af265672e42e0babe1c4"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxMzE4NQ==", "bodyText": "IMO, we can remove the finish() from this method as we are clearing the stack in forceLogout", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506313185", "createdAt": "2020-10-16T11:23:06Z", "author": {"login": "omerhabib26"}, "path": "OpenEdXMobile/src/main/java/org/edx/mobile/base/BaseFragmentActivity.java", "diffHunk": "@@ -279,6 +279,9 @@ protected boolean isLandscape() {\n      */\n     @SuppressWarnings(\"unused\")\n     public void onEvent(LogoutEvent event) {\n+        environment.getRouter().forceLogout(this,\n+                environment.getAnalyticsRegistry(),\n+                environment.getNotificationDelegate());\n         finish();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e466aa2c51743c0c46a6af265672e42e0babe1c4"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyMDg1Ng==", "bodyText": "Can we add a doc here?\nIf the user logged In through social auth & if user got disabled then on next first API call app will force the user to logout and navigate it to the splash screen", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506320856", "createdAt": "2020-10-16T11:32:57Z", "author": {"login": "omerhabib26"}, "path": "OpenEdXMobile/src/main/java/org/edx/mobile/http/authenticator/OauthRefreshTokenAuthenticator.java", "diffHunk": "@@ -88,6 +91,9 @@ public synchronized Request authenticate(Route route, final Response response) t\n                                 .header(\"Authorization\", currentAuth.token_type + \" \" + currentAuth.access_token)\n                                 .build();\n                     }\n+                case DISABLED_USER_ERROR_MESSAGE:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e466aa2c51743c0c46a6af265672e42e0babe1c4"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMyNzgzOA==", "bodyText": "Plus, in environment.getRouter().forceLogout we can remove the EventBus.getDefault().post(new LogoutEvent()); as it can make a loop", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506327838", "createdAt": "2020-10-16T11:41:32Z", "author": {"login": "omerhabib26"}, "path": "OpenEdXMobile/src/main/java/org/edx/mobile/base/BaseFragmentActivity.java", "diffHunk": "@@ -279,6 +279,9 @@ protected boolean isLandscape() {\n      */\n     @SuppressWarnings(\"unused\")\n     public void onEvent(LogoutEvent event) {\n+        environment.getRouter().forceLogout(this,\n+                environment.getAnalyticsRegistry(),\n+                environment.getNotificationDelegate());\n         finish();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMxMzE4NQ=="}, "originalCommit": {"oid": "e466aa2c51743c0c46a6af265672e42e0babe1c4"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzMDg4MA==", "bodyText": "Can we change the subject in the email to \"Account Disabled\"", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506330880", "createdAt": "2020-10-16T11:45:16Z", "author": {"login": "omerhabib26"}, "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/LoginActivity.java", "diffHunk": "@@ -357,17 +357,28 @@ public void onUserLoginFailure(Exception ex, String accessToken, String backend)\n                     errorMessage.getMessageLine1(),\n                     (errorMessage.getMessageLine2() != null) ?\n                             errorMessage.getMessageLine2() : getString(R.string.login_failed));\n-        } else if (ex != null && ex instanceof HttpStatusException &&\n-                ((HttpStatusException) ex).getStatusCode() == HttpStatus.UPGRADE_REQUIRED) {\n-            LoginActivity.this.showAlertDialog(null,\n-                    getString(R.string.app_version_unsupported_login_msg),\n-                    getString(R.string.label_update),\n-                    new DialogInterface.OnClickListener() {\n-                        @Override\n-                        public void onClick(DialogInterface dialog, int which) {\n-                            AppStoreUtils.openAppInAppStore(LoginActivity.this);\n-                        }\n-                    }, getString(android.R.string.cancel), null);\n+        } else if (ex != null && ex instanceof HttpStatusException) {\n+            switch (((HttpStatusException) ex).getStatusCode()) {\n+                case HttpStatus.UPGRADE_REQUIRED:\n+                    LoginActivity.this.showAlertDialog(null,\n+                            getString(R.string.app_version_unsupported_login_msg),\n+                            getString(R.string.label_update),\n+                            (dialog, which) -> AppStoreUtils\n+                                    .openAppInAppStore(LoginActivity.this),\n+                            getString(android.R.string.cancel), null);\n+                    break;\n+                case HttpStatus.FORBIDDEN:\n+                    LoginActivity.this.showAlertDialog(getString(R.string.login_error),\n+                            getString(R.string.auth_provider_disabled_user_error),\n+                            getString(R.string.CUSTOMER_SUPPORT),\n+                            (dialog, which) -> environment.getRouter()\n+                                    .showFeedbackScreen(LoginActivity.this,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e466aa2c51743c0c46a6af265672e42e0babe1c4"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzMTQ4MQ==", "bodyText": "change email subject here as well", "url": "https://github.com/edx/edx-app-android/pull/1471#discussion_r506331481", "createdAt": "2020-10-16T11:46:09Z", "author": {"login": "omerhabib26"}, "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/RegisterActivity.java", "diffHunk": "@@ -653,9 +653,17 @@ public void onUserLoginFailure(Exception ex, String accessToken, String backend)\n         // handle if this is a LoginException\n         tryToSetUIInteraction(true);\n         logger.error(ex);\n-        SocialFactory.SOCIAL_SOURCE_TYPE socialType = SocialFactory.SOCIAL_SOURCE_TYPE.fromString(backend);\n-        updateUIOnSocialLoginToEdxFailure(socialType, accessToken);\n-\n+        if (ex instanceof HttpStatusException && ((HttpStatusException) ex).getStatusCode() == HttpStatus.FORBIDDEN) {\n+            RegisterActivity.this.showAlertDialog(getString(R.string.login_error),\n+                    getString(R.string.auth_provider_disabled_user_error),\n+                    getString(R.string.CUSTOMER_SUPPORT),\n+                    (dialog, which) -> environment.getRouter()\n+                            .showFeedbackScreen(RegisterActivity.this,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e466aa2c51743c0c46a6af265672e42e0babe1c4"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76f4e729e305b122d414c6c537b8391417b154fd", "author": {"user": {"login": "farhan-arshad-dev", "name": "Farhan Arshad"}}, "url": "https://github.com/edx/edx-app-android/commit/76f4e729e305b122d414c6c537b8391417b154fd", "committedDate": "2020-10-16T13:26:52Z", "message": "Address PR commits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cc2b862b2810535a6f320eec2f9a614789d90c5", "author": {"user": {"login": "farhan-arshad-dev", "name": "Farhan Arshad"}}, "url": "https://github.com/edx/edx-app-android/commit/0cc2b862b2810535a6f320eec2f9a614789d90c5", "committedDate": "2020-10-16T13:35:35Z", "message": "Finish for the safe side"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNzI5NzM0", "url": "https://github.com/edx/edx-app-android/pull/1471#pullrequestreview-510729734", "createdAt": "2020-10-16T19:01:18Z", "commit": {"oid": "0cc2b862b2810535a6f320eec2f9a614789d90c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4241, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}