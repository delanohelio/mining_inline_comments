{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4Mjk4Nzk5", "number": 4577, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQxMzoxNTozNlrODoDagA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOTozOTowNlrODoQI3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMzI1NTY4OnYy", "diffSide": "RIGHT", "path": "core/src/test/java/hudson/model/FingerprintCleanupThreadTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQxMzoxNTozNlrOF2ZpYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQxMzoxNTozNlrOF2ZpYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4NzYxOQ==", "bodyText": "Is there a race condition here where the cleanup thread may not yet have completed the deletion of the fingerprint file?\nAlso, is it worth considering using a hamcrest assertion rather than assertTrue?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertTrue(\"Should have deleted obsolete file.\", fpFile.toFile().exists());\n          \n          \n            \n                    assertThat(fpFile.toFile()., is(aReadableFile()));", "url": "https://github.com/jenkinsci/jenkins/pull/4577#discussion_r392587619", "createdAt": "2020-03-14T13:15:36Z", "author": {"login": "MarkEWaite"}, "path": "core/src/test/java/hudson/model/FingerprintCleanupThreadTest.java", "diffHunk": "@@ -90,6 +94,32 @@ public void testIOExceptionOnLoad() throws IOException {\n         assertTrue(\"Should have logged IOException.\", logOutput.contains(\"ERROR: Failed to process\"));\n     }\n \n+    @Test\n+    public void testBlockingFacetBlocksDeletion() throws IOException {\n+        createFolderStructure();\n+        TestTaskListener testTaskListener = new TestTaskListener();\n+        Fingerprint fp = new TestFingerprint(false);\n+        fp.facets.setOwner(Saveable.NOOP);\n+        TestFingperprintFacet facet = new TestFingperprintFacet(fp, System.currentTimeMillis(), true);\n+        fp.facets.add(facet);\n+        FingerprintCleanupThread cleanupThread = new TestFingerprintCleanupThread(fp);\n+        cleanupThread.execute(testTaskListener);\n+        assertTrue(\"Should have deleted obsolete file.\", fpFile.toFile().exists());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe6916fd31e374faff5db4f2ac0287e8ce787b94"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMzI1NzEyOnYy", "diffSide": "RIGHT", "path": "core/src/test/java/hudson/model/FingerprintCleanupThreadTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQxMzoxODo0M1rOF2ZqFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxMDowOTo1OFrOF2eANA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4Nzc5OA==", "bodyText": "Hamcrest assertion for easier diagnosis of failures?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertFalse(\"Should have deleted obsolete file.\", fpFile.toFile().exists());\n          \n          \n            \n                            assertThat(fpFile.toFile()., is(not(aReadableFile())));\n          \n          \n            \n                    assertFalse(\"Should have deleted obsolete file.\", fpFile.toFile().exists());", "url": "https://github.com/jenkinsci/jenkins/pull/4577#discussion_r392587798", "createdAt": "2020-03-14T13:18:43Z", "author": {"login": "MarkEWaite"}, "path": "core/src/test/java/hudson/model/FingerprintCleanupThreadTest.java", "diffHunk": "@@ -90,6 +94,32 @@ public void testIOExceptionOnLoad() throws IOException {\n         assertTrue(\"Should have logged IOException.\", logOutput.contains(\"ERROR: Failed to process\"));\n     }\n \n+    @Test\n+    public void testBlockingFacetBlocksDeletion() throws IOException {\n+        createFolderStructure();\n+        TestTaskListener testTaskListener = new TestTaskListener();\n+        Fingerprint fp = new TestFingerprint(false);\n+        fp.facets.setOwner(Saveable.NOOP);\n+        TestFingperprintFacet facet = new TestFingperprintFacet(fp, System.currentTimeMillis(), true);\n+        fp.facets.add(facet);\n+        FingerprintCleanupThread cleanupThread = new TestFingerprintCleanupThread(fp);\n+        cleanupThread.execute(testTaskListener);\n+        assertTrue(\"Should have deleted obsolete file.\", fpFile.toFile().exists());\n+    }\n+\n+    @Test\n+    public void testUnblockedFacetsDontBlockDeletion() throws IOException {\n+        createFolderStructure();\n+        TestTaskListener testTaskListener = new TestTaskListener();\n+        Fingerprint fp = new TestFingerprint(false);\n+        fp.facets.setOwner(Saveable.NOOP);\n+        TestFingperprintFacet facet = new TestFingperprintFacet(fp, System.currentTimeMillis(), false);\n+        fp.facets.add(facet);\n+        FingerprintCleanupThread cleanupThread = new TestFingerprintCleanupThread(fp);\n+        cleanupThread.execute(testTaskListener);\n+        assertFalse(\"Should have deleted obsolete file.\", fpFile.toFile().exists());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe6916fd31e374faff5db4f2ac0287e8ce787b94"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY1NjgzNQ==", "bodyText": "@MarkEWaite IIUC the aReadableFile FileMatcher is present inside Hamcrest Version 2.0 onwards. However, we are using hamcrest-library version 1.3. Should I try upgrading it? Or should I implement a custom Matcher?", "url": "https://github.com/jenkinsci/jenkins/pull/4577#discussion_r392656835", "createdAt": "2020-03-15T09:38:39Z", "author": {"login": "stellargo"}, "path": "core/src/test/java/hudson/model/FingerprintCleanupThreadTest.java", "diffHunk": "@@ -90,6 +94,32 @@ public void testIOExceptionOnLoad() throws IOException {\n         assertTrue(\"Should have logged IOException.\", logOutput.contains(\"ERROR: Failed to process\"));\n     }\n \n+    @Test\n+    public void testBlockingFacetBlocksDeletion() throws IOException {\n+        createFolderStructure();\n+        TestTaskListener testTaskListener = new TestTaskListener();\n+        Fingerprint fp = new TestFingerprint(false);\n+        fp.facets.setOwner(Saveable.NOOP);\n+        TestFingperprintFacet facet = new TestFingperprintFacet(fp, System.currentTimeMillis(), true);\n+        fp.facets.add(facet);\n+        FingerprintCleanupThread cleanupThread = new TestFingerprintCleanupThread(fp);\n+        cleanupThread.execute(testTaskListener);\n+        assertTrue(\"Should have deleted obsolete file.\", fpFile.toFile().exists());\n+    }\n+\n+    @Test\n+    public void testUnblockedFacetsDontBlockDeletion() throws IOException {\n+        createFolderStructure();\n+        TestTaskListener testTaskListener = new TestTaskListener();\n+        Fingerprint fp = new TestFingerprint(false);\n+        fp.facets.setOwner(Saveable.NOOP);\n+        TestFingperprintFacet facet = new TestFingperprintFacet(fp, System.currentTimeMillis(), false);\n+        fp.facets.add(facet);\n+        FingerprintCleanupThread cleanupThread = new TestFingerprintCleanupThread(fp);\n+        cleanupThread.execute(testTaskListener);\n+        assertFalse(\"Should have deleted obsolete file.\", fpFile.toFile().exists());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4Nzc5OA=="}, "originalCommit": {"oid": "fe6916fd31e374faff5db4f2ac0287e8ce787b94"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY1ODk5Ng==", "bodyText": "should be fine to give it a go at upgrading, I don't remember hitting issues upgrading it elsewhere", "url": "https://github.com/jenkinsci/jenkins/pull/4577#discussion_r392658996", "createdAt": "2020-03-15T10:09:58Z", "author": {"login": "timja"}, "path": "core/src/test/java/hudson/model/FingerprintCleanupThreadTest.java", "diffHunk": "@@ -90,6 +94,32 @@ public void testIOExceptionOnLoad() throws IOException {\n         assertTrue(\"Should have logged IOException.\", logOutput.contains(\"ERROR: Failed to process\"));\n     }\n \n+    @Test\n+    public void testBlockingFacetBlocksDeletion() throws IOException {\n+        createFolderStructure();\n+        TestTaskListener testTaskListener = new TestTaskListener();\n+        Fingerprint fp = new TestFingerprint(false);\n+        fp.facets.setOwner(Saveable.NOOP);\n+        TestFingperprintFacet facet = new TestFingperprintFacet(fp, System.currentTimeMillis(), true);\n+        fp.facets.add(facet);\n+        FingerprintCleanupThread cleanupThread = new TestFingerprintCleanupThread(fp);\n+        cleanupThread.execute(testTaskListener);\n+        assertTrue(\"Should have deleted obsolete file.\", fpFile.toFile().exists());\n+    }\n+\n+    @Test\n+    public void testUnblockedFacetsDontBlockDeletion() throws IOException {\n+        createFolderStructure();\n+        TestTaskListener testTaskListener = new TestTaskListener();\n+        Fingerprint fp = new TestFingerprint(false);\n+        fp.facets.setOwner(Saveable.NOOP);\n+        TestFingperprintFacet facet = new TestFingperprintFacet(fp, System.currentTimeMillis(), false);\n+        fp.facets.add(facet);\n+        FingerprintCleanupThread cleanupThread = new TestFingerprintCleanupThread(fp);\n+        cleanupThread.execute(testTaskListener);\n+        assertFalse(\"Should have deleted obsolete file.\", fpFile.toFile().exists());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU4Nzc5OA=="}, "originalCommit": {"oid": "fe6916fd31e374faff5db4f2ac0287e8ce787b94"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDA0NDQzOnYy", "diffSide": "RIGHT", "path": "core/src/main/java/hudson/model/FingerprintCleanupThread.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxNzowNjo0MVrOF2gEsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxNzowNjo0MVrOF2gEsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5MjkxMg==", "bodyText": "Wouldn't this be much nicer?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                listener.getLogger().println(deletionBlockerFacet.getClass().getName() + \" created at timestamp: \" + deletionBlockerFacet.getTimestamp() + \" blocked deletion of \" + fingerprintFile);\n          \n          \n            \n                                listener.getLogger().println(deletionBlockerFacet.getClass().getName() + \" created on \" + new Date(deletionBlockerFacet.getTimestamp()) + \" blocked deletion of \" + fingerprintFile);\n          \n      \n    \n    \n  \n\n(Assuming this is millis. Untested.)", "url": "https://github.com/jenkinsci/jenkins/pull/4577#discussion_r392692912", "createdAt": "2020-03-15T17:06:41Z", "author": {"login": "daniel-beck"}, "path": "core/src/main/java/hudson/model/FingerprintCleanupThread.java", "diffHunk": "@@ -118,7 +118,7 @@ private boolean check(File fingerprintFile, TaskListener listener) {\n             } else {\n                 if (!fp.isAlive()) {\n                     FingerprintFacet deletionBlockerFacet = fp.getFacetBlockingDeletion();\n-                    listener.getLogger().println(deletionBlockerFacet.getClass().getName() + \" created on \" + DATE_CONVERTER.toString(deletionBlockerFacet.getTimestamp()) + \" blocked deletion of \" + fingerprintFile);\n+                    listener.getLogger().println(deletionBlockerFacet.getClass().getName() + \" created at timestamp: \" + deletionBlockerFacet.getTimestamp() + \" blocked deletion of \" + fingerprintFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce1f4c0f8207de53fde1f12ae8dad5fd250c26f0"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDA0NDgzOnYy", "diffSide": "RIGHT", "path": "core/src/test/java/hudson/model/FingerprintCleanupThreadTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxNzowNzo0M1rOF2gE6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNVQxNzowNzo0M1rOF2gE6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjY5Mjk3MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import hudson.model.listeners.SaveableListener;", "url": "https://github.com/jenkinsci/jenkins/pull/4577#discussion_r392692971", "createdAt": "2020-03-15T17:07:43Z", "author": {"login": "daniel-beck"}, "path": "core/src/test/java/hudson/model/FingerprintCleanupThreadTest.java", "diffHunk": "@@ -34,9 +34,18 @@\n import java.nio.file.Path;\n import java.nio.file.Paths;\n \n+import hudson.model.listeners.SaveableListener;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce1f4c0f8207de53fde1f12ae8dad5fd250c26f0"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDk1MDc4OnYy", "diffSide": "RIGHT", "path": "core/pom.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNzoyNzoyOFrOF2oRlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNzoyNzoyOFrOF2oRlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgyNzI4NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  <version>2.2</version>\n          \n          \n            \n                  <version>${hamcrest.version}</version>", "url": "https://github.com/jenkinsci/jenkins/pull/4577#discussion_r392827284", "createdAt": "2020-03-16T07:27:28Z", "author": {"login": "timja"}, "path": "core/pom.xml", "diffHunk": "@@ -189,10 +189,16 @@ THE SOFTWARE.\n       <artifactId>jenkins-stapler-support</artifactId>\n       <version>1.1</version>\n     </dependency>\n+    <dependency>\n+      <groupId>org.hamcrest</groupId>\n+      <artifactId>hamcrest</artifactId>\n+      <version>2.2</version>\n+      <scope>test</scope>\n+    </dependency>\n     <dependency>\n       <groupId>org.hamcrest</groupId>\n       <artifactId>hamcrest-library</artifactId>\n-      <version>1.3</version>\n+      <version>2.2</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f0d83eeaa50e4964ad05469f6ba026cdf7107c2"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNDk1MTE1OnYy", "diffSide": "RIGHT", "path": "core/pom.xml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNzoyNzo0MVrOF2oR1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwNzoyNzo0MVrOF2oR1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjgyNzM1MA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  <version>2.2</version>\n          \n          \n            \n                  <version>${hamcrest.version}</version>", "url": "https://github.com/jenkinsci/jenkins/pull/4577#discussion_r392827350", "createdAt": "2020-03-16T07:27:41Z", "author": {"login": "timja"}, "path": "core/pom.xml", "diffHunk": "@@ -189,10 +189,16 @@ THE SOFTWARE.\n       <artifactId>jenkins-stapler-support</artifactId>\n       <version>1.1</version>\n     </dependency>\n+    <dependency>\n+      <groupId>org.hamcrest</groupId>\n+      <artifactId>hamcrest</artifactId>\n+      <version>2.2</version>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f0d83eeaa50e4964ad05469f6ba026cdf7107c2"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzNTM0MDQ1OnYy", "diffSide": "RIGHT", "path": "core/src/test/java/hudson/model/FingerprintCleanupThreadTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOTozOTowNlrOF2sAGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQwOTozOTowNlrOF2sAGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjg4ODM0NQ==", "bodyText": "Would it make sense to assert log output here, given what this change does (at least \"blocked deletion\")?", "url": "https://github.com/jenkinsci/jenkins/pull/4577#discussion_r392888345", "createdAt": "2020-03-16T09:39:06Z", "author": {"login": "daniel-beck"}, "path": "core/src/test/java/hudson/model/FingerprintCleanupThreadTest.java", "diffHunk": "@@ -90,6 +97,32 @@ public void testIOExceptionOnLoad() throws IOException {\n         assertTrue(\"Should have logged IOException.\", logOutput.contains(\"ERROR: Failed to process\"));\n     }\n \n+    @Test\n+    public void testBlockingFacetBlocksDeletion() throws IOException {\n+        createFolderStructure();\n+        TestTaskListener testTaskListener = new TestTaskListener();\n+        Fingerprint fp = new TestFingerprint(false);\n+        fp.facets.setOwner(Saveable.NOOP);\n+        TestFingperprintFacet facet = new TestFingperprintFacet(fp, System.currentTimeMillis(), true);\n+        fp.facets.add(facet);\n+        FingerprintCleanupThread cleanupThread = new TestFingerprintCleanupThread(fp);\n+        cleanupThread.execute(testTaskListener);\n+        assertThat(fpFile.toFile(), is(aReadableFile()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa42cf97381491bc995c3dc993b5089f4e7c35da"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 630, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}