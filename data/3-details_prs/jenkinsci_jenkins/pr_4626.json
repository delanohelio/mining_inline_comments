{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5MDQ0NTYz", "number": 4626, "title": "[JENKINS-60866] Un-inline JavaScript from ReverseProxySetupMonitor", "bodyText": "See JENKINS-60866.\nAs I was playing with the rootURL and the reverse proxy monitor, I fall into a situation where my root URL does not contain the contextPath (manually set) and thus it told me that the configuration is not good. So I added a logic for adding a warning message when such situation occurs.\nThe existing test was not really testing stuff, so I added several ones.\nAt the same time, I did some cleanup. If some of the changes do not satisfy you, we can keep only the un-inlining of JavaScript.\nI quickly look for potential usage of the doTest method, and found nothing. So this breaking change should not have any impact. (it's especially a bad idea to call programmatically a web method, but anyway)\n\nScreenshot of the additional warning message\n\n\n\ud83d\udca1 If you have a typo fix, or unquestionable change, please suggest+commit directly ;)\nProposed changelog entries\n\n(internal) Remove inline resources from ReverseProxySetupMonitor view\nAdd a specific warning when the Jenkins Root URL does not contain the contextPath.\n\n\nProposed upgrade guidelines\nN/A\nSubmitter checklist\n\n JIRA issue is well described\n Changelog entries and upgrade guidelines are appropriate for the audience affected by the change (users or developer, depending on the change). Examples\n\nFill-in the Proposed changelog entries section only if there are breaking changes or other changes which may require extra steps from users during the upgrade\n\n\n Appropriate autotests or explanation to why this change has no tests\n[n/a] For dependency updates: links to external changelogs and, if possible, full diffs\n\n\nDesired reviewers\n\nMaintainer checklist\nBefore the changes are marked as ready-for-merge:\n\n There are at least 2 approvals for the pull request and no outstanding requests for change\n Conversations in the pull request are over OR it is explicit that a reviewer does not block the change\n Changelog entries in the PR title and/or Proposed changelog entries are correct\n Proper changelog labels are set so that the changelog can be generated automatically\n If the change needs additional upgrade steps from users, upgrade-guide-needed label is set and there is a Proposed upgrade guidelines section in the PR title. (example)\n If it would make sense to backport the change to LTS, a JIRA issue should exist and be labeled as lts-candidate", "createdAt": "2020-04-05T11:44:50Z", "url": "https://github.com/jenkinsci/jenkins/pull/4626", "merged": true, "mergeCommit": {"oid": "b911b0466cc3cc43328af4d5ec1b4963fdf15515"}, "closed": true, "closedAt": "2020-04-29T12:30:03Z", "author": {"login": "Wadeck"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUogaBAH2gAyMzk5MDQ0NTYzOjg1NmM0YzA4NWFiOGY0NGZiNzdhZjI3OTExZGQ0MGRmMWMzZWE2MjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceEAbhAFqTQwNTI1MDc4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "856c4c085ab8f44fb77af27911dd40df1c3ea622", "author": {"user": {"login": "Wadeck", "name": "Wadeck Follonier"}}, "url": "https://github.com/jenkinsci/jenkins/commit/856c4c085ab8f44fb77af27911dd40df1c3ea622", "committedDate": "2020-04-05T11:36:10Z", "message": "[JENKINS-60866] Un-inline JavaScript from ReverseProxySetupMonitor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3ODExMTY1", "url": "https://github.com/jenkinsci/jenkins/pull/4626#pullrequestreview-387811165", "createdAt": "2020-04-05T12:02:12Z", "commit": {"oid": "856c4c085ab8f44fb77af27911dd40df1c3ea622"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQxMjowMjoxM1rOGA_ZsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQxMjowNjoxM1rOGA_bkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5MTk1Mg==", "bodyText": "Arrow functions do not work on some browsers jenkins supports. Basically, adjuncts cannot use them or other ES6 features.", "url": "https://github.com/jenkinsci/jenkins/pull/4626#discussion_r403691952", "createdAt": "2020-04-05T12:02:13Z", "author": {"login": "fqueiruga"}, "path": "core/src/main/resources/hudson/diagnosis/ReverseProxySetupMonitor/resources.js", "diffHunk": "@@ -0,0 +1,35 @@\n+(() => {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "856c4c085ab8f44fb77af27911dd40df1c3ea622"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5MjA1Mg==", "bodyText": "Can we return here to avoid one extra level of nesting by skipping the else clause?", "url": "https://github.com/jenkinsci/jenkins/pull/4626#discussion_r403692052", "createdAt": "2020-04-05T12:02:53Z", "author": {"login": "fqueiruga"}, "path": "core/src/main/resources/hudson/diagnosis/ReverseProxySetupMonitor/resources.js", "diffHunk": "@@ -0,0 +1,35 @@\n+(() => {\n+\tvar redirectForm = document.getElementById('redirect-error');\n+\tif (!redirectForm) {\n+\t\tconsole.warn('This script expects to have an element with id=\"redirect-error\" to be working.');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "856c4c085ab8f44fb77af27911dd40df1c3ea622"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5MjA5MA==", "bodyText": "love seeing use of data-attributes \ud83d\udc4d", "url": "https://github.com/jenkinsci/jenkins/pull/4626#discussion_r403692090", "createdAt": "2020-04-05T12:03:20Z", "author": {"login": "fqueiruga"}, "path": "core/src/main/resources/hudson/diagnosis/ReverseProxySetupMonitor/resources.js", "diffHunk": "@@ -0,0 +1,35 @@\n+(() => {\n+\tvar redirectForm = document.getElementById('redirect-error');\n+\tif (!redirectForm) {\n+\t\tconsole.warn('This script expects to have an element with id=\"redirect-error\" to be working.');\n+\t} else {\n+\t\tvar urlToTest = redirectForm.getAttribute('data-url');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "856c4c085ab8f44fb77af27911dd40df1c3ea622"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5MjM3NQ==", "bodyText": "I would suggest renaming the .context-message class to .js-context-message, to show is intent to be used by JS code and avoid a regression when refactoring CSS.", "url": "https://github.com/jenkinsci/jenkins/pull/4626#discussion_r403692375", "createdAt": "2020-04-05T12:05:40Z", "author": {"login": "fqueiruga"}, "path": "core/src/main/resources/hudson/diagnosis/ReverseProxySetupMonitor/resources.js", "diffHunk": "@@ -0,0 +1,35 @@\n+(() => {\n+\tvar redirectForm = document.getElementById('redirect-error');\n+\tif (!redirectForm) {\n+\t\tconsole.warn('This script expects to have an element with id=\"redirect-error\" to be working.');\n+\t} else {\n+\t\tvar urlToTest = redirectForm.getAttribute('data-url');\n+\t\tnew Ajax.Request(urlToTest, {\n+\t\t\tonComplete : function(response) {\n+\t\t\t\tif (response.status !== 200) {\n+\t\t\t\t\tvar context = redirectForm.getAttribute('data-context');\n+\t\t\t\t\t// to cover the case where the JenkinsRootUrl is configured without the context\n+\t\t\t\t\tif (context) {\n+\t\t\t\t\t\tnew Ajax.Request(urlToTest, {\n+\t\t\t\t\t\t\tparameters: { testWithContext:true },\n+\t\t\t\t\t\t\tonComplete: function (response) {\n+\t\t\t\t\t\t\t\tif (response.status === 200) {\n+\t\t\t\t\t\t\t\t\t// this means the root URL was configured but without the contextPath, \n+\t\t\t\t\t\t\t\t\t// so different message to display\n+\t\t\t\t\t\t\t\t\tredirectForm.style.display = \"block\";\n+\t\t\t\t\t\t\t\t\tredirectForm.querySelectorAll('.context-message').forEach(node => node.style.display = \"block\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "856c4c085ab8f44fb77af27911dd40df1c3ea622"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY5MjQzMg==", "bodyText": "Again, arrow functions should be swapped by normal anonymous function () { }s", "url": "https://github.com/jenkinsci/jenkins/pull/4626#discussion_r403692432", "createdAt": "2020-04-05T12:06:13Z", "author": {"login": "fqueiruga"}, "path": "core/src/main/resources/hudson/diagnosis/ReverseProxySetupMonitor/resources.js", "diffHunk": "@@ -0,0 +1,35 @@\n+(() => {\n+\tvar redirectForm = document.getElementById('redirect-error');\n+\tif (!redirectForm) {\n+\t\tconsole.warn('This script expects to have an element with id=\"redirect-error\" to be working.');\n+\t} else {\n+\t\tvar urlToTest = redirectForm.getAttribute('data-url');\n+\t\tnew Ajax.Request(urlToTest, {\n+\t\t\tonComplete : function(response) {\n+\t\t\t\tif (response.status !== 200) {\n+\t\t\t\t\tvar context = redirectForm.getAttribute('data-context');\n+\t\t\t\t\t// to cover the case where the JenkinsRootUrl is configured without the context\n+\t\t\t\t\tif (context) {\n+\t\t\t\t\t\tnew Ajax.Request(urlToTest, {\n+\t\t\t\t\t\t\tparameters: { testWithContext:true },\n+\t\t\t\t\t\t\tonComplete: function (response) {\n+\t\t\t\t\t\t\t\tif (response.status === 200) {\n+\t\t\t\t\t\t\t\t\t// this means the root URL was configured but without the contextPath, \n+\t\t\t\t\t\t\t\t\t// so different message to display\n+\t\t\t\t\t\t\t\t\tredirectForm.style.display = \"block\";\n+\t\t\t\t\t\t\t\t\tredirectForm.querySelectorAll('.context-message').forEach(node => node.style.display = \"block\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "856c4c085ab8f44fb77af27911dd40df1c3ea622"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "001af91c94be8bc122dcbb43e64ea7fbc1df24af", "author": {"user": {"login": "Wadeck", "name": "Wadeck Follonier"}}, "url": "https://github.com/jenkinsci/jenkins/commit/001af91c94be8bc122dcbb43e64ea7fbc1df24af", "committedDate": "2020-04-05T12:12:49Z", "message": "Also un-inlining CSS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b95cdf438257eccc30e8f797b5e5c9ddb8cbf4a", "author": {"user": {"login": "Wadeck", "name": "Wadeck Follonier"}}, "url": "https://github.com/jenkinsci/jenkins/commit/0b95cdf438257eccc30e8f797b5e5c9ddb8cbf4a", "committedDate": "2020-04-05T13:18:08Z", "message": "Arrow to function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "133cff776b2a15fd6eba3db9764483c223665662", "author": {"user": {"login": "Wadeck", "name": "Wadeck Follonier"}}, "url": "https://github.com/jenkinsci/jenkins/commit/133cff776b2a15fd6eba3db9764483c223665662", "committedDate": "2020-04-05T13:20:42Z", "message": "Differentiate css-class and js-class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3ODI4MjEw", "url": "https://github.com/jenkinsci/jenkins/pull/4626#pullrequestreview-387828210", "createdAt": "2020-04-05T15:02:42Z", "commit": {"oid": "133cff776b2a15fd6eba3db9764483c223665662"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQxNTowMjo0M1rOGBAvCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNVQxNTowMjo0M1rOGBAvCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzcxMzgwMg==", "bodyText": "You left one arrow function here :)", "url": "https://github.com/jenkinsci/jenkins/pull/4626#discussion_r403713802", "createdAt": "2020-04-05T15:02:43Z", "author": {"login": "fqueiruga"}, "path": "core/src/main/resources/hudson/diagnosis/ReverseProxySetupMonitor/resources.js", "diffHunk": "@@ -0,0 +1,49 @@\n+(function () {\n+\tvar redirectForm = document.getElementById('redirect-error');\n+\tif (!redirectForm) {\n+\t\tconsole.warn('This script expects to have an element with id=\"redirect-error\" to be working.');\n+\t\treturn;\n+\t}\n+\n+\tvar urlToTest = redirectForm.getAttribute('data-url');\n+\tvar callUrlToTest = function(testWithContext, callback) {\n+\t\tvar options = {\n+\t\t\tonComplete: callback\n+\t\t};\n+\t\tif (testWithContext === true) {\n+\t\t\toptions.parameters = { testWithContext: true };\n+\t\t}\n+\t\tnew Ajax.Request(urlToTest, options);\n+\t};\n+\t\n+\tvar displayWarningMessage = function(withContextMessage) {\n+\t\tredirectForm.classList.remove('reverse-proxy__hidden');\n+\t\tif (withContextMessage === true) {\n+\t\t\tredirectForm.querySelectorAll('.js-context-message').forEach(node =>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "133cff776b2a15fd6eba3db9764483c223665662"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "231e6a7aef3818a6b2288677e04118eaa223327d", "author": {"user": {"login": "Wadeck", "name": "Wadeck Follonier"}}, "url": "https://github.com/jenkinsci/jenkins/commit/231e6a7aef3818a6b2288677e04118eaa223327d", "committedDate": "2020-04-05T16:50:52Z", "message": "The forgotten one"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNTkyMjMz", "url": "https://github.com/jenkinsci/jenkins/pull/4626#pullrequestreview-400592233", "createdAt": "2020-04-27T02:31:27Z", "commit": {"oid": "231e6a7aef3818a6b2288677e04118eaa223327d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNzcyNzk4", "url": "https://github.com/jenkinsci/jenkins/pull/4626#pullrequestreview-400772798", "createdAt": "2020-04-27T09:19:51Z", "commit": {"oid": "231e6a7aef3818a6b2288677e04118eaa223327d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjUwNzg1", "url": "https://github.com/jenkinsci/jenkins/pull/4626#pullrequestreview-405250785", "createdAt": "2020-05-04T18:43:54Z", "commit": {"oid": "231e6a7aef3818a6b2288677e04118eaa223327d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODo0Mzo1NFrOGQNUvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODo0Mzo1NFrOGQNUvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY0ODcwMw==", "bodyText": "This should have been set-up or configuration", "url": "https://github.com/jenkinsci/jenkins/pull/4626#discussion_r419648703", "createdAt": "2020-05-04T18:43:54Z", "author": {"login": "jsoref"}, "path": "core/src/main/resources/hudson/diagnosis/ReverseProxySetupMonitor/message.properties", "diffHunk": "@@ -1 +1,2 @@\n-blurb=It appears that your reverse proxy set up is broken.\n\\ No newline at end of file\n+blurb=It appears that your reverse proxy set up is broken.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "231e6a7aef3818a6b2288677e04118eaa223327d"}, "originalPosition": 3}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1391, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}