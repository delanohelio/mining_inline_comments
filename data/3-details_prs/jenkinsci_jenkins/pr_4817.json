{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4MTQzMTYx", "number": 4817, "title": "[JENKINS-62755] Introduce Fingerprint Cleanup in External Storage API", "bodyText": "See JENKINS-62755.\nSee JEP-226.\n\nProposed changelog entries\n\nDeveloper: Introduce new FingerprintStorage methods: iterateAndCleanupFingerprints, cleanFingerprint to allow external fingerprint storages to configure fingerprint cleanup.\nUser: Creates a Fingerprint cleanup configuration page which allows enabling/disabling fingerprint cleanup.\n\n\nProposed upgrade guidelines\nN/A\nSubmitter checklist\n\n (If applicable) Jira issue is well described\n Changelog entries and upgrade guidelines are appropriate for the audience affected by the change (users or developer, depending on the change). Examples\n\nFill-in the Proposed changelog entries section only if there are breaking changes or other changes which may require extra steps from users during the upgrade\n\n\n Appropriate autotests or explanation to why this change has no tests\n For dependency updates: links to external changelogs and, if possible, full diffs\n\n\nDesired reviewers\n@mention\n\nMaintainer checklist\nBefore the changes are marked as ready-for-merge:\n\n There are at least 2 approvals for the pull request and no outstanding requests for change\n Conversations in the pull request are over OR it is explicit that a reviewer does not block the change\n Changelog entries in the PR title and/or Proposed changelog entries are correct\n Proper changelog labels are set so that the changelog can be generated automatically\n If the change needs additional upgrade steps from users, upgrade-guide-needed label is set and there is a Proposed upgrade guidelines section in the PR title. (example)\n If it would make sense to backport the change to LTS, a Jira issue must exist, be a Bug or Improvement, and be labeled as lts-candidate to be considered (see query).", "createdAt": "2020-06-22T19:48:58Z", "url": "https://github.com/jenkinsci/jenkins/pull/4817", "merged": true, "mergeCommit": {"oid": "be28d586b5db3cd3a5b7bbbfa265e73e86b6446b"}, "closed": true, "closedAt": "2020-07-21T04:20:48Z", "author": {"login": "stellargo"}, "timelineItems": {"totalCount": 53, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABct2Q4NgH2gAyNDM4MTQzMTYxOjI4N2Y4ZGZlMGU0NTJmYmYxNTMzZGIzOTQxYzUyMDVlNjM5ZjUyODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc2M8QQAFqTQ1MTA3NDkyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "287f8dfe0e452fbf1533db3941c5205e639f5281", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/287f8dfe0e452fbf1533db3941c5205e639f5281", "committedDate": "2020-06-22T19:45:59Z", "message": "Create new FingerprintCleanupThread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59bdf8d51c35bfea8450e74eaed892799bfa5700", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/59bdf8d51c35bfea8450e74eaed892799bfa5700", "committedDate": "2020-06-23T03:51:05Z", "message": "Moved test to jenkins"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f954d10557ff02cc6a7ce0b75f74a7cc5b834bb8", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/f954d10557ff02cc6a7ce0b75f74a7cc5b834bb8", "committedDate": "2020-06-23T03:52:20Z", "message": "Add license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7950fab3927f7288b7993076457c72a491558878", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/7950fab3927f7288b7993076457c72a491558878", "committedDate": "2020-06-23T03:53:23Z", "message": "Fix license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c54aeb729e84153696cf6305cb7955000799db8e", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/c54aeb729e84153696cf6305cb7955000799db8e", "committedDate": "2020-06-23T15:49:56Z", "message": "Fix some tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82d65b97e8f2a08906b8900939dcd0be06c87669", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/82d65b97e8f2a08906b8900939dcd0be06c87669", "committedDate": "2020-06-23T16:47:52Z", "message": "Fix all tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c274871133bb68d7a18493f27611dfdcc344c764", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/c274871133bb68d7a18493f27611dfdcc344c764", "committedDate": "2020-06-23T16:49:21Z", "message": "Remove redundant imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f6d00ebd799667a2797b4469ff916e643c457d9", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/3f6d00ebd799667a2797b4469ff916e643c457d9", "committedDate": "2020-06-23T17:07:57Z", "message": "Add documentation; add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5bb69dd0abc9e0edd88ba0559f0c60064370dc0", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/a5bb69dd0abc9e0edd88ba0559f0c60064370dc0", "committedDate": "2020-06-23T18:16:55Z", "message": "Fix errors in fingerprintertest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b198246c9e949491914b930ade47771c3dc71251", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/b198246c9e949491914b930ade47771c3dc71251", "committedDate": "2020-06-23T18:17:14Z", "message": "Merge remote-tracking branch 'upstream/master' into fp_cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5daa43c86ca2aea6078de2176485e98cd049c5a3", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/5daa43c86ca2aea6078de2176485e98cd049c5a3", "committedDate": "2020-06-23T18:23:23Z", "message": "Remove default fingerprint cleanup implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da9664fab4883bcc28dbc5552dc28853500892bb", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/da9664fab4883bcc28dbc5552dc28853500892bb", "committedDate": "2020-06-23T18:24:27Z", "message": "Remove override from execute"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "383c47121586f5d772ae506f017778d0b1be2b2f", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/383c47121586f5d772ae506f017778d0b1be2b2f", "committedDate": "2020-06-24T16:25:59Z", "message": "Undo author deletion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a20c73e8757955a43899e7204e7071f0f98ae640", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/a20c73e8757955a43899e7204e7071f0f98ae640", "committedDate": "2020-06-24T16:26:43Z", "message": "Remove redundant import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2ODQyODU4", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-436842858", "createdAt": "2020-06-24T17:06:58Z", "commit": {"oid": "383c47121586f5d772ae506f017778d0b1be2b2f"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNzowNjo1OFrOGobU5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNzoxMTozOFrOGobfLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0Mzk0Mw==", "bodyText": "It used to be a public APi before accmod was introduced. Should be safe enough, I cannot find or imagine an external usage.", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r445043943", "createdAt": "2020-06-24T17:06:58Z", "author": {"login": "oleg-nenashev"}, "path": "core/src/main/java/jenkins/fingerprints/FileFingerprintCleanupThread.java", "diffHunk": "@@ -50,30 +48,14 @@\n  *\n  * @author Kohsuke Kawaguchi\n  */\n-@Extension @Symbol(\"fingerprintCleanup\")\n+@Extension(ordinal=-100)\n @Restricted(NoExternalUse.class)\n-public class FingerprintCleanupThread extends AsyncPeriodicWork {\n+public class FileFingerprintCleanupThread extends FingerprintCleanupThread {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "383c47121586f5d772ae506f017778d0b1be2b2f"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0NDY1NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             */\n          \n          \n            \n             * @since TODO\n          \n          \n            \n             */", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r445044655", "createdAt": "2020-06-24T17:08:06Z", "author": {"login": "oleg-nenashev"}, "path": "core/src/main/java/jenkins/fingerprints/FingerprintCleanupThread.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright (c) 2020, Jenkins project contributors\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package jenkins.fingerprints;\n+\n+import edu.umd.cs.findbugs.annotations.NonNull;\n+import hudson.ExtensionList;\n+import hudson.ExtensionPoint;\n+import hudson.Functions;\n+import hudson.model.AsyncPeriodicWork;\n+import hudson.model.Fingerprint;\n+import hudson.model.TaskListener;\n+import jenkins.model.FingerprintFacet;\n+import jenkins.model.Jenkins;\n+import org.jenkinsci.Symbol;\n+import org.kohsuke.accmod.Restricted;\n+import org.kohsuke.accmod.restrictions.Beta;\n+\n+import java.io.IOException;\n+import java.util.Date;\n+import java.util.List;\n+\n+/**\n+ * Fingerprint Cleanup API.\n+ * To implement custom fingerprint cleanup by external storage plugin, extend this class, and override the\n+ * {@link #execute(TaskListener)} method.\n+ * {@link #cleanFingerprint(Fingerprint, TaskListener)} can be used to clean the fingerprint.\n+ */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "383c47121586f5d772ae506f017778d0b1be2b2f"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0NTA4OQ==", "bodyText": "Could lead to funny results if 2+ plugins are installed, e.g. in the case of migrating from one storage to another", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r445045089", "createdAt": "2020-06-24T17:08:58Z", "author": {"login": "oleg-nenashev"}, "path": "core/src/main/java/jenkins/fingerprints/FingerprintCleanupThread.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright (c) 2020, Jenkins project contributors\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package jenkins.fingerprints;\n+\n+import edu.umd.cs.findbugs.annotations.NonNull;\n+import hudson.ExtensionList;\n+import hudson.ExtensionPoint;\n+import hudson.Functions;\n+import hudson.model.AsyncPeriodicWork;\n+import hudson.model.Fingerprint;\n+import hudson.model.TaskListener;\n+import jenkins.model.FingerprintFacet;\n+import jenkins.model.Jenkins;\n+import org.jenkinsci.Symbol;\n+import org.kohsuke.accmod.Restricted;\n+import org.kohsuke.accmod.restrictions.Beta;\n+\n+import java.io.IOException;\n+import java.util.Date;\n+import java.util.List;\n+\n+/**\n+ * Fingerprint Cleanup API.\n+ * To implement custom fingerprint cleanup by external storage plugin, extend this class, and override the\n+ * {@link #execute(TaskListener)} method.\n+ * {@link #cleanFingerprint(Fingerprint, TaskListener)} can be used to clean the fingerprint.\n+ */\n+@Symbol(\"fingerprintCleanup\")\n+@Restricted(Beta.class)\n+public abstract class FingerprintCleanupThread extends AsyncPeriodicWork implements ExtensionPoint {\n+\n+    public FingerprintCleanupThread() {\n+        super(\"Fingerprint cleanup\");\n+    }\n+\n+    public long getRecurrencePeriod() {\n+        return DAY;\n+    }\n+\n+    /**\n+     * Invokes the periodic job.\n+     */\n+    public static void invoke() {\n+        get().run();\n+    }\n+\n+    /**\n+     * Returns the first implementation of {@link FingerprintCleanupThread} for the instance.\n+     * External storage plugins which implement {@link FingerprintCleanupThread} are given a higher priority.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "383c47121586f5d772ae506f017778d0b1be2b2f"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0NjU3NA==", "bodyText": "Please document what the implementations are expected to do there.\nMaybe a better name like iterateAndCleanupFingerprints() is better", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r445046574", "createdAt": "2020-06-24T17:11:38Z", "author": {"login": "oleg-nenashev"}, "path": "core/src/main/java/jenkins/fingerprints/FingerprintCleanupThread.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * The MIT License\n+ *\n+ * Copyright (c) 2020, Jenkins project contributors\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included in\n+ * all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+ * THE SOFTWARE.\n+ */\n+package jenkins.fingerprints;\n+\n+import edu.umd.cs.findbugs.annotations.NonNull;\n+import hudson.ExtensionList;\n+import hudson.ExtensionPoint;\n+import hudson.Functions;\n+import hudson.model.AsyncPeriodicWork;\n+import hudson.model.Fingerprint;\n+import hudson.model.TaskListener;\n+import jenkins.model.FingerprintFacet;\n+import jenkins.model.Jenkins;\n+import org.jenkinsci.Symbol;\n+import org.kohsuke.accmod.Restricted;\n+import org.kohsuke.accmod.restrictions.Beta;\n+\n+import java.io.IOException;\n+import java.util.Date;\n+import java.util.List;\n+\n+/**\n+ * Fingerprint Cleanup API.\n+ * To implement custom fingerprint cleanup by external storage plugin, extend this class, and override the\n+ * {@link #execute(TaskListener)} method.\n+ * {@link #cleanFingerprint(Fingerprint, TaskListener)} can be used to clean the fingerprint.\n+ */\n+@Symbol(\"fingerprintCleanup\")\n+@Restricted(Beta.class)\n+public abstract class FingerprintCleanupThread extends AsyncPeriodicWork implements ExtensionPoint {\n+\n+    public FingerprintCleanupThread() {\n+        super(\"Fingerprint cleanup\");\n+    }\n+\n+    public long getRecurrencePeriod() {\n+        return DAY;\n+    }\n+\n+    /**\n+     * Invokes the periodic job.\n+     */\n+    public static void invoke() {\n+        get().run();\n+    }\n+\n+    /**\n+     * Returns the first implementation of {@link FingerprintCleanupThread} for the instance.\n+     * External storage plugins which implement {@link FingerprintCleanupThread} are given a higher priority.\n+     */\n+    public static FingerprintCleanupThread get() {\n+        return ExtensionList.lookup(FingerprintCleanupThread.class).get(0);\n+    }\n+\n+    public abstract void execute(TaskListener taskListener);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "383c47121586f5d772ae506f017778d0b1be2b2f"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83aa71aa5faa60407d9e9a103c1f68a8736d1076", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/83aa71aa5faa60407d9e9a103c1f68a8736d1076", "committedDate": "2020-06-24T17:45:03Z", "message": "Move fingerprint cleanup to storage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8589392e30af000fde32988cb56c697da558552", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/c8589392e30af000fde32988cb56c697da558552", "committedDate": "2020-06-24T17:48:07Z", "message": "Fix spacing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f237c7f26f70aaa0efefdea63fe7c8abcdc2145", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/6f237c7f26f70aaa0efefdea63fe7c8abcdc2145", "committedDate": "2020-06-24T17:48:47Z", "message": "Add new line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec5ff5ac0735c5b9f7fa78b590007124418e0948", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/ec5ff5ac0735c5b9f7fa78b590007124418e0948", "committedDate": "2020-06-24T17:50:14Z", "message": "Minor fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac6dfd795dc479475187c5d03f23e39a366ed856", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/ac6dfd795dc479475187c5d03f23e39a366ed856", "committedDate": "2020-06-24T18:10:10Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bc7fea9988d4a48657384cd06facf0ec3288bdc", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/7bc7fea9988d4a48657384cd06facf0ec3288bdc", "committedDate": "2020-06-24T21:20:08Z", "message": "Merge remote-tracking branch 'upstream/master' into fp_cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/383cbe835e94d39141651d8d9369c38f720de453", "committedDate": "2020-06-24T22:08:49Z", "message": "Add documentation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3MTc4NjE3", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-437178617", "createdAt": "2020-06-25T05:30:51Z", "commit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwNTozMDo1MlrOGor5lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQwNTozMDo1MlrOGor5lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMxNTQ3Nw==", "bodyText": "It is only for tests, right? If the test is applicable to File Fingerprint storage, it makes sense to relocate the dependent test to a new class and use the package scope. Option B is to use @Restricted(NoExternalUse.class) to prevent external usages", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r445315477", "createdAt": "2020-06-25T05:30:52Z", "author": {"login": "oleg-nenashev"}, "path": "core/src/main/java/jenkins/fingerprints/FileFingerprintStorage.java", "diffHunk": "@@ -57,6 +62,8 @@\n \n     private static final Logger logger = Logger.getLogger(FileFingerprintStorage.class.getName());\n     private static final DateConverter DATE_CONVERTER = new DateConverter();\n+    public static final String FINGERPRINTS_DIR_NAME = \"fingerprints\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTc4NjAz", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-437578603", "createdAt": "2020-06-25T14:55:45Z", "commit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo1NTo0NVrOGo-mag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo1NTo0NVrOGo-mag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyMTg2Ng==", "bodyText": "Why == 2?", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r445621866", "createdAt": "2020-06-25T14:55:45Z", "author": {"login": "afalko"}, "path": "core/src/main/java/jenkins/fingerprints/FileFingerprintStorage.java", "diffHunk": "@@ -210,6 +217,61 @@ public boolean isReady() {\n         return new File(Jenkins.get().getRootDir(),\"fingerprints\").exists();\n     }\n \n+    /**\n+     * Perform Fingerprint cleanup.\n+     */\n+    public void iterateAndCleanupFingerprints(TaskListener taskListener) {\n+        Object fingerprintStorage = FingerprintStorage.get();\n+        if (!(fingerprintStorage instanceof FileFingerprintStorage)) {\n+            logger.fine(\"External fingerprint storage is configured. Skipping execution\");\n+            return;\n+        }\n+\n+        int numFiles = 0;\n+\n+        File root = new File(getRootDir(), FINGERPRINTS_DIR_NAME);\n+        File[] files1 = root.listFiles(f -> f.isDirectory() && f.getName().length()==2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTc5NzM0", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-437579734", "createdAt": "2020-06-25T14:56:56Z", "commit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo1Njo1NlrOGo-phg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo1Njo1NlrOGo-phg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyMjY2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    taskListener.getLogger().println(\"Cleaned up \"+numFiles+\" records\");\n          \n          \n            \n                    taskListener.getLogger().println(String.format(\"Cleaned up %d records\", records));", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r445622662", "createdAt": "2020-06-25T14:56:56Z", "author": {"login": "afalko"}, "path": "core/src/main/java/jenkins/fingerprints/FileFingerprintStorage.java", "diffHunk": "@@ -210,6 +217,61 @@ public boolean isReady() {\n         return new File(Jenkins.get().getRootDir(),\"fingerprints\").exists();\n     }\n \n+    /**\n+     * Perform Fingerprint cleanup.\n+     */\n+    public void iterateAndCleanupFingerprints(TaskListener taskListener) {\n+        Object fingerprintStorage = FingerprintStorage.get();\n+        if (!(fingerprintStorage instanceof FileFingerprintStorage)) {\n+            logger.fine(\"External fingerprint storage is configured. Skipping execution\");\n+            return;\n+        }\n+\n+        int numFiles = 0;\n+\n+        File root = new File(getRootDir(), FINGERPRINTS_DIR_NAME);\n+        File[] files1 = root.listFiles(f -> f.isDirectory() && f.getName().length()==2);\n+        if(files1!=null) {\n+            for (File file1 : files1) {\n+                File[] files2 = file1.listFiles(f -> f.isDirectory() && f.getName().length()==2);\n+                for(File file2 : files2) {\n+                    File[] files3 = file2.listFiles(f -> f.isFile() && FINGERPRINT_FILE_PATTERN.matcher(f.getName()).matches());\n+                    for(File file3 : files3) {\n+                        if(cleanFingerprint(file3, taskListener))\n+                            numFiles++;\n+                    }\n+                    deleteIfEmpty(file2);\n+                }\n+                deleteIfEmpty(file1);\n+            }\n+        }\n+\n+        taskListener.getLogger().println(\"Cleaned up \"+numFiles+\" records\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTgwODQ3", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-437580847", "createdAt": "2020-06-25T14:58:03Z", "commit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo1ODowNFrOGo-sww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo1ODowNFrOGo-sww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyMzQ5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                listener.getLogger().println(deletionBlockerFacet.getClass().getName() + \" created on \" + new Date(deletionBlockerFacet.getTimestamp()) + \" blocked deletion of \" + fingerprintFile);\n          \n          \n            \n                                listener.getLogger().println(String.format(\"%s created on %s blocked deletion of %s\", deletionBlockerFacet.getClass().getName(), new Date(deletionBlockerFacet.getTimestamp()), fingerprintFile));", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r445623491", "createdAt": "2020-06-25T14:58:04Z", "author": {"login": "afalko"}, "path": "core/src/main/java/jenkins/fingerprints/FileFingerprintStorage.java", "diffHunk": "@@ -210,6 +217,61 @@ public boolean isReady() {\n         return new File(Jenkins.get().getRootDir(),\"fingerprints\").exists();\n     }\n \n+    /**\n+     * Perform Fingerprint cleanup.\n+     */\n+    public void iterateAndCleanupFingerprints(TaskListener taskListener) {\n+        Object fingerprintStorage = FingerprintStorage.get();\n+        if (!(fingerprintStorage instanceof FileFingerprintStorage)) {\n+            logger.fine(\"External fingerprint storage is configured. Skipping execution\");\n+            return;\n+        }\n+\n+        int numFiles = 0;\n+\n+        File root = new File(getRootDir(), FINGERPRINTS_DIR_NAME);\n+        File[] files1 = root.listFiles(f -> f.isDirectory() && f.getName().length()==2);\n+        if(files1!=null) {\n+            for (File file1 : files1) {\n+                File[] files2 = file1.listFiles(f -> f.isDirectory() && f.getName().length()==2);\n+                for(File file2 : files2) {\n+                    File[] files3 = file2.listFiles(f -> f.isFile() && FINGERPRINT_FILE_PATTERN.matcher(f.getName()).matches());\n+                    for(File file3 : files3) {\n+                        if(cleanFingerprint(file3, taskListener))\n+                            numFiles++;\n+                    }\n+                    deleteIfEmpty(file2);\n+                }\n+                deleteIfEmpty(file1);\n+            }\n+        }\n+\n+        taskListener.getLogger().println(\"Cleaned up \"+numFiles+\" records\");\n+    }\n+\n+    private boolean cleanFingerprint(File fingerprintFile, TaskListener listener) {\n+        try {\n+            Fingerprint fp = loadFingerprint(fingerprintFile);\n+            if (fp == null || (!fp.isAlive() && fp.getFacetBlockingDeletion() == null) ) {\n+                listener.getLogger().println(\"deleting obsolete \" + fingerprintFile);\n+                fingerprintFile.delete();\n+                return true;\n+            } else {\n+                if (!fp.isAlive()) {\n+                    FingerprintFacet deletionBlockerFacet = fp.getFacetBlockingDeletion();\n+                    listener.getLogger().println(deletionBlockerFacet.getClass().getName() + \" created on \" + new Date(deletionBlockerFacet.getTimestamp()) + \" blocked deletion of \" + fingerprintFile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTgxMzQz", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-437581343", "createdAt": "2020-06-25T14:58:34Z", "commit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo1ODozNFrOGo-uRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo1ODozNFrOGo-uRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyMzg3Nw==", "bodyText": "curlies", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r445623877", "createdAt": "2020-06-25T14:58:34Z", "author": {"login": "afalko"}, "path": "core/src/main/java/jenkins/fingerprints/FileFingerprintStorage.java", "diffHunk": "@@ -255,4 +317,26 @@ private static String serialize(Fingerprint.RangeSet src) {\n         return buf.toString();\n     }\n \n+    /**\n+     * Deletes a directory if it's empty.\n+     */\n+    private void deleteIfEmpty(File dir) {\n+        String[] r = dir.list();\n+        if(r==null)     return; // can happen in a rare occasion\n+        if(r.length==0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "originalPosition": 111}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTgyMzAx", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-437582301", "createdAt": "2020-06-25T14:59:32Z", "commit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo1OTozMlrOGo-xIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo1OTozMlrOGo-xIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYyNDYxMQ==", "bodyText": "Hmmm...this seems duplicate of https://github.com/jenkinsci/jenkins/pull/4817/files#r445623491", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r445624611", "createdAt": "2020-06-25T14:59:32Z", "author": {"login": "afalko"}, "path": "core/src/main/java/jenkins/fingerprints/FingerprintStorage.java", "diffHunk": "@@ -80,4 +86,39 @@ public static FingerprintStorage get() {\n      */\n     public abstract boolean isReady();\n \n+    /**\n+     * Iterates a set of fingerprints, and cleans them up.\n+     * This method is called periodically by {@link hudson.model.FingerprintCleanupThread}.\n+     * For reference, see {@link FileFingerprintStorage#iterateAndCleanupFingerprints(TaskListener)}\n+     * For cleaning up the fingerprint {@link #cleanFingerprint(Fingerprint, TaskListener)} may be used.\n+     */\n+    public abstract void iterateAndCleanupFingerprints(TaskListener taskListener);\n+\n+    /**\n+     * This method performs the cleanup of the given fingerprint.\n+     */\n+    public boolean cleanFingerprint(@NonNull Fingerprint fingerprint, TaskListener taskListener) {\n+        try {\n+            if (!fingerprint.isAlive() && fingerprint.getFacetBlockingDeletion() == null) {\n+                taskListener.getLogger().println(\"deleting obsolete \" + fingerprint.toString());\n+                Fingerprint.delete(fingerprint.getHashString());\n+                return true;\n+            } else {\n+                if (!fingerprint.isAlive()) {\n+                    FingerprintFacet deletionBlockerFacet = fingerprint.getFacetBlockingDeletion();\n+                    taskListener.getLogger().println(deletionBlockerFacet.getClass().getName() + \" created on \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTgzMzQ1", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-437583345", "createdAt": "2020-06-25T15:00:32Z", "commit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3OTQ0ODM2", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-437944836", "createdAt": "2020-06-26T00:33:06Z", "commit": {"oid": "383cbe835e94d39141651d8d9369c38f720de453"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f51b48ae5744903bcaa49218f03f198eca2c6b9", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/7f51b48ae5744903bcaa49218f03f198eca2c6b9", "committedDate": "2020-06-26T03:10:29Z", "message": "Introduce fingerprint cleanup toggle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99d1ab16c772d34fd8012054323f176bd57fb481", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/99d1ab16c772d34fd8012054323f176bd57fb481", "committedDate": "2020-06-26T03:20:17Z", "message": "Link cleanup config to thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "294d20b7632cf1a40f57204f96a2f26ecf09dd4b", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/294d20b7632cf1a40f57204f96a2f26ecf09dd4b", "committedDate": "2020-06-29T03:36:38Z", "message": "Add file system cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4OTA0MDMy", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-438904032", "createdAt": "2020-06-29T05:56:36Z", "commit": {"oid": "294d20b7632cf1a40f57204f96a2f26ecf09dd4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46c9d4da030a02462a28e72d57e6d3c7009cbe30", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/46c9d4da030a02462a28e72d57e6d3c7009cbe30", "committedDate": "2020-06-29T18:18:09Z", "message": "Add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18bc44ced97c29d3703706076af75989ec98fb06", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/18bc44ced97c29d3703706076af75989ec98fb06", "committedDate": "2020-06-30T02:27:51Z", "message": "Introduce external fingerprint storage cleanup tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64a826628cd335ea94bcb4d1524eb4a620d89aac", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/64a826628cd335ea94bcb4d1524eb4a620d89aac", "committedDate": "2020-06-30T02:37:44Z", "message": "Remove redundant statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1870552433b016a6f7aa2f9591994b82ec56800e", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/1870552433b016a6f7aa2f9591994b82ec56800e", "committedDate": "2020-06-30T03:30:39Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d72d0c17ed6c28ed34dd480fc15dd5a54984617", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/1d72d0c17ed6c28ed34dd480fc15dd5a54984617", "committedDate": "2020-06-30T03:31:37Z", "message": "Merge remote-tracking branch 'upstream/master' into fp_cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMTMxOTI1", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-440131925", "createdAt": "2020-06-30T15:26:08Z", "commit": {"oid": "1d72d0c17ed6c28ed34dd480fc15dd5a54984617"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7157e3c0b04d75233fde20204b7379ce1f5c9ee4", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/7157e3c0b04d75233fde20204b7379ce1f5c9ee4", "committedDate": "2020-07-01T15:08:45Z", "message": "Improve docstring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd15db74c20158e43cf33e93522cd41ca49d7fc2", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/bd15db74c20158e43cf33e93522cd41ca49d7fc2", "committedDate": "2020-07-05T15:02:01Z", "message": "Merge remote-tracking branch 'upstream/master' into fp_cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8552cc48865afd53ff92f7b8e4e0da4daa830d4", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/e8552cc48865afd53ff92f7b8e4e0da4daa830d4", "committedDate": "2020-07-07T03:06:35Z", "message": "Introduce shouldNotCleanFingerprintsWhenDisabled test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb95e9290a2d402ff5f4696a747a7578fce7331f", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/cb95e9290a2d402ff5f4696a747a7578fce7331f", "committedDate": "2020-07-17T15:06:13Z", "message": "Resolve merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "342bea66e312a7d67be28b97d51d18b46e0d765e", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/342bea66e312a7d67be28b97d51d18b46e0d765e", "committedDate": "2020-07-17T15:15:03Z", "message": "Fix default cleanup value"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNzQ0NjQ5", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-450744649", "createdAt": "2020-07-17T15:17:31Z", "commit": {"oid": "342bea66e312a7d67be28b97d51d18b46e0d765e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNToxNzozMVrOGzXDgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNToyMjozMFrOGzXPLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUwODI5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void iterateAndCleanupFingerprints(TaskListener taskListener) {\n          \n          \n            \n                @Override\n          \n          \n            \n                public void iterateAndCleanupFingerprints(TaskListener taskListener) {", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r456508291", "createdAt": "2020-07-17T15:17:31Z", "author": {"login": "oleg-nenashev"}, "path": "core/src/main/java/jenkins/fingerprints/FileFingerprintStorage.java", "diffHunk": "@@ -216,6 +223,55 @@ public boolean isReady() {\n         return new File(Jenkins.get().getRootDir(),\"fingerprints\").exists();\n     }\n \n+    /**\n+     * Perform Fingerprint cleanup.\n+     */\n+    public void iterateAndCleanupFingerprints(TaskListener taskListener) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "342bea66e312a7d67be28b97d51d18b46e0d765e"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUwODU1NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * This method performs the cleanup of the given fingerprint.\n          \n          \n            \n                 * This method performs the cleanup of the given fingerprint.\n          \n          \n            \n                 *\n          \n          \n            \n                 * @since TODO", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r456508555", "createdAt": "2020-07-17T15:18:01Z", "author": {"login": "oleg-nenashev"}, "path": "core/src/main/java/jenkins/fingerprints/FingerprintStorage.java", "diffHunk": "@@ -80,8 +93,51 @@ public static FingerprintStorage get() {\n      */\n     public abstract boolean isReady();\n \n+    /**\n+     * Iterates a set of fingerprints, and cleans them up. Cleaning up a fingerprint implies deleting the builds\n+     * associated with the fingerprints, once they are no longer available on the system. If all the builds have been\n+     * deleted, the fingerprint itself is deleted.\n+     *\n+     * This method is called periodically by {@link hudson.model.FingerprintCleanupThread}.\n+     * For reference, see {@link FileFingerprintStorage#iterateAndCleanupFingerprints(TaskListener)}\n+     * For cleaning up the fingerprint {@link #cleanFingerprint(Fingerprint, TaskListener)} may be used.\n+     */\n+    public abstract void iterateAndCleanupFingerprints(TaskListener taskListener);\n+\n+    /**\n+     * This method performs the cleanup of the given fingerprint.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "342bea66e312a7d67be28b97d51d18b46e0d765e"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUwODc2Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 */\n          \n          \n            \n                 * @since TODO\n          \n          \n            \n                 */", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r456508767", "createdAt": "2020-07-17T15:18:18Z", "author": {"login": "oleg-nenashev"}, "path": "core/src/main/java/jenkins/fingerprints/FingerprintStorage.java", "diffHunk": "@@ -80,8 +93,51 @@ public static FingerprintStorage get() {\n      */\n     public abstract boolean isReady();\n \n+    /**\n+     * Iterates a set of fingerprints, and cleans them up. Cleaning up a fingerprint implies deleting the builds\n+     * associated with the fingerprints, once they are no longer available on the system. If all the builds have been\n+     * deleted, the fingerprint itself is deleted.\n+     *\n+     * This method is called periodically by {@link hudson.model.FingerprintCleanupThread}.\n+     * For reference, see {@link FileFingerprintStorage#iterateAndCleanupFingerprints(TaskListener)}\n+     * For cleaning up the fingerprint {@link #cleanFingerprint(Fingerprint, TaskListener)} may be used.\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "342bea66e312a7d67be28b97d51d18b46e0d765e"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUxMDU1Nw==", "bodyText": "It will not work for configurations deserialized from the disk", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r456510557", "createdAt": "2020-07-17T15:21:16Z", "author": {"login": "oleg-nenashev"}, "path": "core/src/main/java/jenkins/fingerprints/GlobalFingerprintConfiguration.java", "diffHunk": "@@ -43,6 +43,7 @@\n \n     private FingerprintStorage storage = ExtensionList.lookupSingleton(FileFingerprintStorage.class);\n     private static final Logger LOGGER = Logger.getLogger(GlobalFingerprintConfiguration.class.getName());\n+    private boolean fingerprintCleanup = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "342bea66e312a7d67be28b97d51d18b46e0d765e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjUxMTI3OA==", "bodyText": "If it is private, it does not override the implementation in upper class.  Looks like a \ud83d\udc1b for API users", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r456511278", "createdAt": "2020-07-17T15:22:30Z", "author": {"login": "oleg-nenashev"}, "path": "core/src/main/java/jenkins/fingerprints/FileFingerprintStorage.java", "diffHunk": "@@ -216,6 +223,55 @@ public boolean isReady() {\n         return new File(Jenkins.get().getRootDir(),\"fingerprints\").exists();\n     }\n \n+    /**\n+     * Perform Fingerprint cleanup.\n+     */\n+    public void iterateAndCleanupFingerprints(TaskListener taskListener) {\n+        int numFiles = 0;\n+\n+        File root = new File(getRootDir(), FINGERPRINTS_DIR_NAME);\n+        File[] files1 = root.listFiles(f -> f.isDirectory() && f.getName().length()==2);\n+        if(files1!=null) {\n+            for (File file1 : files1) {\n+                File[] files2 = file1.listFiles(f -> f.isDirectory() && f.getName().length()==2);\n+                for(File file2 : files2) {\n+                    File[] files3 = file2.listFiles(f -> f.isFile() && FINGERPRINT_FILE_PATTERN.matcher(f.getName()).matches());\n+                    for(File file3 : files3) {\n+                        if(cleanFingerprint(file3, taskListener))\n+                            numFiles++;\n+                    }\n+                    deleteIfEmpty(file2);\n+                }\n+                deleteIfEmpty(file1);\n+            }\n+        }\n+\n+        taskListener.getLogger().println(\"Cleaned up \"+numFiles+\" records\");\n+    }\n+\n+    private boolean cleanFingerprint(File fingerprintFile, TaskListener listener) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "342bea66e312a7d67be28b97d51d18b46e0d765e"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9e5a3b15066e68122268632a2c304a084b38827", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/a9e5a3b15066e68122268632a2c304a084b38827", "committedDate": "2020-07-17T15:41:22Z", "message": "Minor fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a3896db12fa57ffd112fca217cdf464991ebdce", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/2a3896db12fa57ffd112fca217cdf464991ebdce", "committedDate": "2020-07-17T15:49:38Z", "message": "Enabled->Disabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "512f086609f3a83edd568a792148f52ed2c9c510", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/512f086609f3a83edd568a792148f52ed2c9c510", "committedDate": "2020-07-17T17:22:18Z", "message": "Fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODQ3NjEy", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-450847612", "createdAt": "2020-07-17T17:48:30Z", "commit": {"oid": "512f086609f3a83edd568a792148f52ed2c9c510"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNzo0ODozMFrOGzb2xA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxNzo0ODozMFrOGzb2xA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjU4Njk0OA==", "bodyText": "Usually Java APIs use 'isSomething()' for boolean getters", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r456586948", "createdAt": "2020-07-17T17:48:30Z", "author": {"login": "oleg-nenashev"}, "path": "core/src/main/java/jenkins/fingerprints/GlobalFingerprintConfiguration.java", "diffHunk": "@@ -63,6 +64,15 @@ public void setStorage(FingerprintStorage fingerprintStorage) {\n                 fingerprintStorage.getDescriptor().getDisplayName());\n     }\n \n+    public boolean getFingerprintCleanupDisabled() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "512f086609f3a83edd568a792148f52ed2c9c510"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "578b46f2a5ccc034d9bd4c93178f3eafa8bb3083", "author": {"user": {"login": "stellargo", "name": null}}, "url": "https://github.com/jenkinsci/jenkins/commit/578b46f2a5ccc034d9bd4c93178f3eafa8bb3083", "committedDate": "2020-07-17T18:00:13Z", "message": "get -> is"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDcyMTQ1", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-451072145", "createdAt": "2020-07-18T17:49:22Z", "commit": {"oid": "578b46f2a5ccc034d9bd4c93178f3eafa8bb3083"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxMDc0OTIy", "url": "https://github.com/jenkinsci/jenkins/pull/4817#pullrequestreview-451074922", "createdAt": "2020-07-18T18:42:31Z", "commit": {"oid": "578b46f2a5ccc034d9bd4c93178f3eafa8bb3083"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxODo0MjozMVrOGzp32Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQxODo0MjozMVrOGzp32Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjgxNjYwMQ==", "bodyText": "Is there any reason to disable this if there isn\u2019t an external plugin for fingerprints?", "url": "https://github.com/jenkinsci/jenkins/pull/4817#discussion_r456816601", "createdAt": "2020-07-18T18:42:31Z", "author": {"login": "timja"}, "path": "core/src/main/resources/jenkins/fingerprints/GlobalFingerprintConfiguration/config.jelly", "diffHunk": "@@ -19,11 +19,14 @@ THE SOFTWARE.\n -->\n <?jelly escape-by-default='true'?>\n <j:jelly xmlns:j=\"jelly:core\" xmlns:f=\"/lib/form\">\n-    <j:if test=\"${descriptor.fingerprintStorageDescriptors.size() gt 1}\">\n-        <f:section title=\"${%Fingerprints}\">\n+    <f:section title=\"${%Fingerprints}\">\n+        <f:entry title=\"Disable Fingerprint Cleanup\">\n+            <f:checkbox field=\"fingerprintCleanupDisabled\" default=\"${it.fingerprintCleanupDisabled}\" />", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "578b46f2a5ccc034d9bd4c93178f3eafa8bb3083"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2082, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}