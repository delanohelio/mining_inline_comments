{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1MTY5NDM5", "number": 4905, "title": "Shortlog strip console notes", "bodyText": "No JIRA ticket exists.\nWhile rendering log output for a large logfile Jenkins skips the beginning and shows the last 150KB of data. It is possible that the beginning of such a shortlog falls in the middle of a serialized ConsoleNote and then part of a Gziped and base64-encoded string gets rendered in the output.\nThis may lead to suspicions that something in the build went wrong and/or that Jenkins or one of its plugins did something wrong. In fact there is a pretty old issue in ansicolor-plugin suspecting just that.\nThis PR takes care of this by:\n\nExtending the amount of logfile data being read by an additional amount (preBuffer) used to detect if shortlog begin falls in the middle of a serialized ConsoleNote\nMoving the shortlog beginning (if needed) to just after the ConsoleNote\nAdding a negative and positive case scenario tests\n\nPlease let me know if you would prefer to have a full-blown JIRA ticket (the change is not that big) - I will be happy to create it if you think the issue is worth it.\nProposed changelog entries\n\nDo not render parts of a serialized ConsoleNote in truncated log output.\n\nProposed upgrade guidelines\nN/A\nSubmitter checklist\n\n Changelog entries and upgrade guidelines are appropriate for the audience affected by the change (users or developer, depending on the change). Examples\n\nFill-in the Proposed changelog entries section only if there are breaking changes or other changes which may require extra steps from users during the upgrade\n\n\n Appropriate autotests or explanation to why this change has no tests\n\n\nMaintainer checklist\nBefore the changes are marked as ready-for-merge:\n\n There are at least 2 approvals for the pull request and no outstanding requests for change\n Conversations in the pull request are over OR it is explicit that a reviewer does not block the change\n Changelog entries in the PR title and/or Proposed changelog entries are correct\n Proper changelog labels are set so that the changelog can be generated automatically\n If the change needs additional upgrade steps from users, upgrade-guide-needed label is set and there is a Proposed upgrade guidelines section in the PR title. (example)\n If it would make sense to backport the change to LTS, a Jira issue must exist, be a Bug or Improvement, and be labeled as lts-candidate to be considered (see query).", "createdAt": "2020-08-09T16:00:38Z", "url": "https://github.com/jenkinsci/jenkins/pull/4905", "merged": true, "mergeCommit": {"oid": "dd134ef84e642e851c1fcc8946bebef5cce840ca"}, "closed": true, "closedAt": "2020-10-08T13:29:48Z", "author": {"login": "tszmytka"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9N4YsgH2gAyNDY1MTY5NDM5OjhjZDVhZTkyOTkwOWNlNjcxMWRhZWY5ZDY5N2Q3NmVjYTI4OWMxNWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOjvWJAFqTUwMTAzNDQ5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8cd5ae929909ce6711daef9d697d76eca289c15d", "author": {"user": {"login": "tszmytka", "name": "Tomek Szmytka"}}, "url": "https://github.com/jenkinsci/jenkins/commit/8cd5ae929909ce6711daef9d697d76eca289c15d", "committedDate": "2020-08-09T13:45:49Z", "message": "Do not render parts of serialized a ConsoleNote if output begins in the middle of it. Generalize finding pre/postamble"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "857a2ac6b0c669ce4d12a60000f483fe6c7ed86b", "author": {"user": {"login": "tszmytka", "name": "Tomek Szmytka"}}, "url": "https://github.com/jenkinsci/jenkins/commit/857a2ac6b0c669ce4d12a60000f483fe6c7ed86b", "committedDate": "2020-08-09T15:16:13Z", "message": "Do not render parts of serialized a ConsoleNote while writing non-html output as well. Test sample script output."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f15c85693831ab3aa80c541942727026141aa1f6", "author": {"user": {"login": "tszmytka", "name": "Tomek Szmytka"}}, "url": "https://github.com/jenkinsci/jenkins/commit/f15c85693831ab3aa80c541942727026141aa1f6", "committedDate": "2020-08-09T15:17:37Z", "message": "Add positive scenario test case. Fine-tune implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a1f96925b6a19e03113eed3c1fec6953a3f0f86", "author": {"user": {"login": "tszmytka", "name": "Tomek Szmytka"}}, "url": "https://github.com/jenkinsci/jenkins/commit/4a1f96925b6a19e03113eed3c1fec6953a3f0f86", "committedDate": "2020-08-09T20:34:48Z", "message": "Render progressive output with explicitly set no preBuffer. Ensure only the relevant lines get processed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd4d86e88e9f898c8135f44955ee6b0ffa08e690", "author": {"user": {"login": "tszmytka", "name": "Tomek Szmytka"}}, "url": "https://github.com/jenkinsci/jenkins/commit/bd4d86e88e9f898c8135f44955ee6b0ffa08e690", "committedDate": "2020-09-12T16:49:06Z", "message": "Revert pre-buffer functionality.\nKeep tests in adjusted form."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be6cd7a33ee7907e9151c71d8892f5e2fc519e7a", "author": {"user": {"login": "tszmytka", "name": "Tomek Szmytka"}}, "url": "https://github.com/jenkinsci/jenkins/commit/be6cd7a33ee7907e9151c71d8892f5e2fc519e7a", "committedDate": "2020-09-13T11:58:52Z", "message": "Push offset forward to start writing log on line beginning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db7f231702d4b7fc53f01e0a41186ae0de798efd", "author": {"user": {"login": "tszmytka", "name": "Tomek Szmytka"}}, "url": "https://github.com/jenkinsci/jenkins/commit/db7f231702d4b7fc53f01e0a41186ae0de798efd", "committedDate": "2020-09-13T14:03:01Z", "message": "Move and fine-tune tests. Avoid rendering no output in case offset falls on last line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "014b187f3f87ff3b60cd89c59c633f4a39850526", "author": {"user": {"login": "tszmytka", "name": "Tomek Szmytka"}}, "url": "https://github.com/jenkinsci/jenkins/commit/014b187f3f87ff3b60cd89c59c633f4a39850526", "committedDate": "2020-09-13T14:05:07Z", "message": "Merge branch 'master' into shortlog-strip-console-notes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c79230a48b52d581cafff5ad1f0679e79a81d03", "author": {"user": {"login": "tszmytka", "name": "Tomek Szmytka"}}, "url": "https://github.com/jenkinsci/jenkins/commit/7c79230a48b52d581cafff5ad1f0679e79a81d03", "committedDate": "2020-09-13T14:34:19Z", "message": "Dont render whole log on offset on the last line. It might be problematic for really large logs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNDE4MzM1", "url": "https://github.com/jenkinsci/jenkins/pull/4905#pullrequestreview-490418335", "createdAt": "2020-09-17T09:39:04Z", "commit": {"oid": "7c79230a48b52d581cafff5ad1f0679e79a81d03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwOTozOTowNFrOHTZ69w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwOTozOTowNFrOHTZ69w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDEwOTY4Nw==", "bodyText": "Could you create constants for these magic numbers? It's not easy to understand they are related with the number of lines and characters.", "url": "https://github.com/jenkinsci/jenkins/pull/4905#discussion_r490109687", "createdAt": "2020-09-17T09:39:04Z", "author": {"login": "varyvol"}, "path": "core/src/test/java/hudson/model/RunTest.java", "diffHunk": "@@ -262,4 +265,52 @@ public void compareRunsFromDifferentParentsWithSameNumber() throws Exception {\n         assertTrue(r1.compareTo(r2) != 0);\n         assertTrue(treeSet.size() == 2);\n     }\n+\n+    @Test\n+    public void willTriggerLogToStartWithNextFullLine() throws Exception {\n+        assertWriteLogToEquals(\"Sample build output 3.\\nSample build output 4.\\nFinished: SUCCESS.\\n\", 2 * 23 + 10);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c79230a48b52d581cafff5ad1f0679e79a81d03"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNDE5MzU0", "url": "https://github.com/jenkinsci/jenkins/pull/4905#pullrequestreview-490419354", "createdAt": "2020-09-17T09:40:20Z", "commit": {"oid": "7c79230a48b52d581cafff5ad1f0679e79a81d03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwOTo0MDoyMVrOHTZ98w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwOTo0MDoyMVrOHTZ98w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDExMDQ1MQ==", "bodyText": "I don't think we should use * imports on production code. Could you please revert that? Thanks.", "url": "https://github.com/jenkinsci/jenkins/pull/4905#discussion_r490110451", "createdAt": "2020-09-17T09:40:21Z", "author": {"login": "alecharp"}, "path": "core/src/main/java/hudson/model/Run.java", "diffHunk": "@@ -41,6 +41,8 @@\n import hudson.console.ConsoleNote;\n import hudson.console.ModelHyperlinkNote;\n import hudson.console.PlainTextConsoleOutputStream;\n+\n+import java.io.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c79230a48b52d581cafff5ad1f0679e79a81d03"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e7100202060f4511844f1fc518b67a537faa7d5", "author": {"user": {"login": "tszmytka", "name": "Tomek Szmytka"}}, "url": "https://github.com/jenkinsci/jenkins/commit/2e7100202060f4511844f1fc518b67a537faa7d5", "committedDate": "2020-09-17T20:16:46Z", "message": "Style adjustments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NjYzMDI3", "url": "https://github.com/jenkinsci/jenkins/pull/4905#pullrequestreview-495663027", "createdAt": "2020-09-24T14:56:43Z", "commit": {"oid": "2e7100202060f4511844f1fc518b67a537faa7d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMDM0NDkx", "url": "https://github.com/jenkinsci/jenkins/pull/4905#pullrequestreview-501034491", "createdAt": "2020-10-02T10:47:11Z", "commit": {"oid": "2e7100202060f4511844f1fc518b67a537faa7d5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMDo0NzoxMVrOHbpQKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMDo0NzoxMVrOHbpQKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc0OTQ4Mg==", "bodyText": "So it will print the entire log if we hit the end of the stream, which defeats purpose of offset for large logs. Should not be a problem for real use-cases, but we might want to retain original behavior.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    start = (r == -1)? 0 : start + 1;\n          \n          \n            \n                                    start = (r == -1)? 0 : offset + 1;", "url": "https://github.com/jenkinsci/jenkins/pull/4905#discussion_r498749482", "createdAt": "2020-10-02T10:47:11Z", "author": {"login": "oleg-nenashev"}, "path": "core/src/main/java/hudson/model/Run.java", "diffHunk": "@@ -1538,7 +1539,19 @@ public String toString() {\n      * @since 1.349\n      */\n     public void writeLogTo(long offset, @NonNull XMLOutput out) throws IOException {\n-        getLogText().writeHtmlTo(offset, out.asWriter());\n+        long start = offset;\n+        if (offset > 0) {\n+            try (BufferedInputStream bufferedInputStream = new BufferedInputStream(getLogInputStream())) {\n+                if (offset == bufferedInputStream.skip(offset)) {\n+                    int r;\n+                    do {\n+                        r = bufferedInputStream.read();\n+                        start = (r == -1)? 0 : start + 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e7100202060f4511844f1fc518b67a537faa7d5"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2240, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}