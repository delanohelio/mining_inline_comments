{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3Nzc0NDgw", "number": 2465, "title": "Add listener certificate to the Kafka Status", "bodyText": "Type of change\n\nEnhancement / new feature\n\nDescription\nIn some cases, users might not have access to the secrets containing TLS certificates of the broker. This could be for example in order to protect the secrets with service account tokens etc. In such case, having the public keys in the KAfkastatus might be useful. This PR adds them.\nAn example how the new KAfka Status might look like can be found here:\nstatus:\n  conditions:\n  - lastTransitionTime: 2020-01-28T00:39:29+0000\n    status: \"True\"\n    type: Ready\n  listeners:\n  - addresses:\n    - host: my-cluster-kafka-bootstrap.myproject.svc\n      port: 9092\n    type: plain\n  - addresses:\n    - host: my-cluster-kafka-bootstrap.myproject.svc\n      port: 9093\n    certificates:\n    - |\n      -----BEGIN CERTIFICATE-----\n      MIIDLTCCAhWgAwIBAgIJAJCYKhSYn0jBMA0GCSqGSIb3DQEBCwUAMC0xEzARBgNV\n      BAoMCmlvLnN0cmltemkxFjAUBgNVBAMMDWNsdXN0ZXItY2EgdjAwHhcNMjAwMTI4\n      MDAzNzQ2WhcNMjIxMDI0MDAzNzQ2WjAtMRMwEQYDVQQKDAppby5zdHJpbXppMRYw\n      FAYDVQQDDA1jbHVzdGVyLWNhIHYwMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB\n      CgKCAQEAxq7p+dqcklO9mKAPhWAcb+fi6UwYd7wWfZ5M43rXxHPM2Q+dgq7wrztj\n      YLBVBiBiqDRVNFPIraVnBiVFGxy1vICPYybNkcDAgQc9KRVwYlEs5YibYDSoTdCC\n      5yS8aGP6VRN1geZIb2ZEtOdnIuheZxoyX+0oIO8ypZOncsXinJQioKXV7Ox8n79m\n      ussiAH/YGu/FoEJlkT5SSiiaIt/MxRHbzvy/d0XwvEi7o2vHkKLDbGrCdWrHbFeP\n      4VWzq6+GHviLqTv/sn0Is5zrwJbVaGIilc7NjuOSizPx/rbvizFQiwkUYsMGnqLQ\n      HItYcmC9zlWN+fxoz7alvWXBHMJ6wwIDAQABo1AwTjAdBgNVHQ4EFgQUK5WfcD9l\n      FpQffonJyP4FNA6AmRQwHwYDVR0jBBgwFoAUK5WfcD9lFpQffonJyP4FNA6AmRQw\n      DAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAlab3mNinaYh992FbMvsE\n      JCQGZa/1IkKYXLySaOvY6x+sH7FO9cLejLDg0PCCAvFd4W9f62m43INYNW0MiTwS\n      qwG1bXcehZb0BLA2gTvASTsiaWkElVGhOIAhYHD9x4GtYBGk14Mj21XH4Q899HFM\n      m1ClemwT8x7PRq0uWUYrVV+IBE3EBAeSrf56RnyEr45TgegjowtrwAOqelECIhwu\n      25WQ8MSwf2hL80zFVRKgXhSCZvmu4Nm+y1yFmrCzxVeg9W8ZYO26JDmW8eYlRHPv\n      Z0wTgLDuIqeGHDE8eHDFGxHjJCsB82bgYx+oIlz6lPeaud51xTwNLjE1jcZXvVDL\n      SA==\n      -----END CERTIFICATE-----\n    type: tls\n  - addresses:\n    - host: my-cluster-kafka-bootstrap-myproject.192.168.64.151.nip.io\n      port: 443\n    certificates:\n    - |\n      -----BEGIN CERTIFICATE-----\n      MIIDLTCCAhWgAwIBAgIJAJCYKhSYn0jBMA0GCSqGSIb3DQEBCwUAMC0xEzARBgNV\n      BAoMCmlvLnN0cmltemkxFjAUBgNVBAMMDWNsdXN0ZXItY2EgdjAwHhcNMjAwMTI4\n      MDAzNzQ2WhcNMjIxMDI0MDAzNzQ2WjAtMRMwEQYDVQQKDAppby5zdHJpbXppMRYw\n      FAYDVQQDDA1jbHVzdGVyLWNhIHYwMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIB\n      CgKCAQEAxq7p+dqcklO9mKAPhWAcb+fi6UwYd7wWfZ5M43rXxHPM2Q+dgq7wrztj\n      YLBVBiBiqDRVNFPIraVnBiVFGxy1vICPYybNkcDAgQc9KRVwYlEs5YibYDSoTdCC\n      5yS8aGP6VRN1geZIb2ZEtOdnIuheZxoyX+0oIO8ypZOncsXinJQioKXV7Ox8n79m\n      ussiAH/YGu/FoEJlkT5SSiiaIt/MxRHbzvy/d0XwvEi7o2vHkKLDbGrCdWrHbFeP\n      4VWzq6+GHviLqTv/sn0Is5zrwJbVaGIilc7NjuOSizPx/rbvizFQiwkUYsMGnqLQ\n      HItYcmC9zlWN+fxoz7alvWXBHMJ6wwIDAQABo1AwTjAdBgNVHQ4EFgQUK5WfcD9l\n      FpQffonJyP4FNA6AmRQwHwYDVR0jBBgwFoAUK5WfcD9lFpQffonJyP4FNA6AmRQw\n      DAYDVR0TBAUwAwEB/zANBgkqhkiG9w0BAQsFAAOCAQEAlab3mNinaYh992FbMvsE\n      JCQGZa/1IkKYXLySaOvY6x+sH7FO9cLejLDg0PCCAvFd4W9f62m43INYNW0MiTwS\n      qwG1bXcehZb0BLA2gTvASTsiaWkElVGhOIAhYHD9x4GtYBGk14Mj21XH4Q899HFM\n      m1ClemwT8x7PRq0uWUYrVV+IBE3EBAeSrf56RnyEr45TgegjowtrwAOqelECIhwu\n      25WQ8MSwf2hL80zFVRKgXhSCZvmu4Nm+y1yFmrCzxVeg9W8ZYO26JDmW8eYlRHPv\n      Z0wTgLDuIqeGHDE8eHDFGxHjJCsB82bgYx+oIlz6lPeaud51xTwNLjE1jcZXvVDL\n      SA==\n      -----END CERTIFICATE-----\n    type: external\n  observedGeneration: 1\nChecklist\n\n Write tests\n Make sure all tests pass\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Update CHANGELOG.md", "createdAt": "2020-01-28T00:41:23Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465", "merged": true, "mergeCommit": {"oid": "4e2a9279538379a4317547150cdb76d51c14e320"}, "closed": true, "closedAt": "2020-01-28T20:23:44Z", "author": {"login": "scholzj"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-sSlEgFqTM0OTE3MTA0Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-zER6ABqjI5ODYwOTA3MDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MTcxMDQz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#pullrequestreview-349171043", "createdAt": "2020-01-28T07:31:04Z", "commit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzozMTowNFrOFibQ9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzozMzo0NVrOFibUJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw==", "bodyText": "\"The A list...\" seems to be a typo.\nAnyway isn't it better saying \"TLS certificates\" instead of \"public TLS keys\"?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371642613", "createdAt": "2020-01-28T07:31:04Z", "author": {"login": "ppatierno"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MzQyOA==", "bodyText": "Remove commented lines?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371643428", "createdAt": "2020-01-28T07:33:45Z", "author": {"login": "ppatierno"}, "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperatorCustomCertTest.java", "diffHunk": "@@ -422,8 +422,10 @@ public MockKafkaAssemblyOperator(Vertx vertx, PlatformFeaturesAvailability pfa,\n         Future<Void> reconcile(ReconciliationState reconcileState)  {\n             return reconcileState.reconcileCas(this::dateSupplier)\n                     .compose(state -> state.getKafkaClusterDescription())\n-                    .compose(state -> state.getCustomTlsListenerThumbprint())\n-                    .compose(state -> state.getCustomExternalListenerThumbprint())\n+                    //.compose(state -> state.getCustomTlsListenerThumbprint())\n+                    //.compose(state -> state.getCustomExternalListenerThumbprint())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MjA4MTY0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#pullrequestreview-349208164", "createdAt": "2020-01-28T08:54:20Z", "commit": {"oid": "243e446ef53fcb66209b67a145bf6fd18495f566"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwODo1NDoyMFrOFidE6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwODo1NDoyOVrOFidFOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY3MjI5OQ==", "bodyText": "I guess the charset should be ASCII.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371672299", "createdAt": "2020-01-28T08:54:20Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -1983,54 +1988,77 @@ private KafkaVersionChange getKafkaVersionChange(StatefulSet kafkaSts) {\n             return resultPromise.future();\n         }\n \n-        Future<ReconciliationState> getCustomTlsListenerThumbprint() {\n-            return getCertificateSignature(kafkaCluster.getSecretSourceTls()).map(thumbprint -> {\n-                tlsListenerCustomCertificateThumbprint = thumbprint;\n-                return this;\n-            });\n-        }\n+        Future<ReconciliationState> customTlsListenerCertificate() {\n+            CertAndKeySecretSource customCertSecret = kafkaCluster.getSecretSourceTls();\n \n-        Future<ReconciliationState> getCustomExternalListenerThumbprint() {\n-            return getCertificateSignature(kafkaCluster.getSecretSourceExternal()).map(thumbprint -> {\n-                externalListenerCustomCertificateThumbprint = thumbprint;\n-                return this;\n-            });\n+            return getCustomCertificateSecret(customCertSecret)\n+                    .compose(secret -> {\n+                        if (secret != null)  {\n+                            byte[] publicKeyBytes = Base64.getDecoder().decode(secret.getData().get(customCertSecret.getCertificate()));\n+                            tlsListenerCustomCertificate = new String(publicKeyBytes, Charset.defaultCharset());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "243e446ef53fcb66209b67a145bf6fd18495f566"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY3MjM3OA==", "bodyText": "Ditto", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371672378", "createdAt": "2020-01-28T08:54:29Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -1983,54 +1988,77 @@ private KafkaVersionChange getKafkaVersionChange(StatefulSet kafkaSts) {\n             return resultPromise.future();\n         }\n \n-        Future<ReconciliationState> getCustomTlsListenerThumbprint() {\n-            return getCertificateSignature(kafkaCluster.getSecretSourceTls()).map(thumbprint -> {\n-                tlsListenerCustomCertificateThumbprint = thumbprint;\n-                return this;\n-            });\n-        }\n+        Future<ReconciliationState> customTlsListenerCertificate() {\n+            CertAndKeySecretSource customCertSecret = kafkaCluster.getSecretSourceTls();\n \n-        Future<ReconciliationState> getCustomExternalListenerThumbprint() {\n-            return getCertificateSignature(kafkaCluster.getSecretSourceExternal()).map(thumbprint -> {\n-                externalListenerCustomCertificateThumbprint = thumbprint;\n-                return this;\n-            });\n+            return getCustomCertificateSecret(customCertSecret)\n+                    .compose(secret -> {\n+                        if (secret != null)  {\n+                            byte[] publicKeyBytes = Base64.getDecoder().decode(secret.getData().get(customCertSecret.getCertificate()));\n+                            tlsListenerCustomCertificate = new String(publicKeyBytes, Charset.defaultCharset());\n+                            tlsListenerCustomCertificateThumbprint = getCertificateThumbprint(secret, customCertSecret);\n+\n+                            return Future.succeededFuture(this);\n+                        } else {\n+                            return Future.succeededFuture(this);\n+                        }\n+                    });\n         }\n \n-        Future<String> getCertificateSignature(CertAndKeySecretSource customCertSecret)  {\n-            Promise<String> thumbprintPromise = Promise.promise();\n+        Future<ReconciliationState> customExternalListenerCertificate() {\n+            CertAndKeySecretSource customCertSecret = kafkaCluster.getSecretSourceExternal();\n \n+            return getCustomCertificateSecret(customCertSecret)\n+                    .compose(secret -> {\n+                        if (secret != null)  {\n+                            byte[] publicKeyBytes = Base64.getDecoder().decode(secret.getData().get(customCertSecret.getCertificate()));\n+                            externalListenerCustomCertificate = new String(publicKeyBytes, Charset.defaultCharset());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "243e446ef53fcb66209b67a145bf6fd18495f566"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MzY4MDAw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#pullrequestreview-349368000", "createdAt": "2020-01-28T13:23:30Z", "commit": {"oid": "f3ca4c69b38f21b8f0be450675fa71cfc60cd0e3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50de2124e2dd5218e9e83f70020dd3fc4d169593", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/50de2124e2dd5218e9e83f70020dd3fc4d169593", "committedDate": "2020-01-28T15:27:54Z", "message": "Add listener certificate to the Kafka Status\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a167c08a34103002e5a6fca143db553fd0b59171", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a167c08a34103002e5a6fca143db553fd0b59171", "committedDate": "2020-01-28T15:27:54Z", "message": "Update CHANGELOG.md\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb0ac3efe809f7e4e3e466bd2a56be47c0c5d924", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fb0ac3efe809f7e4e3e466bd2a56be47c0c5d924", "committedDate": "2020-01-28T15:27:54Z", "message": "Fix spotbugs and CRDs\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59c6aac1d8acb352fb2318698071aa704e08ced8", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/59c6aac1d8acb352fb2318698071aa704e08ced8", "committedDate": "2020-01-28T15:27:54Z", "message": "Review comments, forgotten DEBUG log level\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e598b79b7c19b0a18770c9d4c942a77717e2e19", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6e598b79b7c19b0a18770c9d4c942a77717e2e19", "committedDate": "2020-01-28T15:27:54Z", "message": "Fix docs after description annotation change\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59946b8df8ac0ba66f443f40766a20accaa85ab8", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/59946b8df8ac0ba66f443f40766a20accaa85ab8", "committedDate": "2020-01-28T15:27:54Z", "message": "Review comments II\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c165dae01a17bb47ceaa1a04bdea81319e8e57a", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2c165dae01a17bb47ceaa1a04bdea81319e8e57a", "committedDate": "2020-01-28T15:27:54Z", "message": "Unused import :-(\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44bf0077ef3280b12dc56879f430787449fe49a0", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/44bf0077ef3280b12dc56879f430787449fe49a0", "committedDate": "2020-01-28T15:27:54Z", "message": "Fix description certificates versus public key\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ddb3336980c68209f2af9e783d1cff8d9f50542", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0ddb3336980c68209f2af9e783d1cff8d9f50542", "committedDate": "2020-01-28T15:27:54Z", "message": "Add the certificates to the example in docs\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3ca4c69b38f21b8f0be450675fa71cfc60cd0e3", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f3ca4c69b38f21b8f0be450675fa71cfc60cd0e3", "committedDate": "2020-01-28T11:24:30Z", "message": "Add the certificates to the example in docs\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}, "afterCommit": {"oid": "0ddb3336980c68209f2af9e783d1cff8d9f50542", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0ddb3336980c68209f2af9e783d1cff8d9f50542", "committedDate": "2020-01-28T15:27:54Z", "message": "Add the certificates to the example in docs\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1876, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}