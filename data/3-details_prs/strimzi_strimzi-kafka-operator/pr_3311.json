{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MjY2OTYx", "number": 3311, "title": "Bridge dynamic logging", "bodyText": "Signed-off-by: Stanislav Knot sknot@redhat.com\nType of change\n\nEnhancement / new feature\n\nDescription\nAllow setting bridge logging configuration without RU (dynamically).\nChecklist\n\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md", "createdAt": "2020-07-13T13:45:17Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311", "merged": true, "mergeCommit": {"oid": "da242f90279350bb7dec8bf9ac3a7e77b1b88631"}, "closed": true, "closedAt": "2020-07-15T19:06:47Z", "author": {"login": "sknot-rh"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0hwDhAH2gAyNDQ4MjY2OTYxOmQ3OGQ5Njc3MWZkMThlNDQ4OTJmYjYwM2VkYmE2MjEwMmUxZTQ3Y2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1Pe8zgFqTQ0OTI1MDUyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d78d96771fd18e44892fb603edba62102e1e47ce", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d78d96771fd18e44892fb603edba62102e1e47ce", "committedDate": "2020-07-13T13:49:30Z", "message": "Bridge dynamic logging\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f4e9453f762082443452729e96396b38c7df9e8d", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f4e9453f762082443452729e96396b38c7df9e8d", "committedDate": "2020-07-13T13:43:40Z", "message": "Bridge dynamic logging\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "d78d96771fd18e44892fb603edba62102e1e47ce", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d78d96771fd18e44892fb603edba62102e1e47ce", "committedDate": "2020-07-13T13:49:30Z", "message": "Bridge dynamic logging\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3Mjg1Nzk0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311#pullrequestreview-447285794", "createdAt": "2020-07-13T14:08:37Z", "commit": {"oid": "d78d96771fd18e44892fb603edba62102e1e47ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5880efce1e955bb454a32b3d7dd1e15074fffde2", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5880efce1e955bb454a32b3d7dd1e15074fffde2", "committedDate": "2020-07-13T14:22:46Z", "message": "fix tests\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzAyNTcw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311#pullrequestreview-447302570", "createdAt": "2020-07-13T14:27:08Z", "commit": {"oid": "d78d96771fd18e44892fb603edba62102e1e47ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDoyNzowOFrOGwrBIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNDoyNzowOFrOGwrBIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzY4OTYzNQ==", "bodyText": "bridz?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311#discussion_r453689635", "createdAt": "2020-07-13T14:27:08Z", "author": {"login": "ppatierno"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/log/LoggingChangeST.java", "diffHunk": "@@ -349,6 +352,111 @@ void testDynamicallySetEOloggingLevels() throws InterruptedException {\n         assertThat(\"EO pod should not roll\", DeploymentUtils.depSnapshot(eoDeploymentName), equalTo(eoPods));\n     }\n \n+    @Test\n+    void testDynamicallySetBridgeLoggingLevels() throws InterruptedException {\n+        InlineLogging ilOff = new InlineLogging();\n+        Map<String, String> loggers = new HashMap<>();\n+        loggers.put(\"rootLogger.level\", \"OFF\");\n+        loggers.put(\"logger.bridge.level\", \"OFF\");\n+        loggers.put(\"logger.healthy.level\", \"OFF\");\n+        loggers.put(\"logger.ready.level\", \"OFF\");\n+        ilOff.setLoggers(loggers);\n+\n+        KafkaResource.kafkaPersistent(CLUSTER_NAME, 1, 1).done();\n+        KafkaBridgeResource.kafkaBridge(CLUSTER_NAME, KafkaResources.tlsBootstrapAddress(CLUSTER_NAME), 1)\n+                .editSpec()\n+                    .withInlineLogging(ilOff)\n+                .endSpec()\n+                .done();\n+\n+        Map<String, String> bridgeSnapshot = DeploymentUtils.depSnapshot(KafkaBridgeResources.deploymentName(CLUSTER_NAME));\n+\n+        LOGGER.info(\"Changing rootLogger level to DEBUG with inline logging\");\n+        InlineLogging ilDebug = new InlineLogging();\n+        loggers.put(\"rootLogger.level\", \"DEBUG\");\n+        loggers.put(\"logger.bridge.level\", \"OFF\");\n+        loggers.put(\"logger.healthy.level\", \"OFF\");\n+        loggers.put(\"logger.ready.level\", \"OFF\");\n+        ilDebug.setLoggers(loggers);\n+\n+        KafkaBridgeResource.replaceBridgeResource(CLUSTER_NAME, bridz -> {\n+            bridz.getSpec().setLogging(ilDebug);\n+        });\n+\n+        final String bridgePodName = bridgeSnapshot.keySet().iterator().next();\n+        LOGGER.info(\"Waiting for log4j2.properties will contain desired settings\");\n+        TestUtils.waitFor(\"Logger change\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_TIMEOUT,\n+            () -> cmdKubeClient().execInPodContainer(bridgePodName, KafkaBridgeResources.deploymentName(CLUSTER_NAME), \"cat\", \"/opt/strimzi/custom-config/log4j2.properties\").out().contains(\"rootLogger.level=DEBUG\")\n+                && cmdKubeClient().execInPodContainer(bridgePodName, KafkaBridgeResources.deploymentName(CLUSTER_NAME), \"cat\", \"/opt/strimzi/custom-config/log4j2.properties\").out().contains(\"monitorInterval=30\")\n+        );\n+\n+        LOGGER.info(\"Waiting {} ms for DEBUG log will appear\", LOGGING_RELOADING_INTERVAL * 2);\n+        // wait some time and check whether logs after this time contain anything\n+        Thread.sleep(LOGGING_RELOADING_INTERVAL * 2);\n+\n+        LOGGER.info(\"Asserting if log will contain some records\");\n+        assertThat(StUtils.getLogFromPodByTime(bridgePodName, KafkaBridgeResources.deploymentName(CLUSTER_NAME), \"30s\"), is(not(emptyString())));\n+\n+        ConfigMap configMapBridge = new ConfigMapBuilder()\n+                .withNewMetadata()\n+                .withName(\"external-configmap-bridge\")\n+                .withNamespace(NAMESPACE)\n+                .endMetadata()\n+                .withData(Collections.singletonMap(\"log4j2.properties\",\n+                        \"name = BridgeConfig\\n\" +\n+                                \"\\n\" +\n+                                \"appender.console.type = Console\\n\" +\n+                                \"appender.console.name = STDOUT\\n\" +\n+                                \"appender.console.layout.type = PatternLayout\\n\" +\n+                                \"appender.console.layout.pattern = [%d] %-5p <%-12.12c{1}:%L> [%-12.12t] %m%n\\n\" +\n+                                \"\\n\" +\n+                                \"rootLogger.level = OFF\\n\" +\n+                                \"rootLogger.appenderRefs = console\\n\" +\n+                                \"rootLogger.appenderRef.console.ref = STDOUT\\n\" +\n+                                \"rootLogger.additivity = false\\n\" +\n+                                \"\\n\" +\n+                                \"logger.bridge.name = io.strimzi.kafka.bridge\\n\" +\n+                                \"logger.bridge.level = OFF\\n\" +\n+                                \"logger.bridge.appenderRefs = console\\n\" +\n+                                \"logger.bridge.appenderRef.console.ref = STDOUT\\n\" +\n+                                \"logger.bridge.additivity = false\\n\" +\n+                                \"\\n\" +\n+                                \"# HTTP OpenAPI specific logging levels (default is INFO)\\n\" +\n+                                \"# Logging healthy and ready endpoints is very verbose because of Kubernetes health checking.\\n\" +\n+                                \"logger.healthy.name = http.openapi.operation.healthy\\n\" +\n+                                \"logger.healthy.level = OFF\\n\" +\n+                                \"logger.ready.name = http.openapi.operation.ready\\n\" +\n+                                \"logger.ready.level = OFF\"))\n+                .build();\n+\n+        kubeClient().getClient().configMaps().inNamespace(NAMESPACE).createOrReplace(configMapBridge);\n+\n+        ExternalLogging bridgeXternalLogging = new ExternalLoggingBuilder()\n+                .withName(\"external-configmap-bridge\")\n+                .build();\n+\n+        LOGGER.info(\"Setting log level of Bridge to OFF - records should not appear in the log\");\n+        // change to the external logging\n+        KafkaBridgeResource.replaceBridgeResource(CLUSTER_NAME, bridz -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d78d96771fd18e44892fb603edba62102e1e47ce"}, "originalPosition": 111}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NTM3OTYw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311#pullrequestreview-447537960", "createdAt": "2020-07-13T19:28:33Z", "commit": {"oid": "5880efce1e955bb454a32b3d7dd1e15074fffde2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODgyNjA5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311#pullrequestreview-447882609", "createdAt": "2020-07-14T08:08:32Z", "commit": {"oid": "5880efce1e955bb454a32b3d7dd1e15074fffde2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwODowODozMlrOGxI8NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwODowODozMlrOGxI8NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDE3OTg5Mw==", "bodyText": "maybe both on one line?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311#discussion_r454179893", "createdAt": "2020-07-14T08:08:32Z", "author": {"login": "ppatierno"}, "path": "CHANGELOG.md", "diffHunk": "@@ -22,6 +22,7 @@\n   * enable/disable metrics in the KafkaBridge custom resource\n   * new Grafana dashboard for the bridge metrics\n * Support dynamically changeable logging in the Entity Operator \n+* Support dynamically changeable logging in the Kafka Bridge ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5880efce1e955bb454a32b3d7dd1e15074fffde2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "474ebf4ba12b0e6fd11d3cd71543f509f8d730b3", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/474ebf4ba12b0e6fd11d3cd71543f509f8d730b3", "committedDate": "2020-07-14T08:14:58Z", "message": "comment\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MjUwNTI5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3311#pullrequestreview-449250529", "createdAt": "2020-07-15T19:06:27Z", "commit": {"oid": "474ebf4ba12b0e6fd11d3cd71543f509f8d730b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1306, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}