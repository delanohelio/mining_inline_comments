{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3MTMxNzM4", "number": 3582, "title": "[systemtest][mm2] Test for Identity Replication Policy", "bodyText": "Signed-off-by: Lukas Kral lukywill16@gmail.com\nType of change\n\nNew test\n\nDescription\nAfter #3423 we are able to add the IdentityReplicationPolicy to KafkaMirrorMaker2 sourceConnector spec -> how is it mentioned in the issues:\nIdentity replication policy is useful for active-passive cluster mirroring, cluster backups or for migrations from one cluster to another. It can be configured in MM2 and makes sure that MM2 will not be prefixing the mirrored topics with the original cluster alias but keeps the original names.\n\nI wanted to add it to original testMirrorMaker2() test, but it would break the whole test and the main functionality wouldn't be tested, that's why I added the separated test.\nChecklist\n\n Write test\n Make sure all tests pass", "createdAt": "2020-09-01T14:44:48Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3582", "merged": true, "mergeCommit": {"oid": "9509fc20d79b84981cd4e17705333c7840b2bd74"}, "closed": true, "closedAt": "2020-09-02T11:25:42Z", "author": {"login": "im-konge"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEoh25gH2gAyNDc3MTMxNzM4OjNjYjNiZDIwNjg3ZjBkYWIxNGJjZWJiMDZmZjBlZWIyM2M5NjI1Y2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE6Qk-AFqTQ4MDcyNDcyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3cb3bd20687f0dab14bcebb06ff0eeb23c9625cb", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3cb3bd20687f0dab14bcebb06ff0eeb23c9625cb", "committedDate": "2020-09-01T14:46:07Z", "message": "add test for IRP\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fd9863edff573d53acbec706baa8b98ea686156", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6fd9863edff573d53acbec706baa8b98ea686156", "committedDate": "2020-09-01T14:41:00Z", "message": "add test for IRP\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "3cb3bd20687f0dab14bcebb06ff0eeb23c9625cb", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3cb3bd20687f0dab14bcebb06ff0eeb23c9625cb", "committedDate": "2020-09-01T14:46:07Z", "message": "add test for IRP\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d37e2858606ba7f3cc2c41635a0e9cc019be9b7", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0d37e2858606ba7f3cc2c41635a0e9cc019be9b7", "committedDate": "2020-09-01T19:15:17Z", "message": "add another checks\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwMDU3NTMy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3582#pullrequestreview-480057532", "createdAt": "2020-09-01T19:36:27Z", "commit": {"oid": "0d37e2858606ba7f3cc2c41635a0e9cc019be9b7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxOTozNjoyN1rOHLFaQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxOTozNjoyN1rOHLFaQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTM4NTAyNw==", "bodyText": "Stupid question ... but ... On line 692 you create topic original-topic and here you just list it and check it has the right name? Because how do you know this is not the initial topic you created when using single namespace? I guess you could say that if on line 725 you can read the mirrored messages from the topic original-topic it worked. But this should be either fixed or removed.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3582#discussion_r481385027", "createdAt": "2020-09-01T19:36:27Z", "author": {"login": "scholzj"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/mirrormaker/MirrorMaker2ST.java", "diffHunk": "@@ -678,6 +680,59 @@ void testScaleMirrorMaker2ToZero() {\n         assertNull(mm2Status.getUrl());\n     }\n \n+    @Test\n+    void testIdentityReplicationPolicy() {\n+        String originalTopicName = \"original-topic\";\n+\n+        // Deploy source kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterSourceName, 1, 1).done();\n+        // Deploy target kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterTargetName, 1, 1).done();\n+        // Create topic\n+        KafkaTopicResource.topic(kafkaClusterSourceName, originalTopicName, 3).done();\n+\n+        KafkaClientsResource.deployKafkaClients(false, KAFKA_CLIENTS_NAME).done();\n+\n+        final String kafkaClientsPodName = kubeClient().listPodsByPrefixInName(KAFKA_CLIENTS_NAME).get(0).getMetadata().getName();\n+\n+        KafkaMirrorMaker2Resource.kafkaMirrorMaker2(CLUSTER_NAME, kafkaClusterTargetName, kafkaClusterSourceName, 1, false)\n+            .editSpec()\n+                .editMirror(0)\n+                    .editSourceConnector()\n+                        .addToConfig(\"replication.policy.class\", \"io.strimzi.kafka.connect.mirror.IdentityReplicationPolicy\")\n+                    .endSourceConnector()\n+                .endMirror()\n+            .endSpec()\n+            .done();\n+\n+        LOGGER.info(\"Sending and receiving messages via {}\", kafkaClusterSourceName);\n+        InternalKafkaClient internalKafkaClient = new InternalKafkaClient.Builder()\n+            .withNamespaceName(NAMESPACE)\n+            .withTopicName(originalTopicName)\n+            .withClusterName(kafkaClusterSourceName)\n+            .withMessageCount(MESSAGE_COUNT)\n+            .withUsingPodName(kafkaClientsPodName)\n+            .build();\n+\n+        internalKafkaClient.assertSentAndReceivedMessages(\n+            internalKafkaClient.sendMessagesPlain(),\n+            internalKafkaClient.receiveMessagesPlain()\n+        );\n+\n+        LOGGER.info(\"Changing to {} and will try to receive messages\", kafkaClusterTargetName);\n+        internalKafkaClient.setClusterName(kafkaClusterTargetName);\n+\n+        assertThat(internalKafkaClient.receiveMessagesPlain(), equalTo(MESSAGE_COUNT));\n+\n+        LOGGER.info(\"Checking if the mirrored topic name is same as the original one\");\n+\n+        KafkaTopic kafkaTopic = KafkaTopicResource.kafkaTopicClient().inNamespace(NAMESPACE).withName(originalTopicName).get();\n+        assertNotNull(kafkaTopic);\n+        assertThat(kafkaTopic.getMetadata().getName(), equalTo(originalTopicName));\n+        assertThat(kafkaTopic.getSpec().getPartitions(), equalTo(3));\n+        assertThat(kafkaTopic.getSpec().getReplicas(), equalTo(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d37e2858606ba7f3cc2c41635a0e9cc019be9b7"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff8719b54af1c00f9b65ddc30e97b6fb156bc32f", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ff8719b54af1c00f9b65ddc30e97b6fb156bc32f", "committedDate": "2020-09-02T04:59:22Z", "message": "comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTA2NTg0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3582#pullrequestreview-480506584", "createdAt": "2020-09-02T06:03:43Z", "commit": {"oid": "ff8719b54af1c00f9b65ddc30e97b6fb156bc32f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTIyNjA1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3582#pullrequestreview-480522605", "createdAt": "2020-09-02T06:38:19Z", "commit": {"oid": "ff8719b54af1c00f9b65ddc30e97b6fb156bc32f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzI0NzI3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3582#pullrequestreview-480724727", "createdAt": "2020-09-02T11:25:32Z", "commit": {"oid": "ff8719b54af1c00f9b65ddc30e97b6fb156bc32f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 921, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}