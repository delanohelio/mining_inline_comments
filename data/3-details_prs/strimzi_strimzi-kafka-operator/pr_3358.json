{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NzkxODQ5", "number": 3358, "title": "Fix tracing in Kafka Mirror Maker 2", "bodyText": "Type of change\n\nBugfix\n\nDescription\nCurrently, the Mirror Maker 2 doesn't properly implement tracing. When tracing is enabled, it is enabled in the underlying Connect cluster but not in the connector. Therefore the traces do not include the point when the message is consumed from the source cluster by MM2 but only the point when it is produced into the target cluster by MM2.\nThis PR injects the interceptors also to the connectors and makes sure the tracing is included also in them. That makes sure that the MM2 leaves always two traces - one when the message is consumed and one when the message is produced.\nThis PR also adds a new system test into TracingST to test tracing with Mirror Maker 2. Additionally it improves also the Mirror Maker 1 tracing tests:\n\nFixes the oder to make things execute faster\nImproves the check to not just verify the service existence in Jaeger but also that it has the right operations  reading from and writing to a topic.\n\nDocumentation update is handled in #3314.\nChecklist\n\n Write tests\n Make sure all tests pass\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally", "createdAt": "2020-07-21T23:10:48Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3358", "merged": true, "mergeCommit": {"oid": "22fc8970cabcabce80439a7700df9639c4c76509"}, "closed": true, "closedAt": "2020-07-23T12:57:02Z", "author": {"login": "scholzj"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3OfH7gH2gAyNDU0NzkxODQ5Ojc5ZmMzOTAzNGQyOWRhZWI4MTdiMTM2MTZjOTA3MTVkMDU0NDVkMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3rOxPAH2gAyNDU0NzkxODQ5OmMzMzA2YTBkZDFlZjU2ZDZkMWU4MmVhMDk1NWZjNTQyNGYzMWYyZTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "79fc39034d29daeb817b13616c90715d05445d04", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/79fc39034d29daeb817b13616c90715d05445d04", "committedDate": "2020-07-21T23:04:35Z", "message": "Fix tracing in Kafka Mirror Maker 2\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyOTAyNDM1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3358#pullrequestreview-452902435", "createdAt": "2020-07-21T23:44:04Z", "commit": {"oid": "79fc39034d29daeb817b13616c90715d05445d04"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7498b990ae10d2c704bacfe70999a4489d93f657", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7498b990ae10d2c704bacfe70999a4489d93f657", "committedDate": "2020-07-22T16:23:00Z", "message": "Add system tests for MM2 and improve MM1 STs with tracing\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNDg3NjU1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3358#pullrequestreview-453487655", "createdAt": "2020-07-22T16:28:45Z", "commit": {"oid": "7498b990ae10d2c704bacfe70999a4489d93f657"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzOTIxNzM1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3358#pullrequestreview-453921735", "createdAt": "2020-07-23T08:19:14Z", "commit": {"oid": "7498b990ae10d2c704bacfe70999a4489d93f657"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzOTIxNTkz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3358#pullrequestreview-453921593", "createdAt": "2020-07-23T08:19:02Z", "commit": {"oid": "7498b990ae10d2c704bacfe70999a4489d93f657"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwODoxOTowMlrOG2Amcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwODoxOTozMVrOG2AnZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI4NjEzMQ==", "bodyText": "I think that these explicit deletions are not needed it should be deleted by ResourceManager.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3358#discussion_r459286131", "createdAt": "2020-07-23T08:19:02Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/tracing/TracingST.java", "diffHunk": "@@ -648,6 +787,14 @@ void testProducerConsumerMirrorMakerConnectStreamsService() {\n         LOGGER.info(\"Deleting topic {} from CR\", TOPIC_TARGET_NAME);\n         cmdKubeClient().deleteByName(\"kafkatopic\", TOPIC_TARGET_NAME);\n         KafkaTopicUtils.waitForKafkaTopicDeletion(TOPIC_TARGET_NAME);\n+\n+        LOGGER.info(\"Deleting topic {} from CR\", TOPIC_NAME + \"-target\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7498b990ae10d2c704bacfe70999a4489d93f657"}, "originalPosition": 368}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI4NjM3Mw==", "bodyText": "Is this specific configuration really needed?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3358#discussion_r459286373", "createdAt": "2020-07-23T08:19:31Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/tracing/TracingST.java", "diffHunk": "@@ -553,17 +608,65 @@ void testProducerConsumerMirrorMakerConnectStreamsService() {\n                 .endSpec()\n                 .done();\n \n+        TracingUtils.verify(JAEGER_PRODUCER_SERVICE, kafkaClientsPodName, \"To_\" + TOPIC_NAME);\n+        TracingUtils.verify(JAEGER_CONSUMER_SERVICE, kafkaClientsPodName, \"From_\" + TOPIC_NAME);\n+        TracingUtils.verify(JAEGER_MIRROR_MAKER_SERVICE, kafkaClientsPodName, \"From_\" + TOPIC_NAME);\n+        TracingUtils.verify(JAEGER_MIRROR_MAKER_SERVICE, kafkaClientsPodName, \"To_\" + TOPIC_NAME);\n+\n+        LOGGER.info(\"Deleting topic {} from CR\", TOPIC_NAME);\n+        cmdKubeClient().deleteByName(\"kafkatopic\", TOPIC_NAME);\n+        KafkaTopicUtils.waitForKafkaTopicDeletion(TOPIC_NAME);\n+\n+        LOGGER.info(\"Deleting topic {} from CR\", TOPIC_NAME + \"-target\");\n+        cmdKubeClient().deleteByName(\"kafkatopic\", TOPIC_NAME + \"-target\");\n+        KafkaTopicUtils.waitForKafkaTopicDeletion(TOPIC_NAME + \"-target\");\n+    }\n+\n+    @Test\n+    @Tag(CONNECT)\n+    @Tag(MIRROR_MAKER)\n+    @Tag(CONNECT_COMPONENTS)\n+    @SuppressWarnings({\"checkstyle:MethodLength\"})\n+    void testProducerConsumerMirrorMakerConnectStreamsService() {\n+        Map<String, Object> configOfKafka = new HashMap<>();\n+        configOfKafka.put(\"offsets.topic.replication.factor\", \"1\");\n+        configOfKafka.put(\"transaction.state.log.replication.factor\", \"1\");\n+        configOfKafka.put(\"transaction.state.log.min.isr\", \"1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7498b990ae10d2c704bacfe70999a4489d93f657"}, "originalPosition": 256}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3306a0dd1ef56d6d1e82ea0955fc5424f31f2e2", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c3306a0dd1ef56d6d1e82ea0955fc5424f31f2e2", "committedDate": "2020-07-23T08:33:58Z", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1355, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}