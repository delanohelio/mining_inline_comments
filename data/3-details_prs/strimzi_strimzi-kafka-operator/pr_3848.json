{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2OTQ2Nzgx", "number": 3848, "title": "Fix kafka roller when kafka CR is fixed", "bodyText": "Signed-off-by: Stanislav Knot sknot@redhat.com\nType of change\n\nBugfix\n\nDescription\nWhen the kafka CR contains some invalid config (e.g. pod template is set to create pods on node with some non-existent labe\u016f) the kafka pods are Pending. When the CR is fixed, the kafka pod should roll and be running. That is not happening currently.\nAll credits to @tombentley\nChecklist\n\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md\n Supply screenshots for visual changes, such as Grafana dashboards", "createdAt": "2020-10-20T16:34:59Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3848", "merged": true, "mergeCommit": {"oid": "77e1ec1d1e553573243f1e538278d80a6af02495"}, "closed": true, "closedAt": "2020-10-21T23:59:19Z", "author": {"login": "sknot-rh"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUbaHcgH2gAyNTA2OTQ2NzgxOjI4ZjI3Yzg1NTQwNWFkMTlmY2E1OGNhZjdhOGRkMTA4ODJhYmNlZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUxGLYgFqTUxNDAyMzg3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "28f27c855405ad19fca58caf7a8dd10882abcee7", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/28f27c855405ad19fca58caf7a8dd10882abcee7", "committedDate": "2020-10-20T16:31:41Z", "message": "Fix kafka roller when kafka CR is fixed\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMDg5NTUz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3848#pullrequestreview-513089553", "createdAt": "2020-10-20T20:05:10Z", "commit": {"oid": "f746a6b41580950d2bef4b7da3aa42891ffb8af9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDowNToxMFrOHlO_Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQyMDowNjo0OVrOHlPCow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwNDg3OA==", "bodyText": "The empty line is not needed I guess.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3848#discussion_r508804878", "createdAt": "2020-10-20T20:05:10Z", "author": {"login": "scholzj"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/KafkaRollerST.java", "diffHunk": "@@ -205,6 +217,69 @@ void testKafkaPodPending() {\n         KafkaUtils.waitForKafkaReady(CLUSTER_NAME);\n     }\n \n+    @Test\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f746a6b41580950d2bef4b7da3aa42891ffb8af9"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODgwNTc5NQ==", "bodyText": "Might be worth adding a comment to explain what and why is it testing.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3848#discussion_r508805795", "createdAt": "2020-10-20T20:06:49Z", "author": {"login": "scholzj"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/KafkaRollerST.java", "diffHunk": "@@ -205,6 +217,69 @@ void testKafkaPodPending() {\n         KafkaUtils.waitForKafkaReady(CLUSTER_NAME);\n     }\n \n+    @Test\n+\n+    void testKafkaPodPendingDueToRack() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f746a6b41580950d2bef4b7da3aa42891ffb8af9"}, "originalPosition": 38}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f746a6b41580950d2bef4b7da3aa42891ffb8af9", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f746a6b41580950d2bef4b7da3aa42891ffb8af9", "committedDate": "2020-10-20T17:02:34Z", "message": "Fix checkstyle\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}, "afterCommit": {"oid": "28e6604349fc7fcf4e408e73b2fdd4a3b237c908", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/28e6604349fc7fcf4e408e73b2fdd4a3b237c908", "committedDate": "2020-10-21T06:47:45Z", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c2eec7fe1829a63297c41932b8a21db5bc28a9e", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5c2eec7fe1829a63297c41932b8a21db5bc28a9e", "committedDate": "2020-10-21T06:48:47Z", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "28e6604349fc7fcf4e408e73b2fdd4a3b237c908", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/28e6604349fc7fcf4e408e73b2fdd4a3b237c908", "committedDate": "2020-10-21T06:47:45Z", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "5c2eec7fe1829a63297c41932b8a21db5bc28a9e", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5c2eec7fe1829a63297c41932b8a21db5bc28a9e", "committedDate": "2020-10-21T06:48:47Z", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eaedfed33189a98ef7b83a51c6c16ec12df20c8", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3eaedfed33189a98ef7b83a51c6c16ec12df20c8", "committedDate": "2020-10-21T10:05:50Z", "message": "multi/single node labelling\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20e28f7ad728e5715078d5fd6c9189bdac877f6e", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/20e28f7ad728e5715078d5fd6c9189bdac877f6e", "committedDate": "2020-10-21T10:43:02Z", "message": "apply Jakub's wisdom\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab1a5f5e08a60dab03cac0b865602264b8af5519", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ab1a5f5e08a60dab03cac0b865602264b8af5519", "committedDate": "2020-10-21T11:38:12Z", "message": "cs\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNzY1NTk1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3848#pullrequestreview-513765595", "createdAt": "2020-10-21T14:41:32Z", "commit": {"oid": "ab1a5f5e08a60dab03cac0b865602264b8af5519"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDo0MTozMlrOHlwHGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNDo0MTozMlrOHlwHGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM0NzYxMA==", "bodyText": "No need for this to return a Future. It could return a boolean just as well.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3848#discussion_r509347610", "createdAt": "2020-10-21T14:41:32Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaRoller.java", "diffHunk": "@@ -168,7 +168,17 @@ public KafkaRoller(Vertx vertx, Reconciliation reconciliation, PodOperator podOp\n     private ConcurrentHashMap<Integer, RestartContext> podToContext = new ConcurrentHashMap<>();\n     private Function<Pod, List<String>> podNeedsRestart;\n \n-    /**\n+    private Future<Void> initAdminClient() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab1a5f5e08a60dab03cac0b865602264b8af5519"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31627c6c0de965ae486231a4a7e7fbe76dbf6a14", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/31627c6c0de965ae486231a4a7e7fbe76dbf6a14", "committedDate": "2020-10-21T15:06:03Z", "message": "more correct return type\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzODA0NjU5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3848#pullrequestreview-513804659", "createdAt": "2020-10-21T15:17:10Z", "commit": {"oid": "31627c6c0de965ae486231a4a7e7fbe76dbf6a14"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNToxNzoxMVrOHlx6VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNToxOTo0MlrOHlyCbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM3NzEwOA==", "bodyText": "What state of pods is expect? You can add it to comment as well", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3848#discussion_r509377108", "createdAt": "2020-10-21T15:17:11Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/KafkaRollerST.java", "diffHunk": "@@ -205,6 +214,56 @@ void testKafkaPodPending() {\n         KafkaUtils.waitForKafkaReady(CLUSTER_NAME);\n     }\n \n+    @Test\n+    void testKafkaPodPendingDueToRack() {\n+        // Testing this scenario\n+        // 1. deploy Kafka with wrong pod template (looking for nonexistent node)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31627c6c0de965ae486231a4a7e7fbe76dbf6a14"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM3OTE4Mg==", "bodyText": "Shouldn't we add some check that pods are in pending for some time?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3848#discussion_r509379182", "createdAt": "2020-10-21T15:19:42Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/KafkaRollerST.java", "diffHunk": "@@ -205,6 +214,56 @@ void testKafkaPodPending() {\n         KafkaUtils.waitForKafkaReady(CLUSTER_NAME);\n     }\n \n+    @Test\n+    void testKafkaPodPendingDueToRack() {\n+        // Testing this scenario\n+        // 1. deploy Kafka with wrong pod template (looking for nonexistent node)\n+        // 2. wait for Kafka not ready\n+        // 3. fix the Kafka CR\n+        // 4. wait for Kafka ready\n+\n+        NodeSelectorRequirement nsr = new NodeSelectorRequirementBuilder()\n+                .withKey(\"dedicated_test\")\n+                .withNewOperator(\"In\")\n+                .withValues(\"Kafka\")\n+                .build();\n+\n+        NodeSelectorTerm nst = new NodeSelectorTermBuilder()\n+                .withMatchExpressions(nsr)\n+                .build();\n+\n+        Affinity affinity = new AffinityBuilder()\n+                .withNewNodeAffinity()\n+                    .withNewRequiredDuringSchedulingIgnoredDuringExecution()\n+                        .withNodeSelectorTerms(nst)\n+                    .endRequiredDuringSchedulingIgnoredDuringExecution()\n+                .endNodeAffinity()\n+                .build();\n+\n+        PodTemplate pt = new PodTemplate();\n+        pt.setAffinity(affinity);\n+\n+        KafkaClusterTemplate kct = new KafkaClusterTemplateBuilder()\n+                .withPod(pt)\n+                .build();\n+\n+        KafkaResource.kafkaWithoutWait(KafkaResource.defaultKafka(CLUSTER_NAME, 3, 3)\n+                .editSpec()\n+                    .editKafka()\n+                        .withTemplate(kct)\n+                    .endKafka()\n+                .endSpec()\n+                .build());\n+\n+        KafkaUtils.waitForKafkaNotReady(CLUSTER_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31627c6c0de965ae486231a4a7e7fbe76dbf6a14"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14ddcf8807921d5e486d1e584fb26a6292a64ba7", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/14ddcf8807921d5e486d1e584fb26a6292a64ba7", "committedDate": "2020-10-21T15:37:01Z", "message": "Another Jakub's objections\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzOTk4MzYw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3848#pullrequestreview-513998360", "createdAt": "2020-10-21T17:26:28Z", "commit": {"oid": "14ddcf8807921d5e486d1e584fb26a6292a64ba7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MDIzODc4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3848#pullrequestreview-514023878", "createdAt": "2020-10-21T17:47:49Z", "commit": {"oid": "14ddcf8807921d5e486d1e584fb26a6292a64ba7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 834, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}