{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3Nzc0NDgw", "number": 2465, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzozMTowNFrODbH0Ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwODo1NDoyOVrODbJAKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzY2MjAzOnYy", "diffSide": "RIGHT", "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "isResolved": true, "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzozMTowNFrOFibQ9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMTowNjozNlrOFihH6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw==", "bodyText": "\"The A list...\" seems to be a typo.\nAnyway isn't it better saying \"TLS certificates\" instead of \"public TLS keys\"?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371642613", "createdAt": "2020-01-28T07:31:04Z", "author": {"login": "ppatierno"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1MzUxMg==", "bodyText": "The problem is that our documentation is using certificate as a synonym for private key. We have things like certificates and public keys on many places. That is why I used the public keys.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371653512", "createdAt": "2020-01-28T08:05:55Z", "author": {"login": "scholzj"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw=="}, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDI5MQ==", "bodyText": "Really? It's quite the opposite!", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371654291", "createdAt": "2020-01-28T08:08:23Z", "author": {"login": "ppatierno"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw=="}, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NDU5OA==", "bodyText": "For example here we start the chapter with it: https://strimzi.io/docs/master/full.html#kafka-listener-certificates-str", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371654598", "createdAt": "2020-01-28T08:09:21Z", "author": {"login": "scholzj"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw=="}, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY3NDU4NQ==", "bodyText": "Are you referring at this sentence? \"You can provide your own server certificates and public keys\" ... in this case it's wrong imho. We should try to fix this because a server certificates IS a public key (signed).", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371674585", "createdAt": "2020-01-28T08:58:50Z", "author": {"login": "ppatierno"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw=="}, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcxNDM2Mg==", "bodyText": "I'm not sure I really agree. In my life the most common and understandable seemed to be certificate = public + private key. I usually prefer to be specific to make it easier and ytry to avoid certificate where possible. If you want I can change it here.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371714362", "createdAt": "2020-01-28T10:16:55Z", "author": {"login": "scholzj"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw=="}, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcyOTkyMA==", "bodyText": "I lived a different life maybe :-) ...  but certificate was always = signed public key. Why a certificate should be public + private key? It means that if you are delivering the certificate, you are delivering both public and private keys somehow? which is not the case.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371729920", "createdAt": "2020-01-28T10:47:57Z", "author": {"login": "ppatierno"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw=="}, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczMTA1NQ==", "bodyText": "When you generate a public + private key couple and you need a certificate out of it, you generate a CSR providing only the public key. The CSR will be processed by signing your public key generating the certificate. Your private key is not involved at all.\nActually you could do encryption stuff without any sign of your public key (but of course in this case you cannot prove that a public key is yours, so the sign by a CA for example).", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371731055", "createdAt": "2020-01-28T10:50:26Z", "author": {"login": "ppatierno"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw=="}, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczMTIyMQ==", "bodyText": "A certificate contains a public key (it also includes information about the associated entity and a digital signature from the issuer). I think we should fix the documentation which @scholzj linked (and any other places where the language is unclear). For this description I would at \"A list of TLS certificates...\" which is imho clear and correct and lets the reader keep whatever mental model of a TLS certificate they already have (correct or not).", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371731221", "createdAt": "2020-01-28T10:50:46Z", "author": {"login": "tombentley"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw=="}, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczMjI1OA==", "bodyText": "Let me know if we need to change the terminology used in \"Kafka listener certificates\".", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371732258", "createdAt": "2020-01-28T10:52:58Z", "author": {"login": "laidan6000"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw=="}, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczNTI0OQ==", "bodyText": "Comments on the description above:\nwhich can be used > that can be used\n...when connecting to the Kafka broker. Does that make sense?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371735249", "createdAt": "2020-01-28T10:59:10Z", "author": {"login": "laidan6000"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw=="}, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczNjAzMg==", "bodyText": "@laidan6000 I think we should reword: \"You can provide your own TLS certificates for the following types of listeners:\", but let's see how this discussion concludes before we go making any changes.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371736032", "createdAt": "2020-01-28T11:00:51Z", "author": {"login": "tombentley"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw=="}, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTczODYwMg==", "bodyText": "Sorry, I've just seen the full description: ... when connecting to the given listener.\nSounds good to me.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371738602", "createdAt": "2020-01-28T11:06:36Z", "author": {"login": "laidan6000"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/status/ListenerStatus.java", "diffHunk": "@@ -55,6 +56,16 @@ public void setAddresses(List<ListenerAddress> addresses) {\n         this.addresses = addresses;\n     }\n \n+    @Description(\"The A list of public TLS keys which can be used to verify the identity of the server when connecting \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MjYxMw=="}, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5NzY2NzI0OnYy", "diffSide": "RIGHT", "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperatorCustomCertTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzozMzo0NVrOFibUJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNzozMzo0NVrOFibUJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0MzQyOA==", "bodyText": "Remove commented lines?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371643428", "createdAt": "2020-01-28T07:33:45Z", "author": {"login": "ppatierno"}, "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperatorCustomCertTest.java", "diffHunk": "@@ -422,8 +422,10 @@ public MockKafkaAssemblyOperator(Vertx vertx, PlatformFeaturesAvailability pfa,\n         Future<Void> reconcile(ReconciliationState reconcileState)  {\n             return reconcileState.reconcileCas(this::dateSupplier)\n                     .compose(state -> state.getKafkaClusterDescription())\n-                    .compose(state -> state.getCustomTlsListenerThumbprint())\n-                    .compose(state -> state.getCustomExternalListenerThumbprint())\n+                    //.compose(state -> state.getCustomTlsListenerThumbprint())\n+                    //.compose(state -> state.getCustomExternalListenerThumbprint())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74e137090a17cd295ff8729b30e2f650253b73f5"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5Nzg1NTc5OnYy", "diffSide": "RIGHT", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwODo1NDoyMFrOFidE6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwODo1NDoyMFrOFidE6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY3MjI5OQ==", "bodyText": "I guess the charset should be ASCII.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371672299", "createdAt": "2020-01-28T08:54:20Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -1983,54 +1988,77 @@ private KafkaVersionChange getKafkaVersionChange(StatefulSet kafkaSts) {\n             return resultPromise.future();\n         }\n \n-        Future<ReconciliationState> getCustomTlsListenerThumbprint() {\n-            return getCertificateSignature(kafkaCluster.getSecretSourceTls()).map(thumbprint -> {\n-                tlsListenerCustomCertificateThumbprint = thumbprint;\n-                return this;\n-            });\n-        }\n+        Future<ReconciliationState> customTlsListenerCertificate() {\n+            CertAndKeySecretSource customCertSecret = kafkaCluster.getSecretSourceTls();\n \n-        Future<ReconciliationState> getCustomExternalListenerThumbprint() {\n-            return getCertificateSignature(kafkaCluster.getSecretSourceExternal()).map(thumbprint -> {\n-                externalListenerCustomCertificateThumbprint = thumbprint;\n-                return this;\n-            });\n+            return getCustomCertificateSecret(customCertSecret)\n+                    .compose(secret -> {\n+                        if (secret != null)  {\n+                            byte[] publicKeyBytes = Base64.getDecoder().decode(secret.getData().get(customCertSecret.getCertificate()));\n+                            tlsListenerCustomCertificate = new String(publicKeyBytes, Charset.defaultCharset());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "243e446ef53fcb66209b67a145bf6fd18495f566"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI5Nzg1NjQwOnYy", "diffSide": "RIGHT", "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwODo1NDoyOVrOFidFOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwODo1NDoyOVrOFidFOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY3MjM3OA==", "bodyText": "Ditto", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2465#discussion_r371672378", "createdAt": "2020-01-28T08:54:29Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -1983,54 +1988,77 @@ private KafkaVersionChange getKafkaVersionChange(StatefulSet kafkaSts) {\n             return resultPromise.future();\n         }\n \n-        Future<ReconciliationState> getCustomTlsListenerThumbprint() {\n-            return getCertificateSignature(kafkaCluster.getSecretSourceTls()).map(thumbprint -> {\n-                tlsListenerCustomCertificateThumbprint = thumbprint;\n-                return this;\n-            });\n-        }\n+        Future<ReconciliationState> customTlsListenerCertificate() {\n+            CertAndKeySecretSource customCertSecret = kafkaCluster.getSecretSourceTls();\n \n-        Future<ReconciliationState> getCustomExternalListenerThumbprint() {\n-            return getCertificateSignature(kafkaCluster.getSecretSourceExternal()).map(thumbprint -> {\n-                externalListenerCustomCertificateThumbprint = thumbprint;\n-                return this;\n-            });\n+            return getCustomCertificateSecret(customCertSecret)\n+                    .compose(secret -> {\n+                        if (secret != null)  {\n+                            byte[] publicKeyBytes = Base64.getDecoder().decode(secret.getData().get(customCertSecret.getCertificate()));\n+                            tlsListenerCustomCertificate = new String(publicKeyBytes, Charset.defaultCharset());\n+                            tlsListenerCustomCertificateThumbprint = getCertificateThumbprint(secret, customCertSecret);\n+\n+                            return Future.succeededFuture(this);\n+                        } else {\n+                            return Future.succeededFuture(this);\n+                        }\n+                    });\n         }\n \n-        Future<String> getCertificateSignature(CertAndKeySecretSource customCertSecret)  {\n-            Promise<String> thumbprintPromise = Promise.promise();\n+        Future<ReconciliationState> customExternalListenerCertificate() {\n+            CertAndKeySecretSource customCertSecret = kafkaCluster.getSecretSourceExternal();\n \n+            return getCustomCertificateSecret(customCertSecret)\n+                    .compose(secret -> {\n+                        if (secret != null)  {\n+                            byte[] publicKeyBytes = Base64.getDecoder().decode(secret.getData().get(customCertSecret.getCertificate()));\n+                            externalListenerCustomCertificate = new String(publicKeyBytes, Charset.defaultCharset());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "243e446ef53fcb66209b67a145bf6fd18495f566"}, "originalPosition": 88}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 679, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}