{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MjI0NjIz", "number": 4076, "title": "#4035: Patch Rancher Cattle annotations when reconciling services", "bodyText": "Type of change\n\nBugfix\n\nDescription\nShould fix #4035, by whitelisting all \"cattle.io\" annotations, and patching them into the desired spec for Services of the type LoadBalancer or NodePort.\n\nIs it better to make the \"cattle.io\" seed configurable?\n\nChecklist\n\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md\n Supply screenshots for visual changes, such as Grafana dashboards", "createdAt": "2020-12-09T14:35:35Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076", "merged": true, "mergeCommit": {"oid": "4ffece64a52f9365de1f2c73e384d8005d6f546e"}, "closed": true, "closedAt": "2020-12-12T18:59:09Z", "author": {"login": "mluiten"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkkGN-gFqTU0ODU0NTkwMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlhR6eAFqTU1MDg1MzY3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NTQ1OTAw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#pullrequestreview-548545900", "createdAt": "2020-12-09T19:41:53Z", "commit": {"oid": "29b636377e25b94a6825595b305c1aa197141ade"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4OTQ3MDUy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#pullrequestreview-548947052", "createdAt": "2020-12-10T08:21:00Z", "commit": {"oid": "29b636377e25b94a6825595b305c1aa197141ade"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwODoyMTowMFrOIC8zjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwODoyMjowMlrOIC82Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk2NDMwMw==", "bodyText": "I think we should be more precise to have RANCHER in the const name because it's the only one having this annotation AFAIU, right?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#discussion_r539964303", "createdAt": "2020-12-10T08:21:00Z", "author": {"login": "ppatierno"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/operator/resource/ServiceOperator.java", "diffHunk": "@@ -11,13 +11,19 @@\n import io.fabric8.kubernetes.client.KubernetesClient;\n import io.fabric8.kubernetes.client.dsl.MixedOperation;\n import io.fabric8.kubernetes.client.dsl.ServiceResource;\n+import io.strimzi.operator.common.Util;\n import io.vertx.core.Future;\n import io.vertx.core.Vertx;\n \n+import java.util.Map;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n /**\n  * Operations for {@code Service}s.\n  */\n public class ServiceOperator extends AbstractResourceOperator<KubernetesClient, Service, ServiceList, DoneableService, ServiceResource<Service, DoneableService>> {\n+    private static final String CATTLE_ANNOTATION_SEED = \"cattle.io\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29b636377e25b94a6825595b305c1aa197141ade"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk2NDk1NA==", "bodyText": "instead of having a specific method for just this \"cattle\" annotation, why not having a more general one passing a list of annotations to patch which in this case will continue just one annotation for now?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#discussion_r539964954", "createdAt": "2020-12-10T08:22:02Z", "author": {"login": "ppatierno"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/operator/resource/ServiceOperator.java", "diffHunk": "@@ -70,6 +77,31 @@ public ServiceOperator(Vertx vertx, KubernetesClient client) {\n         }\n     }\n \n+    /**\n+     * Finds annotations managed by the Rancher cattle agents (if any), and merge them into the desired spec.\n+     *\n+     * This makes sure there is no infinite loop where Rancher tries to add annotations, while Rancher keeps\n+     * removing them during reconciliation.\n+     *\n+     * @param current   Current Service\n+     * @param desired   Desired Service\n+     */\n+    private void patchCattleAnnotations(Service current, Service desired) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29b636377e25b94a6825595b305c1aa197141ade"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3eeae08cfbe13bb64f81232a995c0013e88edf3", "author": {"user": {"login": "mluiten", "name": "Menno Luiten"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c3eeae08cfbe13bb64f81232a995c0013e88edf3", "committedDate": "2020-12-10T09:37:57Z", "message": "Patch Rancher Cattle annotations when reconciling services (#4035)\n\nSigned-off-by: Menno Luiten <menno.luiten@ah.nl>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "29b636377e25b94a6825595b305c1aa197141ade", "author": {"user": {"login": "mluiten", "name": "Menno Luiten"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/29b636377e25b94a6825595b305c1aa197141ade", "committedDate": "2020-12-09T14:32:25Z", "message": "#4035: Patch Rancher Cattle annotations when reconciling services"}, "afterCommit": {"oid": "c3eeae08cfbe13bb64f81232a995c0013e88edf3", "author": {"user": {"login": "mluiten", "name": "Menno Luiten"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c3eeae08cfbe13bb64f81232a995c0013e88edf3", "committedDate": "2020-12-10T09:37:57Z", "message": "Patch Rancher Cattle annotations when reconciling services (#4035)\n\nSigned-off-by: Menno Luiten <menno.luiten@ah.nl>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f393d39a71b5247b4df6a335ea87d92f84debc29", "author": {"user": {"login": "mluiten", "name": "Menno Luiten"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f393d39a71b5247b4df6a335ea87d92f84debc29", "committedDate": "2020-12-10T09:59:02Z", "message": "Moved configuration of load balancer annotation to whitelist in Annotations (#4035)\n\nSigned-off-by: Menno Luiten <menno.luiten@ah.nl>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MDgxMzA4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#pullrequestreview-549081308", "createdAt": "2020-12-10T11:00:16Z", "commit": {"oid": "f393d39a71b5247b4df6a335ea87d92f84debc29"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NjczNDUz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#pullrequestreview-549673453", "createdAt": "2020-12-10T22:51:19Z", "commit": {"oid": "f393d39a71b5247b4df6a335ea87d92f84debc29"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMjo1MToxOVrOIDg56w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMjo1MToxOVrOIDg56w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU1NTc1NQ==", "bodyText": "I wonder if we really need the matching here. If the contains or startsWith which was used originally wasn't better in terms of performance etc. @tombentley WDYT?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#discussion_r540555755", "createdAt": "2020-12-10T22:51:19Z", "author": {"login": "scholzj"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/operator/resource/ServiceOperator.java", "diffHunk": "@@ -70,6 +78,31 @@ public ServiceOperator(Vertx vertx, KubernetesClient client) {\n         }\n     }\n \n+    /**\n+     * Finds annotations managed by the Rancher cattle agents (if any), and merge them into the desired spec.\n+     *\n+     * This makes sure there is no infinite loop where Rancher tries to add annotations, while Rancher keeps\n+     * removing them during reconciliation.\n+     *\n+     * @param current   Current Service\n+     * @param desired   Desired Service\n+     */\n+    private void patchAnnotations(Service current, Service desired) {\n+        Map<String, String> currentAnnotations = current.getMetadata().getAnnotations();\n+        if (currentAnnotations != null) {\n+            Map<String, String> matchedAnnotations = currentAnnotations.keySet().stream()\n+                    .filter(annotation -> LOADBALANCER_ANNOTATION_WHITELIST.stream().anyMatch(whitelist -> whitelist.test(annotation)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f393d39a71b5247b4df6a335ea87d92f84debc29"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad4c25510cf80677146a5b24068dfc8af30c844b", "author": {"user": {"login": "mluiten", "name": "Menno Luiten"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ad4c25510cf80677146a5b24068dfc8af30c844b", "committedDate": "2020-12-11T13:59:22Z", "message": "Replace regex with startsWith for better performance\n\nSigned-off-by: Menno Luiten <menno.luiten@ah.nl>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4dd965a2efbef0326cbc0bfffb92a3b50bbf50f0", "author": {"user": {"login": "mluiten", "name": "Menno Luiten"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4dd965a2efbef0326cbc0bfffb92a3b50bbf50f0", "committedDate": "2020-12-11T13:38:53Z", "message": "Replace regex with startsWith for better performance"}, "afterCommit": {"oid": "ad4c25510cf80677146a5b24068dfc8af30c844b", "author": {"user": {"login": "mluiten", "name": "Menno Luiten"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ad4c25510cf80677146a5b24068dfc8af30c844b", "committedDate": "2020-12-11T13:59:22Z", "message": "Replace regex with startsWith for better performance\n\nSigned-off-by: Menno Luiten <menno.luiten@ah.nl>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e17034f6831c04cbb34a40a7f55b696c8518f64", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4e17034f6831c04cbb34a40a7f55b696c8518f64", "committedDate": "2020-12-12T00:00:13Z", "message": "Fix checkstyles\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwODUzNjc4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4076#pullrequestreview-550853678", "createdAt": "2020-12-12T18:58:52Z", "commit": {"oid": "4e17034f6831c04cbb34a40a7f55b696c8518f64"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 724, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}