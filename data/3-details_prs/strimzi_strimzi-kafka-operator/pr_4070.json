{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0NzMwMTgy", "number": 4070, "title": "Make it possible to roll Kafka or ZooKeeper pods individually", "bodyText": "Type of change\n\nEnhancement / new feature\n\nDescription\nStrimzi currently supports use of annotation on the StatefulSet resources to trigger manually a rolling update. But in some cases, it might make sense to roll just some of the pods but do it through the operator instead of deleting them manually. Doing it through the operator can ensure that:\n\nThe manual deletion does not conflict with any action the operator might take at the same time (e.g. delete another pod in parallel)\nUse the operator logic to do the roll (especially important for Kafka where it checks the in-sync replicas etc.)\n\nThis PR makes it possible by using the same annotation as for StatefulSet, but on the pod level. When multiple pods from the same StatefulSet are annotated, they will be rolled one after another but within the same reconciliation run.\nSystem tests and documentation will be done in a separate PR.\nChecklist\n\n Write tests\n Make sure all tests pass\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Update CHANGELOG.md", "createdAt": "2020-12-08T21:16:23Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4070", "merged": true, "mergeCommit": {"oid": "1d33ba40851c7f5a871c454645b64beb36830eae"}, "closed": true, "closedAt": "2020-12-09T15:10:12Z", "author": {"login": "scholzj"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkQ6fwgH2gAyNTM0NzMwMTgyOmQ2ODQ0YmFkNmQ4OWY4ZmUzM2I3ZTU1ODhjN2E4MzY4M2NjNmRjN2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkfu3EgFqTU0ODI0NjM2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d6844bad6d89f8fe33b7e5588c7a83683cc6dc7a", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d6844bad6d89f8fe33b7e5588c7a83683cc6dc7a", "committedDate": "2020-12-08T21:20:53Z", "message": "Make it possible to roll Kafka or ZooKeeper pods individually\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97959eef75cf1f711018ac348b4d07d3e81ea4a7", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/97959eef75cf1f711018ac348b4d07d3e81ea4a7", "committedDate": "2020-12-08T21:21:43Z", "message": "CHANGELOG.md\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf4330ebd615faefe56900ef33e902faeb7f45f5", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/bf4330ebd615faefe56900ef33e902faeb7f45f5", "committedDate": "2020-12-08T21:15:39Z", "message": "CHANGELOG.md\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}, "afterCommit": {"oid": "97959eef75cf1f711018ac348b4d07d3e81ea4a7", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/97959eef75cf1f711018ac348b4d07d3e81ea4a7", "committedDate": "2020-12-08T21:21:43Z", "message": "CHANGELOG.md\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MDI1MjQ4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4070#pullrequestreview-548025248", "createdAt": "2020-12-09T10:08:48Z", "commit": {"oid": "97959eef75cf1f711018ac348b4d07d3e81ea4a7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDowODo0OFrOICMmow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMDowODo0OFrOICMmow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTE3NDU2Mw==", "bodyText": "commented code?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4070#discussion_r539174563", "createdAt": "2020-12-09T10:08:48Z", "author": {"login": "ppatierno"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -753,6 +753,66 @@ public void checkCustomCaSecret(CertificateAuthority ca, Secret certSecret, Secr\n                     });\n         }\n \n+        /**\n+         * Does rolling update of Kafka pods based on the annotation on Pod level\n+         *\n+         * @param sts   The Kafka StatefulSet definition needed for the rolling update\n+         *\n+         * @return  Future with the result of the rolling update\n+         */\n+        @SuppressWarnings(\"deprecation\")\n+        Future<Void> kafkaManualPodRollingUpdate(StatefulSet sts) {\n+            return podOperations.listAsync(namespace, kafkaCluster.getSelectorLabels())\n+                    .compose(pods -> {\n+                        List<String> podsToRoll = new ArrayList<>(0);\n+\n+                        for (Pod pod : pods)    {\n+                            if (Annotations.booleanAnnotation(pod, Annotations.ANNO_STRIMZI_IO_MANUAL_ROLLING_UPDATE,\n+                                    false, Annotations.ANNO_OP_STRIMZI_IO_MANUAL_ROLLING_UPDATE)) {\n+                                podsToRoll.add(pod.getMetadata().getName());\n+                            }\n+                        }\n+\n+                        if (!podsToRoll.isEmpty())  {\n+                            return maybeRollKafka(sts, pod -> {\n+                                if (pod != null && podsToRoll.contains(pod.getMetadata().getName())) {\n+                                    log.debug(\"{}: Rolling Kafka pod {} due to manual rolling update annotation on a pod\", reconciliation, pod.getMetadata().getName());\n+                                    return singletonList(\"manual rolling update annotation on a pod\");\n+                                } else {\n+                                    return null;\n+                                }\n+                            });\n+                        } else {\n+                            return Future.succeededFuture();\n+                        }\n+\n+                        /*Future<Void> podRoll = Future.succeededFuture();\n+\n+                        for (String podName : podsToRoll)   {\n+                            podRoll = podRoll.compose(ignore -> {\n+                                return maybeRollKafka(sts, pod -> {\n+                                    if (pod != null && podName.equals(pod.getMetadata().getName())) {\n+                                        log.debug(\"{}: Rolling Kafka pod {} due to manual rolling update annotation on a pod\", reconciliation, podName);\n+                                        return singletonList(\"manual rolling update annotation on a pod\");\n+                                    } else {\n+                                        return null;\n+                                    }\n+                                });\n+                            });\n+                        }\n+\n+                        return withVoid(podRoll);*/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97959eef75cf1f711018ac348b4d07d3e81ea4a7"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa252d51601002c6a4dd2a946ba4e30abb7c66e0", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fa252d51601002c6a4dd2a946ba4e30abb7c66e0", "committedDate": "2020-12-09T10:15:56Z", "message": "Remove commented out code\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MDU0MDI3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4070#pullrequestreview-548054027", "createdAt": "2020-12-09T10:43:04Z", "commit": {"oid": "fa252d51601002c6a4dd2a946ba4e30abb7c66e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MjQ2MzY5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4070#pullrequestreview-548246369", "createdAt": "2020-12-09T14:36:45Z", "commit": {"oid": "fa252d51601002c6a4dd2a946ba4e30abb7c66e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 713, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}