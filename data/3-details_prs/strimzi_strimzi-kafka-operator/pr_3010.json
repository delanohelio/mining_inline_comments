{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NTMxMzc2", "number": 3010, "title": "[systemtest][rollingupdate] Test - replication factor lower than min.insync.replicas", "bodyText": "Signed-off-by: Lukas Kral lukywill16@gmail.com\nType of change\n\nNew test\n\nDescription\nIn this PR I added test about KafkaRoller/rolling update - earlier when we changed min.insync.replicas to be higher than replication factor, KafkaRoller didn't rolled Kafka pods (even when we trigger rolling update manually). Now when we do this change, the pods should be rolled even if KafkaTopic will not be available.\nClosed issue: #2964\nPR with fix: #2968\nChecklist\n\n Write tests\n Make sure all tests pass", "createdAt": "2020-05-13T18:17:37Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3010", "merged": true, "mergeCommit": {"oid": "9d4b26513fcd33269d0ef3642fee21c257075685"}, "closed": true, "closedAt": "2020-05-14T11:24:08Z", "author": {"login": "im-konge"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg9oczgFqTQxMTIxMzc1Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABchJ446AFqTQxMTYxNjMzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjEzNzUy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3010#pullrequestreview-411213752", "createdAt": "2020-05-13T19:00:03Z", "commit": {"oid": "38572fe3fa887ced24c4f9cf468f83cd3549ed03"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjgwMjI2", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3010#pullrequestreview-411280226", "createdAt": "2020-05-13T20:36:47Z", "commit": {"oid": "38572fe3fa887ced24c4f9cf468f83cd3549ed03"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDozNjo0N1rOGVCm6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDozNjo0N1rOGVCm6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcxNjAwOA==", "bodyText": "Do we need this check when we wait for rolling update anyway?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3010#discussion_r424716008", "createdAt": "2020-05-13T20:36:47Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/RollingUpdateST.java", "diffHunk": "@@ -972,6 +972,34 @@ void testMetricsChange() {\n         zkMetricsOutput.values().forEach(value -> assertThat(value, is(\"\")));\n     }\n \n+    @Test\n+    void testKafkaTopicRFLowerThanMinInSyncReplicas() {\n+        KafkaResource.kafkaPersistent(CLUSTER_NAME, 2).done();\n+        KafkaTopicResource.topic(CLUSTER_NAME, TOPIC_NAME, 1, 1).done();\n+\n+        String kafkaName = KafkaResources.kafkaStatefulSetName(CLUSTER_NAME);\n+        Map<String, String> kafkaPods = StatefulSetUtils.ssSnapshot(kafkaName);\n+\n+        LOGGER.info(\"Setting KafkaTopic's min.insync.replicas to be higher than replication factor\");\n+        KafkaTopicResource.replaceTopicResource(TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().getConfig().replace(\"min.insync.replicas\", 2));\n+\n+        // rolling update for kafka\n+        LOGGER.info(\"Annotate Kafka StatefulSet {} with manual rolling update annotation\", kafkaName);\n+        timeMeasuringSystem.setOperationID(timeMeasuringSystem.startTimeMeasuring(Operation.ROLLING_UPDATE));\n+        // set annotation to trigger Kafka rolling update\n+        kubeClient().statefulSet(kafkaName).cascading(false).edit()\n+            .editMetadata()\n+                .addToAnnotations(Annotations.ANNO_STRIMZI_IO_MANUAL_ROLLING_UPDATE, \"true\")\n+            .endMetadata().done();\n+\n+        // check annotation to trigger rolling update\n+        assertThat(Boolean.parseBoolean(kubeClient().getStatefulSet(kafkaName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38572fe3fa887ced24c4f9cf468f83cd3549ed03"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "450142a9188d5b956acdf6bbcf216fb8d9b0f8e3", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/450142a9188d5b956acdf6bbcf216fb8d9b0f8e3", "committedDate": "2020-05-14T09:10:11Z", "message": "add new test for execute rolling update if rf is lower than min.insync.replicas\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6291c7091dde14c919875dfa6eaa616d145f81d2", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6291c7091dde14c919875dfa6eaa616d145f81d2", "committedDate": "2020-05-14T09:10:11Z", "message": "comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38572fe3fa887ced24c4f9cf468f83cd3549ed03", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/38572fe3fa887ced24c4f9cf468f83cd3549ed03", "committedDate": "2020-05-13T18:01:12Z", "message": "add new test for execute rolling update if rf is lower than min.insync.replicas\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "6291c7091dde14c919875dfa6eaa616d145f81d2", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6291c7091dde14c919875dfa6eaa616d145f81d2", "committedDate": "2020-05-14T09:10:11Z", "message": "comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNjE2MzMy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3010#pullrequestreview-411616332", "createdAt": "2020-05-14T09:16:52Z", "commit": {"oid": "6291c7091dde14c919875dfa6eaa616d145f81d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1703, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}