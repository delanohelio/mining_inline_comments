{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNDczNDgw", "number": 3540, "title": "KafkaRoller: Common Admin client, and always check canRoll", "bodyText": "Type of change\n\nBugfix\n\nDescription\nThis is an alternative to #3534 which always checks canRoll before restarting. Unlike #3534 it doesn't treat the controller specially (or rather, only way the controller is special is that it's rolled last).\nChecklist\nPlease go through this checklist and make sure all applicable tasks have been done\n\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md\n Supply screenshots for visual changes, such as Grafana dashboards", "createdAt": "2020-08-24T12:10:11Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3540", "merged": true, "mergeCommit": {"oid": "758ec643ad2c99d7b532302a70916ad713b219ed"}, "closed": true, "closedAt": "2020-08-28T11:44:30Z", "author": {"login": "tombentley"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCDcPrgFqTQ3MzUyNzMwMQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDThoGAFqTQ3NzY2MTA1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNTI3MzAx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3540#pullrequestreview-473527301", "createdAt": "2020-08-24T14:11:30Z", "commit": {"oid": "37dbe54904c82db5798708779049c24eee04c0ad"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNDoxMTozMVrOHFm3cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNDoyNDo1NFrOHFnbYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY0MTcxNA==", "bodyText": "Force-rolled suggests something went wrong. But in case of the controller this might be the first actual check of whether it can be restarted because before it was always deferred. So I think this message is right for other pods but not for the controller.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3540#discussion_r475641714", "createdAt": "2020-08-24T14:11:31Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaRoller.java", "diffHunk": "@@ -346,8 +343,13 @@ private void restartIfNecessary(int podId, RestartContext restartContext)\n             }\n         } catch (ForceableProblem e) {\n             if (restartContext.backOff.done() || e.forceNow) {\n-                log.warn(\"{}: Pod {} will be force-rolled\", reconciliation, podName(podId));\n-                restartAndAwaitReadiness(pod, operationTimeoutMs, TimeUnit.MILLISECONDS);\n+                if (canRoll(allClient, podId, 60_000, TimeUnit.MILLISECONDS)) {\n+                    log.warn(\"{}: Pod {} will be force-rolled\", reconciliation, podName(podId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37dbe54904c82db5798708779049c24eee04c0ad"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTY1MDkxNQ==", "bodyText": "This does not make sense to me. You should not respond to ForceableProblem thrown from canRoll by running canRoll again. Maybe canRoll should not throw ForceableProblem then?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3540#discussion_r475650915", "createdAt": "2020-08-24T14:24:54Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaRoller.java", "diffHunk": "@@ -346,8 +343,13 @@ private void restartIfNecessary(int podId, RestartContext restartContext)\n             }\n         } catch (ForceableProblem e) {\n             if (restartContext.backOff.done() || e.forceNow) {\n-                log.warn(\"{}: Pod {} will be force-rolled\", reconciliation, podName(podId));\n-                restartAndAwaitReadiness(pod, operationTimeoutMs, TimeUnit.MILLISECONDS);\n+                if (canRoll(allClient, podId, 60_000, TimeUnit.MILLISECONDS)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37dbe54904c82db5798708779049c24eee04c0ad"}, "originalPosition": 101}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNTQzNDg3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3540#pullrequestreview-473543487", "createdAt": "2020-08-24T14:28:46Z", "commit": {"oid": "37dbe54904c82db5798708779049c24eee04c0ad"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "084cd57cf8a08d4597dc9c32065eccefb4ce27de", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/084cd57cf8a08d4597dc9c32065eccefb4ce27de", "committedDate": "2020-08-26T15:03:04Z", "message": "Use a common Admin client in KafkaRoller for some calls\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24917785e1542476c26bfa9ca29c827fb47db707", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/24917785e1542476c26bfa9ca29c827fb47db707", "committedDate": "2020-08-26T15:03:07Z", "message": "fixup\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9272b15e6f09fe7b08e6653d9a513ac11678fe0e", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9272b15e6f09fe7b08e6653d9a513ac11678fe0e", "committedDate": "2020-08-26T15:03:07Z", "message": "simplify\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e61f5d28a194c37d557ba64e60b6c8072af6a683", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e61f5d28a194c37d557ba64e60b6c8072af6a683", "committedDate": "2020-08-26T15:03:07Z", "message": "Fix failing test\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "404e109c6b54d76c52a2edea59435b541f9a3060", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/404e109c6b54d76c52a2edea59435b541f9a3060", "committedDate": "2020-08-26T15:03:07Z", "message": "Add test\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "309c1225c6a43d76a8a8f8698f5c6b6ea7447fba", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/309c1225c6a43d76a8a8f8698f5c6b6ea7447fba", "committedDate": "2020-08-26T15:03:07Z", "message": "spotbugs\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87f6a8dc89c5e8ffb18eff99f943ec8495ffca55", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/87f6a8dc89c5e8ffb18eff99f943ec8495ffca55", "committedDate": "2020-08-26T15:03:07Z", "message": "Spurious spotbugs error\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "588cbdf0beab88c2bd989b89774d4fa4834aee19", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/588cbdf0beab88c2bd989b89774d4fa4834aee19", "committedDate": "2020-08-26T15:03:07Z", "message": "Add test\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8abe02bef578811f9415b5c6eafada4f637a851d", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8abe02bef578811f9415b5c6eafada4f637a851d", "committedDate": "2020-08-26T15:03:07Z", "message": "Grr\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d45ba97f41d267ae1563ee38782b3e8dc734c12", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5d45ba97f41d267ae1563ee38782b3e8dc734c12", "committedDate": "2020-08-26T15:03:07Z", "message": "non-fatal\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8d0059950dabedeaf3c67177b8d40788c7b716a", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c8d0059950dabedeaf3c67177b8d40788c7b716a", "committedDate": "2020-08-26T15:19:22Z", "message": "Treat SslAuthenticationException specially\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70f01ead00a50261bc39c5d07ea7d77cbf734673", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/70f01ead00a50261bc39c5d07ea7d77cbf734673", "committedDate": "2020-08-26T15:19:24Z", "message": "Improve\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80f8c6fabce7421d8b2c539bfc8b204afec3dca9", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/80f8c6fabce7421d8b2c539bfc8b204afec3dca9", "committedDate": "2020-08-26T14:53:45Z", "message": "Improve\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}, "afterCommit": {"oid": "70f01ead00a50261bc39c5d07ea7d77cbf734673", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/70f01ead00a50261bc39c5d07ea7d77cbf734673", "committedDate": "2020-08-26T15:19:24Z", "message": "Improve\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "051798d03e50cdc449492ffbee9b25b84aa03aa3", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/051798d03e50cdc449492ffbee9b25b84aa03aa3", "committedDate": "2020-08-28T11:41:51Z", "message": "Fixup\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3NjYxMDUx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3540#pullrequestreview-477661051", "createdAt": "2020-08-28T11:43:56Z", "commit": {"oid": "051798d03e50cdc449492ffbee9b25b84aa03aa3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1199, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}