{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MTAxNzQw", "number": 2564, "title": "CO validation for cluster size and dependent configs", "bodyText": "Signed-off-by: Stanislav Knot sknot@redhat.com\nType of change\n\nEnhancement\n\nDescription\nFixes #2501\nChecklist\n\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging", "createdAt": "2020-02-17T12:06:15Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564", "merged": true, "mergeCommit": {"oid": "a86469c9a75a697b36a1f7a86c6e43726d7b83f4"}, "closed": true, "closedAt": "2020-02-19T10:33:50Z", "author": {"login": "sknot-rh"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFMJfkAH2gAyMzc2MTAxNzQwOjM2YTY4ODBmODU1NWJlNzg3NjI3NTk5ZWY3MWVjNTRkZDVmZjhiZDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFzpuNAFqTM2MDk4MzAwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "36a6880f8555be787627599ef71ec54dd5ff8bd6", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/36a6880f8555be787627599ef71ec54dd5ff8bd6", "committedDate": "2020-02-17T12:04:56Z", "message": "CO validation for cluster size and dependent configs\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5OTQ4MjIx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#pullrequestreview-359948221", "createdAt": "2020-02-17T20:13:56Z", "commit": {"oid": "36a6880f8555be787627599ef71ec54dd5ff8bd6"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMTczNDc5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#pullrequestreview-360173479", "createdAt": "2020-02-18T09:15:30Z", "commit": {"oid": "36a6880f8555be787627599ef71ec54dd5ff8bd6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwOToxNTozMFrOFq6fwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwOToxNzoxNFrOFq6jyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU0MjkxMw==", "bodyText": "Unless there's already been some validation of the config by this point, then you can't assume that the value of the propertyName is parseable as an int, so you need to catch NumberFormatException.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r380542913", "createdAt": "2020-02-18T09:15:30Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -658,6 +662,18 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n+    private static void validateConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {\n+        String orLess = kafkaClusterSpec.getReplicas() > 1 ? \" or less\" : \"\";\n+        if (kafkaClusterSpec.getConfig() != null) {\n+            if (kafkaClusterSpec.getConfig().get(propertyName) != null) {\n+                if (Integer.parseInt(kafkaClusterSpec.getConfig().get(propertyName).toString()) > kafkaClusterSpec.getReplicas()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36a6880f8555be787627599ef71ec54dd5ff8bd6"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU0MzQ5Nw==", "bodyText": "The message should explain why the upper bound is that is it. \"... because spec.kafka.replicas is N\".", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r380543497", "createdAt": "2020-02-18T09:16:29Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -658,6 +662,18 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n+    private static void validateConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {\n+        String orLess = kafkaClusterSpec.getReplicas() > 1 ? \" or less\" : \"\";\n+        if (kafkaClusterSpec.getConfig() != null) {\n+            if (kafkaClusterSpec.getConfig().get(propertyName) != null) {\n+                if (Integer.parseInt(kafkaClusterSpec.getConfig().get(propertyName).toString()) > kafkaClusterSpec.getReplicas()) {\n+                    log.warn(\"Kafka configuration '{}' should be set to {}{}.\", propertyName, kafkaClusterSpec.getReplicas(), orLess);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36a6880f8555be787627599ef71ec54dd5ff8bd6"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU0Mzk0NA==", "bodyText": "We should either warn or throw (which will only result in another log), not both so as to avoid duplicate log entries.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r380543944", "createdAt": "2020-02-18T09:17:14Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -658,6 +662,18 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n+    private static void validateConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {\n+        String orLess = kafkaClusterSpec.getReplicas() > 1 ? \" or less\" : \"\";\n+        if (kafkaClusterSpec.getConfig() != null) {\n+            if (kafkaClusterSpec.getConfig().get(propertyName) != null) {\n+                if (Integer.parseInt(kafkaClusterSpec.getConfig().get(propertyName).toString()) > kafkaClusterSpec.getReplicas()) {\n+                    log.warn(\"Kafka configuration '{}' should be set to {}{}.\", propertyName, kafkaClusterSpec.getReplicas(), orLess);\n+                    throw new InvalidResourceException(\"Kafka configuration '\" + propertyName + \"' should be set to \" + kafkaClusterSpec.getReplicas() + orLess + \".\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36a6880f8555be787627599ef71ec54dd5ff8bd6"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3c464a98e2e072743e1ca3f30b003e03f970b92", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c3c464a98e2e072743e1ca3f30b003e03f970b92", "committedDate": "2020-02-18T15:24:11Z", "message": "Tomments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDMyMTI3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#pullrequestreview-360432127", "createdAt": "2020-02-18T15:27:28Z", "commit": {"oid": "c3c464a98e2e072743e1ca3f30b003e03f970b92"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNToyNzoyOFrOFrGzIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNToyNzoyOFrOFrGzIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc0NDQ4Mw==", "bodyText": "I don't think you need isOk. Just return from within the catch block.\nAlso, use proper logging to say that  should be an integer, rather than e.printStackTrace();", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r380744483", "createdAt": "2020-02-18T15:27:28Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -662,16 +662,25 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n-    private static void validateConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {\n+    protected static boolean validateConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {\n+        /* test */\n+        boolean isOk = true;\n         String orLess = kafkaClusterSpec.getReplicas() > 1 ? \" or less\" : \"\";\n         if (kafkaClusterSpec.getConfig() != null) {\n             if (kafkaClusterSpec.getConfig().get(propertyName) != null) {\n-                if (Integer.parseInt(kafkaClusterSpec.getConfig().get(propertyName).toString()) > kafkaClusterSpec.getReplicas()) {\n-                    log.warn(\"Kafka configuration '{}' should be set to {}{}.\", propertyName, kafkaClusterSpec.getReplicas(), orLess);\n-                    throw new InvalidResourceException(\"Kafka configuration '\" + propertyName + \"' should be set to \" + kafkaClusterSpec.getReplicas() + orLess + \".\");\n+                try {\n+                    int propertyVal = Integer.parseInt(kafkaClusterSpec.getConfig().get(propertyName).toString());\n+                    if (propertyVal > kafkaClusterSpec.getReplicas()) {\n+                        isOk = false;\n+                        log.warn(\"Kafka configuration '{}' should be set to {}{} because 'spec.kafka.replicas' is {}\", propertyName, kafkaClusterSpec.getReplicas(), orLess, kafkaClusterSpec.getReplicas());\n+                    }\n+                } catch (NumberFormatException e) {\n+                    isOk = false;\n+                    e.printStackTrace();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3c464a98e2e072743e1ca3f30b003e03f970b92"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "218bb9ac3bd3b8986119e23a2588dae9b54f639a", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/218bb9ac3bd3b8986119e23a2588dae9b54f639a", "committedDate": "2020-02-18T15:31:42Z", "message": "Tomments2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNjgzNDI4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#pullrequestreview-360683428", "createdAt": "2020-02-18T21:25:00Z", "commit": {"oid": "218bb9ac3bd3b8986119e23a2588dae9b54f639a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyNTowMFrOFrS9Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQyMToyNTowMFrOFrS9Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MzY2Ng==", "bodyText": "This seems a bit weird now. You validate it, but return boolean and do nothing with it. Shouldn't you throw an exception or something? Eventually, if you agreed with @tombentley to only print warning I can live with it, but why return boolean then? Or did I missed something?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r380943666", "createdAt": "2020-02-18T21:25:00Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -658,6 +662,25 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n+    protected static boolean validateIntConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "218bb9ac3bd3b8986119e23a2588dae9b54f639a"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwODU3NDY1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#pullrequestreview-360857465", "createdAt": "2020-02-19T05:55:17Z", "commit": {"oid": "218bb9ac3bd3b8986119e23a2588dae9b54f639a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNTo1NToxN1rOFrb52Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNjowMDo0NVrOFrb-rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA5MDI2NQ==", "bodyText": "just put the second condition on the first if as well, or?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r381090265", "createdAt": "2020-02-19T05:55:17Z", "author": {"login": "ppatierno"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -658,6 +662,25 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n+    protected static boolean validateIntConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {\n+        String orLess = kafkaClusterSpec.getReplicas() > 1 ? \" or less\" : \"\";\n+        if (kafkaClusterSpec.getConfig() != null) {\n+            if (kafkaClusterSpec.getConfig().get(propertyName) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "218bb9ac3bd3b8986119e23a2588dae9b54f639a"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTA5MTUwMg==", "bodyText": "If the user configuration is wrong and the Kafka cluster is not going to work, I agree with Jakub that an exception could be raised. It should avoid having the reconcile ends well and starting an unusable cluster , right?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#discussion_r381091502", "createdAt": "2020-02-19T06:00:45Z", "author": {"login": "ppatierno"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -658,6 +662,25 @@ public static KafkaCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup vers\n         return result;\n     }\n \n+    protected static boolean validateIntConfigProperty(String propertyName, KafkaClusterSpec kafkaClusterSpec) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDk0MzY2Ng=="}, "originalCommit": {"oid": "218bb9ac3bd3b8986119e23a2588dae9b54f639a"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc9be590afb1386c75898199abdbbbe4962e4ee9", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/cc9be590afb1386c75898199abdbbbe4962e4ee9", "committedDate": "2020-02-19T08:07:37Z", "message": "review comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTY5NzQx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#pullrequestreview-360969741", "createdAt": "2020-02-19T09:48:08Z", "commit": {"oid": "cc9be590afb1386c75898199abdbbbe4962e4ee9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwOTgzMDA5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2564#pullrequestreview-360983009", "createdAt": "2020-02-19T10:06:26Z", "commit": {"oid": "cc9be590afb1386c75898199abdbbbe4962e4ee9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1724, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}