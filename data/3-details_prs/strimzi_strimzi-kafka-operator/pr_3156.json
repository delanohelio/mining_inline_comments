{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MDk0ODcx", "number": 3156, "title": "[systemtest] testClusterCaRemovedTriggersRollingUpdate -> \"fix\"", "bodyText": "Signed-off-by: Lukas Kral lukywill16@gmail.com\nType of change\n\n\"Bugfix\"\n\nDescription\nThis PR gonna rename our testClusterCaRemovedTriggersRollingUpdate to be more relevant and move it to another suit with different operationTimeout than in RollingUpdateST.\nThe reason why I put test to different suite with higher operationTimeout (5mins) is, that when we had only 30s set for operationTimeout, the rolling update somehow stucked on one place -> only one from three ZK pods where rolled, even Kafka didn't rolled. This bug was raised and will be fixed one of the future PRs. When I set operationTimeout to 5 minutes, the rolling update ran smooth and the test was successful.\nChecklist\n\n Make sure all tests pass", "createdAt": "2020-06-04T21:15:20Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156", "merged": true, "mergeCommit": {"oid": "57c723041b3c83e06c403bec7c4296a5c4974f2f"}, "closed": true, "closedAt": "2020-06-05T22:27:28Z", "author": {"login": "im-konge"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoE7gOAH2gAyNDI4MDk0ODcxOmJlNmQ5NTA0MzcxOTAwNjZmOGUxYzRjMTMyNzM0OTJkMzdlNmRhMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoXNVXAFqTQyNTU0MjMxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "be6d950437190066f8e1c4c13273492d37e6da00", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/be6d950437190066f8e1c4c13273492d37e6da00", "committedDate": "2020-06-04T21:27:40Z", "message": "move test from one suite to another\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6bde33f2537b402fdf3902d0f6ed59d2c37d1b3f", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6bde33f2537b402fdf3902d0f6ed59d2c37d1b3f", "committedDate": "2020-06-04T20:44:57Z", "message": "move test from one suite to another\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "be6d950437190066f8e1c4c13273492d37e6da00", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/be6d950437190066f8e1c4c13273492d37e6da00", "committedDate": "2020-06-04T21:27:40Z", "message": "move test from one suite to another\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDczOTY0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#pullrequestreview-425073964", "createdAt": "2020-06-05T07:51:44Z", "commit": {"oid": "be6d950437190066f8e1c4c13273492d37e6da00"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDkyNzM3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#pullrequestreview-425092737", "createdAt": "2020-06-05T08:19:59Z", "commit": {"oid": "be6d950437190066f8e1c4c13273492d37e6da00"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxOTo1OVrOGfk66g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoxOTo1OVrOGfk66g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2Mzk0Ng==", "bodyText": "This scenario is a little niche, might it be useful to add a documented comment?\nAlso might we want to also unit test this scenario?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#discussion_r435763946", "createdAt": "2020-06-05T08:19:59Z", "author": {"login": "samuel-hawker"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/ManualRollingUpdateST.java", "diffHunk": "@@ -144,6 +145,50 @@ void testManualTriggeringRollingUpdate() {\n         assertThat(received, is(sent));\n     }\n \n+    @Test\n+    void testRollingUpdateOnNextReconciliationAfterClusterCAKeyDel() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be6d950437190066f8e1c4c13273492d37e6da00"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDkzODMz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#pullrequestreview-425093833", "createdAt": "2020-06-05T08:21:29Z", "commit": {"oid": "be6d950437190066f8e1c4c13273492d37e6da00"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyMToyOVrOGfk-UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODoyMToyOVrOGfk-UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc2NDgxNg==", "bodyText": "I would avoid using terms like accident, a delete in theory could be intentional.\nbest we cover cases of intentional or accidental removal and refer to it as zookeeperDeletedCert and kafkaDeletedCert ?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#discussion_r435764816", "createdAt": "2020-06-05T08:21:29Z", "author": {"login": "samuel-hawker"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/ManualRollingUpdateST.java", "diffHunk": "@@ -144,6 +145,50 @@ void testManualTriggeringRollingUpdate() {\n         assertThat(received, is(sent));\n     }\n \n+    @Test\n+    void testRollingUpdateOnNextReconciliationAfterClusterCAKeyDel() {\n+        KafkaResource.kafkaPersistent(CLUSTER_NAME, 3, 3).done();\n+        String topicName = KafkaTopicUtils.generateRandomNameOfTopic();\n+        KafkaTopicResource.topic(CLUSTER_NAME, topicName, 2, 2).done();\n+\n+        KafkaUser user = KafkaUserResource.tlsUser(CLUSTER_NAME, USER_NAME).done();\n+\n+        KafkaClientsResource.deployKafkaClients(true, CLUSTER_NAME + \"-\" + Constants.KAFKA_CLIENTS, user).done();\n+        final String defaultKafkaClientsPodName =\n+            ResourceManager.kubeClient().listPodsByPrefixInName(CLUSTER_NAME + \"-\" + Constants.KAFKA_CLIENTS).get(0).getMetadata().getName();\n+\n+        InternalKafkaClient internalKafkaClient = new InternalKafkaClient.Builder()\n+            .withUsingPodName(defaultKafkaClientsPodName)\n+            .withTopicName(topicName)\n+            .withNamespaceName(NAMESPACE)\n+            .withClusterName(CLUSTER_NAME)\n+            .withMessageCount(MESSAGE_COUNT)\n+            .withKafkaUsername(USER_NAME)\n+            .build();\n+\n+        Map<String, String> kafkaPods = StatefulSetUtils.ssSnapshot(KafkaResources.kafkaStatefulSetName(CLUSTER_NAME));\n+        Map<String, String> zkPods = StatefulSetUtils.ssSnapshot(KafkaResources.zookeeperStatefulSetName(CLUSTER_NAME));\n+\n+        int sent = internalKafkaClient.sendMessagesTls();\n+        assertThat(sent, is(MESSAGE_COUNT));\n+\n+        String zkCrtBeforeAccident = kubeClient(NAMESPACE).getSecret(CLUSTER_NAME + \"-zookeeper-nodes\").getData().get(CLUSTER_NAME + \"-zookeeper-0.crt\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be6d950437190066f8e1c4c13273492d37e6da00"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "395c24447ae22907e0442372e9d74297c1332ad8", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/395c24447ae22907e0442372e9d74297c1332ad8", "committedDate": "2020-06-05T11:13:16Z", "message": "add scenario comment and change the names of vars\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MjgxMTYw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#pullrequestreview-425281160", "createdAt": "2020-06-05T13:06:47Z", "commit": {"oid": "395c24447ae22907e0442372e9d74297c1332ad8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1Mjg4MDQ3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#pullrequestreview-425288047", "createdAt": "2020-06-05T13:16:02Z", "commit": {"oid": "395c24447ae22907e0442372e9d74297c1332ad8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzoxNjowMlrOGfuBsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxMzoxNjowMlrOGfuBsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTkxMzEzNw==", "bodyText": "I would prefer more structural comment like:\n\nSetup Kafka persistent with 3 replicas\nCreate KafkaUser\nRun producer and consumer to see if cluster is working\nRemove cluster CA key\nKafka and ZK pods should roll, wiat until rolling update finish\nCheck that CA certificates were renewed\nTry consumer, producer and consume rmeessages again with new certificates", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#discussion_r435913137", "createdAt": "2020-06-05T13:16:02Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/ManualRollingUpdateST.java", "diffHunk": "@@ -144,6 +145,57 @@ void testManualTriggeringRollingUpdate() {\n         assertThat(received, is(sent));\n     }\n \n+    /**\n+     * Scenario of the test:\n+     * Firstly customer tries to send messages and checks if he is able to consume the messages,\n+     * then he delete the cluster CA key. Now should Kafka and Zookeper pods roll.\n+     * After the rolling update is done, the CA key/certificate should be renewed,\n+     * but should be different than the previous one. Then, again, he tries to\n+     * send messages with new generated cluster certificate.\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "395c24447ae22907e0442372e9d74297c1332ad8"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce5d530191be68b8b8155702a226939e3b320463", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ce5d530191be68b8b8155702a226939e3b320463", "committedDate": "2020-06-05T17:49:17Z", "message": "fixup! add scenario comment and change the names of vars\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b123bc4e50c6deea3cc4c0ba07498deaae585dcd", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b123bc4e50c6deea3cc4c0ba07498deaae585dcd", "committedDate": "2020-06-05T17:50:46Z", "message": "fixup! fixup! add scenario comment and change the names of vars\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTQyMzE3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3156#pullrequestreview-425542317", "createdAt": "2020-06-05T18:45:27Z", "commit": {"oid": "b123bc4e50c6deea3cc4c0ba07498deaae585dcd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1489, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}