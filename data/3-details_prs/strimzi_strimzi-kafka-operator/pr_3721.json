{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0ODgyNjEy", "number": 3721, "title": "Fix KR issues", "bodyText": "Signed-off-by: Stanislav Knot sknot@redhat.com\nType of change\n\nBugfix\n\nDescription\nFixes #3710\nAll credits to @tombentley\nSet timetouts to AdminClient;\nCheck whether the pod is in the CrashLoopBackOff\nChecklist\n\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md\n Supply screenshots for visual changes, such as Grafana dashboards", "createdAt": "2020-09-29T14:40:42Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721", "merged": true, "mergeCommit": {"oid": "30ff688f964e28408b3f90728b3a2571b367bff9"}, "closed": true, "closedAt": "2020-10-08T19:04:46Z", "author": {"login": "sknot-rh"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNpo6pgFqTQ5ODU4NTI2OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQf4tEgH2gAyNDk0ODgyNjEyOjdlMGY5OWU0MmUyZDg2YjhhZmFiMDY0ZWMzODI3ODRlZjc5OTdjY2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NTg1MjY5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#pullrequestreview-498585269", "createdAt": "2020-09-29T15:07:38Z", "commit": {"oid": "4a6d429b44c552c7c555567c6842dcac0f13c3fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNTowNzozOFrOHZyBHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNTowNzozOFrOHZyBHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc5NTkzNA==", "bodyText": "This might suffer from NPEs (especially .getState().getWaiting().getReason()) and also possibly IndexNotFoundException if, for whatever reason the container couldn't be found. Probably better to code it more carefully.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#discussion_r496795934", "createdAt": "2020-09-29T15:07:38Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaRoller.java", "diffHunk": "@@ -362,6 +362,10 @@ private void restartIfNecessary(int podId, RestartContext restartContext)\n         }\n     }\n \n+    private boolean isCrashlooping(Pod pod) {\n+        return \"CrashLoopBackOff\".equals(pod.getStatus().getContainerStatuses().stream().filter(containerStatus -> containerStatus.getName().equals(\"kafka\")).collect(Collectors.toList()).get(0).getState().getWaiting().getReason());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a6d429b44c552c7c555567c6842dcac0f13c3fe"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a8f11a459dd8dac8bc1b09acf857ff70b3bfd7f", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2a8f11a459dd8dac8bc1b09acf857ff70b3bfd7f", "committedDate": "2020-09-30T13:47:19Z", "message": "changes\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "70a75e19a061549843bd93bda939c897da90fb65", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/70a75e19a061549843bd93bda939c897da90fb65", "committedDate": "2020-09-30T14:54:39Z", "message": "changes\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNDQ4NzE0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#pullrequestreview-500448714", "createdAt": "2020-10-01T15:08:39Z", "commit": {"oid": "d48e7aa99288c9c783d4b831568f92a8a6dedeed"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNTowODozOVrOHbO-6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNTowODozOVrOHbO-6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODMxOTA4Mg==", "bodyText": "Out of interest why was it necessary to add it here? Just so that we don't spend ~7 minutes before we restart it?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#discussion_r498319082", "createdAt": "2020-10-01T15:08:39Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaRoller.java", "diffHunk": "@@ -318,38 +320,43 @@ private void restartIfNecessary(int podId, RestartContext restartContext)\n         }\n \n         try {\n-            RestartPlan restartPlan = restartPlan(podId, pod, restartContext);\n-            if (restartPlan.needsRestart || restartPlan.needsReconfig) {\n-                if (deferController(podId, restartContext)) {\n-                    log.debug(\"{}: Pod {} is controller and there are other pods to roll\", reconciliation, podId);\n-                    throw new ForceableProblem(\"Pod \" + podName(podId) + \" is currently the controller and there are other pods still to roll\");\n-                } else {\n-                    if (canRoll(podId, 60_000, TimeUnit.MILLISECONDS, false)) {\n-                        // Check for rollability before trying a dynamic update so that if the dynamic update fails we can go to a full restart\n-                        if (!maybeDynamicUpdateBrokerConfig(podId, restartPlan)) {\n-                            log.debug(\"{}: Pod {} can be rolled now\", reconciliation, podId);\n-                            restartAndAwaitReadiness(pod, operationTimeoutMs, TimeUnit.MILLISECONDS);\n+            if (isCrashlooping(pod)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d48e7aa99288c9c783d4b831568f92a8a6dedeed"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwOTE0NTk1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#pullrequestreview-500914595", "createdAt": "2020-10-02T07:33:07Z", "commit": {"oid": "d48e7aa99288c9c783d4b831568f92a8a6dedeed"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwOTgxNTUy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#pullrequestreview-500981552", "createdAt": "2020-10-02T09:18:07Z", "commit": {"oid": "d48e7aa99288c9c783d4b831568f92a8a6dedeed"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwOToxODowOFrOHbmzeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwOToyNjoxMFrOHbnC2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcwOTM3MA==", "bodyText": "What if the pod is not crash looping but creating or pending because of some other misconfiguration (missing volumes, badly configured resources, ...)? Does the rolling update work fine in that case even with this check looking just for crash-looping pods?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#discussion_r498709370", "createdAt": "2020-10-02T09:18:08Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaRoller.java", "diffHunk": "@@ -318,38 +320,43 @@ private void restartIfNecessary(int podId, RestartContext restartContext)\n         }\n \n         try {\n-            RestartPlan restartPlan = restartPlan(podId, pod, restartContext);\n-            if (restartPlan.needsRestart || restartPlan.needsReconfig) {\n-                if (deferController(podId, restartContext)) {\n-                    log.debug(\"{}: Pod {} is controller and there are other pods to roll\", reconciliation, podId);\n-                    throw new ForceableProblem(\"Pod \" + podName(podId) + \" is currently the controller and there are other pods still to roll\");\n-                } else {\n-                    if (canRoll(podId, 60_000, TimeUnit.MILLISECONDS, false)) {\n-                        // Check for rollability before trying a dynamic update so that if the dynamic update fails we can go to a full restart\n-                        if (!maybeDynamicUpdateBrokerConfig(podId, restartPlan)) {\n-                            log.debug(\"{}: Pod {} can be rolled now\", reconciliation, podId);\n-                            restartAndAwaitReadiness(pod, operationTimeoutMs, TimeUnit.MILLISECONDS);\n+            if (isCrashlooping(pod)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d48e7aa99288c9c783d4b831568f92a8a6dedeed"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcxMzMwNw==", "bodyText": "Does this actually work? Why should it decide to roll the pod? In your test the configuration is up to date so I would not expect it to roll the pod. I think the test should do the following:\n\nDeploy the Kafka cluster with UseParNewGC\nWait for it to crash loop\nRemove UseParNewGC from the config\nWait for it to roll\nWait for it to be ready\n\nWith the test as it is written right now, I would not expect the pods to be rolled at all since there was no change to anything. It should not roll them just because they are crashlooping ... but if it needs to roll them and they are crashlooping it should not wait for a successful connection tot he broker.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#discussion_r498713307", "createdAt": "2020-10-02T09:26:10Z", "author": {"login": "scholzj"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/KafkaRollerST.java", "diffHunk": "@@ -122,6 +125,30 @@ void testKafkaTopicRFLowerThanMinInSyncReplicas() {\n         assertThat(StatefulSetUtils.ssSnapshot(kafkaName), is(not(kafkaPods)));\n     }\n \n+    @Test\n+    void testKafkaPodCrashLooping() throws InterruptedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d48e7aa99288c9c783d4b831568f92a8a6dedeed"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7799f7189c58791fefcf6f1482c88401a7d6a604", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7799f7189c58791fefcf6f1482c88401a7d6a604", "committedDate": "2020-10-06T09:00:37Z", "message": "Fix KR issues\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2c30dfda4cd726c746715212d430b6e1098bb50", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c2c30dfda4cd726c746715212d430b6e1098bb50", "committedDate": "2020-10-06T09:00:37Z", "message": "carefully coding\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90a434a5fcfcf2d67d2ea784d68c4e02ed38fa12", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/90a434a5fcfcf2d67d2ea784d68c4e02ed38fa12", "committedDate": "2020-10-06T09:00:37Z", "message": "changes\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c37c0315b9c2926f458e516ae658b4302cc335c8", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c37c0315b9c2926f458e516ae658b4302cc335c8", "committedDate": "2020-10-06T09:00:37Z", "message": "changes\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9224dada82182b32cfce95a29cfa1541781656e4", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9224dada82182b32cfce95a29cfa1541781656e4", "committedDate": "2020-10-06T09:00:37Z", "message": "fixes\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c35a6cb858aa68e51db31cbf0c1db3d204e6c0b", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6c35a6cb858aa68e51db31cbf0c1db3d204e6c0b", "committedDate": "2020-10-06T09:00:10Z", "message": "fixes\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "9224dada82182b32cfce95a29cfa1541781656e4", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9224dada82182b32cfce95a29cfa1541781656e4", "committedDate": "2020-10-06T09:00:37Z", "message": "fixes\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1d0b8650ef166476a9a1dacf06e3b3bdf24dc32", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e1d0b8650ef166476a9a1dacf06e3b3bdf24dc32", "committedDate": "2020-10-07T11:14:03Z", "message": "another situations\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74012ed08e7de1a001e0e550ecfaac28dc43602c", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/74012ed08e7de1a001e0e550ecfaac28dc43602c", "committedDate": "2020-10-07T12:00:39Z", "message": "fix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzODE1MTU0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#pullrequestreview-503815154", "createdAt": "2020-10-07T12:17:18Z", "commit": {"oid": "e1d0b8650ef166476a9a1dacf06e3b3bdf24dc32"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTEyODE0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#pullrequestreview-504512814", "createdAt": "2020-10-08T07:50:37Z", "commit": {"oid": "74012ed08e7de1a001e0e550ecfaac28dc43602c"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNzo1MDozOFrOHeSGaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNzo1NzowMVrOHeSVmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxNTg4MQ==", "bodyText": "The body of this catch clause seems to be identical to the catch (ForceableProblem e) above. Can we have just a single catch with the union type catch (ForceableProblem | IllegalArgumentException e)", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#discussion_r501515881", "createdAt": "2020-10-08T07:50:38Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaRoller.java", "diffHunk": "@@ -359,7 +362,55 @@ private void restartIfNecessary(int podId, RestartContext restartContext)\n             } else {\n                 throw e;\n             }\n+        } catch (IllegalArgumentException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74012ed08e7de1a001e0e550ecfaac28dc43602c"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxNjY0NA==", "bodyText": "Breaking the long line at filter and collect means it fits on a screen and makes it easier to see the logic.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#discussion_r501516644", "createdAt": "2020-10-08T07:51:59Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaRoller.java", "diffHunk": "@@ -359,7 +362,55 @@ private void restartIfNecessary(int podId, RestartContext restartContext)\n             } else {\n                 throw e;\n             }\n+        } catch (IllegalArgumentException e) {\n+            if (isPodStuck(pod) || restartContext.backOff.done()) {\n+                if (canRoll(podId, 60_000, TimeUnit.MILLISECONDS, true)) {\n+                    log.warn(\"{}: Pod {} will be force-rolled, due to error: {}\", reconciliation, podName(podId), e.getCause() != null ? e.getCause().getMessage() : e.getMessage());\n+                    restartAndAwaitReadiness(pod, operationTimeoutMs, TimeUnit.MILLISECONDS);\n+                } else {\n+                    log.warn(\"{}: Pod {} can't be safely force-rolled; original error: \", reconciliation, podName(podId), e.getCause() != null ? e.getCause().getMessage() : e.getMessage());\n+                    throw e;\n+                }\n+            } else {\n+                throw e;\n+            }\n+        }\n+    }\n+\n+    private boolean isCrashLooping(Pod pod) {\n+        return podWaitingBecauseOfReason(pod, \"CrashLoopBackOff\");\n+    }\n+\n+    private boolean isImagePullBackOff(Pod pod) {\n+        return podWaitingBecauseOfReason(pod, \"ImagePullBackOff\");\n+    }\n+\n+    private boolean isCreating(Pod pod) {\n+        return podWaitingBecauseOfReason(pod, \"ContainerCreating\");\n+    }\n+\n+    private boolean podWaitingBecauseOfReason(Pod pod, String reason) {\n+        if (pod != null && pod.getStatus() != null) {\n+            List<ContainerStatus> kafkaContainerStatus = pod.getStatus().getContainerStatuses().stream().filter(containerStatus -> containerStatus.getName().equals(\"kafka\")).collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74012ed08e7de1a001e0e550ecfaac28dc43602c"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxNzI1Mg==", "bodyText": "If you're just interested in getting the first reason you should use findFirst, rather than collecting into a List. But is it correct that the container status we're looking for will always be the first in the list?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#discussion_r501517252", "createdAt": "2020-10-08T07:52:57Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaRoller.java", "diffHunk": "@@ -359,7 +362,55 @@ private void restartIfNecessary(int podId, RestartContext restartContext)\n             } else {\n                 throw e;\n             }\n+        } catch (IllegalArgumentException e) {\n+            if (isPodStuck(pod) || restartContext.backOff.done()) {\n+                if (canRoll(podId, 60_000, TimeUnit.MILLISECONDS, true)) {\n+                    log.warn(\"{}: Pod {} will be force-rolled, due to error: {}\", reconciliation, podName(podId), e.getCause() != null ? e.getCause().getMessage() : e.getMessage());\n+                    restartAndAwaitReadiness(pod, operationTimeoutMs, TimeUnit.MILLISECONDS);\n+                } else {\n+                    log.warn(\"{}: Pod {} can't be safely force-rolled; original error: \", reconciliation, podName(podId), e.getCause() != null ? e.getCause().getMessage() : e.getMessage());\n+                    throw e;\n+                }\n+            } else {\n+                throw e;\n+            }\n+        }\n+    }\n+\n+    private boolean isCrashLooping(Pod pod) {\n+        return podWaitingBecauseOfReason(pod, \"CrashLoopBackOff\");\n+    }\n+\n+    private boolean isImagePullBackOff(Pod pod) {\n+        return podWaitingBecauseOfReason(pod, \"ImagePullBackOff\");\n+    }\n+\n+    private boolean isCreating(Pod pod) {\n+        return podWaitingBecauseOfReason(pod, \"ContainerCreating\");\n+    }\n+\n+    private boolean podWaitingBecauseOfReason(Pod pod, String reason) {\n+        if (pod != null && pod.getStatus() != null) {\n+            List<ContainerStatus> kafkaContainerStatus = pod.getStatus().getContainerStatuses().stream().filter(containerStatus -> containerStatus.getName().equals(\"kafka\")).collect(Collectors.toList());\n+            if (kafkaContainerStatus.size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74012ed08e7de1a001e0e550ecfaac28dc43602c"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUxOTc2OQ==", "bodyText": "In the worst case this will have to traverse the list of container statues 3 times. It would have been better to write a function private boolean podWaitingBecauseAnyOfReasons(Pod pod, Set<String> reasons) which would allow you to traverse the list once. Not that this is going to be hot code, but choosing appropriate algorithms is important.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3721#discussion_r501519769", "createdAt": "2020-10-08T07:57:01Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaRoller.java", "diffHunk": "@@ -359,7 +362,55 @@ private void restartIfNecessary(int podId, RestartContext restartContext)\n             } else {\n                 throw e;\n             }\n+        } catch (IllegalArgumentException e) {\n+            if (isPodStuck(pod) || restartContext.backOff.done()) {\n+                if (canRoll(podId, 60_000, TimeUnit.MILLISECONDS, true)) {\n+                    log.warn(\"{}: Pod {} will be force-rolled, due to error: {}\", reconciliation, podName(podId), e.getCause() != null ? e.getCause().getMessage() : e.getMessage());\n+                    restartAndAwaitReadiness(pod, operationTimeoutMs, TimeUnit.MILLISECONDS);\n+                } else {\n+                    log.warn(\"{}: Pod {} can't be safely force-rolled; original error: \", reconciliation, podName(podId), e.getCause() != null ? e.getCause().getMessage() : e.getMessage());\n+                    throw e;\n+                }\n+            } else {\n+                throw e;\n+            }\n+        }\n+    }\n+\n+    private boolean isCrashLooping(Pod pod) {\n+        return podWaitingBecauseOfReason(pod, \"CrashLoopBackOff\");\n+    }\n+\n+    private boolean isImagePullBackOff(Pod pod) {\n+        return podWaitingBecauseOfReason(pod, \"ImagePullBackOff\");\n+    }\n+\n+    private boolean isCreating(Pod pod) {\n+        return podWaitingBecauseOfReason(pod, \"ContainerCreating\");\n+    }\n+\n+    private boolean podWaitingBecauseOfReason(Pod pod, String reason) {\n+        if (pod != null && pod.getStatus() != null) {\n+            List<ContainerStatus> kafkaContainerStatus = pod.getStatus().getContainerStatuses().stream().filter(containerStatus -> containerStatus.getName().equals(\"kafka\")).collect(Collectors.toList());\n+            if (kafkaContainerStatus.size() > 0) {\n+                ContainerStateWaiting waiting = kafkaContainerStatus.get(0).getState().getWaiting();\n+                if (waiting != null) {\n+                    return reason.equals(waiting.getReason());\n+                }\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private boolean isPending(Pod pod) {\n+        if (pod != null && pod.getStatus() != null && \"Pending\".equals(pod.getStatus().getPhase())) {\n+            return true;\n         }\n+        return false;\n+    }\n+\n+    private boolean isPodStuck(Pod pod) {\n+        return isPending(pod) || isCrashLooping(pod) || isImagePullBackOff(pod) || isCreating(pod);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74012ed08e7de1a001e0e550ecfaac28dc43602c"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eef513c5799ac59f628a2bb9d02073a4a520d650", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/eef513c5799ac59f628a2bb9d02073a4a520d650", "committedDate": "2020-10-08T09:00:27Z", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e0f99e42e2d86b8afab064ec382784ef7997ccc", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7e0f99e42e2d86b8afab064ec382784ef7997ccc", "committedDate": "2020-10-08T11:29:01Z", "message": "list to opt\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1006, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}