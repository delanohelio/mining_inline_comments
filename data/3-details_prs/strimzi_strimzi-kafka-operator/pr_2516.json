{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNDM0Mjk1", "number": 2516, "title": "Fix the kafka rolling when the reconciliation failed", "bodyText": "Signed-off-by: Stanislav Knot sknot@redhat.com\nType of change\n\nBugfix\n\nDescription\nWe have a kafka configuration placed in the ConfigMap and when this map changes, the reconciliation is started. But it may happen the reconciliation fails and the state of changed ConfigMap is lost. It is better to watch whether pods have the same value in annotation as the STS template has.\nChecklist\nPlease go through this checklist and make sure all applicable tasks have been done\n\n Update/write design documentation in ./design\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md", "createdAt": "2020-02-07T14:19:22Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2516", "merged": true, "mergeCommit": {"oid": "32bc282bdf40212518e87737a0f2eb2aa8e5eb27"}, "closed": true, "closedAt": "2020-02-15T06:22:31Z", "author": {"login": "sknot-rh"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcC5BXugFqTM1NTc1NjY4MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcETac2AFqTM1OTExODk5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NzU2Njgw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2516#pullrequestreview-355756680", "createdAt": "2020-02-10T08:33:22Z", "commit": {"oid": "cb42ff926c0322a207015c528686a1f6ab58df8e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwODozMzoyM1rOFndcAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwODozNDo1OVrOFndeRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkyMTA4OA==", "bodyText": "I think kafkaAncillaryCmGeneration is a more natural ordering of these terms. zkAncillaryCmGeneration too.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2516#discussion_r376921088", "createdAt": "2020-02-10T08:33:23Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -387,7 +387,8 @@ ReconciliationState createReconciliationState(Reconciliation reconciliation, Kaf\n         private Set<String> kafkaExternalAdvertisedHostnames = new LinkedHashSet<>();\n         private Set<String> kafkaExternalAdvertisedPorts = new LinkedHashSet<>();\n         private Map<Integer, Set<String>> kafkaExternalDnsNames = new HashMap<>();\n-        private boolean kafkaAncillaryCmChange;\n+        private Long ancillaryZkCmGeneration = 0L;\n+        private Long ancillaryKafkaCmGeneration = 0L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb42ff926c0322a207015c528686a1f6ab58df8e"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkyMTY2OQ==", "bodyText": "In theory a NPE might be possible here if the ancillaryCmGeneration is null. Probably best to do the roll if it's null.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2516#discussion_r376921669", "createdAt": "2020-02-10T08:34:59Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -2920,7 +2926,7 @@ private boolean isPodToRestart(StatefulSet sts, Pod pod, boolean isAncillaryCmCh\n                         reasons.add(\"Pod has old \" + ca + \" certificate generation\");\n                     }\n                 }\n-                if (isAncillaryCmChange) {\n+                if (cmAnno != ancillaryCmGeneration) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb42ff926c0322a207015c528686a1f6ab58df8e"}, "originalPosition": 124}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f11bf09e412a2602619e460c5c8e61261c1da88f", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f11bf09e412a2602619e460c5c8e61261c1da88f", "committedDate": "2020-02-13T09:08:26Z", "message": "initial values\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "dc0f9f71129c5b98136889024d41476aeb24492d", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/dc0f9f71129c5b98136889024d41476aeb24492d", "committedDate": "2020-02-13T09:33:13Z", "message": "initial values\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ad54df0ae5abea72962d73a9d3f0fa40b859866", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3ad54df0ae5abea72962d73a9d3f0fa40b859866", "committedDate": "2020-02-13T11:52:15Z", "message": "Fix the kafka rolling when the reconciliation failed\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f4ce8eef941c194825933f326599e4c47eebc98", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9f4ce8eef941c194825933f326599e4c47eebc98", "committedDate": "2020-02-13T11:52:15Z", "message": "maybefix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05bc21275e696571851ad1907dc4cc7bde13218d", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/05bc21275e696571851ad1907dc4cc7bde13218d", "committedDate": "2020-02-13T11:52:15Z", "message": "maybefix2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d24148fa86c936c3f7dfb646a41898b908dadb6b", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d24148fa86c936c3f7dfb646a41898b908dadb6b", "committedDate": "2020-02-13T11:52:15Z", "message": "maybefix3\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "755559c5df557c2a09761f33d98cc78b87f6753b", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/755559c5df557c2a09761f33d98cc78b87f6753b", "committedDate": "2020-02-13T11:52:15Z", "message": "maybefix4\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b521b58b1b202622603a86929748f036e1fc39fd", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b521b58b1b202622603a86929748f036e1fc39fd", "committedDate": "2020-02-13T11:52:15Z", "message": "maybefix5\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94495cb5241385adb8eec3bcbfacc0ce5bb280e2", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/94495cb5241385adb8eec3bcbfacc0ce5bb280e2", "committedDate": "2020-02-13T11:52:15Z", "message": "initial values\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dc0f9f71129c5b98136889024d41476aeb24492d", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/dc0f9f71129c5b98136889024d41476aeb24492d", "committedDate": "2020-02-13T09:33:13Z", "message": "initial values\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "a6a0cfc4d6188c50ec6e89e0bdb8837c858c085d", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a6a0cfc4d6188c50ec6e89e0bdb8837c858c085d", "committedDate": "2020-02-13T11:53:03Z", "message": "reenable testGcLoggingSetDisabled\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2e091982abfd2aa5d1068a47ccc5e3a219c164d", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e2e091982abfd2aa5d1068a47ccc5e3a219c164d", "committedDate": "2020-02-13T12:17:21Z", "message": "reenable testGcLoggingSetDisabled\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a6a0cfc4d6188c50ec6e89e0bdb8837c858c085d", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a6a0cfc4d6188c50ec6e89e0bdb8837c858c085d", "committedDate": "2020-02-13T11:53:03Z", "message": "reenable testGcLoggingSetDisabled\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "e2e091982abfd2aa5d1068a47ccc5e3a219c164d", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e2e091982abfd2aa5d1068a47ccc5e3a219c164d", "committedDate": "2020-02-13T12:17:21Z", "message": "reenable testGcLoggingSetDisabled\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4be5e1ed9b089344c5b618f00ec8910c395c496d", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4be5e1ed9b089344c5b618f00ec8910c395c496d", "committedDate": "2020-02-13T15:06:43Z", "message": "redisabling test\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NjE1NDM5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2516#pullrequestreview-358615439", "createdAt": "2020-02-13T23:05:41Z", "commit": {"oid": "4be5e1ed9b089344c5b618f00ec8910c395c496d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MTE4OTkw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2516#pullrequestreview-359118990", "createdAt": "2020-02-14T17:58:53Z", "commit": {"oid": "4be5e1ed9b089344c5b618f00ec8910c395c496d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1694, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}