{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5MTQwNDM1", "number": 3672, "title": "More fixes for dynamic logging diff", "bodyText": "Type of change\n\nBugfix\n\nDescription\nPrevious fixes to dynamic logging left a few problems:\n\nSome system tests were failing due to the lack of the proper handling of variable expansion and variable definitions in (log4j) logging configuration.\nWe realised that we also broke backwards compatibility due to removing variable declarations from template log4j.properties files.\nFixed a buggy KafkaRollerTest that kept hanging\nAdded support for automatically adding an appender to log4j.rootLogger declaration without one\nAdded same fixes also to kafkaconnect, and mirrormaker2 logging config, where before the logger levels were all first set to OFF and then they didn't inherit the proper level, but now the default root logger level from the log4j file is used\n\nChecklist\nPlease go through this checklist and make sure all applicable tasks have been done\n\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md\n Supply screenshots for visual changes, such as Grafana dashboards", "createdAt": "2020-09-18T07:45:26Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3672", "merged": true, "mergeCommit": {"oid": "01636fe8ede0a366b8cf10e677d21005f31e4f9e"}, "closed": true, "closedAt": "2020-10-07T21:32:33Z", "author": {"login": "mstruk"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKAFzagH2gAyNDg5MTQwNDM1Ojc1ZmExNTk1YWI0MmU2ODQ5MDU0ZDMyYTg1NTlkOTY5M2FjODdhM2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQOYT_gH2gAyNDg5MTQwNDM1OmM5NmQzNzAxMDI3NTY1ZGM1OWRhNmY4NWM5YTI4MTZmMDRlN2E1MTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "75fa1595ab42e6849054d32a8559d9693ac87a3a", "author": {"user": {"login": "mstruk", "name": "Marko Strukelj"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/75fa1595ab42e6849054d32a8559d9693ac87a3a", "committedDate": "2020-09-18T07:02:49Z", "message": "Travis failures - added var definitions, value interpolation support to interpreting log4j.properties\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c35f11b09364fc7aa4c14ac07030257f61b335e7", "author": {"user": {"login": "mstruk", "name": "Marko Strukelj"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c35f11b09364fc7aa4c14ac07030257f61b335e7", "committedDate": "2020-09-18T07:02:49Z", "message": "Additional fixes for dynamic logging configuration\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55324fce3181012c2a3b5d21457df7477666eadd", "author": {"user": {"login": "mstruk", "name": "Marko Strukelj"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/55324fce3181012c2a3b5d21457df7477666eadd", "committedDate": "2020-09-18T11:39:57Z", "message": "Try fix KafkaRollerTest\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyMjk5NzYx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3672#pullrequestreview-492299761", "createdAt": "2020-09-21T06:15:48Z", "commit": {"oid": "55324fce3181012c2a3b5d21457df7477666eadd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwNjoxNTo0OFrOHVBx4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwNjoxNzo0M1rOHVB0KA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgxMTI5OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                int p = line.indexOf(\"=\", 13);\n          \n          \n            \n                                int p = line.indexOf(\"=\", \"log4j.logger.\".length());", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3672#discussion_r491811298", "createdAt": "2020-09-21T06:15:48Z", "author": {"login": "sknot-rh"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaBrokerLoggingConfigurationDiff.java", "diffHunk": "@@ -96,6 +95,80 @@ public int getDiffSize() {\n         return updatedCE;\n     }\n \n+    private static Map<String, String> readLog4jConfig(String config) {\n+\n+        Map<String, String> parsed = new LinkedHashMap<>();\n+        Map<String, String> env = new HashMap<>();\n+        BufferedReader reader = new BufferedReader(new StringReader(config));\n+        String line;\n+        try {\n+            while ((line = reader.readLine()) != null) {\n+                // skip comments\n+                if (line.startsWith(\"#\")) continue;\n+\n+                // ignore empty lines\n+                line = line.trim();\n+                if (line.length() == 0) continue;\n+\n+                // everything that does not start with 'log4j.' is a variable definition\n+                if (!line.startsWith(\"log4j.\")) {\n+                    int p = line.indexOf(\"=\");\n+                    if (p >= 0) {\n+                        env.put(line.substring(0, p).trim(), line.substring(p + 1).trim());\n+                    } else {\n+                        env.put(line.trim(), \"\");\n+                    }\n+                    log.debug(\"Treating the line as ENV var declaration: {}\", line);\n+                    continue;\n+                }\n+\n+                // we ignore appenders (log4j.appender.*)\n+                // and only handle loggers (log4j.logger.*)\n+                if (line.startsWith(\"log4j.logger.\")) {\n+                    int p = line.indexOf(\"=\", 13);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55324fce3181012c2a3b5d21457df7477666eadd"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgxMTg4MA==", "bodyText": "What about spaces before =?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3672#discussion_r491811880", "createdAt": "2020-09-21T06:17:43Z", "author": {"login": "sknot-rh"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaBrokerLoggingConfigurationDiff.java", "diffHunk": "@@ -96,6 +95,80 @@ public int getDiffSize() {\n         return updatedCE;\n     }\n \n+    private static Map<String, String> readLog4jConfig(String config) {\n+\n+        Map<String, String> parsed = new LinkedHashMap<>();\n+        Map<String, String> env = new HashMap<>();\n+        BufferedReader reader = new BufferedReader(new StringReader(config));\n+        String line;\n+        try {\n+            while ((line = reader.readLine()) != null) {\n+                // skip comments\n+                if (line.startsWith(\"#\")) continue;\n+\n+                // ignore empty lines\n+                line = line.trim();\n+                if (line.length() == 0) continue;\n+\n+                // everything that does not start with 'log4j.' is a variable definition\n+                if (!line.startsWith(\"log4j.\")) {\n+                    int p = line.indexOf(\"=\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55324fce3181012c2a3b5d21457df7477666eadd"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4ce75cc0bc889b714e98d26008c7284ffd26f40", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f4ce75cc0bc889b714e98d26008c7284ffd26f40", "committedDate": "2020-09-22T11:29:00Z", "message": "patch appender\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c324c5eb2a6da7d285e6de5d81073224ea4a23a2", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c324c5eb2a6da7d285e6de5d81073224ea4a23a2", "committedDate": "2020-09-22T12:26:17Z", "message": "var expansion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afefd88c6c74dcc07ff5984d3d0327fa08f2d479", "author": {"user": {"login": "mstruk", "name": "Marko Strukelj"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/afefd88c6c74dcc07ff5984d3d0327fa08f2d479", "committedDate": "2020-09-23T19:26:44Z", "message": "Merge pull request #2 from stanlyDoge/fix-logging-diff\n\nAutomatically add the appender to root logger, if only the level is set in the inline / external logging config."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bad05569d19c30c1c9b00c83d79f81f1bca2f5cc", "author": {"user": {"login": "mstruk", "name": "Marko Strukelj"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/bad05569d19c30c1c9b00c83d79f81f1bca2f5cc", "committedDate": "2020-09-23T21:27:58Z", "message": "Fix NPE\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4ce1f6da2d43c63047fa96a63cd75b58652003c", "author": {"user": {"login": "mstruk", "name": "Marko Strukelj"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b4ce1f6da2d43c63047fa96a63cd75b58652003c", "committedDate": "2020-09-23T21:40:06Z", "message": "Improve readability\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MjQ5Mjk3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3672#pullrequestreview-495249297", "createdAt": "2020-09-24T06:18:47Z", "commit": {"oid": "55324fce3181012c2a3b5d21457df7477666eadd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNjoxODo0N1rOHXLPMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQwNjoxODo0N1rOHXLPMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDA2MzQwOA==", "bodyText": "Likewise, why we are using single letter variable here? The rest of the Strimzi codebase is pretty consistently using descriptive names for variables like these.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3672#discussion_r494063408", "createdAt": "2020-09-24T06:18:47Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaBrokerLoggingConfigurationDiff.java", "diffHunk": "@@ -96,6 +95,80 @@ public int getDiffSize() {\n         return updatedCE;\n     }\n \n+    private static Map<String, String> readLog4jConfig(String config) {\n+\n+        Map<String, String> parsed = new LinkedHashMap<>();\n+        Map<String, String> env = new HashMap<>();\n+        BufferedReader reader = new BufferedReader(new StringReader(config));\n+        String line;\n+        try {\n+            while ((line = reader.readLine()) != null) {\n+                // skip comments\n+                if (line.startsWith(\"#\")) continue;\n+\n+                // ignore empty lines\n+                line = line.trim();\n+                if (line.length() == 0) continue;\n+\n+                // everything that does not start with 'log4j.' is a variable definition\n+                if (!line.startsWith(\"log4j.\")) {\n+                    int p = line.indexOf(\"=\");\n+                    if (p >= 0) {\n+                        env.put(line.substring(0, p).trim(), line.substring(p + 1).trim());\n+                    } else {\n+                        env.put(line.trim(), \"\");\n+                    }\n+                    log.debug(\"Treating the line as ENV var declaration: {}\", line);\n+                    continue;\n+                }\n+\n+                // we ignore appenders (log4j.appender.*)\n+                // and only handle loggers (log4j.logger.*)\n+                if (line.startsWith(\"log4j.logger.\")) {\n+                    int p = line.indexOf(\"=\", 13);\n+                    if (p == -1) {\n+                        log.debug(\"Skipping log4j.logger.* declaration without level: {}\", line);\n+                        continue;\n+                    }\n+                    String name = line.substring(13, p).trim();\n+                    String value = line.substring(p + 1).trim();\n+\n+                    value = expandVars(value, env);\n+                    parsed.put(name, value);\n+\n+                } else if (line.startsWith(\"log4j.rootLogger=\")) {\n+                    parsed.put(\"root\", expandVars(line.substring(17).trim(), env));\n+\n+                } else {\n+                    log.debug(\"Skipping log4j line: {}\", line);\n+                }\n+            }\n+        } catch (Exception e) {\n+            log.error(\"Failed to parse logging configuration: \" + config, e);\n+            return Collections.emptyMap();\n+        }\n+        return parsed;\n+    }\n+\n+    private static String expandVars(String value, Map<String, String> env) {\n+        StringBuilder sb = new StringBuilder();\n+        int e = -1;\n+        int b;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55324fce3181012c2a3b5d21457df7477666eadd"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae5b1850c66748c09d0ebef9c665a92645f47561", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ae5b1850c66748c09d0ebef9c665a92645f47561", "committedDate": "2020-09-25T08:58:45Z", "message": "use default value ad default value\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db6143ee0300d13e7bd10db1d7ea96b1afaf1e4a", "author": {"user": {"login": "mstruk", "name": "Marko Strukelj"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/db6143ee0300d13e7bd10db1d7ea96b1afaf1e4a", "committedDate": "2020-09-25T13:48:08Z", "message": "Merge pull request #3 from stanlyDoge/fix-logging-diff\n\nconnect logging - use default value as default value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b690978e816ba61aaa1f4127b8f0980d5efb0695", "author": {"user": {"login": "mstruk", "name": "Marko Strukelj"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b690978e816ba61aaa1f4127b8f0980d5efb0695", "committedDate": "2020-09-25T14:35:00Z", "message": "Rename single-letter vars and remove some leftover logging\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb63089041a1e694248be208abbe01c3d2849f7b", "author": {"user": {"login": "mstruk", "name": "Marko Strukelj"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/cb63089041a1e694248be208abbe01c3d2849f7b", "committedDate": "2020-09-27T18:20:49Z", "message": "Fix the KafkaConnectApiTest - loggers are no longer turned off\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxODA5MTU5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3672#pullrequestreview-501809159", "createdAt": "2020-10-05T08:04:03Z", "commit": {"oid": "55324fce3181012c2a3b5d21457df7477666eadd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODowNDowM1rOHcRwIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODowNDowM1rOHcRwIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQxMzAyNg==", "bodyText": "Can we have a better variable name than p?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3672#discussion_r499413026", "createdAt": "2020-10-05T08:04:03Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/KafkaBrokerLoggingConfigurationDiff.java", "diffHunk": "@@ -96,6 +95,80 @@ public int getDiffSize() {\n         return updatedCE;\n     }\n \n+    private static Map<String, String> readLog4jConfig(String config) {\n+\n+        Map<String, String> parsed = new LinkedHashMap<>();\n+        Map<String, String> env = new HashMap<>();\n+        BufferedReader reader = new BufferedReader(new StringReader(config));\n+        String line;\n+        try {\n+            while ((line = reader.readLine()) != null) {\n+                // skip comments\n+                if (line.startsWith(\"#\")) continue;\n+\n+                // ignore empty lines\n+                line = line.trim();\n+                if (line.length() == 0) continue;\n+\n+                // everything that does not start with 'log4j.' is a variable definition\n+                if (!line.startsWith(\"log4j.\")) {\n+                    int p = line.indexOf(\"=\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTgxMTg4MA=="}, "originalCommit": {"oid": "55324fce3181012c2a3b5d21457df7477666eadd"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxODc2MzAx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3672#pullrequestreview-501876301", "createdAt": "2020-10-05T09:29:31Z", "commit": {"oid": "cb63089041a1e694248be208abbe01c3d2849f7b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17bea2542615c984a5334d77bb369141e5d36afc", "author": {"user": {"login": "mstruk", "name": "Marko Strukelj"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/17bea2542615c984a5334d77bb369141e5d36afc", "committedDate": "2020-10-05T13:26:34Z", "message": "Fix single-char local variable names\n\nSigned-off-by: Marko Strukelj <marko.strukelj@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7203031604f293b79cca0bbb01ede1645843ec63", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/7203031604f293b79cca0bbb01ede1645843ec63", "committedDate": "2020-10-07T13:25:08Z", "message": "fix external cm logging\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f6d6d154549445d1cc5d5d13ef09904338c7398", "author": {"user": {"login": "mstruk", "name": "Marko Strukelj"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4f6d6d154549445d1cc5d5d13ef09904338c7398", "committedDate": "2020-10-07T13:30:03Z", "message": "Merge pull request #4 from stanlyDoge/fix-logging-diff\n\nfix external cm logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c96d3701027565dc59da6f85c9a2816f04e7a519", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c96d3701027565dc59da6f85c9a2816f04e7a519", "committedDate": "2020-10-07T15:05:15Z", "message": "Remove unused line\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 995, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}