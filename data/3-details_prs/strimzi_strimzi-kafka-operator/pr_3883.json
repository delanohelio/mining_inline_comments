{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwODMyMzE2", "number": 3883, "title": "Topic Operator metrics", "bodyText": "Signed-off-by: Stanislav Knot sknot@redhat.com\nType of change\n\nBugfix\n\nDescription\nWe were wrongly watching reconciliations TO->Kafka. We should watch k8s->TO, what is done in this PR.\n\nPlease anybody from QE check the modified test.\nFixes #3659\nChecklist\nPlease go through this checklist and make sure all applicable tasks have been done\n\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md\n Supply screenshots for visual changes, such as Grafana dashboards", "createdAt": "2020-10-27T15:15:36Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3883", "merged": true, "mergeCommit": {"oid": "42e53819fc1b6c414c6d0d85a8f781b13e5801a6"}, "closed": true, "closedAt": "2020-11-04T19:32:40Z", "author": {"login": "sknot-rh"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWqflkgH2gAyNTEwODMyMzE2OjFiYTQ2OTQ4NDQ1ZjQzYzM0ODY4N2Q5N2VjZTMwZTE4YWY0YjNiYWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZPCFuAFqTUyMzQzOTc5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ba46948445f43c348687d97ece30e18af4b3bae", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1ba46948445f43c348687d97ece30e18af4b3bae", "committedDate": "2020-10-27T15:14:05Z", "message": "Topic Operator metrics\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faee4f8a39dfcee9b0ea12862212c1dbb1b2860a", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/faee4f8a39dfcee9b0ea12862212c1dbb1b2860a", "committedDate": "2020-11-02T08:10:28Z", "message": "fix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDM4MjYw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3883#pullrequestreview-522438260", "createdAt": "2020-11-03T12:16:05Z", "commit": {"oid": "faee4f8a39dfcee9b0ea12862212c1dbb1b2860a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMjcxMjA5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3883#pullrequestreview-523271209", "createdAt": "2020-11-04T11:24:07Z", "commit": {"oid": "faee4f8a39dfcee9b0ea12862212c1dbb1b2860a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMToyNDowOFrOHtT-sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMToyNjoyOFrOHtUDzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3NTMxNQ==", "bodyText": "Basing it on names seems fragile. I think it would be better to have a constructor parameter for whether a particular Reconciliation should count towards metrics.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3883#discussion_r517275315", "createdAt": "2020-11-04T11:24:08Z", "author": {"login": "tombentley"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -914,18 +921,31 @@ public void onMaxAttemptsExceeded(MaxAttemptsExceededException e) {\n \n         public Reconciliation(String name) {\n             this.name = name;\n-            this.reconciliationTimerSample = Timer.start(metrics.meterRegistry());\n-            reconciliationsCounter.increment();\n+            if (isEventWatched()) {\n+                LOGGER.debug(\"Metric {} triggered\", this.name);\n+                this.reconciliationTimerSample = Timer.start(metrics.meterRegistry());\n+                reconciliationsCounter.increment();\n+            }\n         }\n \n         public void failed() {\n-            reconciliationTimerSample.stop(reconciliationsTimer);\n-            failedReconciliationsCounter.increment();\n+            if (isEventWatched()) {\n+                LOGGER.debug(\"failed reconciliation {}\", name);\n+                reconciliationTimerSample.stop(reconciliationsTimer);\n+                failedReconciliationsCounter.increment();\n+            }\n         }\n \n         public void succeeded() {\n-            reconciliationTimerSample.stop(reconciliationsTimer);\n-            successfulReconciliationsCounter.increment();\n+            if (isEventWatched()) {\n+                LOGGER.debug(\"succeeded reconciliation {}\", name);\n+                reconciliationTimerSample.stop(reconciliationsTimer);\n+                successfulReconciliationsCounter.increment();\n+            }\n+        }\n+\n+        private boolean isEventWatched() {\n+            return !\"onResourceEvent\".equals(name) && !\"reconcile-from-kafka\".equals(name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faee4f8a39dfcee9b0ea12862212c1dbb1b2860a"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3NjYyMQ==", "bodyText": "Why does this get counted as a (successful) reconciliation, but when there are topics each one counts as successful? What are we counting? The number of times the timer goes off or the number of time we actually deal with a topic?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3883#discussion_r517276621", "createdAt": "2020-11-04T11:26:28Z", "author": {"login": "tombentley"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -1229,6 +1249,10 @@ public void setKafkaTopics(List<KafkaTopic> ktList) {\n         }).compose(reconcileState -> {\n             List<Future> futs = new ArrayList<>();\n             topicCounter.set(reconcileState.ktList.size());\n+            if (reconcileState.ktList.size() == 0) {\n+                reconciliationsCounter.increment();\n+                successfulReconciliationsCounter.increment();\n+            }\n             for (KafkaTopic kt : reconcileState.ktList) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faee4f8a39dfcee9b0ea12862212c1dbb1b2860a"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01a9f41b1a3bc03ccf4cc4d4643f1809442c5ef4", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/01a9f41b1a3bc03ccf4cc4d4643f1809442c5ef4", "committedDate": "2020-11-04T13:05:10Z", "message": "fix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ddaaf5f1daa6400bb01b1bf2973609b88e0ee624", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ddaaf5f1daa6400bb01b1bf2973609b88e0ee624", "committedDate": "2020-11-04T12:03:33Z", "message": "fix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "01a9f41b1a3bc03ccf4cc4d4643f1809442c5ef4", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/01a9f41b1a3bc03ccf4cc4d4643f1809442c5ef4", "committedDate": "2020-11-04T13:05:10Z", "message": "fix\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDMzODA1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3883#pullrequestreview-523433805", "createdAt": "2020-11-04T14:50:13Z", "commit": {"oid": "01a9f41b1a3bc03ccf4cc4d4643f1809442c5ef4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNDM5Nzk0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3883#pullrequestreview-523439794", "createdAt": "2020-11-04T14:56:12Z", "commit": {"oid": "01a9f41b1a3bc03ccf4cc4d4643f1809442c5ef4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 861, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}