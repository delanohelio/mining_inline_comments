{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NTE4Njk2", "number": 3351, "title": "Using PodMonitor for scraping Kafka related metrics", "bodyText": "Type of change\n\nBugfix\n\nDescription\nAfter some analysis on the current Prometheus configurations (ServiceMonitor, PodMonitor, and additional ones) I have got the following results:\n\nthe kubernetes_pods job (from the additional configuration) is not used\nthe current ServiceMonitor is actually not working so we are not getting Kafka/ZooKeeper related metrics from it. When used in Prometheus, there are no endpoints for it in the Targets view (remember that a ServiceMonitor is translated by the Prometheus operator in a Kubernetes service discovery configuration with endpoints role).\nWe are getting the Kafka/ZooKeeper metrics from the kubernetes_service job (from the additional configuration) which was what we had before the Prometheus operator usage but since using that operator we should have used the ServiceMonitor (which is not working properly, see above).\n\nSaid that, this PR is about:\n\nremoving useless kubernetes_pods and kubernetes_service jobs from the additional configuration. When using Prometheus operator, the additional configuration should be really used just for Kubernetes service discovery roles like node while using PodMonitor and ServiceMonitor for other stuff). It means that the additional configuration should just have cAdvisor job (used for getting memory information from running containers) and the Kubelet one (for getting information about volume stats, storage, ...).\nusing PodMonitor instead of ServiceMonitor for scraping metrics for Kafka/ZooKeeper\n\nChecklist\nPlease go through this checklist and make sure all applicable tasks have been done\n\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally", "createdAt": "2020-07-21T13:49:39Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3351", "merged": true, "mergeCommit": {"oid": "234efbce30ab547b1d2a5fed1978f04b343cdaef"}, "closed": true, "closedAt": "2020-07-22T16:41:59Z", "author": {"login": "ppatierno"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3GZtrAH2gAyNDU0NTE4Njk2OmJmOGVmZWRhNzRmYTUzNzJmZDQ5YWE5MWNiZDllNjc0ODg4NzA1ZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3auodgFqTQ1MzMwOTE2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bf8efeda74fa5372fd49aa91cbd9e674888705de", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/bf8efeda74fa5372fd49aa91cbd9e674888705de", "committedDate": "2020-07-21T13:39:26Z", "message": "Removed some useless additional scrape configurations\nFixed usage of ServiceMonitor for scraping Kafka metrics\nFixed Grafana dashboards due to above changes\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNDg1MTc5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3351#pullrequestreview-452485179", "createdAt": "2020-07-21T13:58:33Z", "commit": {"oid": "bf8efeda74fa5372fd49aa91cbd9e674888705de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMzo1ODozM1rOG05T3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMzo1ODozM1rOG05T3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODExODExMA==", "bodyText": "I think this is confusing - the metrics do not come from the service but from the pod. Is there any reason we don't use PodMonitors to scrape all pods? Why do we use ServiceMonitor somewhere and PodMonitor elsewhere?\nIn a sense this also impacts backwards compatibility.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3351#discussion_r458118110", "createdAt": "2020-07-21T13:58:33Z", "author": {"login": "scholzj"}, "path": "examples/metrics/grafana-dashboards/strimzi-kafka.json", "diffHunk": "@@ -1027,7 +1027,7 @@\n       \"steppedLine\": false,\n       \"targets\": [\n         {\n-          \"expr\": \"sum(jvm_memory_bytes_used{namespace=\\\"$kubernetes_namespace\\\",kubernetes_pod_name=~\\\"$strimzi_cluster_name-$kafka_broker\\\",strimzi_io_name=\\\"$strimzi_cluster_name-kafka\\\"}) by (kubernetes_pod_name)\",\n+          \"expr\": \"sum(jvm_memory_bytes_used{namespace=\\\"$kubernetes_namespace\\\",kubernetes_pod_name=~\\\"$strimzi_cluster_name-$kafka_broker\\\",strimzi_io_name=\\\"$strimzi_cluster_name-kafka-bootstrap\\\"}) by (kubernetes_pod_name)\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf8efeda74fa5372fd49aa91cbd9e674888705de"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNTMyMTcz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3351#pullrequestreview-452532173", "createdAt": "2020-07-21T14:45:02Z", "commit": {"oid": "bf8efeda74fa5372fd49aa91cbd9e674888705de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNDo0NTowMlrOG07fcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNDo0NTowMlrOG07fcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODE1Mzg0MQ==", "bodyText": "Who does not the scraping of the node exporter information? Or do we not use any information from node exporter in the dashboards and it is not needed?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3351#discussion_r458153841", "createdAt": "2020-07-21T14:45:02Z", "author": {"login": "scholzj"}, "path": "examples/metrics/prometheus-install/strimzi-service-monitor.yaml", "diffHunk": "@@ -40,58 +32,10 @@ spec:\n       targetLabel: namespace\n       replacement: $1\n       action: replace\n-    - sourceLabels: [__meta_kubernetes_namespace]\n-      separator: ;\n-      regex: (.*)\n-      targetLabel: kubernetes_namespace\n-      replacement: $1\n-      action: replace\n-    - sourceLabels: [__meta_kubernetes_service_name]\n-      separator: ;\n-      regex: (.*)\n-      targetLabel: kubernetes_name\n-      replacement: $1\n-      action: replace\n-    - sourceLabels: [__meta_kubernetes_pod_node_name]\n-      separator: ;\n-      regex: (.*)\n-      targetLabel: node_name\n-      replacement: $1\n-      action: replace\n-    - sourceLabels: [__meta_kubernetes_pod_host_ip]\n-      separator: ;\n-      regex: (.*)\n-      targetLabel: node_ip\n-      replacement: $1\n-      action: replace\n-\n-  #### job_name: node-exporter\n-  - port: tcp-prometheus", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf8efeda74fa5372fd49aa91cbd9e674888705de"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6473268c71887560722dde5453fda56ea3b7d2b", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d6473268c71887560722dde5453fda56ea3b7d2b", "committedDate": "2020-07-22T10:35:11Z", "message": "Moved to use PodMonitor instead of ServiceMonitor for Kafka, ZooKeeper\nrelated metrics\nReverted back changes on Grafana dashboards\nUpdated documentation about usage of PodMonitor\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMjM1Nzgz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3351#pullrequestreview-453235783", "createdAt": "2020-07-22T11:40:52Z", "commit": {"oid": "d6473268c71887560722dde5453fda56ea3b7d2b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMTo0MDo1MlrOG1eocA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMTo0MDo1MlrOG1eocA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcyOTU4NA==", "bodyText": "I would add this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            This port will be removed in the next release.\n          \n          \n            \n            This port will be removed in the next release.\n          \n          \n            \n            Together with it we will also remove the Prometheus annotation from the service.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3351#discussion_r458729584", "createdAt": "2020-07-22T11:40:52Z", "author": {"login": "scholzj"}, "path": "CHANGELOG.md", "diffHunk": "@@ -45,6 +45,12 @@ We removed the old ones from the Prometheus scraping configuration/alerts and on\n It means that the charts related to memory and CPU usage are not going to work on Kuvbernetes version previous 1.14.\n For more information on what is changed: https://github.com/strimzi/strimzi-kafka-operator/pull/3312\n \n+#### Deprecation of monitoring port on Kafka and ZooKeeper related services\n+\n+The `PodMonitor` resource is now used instead of the `ServiceMonitor` for scraping metrics from Kafka, ZooKeeper, Kafka Connect and so on.\n+For this reason, we are deprecating the monitoring port `tcp-prometheus` (9404) on all the services where it is declared (Kafka bootstrap, ZooKeeper client and so on).\n+This port will be removed in the next release.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6473268c71887560722dde5453fda56ea3b7d2b"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86ebbb8b939dfccc1c05b28816ec33c279682193", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/86ebbb8b939dfccc1c05b28816ec33c279682193", "committedDate": "2020-07-22T11:43:06Z", "message": "Fix comment\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2144c1b31a8638213df6789a372f17dc2987a28", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b2144c1b31a8638213df6789a372f17dc2987a28", "committedDate": "2020-07-22T12:50:12Z", "message": "Fixed Prometeus rules\nFixed PodMonitor wrong matching default namespace\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMzA5MTYz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3351#pullrequestreview-453309163", "createdAt": "2020-07-22T13:20:23Z", "commit": {"oid": "b2144c1b31a8638213df6789a372f17dc2987a28"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1344, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}