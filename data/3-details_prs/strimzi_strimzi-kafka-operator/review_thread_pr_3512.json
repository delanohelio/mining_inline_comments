{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MTYyMzQ4", "number": 3512, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQxMzo0NzozMlrOEYtO0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjozOTozN1rOEZkJKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0MzQyMzUyOnYy", "diffSide": "RIGHT", "path": "crd-generator/src/main/java/io/strimzi/crdgenerator/DocGenerator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQxMzo0NzozMlrOHBK5qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNVQxNDo1NzoxOVrOHBLcUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk4OTIyNQ==", "bodyText": "What's the reasoning behind initializing with this size?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r470989225", "createdAt": "2020-08-15T13:47:32Z", "author": {"login": "samuel-hawker"}, "path": "crd-generator/src/main/java/io/strimzi/crdgenerator/DocGenerator.java", "diffHunk": "@@ -80,27 +83,57 @@ private void appendHeading(Crd crd, String name) throws IOException {\n     }\n \n     private void usedIn(Class<?> cls, Map<Class<?>, Set<Class<?>>> usedIn) {\n+        Set<Property> memorableProperties = new HashSet<>();\n+\n         for (Property property : properties(cls).values()) {\n             if (property.isAnnotationPresent(KubeLink.class)) {\n                 continue;\n             }\n+\n+            OneOfType oneOfType = property.getAnnotation(OneOfType.class);\n+            if (oneOfType != null && oneOfType.value().length > 0) {\n+                for (OneOfType.Alternative alt : oneOfType.value()) {\n+                    for (OneOfType.Alternative.Field field : alt.value()) {\n+                        try {\n+                            memorableProperties.add(new Property(property.getType().getType().getDeclaredField(field.value())));\n+                        } catch (NoSuchFieldException e) {\n+                            throw new RuntimeException(\"Failed to find field used in OneOfType annotation\", e);\n+                        }\n+                    }\n+                }\n+            } else {\n+                memorableProperties.add(property);\n+            }\n+        }\n+\n+        for (Property property : memorableProperties) {\n             PropertyType propertyType = property.getType();\n             Class<?> type = propertyType.isArray() ? propertyType.arrayBase() : propertyType.getType();\n             for (Class<?> c : subtypesOrSelf(type)) {\n                 if (Schema.isJsonScalarType(c)) {\n                     continue;\n                 }\n-                Set<Class<?>> classes = usedIn.get(c);\n-                if (classes == null) {\n-                    classes = new HashSet<>(2);\n-                    usedIn.put(c, classes);\n-                }\n+\n+                Set<Class<?>> classes = getOrCreateClassesSet(c, usedIn);\n+\n                 classes.add(cls);\n+\n                 usedIn(c, usedIn);\n             }\n         }\n     }\n \n+    private Set<Class<?>> getOrCreateClassesSet(Class<?> c, Map<Class<?>, Set<Class<?>>> usedIn)   {\n+        Set<Class<?>> classes = usedIn.get(c);\n+\n+        if (classes == null) {\n+            classes = new HashSet<>(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4eaaa0a9cfe4017e880bb8463a6cb0864e37d1dc"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk5ODA5Nw==", "bodyText": "Honestly, it was in the old code. I just move it into separate method because of spotbugs. But I do not see any reason for it, so I changed it to 1.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r470998097", "createdAt": "2020-08-15T14:57:19Z", "author": {"login": "scholzj"}, "path": "crd-generator/src/main/java/io/strimzi/crdgenerator/DocGenerator.java", "diffHunk": "@@ -80,27 +83,57 @@ private void appendHeading(Crd crd, String name) throws IOException {\n     }\n \n     private void usedIn(Class<?> cls, Map<Class<?>, Set<Class<?>>> usedIn) {\n+        Set<Property> memorableProperties = new HashSet<>();\n+\n         for (Property property : properties(cls).values()) {\n             if (property.isAnnotationPresent(KubeLink.class)) {\n                 continue;\n             }\n+\n+            OneOfType oneOfType = property.getAnnotation(OneOfType.class);\n+            if (oneOfType != null && oneOfType.value().length > 0) {\n+                for (OneOfType.Alternative alt : oneOfType.value()) {\n+                    for (OneOfType.Alternative.Field field : alt.value()) {\n+                        try {\n+                            memorableProperties.add(new Property(property.getType().getType().getDeclaredField(field.value())));\n+                        } catch (NoSuchFieldException e) {\n+                            throw new RuntimeException(\"Failed to find field used in OneOfType annotation\", e);\n+                        }\n+                    }\n+                }\n+            } else {\n+                memorableProperties.add(property);\n+            }\n+        }\n+\n+        for (Property property : memorableProperties) {\n             PropertyType propertyType = property.getType();\n             Class<?> type = propertyType.isArray() ? propertyType.arrayBase() : propertyType.getType();\n             for (Class<?> c : subtypesOrSelf(type)) {\n                 if (Schema.isJsonScalarType(c)) {\n                     continue;\n                 }\n-                Set<Class<?>> classes = usedIn.get(c);\n-                if (classes == null) {\n-                    classes = new HashSet<>(2);\n-                    usedIn.put(c, classes);\n-                }\n+\n+                Set<Class<?>> classes = getOrCreateClassesSet(c, usedIn);\n+\n                 classes.add(cls);\n+\n                 usedIn(c, usedIn);\n             }\n         }\n     }\n \n+    private Set<Class<?>> getOrCreateClassesSet(Class<?> c, Map<Class<?>, Set<Class<?>>> usedIn)   {\n+        Set<Class<?>> classes = usedIn.get(c);\n+\n+        if (classes == null) {\n+            classes = new HashSet<>(2);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDk4OTIyNQ=="}, "originalCommit": {"oid": "4eaaa0a9cfe4017e880bb8463a6cb0864e37d1dc"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTUzODAyOnYy", "diffSide": "RIGHT", "path": "crd-annotations/src/main/java/io/strimzi/api/annotations/DeprecatedType.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjozNjoyOVrOHBbW5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNjo0ODozMlrOHCFm9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1ODg1Mw==", "bodyText": "Any reason not to use java.lang.Class as the type?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r471258853", "createdAt": "2020-08-17T06:36:29Z", "author": {"login": "tombentley"}, "path": "crd-annotations/src/main/java/io/strimzi/api/annotations/DeprecatedType.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.api.annotations;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+@Target({ElementType.TYPE})\n+@Retention(RetentionPolicy.RUNTIME)\n+public @interface DeprecatedType {\n+    /**\n+     * @return The type which should be used as replacement\n+     */\n+    String replacedWithType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19e7bbf98b32c4f48995247c7ed1048fa42258c"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY4NzM5Mg==", "bodyText": "The CrdGenerator and DocGenerator are based around properties. The way the annotation works to day is that the String specifies the name of the filed in the ThisOrThat class and that allows to easily integrate it -> basically just changes the parameter annotated as OneOfType with the two parameters from inside its class.\nIf you think having a class there would be cleaner despite the more complicated DocGenerator and CrdGenerator classes, I can change it.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r471687392", "createdAt": "2020-08-17T18:30:58Z", "author": {"login": "scholzj"}, "path": "crd-annotations/src/main/java/io/strimzi/api/annotations/DeprecatedType.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.api.annotations;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+@Target({ElementType.TYPE})\n+@Retention(RetentionPolicy.RUNTIME)\n+public @interface DeprecatedType {\n+    /**\n+     * @return The type which should be used as replacement\n+     */\n+    String replacedWithType();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1ODg1Mw=="}, "originalCommit": {"oid": "d19e7bbf98b32c4f48995247c7ed1048fa42258c"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk1MTA5Mg==", "bodyText": "AFAICS the string is only used in DocGenerator where it's immediately passed to Class.forName() to obtain a Class instance anyway. I don't understand what the drawback/complication is (I'm not saying there isn't one).", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r471951092", "createdAt": "2020-08-18T06:48:32Z", "author": {"login": "tombentley"}, "path": "crd-annotations/src/main/java/io/strimzi/api/annotations/DeprecatedType.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.api.annotations;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+@Target({ElementType.TYPE})\n+@Retention(RetentionPolicy.RUNTIME)\n+public @interface DeprecatedType {\n+    /**\n+     * @return The type which should be used as replacement\n+     */\n+    String replacedWithType();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI1ODg1Mw=="}, "originalCommit": {"oid": "d19e7bbf98b32c4f48995247c7ed1048fa42258c"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTU1Mjk0OnYy", "diffSide": "RIGHT", "path": "crd-generator/src/test/java/io/strimzi/crdgenerator/Type1OrType2.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo0Mjo0N1rOHBbfjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODozNzo0M1rOHB2FuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2MTA2OA==", "bodyText": "ObjectMapper is thread-safe and relatively heavyweight. We should be moving in the direction of using a (few) constants, rather than instantiating every time we want to serialize or deserialize.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r471261068", "createdAt": "2020-08-17T06:42:47Z", "author": {"login": "tombentley"}, "path": "crd-generator/src/test/java/io/strimzi/crdgenerator/Type1OrType2.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.crdgenerator;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.core.ObjectCodec;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectReader;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import io.strimzi.api.annotations.DeprecatedType;\n+\n+import java.io.IOException;\n+\n+@JsonDeserialize(using = Type1OrType2.Deserializer.class)\n+@JsonSerialize(using = Type1OrType2.Serializer.class)\n+public class Type1OrType2 {\n+    private Type1 type1Value;\n+    private Type2 type2Value;\n+\n+    public Type1OrType2(Type1 type1Value)   {\n+        type1Value = type1Value;\n+        type2Value = null;\n+    }\n+\n+    public Type1OrType2(Type2 type2Value)   {\n+        type1Value = null;\n+        type2Value = type2Value;\n+    }\n+\n+    public Type1 getMapValue()    {\n+        return type1Value;\n+    }\n+\n+    public Type2 getListValue()    {\n+        return type2Value;\n+    }\n+\n+    public static class Serializer extends JsonSerializer<Type1OrType2> {\n+        @Override\n+        public void serialize(Type1OrType2 value, JsonGenerator generator, SerializerProvider provider) throws IOException {\n+            if (value != null) {\n+                if (value.type1Value != null)    {\n+                    generator.writeObject(value.type1Value);\n+                } else if (value.type2Value != null)  {\n+                    generator.writeObject(value.type2Value);\n+                } else {\n+                    generator.writeNull();\n+                }\n+            } else {\n+                generator.writeNull();\n+            }\n+        }\n+    }\n+\n+    public static class Deserializer extends JsonDeserializer<Type1OrType2> {\n+        @Override\n+        public Type1OrType2 deserialize(JsonParser jsonParser, DeserializationContext context) throws IOException {\n+            ObjectMapper objectMapper = new ObjectMapper();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19e7bbf98b32c4f48995247c7ed1048fa42258c"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY5NjgyNQ==", "bodyText": "I made the ObjectMapper static member of the deserializer class. Is that what you meant here?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r471696825", "createdAt": "2020-08-17T18:37:43Z", "author": {"login": "scholzj"}, "path": "crd-generator/src/test/java/io/strimzi/crdgenerator/Type1OrType2.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.crdgenerator;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.core.ObjectCodec;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectReader;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import io.strimzi.api.annotations.DeprecatedType;\n+\n+import java.io.IOException;\n+\n+@JsonDeserialize(using = Type1OrType2.Deserializer.class)\n+@JsonSerialize(using = Type1OrType2.Serializer.class)\n+public class Type1OrType2 {\n+    private Type1 type1Value;\n+    private Type2 type2Value;\n+\n+    public Type1OrType2(Type1 type1Value)   {\n+        type1Value = type1Value;\n+        type2Value = null;\n+    }\n+\n+    public Type1OrType2(Type2 type2Value)   {\n+        type1Value = null;\n+        type2Value = type2Value;\n+    }\n+\n+    public Type1 getMapValue()    {\n+        return type1Value;\n+    }\n+\n+    public Type2 getListValue()    {\n+        return type2Value;\n+    }\n+\n+    public static class Serializer extends JsonSerializer<Type1OrType2> {\n+        @Override\n+        public void serialize(Type1OrType2 value, JsonGenerator generator, SerializerProvider provider) throws IOException {\n+            if (value != null) {\n+                if (value.type1Value != null)    {\n+                    generator.writeObject(value.type1Value);\n+                } else if (value.type2Value != null)  {\n+                    generator.writeObject(value.type2Value);\n+                } else {\n+                    generator.writeNull();\n+                }\n+            } else {\n+                generator.writeNull();\n+            }\n+        }\n+    }\n+\n+    public static class Deserializer extends JsonDeserializer<Type1OrType2> {\n+        @Override\n+        public Type1OrType2 deserialize(JsonParser jsonParser, DeserializationContext context) throws IOException {\n+            ObjectMapper objectMapper = new ObjectMapper();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2MTA2OA=="}, "originalCommit": {"oid": "d19e7bbf98b32c4f48995247c7ed1048fa42258c"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk0NTU1NzY0OnYy", "diffSide": "RIGHT", "path": "crd-generator/src/test/resources/io/strimzi/crdgenerator/simpleTest.yaml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNjo0NDo1MVrOHBbiag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxODozNjoxNFrOHB19zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2MTgwMg==", "bodyText": "Have you checked that the Kube API server accepted the generated schema and that it validates it correctly?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r471261802", "createdAt": "2020-08-17T06:44:51Z", "author": {"login": "tombentley"}, "path": "crd-generator/src/test/resources/io/strimzi/crdgenerator/simpleTest.yaml", "diffHunk": "@@ -427,6 +433,16 @@ spec:\n         stringProperty:\n           type: \"string\"\n           pattern: \".*\"\n+        typedAlternatives:\n+          oneOf:\n+          - type: \"object\"\n+            properties:\n+              key1:\n+                type: \"string\"\n+          - type: \"object\"\n+            properties:\n+              key2:\n+                type: \"string\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d19e7bbf98b32c4f48995247c7ed1048fa42258c"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY5NDc5Ng==", "bodyText": "Yes, I'm already using it for the (work in progress) listener redesign and it works fine.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r471694796", "createdAt": "2020-08-17T18:36:14Z", "author": {"login": "scholzj"}, "path": "crd-generator/src/test/resources/io/strimzi/crdgenerator/simpleTest.yaml", "diffHunk": "@@ -427,6 +433,16 @@ spec:\n         stringProperty:\n           type: \"string\"\n           pattern: \".*\"\n+        typedAlternatives:\n+          oneOf:\n+          - type: \"object\"\n+            properties:\n+              key1:\n+                type: \"string\"\n+          - type: \"object\"\n+            properties:\n+              key2:\n+                type: \"string\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI2MTgwMg=="}, "originalCommit": {"oid": "d19e7bbf98b32c4f48995247c7ed1048fa42258c"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MDA0MDMzOnYy", "diffSide": "RIGHT", "path": "crd-generator/src/main/java/io/strimzi/crdgenerator/CrdGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNjo1Nzo1OFrOHCF3zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNjo1Nzo1OFrOHCF3zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk1NTQwNg==", "bodyText": "I'm not really sure I understand this. Each of the alternatives in the OneOfType can have a set of fields, but then the fields each get called alternatives?\nAlso, I think a more idiomatic thing to do would be to get a Property via Property.properties(property.getType().getType()). That way it will work correctly with getters and/or fields. It also keeps the reflection in Properties. Same comment goes for the DocGenerator, I think. Can we, at the same time, make the constructors of Property private?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r471955406", "createdAt": "2020-08-18T06:57:58Z", "author": {"login": "tombentley"}, "path": "crd-generator/src/main/java/io/strimzi/crdgenerator/CrdGenerator.java", "diffHunk": "@@ -466,11 +468,39 @@ private ArrayNode buildSchemaRequired(Class<?> crdClass) {\n     private ObjectNode buildSchemaProperties(Class<?> crdClass) {\n         ObjectNode properties = nf.objectNode();\n         for (Property property : unionOfSubclassProperties(crdClass)) {\n-            buildProperty(properties, property);\n+            OneOfType oneOfType = property.getAnnotation(OneOfType.class);\n+            if (oneOfType != null && oneOfType.value().length > 0)    {\n+                List<Property> alternatives = new ArrayList<>(0);\n+\n+                for (OneOfType.Alternative alt : oneOfType.value()) {\n+                    for (OneOfType.Alternative.Field field : alt.value()) {\n+                        try {\n+                            alternatives.add(new Property(property.getType().getType().getDeclaredField(field.value())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b044907bf3afadb30e905bd684022141d3ef3678"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MDA2MjUyOnYy", "diffSide": "RIGHT", "path": "crd-generator/src/main/java/io/strimzi/crdgenerator/DocGenerator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNzowNDo0M1rOHCGEwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNzowNDo0M1rOHCGEwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk1ODcyMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    Set<Class<?>> classes = usedIn.get(c);\n          \n          \n            \n            \n          \n          \n            \n                    if (classes == null) {\n          \n          \n            \n                        classes = new HashSet<>(1);\n          \n          \n            \n                        usedIn.put(c, classes);\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    return classes;\n          \n          \n            \n                    return usedIn.computeIfAbsent(c, cls -> new HashSet(1));", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r471958722", "createdAt": "2020-08-18T07:04:43Z", "author": {"login": "tombentley"}, "path": "crd-generator/src/main/java/io/strimzi/crdgenerator/DocGenerator.java", "diffHunk": "@@ -80,27 +83,57 @@ private void appendHeading(Crd crd, String name) throws IOException {\n     }\n \n     private void usedIn(Class<?> cls, Map<Class<?>, Set<Class<?>>> usedIn) {\n+        Set<Property> memorableProperties = new HashSet<>();\n+\n         for (Property property : properties(cls).values()) {\n             if (property.isAnnotationPresent(KubeLink.class)) {\n                 continue;\n             }\n+\n+            OneOfType oneOfType = property.getAnnotation(OneOfType.class);\n+            if (oneOfType != null && oneOfType.value().length > 0) {\n+                for (OneOfType.Alternative alt : oneOfType.value()) {\n+                    for (OneOfType.Alternative.Field field : alt.value()) {\n+                        try {\n+                            memorableProperties.add(new Property(property.getType().getType().getDeclaredField(field.value())));\n+                        } catch (NoSuchFieldException e) {\n+                            throw new RuntimeException(\"Failed to find field used in OneOfType annotation\", e);\n+                        }\n+                    }\n+                }\n+            } else {\n+                memorableProperties.add(property);\n+            }\n+        }\n+\n+        for (Property property : memorableProperties) {\n             PropertyType propertyType = property.getType();\n             Class<?> type = propertyType.isArray() ? propertyType.arrayBase() : propertyType.getType();\n             for (Class<?> c : subtypesOrSelf(type)) {\n                 if (Schema.isJsonScalarType(c)) {\n                     continue;\n                 }\n-                Set<Class<?>> classes = usedIn.get(c);\n-                if (classes == null) {\n-                    classes = new HashSet<>(2);\n-                    usedIn.put(c, classes);\n-                }\n+\n+                Set<Class<?>> classes = getOrCreateClassesSet(c, usedIn);\n+\n                 classes.add(cls);\n+\n                 usedIn(c, usedIn);\n             }\n         }\n     }\n \n+    private Set<Class<?>> getOrCreateClassesSet(Class<?> c, Map<Class<?>, Set<Class<?>>> usedIn)   {\n+        Set<Class<?>> classes = usedIn.get(c);\n+\n+        if (classes == null) {\n+            classes = new HashSet<>(1);\n+            usedIn.put(c, classes);\n+        }\n+\n+        return classes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b044907bf3afadb30e905bd684022141d3ef3678"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MDA3NDkzOnYy", "diffSide": "RIGHT", "path": "crd-generator/src/main/java/io/strimzi/crdgenerator/annotations/OneOfType.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNzowODo0OFrOHCGMYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNzowODo0OFrOHCGMYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk2MDY3NA==", "bodyText": "What's the value of using Field, couldn't value just be a String[] of the field names.\nAlso, I think we should use the term property, rather than field, since in Java terms these things can be either fields or getters (aka properties).", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r471960674", "createdAt": "2020-08-18T07:08:48Z", "author": {"login": "tombentley"}, "path": "crd-generator/src/main/java/io/strimzi/crdgenerator/annotations/OneOfType.java", "diffHunk": "@@ -0,0 +1,28 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.crdgenerator.annotations;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+@Retention(RetentionPolicy.RUNTIME)\n+@Target({ElementType.METHOD})\n+public @interface OneOfType {\n+    /** @return List of alternatives */\n+    Alternative[] value();\n+\n+    @interface Alternative {\n+        @interface Field {\n+            /** @return The name of a field */\n+            String value();\n+        }\n+\n+        /** @return Fields in this alternative */\n+        Field[] value();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b044907bf3afadb30e905bd684022141d3ef3678"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk1MjQyMDI2OnYy", "diffSide": "RIGHT", "path": "crd-generator/src/test/java/io/strimzi/crdgenerator/MapOrList.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNjozOTozN1rOHCc5Sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNToxMDo0NFrOHDL__g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMzMjYxOQ==", "bodyText": "I think you should be able to write the deserializer like this (for this case), which saves having to deserialize the whole tree into JsonNode only to go mapping it to java types:\n        @Override\n        public MapOrList deserialize(JsonParser jsonParser, DeserializationContext context) throws IOException {\n            MapOrList mapOrList;\n            ObjectCodec oc = jsonParser.getCodec();\n            if (jsonParser.currentToken() == JsonToken.START_ARRAY) {\n                mapOrList = new MapOrList(oc.readValue(jsonParser, new TypeReference<List<String>>() { }));\n            } else if (jsonParser.currentToken() == JsonToken.START_OBJECT) {\n                mapOrList = new MapOrList(oc.readValue(jsonParser, new TypeReference<Map<String, String>>() { }));\n            } else {\n                throw new RuntimeException();\n            }\n            return mapOrList;\n        }\nUnfortunately that's not possible for the Type1OrType2 case.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r472332619", "createdAt": "2020-08-18T16:39:37Z", "author": {"login": "tombentley"}, "path": "crd-generator/src/test/java/io/strimzi/crdgenerator/MapOrList.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.crdgenerator;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.core.ObjectCodec;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectReader;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import io.strimzi.crdgenerator.annotations.Alternation;\n+import io.strimzi.crdgenerator.annotations.Alternative;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+\n+@JsonDeserialize(using = MapOrList.Deserializer.class)\n+@JsonSerialize(using = MapOrList.Serializer.class)\n+@Alternation\n+public class MapOrList {\n+    private Map<String, String> mapValue;\n+    private List<String> listValue;\n+\n+    public MapOrList(Map<String, String> map)   {\n+        mapValue = map;\n+        listValue = null;\n+    }\n+\n+    public MapOrList(List<String> list)   {\n+        mapValue = null;\n+        listValue = list;\n+    }\n+\n+    @Alternative\n+    public Map<String, String> getMapValue()    {\n+        return mapValue;\n+    }\n+\n+    @Alternative\n+    public List<String> getListValue()    {\n+        return listValue;\n+    }\n+\n+    public static class Serializer extends JsonSerializer<MapOrList> {\n+        @Override\n+        public void serialize(MapOrList value, JsonGenerator generator, SerializerProvider provider) throws IOException {\n+            if (value != null) {\n+                if (value.listValue != null)    {\n+                    generator.writeObject(value.listValue);\n+                } else if (value.mapValue != null)  {\n+                    generator.writeObject(value.mapValue);\n+                } else {\n+                    generator.writeNull();\n+                }\n+            } else {\n+                generator.writeNull();\n+            }\n+        }\n+    }\n+\n+    public static class Deserializer extends JsonDeserializer<MapOrList> {\n+        @Override\n+        public MapOrList deserialize(JsonParser jsonParser, DeserializationContext context) throws IOException {\n+            ObjectMapper objectMapper = new ObjectMapper();\n+            ObjectCodec oc = jsonParser.getCodec();\n+            JsonNode node = oc.readTree(jsonParser);\n+            MapOrList mapOrList;\n+\n+            if (node.isArray()) {\n+                ObjectReader reader = objectMapper.readerFor(new TypeReference<List<String>>() { });\n+                List<String> list = reader.readValue(node);\n+                mapOrList = new MapOrList(list);\n+            } else {\n+                ObjectReader reader = objectMapper.readerFor(new TypeReference<Map<String, String>>() { });\n+                Map<String, String> map = reader.readValue(node);\n+                mapOrList = new MapOrList(map);\n+            }\n+            return mapOrList;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d30bda65b7a81c1e5bf4ffbbaab398629821b4f"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzEwNDM4Mg==", "bodyText": "Fixed. This seems to work and it will even work in the actual listeners use case. So this is good. Thanks.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3512#discussion_r473104382", "createdAt": "2020-08-19T15:10:44Z", "author": {"login": "scholzj"}, "path": "crd-generator/src/test/java/io/strimzi/crdgenerator/MapOrList.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.crdgenerator;\n+\n+import com.fasterxml.jackson.core.JsonGenerator;\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.core.ObjectCodec;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.JsonDeserializer;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.JsonSerializer;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectReader;\n+import com.fasterxml.jackson.databind.SerializerProvider;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n+import io.strimzi.crdgenerator.annotations.Alternation;\n+import io.strimzi.crdgenerator.annotations.Alternative;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+\n+@JsonDeserialize(using = MapOrList.Deserializer.class)\n+@JsonSerialize(using = MapOrList.Serializer.class)\n+@Alternation\n+public class MapOrList {\n+    private Map<String, String> mapValue;\n+    private List<String> listValue;\n+\n+    public MapOrList(Map<String, String> map)   {\n+        mapValue = map;\n+        listValue = null;\n+    }\n+\n+    public MapOrList(List<String> list)   {\n+        mapValue = null;\n+        listValue = list;\n+    }\n+\n+    @Alternative\n+    public Map<String, String> getMapValue()    {\n+        return mapValue;\n+    }\n+\n+    @Alternative\n+    public List<String> getListValue()    {\n+        return listValue;\n+    }\n+\n+    public static class Serializer extends JsonSerializer<MapOrList> {\n+        @Override\n+        public void serialize(MapOrList value, JsonGenerator generator, SerializerProvider provider) throws IOException {\n+            if (value != null) {\n+                if (value.listValue != null)    {\n+                    generator.writeObject(value.listValue);\n+                } else if (value.mapValue != null)  {\n+                    generator.writeObject(value.mapValue);\n+                } else {\n+                    generator.writeNull();\n+                }\n+            } else {\n+                generator.writeNull();\n+            }\n+        }\n+    }\n+\n+    public static class Deserializer extends JsonDeserializer<MapOrList> {\n+        @Override\n+        public MapOrList deserialize(JsonParser jsonParser, DeserializationContext context) throws IOException {\n+            ObjectMapper objectMapper = new ObjectMapper();\n+            ObjectCodec oc = jsonParser.getCodec();\n+            JsonNode node = oc.readTree(jsonParser);\n+            MapOrList mapOrList;\n+\n+            if (node.isArray()) {\n+                ObjectReader reader = objectMapper.readerFor(new TypeReference<List<String>>() { });\n+                List<String> list = reader.readValue(node);\n+                mapOrList = new MapOrList(list);\n+            } else {\n+                ObjectReader reader = objectMapper.readerFor(new TypeReference<Map<String, String>>() { });\n+                Map<String, String> map = reader.readValue(node);\n+                mapOrList = new MapOrList(map);\n+            }\n+            return mapOrList;\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjMzMjYxOQ=="}, "originalCommit": {"oid": "4d30bda65b7a81c1e5bf4ffbbaab398629821b4f"}, "originalPosition": 89}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1317, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}