{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzMTkyNjM4", "number": 3623, "title": "Redesigned unknown and deprecated fields in resource status conditions", "bodyText": "Type of change\n\nEnhancement / new feature\n\nDescription\nThis PR replaces the older PR #3379 with a new design which came up from the discussion there.\nSometimes it happens that users mis-configure something in the custom resource - for example by placing the field into the wrong path etc. That can have sometimes serious consequences - we had several users who had this issue with authorization and were wondering why does the authorization nor work. This applies similarly also to deprecated fields.\nWe already detect such fields and print them in logs. E.g.:\n2020-07-24 23:10:20 WARN  AbstractOperator:92 - Kafka resource my-cluster in namespace myproject: In API version kafka.strimzi.io/v1beta1 the property tolerations at path spec.kafka.tolerations has been deprecated. This feature should now be configured at path spec.kafka.template.pod.tolerations.\n2020-07-24 23:10:20 WARN  AbstractOperator:117 - Kafka resource my-cluster in namespace myproject: Contains object at path spec.kafka.listeners with an unknown property: authorization\n\nHowever, it seems people often miss them in logs. For example when the operator is running in different namespace, possibly installed by someone else or from OperatorHub.io it might be hard to even find the logs.\nThis PR adds these fields in addition to the logs also to the status condition where they might be easier to notice:\n  # ...\n  status:\n    conditions:\n    - lastTransitionTime: 2020-07-24T23:09:27+0000\n      status: \"True\"\n      type: Ready\n    - lastTransitionTime: \"2020-07-24T23:06:34.339352Z\"\n      message: 'Contains object at path spec.kafka.listeners with an unknown property:\n        authorization'\n      reason: UnknownFields\n      status: \"True\"\n      type: Warning\n    - lastTransitionTime: \"2020-07-24T23:06:34.339445Z\"\n      message: In API version kafka.strimzi.io/v1beta1 the property tolerations at\n        path spec.kafka.tolerations has been deprecated. This feature should now be\n        configured at path spec.kafka.template.pod.tolerations.\n      reason: DeprecatedFields\n      status: \"True\"\n      type: Warning\n    # ...\nThis PR does not impact KafkaRebalance and KafkaConnector resources which have their own reconciliation cycle and do not seem to use the ValidatingVisitor. Separate issues #3637 and #3638 have been opened.\nChecklist\n\n Write tests\n Make sure all tests pass\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Update CHANGELOG.md", "createdAt": "2020-09-09T23:08:20Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623", "merged": true, "mergeCommit": {"oid": "c11dd92d624e90267224395d3ee6a48b5d2aca6d"}, "closed": true, "closedAt": "2020-09-17T18:08:05Z", "author": {"login": "scholzj"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHcG9fgFqTQ4NTY2MDQ5NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJuaEwABqjM3NzcyNDYzNDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NjYwNDk1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#pullrequestreview-485660495", "createdAt": "2020-09-10T07:39:09Z", "commit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzozOTowOVrOHPm_uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwNzo1NzozOVrOHPnqAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEyOTU5Mw==", "bodyText": "Why does this have to be a class extending CustomerResource rather than an interface that extends HasMetadata and HasStatus?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486129593", "createdAt": "2020-09-10T07:39:09Z", "author": {"login": "tombentley"}, "path": "api/src/main/java/io/strimzi/api/kafka/AbstractCustomResource.java", "diffHunk": "@@ -0,0 +1,17 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.api.kafka;\n+\n+import io.fabric8.kubernetes.client.CustomResource;\n+import io.strimzi.api.kafka.model.Spec;\n+import io.strimzi.api.kafka.model.status.HasStatus;\n+import io.strimzi.api.kafka.model.status.Status;\n+\n+public abstract class AbstractCustomResource<T extends Spec, S extends Status> extends CustomResource implements HasStatus<S> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzNDYzNg==", "bodyText": "It shouldn't be in this PR, but I think we should consider using proper names rather than single letters for type parameters, since it remembering the single letters gets harder the more thee are of them.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486134636", "createdAt": "2020-09-10T07:47:50Z", "author": {"login": "tombentley"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/AbstractOperator.java", "diffHunk": "@@ -40,20 +51,22 @@\n  *\n  * <ul>\n  * <li>uses the Fabric8 kubernetes API and implements\n- * {@link #reconcile(Reconciliation)} by delegating to abstract {@link #createOrUpdate(Reconciliation, HasMetadata)}\n+ * {@link #reconcile(Reconciliation)} by delegating to abstract {@link #createOrUpdate(Reconciliation, AbstractCustomResource)}\n  * and {@link #delete(Reconciliation)} methods for subclasses to implement.\n  * \n- * <li>add support for operator-side {@linkplain #validate(HasMetadata) validation}.\n+ * <li>add support for operator-side {@linkplain #validate(AbstractCustomResource) validation}.\n  *     This can be used to automatically log warnings about source resources which used deprecated part of the CR API.\n  *\n  * </ul>\n  * @param <T> The Java representation of the Kubernetes resource, e.g. {@code Kafka} or {@code KafkaConnect}\n- * @param <S> The \"Resource Operator\" for the source resource type. Typically this will be some instantiation of\n+ * @param <O> The \"Resource Operator\" for the source resource type. Typically this will be some instantiation of\n  *           {@link io.strimzi.operator.common.operator.resource.CrdOperator}.\n  */\n public abstract class AbstractOperator<\n-        T extends HasMetadata,\n-        S extends AbstractWatchableResourceOperator<?, T, ?, ?, ?>>\n+        T extends AbstractCustomResource<P, S>,\n+        P extends Spec,\n+        S extends Status,\n+        O extends AbstractWatchableResourceOperatorWithStatus<?, T, ?, ?, ?>>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzNzc2MQ==", "bodyText": "I find this method signature a little odd. You're only passing unknownAndDeprecatedConditions so you can add it to desiredStatus. I think it would be better to factor that into its own method which the caller of this method invokes and passes just the desiredStatus.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486137761", "createdAt": "2020-09-10T07:53:11Z", "author": {"login": "tombentley"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/AbstractOperator.java", "diffHunk": "@@ -200,6 +262,75 @@ private String getLockName(String namespace, String name) {\n         return result.future();\n     }\n \n+\n+\n+    /**\n+     * Updates the Status field of the Kafka CR. It diffs the desired status against the current status and calls\n+     * the update only when there is any difference in non-timestamp fields.\n+     *\n+     * @param desiredStatus The KafkaStatus which should be set\n+     *\n+     * @return\n+     */\n+    Future<Void> updateStatus(Reconciliation reconciliation, S desiredStatus, List<Condition> unknownAndDeprecatedConditions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 183}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzOTE1OQ==", "bodyText": "Wouldn't it be easier if the ValidationVisitor just returned a List<Condition>, rather than having to map the two lists of Strings to Conditions?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486139159", "createdAt": "2020-09-10T07:55:31Z", "author": {"login": "tombentley"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/AbstractOperator.java", "diffHunk": "@@ -258,10 +389,31 @@ private String getLockName(String namespace, String name) {\n      * @param resource The custom resource\n      * @throws InvalidResourceException if the resource cannot be safely reconciled.\n      */\n-    protected void validate(T resource) {\n+    protected List<Condition> validate(T resource) {\n         if (resource != null) {\n-            ResourceVisitor.visit(resource, new ValidationVisitor(resource, log));\n+            Set<String> unknownFields = new HashSet<>(0);\n+            Set<String> deprecatedFields = new HashSet<>(0);\n+\n+            ResourceVisitor.visit(resource, new ValidationVisitor(resource, log, unknownFields, deprecatedFields));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 256}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzOTQwMg==", "bodyText": "Does this still need to be protected?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486139402", "createdAt": "2020-09-10T07:55:54Z", "author": {"login": "tombentley"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/AbstractOperator.java", "diffHunk": "@@ -258,10 +389,31 @@ private String getLockName(String namespace, String name) {\n      * @param resource The custom resource\n      * @throws InvalidResourceException if the resource cannot be safely reconciled.\n      */\n-    protected void validate(T resource) {\n+    protected List<Condition> validate(T resource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 250}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjEzOTg5OA==", "bodyText": "Javadoc", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486139898", "createdAt": "2020-09-10T07:56:46Z", "author": {"login": "tombentley"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/ReconciliationException.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.operator.common;\n+\n+import io.strimzi.api.kafka.model.status.Status;\n+\n+public class ReconciliationException extends Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE0MDQxOQ==", "bodyText": "Javadoc", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486140419", "createdAt": "2020-09-10T07:57:39Z", "author": {"login": "tombentley"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/operator/resource/AbstractWatchableResourceOperatorWithStatus.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.operator.common.operator.resource;\n+\n+import io.fabric8.kubernetes.api.model.Doneable;\n+import io.fabric8.kubernetes.api.model.HasMetadata;\n+import io.fabric8.kubernetes.api.model.KubernetesResourceList;\n+import io.fabric8.kubernetes.client.KubernetesClient;\n+import io.fabric8.kubernetes.client.dsl.Resource;\n+import io.vertx.core.Future;\n+import io.vertx.core.Vertx;\n+\n+public abstract class AbstractWatchableResourceOperatorWithStatus<", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NzA5NTY1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#pullrequestreview-485709565", "createdAt": "2020-09-10T08:38:35Z", "commit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwODozODozNVrOHPpNXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwODozODozNVrOHPpNXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE2NTg1Mg==", "bodyText": "Small nitpick, this sounds like the operator has a status, mybe something like:\nAbstractWatchableStatedResourceOperator", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486165852", "createdAt": "2020-09-10T08:38:35Z", "author": {"login": "samuel-hawker"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/AbstractAssemblyOperator.java", "diffHunk": "@@ -72,7 +74,7 @@\n      */\n     protected AbstractAssemblyOperator(Vertx vertx, PlatformFeaturesAvailability pfa, String kind,\n                                        CertManager certManager, PasswordGenerator passwordGenerator,\n-                                       AbstractWatchableResourceOperator<C, T, L, D, R> resourceOperator,\n+                                       AbstractWatchableResourceOperatorWithStatus<C, T, L, D, R> resourceOperator,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NzExODcw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#pullrequestreview-485711870", "createdAt": "2020-09-10T08:41:02Z", "commit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwODo0MTowM1rOHPpTZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQwOTowNTo0MlrOHPqP3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE2NzM5OA==", "bodyText": "I wonder if, as useful as this is, copying it is an anti-pattern?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486167398", "createdAt": "2020-09-10T08:41:03Z", "author": {"login": "samuel-hawker"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -3523,4 +3526,13 @@ String getInternalServiceHostname(String serviceName, boolean useServiceDnsDomai\n         return new Date();\n     }\n \n+    @Override\n+    protected Kafka copyResource(Kafka res) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE3NjY2Nw==", "bodyText": "status Result is never handled or logged, which may cause potential confusion\nAlbeit this is an extreme edge case anyway", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486176667", "createdAt": "2020-09-10T08:55:42Z", "author": {"login": "samuel-hawker"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/AbstractOperator.java", "diffHunk": "@@ -168,13 +182,61 @@ private String getLockName(String namespace, String name) {\n \n         Future<Void> handler = withLock(reconciliation, LOCK_TIMEOUT_MS, () -> {\n             T cr = resourceOperator.get(namespace, name);\n+\n             if (cr != null) {\n-                validate(cr);\n+                List<Condition> unknownAndDeprecatedConditions = validate(cr);\n+                Promise<Void> createOrUpdate = Promise.promise();\n+\n+                if (cr.getSpec() == null)   {\n+                    InvalidResourceException exception = new InvalidResourceException(\"Spec cannot be null\");\n+\n+                    S status = createStatus();\n+                    Condition errorCondition = new ConditionBuilder()\n+                            .withLastTransitionTime(StatusUtils.iso8601Now())\n+                            .withType(\"NotReady\")\n+                            .withStatus(\"True\")\n+                            .withReason(exception.getClass().getSimpleName())\n+                            .withMessage(exception.getMessage())\n+                            .build();\n+                    status.addCondition(errorCondition);\n+\n+                    log.error(\"{}: {} spec cannot be null\", reconciliation, cr.getMetadata().getName());\n+                    updateStatus(reconciliation, status, unknownAndDeprecatedConditions).onComplete(statusResult -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE3ODgwNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            createOrUpdate(reconciliation, cr).onComplete(createOrUpdateResult -> {\n          \n          \n            \n                                if (createOrUpdateResult.succeeded())    {\n          \n          \n            \n                                    updateStatus(reconciliation, createOrUpdateResult.result(), unknownAndDeprecatedConditions).onComplete(statusResult -> {\n          \n          \n            \n                                        if (statusResult.succeeded())   {\n          \n          \n            \n                                            createOrUpdate.complete();\n          \n          \n            \n                                        } else {\n          \n          \n            \n                                            createOrUpdate.fail(statusResult.cause());\n          \n          \n            \n                                        }\n          \n          \n            \n                                    });\n          \n          \n            \n                                } else {\n          \n          \n            \n                                    if (createOrUpdateResult.cause() instanceof ReconciliationException) {\n          \n          \n            \n                                        ReconciliationException e = (ReconciliationException) createOrUpdateResult.cause();\n          \n          \n            \n                                        Status status = e.getStatus();\n          \n          \n            \n            \n          \n          \n            \n                                        log.error(\"{}: createOrUpdate failed\", reconciliation, e.getCause());\n          \n          \n            \n            \n          \n          \n            \n                                        updateStatus(reconciliation, (S) status, unknownAndDeprecatedConditions).onComplete(statusResult -> {\n          \n          \n            \n                                            createOrUpdate.fail(e.getCause());\n          \n          \n            \n                                        });\n          \n          \n            \n                                    } else {\n          \n          \n            \n                                        log.error(\"{}: createOrUpdate failed\", reconciliation, createOrUpdateResult.cause());\n          \n          \n            \n                                        createOrUpdate.fail(createOrUpdateResult.cause());\n          \n          \n            \n                                    }\n          \n          \n            \n                                }\n          \n          \n            \n                            });\n          \n          \n            \n                            createOrUpdate(reconciliation, cr).compose(status -> {\n          \n          \n            \n                                 updateStatus(reconciliation, status, unknownAndDeprecatedConditions)\n          \n          \n            \n                                    .onComplete(statusResult -> {\n          \n          \n            \n                                        if (statusResult.succeeded())   {\n          \n          \n            \n                                            createOrUpdate.complete();\n          \n          \n            \n                                        } else {\n          \n          \n            \n                                            createOrUpdate.fail(statusResult.cause());\n          \n          \n            \n                                        }\n          \n          \n            \n                                    });\n          \n          \n            \n                                }, error -> {\n          \n          \n            \n                                    if (error instanceof ReconciliationException) {\n          \n          \n            \n                                        ReconciliationException e = (ReconciliationException) error;\n          \n          \n            \n                                        Status status = e.getStatus();\n          \n          \n            \n            \n          \n          \n            \n                                        log.error(\"{}: createOrUpdate failed\", reconciliation, e.getCause());\n          \n          \n            \n            \n          \n          \n            \n                                        updateStatus(reconciliation, (S) status, unknownAndDeprecatedConditions).onComplete(statusResult -> {\n          \n          \n            \n                                            createOrUpdate.fail(e.getCause());\n          \n          \n            \n                                        });\n          \n          \n            \n                                    } else {\n          \n          \n            \n                                        log.error(\"{}: createOrUpdate failed\", reconciliation, error);\n          \n          \n            \n                                        createOrUpdate.fail(error);\n          \n          \n            \n                                    }\n          \n          \n            \n                                }\n          \n          \n            \n                            });", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486178804", "createdAt": "2020-09-10T08:59:13Z", "author": {"login": "samuel-hawker"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/AbstractOperator.java", "diffHunk": "@@ -168,13 +182,61 @@ private String getLockName(String namespace, String name) {\n \n         Future<Void> handler = withLock(reconciliation, LOCK_TIMEOUT_MS, () -> {\n             T cr = resourceOperator.get(namespace, name);\n+\n             if (cr != null) {\n-                validate(cr);\n+                List<Condition> unknownAndDeprecatedConditions = validate(cr);\n+                Promise<Void> createOrUpdate = Promise.promise();\n+\n+                if (cr.getSpec() == null)   {\n+                    InvalidResourceException exception = new InvalidResourceException(\"Spec cannot be null\");\n+\n+                    S status = createStatus();\n+                    Condition errorCondition = new ConditionBuilder()\n+                            .withLastTransitionTime(StatusUtils.iso8601Now())\n+                            .withType(\"NotReady\")\n+                            .withStatus(\"True\")\n+                            .withReason(exception.getClass().getSimpleName())\n+                            .withMessage(exception.getMessage())\n+                            .build();\n+                    status.addCondition(errorCondition);\n+\n+                    log.error(\"{}: {} spec cannot be null\", reconciliation, cr.getMetadata().getName());\n+                    updateStatus(reconciliation, status, unknownAndDeprecatedConditions).onComplete(statusResult -> {\n+                        createOrUpdate.fail(exception);\n+                    });\n+\n+                    return createOrUpdate.future();\n+                }\n+\n                 log.info(\"{}: {} {} should be created or updated\", reconciliation, kind, name);\n-                return createOrUpdate(reconciliation, cr).recover(createResult -> {\n-                    log.error(\"{}: createOrUpdate failed\", reconciliation, createResult);\n-                    return Future.failedFuture(createResult);\n+\n+                createOrUpdate(reconciliation, cr).onComplete(createOrUpdateResult -> {\n+                    if (createOrUpdateResult.succeeded())    {\n+                        updateStatus(reconciliation, createOrUpdateResult.result(), unknownAndDeprecatedConditions).onComplete(statusResult -> {\n+                            if (statusResult.succeeded())   {\n+                                createOrUpdate.complete();\n+                            } else {\n+                                createOrUpdate.fail(statusResult.cause());\n+                            }\n+                        });\n+                    } else {\n+                        if (createOrUpdateResult.cause() instanceof ReconciliationException) {\n+                            ReconciliationException e = (ReconciliationException) createOrUpdateResult.cause();\n+                            Status status = e.getStatus();\n+\n+                            log.error(\"{}: createOrUpdate failed\", reconciliation, e.getCause());\n+\n+                            updateStatus(reconciliation, (S) status, unknownAndDeprecatedConditions).onComplete(statusResult -> {\n+                                createOrUpdate.fail(e.getCause());\n+                            });\n+                        } else {\n+                            log.error(\"{}: createOrUpdate failed\", reconciliation, createOrUpdateResult.cause());\n+                            createOrUpdate.fail(createOrUpdateResult.cause());\n+                        }\n+                    }\n                 });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE4MDQ1NQ==", "bodyText": "if the get fails, we just hang until timeout as the promise is never addressed. We should use a failure handler (preferably with a compose(successhandler, failhandler)", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486180455", "createdAt": "2020-09-10T09:01:48Z", "author": {"login": "samuel-hawker"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/AbstractOperator.java", "diffHunk": "@@ -200,6 +262,75 @@ private String getLockName(String namespace, String name) {\n         return result.future();\n     }\n \n+\n+\n+    /**\n+     * Updates the Status field of the Kafka CR. It diffs the desired status against the current status and calls\n+     * the update only when there is any difference in non-timestamp fields.\n+     *\n+     * @param desiredStatus The KafkaStatus which should be set\n+     *\n+     * @return\n+     */\n+    Future<Void> updateStatus(Reconciliation reconciliation, S desiredStatus, List<Condition> unknownAndDeprecatedConditions) {\n+        if (desiredStatus == null)  {\n+            log.debug(\"{}: Desired status is null - status will not be updated\", reconciliation);\n+            return Future.succeededFuture();\n+        }\n+\n+        String namespace = reconciliation.namespace();\n+        String name = reconciliation.name();\n+        desiredStatus.addConditions(unknownAndDeprecatedConditions);\n+\n+        Promise<Void> updateStatusPromise = Promise.promise();\n+\n+        resourceOperator.getAsync(namespace, name).onComplete(getRes -> {\n+            if (getRes.succeeded())    {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 196}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE4Mjg3OA==", "bodyText": "What is the purpose behind a new type of exception here?\nJust so that a status can be retreieved from it?\nWouldn't it make sense for the reconciler to catch any exceptions and construct the status prior to ending the reconcile?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r486182878", "createdAt": "2020-09-10T09:05:42Z", "author": {"login": "samuel-hawker"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/ReconciliationException.java", "diffHunk": "@@ -0,0 +1,20 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.operator.common;\n+\n+import io.strimzi.api.kafka.model.status.Status;\n+\n+public class ReconciliationException extends Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3027e7efa3b8a25ee406de4acc58b1fa99b5133"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NDgwMDgx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#pullrequestreview-487480081", "createdAt": "2020-09-14T07:24:44Z", "commit": {"oid": "bd0a89ff751d9dba1d802bac443f7cd204a63e44"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNzoyNDo0NFrOHRHAew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwNzoyOTo1M1rOHRHKgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcwMjY1MQ==", "bodyText": "\"generic status\"?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r487702651", "createdAt": "2020-09-14T07:24:44Z", "author": {"login": "ppatierno"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/Spec.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.api.kafka.model;\n+\n+import com.fasterxml.jackson.annotation.JsonInclude;\n+import io.sundr.builder.annotations.Buildable;\n+import lombok.EqualsAndHashCode;\n+import lombok.ToString;\n+\n+import java.io.Serializable;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.emptyMap;\n+\n+/**\n+ * Represents a generic status which can be used across different resources", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0a89ff751d9dba1d802bac443f7cd204a63e44"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcwMzU0Mg==", "bodyText": "is readyCondition really a good name in this case when you are setting an \"error/warning\" condition?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r487703542", "createdAt": "2020-09-14T07:26:31Z", "author": {"login": "ppatierno"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -234,26 +234,10 @@ public KafkaAssemblyOperator(Vertx vertx, PlatformFeaturesAvailability pfa,\n                         .withReason(reconcileResult.cause().getClass().getSimpleName())\n                         .withMessage(reconcileResult.cause().getMessage())\n                         .build();\n-            }\n \n-            status.addCondition(readyCondition);\n-            reconcileState.updateStatus(status).onComplete(statusResult -> {\n-                if (statusResult.succeeded())    {\n-                    log.debug(\"Status for {} is up to date\", kafkaAssembly.getMetadata().getName());\n-                } else {\n-                    log.error(\"Failed to set status for {}\", kafkaAssembly.getMetadata().getName());\n-                }\n-\n-                // If both features succeeded, createOrUpdate succeeded as well\n-                // If one or both of them failed, we prefer the reconciliation failure as the main error\n-                if (reconcileResult.succeeded() && statusResult.succeeded())    {\n-                    createOrUpdatePromise.complete();\n-                } else if (reconcileResult.failed())    {\n-                    createOrUpdatePromise.fail(reconcileResult.cause());\n-                } else {\n-                    createOrUpdatePromise.fail(statusResult.cause());\n-                }\n-            });\n+                status.addCondition(readyCondition);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0a89ff751d9dba1d802bac443f7cd204a63e44"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcwNDgyMA==", "bodyText": "can we remove this?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r487704820", "createdAt": "2020-09-14T07:29:01Z", "author": {"login": "ppatierno"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/AbstractOperator.java", "diffHunk": "@@ -200,6 +267,64 @@ private String getLockName(String namespace, String name) {\n         return result.future();\n     }\n \n+    private void addWarningsToStatus(Status status, Set<Condition> unknownAndDeprecatedConditions)   {\n+        if (status != null)  {\n+            status.addConditions(unknownAndDeprecatedConditions);\n+        }\n+    }\n+\n+    /**\n+     * Updates the Status field of the Kafka CR. It diffs the desired status against the current status and calls\n+     * the update only when there is any difference in non-timestamp fields.\n+     *\n+     * @param reconciliation the reconciliation identified\n+     * @param desiredStatus The KafkaStatus which should be set\n+     *\n+     * @return\n+     */\n+    Future<Void> updateStatus(Reconciliation reconciliation, S desiredStatus) {\n+        if (desiredStatus == null)  {\n+            log.debug(\"{}: Desired status is null - status will not be updated\", reconciliation);\n+            return Future.succeededFuture();\n+        }\n+\n+        String namespace = reconciliation.namespace();\n+        String name = reconciliation.name();\n+\n+        return resourceOperator.getAsync(namespace, name)\n+                .compose(res -> {\n+                    if (res != null) {\n+                        S currentStatus = res.getStatus();\n+                        StatusDiff sDiff = new StatusDiff(currentStatus, desiredStatus);\n+\n+                        if (!sDiff.isEmpty()) {\n+                            //T copiedResource = copyResource(res);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0a89ff751d9dba1d802bac443f7cd204a63e44"}, "originalPosition": 211}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzcwNTIxOQ==", "bodyText": "Let's remove this \"Haaa\" :-D", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#discussion_r487705219", "createdAt": "2020-09-14T07:29:53Z", "author": {"login": "ppatierno"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/model/ValidationVisitor.java", "diffHunk": "@@ -100,14 +128,17 @@ private String path(List<String> path, String propertyName) {\n \n     @Override\n     public void visitObject(List<String> path, Object object) {\n+        //System.out.println(\"Haaa\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0a89ff751d9dba1d802bac443f7cd204a63e44"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMjY2Mzkx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#pullrequestreview-490266391", "createdAt": "2020-09-17T06:03:47Z", "commit": {"oid": "c59d6a75b8a941ab5fc8a558a36387fa48db768d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMjg1MjUx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#pullrequestreview-490285251", "createdAt": "2020-09-17T06:42:29Z", "commit": {"oid": "c59d6a75b8a941ab5fc8a558a36387fa48db768d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba03492f88cf5d93f859810731f2121c321117e0", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ba03492f88cf5d93f859810731f2121c321117e0", "committedDate": "2020-09-17T08:12:32Z", "message": "Redesigned unknown and deprecated fields in resource status conditions\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb575d223579fd86bd2caa42d426de353164ee1e", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/eb575d223579fd86bd2caa42d426de353164ee1e", "committedDate": "2020-09-17T08:25:47Z", "message": "Review comments - still WiP\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "273c50a146e02180900de8e91ebf71c985928df8", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/273c50a146e02180900de8e91ebf71c985928df8", "committedDate": "2020-09-17T08:27:21Z", "message": "Fix tests\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6f5c59a7cd3e2b34f4991613012dea971c8a027", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b6f5c59a7cd3e2b34f4991613012dea971c8a027", "committedDate": "2020-09-17T08:27:22Z", "message": "Code cleanup\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f24190c5e4bccc3c2f2cf6f51df04ce107c07297", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f24190c5e4bccc3c2f2cf6f51df04ce107c07297", "committedDate": "2020-09-17T08:27:22Z", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMzYyODYw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3623#pullrequestreview-490362860", "createdAt": "2020-09-17T08:31:09Z", "commit": {"oid": "c59d6a75b8a941ab5fc8a558a36387fa48db768d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c59d6a75b8a941ab5fc8a558a36387fa48db768d", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c59d6a75b8a941ab5fc8a558a36387fa48db768d", "committedDate": "2020-09-14T08:04:15Z", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}, "afterCommit": {"oid": "f24190c5e4bccc3c2f2cf6f51df04ce107c07297", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f24190c5e4bccc3c2f2cf6f51df04ce107c07297", "committedDate": "2020-09-17T08:27:22Z", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 960, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}