{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MzkxMTU3", "number": 2695, "title": "Connector conditional put", "bodyText": "Type of change\n\nBugfix\n\nDescription\nThis PR fixes #2688 and adds a test for it. The fix is pretty simple: Get the connector config from the REST API and only update if the config differs. To do this I had to add a new method to the REST API client.\nThe PR also adds an integration test which runs the reconcileConnector() method against a real Kafka Connect cluster.\nChecklist\nPlease go through this checklist and make sure all applicable tasks have been done\n\n Update/write design documentation in ./design\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md", "createdAt": "2020-03-12T18:01:00Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2695", "merged": true, "mergeCommit": {"oid": "ad9d70ae8226a67fc19dfd3cc3c4ea2202d3d32f"}, "closed": true, "closedAt": "2020-03-12T20:14:18Z", "author": {"login": "tombentley"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM-ftDgH2gAyMzg3MzkxMTU3OmE3YWNkYjViNGQxMWNiYjg2ODBjMmE2ZGNjNWU1MGFkYTg0MWRjYmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNAeKzgH2gAyMzg3MzkxMTU3OjRiNjE3YjNiNDMyYjQ3ZGU5YmJhMDFmYTBhY2ZhMzMzYWY5NmIzMmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a7acdb5b4d11cbb8680c2a6dcc5e50ada841dcbe", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a7acdb5b4d11cbb8680c2a6dcc5e50ada841dcbe", "committedDate": "2020-03-12T16:41:55Z", "message": "Only reconcile connectors if they don't exist or have different config\n\nThis fixes #2688 where unconditionally doing the PUT request\ncaused connector to reconfigure which caused status update when caused\nreconciliation ad infinitum.\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a26b6e929f73bb6068c68771604c28ce178b03e8", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a26b6e929f73bb6068c68771604c28ce178b03e8", "committedDate": "2020-03-12T16:42:28Z", "message": "Refactor KafkaConnectApi a little to remove some dupe code.\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8d9fef9852d070d5ade988c04ecfe7acb2dad35", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d8d9fef9852d070d5ade988c04ecfe7acb2dad35", "committedDate": "2020-03-12T16:42:41Z", "message": "test for #2688\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38d85c3e4aed5646c0d6e0d53b445f47f28032fe", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/38d85c3e4aed5646c0d6e0d53b445f47f28032fe", "committedDate": "2020-03-12T17:59:37Z", "message": "Checkstyle, fix test\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNzkwMTIx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2695#pullrequestreview-373790121", "createdAt": "2020-03-12T18:10:46Z", "commit": {"oid": "38d85c3e4aed5646c0d6e0d53b445f47f28032fe"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODoxMDo0NlrOF1pyEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxODoxNDoyN1rOF1p5tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwMzQxMQ==", "bodyText": "Should this be really info level?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2695#discussion_r391803411", "createdAt": "2020-03-12T18:10:46Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/AbstractConnectOperator.java", "diffHunk": "@@ -333,40 +338,95 @@ protected KafkaConnectApi getKafkaConnectApi() {\n         }\n     }\n \n-    protected Future<Map<String, Object>> createOrUpdateConnector(Reconciliation reconciliation, String host, KafkaConnectApi apiClient, \n-            String connectorName, KafkaConnectorSpec connectorSpec) {\n-        return apiClient.createOrUpdatePutRequest(host, KafkaConnectCluster.REST_API_PORT, connectorName, asJson(connectorSpec))\n-            .compose(ignored -> apiClient.statusWithBackOff(new BackOff(200L, 2, 6), host, KafkaConnectCluster.REST_API_PORT,\n-                    connectorName))\n-            .compose(status -> {\n-                Object path = ((Map) status.getOrDefault(\"connector\", emptyMap())).get(\"state\");\n-                if (!(path instanceof String)) {\n-                    return Future.failedFuture(\"JSON response lacked $.connector.state\");\n+    /**\n+     * Try to get the current connector config. If the connector does not exist, or its config differs from the \n+     * {@code connectorSpec}'s, then call\n+     * {@link #createOrUpdateConnector(Reconciliation, String, KafkaConnectApi, String, KafkaConnectorSpec)}\n+     * otherwise, just return the connectors current state.\n+     * @param reconciliation The reconciliation.\n+     * @param host The REST API host.\n+     * @param apiClient The client instance.\n+     * @param connectorName The connector name.\n+     * @param connectorSpec The desired connector spec.\n+     * @return A Future whose result, when successfully completed, is a map of the current connector state.\n+     */\n+    protected Future<Map<String, Object>> maybeCreateOrUpdateConnector(Reconciliation reconciliation, String host, KafkaConnectApi apiClient,\n+                                                                       String connectorName, KafkaConnectorSpec connectorSpec) {\n+        return apiClient.getConnectorConfig(new BackOff(200L, 2, 6), host, port, connectorName).compose(\n+            config -> {\n+                if (!needsReconfiguring(reconciliation, connectorName, connectorSpec, config)) {\n+                    log.info(\"{}: Connector {} exists and has desired config, {}=={}\", reconciliation, connectorName, connectorSpec.getConfig(), config);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d85c3e4aed5646c0d6e0d53b445f47f28032fe"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwMzg2Mg==", "bodyText": "Same as above.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2695#discussion_r391803862", "createdAt": "2020-03-12T18:11:34Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/AbstractConnectOperator.java", "diffHunk": "@@ -333,40 +338,95 @@ protected KafkaConnectApi getKafkaConnectApi() {\n         }\n     }\n \n-    protected Future<Map<String, Object>> createOrUpdateConnector(Reconciliation reconciliation, String host, KafkaConnectApi apiClient, \n-            String connectorName, KafkaConnectorSpec connectorSpec) {\n-        return apiClient.createOrUpdatePutRequest(host, KafkaConnectCluster.REST_API_PORT, connectorName, asJson(connectorSpec))\n-            .compose(ignored -> apiClient.statusWithBackOff(new BackOff(200L, 2, 6), host, KafkaConnectCluster.REST_API_PORT,\n-                    connectorName))\n-            .compose(status -> {\n-                Object path = ((Map) status.getOrDefault(\"connector\", emptyMap())).get(\"state\");\n-                if (!(path instanceof String)) {\n-                    return Future.failedFuture(\"JSON response lacked $.connector.state\");\n+    /**\n+     * Try to get the current connector config. If the connector does not exist, or its config differs from the \n+     * {@code connectorSpec}'s, then call\n+     * {@link #createOrUpdateConnector(Reconciliation, String, KafkaConnectApi, String, KafkaConnectorSpec)}\n+     * otherwise, just return the connectors current state.\n+     * @param reconciliation The reconciliation.\n+     * @param host The REST API host.\n+     * @param apiClient The client instance.\n+     * @param connectorName The connector name.\n+     * @param connectorSpec The desired connector spec.\n+     * @return A Future whose result, when successfully completed, is a map of the current connector state.\n+     */\n+    protected Future<Map<String, Object>> maybeCreateOrUpdateConnector(Reconciliation reconciliation, String host, KafkaConnectApi apiClient,\n+                                                                       String connectorName, KafkaConnectorSpec connectorSpec) {\n+        return apiClient.getConnectorConfig(new BackOff(200L, 2, 6), host, port, connectorName).compose(\n+            config -> {\n+                if (!needsReconfiguring(reconciliation, connectorName, connectorSpec, config)) {\n+                    log.info(\"{}: Connector {} exists and has desired config, {}=={}\", reconciliation, connectorName, connectorSpec.getConfig(), config);\n+                    return apiClient.status(host, port, connectorName)\n+                        .compose(status -> {\n+                            return pauseResume(reconciliation, host, apiClient, connectorName, connectorSpec, status);\n+                        });\n                 } else {\n-                    String state = (String) path;\n-                    boolean shouldPause = Boolean.TRUE.equals(connectorSpec.getPause());\n-                    if (\"RUNNING\".equals(state) && shouldPause) {\n-                        log.debug(\"{}: Pausing connector {}\", reconciliation, connectorName);\n-                        return apiClient.pause(host, KafkaConnectCluster.REST_API_PORT,\n-                                connectorName)\n-                                .compose(ignored ->\n-                                        apiClient.status(host, KafkaConnectCluster.REST_API_PORT,\n-                                                connectorName));\n-                    } else if (\"PAUSED\".equals(state) && !shouldPause) {\n-                        log.debug(\"{}: Resuming connector {}\", reconciliation, connectorName);\n-                        return apiClient.resume(host, KafkaConnectCluster.REST_API_PORT,\n-                                connectorName)\n-                                .compose(ignored ->\n-                                        apiClient.status(host, KafkaConnectCluster.REST_API_PORT,\n-                                                connectorName));\n-\n-                    } else {\n-                        return Future.succeededFuture(status);\n-                    }\n+                    log.info(\"{}: Connector {} exists but does not have desired config, {}!={}\", reconciliation, connectorName, connectorSpec.getConfig(), config);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d85c3e4aed5646c0d6e0d53b445f47f28032fe"}, "originalPosition": 137}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwNDU4OA==", "bodyText": "Given the isDebugEnabled I guess this should definitely be debug?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2695#discussion_r391804588", "createdAt": "2020-03-12T18:13:00Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/AbstractConnectOperator.java", "diffHunk": "@@ -333,40 +338,95 @@ protected KafkaConnectApi getKafkaConnectApi() {\n         }\n     }\n \n-    protected Future<Map<String, Object>> createOrUpdateConnector(Reconciliation reconciliation, String host, KafkaConnectApi apiClient, \n-            String connectorName, KafkaConnectorSpec connectorSpec) {\n-        return apiClient.createOrUpdatePutRequest(host, KafkaConnectCluster.REST_API_PORT, connectorName, asJson(connectorSpec))\n-            .compose(ignored -> apiClient.statusWithBackOff(new BackOff(200L, 2, 6), host, KafkaConnectCluster.REST_API_PORT,\n-                    connectorName))\n-            .compose(status -> {\n-                Object path = ((Map) status.getOrDefault(\"connector\", emptyMap())).get(\"state\");\n-                if (!(path instanceof String)) {\n-                    return Future.failedFuture(\"JSON response lacked $.connector.state\");\n+    /**\n+     * Try to get the current connector config. If the connector does not exist, or its config differs from the \n+     * {@code connectorSpec}'s, then call\n+     * {@link #createOrUpdateConnector(Reconciliation, String, KafkaConnectApi, String, KafkaConnectorSpec)}\n+     * otherwise, just return the connectors current state.\n+     * @param reconciliation The reconciliation.\n+     * @param host The REST API host.\n+     * @param apiClient The client instance.\n+     * @param connectorName The connector name.\n+     * @param connectorSpec The desired connector spec.\n+     * @return A Future whose result, when successfully completed, is a map of the current connector state.\n+     */\n+    protected Future<Map<String, Object>> maybeCreateOrUpdateConnector(Reconciliation reconciliation, String host, KafkaConnectApi apiClient,\n+                                                                       String connectorName, KafkaConnectorSpec connectorSpec) {\n+        return apiClient.getConnectorConfig(new BackOff(200L, 2, 6), host, port, connectorName).compose(\n+            config -> {\n+                if (!needsReconfiguring(reconciliation, connectorName, connectorSpec, config)) {\n+                    log.info(\"{}: Connector {} exists and has desired config, {}=={}\", reconciliation, connectorName, connectorSpec.getConfig(), config);\n+                    return apiClient.status(host, port, connectorName)\n+                        .compose(status -> {\n+                            return pauseResume(reconciliation, host, apiClient, connectorName, connectorSpec, status);\n+                        });\n                 } else {\n-                    String state = (String) path;\n-                    boolean shouldPause = Boolean.TRUE.equals(connectorSpec.getPause());\n-                    if (\"RUNNING\".equals(state) && shouldPause) {\n-                        log.debug(\"{}: Pausing connector {}\", reconciliation, connectorName);\n-                        return apiClient.pause(host, KafkaConnectCluster.REST_API_PORT,\n-                                connectorName)\n-                                .compose(ignored ->\n-                                        apiClient.status(host, KafkaConnectCluster.REST_API_PORT,\n-                                                connectorName));\n-                    } else if (\"PAUSED\".equals(state) && !shouldPause) {\n-                        log.debug(\"{}: Resuming connector {}\", reconciliation, connectorName);\n-                        return apiClient.resume(host, KafkaConnectCluster.REST_API_PORT,\n-                                connectorName)\n-                                .compose(ignored ->\n-                                        apiClient.status(host, KafkaConnectCluster.REST_API_PORT,\n-                                                connectorName));\n-\n-                    } else {\n-                        return Future.succeededFuture(status);\n-                    }\n+                    log.info(\"{}: Connector {} exists but does not have desired config, {}!={}\", reconciliation, connectorName, connectorSpec.getConfig(), config);\n+                    return createOrUpdateConnector(reconciliation, host, apiClient, connectorName, connectorSpec);\n+                }\n+            },\n+            error -> {\n+                if (error instanceof ConnectRestException\n+                        && ((ConnectRestException) error).getStatusCode() == 404) {\n+                    log.info(\"{}: Connector {} does not exist\", reconciliation, connectorName);\n+                    return createOrUpdateConnector(reconciliation, host, apiClient, connectorName, connectorSpec);\n+                } else {\n+                    return Future.failedFuture(error);\n                 }\n             });\n     }\n \n+    private boolean needsReconfiguring(Reconciliation reconciliation, String connectorName, KafkaConnectorSpec connectorSpec, Map<String, Object> actual) {\n+        // The actual which comes from Connect API includes tasks.max, connector.class and name,\n+        // which connectorSpec.getConfig() does not\n+        Map<String, Object> desired = log.isDebugEnabled() ? new TreeMap<>(connectorSpec.getConfig()) : new HashMap<>(connectorSpec.getConfig());\n+        desired.put(\"tasks.max\", connectorSpec.getTasksMax().toString());\n+        desired.put(\"name\", connectorName);\n+        desired.put(\"connector.class\", connectorSpec.getClassName());\n+        if (log.isDebugEnabled()) {\n+            log.info(\"{}: Desired: {}\", reconciliation, desired);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d85c3e4aed5646c0d6e0d53b445f47f28032fe"}, "originalPosition": 160}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwNTIyNA==", "bodyText": "debug ot trace level I guess?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2695#discussion_r391805224", "createdAt": "2020-03-12T18:14:09Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaConnectApi.java", "diffHunk": "@@ -89,13 +188,16 @@ public KafkaConnectApiImpl(Vertx vertx) {\n                         response.bodyHandler(buffer -> {\n                             ObjectMapper mapper = new ObjectMapper();\n                             try {\n-                                result.complete(mapper.readValue(buffer.getBytes(), Map.class));\n+                                Map t = mapper.readValue(buffer.getBytes(), Map.class);\n+                                log.info(\"Got {} response to PUT request to {}: {}\", response.statusCode(), path, t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d85c3e4aed5646c0d6e0d53b445f47f28032fe"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwNTM2NQ==", "bodyText": "Again ...", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2695#discussion_r391805365", "createdAt": "2020-03-12T18:14:27Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaConnectApi.java", "diffHunk": "@@ -89,13 +188,16 @@ public KafkaConnectApiImpl(Vertx vertx) {\n                         response.bodyHandler(buffer -> {\n                             ObjectMapper mapper = new ObjectMapper();\n                             try {\n-                                result.complete(mapper.readValue(buffer.getBytes(), Map.class));\n+                                Map t = mapper.readValue(buffer.getBytes(), Map.class);\n+                                log.info(\"Got {} response to PUT request to {}: {}\", response.statusCode(), path, t);\n+                                result.complete(t);\n                             } catch (IOException e) {\n                                 result.fail(new ConnectRestException(response, \"Could not deserialize response: \" + e));\n                             }\n                         });\n                     } else {\n                         // TODO Handle 409 (Conflict) indicating a rebalance in progress\n+                        log.info(\"Got {} response to PUT request to {}\", response.statusCode(), path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38d85c3e4aed5646c0d6e0d53b445f47f28032fe"}, "originalPosition": 149}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "283c2a832c775cfcb46c8f8585a18ef6e1b76744", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/283c2a832c775cfcb46c8f8585a18ef6e1b76744", "committedDate": "2020-03-12T18:55:15Z", "message": "Review comments and less logging for travis\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e62d3416eb824389f47bf218c8ed1bda651844d1", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e62d3416eb824389f47bf218c8ed1bda651844d1", "committedDate": "2020-03-12T18:55:15Z", "message": "Remove unnecessary code\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c8b4297fc5e6a962e4811cca8e901adcbd8c1e0a", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c8b4297fc5e6a962e4811cca8e901adcbd8c1e0a", "committedDate": "2020-03-12T18:50:02Z", "message": "Review comments and less logging for travis\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}, "afterCommit": {"oid": "e62d3416eb824389f47bf218c8ed1bda651844d1", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e62d3416eb824389f47bf218c8ed1bda651844d1", "committedDate": "2020-03-12T18:55:15Z", "message": "Remove unnecessary code\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczODIyMTAy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2695#pullrequestreview-373822102", "createdAt": "2020-03-12T18:57:38Z", "commit": {"oid": "e62d3416eb824389f47bf218c8ed1bda651844d1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b617b3b432b47de9bba01fa0acfa333af96b32b", "author": {"user": {"login": "tombentley", "name": "Tom Bentley"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4b617b3b432b47de9bba01fa0acfa333af96b32b", "committedDate": "2020-03-12T19:00:03Z", "message": "Checkstyle\n\nSigned-off-by: Tom Bentley <tbentley@redhat.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2055, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}