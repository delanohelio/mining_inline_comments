{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMTA3NzQ5", "number": 3438, "title": "[systemtest][mm] Add test for scaling mm to zero", "bodyText": "Signed-off-by: Lukas Kral lukywill16@gmail.com\nType of change\n\nNew test\n\nDescription\nAfter #3412 we are able to deploy (scale) the KafkaMirrorMaker to zero replicas and the resource will be Ready. This PR tests this feature.\nChecklist\n\n Write tests\n Make sure all tests pass", "createdAt": "2020-08-03T10:59:28Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3438", "merged": true, "mergeCommit": {"oid": "4d09e7966c95dfd48aef8e7d4ff7b085d87d9cad"}, "closed": true, "closedAt": "2020-08-04T15:44:42Z", "author": {"login": "im-konge"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7P0LdgH2gAyNDYyMTA3NzQ5OmQ2YzljYjU4N2YyZGM1NTZmNTllM2NmM2UwZGE5Zjg4YjBmZGM3MzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7iXMNgBqjM2MTkxNDc2NDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d6c9cb587f2dc556f59e3cf3e0da9f88b0fdc736", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d6c9cb587f2dc556f59e3cf3e0da9f88b0fdc736", "committedDate": "2020-08-03T10:53:11Z", "message": "add test for scaling mm to zero\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTYzMTIz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3438#pullrequestreview-459963123", "createdAt": "2020-08-03T11:50:12Z", "commit": {"oid": "d6c9cb587f2dc556f59e3cf3e0da9f88b0fdc736"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMTo1MDoxMlrOG62hjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMTo1MDoxMlrOG62hjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM2MzkxOQ==", "bodyText": "How does this ensure that the previous status is not caught by this? I do not see any checks for observed generations etc.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3438#discussion_r464363919", "createdAt": "2020-08-03T11:50:12Z", "author": {"login": "scholzj"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/mirrormaker/MirrorMakerST.java", "diffHunk": "@@ -663,6 +666,36 @@ void testScaleMirrorMakerSubresource() {\n             assertThat(pod.contains(mmGenName), is(true));\n         }\n     }\n+\n+    @Test\n+    void testScaleMirrorMakerToZero() {\n+        // Deploy source kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterSourceName, 1, 1).done();\n+        // Deploy target kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterTargetName, 1, 1).done();\n+\n+        KafkaMirrorMakerResource.kafkaMirrorMaker(CLUSTER_NAME, kafkaClusterTargetName, kafkaClusterSourceName, \"my-group\" + rng.nextInt(Integer.MAX_VALUE), 3, false)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-mirror-maker\")\n+            .endMetadata()\n+            .done();\n+\n+        String mmDepName = KafkaMirrorMakerResources.deploymentName(CLUSTER_NAME);\n+        List<String> mmPods = kubeClient().listPodNames(\"type\", \"kafka-mirror-maker\");\n+        assertThat(mmPods.size(), is(3));\n+\n+        LOGGER.info(\"Scaling MirrorMaker to zero\");\n+        KafkaMirrorMakerResource.replaceMirrorMakerResource(CLUSTER_NAME, mm -> mm.getSpec().setReplicas(0));\n+\n+        KafkaMirrorMakerUtils.waitForKafkaMirrorMakerReady(CLUSTER_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6c9cb587f2dc556f59e3cf3e0da9f88b0fdc736"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTcwNzI0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3438#pullrequestreview-459970724", "createdAt": "2020-08-03T12:04:26Z", "commit": {"oid": "d6c9cb587f2dc556f59e3cf3e0da9f88b0fdc736"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjowNDoyN1rOG6254Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjowNDoyN1rOG6254Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM3MDE0NQ==", "bodyText": "We maybe should take into consideration to create some Enum on CR type statuses. Would be better instead of hardcoding these values", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3438#discussion_r464370145", "createdAt": "2020-08-03T12:04:27Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/mirrormaker/MirrorMakerST.java", "diffHunk": "@@ -663,6 +666,36 @@ void testScaleMirrorMakerSubresource() {\n             assertThat(pod.contains(mmGenName), is(true));\n         }\n     }\n+\n+    @Test\n+    void testScaleMirrorMakerToZero() {\n+        // Deploy source kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterSourceName, 1, 1).done();\n+        // Deploy target kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterTargetName, 1, 1).done();\n+\n+        KafkaMirrorMakerResource.kafkaMirrorMaker(CLUSTER_NAME, kafkaClusterTargetName, kafkaClusterSourceName, \"my-group\" + rng.nextInt(Integer.MAX_VALUE), 3, false)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-mirror-maker\")\n+            .endMetadata()\n+            .done();\n+\n+        String mmDepName = KafkaMirrorMakerResources.deploymentName(CLUSTER_NAME);\n+        List<String> mmPods = kubeClient().listPodNames(\"type\", \"kafka-mirror-maker\");\n+        assertThat(mmPods.size(), is(3));\n+\n+        LOGGER.info(\"Scaling MirrorMaker to zero\");\n+        KafkaMirrorMakerResource.replaceMirrorMakerResource(CLUSTER_NAME, mm -> mm.getSpec().setReplicas(0));\n+\n+        KafkaMirrorMakerUtils.waitForKafkaMirrorMakerReady(CLUSTER_NAME);\n+        PodUtils.waitForPodsReady(kubeClient().getDeploymentSelectors(mmDepName), 0, true);\n+\n+        mmPods = kubeClient().listPodNames(\"type\", \"kafka-mirror-maker\");\n+        KafkaMirrorMakerStatus mmStatus = KafkaMirrorMakerResource.kafkaMirrorMakerClient().inNamespace(NAMESPACE).withName(CLUSTER_NAME).get().getStatus();\n+\n+        assertThat(mmPods.size(), is(0));\n+        assertThat(mmStatus.getConditions().get(0).getType(), is(\"Ready\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6c9cb587f2dc556f59e3cf3e0da9f88b0fdc736"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTcxMDc4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3438#pullrequestreview-459971078", "createdAt": "2020-08-03T12:05:04Z", "commit": {"oid": "d6c9cb587f2dc556f59e3cf3e0da9f88b0fdc736"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fb521fc4e9302fa275b8b29238da33dafa636a1", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0fb521fc4e9302fa275b8b29238da33dafa636a1", "committedDate": "2020-08-03T12:05:29Z", "message": "comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2650395f97f270e238cc52b75841814cb456c684", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2650395f97f270e238cc52b75841814cb456c684", "committedDate": "2020-08-03T12:03:35Z", "message": "comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "0fb521fc4e9302fa275b8b29238da33dafa636a1", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0fb521fc4e9302fa275b8b29238da33dafa636a1", "committedDate": "2020-08-03T12:05:29Z", "message": "comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNTkyNDQ1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3438#pullrequestreview-460592445", "createdAt": "2020-08-04T08:13:23Z", "commit": {"oid": "0fb521fc4e9302fa275b8b29238da33dafa636a1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjAyNTEw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3438#pullrequestreview-460602510", "createdAt": "2020-08-04T08:27:13Z", "commit": {"oid": "a3967ddbb511fcdd0a805b744bc6e3c9ad6a3389"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f70d7a102eb0fc1edf95e78183cca97d9158308e", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f70d7a102eb0fc1edf95e78183cca97d9158308e", "committedDate": "2020-08-04T08:29:31Z", "message": "comment vol.2\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a3967ddbb511fcdd0a805b744bc6e3c9ad6a3389", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a3967ddbb511fcdd0a805b744bc6e3c9ad6a3389", "committedDate": "2020-08-04T08:23:59Z", "message": "comment vol.2\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "f70d7a102eb0fc1edf95e78183cca97d9158308e", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f70d7a102eb0fc1edf95e78183cca97d9158308e", "committedDate": "2020-08-04T08:29:31Z", "message": "comment vol.2\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1075, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}