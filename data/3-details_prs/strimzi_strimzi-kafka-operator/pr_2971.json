{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0MzA2MTc3", "number": 2971, "title": "[systemtest] Fix tests in ListenersST and KafkaST", "bodyText": "Signed-off-by: Lukas Kral lukywill16@gmail.com\nType of change\n\nBugfix\n\nDescription\nThis PR gonna fix some of our failing tests from nightly builds.\nFirst one was in KafkaST -> this problem I tried to fix on different PR, but it was wrong -> problem here is when before we are deleting TO and UO from EO, we got EO pod name and after it's deletion we've waited for pod with name to be deleted. Bad thing is, that after terminating the original EO pod, another one reappeared and terminated, but we already checked that EO pods are on 0. Here was race condition.\nThe last one was in ListenersST and sending messages -> when we tried to send messages with external bootstrap server, it failed. I removed it as we have it in every ST with external services\nChecklist\n\n Write tests\n Make sure all tests pass", "createdAt": "2020-05-06T20:04:55Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2971", "merged": true, "mergeCommit": {"oid": "a82ba16420b54f3a21401e4db44a54c46af5c417"}, "closed": true, "closedAt": "2020-05-11T10:22:07Z", "author": {"login": "im-konge"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceubt1gH2gAyNDE0MzA2MTc3OjRjZTU0NzA4MGRkM2I1YmQ4ZDAwN2QxMWQ4ZTkwMTFhOGE4NTk5MGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgNBbVgFqTQwOTA0NTgxNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4ce547080dd3b5bd8d007d11d8e9011a8a85990a", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4ce547080dd3b5bd8d007d11d8e9011a8a85990a", "committedDate": "2020-05-06T20:09:43Z", "message": "fix failing tests\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b326846fa953ac753648a48a5e078292fc084c3", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6b326846fa953ac753648a48a5e078292fc084c3", "committedDate": "2020-05-06T19:54:01Z", "message": "fix failing tests\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "4ce547080dd3b5bd8d007d11d8e9011a8a85990a", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4ce547080dd3b5bd8d007d11d8e9011a8a85990a", "committedDate": "2020-05-06T20:09:43Z", "message": "fix failing tests\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTU1NTI5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2971#pullrequestreview-406955529", "createdAt": "2020-05-06T20:18:38Z", "commit": {"oid": "4ce547080dd3b5bd8d007d11d8e9011a8a85990a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDoxODozOFrOGRj22A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDoxODozOFrOGRj22A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA2NjQ1Ng==", "bodyText": "You should check the implementation of waitForPodDeletion and reuse it or update", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2971#discussion_r421066456", "createdAt": "2020-05-06T20:18:38Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/KafkaST.java", "diffHunk": "@@ -1031,7 +1030,7 @@ void testRemoveUserAndTopicOperatorsFromEntityOperator() {\n         //Waiting when EO pod will be deleted\n         DeploymentUtils.waitForDeploymentDeletion(eoDeploymentName);\n         ReplicaSetUtils.waitForReplicaSetDeletion(eoDeploymentName);\n-        PodUtils.waitForPodDeletion(eoPodName);\n+        PodUtils.waitForPodDeletionByPrefix(eoDeploymentName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ce547080dd3b5bd8d007d11d8e9011a8a85990a"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74d95871d44d3d8b97a9cd5f40e4f924bc834637", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/74d95871d44d3d8b97a9cd5f40e4f924bc834637", "committedDate": "2020-05-07T08:52:36Z", "message": "fixup! fix failing tests\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cb99d5278483854730a9d8c1c592f2f20f49c642", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/cb99d5278483854730a9d8c1c592f2f20f49c642", "committedDate": "2020-05-07T08:40:30Z", "message": "fixup! fix failing tests\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "74d95871d44d3d8b97a9cd5f40e4f924bc834637", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/74d95871d44d3d8b97a9cd5f40e4f924bc834637", "committedDate": "2020-05-07T08:52:36Z", "message": "fixup! fix failing tests\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3Mjg4NDM1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2971#pullrequestreview-407288435", "createdAt": "2020-05-07T09:11:07Z", "commit": {"oid": "74d95871d44d3d8b97a9cd5f40e4f924bc834637"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MzU1NTYz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2971#pullrequestreview-407355563", "createdAt": "2020-05-07T10:46:01Z", "commit": {"oid": "74d95871d44d3d8b97a9cd5f40e4f924bc834637"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4OTgzMzMz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2971#pullrequestreview-408983333", "createdAt": "2020-05-11T08:54:52Z", "commit": {"oid": "74d95871d44d3d8b97a9cd5f40e4f924bc834637"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODo1NDo1M1rOGTS-iQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwODo1NDo1M1rOGTS-iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg4NzA0OQ==", "bodyText": "I think this is a bit confusing. The method name says waitForPodDeletion - so I expect it that not delete anything, just wait for it to be deleted. Yet the message Pod xyz could not be deleted suggests this is actually a method deleting the pod? I think we should rename this method to something more matching for what it does ... e.g. deletePodWithWait, deletePodSync etc.\nIf you wanna do that in separate PR, that should be fine. But it should be fixed because when you read in the code waitForPodDeletion you do not expect it to delete anything. I also don't think this makes any sense form the test perspective. You want the CO to delete the pod. Not delete it your self.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2971#discussion_r422887049", "createdAt": "2020-05-11T08:54:53Z", "author": {"login": "scholzj"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kubeUtils/objects/PodUtils.java", "diffHunk": "@@ -144,19 +144,19 @@ public static void waitForPod(String name) {\n     public static void waitForPodDeletion(String name) {\n         LOGGER.info(\"Waiting when Pod {} will be deleted\", name);\n \n-        if (kubeClient().listPodsByPrefixInName(name).size() != 0) {\n-            TestUtils.waitFor(\"Pod \" + name + \" could not be deleted\", Constants.POLL_INTERVAL_FOR_RESOURCE_DELETION, Constants.TIMEOUT_FOR_POD_DELETION,\n-                () -> {\n-                    Pod pod = kubeClient().getPod(name);\n-                    if (pod == null) {\n-                        return true;\n-                    } else {\n+        TestUtils.waitFor(\"Pod \" + name + \" could not be deleted\", Constants.POLL_INTERVAL_FOR_RESOURCE_DELETION, Constants.TIMEOUT_FOR_POD_DELETION,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "74d95871d44d3d8b97a9cd5f40e4f924bc834637"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDQ1ODE0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2971#pullrequestreview-409045814", "createdAt": "2020-05-11T10:21:59Z", "commit": {"oid": "74d95871d44d3d8b97a9cd5f40e4f924bc834637"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1643, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}