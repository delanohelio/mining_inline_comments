{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NjE4OTgz", "number": 3858, "title": "Jaas config secret", "bodyText": "Type of change\nSelect the type of your PR\n\nEnhancement / new feature\n\nDescription\nThis adds  sasl.jaas.config property for SASL/SCRAM authentication to the generated secret.\nSee #3332\nChecklist\nPlease go through this checklist and make sure all applicable tasks have been done\n\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md\n Supply screenshots for visual changes, such as Grafana dashboards", "createdAt": "2020-10-22T23:54:06Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858", "merged": true, "mergeCommit": {"oid": "58f1f60a69c7eda1ee4be2a8997a2412d3bbd301"}, "closed": true, "closedAt": "2020-10-24T15:38:40Z", "author": {"login": "allanmoso"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVLDyKAH2gAyNTA4NjE4OTgzOjJiNGFjNDkwOGRiOWNjYzk0OGIzMTc1ZGVkNjg0NDhlY2VlMzAwMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVownegFqTUxNjI2Nzc5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2b4ac4908db9ccc948b3175ded68448ecee30006", "author": {"user": {"login": "allanmoso", "name": "Allan Moso"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2b4ac4908db9ccc948b3175ded68448ecee30006", "committedDate": "2020-10-23T00:02:44Z", "message": "Scram user secrets now includes sasl.jaas.config string.\n\nSigned-off-by: Allan Moso <allan.moso@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39f042aba31d11ae6fd58af4cdc850af7f7cfda5", "author": {"user": {"login": "allanmoso", "name": "Allan Moso"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/39f042aba31d11ae6fd58af4cdc850af7f7cfda5", "committedDate": "2020-10-23T00:02:44Z", "message": "Updated documentation with sasl.jaas.config.\n\nSigned-off-by: Allan Moso <allan.moso@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a91ce605d64f66064cbfb05a0cc116dc9d22141f", "author": {"user": {"login": "allanmoso", "name": "Allan Moso"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a91ce605d64f66064cbfb05a0cc116dc9d22141f", "committedDate": "2020-10-22T23:51:14Z", "message": "Updated documentation with sasl.jaas.config."}, "afterCommit": {"oid": "39f042aba31d11ae6fd58af4cdc850af7f7cfda5", "author": {"user": {"login": "allanmoso", "name": "Allan Moso"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/39f042aba31d11ae6fd58af4cdc850af7f7cfda5", "committedDate": "2020-10-23T00:02:44Z", "message": "Updated documentation with sasl.jaas.config.\n\nSigned-off-by: Allan Moso <allan.moso@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cf627554715ff510ad30bafab6313bef6f94775", "author": {"user": {"login": "allanmoso", "name": "Allan Moso"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5cf627554715ff510ad30bafab6313bef6f94775", "committedDate": "2020-10-23T00:08:35Z", "message": "Updated CHANGELOG.md with sasl.jaas.config.\n\nSigned-off-by: Allan Moso <allan.moso@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b96bd0877251dac09b18fa123cb221ee751d3477", "author": {"user": {"login": "allanmoso", "name": "Allan Moso"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b96bd0877251dac09b18fa123cb221ee751d3477", "committedDate": "2020-10-23T00:06:35Z", "message": "Updated CHANGELOG.md with sasl.jaas.config."}, "afterCommit": {"oid": "5cf627554715ff510ad30bafab6313bef6f94775", "author": {"user": {"login": "allanmoso", "name": "Allan Moso"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5cf627554715ff510ad30bafab6313bef6f94775", "committedDate": "2020-10-23T00:08:35Z", "message": "Updated CHANGELOG.md with sasl.jaas.config.\n\nSigned-off-by: Allan Moso <allan.moso@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NDA5Mjg1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#pullrequestreview-515409285", "createdAt": "2020-10-23T07:28:52Z", "commit": {"oid": "5cf627554715ff510ad30bafab6313bef6f94775"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwNzoyODo1M1rOHnB7JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwNzozOToxNlrOHnCPrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4ODAzNg==", "bodyText": "The above HashMap size should be 2.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r510688036", "createdAt": "2020-10-23T07:28:53Z", "author": {"login": "ppatierno"}, "path": "user-operator/src/main/java/io/strimzi/operator/user/model/KafkaUserModel.java", "diffHunk": "@@ -158,7 +159,8 @@ public Secret generateSecret()  {\n             return createSecret(data);\n         } else if (authentication instanceof KafkaUserScramSha512ClientAuthentication) {\n             Map<String, String> data = new HashMap<>(1);\n-            data.put(KafkaUserModel.KEY_PASSWORD, Base64.getEncoder().encodeToString(scramSha512Password.getBytes(StandardCharsets.US_ASCII)));\n+            data.put(KafkaUserModel.KEY_PASSWORD, Base64.getEncoder().encodeToString(this.scramSha512Password.getBytes(StandardCharsets.US_ASCII)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cf627554715ff510ad30bafab6313bef6f94775"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4ODI4OQ==", "bodyText": "can you explicit KafkaUserModel.KEY_SASL_JAAS_CONFIG as for the other field please?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r510688289", "createdAt": "2020-10-23T07:29:19Z", "author": {"login": "ppatierno"}, "path": "user-operator/src/main/java/io/strimzi/operator/user/model/KafkaUserModel.java", "diffHunk": "@@ -158,7 +159,8 @@ public Secret generateSecret()  {\n             return createSecret(data);\n         } else if (authentication instanceof KafkaUserScramSha512ClientAuthentication) {\n             Map<String, String> data = new HashMap<>(1);\n-            data.put(KafkaUserModel.KEY_PASSWORD, Base64.getEncoder().encodeToString(scramSha512Password.getBytes(StandardCharsets.US_ASCII)));\n+            data.put(KafkaUserModel.KEY_PASSWORD, Base64.getEncoder().encodeToString(this.scramSha512Password.getBytes(StandardCharsets.US_ASCII)));\n+            data.put(KEY_SASL_JAAS_CONFIG, Base64.getEncoder().encodeToString(getSaslJsonConfig().getBytes(StandardCharsets.US_ASCII)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cf627554715ff510ad30bafab6313bef6f94775"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4OTI3OQ==", "bodyText": "I would not use the field name to explain the field itself. It would be better saying something like \"The JAAS configuration string for SASL SCRAM-SHA-512 authentication\".", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r510689279", "createdAt": "2020-10-23T07:31:13Z", "author": {"login": "ppatierno"}, "path": "documentation/modules/con-securing-client-authentication.adoc", "diffHunk": "@@ -103,8 +103,10 @@ metadata:\n type: Opaque\n data:\n   password: Z2VuZXJhdGVkcGFzc3dvcmQ= <1>\n+  sasl.jaas.config: b3JnLmFwYWNoZS5rYWZrYS5jb21tb24uc2VjdXJpdHkuc2NyYW0uU2NyYW1Mb2dpbk1vZHVsZSByZXF1aXJlZCB1c2VybmFtZT0ibXktdXNlciIgcGFzc3dvcmQ9ImdlbmVyYXRlZHBhc3N3b3JkIjsK <2>\n ----\n <1> The generated password, base64 encoded.\n+<2> The `sasl.jaas.config` string, base64 encoded.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cf627554715ff510ad30bafab6313bef6f94775"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY4OTg1MQ==", "bodyText": "It's better to not use just the field name but explaining what it is, so for example.\n\"Add the JAAS configuration string in the sasl.jaas.config property to the generated secrets for KafkaUser with SCRAM-SHA-512 authentication\"", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r510689851", "createdAt": "2020-10-23T07:32:24Z", "author": {"login": "ppatierno"}, "path": "CHANGELOG.md", "diffHunk": "@@ -4,6 +4,7 @@\n \n * Add support for `secretPrefix` property for User Operator to prefix all secret names created from KafkaUser resource.\n * Allow configuring labels and annotations for Cluster CA certificate secrets\n+* Add `sasl.jaas.config` to generated secrets for KafkaUser with SCRAM-SHA-512 authentication.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cf627554715ff510ad30bafab6313bef6f94775"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5MTMyNQ==", "bodyText": "As usual not use the field name, explicit what the parameter represents.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r510691325", "createdAt": "2020-10-23T07:35:22Z", "author": {"login": "ppatierno"}, "path": "user-operator/src/main/java/io/strimzi/operator/user/model/KafkaUserModel.java", "diffHunk": "@@ -394,6 +396,17 @@ public static String getSecretName(String secretPrefix, String username)    {\n         return secretPrefix + username;\n     }\n \n+    /**\n+     * Creates the sasl.jaas.config string for SASL/SCRAM authentication.\n+     *\n+     * @param username The SCRAM username.\n+     * @param password The SCRAM password.\n+     * @return The sasl.jaas.config string.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cf627554715ff510ad30bafab6313bef6f94775"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5MTU4MA==", "bodyText": "ditto as already mentioned both for description and parameter.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r510691580", "createdAt": "2020-10-23T07:35:51Z", "author": {"login": "ppatierno"}, "path": "user-operator/src/main/java/io/strimzi/operator/user/model/KafkaUserModel.java", "diffHunk": "@@ -482,4 +495,14 @@ public boolean isScramUser()  {\n     public boolean isNoneUser()  {\n         return authentication == null;\n     }\n+\n+    /**\n+     * Creates the sasl.jaas.config string for SASL/SCRAM authentication.\n+     *\n+     * @return The sasl.jaas.config string.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cf627554715ff510ad30bafab6313bef6f94775"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5MzI5Mw==", "bodyText": "I think you are just testing that the base64 encoding (on Kafka user creation) and the decoding (in the assert) are working not that it returns the JAAS string you would expect. You should also have the expected string somewhere to do the assertation that it's corrected.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#discussion_r510693293", "createdAt": "2020-10-23T07:39:16Z", "author": {"login": "ppatierno"}, "path": "user-operator/src/test/java/io/strimzi/operator/user/model/KafkaUserModelTest.java", "diffHunk": "@@ -297,8 +298,12 @@ public void testGenerateSecretGeneratesPasswordWhenNoUserSecretExists()    {\n                         .withKubernetesManagedBy(KafkaUserModel.KAFKA_USER_OPERATOR_NAME)\n                         .toMap()));\n \n-        assertThat(generatedSecret.getData().keySet(), is(singleton(KafkaUserModel.KEY_PASSWORD)));\n-        assertThat(new String(Base64.getDecoder().decode(generatedSecret.getData().get(KafkaUserModel.KEY_PASSWORD))), is(\"aaaaaaaaaa\"));\n+        assertThat(generatedSecret.getData().keySet(), is(new HashSet<>(Arrays.asList(KafkaUserModel.KEY_PASSWORD, KafkaUserModel.KEY_SASL_JAAS_CONFIG))));\n+\n+        String password = \"aaaaaaaaaa\";\n+        assertThat(new String(Base64.getDecoder().decode(generatedSecret.getData().get(KafkaUserModel.KEY_PASSWORD))), is(password));\n+        assertThat(new String(Base64.getDecoder().decode(generatedSecret.getData().get(KafkaUserModel.KEY_SASL_JAAS_CONFIG))),\n+                is(KafkaUserModel.getSaslJsonConfig(ResourceUtils.NAME, password)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cf627554715ff510ad30bafab6313bef6f94775"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8e7af525222c7544931294d437f0021718e078a", "author": {"user": {"login": "allanmoso", "name": "Allan Moso"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c8e7af525222c7544931294d437f0021718e078a", "committedDate": "2020-10-23T17:39:36Z", "message": "PR feedback changes: updated docs and test.\n\nSigned-off-by: Allan Moso <allan.moso@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MjY2NDI1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#pullrequestreview-516266425", "createdAt": "2020-10-24T10:14:17Z", "commit": {"oid": "c8e7af525222c7544931294d437f0021718e078a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2MjY3Nzk2", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3858#pullrequestreview-516267796", "createdAt": "2020-10-24T10:38:57Z", "commit": {"oid": "c8e7af525222c7544931294d437f0021718e078a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 851, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}