{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3NzA3NjYw", "number": 4005, "title": "Improve Strimzi network policies for Cluster Operator access", "bodyText": "Type of change\n\nEnhancement / new feature\n\nDescription\nCluster Operator (CO) needs access to different operands to operate them and network policies are used to protect the access. However, since the CO might be running in different namespace then the operands, network policies need to allow cross-namespace access. So far we handled it by allowing the access to all CO pods running in any namespace (namespaceSelector: {}). This in general is not an issue since it still limits the access to CO pods and it is not the only security (TLS client authentication is used as well). However, this is more opened then it has to be and we should look at how it can be improved.\nSince we do not control the namespaces, we cannot easily set the namespaceSelector to some specific labels. We cannot just label the namespace, since that would need additional labels to be set by the operator, but they can be also deleted by any user tooling. However, there are still things we can improve:\n\nWhen CO runs in the same namespace as the operand, we can detect it and allow only local access\nWhen user provides us the namespace labels, we can use them\n\nBoth of these are implemented in this PR.\nFor the first, this PR adds new environment variable STRIMZI_OPERATOR_NAMESPACE (not to confuse with STRIMZI_NAMESPACE) which uses the Kubernetes Downward API to find out in which namespace is the operator running. If it is the same as the operand, the namespaceSelector is left out from the network policies. This environment variable is automatically added to our deployments (both YMALs and Helm Charts).\nFor the second, this PR adds new environment variable STRIMZI_OPERATOR_NAMESPACE_LABELS. This env var is optional and not set by default. But it can be configured by the user and if set, the labels passed through it will be used for the network policies. For example STRIMZI_OPERATOR_NAMESPACE_LABELS set to co=yes will result in network policies with\n- namespaceSelector:\n    matchLabels:\n      co: \"yes\"\nThis PR also adds very basic docs (adds both env vars to the CO configuration reference) and unit tests.\nChecklist\n\n Write tests\n Make sure all tests pass\n Update documentation\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally", "createdAt": "2020-11-25T21:48:12Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005", "merged": true, "mergeCommit": {"oid": "b774a3966567d908d836be99624383c851f43776"}, "closed": true, "closedAt": "2020-12-01T23:12:07Z", "author": {"login": "scholzj"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgFXEWAH2gAyNTI3NzA3NjYwOmIyZDMxNGI5OGZlMTdjN2IzYjMyNTY0OTI4OTJlOGJlM2VkMjk2OGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh_520gH2gAyNTI3NzA3NjYwOmI0N2E2YTlkODU4ZWU3YThmNjZhMDdjNjkyZGU0YTJmZmU0NDAzZmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b2d314b98fe17c7b3b3256492892e8be3ed2968f", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b2d314b98fe17c7b3b3256492892e8be3ed2968f", "committedDate": "2020-11-25T21:37:32Z", "message": "Improve Strimzi network policies for Cluster Operator access\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxODIwNjUw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#pullrequestreview-541820650", "createdAt": "2020-12-01T11:51:24Z", "commit": {"oid": "b2d314b98fe17c7b3b3256492892e8be3ed2968f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo1MToyNFrOH8pIGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo1MToyNFrOH8pIGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM1MDQyNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            This variable should not be configured manually but should use the Kubernetes Downward API.\n          \n          \n            \n            Do not configure this variable manually. Use the Kubernetes Downward API.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533350425", "createdAt": "2020-12-01T11:51:24Z", "author": {"login": "PaulRMellor"}, "path": "documentation/modules/ref-operator-cluster.adoc", "diffHunk": "@@ -27,6 +27,23 @@ env:\n The timeout for internal operations, in milliseconds. This value should be\n increased when using Strimzi on clusters where regular Kubernetes operations take longer than usual (because of slow downloading of Docker images, for example).\n \n+`STRIMZI_OPERATOR_NAMESPACE`:: The name of the namespace where the Strimzi Cluster Operator is running.\n+This variable should not be configured manually but should use the Kubernetes Downward API.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2d314b98fe17c7b3b3256492892e8be3ed2968f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxODIzODc4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#pullrequestreview-541823878", "createdAt": "2020-12-01T11:55:56Z", "commit": {"oid": "b2d314b98fe17c7b3b3256492892e8be3ed2968f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo1NTo1N1rOH8pSlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo1NTo1N1rOH8pSlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM1MzExMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            These labels will be used to configure the namespace selector in network policies to allow Strimzi Cluster Operator to access the operands only from namespace with these labels.\n          \n          \n            \n            Namespace labels are used to configure the namespace selector in network policies to allow the Strimzi Cluster Operator to only have access to the operands from the namespace with these labels.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533353111", "createdAt": "2020-12-01T11:55:57Z", "author": {"login": "PaulRMellor"}, "path": "documentation/modules/ref-operator-cluster.adoc", "diffHunk": "@@ -27,6 +27,23 @@ env:\n The timeout for internal operations, in milliseconds. This value should be\n increased when using Strimzi on clusters where regular Kubernetes operations take longer than usual (because of slow downloading of Docker images, for example).\n \n+`STRIMZI_OPERATOR_NAMESPACE`:: The name of the namespace where the Strimzi Cluster Operator is running.\n+This variable should not be configured manually but should use the Kubernetes Downward API.\n++\n+[source,yaml,options=\"nowrap\"]\n+----\n+env:\n+  - name: STRIMZI_OPERATOR_NAMESPACE\n+    valueFrom:\n+      fieldRef:\n+        fieldPath: metadata.namespace\n+----\n+\n+`STRIMZI_OPERATOR_NAMESPACE_LABELS`:: Optional.\n+The labels of the namespace where the Strimzi Cluster Operator is running.\n+These labels will be used to configure the namespace selector in network policies to allow Strimzi Cluster Operator to access the operands only from namespace with these labels.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2d314b98fe17c7b3b3256492892e8be3ed2968f"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxODI0NjE4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#pullrequestreview-541824618", "createdAt": "2020-12-01T11:56:56Z", "commit": {"oid": "b2d314b98fe17c7b3b3256492892e8be3ed2968f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo1Njo1N1rOH8pU6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo1Njo1N1rOH8pU6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM1MzcwNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            When not set, the namespace selector in network policies will be configured to allow access from Strimzi Cluster Operator from any namespace in the Kubernetes cluster.\n          \n          \n            \n            When not set, the namespace selector in network policies is configured to allow access to the Strimzi Cluster Operator from any namespace in the Kubernetes cluster.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533353706", "createdAt": "2020-12-01T11:56:57Z", "author": {"login": "PaulRMellor"}, "path": "documentation/modules/ref-operator-cluster.adoc", "diffHunk": "@@ -27,6 +27,23 @@ env:\n The timeout for internal operations, in milliseconds. This value should be\n increased when using Strimzi on clusters where regular Kubernetes operations take longer than usual (because of slow downloading of Docker images, for example).\n \n+`STRIMZI_OPERATOR_NAMESPACE`:: The name of the namespace where the Strimzi Cluster Operator is running.\n+This variable should not be configured manually but should use the Kubernetes Downward API.\n++\n+[source,yaml,options=\"nowrap\"]\n+----\n+env:\n+  - name: STRIMZI_OPERATOR_NAMESPACE\n+    valueFrom:\n+      fieldRef:\n+        fieldPath: metadata.namespace\n+----\n+\n+`STRIMZI_OPERATOR_NAMESPACE_LABELS`:: Optional.\n+The labels of the namespace where the Strimzi Cluster Operator is running.\n+These labels will be used to configure the namespace selector in network policies to allow Strimzi Cluster Operator to access the operands only from namespace with these labels.\n+When not set, the namespace selector in network policies will be configured to allow access from Strimzi Cluster Operator from any namespace in the Kubernetes cluster.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2d314b98fe17c7b3b3256492892e8be3ed2968f"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxODI2MTc0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#pullrequestreview-541826174", "createdAt": "2020-12-01T11:59:03Z", "commit": {"oid": "b2d314b98fe17c7b3b3256492892e8be3ed2968f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18f4076caa421c75f62cc1f71c868fc2fbc67680", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/18f4076caa421c75f62cc1f71c868fc2fbc67680", "committedDate": "2020-12-01T12:54:01Z", "message": "Apply suggestions from code review\r\n\r\nSigned-off-by: Jakub Scholz <www@scholzj.com>\n\nCo-authored-by: PaulRMellor <47596553+PaulRMellor@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxOTE5Mjc2", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#pullrequestreview-541919276", "createdAt": "2020-12-01T13:59:37Z", "commit": {"oid": "18f4076caa421c75f62cc1f71c868fc2fbc67680"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMzo1OTozOFrOH8tzyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMzo1OTozOFrOH8tzyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQyNzE0Nw==", "bodyText": "Looks like this is repeated 3 times, can we extract a method?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533427147", "createdAt": "2020-12-01T13:59:38Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ZookeeperCluster.java", "diffHunk": "@@ -412,7 +421,20 @@ public NetworkPolicy generateNetworkPolicy(boolean namespaceAndPodSelectorNetwor\n             expressions4.put(Labels.STRIMZI_KIND_LABEL, \"cluster-operator\");\n             labelSelector4.setMatchLabels(expressions4);\n             clusterOperatorPeer.setPodSelector(labelSelector4);\n-            clusterOperatorPeer.setNamespaceSelector(new LabelSelector());\n+\n+            if (!namespace.equals(operatorNamespace)) {\n+                // If CO and Zoo do not run in the same namespace, we need to handle cross namespace access\n+\n+                if (operatorNamespaceLabels != null)    {\n+                    // If user specified the namespace labels, we can use them to make the selector as tight as possible\n+                    LabelSelector nsLabelSelector = new LabelSelector();\n+                    nsLabelSelector.setMatchLabels(operatorNamespaceLabels.toMap());\n+                    clusterOperatorPeer.setNamespaceSelector(nsLabelSelector);\n+                } else {\n+                    // If no namespace labels were specified, we open the network policy to COs in all namespaces\n+                    clusterOperatorPeer.setNamespaceSelector(new LabelSelector());\n+                }\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18f4076caa421c75f62cc1f71c868fc2fbc67680"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e01f042299df92ab709a7f2f23baa48db4bc039b", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e01f042299df92ab709a7f2f23baa48db4bc039b", "committedDate": "2020-12-01T17:09:18Z", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMjYxMDMx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#pullrequestreview-542261031", "createdAt": "2020-12-01T20:16:05Z", "commit": {"oid": "e01f042299df92ab709a7f2f23baa48db4bc039b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDoxNjowNVrOH8-GGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDoxNjowNVrOH8-GGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5Mzk3OA==", "bodyText": "\"namespace s\" -> \"namespace as\" ?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4005#discussion_r533693978", "createdAt": "2020-12-01T20:16:05Z", "author": {"login": "ppatierno"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ModelUtils.java", "diffHunk": "@@ -479,4 +481,33 @@ public static AffinityBuilder populateAffinityBuilderWithRackLabelSelector(Affin\n         }\n         return builder;\n     }\n+\n+    /**\n+     * Decides whether the Cluster Operator needs namespaceSelector to be configured in the network policies in order\n+     * to talk with the operands. This follows the following rules:\n+     *     - If it runs in the same namespace s the operand, do not set namespace selector", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e01f042299df92ab709a7f2f23baa48db4bc039b"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b47a6a9d858ee7a8f66a07c692de4a2ffe4403fc", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b47a6a9d858ee7a8f66a07c692de4a2ffe4403fc", "committedDate": "2020-12-01T20:23:57Z", "message": "Review comments II\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 683, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}