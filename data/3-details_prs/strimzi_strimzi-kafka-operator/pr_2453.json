{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2OTM4NDAy", "number": 2453, "title": "ST: Add test for connect and connects2i with same name", "bodyText": "Signed-off-by: Jakub Stejskal xstejs24@gmail.com\nSelect the type of your PR\n\nEnhancement / new feature\n\nDescription\nAdd system test coverage for #2463\nChecklist\n\n Write tests\n Make sure all tests pass", "createdAt": "2020-01-24T17:23:28Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453", "merged": true, "mergeCommit": {"oid": "1e8c26e896f0dd58ac73a356c42eedc935aa6aa0"}, "closed": true, "closedAt": "2020-01-29T19:16:18Z", "author": {"login": "Frawless"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_CraPgH2gAyMzY2OTM4NDAyOjcyZjUxZTJhNTY1MTkzYjc4NzFjMWQ5MDFlZWI3ODcwMDYwYTdmOWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_JOwIgFqTM1MDI4MjU1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "72f51e2a565193b7871c1d901eeb7870060a7f9c", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/72f51e2a565193b7871c1d901eeb7870060a7f9c", "committedDate": "2020-01-29T09:39:23Z", "message": "Add test for connect and connects2i with same name\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17a03e059ad36e09324db32e609b1dbd43d524f2", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/17a03e059ad36e09324db32e609b1dbd43d524f2", "committedDate": "2020-01-28T19:18:59Z", "message": "fixup! fixup! Finish the test case\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}, "afterCommit": {"oid": "c7da02628bb46cf71779a98360738b6d86c7389c", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c7da02628bb46cf71779a98360738b6d86c7389c", "committedDate": "2020-01-29T10:46:43Z", "message": "Fix new test in s2i\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ee48b0c656c4bbe109e2d69bdc7593ce0ea36bc", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8ee48b0c656c4bbe109e2d69bdc7593ce0ea36bc", "committedDate": "2020-01-29T10:47:46Z", "message": "Finish the test case\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61468f0e12f286494fde47d7724324b78a903351", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/61468f0e12f286494fde47d7724324b78a903351", "committedDate": "2020-01-29T10:47:46Z", "message": "Fix new test in s2i\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7da02628bb46cf71779a98360738b6d86c7389c", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c7da02628bb46cf71779a98360738b6d86c7389c", "committedDate": "2020-01-29T10:46:43Z", "message": "Fix new test in s2i\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}, "afterCommit": {"oid": "61468f0e12f286494fde47d7724324b78a903351", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/61468f0e12f286494fde47d7724324b78a903351", "committedDate": "2020-01-29T10:47:46Z", "message": "Fix new test in s2i\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMDY4MDg1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#pullrequestreview-350068085", "createdAt": "2020-01-29T12:26:57Z", "commit": {"oid": "61468f0e12f286494fde47d7724324b78a903351"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMjoyNjo1N1rOFjGpWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMjoyOTo0NVrOFjGt2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1MzM3MQ==", "bodyText": "You have the comments from the oposite case - here is now S2I and on line 376 is regular connect.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#discussion_r372353371", "createdAt": "2020-01-29T12:26:57Z", "author": {"login": "scholzj"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/ConnectS2IST.java", "diffHunk": "@@ -332,6 +335,91 @@ void testJvmAndResources() {\n         KafkaConnectS2IResource.deleteKafkaConnectS2IWithoutWait(kafkaConnectS2i);\n     }\n \n+    @Test\n+    void testKafkaConnectorWithConnectS2IAndConnectWithSameName() {\n+        String topicName = \"test-topic-\" + new Random().nextInt(Integer.MAX_VALUE);\n+        String connectClusterName = \"connect-cluster\";\n+        String connectS2IClusterName = \"connect-s2i-cluster\";\n+\n+        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3).done();\n+        // Crate connect cluster with default connect image", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61468f0e12f286494fde47d7724324b78a903351"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1NDUyMw==", "bodyText": "Right now both this and the connect test are in following order:\n\nCreate ConnectS2I\nCreate Connector\nCreate conflicting Connect with the same name.\n\nI wonder if the better order would be:\n\nCreate ConnectS2I\nCreate conflicting Connect with the same name.\nCreate Connector\n\nOr mybe at least try that for example connector update still works after you create the conflicting Connect.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#discussion_r372354523", "createdAt": "2020-01-29T12:29:45Z", "author": {"login": "scholzj"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/ConnectS2IST.java", "diffHunk": "@@ -332,6 +335,91 @@ void testJvmAndResources() {\n         KafkaConnectS2IResource.deleteKafkaConnectS2IWithoutWait(kafkaConnectS2i);\n     }\n \n+    @Test\n+    void testKafkaConnectorWithConnectS2IAndConnectWithSameName() {\n+        String topicName = \"test-topic-\" + new Random().nextInt(Integer.MAX_VALUE);\n+        String connectClusterName = \"connect-cluster\";\n+        String connectS2IClusterName = \"connect-s2i-cluster\";\n+\n+        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3).done();\n+        // Crate connect cluster with default connect image\n+        KafkaConnectS2IResource.kafkaConnectS2I(CLUSTER_NAME, CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-connect-s2i\")\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata()\n+                .editSpec()\n+                .addToConfig(\"group.id\", connectClusterName)\n+                .addToConfig(\"offset.storage.topic\", connectClusterName + \"-offsets\")\n+                .addToConfig(\"config.storage.topic\", connectClusterName + \"-config\")\n+                .addToConfig(\"status.storage.topic\", connectClusterName + \"-status\")\n+            .endSpec().done();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61468f0e12f286494fde47d7724324b78a903351"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d580813a6c0672e80601bfc7ae9cc2a32f294e3a", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d580813a6c0672e80601bfc7ae9cc2a32f294e3a", "committedDate": "2020-01-29T15:35:06Z", "message": "Workin comments from review\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMjA4Mzc4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#pullrequestreview-350208378", "createdAt": "2020-01-29T15:43:36Z", "commit": {"oid": "d580813a6c0672e80601bfc7ae9cc2a32f294e3a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMjE3MDUy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#pullrequestreview-350217052", "createdAt": "2020-01-29T15:53:48Z", "commit": {"oid": "d580813a6c0672e80601bfc7ae9cc2a32f294e3a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNTo1Mzo0OFrOFjNqIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNTo1Njo1MVrOFjNx9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ2ODI1Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Crate connect cluster with default connect image\n          \n          \n            \n                    // Create connect cluster with default connect image", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#discussion_r372468256", "createdAt": "2020-01-29T15:53:48Z", "author": {"login": "tombentley"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/ConnectS2IST.java", "diffHunk": "@@ -332,6 +335,101 @@ void testJvmAndResources() {\n         KafkaConnectS2IResource.deleteKafkaConnectS2IWithoutWait(kafkaConnectS2i);\n     }\n \n+    @Test\n+    void testKafkaConnectorWithConnectS2IAndConnectWithSameName() {\n+        String topicName = \"test-topic-\" + new Random().nextInt(Integer.MAX_VALUE);\n+        String connectClusterName = \"connect-cluster\";\n+        String connectS2IClusterName = \"connect-s2i-cluster\";\n+\n+        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3).done();\n+        // Create different connect cluster via S2I resources\n+        KafkaConnectS2IResource.kafkaConnectS2I(CLUSTER_NAME, CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-connect-s2i\")\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata()\n+                .editSpec()\n+                .addToConfig(\"group.id\", connectClusterName)\n+                .addToConfig(\"offset.storage.topic\", connectClusterName + \"-offsets\")\n+                .addToConfig(\"config.storage.topic\", connectClusterName + \"-config\")\n+                .addToConfig(\"status.storage.topic\", connectClusterName + \"-status\")\n+            .endSpec().done();\n+\n+        // Crate connect cluster with default connect image", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d580813a6c0672e80601bfc7ae9cc2a32f294e3a"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ2ODY2Mg==", "bodyText": "Reconciliation of what?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#discussion_r372468662", "createdAt": "2020-01-29T15:54:25Z", "author": {"login": "tombentley"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/ConnectS2IST.java", "diffHunk": "@@ -332,6 +335,101 @@ void testJvmAndResources() {\n         KafkaConnectS2IResource.deleteKafkaConnectS2IWithoutWait(kafkaConnectS2i);\n     }\n \n+    @Test\n+    void testKafkaConnectorWithConnectS2IAndConnectWithSameName() {\n+        String topicName = \"test-topic-\" + new Random().nextInt(Integer.MAX_VALUE);\n+        String connectClusterName = \"connect-cluster\";\n+        String connectS2IClusterName = \"connect-s2i-cluster\";\n+\n+        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3).done();\n+        // Create different connect cluster via S2I resources\n+        KafkaConnectS2IResource.kafkaConnectS2I(CLUSTER_NAME, CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-connect-s2i\")\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata()\n+                .editSpec()\n+                .addToConfig(\"group.id\", connectClusterName)\n+                .addToConfig(\"offset.storage.topic\", connectClusterName + \"-offsets\")\n+                .addToConfig(\"config.storage.topic\", connectClusterName + \"-config\")\n+                .addToConfig(\"status.storage.topic\", connectClusterName + \"-status\")\n+            .endSpec().done();\n+\n+        // Crate connect cluster with default connect image\n+        KafkaConnectResource.kafkaConnectWithoutWait(KafkaConnectResource.defaultKafkaConnect(CLUSTER_NAME, CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-connect\")\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata()\n+            .editSpec()\n+                .addToConfig(\"group.id\", connectS2IClusterName)\n+                .addToConfig(\"offset.storage.topic\", connectS2IClusterName + \"-offsets\")\n+                .addToConfig(\"config.storage.topic\", connectS2IClusterName + \"-config\")\n+                .addToConfig(\"status.storage.topic\", connectS2IClusterName + \"-status\")\n+            .endSpec().build());\n+\n+        KafkaConnectUtils.waitForConnectStatus(CLUSTER_NAME, \"NotReady\");\n+\n+        KafkaConnectorResource.kafkaConnector(CLUSTER_NAME)\n+            .editSpec()\n+                .withClassName(\"org.apache.kafka.connect.file.FileStreamSinkConnector\")\n+                .addToConfig(\"topics\", topicName)\n+                .addToConfig(\"file\", \"/tmp/test-file-sink.txt\")\n+                .addToConfig(\"key.converter\", \"org.apache.kafka.connect.storage.StringConverter\")\n+                .addToConfig(\"value.converter\", \"org.apache.kafka.connect.storage.StringConverter\")\n+            .endSpec().done();\n+        KafkaConnectUtils.waitForConnectorReady(CLUSTER_NAME);\n+\n+        // Wait for first reconciliation\n+        StUtils.waitForReconciliation(testClass, testName, NAMESPACE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d580813a6c0672e80601bfc7ae9cc2a32f294e3a"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQ3MDI2Mg==", "bodyText": "You probably need to test both to ensure the first-created-resource-wins strategy.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#discussion_r372470262", "createdAt": "2020-01-29T15:56:51Z", "author": {"login": "tombentley"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/ConnectS2IST.java", "diffHunk": "@@ -332,6 +335,91 @@ void testJvmAndResources() {\n         KafkaConnectS2IResource.deleteKafkaConnectS2IWithoutWait(kafkaConnectS2i);\n     }\n \n+    @Test\n+    void testKafkaConnectorWithConnectS2IAndConnectWithSameName() {\n+        String topicName = \"test-topic-\" + new Random().nextInt(Integer.MAX_VALUE);\n+        String connectClusterName = \"connect-cluster\";\n+        String connectS2IClusterName = \"connect-s2i-cluster\";\n+\n+        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3).done();\n+        // Crate connect cluster with default connect image\n+        KafkaConnectS2IResource.kafkaConnectS2I(CLUSTER_NAME, CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-connect-s2i\")\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata()\n+                .editSpec()\n+                .addToConfig(\"group.id\", connectClusterName)\n+                .addToConfig(\"offset.storage.topic\", connectClusterName + \"-offsets\")\n+                .addToConfig(\"config.storage.topic\", connectClusterName + \"-config\")\n+                .addToConfig(\"status.storage.topic\", connectClusterName + \"-status\")\n+            .endSpec().done();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1NDUyMw=="}, "originalCommit": {"oid": "61468f0e12f286494fde47d7724324b78a903351"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec1c101347af8c61d27c486e06ebac84988ad1fd", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ec1c101347af8c61d27c486e06ebac84988ad1fd", "committedDate": "2020-01-29T16:56:48Z", "message": "fixup! Workin comments from review\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMjgyNTU1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2453#pullrequestreview-350282555", "createdAt": "2020-01-29T17:17:25Z", "commit": {"oid": "ec1c101347af8c61d27c486e06ebac84988ad1fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1863, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}