{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4OTI0OTUx", "number": 2356, "title": "ST: Improve Connect tests with Connector resource and check values set by\u2026", "bodyText": "Type of change\n\nEnhancement / new feature\n\nDescription\nThis PR extends original system test for Kafka Connector CR.\nConnector CR Status is tested as part of testKafkaConnectS2IStatus and testKafkaConnectStatus tests to save time for regression suite (to avoid duplicity test case which takes 6-8 minutes).\n#2354 is not tested as part of this PR. I suggest to create new with enhancement for current tests when it's fixed.\nChecklist\n\n Write tests\n Make sure all tests pass", "createdAt": "2020-01-03T09:32:36Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356", "merged": true, "mergeCommit": {"oid": "6abba4c2c5815aca9a737e139faf66e83766bad4"}, "closed": true, "closedAt": "2020-01-13T21:36:35Z", "author": {"login": "Frawless"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2w_XtAFqTMzODE2MjQzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb59nCwABqjI5NDM0OTYyMzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MTYyNDM1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#pullrequestreview-338162435", "createdAt": "2020-01-03T16:31:30Z", "commit": {"oid": "96d7bd000245c97daa847f9d9fbc540ffccac34b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NDE4NjE4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#pullrequestreview-338418618", "createdAt": "2020-01-05T20:04:58Z", "commit": {"oid": "96d7bd000245c97daa847f9d9fbc540ffccac34b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQyMDowNDo1OVrOFaSuLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNVQyMDowNTo0N1rOFaSuWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExNDAzMA==", "bodyText": "I'm not sure I understand the logic why this is here. It doesn't seem to belong to this cluster and the actual Connect cluster is anyway not ready. I think the test with invalid lbel should be done when the Connect is ready.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#discussion_r363114030", "createdAt": "2020-01-05T20:04:59Z", "author": {"login": "scholzj"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -170,40 +173,64 @@ void testKafkaBridgeStatus() {\n     @Test\n     void testKafkaConnectStatus() {\n         String connectUrl = \"http://my-cluster-connect-api.status-cluster-test.svc:8083\";\n-        KafkaConnectResource.kafkaConnect(CLUSTER_NAME, 1).done();\n+        KafkaConnectResource.kafkaConnect(CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata().done();\n         waitForKafkaConnectStatus(\"Ready\");\n+        KafkaConnectorResource.kafkaConnector(CLUSTER_NAME, TOPIC_NAME).done();\n+        waitForKafkaConnectorStatus(CLUSTER_NAME, \"Ready\");\n         assertKafkaConnectStatus(1, connectUrl);\n \n         KafkaConnectResource.replaceKafkaConnectResource(CLUSTER_NAME, kb -> kb.getSpec().setResources(new ResourceRequirementsBuilder()\n                 .addToRequests(\"cpu\", new Quantity(\"100000000m\"))\n                 .build()));\n         waitForKafkaConnectStatus(\"NotReady\");\n \n+        KafkaConnectorResource.replaceKafkaConnectorResource(CLUSTER_NAME,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96d7bd000245c97daa847f9d9fbc540ffccac34b"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExNDA3NQ==", "bodyText": "Same as above.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#discussion_r363114075", "createdAt": "2020-01-05T20:05:47Z", "author": {"login": "scholzj"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -170,40 +173,64 @@ void testKafkaBridgeStatus() {\n     @Test\n     void testKafkaConnectStatus() {\n         String connectUrl = \"http://my-cluster-connect-api.status-cluster-test.svc:8083\";\n-        KafkaConnectResource.kafkaConnect(CLUSTER_NAME, 1).done();\n+        KafkaConnectResource.kafkaConnect(CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata().done();\n         waitForKafkaConnectStatus(\"Ready\");\n+        KafkaConnectorResource.kafkaConnector(CLUSTER_NAME, TOPIC_NAME).done();\n+        waitForKafkaConnectorStatus(CLUSTER_NAME, \"Ready\");\n         assertKafkaConnectStatus(1, connectUrl);\n \n         KafkaConnectResource.replaceKafkaConnectResource(CLUSTER_NAME, kb -> kb.getSpec().setResources(new ResourceRequirementsBuilder()\n                 .addToRequests(\"cpu\", new Quantity(\"100000000m\"))\n                 .build()));\n         waitForKafkaConnectStatus(\"NotReady\");\n \n+        KafkaConnectorResource.replaceKafkaConnectorResource(CLUSTER_NAME,\n+            kc -> kc.getMetadata().setLabels(Collections.singletonMap(\"strimzi.io/cluster\", \"non-existing-connect-cluster\")));\n+        waitForKafkaConnectorStatus(CLUSTER_NAME, \"NotReady\");\n+\n         KafkaConnectResource.replaceKafkaConnectResource(CLUSTER_NAME, kb -> kb.getSpec().setResources(new ResourceRequirementsBuilder()\n                 .addToRequests(\"cpu\", new Quantity(\"10m\"))\n                 .build()));\n         waitForKafkaConnectStatus(\"Ready\");\n         assertKafkaConnectStatus(3, connectUrl);\n+        KafkaConnectorResource.replaceKafkaConnectorResource(CLUSTER_NAME,\n+            kc -> kc.getMetadata().setLabels(Collections.singletonMap(\"strimzi.io/cluster\", CLUSTER_NAME)));\n+        waitForKafkaConnectorStatus(CLUSTER_NAME, \"Ready\");\n     }\n \n     @Test\n     void testKafkaConnectS2IStatus() {\n         String connectS2IUrl = \"http://my-cluster-s2i-connect-api.status-cluster-test.svc:8083\";\n         String connectS2IDeploymentConfigName = CONNECTS2I_CLUSTER_NAME + \"-connect\";\n-        KafkaConnectS2IResource.kafkaConnectS2I(CONNECTS2I_CLUSTER_NAME, CLUSTER_NAME, 1).done();\n+        KafkaConnectS2IResource.kafkaConnectS2I(CONNECTS2I_CLUSTER_NAME, CLUSTER_NAME, 1)\n+            .editMetadata()\n+                .addToAnnotations(\"strimzi.io/use-connector-resources\", \"true\")\n+            .endMetadata().done();\n         waitForKafkaConnectS2IStatus(\"Ready\");\n         assertKafkaConnectS2IStatus(1, connectS2IUrl, connectS2IDeploymentConfigName);\n+        KafkaConnectorResource.kafkaConnector(CONNECTS2I_CLUSTER_NAME, TOPIC_NAME).done();\n+        waitForKafkaConnectorStatus(CONNECTS2I_CLUSTER_NAME, \"Ready\");\n \n         KafkaConnectS2IResource.replaceConnectS2IResource(CONNECTS2I_CLUSTER_NAME, kb -> kb.getSpec().setResources(new ResourceRequirementsBuilder()\n                 .addToRequests(\"cpu\", new Quantity(\"100000000m\"))\n                 .build()));\n         waitForKafkaConnectS2IStatus(\"NotReady\");\n \n+        KafkaConnectorResource.replaceKafkaConnectorResource(CONNECTS2I_CLUSTER_NAME,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96d7bd000245c97daa847f9d9fbc540ffccac34b"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NDUyNDYz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#pullrequestreview-339452463", "createdAt": "2020-01-07T19:23:47Z", "commit": {"oid": "0a2c3b92b8b49c11823a8c7d65706187578bebae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NTI1MzMy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2356#pullrequestreview-339525332", "createdAt": "2020-01-07T21:41:32Z", "commit": {"oid": "0a2c3b92b8b49c11823a8c7d65706187578bebae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de79ce9e320a2df2d2934d8d1cfdc4bef49a3522", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/de79ce9e320a2df2d2934d8d1cfdc4bef49a3522", "committedDate": "2020-01-09T10:31:53Z", "message": "Improve Connect tests with Connector resource and check values set by connector operator via connect api\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f61785f697ec8a93cc93587a2ffa35d6b962a7f", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4f61785f697ec8a93cc93587a2ffa35d6b962a7f", "committedDate": "2020-01-09T10:31:53Z", "message": "Work in some review comments - move connector status check to phase when connects are rdy\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f0e945cd351fcbd4c06ccf5eb9785ad2d7ac377", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8f0e945cd351fcbd4c06ccf5eb9785ad2d7ac377", "committedDate": "2020-01-09T10:31:53Z", "message": "fixup! Work in some review comments - move connector status check to phase when connects are rdy\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6137fcd0fb44989234cf9342a6739f3484b84dd5", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6137fcd0fb44989234cf9342a6739f3484b84dd5", "committedDate": "2020-01-09T10:31:53Z", "message": "Improve connector status checks\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c54d649cf13fbddf949e9922745e423fbb9cfc9", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9c54d649cf13fbddf949e9922745e423fbb9cfc9", "committedDate": "2020-01-09T10:31:53Z", "message": "Improve connector status checks v2\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b1debe14518aa187544fc75b115d61afa70d1b9", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3b1debe14518aa187544fc75b115d61afa70d1b9", "committedDate": "2020-01-09T10:31:53Z", "message": "FIx connector state in tests\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9af24f8b096c7857576cd090308ace5b3ed584db", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9af24f8b096c7857576cd090308ace5b3ed584db", "committedDate": "2020-01-09T10:31:53Z", "message": "Minor fixes for tests\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bb6152ac2bf824f850276fd796b3a9e82656794", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8bb6152ac2bf824f850276fd796b3a9e82656794", "committedDate": "2020-01-13T14:55:09Z", "message": "fix tests\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0a2c3b92b8b49c11823a8c7d65706187578bebae", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0a2c3b92b8b49c11823a8c7d65706187578bebae", "committedDate": "2020-01-07T11:52:40Z", "message": "Minor fixes for tests\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}, "afterCommit": {"oid": "8bb6152ac2bf824f850276fd796b3a9e82656794", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8bb6152ac2bf824f850276fd796b3a9e82656794", "committedDate": "2020-01-13T14:55:09Z", "message": "fix tests\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1766, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}