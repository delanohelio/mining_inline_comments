{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3NDY4NDI2", "number": 2874, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToyNjozNFrOD0-ulw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQxNToxODoyOFrOD4qpPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2ODgwMjc5OnYy", "diffSide": "RIGHT", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToyNjozNFrOGKMj8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToyNjozNFrOGKMj8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM0NDc1NA==", "bodyText": "In CO and UO, the timer as well as some of the counters are measured per resource. So if you have 10 Kafka topics, you will get 10 measurements. This looks to me like it really measures only the reconcilaAll. Or do I misunderstand what this code in the operator does?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413344754", "createdAt": "2020-04-22T21:26:34Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -221,8 +223,18 @@ public void handle(Long oldTimerId) {\n                         if (!stopped) {\n                             timerId = null;\n                             boolean isInitialReconcile = oldTimerId == null;\n+                            Timer.Sample reconciliationTimerSample = Timer.start(topicOperator.getMetrics().meterRegistry());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2ODgwNjgwOnYy", "diffSide": "RIGHT", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToyNzozM1rOGKMmSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNTo1NzoyMlrOGKX4Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM0NTM1Mg==", "bodyText": "Doesn't this and the line 233 increment the counter twice in a sinfle recomciliation?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413345352", "createdAt": "2020-04-22T21:27:33Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -221,8 +223,18 @@ public void handle(Long oldTimerId) {\n                         if (!stopped) {\n                             timerId = null;\n                             boolean isInitialReconcile = oldTimerId == null;\n+                            Timer.Sample reconciliationTimerSample = Timer.start(topicOperator.getMetrics().meterRegistry());\n                             topicOperator.reconcileAllTopics(isInitialReconcile ? \"initial \" : \"periodic \").setHandler(result -> {\n+                                topicOperator.getPeriodicReconciliationsCounter().increment();\n+                                if (result.failed()) {\n+                                    topicOperator.incrementFailedReconciliationsCounter();\n+                                    reconciliationTimerSample.stop(topicOperator.getReconciliationsTimer());\n+                                } else {\n+                                    topicOperator.incrementSuccessfulReconciliationsCounter();\n+                                    reconciliationTimerSample.stop(topicOperator.getReconciliationsTimer());\n+                                }\n                                 if (isInitialReconcile) {\n+                                    topicOperator.incrementSuccessfulReconciliationsCounter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUzMDE1MA==", "bodyText": "I think it does. I had a problem the count did not match. For example startedReconciliations=5, periodicalReconciliations=7, sucesfulReconciliations=11. I have no idea where is the one lost reconciliation.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413530150", "createdAt": "2020-04-23T05:57:22Z", "author": {"login": "sknot-rh"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -221,8 +223,18 @@ public void handle(Long oldTimerId) {\n                         if (!stopped) {\n                             timerId = null;\n                             boolean isInitialReconcile = oldTimerId == null;\n+                            Timer.Sample reconciliationTimerSample = Timer.start(topicOperator.getMetrics().meterRegistry());\n                             topicOperator.reconcileAllTopics(isInitialReconcile ? \"initial \" : \"periodic \").setHandler(result -> {\n+                                topicOperator.getPeriodicReconciliationsCounter().increment();\n+                                if (result.failed()) {\n+                                    topicOperator.incrementFailedReconciliationsCounter();\n+                                    reconciliationTimerSample.stop(topicOperator.getReconciliationsTimer());\n+                                } else {\n+                                    topicOperator.incrementSuccessfulReconciliationsCounter();\n+                                    reconciliationTimerSample.stop(topicOperator.getReconciliationsTimer());\n+                                }\n                                 if (isInitialReconcile) {\n+                                    topicOperator.incrementSuccessfulReconciliationsCounter();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM0NTM1Mg=="}, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU2ODgxMDI4OnYy", "diffSide": "RIGHT", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToyODoyOFrOGKMoNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToyODoyOFrOGKMoNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM0NTg0NQ==", "bodyText": "The time can be probably stopped only once outside the if-else, or?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413345845", "createdAt": "2020-04-22T21:28:28Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -221,8 +223,18 @@ public void handle(Long oldTimerId) {\n                         if (!stopped) {\n                             timerId = null;\n                             boolean isInitialReconcile = oldTimerId == null;\n+                            Timer.Sample reconciliationTimerSample = Timer.start(topicOperator.getMetrics().meterRegistry());\n                             topicOperator.reconcileAllTopics(isInitialReconcile ? \"initial \" : \"periodic \").setHandler(result -> {\n+                                topicOperator.getPeriodicReconciliationsCounter().increment();\n+                                if (result.failed()) {\n+                                    topicOperator.incrementFailedReconciliationsCounter();\n+                                    reconciliationTimerSample.stop(topicOperator.getReconciliationsTimer());\n+                                } else {\n+                                    topicOperator.incrementSuccessfulReconciliationsCounter();\n+                                    reconciliationTimerSample.stop(topicOperator.getReconciliationsTimer());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MDY5MDUwOnYy", "diffSide": "RIGHT", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwODoyNTozNFrOGKdE0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwNzo0MjowOVrOGMVNkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxNTMxMw==", "bodyText": "I think \"periodic\" is better than \"periodical\"", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413615313", "createdAt": "2020-04-23T08:25:34Z", "author": {"login": "tombentley"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -357,16 +372,75 @@ public TopicOperator(Vertx vertx, Kafka kafka,\n                          TopicStore topicStore,\n                          Labels labels,\n                          String namespace,\n-                         Config config) {\n+                         Config config,\n+                         MetricsProvider metrics) {\n         this.kafka = kafka;\n         this.k8s = k8s;\n         this.vertx = vertx;\n         this.labels = labels;\n         this.topicStore = topicStore;\n         this.namespace = namespace;\n         this.config = config;\n+        this.metrics = metrics;\n+\n+        initMetrics();\n+    }\n+\n+    public void initMetrics() {\n+        Tags metricTags = Tags.of(Tag.of(\"kind\", \"KafkaTopic\"));\n+\n+        periodicReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.periodical\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4MzYzMg==", "bodyText": "This needs to be same as https://github.com/strimzi/strimzi-kafka-operator/pull/2737/files#diff-94c2cc18347a188f142d49e8bd0c3753R257", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r415583632", "createdAt": "2020-04-27T07:42:09Z", "author": {"login": "sknot-rh"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -357,16 +372,75 @@ public TopicOperator(Vertx vertx, Kafka kafka,\n                          TopicStore topicStore,\n                          Labels labels,\n                          String namespace,\n-                         Config config) {\n+                         Config config,\n+                         MetricsProvider metrics) {\n         this.kafka = kafka;\n         this.k8s = k8s;\n         this.vertx = vertx;\n         this.labels = labels;\n         this.topicStore = topicStore;\n         this.namespace = namespace;\n         this.config = config;\n+        this.metrics = metrics;\n+\n+        initMetrics();\n+    }\n+\n+    public void initMetrics() {\n+        Tags metricTags = Tags.of(Tag.of(\"kind\", \"KafkaTopic\"));\n+\n+        periodicReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.periodical\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxNTMxMw=="}, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MDcwNDc5OnYy", "diffSide": "RIGHT", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwODoyODo0MFrOGKdNzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwODoxNDoxMVrOGMWfqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxNzYxMg==", "bodyText": "Is this an average? Or just the time for the last reconciliation? We probably need two of these because of the fact that periodic reconciliations (because they reconcile all the topics) will take ~n times longer than event-based reconciliations.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413617612", "createdAt": "2020-04-23T08:28:40Z", "author": {"login": "tombentley"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -357,16 +372,75 @@ public TopicOperator(Vertx vertx, Kafka kafka,\n                          TopicStore topicStore,\n                          Labels labels,\n                          String namespace,\n-                         Config config) {\n+                         Config config,\n+                         MetricsProvider metrics) {\n         this.kafka = kafka;\n         this.k8s = k8s;\n         this.vertx = vertx;\n         this.labels = labels;\n         this.topicStore = topicStore;\n         this.namespace = namespace;\n         this.config = config;\n+        this.metrics = metrics;\n+\n+        initMetrics();\n+    }\n+\n+    public void initMetrics() {\n+        Tags metricTags = Tags.of(Tag.of(\"kind\", \"KafkaTopic\"));\n+\n+        periodicReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.periodical\",\n+                \"Number of periodical reconciliations done by the operator\",\n+                metricTags);\n+\n+        reconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations\",\n+                \"Number of reconciliations done by the operator for individual topics\",\n+                metricTags);\n+\n+        failedReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.failed\",\n+                \"Number of reconciliations done by the operator for individual topics which failed\",\n+                metricTags);\n+\n+        successfulReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.successful\",\n+                \"Number of reconciliations done by the operator for individual topics which were successful\",\n+                metricTags);\n+\n+        topicCounter = metrics.gauge(METRICS_PREFIX + \"resources\",\n+                \"Number of topics the operator sees\",\n+                metricTags);\n+\n+        reconciliationsTimer = metrics.timer(METRICS_PREFIX + \"reconciliations.duration\",\n+                \"The time the reconciliation takes to complete\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4NDQxOQ==", "bodyText": "@scholzj Did you distinguish these?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r415584419", "createdAt": "2020-04-27T07:43:27Z", "author": {"login": "sknot-rh"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -357,16 +372,75 @@ public TopicOperator(Vertx vertx, Kafka kafka,\n                          TopicStore topicStore,\n                          Labels labels,\n                          String namespace,\n-                         Config config) {\n+                         Config config,\n+                         MetricsProvider metrics) {\n         this.kafka = kafka;\n         this.k8s = k8s;\n         this.vertx = vertx;\n         this.labels = labels;\n         this.topicStore = topicStore;\n         this.namespace = namespace;\n         this.config = config;\n+        this.metrics = metrics;\n+\n+        initMetrics();\n+    }\n+\n+    public void initMetrics() {\n+        Tags metricTags = Tags.of(Tag.of(\"kind\", \"KafkaTopic\"));\n+\n+        periodicReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.periodical\",\n+                \"Number of periodical reconciliations done by the operator\",\n+                metricTags);\n+\n+        reconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations\",\n+                \"Number of reconciliations done by the operator for individual topics\",\n+                metricTags);\n+\n+        failedReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.failed\",\n+                \"Number of reconciliations done by the operator for individual topics which failed\",\n+                metricTags);\n+\n+        successfulReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.successful\",\n+                \"Number of reconciliations done by the operator for individual topics which were successful\",\n+                metricTags);\n+\n+        topicCounter = metrics.gauge(METRICS_PREFIX + \"resources\",\n+                \"Number of topics the operator sees\",\n+                metricTags);\n+\n+        reconciliationsTimer = metrics.timer(METRICS_PREFIX + \"reconciliations.duration\",\n+                \"The time the reconciliation takes to complete\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxNzYxMg=="}, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4ODA2Nw==", "bodyText": "That is handled by the Micrometer framework it self. I would need to check what exactly it provides and what we used. I believe it might provide the max time and the average?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r415588067", "createdAt": "2020-04-27T07:49:04Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -357,16 +372,75 @@ public TopicOperator(Vertx vertx, Kafka kafka,\n                          TopicStore topicStore,\n                          Labels labels,\n                          String namespace,\n-                         Config config) {\n+                         Config config,\n+                         MetricsProvider metrics) {\n         this.kafka = kafka;\n         this.k8s = k8s;\n         this.vertx = vertx;\n         this.labels = labels;\n         this.topicStore = topicStore;\n         this.namespace = namespace;\n         this.config = config;\n+        this.metrics = metrics;\n+\n+        initMetrics();\n+    }\n+\n+    public void initMetrics() {\n+        Tags metricTags = Tags.of(Tag.of(\"kind\", \"KafkaTopic\"));\n+\n+        periodicReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.periodical\",\n+                \"Number of periodical reconciliations done by the operator\",\n+                metricTags);\n+\n+        reconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations\",\n+                \"Number of reconciliations done by the operator for individual topics\",\n+                metricTags);\n+\n+        failedReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.failed\",\n+                \"Number of reconciliations done by the operator for individual topics which failed\",\n+                metricTags);\n+\n+        successfulReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.successful\",\n+                \"Number of reconciliations done by the operator for individual topics which were successful\",\n+                metricTags);\n+\n+        topicCounter = metrics.gauge(METRICS_PREFIX + \"resources\",\n+                \"Number of topics the operator sees\",\n+                metricTags);\n+\n+        reconciliationsTimer = metrics.timer(METRICS_PREFIX + \"reconciliations.duration\",\n+                \"The time the reconciliation takes to complete\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxNzYxMg=="}, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTYwNDY0OA==", "bodyText": "OK, I see. It just seems to measure the time for periodic reconciliations (as Jakub mentioned here), and doesn't cover the reconciliations caused by changes. So the number will make sense, but it also means we have no visibility of the time taken to perform per-topic reconciliation.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r415604648", "createdAt": "2020-04-27T08:14:11Z", "author": {"login": "tombentley"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -357,16 +372,75 @@ public TopicOperator(Vertx vertx, Kafka kafka,\n                          TopicStore topicStore,\n                          Labels labels,\n                          String namespace,\n-                         Config config) {\n+                         Config config,\n+                         MetricsProvider metrics) {\n         this.kafka = kafka;\n         this.k8s = k8s;\n         this.vertx = vertx;\n         this.labels = labels;\n         this.topicStore = topicStore;\n         this.namespace = namespace;\n         this.config = config;\n+        this.metrics = metrics;\n+\n+        initMetrics();\n+    }\n+\n+    public void initMetrics() {\n+        Tags metricTags = Tags.of(Tag.of(\"kind\", \"KafkaTopic\"));\n+\n+        periodicReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.periodical\",\n+                \"Number of periodical reconciliations done by the operator\",\n+                metricTags);\n+\n+        reconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations\",\n+                \"Number of reconciliations done by the operator for individual topics\",\n+                metricTags);\n+\n+        failedReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.failed\",\n+                \"Number of reconciliations done by the operator for individual topics which failed\",\n+                metricTags);\n+\n+        successfulReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.successful\",\n+                \"Number of reconciliations done by the operator for individual topics which were successful\",\n+                metricTags);\n+\n+        topicCounter = metrics.gauge(METRICS_PREFIX + \"resources\",\n+                \"Number of topics the operator sees\",\n+                metricTags);\n+\n+        reconciliationsTimer = metrics.timer(METRICS_PREFIX + \"reconciliations.duration\",\n+                \"The time the reconciliation takes to complete\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxNzYxMg=="}, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MDcxMzU4OnYy", "diffSide": "RIGHT", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/ZkTopicsWatcher.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwODozMDoxOFrOGKdS4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwNzo0NjowMlrOGMVW-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxODkxNQ==", "bodyText": "With these I wonder if it would be better to build this into the Reconciliation class, rather than having to change all these call sites. Wdyt?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413618915", "createdAt": "2020-04-23T08:30:18Z", "author": {"login": "tombentley"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/ZkTopicsWatcher.java", "diffHunk": "@@ -84,8 +84,11 @@ void start(Zk zk) {\n                     LogContext logContext = LogContext.zkWatch(TOPICS_ZNODE, \"-\" + topicName);\n                     topicOperator.onTopicDeleted(logContext, new TopicName(topicName)).setHandler(ar -> {\n                         if (ar.succeeded()) {\n+                            topicOperator.decrementTopicCounter();\n+                            topicOperator.incrementSuccessfulReconciliationsCounter();\n                             LOGGER.debug(\"{}: Success responding to deletion of topic {}\", logContext, topicName);\n                         } else {\n+                            topicOperator.incrementFailedReconciliationsCounter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4NDc2Nw==", "bodyText": "Maybe it would. Should I do that in this PR?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r415584767", "createdAt": "2020-04-27T07:44:02Z", "author": {"login": "sknot-rh"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/ZkTopicsWatcher.java", "diffHunk": "@@ -84,8 +84,11 @@ void start(Zk zk) {\n                     LogContext logContext = LogContext.zkWatch(TOPICS_ZNODE, \"-\" + topicName);\n                     topicOperator.onTopicDeleted(logContext, new TopicName(topicName)).setHandler(ar -> {\n                         if (ar.succeeded()) {\n+                            topicOperator.decrementTopicCounter();\n+                            topicOperator.incrementSuccessfulReconciliationsCounter();\n                             LOGGER.debug(\"{}: Success responding to deletion of topic {}\", logContext, topicName);\n                         } else {\n+                            topicOperator.incrementFailedReconciliationsCounter();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxODkxNQ=="}, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4NjA0Mw==", "bodyText": "By all means give it a try and see how it works out. You can always revert/drop that commit.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r415586043", "createdAt": "2020-04-27T07:46:02Z", "author": {"login": "tombentley"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/ZkTopicsWatcher.java", "diffHunk": "@@ -84,8 +84,11 @@ void start(Zk zk) {\n                     LogContext logContext = LogContext.zkWatch(TOPICS_ZNODE, \"-\" + topicName);\n                     topicOperator.onTopicDeleted(logContext, new TopicName(topicName)).setHandler(ar -> {\n                         if (ar.succeeded()) {\n+                            topicOperator.decrementTopicCounter();\n+                            topicOperator.incrementSuccessfulReconciliationsCounter();\n                             LOGGER.debug(\"{}: Success responding to deletion of topic {}\", logContext, topicName);\n                         } else {\n+                            topicOperator.incrementFailedReconciliationsCounter();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxODkxNQ=="}, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MDcyMzQxOnYy", "diffSide": "RIGHT", "path": "topic-operator/src/test/java/io/strimzi/operator/topic/TopicOperatorTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwODozMjoxNlrOGKdYww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwODozMjoxNlrOGKdYww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYyMDQxOQ==", "bodyText": "Rather than adding specific tests for the metrics, did you consider adding assertions on the metrics to the existing tests in TOT? That would provide better coverage.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413620419", "createdAt": "2020-04-23T08:32:16Z", "author": {"login": "tombentley"}, "path": "topic-operator/src/test/java/io/strimzi/operator/topic/TopicOperatorTest.java", "diffHunk": "@@ -995,6 +1008,90 @@ public void testReconcileAllTopics_listMapsFails(VertxTestContext context) {\n         }));\n     }\n \n+    @Test\n+    public void testFailedReconcileMetrics(VertxTestContext context) throws InterruptedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5NzEzNTc0OnYy", "diffSide": "RIGHT", "path": "systemtest/src/test/java/io/strimzi/systemtest/metrics/MetricsST.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTozMToyMlrOGOEldQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTo1MDoyMlrOGOFcTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQwODM3Mw==", "bodyText": "Do we rly needs this for getExpectedTopics().size() ?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r417408373", "createdAt": "2020-04-29T15:31:22Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/metrics/MetricsST.java", "diffHunk": "@@ -316,6 +332,21 @@ void setupEnvironment() throws InterruptedException {\n         kafkaExporterMetricsData = MetricsUtils.collectKafkaExporterPodsMetrics(CLUSTER_NAME);\n         kafkaMirrorMaker2MetricsData = MetricsUtils.collectKafkaMirrorMaker2PodsMetrics(MIRROR_MAKER_CLUSTER);\n         userOperatorMetricsData = MetricsUtils.collectUserOperatorPodMetrics(CLUSTER_NAME);\n+        topicOperatorMetricsData = MetricsUtils.collectTopicOperatorPodMetrics(CLUSTER_NAME);\n         clusterOperatorMetricsData = MetricsUtils.collectClusterOperatorPodMetrics();\n     }\n+    \n+    private List<String> getExpectedTopics() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b614665c596a86037b44df8b4aed8849b4a090c7"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyMjQxMw==", "bodyText": "I added it because someone can say I am just making up it should be x.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r417422413", "createdAt": "2020-04-29T15:50:22Z", "author": {"login": "sknot-rh"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/metrics/MetricsST.java", "diffHunk": "@@ -316,6 +332,21 @@ void setupEnvironment() throws InterruptedException {\n         kafkaExporterMetricsData = MetricsUtils.collectKafkaExporterPodsMetrics(CLUSTER_NAME);\n         kafkaMirrorMaker2MetricsData = MetricsUtils.collectKafkaMirrorMaker2PodsMetrics(MIRROR_MAKER_CLUSTER);\n         userOperatorMetricsData = MetricsUtils.collectUserOperatorPodMetrics(CLUSTER_NAME);\n+        topicOperatorMetricsData = MetricsUtils.collectTopicOperatorPodMetrics(CLUSTER_NAME);\n         clusterOperatorMetricsData = MetricsUtils.collectClusterOperatorPodMetrics();\n     }\n+    \n+    private List<String> getExpectedTopics() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQwODM3Mw=="}, "originalCommit": {"oid": "b614665c596a86037b44df8b4aed8849b4a090c7"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNzQ1MDY0OnYy", "diffSide": "RIGHT", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQxNToxMzoxMVrOGPj46w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQxNToxMzoxMVrOGPj46w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk2OTgzNQ==", "bodyText": "This looks wrong to me -> In the other operators:\n\nEvery periodic reconciliation increases the periodic counter + triggers reconciliation for every resource (topic in this case)\nEvery reconcilition for a prticular topic triggers its own counter\n\nThe sucess and failure counters as well as timers are counted only against the particular topics reconciliation. Not against the periodic reconciliations. So I don't think you should increment here the failed and success counters.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r418969835", "createdAt": "2020-05-02T15:13:11Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -223,6 +224,12 @@ public void handle(Long oldTimerId) {\n                             timerId = null;\n                             boolean isInitialReconcile = oldTimerId == null;\n                             topicOperator.reconcileAllTopics(isInitialReconcile ? \"initial \" : \"periodic \").setHandler(result -> {\n+                                topicOperator.getPeriodicReconciliationsCounter().increment();\n+                                if (result.failed()) {\n+                                    topicOperator.incrementFailedReconciliationsCounter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c8d0e9ce028c06fbb6040ac9df2de9dbbdd418c"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNzQ1MzM4OnYy", "diffSide": "RIGHT", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQxNToxNjoxMFrOGPj6Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQxNToxNjoxMFrOGPj6Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3MDE2Mg==", "bodyText": "I don't really understand the TO much. But do we have to do this in these onTopic* methods? Seems a but fragile to me and must be hard to test. Isn't there some method which is calling these where you can set it?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r418970162", "createdAt": "2020-05-02T15:16:10Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -700,7 +774,7 @@ void enqueue(Handler<Void> event) {\n     /** Called when a topic znode is deleted in ZK */\n     Future<Void> onTopicDeleted(LogContext logContext, TopicName topicName) {\n         return executeWithTopicLockHeld(logContext, topicName,\n-            new Reconciliation(\"onTopicDeleted\") {\n+            new Reconciliation(\"onTopicDeleted\", Timer.start(metrics.meterRegistry())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c8d0e9ce028c06fbb6040ac9df2de9dbbdd418c"}, "originalPosition": 138}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNzQ1NTMzOnYy", "diffSide": "RIGHT", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/ZkTopicsWatcher.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQxNToxODoyOFrOGPj7LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQxNToxODoyOFrOGPj7LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3MDQxMw==", "bodyText": "This looks a bit fragile, but I assume it works. The other operator set the topic counter in the reconcileAll method which easily gets the count of all topics with every periodic reconciliation. But not sure that is any easier or harder in the TO.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r418970413", "createdAt": "2020-05-02T15:18:28Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/ZkTopicsWatcher.java", "diffHunk": "@@ -84,6 +84,7 @@ void start(Zk zk) {\n                     LogContext logContext = LogContext.zkWatch(TOPICS_ZNODE, \"-\" + topicName);\n                     topicOperator.onTopicDeleted(logContext, new TopicName(topicName)).setHandler(ar -> {\n                         if (ar.succeeded()) {\n+                            topicOperator.decrementTopicCounter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c8d0e9ce028c06fbb6040ac9df2de9dbbdd418c"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 214, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}