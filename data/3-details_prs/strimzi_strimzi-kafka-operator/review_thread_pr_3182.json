{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNDMzOTg1", "number": 3182, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxOTowMDozNlrOEEz7Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxOTowMDozNlrOEEz7Hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjczNDgwNDc5OnYy", "diffSide": "RIGHT", "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxOTowMDozNlrOGiqxIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxOToyODoxMFrOGirm9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNTQ3Mg==", "bodyText": "interesting to know why this move should help :-)", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3182#discussion_r439005472", "createdAt": "2020-06-11T19:00:36Z", "author": {"login": "ppatierno"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -240,11 +240,12 @@ public void handle(Long oldTimerId) {\n     }\n \n     public void setupMetrics() {\n-        new ClassLoaderMetrics().bindTo(METRICS_REGISTRY);\n-        new JvmMemoryMetrics().bindTo(METRICS_REGISTRY);\n-        new ProcessorMetrics().bindTo(METRICS_REGISTRY);\n-        new JvmThreadMetrics().bindTo(METRICS_REGISTRY);\n-        new JvmGcMetrics().bindTo(METRICS_REGISTRY);\n+        this.metricsRegistry = (PrometheusMeterRegistry) BackendRegistries.getDefaultNow();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "031e2e95356d66b5cef244eb3535371fa069eb36"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAxMjg0Nw==", "bodyText": "I knew it is something with metrics. So this was just a desperate move. But now we have the same approach in all operators.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3182#discussion_r439012847", "createdAt": "2020-06-11T19:15:32Z", "author": {"login": "sknot-rh"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -240,11 +240,12 @@ public void handle(Long oldTimerId) {\n     }\n \n     public void setupMetrics() {\n-        new ClassLoaderMetrics().bindTo(METRICS_REGISTRY);\n-        new JvmMemoryMetrics().bindTo(METRICS_REGISTRY);\n-        new ProcessorMetrics().bindTo(METRICS_REGISTRY);\n-        new JvmThreadMetrics().bindTo(METRICS_REGISTRY);\n-        new JvmGcMetrics().bindTo(METRICS_REGISTRY);\n+        this.metricsRegistry = (PrometheusMeterRegistry) BackendRegistries.getDefaultNow();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNTQ3Mg=="}, "originalCommit": {"oid": "031e2e95356d66b5cef244eb3535371fa069eb36"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAxNTUxNw==", "bodyText": "Let's see what will happen when I will remove this method in a coming PR. It's not needed for enabling these metrics. Let's hope it won't screw up tests again :-)", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3182#discussion_r439015517", "createdAt": "2020-06-11T19:20:55Z", "author": {"login": "ppatierno"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -240,11 +240,12 @@ public void handle(Long oldTimerId) {\n     }\n \n     public void setupMetrics() {\n-        new ClassLoaderMetrics().bindTo(METRICS_REGISTRY);\n-        new JvmMemoryMetrics().bindTo(METRICS_REGISTRY);\n-        new ProcessorMetrics().bindTo(METRICS_REGISTRY);\n-        new JvmThreadMetrics().bindTo(METRICS_REGISTRY);\n-        new JvmGcMetrics().bindTo(METRICS_REGISTRY);\n+        this.metricsRegistry = (PrometheusMeterRegistry) BackendRegistries.getDefaultNow();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNTQ3Mg=="}, "originalCommit": {"oid": "031e2e95356d66b5cef244eb3535371fa069eb36"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAxOTI1Mw==", "bodyText": "The problem is not in the metrics but in the registry. It seems to have some kind of weird asynch initialization / destroying of the registry which is causing problem. Funny enough, I think we did the change which Stanislav changed now exactly because of NPEs on Jenkins :-o", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3182#discussion_r439019253", "createdAt": "2020-06-11T19:28:10Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -240,11 +240,12 @@ public void handle(Long oldTimerId) {\n     }\n \n     public void setupMetrics() {\n-        new ClassLoaderMetrics().bindTo(METRICS_REGISTRY);\n-        new JvmMemoryMetrics().bindTo(METRICS_REGISTRY);\n-        new ProcessorMetrics().bindTo(METRICS_REGISTRY);\n-        new JvmThreadMetrics().bindTo(METRICS_REGISTRY);\n-        new JvmGcMetrics().bindTo(METRICS_REGISTRY);\n+        this.metricsRegistry = (PrometheusMeterRegistry) BackendRegistries.getDefaultNow();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTAwNTQ3Mg=="}, "originalCommit": {"oid": "031e2e95356d66b5cef244eb3535371fa069eb36"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1659, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}