{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwODgzNzM3", "number": 2505, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNjowMDozOVrODdkkwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNjowMDozOVrODdkkwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMzM0NTI5OnYy", "diffSide": "RIGHT", "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kubeUtils/objects/PersistentVolumeClaimUtils.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQwNjowMDozOVrOFmQEIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMToxODo1MVrOFm6BXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1MzQxMQ==", "bodyText": "a question ... we have deleteClaim property on the storage which is actually for deleting PVCs when the cluster is deployed. Should you set this flag for your deployed Kafka cluster and then waiting just for deletion instead of forcing it?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2505#discussion_r375653411", "createdAt": "2020-02-06T06:00:39Z", "author": {"login": "ppatierno"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kubeUtils/objects/PersistentVolumeClaimUtils.java", "diffHunk": "@@ -47,4 +50,22 @@ public static void waitUntilPVCAnnotationChange(Map<String, String> newAnnotatio\n             });\n         LOGGER.info(\"PVC annotation has changed {}\", newAnnotation.toString());\n     }\n+\n+    public static void waitUntilPVCDeletion(String clusterName) {\n+        LOGGER.info(\"Waiting till PVC deletion for cluster {}\", clusterName);\n+        TestUtils.waitFor(\"Waiting till PVC will be deleted {}\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_STATUS_TIMEOUT,\n+            () -> {\n+                List<PersistentVolumeClaim> pvcList = kubeClient().listPersistentVolumeClaims().stream().filter(pvc -> pvc.getMetadata().getName().contains(clusterName)).collect(Collectors.toList());\n+                if (pvcList.isEmpty()) {\n+                    return true;\n+                } else {\n+                    for (PersistentVolumeClaim pvc : pvcList) {\n+                        LOGGER.warn(\"PVC {} is not deleted yet! Triggering force delete by cmd client!\", pvc.getMetadata().getName());\n+                        cmdKubeClient().deleteByName(\"pvc\", pvc.getMetadata().getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02cea7bbbc2325f99fc7fcf2dc95abcca62002b2"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTgwNDUyNA==", "bodyText": "It's a valid point. I was thinking that we have deleteClaim: true by default but by default it's set to fase. I will change this as well. However, this check which I added is just double check that everything is deleted before new test starts and in case if's still up, we force the deletion. We are doing same with STs, Deployment, etc.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2505#discussion_r375804524", "createdAt": "2020-02-06T12:25:07Z", "author": {"login": "Frawless"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kubeUtils/objects/PersistentVolumeClaimUtils.java", "diffHunk": "@@ -47,4 +50,22 @@ public static void waitUntilPVCAnnotationChange(Map<String, String> newAnnotatio\n             });\n         LOGGER.info(\"PVC annotation has changed {}\", newAnnotation.toString());\n     }\n+\n+    public static void waitUntilPVCDeletion(String clusterName) {\n+        LOGGER.info(\"Waiting till PVC deletion for cluster {}\", clusterName);\n+        TestUtils.waitFor(\"Waiting till PVC will be deleted {}\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_STATUS_TIMEOUT,\n+            () -> {\n+                List<PersistentVolumeClaim> pvcList = kubeClient().listPersistentVolumeClaims().stream().filter(pvc -> pvc.getMetadata().getName().contains(clusterName)).collect(Collectors.toList());\n+                if (pvcList.isEmpty()) {\n+                    return true;\n+                } else {\n+                    for (PersistentVolumeClaim pvc : pvcList) {\n+                        LOGGER.warn(\"PVC {} is not deleted yet! Triggering force delete by cmd client!\", pvc.getMetadata().getName());\n+                        cmdKubeClient().deleteByName(\"pvc\", pvc.getMetadata().getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1MzQxMQ=="}, "originalCommit": {"oid": "02cea7bbbc2325f99fc7fcf2dc95abcca62002b2"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg0MTg2NQ==", "bodyText": "So it means that it's the current test deleting the PVCs if you are leaving the deleteClaim to the default false.\nI guess it's not the purpose of this test to check that deleteClaim is working fine when it's true. Do you have a corresponding ST for it?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2505#discussion_r375841865", "createdAt": "2020-02-06T13:47:15Z", "author": {"login": "ppatierno"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kubeUtils/objects/PersistentVolumeClaimUtils.java", "diffHunk": "@@ -47,4 +50,22 @@ public static void waitUntilPVCAnnotationChange(Map<String, String> newAnnotatio\n             });\n         LOGGER.info(\"PVC annotation has changed {}\", newAnnotation.toString());\n     }\n+\n+    public static void waitUntilPVCDeletion(String clusterName) {\n+        LOGGER.info(\"Waiting till PVC deletion for cluster {}\", clusterName);\n+        TestUtils.waitFor(\"Waiting till PVC will be deleted {}\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_STATUS_TIMEOUT,\n+            () -> {\n+                List<PersistentVolumeClaim> pvcList = kubeClient().listPersistentVolumeClaims().stream().filter(pvc -> pvc.getMetadata().getName().contains(clusterName)).collect(Collectors.toList());\n+                if (pvcList.isEmpty()) {\n+                    return true;\n+                } else {\n+                    for (PersistentVolumeClaim pvc : pvcList) {\n+                        LOGGER.warn(\"PVC {} is not deleted yet! Triggering force delete by cmd client!\", pvc.getMetadata().getName());\n+                        cmdKubeClient().deleteByName(\"pvc\", pvc.getMetadata().getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1MzQxMQ=="}, "originalCommit": {"oid": "02cea7bbbc2325f99fc7fcf2dc95abcca62002b2"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2NzMwOQ==", "bodyText": "Yes we have separated tests for that. I will double check if they are working as expected with these changes just to avoid need to create another fix PR.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2505#discussion_r376267309", "createdAt": "2020-02-07T08:31:36Z", "author": {"login": "Frawless"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kubeUtils/objects/PersistentVolumeClaimUtils.java", "diffHunk": "@@ -47,4 +50,22 @@ public static void waitUntilPVCAnnotationChange(Map<String, String> newAnnotatio\n             });\n         LOGGER.info(\"PVC annotation has changed {}\", newAnnotation.toString());\n     }\n+\n+    public static void waitUntilPVCDeletion(String clusterName) {\n+        LOGGER.info(\"Waiting till PVC deletion for cluster {}\", clusterName);\n+        TestUtils.waitFor(\"Waiting till PVC will be deleted {}\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_STATUS_TIMEOUT,\n+            () -> {\n+                List<PersistentVolumeClaim> pvcList = kubeClient().listPersistentVolumeClaims().stream().filter(pvc -> pvc.getMetadata().getName().contains(clusterName)).collect(Collectors.toList());\n+                if (pvcList.isEmpty()) {\n+                    return true;\n+                } else {\n+                    for (PersistentVolumeClaim pvc : pvcList) {\n+                        LOGGER.warn(\"PVC {} is not deleted yet! Triggering force delete by cmd client!\", pvc.getMetadata().getName());\n+                        cmdKubeClient().deleteByName(\"pvc\", pvc.getMetadata().getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1MzQxMQ=="}, "originalCommit": {"oid": "02cea7bbbc2325f99fc7fcf2dc95abcca62002b2"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM0MDgzMA==", "bodyText": "Tests related to deleteClaim options are fine so I am going to mark this one as ready for merge.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2505#discussion_r376340830", "createdAt": "2020-02-07T11:18:51Z", "author": {"login": "Frawless"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kubeUtils/objects/PersistentVolumeClaimUtils.java", "diffHunk": "@@ -47,4 +50,22 @@ public static void waitUntilPVCAnnotationChange(Map<String, String> newAnnotatio\n             });\n         LOGGER.info(\"PVC annotation has changed {}\", newAnnotation.toString());\n     }\n+\n+    public static void waitUntilPVCDeletion(String clusterName) {\n+        LOGGER.info(\"Waiting till PVC deletion for cluster {}\", clusterName);\n+        TestUtils.waitFor(\"Waiting till PVC will be deleted {}\", Constants.GLOBAL_POLL_INTERVAL, Constants.GLOBAL_STATUS_TIMEOUT,\n+            () -> {\n+                List<PersistentVolumeClaim> pvcList = kubeClient().listPersistentVolumeClaims().stream().filter(pvc -> pvc.getMetadata().getName().contains(clusterName)).collect(Collectors.toList());\n+                if (pvcList.isEmpty()) {\n+                    return true;\n+                } else {\n+                    for (PersistentVolumeClaim pvc : pvcList) {\n+                        LOGGER.warn(\"PVC {} is not deleted yet! Triggering force delete by cmd client!\", pvc.getMetadata().getName());\n+                        cmdKubeClient().deleteByName(\"pvc\", pvc.getMetadata().getName());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTY1MzQxMQ=="}, "originalCommit": {"oid": "02cea7bbbc2325f99fc7fcf2dc95abcca62002b2"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 419, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}