{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1NTczMzkz", "number": 2857, "title": "Fix waitForObserved for DeploymentConfigs to make the operator wait for roll outs", "bodyText": "Type of change\n\nBugfix\n\nDescription\nThe operator should always wait until the deployment or a new update is finished. With DeploymentConfigs on OCP, this currently does not seem to work. The waitForObserved which waits for the roll out of the new version to be started doesn't seem to catch the roll out properly. It is currently based on the current generation from metadata and the observed generation from status. But with DeploymentConfig, the generation seems to take more time to change and this test is passing with the old generation.\nThis PR adds additional condition to detect whether the generation change is still in progress and waits for the generation to update.\nThis needs ot be covered by system tests, since we need to make sure it works and doesn't cause any problems on real OCP deployments, to be covered to catch all the different behaviours whcih might occur. Writting a system test for single variant would not help much.\nTested on OCP 3.11 and 4.\nChecklist\n\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally", "createdAt": "2020-04-18T23:07:03Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857", "merged": true, "mergeCommit": {"oid": "cf4707e88c1cc4ad721b2ba8db013074113e9d96"}, "closed": true, "closedAt": "2020-04-21T12:58:57Z", "author": {"login": "scholzj"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcY-GBCgH2gAyNDA1NTczMzkzOmE3NTAwMWJlMzRkMDE1MjA5YmIyZjg2OTM3YjhhY2JhYTM1MzUwY2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZxnaPgFqTM5NzIyMTIyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a75001be34d015209bb2f86937b8acbaa35350cd", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a75001be34d015209bb2f86937b8acbaa35350cd", "committedDate": "2020-04-18T23:00:57Z", "message": "Fix waitForObserved for DeploymentConfigs to make the operator wait for roll outs\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "876f4d3fa1709b0b01bc58ecff3106ca42cd5abe", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/876f4d3fa1709b0b01bc58ecff3106ca42cd5abe", "committedDate": "2020-04-18T23:04:13Z", "message": "Fix imports\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MDAyNjk3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857#pullrequestreview-396002697", "createdAt": "2020-04-19T10:46:52Z", "commit": {"oid": "876f4d3fa1709b0b01bc58ecff3106ca42cd5abe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOVQxMDo0Njo1MlrOGH14KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xOVQxMDo0Njo1MlrOGH14KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDg3NTk0NQ==", "bodyText": "Just to avoid confusion around double negatives, might it be worth changing this to\nrollOutStarted = true\n\nAs we assume it has started unless the condition states otherwise", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857#discussion_r410875945", "createdAt": "2020-04-19T10:46:52Z", "author": {"login": "samuel-hawker"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/operator/resource/DeploymentConfigOperator.java", "diffHunk": "@@ -72,9 +73,35 @@ protected Integer currentScale(String namespace, String name) {\n     private boolean isObserved(String namespace, String name) {\n         DeploymentConfig dep = get(namespace, name);\n         if (dep != null)   {\n-            return dep.getMetadata().getGeneration().equals(dep.getStatus().getObservedGeneration());\n+            // Get the roll out status\n+            //     => Sometimes it takes OCP some time before the generations are updated.\n+            //        So we need to check the conditions in addition to detect such situation.\n+            boolean rollOutNotStartedYet = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "876f4d3fa1709b0b01bc58ecff3106ca42cd5abe"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9ae06720e2bab4706f0ddac2bbf155c0f64615a", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a9ae06720e2bab4706f0ddac2bbf155c0f64615a", "committedDate": "2020-04-19T19:15:40Z", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MjE2ODQ2", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857#pullrequestreview-397216846", "createdAt": "2020-04-21T10:56:05Z", "commit": {"oid": "a9ae06720e2bab4706f0ddac2bbf155c0f64615a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMDo1NjowNVrOGI_inw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMDo1NjowNVrOGI_inw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Mjg0Nw==", "bodyText": "should it be valid just for \"Ready\". Is it possible that the status is \"NotReady\" so anyway different from \"Unkown\"?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857#discussion_r412082847", "createdAt": "2020-04-21T10:56:05Z", "author": {"login": "ppatierno"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/operator/resource/DeploymentConfigOperator.java", "diffHunk": "@@ -72,9 +73,35 @@ protected Integer currentScale(String namespace, String name) {\n     private boolean isObserved(String namespace, String name) {\n         DeploymentConfig dep = get(namespace, name);\n         if (dep != null)   {\n-            return dep.getMetadata().getGeneration().equals(dep.getStatus().getObservedGeneration());\n+            // Get the roll out status\n+            //     => Sometimes it takes OCP some time before the generations are updated.\n+            //        So we need to check the conditions in addition to detect such situation.\n+            boolean rollOutNotStarting = true;\n+            DeploymentCondition progressing = getProgressingCondition(dep);\n+\n+            if (progressing != null)    {\n+                rollOutNotStarting = progressing.getReason() != null && !\"Unknown\".equals(progressing.getStatus());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9ae06720e2bab4706f0ddac2bbf155c0f64615a"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MjIxMjIy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2857#pullrequestreview-397221222", "createdAt": "2020-04-21T11:02:35Z", "commit": {"oid": "a9ae06720e2bab4706f0ddac2bbf155c0f64615a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1902, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}