{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczMTI2MTIy", "number": 3546, "title": "[systemtest][upgrade] Attempt to deflake the upgrade tests and fix sending/receiving messages during upgrade", "bodyText": "Signed-off-by: Lukas Kral lukywill16@gmail.com\nType of change\n\nBugfix\n\nDescription\nIn #3200 I totally forgot that the change of --broker-list to --boostrap-server can affect older versions of Kafka (during the upgrade) -> I tested it only with Kafka 2.5.0 and 2.6.0, problem is that --boostrap-server option was added to 2.5.0. So I added ternary operator to determine which option use based on Kafka version.\nAlso this is an attempt to deflake the upgrade tests. I assume that main problem of the flakyness was this block of code:\nif (KafkaTopicResource.kafkaTopicClient().inNamespace(NAMESPACE).withName(continuousTopicName).get() == null) {\n                KafkaTopicResource.topic(CLUSTER_NAME, continuousTopicName, 3, 3, 2).done();\n                // Add continuous topic to expectedTopicCount which will be check after upgrade procedures\n                expectedTopicCount += 1;\n            }\n\nThe problem is that if happen that topic is deleted and recreated, the expectedTopicCount will be increased and next check will not pass. This assumption is based on given result from PR run:\n[WARNING] Flakes: \n[WARNING] io.strimzi.systemtest.upgrade.StrimziUpgradeST.testUpgradeStrimziVersion(JsonObject)[9]\n[ERROR]   Run 1: StrimziUpgradeST.testUpgradeStrimziVersion:97->performUpgrade:351 KafkaTopic list doesn't have expected size\nExpected: is <44>\n     but: was <43>\n[INFO]   Run 2: PASS\n\nChecklist\n\n Make sure all tests pass", "createdAt": "2020-08-25T11:10:11Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3546", "merged": true, "mergeCommit": {"oid": "16c9018dac26900726e2e1ba80d4d5ae60581b28"}, "closed": true, "closedAt": "2020-08-27T11:22:03Z", "author": {"login": "im-konge"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCWEVoAFqTQ3NDQwNTA4Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdC-m4aAFqTQ3NjYyMTMxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0NDA1MDgy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3546#pullrequestreview-474405082", "createdAt": "2020-08-25T11:54:01Z", "commit": {"oid": "14f61718fef6ed6b8f0bfe25a09edfe9b77f0295"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMTo1NDowMlrOHGUizg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMTo1NDowMlrOHGUizg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM5MDA5NA==", "bodyText": "I think we should store client version somewhere during init and there just ask about it. During clients deployment, you can get version from image name I guess and you don't need to get image from pod directly.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3546#discussion_r476390094", "createdAt": "2020-08-25T11:54:02Z", "author": {"login": "Frawless"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/kafkaclients/internalClients/VerifiableClient.java", "diffHunk": "@@ -128,18 +128,19 @@ public VerifiableClient(VerifiableClientBuilder verifiableClientBuilder) {\n \n         this.setAllowedArguments(this.clientType);\n         this.clientArgumentMap = new ClientArgumentMap();\n-        this.clientArgumentMap.put(ClientArgument.BOOTSTRAP_SERVER, bootstrapServer);\n         this.clientArgumentMap.put(ClientArgument.TOPIC, topicName);\n         this.clientArgumentMap.put(ClientArgument.MAX_MESSAGES, Integer.toString(maxMessages));\n         if (kafkaUsername != null) this.clientArgumentMap.put(ClientArgument.USER,  kafkaUsername.replace(\"-\", \"_\"));\n \n+        String image = kubeClient().getPod(this.podName).getSpec().getContainers().get(0).getImage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14f61718fef6ed6b8f0bfe25a09edfe9b77f0295"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0Nzg2MTkx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3546#pullrequestreview-474786191", "createdAt": "2020-08-25T19:26:43Z", "commit": {"oid": "14f61718fef6ed6b8f0bfe25a09edfe9b77f0295"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aca3c85778b1f364b53bf87f1eb2f79bc7a28902", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/aca3c85778b1f364b53bf87f1eb2f79bc7a28902", "committedDate": "2020-08-26T12:28:47Z", "message": "determine if use --broker-list or --bootstrap-version by Kafka version\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8af19cc67568812b2a14ceaf1c5487f73796a8d8", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8af19cc67568812b2a14ceaf1c5487f73796a8d8", "committedDate": "2020-08-26T12:28:47Z", "message": "attemp to deflake the upgrade tests\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "14f61718fef6ed6b8f0bfe25a09edfe9b77f0295", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/14f61718fef6ed6b8f0bfe25a09edfe9b77f0295", "committedDate": "2020-08-25T11:37:01Z", "message": "attemp to deflake the upgrade tests\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "719b4ce4de57e66bb1044c6359bccd7c9ed28ff7", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/719b4ce4de57e66bb1044c6359bccd7c9ed28ff7", "committedDate": "2020-08-26T12:46:21Z", "message": "change azure\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "719b4ce4de57e66bb1044c6359bccd7c9ed28ff7", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/719b4ce4de57e66bb1044c6359bccd7c9ed28ff7", "committedDate": "2020-08-26T12:46:21Z", "message": "change azure\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "8af19cc67568812b2a14ceaf1c5487f73796a8d8", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8af19cc67568812b2a14ceaf1c5487f73796a8d8", "committedDate": "2020-08-26T12:28:47Z", "message": "attemp to deflake the upgrade tests\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NjIxMzE1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3546#pullrequestreview-476621315", "createdAt": "2020-08-27T11:21:40Z", "commit": {"oid": "8af19cc67568812b2a14ceaf1c5487f73796a8d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1205, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}