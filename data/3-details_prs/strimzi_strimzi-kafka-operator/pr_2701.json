{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4Mjc3MDA1", "number": 2701, "title": "feat: Use AbstractCustomResourceOperatorIT to simplify ITs", "bodyText": "Use a new Abstract class to cut down code duplication\nAdd a new class to test KafkaConnector\nCloses: #2699\nSigned-off-by: Samuel Hawker samuel.hawker@ibm.com\nType of change\nSelect the type of your PR\n\nBugfix\nEnhancement / new feature\nRefactoring\nDocumentation\n\nDescription\nPlease describe your pull request\nChecklist\nPlease go through this checklist and make sure all applicable tasks have been done\n\n Update/write design documentation in ./design\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md", "createdAt": "2020-03-14T12:00:36Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2701", "merged": true, "mergeCommit": {"oid": "8b8be86fd0c94e86a7e67d2288bf1aeac85e34a6"}, "closed": true, "closedAt": "2020-03-19T21:41:24Z", "author": {"login": "samuel-hawker"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNZAxXAH2gAyMzg4Mjc3MDA1OmI0N2E4MTVkMTYzNTIzMzViY2NjMWY2NzY2YTBmNTA2YzE3MzRhOWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPNqEqAFqTM3NzgzMzMzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b47a815d16352335bccc1f6766a0f506c1734a9d", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b47a815d16352335bccc1f6766a0f506c1734a9d", "committedDate": "2020-03-13T23:35:34Z", "message": "feat: Use AbstractCustomResourceOperatorIT to simply ITs\n\nUse a new Abstract class to cut down code duplication\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8fda84a2db9efe0277da436736eb57abc13a013", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f8fda84a2db9efe0277da436736eb57abc13a013", "committedDate": "2020-03-14T11:53:13Z", "message": "feat: Add a tests for kafkaconnector\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d716ce76bb60bcb7d0b829357b66fc1e56f09974", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d716ce76bb60bcb7d0b829357b66fc1e56f09974", "committedDate": "2020-03-14T16:15:51Z", "message": "chore: Add comment to add clarity to annotation\n\nAnnotation required so as to make before/after\nmethods non-static\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MzEwMTE4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2701#pullrequestreview-376310118", "createdAt": "2020-03-17T18:43:29Z", "commit": {"oid": "d716ce76bb60bcb7d0b829357b66fc1e56f09974"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxODo0MzoyOVrOF3pbvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxODo1MDoyNVrOF3prJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5NDg0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            //  to correctly setup the test environment before the tests\n          \n          \n            \n            // to correctly setup the test environment before the tests.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2701#discussion_r393894847", "createdAt": "2020-03-17T18:43:29Z", "author": {"login": "tombentley"}, "path": "operator-common/src/test/java/io/strimzi/operator/common/operator/resource/AbstractCustomResourceOperatorIT.java", "diffHunk": "@@ -0,0 +1,248 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.operator.common.operator.resource;\n+\n+import io.fabric8.kubernetes.api.model.Doneable;\n+import io.fabric8.kubernetes.api.model.apiextensions.CustomResourceDefinition;\n+import io.fabric8.kubernetes.client.CustomResource;\n+import io.fabric8.kubernetes.client.CustomResourceList;\n+import io.fabric8.kubernetes.client.DefaultKubernetesClient;\n+import io.fabric8.kubernetes.client.KubernetesClient;\n+import io.fabric8.kubernetes.client.KubernetesClientException;\n+import io.strimzi.api.kafka.model.status.Condition;\n+import io.strimzi.api.kafka.model.status.ConditionBuilder;\n+import io.strimzi.operator.KubernetesVersion;\n+import io.strimzi.operator.PlatformFeaturesAvailability;\n+import io.strimzi.test.k8s.KubeClusterResource;\n+import io.strimzi.test.k8s.cluster.KubeCluster;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.junit5.Checkpoint;\n+import io.vertx.junit5.VertxExtension;\n+import io.vertx.junit5.VertxTestContext;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.hamcrest.CoreMatchers;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import static io.strimzi.test.k8s.KubeClusterResource.cmdKubeClient;\n+import static io.strimzi.test.k8s.KubeClusterResource.kubeClient;\n+import static org.hamcrest.CoreMatchers.instanceOf;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.lessThan;\n+import static org.hamcrest.Matchers.not;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+\n+/**\n+ * The main purpose of the Integration Tests for the operators is to test them against a real Kubernetes cluster.\n+ * Real Kubernetes cluster has often some quirks such as some fields being immutable, some fields in the spec section\n+ * being created by the Kubernetes API etc. These things are hard to test with mocks. These IT tests make it easy to\n+ * test them against real clusters.\n+ */\n+@ExtendWith(VertxExtension.class)\n+// TestInstance lifecycle set to per class so that @BeforeAll and @AfterAll methods are non static\n+// Methods must be be non static as they make a non-static call to getCrd()\n+//  to correctly setup the test environment before the tests", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d716ce76bb60bcb7d0b829357b66fc1e56f09974"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5NDk3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            // TestInstance lifecycle set to per class so that @BeforeAll and @AfterAll methods are non static\n          \n          \n            \n            // TestInstance lifecycle set to per class so that @BeforeAll and @AfterAll methods are non static.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2701#discussion_r393894972", "createdAt": "2020-03-17T18:43:41Z", "author": {"login": "tombentley"}, "path": "operator-common/src/test/java/io/strimzi/operator/common/operator/resource/AbstractCustomResourceOperatorIT.java", "diffHunk": "@@ -0,0 +1,248 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.operator.common.operator.resource;\n+\n+import io.fabric8.kubernetes.api.model.Doneable;\n+import io.fabric8.kubernetes.api.model.apiextensions.CustomResourceDefinition;\n+import io.fabric8.kubernetes.client.CustomResource;\n+import io.fabric8.kubernetes.client.CustomResourceList;\n+import io.fabric8.kubernetes.client.DefaultKubernetesClient;\n+import io.fabric8.kubernetes.client.KubernetesClient;\n+import io.fabric8.kubernetes.client.KubernetesClientException;\n+import io.strimzi.api.kafka.model.status.Condition;\n+import io.strimzi.api.kafka.model.status.ConditionBuilder;\n+import io.strimzi.operator.KubernetesVersion;\n+import io.strimzi.operator.PlatformFeaturesAvailability;\n+import io.strimzi.test.k8s.KubeClusterResource;\n+import io.strimzi.test.k8s.cluster.KubeCluster;\n+import io.vertx.core.Promise;\n+import io.vertx.core.Vertx;\n+import io.vertx.junit5.Checkpoint;\n+import io.vertx.junit5.VertxExtension;\n+import io.vertx.junit5.VertxTestContext;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.hamcrest.CoreMatchers;\n+import org.junit.jupiter.api.AfterAll;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.TestInstance;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import static io.strimzi.test.k8s.KubeClusterResource.cmdKubeClient;\n+import static io.strimzi.test.k8s.KubeClusterResource.kubeClient;\n+import static org.hamcrest.CoreMatchers.instanceOf;\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.lessThan;\n+import static org.hamcrest.Matchers.not;\n+import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;\n+\n+/**\n+ * The main purpose of the Integration Tests for the operators is to test them against a real Kubernetes cluster.\n+ * Real Kubernetes cluster has often some quirks such as some fields being immutable, some fields in the spec section\n+ * being created by the Kubernetes API etc. These things are hard to test with mocks. These IT tests make it easy to\n+ * test them against real clusters.\n+ */\n+@ExtendWith(VertxExtension.class)\n+// TestInstance lifecycle set to per class so that @BeforeAll and @AfterAll methods are non static", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d716ce76bb60bcb7d0b829357b66fc1e56f09974"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5Nzk0NA==", "bodyText": "You should be able to extend the non-raw type in the class declaration so this method is better typed and avoid having the downcast on the following line", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2701#discussion_r393897944", "createdAt": "2020-03-17T18:48:49Z", "author": {"login": "tombentley"}, "path": "operator-common/src/test/java/io/strimzi/operator/common/operator/resource/KafkaBridgeCrdOperatorIT.java", "diffHunk": "@@ -119,153 +61,32 @@ protected KafkaBridge getResource() {\n                 .build();\n     }\n \n-    @Test\n-    public void testUpdateStatus(VertxTestContext context) {\n-        Checkpoint async = context.checkpoint();\n-\n-        log.info(\"Getting Kubernetes version\");\n-        PlatformFeaturesAvailability.create(vertx, client)\n-            .setHandler(context.succeeding(pfa -> context.verify(() -> {\n-                assertThat(\"Kubernetes version : \" + pfa.getKubernetesVersion() + \" is too old\",\n-                        pfa.getKubernetesVersion().compareTo(KubernetesVersion.V1_11), is(not(lessThan(0))));\n-            })))\n-\n-            .compose(pfa -> {\n-                log.info(\"Creating resource\");\n-                return kafkaBridgeOperator.reconcile(namespace, RESOURCE_NAME, getResource());\n-            })\n-            .setHandler(context.succeeding())\n-\n-            .compose(rrCreated -> {\n-                KafkaBridge newStatus = new KafkaBridgeBuilder(kafkaBridgeOperator.get(namespace, RESOURCE_NAME))\n-                        .withNewStatus()\n-                        .withConditions(new ConditionBuilder()\n-                                .withType(\"Ready\")\n-                                .withStatus(\"True\")\n-                                .build())\n-                        .endStatus()\n-                        .build();\n-\n-                log.info(\"Updating resource status\");\n-                return kafkaBridgeOperator.updateStatusAsync(newStatus);\n-            })\n-            .setHandler(context.succeeding())\n-\n-            .compose(rrModified -> kafkaBridgeOperator.getAsync(namespace, RESOURCE_NAME))\n-            .setHandler(context.succeeding(modifiedKafkaBridge -> context.verify(() -> {\n-                assertThat(modifiedKafkaBridge.getStatus().getConditions().get(0).getType(), is(\"Ready\"));\n-                assertThat(modifiedKafkaBridge.getStatus().getConditions().get(0).getStatus(), is(\"True\"));\n-            })))\n-\n-            .compose(rrModified -> {\n-                log.info(\"Deleting resource\");\n-                return kafkaBridgeOperator.reconcile(namespace, RESOURCE_NAME, null);\n-            })\n-            .setHandler(context.succeeding(rrDeleted ->  async.flag()));\n+    @Override\n+    protected CustomResource getResourceWithModifications(CustomResource resourceInCluster) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d716ce76bb60bcb7d0b829357b66fc1e56f09974"}, "originalPosition": 175}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5ODI2Mg==", "bodyText": "Same comment.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2701#discussion_r393898262", "createdAt": "2020-03-17T18:49:25Z", "author": {"login": "tombentley"}, "path": "operator-common/src/test/java/io/strimzi/operator/common/operator/resource/KafkaBridgeCrdOperatorIT.java", "diffHunk": "@@ -119,153 +61,32 @@ protected KafkaBridge getResource() {\n                 .build();\n     }\n \n-    @Test\n-    public void testUpdateStatus(VertxTestContext context) {\n-        Checkpoint async = context.checkpoint();\n-\n-        log.info(\"Getting Kubernetes version\");\n-        PlatformFeaturesAvailability.create(vertx, client)\n-            .setHandler(context.succeeding(pfa -> context.verify(() -> {\n-                assertThat(\"Kubernetes version : \" + pfa.getKubernetesVersion() + \" is too old\",\n-                        pfa.getKubernetesVersion().compareTo(KubernetesVersion.V1_11), is(not(lessThan(0))));\n-            })))\n-\n-            .compose(pfa -> {\n-                log.info(\"Creating resource\");\n-                return kafkaBridgeOperator.reconcile(namespace, RESOURCE_NAME, getResource());\n-            })\n-            .setHandler(context.succeeding())\n-\n-            .compose(rrCreated -> {\n-                KafkaBridge newStatus = new KafkaBridgeBuilder(kafkaBridgeOperator.get(namespace, RESOURCE_NAME))\n-                        .withNewStatus()\n-                        .withConditions(new ConditionBuilder()\n-                                .withType(\"Ready\")\n-                                .withStatus(\"True\")\n-                                .build())\n-                        .endStatus()\n-                        .build();\n-\n-                log.info(\"Updating resource status\");\n-                return kafkaBridgeOperator.updateStatusAsync(newStatus);\n-            })\n-            .setHandler(context.succeeding())\n-\n-            .compose(rrModified -> kafkaBridgeOperator.getAsync(namespace, RESOURCE_NAME))\n-            .setHandler(context.succeeding(modifiedKafkaBridge -> context.verify(() -> {\n-                assertThat(modifiedKafkaBridge.getStatus().getConditions().get(0).getType(), is(\"Ready\"));\n-                assertThat(modifiedKafkaBridge.getStatus().getConditions().get(0).getStatus(), is(\"True\"));\n-            })))\n-\n-            .compose(rrModified -> {\n-                log.info(\"Deleting resource\");\n-                return kafkaBridgeOperator.reconcile(namespace, RESOURCE_NAME, null);\n-            })\n-            .setHandler(context.succeeding(rrDeleted ->  async.flag()));\n+    @Override\n+    protected CustomResource getResourceWithModifications(CustomResource resourceInCluster) {\n+        return new KafkaBridgeBuilder((KafkaBridge) resourceInCluster)\n+                .editSpec()\n+                .withLogging(new InlineLogging())\n+                .endSpec()\n+                .build();\n     }\n \n-    /**\n-     * Tests what happens when the resource is deleted while updating the status\n-     *\n-     * @param context\n-     */\n-    @Test\n-    public void testUpdateStatusWhileResourceDeletedThrowsNullPointerException(VertxTestContext context) {\n-        Checkpoint async = context.checkpoint();\n-\n-        log.info(\"Getting Kubernetes version\");\n-        PlatformFeaturesAvailability.create(vertx, client)\n-            .setHandler(context.succeeding(pfa -> context.verify(() -> {\n-                assertThat(\"Kubernetes version : \" + pfa.getKubernetesVersion() + \" is too old\",\n-                        pfa.getKubernetesVersion().compareTo(KubernetesVersion.V1_11), is(not(lessThan(0))));\n-            })))\n-            .compose(pfa -> {\n-                log.info(\"Creating resource\");\n-                return kafkaBridgeOperator.reconcile(namespace, RESOURCE_NAME, getResource());\n-            })\n-            .setHandler(context.succeeding())\n-\n-            .compose(rr -> {\n-                log.info(\"Deleting resource\");\n-                return kafkaBridgeOperator.reconcile(namespace, RESOURCE_NAME, null);\n-            })\n-            .setHandler(context.succeeding())\n-\n-            .compose(v -> {\n-                KafkaBridge newStatus = new KafkaBridgeBuilder(kafkaBridgeOperator.get(namespace, RESOURCE_NAME))\n-                        .withNewStatus()\n-                        .withConditions(new ConditionBuilder()\n-                                .withType(\"Ready\")\n-                                .withStatus(\"True\")\n-                                .build())\n-                        .endStatus()\n-                        .build();\n-\n-                log.info(\"Updating resource status\");\n-                return kafkaBridgeOperator.updateStatusAsync(newStatus);\n-            })\n-            .setHandler(context.failing(e -> context.verify(() -> {\n-                assertThat(e, instanceOf(NullPointerException.class));\n-                async.flag();\n-            })));\n+    @Override\n+    protected CustomResource getResourceWithNewReadyStatus(CustomResource resourceInCluster) {\n+        return new KafkaBridgeBuilder((KafkaBridge) resourceInCluster)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d716ce76bb60bcb7d0b829357b66fc1e56f09974"}, "originalPosition": 229}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5ODQ3OQ==", "bodyText": "Again, use generics in the extends clause.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2701#discussion_r393898479", "createdAt": "2020-03-17T18:49:50Z", "author": {"login": "tombentley"}, "path": "operator-common/src/test/java/io/strimzi/operator/common/operator/resource/KafkaConnectCrdOperatorIT.java", "diffHunk": "@@ -47,70 +27,31 @@\n  * test them against real clusters.\n  */\n @ExtendWith(VertxExtension.class)\n-public class KafkaConnectCrdOperatorIT {\n+public class KafkaConnectCrdOperatorIT extends AbstractCustomResourceOperatorIT {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d716ce76bb60bcb7d0b829357b66fc1e56f09974"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5ODc5MQ==", "bodyText": "Same comment", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2701#discussion_r393898791", "createdAt": "2020-03-17T18:50:25Z", "author": {"login": "tombentley"}, "path": "operator-common/src/test/java/io/strimzi/operator/common/operator/resource/KafkaConnectS2ICrdOperatorIT.java", "diffHunk": "@@ -46,70 +27,31 @@\n  * test them against real clusters.\n  */\n @ExtendWith(VertxExtension.class)\n-public class KafkaConnectS2ICrdOperatorIT {\n+public class KafkaConnectS2ICrdOperatorIT extends AbstractCustomResourceOperatorIT {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d716ce76bb60bcb7d0b829357b66fc1e56f09974"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2c7bc059ba4433f49bd4919d14c6bdd4786ffb0", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f2c7bc059ba4433f49bd4919d14c6bdd4786ffb0", "committedDate": "2020-03-18T14:20:33Z", "message": "feat: Use generics to not cast classes\n\nAs part of review by Tom Bentley he suggested to declare the\ntypes that I am extending the test classes with\n\nSeveral punctuation points added also.\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2OTIxNDQ1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2701#pullrequestreview-376921445", "createdAt": "2020-03-18T14:33:03Z", "commit": {"oid": "f2c7bc059ba4433f49bd4919d14c6bdd4786ffb0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODMzMzMx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2701#pullrequestreview-377833331", "createdAt": "2020-03-19T15:29:40Z", "commit": {"oid": "f2c7bc059ba4433f49bd4919d14c6bdd4786ffb0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2059, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}