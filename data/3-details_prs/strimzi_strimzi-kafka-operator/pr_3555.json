{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0MDU2MzAz", "number": 3555, "title": "[ST] test availability during nodes drain", "bodyText": "Signed-off-by: David Kornel kornys@outlook.com\nType of change\nSelect the type of your PR\n\nTest\n\nDescription\nAdded test for check strimzi behavior during kubernetes node drain.", "createdAt": "2020-08-26T17:39:26Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555", "merged": true, "mergeCommit": {"oid": "6cbde6fd8acdec5d2e99d777837b9d518d60be58"}, "closed": true, "closedAt": "2020-08-27T15:00:29Z", "author": {"login": "kornys"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCvYUVgH2gAyNDc0MDU2MzAzOjYyZWM2NTBhY2FkYmM5MWFjOGRjODU2YzI0OTkzNjU1NzNhYzRlNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdC8VcygFqTQ3NjUwODcyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "62ec650acadbc91ac8dc856c2499365573ac4e55", "author": {"user": {"login": "kornys", "name": "David Kornel"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/62ec650acadbc91ac8dc856c2499365573ac4e55", "committedDate": "2020-08-26T17:37:11Z", "message": "[ST] test availability during nodes drain\n\nSigned-off-by: David Kornel <kornys@outlook.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NzI4MTY0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#pullrequestreview-475728164", "createdAt": "2020-08-26T17:58:12Z", "commit": {"oid": "62ec650acadbc91ac8dc856c2499365573ac4e55"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNzo1ODoxMlrOHHXZyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODowMzozMVrOHHXl8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4NTUxNA==", "bodyText": "Guess you want to use there different log message.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477485514", "createdAt": "2020-08-26T17:58:12Z", "author": {"login": "Frawless"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/annotations/RequiredMinKubeApiVersionCondition.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.annotations;\n+\n+import io.strimzi.test.k8s.KubeClusterResource;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.junit.jupiter.api.extension.ConditionEvaluationResult;\n+import org.junit.jupiter.api.extension.ExecutionCondition;\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+\n+import java.util.Optional;\n+\n+import static org.junit.platform.commons.support.AnnotationSupport.findAnnotation;\n+\n+public class RequiredMinKubeApiVersionCondition implements ExecutionCondition {\n+    private static final Logger LOGGER = LogManager.getLogger(RequiredMinKubeApiVersionCondition.class);\n+\n+    @Override\n+    public ConditionEvaluationResult evaluateExecutionCondition(ExtensionContext extensionContext) {\n+        Optional<RequiredMinKubeApiVersion> annotation = findAnnotation(extensionContext.getElement(), RequiredMinKubeApiVersion.class);\n+        KubeClusterResource clusterResource = KubeClusterResource.getInstance();\n+        double version = annotation.get().version();\n+\n+        if (Double.parseDouble(clusterResource.client().clusterKubernetesVersion()) >= version) {\n+            return ConditionEvaluationResult.enabled(\"Test is enabled\");\n+        } else {\n+            LOGGER.info(\"{} is @MultiNodeClusterOnly, but the running cluster is not multi-node cluster: Ignoring {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62ec650acadbc91ac8dc856c2499365573ac4e55"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4NTc2MA==", "bodyText": "Wouldn't be better to use there real version instead of 0 ?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477485760", "createdAt": "2020-08-26T17:58:35Z", "author": {"login": "Frawless"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/annotations/RequiredMinKubeApiVersion.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.annotations;\n+\n+import org.junit.jupiter.api.extension.ExtendWith;\n+\n+import java.lang.annotation.ElementType;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+import java.lang.annotation.Target;\n+\n+@Target({ElementType.METHOD, ElementType.TYPE})\n+@Retention(RetentionPolicy.RUNTIME)\n+@ExtendWith(RequiredMinKubeApiVersionCondition.class)\n+public @interface RequiredMinKubeApiVersion {\n+    double version() default 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62ec650acadbc91ac8dc856c2499365573ac4e55"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4NjY0NA==", "bodyText": "We use indentation across whole project for piece of code like this. You should follow our current practice.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477486644", "createdAt": "2020-08-26T18:00:05Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/specific/ClusterOperationST.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.specific;\n+\n+import io.fabric8.kubernetes.api.model.Node;\n+import io.strimzi.api.kafka.model.KafkaResources;\n+import io.strimzi.systemtest.AbstractST;\n+import io.strimzi.systemtest.annotations.MultiNodeClusterOnly;\n+import io.strimzi.systemtest.annotations.RequiredMinKubeApiVersion;\n+import io.strimzi.systemtest.resources.ResourceManager;\n+import io.strimzi.systemtest.resources.crd.KafkaClientsResource;\n+import io.strimzi.systemtest.resources.crd.KafkaResource;\n+import io.strimzi.systemtest.resources.crd.KafkaTopicResource;\n+import io.strimzi.systemtest.resources.operator.BundleResource;\n+import io.strimzi.systemtest.utils.ClientUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+import static io.strimzi.systemtest.Constants.SPECIFIC;\n+import static io.strimzi.test.k8s.KubeClusterResource.cmdKubeClient;\n+import static io.strimzi.test.k8s.KubeClusterResource.kubeClient;\n+\n+@Tag(SPECIFIC)\n+public class ClusterOperationST extends AbstractST {\n+\n+    private static final Logger LOGGER = LogManager.getLogger(ClusterOperationST.class);\n+    public static final String NAMESPACE = \"cluster-operations-test\";\n+\n+    @Test\n+    @MultiNodeClusterOnly\n+    @RequiredMinKubeApiVersion(version = 1.15)\n+    void testAvailabilityDuringNodeDrain() {\n+        List<String> topicNames = IntStream.range(0, 5).boxed().map(i -> \"test-topic-\" + i).collect(Collectors.toList());\n+        List<String> producerNames = IntStream.range(0, 5).boxed().map(i -> \"hello-world-producer-\" + i).collect(Collectors.toList());\n+        List<String> consumerNames = IntStream.range(0, 5).boxed().map(i -> \"hello-world-consumer-\" + i).collect(Collectors.toList());\n+        List<String> continuousConsumerGroups = IntStream.range(0, 5).boxed().map(i -> \"continuous-consumer-group-\" + i).collect(Collectors.toList());\n+        int continuousClientsMessageCount = 300;\n+        List<Node> nodes = kubeClient().getClusterWorkers();\n+\n+        KafkaResource.kafkaPersistent(CLUSTER_NAME, 3, 3)\n+                .editOrNewSpec()\n+                .editEntityOperator()\n+                .editUserOperator()\n+                .withReconciliationIntervalSeconds(30)\n+                .endUserOperator()\n+                .endEntityOperator()\n+                .endSpec()\n+                .done();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62ec650acadbc91ac8dc856c2499365573ac4e55"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4NzcyNg==", "bodyText": "Just a note: this is used to kinda simulate worse environment for clients cause we already had issues, that tests were green, but users were able to hit issues with producers and lost messages.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477487726", "createdAt": "2020-08-26T18:01:54Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/specific/ClusterOperationST.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.specific;\n+\n+import io.fabric8.kubernetes.api.model.Node;\n+import io.strimzi.api.kafka.model.KafkaResources;\n+import io.strimzi.systemtest.AbstractST;\n+import io.strimzi.systemtest.annotations.MultiNodeClusterOnly;\n+import io.strimzi.systemtest.annotations.RequiredMinKubeApiVersion;\n+import io.strimzi.systemtest.resources.ResourceManager;\n+import io.strimzi.systemtest.resources.crd.KafkaClientsResource;\n+import io.strimzi.systemtest.resources.crd.KafkaResource;\n+import io.strimzi.systemtest.resources.crd.KafkaTopicResource;\n+import io.strimzi.systemtest.resources.operator.BundleResource;\n+import io.strimzi.systemtest.utils.ClientUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+import static io.strimzi.systemtest.Constants.SPECIFIC;\n+import static io.strimzi.test.k8s.KubeClusterResource.cmdKubeClient;\n+import static io.strimzi.test.k8s.KubeClusterResource.kubeClient;\n+\n+@Tag(SPECIFIC)\n+public class ClusterOperationST extends AbstractST {\n+\n+    private static final Logger LOGGER = LogManager.getLogger(ClusterOperationST.class);\n+    public static final String NAMESPACE = \"cluster-operations-test\";\n+\n+    @Test\n+    @MultiNodeClusterOnly\n+    @RequiredMinKubeApiVersion(version = 1.15)\n+    void testAvailabilityDuringNodeDrain() {\n+        List<String> topicNames = IntStream.range(0, 5).boxed().map(i -> \"test-topic-\" + i).collect(Collectors.toList());\n+        List<String> producerNames = IntStream.range(0, 5).boxed().map(i -> \"hello-world-producer-\" + i).collect(Collectors.toList());\n+        List<String> consumerNames = IntStream.range(0, 5).boxed().map(i -> \"hello-world-consumer-\" + i).collect(Collectors.toList());\n+        List<String> continuousConsumerGroups = IntStream.range(0, 5).boxed().map(i -> \"continuous-consumer-group-\" + i).collect(Collectors.toList());\n+        int continuousClientsMessageCount = 300;\n+        List<Node> nodes = kubeClient().getClusterWorkers();\n+\n+        KafkaResource.kafkaPersistent(CLUSTER_NAME, 3, 3)\n+                .editOrNewSpec()\n+                .editEntityOperator()\n+                .editUserOperator()\n+                .withReconciliationIntervalSeconds(30)\n+                .endUserOperator()\n+                .endEntityOperator()\n+                .endSpec()\n+                .done();\n+\n+        topicNames.forEach(topicName -> KafkaTopicResource.topic(CLUSTER_NAME, topicName, 3, 3, 2).done());\n+\n+        String producerAdditionConfiguration = \"delivery.timeout.ms=20000\\nrequest.timeout.ms=20000\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62ec650acadbc91ac8dc856c2499365573ac4e55"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQ4ODYyNQ==", "bodyText": "Does it means we cannot use OLM/Helm install for this scenario?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#discussion_r477488625", "createdAt": "2020-08-26T18:03:31Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/specific/ClusterOperationST.java", "diffHunk": "@@ -0,0 +1,114 @@\n+/*\n+ * Copyright Strimzi authors.\n+ * License: Apache License 2.0 (see the file LICENSE or http://apache.org/licenses/LICENSE-2.0.html).\n+ */\n+package io.strimzi.systemtest.specific;\n+\n+import io.fabric8.kubernetes.api.model.Node;\n+import io.strimzi.api.kafka.model.KafkaResources;\n+import io.strimzi.systemtest.AbstractST;\n+import io.strimzi.systemtest.annotations.MultiNodeClusterOnly;\n+import io.strimzi.systemtest.annotations.RequiredMinKubeApiVersion;\n+import io.strimzi.systemtest.resources.ResourceManager;\n+import io.strimzi.systemtest.resources.crd.KafkaClientsResource;\n+import io.strimzi.systemtest.resources.crd.KafkaResource;\n+import io.strimzi.systemtest.resources.crd.KafkaTopicResource;\n+import io.strimzi.systemtest.resources.operator.BundleResource;\n+import io.strimzi.systemtest.utils.ClientUtils;\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Tag;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+import static io.strimzi.systemtest.Constants.SPECIFIC;\n+import static io.strimzi.test.k8s.KubeClusterResource.cmdKubeClient;\n+import static io.strimzi.test.k8s.KubeClusterResource.kubeClient;\n+\n+@Tag(SPECIFIC)\n+public class ClusterOperationST extends AbstractST {\n+\n+    private static final Logger LOGGER = LogManager.getLogger(ClusterOperationST.class);\n+    public static final String NAMESPACE = \"cluster-operations-test\";\n+\n+    @Test\n+    @MultiNodeClusterOnly\n+    @RequiredMinKubeApiVersion(version = 1.15)\n+    void testAvailabilityDuringNodeDrain() {\n+        List<String> topicNames = IntStream.range(0, 5).boxed().map(i -> \"test-topic-\" + i).collect(Collectors.toList());\n+        List<String> producerNames = IntStream.range(0, 5).boxed().map(i -> \"hello-world-producer-\" + i).collect(Collectors.toList());\n+        List<String> consumerNames = IntStream.range(0, 5).boxed().map(i -> \"hello-world-consumer-\" + i).collect(Collectors.toList());\n+        List<String> continuousConsumerGroups = IntStream.range(0, 5).boxed().map(i -> \"continuous-consumer-group-\" + i).collect(Collectors.toList());\n+        int continuousClientsMessageCount = 300;\n+        List<Node> nodes = kubeClient().getClusterWorkers();\n+\n+        KafkaResource.kafkaPersistent(CLUSTER_NAME, 3, 3)\n+                .editOrNewSpec()\n+                .editEntityOperator()\n+                .editUserOperator()\n+                .withReconciliationIntervalSeconds(30)\n+                .endUserOperator()\n+                .endEntityOperator()\n+                .endSpec()\n+                .done();\n+\n+        topicNames.forEach(topicName -> KafkaTopicResource.topic(CLUSTER_NAME, topicName, 3, 3, 2).done());\n+\n+        String producerAdditionConfiguration = \"delivery.timeout.ms=20000\\nrequest.timeout.ms=20000\";\n+        producerNames.forEach(producerName -> KafkaClientsResource.producerStrimzi(\n+                producerName,\n+                KafkaResources.plainBootstrapAddress(CLUSTER_NAME),\n+                topicNames.get(producerNames.indexOf(producerName)),\n+                continuousClientsMessageCount, producerAdditionConfiguration).done());\n+\n+\n+        consumerNames.forEach(consumerName -> KafkaClientsResource.consumerStrimzi(\n+                consumerName,\n+                KafkaResources.plainBootstrapAddress(CLUSTER_NAME),\n+                topicNames.get(consumerNames.indexOf(consumerName)),\n+                continuousClientsMessageCount, \"\",\n+                continuousConsumerGroups.get(consumerNames.indexOf(consumerName))).done());\n+\n+        // ##############################\n+        // Nodes draining\n+        // ##############################\n+        for (Node node : nodes) {\n+            drainNode(node.getMetadata().getName());\n+            setNodeSchedule(node.getMetadata().getName(), true);\n+        }\n+\n+        producerNames.forEach(producerName -> ClientUtils.waitTillContinuousClientsFinish(producerName, consumerNames.get(producerName.indexOf(producerName)), NAMESPACE, continuousClientsMessageCount));\n+        producerNames.forEach(producerName -> kubeClient().getClient().batch().jobs().inNamespace(NAMESPACE).withName(producerName).delete());\n+        consumerNames.forEach(consumerName -> kubeClient().getClient().batch().jobs().inNamespace(NAMESPACE).withName(consumerName).delete());\n+    }\n+\n+    @BeforeAll\n+    void setup() {\n+        ResourceManager.setClassResources();\n+        prepareEnvForOperator(NAMESPACE);\n+\n+        applyRoleBindings(NAMESPACE);\n+        BundleResource.clusterOperator(NAMESPACE).done();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62ec650acadbc91ac8dc856c2499365573ac4e55"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5da33660b8fc2c9f5a4d519078e4a4aa1feb02f6", "author": {"user": {"login": "kornys", "name": "David Kornel"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5da33660b8fc2c9f5a4d519078e4a4aa1feb02f6", "committedDate": "2020-08-26T19:31:46Z", "message": "Address comments + fix maven dependencies\n\nSigned-off-by: David Kornel <kornys@outlook.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODAxMDYw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#pullrequestreview-475801060", "createdAt": "2020-08-26T19:37:51Z", "commit": {"oid": "5da33660b8fc2c9f5a4d519078e4a4aa1feb02f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NTA4NzI4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3555#pullrequestreview-476508728", "createdAt": "2020-08-27T08:42:49Z", "commit": {"oid": "5da33660b8fc2c9f5a4d519078e4a4aa1feb02f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1213, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}