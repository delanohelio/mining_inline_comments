{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MzA3MzAz", "number": 3007, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzo1ODozNVrOD8FDOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMzo1NDoxMFrOD8fUUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MzIzODk2OnYy", "diffSide": "RIGHT", "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzo1ODozNVrOGUy9uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNDowMjo1NlrOGUzKow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1OTcwNw==", "bodyText": "The original issue wasn't just that the status was wrong, but also that it flipped back to Ready on the next reconciliation. So if this is intended as a regression test we should probably wait for a reconciliation interval and make the same assertion again.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r424459707", "createdAt": "2020-05-13T13:58:35Z", "author": {"login": "tombentley"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -366,6 +366,34 @@ void testKafkaMirrorMaker2WrongBootstrap() {\n         KafkaMirrorMaker2Resource.deleteKafkaMirrorMaker2WithoutWait(kafkaMirrorMaker2);\n     }\n \n+    @Test\n+    void testKafkaTopicDecreaseStatus() {\n+        KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 5).done();\n+        int decreaseTo = 1;\n+\n+        LOGGER.info(\"Decreasing number of partitions to {}\", decreaseTo);\n+        KafkaTopicResource.replaceTopicResource(TEST_TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().setPartitions(decreaseTo));\n+        KafkaTopicUtils.waitForKafkaTopicPartitionChange(TEST_TOPIC_NAME, decreaseTo);\n+\n+        assertKafkaTopicDecreasePartitionsStatus(TEST_TOPIC_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b07d1abe6e2cdc244471769db3d2e97e663c134e"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ2MzAxMQ==", "bodyText": "Yes, you are right, I didn't read the issue correctly, thanks for the comment.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r424463011", "createdAt": "2020-05-13T14:02:56Z", "author": {"login": "im-konge"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -366,6 +366,34 @@ void testKafkaMirrorMaker2WrongBootstrap() {\n         KafkaMirrorMaker2Resource.deleteKafkaMirrorMaker2WithoutWait(kafkaMirrorMaker2);\n     }\n \n+    @Test\n+    void testKafkaTopicDecreaseStatus() {\n+        KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 5).done();\n+        int decreaseTo = 1;\n+\n+        LOGGER.info(\"Decreasing number of partitions to {}\", decreaseTo);\n+        KafkaTopicResource.replaceTopicResource(TEST_TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().setPartitions(decreaseTo));\n+        KafkaTopicUtils.waitForKafkaTopicPartitionChange(TEST_TOPIC_NAME, decreaseTo);\n+\n+        assertKafkaTopicDecreasePartitionsStatus(TEST_TOPIC_NAME);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1OTcwNw=="}, "originalCommit": {"oid": "b07d1abe6e2cdc244471769db3d2e97e663c134e"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0MzI0NDg5OnYy", "diffSide": "RIGHT", "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzo1OTo1M1rOGUzBkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNDowMDo1M1rOGUzE6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ2MDY5MA==", "bodyText": "It's the reconciliation interval you need to wait for. Hard coding 60s is fragile. You could obtaint the interval by reading it from the env var of the TO container in the EO pod. That way the test would not break even if the interval later got changed.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r424460690", "createdAt": "2020-05-13T13:59:53Z", "author": {"login": "tombentley"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -366,6 +366,34 @@ void testKafkaMirrorMaker2WrongBootstrap() {\n         KafkaMirrorMaker2Resource.deleteKafkaMirrorMaker2WithoutWait(kafkaMirrorMaker2);\n     }\n \n+    @Test\n+    void testKafkaTopicDecreaseStatus() {\n+        KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 5).done();\n+        int decreaseTo = 1;\n+\n+        LOGGER.info(\"Decreasing number of partitions to {}\", decreaseTo);\n+        KafkaTopicResource.replaceTopicResource(TEST_TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().setPartitions(decreaseTo));\n+        KafkaTopicUtils.waitForKafkaTopicPartitionChange(TEST_TOPIC_NAME, decreaseTo);\n+\n+        assertKafkaTopicDecreasePartitionsStatus(TEST_TOPIC_NAME);\n+    }\n+\n+    @Test\n+    void testKafkaTopicChangingInSyncReplicasStatus() throws InterruptedException {\n+        KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 5).done();\n+        String invalidValue = \"x\";\n+\n+        LOGGER.info(\"Changing min.insync.replicas to random char\");\n+        KafkaTopicResource.replaceTopicResource(TEST_TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().getConfig().replace(\"min.insync.replicas\", invalidValue));\n+        KafkaTopicUtils.waitForKafkaTopicNotReady(TEST_TOPIC_NAME);\n+\n+        assertKafkaTopicWrongMinInSyncReplicasStatus(TEST_TOPIC_NAME, invalidValue);\n+\n+        // Wait some time to check if error is still present in KafkaTopic status\n+        Thread.sleep(60_000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b07d1abe6e2cdc244471769db3d2e97e663c134e"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ2MTU0NA==", "bodyText": "Thanks for comment, I'll fix it", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r424461544", "createdAt": "2020-05-13T14:00:53Z", "author": {"login": "im-konge"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -366,6 +366,34 @@ void testKafkaMirrorMaker2WrongBootstrap() {\n         KafkaMirrorMaker2Resource.deleteKafkaMirrorMaker2WithoutWait(kafkaMirrorMaker2);\n     }\n \n+    @Test\n+    void testKafkaTopicDecreaseStatus() {\n+        KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 5).done();\n+        int decreaseTo = 1;\n+\n+        LOGGER.info(\"Decreasing number of partitions to {}\", decreaseTo);\n+        KafkaTopicResource.replaceTopicResource(TEST_TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().setPartitions(decreaseTo));\n+        KafkaTopicUtils.waitForKafkaTopicPartitionChange(TEST_TOPIC_NAME, decreaseTo);\n+\n+        assertKafkaTopicDecreasePartitionsStatus(TEST_TOPIC_NAME);\n+    }\n+\n+    @Test\n+    void testKafkaTopicChangingInSyncReplicasStatus() throws InterruptedException {\n+        KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 5).done();\n+        String invalidValue = \"x\";\n+\n+        LOGGER.info(\"Changing min.insync.replicas to random char\");\n+        KafkaTopicResource.replaceTopicResource(TEST_TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().getConfig().replace(\"min.insync.replicas\", invalidValue));\n+        KafkaTopicUtils.waitForKafkaTopicNotReady(TEST_TOPIC_NAME);\n+\n+        assertKafkaTopicWrongMinInSyncReplicasStatus(TEST_TOPIC_NAME, invalidValue);\n+\n+        // Wait some time to check if error is still present in KafkaTopic status\n+        Thread.sleep(60_000);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ2MDY5MA=="}, "originalCommit": {"oid": "b07d1abe6e2cdc244471769db3d2e97e663c134e"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0NzU0MjU5OnYy", "diffSide": "RIGHT", "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMzo1NDoxMFrOGVdZ6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMzo1NDoxMFrOGVdZ6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE1NTA0OA==", "bodyText": "I think this timeout should be longer than reconicliation interval...and Maybe I will extend at least double times", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r425155048", "createdAt": "2020-05-14T13:54:10Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -404,6 +439,9 @@ void deployTestSpecificResources() {\n \n         KafkaTopicResource.topic(CLUSTER_NAME, TOPIC_NAME).done();\n         KafkaClientsResource.deployKafkaClients(false, KAFKA_CLIENTS_NAME).done();\n+\n+        topicOperatorReconciliationInterval = KafkaResource.kafkaClient().inNamespace(NAMESPACE).withName(CLUSTER_NAME).get()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d8b5550a003dc405147f3ba7ec5775b3cf8651d"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 45, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}