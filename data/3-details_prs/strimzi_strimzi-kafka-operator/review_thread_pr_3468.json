{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzOTY4Mzkx", "number": 3468, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMTo0NjozOVrOEVy0Hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTowNzo0NVrOEWtmKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMjg4MDk1OnYy", "diffSide": "RIGHT", "path": "systemtest/src/test/java/io/strimzi/systemtest/cruisecontrol/CruiseControlApiST.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMTo0NjozOVrOG8wDEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMzoxNTowMFrOG8y95g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1NDk2Mg==", "bodyText": "Just a question -> shouldn't be this test in MetricsST? I know you already added test to this suite, but I'm curious. It can be really confusing for the first time.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r466354962", "createdAt": "2020-08-06T11:46:39Z", "author": {"login": "im-konge"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/cruisecontrol/CruiseControlApiST.java", "diffHunk": "@@ -121,15 +122,30 @@ void testUserTasks() {\n         assertThat(response, containsString(CruiseControlUserTaskStatus.COMPLETED.toString()));\n     }\n \n+    @Order(5)\n+    @Test\n+    void testMetrics() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bf9a94a3021807b01c430cfbcb6f24b12cd60b0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM4MDk2Mw==", "bodyText": "I agree, as /metrics is not actually a CC API endpoint this test would be better in the MetricsST.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r466380963", "createdAt": "2020-08-06T12:37:51Z", "author": {"login": "tomncooper"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/cruisecontrol/CruiseControlApiST.java", "diffHunk": "@@ -121,15 +122,30 @@ void testUserTasks() {\n         assertThat(response, containsString(CruiseControlUserTaskStatus.COMPLETED.toString()));\n     }\n \n+    @Order(5)\n+    @Test\n+    void testMetrics() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1NDk2Mg=="}, "originalCommit": {"oid": "2bf9a94a3021807b01c430cfbcb6f24b12cd60b0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM4MTg2OQ==", "bodyText": "I would say that name of the suite CruiseControlApiST.java  will tell explicitly the user that tests are designed to tests the APIs which CC provide or it is bind.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r466381869", "createdAt": "2020-08-06T12:39:33Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/cruisecontrol/CruiseControlApiST.java", "diffHunk": "@@ -121,15 +122,30 @@ void testUserTasks() {\n         assertThat(response, containsString(CruiseControlUserTaskStatus.COMPLETED.toString()));\n     }\n \n+    @Order(5)\n+    @Test\n+    void testMetrics() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1NDk2Mg=="}, "originalCommit": {"oid": "2bf9a94a3021807b01c430cfbcb6f24b12cd60b0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQwMjc5MA==", "bodyText": "Yeah, I don't think that testing metrics is ok here. This class is about testing CC API endpoints which /metrics isn't.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r466402790", "createdAt": "2020-08-06T13:15:00Z", "author": {"login": "ppatierno"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/cruisecontrol/CruiseControlApiST.java", "diffHunk": "@@ -121,15 +122,30 @@ void testUserTasks() {\n         assertThat(response, containsString(CruiseControlUserTaskStatus.COMPLETED.toString()));\n     }\n \n+    @Order(5)\n+    @Test\n+    void testMetrics() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1NDk2Mg=="}, "originalCommit": {"oid": "2bf9a94a3021807b01c430cfbcb6f24b12cd60b0"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkxMzAxMTcyOnYy", "diffSide": "RIGHT", "path": "operator-common/src/main/java/io/strimzi/operator/cluster/operator/resource/cruisecontrol/CruiseControlEndpoints.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMjoyODowMlrOG8xTmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMzoxMjo1MFrOG8y4cQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM3NTU3Ng==", "bodyText": "Could you put a comment above this entry and state that this is not provided by Cruise Control and instead comes from the JMX Exporter.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r466375576", "createdAt": "2020-08-06T12:28:02Z", "author": {"login": "tomncooper"}, "path": "operator-common/src/main/java/io/strimzi/operator/cluster/operator/resource/cruisecontrol/CruiseControlEndpoints.java", "diffHunk": "@@ -9,7 +9,9 @@\n     STATE(\"/kafkacruisecontrol/state\"),\n     REBALANCE(\"/kafkacruisecontrol/rebalance\"),\n     STOP(\"/kafkacruisecontrol/stop_proposal_execution\"),\n-    USER_TASKS(\"/kafkacruisecontrol/user_tasks\");\n+    USER_TASKS(\"/kafkacruisecontrol/user_tasks\"),\n+\n+    METRICS(\"/metrics\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2bf9a94a3021807b01c430cfbcb6f24b12cd60b0"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM4MjAzNA==", "bodyText": "Of course :)", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r466382034", "createdAt": "2020-08-06T12:39:51Z", "author": {"login": "see-quick"}, "path": "operator-common/src/main/java/io/strimzi/operator/cluster/operator/resource/cruisecontrol/CruiseControlEndpoints.java", "diffHunk": "@@ -9,7 +9,9 @@\n     STATE(\"/kafkacruisecontrol/state\"),\n     REBALANCE(\"/kafkacruisecontrol/rebalance\"),\n     STOP(\"/kafkacruisecontrol/stop_proposal_execution\"),\n-    USER_TASKS(\"/kafkacruisecontrol/user_tasks\");\n+    USER_TASKS(\"/kafkacruisecontrol/user_tasks\"),\n+\n+    METRICS(\"/metrics\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM3NTU3Ng=="}, "originalCommit": {"oid": "2bf9a94a3021807b01c430cfbcb6f24b12cd60b0"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQwMTM5Mw==", "bodyText": "Tbh I would not add this endpoint here. It's not the code for tests only, it's code related to the Cruise Control integration in the operator and that integration is about the strictly related CC endpoints.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r466401393", "createdAt": "2020-08-06T13:12:50Z", "author": {"login": "ppatierno"}, "path": "operator-common/src/main/java/io/strimzi/operator/cluster/operator/resource/cruisecontrol/CruiseControlEndpoints.java", "diffHunk": "@@ -9,7 +9,9 @@\n     STATE(\"/kafkacruisecontrol/state\"),\n     REBALANCE(\"/kafkacruisecontrol/rebalance\"),\n     STOP(\"/kafkacruisecontrol/stop_proposal_execution\"),\n-    USER_TASKS(\"/kafkacruisecontrol/user_tasks\");\n+    USER_TASKS(\"/kafkacruisecontrol/user_tasks\"),\n+\n+    METRICS(\"/metrics\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM3NTU3Ng=="}, "originalCommit": {"oid": "2bf9a94a3021807b01c430cfbcb6f24b12cd60b0"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyMjUxMTc2OnYy", "diffSide": "RIGHT", "path": "systemtest/src/test/java/io/strimzi/systemtest/metrics/MetricsST.java", "isResolved": false, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQwOTowNzo0NVrOG-Gv8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNzoyNTozMFrOG-YPNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc3NTQ3Mw==", "bodyText": "Might we want to assert that we pass through this more than 0 times? If the interface changes the regex will immediately not find and this test becomes a no-op if I am not mistaken.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r467775473", "createdAt": "2020-08-10T09:07:45Z", "author": {"login": "samuel-hawker"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/metrics/MetricsST.java", "diffHunk": "@@ -329,6 +333,26 @@ void testKafkaBridgeMetrics() {\n         assertThat(values.stream().mapToDouble(i -> i).sum(), is((double) 1));\n     }\n \n+    @Test\n+    @Tag(CRUISE_CONTROL)\n+    void testCruiseControlMetrics() {\n+\n+        String cruiseControlMetrics = CruiseControlUtils.callApi(CruiseControlUtils.SupportedHttpMethods.GET, \"/metrics\");\n+\n+        Matcher regex = Pattern.compile(\"^([^#].*)\\\\s+([^\\\\s]*)$\", Pattern.MULTILINE).matcher(cruiseControlMetrics);\n+\n+        while (regex.find()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6fc362973c482b0471c05a59b109294677efa6b"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc4MDM0NQ==", "bodyText": "Yeah, that's correct consideration. What about assertThat(regex.end(), greaterThan(0)); ?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r467780345", "createdAt": "2020-08-10T09:17:20Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/metrics/MetricsST.java", "diffHunk": "@@ -329,6 +333,26 @@ void testKafkaBridgeMetrics() {\n         assertThat(values.stream().mapToDouble(i -> i).sum(), is((double) 1));\n     }\n \n+    @Test\n+    @Tag(CRUISE_CONTROL)\n+    void testCruiseControlMetrics() {\n+\n+        String cruiseControlMetrics = CruiseControlUtils.callApi(CruiseControlUtils.SupportedHttpMethods.GET, \"/metrics\");\n+\n+        Matcher regex = Pattern.compile(\"^([^#].*)\\\\s+([^\\\\s]*)$\", Pattern.MULTILINE).matcher(cruiseControlMetrics);\n+\n+        while (regex.find()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc3NTQ3Mw=="}, "originalCommit": {"oid": "b6fc362973c482b0471c05a59b109294677efa6b"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgyNTUxNA==", "bodyText": "Changed to\nLOGGER.info(\"Verifying that there is already more than 100 different metrics\");\nassertThat(regex.results().count(), greaterThan(100L));", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r467825514", "createdAt": "2020-08-10T10:53:17Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/metrics/MetricsST.java", "diffHunk": "@@ -329,6 +333,26 @@ void testKafkaBridgeMetrics() {\n         assertThat(values.stream().mapToDouble(i -> i).sum(), is((double) 1));\n     }\n \n+    @Test\n+    @Tag(CRUISE_CONTROL)\n+    void testCruiseControlMetrics() {\n+\n+        String cruiseControlMetrics = CruiseControlUtils.callApi(CruiseControlUtils.SupportedHttpMethods.GET, \"/metrics\");\n+\n+        Matcher regex = Pattern.compile(\"^([^#].*)\\\\s+([^\\\\s]*)$\", Pattern.MULTILINE).matcher(cruiseControlMetrics);\n+\n+        while (regex.find()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc3NTQ3Mw=="}, "originalCommit": {"oid": "b6fc362973c482b0471c05a59b109294677efa6b"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzgyNjEzOA==", "bodyText": "That looks good to me, whilst variable sized checks are useful for extensibility, we should add the sanity check assert that you suggested to check that we have an expected sized sample", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r467826138", "createdAt": "2020-08-10T10:54:50Z", "author": {"login": "samuel-hawker"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/metrics/MetricsST.java", "diffHunk": "@@ -329,6 +333,26 @@ void testKafkaBridgeMetrics() {\n         assertThat(values.stream().mapToDouble(i -> i).sum(), is((double) 1));\n     }\n \n+    @Test\n+    @Tag(CRUISE_CONTROL)\n+    void testCruiseControlMetrics() {\n+\n+        String cruiseControlMetrics = CruiseControlUtils.callApi(CruiseControlUtils.SupportedHttpMethods.GET, \"/metrics\");\n+\n+        Matcher regex = Pattern.compile(\"^([^#].*)\\\\s+([^\\\\s]*)$\", Pattern.MULTILINE).matcher(cruiseControlMetrics);\n+\n+        while (regex.find()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc3NTQ3Mw=="}, "originalCommit": {"oid": "b6fc362973c482b0471c05a59b109294677efa6b"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg1MjM1Mw==", "bodyText": "hmmm regex.results().count() is only for Java 11 :(, This one regex.end() also doens't work. So maybe i can assert that line will have 2 groups.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r467852353", "createdAt": "2020-08-10T11:53:51Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/metrics/MetricsST.java", "diffHunk": "@@ -329,6 +333,26 @@ void testKafkaBridgeMetrics() {\n         assertThat(values.stream().mapToDouble(i -> i).sum(), is((double) 1));\n     }\n \n+    @Test\n+    @Tag(CRUISE_CONTROL)\n+    void testCruiseControlMetrics() {\n+\n+        String cruiseControlMetrics = CruiseControlUtils.callApi(CruiseControlUtils.SupportedHttpMethods.GET, \"/metrics\");\n+\n+        Matcher regex = Pattern.compile(\"^([^#].*)\\\\s+([^\\\\s]*)$\", Pattern.MULTILINE).matcher(cruiseControlMetrics);\n+\n+        while (regex.find()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc3NTQ3Mw=="}, "originalCommit": {"oid": "b6fc362973c482b0471c05a59b109294677efa6b"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkzMjUyOA==", "bodyText": "WDYT  @samuel-hawker", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r467932528", "createdAt": "2020-08-10T14:13:15Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/metrics/MetricsST.java", "diffHunk": "@@ -329,6 +333,26 @@ void testKafkaBridgeMetrics() {\n         assertThat(values.stream().mapToDouble(i -> i).sum(), is((double) 1));\n     }\n \n+    @Test\n+    @Tag(CRUISE_CONTROL)\n+    void testCruiseControlMetrics() {\n+\n+        String cruiseControlMetrics = CruiseControlUtils.callApi(CruiseControlUtils.SupportedHttpMethods.GET, \"/metrics\");\n+\n+        Matcher regex = Pattern.compile(\"^([^#].*)\\\\s+([^\\\\s]*)$\", Pattern.MULTILINE).matcher(cruiseControlMetrics);\n+\n+        while (regex.find()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc3NTQ3Mw=="}, "originalCommit": {"oid": "b6fc362973c482b0471c05a59b109294677efa6b"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODA2MjAwNA==", "bodyText": "Honestly, I don't have a strong opinion on this, I would suggest the cleaner Java 11 check you leave in, but commented out, and when we stop supporting java 8 we remove the old assertion.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3468#discussion_r468062004", "createdAt": "2020-08-10T17:25:30Z", "author": {"login": "samuel-hawker"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/metrics/MetricsST.java", "diffHunk": "@@ -329,6 +333,26 @@ void testKafkaBridgeMetrics() {\n         assertThat(values.stream().mapToDouble(i -> i).sum(), is((double) 1));\n     }\n \n+    @Test\n+    @Tag(CRUISE_CONTROL)\n+    void testCruiseControlMetrics() {\n+\n+        String cruiseControlMetrics = CruiseControlUtils.callApi(CruiseControlUtils.SupportedHttpMethods.GET, \"/metrics\");\n+\n+        Matcher regex = Pattern.compile(\"^([^#].*)\\\\s+([^\\\\s]*)$\", Pattern.MULTILINE).matcher(cruiseControlMetrics);\n+\n+        while (regex.find()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzc3NTQ3Mw=="}, "originalCommit": {"oid": "b6fc362973c482b0471c05a59b109294677efa6b"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1272, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}