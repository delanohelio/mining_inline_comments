{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMzA2NDc4", "number": 3456, "title": "[systemtest][mm2] Test scale mm2 to zero replicas", "bodyText": "Signed-off-by: Lukas Kral lukywill16@gmail.com\nType of change\n\nNew test\n\nDescription\nAfter #3431 we are able to scale Kafka MirrorMaker2 to zero replicas and in this PR I'm adding test for it.\nChecklist\n\n Write tests\n Make sure all tests pass", "createdAt": "2020-08-05T10:54:59Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3456", "merged": true, "mergeCommit": {"oid": "8c6c8583ec880fbc8904898dcc091519b5a0b7d6"}, "closed": true, "closedAt": "2020-08-06T08:05:18Z", "author": {"login": "im-konge"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc75DmUABqjM2MjQxMzUwMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8KWOiABqjM2Mjc2ODMxODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b97417a2954085dbdd876b91d52c17bba00deb9f", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b97417a2954085dbdd876b91d52c17bba00deb9f", "committedDate": "2020-08-05T10:50:38Z", "message": "add test for scaling mm2 to zero\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "57b1fc1468a79a437ae623d71a146e75668b4abf", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/57b1fc1468a79a437ae623d71a146e75668b4abf", "committedDate": "2020-08-05T10:55:57Z", "message": "add test for scaling mm2 to zero\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNTk4MTQ0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3456#pullrequestreview-461598144", "createdAt": "2020-08-05T12:03:06Z", "commit": {"oid": "57b1fc1468a79a437ae623d71a146e75668b4abf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMjowMzowNlrOG8GpNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxMjowMzowNlrOG8GpNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY3NjU5OQ==", "bodyText": "Since you already do asserts on the status, maybe you can also check that url is not set.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3456#discussion_r465676599", "createdAt": "2020-08-05T12:03:06Z", "author": {"login": "scholzj"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/mirrormaker/MirrorMaker2ST.java", "diffHunk": "@@ -653,6 +655,39 @@ void testMirrorMaker2CorrectlyMirrorsHeaders() {\n         assertThat(log, containsString(header1));\n         assertThat(log, containsString(header2));\n     }\n+\n+    @Test\n+    void testScaleMirrorMaker2ToZero() {\n+        // Deploy source kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterSourceName, 1, 1).done();\n+        // Deploy target kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterTargetName, 1, 1).done();\n+\n+        KafkaMirrorMaker2Resource.kafkaMirrorMaker2(CLUSTER_NAME, kafkaClusterTargetName, kafkaClusterSourceName, 3, false)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-mirror-maker-2\")\n+            .endMetadata()\n+            .done();\n+\n+        long oldObsGen = KafkaMirrorMaker2Resource.kafkaMirrorMaker2Client().inNamespace(NAMESPACE).withName(CLUSTER_NAME).get().getStatus().getObservedGeneration();\n+        String mm2DepName = KafkaMirrorMaker2Resources.deploymentName(CLUSTER_NAME);\n+        List<String> mm2Pods = kubeClient().listPodNames(\"type\", \"kafka-mirror-maker-2\");\n+        assertThat(mm2Pods.size(), is(3));\n+\n+        LOGGER.info(\"Scaling MirrorMaker to zero\");\n+        KafkaMirrorMaker2Resource.replaceKafkaMirrorMaker2Resource(CLUSTER_NAME, mm2 -> mm2.getSpec().setReplicas(0));\n+\n+        PodUtils.waitForPodsReady(kubeClient().getDeploymentSelectors(mm2DepName), 0, true);\n+\n+        mm2Pods = kubeClient().listPodNames(\"type\", \"kafka-mirror-maker-2\");\n+        KafkaMirrorMaker2Status mm2Status = KafkaMirrorMaker2Resource.kafkaMirrorMaker2Client().inNamespace(NAMESPACE).withName(CLUSTER_NAME).get().getStatus();\n+        long actualObsGen = KafkaMirrorMaker2Resource.kafkaMirrorMaker2Client().inNamespace(NAMESPACE).withName(CLUSTER_NAME).get().getStatus().getObservedGeneration();\n+\n+        assertThat(mm2Pods.size(), is(0));\n+        assertThat(mm2Status.getConditions().get(0).getType(), is(\"Ready\"));\n+        assertThat(actualObsGen, is(not(oldObsGen)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57b1fc1468a79a437ae623d71a146e75668b4abf"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNzM5NzAw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3456#pullrequestreview-461739700", "createdAt": "2020-08-05T14:48:46Z", "commit": {"oid": "a081d24404f8f139354671a36b918d4fb223abea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNzYzNTc0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3456#pullrequestreview-461763574", "createdAt": "2020-08-05T15:13:52Z", "commit": {"oid": "a081d24404f8f139354671a36b918d4fb223abea"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNToxMzo1M1rOG8OR_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNToxMzo1M1rOG8OR_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTgwMTcyNw==", "bodyText": "\"MirrorMaker2\"", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3456#discussion_r465801727", "createdAt": "2020-08-05T15:13:53Z", "author": {"login": "ppatierno"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/mirrormaker/MirrorMaker2ST.java", "diffHunk": "@@ -653,6 +655,40 @@ void testMirrorMaker2CorrectlyMirrorsHeaders() {\n         assertThat(log, containsString(header1));\n         assertThat(log, containsString(header2));\n     }\n+\n+    @Test\n+    void testScaleMirrorMaker2ToZero() {\n+        // Deploy source kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterSourceName, 1, 1).done();\n+        // Deploy target kafka\n+        KafkaResource.kafkaEphemeral(kafkaClusterTargetName, 1, 1).done();\n+\n+        KafkaMirrorMaker2Resource.kafkaMirrorMaker2(CLUSTER_NAME, kafkaClusterTargetName, kafkaClusterSourceName, 3, false)\n+            .editMetadata()\n+                .addToLabels(\"type\", \"kafka-mirror-maker-2\")\n+            .endMetadata()\n+            .done();\n+\n+        long oldObsGen = KafkaMirrorMaker2Resource.kafkaMirrorMaker2Client().inNamespace(NAMESPACE).withName(CLUSTER_NAME).get().getStatus().getObservedGeneration();\n+        String mm2DepName = KafkaMirrorMaker2Resources.deploymentName(CLUSTER_NAME);\n+        List<String> mm2Pods = kubeClient().listPodNames(\"type\", \"kafka-mirror-maker-2\");\n+        assertThat(mm2Pods.size(), is(3));\n+\n+        LOGGER.info(\"Scaling MirrorMaker to zero\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a081d24404f8f139354671a36b918d4fb223abea"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dbc5b45eb85d3d6cb7bf77dba3ccbb87b41a605", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1dbc5b45eb85d3d6cb7bf77dba3ccbb87b41a605", "committedDate": "2020-08-05T20:59:01Z", "message": "add test for scaling mm2 to zero\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28af3512aeaffae55e60482775adf5294d9a40f2", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/28af3512aeaffae55e60482775adf5294d9a40f2", "committedDate": "2020-08-05T20:59:01Z", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "094c3a277520d98a8339d0a67d139ce96abd2bd7", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/094c3a277520d98a8339d0a67d139ce96abd2bd7", "committedDate": "2020-08-05T20:59:01Z", "message": "comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "923151fdc50212823d1a4c024a045d398ab6f1cd", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/923151fdc50212823d1a4c024a045d398ab6f1cd", "committedDate": "2020-08-05T22:24:43Z", "message": "fixup! comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c920a92c1db07fe5ac851277a59e93c5feba8e40", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c920a92c1db07fe5ac851277a59e93c5feba8e40", "committedDate": "2020-08-05T15:27:07Z", "message": "comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "923151fdc50212823d1a4c024a045d398ab6f1cd", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/923151fdc50212823d1a4c024a045d398ab6f1cd", "committedDate": "2020-08-05T22:24:43Z", "message": "fixup! comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63a06ef89552d4051f723f4d41155234fb320817", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/63a06ef89552d4051f723f4d41155234fb320817", "committedDate": "2020-08-06T07:04:37Z", "message": "fixup! fixup! comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8837bc9db4677336bb14665645e97bb7d15ef229", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8837bc9db4677336bb14665645e97bb7d15ef229", "committedDate": "2020-08-06T07:00:42Z", "message": "fixup! fixup! comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "63a06ef89552d4051f723f4d41155234fb320817", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/63a06ef89552d4051f723f4d41155234fb320817", "committedDate": "2020-08-06T07:04:37Z", "message": "fixup! fixup! comment\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1092, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}