{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMTU4MzM2", "number": 3439, "title": "Remove Prometheus port and annotations from services", "bodyText": "Type of change\n\nBugfix\n\nDescription\nThis PR fixes #3366.\nWith the current way of scraping metrics on pods (Kafka, ZooKeeper, Kafka Connect, Exporter, and so on), using a PodMonitor resource, there is no need for having the metrics port 9404 and Prometheus annotations on the services for the mentioned instances. That port was deprecated in 0.19.0 and this PR removes it.\nFor the specific Kafka Exporter case, the service was removed because it was used just for metrics so it's not needed anymore.\nChecklist\nPlease go through this checklist and make sure all applicable tasks have been done\n\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md", "createdAt": "2020-08-03T12:49:16Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3439", "merged": true, "mergeCommit": {"oid": "a299364d11909a33b05511f0e60f25b3a5dc38a2"}, "closed": true, "closedAt": "2020-08-04T19:39:27Z", "author": {"login": "ppatierno"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7XA7vgBqjM2MTcyNTc4NjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7mknYAFqTQ2MDgwODE4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "55c946a00486b7241f6a73cd4ed091695287c2b2", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/55c946a00486b7241f6a73cd4ed091695287c2b2", "committedDate": "2020-08-03T13:51:56Z", "message": "Fixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}, "afterCommit": {"oid": "8f0d15e8b05839cbf9c74ee4d2f01c775404b42e", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8f0d15e8b05839cbf9c74ee4d2f01c775404b42e", "committedDate": "2020-08-03T19:16:03Z", "message": "Removed metrics port from services\nRemoved Prometheus annotations from services\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nRemoved Kafka Exporter service with no ports anymore\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nUpdated CHANGELOG\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed test\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f0d15e8b05839cbf9c74ee4d2f01c775404b42e", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8f0d15e8b05839cbf9c74ee4d2f01c775404b42e", "committedDate": "2020-08-03T19:16:03Z", "message": "Removed metrics port from services\nRemoved Prometheus annotations from services\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nRemoved Kafka Exporter service with no ports anymore\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nUpdated CHANGELOG\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed test\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}, "afterCommit": {"oid": "681ce11c50601010a6c34d66505a0bab64c261a2", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/681ce11c50601010a6c34d66505a0bab64c261a2", "committedDate": "2020-08-03T19:28:43Z", "message": "Removed metrics port from services\nRemoved Prometheus annotations from services\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nRemoved Kafka Exporter service with no ports anymore\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nUpdated CHANGELOG\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed test\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMzY5MDgz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3439#pullrequestreview-460369083", "createdAt": "2020-08-03T22:01:30Z", "commit": {"oid": "681ce11c50601010a6c34d66505a0bab64c261a2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjowMTozMVrOG7KIWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjowMzozMFrOG7KLMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4NTE0Ng==", "bodyText": "Can you similarly to 0.19.0 release add special section for deprecations and removals and add it there? It can get easily lost here. You should probably also mention the removed services and the option to ise templates for adding such annotations.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3439#discussion_r464685146", "createdAt": "2020-08-03T22:01:31Z", "author": {"login": "scholzj"}, "path": "CHANGELOG.md", "diffHunk": "@@ -4,6 +4,7 @@\n ## 0.20.0\n \n * Updated to Cruise Control 2.0.124, which fixes a previous issue with CPU utilization statistics for containers. As a result, the CPUCapacityGoal has now been enabled.\n+* Removed deprecated metrics port 9404 and Prometheus annotations from services", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "681ce11c50601010a6c34d66505a0bab64c261a2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4NTg3NQ==", "bodyText": "I guess we do not need the mergeLabelsOrAnnotations here?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3439#discussion_r464685875", "createdAt": "2020-08-03T22:03:30Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ZookeeperCluster.java", "diffHunk": "@@ -342,13 +342,10 @@ static Affinity affinity(ZookeeperClusterSpec zookeeperClusterSpec) {\n     }\n \n     public Service generateService() {\n-        List<ServicePort> ports = new ArrayList<>(2);\n-        if (isMetricsEnabled()) {\n-            ports.add(createServicePort(METRICS_PORT_NAME, METRICS_PORT, METRICS_PORT, \"TCP\"));\n-        }\n+        List<ServicePort> ports = new ArrayList<>(1);\n         ports.add(createServicePort(CLIENT_TLS_PORT_NAME, CLIENT_TLS_PORT, CLIENT_TLS_PORT, \"TCP\"));\n \n-        return createService(\"ClusterIP\", ports, Util.mergeLabelsOrAnnotations(prometheusAnnotations(), templateServiceAnnotations));\n+        return createService(\"ClusterIP\", ports, Util.mergeLabelsOrAnnotations(templateServiceAnnotations));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "681ce11c50601010a6c34d66505a0bab64c261a2"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8c0adec0e392290043fedf393f42d78cbbe7142", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c8c0adec0e392290043fedf393f42d78cbbe7142", "committedDate": "2020-08-04T06:55:36Z", "message": "Removed metrics port from services\nRemoved Prometheus annotations from services\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nRemoved Kafka Exporter service with no ports anymore\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nUpdated CHANGELOG\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed test\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "681ce11c50601010a6c34d66505a0bab64c261a2", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/681ce11c50601010a6c34d66505a0bab64c261a2", "committedDate": "2020-08-03T19:28:43Z", "message": "Removed metrics port from services\nRemoved Prometheus annotations from services\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nRemoved Kafka Exporter service with no ports anymore\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nUpdated CHANGELOG\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed test\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}, "afterCommit": {"oid": "c8c0adec0e392290043fedf393f42d78cbbe7142", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c8c0adec0e392290043fedf393f42d78cbbe7142", "committedDate": "2020-08-04T06:55:36Z", "message": "Removed metrics port from services\nRemoved Prometheus annotations from services\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nRemoved Kafka Exporter service with no ports anymore\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nUpdated CHANGELOG\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed test\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>\n\nFixed checkstyle\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36e96d3025b72aba02d4f83d90f502e9de0692d5", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/36e96d3025b72aba02d4f83d90f502e9de0692d5", "committedDate": "2020-08-04T07:13:45Z", "message": "Fixed comments\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjAxMjc3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3439#pullrequestreview-460601277", "createdAt": "2020-08-04T08:25:30Z", "commit": {"oid": "36e96d3025b72aba02d4f83d90f502e9de0692d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35a52739fc66ee5f7f277aabc31e94d4995d59fa", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/35a52739fc66ee5f7f277aabc31e94d4995d59fa", "committedDate": "2020-08-04T12:25:58Z", "message": "Fixed CHANGELOG\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f09203f0830f8fdb6f60ce3735d8c341ef12508b", "author": {"user": {"login": "ppatierno", "name": "Paolo Patierno"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f09203f0830f8fdb6f60ce3735d8c341ef12508b", "committedDate": "2020-08-04T12:26:54Z", "message": "Fixed comment\n\nSigned-off-by: Paolo Patierno <ppatierno@live.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwODA4MTg5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3439#pullrequestreview-460808189", "createdAt": "2020-08-04T13:24:00Z", "commit": {"oid": "f09203f0830f8fdb6f60ce3735d8c341ef12508b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1079, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}