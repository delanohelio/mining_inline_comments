{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNjE1MDI4", "number": 3533, "title": "[MO] - [oauth + clients] -> removing oauth external lister dependency + refactor clients", "bodyText": "Signed-off-by: morsak xorsak02@stud.fit.vutbr.cz\nType of change\n\nEnhancement / new feature\nRefactoring\n\nDescription\nThis PR removing the dependency on external listeners in ouath test suite. Moreover, refactored the current client's resource which currently has this structure.\n\nKafkaClientsResource (abstract)\n\nKafkaBasicClientResource\n\nKafkaOauthClientsResource\n\n\nKafkaBridgeClientsResource\nKafkaTracingClientsResource\n\n\n\nI (@Frawless ) did a different part of this PR than @see-quick so I approved his changes (I already tested them).\nChecklist\n\n Make sure all tests pass", "createdAt": "2020-08-21T12:51:41Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3533", "merged": true, "mergeCommit": {"oid": "48ee71875fe8636db4ac57ce438f14b1e32c9884"}, "closed": true, "closedAt": "2020-09-02T19:27:18Z", "author": {"login": "see-quick"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCVCZ5gBqjM2ODk1MDc5OTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE9O2tAH2gAyNDcxNjE1MDI4OjNiZmE1YWQ5ZmU4MjBiZWJlZWQwMzY2OTFlMTFmNDI3ZjIwODRjYWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c433b3501b7dd561d7288c6857dc2a1133d87af6", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c433b3501b7dd561d7288c6857dc2a1133d87af6", "committedDate": "2020-08-21T12:50:56Z", "message": "[MO] - [oauth + clients] -> removing oauth external lister dependency + refactor clients\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}, "afterCommit": {"oid": "d55bc7a89ca09e019703742a0b9cf96cdf996173", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d55bc7a89ca09e019703742a0b9cf96cdf996173", "committedDate": "2020-08-25T10:55:24Z", "message": "[MO] - OauthPlainST and OauthTlsST  without external listeners\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a251c9087093c47a80990def6be34f998e35e82", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6a251c9087093c47a80990def6be34f998e35e82", "committedDate": "2020-08-26T12:21:10Z", "message": "fix\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}, "afterCommit": {"oid": "3e8644132ff20ead333eb04d957e8efaef2c823b", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3e8644132ff20ead333eb04d957e8efaef2c823b", "committedDate": "2020-08-27T08:28:55Z", "message": "fix\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "631e534b5992f28c5764a61ed68cdaacfc1d2b4d", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/631e534b5992f28c5764a61ed68cdaacfc1d2b4d", "committedDate": "2020-08-29T00:06:40Z", "message": "[MO] - [oauth + clients] -> removing oauth external lister dependency + refactor clients\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d05b7e065c4b380c33fa7fa8321081956b24ad9", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2d05b7e065c4b380c33fa7fa8321081956b24ad9", "committedDate": "2020-08-29T00:06:40Z", "message": "[MO] - OauthPlainST and OauthTlsST  without external listeners\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2283e424bdaa2de78c45899f1619b8593332edd9", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2283e424bdaa2de78c45899f1619b8593332edd9", "committedDate": "2020-08-29T00:06:40Z", "message": "[dir]\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5182b12662965fe05176ae3f166a3d2fc61a64bd", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5182b12662965fe05176ae3f166a3d2fc61a64bd", "committedDate": "2020-08-29T00:06:40Z", "message": "[MO] - [access] -> package - protected\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54f815539ccc7cb3cdc2f7010a08bec0e473cd93", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/54f815539ccc7cb3cdc2f7010a08bec0e473cd93", "committedDate": "2020-08-29T00:06:40Z", "message": "fix\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6bf4c70babb8fa38940073fa23056a17fdc42a7", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b6bf4c70babb8fa38940073fa23056a17fdc42a7", "committedDate": "2020-08-29T00:06:40Z", "message": "kafka-connect-fix\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1357f9bc6d766f62eb7116c637dbe479bc4cacd1", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1357f9bc6d766f62eb7116c637dbe479bc4cacd1", "committedDate": "2020-08-29T00:06:40Z", "message": "last\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4e9a6bd3b09f906073d367e24766985250d0515", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d4e9a6bd3b09f906073d367e24766985250d0515", "committedDate": "2020-08-29T00:06:40Z", "message": "s\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb38adc71245412bcb0a5a80352f3bdf70a1ed09", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fb38adc71245412bcb0a5a80352f3bdf70a1ed09", "committedDate": "2020-08-29T00:06:40Z", "message": "kc message\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2ba41db5a969527c8f1bc54865144aac52a0f43", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a2ba41db5a969527c8f1bc54865144aac52a0f43", "committedDate": "2020-08-29T00:06:40Z", "message": "fix\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1a3dbdfa969772ab8218b95c9874bd46f0322a0", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d1a3dbdfa969772ab8218b95c9874bd46f0322a0", "committedDate": "2020-08-29T00:06:40Z", "message": "todo remove\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae9f1fb7b45d25f4fbffb81e0d6ba289695f8116", "author": {"user": {"login": "see-quick", "name": "Ors\u00e1k Maro\u0161"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ae9f1fb7b45d25f4fbffb81e0d6ba289695f8116", "committedDate": "2020-08-29T00:06:40Z", "message": "fix\n\nSigned-off-by: morsak <xorsak02@stud.fit.vutbr.cz>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8145e8ad8c6fd6141762a1cac7d250a6a8a6b09", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e8145e8ad8c6fd6141762a1cac7d250a6a8a6b09", "committedDate": "2020-08-29T00:08:28Z", "message": "Refactor authorization (#2)\n\n* Refactor authorization\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>\n\n* fixup! Refactor authorization\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>\n\n* fixup! fixup! Refactor authorization\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>\n\n* Finish refactor\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>\n\n* fixup! Finish refactor\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0001c2ec078560ee3cbd3d601056e973c968b342", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0001c2ec078560ee3cbd3d601056e973c968b342", "committedDate": "2020-08-29T09:18:28Z", "message": "rebase fixups\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83bab446703ed9c85460bfdb486fa4bcf8912498", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/83bab446703ed9c85460bfdb486fa4bcf8912498", "committedDate": "2020-08-28T15:53:37Z", "message": "Refactor authorization (#2)\n\n* Refactor authorization\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>\n\n* fixup! Refactor authorization\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>\n\n* fixup! fixup! Refactor authorization\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>\n\n* Finish refactor\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>\n\n* fixup! Finish refactor\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}, "afterCommit": {"oid": "0001c2ec078560ee3cbd3d601056e973c968b342", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0001c2ec078560ee3cbd3d601056e973c968b342", "committedDate": "2020-08-29T09:18:28Z", "message": "rebase fixups\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd9800c0aad42ad34c0f214eac0b674e3290a37a", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/cd9800c0aad42ad34c0f214eac0b674e3290a37a", "committedDate": "2020-08-29T09:19:31Z", "message": "fixup! rebase fixups\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3483460e087f589fc8cdfe130b3e3c64173839f8", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3483460e087f589fc8cdfe130b3e3c64173839f8", "committedDate": "2020-08-31T09:43:45Z", "message": "Some minor changes\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93bee8ca22346ac0b49ecebcd0cc87767c3afa76", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/93bee8ca22346ac0b49ecebcd0cc87767c3afa76", "committedDate": "2020-08-31T09:47:29Z", "message": "fixup! Some minor changes\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDY5MTM3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3533#pullrequestreview-478469137", "createdAt": "2020-08-31T09:48:29Z", "commit": {"oid": "93bee8ca22346ac0b49ecebcd0cc87767c3afa76"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NzA1MzE1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3533#pullrequestreview-478705315", "createdAt": "2020-08-31T15:15:52Z", "commit": {"oid": "93bee8ca22346ac0b49ecebcd0cc87767c3afa76"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNToxNTo1MlrOHJ9B0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxNToxNjozNVrOHJ9DpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5OTEyMw==", "bodyText": "Why not to use the JobUtils.deleteJob()?\nAnd question -> don't we want to add something like JobsClient() to not always do the kubeClient().getClient().batch().jobs()? This is just a question/suggestion.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3533#discussion_r480199123", "createdAt": "2020-08-31T15:15:52Z", "author": {"login": "im-konge"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/security/oauth/OauthAbstractST.java", "diffHunk": "@@ -72,73 +67,31 @@ void setup() throws Exception {\n \n         KeycloakUtils.deployKeycloak(NAMESPACE);\n \n-        // https\n-        Service keycloakService = KubernetesResource.createKeycloakNodePortService(NAMESPACE);\n-        KubernetesResource.createServiceResource(keycloakService, NAMESPACE);\n-        ServiceUtils.waitForNodePortService(keycloakService.getMetadata().getName());\n-\n-        // http\n-        Service keycloakHttpService = KubernetesResource.createKeycloakNodePortHttpService(NAMESPACE);\n-        KubernetesResource.createServiceResource(keycloakHttpService, NAMESPACE);\n-        ServiceUtils.waitForNodePortService(keycloakHttpService.getMetadata().getName());\n-\n         String passwordEncoded = kubeClient().getSecret(\"credential-example-keycloak\").getData().get(\"ADMIN_PASSWORD\");\n         String password = new String(Base64.getDecoder().decode(passwordEncoded.getBytes()));\n         keycloakInstance = new KeycloakInstance(\"admin\", password, NAMESPACE);\n \n-        clusterHost = kubeClient().getNodeAddress();\n-\n-        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3, 1)\n-            .editSpec()\n-                .editKafka()\n-                    .editListeners()\n-                        .withNewTls()\n-                            .withNewKafkaListenerAuthenticationOAuth()\n-                                .withValidIssuerUri(keycloakInstance.getValidIssuerUri())\n-                                .withJwksExpirySeconds(keycloakInstance.getJwksExpireSeconds())\n-                                .withJwksRefreshSeconds(keycloakInstance.getJwksRefreshSeconds())\n-                                .withJwksEndpointUri(keycloakInstance.getJwksEndpointUri())\n-                                .withUserNameClaim(keycloakInstance.getUserNameClaim())\n-                                .withTlsTrustedCertificates(\n-                                    new CertSecretSourceBuilder()\n-                                        .withSecretName(SECRET_OF_KEYCLOAK)\n-                                        .withCertificate(CERTIFICATE_OF_KEYCLOAK)\n-                                        .build())\n-                                .withDisableTlsHostnameVerification(true)\n-                            .endKafkaListenerAuthenticationOAuth()\n-                        .endTls()\n-                        .withNewKafkaListenerExternalNodePort()\n-                            .withNewKafkaListenerAuthenticationOAuth()\n-                                .withValidIssuerUri(keycloakInstance.getValidIssuerUri())\n-                                .withJwksExpirySeconds(keycloakInstance.getJwksExpireSeconds())\n-                                .withJwksRefreshSeconds(keycloakInstance.getJwksRefreshSeconds())\n-                                .withJwksEndpointUri(keycloakInstance.getJwksEndpointUri())\n-                                .withUserNameClaim(keycloakInstance.getUserNameClaim())\n-                                .withTlsTrustedCertificates(\n-                                    new CertSecretSourceBuilder()\n-                                        .withSecretName(SECRET_OF_KEYCLOAK)\n-                                        .withCertificate(CERTIFICATE_OF_KEYCLOAK)\n-                                        .build())\n-                                .withDisableTlsHostnameVerification(true)\n-                            .endKafkaListenerAuthenticationOAuth()\n-                        .endKafkaListenerExternalNodePort()\n-                    .endListeners()\n-                .endKafka()\n-            .endSpec()\n-            .done();\n-\n-        KafkaTopicResource.topic(CLUSTER_NAME, TOPIC_NAME).done();\n-\n         createSecretsForDeployments();\n+    }\n+\n+    @AfterEach\n+    void tearDown() {\n \n-        KafkaUserResource.tlsUser(CLUSTER_NAME, OAUTH_CLIENT_NAME).done();\n+        for (Job job : kubeClient().getClient().batch().jobs().inNamespace(NAMESPACE).list().getItems()) {\n+            LOGGER.info(\"Deleting {} job\", job.getMetadata().getName());\n+            kubeClient().getClient().batch().jobs().inNamespace(NAMESPACE).delete(job);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93bee8ca22346ac0b49ecebcd0cc87767c3afa76"}, "originalPosition": 140}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5OTM0NQ==", "bodyText": "Another suggestion -> shouldn't be better to have builder for this? Just asking ... for the future PR?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3533#discussion_r480199345", "createdAt": "2020-08-31T15:16:12Z", "author": {"login": "im-konge"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/security/oauth/OauthAuthorizationST.java", "diffHunk": "@@ -222,76 +231,70 @@ void testClusterVerification() {\n     void setUp()  {\n         keycloakInstance.setRealm(\"kafka-authz\", true);\n \n+        KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3, 1)\n+            .editSpec()\n+                .editKafka()\n+                    .editListeners()\n+                        .withNewTls()\n+                            .withNewKafkaListenerAuthenticationOAuth()\n+                                .withValidIssuerUri(keycloakInstance.getValidIssuerUri())\n+                                .withJwksExpirySeconds(keycloakInstance.getJwksExpireSeconds())\n+                                .withJwksRefreshSeconds(keycloakInstance.getJwksRefreshSeconds())\n+                                .withJwksEndpointUri(keycloakInstance.getJwksEndpointUri())\n+                                .withUserNameClaim(keycloakInstance.getUserNameClaim())\n+                                .withTlsTrustedCertificates(\n+                                    new CertSecretSourceBuilder()\n+                                        .withSecretName(KeycloakInstance.KEYCLOAK_SECRET_NAME)\n+                                        .withCertificate(KeycloakInstance.KEYCLOAK_SECRET_CERT)\n+                                        .build())\n+                                .withDisableTlsHostnameVerification(true)\n+                            .endKafkaListenerAuthenticationOAuth()\n+                        .endTls()\n+                    .endListeners()\n+                    .withNewKafkaAuthorizationKeycloak()\n+                        .withClientId(KAFKA_CLIENT_ID)\n+                        .withDisableTlsHostnameVerification(true)\n+                        .withDelegateToKafkaAcls(false)\n+                        // ca.crt a tls.crt\n+                        .withTlsTrustedCertificates(\n+                            new CertSecretSourceBuilder()\n+                                .withSecretName(KeycloakInstance.KEYCLOAK_SECRET_NAME)\n+                                .withCertificate(KeycloakInstance.KEYCLOAK_SECRET_CERT)\n+                                .build()\n+                        )\n+                        .withTokenEndpointUri(keycloakInstance.getOauthTokenEndpointUri())\n+                    .endKafkaAuthorizationKeycloak()\n+                .endKafka()\n+            .endSpec()\n+            .done();\n+\n         LOGGER.info(\"Setting producer and consumer properties\");\n \n         KafkaUserResource.tlsUser(CLUSTER_NAME, TEAM_A_CLIENT).done();\n         KafkaUserResource.tlsUser(CLUSTER_NAME, TEAM_B_CLIENT).done();\n \n-        KafkaUserUtils.waitForKafkaUserCreation(TEAM_A_CLIENT);\n-        KafkaUserUtils.waitForKafkaUserCreation(TEAM_B_CLIENT);\n-\n-        teamAOauthKafkaClient = new OauthExternalKafkaClient.Builder()\n-            .withTopicName(TOPIC_A)\n-            .withNamespaceName(NAMESPACE)\n-            .withClusterName(CLUSTER_NAME)\n-            .withKafkaUsername(TEAM_A_CLIENT)\n-            .withMessageCount(MESSAGE_COUNT)\n-            .withSecurityProtocol(SecurityProtocol.SASL_SSL)\n-            .withConsumerGroupName(\"a-consumer_group\")\n-            .withOauthClientId(TEAM_A_CLIENT)\n-            .withClientSecretName(TEAM_A_CLIENT_SECRET)\n-            .withOauthTokenEndpointUri(keycloakInstance.getOauthTokenEndpointUri())\n-            .build();\n-\n-        teamBOauthKafkaClient = new OauthExternalKafkaClient.Builder()\n-            .withTopicName(TOPIC_NAME)\n-            .withNamespaceName(NAMESPACE)\n-            .withClusterName(CLUSTER_NAME)\n-            .withKafkaUsername(TEAM_A_CLIENT)\n-            .withMessageCount(MESSAGE_COUNT)\n-            .withSecurityProtocol(SecurityProtocol.SASL_SSL)\n-            .withConsumerGroupName(\"x-\" + ClientUtils.generateRandomConsumerGroup())\n-            .withOauthClientId(TEAM_B_CLIENT)\n-            .withClientSecretName(TEAM_B_CLIENT_SECRET)\n-            .withOauthTokenEndpointUri(keycloakInstance.getOauthTokenEndpointUri())\n-            .build();\n-\n-        Map<String, String> kafkaPods = StatefulSetUtils.ssSnapshot(KafkaResources.kafkaStatefulSetName(CLUSTER_NAME));\n-\n-        KafkaResource.replaceKafkaResource(CLUSTER_NAME, kafka -> {\n-            kafka.getSpec().getKafka().getListeners().setExternal(\n-                new KafkaListenerExternalNodePortBuilder()\n-                    .withNewKafkaListenerAuthenticationOAuth()\n-                        .withValidIssuerUri(keycloakInstance.getValidIssuerUri())\n-                        .withJwksEndpointUri(keycloakInstance.getJwksEndpointUri())\n-                        .withJwksExpirySeconds(keycloakInstance.getJwksExpireSeconds())\n-                        .withJwksRefreshSeconds(keycloakInstance.getJwksRefreshSeconds())\n-                        .withUserNameClaim(keycloakInstance.getUserNameClaim())\n-                        .withTlsTrustedCertificates(\n-                            new CertSecretSourceBuilder()\n-                                .withSecretName(SECRET_OF_KEYCLOAK)\n-                                .withCertificate(CERTIFICATE_OF_KEYCLOAK)\n-                                .build())\n-                        .withDisableTlsHostnameVerification(true)\n-                    .endKafkaListenerAuthenticationOAuth()\n-                    .build());\n-\n-            kafka.getSpec().getKafka().setAuthorization(\n-                new KafkaAuthorizationKeycloakBuilder()\n-                    .withClientId(KAFKA_CLIENT_ID)\n-                    .withDisableTlsHostnameVerification(true)\n-                    .withDelegateToKafkaAcls(false)\n-                    // ca.crt a tls.crt\n-                    .withTlsTrustedCertificates(\n-                        new CertSecretSourceBuilder()\n-                            .withSecretName(SECRET_OF_KEYCLOAK)\n-                            .withCertificate(CERTIFICATE_OF_KEYCLOAK)\n-                            .build()\n-                    )\n-                    .withTokenEndpointUri(keycloakInstance.getOauthTokenEndpointUri())\n-                    .build());\n-        });\n-\n-        StatefulSetUtils.waitTillSsHasRolled(KafkaResources.kafkaStatefulSetName(CLUSTER_NAME), 3, kafkaPods);\n+        teamAOauthClientJob = new KafkaOauthClientsResource(\n+                TEAM_A_PRODUCER_NAME,\n+                TEAM_A_CONSUMER_NAME,\n+                KafkaResources.tlsBootstrapAddress(CLUSTER_NAME),\n+                TOPIC_A,\n+                MESSAGE_COUNT,\n+                \"\",\n+                \"a-consumer_group\",\n+                TEAM_A_CLIENT,\n+                TEAM_A_CLIENT_SECRET,\n+                keycloakInstance.getOauthTokenEndpointUri());\n+\n+        teamBOauthClientJob = new KafkaOauthClientsResource(\n+                TEAM_B_PRODUCER_NAME,\n+                TEAM_B_CONSUMER_NAME,\n+                KafkaResources.tlsBootstrapAddress(CLUSTER_NAME),\n+                TOPIC_A,\n+                MESSAGE_COUNT,\n+                \"\",\n+                \"x-\" + ClientUtils.generateRandomConsumerGroup(),\n+                TEAM_B_CLIENT,\n+                TEAM_B_CLIENT_SECRET,\n+                keycloakInstance.getOauthTokenEndpointUri());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93bee8ca22346ac0b49ecebcd0cc87767c3afa76"}, "originalPosition": 381}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5OTQ4Nw==", "bodyText": "Same as above: Why not to use the JobUtils.deleteJob()?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3533#discussion_r480199487", "createdAt": "2020-08-31T15:16:25Z", "author": {"login": "im-konge"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/security/oauth/OauthPlainST.java", "diffHunk": "@@ -187,19 +184,35 @@ void testProducerConsumerMirrorMaker() {\n         TestUtils.waitFor(\"Waiting for Mirror Maker will copy messages from \" + CLUSTER_NAME + \" to \" + targetKafkaCluster,\n             Constants.GLOBAL_CLIENTS_POLL, Constants.TIMEOUT_FOR_MIRROR_MAKER_COPY_MESSAGES_BETWEEN_BROKERS,\n             () -> {\n-                oauthExternalKafkaClient.setConsumerGroup(ClientUtils.generateRandomConsumerGroup());\n-                return oauthExternalKafkaClient.receiveMessagesPlain() == MESSAGE_COUNT;\n+                LOGGER.info(\"Deleting the Job\");\n+                kubeClient().getClient().batch().jobs().inNamespace(NAMESPACE).withName(OAUTH_CONSUMER_NAME).delete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93bee8ca22346ac0b49ecebcd0cc87767c3afa76"}, "originalPosition": 114}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDE5OTU4OA==", "bodyText": "Same as above", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3533#discussion_r480199588", "createdAt": "2020-08-31T15:16:35Z", "author": {"login": "im-konge"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/security/oauth/OauthPlainST.java", "diffHunk": "@@ -273,19 +286,35 @@ void testProducerConsumerMirrorMaker2() {\n         TestUtils.waitFor(\"Waiting for Mirror Maker 2 will copy messages from \" + kafkaSourceClusterName + \" to \" + kafkaTargetClusterName,\n             Duration.ofSeconds(30).toMillis(), Constants.TIMEOUT_FOR_MIRROR_MAKER_COPY_MESSAGES_BETWEEN_BROKERS,\n             () -> {\n-                oauthExternalKafkaClient.setConsumerGroup(ClientUtils.generateRandomConsumerGroup());\n-                return oauthExternalKafkaClient.receiveMessagesPlain() == MESSAGE_COUNT;\n+                LOGGER.info(\"Deleting the Job {}\", OAUTH_CONSUMER_NAME);\n+                kubeClient().getClient().batch().jobs().inNamespace(NAMESPACE).withName(OAUTH_CONSUMER_NAME).delete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93bee8ca22346ac0b49ecebcd0cc87767c3afa76"}, "originalPosition": 156}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28e4b4fdd92fa08f3eeaa91ce46ec8af06fee5af", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/28e4b4fdd92fa08f3eeaa91ce46ec8af06fee5af", "committedDate": "2020-09-01T07:37:33Z", "message": "Fix comments\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5OTQxODcx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3533#pullrequestreview-479941871", "createdAt": "2020-09-01T16:54:42Z", "commit": {"oid": "28e4b4fdd92fa08f3eeaa91ce46ec8af06fee5af"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjU3Mjkw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3533#pullrequestreview-480657290", "createdAt": "2020-09-02T09:46:31Z", "commit": {"oid": "28e4b4fdd92fa08f3eeaa91ce46ec8af06fee5af"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTo0NjozMVrOHLneQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTo1MzoyMlrOHLntYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk0MzEwNw==", "bodyText": "Should this be a waitForJobFailure and sit in JobUtils? apart from the log message, there is nothing client specific.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3533#discussion_r481943107", "createdAt": "2020-09-02T09:46:31Z", "author": {"login": "scholzj"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/ClientUtils.java", "diffHunk": "@@ -60,6 +60,12 @@ public static void waitForClientSuccess(String jobName, String namespace, int me\n             () -> kubeClient().getClient().batch().jobs().inNamespace(namespace).withName(jobName).get().getStatus().getSucceeded().equals(1));\n     }\n \n+    public static void waitForClientFailure(String jobName, String namespace, long timeout) {\n+        LOGGER.info(\"Waiting for producer/consumer:{} will be in error state\", jobName);\n+        TestUtils.waitFor(\"job finished\", Constants.GLOBAL_POLL_INTERVAL, timeout,\n+            () -> kubeClient().getClient().batch().jobs().inNamespace(namespace).withName(jobName).get().getStatus().getSucceeded().equals(1));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28e4b4fdd92fa08f3eeaa91ce46ec8af06fee5af"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk0NDM1Mw==", "bodyText": "This seems to be the same for all the Bridge tests. Can this be moved in some way to the abstract class?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3533#discussion_r481944353", "createdAt": "2020-09-02T09:48:46Z", "author": {"login": "scholzj"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/bridge/HttpBridgeKafkaExternalListenersST.java", "diffHunk": "@@ -164,5 +166,8 @@ private void testWeirdUsername(String weirdUserName, KafkaListenerAuthentication\n     @BeforeAll\n     void createClassResources() throws Exception {\n         deployClusterOperator(NAMESPACE);\n+\n+        kafkaBridgeClientJob = new KafkaBridgeClientsResource(producerName, consumerName, KafkaBridgeResources.serviceName(CLUSTER_NAME),\n+            TOPIC_NAME, MESSAGE_COUNT, \"\", ClientUtils.generateRandomConsumerGroup(), bridgePort, 1000, 1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28e4b4fdd92fa08f3eeaa91ce46ec8af06fee5af"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk0Njk3Nw==", "bodyText": "What is the value of having this at the class level? Looks like you use it only within a single loop.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3533#discussion_r481946977", "createdAt": "2020-09-02T09:53:22Z", "author": {"login": "scholzj"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/specific/ClusterOperationST.java", "diffHunk": "@@ -32,16 +32,19 @@\n public class ClusterOperationST extends AbstractST {\n \n     private static final Logger LOGGER = LogManager.getLogger(ClusterOperationST.class);\n+    private KafkaBasicClientResource kafkaBasicClientResource;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28e4b4fdd92fa08f3eeaa91ce46ec8af06fee5af"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a41625208d3b724616b19aefc9498fa7df904696", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a41625208d3b724616b19aefc9498fa7df904696", "committedDate": "2020-09-02T11:12:30Z", "message": "fix comments\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bfa5ad9fe820bebeed036691e11f427f2084cac", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3bfa5ad9fe820bebeed036691e11f427f2084cac", "committedDate": "2020-09-02T14:53:22Z", "message": "fixup! fix comments\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1188, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}