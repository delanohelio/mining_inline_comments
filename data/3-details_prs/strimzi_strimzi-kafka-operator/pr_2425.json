{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0NDU0NTY3", "number": 2425, "title": "Add list of connector plugins to Kafka Connect status", "bodyText": "Type of change\n\nEnhancement / new feature\n\nDescription\nOne of the things user needs to know to manage connectors using the Connector operator is which connectors are available in the Connect deployment. This PR adds list of available plugins to Kafka Connect and Kafka Connect S2I resources.\nThe status with this change looks something like this:\nstatus:\n  buildConfigName: my-connect-cluster-connect\n  conditions:\n  - lastTransitionTime: \"2020-01-18T17:43:26.736Z\"\n    status: \"True\"\n    type: Ready\n  connectorPlugins:\n  - class: cz.scholz.kafka.connect.echosink.EchoSinkConnector\n    type: sink\n    version: 1.0.0\n  - class: org.apache.kafka.connect.file.FileStreamSinkConnector\n    type: sink\n    version: 2.4.0\n  - class: org.apache.kafka.connect.file.FileStreamSourceConnector\n    type: source\n    version: 2.4.0\n  - class: org.apache.kafka.connect.mirror.MirrorCheckpointConnector\n    type: source\n    version: \"1\"\n  - class: org.apache.kafka.connect.mirror.MirrorHeartbeatConnector\n    type: source\n    version: \"1\"\n  - class: org.apache.kafka.connect.mirror.MirrorSourceConnector\n    type: source\n    version: \"1\"\n  observedGeneration: 1\n  url: http://my-connect-cluster-connect-api.myproject.svc:8083\n\nChecklist\n\n Write tests\n Make sure all tests pass\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally", "createdAt": "2020-01-18T19:04:10Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2425", "merged": true, "mergeCommit": {"oid": "dabc99e413dc4f41360d2f57f7b027cd93bae6e8"}, "closed": true, "closedAt": "2020-01-20T13:48:56Z", "author": {"login": "scholzj"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7nQPjAH2gAyMzY0NDU0NTY3OjM3NmFkOTVmYTI2ZjlmMzExNWIxMDQ3NjAwYmQzMzU2MDI1NGE2YWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8MVOpAH2gAyMzY0NDU0NTY3OjMzOThiMmI0ZjY0Y2Y3MTY2ZWM1NjNmYTA1YTI1Zjc4MGE5YjFjODA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "376ad95fa26f9f3115b1047600bd33560254a6af", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/376ad95fa26f9f3115b1047600bd33560254a6af", "committedDate": "2020-01-18T18:00:30Z", "message": "Add list of connector plugins to Kafka Connect status\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc0b2c022d966564ba16d35f68f0eb37f2818d22", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/cc0b2c022d966564ba16d35f68f0eb37f2818d22", "committedDate": "2020-01-18T19:23:13Z", "message": "Fix spotbugs\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af349b019bb93740eec9cb90906c437ad4ff535d", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/af349b019bb93740eec9cb90906c437ad4ff535d", "committedDate": "2020-01-18T20:07:54Z", "message": "Fix tests\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1a24b4c04c22b85c8e4c8e8d1fe78087beb9d75", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c1a24b4c04c22b85c8e4c8e8d1fe78087beb9d75", "committedDate": "2020-01-18T20:45:17Z", "message": "Fix derived resources\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MTYxOTQ5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2425#pullrequestreview-345161949", "createdAt": "2020-01-20T09:09:46Z", "commit": {"oid": "c1a24b4c04c22b85c8e4c8e8d1fe78087beb9d75"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwOTowOTo0NlrOFfXb4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwOToxNDoxN1rOFfXkQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQzNDE0Nw==", "bodyText": "There's ConnectRestException which you should use here.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2425#discussion_r368434147", "createdAt": "2020-01-20T09:09:46Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaConnectApi.java", "diffHunk": "@@ -212,4 +215,37 @@ public KafkaConnectApiImpl(Vertx vertx) {\n                 .end();\n         return result;\n     }\n+\n+    @Override\n+    public Future<List<ConnectorPlugin>> listConnectorPlugins(String host, int port) {\n+        Future<List<ConnectorPlugin>> result = Future.future();\n+        HttpClientOptions options = new HttpClientOptions().setLogActivity(true);\n+        String path = \"/connector-plugins\";\n+        vertx.createHttpClient(options)\n+                .get(port, host, path, response -> {\n+                    response.exceptionHandler(error -> {\n+                        result.fail(error);\n+                    });\n+                    if (response.statusCode() == 200) {\n+                        response.bodyHandler(buffer -> {\n+                            ObjectMapper mapper = new ObjectMapper();\n+\n+                            try {\n+                                result.complete(Arrays.asList(mapper.readValue(buffer.getBytes(), ConnectorPlugin[].class)));\n+                            } catch (IOException e)  {\n+                                log.warn(\"Failed to parse list of connector plugins\");\n+                                result.fail(e);\n+                            }\n+                        });\n+                    } else {\n+                        result.fail(\"Unexpected status code \" + response.statusCode()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1a24b4c04c22b85c8e4c8e8d1fe78087beb9d75"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQzNTUxNg==", "bodyText": "I wonder if you should use ConnectRestException here. Until now ConnectRestException has been for lower level errors in handling the HTTP. Here the HTTP worked but returned something that wasn't valid JSON, or was not the expected JSON.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2425#discussion_r368435516", "createdAt": "2020-01-20T09:12:42Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaConnectApi.java", "diffHunk": "@@ -212,4 +215,37 @@ public KafkaConnectApiImpl(Vertx vertx) {\n                 .end();\n         return result;\n     }\n+\n+    @Override\n+    public Future<List<ConnectorPlugin>> listConnectorPlugins(String host, int port) {\n+        Future<List<ConnectorPlugin>> result = Future.future();\n+        HttpClientOptions options = new HttpClientOptions().setLogActivity(true);\n+        String path = \"/connector-plugins\";\n+        vertx.createHttpClient(options)\n+                .get(port, host, path, response -> {\n+                    response.exceptionHandler(error -> {\n+                        result.fail(error);\n+                    });\n+                    if (response.statusCode() == 200) {\n+                        response.bodyHandler(buffer -> {\n+                            ObjectMapper mapper = new ObjectMapper();\n+\n+                            try {\n+                                result.complete(Arrays.asList(mapper.readValue(buffer.getBytes(), ConnectorPlugin[].class)));\n+                            } catch (IOException e)  {\n+                                log.warn(\"Failed to parse list of connector plugins\");\n+                                result.fail(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1a24b4c04c22b85c8e4c8e8d1fe78087beb9d75"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODQzNjI4OQ==", "bodyText": "So we really want to assert on the exact version number? We'll end up having to do this every time we change the version of Kafka being used to run the test. I think it's enough to test non-emptiness.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2425#discussion_r368436289", "createdAt": "2020-01-20T09:14:17Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/operator/assembly/KafkaConnectApiTest.java", "diffHunk": "@@ -96,7 +98,22 @@ public void after() {\n     public void test(VertxTestContext context) throws InterruptedException {\n         KafkaConnectApi client = new KafkaConnectApiImpl(vertx);\n         CountDownLatch async = new CountDownLatch(1);\n-        client.list(\"localhost\", PORT)\n+        client.listConnectorPlugins(\"localhost\", PORT)\n+            .compose(connectorPlugins -> {\n+                assertEquals(connectorPlugins.size(), 2);\n+\n+                ConnectorPlugin fileSink = connectorPlugins.stream().filter(connector -> \"org.apache.kafka.connect.file.FileStreamSinkConnector\".equals(connector.getConnectorClass())).findFirst().orElse(null);\n+                assertNotNull(fileSink);\n+                assertEquals(fileSink.getType(), \"sink\");\n+                assertEquals(fileSink.getVersion(), \"2.3.1\");\n+\n+                ConnectorPlugin fileSource = connectorPlugins.stream().filter(connector -> \"org.apache.kafka.connect.file.FileStreamSourceConnector\".equals(connector.getConnectorClass())).findFirst().orElse(null);\n+                assertNotNull(fileSource);\n+                assertEquals(fileSource.getType(), \"source\");\n+                assertEquals(fileSource.getVersion(), \"2.3.1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1a24b4c04c22b85c8e4c8e8d1fe78087beb9d75"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ef0460d80b8b5e82c2aa17546206c5eb7860d90", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6ef0460d80b8b5e82c2aa17546206c5eb7860d90", "committedDate": "2020-01-20T09:56:55Z", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26184efcceb3d37e544ab84f73c2ecfb365e27d9", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/26184efcceb3d37e544ab84f73c2ecfb365e27d9", "committedDate": "2020-01-20T09:59:09Z", "message": "Merge branch 'master' into add-list-of-connector-plugins-to-kafka-connect-status"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MTk1NDg5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2425#pullrequestreview-345195489", "createdAt": "2020-01-20T10:02:37Z", "commit": {"oid": "26184efcceb3d37e544ab84f73c2ecfb365e27d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MjAwNjEz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2425#pullrequestreview-345200613", "createdAt": "2020-01-20T10:10:53Z", "commit": {"oid": "26184efcceb3d37e544ab84f73c2ecfb365e27d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da47f1d6a1cdf36cabd7ff2d30c85d1028096ab8", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/da47f1d6a1cdf36cabd7ff2d30c85d1028096ab8", "committedDate": "2020-01-20T10:41:55Z", "message": "Merge branch 'master' into add-list-of-connector-plugins-to-kafka-connect-status"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4b571fa6982098045ae620969d980eddcb4e2bd", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c4b571fa6982098045ae620969d980eddcb4e2bd", "committedDate": "2020-01-20T11:23:31Z", "message": "Fix Connect S2I tests after connector reconciliation in S2I has been fixed\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3398b2b4f64cf7166ec563fa05a25f780a9b1c80", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/3398b2b4f64cf7166ec563fa05a25f780a9b1c80", "committedDate": "2020-01-20T13:12:26Z", "message": "Fix checkstyle\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1823, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}