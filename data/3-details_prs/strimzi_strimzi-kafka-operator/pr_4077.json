{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1MzM1Mjc2", "number": 4077, "title": "Remove owner referneces from ClusterRoleBindings", "bodyText": "Type of change\n\nBugfix\n\nDescription\nStrimzi is using ownerReferences to delete resources through Kubernetes garbage collection. The owner references should however be used only within the same scope as the the owner resource. E.g. be in the same namespace or be cluster scoped for cluster scoped resources.\nThis is not the case for ClusterRoleBindings resources and for RoleBindings created for TO/UO in case they watch different namespace. This PR removes the owner references from the first case and adds manual deletion of the ClusterRoleBindings in Kafka and KafkaConnect resources. The TO/UO is a bit more complicated and needs to be addressed in a different PR.\nThis is related to discussion in #3577\nChecklist\n\n Write tests\n Make sure all tests pass\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging", "createdAt": "2020-12-09T17:18:27Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077", "merged": true, "mergeCommit": {"oid": "44c965bc2b96a4d113c0941aac694b908b494735"}, "closed": true, "closedAt": "2020-12-11T08:59:43Z", "author": {"login": "scholzj"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk1iAIgFqTU0OTM0NTY5NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlCmLwgFqTU0OTg0OTA1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MzQ1Njk0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#pullrequestreview-549345694", "createdAt": "2020-12-10T15:58:16Z", "commit": {"oid": "43782fd74e23042d05434ebe44c6e3730fad87a6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNTo1ODoxNlrOIDQcYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxNjowMDowMFrOIDQhyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NjA1MQ==", "bodyText": "I'm guessing this needs @Override annotation", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#discussion_r540286051", "createdAt": "2020-12-10T15:58:16Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -3711,4 +3711,19 @@ String getInternalServiceHostname(String serviceName, boolean useServiceDnsDomai\n     protected KafkaStatus createStatus() {\n         return new KafkaStatus();\n     }\n+\n+    protected Future<Boolean> delete(Reconciliation reconciliation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43782fd74e23042d05434ebe44c6e3730fad87a6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NjYzNQ==", "bodyText": "Doesn't the user need to delete in this case? So should it be a info, or even warn?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#discussion_r540286635", "createdAt": "2020-12-10T15:59:01Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -3711,4 +3711,19 @@ String getInternalServiceHostname(String serviceName, boolean useServiceDnsDomai\n     protected KafkaStatus createStatus() {\n         return new KafkaStatus();\n     }\n+\n+    protected Future<Boolean> delete(Reconciliation reconciliation) {\n+        return clusterRoleBindingOperations.reconcile(KafkaResources.initContainerClusterRoleBindingName(reconciliation.name(), reconciliation.namespace()), null)\n+                .recover(error -> {\n+                    if (error != null\n+                            && error.getMessage() != null\n+                            && error.getMessage().contains(\"Message: Forbidden!\"))  {\n+                        log.debug(\"Ignoring forbidden access to ClusterRoleBindings when attempting to delete resources.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43782fd74e23042d05434ebe44c6e3730fad87a6"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI4NzQzNA==", "bodyText": "It it's a KubernetesClientException I think there should be a status code, which might be a little less fragile than contains on the message.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#discussion_r540287434", "createdAt": "2020-12-10T16:00:00Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -3711,4 +3711,19 @@ String getInternalServiceHostname(String serviceName, boolean useServiceDnsDomai\n     protected KafkaStatus createStatus() {\n         return new KafkaStatus();\n     }\n+\n+    protected Future<Boolean> delete(Reconciliation reconciliation) {\n+        return clusterRoleBindingOperations.reconcile(KafkaResources.initContainerClusterRoleBindingName(reconciliation.name(), reconciliation.namespace()), null)\n+                .recover(error -> {\n+                    if (error != null\n+                            && error.getMessage() != null\n+                            && error.getMessage().contains(\"Message: Forbidden!\"))  {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43782fd74e23042d05434ebe44c6e3730fad87a6"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13e60fea924b044788997aebfff8e6fc4b0a6395", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/13e60fea924b044788997aebfff8e6fc4b0a6395", "committedDate": "2020-12-11T01:47:40Z", "message": "Remove ownerReferneces from ClusterRoleBindings\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "556320cc0f15595c3c9ddacdedacb5de78b3fe2a", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/556320cc0f15595c3c9ddacdedacb5de78b3fe2a", "committedDate": "2020-12-11T01:47:40Z", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "167d1ebf7b09a3c57c7a81c7b7317560024b8062", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/167d1ebf7b09a3c57c7a81c7b7317560024b8062", "committedDate": "2020-12-11T01:47:40Z", "message": "Review comments II\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90328180ae66f0fbce4550b9e72da8526f89b2a7", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/90328180ae66f0fbce4550b9e72da8526f89b2a7", "committedDate": "2020-12-11T01:49:36Z", "message": "Fix log message search in STs\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e8369abe07c4d160558a5eeb8e724598bafbafda", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e8369abe07c4d160558a5eeb8e724598bafbafda", "committedDate": "2020-12-10T21:30:48Z", "message": "Review comments II\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}, "afterCommit": {"oid": "90328180ae66f0fbce4550b9e72da8526f89b2a7", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/90328180ae66f0fbce4550b9e72da8526f89b2a7", "committedDate": "2020-12-11T01:49:36Z", "message": "Fix log message search in STs\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5ODQ5MDU0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/4077#pullrequestreview-549849054", "createdAt": "2020-12-11T07:13:57Z", "commit": {"oid": "90328180ae66f0fbce4550b9e72da8526f89b2a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 727, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}