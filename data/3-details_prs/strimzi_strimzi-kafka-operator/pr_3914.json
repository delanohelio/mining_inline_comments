{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MDU2MDQ3", "number": 3914, "title": "[systemtest] Test recovery of Kafka cluster when impossible memory request is set", "bodyText": "Signed-off-by: Lukas Kral lukywill16@gmail.com\nType of change\n\nNew test\n\nDescription\nIn #3721 was comment about adding recovery test for KafkaRoller, when we deploy Kafka cluster with some impossible memory request -> the pods are in Pending state. After the fix, there should be option to change the CR with correct values, Kafka pods should then \"recover\" itself and become running and Ready.\nThis PR adds test for it.\nChecklist\n\n Write tests\n Make sure all tests pass", "createdAt": "2020-11-04T00:02:28Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914", "merged": true, "mergeCommit": {"oid": "8063e26e0d9cce820abf01046c80591da04498ca"}, "closed": true, "closedAt": "2020-11-06T12:13:52Z", "author": {"login": "im-konge"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZJVX7AFqTUyMzEyNDY2MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ1WNRAFqTUyNTA3NDQ5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMTI0NjYx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#pullrequestreview-523124661", "createdAt": "2020-11-04T08:15:55Z", "commit": {"oid": "4bcb35af9d15969d676eadb348c49b65738e4929"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwODoxNTo1NVrOHtNIYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwODoxNzozMVrOHtNLrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2MzEwNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    PodUtils.waitForPendingPod(clusterName + \"-kafka\");\n          \n          \n            \n                    PodUtils.waitForPendingPod(KafkaResources.kafkaStatefulSetName(clusterName));", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517163105", "createdAt": "2020-11-04T08:15:55Z", "author": {"login": "sknot-rh"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/RecoveryST.java", "diffHunk": "@@ -228,6 +235,42 @@ void testRecoveryFromKafkaBridgeMetricsConfigDeletion() {\n         timeMeasuringSystem.stopOperation(timeMeasuringSystem.getOperationID());\n     }\n \n+    @Test\n+    void testRecoveryFromImpossibleMemoryRequest() {\n+        String clusterName = \"my-cluster\";\n+\n+        Map<String, Quantity> requests = new HashMap<>(2);\n+        requests.put(\"memory\", new Quantity(\"465458732Gi\"));\n+\n+        ResourceRequirements resourceReq = new ResourceRequirementsBuilder()\n+            .withRequests(requests)\n+            .build();\n+\n+        KafkaResource.kafkaWithoutWait(KafkaResource.defaultKafka(clusterName, 3, 3)\n+            .editSpec()\n+                .editKafka()\n+                    .withResources(resourceReq)\n+                .endKafka()\n+            .endSpec()\n+            .build());\n+\n+        PodUtils.waitForPendingPod(clusterName + \"-kafka\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bcb35af9d15969d676eadb348c49b65738e4929"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE2Mzk1MQ==", "bodyText": "Is this test different from io.strimzi.systemtest.rollingupdate.KafkaRollerST#testKafkaPodPending apart from setting memory instead of CPU?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517163951", "createdAt": "2020-11-04T08:17:31Z", "author": {"login": "sknot-rh"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/RecoveryST.java", "diffHunk": "@@ -228,6 +235,42 @@ void testRecoveryFromKafkaBridgeMetricsConfigDeletion() {\n         timeMeasuringSystem.stopOperation(timeMeasuringSystem.getOperationID());\n     }\n \n+    @Test\n+    void testRecoveryFromImpossibleMemoryRequest() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bcb35af9d15969d676eadb348c49b65738e4929"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42bceedf6d61c4ede64bbfab62202a718e35f805", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/42bceedf6d61c4ede64bbfab62202a718e35f805", "committedDate": "2020-11-04T12:08:50Z", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "5d7fd0b1add485cb803025a107b01057324cc145", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5d7fd0b1add485cb803025a107b01057324cc145", "committedDate": "2020-11-04T13:46:04Z", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMzgyMTIx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#pullrequestreview-523382121", "createdAt": "2020-11-04T13:56:29Z", "commit": {"oid": "5d7fd0b1add485cb803025a107b01057324cc145"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "edbf542f7615d97aa17fa9b18fdc540b096bee04", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/edbf542f7615d97aa17fa9b18fdc540b096bee04", "committedDate": "2020-11-04T14:03:28Z", "message": "fixup! comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "6f1c8758b53997618680023241e5bc6de9b7c775", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6f1c8758b53997618680023241e5bc6de9b7c775", "committedDate": "2020-11-04T16:38:24Z", "message": "fixup! comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MDE1MDA2", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#pullrequestreview-524015006", "createdAt": "2020-11-05T08:20:32Z", "commit": {"oid": "6f1c8758b53997618680023241e5bc6de9b7c775"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODoyMDozMlrOHt38aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODoyMDozN1rOHt38lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2NDU1Mg==", "bodyText": "What's the purpose of this?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517864552", "createdAt": "2020-11-05T08:20:32Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/KafkaRollerST.java", "diffHunk": "@@ -168,11 +171,15 @@ void testKafkaPodCrashLooping() {\n     void testKafkaPodImagePullBackOff() {\n         KafkaResource.kafkaPersistent(CLUSTER_NAME, 3, 3).done();\n \n-        KafkaResource.replaceKafkaResource(CLUSTER_NAME, kafka ->\n-                kafka.getSpec().getKafka().setImage(\"strimzi/kafka:not-existent-tag\"));\n+        KafkaResource.replaceKafkaResource(CLUSTER_NAME, kafka -> {\n+            kafka.getSpec().getKafka().setImage(\"strimzi/kafka:not-existent-tag\");\n+            kafka.getSpec().getZookeeper().setImage(\"strimzi/kafka:latest-kafka-\" + Environment.ST_KAFKA_VERSION);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1c8758b53997618680023241e5bc6de9b7c775"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg2NDU5OQ==", "bodyText": "Shouldn't we have there some additional wait to see that pods are rly broken?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r517864599", "createdAt": "2020-11-05T08:20:37Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/RecoveryST.java", "diffHunk": "@@ -228,6 +235,42 @@ void testRecoveryFromKafkaBridgeMetricsConfigDeletion() {\n         timeMeasuringSystem.stopOperation(timeMeasuringSystem.getOperationID());\n     }\n \n+    @Test\n+    void testRecoveryFromImpossibleMemoryRequest() {\n+        String clusterName = \"my-cluster\";\n+\n+        Map<String, Quantity> requests = new HashMap<>(2);\n+        requests.put(\"memory\", new Quantity(\"465458732Gi\"));\n+\n+        ResourceRequirements resourceReq = new ResourceRequirementsBuilder()\n+            .withRequests(requests)\n+            .build();\n+\n+        KafkaResource.kafkaWithoutWait(KafkaResource.defaultKafka(clusterName, 3, 3)\n+            .editSpec()\n+                .editKafka()\n+                    .withResources(resourceReq)\n+                .endKafka()\n+            .endSpec()\n+            .build());\n+\n+        PodUtils.waitForPendingPod(KafkaResources.kafkaStatefulSetName(clusterName));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1c8758b53997618680023241e5bc6de9b7c775"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec187127d7d5510ee85a6c9e7bbb13693cc7c5cf", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ec187127d7d5510ee85a6c9e7bbb13693cc7c5cf", "committedDate": "2020-11-05T15:26:54Z", "message": "add recovery test for starting kafka cluster with impossible memory request\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de2511aeda9f1203399eabcc7a4540ae45820976", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/de2511aeda9f1203399eabcc7a4540ae45820976", "committedDate": "2020-11-05T15:26:54Z", "message": "fixup! add recovery test for starting kafka cluster with impossible memory request\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbeb531bf30a68930e357b6a1281ac4407b05558", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/bbeb531bf30a68930e357b6a1281ac4407b05558", "committedDate": "2020-11-05T15:26:54Z", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b92aa3b072deefdc8c50c533f18989ae7c693290", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b92aa3b072deefdc8c50c533f18989ae7c693290", "committedDate": "2020-11-05T15:26:54Z", "message": "fixup! comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDU0MzE3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#pullrequestreview-524454317", "createdAt": "2020-11-05T16:42:09Z", "commit": {"oid": "6f1c8758b53997618680023241e5bc6de9b7c775"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjo0MjowOVrOHuMJ6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjo0MzowOFrOHuMMkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NTY5MA==", "bodyText": "checkIfExactlyOneKafkaPodIsNotReady would be clearer (otherwise it might be mistaken for an 'at least one' condition)", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r518195690", "createdAt": "2020-11-05T16:42:09Z", "author": {"login": "tombentley"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/rollingupdate/KafkaRollerST.java", "diffHunk": "@@ -266,6 +275,13 @@ void testKafkaPodPendingDueToRack() {\n         KafkaUtils.waitForKafkaReady(CLUSTER_NAME);\n     }\n \n+    boolean checkIfOneKafkaPodIsNotReady(String clusterName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1c8758b53997618680023241e5bc6de9b7c775"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5NjM3MQ==", "bodyText": "Add javadoc here and to testKafkaPodPending to explain the difference between the tests.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#discussion_r518196371", "createdAt": "2020-11-05T16:43:08Z", "author": {"login": "tombentley"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/operators/RecoveryST.java", "diffHunk": "@@ -228,6 +235,42 @@ void testRecoveryFromKafkaBridgeMetricsConfigDeletion() {\n         timeMeasuringSystem.stopOperation(timeMeasuringSystem.getOperationID());\n     }\n \n+    @Test\n+    void testRecoveryFromImpossibleMemoryRequest() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f1c8758b53997618680023241e5bc6de9b7c775"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c56a212df511088e2f0db39475219426f0e2961", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5c56a212df511088e2f0db39475219426f0e2961", "committedDate": "2020-11-05T18:11:53Z", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6f1c8758b53997618680023241e5bc6de9b7c775", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6f1c8758b53997618680023241e5bc6de9b7c775", "committedDate": "2020-11-04T16:38:24Z", "message": "fixup! comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "5c56a212df511088e2f0db39475219426f0e2961", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5c56a212df511088e2f0db39475219426f0e2961", "committedDate": "2020-11-05T18:11:53Z", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f2ed2f6cff7e1396dedd922bee9b1665ae78261", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8f2ed2f6cff7e1396dedd922bee9b1665ae78261", "committedDate": "2020-11-06T09:42:22Z", "message": "change javadoc again\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MDc0NDkx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3914#pullrequestreview-525074491", "createdAt": "2020-11-06T11:34:34Z", "commit": {"oid": "8f2ed2f6cff7e1396dedd922bee9b1665ae78261"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 880, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}