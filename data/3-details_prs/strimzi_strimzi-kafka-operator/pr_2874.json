{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3NDY4NDI2", "number": 2874, "title": "TO metrics", "bodyText": "Signed-off-by: Stanislav Knot sknot@redhat.com\nType of change\n\nEnhancement / new feature\n\nDescription\nAdd metrics for the Topic operator.\nChecklist\n\n Update/write design documentation in ./design\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md", "createdAt": "2020-04-22T18:40:54Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874", "merged": true, "mergeCommit": {"oid": "e94c75258ad7ff3c455c36c4184ceb3a3991fed0"}, "closed": true, "closedAt": "2020-05-05T07:07:55Z", "author": {"login": "sknot-rh"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaPLupAFqTM5ODYwMjAyNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABceOmeDAFqTQwNTUzNjgwMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NjAyMDI3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#pullrequestreview-398602027", "createdAt": "2020-04-22T21:26:34Z", "commit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToyNjozNFrOGKMj8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQyMToyODoyOFrOGKMoNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM0NDc1NA==", "bodyText": "In CO and UO, the timer as well as some of the counters are measured per resource. So if you have 10 Kafka topics, you will get 10 measurements. This looks to me like it really measures only the reconcilaAll. Or do I misunderstand what this code in the operator does?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413344754", "createdAt": "2020-04-22T21:26:34Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -221,8 +223,18 @@ public void handle(Long oldTimerId) {\n                         if (!stopped) {\n                             timerId = null;\n                             boolean isInitialReconcile = oldTimerId == null;\n+                            Timer.Sample reconciliationTimerSample = Timer.start(topicOperator.getMetrics().meterRegistry());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM0NTM1Mg==", "bodyText": "Doesn't this and the line 233 increment the counter twice in a sinfle recomciliation?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413345352", "createdAt": "2020-04-22T21:27:33Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -221,8 +223,18 @@ public void handle(Long oldTimerId) {\n                         if (!stopped) {\n                             timerId = null;\n                             boolean isInitialReconcile = oldTimerId == null;\n+                            Timer.Sample reconciliationTimerSample = Timer.start(topicOperator.getMetrics().meterRegistry());\n                             topicOperator.reconcileAllTopics(isInitialReconcile ? \"initial \" : \"periodic \").setHandler(result -> {\n+                                topicOperator.getPeriodicReconciliationsCounter().increment();\n+                                if (result.failed()) {\n+                                    topicOperator.incrementFailedReconciliationsCounter();\n+                                    reconciliationTimerSample.stop(topicOperator.getReconciliationsTimer());\n+                                } else {\n+                                    topicOperator.incrementSuccessfulReconciliationsCounter();\n+                                    reconciliationTimerSample.stop(topicOperator.getReconciliationsTimer());\n+                                }\n                                 if (isInitialReconcile) {\n+                                    topicOperator.incrementSuccessfulReconciliationsCounter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzM0NTg0NQ==", "bodyText": "The time can be probably stopped only once outside the if-else, or?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413345845", "createdAt": "2020-04-22T21:28:28Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -221,8 +223,18 @@ public void handle(Long oldTimerId) {\n                         if (!stopped) {\n                             timerId = null;\n                             boolean isInitialReconcile = oldTimerId == null;\n+                            Timer.Sample reconciliationTimerSample = Timer.start(topicOperator.getMetrics().meterRegistry());\n                             topicOperator.reconcileAllTopics(isInitialReconcile ? \"initial \" : \"periodic \").setHandler(result -> {\n+                                topicOperator.getPeriodicReconciliationsCounter().increment();\n+                                if (result.failed()) {\n+                                    topicOperator.incrementFailedReconciliationsCounter();\n+                                    reconciliationTimerSample.stop(topicOperator.getReconciliationsTimer());\n+                                } else {\n+                                    topicOperator.incrementSuccessfulReconciliationsCounter();\n+                                    reconciliationTimerSample.stop(topicOperator.getReconciliationsTimer());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4ODcxMjU5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#pullrequestreview-398871259", "createdAt": "2020-04-23T08:25:33Z", "commit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwODoyNTozNFrOGKdE0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwODozMjoxNlrOGKdYww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxNTMxMw==", "bodyText": "I think \"periodic\" is better than \"periodical\"", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413615313", "createdAt": "2020-04-23T08:25:34Z", "author": {"login": "tombentley"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -357,16 +372,75 @@ public TopicOperator(Vertx vertx, Kafka kafka,\n                          TopicStore topicStore,\n                          Labels labels,\n                          String namespace,\n-                         Config config) {\n+                         Config config,\n+                         MetricsProvider metrics) {\n         this.kafka = kafka;\n         this.k8s = k8s;\n         this.vertx = vertx;\n         this.labels = labels;\n         this.topicStore = topicStore;\n         this.namespace = namespace;\n         this.config = config;\n+        this.metrics = metrics;\n+\n+        initMetrics();\n+    }\n+\n+    public void initMetrics() {\n+        Tags metricTags = Tags.of(Tag.of(\"kind\", \"KafkaTopic\"));\n+\n+        periodicReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.periodical\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxNzYxMg==", "bodyText": "Is this an average? Or just the time for the last reconciliation? We probably need two of these because of the fact that periodic reconciliations (because they reconcile all the topics) will take ~n times longer than event-based reconciliations.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413617612", "createdAt": "2020-04-23T08:28:40Z", "author": {"login": "tombentley"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -357,16 +372,75 @@ public TopicOperator(Vertx vertx, Kafka kafka,\n                          TopicStore topicStore,\n                          Labels labels,\n                          String namespace,\n-                         Config config) {\n+                         Config config,\n+                         MetricsProvider metrics) {\n         this.kafka = kafka;\n         this.k8s = k8s;\n         this.vertx = vertx;\n         this.labels = labels;\n         this.topicStore = topicStore;\n         this.namespace = namespace;\n         this.config = config;\n+        this.metrics = metrics;\n+\n+        initMetrics();\n+    }\n+\n+    public void initMetrics() {\n+        Tags metricTags = Tags.of(Tag.of(\"kind\", \"KafkaTopic\"));\n+\n+        periodicReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.periodical\",\n+                \"Number of periodical reconciliations done by the operator\",\n+                metricTags);\n+\n+        reconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations\",\n+                \"Number of reconciliations done by the operator for individual topics\",\n+                metricTags);\n+\n+        failedReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.failed\",\n+                \"Number of reconciliations done by the operator for individual topics which failed\",\n+                metricTags);\n+\n+        successfulReconciliationsCounter = metrics.counter(METRICS_PREFIX + \"reconciliations.successful\",\n+                \"Number of reconciliations done by the operator for individual topics which were successful\",\n+                metricTags);\n+\n+        topicCounter = metrics.gauge(METRICS_PREFIX + \"resources\",\n+                \"Number of topics the operator sees\",\n+                metricTags);\n+\n+        reconciliationsTimer = metrics.timer(METRICS_PREFIX + \"reconciliations.duration\",\n+                \"The time the reconciliation takes to complete\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYxODkxNQ==", "bodyText": "With these I wonder if it would be better to build this into the Reconciliation class, rather than having to change all these call sites. Wdyt?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413618915", "createdAt": "2020-04-23T08:30:18Z", "author": {"login": "tombentley"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/ZkTopicsWatcher.java", "diffHunk": "@@ -84,8 +84,11 @@ void start(Zk zk) {\n                     LogContext logContext = LogContext.zkWatch(TOPICS_ZNODE, \"-\" + topicName);\n                     topicOperator.onTopicDeleted(logContext, new TopicName(topicName)).setHandler(ar -> {\n                         if (ar.succeeded()) {\n+                            topicOperator.decrementTopicCounter();\n+                            topicOperator.incrementSuccessfulReconciliationsCounter();\n                             LOGGER.debug(\"{}: Success responding to deletion of topic {}\", logContext, topicName);\n                         } else {\n+                            topicOperator.incrementFailedReconciliationsCounter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYyMDQxOQ==", "bodyText": "Rather than adding specific tests for the metrics, did you consider adding assertions on the metrics to the existing tests in TOT? That would provide better coverage.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r413620419", "createdAt": "2020-04-23T08:32:16Z", "author": {"login": "tombentley"}, "path": "topic-operator/src/test/java/io/strimzi/operator/topic/TopicOperatorTest.java", "diffHunk": "@@ -995,6 +1008,90 @@ public void testReconcileAllTopics_listMapsFails(VertxTestContext context) {\n         }));\n     }\n \n+    @Test\n+    public void testFailedReconcileMetrics(VertxTestContext context) throws InterruptedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b3417e5ec2496d4a864e60314c3dcf44a06b65c"}, "originalPosition": 71}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d23aae7cbaf0bd175a787d56e8d7dad9cb4e6956", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d23aae7cbaf0bd175a787d56e8d7dad9cb4e6956", "committedDate": "2020-04-27T10:30:52Z", "message": "move metrics stuff to reconciliation\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "9ce6f8b0abb7cf5bd847a10f3c173d0d73237700", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9ce6f8b0abb7cf5bd847a10f3c173d0d73237700", "committedDate": "2020-04-27T10:31:41Z", "message": "move metrics stuff to reconciliation\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a4b1215707b4221c29f3db9fb8f7ed2b27b95e2", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8a4b1215707b4221c29f3db9fb8f7ed2b27b95e2", "committedDate": "2020-04-28T14:55:40Z", "message": "tests vol2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "93455b94d9d3f4895973dc7ad7bd18b449cc08ab", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/93455b94d9d3f4895973dc7ad7bd18b449cc08ab", "committedDate": "2020-04-28T15:08:57Z", "message": "tests vol2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93455b94d9d3f4895973dc7ad7bd18b449cc08ab", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/93455b94d9d3f4895973dc7ad7bd18b449cc08ab", "committedDate": "2020-04-28T15:08:57Z", "message": "tests vol2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "c84419099f979640653bcb8cea45fbdf089da986", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c84419099f979640653bcb8cea45fbdf089da986", "committedDate": "2020-04-28T16:26:39Z", "message": "tests vol2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c84419099f979640653bcb8cea45fbdf089da986", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c84419099f979640653bcb8cea45fbdf089da986", "committedDate": "2020-04-28T16:26:39Z", "message": "tests vol2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "42f6fc315d2dc60eae92184a93f04cfc58421e1f", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/42f6fc315d2dc60eae92184a93f04cfc58421e1f", "committedDate": "2020-04-28T17:28:53Z", "message": "tests vol2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42f6fc315d2dc60eae92184a93f04cfc58421e1f", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/42f6fc315d2dc60eae92184a93f04cfc58421e1f", "committedDate": "2020-04-28T17:28:53Z", "message": "tests vol2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "923172814b67d84863e13c492b8fbae2f49fbd61", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/923172814b67d84863e13c492b8fbae2f49fbd61", "committedDate": "2020-04-28T18:03:26Z", "message": "tests vol2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "923172814b67d84863e13c492b8fbae2f49fbd61", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/923172814b67d84863e13c492b8fbae2f49fbd61", "committedDate": "2020-04-28T18:03:26Z", "message": "tests vol2\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "20e9ebf99d616f0a4892360fb7a6913aff529ca5", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/20e9ebf99d616f0a4892360fb7a6913aff529ca5", "committedDate": "2020-04-29T06:53:19Z", "message": "flaky\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20e9ebf99d616f0a4892360fb7a6913aff529ca5", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/20e9ebf99d616f0a4892360fb7a6913aff529ca5", "committedDate": "2020-04-29T06:53:19Z", "message": "flaky\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "4c454409f7ee3eff143951f59b6a3983e9bff389", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4c454409f7ee3eff143951f59b6a3983e9bff389", "committedDate": "2020-04-29T06:55:15Z", "message": "flaky\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNzg1OTI3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#pullrequestreview-402785927", "createdAt": "2020-04-29T15:31:22Z", "commit": {"oid": "b614665c596a86037b44df8b4aed8849b4a090c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTozMToyMlrOGOEldQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTozMToyMlrOGOEldQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQwODM3Mw==", "bodyText": "Do we rly needs this for getExpectedTopics().size() ?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r417408373", "createdAt": "2020-04-29T15:31:22Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/metrics/MetricsST.java", "diffHunk": "@@ -316,6 +332,21 @@ void setupEnvironment() throws InterruptedException {\n         kafkaExporterMetricsData = MetricsUtils.collectKafkaExporterPodsMetrics(CLUSTER_NAME);\n         kafkaMirrorMaker2MetricsData = MetricsUtils.collectKafkaMirrorMaker2PodsMetrics(MIRROR_MAKER_CLUSTER);\n         userOperatorMetricsData = MetricsUtils.collectUserOperatorPodMetrics(CLUSTER_NAME);\n+        topicOperatorMetricsData = MetricsUtils.collectTopicOperatorPodMetrics(CLUSTER_NAME);\n         clusterOperatorMetricsData = MetricsUtils.collectClusterOperatorPodMetrics();\n     }\n+    \n+    private List<String> getExpectedTopics() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b614665c596a86037b44df8b4aed8849b4a090c7"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e932356581959a66642eda804418116e05dea23", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8e932356581959a66642eda804418116e05dea23", "committedDate": "2020-04-30T13:20:48Z", "message": "TO metrics\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27b2136b8033a9c510e078706619d6550c530b60", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/27b2136b8033a9c510e078706619d6550c530b60", "committedDate": "2020-04-30T13:20:48Z", "message": "fix tests\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9515b77f44e57fb8ab9d4123d3db200d1fcffbad", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9515b77f44e57fb8ab9d4123d3db200d1fcffbad", "committedDate": "2020-04-30T13:20:48Z", "message": "comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa514424e6de8458afd10a554a31576255afce1d", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fa514424e6de8458afd10a554a31576255afce1d", "committedDate": "2020-04-30T13:20:48Z", "message": "move metrics stuff to reconciliation\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3c24fda6188ee4eeb87f8ab54042f2eb231b00f", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a3c24fda6188ee4eeb87f8ab54042f2eb231b00f", "committedDate": "2020-04-30T13:20:48Z", "message": "silly me\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "416a6897164ce13b5fc036f97fe47475fccd2323", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/416a6897164ce13b5fc036f97fe47475fccd2323", "committedDate": "2020-04-30T13:20:48Z", "message": "I love flaky tests so much\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f3ed3ea0e99efd4e4832245a88763bde8eda820", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/0f3ed3ea0e99efd4e4832245a88763bde8eda820", "committedDate": "2020-04-30T13:20:48Z", "message": "flaky\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c8d0e9ce028c06fbb6040ac9df2de9dbbdd418c", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5c8d0e9ce028c06fbb6040ac9df2de9dbbdd418c", "committedDate": "2020-04-30T13:20:48Z", "message": "flaky\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b614665c596a86037b44df8b4aed8849b4a090c7", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b614665c596a86037b44df8b4aed8849b4a090c7", "committedDate": "2020-04-29T08:50:44Z", "message": "flaky\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "5c8d0e9ce028c06fbb6040ac9df2de9dbbdd418c", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5c8d0e9ce028c06fbb6040ac9df2de9dbbdd418c", "committedDate": "2020-04-30T13:20:48Z", "message": "flaky\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NTM1ODUw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#pullrequestreview-404535850", "createdAt": "2020-05-02T15:13:11Z", "commit": {"oid": "5c8d0e9ce028c06fbb6040ac9df2de9dbbdd418c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQxNToxMzoxMVrOGPj46w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMlQxNToxODoyOFrOGPj7LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk2OTgzNQ==", "bodyText": "This looks wrong to me -> In the other operators:\n\nEvery periodic reconciliation increases the periodic counter + triggers reconciliation for every resource (topic in this case)\nEvery reconcilition for a prticular topic triggers its own counter\n\nThe sucess and failure counters as well as timers are counted only against the particular topics reconciliation. Not against the periodic reconciliations. So I don't think you should increment here the failed and success counters.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r418969835", "createdAt": "2020-05-02T15:13:11Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/Session.java", "diffHunk": "@@ -223,6 +224,12 @@ public void handle(Long oldTimerId) {\n                             timerId = null;\n                             boolean isInitialReconcile = oldTimerId == null;\n                             topicOperator.reconcileAllTopics(isInitialReconcile ? \"initial \" : \"periodic \").setHandler(result -> {\n+                                topicOperator.getPeriodicReconciliationsCounter().increment();\n+                                if (result.failed()) {\n+                                    topicOperator.incrementFailedReconciliationsCounter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c8d0e9ce028c06fbb6040ac9df2de9dbbdd418c"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3MDE2Mg==", "bodyText": "I don't really understand the TO much. But do we have to do this in these onTopic* methods? Seems a but fragile to me and must be hard to test. Isn't there some method which is calling these where you can set it?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r418970162", "createdAt": "2020-05-02T15:16:10Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/TopicOperator.java", "diffHunk": "@@ -700,7 +774,7 @@ void enqueue(Handler<Void> event) {\n     /** Called when a topic znode is deleted in ZK */\n     Future<Void> onTopicDeleted(LogContext logContext, TopicName topicName) {\n         return executeWithTopicLockHeld(logContext, topicName,\n-            new Reconciliation(\"onTopicDeleted\") {\n+            new Reconciliation(\"onTopicDeleted\", Timer.start(metrics.meterRegistry())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c8d0e9ce028c06fbb6040ac9df2de9dbbdd418c"}, "originalPosition": 138}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODk3MDQxMw==", "bodyText": "This looks a bit fragile, but I assume it works. The other operator set the topic counter in the reconcileAll method which easily gets the count of all topics with every periodic reconciliation. But not sure that is any easier or harder in the TO.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#discussion_r418970413", "createdAt": "2020-05-02T15:18:28Z", "author": {"login": "scholzj"}, "path": "topic-operator/src/main/java/io/strimzi/operator/topic/ZkTopicsWatcher.java", "diffHunk": "@@ -84,6 +84,7 @@ void start(Zk zk) {\n                     LogContext logContext = LogContext.zkWatch(TOPICS_ZNODE, \"-\" + topicName);\n                     topicOperator.onTopicDeleted(logContext, new TopicName(topicName)).setHandler(ar -> {\n                         if (ar.succeeded()) {\n+                            topicOperator.decrementTopicCounter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c8d0e9ce028c06fbb6040ac9df2de9dbbdd418c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e890de14ea552b0fc4f61a0b37aa97925ca568e9", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e890de14ea552b0fc4f61a0b37aa97925ca568e9", "committedDate": "2020-05-04T06:30:18Z", "message": "review comments\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecd7bb2c000f72822162f57700234793a240722f", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ecd7bb2c000f72822162f57700234793a240722f", "committedDate": "2020-05-04T08:36:18Z", "message": "better place for topic count\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e7e40ee5e3ed1943156f024508c492b784aff47c", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e7e40ee5e3ed1943156f024508c492b784aff47c", "committedDate": "2020-05-04T08:30:44Z", "message": "better place for topic count\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "ecd7bb2c000f72822162f57700234793a240722f", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ecd7bb2c000f72822162f57700234793a240722f", "committedDate": "2020-05-04T08:36:18Z", "message": "better place for topic count\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0Nzk5MzY2", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#pullrequestreview-404799366", "createdAt": "2020-05-04T08:39:03Z", "commit": {"oid": "ecd7bb2c000f72822162f57700234793a240722f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0ODI5NTYx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#pullrequestreview-404829561", "createdAt": "2020-05-04T09:25:45Z", "commit": {"oid": "ecd7bb2c000f72822162f57700234793a240722f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0ODM4Njgy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#pullrequestreview-404838682", "createdAt": "2020-05-04T09:39:55Z", "commit": {"oid": "ecd7bb2c000f72822162f57700234793a240722f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4f55b4d15610751fad9f8e9e4006d052c8e2ce1", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a4f55b4d15610751fad9f8e9e4006d052c8e2ce1", "committedDate": "2020-05-04T13:20:48Z", "message": "fix ST\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "93780678e8c1a648f0899db31e2c3315bf74128f", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/93780678e8c1a648f0899db31e2c3315bf74128f", "committedDate": "2020-05-04T14:28:48Z", "message": "fix ST\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3ba3732c18a5988893d92a7c8a0b5953a74da1e", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d3ba3732c18a5988893d92a7c8a0b5953a74da1e", "committedDate": "2020-05-04T15:22:07Z", "message": "fix ST\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93780678e8c1a648f0899db31e2c3315bf74128f", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/93780678e8c1a648f0899db31e2c3315bf74128f", "committedDate": "2020-05-04T14:28:48Z", "message": "fix ST\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "d3ba3732c18a5988893d92a7c8a0b5953a74da1e", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d3ba3732c18a5988893d92a7c8a0b5953a74da1e", "committedDate": "2020-05-04T15:22:07Z", "message": "fix ST\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NTM2ODAy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2874#pullrequestreview-405536802", "createdAt": "2020-05-05T07:04:30Z", "commit": {"oid": "d3ba3732c18a5988893d92a7c8a0b5953a74da1e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1931, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}