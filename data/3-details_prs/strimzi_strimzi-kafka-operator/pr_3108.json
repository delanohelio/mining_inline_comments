{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MDU0NDc4", "number": 3108, "title": "Improve shell scripts in our Docker images", "bodyText": "Type of change\n\nBugfix\n\nDescription\nWe seem to have fairly often problems with the quality of the shell scripts in our container images where for example errors when preparing TLS certificates are ignored and do not fail the container startup (latest in #3092).\nThis PR tries to improve it by setting -e in all the scripts to make them fail on error. Additionally, it also adds validation using Shellcheck which is also integrated into the CI build and resulted in some more changes to actually pass the checks.\nChecklist\n\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging", "createdAt": "2020-05-27T19:00:09Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3108", "merged": true, "mergeCommit": {"oid": "35c268f686f09b4d451d80324d686b651e664008"}, "closed": true, "closedAt": "2020-06-01T13:04:06Z", "author": {"login": "scholzj"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcld77VgH2gAyNDI0MDU0NDc4OjE3ZDhjNzNkOTZlNzY4ZWU2MmE5MTk5MDQ3MWE0OWI4ZDViOTRhMmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcm77kUAFqTQyMTY3MzQ4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "17d8c73d96e768ee62a91990471a49b8d5b94a2c", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/17d8c73d96e768ee62a91990471a49b8d5b94a2c", "committedDate": "2020-05-27T18:53:59Z", "message": "Improve shell scripts in our Docker images\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13552ac368daba07f2b5cc22d1e78329363f6025", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/13552ac368daba07f2b5cc22d1e78329363f6025", "committedDate": "2020-05-27T19:15:13Z", "message": "Validate operator shell scripts in the originl location\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5NTQ0ODI5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3108#pullrequestreview-419544829", "createdAt": "2020-05-27T19:30:00Z", "commit": {"oid": "13552ac368daba07f2b5cc22d1e78329363f6025"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxOTozMDowMFrOGbaJJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxOTozMDowMFrOGbaJJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM5MzA2Mw==", "bodyText": "Normally you would quote the whole string I.e. exec \"${STRIMZI_HOME}/bin/launch_java.sh\"\nI think in practice is has little difference but it makes it a little clearer to read", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3108#discussion_r431393063", "createdAt": "2020-05-27T19:30:00Z", "author": {"login": "samuel-hawker"}, "path": "user-operator/scripts/user_operator_run.sh", "diffHunk": "@@ -14,4 +16,4 @@ fi\n \n export JAVA_CLASSPATH=lib/io.strimzi.@project.build.finalName@.@project.packaging@:@project.dist.classpath@\n export JAVA_MAIN=io.strimzi.operator.user.Main\n-exec ${STRIMZI_HOME}/bin/launch_java.sh\n+exec \"${STRIMZI_HOME}\"/bin/launch_java.sh", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13552ac368daba07f2b5cc22d1e78329363f6025"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea2b13f472acfe5c81039da88dcce3fa0e9c5cc5", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ea2b13f472acfe5c81039da88dcce3fa0e9c5cc5", "committedDate": "2020-05-27T20:04:42Z", "message": "Setup shellcheck on Azure + review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5a3a25f2424112939fc45e17004e012782841e0", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e5a3a25f2424112939fc45e17004e012782841e0", "committedDate": "2020-05-27T20:39:59Z", "message": "Fix shellcheck install script\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcc2f3a3450c42ad1b4390c0465ff00dcd1b18de", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/dcc2f3a3450c42ad1b4390c0465ff00dcd1b18de", "committedDate": "2020-05-27T21:24:24Z", "message": "Install newer version of shellcheck\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "917a20fde4cddb839fe8c2ad03ae143f87606b08", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/917a20fde4cddb839fe8c2ad03ae143f87606b08", "committedDate": "2020-05-27T21:40:55Z", "message": "Install xz-utils\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e02cf5529589c52c0619fd7de712fd47e61ea977", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e02cf5529589c52c0619fd7de712fd47e61ea977", "committedDate": "2020-05-27T22:34:30Z", "message": "Remove -z option\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODk3NTI0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3108#pullrequestreview-419897524", "createdAt": "2020-05-28T08:41:08Z", "commit": {"oid": "e02cf5529589c52c0619fd7de712fd47e61ea977"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODo0MTowOFrOGbrXuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODo0MTowOFrOGbrXuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3NTMyMQ==", "bodyText": "I think you can remove the sc disable line if you write:\nset /usr/bin/tini -w -e 143 -- \"java -server ${JAVA_OPTS} ${JMXTRANS_OPTS} ${GC_OPTS} ${EXEC}\"\n\nMight be wrong on this.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3108#discussion_r431675321", "createdAt": "2020-05-28T08:41:08Z", "author": {"login": "samuel-hawker"}, "path": "docker-images/jmxtrans/docker-entrypoint.sh", "diffHunk": "@@ -17,8 +16,10 @@ MONITOR_OPTS=\"-Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.ssl=\n               -Djava.rmi.server.hostname=${PROXY_HOST}\"\n \n if [ \"$1\" = 'start-without-jmx' ]; then\n+    # shellcheck disable=SC2086\n     set /usr/bin/tini -w -e 143 -- java -server $JAVA_OPTS $JMXTRANS_OPTS $GC_OPTS $EXEC", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e02cf5529589c52c0619fd7de712fd47e61ea977"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODk5MTI5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3108#pullrequestreview-419899129", "createdAt": "2020-05-28T08:43:13Z", "commit": {"oid": "e02cf5529589c52c0619fd7de712fd47e61ea977"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODo0MzoxM1rOGbrccw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQwODo0MzoxM1rOGbrccw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTY3NjUzMQ==", "bodyText": "groupregex=\"--group.filter=\\\"${KAFKA_EXPORTER_GROUP_REGEX}\\\"\"\n\nShould mean we can remove the disable", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3108#discussion_r431676531", "createdAt": "2020-05-28T08:43:13Z", "author": {"login": "samuel-hawker"}, "path": "docker-images/kafka/exporter-scripts/kafka_exporter_run.sh", "diffHunk": "@@ -1,15 +1,18 @@\n #!/usr/bin/env bash\n+set -e\n set +x\n \n # We don't need LOG_DIR because we write no log files, but setting it to a\n # directory avoids trying to create it (and logging a permission denied error)\n export LOG_DIR=\"$KAFKA_EXPORTER_HOME\"\n \n if [ -n \"$KAFKA_EXPORTER_GROUP_REGEX\" ]; then\n+    # shellcheck disable=SC2027\n     groupregex=\"--group.filter=\\\"\"${KAFKA_EXPORTER_GROUP_REGEX}\"\\\"\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e02cf5529589c52c0619fd7de712fd47e61ea977"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be60fb055b5bf65badb779cc5d6176ad06585669", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/be60fb055b5bf65badb779cc5d6176ad06585669", "committedDate": "2020-05-29T22:55:16Z", "message": "Fix Mirror Maker and Mirror Maker 2 with OAuth\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTA5NDA0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3108#pullrequestreview-421509404", "createdAt": "2020-05-31T16:32:05Z", "commit": {"oid": "be60fb055b5bf65badb779cc5d6176ad06585669"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNjczNDgx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3108#pullrequestreview-421673481", "createdAt": "2020-06-01T08:24:40Z", "commit": {"oid": "be60fb055b5bf65badb779cc5d6176ad06585669"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1448, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}