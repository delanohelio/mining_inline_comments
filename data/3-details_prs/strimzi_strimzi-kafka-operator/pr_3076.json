{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNzg0NTM1", "number": 3076, "title": "Fix storage size comparsion", "bodyText": "Signed-off-by: Stanislav Knot sknot@redhat.com\nType of change\n\nBugfix\n\nDescription\nFixes #2877\nThe problem is StatefulSetDiff comparing of size.\nStatefulSetDiff:102 - StatefulSet test/foo differs: {\"op\":\"replace\",\"path\":\"/spec/volumeClaimTemplates/0/spec/resources/requests/storage\",\"value\":\"3Ti\"}\nStatefulSetDiff:103 - Current StatefulSet path /spec/volumeClaimTemplates/0/spec/resources/requests/storage has value \"3072Gi\"\nStatefulSetDiff:104 - Desired StatefulSet path /spec/volumeClaimTemplates/0/spec/resources/requests/storage has value \"3Ti\"\n\n3072Gi == 3Ti, but current comparison sees it as difference.\nChecklist\n\n Update/write design documentation in ./design\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md", "createdAt": "2020-05-22T08:20:48Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3076", "merged": true, "mergeCommit": {"oid": "d9a85f95f8cc150590dcdfada730dc7d2fc81c0a"}, "closed": true, "closedAt": "2020-05-27T18:11:01Z", "author": {"login": "sknot-rh"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjt6xKgBqjMzNjM3NjE2MTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclaVlJgFqTQxOTI4NzA3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8d350954716c797d20eaef9c8833cc5939b5ec35", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/8d350954716c797d20eaef9c8833cc5939b5ec35", "committedDate": "2020-05-22T08:19:59Z", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "69bde8565bf54d8313ded3beb099e1fb6f1e41b7", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/69bde8565bf54d8313ded3beb099e1fb6f1e41b7", "committedDate": "2020-05-22T08:23:12Z", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzQ5NjY2", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3076#pullrequestreview-416749666", "createdAt": "2020-05-22T08:48:13Z", "commit": {"oid": "69bde8565bf54d8313ded3beb099e1fb6f1e41b7"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "69bde8565bf54d8313ded3beb099e1fb6f1e41b7", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/69bde8565bf54d8313ded3beb099e1fb6f1e41b7", "committedDate": "2020-05-22T08:23:12Z", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "594e243545f92e53ae1f7cac2754ac571339313b", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/594e243545f92e53ae1f7cac2754ac571339313b", "committedDate": "2020-05-22T09:15:18Z", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "594e243545f92e53ae1f7cac2754ac571339313b", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/594e243545f92e53ae1f7cac2754ac571339313b", "committedDate": "2020-05-22T09:15:18Z", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "befa27b4be116074243fb844bc045672d59df6e6", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/befa27b4be116074243fb844bc045672d59df6e6", "committedDate": "2020-05-22T09:17:30Z", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c80c1973754686281ed9e9e041f67a60d83224f3", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c80c1973754686281ed9e9e041f67a60d83224f3", "committedDate": "2020-05-22T09:19:01Z", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "befa27b4be116074243fb844bc045672d59df6e6", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/befa27b4be116074243fb844bc045672d59df6e6", "committedDate": "2020-05-22T09:17:30Z", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "c80c1973754686281ed9e9e041f67a60d83224f3", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c80c1973754686281ed9e9e041f67a60d83224f3", "committedDate": "2020-05-22T09:19:01Z", "message": "Fix storage size comparsion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2OTU2ODc0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3076#pullrequestreview-416956874", "createdAt": "2020-05-22T14:30:28Z", "commit": {"oid": "c80c1973754686281ed9e9e041f67a60d83224f3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNDozMDoyOFrOGZZROg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQxNDozMDoyOFrOGZZROg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI4MTU5NA==", "bodyText": "I think you should try to optimize the code a bit. You should probably first check the path whether it matches the VOLUME_SIZE path. Only then you should do the lookups.\nIf you keep using separate method for it, it migth also make more sense to have a method isVolumeSizeChanged instead of using ``isvolumeSizeEqual`. It will make the code more readable.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3076#discussion_r429281594", "createdAt": "2020-05-22T14:30:28Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/resource/StatefulSetDiff.java", "diffHunk": "@@ -107,7 +108,7 @@ public StatefulSetDiff(StatefulSet current, StatefulSet desired) {\n             // Any volume claim template changes apart from size change should trigger rolling update\n             // Size changes should not trigger rolling update. Therefore we need to separate these two in the diff.\n             changesVolumeClaimTemplate |= equalsOrPrefix(\"/spec/volumeClaimTemplates\", pathValue) && !VOLUME_SIZE.matcher(pathValue).matches();\n-            changesVolumeSize |= VOLUME_SIZE.matcher(pathValue).matches();\n+            changesVolumeSize |= !isVolumeSizeEqual(pathValue, lookupPath(source, pathValue), lookupPath(target, pathValue));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c80c1973754686281ed9e9e041f67a60d83224f3"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d81075959f6b7a7b36f75ddda2b27057f9f8e4b", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9d81075959f6b7a7b36f75ddda2b27057f9f8e4b", "committedDate": "2020-05-25T06:05:41Z", "message": "optimize\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NTA3MjY4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3076#pullrequestreview-417507268", "createdAt": "2020-05-25T07:23:39Z", "commit": {"oid": "9d81075959f6b7a7b36f75ddda2b27057f9f8e4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5Mjg3MDc1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3076#pullrequestreview-419287075", "createdAt": "2020-05-27T14:42:23Z", "commit": {"oid": "9d81075959f6b7a7b36f75ddda2b27057f9f8e4b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1781, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}