{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3MzA3MzAz", "number": 3007, "title": "[systemtest][kafkatopic] Decrease topic partitions and min.insync.replicas tests", "bodyText": "Signed-off-by: Lukas Kral lukywill16@gmail.com\nType of change\n\nNew tests\n\nDescription\nOur new tests will check functionality of our new features:\n\n\n\nearlier when we wanted to decrease KafkaTopic partitions, CR status was saying, that topic is Ready but in TO there was error that KafkaTopic cannot be reconcile because of exception: Number of partitions cannot be decreased\nNow in status of KafkaTopic is proper error and reason with message.\n\n\n\n\nsecond feature is also about KafkaTopic status - when we changed min.insync.replicas to some random character (like x) we get proper error, but after a while the status changed to Ready even if the min.insync.replicas was still set to x.\n\n\n\nChecklist:\nDecrease topic partitions test:\n\ncreate topic with x partitions\ndecrease it to 1 partition\nassert KafkaTopic status\n\nMin.insync.replicas test:\n\ncreate topic\nchange min.insync.replicas to x\nassert KafkaTopic status\nwait some time\nassert KafkaTopic status again\n\n\n\n\nfix one failing test ->  problem here was in observedGeneration - in original test we had gen 2 - cause of this was that Kafka sync message.format.version on topic creation. But after #2930 is behaviour of KafkaTopic changed\n\n\nother problem was in deletion of KafkaMirrorMaker2 without wait -> I added cascading deletion to CR resource - now should be deleted correctly\n\n\nChecklist\n\n Write tests\n Make sure all tests pass", "createdAt": "2020-05-13T11:44:49Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007", "merged": true, "mergeCommit": {"oid": "4625c4133e75d6086795867b52bf631ee5ff6e25"}, "closed": true, "closedAt": "2020-05-15T09:30:53Z", "author": {"login": "im-konge"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg5Vs0gFqTQxMDk1MjY0Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABchbn4jgFqTQxMjM2NjAwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwOTUyNjQy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#pullrequestreview-410952642", "createdAt": "2020-05-13T13:58:35Z", "commit": {"oid": "b07d1abe6e2cdc244471769db3d2e97e663c134e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzo1ODozNVrOGUy9uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMzo1OTo1M1rOGUzBkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ1OTcwNw==", "bodyText": "The original issue wasn't just that the status was wrong, but also that it flipped back to Ready on the next reconciliation. So if this is intended as a regression test we should probably wait for a reconciliation interval and make the same assertion again.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r424459707", "createdAt": "2020-05-13T13:58:35Z", "author": {"login": "tombentley"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -366,6 +366,34 @@ void testKafkaMirrorMaker2WrongBootstrap() {\n         KafkaMirrorMaker2Resource.deleteKafkaMirrorMaker2WithoutWait(kafkaMirrorMaker2);\n     }\n \n+    @Test\n+    void testKafkaTopicDecreaseStatus() {\n+        KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 5).done();\n+        int decreaseTo = 1;\n+\n+        LOGGER.info(\"Decreasing number of partitions to {}\", decreaseTo);\n+        KafkaTopicResource.replaceTopicResource(TEST_TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().setPartitions(decreaseTo));\n+        KafkaTopicUtils.waitForKafkaTopicPartitionChange(TEST_TOPIC_NAME, decreaseTo);\n+\n+        assertKafkaTopicDecreasePartitionsStatus(TEST_TOPIC_NAME);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b07d1abe6e2cdc244471769db3d2e97e663c134e"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ2MDY5MA==", "bodyText": "It's the reconciliation interval you need to wait for. Hard coding 60s is fragile. You could obtaint the interval by reading it from the env var of the TO container in the EO pod. That way the test would not break even if the interval later got changed.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r424460690", "createdAt": "2020-05-13T13:59:53Z", "author": {"login": "tombentley"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -366,6 +366,34 @@ void testKafkaMirrorMaker2WrongBootstrap() {\n         KafkaMirrorMaker2Resource.deleteKafkaMirrorMaker2WithoutWait(kafkaMirrorMaker2);\n     }\n \n+    @Test\n+    void testKafkaTopicDecreaseStatus() {\n+        KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 5).done();\n+        int decreaseTo = 1;\n+\n+        LOGGER.info(\"Decreasing number of partitions to {}\", decreaseTo);\n+        KafkaTopicResource.replaceTopicResource(TEST_TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().setPartitions(decreaseTo));\n+        KafkaTopicUtils.waitForKafkaTopicPartitionChange(TEST_TOPIC_NAME, decreaseTo);\n+\n+        assertKafkaTopicDecreasePartitionsStatus(TEST_TOPIC_NAME);\n+    }\n+\n+    @Test\n+    void testKafkaTopicChangingInSyncReplicasStatus() throws InterruptedException {\n+        KafkaTopicResource.topic(CLUSTER_NAME, TEST_TOPIC_NAME, 5).done();\n+        String invalidValue = \"x\";\n+\n+        LOGGER.info(\"Changing min.insync.replicas to random char\");\n+        KafkaTopicResource.replaceTopicResource(TEST_TOPIC_NAME, kafkaTopic -> kafkaTopic.getSpec().getConfig().replace(\"min.insync.replicas\", invalidValue));\n+        KafkaTopicUtils.waitForKafkaTopicNotReady(TEST_TOPIC_NAME);\n+\n+        assertKafkaTopicWrongMinInSyncReplicasStatus(TEST_TOPIC_NAME, invalidValue);\n+\n+        // Wait some time to check if error is still present in KafkaTopic status\n+        Thread.sleep(60_000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b07d1abe6e2cdc244471769db3d2e97e663c134e"}, "originalPosition": 28}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5277f5bff4ef73929d8153a0ee03719e38a414fe", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/5277f5bff4ef73929d8153a0ee03719e38a414fe", "committedDate": "2020-05-13T16:45:03Z", "message": "fixup! fix failing test and add one more wait to prevent race condition\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "32c8e7a96fca9822061c46500a9e5e82c8265b8c", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/32c8e7a96fca9822061c46500a9e5e82c8265b8c", "committedDate": "2020-05-13T16:55:55Z", "message": "fixup! fix failing test and add one more wait to prevent race condition\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "510367401b66a780bf504a739fe2f4f45e9b1bdc", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/510367401b66a780bf504a739fe2f4f45e9b1bdc", "committedDate": "2020-05-14T11:36:26Z", "message": "add test for decrease topic partitions\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e46bda06a73a615f1bfab0cb199b28941699ecbd", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e46bda06a73a615f1bfab0cb199b28941699ecbd", "committedDate": "2020-05-14T11:36:26Z", "message": "add test for changin min.insync.replicas\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12a06a81bed189e837f6378284f19196f6200271", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/12a06a81bed189e837f6378284f19196f6200271", "committedDate": "2020-05-14T11:36:27Z", "message": "add methods for assertion and add sleep\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "658cbecf681f472a47487200c879afae8bfa753e", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/658cbecf681f472a47487200c879afae8bfa753e", "committedDate": "2020-05-14T11:36:27Z", "message": "fixup! add methods for assertion and add sleep\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18576f81c127056a37882c60f0d4cdd244bb954b", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/18576f81c127056a37882c60f0d4cdd244bb954b", "committedDate": "2020-05-14T11:36:27Z", "message": "fix failing test and add one more wait to prevent race condition\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24a18c101bdbd54871da4fe25edb89bcd0676db9", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/24a18c101bdbd54871da4fe25edb89bcd0676db9", "committedDate": "2020-05-14T11:36:27Z", "message": "fixup! fix failing test and add one more wait to prevent race condition\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d8b5550a003dc405147f3ba7ec5775b3cf8651d", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1d8b5550a003dc405147f3ba7ec5775b3cf8651d", "committedDate": "2020-05-14T13:31:25Z", "message": "fix deletion of CR\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "32c8e7a96fca9822061c46500a9e5e82c8265b8c", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/32c8e7a96fca9822061c46500a9e5e82c8265b8c", "committedDate": "2020-05-13T16:55:55Z", "message": "fixup! fix failing test and add one more wait to prevent race condition\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}, "afterCommit": {"oid": "1d8b5550a003dc405147f3ba7ec5775b3cf8651d", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1d8b5550a003dc405147f3ba7ec5775b3cf8651d", "committedDate": "2020-05-14T13:31:25Z", "message": "fix deletion of CR\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExODE1MDMx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#pullrequestreview-411815031", "createdAt": "2020-05-14T13:41:13Z", "commit": {"oid": "1d8b5550a003dc405147f3ba7ec5775b3cf8651d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExODE4MTQ5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#pullrequestreview-411818149", "createdAt": "2020-05-14T13:44:27Z", "commit": {"oid": "1d8b5550a003dc405147f3ba7ec5775b3cf8651d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExODI3ODMy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#pullrequestreview-411827832", "createdAt": "2020-05-14T13:54:10Z", "commit": {"oid": "1d8b5550a003dc405147f3ba7ec5775b3cf8651d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMzo1NDoxMFrOGVdZ6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxMzo1NDoxMFrOGVdZ6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTE1NTA0OA==", "bodyText": "I think this timeout should be longer than reconicliation interval...and Maybe I will extend at least double times", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#discussion_r425155048", "createdAt": "2020-05-14T13:54:10Z", "author": {"login": "Frawless"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/CustomResourceStatusST.java", "diffHunk": "@@ -404,6 +439,9 @@ void deployTestSpecificResources() {\n \n         KafkaTopicResource.topic(CLUSTER_NAME, TOPIC_NAME).done();\n         KafkaClientsResource.deployKafkaClients(false, KAFKA_CLIENTS_NAME).done();\n+\n+        topicOperatorReconciliationInterval = KafkaResource.kafkaClient().inNamespace(NAMESPACE).withName(CLUSTER_NAME).get()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d8b5550a003dc405147f3ba7ec5775b3cf8651d"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bebc9c87f6b62db82ae932ecbe011a6a21e06556", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/bebc9c87f6b62db82ae932ecbe011a6a21e06556", "committedDate": "2020-05-14T15:18:54Z", "message": "comments vol.2\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExOTM0NjU2", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#pullrequestreview-411934656", "createdAt": "2020-05-14T15:41:25Z", "commit": {"oid": "bebc9c87f6b62db82ae932ecbe011a6a21e06556"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMzY2MDA4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3007#pullrequestreview-412366008", "createdAt": "2020-05-15T05:56:35Z", "commit": {"oid": "bebc9c87f6b62db82ae932ecbe011a6a21e06556"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1700, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}