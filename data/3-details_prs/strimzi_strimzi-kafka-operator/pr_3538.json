{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMzE2ODk5", "number": 3538, "title": "ST: change keycloak deployment in system tests", "bodyText": "Type of change\n\nEnhancement / new feature\nRefactoring\n\nDescription\nAs part of removing external listeners for OAuth tests, we decided to rewrite procedure that deploys keycloak for testing. After some investigation, we decided to use KeycloakOperator. However, operator does not support authorization config yes so we still use scripts for import realms used in tests.\nDeployment is now done via script, which copies realm scripts and executes them in keycloak pod to avoid usage of NodePort services. This script can be used for manual tests as well.\nMain changes:\nUse Keycloak operator and Keycloak version 11.0.0\nMove Keycloak deployment from code to script which is used in tests\nNext steps:\n#3533\nChecklist\n\n Make sure all tests pass", "createdAt": "2020-08-24T07:14:42Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538", "merged": true, "mergeCommit": {"oid": "14a3682e7c6d269b71c962b0dd869557365b2b02"}, "closed": true, "closedAt": "2020-08-26T20:09:49Z", "author": {"login": "Frawless"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdB9ck_gFqTQ3MzE3NjI3MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCw5i_gFqTQ3NTc5MTMzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMTc2Mjcw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#pullrequestreview-473176270", "createdAt": "2020-08-24T07:19:27Z", "commit": {"oid": "ff8b5cb566b864b6996f2542d571f7569b710d1a"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNzoxOToyN1rOHFXduQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNzoyNTo1NlrOHFXpyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM4OTM2OQ==", "bodyText": "This can be removed :)", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#discussion_r475389369", "createdAt": "2020-08-24T07:19:27Z", "author": {"login": "see-quick"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/kafkaclients/KafkaClientProperties.java", "diffHunk": "@@ -204,7 +198,7 @@ public KafkaClientPropertiesBuilder withSaslJassConfigAndTls(String clientId, St\n \n             try {\n                 importKeycloakCertificateToTruststore(properties);\n-                fixBadlyImportedAuthzSettings();\n+//                fixBadlyImportedAuthzSettings();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff8b5cb566b864b6996f2542d571f7569b710d1a"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM5MDI2Mw==", "bodyText": "Do we still need this?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#discussion_r475390263", "createdAt": "2020-08-24T07:21:21Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/security/oauth/OauthAbstractST.java", "diffHunk": "@@ -71,73 +70,62 @@ void setup() throws Exception {\n \n         LOGGER.info(\"Deploying keycloak...\");\n \n-        KeycloakUtils.deployKeycloak().done();\n+        KeycloakUtils.deployKeycloak(NAMESPACE);\n \n         // https\n-        Service keycloakService = KubernetesResource.deployKeycloakNodePortService(NAMESPACE);\n+        Service keycloakService = KubernetesResource.createKeycloakNodePortService(NAMESPACE);\n         KubernetesResource.createServiceResource(keycloakService, NAMESPACE);\n         ServiceUtils.waitForNodePortService(keycloakService.getMetadata().getName());\n \n         // http\n-        Service keycloakHttpService = KubernetesResource.deployKeycloakNodePortHttpService(NAMESPACE);\n+        Service keycloakHttpService = KubernetesResource.createKeycloakNodePortHttpService(NAMESPACE);\n         KubernetesResource.createServiceResource(keycloakHttpService, NAMESPACE);\n         ServiceUtils.waitForNodePortService(keycloakHttpService.getMetadata().getName());\n \n-        keycloakInstance = new KeycloakInstance(\"admin\", \"admin\");\n-        clusterHost = kubeClient().getNodeAddress();\n-\n-        LOGGER.info(\"Importing basic realm\");\n-        keycloakInstance.importRealm(\"../systemtest/src/test/resources/oauth2/create_realm.sh\");\n-\n-        LOGGER.info(\"Importing authorization realm\");\n-\n-        keycloakInstance.importRealm(\"../systemtest/src/test/resources/oauth2/create_realm_authorization.sh\");\n+        String passwordEncoded = kubeClient().getSecret(\"credential-example-keycloak\").getData().get(\"ADMIN_PASSWORD\");\n+        String password = new String(Base64.getDecoder().decode(passwordEncoded.getBytes()));\n+        keycloakInstance = new KeycloakInstance(\"admin\", password);\n \n-        String keycloakPodName = kubeClient().listPodsByPrefixInName(\"keycloak-\").get(0).getMetadata().getName();\n-\n-        String pubKey = ResourceManager.cmdKubeClient().execInPod(keycloakPodName, \"keytool\", \"-exportcert\", \"-keystore\",\n-            \"/opt/jboss/keycloak/standalone/configuration/application.keystore\", \"-alias\", \"server\", \"-storepass\", \"password\", \"-rfc\").out();\n-\n-        SecretUtils.createSecret(SECRET_OF_KEYCLOAK, CERTIFICATE_OF_KEYCLOAK, new String(Base64.getEncoder().encode(pubKey.getBytes()), StandardCharsets.US_ASCII));\n+        clusterHost = kubeClient().getNodeAddress();\n \n         KafkaResource.kafkaEphemeral(CLUSTER_NAME, 3, 1)\n-                .editSpec()\n-                    .editKafka()\n-                        .editListeners()\n-                            .withNewTls()\n-                                .withNewKafkaListenerAuthenticationOAuth()\n-                                    .withValidIssuerUri(keycloakInstance.getValidIssuerUri())\n-                                    .withJwksExpirySeconds(keycloakInstance.getJwksExpireSeconds())\n-                                    .withJwksRefreshSeconds(keycloakInstance.getJwksRefreshSeconds())\n-                                    .withJwksEndpointUri(keycloakInstance.getJwksEndpointUri())\n-                                    .withUserNameClaim(keycloakInstance.getUserNameClaim())\n-                                    .withTlsTrustedCertificates(\n-                                        new CertSecretSourceBuilder()\n-                                            .withSecretName(SECRET_OF_KEYCLOAK)\n-                                            .withCertificate(CERTIFICATE_OF_KEYCLOAK)\n-                                            .build())\n-                                    .withDisableTlsHostnameVerification(true)\n-                                .endKafkaListenerAuthenticationOAuth()\n-                            .endTls()\n-                            .withNewKafkaListenerExternalNodePort()\n-                                .withNewKafkaListenerAuthenticationOAuth()\n-                                    .withValidIssuerUri(keycloakInstance.getValidIssuerUri())\n-                                    .withJwksExpirySeconds(keycloakInstance.getJwksExpireSeconds())\n-                                    .withJwksRefreshSeconds(keycloakInstance.getJwksRefreshSeconds())\n-                                    .withJwksEndpointUri(keycloakInstance.getJwksEndpointUri())\n-                                    .withUserNameClaim(keycloakInstance.getUserNameClaim())\n-                                    .withTlsTrustedCertificates(\n-                                        new CertSecretSourceBuilder()\n-                                            .withSecretName(SECRET_OF_KEYCLOAK)\n-                                            .withCertificate(CERTIFICATE_OF_KEYCLOAK)\n-                                            .build())\n-                                    .withDisableTlsHostnameVerification(true)\n-                                .endKafkaListenerAuthenticationOAuth()\n-                            .endKafkaListenerExternalNodePort()\n-                        .endListeners()\n-                    .endKafka()\n-                .endSpec()\n-                .done();\n+            .editSpec()\n+                .editKafka()\n+                    .editListeners()\n+                        .withNewTls()\n+                            .withNewKafkaListenerAuthenticationOAuth()\n+                                .withValidIssuerUri(keycloakInstance.getValidIssuerUri())\n+                                .withJwksExpirySeconds(keycloakInstance.getJwksExpireSeconds())\n+                                .withJwksRefreshSeconds(keycloakInstance.getJwksRefreshSeconds())\n+                                .withJwksEndpointUri(keycloakInstance.getJwksEndpointUri())\n+                                .withUserNameClaim(keycloakInstance.getUserNameClaim())\n+                                .withTlsTrustedCertificates(\n+                                    new CertSecretSourceBuilder()\n+                                        .withSecretName(SECRET_OF_KEYCLOAK)\n+                                        .withCertificate(CERTIFICATE_OF_KEYCLOAK)\n+                                        .build())\n+                                .withDisableTlsHostnameVerification(true)\n+                            .endKafkaListenerAuthenticationOAuth()\n+                        .endTls()\n+                        .withNewKafkaListenerExternalNodePort()\n+                            .withNewKafkaListenerAuthenticationOAuth()\n+                                .withValidIssuerUri(keycloakInstance.getValidIssuerUri())\n+                                .withJwksExpirySeconds(keycloakInstance.getJwksExpireSeconds())\n+                                .withJwksRefreshSeconds(keycloakInstance.getJwksRefreshSeconds())\n+                                .withJwksEndpointUri(keycloakInstance.getJwksEndpointUri())\n+                                .withUserNameClaim(keycloakInstance.getUserNameClaim())\n+                                .withTlsTrustedCertificates(\n+                                    new CertSecretSourceBuilder()\n+                                        .withSecretName(SECRET_OF_KEYCLOAK)\n+                                        .withCertificate(CERTIFICATE_OF_KEYCLOAK)\n+                                        .build())\n+                                .withDisableTlsHostnameVerification(true)\n+                            .endKafkaListenerAuthenticationOAuth()\n+                        .endKafkaListenerExternalNodePort()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff8b5cb566b864b6996f2542d571f7569b710d1a"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM5MjE2NA==", "bodyText": "What about this one?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#discussion_r475392164", "createdAt": "2020-08-24T07:25:16Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/resources/oauth2/realm.yaml", "diffHunk": "@@ -0,0 +1,251 @@\n+apiVersion: keycloak.org/v1alpha1\n+kind: KeycloakRealm\n+metadata:\n+  name: oauth2-kafka\n+  labels:\n+    app: sso\n+spec:\n+  realm:\n+    id: \"internal\"\n+    realm: \"internal\"\n+    enabled: True\n+    displayName: \"Internal realm with users\"\n+    users:\n+      - username: \"alice\"\n+        firstName: \"Alice\"\n+        lastName: \"Doe\"\n+        email: \"alice@example.com\"\n+        enabled: True\n+        emailVerified: False\n+        credentials:\n+          - type: password\n+            value: \"alice-password\"\n+        realmRoles:\n+          - \"user\"\n+        clientRoles:\n+          kafka:\n+            - \"kafka-topic:superapp_*:owner\"\n+            - \"kafka-topic:superapp_*:consumer\"\n+      - username: \"admin\"\n+        firstName: \"Admin\"\n+        lastName: \"Doe\"\n+        email: \"admin@example.com\"\n+        enabled: True\n+        emailVerified: False\n+        credentials:\n+          - type: password\n+            value: \"admin-password\"\n+        realmRoles:\n+          - \"admin\"\n+        clientRoles:\n+          kafka:\n+            - \"kafka-admin\"\n+          realm-management:\n+            - \"realm-admin\"\n+\n+      # useless?\n+#      - username: \"service-account-kafka-broker\"\n+#        email: \"service-account-kafka-broker@placeholder.org\"\n+#        enabled: True\n+#        emailVerified: False\n+#        clientRoles:\n+#          kafka:\n+#            - \"kafka-admin\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff8b5cb566b864b6996f2542d571f7569b710d1a"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM5MjQ1OA==", "bodyText": "I wonder if we need to the parametrized version of the keycloak for the future.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#discussion_r475392458", "createdAt": "2020-08-24T07:25:56Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/resources/oauth2/teardown_keycloak_operator.sh", "diffHunk": "@@ -0,0 +1,23 @@\n+#!/usr/bin/env bash\n+\n+NAMESPACE=$1\n+\n+KEYCLOAK_VERSION=11.0.0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff8b5cb566b864b6996f2542d571f7569b710d1a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjAxNjU2", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#pullrequestreview-473201656", "createdAt": "2020-08-24T07:58:52Z", "commit": {"oid": "10d33447f9eef457c77551057a062b700f09f822"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzgyMTAx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#pullrequestreview-473382101", "createdAt": "2020-08-24T11:34:35Z", "commit": {"oid": "eece305ed44a09ed8bd8b2338c1a66c85aca195f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzgzMDI0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#pullrequestreview-473383024", "createdAt": "2020-08-24T11:36:02Z", "commit": {"oid": "eece305ed44a09ed8bd8b2338c1a66c85aca195f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTozNjowM1rOHFgfuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTozNjowM1rOHFgfuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUzNzMzNw==", "bodyText": "Here you can remove this commend or?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#discussion_r475537337", "createdAt": "2020-08-24T11:36:03Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/security/oauth/OauthAuthorizationST.java", "diffHunk": "@@ -136,7 +136,7 @@ void testTeamBWriteToTopic() {\n         );\n     }\n \n-    @Disabled(\"Will be fixed in the new PR.\")\n+//    @Disabled(\"Will be fixed in the new PR.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eece305ed44a09ed8bd8b2338c1a66c85aca195f"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "253f076443d2dc79bae96130f0c79e9365f6b833", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/253f076443d2dc79bae96130f0c79e9365f6b833", "committedDate": "2020-08-26T10:49:16Z", "message": "Deploy keycloak via script\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eab9952d3296efc45871a3aed8d03353a63ce2fa", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/eab9952d3296efc45871a3aed8d03353a63ce2fa", "committedDate": "2020-08-26T10:50:17Z", "message": "Make deployment working, increace version of keycloak to 11.0.0, use operator for deployment\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "707194e22871943693271cb9555e1681017a1ab6", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/707194e22871943693271cb9555e1681017a1ab6", "committedDate": "2020-08-26T10:50:23Z", "message": "Remove leftovers\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "acae7ecbd83defbacc600799723f019b6d3c60e8", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/acae7ecbd83defbacc600799723f019b6d3c60e8", "committedDate": "2020-08-26T10:50:23Z", "message": "fix st on jenkins\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2678008a232539f4bc556b2217e90b2dc18a193a", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/2678008a232539f4bc556b2217e90b2dc18a193a", "committedDate": "2020-08-26T10:50:23Z", "message": "fixup! fix st on jenkins\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce520220e6c034dac659ebad4c3424b20611d9c7", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ce520220e6c034dac659ebad4c3424b20611d9c7", "committedDate": "2020-08-26T10:50:24Z", "message": "fixup! fixup! fix st on jenkins\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90e050c73f679a19a79dcb3e29d6c6014fab21e1", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/90e050c73f679a19a79dcb3e29d6c6014fab21e1", "committedDate": "2020-08-26T10:50:24Z", "message": "some fixes\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b97d980aa1d92046a22c031717879656f8dc9102", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b97d980aa1d92046a22c031717879656f8dc9102", "committedDate": "2020-08-26T10:50:24Z", "message": "Azp debug\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db21af25f05956f4d333d261c6e358cdbf36aba5", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/db21af25f05956f4d333d261c6e358cdbf36aba5", "committedDate": "2020-08-26T10:50:24Z", "message": "another fixes\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d452fe94f20086047b4f1ead4f29e4ce78c04fe", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6d452fe94f20086047b4f1ead4f29e4ce78c04fe", "committedDate": "2020-08-26T10:50:24Z", "message": "fixup! another fixes\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a111f6d0d70865e49301add66346a617201fd0e8", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a111f6d0d70865e49301add66346a617201fd0e8", "committedDate": "2020-08-26T10:55:59Z", "message": "fixup! fixup! another fixes\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "520492cc2d86d9c10217ee0e398c9142793162d5", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/520492cc2d86d9c10217ee0e398c9142793162d5", "committedDate": "2020-08-26T10:47:27Z", "message": "fixup! another fixes\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}, "afterCommit": {"oid": "a111f6d0d70865e49301add66346a617201fd0e8", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a111f6d0d70865e49301add66346a617201fd0e8", "committedDate": "2020-08-26T10:55:59Z", "message": "fixup! fixup! another fixes\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1d96fe37a3e8df0e33999c681039a69906d4807", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/f1d96fe37a3e8df0e33999c681039a69906d4807", "committedDate": "2020-08-26T12:34:49Z", "message": "Rever pipeline changes\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "151210b1ca0911ec41678d8e2ef27e842ce83c60", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/151210b1ca0911ec41678d8e2ef27e842ce83c60", "committedDate": "2020-08-26T13:50:41Z", "message": "fixup! Rever pipeline changes\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80d9bdcb0ac8681252904a8772585443d2a0ee4c", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/80d9bdcb0ac8681252904a8772585443d2a0ee4c", "committedDate": "2020-08-26T13:53:00Z", "message": "fixup! fixup! Rever pipeline changes\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NTE2OTM2", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#pullrequestreview-475516936", "createdAt": "2020-08-26T13:58:11Z", "commit": {"oid": "80d9bdcb0ac8681252904a8772585443d2a0ee4c"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxMzo1ODoxMVrOHHNcsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNDowMjo0N1rOHHNqjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyMjQxNg==", "bodyText": "Remove it? :)", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#discussion_r477322416", "createdAt": "2020-08-26T13:58:11Z", "author": {"login": "see-quick"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/keycloak/KeycloakInstance.java", "diffHunk": "@@ -37,40 +35,22 @@\n     private Pattern keystorePattern = Pattern.compile(\"<tls>\\\\s*<key-stores>\\\\s*<key-store name=\\\"kcKeyStore\\\">\\\\s*<credential-reference clear-text=\\\".*\\\"\\\\/>\");\n     private Pattern keystorePasswordPattern = Pattern.compile(\"\\\\\\\".*\\\\\\\"\");\n \n-    public KeycloakInstance(String username, String password) {\n+    public KeycloakInstance(String username, String password, String namespace) {\n \n         this.username = username;\n         this.password = password;\n+        this.namespace = namespace;\n         this.httpsUri = ResourceManager.kubeClient().getNodeAddress() + \":\" + Constants.HTTPS_KEYCLOAK_DEFAULT_NODE_PORT;\n         this.httpUri = ResourceManager.kubeClient().getNodeAddress() + \":\" + Constants.HTTP_KEYCLOAK_DEFAULT_NODE_PORT;\n+        // this.httpsUri = \"keycloak.\" + namespace + \".svc.cluster.local\" +\":8443\";\n+        // this.httpUri = \"keycloak-discovery.\" + namespace + \".svc.cluster.local\" +\":8080\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80d9bdcb0ac8681252904a8772585443d2a0ee4c"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyMzc3NA==", "bodyText": "Why did you do this change? )", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#discussion_r477323774", "createdAt": "2020-08-26T13:59:52Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/resources/oauth2/create_realm_authorization.sh", "diffHunk": "@@ -8,14 +8,14 @@ URL=$3\n \n TOKEN=$(curl --insecure -X POST -d \"client_id=admin-cli&client_secret=aGVsbG8td29ybGQtcHJvZHVjZXItc2VjcmV0&grant_type=password&username=$USERNAME&password=$PASSWORD\" \"https://$URL/auth/realms/master/protocol/openid-connect/token\" | awk -F '\\\"' '{print $4}')\n \n-curl -v --insecure \"https://$URL/auth/admin/realms\" \\\n+RESULT=$(curl -v --insecure \"https://$URL/auth/admin/realms\" \\\n   -H \"Authorization: Bearer $TOKEN\" \\\n   -H 'Content-Type: application/json' \\\n   -H 'Postman-Token: 3a6cd746-03b5-46fe-a54a-014fc7c51983' \\\n   -H 'cache-control: no-cache' \\\n   -d '{\n   \"realm\": \"kafka-authz\",\n-  \"accessTokenLifespan\": 300,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80d9bdcb0ac8681252904a8772585443d2a0ee4c"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMyNTk2NQ==", "bodyText": "oauth2-cluster-test -> namespace?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#discussion_r477325965", "createdAt": "2020-08-26T14:02:47Z", "author": {"login": "see-quick"}, "path": "systemtest/src/test/resources/oauth2/teardown_keycloak_operator.sh", "diffHunk": "@@ -0,0 +1,24 @@\n+#!/usr/bin/env bash\n+\n+NAMESPACE=$1\n+\n+KEYCLOAK_VERSION=11.0.0\n+\n+SCRIPT_PATH=$(dirname \"${BASH_SOURCE[0]}\")\n+\n+echo \"[INFO] $(date -u +\"%Y-%m-%d %H:%M:%S\") Delete Keycloak & Keycloak Operator\"\n+kubectl delete -n ${NAMESPACE} -f https://github.com/keycloak/keycloak-operator/raw/${KEYCLOAK_VERSION}/deploy/examples/keycloak/keycloak.yaml\n+kubectl delete -n ${NAMESPACE} -f https://github.com/keycloak/keycloak-operator/raw/${KEYCLOAK_VERSION}/deploy/operator.yaml\n+kubectl delete -f https://github.com/keycloak/keycloak-operator/raw/${KEYCLOAK_VERSION}/deploy/crds/keycloak.org_keycloakusers_crd.yaml\n+kubectl delete -f https://github.com/keycloak/keycloak-operator/raw/${KEYCLOAK_VERSION}/deploy/crds/keycloak.org_keycloaks_crd.yaml\n+kubectl delete -f https://github.com/keycloak/keycloak-operator/raw/${KEYCLOAK_VERSION}/deploy/crds/keycloak.org_keycloakclients_crd.yaml\n+kubectl delete -f https://github.com/keycloak/keycloak-operator/raw/${KEYCLOAK_VERSION}/deploy/crds/keycloak.org_keycloakrealms_crd.yaml\n+kubectl delete -f https://github.com/keycloak/keycloak-operator/raw/${KEYCLOAK_VERSION}/deploy/crds/keycloak.org_keycloakbackups_crd.yaml\n+kubectl delete -f https://github.com/keycloak/keycloak-operator/raw/${KEYCLOAK_VERSION}/deploy/cluster_roles/cluster_role.yaml\n+kubectl delete -f https://raw.githubusercontent.com/keycloak/keycloak-operator/${KEYCLOAK_VERSION}/deploy/cluster_roles/cluster_role_binding.yaml\n+kubectl delete -n ${NAMESPACE} -f https://github.com/keycloak/keycloak-operator/raw/${KEYCLOAK_VERSION}/deploy/role.yaml\n+kubectl delete -n ${NAMESPACE} -f https://github.com/keycloak/keycloak-operator/raw/${KEYCLOAK_VERSION}/deploy/role_binding.yaml\n+kubectl delete -n ${NAMESPACE} -f https://github.com/keycloak/keycloak-operator/raw/${KEYCLOAK_VERSION}/deploy/service_account.yaml\n+\n+\n+#keycloak.oauth2-cluster-test.svc.cluster.local:8443", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80d9bdcb0ac8681252904a8772585443d2a0ee4c"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0b07399e6692956dc8c4ceb05c0babc1185f1bb", "author": {"user": {"login": "Frawless", "name": "Jakub Stejskal"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a0b07399e6692956dc8c4ceb05c0babc1185f1bb", "committedDate": "2020-08-26T16:45:47Z", "message": "Comments\n\nSigned-off-by: Jakub Stejskal <xstejs24@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NzkxMzMz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3538#pullrequestreview-475791333", "createdAt": "2020-08-26T19:23:23Z", "commit": {"oid": "a0b07399e6692956dc8c4ceb05c0babc1185f1bb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1194, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}