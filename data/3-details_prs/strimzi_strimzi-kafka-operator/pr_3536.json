{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMDE4NzQ4", "number": 3536, "title": "Use client.rack property in kafka connect", "bodyText": "Signed-off-by: klalafaryan lalafaryan@gmail.com\nType of change\n\nEnhancement / new feature\n\nDescription\nThis PR adds new property client.rack for kafka connect cluster, which allows to use fetch from closest replica feature.\nIt is covering #3426 ticket.\nChecklist\n\n Write tests\n Make sure all tests pass\n Update documentation\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md", "createdAt": "2020-08-22T18:14:18Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3536", "merged": true, "mergeCommit": {"oid": "b0c04b4ff41d688d716ec5454082a95e873d551b"}, "closed": true, "closedAt": "2020-09-01T00:40:30Z", "author": {"login": "klalafaryan"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBeXr7gFqTQ3Mjk0NDQzOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEcbiQgFqTQ3OTE5NzIxMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTQ0NDM4", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3536#pullrequestreview-472944438", "createdAt": "2020-08-22T18:45:14Z", "commit": {"oid": "a9f530164f6af66e985dca7eb802fd30a63d2c37"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxODo0NToxNFrOHFG9og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxOTowMzo0N1rOHFHD7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExOTAxMA==", "bodyText": "I think the comment is a bit misleading. Maybe it should say something like Configuration of the node label which will be used as the client.rack consumer configuration.?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3536#discussion_r475119010", "createdAt": "2020-08-22T18:45:14Z", "author": {"login": "scholzj"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/KafkaConnectSpec.java", "diffHunk": "@@ -50,6 +54,26 @@ public void setConfig(Map<String, Object> config) {\n         this.config = config;\n     }\n \n+    @Description(\"The image of the init container used for initializing the `client.rack`.\")\n+    @JsonInclude(value = JsonInclude.Include.NON_NULL)\n+    public String getClientRackInitImage() {\n+        return clientRackInitImage;\n+    }\n+\n+    public void setClientRackInitImage(String brokerRackInitImage) {\n+        this.clientRackInitImage = brokerRackInitImage;\n+    }\n+\n+    @Description(\"Configuration of the `client.rack` consumer config.\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9f530164f6af66e985dca7eb802fd30a63d2c37"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExOTA5Mg==", "bodyText": "I think this is not needed if it is the same name as the name in the method.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3536#discussion_r475119092", "createdAt": "2020-08-22T18:46:19Z", "author": {"login": "scholzj"}, "path": "api/src/main/java/io/strimzi/api/kafka/model/KafkaConnectSpec.java", "diffHunk": "@@ -50,6 +54,26 @@ public void setConfig(Map<String, Object> config) {\n         this.config = config;\n     }\n \n+    @Description(\"The image of the init container used for initializing the `client.rack`.\")\n+    @JsonInclude(value = JsonInclude.Include.NON_NULL)\n+    public String getClientRackInitImage() {\n+        return clientRackInitImage;\n+    }\n+\n+    public void setClientRackInitImage(String brokerRackInitImage) {\n+        this.clientRackInitImage = brokerRackInitImage;\n+    }\n+\n+    @Description(\"Configuration of the `client.rack` consumer config.\")\n+    @JsonProperty(\"rack\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9f530164f6af66e985dca7eb802fd30a63d2c37"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExOTkyNw==", "bodyText": "I do not think we need this if block since the init container should be used only when the rack is configure (and not null). You call it from getInitContainers only when rack is already not null I think.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3536#discussion_r475119927", "createdAt": "2020-08-22T18:56:13Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaConnectCluster.java", "diffHunk": "@@ -459,6 +505,51 @@ public Deployment generateDeployment(Map<String, String> annotations, boolean is\n         return containers;\n     }\n \n+    protected List<EnvVar> getInitContainerEnvVars() {\n+        List<EnvVar> varList = new ArrayList<>();\n+        varList.add(buildEnvVarFromFieldRef(ENV_VAR_KAFKA_INIT_NODE_NAME, \"spec.nodeName\"));\n+\n+        if (rack != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9f530164f6af66e985dca7eb802fd30a63d2c37"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEyMDM2Mg==", "bodyText": "Should this be called from testGenerateDeploymentWithRack?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3536#discussion_r475120362", "createdAt": "2020-08-22T19:00:52Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/test/java/io/strimzi/operator/cluster/model/KafkaConnectClusterTest.java", "diffHunk": "@@ -1346,4 +1337,93 @@ public void testNetworkPolicyWithoutConnectorOperator() {\n \n         assertThat(kc.generateNetworkPolicy(true, false), is(nullValue()));\n     }\n+\n+    @Test\n+    public void testClusterRoleBindingRack() {\n+        String testNamespace = \"other-namespace\";\n+\n+        KafkaConnect kafkaConnect = new KafkaConnectBuilder(this.resource)\n+                    .editOrNewMetadata()\n+                        .withNamespace(testNamespace)\n+                    .endMetadata()\n+                    .editOrNewSpec()\n+                        .withNewRack(\"my-topology-label\")\n+                    .endSpec()\n+                .build();\n+\n+        KafkaConnectCluster kafkaConnectCluster = KafkaConnectCluster.fromCrd(kafkaConnect, VERSIONS);\n+        ClusterRoleBinding crb = kafkaConnectCluster.generateClusterRoleBinding(testNamespace);\n+\n+        assertThat(crb.getMetadata().getName(), is(KafkaConnectCluster.initContainerClusterRoleBindingName(testNamespace, cluster)));\n+        assertThat(crb.getMetadata().getNamespace(), is(nullValue()));\n+        assertThat(crb.getSubjects().get(0).getNamespace(), is(testNamespace));\n+        assertThat(crb.getSubjects().get(0).getName(), is(KafkaConnectCluster.initContainerServiceAccountName(cluster)));\n+    }\n+\n+    @Test\n+    public void testNullClusterRoleBinding() {\n+        String testNamespace = \"other-namespace\";\n+\n+        KafkaConnect kafkaConnect = new KafkaConnectBuilder(this.resource)\n+                .editOrNewMetadata()\n+                    .withNamespace(testNamespace)\n+                .endMetadata()\n+                .build();\n+\n+        KafkaConnectCluster kafkaConnectCluster = KafkaConnectCluster.fromCrd(kafkaConnect, VERSIONS);\n+        ClusterRoleBinding crb = kafkaConnectCluster.generateClusterRoleBinding(testNamespace);\n+\n+        assertThat(crb, is(nullValue()));\n+    }\n+\n+    private void checkDeployment(Deployment dep, KafkaConnect resource) {\n+        assertThat(dep.getMetadata().getName(), is(KafkaConnectResources.deploymentName(cluster)));\n+        assertThat(dep.getMetadata().getNamespace(), is(namespace));\n+        Map<String, String> expectedDeploymentLabels = expectedLabels(KafkaConnectResources.deploymentName(cluster));\n+        assertThat(dep.getMetadata().getLabels(), is(expectedDeploymentLabels));\n+        assertThat(dep.getSpec().getSelector().getMatchLabels(), is(expectedSelectorLabels()));\n+        assertThat(dep.getSpec().getReplicas(), is(replicas));\n+        assertThat(dep.getSpec().getTemplate().getMetadata().getLabels(), is(expectedDeploymentLabels));\n+        assertThat(dep.getSpec().getTemplate().getSpec().getContainers().size(), is(1));\n+        assertThat(dep.getSpec().getTemplate().getSpec().getContainers().get(0).getName(), is(KafkaConnectResources.deploymentName(this.cluster)));\n+        assertThat(dep.getSpec().getTemplate().getSpec().getContainers().get(0).getImage(), is(kc.image));\n+        assertThat(dep.getSpec().getTemplate().getSpec().getContainers().get(0).getEnv(), is(getExpectedEnvVars()));\n+        assertThat(dep.getSpec().getTemplate().getSpec().getContainers().get(0).getLivenessProbe().getInitialDelaySeconds(), is(healthDelay));\n+        assertThat(dep.getSpec().getTemplate().getSpec().getContainers().get(0).getLivenessProbe().getTimeoutSeconds(), is(healthTimeout));\n+        assertThat(dep.getSpec().getTemplate().getSpec().getContainers().get(0).getReadinessProbe().getInitialDelaySeconds(), is(healthDelay));\n+        assertThat(dep.getSpec().getTemplate().getSpec().getContainers().get(0).getReadinessProbe().getTimeoutSeconds(), is(healthTimeout));\n+        assertThat(dep.getSpec().getTemplate().getSpec().getContainers().get(0).getPorts().size(), is(2));\n+        assertThat(dep.getSpec().getTemplate().getSpec().getContainers().get(0).getPorts().get(0).getContainerPort(), is(KafkaConnectCluster.REST_API_PORT));\n+        assertThat(dep.getSpec().getTemplate().getSpec().getContainers().get(0).getPorts().get(0).getName(), is(KafkaConnectCluster.REST_API_PORT_NAME));\n+        assertThat(dep.getSpec().getTemplate().getSpec().getContainers().get(0).getPorts().get(0).getProtocol(), is(\"TCP\"));\n+        assertThat(dep.getSpec().getStrategy().getType(), is(\"RollingUpdate\"));\n+        assertThat(dep.getSpec().getStrategy().getRollingUpdate().getMaxSurge().getIntVal(), is(1));\n+        assertThat(dep.getSpec().getStrategy().getRollingUpdate().getMaxUnavailable().getIntVal(), is(0));\n+        assertThat(AbstractModel.containerEnvVars(dep.getSpec().getTemplate().getSpec().getContainers().get(0)).get(KafkaConnectCluster.ENV_VAR_KAFKA_CONNECT_TLS), is(nullValue()));\n+        checkOwnerReference(kc.createOwnerReference(), dep);\n+        checkRack(dep, resource);\n+    }\n+\n+    private void checkOwnerReference(OwnerReference ownerRef, HasMetadata resource)  {\n+        assertThat(resource.getMetadata().getOwnerReferences().size(), is(1));\n+        assertThat(resource.getMetadata().getOwnerReferences().get(0), is(ownerRef));\n+    }\n+\n+    private void checkRack(Deployment deployment, KafkaConnect resource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9f530164f6af66e985dca7eb802fd30a63d2c37"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEyMDYyMQ==", "bodyText": "I guess we need to add the Cluster role to the installation files? We will need to add it to install/ and for both Helm Charts.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3536#discussion_r475120621", "createdAt": "2020-08-22T19:03:47Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaConnectCluster.java", "diffHunk": "@@ -682,4 +781,61 @@ public NetworkPolicy generateNetworkPolicy(boolean namespaceAndPodSelectorNetwor\n     public Tracing getTracing() {\n         return tracing;\n     }\n+\n+    /**\n+     * Get the name of the kafka connect service account given the name of the {@code kafkaResourceName}.\n+     *\n+     * @param resourceName The name of the Kafka connect resource.\n+     * @return The name of the ServiceAccount.\n+     */\n+    public static String initContainerServiceAccountName(String resourceName) {\n+        return KafkaConnectResources.deploymentName(resourceName);\n+    }\n+\n+    /**\n+     * Get the name of the kafka connect init container role binding given the name of the {@code namespace} and {@code cluster}.\n+     *\n+     * @param namespace The namespace.\n+     * @param cluster   The cluster name.\n+     * @return The name of the init container's cluster role binding.\n+     */\n+    public static String initContainerClusterRoleBindingName(String namespace, String cluster) {\n+        return \"strimzi-\" + namespace + \"-\" + cluster + \"-kafka-init\";\n+    }\n+\n+    /**\n+     * Creates the ClusterRoleBinding which is used to bind the Kafka Connect SA to the ClusterRole\n+     * which permissions the Kafka init container to access K8S nodes (necessary for rack-awareness).\n+     *\n+     * @param assemblyNamespace The namespace.\n+     * @return The cluster role binding.\n+     */\n+    public ClusterRoleBinding generateClusterRoleBinding(String assemblyNamespace) {\n+\n+        if (rack == null) {\n+            return null;\n+        }\n+\n+        Subject ks = new SubjectBuilder()\n+                .withKind(\"ServiceAccount\")\n+                .withName(initContainerServiceAccountName(cluster))\n+                .withNamespace(assemblyNamespace)\n+                .build();\n+\n+        RoleRef roleRef = new RoleRefBuilder()\n+                .withName(\"strimzi-kafka-client\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9f530164f6af66e985dca7eb802fd30a63d2c37"}, "originalPosition": 238}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODQ0MDgz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3536#pullrequestreview-475844083", "createdAt": "2020-08-26T20:43:03Z", "commit": {"oid": "94b19696db074afd6040c5d92018053cc1c4daf0"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MzYyNTcz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3536#pullrequestreview-478362573", "createdAt": "2020-08-31T06:56:12Z", "commit": {"oid": "94b19696db074afd6040c5d92018053cc1c4daf0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2571247d19bc3a428d0705df1278a6f88a02165", "author": {"user": {"login": "klalafaryan", "name": "Konstantin Lalafaryan"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/c2571247d19bc3a428d0705df1278a6f88a02165", "committedDate": "2020-08-31T20:25:49Z", "message": "Use client.rack property in kafka connect\n\nSigned-off-by: klalafaryan <lalafaryan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0411be93c4a5ccf45eff947e1af694cabe14cd7", "author": {"user": {"login": "klalafaryan", "name": "Konstantin Lalafaryan"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/b0411be93c4a5ccf45eff947e1af694cabe14cd7", "committedDate": "2020-08-31T20:25:49Z", "message": "Update derived resources\n\nSigned-off-by: klalafaryan <lalafaryan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e41b420946f23743e6a34448ebb2c8e3ab1e5907", "author": {"user": {"login": "klalafaryan", "name": "Konstantin Lalafaryan"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e41b420946f23743e6a34448ebb2c8e3ab1e5907", "committedDate": "2020-08-31T20:26:13Z", "message": "Fix code review comments, and some other improvements\n\nSigned-off-by: klalafaryan <lalafaryan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4aebd612308d5d4cc225541f4b0d3aa9139fe8f6", "author": {"user": {"login": "klalafaryan", "name": "Konstantin Lalafaryan"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4aebd612308d5d4cc225541f4b0d3aa9139fe8f6", "committedDate": "2020-08-31T20:26:13Z", "message": "Fix unit tests and update from master\n\nSigned-off-by: klalafaryan <lalafaryan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb820ff8e31ac8ad87d402376df0feb5fdd3ef12", "author": {"user": {"login": "klalafaryan", "name": "Konstantin Lalafaryan"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fb820ff8e31ac8ad87d402376df0feb5fdd3ef12", "committedDate": "2020-08-31T20:26:13Z", "message": "Some further improvements\n\nSigned-off-by: klalafaryan <lalafaryan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a542ff6698dd794a9c33da57f168e452e5fe18b4", "author": {"user": {"login": "klalafaryan", "name": "Konstantin Lalafaryan"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a542ff6698dd794a9c33da57f168e452e5fe18b4", "committedDate": "2020-08-31T20:26:13Z", "message": "some small improvements\n\nSigned-off-by: klalafaryan <lalafaryan@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94b19696db074afd6040c5d92018053cc1c4daf0", "author": {"user": {"login": "klalafaryan", "name": "Konstantin Lalafaryan"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/94b19696db074afd6040c5d92018053cc1c4daf0", "committedDate": "2020-08-26T19:33:20Z", "message": "some small improvements\n\nSigned-off-by: klalafaryan <lalafaryan@gmail.com>"}, "afterCommit": {"oid": "a542ff6698dd794a9c33da57f168e452e5fe18b4", "author": {"user": {"login": "klalafaryan", "name": "Konstantin Lalafaryan"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a542ff6698dd794a9c33da57f168e452e5fe18b4", "committedDate": "2020-08-31T20:26:13Z", "message": "some small improvements\n\nSigned-off-by: klalafaryan <lalafaryan@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5MTk3MjEw", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3536#pullrequestreview-479197210", "createdAt": "2020-09-01T00:40:21Z", "commit": {"oid": "a542ff6698dd794a9c33da57f168e452e5fe18b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1189, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}