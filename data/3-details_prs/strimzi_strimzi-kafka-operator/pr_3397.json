{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3NDg4NzE4", "number": 3397, "title": "[cc] Add test for topic exclusion, fix utils methods, change annotation location", "bodyText": "Signed-off-by: Lukas Kral lukywill16@gmail.com\nType of change\n\nBugfix\nNew test\n\nDescription\nAfter #3275 we are able to set which topics should be excluded, so theirs performance remains stable during the rebalance. Other than this I fixed utils methods -> all the states of KafkaRebalance had timeout 3 minutes -> I added there wrong method from ResourceOperation in my last PR. Also I added method for annotating the KafkaRebalance.\nChecklist\n\n Write tests\n Make sure all tests pass", "createdAt": "2020-07-28T01:41:24Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397", "merged": true, "mergeCommit": {"oid": "83a6898c050cf56f370b89aef97db664b5ede182"}, "closed": true, "closedAt": "2020-07-28T21:07:24Z", "author": {"login": "im-konge"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5MOjFgH2gAyNDU3NDg4NzE4OjlmYjM0Zjk0NWU0MDk3MDM2ZmU0OTBhYjQwMWIyNjJhM2M3MTNlMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5YorTgFqTQ1Njc4MzkyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9fb34f945e4097036fe490ab401b262a3c713e10", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9fb34f945e4097036fe490ab401b262a3c713e10", "committedDate": "2020-07-28T01:34:31Z", "message": "add test, fix utils methods\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MzQ5NjU5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#pullrequestreview-456349659", "createdAt": "2020-07-28T06:54:50Z", "commit": {"oid": "9fb34f945e4097036fe490ab401b262a3c713e10"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNjo1NDo1MVrOG3_Fag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNjo1NDo1MVrOG3_Fag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM1ODQ0Mg==", "bodyText": "why setting throttling and leader movements for this test?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461358442", "createdAt": "2020-07-28T06:54:51Z", "author": {"login": "ppatierno"}, "path": "systemtest/src/test/java/io/strimzi/systemtest/cruisecontrol/CruiseControlIsolatedST.java", "diffHunk": "@@ -125,6 +122,37 @@ void testCruiseControlWithSingleNodeKafka() {\n         assertThat(kafkaStatus.getConditions().get(0).getMessage(), is(not(errMessage)));\n     }\n \n+    @Test\n+    void testCruiseControlTopicExclusion() {\n+        String excludedTopic1 = \"excluded-topic-1\";\n+        String excludedTopic2 = \"excluded-topic-2\";\n+        String includedTopic = \"included-topic\";\n+\n+        KafkaResource.kafkaWithCruiseControl(CLUSTER_NAME, 3, 3).done();\n+        KafkaTopicResource.topic(CLUSTER_NAME, excludedTopic1).done();\n+        KafkaTopicResource.topic(CLUSTER_NAME, excludedTopic2).done();\n+        KafkaTopicResource.topic(CLUSTER_NAME, includedTopic).done();\n+\n+        KafkaRebalanceResource.kafkaRebalance(CLUSTER_NAME)\n+            .editOrNewSpec()\n+                .withExcludedTopics(\"excluded-.*\")\n+                .withReplicationThrottle(200000)\n+                .withConcurrentLeaderMovements(1200)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fb34f945e4097036fe490ab401b262a3c713e10"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NDMyMTgy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#pullrequestreview-456432182", "createdAt": "2020-07-28T08:52:45Z", "commit": {"oid": "9fb34f945e4097036fe490ab401b262a3c713e10"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwODo1Mjo0NVrOG4DC1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwODo1Mjo0NVrOG4DC1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQyMzMxOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        .execInCurrentNamespace(\"annotate\", \"kafkarebalance\", resourceName, \"strimzi.io/rebalance=\" + annotation.toString())\n          \n          \n            \n                        .execInCurrentNamespace(\"annotate\", \"kafkarebalance\", resourceName, KafkaRebalanceAssemblyOperator.ANNO_STRIMZI_IO_REBALANCE + \"=\" + annotation.toString())", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461423319", "createdAt": "2020-07-28T08:52:45Z", "author": {"login": "samuel-hawker"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kafkaUtils/KafkaRebalanceUtils.java", "diffHunk": "@@ -45,7 +47,14 @@ private static Condition rebalanceStateCondition(String resourceName) {\n \n     public static void waitForKafkaRebalanceCustomResourceState(String resourceName, KafkaRebalanceState state) {\n         KafkaRebalance kafkaRebalance = KafkaRebalanceResource.kafkaRebalanceClient().inNamespace(kubeClient().getNamespace()).withName(resourceName).get();\n-        ResourceManager.waitForResourceStatus(KafkaRebalanceResource.kafkaRebalanceClient(), kafkaRebalance, state.toString());\n+        ResourceManager.waitForResourceStatus(KafkaRebalanceResource.kafkaRebalanceClient(), kafkaRebalance, state.toString(), ResourceOperation.getTimeoutForKafkaRebalanceState(state));\n+    }\n+\n+    public static String annotateKafkaRebalanceResource(String resourceName, KafkaRebalanceAnnotation annotation) {\n+        LOGGER.info(\"Annotating KafkaRebalance:{} with annotation {}\", resourceName, annotation.toString());\n+        return ResourceManager.cmdKubeClient().namespace(kubeClient().getNamespace())\n+            .execInCurrentNamespace(\"annotate\", \"kafkarebalance\", resourceName, \"strimzi.io/rebalance=\" + annotation.toString())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fb34f945e4097036fe490ab401b262a3c713e10"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NDU5NjQz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#pullrequestreview-456459643", "createdAt": "2020-07-28T09:26:42Z", "commit": {"oid": "9fb34f945e4097036fe490ab401b262a3c713e10"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19a4b7a34a23152e8d856f2be25970860c709f96", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/19a4b7a34a23152e8d856f2be25970860c709f96", "committedDate": "2020-07-28T11:56:53Z", "message": "comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NTYxMTUy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#pullrequestreview-456561152", "createdAt": "2020-07-28T12:00:33Z", "commit": {"oid": "19a4b7a34a23152e8d856f2be25970860c709f96"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92b711c60550e3bc64cb0c1b23a3083ef2bd60be", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/92b711c60550e3bc64cb0c1b23a3083ef2bd60be", "committedDate": "2020-07-28T12:09:48Z", "message": "fixup! comments\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NTc1NzA5", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#pullrequestreview-456575709", "createdAt": "2020-07-28T12:21:54Z", "commit": {"oid": "92b711c60550e3bc64cb0c1b23a3083ef2bd60be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMjoyMTo1NVrOG4J9Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxMjoyMTo1NVrOG4J9Tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTUzNjU5MQ==", "bodyText": "What is this import used for? I think it would be much better to keep clean separation between the system tests and internal code of the cluster operator.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#discussion_r461536591", "createdAt": "2020-07-28T12:21:55Z", "author": {"login": "scholzj"}, "path": "systemtest/src/main/java/io/strimzi/systemtest/utils/kafkaUtils/KafkaRebalanceUtils.java", "diffHunk": "@@ -6,8 +6,11 @@\n \n import io.strimzi.api.kafka.model.KafkaRebalance;\n import io.strimzi.api.kafka.model.status.Condition;\n+import io.strimzi.api.kafka.operator.assembly.KafkaRebalanceAnnotation;\n import io.strimzi.api.kafka.operator.assembly.KafkaRebalanceState;\n+import io.strimzi.operator.cluster.operator.assembly.KafkaRebalanceAssemblyOperator;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92b711c60550e3bc64cb0c1b23a3083ef2bd60be"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "836ccfe177f2ac76a608a14f52006baa3db890d2", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/836ccfe177f2ac76a608a14f52006baa3db890d2", "committedDate": "2020-07-28T13:23:04Z", "message": "comment vol2\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjI5MDk1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#pullrequestreview-456629095", "createdAt": "2020-07-28T13:27:50Z", "commit": {"oid": "836ccfe177f2ac76a608a14f52006baa3db890d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "089186bc68f6eff662863d09d4d63f5a5db1a700", "author": {"user": {"login": "im-konge", "name": "Luk\u00e1\u0161 Kr\u00e1l"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/089186bc68f6eff662863d09d4d63f5a5db1a700", "committedDate": "2020-07-28T14:02:24Z", "message": "change anno everywhere\n\nSigned-off-by: Lukas Kral <lukywill16@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NjY0Mzkx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#pullrequestreview-456664391", "createdAt": "2020-07-28T14:03:56Z", "commit": {"oid": "089186bc68f6eff662863d09d4d63f5a5db1a700"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NzgzOTIy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/3397#pullrequestreview-456783922", "createdAt": "2020-07-28T16:01:55Z", "commit": {"oid": "089186bc68f6eff662863d09d4d63f5a5db1a700"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1393, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}