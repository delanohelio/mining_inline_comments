{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MDc4Mzg5", "number": 2563, "title": "Print a warning when single ZK replica with ephemeral storage is used", "bodyText": "Signed-off-by: Stanislav Knot sknot@redhat.com\nType of change\n\nEnhancement\n\nDescription\nWhile debugging faulty STs @tombentley noticed, we are using single node ZK clusters with ephemeral storage. It is ok, until we need any rolling update/restart. We do not want to disable this combination though. User should be at least log:WARNed the things will hit the fan eventually.\nFixes #2555\nChecklist\n\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging", "createdAt": "2020-02-17T11:08:43Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2563", "merged": true, "mergeCommit": {"oid": "8229661d2bbf776e34fa3f6df92daf1529b4150c"}, "closed": true, "closedAt": "2020-02-17T20:09:50Z", "author": {"login": "sknot-rh"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFLSgCAH2gAyMzc2MDc4Mzg5OmZjNzhhMDA0MGNlMzA2NGUzZmFmNjVjMDljMmI2ZjY0YmE5N2M3ZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFTFCSAFqTM1OTk0Njc0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc78a0040ce3064e3faf65c09c2b6f64ba97c7e1", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fc78a0040ce3064e3faf65c09c2b6f64ba97c7e1", "committedDate": "2020-02-17T11:04:52Z", "message": "Print a warning when single ZK replica with ephemeral storage is used\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NzQxNzA0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2563#pullrequestreview-359741704", "createdAt": "2020-02-17T13:41:50Z", "commit": {"oid": "ffc00759b7df44f2f5b040e1d4282061de5b4aa5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMzo0MTo1MFrOFqk03w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMzo0MTo1MFrOFqk03w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE4Nzg3MQ==", "bodyText": "Isn't \"ephemeral\".equals(...) better? Smaller chance for NPE.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2563#discussion_r380187871", "createdAt": "2020-02-17T13:41:50Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ZookeeperCluster.java", "diffHunk": "@@ -181,6 +181,11 @@ public static ZookeeperCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup\n         if (replicas <= 0) {\n             replicas = ZookeeperClusterSpec.DEFAULT_REPLICAS;\n         }\n+\n+        if (replicas == 1 && zookeeperClusterSpec.getStorage() != null && zookeeperClusterSpec.getStorage().getType().equals(\"ephemeral\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffc00759b7df44f2f5b040e1d4282061de5b4aa5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NzQzNDcz", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2563#pullrequestreview-359743473", "createdAt": "2020-02-17T13:44:31Z", "commit": {"oid": "ffc00759b7df44f2f5b040e1d4282061de5b4aa5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMzo0NDozMlrOFqk6Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMzo0NDozMlrOFqk6Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE4OTIxMQ==", "bodyText": "@laidan6000 @PaulRMellor Could one of you review the message please?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2563#discussion_r380189211", "createdAt": "2020-02-17T13:44:32Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ZookeeperCluster.java", "diffHunk": "@@ -181,6 +181,11 @@ public static ZookeeperCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup\n         if (replicas <= 0) {\n             replicas = ZookeeperClusterSpec.DEFAULT_REPLICAS;\n         }\n+\n+        if (replicas == 1 && zookeeperClusterSpec.getStorage() != null && zookeeperClusterSpec.getStorage().getType().equals(\"ephemeral\")) {\n+            log.warn(\"Zookeeper cluster with single replica and ephemeral storage will be in defective state after any restart or rolling update. It is recommended to use at least three replicas.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffc00759b7df44f2f5b040e1d4282061de5b4aa5"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcb198aa7f4824510c574c8493fc598f29890d1d", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fcb198aa7f4824510c574c8493fc598f29890d1d", "committedDate": "2020-02-17T14:29:26Z", "message": "jbod\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ffc00759b7df44f2f5b040e1d4282061de5b4aa5", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ffc00759b7df44f2f5b040e1d4282061de5b4aa5", "committedDate": "2020-02-17T12:12:34Z", "message": "jbod\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}, "afterCommit": {"oid": "fcb198aa7f4824510c574c8493fc598f29890d1d", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/fcb198aa7f4824510c574c8493fc598f29890d1d", "committedDate": "2020-02-17T14:29:26Z", "message": "jbod\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5ODA2MzMx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2563#pullrequestreview-359806331", "createdAt": "2020-02-17T15:14:27Z", "commit": {"oid": "fcb198aa7f4824510c574c8493fc598f29890d1d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNToxNDoyN1rOFqn3gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNToxNDoyN1rOFqn3gQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzNzY5Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        log.warn(\"Zookeeper cluster with single replica and ephemeral storage will be in defective state after any restart or rolling update. It is recommended to use at least three replicas.\");\n          \n          \n            \n                        log.warn(\"A ZooKeeper cluster with a single replica and ephemeral storage will be in a defective state after any restart or rolling update. It is recommended that a minimum of three replicas are used.\");", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2563#discussion_r380237697", "createdAt": "2020-02-17T15:14:27Z", "author": {"login": "PaulRMellor"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/ZookeeperCluster.java", "diffHunk": "@@ -181,6 +181,11 @@ public static ZookeeperCluster fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup\n         if (replicas <= 0) {\n             replicas = ZookeeperClusterSpec.DEFAULT_REPLICAS;\n         }\n+\n+        if (replicas == 1 && zookeeperClusterSpec.getStorage() != null && \"ephemeral\".equals(zookeeperClusterSpec.getStorage().getType())) {\n+            log.warn(\"Zookeeper cluster with single replica and ephemeral storage will be in defective state after any restart or rolling update. It is recommended to use at least three replicas.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fcb198aa7f4824510c574c8493fc598f29890d1d"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5ODA2ODcx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2563#pullrequestreview-359806871", "createdAt": "2020-02-17T15:15:12Z", "commit": {"oid": "fcb198aa7f4824510c574c8493fc598f29890d1d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6acbdc64e72645954a9adf495f2e6823c4aef549", "author": {"user": {"login": "sknot-rh", "name": "Stanislav Knot"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/6acbdc64e72645954a9adf495f2e6823c4aef549", "committedDate": "2020-02-17T15:18:58Z", "message": "message suggestion\n\nSigned-off-by: Stanislav Knot <sknot@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5OTQzNDM3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2563#pullrequestreview-359943437", "createdAt": "2020-02-17T19:59:10Z", "commit": {"oid": "6acbdc64e72645954a9adf495f2e6823c4aef549"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5OTQ2NzQy", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2563#pullrequestreview-359946742", "createdAt": "2020-02-17T20:09:24Z", "commit": {"oid": "6acbdc64e72645954a9adf495f2e6823c4aef549"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1722, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}