{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNjU3MTY3", "number": 2730, "title": "feat: Correct Kubernetes labels and labels refactor", "bodyText": "Modify the app.kubernetes.io/name label to reflect the\ncorrect apps for each component\nThese labels are queryable so that a user can see all 'kafka',\n'zookeeper' etc components in a cluster\nModify the app.kubernetes.io/part-of label to have a unique\nidentifier for each instance of a cluster\nThis is mostly for the openshift Ui which clusters applications\nbased on their part-of label\nRefactored labels so that all models build up their labels\nin a similar fashion.\nMade explicit the subset of labels that constitute a strimzi  selector\nlabel this should assist in  avoiding breaking bugs in future\n\nRework of: #2606\nSigned-off-by: Samuel Hawker samuel.hawker@ibm.com\nType of change\nSelect the type of your PR\n\nBugfix\nEnhancement / new feature\nRefactoring\nDocumentation\n\nDescription\nPlease describe your pull request\nChecklist\nPlease go through this checklist and make sure all applicable tasks have been done\n\n Update/write design documentation in ./design\n Write tests\n Make sure all tests pass\n Update documentation\n Check RBAC rights for Kubernetes / OpenShift roles\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging\n Update CHANGELOG.md", "createdAt": "2020-03-20T17:33:24Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730", "merged": true, "mergeCommit": {"oid": "1a2d6783dffe4db3931663cb4464e37a666f8a2f"}, "closed": true, "closedAt": "2020-03-27T12:25:54Z", "author": {"login": "samuel-hawker"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPlovaABqjMxNTA2MzQzMzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRtADjgBqjMxNzE1NDU4NDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "51758bd2b9c218aec45c25344bd7d88a72349c59", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/51758bd2b9c218aec45c25344bd7d88a72349c59", "committedDate": "2020-03-20T17:11:25Z", "message": "feat: Correct Kubernetes labels and labels refactor\n\n- Modify the app.kubernetes.io/name label to reflect the\ncorrect apps for each component\nThese labels are queryable so that a user can see all 'kafka',\n'zookeeper' etc components in a cluster\n- Modify the app.kubernetes.io/part-of label to have a unique\nidentifier for each instance of a cluster\nThis is mostly for the openshift Ui which clusters applications\nbased on their part-of label\n- Refactored labels so that all models build up their labels\nin a similar fashion.\nMade explicit the subset of labels that constitute a strimzi  selector\nlabel this should assist in  avoiding breaking bugs in future\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>ase enter the commit message for your changes. Lines starting"}, "afterCommit": {"oid": "9aa5e24eee61691ed87330e4bb5d45b59bb7fc3a", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/9aa5e24eee61691ed87330e4bb5d45b59bb7fc3a", "committedDate": "2020-03-20T19:25:42Z", "message": "feat: Correct Kubernetes labels and labels refactor\n\n- Modify the app.kubernetes.io/name label to reflect the\ncorrect apps for each component\nThese labels are queryable so that a user can see all 'kafka',\n'zookeeper' etc components in a cluster\n- Modify the app.kubernetes.io/part-of label to have a unique\nidentifier for each instance of a cluster\nThis is mostly for the openshift Ui which clusters applications\nbased on their part-of label\n- Refactored labels so that all models build up their labels\nin a similar fashion.\nMade explicit the subset of labels that constitute a strimzi  selector\nlabel this should assist in  avoiding breaking bugs in future\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>ase enter the commit message for your changes. Lines starting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5OTE0MjM3", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#pullrequestreview-379914237", "createdAt": "2020-03-24T00:01:16Z", "commit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwMDowMToxNlrOF6clIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwMDoxODozNVrOF6c4XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgyOTk4Ng==", "bodyText": "BEfore we included here also the templateStatefulSetLabels. I'm sure that had some reason. Why don't we need it anymore?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396829986", "createdAt": "2020-03-24T00:01:16Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/AbstractModel.java", "diffHunk": "@@ -620,7 +612,8 @@ protected PersistentVolumeClaim createPersistentVolumeClaim(int podNumber, Strin\n                 .withNewMetadata()\n                     .withName(name)\n                     .withNamespace(namespace)\n-                    .withLabels(mergeLabelsOrAnnotations(getLabelsWithName(templateStatefulSetLabels), templatePersistentVolumeClaimLabels))\n+                    // labels with the Strimzi name set to that of the component\n+                    .withLabels(getLabelsWithStrimziName(this.name, templatePersistentVolumeClaimLabels).toMap())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzMDY1Ng==", "bodyText": "Is there some object inheriting from AbtractModel which does not do this? If yes, why does it need to be separate method and not part of the constructor?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396830656", "createdAt": "2020-03-24T00:03:46Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/JmxTrans.java", "diffHunk": "@@ -106,10 +106,11 @@ public static JmxTrans fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup versions\n                 throw new InvalidResourceException(error);\n             }\n             result = new JmxTrans(kafkaAssembly.getMetadata().getNamespace(),\n-                    kafkaAssembly.getMetadata().getName(),\n-                    Labels.fromResource(kafkaAssembly).withKind(kafkaAssembly.getKind()));\n+                    kafkaAssembly.getMetadata().getName());\n             result.isDeployed = true;\n \n+            result.setDefaultLabels(kafkaAssembly);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzMTQ5OA==", "bodyText": "I find it a bit weird that out of the 12 places where this is defined the comment is only here ;-)", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396831498", "createdAt": "2020-03-24T00:06:49Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -113,6 +113,9 @@\n \n @SuppressWarnings(\"checkstyle:ClassDataAbstractionCoupling\")\n public class KafkaCluster extends AbstractModel {\n+    // Name of component kafka", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzMjgwNg==", "bodyText": "If I read it corrctly, this seems to be called only from one place. Shouldn't we use the Labels.geenrateDefaultLabels() directly and remove this?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396832806", "createdAt": "2020-03-24T00:11:09Z", "author": {"login": "scholzj"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/AbstractModel.java", "diffHunk": "@@ -247,39 +252,26 @@ public String getHeadlessServiceName() {\n      * @return The selector labels as an instance of the Labels object.\n      */\n     public Labels getSelectorLabels() {\n-        return labels.withName(name).strimziSelectorLabels();\n+        return getLabelsWithStrimziName(name, Collections.emptyMap()).strimziSelectorLabels();\n     }\n \n-    /**\n-     * @return The selector labels as Map.\n-     */\n-    public Map<String, String> getSelectorLabelsAsMap() {\n-        return getSelectorLabels().toMap();\n+    protected Labels getLabelsWithStrimziName(String name, Map<String, String> additionalLabels) {\n+        return labels.withStrimziName(name).withAdditionalLabels(additionalLabels);\n     }\n \n-    protected Map<String, String> getLabelsWithName() {\n-        return getLabelsWithName(name);\n+    protected Labels getLabelsWithNameAndDiscovery(String name, Map<String, String> additionalLabels) {\n+        return getLabelsWithStrimziName(name, additionalLabels).withStrimziDiscovery();\n     }\n \n-    protected Map<String, String> getLabelsWithName(Map<String, String> userLabels) {\n-        return getLabelsWithName(name, userLabels);\n-    }\n-\n-    protected Map<String, String> getLabelsWithName(String name) {\n-        return labels.withName(name).toMap();\n-    }\n-\n-    protected Map<String, String> getLabelsWithName(String name, Map<String, String> userLabels) {\n-        return labels.withName(name).withUserLabels(userLabels).toMap();\n+    /**\n+     * @param resource\n+     * @return The default Labels set\n+     */\n+    protected Labels generateDefaultLabels(HasMetadata resource) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzMzYyNA==", "bodyText": "I think we need to sanitize this for length\nEDIT: I can see you do that in the with...() methods. That means it is done multiple times and here were are vulnerable to someone adding new label without sanitizing it. Maybe you have a reson to keep it in the with...() methods. But it might be good to leave here a comment or something.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396833624", "createdAt": "2020-03-24T00:14:01Z", "author": {"login": "scholzj"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/model/Labels.java", "diffHunk": "@@ -361,4 +393,24 @@ public int hashCode() {\n     public String toString() {\n         return \"Labels\" + labels;\n     }\n+\n+    /**\n+     * @param resource        a resource with metadata\n+     * @param applicationName the name of the application of the component\n+     * @param managedBy       a resource with meta\n+     * @return The default Labels set\n+     */\n+    public static Labels generateDefaultLabels(HasMetadata resource, String applicationName, String managedBy) {\n+        String instanceName = resource.getMetadata().getName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 332}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzMzg4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<String> strimziSelectorLabels = new ArrayList<>();\n          \n          \n            \n                    List<String> strimziSelectorLabels = new ArrayList<>(3);", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396833881", "createdAt": "2020-03-24T00:15:00Z", "author": {"login": "scholzj"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/model/Labels.java", "diffHunk": "@@ -316,29 +345,32 @@ public Labels withStatefulSetPod(String name) {\n      * @param cluster The cluster.\n      * @return A singleton instance with the given {@code cluster} for the {@code strimzi.io/cluster} key.\n      */\n-    public static Labels forCluster(String cluster) {\n+    public static Labels forStrimziCluster(String cluster) {\n         return new Labels(singletonMap(STRIMZI_CLUSTER_LABEL, cluster));\n     }\n \n     /**\n      * @param kind The kind.\n      * @return A singleton instance with the given {@code kind} for the {@code strimzi.io/kind} key.\n      */\n-    public static Labels forKind(String kind) {\n+    public static Labels forStrimziKind(String kind) {\n         return new Labels(singletonMap(STRIMZI_KIND_LABEL, kind));\n     }\n \n     /**\n-     * @return An instances containing just the strimzi.io labels present in this instance.\n+     * @return A new instances containing just the strimzi.io selector labels present in this instance.\n      */\n     public Labels strimziSelectorLabels() {\n         Map<String, String> newLabels = new HashMap<>(3);\n \n-        for (Map.Entry<String, String> entry : labels.entrySet()) {\n-            if (entry.getKey().startsWith(STRIMZI_DOMAIN) && !entry.getKey().equals(STRIMZI_DISCOVERY_LABEL)) {\n-                newLabels.put(entry.getKey(), entry.getValue());\n-            }\n-        }\n+        List<String> strimziSelectorLabels = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 309}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzNDI4OQ==", "bodyText": "I think we normally have this on single line:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static String getOrValidInstanceLabelValue(String instance) {\n          \n          \n            \n                /*test*/ static String getOrValidInstanceLabelValue(String instance) {", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396834289", "createdAt": "2020-03-24T00:16:26Z", "author": {"login": "scholzj"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/model/Labels.java", "diffHunk": "@@ -196,68 +215,74 @@ private Labels with(String label, String value) {\n \n     /**\n      * The same labels as this instance, but with the given {@code kind} for the {@code strimzi.io/kind} key.\n+     *\n      * @param kind The kind to add.\n      * @return A new instance with the given kind added.\n      */\n-    public Labels withKind(String kind) {\n+    public Labels withStrimziKind(String kind) {\n         return with(STRIMZI_KIND_LABEL, kind);\n     }\n \n \n     /**\n      * The same labels as this instance, but with the given {@code cluster} for the {@code strimzi.io/cluster} key.\n+     *\n      * @param cluster The cluster to add.\n      * @return A new instance with the given cluster added.\n      */\n-    public Labels withCluster(String cluster) {\n+    public Labels withStrimziCluster(String cluster) {\n         return with(STRIMZI_CLUSTER_LABEL, cluster);\n     }\n \n     /**\n      * The same labels as this instance, but with the application name {@code strimzi} for the {@code app.kubernetes.io/name} key.\n+     *\n+     * @param name The kubernetes name to add.\n      * @return A new instance with the given kubernetes application name added.\n      */\n-    public Labels withKubernetesName() {\n-        return with(Labels.KUBERNETES_NAME_LABEL, Labels.KUBERNETES_NAME);\n+    public Labels withKubernetesName(String name) {\n+        return with(Labels.KUBERNETES_NAME_LABEL, name);\n     }\n \n     /**\n      * The same labels as this instance, but with the given {@code instance} for the {@code app.kubernetes.io/instance} key.\n-     * @param instance The instance to add.\n+     *\n+     * @param instanceName The instance to add.\n      * @return A new instance with the given kubernetes application instance added.\n      */\n-    public Labels withKubernetesInstance(String instance) {\n-        return with(Labels.KUBERNETES_INSTANCE_LABEL, getOrValidInstanceLabelValue(instance));\n+    public Labels withKubernetesInstance(String instanceName) {\n+        return with(Labels.KUBERNETES_INSTANCE_LABEL, getOrValidInstanceLabelValue(instanceName));\n     }\n \n     /**\n      * The same labels as this instance, but with the given {@code part-of} for the {@code app.kubernetes.io/part-of} key.\n-     * @param partof The partof label to add.\n+     *\n+     * @param instanceName The instance used to generate the unique label to add composed with the application name.\n      * @return A new instance with the given kubernetes application part-of label added.\n      */\n-    public Labels withKubernetesPartOf(String partof) {\n-        return with(Labels.KUBERNETES_PART_OF_LABEL, getOrValidInstanceLabelValue(partof));\n+    public Labels withKubernetesPartOf(String instanceName) {\n+        return with(Labels.KUBERNETES_PART_OF_LABEL, getOrValidInstanceLabelValue(APPLICATION_NAME + \"-\" + instanceName));\n     }\n \n     /**\n      * Validates the instance name and if needed modifies it to make it a valid Label value:\n-     *   - (([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])?\n-     *   - 63 characters max\n+     * - (([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])?\n+     * - 63 characters max\n      * This method is written to handle instance names which are valid resource names, since they are derived from a\n      * custom resource. It does not modify arbitrary names as label values.\n      *\n-     *\n      * @param instance Theoriginal name of the instance\n      * @return Either the original instance name or a modified version to match label value criteria\n      */\n-    /*test*/ static String getOrValidInstanceLabelValue(String instance) {\n-        if (instance == null)   {\n+    /*test*/\n+    static String getOrValidInstanceLabelValue(String instance) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 227}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzNDkwOQ==", "bodyText": "So I guess this is where it runs into #2743 and it is not clear to me how to deal with it.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396834909", "createdAt": "2020-03-24T00:18:35Z", "author": {"login": "scholzj"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/model/Labels.java", "diffHunk": "@@ -117,7 +136,7 @@ public static Labels userLabels(Map<String, String> userLabels) {\n         }\n \n         // Remove Kubernetes Domain specific labels\n-        Map<String, String> filteredLabels = userLabels\n+        Map<String, String> filteredLabels = additionalLabels", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 100}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMDk0MjE1", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#pullrequestreview-380094215", "createdAt": "2020-03-24T08:38:25Z", "commit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwODozODoyNVrOF6lwUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwODo0ODo1MlrOF6mHIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4MDMwNw==", "bodyText": "You're absolutely right I will change this, I thought changing the signature would be useful but it wasn't", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396980307", "createdAt": "2020-03-24T08:38:25Z", "author": {"login": "samuel-hawker"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/AbstractModel.java", "diffHunk": "@@ -247,39 +252,26 @@ public String getHeadlessServiceName() {\n      * @return The selector labels as an instance of the Labels object.\n      */\n     public Labels getSelectorLabels() {\n-        return labels.withName(name).strimziSelectorLabels();\n+        return getLabelsWithStrimziName(name, Collections.emptyMap()).strimziSelectorLabels();\n     }\n \n-    /**\n-     * @return The selector labels as Map.\n-     */\n-    public Map<String, String> getSelectorLabelsAsMap() {\n-        return getSelectorLabels().toMap();\n+    protected Labels getLabelsWithStrimziName(String name, Map<String, String> additionalLabels) {\n+        return labels.withStrimziName(name).withAdditionalLabels(additionalLabels);\n     }\n \n-    protected Map<String, String> getLabelsWithName() {\n-        return getLabelsWithName(name);\n+    protected Labels getLabelsWithNameAndDiscovery(String name, Map<String, String> additionalLabels) {\n+        return getLabelsWithStrimziName(name, additionalLabels).withStrimziDiscovery();\n     }\n \n-    protected Map<String, String> getLabelsWithName(Map<String, String> userLabels) {\n-        return getLabelsWithName(name, userLabels);\n-    }\n-\n-    protected Map<String, String> getLabelsWithName(String name) {\n-        return labels.withName(name).toMap();\n-    }\n-\n-    protected Map<String, String> getLabelsWithName(String name, Map<String, String> userLabels) {\n-        return labels.withName(name).withUserLabels(userLabels).toMap();\n+    /**\n+     * @param resource\n+     * @return The default Labels set\n+     */\n+    protected Labels generateDefaultLabels(HasMetadata resource) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzMjgwNg=="}, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4MTIwMg==", "bodyText": "We do need it, but I have moved the merge to arguably the correct place to put it, in each model when the labels are initially defined, I think merging the labels this late is an anti-pattern and causes more confusion.\nhttps://github.com/strimzi/strimzi-kafka-operator/pull/2730/files#diff-405b3358597333915e4058062355209aL656\nhttps://github.com/strimzi/strimzi-kafka-operator/pull/2730/files#diff-93b151183726e7a1a3e42dcffc82367bR320-R321", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396981202", "createdAt": "2020-03-24T08:40:07Z", "author": {"login": "samuel-hawker"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/AbstractModel.java", "diffHunk": "@@ -620,7 +612,8 @@ protected PersistentVolumeClaim createPersistentVolumeClaim(int podNumber, Strin\n                 .withNewMetadata()\n                     .withName(name)\n                     .withNamespace(namespace)\n-                    .withLabels(mergeLabelsOrAnnotations(getLabelsWithName(templateStatefulSetLabels), templatePersistentVolumeClaimLabels))\n+                    // labels with the Strimzi name set to that of the component\n+                    .withLabels(getLabelsWithStrimziName(this.name, templatePersistentVolumeClaimLabels).toMap())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgyOTk4Ng=="}, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4MjE2MQ==", "bodyText": "So I had a long time thinking about this. Originally I didn't include it as I did not want to add a HasMetadata as an argument, but also it sort of made sense to me that since all other label set fields are defined outside of the constructor this one should be also...\nHappy to move it in if you disagree with this approach", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396982161", "createdAt": "2020-03-24T08:41:55Z", "author": {"login": "samuel-hawker"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/JmxTrans.java", "diffHunk": "@@ -106,10 +106,11 @@ public static JmxTrans fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup versions\n                 throw new InvalidResourceException(error);\n             }\n             result = new JmxTrans(kafkaAssembly.getMetadata().getNamespace(),\n-                    kafkaAssembly.getMetadata().getName(),\n-                    Labels.fromResource(kafkaAssembly).withKind(kafkaAssembly.getKind()));\n+                    kafkaAssembly.getMetadata().getName());\n             result.isDeployed = true;\n \n+            result.setDefaultLabels(kafkaAssembly);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzMDY1Ng=="}, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4MjUyMQ==", "bodyText": "Embarassing - originally only has these for kafka and zookeeper then saw the value in applying to them all.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396982521", "createdAt": "2020-03-24T08:42:32Z", "author": {"login": "samuel-hawker"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/KafkaCluster.java", "diffHunk": "@@ -113,6 +113,9 @@\n \n @SuppressWarnings(\"checkstyle:ClassDataAbstractionCoupling\")\n public class KafkaCluster extends AbstractModel {\n+    // Name of component kafka", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzMTQ5OA=="}, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4NDAxMw==", "bodyText": "For the short term I think we should modify this filter to allow a few whitelisted labels to be applied\nhttps://github.com/strimzi/strimzi-kafka-operator/pull/2730/files#diff-6de62e326f52e6cc92e7ffd7e722e8f4R142\nI suggest we only allow the app.kubernetes.io/part-of label as this one is used to group resources together? Looking at the others it is unclear what value it would have to allow them to be modifiable.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396984013", "createdAt": "2020-03-24T08:45:16Z", "author": {"login": "samuel-hawker"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/model/Labels.java", "diffHunk": "@@ -117,7 +136,7 @@ public static Labels userLabels(Map<String, String> userLabels) {\n         }\n \n         // Remove Kubernetes Domain specific labels\n-        Map<String, String> filteredLabels = userLabels\n+        Map<String, String> filteredLabels = additionalLabels", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzNDkwOQ=="}, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk4NjE0NA==", "bodyText": "Some comment along the lines of :\n// This string may be truncated for sanitization purposes to be compatible with Kubernetes\n\n, or am I misunderstanding your suggestion?", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r396986144", "createdAt": "2020-03-24T08:48:52Z", "author": {"login": "samuel-hawker"}, "path": "operator-common/src/main/java/io/strimzi/operator/common/model/Labels.java", "diffHunk": "@@ -361,4 +393,24 @@ public int hashCode() {\n     public String toString() {\n         return \"Labels\" + labels;\n     }\n+\n+    /**\n+     * @param resource        a resource with metadata\n+     * @param applicationName the name of the application of the component\n+     * @param managedBy       a resource with meta\n+     * @return The default Labels set\n+     */\n+    public static Labels generateDefaultLabels(HasMetadata resource, String applicationName, String managedBy) {\n+        String instanceName = resource.getMetadata().getName();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzMzYyNA=="}, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 332}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTY4MzYx", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#pullrequestreview-380168361", "createdAt": "2020-03-24T10:16:45Z", "commit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoxNjo0NVrOF6pcuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDoyMTowOVrOF6pmrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MDgyNw==", "bodyText": "I think Javadoc to explain what discovery is in this context would be helpful.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r397040827", "createdAt": "2020-03-24T10:16:45Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/AbstractModel.java", "diffHunk": "@@ -247,39 +252,26 @@ public String getHeadlessServiceName() {\n      * @return The selector labels as an instance of the Labels object.\n      */\n     public Labels getSelectorLabels() {\n-        return labels.withName(name).strimziSelectorLabels();\n+        return getLabelsWithStrimziName(name, Collections.emptyMap()).strimziSelectorLabels();\n     }\n \n-    /**\n-     * @return The selector labels as Map.\n-     */\n-    public Map<String, String> getSelectorLabelsAsMap() {\n-        return getSelectorLabels().toMap();\n+    protected Labels getLabelsWithStrimziName(String name, Map<String, String> additionalLabels) {\n+        return labels.withStrimziName(name).withAdditionalLabels(additionalLabels);\n     }\n \n-    protected Map<String, String> getLabelsWithName() {\n-        return getLabelsWithName(name);\n+    protected Labels getLabelsWithNameAndDiscovery(String name, Map<String, String> additionalLabels) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MDk3Ng==", "bodyText": "I think Javadoc to explain what a Strimzi name is in this context would be helpful.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r397040976", "createdAt": "2020-03-24T10:17:01Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/AbstractModel.java", "diffHunk": "@@ -247,39 +252,26 @@ public String getHeadlessServiceName() {\n      * @return The selector labels as an instance of the Labels object.\n      */\n     public Labels getSelectorLabels() {\n-        return labels.withName(name).strimziSelectorLabels();\n+        return getLabelsWithStrimziName(name, Collections.emptyMap()).strimziSelectorLabels();\n     }\n \n-    /**\n-     * @return The selector labels as Map.\n-     */\n-    public Map<String, String> getSelectorLabelsAsMap() {\n-        return getSelectorLabels().toMap();\n+    protected Labels getLabelsWithStrimziName(String name, Map<String, String> additionalLabels) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0MzM3Mg==", "bodyText": "Another option would be to define an abstract getter in AbstractModel, forcing subclasses to override it. I actually think this is preferable, since there's no need for this property to be mutable AFAICT.", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#discussion_r397043372", "createdAt": "2020-03-24T10:21:09Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/model/JmxTrans.java", "diffHunk": "@@ -106,10 +106,11 @@ public static JmxTrans fromCrd(Kafka kafkaAssembly, KafkaVersion.Lookup versions\n                 throw new InvalidResourceException(error);\n             }\n             result = new JmxTrans(kafkaAssembly.getMetadata().getNamespace(),\n-                    kafkaAssembly.getMetadata().getName(),\n-                    Labels.fromResource(kafkaAssembly).withKind(kafkaAssembly.getKind()));\n+                    kafkaAssembly.getMetadata().getName());\n             result.isDeployed = true;\n \n+            result.setDefaultLabels(kafkaAssembly);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzMDY1Ng=="}, "originalCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429"}, "originalPosition": 45}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "799450a5b1e64adfa333908c452887aa09ded429", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/799450a5b1e64adfa333908c452887aa09ded429", "committedDate": "2020-03-23T09:27:38Z", "message": "Merge branch 'master' into labels-refactor"}, "afterCommit": {"oid": "4b944a93f15c911e9286e8b8a4e83c4bfc6df61c", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4b944a93f15c911e9286e8b8a4e83c4bfc6df61c", "committedDate": "2020-03-24T21:51:37Z", "message": "feat: Review comments\n\nChange constructor signatures\nseveral cleanups\ntest fixes\ncomment clarifications\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "068786499e669b236795a299a5ec8548bd630c5c", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/068786499e669b236795a299a5ec8548bd630c5c", "committedDate": "2020-03-25T09:42:52Z", "message": "Merge branch 'master' of https://github.com/strimzi/strimzi-kafka-operator into labels-refactor"}, "afterCommit": {"oid": "4eb3fc27439df441403d6a0e019c055f1433ebc6", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/4eb3fc27439df441403d6a0e019c055f1433ebc6", "committedDate": "2020-03-25T09:53:17Z", "message": "Merge branch 'master' of https://github.com/strimzi/strimzi-kafka-operator into labels-refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDgxMDI2", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2730#pullrequestreview-382481026", "createdAt": "2020-03-26T23:07:47Z", "commit": {"oid": "816939b151f5d96d17c7b91839bc61a6c28e6ab5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e44129238d2ca8292388dceb734b020aee001ae5", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/e44129238d2ca8292388dceb734b020aee001ae5", "committedDate": "2020-03-27T08:50:03Z", "message": "feat: Correct Kubernetes labels and labels refactor\n\n- Modify the app.kubernetes.io/name label to reflect the\ncorrect apps for each component\nThese labels are queryable so that a user can see all 'kafka',\n'zookeeper' etc components in a cluster\n- Modify the app.kubernetes.io/part-of label to have a unique\nidentifier for each instance of a cluster\nThis is mostly for the openshift Ui which clusters applications\nbased on their part-of label\n- Refactored labels so that all models build up their labels\nin a similar fashion.\nMade explicit the subset of labels that constitute a strimzi  selector\nlabel this should assist in  avoiding breaking bugs in future\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d00d44efb37d4ad331405b808c64220945292dc", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/1d00d44efb37d4ad331405b808c64220945292dc", "committedDate": "2020-03-27T08:50:27Z", "message": "feat: Review comments\n\nChange constructor signatures\nseveral cleanups\ntest fixes\ncomment clarifications\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a44ad15ebaf0a26207eed1b1b48de26418eb05f1", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/a44ad15ebaf0a26207eed1b1b48de26418eb05f1", "committedDate": "2020-03-27T08:51:04Z", "message": "fix: lint\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ced34bd43f8f5ab494f354ebf27724d4e7472acd", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ced34bd43f8f5ab494f354ebf27724d4e7472acd", "committedDate": "2020-03-27T08:51:16Z", "message": "feat: Add java doc to refactored Labels helpers\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "816939b151f5d96d17c7b91839bc61a6c28e6ab5", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/816939b151f5d96d17c7b91839bc61a6c28e6ab5", "committedDate": "2020-03-25T19:47:19Z", "message": "feat: Add java doc to refactored Labels helpers\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>"}, "afterCommit": {"oid": "ced34bd43f8f5ab494f354ebf27724d4e7472acd", "author": {"user": {"login": "samuel-hawker", "name": "Samuel Hawker"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ced34bd43f8f5ab494f354ebf27724d4e7472acd", "committedDate": "2020-03-27T08:51:16Z", "message": "feat: Add java doc to refactored Labels helpers\n\nSigned-off-by: Samuel Hawker <samuel.hawker@ibm.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2104, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}