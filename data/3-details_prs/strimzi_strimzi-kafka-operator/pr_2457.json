{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3Mjg0MDUw", "number": 2457, "title": "Fix the Kafka upgrade procedure when the CO is upgraded and version in Kafka CR is not specified", "bodyText": "Type of change\n\nBugfix\n\nDescription\n0.16 release brought significant changes to the way we confgure the brokers. The issue #2426 describes a bug during the upgrade which this PR attempts to fix. There are two way how users will usually run into an 0.16 upgrade.\n\nUser has a version specified in his Kafka CR and set to 2.3.1. When the CO is upgraded to 0.16.0, it iwll run a regular reconciliation wchih updates everything to 0.16.0 but remains on 2.3.1. Only later the user changes the version field to KAfka 2.4.0. The CO will do the upgrade, the statefulset is already managed by 0.+6.0 so there are no (known / reported) issues.\nThe user does nto have version field specified. In such case it is aways using the latest available KAfka version. With 0.15 this would be 2.3.1. When the CO is updated to 0.16, the Kafka upgrade to 2.4.0 will be happening immediately on the beginning of the first reconciliation. In this case the upgrade will need to deal with an old stateful set. This is a problem which was not handled in the code until this PR and is described in #2426. This PR handles is by refreshing the whole Statefulset to the 0.16.0 level including all the other required resources (CM with broker config, new DNS names in broker certs etc.)\n\nI also as another option considered to just detect these situations and enforce first an initial update using the lowe version. However, this would not work when the ogirinal version was not 2.3.1 but for example KAfka 2.2.0 in which case we would basically do an upgrade during the rolling update. Another problem is that teh Zookeeper upgrade is independent process and is already done when we execute this. That is why the solution in this PR seemed better.\nChecklist\n\n Make sure all tests pass\n Try your changes from Pod inside your Kubernetes and OpenShift cluster, not just locally\n Reference relevant issue(s) and close them after merging", "createdAt": "2020-01-27T01:20:28Z", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2457", "merged": true, "mergeCommit": {"oid": "77d6649d54a96c82a7994f56b0f1a452ea7f0dae"}, "closed": true, "closedAt": "2020-01-29T17:42:42Z", "author": {"login": "scholzj"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-vlr0AFqTM0OTMwMTA1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-vzV1gBqjI5ODUyOTEwNTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MzAxMDU0", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2457#pullrequestreview-349301054", "createdAt": "2020-01-28T11:24:11Z", "commit": {"oid": "03ceff739d2b801682f0b3964a1aef5ce3d580df"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMToyNDoxMVrOFihjfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMToyNDoxMVrOFihjfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc0NTY2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    \" must be explicitely set.\"));\n          \n          \n            \n                                    \" must be explicitly set.\"));", "url": "https://github.com/strimzi/strimzi-kafka-operator/pull/2457#discussion_r371745663", "createdAt": "2020-01-28T11:24:11Z", "author": {"login": "tombentley"}, "path": "cluster-operator/src/main/java/io/strimzi/operator/cluster/operator/assembly/KafkaAssemblyOperator.java", "diffHunk": "@@ -923,12 +941,8 @@ private KafkaVersionChange getKafkaVersionChange(StatefulSet kafkaSts) {\n                 // to match the old version\n                 return Future.failedFuture(new KafkaUpgradeException(versionChange + \" requires a message format change \" +\n                         \"from \" + versionChange.from().messageVersion() + \" to \" + versionChange.to().messageVersion() + \". \" +\n-                        \"You must explicitly set \" +\n                         LOG_MESSAGE_FORMAT_VERSION + \": \\\"\" + versionChange.from().messageVersion() + \"\\\"\" +\n-                        \" in Kafka.spec.kafka.config to perform the upgrade. \" +\n-                        \"Then you can upgrade client applications. \" +\n-                        \"And finally you can remove \" + LOG_MESSAGE_FORMAT_VERSION +\n-                        \" from Kafka.spec.kafka.config\"));\n+                        \" must be explicitely set.\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03ceff739d2b801682f0b3964a1aef5ce3d580df"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8a754cd47075609d249ee22bdd971516e8e12e", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/ae8a754cd47075609d249ee22bdd971516e8e12e", "committedDate": "2020-01-28T11:36:03Z", "message": "Fix the Kafka upgrade procedure when the CO is upgraded and version in Kafka CR is not specified\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d99b9e44fb666a4d55d2c43dfd33200c67a25f20", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d99b9e44fb666a4d55d2c43dfd33200c67a25f20", "committedDate": "2020-01-28T11:39:04Z", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "03ceff739d2b801682f0b3964a1aef5ce3d580df", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/03ceff739d2b801682f0b3964a1aef5ce3d580df", "committedDate": "2020-01-27T00:59:13Z", "message": "Fix the Kafka upgrade procedure when the CO is upgraded and version in Kafka CR is not specified\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}, "afterCommit": {"oid": "d99b9e44fb666a4d55d2c43dfd33200c67a25f20", "author": {"user": {"login": "scholzj", "name": "Jakub Scholz"}}, "url": "https://github.com/strimzi/strimzi-kafka-operator/commit/d99b9e44fb666a4d55d2c43dfd33200c67a25f20", "committedDate": "2020-01-28T11:39:04Z", "message": "Review comments\n\nSigned-off-by: Jakub Scholz <www@scholzj.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1870, "cost": 1, "resetAt": "2021-10-28T20:13:43Z"}}}