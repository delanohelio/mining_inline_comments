{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3MzM1ODUx", "number": 816, "title": "Protectors - Support HTTP only in ZAAS client", "bodyText": "Description\nThis is a work in progress. It is not ready for review.\nFixes #813\nType of change\nPlease delete options that are not relevant.\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality) - https://dev.to/codemouse92/turning-bugs-into-features-48gl\n This change requires a documentation update\n\nChecklist:\n\n My code follows the style guidelines of this project\n I have performed a self-review of my own code\n I have commented on my code, particularly in hard-to-understand areas\n I have made corresponding changes to the documentation - #816\n My changes generate no new warnings\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n Any dependent changes have been merged and published in downstream modules\n\nFor more details about how should the code look like read the Contributing guideline", "createdAt": "2020-09-01T21:07:23Z", "url": "https://github.com/zowe/api-layer/pull/816", "merged": true, "mergeCommit": {"oid": "f671fc952dadb7eed08c3e40b1c8f2bb199b2385"}, "closed": true, "closedAt": "2020-09-04T09:24:23Z", "author": {"login": "plavjanik"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEoZ9CgH2gAyNDc3MzM1ODUxOjM2NGQwYjZkYzA1YjgzOWE0NTYxYmJjODE3NWFjMDdhNTM4MzgxODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFf-p8gFqTQ4MjQxNzczMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "364d0b6dc05b839a4561bbc8175ac07a53838186", "author": {"user": {"login": "plavjanik", "name": "Petr Plavjanik"}}, "url": "https://github.com/zowe/api-layer/commit/364d0b6dc05b839a4561bbc8175ac07a53838186", "committedDate": "2020-09-01T14:37:29Z", "message": "Support HTTP only in ZAAS client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "993e633df4f5490c9582c731236bffa53eb32fe8", "author": {"user": {"login": "plavjanik", "name": "Petr Plavjanik"}}, "url": "https://github.com/zowe/api-layer/commit/993e633df4f5490c9582c731236bffa53eb32fe8", "committedDate": "2020-09-01T21:09:21Z", "message": "Merge branch 'master' into protectors/zaas-client-http"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dee991de9e0bf36cea8854fcf089a9ddb226a0bf", "author": {"user": {"login": "plavjanik", "name": "Petr Plavjanik"}}, "url": "https://github.com/zowe/api-layer/commit/dee991de9e0bf36cea8854fcf089a9ddb226a0bf", "committedDate": "2020-09-03T11:41:31Z", "message": "ZaasHttpClientProviderTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f55c12be300239b0064bc04bdd5b1743568a96df", "author": {"user": {"login": "plavjanik", "name": "Petr Plavjanik"}}, "url": "https://github.com/zowe/api-layer/commit/f55c12be300239b0064bc04bdd5b1743568a96df", "committedDate": "2020-09-03T11:50:59Z", "message": "HttpOnly ZaasClientTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "841c028e8d10915144dfad4e52e2aa12334ba06f", "author": {"user": {"login": "plavjanik", "name": "Petr Plavjanik"}}, "url": "https://github.com/zowe/api-layer/commit/841c028e8d10915144dfad4e52e2aa12334ba06f", "committedDate": "2020-09-03T13:08:38Z", "message": "SonarQube"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxOTM4MDI1", "url": "https://github.com/zowe/api-layer/pull/816#pullrequestreview-481938025", "createdAt": "2020-09-03T15:09:20Z", "commit": {"oid": "841c028e8d10915144dfad4e52e2aa12334ba06f"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNTowOToyMFrOHMrMUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNToxOToxM1rOHMroLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1MjYyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import java.io.IOException;\n          \n          \n            \n            import java.io.IOException;\n          \n          \n            \n            import org.apache.http.HttpHeaders;\n          \n          \n            \n            import org.apache.http.cookie.SM;", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483052624", "createdAt": "2020-09-03T15:09:20Z", "author": {"login": "pj892031"}, "path": "zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/PassTicketServiceImpl.java", "diffHunk": "@@ -25,41 +25,35 @@\n import java.io.IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841c028e8d10915144dfad4e52e2aa12334ba06f"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1MjY3OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        httpPost.setHeader(\"Content-Type\", \"application/json\");\n          \n          \n            \n                        httpPost.setHeader(\"Cookie\", TOKEN_PREFIX + \"=\" + jwtToken);\n          \n          \n            \n                        httpPost.setHeader(HttpHeaders.CONTENT_TYPE, \"application/json\");\n          \n          \n            \n                        httpPost.setHeader(SM.COOKIE, TOKEN_PREFIX + \"=\" + jwtToken);", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483052678", "createdAt": "2020-09-03T15:09:25Z", "author": {"login": "pj892031"}, "path": "zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/PassTicketServiceImpl.java", "diffHunk": "@@ -25,41 +25,35 @@\n import java.io.IOException;\n \n @Slf4j\n-class PassTicketServiceHttps implements PassTicketService {\n+class PassTicketServiceImpl implements PassTicketService {\n     private static final String TOKEN_PREFIX = \"apimlAuthenticationToken\";\n \n-    private HttpsClientProvider httpsClientProvider;\n+    private final CloseableClientProvider httpClientProvider;\n     private final String ticketUrl;\n \n-    public PassTicketServiceHttps(HttpsClientProvider client, String baseUrl) {\n-        this.httpsClientProvider = client;\n-\n+    public PassTicketServiceImpl(CloseableClientProvider client, String baseUrl) {\n+        httpClientProvider = client;\n         ticketUrl = baseUrl + \"/ticket\";\n     }\n \n     @Override\n     public String passTicket(String jwtToken, String applicationId) throws ZaasClientException, ZaasConfigurationException {\n-        CloseableHttpResponse response = null;\n-        CloseableHttpClient closeableHttpsClient = null;\n-        try {\n-            closeableHttpsClient = httpsClientProvider.getHttpsClientWithKeyStoreAndTrustStore();\n+        try (CloseableHttpClient closeableHttpsClient = httpClientProvider.getHttpClient()) {\n             ZaasClientTicketRequest zaasClientTicketRequest = new ZaasClientTicketRequest();\n             ObjectMapper mapper = new ObjectMapper();\n             zaasClientTicketRequest.setApplicationName(applicationId);\n \n             HttpPost httpPost = new HttpPost(ticketUrl);\n             httpPost.setEntity(new StringEntity(mapper.writeValueAsString(zaasClientTicketRequest)));\n-            httpPost.setHeader(\"Content-type\", \"application/json\");\n+            httpPost.setHeader(\"Content-Type\", \"application/json\");\n             httpPost.setHeader(\"Cookie\", TOKEN_PREFIX + \"=\" + jwtToken);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841c028e8d10915144dfad4e52e2aa12334ba06f"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1NjA3NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.apache.http.impl.client.HttpClientBuilder;\n          \n          \n            \n            \n          \n          \n            \n            public class ZaasHttpClientProvider implements CloseableClientProvider {\n          \n          \n            \n                private final CloseableHttpClient httpClient;\n          \n          \n            \n            \n          \n          \n            \n                public ZaasHttpClientProvider() {\n          \n          \n            \n                    httpClient = HttpClientBuilder.create().disableCookieManagement().disableAuthCaching().build();\n          \n          \n            \n                }\n          \n          \n            \n            \n          \n          \n            \n                @Override\n          \n          \n            \n                public CloseableHttpClient getHttpClient() {\n          \n          \n            \n                    return httpClient;\n          \n          \n            \n                }\n          \n          \n            \n            import org.apache.http.impl.client.HttpClientBuilder;\n          \n          \n            \n            import lombok.Getter;\n          \n          \n            \n            \n          \n          \n            \n            public class ZaasHttpClientProvider implements CloseableClientProvider {\n          \n          \n            \n            \n          \n          \n            \n                @Getter\n          \n          \n            \n                private final CloseableHttpClient httpClient;\n          \n          \n            \n            \n          \n          \n            \n                public ZaasHttpClientProvider() {\n          \n          \n            \n                    httpClient = HttpClientBuilder.create().disableCookieManagement().disableAuthCaching().build();\n          \n          \n            \n                }", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483056075", "createdAt": "2020-09-03T15:14:18Z", "author": {"login": "pj892031"}, "path": "zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasHttpClientProvider.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * This program and the accompanying materials are made available under the terms of the\n+ * Eclipse Public License v2.0 which accompanies this distribution, and is available at\n+ * https://www.eclipse.org/legal/epl-v20.html\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Copyright Contributors to the Zowe Project.\n+ */\n+package org.zowe.apiml.zaasclient.service.internal;\n+\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+\n+public class ZaasHttpClientProvider implements CloseableClientProvider {\n+    private final CloseableHttpClient httpClient;\n+\n+    public ZaasHttpClientProvider() {\n+        httpClient = HttpClientBuilder.create().disableCookieManagement().disableAuthCaching().build();\n+    }\n+\n+    @Override\n+    public CloseableHttpClient getHttpClient() {\n+        return httpClient;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841c028e8d10915144dfad4e52e2aa12334ba06f"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1NzkxNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    httpGet.addHeader(\"Cookie\", TOKEN_PREFIX + \"=\" + jwtToken);\n          \n          \n            \n                    httpGet.addHeader(SM.COOKIE, TOKEN_PREFIX + \"=\" + jwtToken);", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483057916", "createdAt": "2020-09-03T15:16:53Z", "author": {"login": "pj892031"}, "path": "zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasJwtService.java", "diffHunk": "@@ -86,7 +86,7 @@ public ZaasToken query(String jwtToken) throws ZaasClientException {\n     }\n \n     private ClientWithResponse queryWithJwtToken(String jwtToken) throws ZaasConfigurationException, IOException {\n-        CloseableHttpClient client = httpsClientProvider.getHttpsClientWithTrustStore();\n+        CloseableHttpClient client = httpClientProvider.getHttpClient();\n         HttpGet httpGet = new HttpGet(queryEndpoint);\n         httpGet.addHeader(\"Cookie\", TOKEN_PREFIX + \"=\" + jwtToken);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841c028e8d10915144dfad4e52e2aa12334ba06f"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1OTM0MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import java.util.stream.Stream;\n          \n          \n            \n            import java.util.stream.Stream;\n          \n          \n            \n            import org.apache.http.cookie.SM;", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483059341", "createdAt": "2020-09-03T15:18:45Z", "author": {"login": "pj892031"}, "path": "zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasJwtService.java", "diffHunk": "@@ -32,15 +32,15 @@\n import java.util.stream.Stream;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841c028e8d10915144dfad4e52e2aa12334ba06f"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA1OTc1Nw==", "bodyText": "Also possible to replace \"Set-cookie\" with SM.SET_COOKIE (line 118)", "url": "https://github.com/zowe/api-layer/pull/816#discussion_r483059757", "createdAt": "2020-09-03T15:19:13Z", "author": {"login": "pj892031"}, "path": "zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasJwtService.java", "diffHunk": "@@ -32,15 +32,15 @@\n import java.util.stream.Stream;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841c028e8d10915144dfad4e52e2aa12334ba06f"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dafc76fbf33b08b4d64756672929afdaa7a99058", "author": {"user": {"login": "plavjanik", "name": "Petr Plavjanik"}}, "url": "https://github.com/zowe/api-layer/commit/dafc76fbf33b08b4d64756672929afdaa7a99058", "committedDate": "2020-09-03T15:23:25Z", "message": "Update zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/PassTicketServiceImpl.java\n\nCo-authored-by: Pavel Jare\u0161 <58428711+pj892031@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19432be684a069d4b24e3d48693e5f785e7e8ce4", "author": {"user": {"login": "plavjanik", "name": "Petr Plavjanik"}}, "url": "https://github.com/zowe/api-layer/commit/19432be684a069d4b24e3d48693e5f785e7e8ce4", "committedDate": "2020-09-03T15:23:32Z", "message": "Update zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/PassTicketServiceImpl.java\n\nCo-authored-by: Pavel Jare\u0161 <58428711+pj892031@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "198e9972aa004241e0232c4ec7b9a5a294274e18", "author": {"user": {"login": "plavjanik", "name": "Petr Plavjanik"}}, "url": "https://github.com/zowe/api-layer/commit/198e9972aa004241e0232c4ec7b9a5a294274e18", "committedDate": "2020-09-03T15:23:39Z", "message": "Update zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasHttpClientProvider.java\n\nCo-authored-by: Pavel Jare\u0161 <58428711+pj892031@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf9c50384d2b199795af8384d62c3c1e9b3ba573", "author": {"user": {"login": "plavjanik", "name": "Petr Plavjanik"}}, "url": "https://github.com/zowe/api-layer/commit/cf9c50384d2b199795af8384d62c3c1e9b3ba573", "committedDate": "2020-09-03T15:23:47Z", "message": "Update zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasJwtService.java\n\nCo-authored-by: Pavel Jare\u0161 <58428711+pj892031@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8c5eede8bb1272bc15a9c6fb3e5dfbcec8a23b2", "author": {"user": {"login": "plavjanik", "name": "Petr Plavjanik"}}, "url": "https://github.com/zowe/api-layer/commit/f8c5eede8bb1272bc15a9c6fb3e5dfbcec8a23b2", "committedDate": "2020-09-03T15:23:54Z", "message": "Update zaas-client/src/main/java/org/zowe/apiml/zaasclient/service/internal/ZaasJwtService.java\n\nCo-authored-by: Pavel Jare\u0161 <58428711+pj892031@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85424c5219afdd82d778656a20dc6814dec6019d", "author": {"user": {"login": "plavjanik", "name": "Petr Plavjanik"}}, "url": "https://github.com/zowe/api-layer/commit/85424c5219afdd82d778656a20dc6814dec6019d", "committedDate": "2020-09-03T15:37:30Z", "message": "Use constant instead of inline string"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMDY1OTI3", "url": "https://github.com/zowe/api-layer/pull/816#pullrequestreview-482065927", "createdAt": "2020-09-03T17:43:34Z", "commit": {"oid": "85424c5219afdd82d778656a20dc6814dec6019d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyNDE3NzMz", "url": "https://github.com/zowe/api-layer/pull/816#pullrequestreview-482417733", "createdAt": "2020-09-04T07:22:21Z", "commit": {"oid": "85424c5219afdd82d778656a20dc6814dec6019d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4834, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}