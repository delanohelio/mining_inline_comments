{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0Nzg5NDc1", "number": 874, "title": "Improve Gateway logout endpoint error handling", "bodyText": "Description\nThis introduces the two following behaviours for the Gateway logout endpoint:\n\n\nWhen a previously invalidated token is attempted to be invalidated (logged out) again, the Gateway now returns a 401 with explanation, rather than a 204 response.\n\n\nWhen a token is valid but an unknown error happens during logout, the Gateway now returns a generic 500 internal server error.\n\n\nFixes #831\nType of change\nPlease delete options that are not relevant.\n\n Bug fix (non-breaking change which fixes an issue)\n New feature (non-breaking change which adds functionality)\n Breaking change (fix or feature that would cause existing functionality to not work as expected)\n This change requires a documentation update\n\nChecklist:\n\n My code follows the style guidelines of this project\n I have performed a self-review of my own code\n I have commented my code, particularly in hard-to-understand areas\n I have made corresponding changes to the documentation\n My changes generate no new warnings\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n\nFor more details about how should the code look like read the Contributing guideline", "createdAt": "2020-09-29T12:21:36Z", "url": "https://github.com/zowe/api-layer/pull/874", "merged": true, "mergeCommit": {"oid": "b95c71088d7c2e62f9c8574b6079891c254f5ac7"}, "closed": true, "closedAt": "2020-10-06T05:32:30Z", "author": {"login": "CarsonCook"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNo179AFqTQ5ODUxNTcyNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPxlWxgFqTUwMjU5NDIwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NTE1NzI0", "url": "https://github.com/zowe/api-layer/pull/874#pullrequestreview-498515724", "createdAt": "2020-09-29T14:13:22Z", "commit": {"oid": "e110034b828275165a88313a6e347fc20f40bb2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNDoxMzoyMlrOHZvUrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNDoxMzoyMlrOHZvUrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc1MTc5MA==", "bodyText": "I think this is causing some problem on the error handling. I've tried to intentionally pass an invalid token via Cookie (I deleted part of the token) and call the /logout endpoint. On master it returns 400 with TokenFormatNotValidException exception, which is the expected behaviour. Now it returns 500 with:\n{\n    \"messages\": [\n        {\n            \"messageType\": \"ERROR\",\n            \"messageNumber\": \"ZWEAG100E\",\n            \"messageContent\": \"Authentication exception: 'Error while logging out token' for URL '/api/v1/gateway/auth/logout'\",\n            \"messageKey\": \"org.zowe.apiml.security.generic\"\n        }\n    ]\n}\n\nIt is because authenticationService.invalidateJwtToken(token, true); is throwing TokenNotValidException and you are catching a generic Exception e that will throw this message, which is not correct in this case. It should rather return 400 with TokenFormatNotValidException, based on how it was before.\nTherefore I think you can add a catch:\n } catch (TokenNotValidException e) {\n                failure.onAuthenticationFailure(request, response, new TokenFormatNotValidException(e.getMessage()));\n            }\n\nand keep the last generic catch to catch other possible exception such as ServiceNotAccessibleException", "url": "https://github.com/zowe/api-layer/pull/874#discussion_r496751790", "createdAt": "2020-09-29T14:13:22Z", "author": {"login": "taban03"}, "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/security/config/JWTLogoutHandler.java", "diffHunk": "@@ -34,21 +36,27 @@\n     public void logout(HttpServletRequest request, HttpServletResponse response, Authentication authentication) {\n         Optional<String> token = authenticationService.getJwtTokenFromRequest(request);\n         try {\n-            checkJwtTokenFormat(failure, request, response, token);\n+            if (token.isPresent()) {\n+                invalidateJwtToken(failure, request, response, token.get());\n+            } else {\n+                failure.onAuthenticationFailure(request, response, new TokenNotProvidedException(\"The token you are trying to logout is not present in the header\"));\n+            }\n         } catch (ServletException e) {\n             log.error(\"The response cannot be written during the logout exception handler: {}\", e.getMessage());\n         }\n     }\n \n-    private void checkJwtTokenFormat(FailedAuthenticationHandler failure, HttpServletRequest request, HttpServletResponse response, Optional<String> token) throws ServletException {\n-        if (token.isPresent()) {\n+    private void invalidateJwtToken(FailedAuthenticationHandler failure, HttpServletRequest request, HttpServletResponse response, String token) throws ServletException {\n+        if (authenticationService.isInvalidated(token)) {\n+            failure.onAuthenticationFailure(request, response, new TokenNotValidException(\"The token you are trying to logout is not valid\"));\n+        } else {\n             try {\n-                authenticationService.invalidateJwtToken(token.get(), true);\n-            } catch (TokenNotValidException e) {\n-                failure.onAuthenticationFailure(request, response, new TokenFormatNotValidException(e.getMessage()));\n+                authenticationService.invalidateJwtToken(token, true);\n+            } catch (TokenFormatNotValidException e) {\n+                failure.onAuthenticationFailure(request, response, e);\n+            } catch (Exception e) {\n+                failure.onAuthenticationFailure(request, response, new AuthenticationTokenException(\"Error while logging out token\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e110034b828275165a88313a6e347fc20f40bb2b"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "894198fb10474f2adbc39c1314f7c5044ea9df85", "author": {"user": {"login": "CarsonCook", "name": "Carson Cook"}}, "url": "https://github.com/zowe/api-layer/commit/894198fb10474f2adbc39c1314f7c5044ea9df85", "committedDate": "2020-10-02T07:29:17Z", "message": "Reject already invalidated token on logout\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b8b95253dfd99c45a5fa88b7ef109db34d39c0b", "author": {"user": {"login": "CarsonCook", "name": "Carson Cook"}}, "url": "https://github.com/zowe/api-layer/commit/1b8b95253dfd99c45a5fa88b7ef109db34d39c0b", "committedDate": "2020-10-02T07:29:17Z", "message": "Unit test reject already invalidated token on logout\n:\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00724713074f7daaf7de33b9a4e7b52f6fbe6bee", "author": {"user": {"login": "CarsonCook", "name": "Carson Cook"}}, "url": "https://github.com/zowe/api-layer/commit/00724713074f7daaf7de33b9a4e7b52f6fbe6bee", "committedDate": "2020-10-02T07:29:17Z", "message": "Update for integration tests for 401 on double logout\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9473906e2d9d5d6a4d1b2c557881ed4366a93b62", "author": {"user": {"login": "CarsonCook", "name": "Carson Cook"}}, "url": "https://github.com/zowe/api-layer/commit/9473906e2d9d5d6a4d1b2c557881ed4366a93b62", "committedDate": "2020-10-02T07:29:17Z", "message": "Add generic exception handling for gw logout\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f6c5b80712c39fc2ca0e12e353043e7fb8db23b", "author": {"user": {"login": "CarsonCook", "name": "Carson Cook"}}, "url": "https://github.com/zowe/api-layer/commit/2f6c5b80712c39fc2ca0e12e353043e7fb8db23b", "committedDate": "2020-10-02T07:29:17Z", "message": "Fix code smell\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71041cfe3e2f074910041f20739ab66db5ac0fe0", "author": {"user": {"login": "CarsonCook", "name": "Carson Cook"}}, "url": "https://github.com/zowe/api-layer/commit/71041cfe3e2f074910041f20739ab66db5ac0fe0", "committedDate": "2020-10-02T07:29:17Z", "message": "Fix zaas double logout error code\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72fafd15ec60770fa4648e98993bfd34e0235f7c", "author": {"user": {"login": "CarsonCook", "name": "Carson Cook"}}, "url": "https://github.com/zowe/api-layer/commit/72fafd15ec60770fa4648e98993bfd34e0235f7c", "committedDate": "2020-10-02T07:29:17Z", "message": "Fix typos\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e063a784fb7433fd5ef915be950caa39b78fc7cc", "author": {"user": {"login": "CarsonCook", "name": "Carson Cook"}}, "url": "https://github.com/zowe/api-layer/commit/e063a784fb7433fd5ef915be950caa39b78fc7cc", "committedDate": "2020-10-02T07:29:17Z", "message": "Fix back to sending 400 on mangled token\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c852b680bb96f1e1ba42327a3b8895ea0fb28850", "author": {"user": {"login": "CarsonCook", "name": "Carson Cook"}}, "url": "https://github.com/zowe/api-layer/commit/c852b680bb96f1e1ba42327a3b8895ea0fb28850", "committedDate": "2020-10-02T07:29:17Z", "message": "Return 401 on generic error in gw logout\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7fe2df98dfa96ddbbd048aa0935751a0508233d5", "author": {"user": {"login": "jandadav", "name": "David Janda"}}, "url": "https://github.com/zowe/api-layer/commit/7fe2df98dfa96ddbbd048aa0935751a0508233d5", "committedDate": "2020-10-01T08:30:47Z", "message": "Merge branch 'master' into carsoncook/gh831/errorHandlingGWLogout"}, "afterCommit": {"oid": "c852b680bb96f1e1ba42327a3b8895ea0fb28850", "author": {"user": {"login": "CarsonCook", "name": "Carson Cook"}}, "url": "https://github.com/zowe/api-layer/commit/c852b680bb96f1e1ba42327a3b8895ea0fb28850", "committedDate": "2020-10-02T07:29:17Z", "message": "Return 401 on generic error in gw logout\n\nSigned-off-by: Carson Cook <carson.cook@ibm.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57db81d95f9cbed4904db416bb1a45507f8c0a1a", "author": {"user": {"login": "balhar-jakub", "name": "Jakub Balhar"}}, "url": "https://github.com/zowe/api-layer/commit/57db81d95f9cbed4904db416bb1a45507f8c0a1a", "committedDate": "2020-10-05T07:33:15Z", "message": "Merge branch 'master' into carsoncook/gh831/errorHandlingGWLogout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e880cc46c612e291dc5b30a6317c9441bb49755b", "author": {"user": {"login": "balhar-jakub", "name": "Jakub Balhar"}}, "url": "https://github.com/zowe/api-layer/commit/e880cc46c612e291dc5b30a6317c9441bb49755b", "committedDate": "2020-10-05T15:04:02Z", "message": "Remove the test which should verify the validity of the second token after logout.\n  - The tokens produced by zOSMF are the same and as such the logout on one means the other doesn't work.\nThe same goes for the second logout. The first logout already invalidates properly the first token.\n\nSigned-off-by: Jakub Balhar <jakub.balhar@broadcom.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNTk0MjA4", "url": "https://github.com/zowe/api-layer/pull/874#pullrequestreview-502594208", "createdAt": "2020-10-06T05:32:15Z", "commit": {"oid": "e880cc46c612e291dc5b30a6317c9441bb49755b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4842, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}