{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1MDUyMjIy", "number": 714, "title": "Private/dj/retry loadbalancer race condition", "bodyText": "Description\nReload existing load balancers at service registration.\nFixes # (issue)\nType of change\nPlease delete options that are not relevant.\n\n Bug fix (non-breaking change which fixes an issue)\n\nChecklist:\n\n My code follows the style guidelines of this project\n I have performed a self-review of my own code\n I have commented my code, particularly in hard-to-understand areas\n I have made corresponding changes to the documentation\n My changes generate no new warnings\n I have added tests that prove my fix is effective or that my feature works\n New and existing unit tests pass locally with my changes\n Any dependent changes have been merged and published in downstream modules\n\nFor more details about how should the code look like read the Contributing guideline", "createdAt": "2020-06-16T08:19:34Z", "url": "https://github.com/zowe/api-layer/pull/714", "merged": true, "mergeCommit": {"oid": "778f32598c4b7762c5506da05a7bd545d0a09397"}, "closed": true, "closedAt": "2020-06-16T15:34:26Z", "author": {"login": "achmelo"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpOQyVgH2gAyNDM1MDUyMjIyOmM5OGRkMGFiYmJmNGQyMTQ1NTZmYzgxMjQ5Y2I4NzA2MWU1ZjFlYTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr05nKgH2gAyNDM1MDUyMjIyOjlmMGQwN2U0MjgwNmYwNzAxZGRmNzQ3YjI0NjI4OGY5YzMxMjBmMjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c98dd0abbbf4d214556fc81249cb87061e5f1ea5", "author": {"user": {"login": "jandadav", "name": "David Janda"}}, "url": "https://github.com/zowe/api-layer/commit/c98dd0abbbf4d214556fc81249cb87061e5f1ea5", "committedDate": "2020-06-08T10:53:59Z", "message": "add test service for rebuilding\n\nSigned-off-by: jandadav <janda.david@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf7c485f2fc6d3a3241419bb46145fa68f986cc4", "author": {"user": {"login": "jandadav", "name": "David Janda"}}, "url": "https://github.com/zowe/api-layer/commit/bf7c485f2fc6d3a3241419bb46145fa68f986cc4", "committedDate": "2020-06-08T14:11:18Z", "message": "add logging\n\nSigned-off-by: jandadav <janda.david@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6633ff4f42be40f55558823e5980bf732b910342", "author": {"user": {"login": "jandadav", "name": "David Janda"}}, "url": "https://github.com/zowe/api-layer/commit/6633ff4f42be40f55558823e5980bf732b910342", "committedDate": "2020-06-09T11:13:06Z", "message": "another debug fixture\n\nSigned-off-by: jandadav <janda.david@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "912df85bb795e7c3121f24a959a645b6b8ea456b", "author": {"user": {"login": "jandadav", "name": "David Janda"}}, "url": "https://github.com/zowe/api-layer/commit/912df85bb795e7c3121f24a959a645b6b8ea456b", "committedDate": "2020-06-11T08:16:05Z", "message": "RC identified\n\nSigned-off-by: jandadav <janda.david@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57dc57df377763b8a1f95f5e833253689b9533e4", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/57dc57df377763b8a1f95f5e833253689b9533e4", "committedDate": "2020-06-11T14:32:48Z", "message": "keep LB instances in map\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca638fa2e4e17831e15372f82dae8b0f0997e60e", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/ca638fa2e4e17831e15372f82dae8b0f0997e60e", "committedDate": "2020-06-11T14:33:59Z", "message": "remove test\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2c8d225a1e67130d760a649531e34d9a50f09a2", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/e2c8d225a1e67130d760a649531e34d9a50f09a2", "committedDate": "2020-06-11T14:34:31Z", "message": "format\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb8dbef59f5a60fc6b8d1dfc3767f61f92196743", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/eb8dbef59f5a60fc6b8d1dfc3767f61f92196743", "committedDate": "2020-06-11T14:36:01Z", "message": "Merge remote-tracking branch 'origin/private/dj/retry-loadbalancer-race-condition' into private/dj/retry-loadbalancer-race-condition\n\n# Conflicts:\n#\tgateway-service/src/main/java/org/zowe/apiml/gateway/cache/ServiceCacheEvictor.java\n#\tgateway-service/src/main/java/org/zowe/apiml/gateway/ribbon/ApimlZoneAwareLoadBalancer.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd22e9d48620f412fa702d7682c7f38e18cfd097", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/bd22e9d48620f412fa702d7682c7f38e18cfd097", "committedDate": "2020-06-15T13:54:28Z", "message": ".\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dd7794300db43f4667b4aa1f4c13da016281026", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/2dd7794300db43f4667b4aa1f4c13da016281026", "committedDate": "2020-06-15T14:33:56Z", "message": "refactor, server list update moved\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c81d815a01143dc2834f2fae674cf99cb8308e2", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/0c81d815a01143dc2834f2fae674cf99cb8308e2", "committedDate": "2020-06-15T14:55:33Z", "message": "test correction\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d797e8279f7bb5d67f233d0d1b5efd9d944b9280", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/d797e8279f7bb5d67f233d0d1b5efd9d944b9280", "committedDate": "2020-06-16T07:10:09Z", "message": "reload all existing loadbalancers, add integrations test for reregistration\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08b09b89c5c795c2d454720bff3235450bd26a29", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/08b09b89c5c795c2d454720bff3235450bd26a29", "committedDate": "2020-06-16T07:27:05Z", "message": "Merge branch 'master' into private/dj/retry-loadbalancer-race-condition\n\n# Conflicts:\n#\tintegration-tests/src/test/java/org/zowe/apiml/gatewayservice/AuthenticationOnDeploymentTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa8dfd2452e27a7db6ccbf1eaa7b0d3adc1bfcf1", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/aa8dfd2452e27a7db6ccbf1eaa7b0d3adc1bfcf1", "committedDate": "2020-06-16T08:12:46Z", "message": "remove debug level\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a71c053f935969f5e3804385a591c59f0914b64", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/7a71c053f935969f5e3804385a591c59f0914b64", "committedDate": "2020-06-16T08:17:25Z", "message": "remove logger\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMjc2NzYw", "url": "https://github.com/zowe/api-layer/pull/714#pullrequestreview-431276760", "createdAt": "2020-06-16T08:30:01Z", "commit": {"oid": "7a71c053f935969f5e3804385a591c59f0914b64"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODozMDowMVrOGkQ1dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODozMDowMVrOGkQ1dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3Nzc0OQ==", "bodyText": "Any reason why the filter is commented out?", "url": "https://github.com/zowe/api-layer/pull/714#discussion_r440677749", "createdAt": "2020-06-16T08:30:01Z", "author": {"login": "balhar-jakub"}, "path": "apiml-common/src/main/resources/logback.xml", "diffHunk": "@@ -5,9 +5,9 @@\n     <turboFilter class=\"org.zowe.apiml.product.logging.UseridFilter\"/>\n     <turboFilter class=\"org.zowe.apiml.product.logging.ApimlDependencyLogHider\"/>\n     <turboFilter class=\"org.zowe.apiml.product.logging.LogLevelInfoFilter\"/>\n-    <turboFilter class=\"ch.qos.logback.classic.turbo.DuplicateMessageFilter\">", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a71c053f935969f5e3804385a591c59f0914b64"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMjc3MjQx", "url": "https://github.com/zowe/api-layer/pull/714#pullrequestreview-431277241", "createdAt": "2020-06-16T08:30:37Z", "commit": {"oid": "7a71c053f935969f5e3804385a591c59f0914b64"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODozMDozN1rOGkQ23g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODozMDozN1rOGkQ23g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3ODExMA==", "bodyText": "Isn't the closing tag missing?", "url": "https://github.com/zowe/api-layer/pull/714#discussion_r440678110", "createdAt": "2020-06-16T08:30:37Z", "author": {"login": "balhar-jakub"}, "path": "gateway-service/src/main/java/org/zowe/apiml/gateway/cache/ServiceCacheEvictor.java", "diffHunk": "@@ -9,38 +9,41 @@\n  */\n package org.zowe.apiml.gateway.cache;\n \n-import org.zowe.apiml.gateway.discovery.ApimlDiscoveryClient;\n-import org.zowe.apiml.gateway.ribbon.ApimlZoneAwareLoadBalancer;\n import com.netflix.discovery.CacheRefreshedEvent;\n import com.netflix.discovery.EurekaEvent;\n import com.netflix.discovery.EurekaEventListener;\n import lombok.Value;\n+import lombok.extern.slf4j.Slf4j;\n import org.springframework.stereotype.Component;\n+import org.zowe.apiml.gateway.discovery.ApimlDiscoveryClient;\n+import org.zowe.apiml.gateway.ribbon.ApimlZoneAwareLoadBalancer;\n import org.zowe.apiml.gateway.security.service.ServiceCacheEvict;\n \n import java.util.HashSet;\n import java.util.List;\n+import java.util.Map;\n+import java.util.concurrent.ConcurrentHashMap;\n \n /**\n  * This class is responsible for evicting cache after new registry is loaded. This avoid race condition. Scenario is:\n  * 1. discovery service changed\n- *  a. about change is notified all gateways\n- *  b. gateways evict caches and start with mirroring of discovery into discoveryClient\n+ * a. about change is notified all gateways\n+ * b. gateways evict caches and start with mirroring of discovery into discoveryClient\n  * 2. now is possible cache again data with old settings from discovery service, because fetching new is asynchronous\n  * 3. after make fetching this beans is notified from discovery client and evict caches again\n- *\n+ * <p>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a71c053f935969f5e3804385a591c59f0914b64"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMjc3NDAw", "url": "https://github.com/zowe/api-layer/pull/714#pullrequestreview-431277400", "createdAt": "2020-06-16T08:30:49Z", "commit": {"oid": "7a71c053f935969f5e3804385a591c59f0914b64"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODozMDo0OVrOGkQ3Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODozMDo0OVrOGkQ3Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3ODIzOQ==", "bodyText": "What is the impact of this change?", "url": "https://github.com/zowe/api-layer/pull/714#discussion_r440678239", "createdAt": "2020-06-16T08:30:49Z", "author": {"login": "balhar-jakub"}, "path": "discovery-service/src/main/resources/application.yml", "diffHunk": "@@ -75,6 +75,7 @@ eureka:\n             defaultZone: ${apiml.discovery.allPeersUrls}\n     server:\n         useReadOnlyResponseCache: false\n+        enable-self-preservation: false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a71c053f935969f5e3804385a591c59f0914b64"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ea32c5bc985b442f3f4fe0252749b98cc8bceaf", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/3ea32c5bc985b442f3f4fe0252749b98cc8bceaf", "committedDate": "2020-06-16T08:37:51Z", "message": "review\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxMjc4MzAw", "url": "https://github.com/zowe/api-layer/pull/714#pullrequestreview-431278300", "createdAt": "2020-06-16T08:31:56Z", "commit": {"oid": "7a71c053f935969f5e3804385a591c59f0914b64"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODozMTo1NlrOGkQ6AA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQwODozMjoxN1rOGkQ61w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3ODkxMg==", "bodyText": "What is this one?", "url": "https://github.com/zowe/api-layer/pull/714#discussion_r440678912", "createdAt": "2020-06-16T08:31:56Z", "author": {"login": "balhar-jakub"}, "path": "settings.gradle", "diffHunk": "@@ -33,4 +33,4 @@ include 'security-service-client-spring'\n include 'onboarding-enabler-java'\n include 'onboarding-enabler-spring'\n include 'zaas-client'\n-\n+include 'oes-app'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a71c053f935969f5e3804385a591c59f0914b64"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY3OTEyNw==", "bodyText": "Why do you remove the functionality?", "url": "https://github.com/zowe/api-layer/pull/714#discussion_r440679127", "createdAt": "2020-06-16T08:32:17Z", "author": {"login": "balhar-jakub"}, "path": "integration-tests/src/test/java/org/zowe/apiml/util/service/RequestVerifier.java", "diffHunk": "@@ -121,12 +121,6 @@ public String getHeader(String name) {\n             return list.get(0);\n         }\n \n-        public Enumeration<String> getHeaders(String name) {\n-            List list = headersData.get(name);\n-            if (list == null) list = Collections.emptyList();\n-            return Collections.enumeration(list);\n-        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a71c053f935969f5e3804385a591c59f0914b64"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfde6d7b6a24c49441ea4ad72c820e202ebb78bc", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/cfde6d7b6a24c49441ea4ad72c820e202ebb78bc", "committedDate": "2020-06-16T08:48:04Z", "message": "remove oes-app\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f2b0605ce0ba1e3c48034f2dad9b5306db61380", "author": {"user": {"login": "jandadav", "name": "David Janda"}}, "url": "https://github.com/zowe/api-layer/commit/8f2b0605ce0ba1e3c48034f2dad9b5306db61380", "committedDate": "2020-06-16T09:10:24Z", "message": "Merge branch 'master' into private/dj/retry-loadbalancer-race-condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e36e3ab998db4595541dcb7ba6b50c8fb6f94a2e", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/e36e3ab998db4595541dcb7ba6b50c8fb6f94a2e", "committedDate": "2020-06-16T09:20:20Z", "message": "fix code smells\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03c7a745a63f49a80931b33610ab24410436e65d", "author": {"user": {"login": "jandadav", "name": "David Janda"}}, "url": "https://github.com/zowe/api-layer/commit/03c7a745a63f49a80931b33610ab24410436e65d", "committedDate": "2020-06-16T09:41:33Z", "message": "cc refactor\ngenerify cache evictor\n\nSigned-off-by: jandadav <janda.david@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05ec9eb719992c8a2d683f8a2c325a500fc6fe9f", "author": {"user": {"login": "jandadav", "name": "David Janda"}}, "url": "https://github.com/zowe/api-layer/commit/05ec9eb719992c8a2d683f8a2c325a500fc6fe9f", "committedDate": "2020-06-16T09:43:01Z", "message": "refactor load balancer name\n\nSigned-off-by: jandadav <janda.david@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee173c325c0c78dbc37221d78f9f3989fa4346c5", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/ee173c325c0c78dbc37221d78f9f3989fa4346c5", "committedDate": "2020-06-16T12:27:03Z", "message": "fix ports\n\nSigned-off-by: achmelo <a.chmelo@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5cd6a507bba03e971150fe0c53e7d2f4fe7163c", "author": {"user": {"login": "achmelo", "name": null}}, "url": "https://github.com/zowe/api-layer/commit/b5cd6a507bba03e971150fe0c53e7d2f4fe7163c", "committedDate": "2020-06-16T12:27:13Z", "message": "Merge remote-tracking branch 'origin/private/dj/retry-loadbalancer-race-condition' into private/dj/retry-loadbalancer-race-condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "178aad441733787d81ec74aee831a59afe1d72a1", "author": {"user": {"login": "jandadav", "name": "David Janda"}}, "url": "https://github.com/zowe/api-layer/commit/178aad441733787d81ec74aee831a59afe1d72a1", "committedDate": "2020-06-16T12:43:18Z", "message": "fix code smells\n\nSigned-off-by: jandadav <janda.david@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f0d07e42806f0701ddf747b246288f9c3120f23", "author": {"user": {"login": "balhar-jakub", "name": "Jakub Balhar"}}, "url": "https://github.com/zowe/api-layer/commit/9f0d07e42806f0701ddf747b246288f9c3120f23", "committedDate": "2020-06-16T13:02:49Z", "message": "Merge branch 'master' into private/dj/retry-loadbalancer-race-condition"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4882, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}