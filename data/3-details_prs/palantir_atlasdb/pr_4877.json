{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMzE2MTMz", "number": 4877, "title": "Borrow WC variants of executor views to reduce thread count and increase reuse", "bodyText": "Goals (and why):\nFewer total threads.\nThreads are reused effectively.\nImplementation Description (bullets):\n\nThis includes an API+ABI break for fixed-size-executor factory methods which have been updated to return ExecutorService instead of ThreadPoolExecutor.\nPending the next jboss-threads release, the executor wrapping code will be replaced by a dependency.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nThe executor code is already used in wc which has been rolled out broadly.", "createdAt": "2020-06-30T21:52:46Z", "url": "https://github.com/palantir/atlasdb/pull/4877", "merged": true, "mergeCommit": {"oid": "abedbf01c573127da51a2a7f3ea9d801fa854fb8"}, "closed": true, "closedAt": "2020-07-02T16:27:43Z", "author": {"login": "carterkozak"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwqTJBAFqTQ0MDg3MTE3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxBWc8AFqTQ0MTc3NjQxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwODcxMTc5", "url": "https://github.com/palantir/atlasdb/pull/4877#pullrequestreview-440871179", "createdAt": "2020-07-01T13:31:21Z", "commit": {"oid": "78c8ead4ec6569a2f30e82d8e1f2688fc0d39a62"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMzozMToyMVrOGrmBOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMzozMToyMVrOGrmBOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM2NDg1OA==", "bodyText": "This executor configuration is highly suspect. At a glance I believe it will only ever have a single thread unless we manage to fill the LinkedBlockingQueue with Integer.MAX_VALUE elements.", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r448364858", "createdAt": "2020-07-01T13:31:21Z", "author": {"login": "carterkozak"}, "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/async/DefaultCassandraAsyncKeyValueServiceFactory.java", "diffHunk": "@@ -88,10 +85,7 @@ public ExecutorService visit(CqlCapableConfig cqlCapableConfig) {\n      * @return a new dynamic thread pool with a thread keep alive time of 1 minute\n      */\n     private static ExecutorService createThreadPool(int maxPoolSize) {\n-        LinkedBlockingQueue<Runnable> workQueue = new LinkedBlockingQueue<>();\n-        NamedThreadFactory threadFactory = new NamedThreadFactory(\"Atlas Cassandra Async KVS\", false);\n-\n-        return PTExecutors.newThreadPoolExecutor(0, maxPoolSize, 1, TimeUnit.MINUTES, workQueue, threadFactory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78c8ead4ec6569a2f30e82d8e1f2688fc0d39a62"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a6e3ee6dfe4505c54490402e70823335cb3cd16", "author": {"user": {"login": "carterkozak", "name": "Carter Kozak"}}, "url": "https://github.com/palantir/atlasdb/commit/0a6e3ee6dfe4505c54490402e70823335cb3cd16", "committedDate": "2020-07-01T18:55:19Z", "message": "Borrow WC variants of executor views to reduce thread count and increase reuse\n\nNote that this includes an API+ABI break for fixed-size-executor factory\nmethods which have been updated to return ExecutorService instead\nof ThreadPoolExecutor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e42db57fbd49bffcf1d731bfa3ef16c02d8357b", "author": {"user": {"login": "carterkozak", "name": "Carter Kozak"}}, "url": "https://github.com/palantir/atlasdb/commit/8e42db57fbd49bffcf1d731bfa3ef16c02d8357b", "committedDate": "2020-07-01T18:55:19Z", "message": "changelog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "78c8ead4ec6569a2f30e82d8e1f2688fc0d39a62", "author": {"user": {"login": "carterkozak", "name": "Carter Kozak"}}, "url": "https://github.com/palantir/atlasdb/commit/78c8ead4ec6569a2f30e82d8e1f2688fc0d39a62", "committedDate": "2020-07-01T11:59:41Z", "message": "changelog"}, "afterCommit": {"oid": "8e42db57fbd49bffcf1d731bfa3ef16c02d8357b", "author": {"user": {"login": "carterkozak", "name": "Carter Kozak"}}, "url": "https://github.com/palantir/atlasdb/commit/8e42db57fbd49bffcf1d731bfa3ef16c02d8357b", "committedDate": "2020-07-01T18:55:19Z", "message": "changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNzc2NDE4", "url": "https://github.com/palantir/atlasdb/pull/4877#pullrequestreview-441776418", "createdAt": "2020-07-02T15:12:05Z", "commit": {"oid": "8e42db57fbd49bffcf1d731bfa3ef16c02d8357b"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNToxMjowNVrOGsRPJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNTozNToyOVrOGsSfuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3MjkzNA==", "bodyText": "We looked at metrics-platform and it turns out this executor is basically unused in practice...", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r449072934", "createdAt": "2020-07-02T15:12:05Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/async/DefaultCassandraAsyncKeyValueServiceFactory.java", "diffHunk": "@@ -88,10 +85,7 @@ public ExecutorService visit(CqlCapableConfig cqlCapableConfig) {\n      * @return a new dynamic thread pool with a thread keep alive time of 1 minute\n      */\n     private static ExecutorService createThreadPool(int maxPoolSize) {\n-        LinkedBlockingQueue<Runnable> workQueue = new LinkedBlockingQueue<>();\n-        NamedThreadFactory threadFactory = new NamedThreadFactory(\"Atlas Cassandra Async KVS\", false);\n-\n-        return PTExecutors.newThreadPoolExecutor(0, maxPoolSize, 1, TimeUnit.MINUTES, workQueue, threadFactory);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM2NDg1OA=="}, "originalCommit": {"oid": "78c8ead4ec6569a2f30e82d8e1f2688fc0d39a62"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3ODYyNQ==", "bodyText": "note: will cause breaks in large internal product. Can confirm not used by the common AtlasDB supporting libraries.", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r449078625", "createdAt": "2020-07-02T15:20:44Z", "author": {"login": "jeremyk-91"}, "path": "changelog/@unreleased/pr-4877.v2.yml", "diffHunk": "@@ -0,0 +1,14 @@\n+changes:\n+  - type: improvement\n+    improvement:\n+      description: |-\n+        PTExecutors simple cached and fixed executor factories (those which don't consume a ThreadFactory) use views\n+        over a shared executor service to reduce total thread count and promote resource reuse.\n+      links:\n+      - https://github.com/palantir/atlasdb/pull/4877\n+  - type: break\n+    break:\n+      description: |-\n+        `PTExecutors.newFixedThreadPool` overloads return `ExecutorService` instead of the concrete `ThreadPoolExecutor` type.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e42db57fbd49bffcf1d731bfa3ef16c02d8357b"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA5MjgxMQ==", "bodyText": "This PR merged, though I wouldn't block on us using the alternative there. I checked for equivalence - it seems we have a bit more interrupt handling logic here.", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r449092811", "createdAt": "2020-07-02T15:34:51Z", "author": {"login": "jeremyk-91"}, "path": "commons-executors/src/main/java/com/palantir/common/concurrent/AtlasQueuedViewExecutor.java", "diffHunk": "@@ -0,0 +1,335 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ */\n+\n+package com.palantir.common.concurrent;\n+\n+import java.util.ArrayDeque;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.locks.Condition;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Borrowed from jboss-threads. http://www.apache.org/licenses/LICENSE-2.0\n+ * https://github.com/jbossas/jboss-threads/blob/master/src/main/java/org/jboss/threads/QueuedViewExecutor.java Changes\n+ * have been contributed and merged, this may be replaced by the upstream ViewExecutor pending a release including\n+ * https://github.com/jbossas/jboss-threads/pull/85.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e42db57fbd49bffcf1d731bfa3ef16c02d8357b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA5MzU2Mw==", "bodyText": "nit: this is private so we could probably remove the unused corepoolsize parameter.", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r449093563", "createdAt": "2020-07-02T15:35:29Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/Leaders.java", "diffHunk": "@@ -239,20 +232,7 @@ public static LocalPaxosServices createInstrumentedLocalServices(\n     // TODO (jkong): Make the limits configurable.\n     // Current use cases tend to have not more than 10 (<< 100) inflight tasks under normal circumstances.\n     private static ExecutorService createExecutor(MetricsManager metricsManager, String useCase, int corePoolSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e42db57fbd49bffcf1d731bfa3ef16c02d8357b"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2710, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}