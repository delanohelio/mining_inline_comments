{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5NzA2NDE0", "number": 4954, "title": "Don't Register Duplicate Metrics", "bodyText": "Based on @pkoenig10's #4938 but fixed to handle annoying JAX-RS semantics correctly.\nGoals (and why):\n\nSee #4938\n\nImplementation Description (bullets):\n\nDon't wire proxies through ServiceCreator for embedded leader block\nBut open TimestampService and TimestampManagementService facades so that registration works properly.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nExisting tests should suffice for correctness.\nRemoval of metrics is verified by removing the test involved\n\nConcerns (what feedback would you like?):\nNothing in particular\nWhere should we start reviewing?: TransactionManagers\nPriority (whenever / two weeks / yesterday): yesterday \ud83d\udd25", "createdAt": "2020-08-18T19:50:46Z", "url": "https://github.com/palantir/atlasdb/pull/4954", "merged": true, "mergeCommit": {"oid": "5db7a1e5d87dd3be1f604e725b66d68d185dac6e"}, "closed": true, "closedAt": "2020-08-21T10:33:12Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAMbJigH2gAyNDY5NzA2NDE0OjYyYWE1YWFjYjliZDQ3ZDcwYjMxYzUyZDE3MTQ2NTMxMjQ4ZTEwYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA1YXWgFqTQ3MTkyMTA4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "62aa5aacb9bd47d70b31c52d17146531248e10b5", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/62aa5aacb9bd47d70b31c52d17146531248e10b5", "committedDate": "2020-08-18T19:45:45Z", "message": "proxies"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c20b84d6c9fa53544bd9ac0800e4f76b45a69d7b", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/c20b84d6c9fa53544bd9ac0800e4f76b45a69d7b", "committedDate": "2020-08-18T19:47:09Z", "message": "Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99aa35e93ba02e3503ffb6d6b587ee24de33ff5c", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/99aa35e93ba02e3503ffb6d6b587ee24de33ff5c", "committedDate": "2020-08-18T19:47:09Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMjQ1NTAw", "url": "https://github.com/palantir/atlasdb/pull/4954#pullrequestreview-470245500", "createdAt": "2020-08-19T08:40:44Z", "commit": {"oid": "99aa35e93ba02e3503ffb6d6b587ee24de33ff5c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODo0MDo0NFrOHC9Pug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQwODo0NDoyNVrOHC9YpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2MjY1MA==", "bodyText": "nit: close bracket (that was opened on the line above)", "url": "https://github.com/palantir/atlasdb/pull/4954#discussion_r472862650", "createdAt": "2020-08-19T08:40:44Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -1187,23 +1188,16 @@ private static LockAndTimestampServices createRawLeaderServices(\n                 leaderConfig,\n                 userAgent);\n         LeaderElectionService leader = localPaxosServices.leaderElectionService();\n-        LockService localLock = ServiceCreator.instrumentService(\n-                metricsManager.getRegistry(),\n-                AwaitingLeadershipProxy.newProxyInstance(LockService.class, lock::get, leader),\n-                LockService.class);\n+        LockService localLock = AwaitingLeadershipProxy.newProxyInstance(LockService.class, lock::get, leader);\n \n         ManagedTimestampService managedTimestampProxy =\n                 AwaitingLeadershipProxy.newProxyInstance(ManagedTimestampService.class, time::get, leader);\n \n-        TimestampService localTime = ServiceCreator.instrumentService(\n-                metricsManager.getRegistry(),\n-                managedTimestampProxy,\n-                TimestampService.class);\n+        // These facades are necessary because of the semantics of the JAX-RS algorithm (in particular, accepting\n+        // just the managed timestamp service will *not* work.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99aa35e93ba02e3503ffb6d6b587ee24de33ff5c"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2Mzk3OA==", "bodyText": "You've removed two tests, but added none - are there any tests we can add to have confidence that this fix is correct?", "url": "https://github.com/palantir/atlasdb/pull/4954#discussion_r472863978", "createdAt": "2020-08-19T08:42:53Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java", "diffHunk": "@@ -612,15 +612,6 @@ private TransactionManagers withLockImmutableTsOnReadOnlyTransaction(boolean opt\n                 .build();\n     }\n \n-    @Test\n-    public void metricsAreReportedExactlyOnceWhenUsingLocalService() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99aa35e93ba02e3503ffb6d6b587ee24de33ff5c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2NDkzMw==", "bodyText": "I see you've said\n\nExisting tests should suffice for correctness.\nRemoval of metrics is verified by removing the test involved\n\nbut I'm not 100% on the second point - removing the tests just removes the check that there are metrics, but surely it doesn't actively check that no metrics are registered? That's what we want here, right?", "url": "https://github.com/palantir/atlasdb/pull/4954#discussion_r472864933", "createdAt": "2020-08-19T08:44:25Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java", "diffHunk": "@@ -612,15 +612,6 @@ private TransactionManagers withLockImmutableTsOnReadOnlyTransaction(boolean opt\n                 .build();\n     }\n \n-    @Test\n-    public void metricsAreReportedExactlyOnceWhenUsingLocalService() throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mjg2Mzk3OA=="}, "originalCommit": {"oid": "99aa35e93ba02e3503ffb6d6b587ee24de33ff5c"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1db085ebffb97a1cae1a3378142e6fa10cf5d790", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/1db085ebffb97a1cae1a3378142e6fa10cf5d790", "committedDate": "2020-08-19T08:56:45Z", "message": "CR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8afb8cccd42194c333d551a4e0fb34d655a4ae7", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/c8afb8cccd42194c333d551a4e0fb34d655a4ae7", "committedDate": "2020-08-19T08:56:56Z", "message": "Merge branch 'jkong/duplicate-final' of github.com:palantir/atlasdb into jkong/duplicate-final"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxOTIxMDg1", "url": "https://github.com/palantir/atlasdb/pull/4954#pullrequestreview-471921085", "createdAt": "2020-08-20T19:28:49Z", "commit": {"oid": "c8afb8cccd42194c333d551a4e0fb34d655a4ae7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2805, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}