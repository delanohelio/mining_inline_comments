{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNDkzOTky", "number": 4607, "title": "SweepStrategyManagers only load one table metadata on cache miss", "bodyText": "Goals (and why):\nDo not have to reload all tables' metadata (which could include a LOT of tables) every single time there is a cache miss.\nImplementation Description (bullets):\nRather than have a supplier that recalculates the entire map each time, just get and cache each entry. But still add all initial tables at the beginning as a perf optimization.\nTesting (What was existing testing like?  What have you done to improve it?):\nConcerns (what feedback would you like?):\nWhere should we start reviewing?:\nPriority (whenever / two weeks / yesterday):", "createdAt": "2020-02-26T20:38:28Z", "url": "https://github.com/palantir/atlasdb/pull/4607", "merged": true, "mergeCommit": {"oid": "def50bf6bc4d3cf6f6330d868ca91853b37b811b"}, "closed": true, "closedAt": "2020-03-02T16:44:21Z", "author": {"login": "mswintermeyer"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIM2p1AH2gAyMzgwNDkzOTkyOjExMTc2MTA0NmJmNzQ4Y2JlZWQzZjYzZjg5OTM1NzEzMzdiYTIwNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJwVM0AH2gAyMzgwNDkzOTkyOjgwYWYxYmRlMzBkYzljODMwNWUzN2FhNTk5ODgzMmMyZjE3OTg0YWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "111761046bf748cbeed3f63f8993571337ba2071", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/111761046bf748cbeed3f63f8993571337ba2071", "committedDate": "2020-02-26T20:36:02Z", "message": "SweepStrategyManagers only load one table metadata on cache miss"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f53546830f2a9b282c457942fc5c38038e246977", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/f53546830f2a9b282c457942fc5c38038e246977", "committedDate": "2020-02-26T20:36:02Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1MjQ1OTUx", "url": "https://github.com/palantir/atlasdb/pull/4607#pullrequestreview-365245951", "createdAt": "2020-02-26T21:13:16Z", "commit": {"oid": "111761046bf748cbeed3f63f8993571337ba2071"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMToxMzoxNlrOFu8aLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQyMToxMzoxNlrOFu8aLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc2ODU1Ng==", "bodyText": "The way you wrote this, this will never return null.", "url": "https://github.com/palantir/atlasdb/pull/4607#discussion_r384768556", "createdAt": "2020-02-26T21:13:16Z", "author": {"login": "tjwilson90"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/transaction/impl/SweepStrategyManagers.java", "diffHunk": "@@ -33,13 +35,15 @@ private SweepStrategyManagers() {\n     }\n \n     public static SweepStrategyManager createDefault(KeyValueService kvs) {\n-        RecomputingSupplier<Map<TableReference, SweepStrategy>> supplier =\n-                RecomputingSupplier.create(() -> getSweepStrategies(kvs));\n+        // On a cache miss, load metadata only for the relevant table. Helpful when many dynamic tables.\n+        LoadingCache<TableReference, SweepStrategy> cache = Caffeine.newBuilder()\n+                .build(tableRef -> getSweepStrategy(kvs.getMetadataForTable(tableRef)));\n         return tableRef -> {\n-            SweepStrategy strategy = supplier.get().get(tableRef);\n-            if (strategy == null) {\n-                strategy = supplier.recompute().get(tableRef);\n+            // Add all existing tables the first time this is called, to optimize for cases when mostly non-dynamic tables.\n+            if (cache.estimatedSize() == 0) {\n+                cache.putAll(getSweepStrategies(kvs));\n             }\n+            SweepStrategy strategy = cache.get(tableRef);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "111761046bf748cbeed3f63f8993571337ba2071"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MzA1MDcz", "url": "https://github.com/palantir/atlasdb/pull/4607#pullrequestreview-367305073", "createdAt": "2020-03-02T15:48:11Z", "commit": {"oid": "f53546830f2a9b282c457942fc5c38038e246977"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c004bcfab6832770f69ef9a0d8fbd7ef4bc8010", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/7c004bcfab6832770f69ef9a0d8fbd7ef4bc8010", "committedDate": "2020-03-02T15:53:04Z", "message": "empty commit to retrigger build flake"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MzE3NDQ0", "url": "https://github.com/palantir/atlasdb/pull/4607#pullrequestreview-367317444", "createdAt": "2020-03-02T16:01:53Z", "commit": {"oid": "f53546830f2a9b282c457942fc5c38038e246977"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNjowMTo1M1rOFwlIXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNjowNDowMFrOFwlN4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ4NDMxNg==", "bodyText": "in this initial case doesn't this degrade to the version on the left on initial load? or is that an acceptable compromise?", "url": "https://github.com/palantir/atlasdb/pull/4607#discussion_r386484316", "createdAt": "2020-03-02T16:01:53Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/transaction/impl/SweepStrategyManagers.java", "diffHunk": "@@ -33,13 +35,15 @@ private SweepStrategyManagers() {\n     }\n \n     public static SweepStrategyManager createDefault(KeyValueService kvs) {\n-        RecomputingSupplier<Map<TableReference, SweepStrategy>> supplier =\n-                RecomputingSupplier.create(() -> getSweepStrategies(kvs));\n+        // On a cache miss, load metadata only for the relevant table. Helpful when many dynamic tables.\n+        LoadingCache<TableReference, SweepStrategy> cache = Caffeine.newBuilder()\n+                .build(tableRef -> getSweepStrategy(kvs.getMetadataForTable(tableRef)));\n         return tableRef -> {\n-            SweepStrategy strategy = supplier.get().get(tableRef);\n-            if (strategy == null) {\n-                strategy = supplier.recompute().get(tableRef);\n+            // Add all existing tables the first time this is called, to optimize for cases when mostly non-dynamic tables.\n+            if (cache.estimatedSize() == 0) {\n+                cache.putAll(getSweepStrategies(kvs));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f53546830f2a9b282c457942fc5c38038e246977"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ4NTY0NQ==", "bodyText": "getSweepStrategy never returns null though right? Similarly TableMetadata.BYTES_HYDRATOR.hydrateFromBytes(tableMeta).getSweepStrategy().", "url": "https://github.com/palantir/atlasdb/pull/4607#discussion_r386485645", "createdAt": "2020-03-02T16:03:51Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/transaction/impl/SweepStrategyManagers.java", "diffHunk": "@@ -33,13 +35,15 @@ private SweepStrategyManagers() {\n     }\n \n     public static SweepStrategyManager createDefault(KeyValueService kvs) {\n-        RecomputingSupplier<Map<TableReference, SweepStrategy>> supplier =\n-                RecomputingSupplier.create(() -> getSweepStrategies(kvs));\n+        // On a cache miss, load metadata only for the relevant table. Helpful when many dynamic tables.\n+        LoadingCache<TableReference, SweepStrategy> cache = Caffeine.newBuilder()\n+                .build(tableRef -> getSweepStrategy(kvs.getMetadataForTable(tableRef)));\n         return tableRef -> {\n-            SweepStrategy strategy = supplier.get().get(tableRef);\n-            if (strategy == null) {\n-                strategy = supplier.recompute().get(tableRef);\n+            // Add all existing tables the first time this is called, to optimize for cases when mostly non-dynamic tables.\n+            if (cache.estimatedSize() == 0) {\n+                cache.putAll(getSweepStrategies(kvs));\n             }\n+            SweepStrategy strategy = cache.get(tableRef);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDc2ODU1Ng=="}, "originalCommit": {"oid": "111761046bf748cbeed3f63f8993571337ba2071"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQ4NTczMA==", "bodyText": "please fix up the changelog", "url": "https://github.com/palantir/atlasdb/pull/4607#discussion_r386485730", "createdAt": "2020-03-02T16:04:00Z", "author": {"login": "felixdesouza"}, "path": "changelog/@unreleased/pr-4607.v2.yml", "diffHunk": "@@ -0,0 +1,28 @@\n+type: fix\n+fix:\n+  description: |-\n+    SweepStrategyManagers only load one table metadata on cache miss", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f53546830f2a9b282c457942fc5c38038e246977"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b64b2aac5f1872a1ef3a66563e0518e409e7f7d", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/5b64b2aac5f1872a1ef3a66563e0518e409e7f7d", "committedDate": "2020-03-02T16:07:38Z", "message": "remove null check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6081dde199ed705c9590199f50a67d1f7470c1f5", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/6081dde199ed705c9590199f50a67d1f7470c1f5", "committedDate": "2020-03-02T16:18:45Z", "message": "clean up changelog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MzM2MDQ2", "url": "https://github.com/palantir/atlasdb/pull/4607#pullrequestreview-367336046", "createdAt": "2020-03-02T16:24:00Z", "commit": {"oid": "6081dde199ed705c9590199f50a67d1f7470c1f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80af1bde30dc9c8305e37aa5998832c2f17984aa", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/80af1bde30dc9c8305e37aa5998832c2f17984aa", "committedDate": "2020-03-02T16:30:00Z", "message": "empty commit to retrigger build flake"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2303, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}