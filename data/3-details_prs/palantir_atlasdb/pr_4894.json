{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2ODY1NjI0", "number": 4894, "title": "[LW] Test for lock watch updates that are too far behind", "bodyText": "Goals (and why):\nCatch a case in the code where the successful update has a version before the snapshot.\nSince the start transaction flow is synchronous and batched, it should not be possible to have this case - it would mean that the cache has received some updates, and the transactions that carried those updates have committed, all before the second set of updates comes in. This defends against it anyway.\nImplementation Description (bullets):\n\nAdded a test for successful updates that have a version before the snapshot (which essentially represents the earliest version for which we have events).\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nAdded another test to LockWatchEventCacheIntegrationTests.\n\nConcerns (what feedback would you like?):\n\nIs this change necessary? Note that if the above case were to happen with the current code, the main point of worry is the commit update, and that would end up invalidating all (i.e. causing a conflict, and retrying the transaction anyway).\n\nWhere should we start reviewing?:\n\nLockWatchEventLog\n\nPriority (whenever / two weeks / yesterday):\nWhenever.", "createdAt": "2020-07-09T13:36:27Z", "url": "https://github.com/palantir/atlasdb/pull/4894", "merged": true, "mergeCommit": {"oid": "90abb4dd92d138a5b8dea03630ad55d5a0c7fbeb"}, "closed": true, "closedAt": "2020-07-09T14:55:28Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczPFc4gH2gAyNDQ2ODY1NjI0OjY1ZjdlMjc0NTE3Nzk4M2EzNGEwZDQyNDc2ZjUzZjRlNjYyYTFiNTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczQK4PgH2gAyNDQ2ODY1NjI0OjM1NmVhYjhmNjI3NGFhMjk0YzgxZTdmYWVmN2QyMWZjOTVkM2ZkMGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "65f7e2745177983a34a0d42476f53f4e662a1b51", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/65f7e2745177983a34a0d42476f53f4e662a1b51", "committedDate": "2020-07-09T13:30:45Z", "message": "add test for new case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjIzMDY3", "url": "https://github.com/palantir/atlasdb/pull/4894#pullrequestreview-445623067", "createdAt": "2020-07-09T13:37:15Z", "commit": {"oid": "65f7e2745177983a34a0d42476f53f4e662a1b51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzozNzoxNVrOGvRgNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzozNzoxNVrOGvRgNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIyMzAzMQ==", "bodyText": "Already enforced elsewhere (i.e. must have a snapshot before processing successes), but this is just because we have to handle optionals everywhere.", "url": "https://github.com/palantir/atlasdb/pull/4894#discussion_r452223031", "createdAt": "2020-07-09T13:37:15Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java", "diffHunk": "@@ -120,6 +121,13 @@ private IdentifiedVersion getLatestVersionAndVerify(IdentifiedVersion endVersion\n \n     private void processSuccess(LockWatchStateUpdate.Success success) {\n         Preconditions.checkState(latestVersion.isPresent(), \"Must have a known version to process successful updates\");\n+        Optional<IdentifiedVersion> snapshotVersion = snapshot.getSnapshotVersion();\n+        Preconditions.checkState(snapshotVersion.isPresent(),\n+                \"Must have a snapshot before processing successful updates\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65f7e2745177983a34a0d42476f53f4e662a1b51"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjIzMjY2", "url": "https://github.com/palantir/atlasdb/pull/4894#pullrequestreview-445623266", "createdAt": "2020-07-09T13:37:25Z", "commit": {"oid": "65f7e2745177983a34a0d42476f53f4e662a1b51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzozNzoyNVrOGvRgwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzozNzoyNVrOGvRgwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIyMzE3MA==", "bodyText": "Drive by fix.", "url": "https://github.com/palantir/atlasdb/pull/4894#discussion_r452223170", "createdAt": "2020-07-09T13:37:25Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventCacheIntegrationTest.java", "diffHunk": "@@ -77,7 +78,7 @@\n             LockEvent.builder(ImmutableSet.of(DESCRIPTOR), LockToken.of(EVENT2_UUID)).build(7L);\n \n     private static final UUID LEADER = UUID.fromString(\"470c855e-f77b-44df-b56a-14d3df085dbc\");\n-    public static final LockWatchStateUpdate.Success SUCCESS_2 = LockWatchStateUpdate.success(LEADER, 7L,\n+    private static final LockWatchStateUpdate.Success SUCCESS_2 = LockWatchStateUpdate.success(LEADER, 7L,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65f7e2745177983a34a0d42476f53f4e662a1b51"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1Njg0MzA4", "url": "https://github.com/palantir/atlasdb/pull/4894#pullrequestreview-445684308", "createdAt": "2020-07-09T14:41:41Z", "commit": {"oid": "65f7e2745177983a34a0d42476f53f4e662a1b51"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDo0MTo0MVrOGvUUxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDo0MTo0MVrOGvUUxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2OTI1NQ==", "bodyText": "Checked that this should get retried both by atlasdb-proxy and atlasdb internally.", "url": "https://github.com/palantir/atlasdb/pull/4894#discussion_r452269255", "createdAt": "2020-07-09T14:41:41Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java", "diffHunk": "@@ -120,6 +121,13 @@ private IdentifiedVersion getLatestVersionAndVerify(IdentifiedVersion endVersion\n \n     private void processSuccess(LockWatchStateUpdate.Success success) {\n         Preconditions.checkState(latestVersion.isPresent(), \"Must have a known version to process successful updates\");\n+        Optional<IdentifiedVersion> snapshotVersion = snapshot.getSnapshotVersion();\n+        Preconditions.checkState(snapshotVersion.isPresent(),\n+                \"Must have a snapshot before processing successful updates\");\n+\n+        if (success.lastKnownVersion() < snapshotVersion.get().version()) {\n+            throw new TransactionLockWatchFailedException(\"Cannot process events before the oldest event\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65f7e2745177983a34a0d42476f53f4e662a1b51"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1Njg2ODQ1", "url": "https://github.com/palantir/atlasdb/pull/4894#pullrequestreview-445686845", "createdAt": "2020-07-09T14:44:07Z", "commit": {"oid": "65f7e2745177983a34a0d42476f53f4e662a1b51"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5607c7977b8d111cd87a3b748a84f6755aa21e82", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/5607c7977b8d111cd87a3b748a84f6755aa21e82", "committedDate": "2020-07-09T14:45:47Z", "message": "extend message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "356eab8f6274aa294c81e7faef7d21fc95d3fd0d", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/356eab8f6274aa294c81e7faef7d21fc95d3fd0d", "committedDate": "2020-07-09T14:46:35Z", "message": "fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2731, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}