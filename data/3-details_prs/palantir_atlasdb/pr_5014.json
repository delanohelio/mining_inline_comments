{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NjE3MzQ3", "number": 5014, "title": "[DB TimeLock] 1D - Agent Wiring", "bodyText": "Goals (and why):\n\nDB Timelock needs to support multiple series\n\nImplementation Description (bullets):\n\nSet db timelock up to use the new multi series bound store.\nPass the series in as a client.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nThe ETEs validate that nothing has truly imploded. There are some small unit tests. More involved testing should be handled in task 3 of this workstream.\nConcerns (what feedback would you like?):\n\nDbTimestampCreationParameters would really better be served by a Visitor pattern and subtypes, though I think that's a bit too much work and not particularly valuable. What do you think?\nSome duplication in the checks for Cassandra and JDBC. I will separately check if we can kill the latter, this is frustrating. Impl-Shared is strangely not pulled in by JDBC and there aren't many choices on where\nThe testing setup for this PR is admittedly limited, and I do not like it. That said, we will not roll this out until it's further improved, and this code path is not used in production anywhere, and I think this component is reviewable by itself.\n\nWhere should we start reviewing?: DbBoundTimestampCreator is the entrypoint and probably where you should drill down from.\nPriority (whenever / two weeks / yesterday): this week for a first pass (though not the highest priority as I'll be back in on Monday)", "createdAt": "2020-10-02T00:33:22Z", "url": "https://github.com/palantir/atlasdb/pull/5014", "merged": true, "mergeCommit": {"oid": "89f791a359ad460f94e426bb1c200e958234c63a"}, "closed": true, "closedAt": "2020-10-13T13:02:50Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOY33ZgH2gAyNDk2NjE3MzQ3OjJjMmYwOGM4ZTM0ZTUyOWZjNjUzMDM3MTcyZGIyZTdkYjE5YmU4NDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSGR-QAFqTUwNzI5MTc0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2c2f08c8e34e529fc653037172db2e7db19be849", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/2c2f08c8e34e529fc653037172db2e7db19be849", "committedDate": "2020-10-01T22:10:55Z", "message": "bleh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5272f03a48917e0871dbe2afc765d787b142423d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/5272f03a48917e0871dbe2afc765d787b142423d", "committedDate": "2020-10-01T23:09:39Z", "message": "fbuo2ch1902w rbguohcbfuch81"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c7ba2e0a0e7d9216ac9a39ef2a8f61f1bee2d83", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/7c7ba2e0a0e7d9216ac9a39ef2a8f61f1bee2d83", "committedDate": "2020-10-01T23:09:45Z", "message": "Creation Params"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2af61a91257657ed74eee980e0811b835b86dad8", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/2af61a91257657ed74eee980e0811b835b86dad8", "committedDate": "2020-10-01T23:18:59Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7858b2f19c99964f2fc570a7d54dc25f4f44539a", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/7858b2f19c99964f2fc570a7d54dc25f4f44539a", "committedDate": "2020-10-01T23:22:23Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00998816bfccaae4a06378f709906ab241186423", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/00998816bfccaae4a06378f709906ab241186423", "committedDate": "2020-10-01T23:33:00Z", "message": "more fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5493891f42c3a6e439a78988dc3b4528a1343254", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/5493891f42c3a6e439a78988dc3b4528a1343254", "committedDate": "2020-10-01T23:37:41Z", "message": " g4j029uv39 8h2y1u 2u49j30"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "175476149ec07b1c974c3118c40a41d49384230a", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/175476149ec07b1c974c3118c40a41d49384230a", "committedDate": "2020-10-01T23:49:46Z", "message": "baseli rn12g4303 j4r3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbca332246f3e9dea8852fc0ac6b690f418973cd", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/bbca332246f3e9dea8852fc0ac6b690f418973cd", "committedDate": "2020-10-01T23:54:32Z", "message": " 13h0r4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fe12b22156e8e8db1211c6315e21796cbe7c0f0", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/7fe12b22156e8e8db1211c6315e21796cbe7c0f0", "committedDate": "2020-10-02T00:31:44Z", "message": "some tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5846ea622994eb934ef9dfa819bb2e74b3193b6e", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/5846ea622994eb934ef9dfa819bb2e74b3193b6e", "committedDate": "2020-10-13T10:26:30Z", "message": "Derive4j to the rescue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca7ae7493ea0838e112b829a80ab1c7c7c3f1944", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/ca7ae7493ea0838e112b829a80ab1c7c7c3f1944", "committedDate": "2020-10-13T10:46:22Z", "message": "Clean up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MjkxNzQ3", "url": "https://github.com/palantir/atlasdb/pull/5014#pullrequestreview-507291747", "createdAt": "2020-10-13T10:29:31Z", "commit": {"oid": "5846ea622994eb934ef9dfa819bb2e74b3193b6e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMDoyOTozMVrOHggEfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMDo0MjoxMVrOHgggRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg0MTkxNg==", "bodyText": "Note: these indicate that the methods should be generated", "url": "https://github.com/palantir/atlasdb/pull/5014#discussion_r503841916", "createdAt": "2020-10-13T10:29:31Z", "author": {"login": "gmaretic"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/config/DbTimestampCreationSetting.java", "diffHunk": "@@ -0,0 +1,41 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.config;\n+\n+import java.util.Optional;\n+\n+import org.derive4j.Data;\n+\n+import com.palantir.atlasdb.keyvalue.api.TableReference;\n+import com.palantir.atlasdb.keyvalue.api.TimestampSeries;\n+\n+@Data\n+public abstract class DbTimestampCreationSetting {\n+    public interface Cases<R> {\n+        R multipleSeries(Optional<TableReference> tableReference, TimestampSeries series);\n+        R singleSeries(Optional<TableReference> tableReference);\n+    }\n+\n+    public abstract <R> R match(Cases<R> cases);\n+\n+    @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5846ea622994eb934ef9dfa819bb2e74b3193b6e"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg0OTAzMA==", "bodyText": "Is it safe to just switch here?", "url": "https://github.com/palantir/atlasdb/pull/5014#discussion_r503849030", "createdAt": "2020-10-13T10:42:11Z", "author": {"login": "gmaretic"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/DbBoundTimestampCreator.java", "diffHunk": "@@ -49,15 +52,18 @@ public DbBoundTimestampCreator(KeyValueServiceConfig kvsConfig) {\n                 Optional::empty,\n                 Optional.of(leaderConfig),\n                 Optional.empty(),\n-                Optional.of(AtlasDbConstants.LEGACY_TIMELOCK_TIMESTAMP_TABLE),\n+                Optional.of(getTimestampCreationParameters(client)),\n                 AtlasDbConstants.DEFAULT_INITIALIZE_ASYNC,\n                 AtlasDbFactory.THROWING_FRESH_TIMESTAMP_SOURCE);\n \n         TimestampService timestampService = atlasFactory.getManagedTimestampService();\n-        Preconditions.checkArgument(timestampService instanceof TimestampManagementService,\n-                \"The timestamp service is not a managed timestamp service.\");\n \n         return () -> new DelegatingManagedTimestampService(timestampService,\n                 (TimestampManagementService) timestampService);\n     }\n+\n+    @VisibleForTesting\n+    static DbTimestampCreationSetting getTimestampCreationParameters(Client client) {\n+        return DbTimestampCreationSettings.multipleSeries(Optional.empty(), TimestampSeries.of(client.value()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5846ea622994eb934ef9dfa819bb2e74b3193b6e"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2618, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}