{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMTM0MjIz", "number": 4799, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjowNzoyMlrOD_pOrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxOTo1NDoxMVrOEAQPjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MDYyMzgyOnYy", "diffSide": "RIGHT", "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/StartTransactionRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjowNzoyMlrOGabO-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjowNzoyMlrOGabO-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM2MjM2MQ==", "bodyText": "I am thinking we could have a different Interface passed here here that is only lockwatch related, so we don't pollute PreCommitCondition.", "url": "https://github.com/palantir/atlasdb/pull/4799#discussion_r430362361", "createdAt": "2020-05-26T12:07:22Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/StartTransactionRequest.java", "diffHunk": "@@ -13,23 +13,12 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n+\n package com.palantir.atlasdb.transaction.api;\n \n import org.immutables.value.Value;\n \n-import com.palantir.lock.v2.LockToken;\n-\n @Value.Immutable\n-public interface TransactionAndImmutableTsLock {\n-\n-    Transaction transaction();\n-\n-    LockToken immutableTsLock();\n-\n-    static TransactionAndImmutableTsLock of(Transaction transaction, LockToken immutableTsLock) {\n-        return ImmutableTransactionAndImmutableTsLock.builder()\n-                .transaction(transaction)\n-                .immutableTsLock(immutableTsLock)\n-                .build();\n-    }\n+public interface StartTransactionRequest {\n+    PreCommitCondition preCommitCondition();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7488fdef599530eeea031c9c6a49b240957b7d2b"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MDYyNjgwOnYy", "diffSide": "RIGHT", "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/StartTransactionRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjowODoxN1rOGabQ5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjowODoxN1rOGabQ5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM2Mjg1Mw==", "bodyText": "Possibly, this dealing with List might cleanup some more code (where we have CombinedCondition* type things), but I'd hold off for now.", "url": "https://github.com/palantir/atlasdb/pull/4799#discussion_r430362853", "createdAt": "2020-05-26T12:08:17Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/StartTransactionRequest.java", "diffHunk": "@@ -13,23 +13,12 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n+\n package com.palantir.atlasdb.transaction.api;\n \n import org.immutables.value.Value;\n \n-import com.palantir.lock.v2.LockToken;\n-\n @Value.Immutable\n-public interface TransactionAndImmutableTsLock {\n-\n-    Transaction transaction();\n-\n-    LockToken immutableTsLock();\n-\n-    static TransactionAndImmutableTsLock of(Transaction transaction, LockToken immutableTsLock) {\n-        return ImmutableTransactionAndImmutableTsLock.builder()\n-                .transaction(transaction)\n-                .immutableTsLock(immutableTsLock)\n-                .build();\n-    }\n+public interface StartTransactionRequest {\n+    PreCommitCondition preCommitCondition();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7488fdef599530eeea031c9c6a49b240957b7d2b"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MDYzMzMzOnYy", "diffSide": "RIGHT", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransactionManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjoxMDoxNlrOGabVGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjoxMDoxNlrOGabVGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM2MzkzMA==", "bodyText": "This would have to work with an empty list of started transactions, and just send the update up to the latest we know about. Or throw", "url": "https://github.com/palantir/atlasdb/pull/4799#discussion_r430363930", "createdAt": "2020-05-26T12:10:16Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransactionManager.java", "diffHunk": "@@ -209,26 +214,74 @@ protected boolean shouldStopRetrying(int numTimesFailed) {\n         }\n     }\n \n-    @Override\n-    public <T, E extends Exception> T finishRunTaskWithLockThrowOnConflict(TransactionAndImmutableTsLock txAndLock,\n-                                                                           TransactionTask<T, E> task)\n-            throws E, TransactionFailedRetriableException {\n-        Timer postTaskTimer = getTimer(\"finishTask\");\n-        Timer.Context postTaskContext;\n+    static final OpenTransactions EMPTY = new OpenTransactions() {\n+        @Override\n+        public List<OpenTransaction> getTransactions() {\n+            return ImmutableList.of();\n+        }\n \n-        TransactionTask<T, E> wrappedTask = wrapTaskIfNecessary(task, txAndLock.immutableTsLock());\n+        //        @Override\n+        //        public TransactionsLockWatchEvents getEvents(Optional<IdentifiedVersion> lastKnownVersion) {\n+        //            throw new SafeIllegalArgumentException(\"Empty batch\");\n+        //        }\n+    };\n \n-        Transaction tx = txAndLock.transaction();\n-        T result;\n-        try {\n-            result = runTaskThrowOnConflict(wrappedTask, tx);\n-        } finally {\n-            postTaskContext = postTaskTimer.time();\n-            timelockService.tryUnlock(ImmutableSet.of(txAndLock.immutableTsLock()));\n+    private final class DefaultOpenTransactions implements OpenTransactions {\n+\n+        private final List<OpenTransaction> transactions;\n+\n+        DefaultOpenTransactions(\n+                List<OpenTransaction> transactions) {\n+            this.transactions = transactions;\n+        }\n+\n+\n+        @Override\n+        public List<OpenTransaction> getTransactions() {\n+            return transactions;\n+        }\n+\n+        //    @Override\n+        //    public TransactionsLockWatchEvents getEvents(Optional<IdentifiedVersion> lastKnownVersion) {\n+        //        return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7488fdef599530eeea031c9c6a49b240957b7d2b"}, "originalPosition": 131}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4MDY4MzcyOnYy", "diffSide": "RIGHT", "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/OpenTransaction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjoyNTozNVrOGab1hQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxOToxNzo1NlrOGbZtbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM3MjIyOQ==", "bodyText": "Interested in another name, but this is how we call this in atlasdb-proxy.", "url": "https://github.com/palantir/atlasdb/pull/4799#discussion_r430372229", "createdAt": "2020-05-26T12:25:35Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/OpenTransaction.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.transaction.api;\n+\n+import com.palantir.atlasdb.metrics.Timed;\n+\n+public interface OpenTransaction extends Transaction {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7488fdef599530eeea031c9c6a49b240957b7d2b"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTM4NTk2Nw==", "bodyText": "I think this is fine, enough of us work on atlasdb-proxy that the naming should be obvious :)", "url": "https://github.com/palantir/atlasdb/pull/4799#discussion_r431385967", "createdAt": "2020-05-27T19:17:56Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/OpenTransaction.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.transaction.api;\n+\n+import com.palantir.atlasdb.metrics.Timed;\n+\n+public interface OpenTransaction extends Transaction {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM3MjIyOQ=="}, "originalCommit": {"oid": "7488fdef599530eeea031c9c6a49b240957b7d2b"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzAwNzQwOnYy", "diffSide": "RIGHT", "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/OpenTransactions.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxOTo1MToyMVrOGba0nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDozNjoxNlrOGbcK9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQwNDE5MQ==", "bodyText": "Think we discussed this one, I'm still slightly in favour of StartTransactionsResponse", "url": "https://github.com/palantir/atlasdb/pull/4799#discussion_r431404191", "createdAt": "2020-05-27T19:51:21Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/OpenTransactions.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.transaction.api;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+import com.palantir.lock.watch.IdentifiedVersion;\n+import com.palantir.lock.watch.TransactionsLockWatchEvents;\n+\n+public interface OpenTransactions {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a0bd72bc0cfc1e29497ff1570d227b9bd40636e"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyNTA4MQ==", "bodyText": "Cool, will rename now.", "url": "https://github.com/palantir/atlasdb/pull/4799#discussion_r431425081", "createdAt": "2020-05-27T20:33:53Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/OpenTransactions.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.transaction.api;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+import com.palantir.lock.watch.IdentifiedVersion;\n+import com.palantir.lock.watch.TransactionsLockWatchEvents;\n+\n+public interface OpenTransactions {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQwNDE5MQ=="}, "originalCommit": {"oid": "9a0bd72bc0cfc1e29497ff1570d227b9bd40636e"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyNjI5NA==", "bodyText": "Renamed", "url": "https://github.com/palantir/atlasdb/pull/4799#discussion_r431426294", "createdAt": "2020-05-27T20:36:16Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/OpenTransactions.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.transaction.api;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+import com.palantir.lock.watch.IdentifiedVersion;\n+import com.palantir.lock.watch.TransactionsLockWatchEvents;\n+\n+public interface OpenTransactions {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQwNDE5MQ=="}, "originalCommit": {"oid": "9a0bd72bc0cfc1e29497ff1570d227b9bd40636e"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY4NzAxNTgyOnYy", "diffSide": "RIGHT", "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/OpenTransactions.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxOTo1NDoxMVrOGba6JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QyMDo0MjowM1rOGbcW8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQwNTYwNA==", "bodyText": "Should we document/put in the contract the behaviour around FAILUREs at -1 (for systems with no-op managers i.e. embedded)? I don't remember exactly how we handle that case", "url": "https://github.com/palantir/atlasdb/pull/4799#discussion_r431405604", "createdAt": "2020-05-27T19:54:11Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/OpenTransactions.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.transaction.api;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+import com.palantir.lock.watch.IdentifiedVersion;\n+import com.palantir.lock.watch.TransactionsLockWatchEvents;\n+\n+public interface OpenTransactions {\n+\n+    List<OpenTransaction> getTransactions();\n+\n+    /**\n+     * Returns a condensed view of new lock watch events since lastKnownVersion for the set of started transactions.\n+     *\n+     * @param lastKnownVersion exclusive start version to get events from\n+     */\n+    TransactionsLockWatchEvents getEvents(Optional<IdentifiedVersion> lastKnownVersion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a0bd72bc0cfc1e29497ff1570d227b9bd40636e"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQyOTM2MQ==", "bodyText": "Discussed offline: this ends up just sending a dummy SNAPSHOT always, meaning lock watches are effectively off.", "url": "https://github.com/palantir/atlasdb/pull/4799#discussion_r431429361", "createdAt": "2020-05-27T20:42:03Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/transaction/api/OpenTransactions.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.transaction.api;\n+\n+import java.util.List;\n+import java.util.Optional;\n+\n+import com.palantir.lock.watch.IdentifiedVersion;\n+import com.palantir.lock.watch.TransactionsLockWatchEvents;\n+\n+public interface OpenTransactions {\n+\n+    List<OpenTransaction> getTransactions();\n+\n+    /**\n+     * Returns a condensed view of new lock watch events since lastKnownVersion for the set of started transactions.\n+     *\n+     * @param lastKnownVersion exclusive start version to get events from\n+     */\n+    TransactionsLockWatchEvents getEvents(Optional<IdentifiedVersion> lastKnownVersion);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTQwNTYwNA=="}, "originalCommit": {"oid": "9a0bd72bc0cfc1e29497ff1570d227b9bd40636e"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2881, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}