{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3Mzk0NTE4", "number": 4986, "title": "Reject requests if corruption", "bodyText": "Goals (and why):\nFinal piece of TimeLock shooting itself upon detecting local/ remote corruption.\nImplementation Description (bullets):\n\n\nAdded a Jersey filter + Undertow handler to reject requests at RPC level if detected corruption.\n\n\nWrap undertow endpoints in corruption handler while registering undertow resources.\n\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nTested on internal test stack\n\nConcerns (what feedback would you like?):\n\nHave I missed out something in filter + handler implementation?\n\nWhere should we start reviewing?:\nUndertowCorruptionHandlerService.java, JerseyCorruptionFilter.java\nPriority (whenever / two weeks / yesterday):\nEOD Wednesday would be great.", "createdAt": "2020-09-15T15:52:18Z", "url": "https://github.com/palantir/atlasdb/pull/4986", "merged": true, "mergeCommit": {"oid": "0ea8a09989025427b6ab2c3008f6d927edb31608"}, "closed": true, "closedAt": "2020-09-23T15:19:32Z", "author": {"login": "sudiksha27"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJJ3AjgH2gAyNDg3Mzk0NTE4Ojk3MzZmOTkwMTg4ZjY2YWI0NzQ1ODIyMDIzYWIyMDhlNjRlN2FmZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdMbI1ogFqTQ5Njc1NjUxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9736f990188f66ab4745822023ab208e64e7afe8", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/9736f990188f66ab4745822023ab208e64e7afe8", "committedDate": "2020-09-15T15:51:47Z", "message": "Reject requests if corruption"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f476cd5b835d283d17fb6057eab3c2d3903a331", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/3f476cd5b835d283d17fb6057eab3c2d3903a331", "committedDate": "2020-09-15T18:04:22Z", "message": "Minor refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NTEzOTM5", "url": "https://github.com/palantir/atlasdb/pull/4986#pullrequestreview-489513939", "createdAt": "2020-09-16T11:05:12Z", "commit": {"oid": "3f476cd5b835d283d17fb6057eab3c2d3903a331"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMTowNToxM1rOHSrtPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMTowNToxM1rOHSrtPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM1MjUwOA==", "bodyText": "Note - QosException.unavailable returns 200 response and the client may retry at a later time.", "url": "https://github.com/palantir/atlasdb/pull/4986#discussion_r489352508", "createdAt": "2020-09-16T11:05:13Z", "author": {"login": "sudiksha27"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/corruption/UndertowCorruptionHandlerService.java", "diffHunk": "@@ -0,0 +1,59 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.corruption;\n+\n+import java.util.List;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.palantir.common.remoting.ServiceNotAvailableException;\n+import com.palantir.conjure.java.undertow.lib.Endpoint;\n+import com.palantir.conjure.java.undertow.lib.UndertowRuntime;\n+import com.palantir.conjure.java.undertow.lib.UndertowService;\n+\n+import io.undertow.server.HandlerWrapper;\n+\n+public class UndertowCorruptionHandlerService implements UndertowService {\n+    private final UndertowService delegate;\n+    private final HandlerWrapper wrapper;\n+    private final CorruptionHealthCheck healthCheck;\n+\n+    public UndertowCorruptionHandlerService(UndertowService service, CorruptionHealthCheck healthCheck) {\n+        this.delegate = service;\n+        this.healthCheck = healthCheck;\n+        this.wrapper = handler -> exchange -> {\n+            if (healthCheck.isHealthy()) {\n+                handler.handleRequest(exchange);\n+            } else {\n+                throw new ServiceNotAvailableException(\"TimeLock is not available on account of data corruption.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f476cd5b835d283d17fb6057eab3c2d3903a331"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "728157d98fb3d3176a8524aa78b3b844594e5cc6", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/728157d98fb3d3176a8524aa78b3b844594e5cc6", "committedDate": "2020-09-16T21:04:46Z", "message": "Update UndertowCorruptionHandlerService.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3398fbd2c62480a58c0376e1f24b3fb7a9453b03", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/3398fbd2c62480a58c0376e1f24b3fb7a9453b03", "committedDate": "2020-09-16T21:05:23Z", "message": "Update JerseyCorruptionFilter.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0ce165d59eaaf5708193e85d1a0188e4892961c", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/d0ce165d59eaaf5708193e85d1a0188e4892961c", "committedDate": "2020-09-16T21:53:19Z", "message": "Json response message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaae88d1cdbd1d3a8bfc466d24f5a719b88b0df2", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/aaae88d1cdbd1d3a8bfc466d24f5a719b88b0df2", "committedDate": "2020-09-16T21:54:25Z", "message": "Service unavailable exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a825c719dad92f54a0870467ec204ddb36d52e21", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/a825c719dad92f54a0870467ec204ddb36d52e21", "committedDate": "2020-09-17T09:34:53Z", "message": "Refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNDUzMjQx", "url": "https://github.com/palantir/atlasdb/pull/4986#pullrequestreview-490453241", "createdAt": "2020-09-17T10:24:58Z", "commit": {"oid": "a825c719dad92f54a0870467ec204ddb36d52e21"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMDoyNDo1OFrOHTbkYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMDoyOTozM1rOHTbt0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDEzNjY3NA==", "bodyText": "This should be consistent with the other QoS exceptions we get.", "url": "https://github.com/palantir/atlasdb/pull/4986#discussion_r490136674", "createdAt": "2020-09-17T10:24:58Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/corruption/Constants.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.corruption;\n+\n+public final class Constants {\n+    private Constants() {\n+        // no op\n+    }\n+\n+    public static final String CORRUPTION_MESSAGE\n+            = \"{\\\"error\\\": \\\"TimeLock is not available on account of data corruption.\\\"}\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a825c719dad92f54a0870467ec204ddb36d52e21"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDEzOTA4OA==", "bodyText": "I don't think this is needed if we standardise with internal frameworks.", "url": "https://github.com/palantir/atlasdb/pull/4986#discussion_r490139088", "createdAt": "2020-09-17T10:29:33Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/corruption/UndertowCorruptionHandlerService.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.corruption;\n+\n+import java.util.List;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.palantir.conjure.java.undertow.lib.Endpoint;\n+import com.palantir.conjure.java.undertow.lib.UndertowRuntime;\n+import com.palantir.conjure.java.undertow.lib.UndertowService;\n+\n+import io.undertow.server.HandlerWrapper;\n+import io.undertow.util.Headers;\n+import io.undertow.util.StatusCodes;\n+\n+public class UndertowCorruptionHandlerService implements UndertowService {\n+    private final UndertowService delegate;\n+    private final HandlerWrapper wrapper;\n+    private final CorruptionHealthCheck healthCheck;\n+\n+    public UndertowCorruptionHandlerService(UndertowService service, CorruptionHealthCheck healthCheck) {\n+        this.delegate = service;\n+        this.healthCheck = healthCheck;\n+        this.wrapper = handler -> exchange -> {\n+            if (healthCheck.isHealthy()) {\n+                handler.handleRequest(exchange);\n+            } else {\n+                exchange.setStatusCode(StatusCodes.SERVICE_UNAVAILABLE);\n+                exchange.getResponseHeaders().put(Headers.CONTENT_TYPE, \"application/json\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a825c719dad92f54a0870467ec204ddb36d52e21"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b50c4e13c141861cdcbd4c69e8a4f3ecf5b7f01d", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/b50c4e13c141861cdcbd4c69e8a4f3ecf5b7f01d", "committedDate": "2020-09-17T10:31:50Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b47183d77af8f49caf6ccd150475a918d18c99fc", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/b47183d77af8f49caf6ccd150475a918d18c99fc", "committedDate": "2020-09-17T10:31:50Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNjAwNDQz", "url": "https://github.com/palantir/atlasdb/pull/4986#pullrequestreview-492600443", "createdAt": "2020-09-21T13:29:20Z", "commit": {"oid": "b50c4e13c141861cdcbd4c69e8a4f3ecf5b7f01d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de406edae9eb287bbb3823ef944499dbd1158ac0", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/de406edae9eb287bbb3823ef944499dbd1158ac0", "committedDate": "2020-09-23T12:32:11Z", "message": "Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NzU2NTE3", "url": "https://github.com/palantir/atlasdb/pull/4986#pullrequestreview-496756517", "createdAt": "2020-09-25T19:41:25Z", "commit": {"oid": "de406edae9eb287bbb3823ef944499dbd1158ac0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOTo0MToyNVrOHYQVNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxOTo0MToyNVrOHYQVNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE5NTQ0Nw==", "bodyText": "as a note, you can here throw QosException.unavailabe() and induce the same behaviour", "url": "https://github.com/palantir/atlasdb/pull/4986#discussion_r495195447", "createdAt": "2020-09-25T19:41:25Z", "author": {"login": "j-baker"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/corruption/UndertowCorruptionHandlerService.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.corruption;\n+\n+import java.util.List;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.palantir.conjure.java.undertow.lib.Endpoint;\n+import com.palantir.conjure.java.undertow.lib.UndertowRuntime;\n+import com.palantir.conjure.java.undertow.lib.UndertowService;\n+\n+import io.undertow.server.HandlerWrapper;\n+import io.undertow.util.Headers;\n+import io.undertow.util.StatusCodes;\n+\n+public class UndertowCorruptionHandlerService implements UndertowService {\n+    private final UndertowService delegate;\n+    private final HandlerWrapper wrapper;\n+    private final CorruptionHealthCheck healthCheck;\n+\n+    public UndertowCorruptionHandlerService(UndertowService service, CorruptionHealthCheck healthCheck) {\n+        this.delegate = service;\n+        this.healthCheck = healthCheck;\n+        this.wrapper = handler -> exchange -> {\n+            if (healthCheck.isHealthy()) {\n+                handler.handleRequest(exchange);\n+            } else {\n+                exchange.setStatusCode(StatusCodes.SERVICE_UNAVAILABLE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de406edae9eb287bbb3823ef944499dbd1158ac0"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2573, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}