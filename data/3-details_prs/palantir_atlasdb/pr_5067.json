{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NjQyMjc1", "number": 5067, "title": "Increase error-prone reference comparison strictness", "bodyText": "Goals (and why):\nIncrease strictness of error-prone checks to prevent issues as resolved in #5039\nImplementation Description (bullets):\nPromote BoxedPrimitiveEquality and ReferenceEquality to errors.\nIgnore errors and warnings in generated code.\nTesting (What was existing testing like?  What have you done to improve it?):\nLocal compilation\nConcerns (what feedback would you like?):\nWhere should we start reviewing?:\nbuild.gradle\nPriority (whenever / two weeks / yesterday):\nWhenever", "createdAt": "2020-10-21T15:36:38Z", "url": "https://github.com/palantir/atlasdb/pull/5067", "merged": true, "mergeCommit": {"oid": "5441d24e02bef038e6ba28fa41cd48f889ce0114"}, "closed": true, "closedAt": "2020-11-09T18:27:01Z", "author": {"login": "schlosna"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdU-LpCgFqTUxNDUwMjUxNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABda5C1WgFqTUyNjUzNDMwNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NTAyNTE0", "url": "https://github.com/palantir/atlasdb/pull/5067#pullrequestreview-514502514", "createdAt": "2020-10-22T08:54:16Z", "commit": {"oid": "8f1cadfd0bdb5d7f490a9666dceffed0f999e555"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwODo1NDoxNlrOHmXeLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwOTowMjowM1rOHmXzXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk5MjQ5Mg==", "bodyText": "(Just an observation): this replaces google's deprecated Objects.equal with the java.util.Objects one. \ud83d\udc4d", "url": "https://github.com/palantir/atlasdb/pull/5067#discussion_r509992492", "createdAt": "2020-10-22T08:54:16Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/ColumnFamilyDefinitions.java", "diffHunk": "@@ -169,7 +169,7 @@ static boolean isMatchingCf(CfDef clientSide, CfDef clusterSide) {\n                     clusterSide.compression_options.get(CassandraConstants.CFDEF_COMPRESSION_CHUNK_LENGTH_KEY));\n             return false;\n         }\n-        if (!Objects.equal(clientSide.compaction_strategy, clusterSide.compaction_strategy)) {\n+        if (!Objects.equals(clientSide.compaction_strategy, clusterSide.compaction_strategy)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f1cadfd0bdb5d7f490a9666dceffed0f999e555"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk5NDM0Nw==", "bodyText": "I'm not sure about this one - reading the comment where this is called:\n    // because unfortunately .equals takes into account if fields with defaults are populated or not\n    // also because compression_options after serialization / deserialization comes back as blank\n    // for the ones we set 4K chunk on... ?!\n\nMy guess is that the intention is to compare references in this first check. An extra test around this would help verify whether this refactor would break it or not.", "url": "https://github.com/palantir/atlasdb/pull/5067#discussion_r509994347", "createdAt": "2020-10-22T08:57:00Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/ColumnFamilyDefinitions.java", "diffHunk": "@@ -206,7 +206,7 @@ private static void logMismatch(\n     }\n \n     private static boolean equalsIgnoringClasspath(String class1, String class2) {\n-        if (class1 == class2) {\n+        if (Objects.equals(class1, class2)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f1cadfd0bdb5d7f490a9666dceffed0f999e555"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk5NTE4Ng==", "bodyText": "bizarre - what's the actual diff?", "url": "https://github.com/palantir/atlasdb/pull/5067#discussion_r509995186", "createdAt": "2020-10-22T08:58:07Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/time/Clock.java", "diffHunk": "@@ -20,7 +20,7 @@\n public interface Clock {\n     /**\n      * @return The time in milliseconds. This is conventionally interpreted as the number of\n-     *         milliseconds since\u00a01970-01-01T00:00Z excluding leap seconds not included in the\n+     *         milliseconds since 1970-01-01T00:00Z excluding leap seconds not included in the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f1cadfd0bdb5d7f490a9666dceffed0f999e555"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk5NTk1MQ==", "bodyText": "I'm curious as to why you switched these around - there is a null check directly above which ensures that we don't call .equals on a null.", "url": "https://github.com/palantir/atlasdb/pull/5067#discussion_r509995951", "createdAt": "2020-10-22T08:59:10Z", "author": {"login": "Jolyon-S"}, "path": "lock-impl/src/main/java/com/palantir/lock/impl/LockServiceImpl.java", "diffHunk": "@@ -337,7 +337,7 @@ public HeldLocksToken lockAndGetHeldLocks(String client, LockRequest request) th\n     // We're concerned about sanitizing logs at the info level and above. This method just logs at debug and info.\n     public LockResponse lockWithFullLockResponse(LockClient client, LockRequest request) throws InterruptedException {\n         com.palantir.logsafe.Preconditions.checkNotNull(client);\n-        com.palantir.logsafe.Preconditions.checkArgument(!client.equals(INTERNAL_LOCK_GRANT_CLIENT));\n+        com.palantir.logsafe.Preconditions.checkArgument(!INTERNAL_LOCK_GRANT_CLIENT.equals(client));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f1cadfd0bdb5d7f490a9666dceffed0f999e555"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTk5NzkxNw==", "bodyText": "It looks like the difference here is that you'll return false if the clientIds are different (where before, if I understand this correctly, just if the references are the same). Presumably the clientId is supposed to uniquely identify a client, but I haven't dug into the code to verify this.", "url": "https://github.com/palantir/atlasdb/pull/5067#discussion_r509997917", "createdAt": "2020-10-22T09:02:03Z", "author": {"login": "Jolyon-S"}, "path": "lock-impl/src/main/java/com/palantir/lock/impl/LockServiceImpl.java", "diffHunk": "@@ -907,7 +907,7 @@ public HeldLocksGrant convertToGrant(HeldLocksToken token) {\n     @Override\n     public HeldLocksToken useGrant(LockClient client, HeldLocksGrant grant) {\n         com.palantir.logsafe.Preconditions.checkNotNull(client);\n-        com.palantir.logsafe.Preconditions.checkArgument(client != INTERNAL_LOCK_GRANT_CLIENT);\n+        com.palantir.logsafe.Preconditions.checkArgument(!INTERNAL_LOCK_GRANT_CLIENT.equals(client));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f1cadfd0bdb5d7f490a9666dceffed0f999e555"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0OTg4NjEx", "url": "https://github.com/palantir/atlasdb/pull/5067#pullrequestreview-514988611", "createdAt": "2020-10-22T18:03:41Z", "commit": {"oid": "0396699bf0780f0e2d5f290548de515417d4eb13"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxODowMzo0MVrOHmtuhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxODowMzo0MVrOHmtuhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDM1NzEyNQ==", "bodyText": "These are not technically required with gradle-baseline 3.43.0+ per palantir/gradle-baseline#1514 so curious if folks want to remove them from here or leave them to be explicit in case gradle-baseline relaxes either back to a warning.", "url": "https://github.com/palantir/atlasdb/pull/5067#discussion_r510357125", "createdAt": "2020-10-22T18:03:41Z", "author": {"login": "schlosna"}, "path": "build.gradle", "diffHunk": "@@ -107,8 +107,16 @@ allprojects {\n     }\n \n     tasks.withType(JavaCompile) {\n-        // temporarily relax constraints until we can fix all violations\n-        options.errorprone.warn 'CatchBlockLogException',\n+        options.errorprone {\n+            disableWarningsInGeneratedCode = true\n+            excludedPaths = '.*(generated).*'\n+\n+            // increase specific warnings to error until we can treat all warnings as errors\n+            error 'BoxedPrimitiveEquality',\n+                'ReferenceEquality'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0396699bf0780f0e2d5f290548de515417d4eb13"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0396699bf0780f0e2d5f290548de515417d4eb13", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/0396699bf0780f0e2d5f290548de515417d4eb13", "committedDate": "2020-10-22T12:47:33Z", "message": "Test coverage for ColumnFamilyDefinitions.equalsIgnoringClasspath"}, "afterCommit": {"oid": "1fec81f72dc8aca631989428615b466a019baea2", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/1fec81f72dc8aca631989428615b466a019baea2", "committedDate": "2020-10-27T14:56:14Z", "message": "Test coverage for ColumnFamilyDefinitions.equalsIgnoringClasspath"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1fec81f72dc8aca631989428615b466a019baea2", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/1fec81f72dc8aca631989428615b466a019baea2", "committedDate": "2020-10-27T14:56:14Z", "message": "Test coverage for ColumnFamilyDefinitions.equalsIgnoringClasspath"}, "afterCommit": {"oid": "0081b02b190bee5253df9cf4ad3feb749a2541db", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/0081b02b190bee5253df9cf4ad3feb749a2541db", "committedDate": "2020-10-27T15:08:37Z", "message": "Test coverage for ColumnFamilyDefinitions.equalsIgnoringClasspath"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTA2MDMy", "url": "https://github.com/palantir/atlasdb/pull/5067#pullrequestreview-517906032", "createdAt": "2020-10-27T16:30:13Z", "commit": {"oid": "0081b02b190bee5253df9cf4ad3feb749a2541db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozMDoxM1rOHpFiOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozMDoxM1rOHpFiOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NDM0Nw==", "bodyText": "Isn't this already set by default? Much of our generated code (protobuf) isn't annotated @Generated, so it doesn't help there.\nI updated the build scripts in the -protobufs projects to opt out of error-prone.", "url": "https://github.com/palantir/atlasdb/pull/5067#discussion_r512844347", "createdAt": "2020-10-27T16:30:13Z", "author": {"login": "carterkozak"}, "path": "build.gradle", "diffHunk": "@@ -107,9 +107,12 @@ allprojects {\n     }\n \n     tasks.withType(JavaCompile) {\n-        options.compilerArgs += ['-Werror']\n-        // temporarily relax constraints until we can fix all violations\n-        options.errorprone.disable 'AlmostJavadoc', \n+        options.errorprone {\n+            disableWarningsInGeneratedCode = true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0081b02b190bee5253df9cf4ad3feb749a2541db"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTA2Nzcy", "url": "https://github.com/palantir/atlasdb/pull/5067#pullrequestreview-517906772", "createdAt": "2020-10-27T16:30:57Z", "commit": {"oid": "0081b02b190bee5253df9cf4ad3feb749a2541db"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozMDo1N1rOHpFktQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxNjozMDo1N1rOHpFktQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0NDk4MQ==", "bodyText": "Is this necessary? I'm worried about paths that include a generated substring being ignored. I think this will replace the default excludedPaths configuration.", "url": "https://github.com/palantir/atlasdb/pull/5067#discussion_r512844981", "createdAt": "2020-10-27T16:30:57Z", "author": {"login": "carterkozak"}, "path": "build.gradle", "diffHunk": "@@ -107,9 +107,12 @@ allprojects {\n     }\n \n     tasks.withType(JavaCompile) {\n-        options.compilerArgs += ['-Werror']\n-        // temporarily relax constraints until we can fix all violations\n-        options.errorprone.disable 'AlmostJavadoc', \n+        options.errorprone {\n+            disableWarningsInGeneratedCode = true\n+            excludedPaths = '.*(generated).*'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0081b02b190bee5253df9cf4ad3feb749a2541db"}, "originalPosition": 9}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0081b02b190bee5253df9cf4ad3feb749a2541db", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/0081b02b190bee5253df9cf4ad3feb749a2541db", "committedDate": "2020-10-27T15:08:37Z", "message": "Test coverage for ColumnFamilyDefinitions.equalsIgnoringClasspath"}, "afterCommit": {"oid": "e067e78302dab312cd31bbbf2a2b15cd7cf67e29", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/e067e78302dab312cd31bbbf2a2b15cd7cf67e29", "committedDate": "2020-10-28T13:49:39Z", "message": "format after schema generation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9e5bd76e8fbb0bf3782863e3e4120f9d382e291", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/a9e5bd76e8fbb0bf3782863e3e4120f9d382e291", "committedDate": "2020-10-30T14:25:35Z", "message": "Fix non-ASCII character error\n\nResolves following error from non-breaking space in JavaDoc\n\natlasdb-commons/src/main/java/com/palantir/common/time/Clock.java:23: error: unmappable character (0xC2) for encoding US-ASCII\natlasdb-commons/src/main/java/com/palantir/common/time/Clock.java:23: error: unmappable character (0xA0) for encoding US-ASCII"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68900a2ab88fcbef14155faaf549245ee216948a", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/68900a2ab88fcbef14155faaf549245ee216948a", "committedDate": "2020-10-30T14:25:35Z", "message": "Treat ReferenceEquality as error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d873eb237f19fcbcc75d7032b580f2cb14970fd9", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/d873eb237f19fcbcc75d7032b580f2cb14970fd9", "committedDate": "2020-10-30T14:25:35Z", "message": "Address ReferenceEquality findings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b623a5d4f84261b36099f89df7bbec48dc14ec0", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/2b623a5d4f84261b36099f89df7bbec48dc14ec0", "committedDate": "2020-10-30T14:25:35Z", "message": "Test coverage for ColumnFamilyDefinitions.equalsIgnoringClasspath"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49a1ec17e76146d21aea770b8e6fbf04739d37a9", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/49a1ec17e76146d21aea770b8e6fbf04739d37a9", "committedDate": "2020-10-30T14:25:35Z", "message": "Fix ReferenceEquality in generated stream store code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a32fc6f53a62f75c3685708814c4d440b6a87703", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/a32fc6f53a62f75c3685708814c4d440b6a87703", "committedDate": "2020-10-30T14:25:35Z", "message": "StreamStoreRenderer prefers collection constructors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff4ed58a5c7ad99f2ed4f5811c0b584caa8ce122", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/ff4ed58a5c7ad99f2ed4f5811c0b584caa8ce122", "committedDate": "2020-10-30T14:25:35Z", "message": "Rendered stream store prefers collection constructors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0a75818993b80bfcd567eff688875896454d708", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/b0a75818993b80bfcd567eff688875896454d708", "committedDate": "2020-10-30T14:25:35Z", "message": "format after schema generation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e067e78302dab312cd31bbbf2a2b15cd7cf67e29", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/e067e78302dab312cd31bbbf2a2b15cd7cf67e29", "committedDate": "2020-10-28T13:49:39Z", "message": "format after schema generation"}, "afterCommit": {"oid": "b0a75818993b80bfcd567eff688875896454d708", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/b0a75818993b80bfcd567eff688875896454d708", "committedDate": "2020-10-30T14:25:35Z", "message": "format after schema generation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89fd29cd42a7262d0b37e3856ad807b8a0814d03", "author": {"user": {"login": "schlosna", "name": "David Schlosnagle"}}, "url": "https://github.com/palantir/atlasdb/commit/89fd29cd42a7262d0b37e3856ad807b8a0814d03", "committedDate": "2020-10-30T15:04:25Z", "message": "Remove unnecessary parentheses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2e8e78a3e19170015275feace76483e15f7b6d6", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/d2e8e78a3e19170015275feace76483e15f7b6d6", "committedDate": "2020-11-09T17:11:05Z", "message": "Merge with develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NTE0OTE3", "url": "https://github.com/palantir/atlasdb/pull/5067#pullrequestreview-526514917", "createdAt": "2020-11-09T18:01:37Z", "commit": {"oid": "d2e8e78a3e19170015275feace76483e15f7b6d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NTM0MzA1", "url": "https://github.com/palantir/atlasdb/pull/5067#pullrequestreview-526534305", "createdAt": "2020-11-09T18:26:57Z", "commit": {"oid": "d2e8e78a3e19170015275feace76483e15f7b6d6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2412, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}