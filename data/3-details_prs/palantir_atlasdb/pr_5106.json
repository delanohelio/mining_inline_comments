{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NzQ5NTg5", "number": 5106, "title": "[LW] Check the correct client versions range", "bodyText": "Goals (and why):\n\nTurns out that we were checking the wrong version range for validation. We should check that the events returned enclose (userVersion, latestTimestampVersion], but we were actually checking [earliestTimestampVersion, latestTimestampVersion].\n\nImplementation Description (bullets):\n\nFixed the bug as listed above.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nAdded yet another test. This was caught by the ETE test PR, so that will also help.\n\nConcerns (what feedback would you like?):\n\nIs this finally right?\n\nWhere should we start reviewing?:\n\nClientLogEvents\n\nPriority (whenever / two weeks / yesterday):\nThis week.", "createdAt": "2020-11-09T13:04:05Z", "url": "https://github.com/palantir/atlasdb/pull/5106", "merged": true, "mergeCommit": {"oid": "32b371c82a4deab5bdb41d062846c8ab92deebeb"}, "closed": true, "closedAt": "2020-11-11T16:14:40Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABda0ZbLAH2gAyNTE3NzQ5NTg5OmI4MWMzYzI3YmI2ZWUyYzg2YzJjNjE2YzJmOWFjMzU1ZjNlZTBlNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbgBelAH2gAyNTE3NzQ5NTg5Ojc4ZThlZTc1MjJhMDVkZmNlMmY5MDFjMzRjMWRjNDRjN2ZiZDYyMWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b81c3c27bb6ee2c86c2c616c2f9ac355f3ee0e77", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/b81c3c27bb6ee2c86c2c616c2f9ac355f3ee0e77", "committedDate": "2020-11-09T13:02:06Z", "message": "caught another one"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8717a3fcfd4984552b1b821a6ad2f3b04fb26e7b", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/8717a3fcfd4984552b1b821a6ad2f3b04fb26e7b", "committedDate": "2020-11-09T13:02:06Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MjQ0ODk1", "url": "https://github.com/palantir/atlasdb/pull/5106#pullrequestreview-528244895", "createdAt": "2020-11-11T14:55:18Z", "commit": {"oid": "8717a3fcfd4984552b1b821a6ad2f3b04fb26e7b"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDo1NToxOVrOHxQnQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNTowNzowOFrOHxRG8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQxNDQ2Ng==", "bodyText": "...ensure that events are present for each version starting with client version (exclusive) and ending with transaction version (inclusive).", "url": "https://github.com/palantir/atlasdb/pull/5106#discussion_r521414466", "createdAt": "2020-11-11T14:55:19Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ClientLogEvents.java", "diffHunk": "@@ -53,14 +53,20 @@\n \n     default TransactionsLockWatchUpdate toTransactionsLockWatchUpdate(\n             TimestampMapping timestampMapping, Optional<LockWatchVersion> lastKnownVersion) {\n-        // If the client is at the same version as the earliest version in the timestamp mapping, then they will\n-        // only receive versions after that - and therefore the range of versions coming back from the events will not\n-        // enclose the versions in the mapping. This flag makes sure that we don't throw on this case\n-        boolean offsetStartVersion = lastKnownVersion\n-                .map(version ->\n-                        version.version() == timestampMapping.versionRange().lowerEndpoint())\n-                .orElse(false);\n-        verifyReturnedEventsEnclosesTransactionVersions(timestampMapping.versionRange(), offsetStartVersion);\n+        /*\n+         Case 1: client is behind earliest transaction. Therefore we want to ensure that there are events from", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8717a3fcfd4984552b1b821a6ad2f3b04fb26e7b"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQxODczMg==", "bodyText": "Range.openClosed so you don't need to do +1 on the lower bound everywhere", "url": "https://github.com/palantir/atlasdb/pull/5106#discussion_r521418732", "createdAt": "2020-11-11T15:01:30Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ClientLogEvents.java", "diffHunk": "@@ -73,28 +79,23 @@ default CommitUpdate toCommitUpdate(LockWatchVersion startVersion, CommitInfo co\n             return ImmutableInvalidateAll.builder().build();\n         }\n \n+        // We want to ensure that we do not miss any versions, but we do not care about the event with the same version\n+        // as the start version.\n         verifyReturnedEventsEnclosesTransactionVersions(\n-                Range.closed(startVersion.version(), commitInfo.commitVersion().version()), true);\n+                startVersion.version() + 1, commitInfo.commitVersion().version());\n \n         LockEventVisitor eventVisitor = new LockEventVisitor(commitInfo.commitLockToken());\n         Set<LockDescriptor> locksTakenOut = new HashSet<>();\n         events().events().forEach(event -> locksTakenOut.addAll(event.accept(eventVisitor)));\n         return ImmutableInvalidateSome.builder().invalidatedLocks(locksTakenOut).build();\n     }\n \n-    default void verifyReturnedEventsEnclosesTransactionVersions(Range<Long> versionRange, boolean offsetStartVersion) {\n-        // If we offset the start version, but the range is already [x..x], we throw when creating the range.\n-        if (versionRange.lowerEndpoint().equals(versionRange.upperEndpoint()) && offsetStartVersion) {\n+    default void verifyReturnedEventsEnclosesTransactionVersions(long lowerBound, long upperBound) {\n+        if (lowerBound > upperBound) {\n             return;\n         }\n \n-        Range<Long> rangeToTest;\n-        if (offsetStartVersion) {\n-            rangeToTest = Range.closed(versionRange.lowerEndpoint() + 1, versionRange.upperEndpoint());\n-        } else {\n-            rangeToTest = versionRange;\n-        }\n-\n+        Range<Long> rangeToTest = Range.closed(lowerBound, upperBound);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8717a3fcfd4984552b1b821a6ad2f3b04fb26e7b"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQyMjU3OQ==", "bodyText": "Though I guess you need a -1 :D", "url": "https://github.com/palantir/atlasdb/pull/5106#discussion_r521422579", "createdAt": "2020-11-11T15:07:08Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ClientLogEvents.java", "diffHunk": "@@ -73,28 +79,23 @@ default CommitUpdate toCommitUpdate(LockWatchVersion startVersion, CommitInfo co\n             return ImmutableInvalidateAll.builder().build();\n         }\n \n+        // We want to ensure that we do not miss any versions, but we do not care about the event with the same version\n+        // as the start version.\n         verifyReturnedEventsEnclosesTransactionVersions(\n-                Range.closed(startVersion.version(), commitInfo.commitVersion().version()), true);\n+                startVersion.version() + 1, commitInfo.commitVersion().version());\n \n         LockEventVisitor eventVisitor = new LockEventVisitor(commitInfo.commitLockToken());\n         Set<LockDescriptor> locksTakenOut = new HashSet<>();\n         events().events().forEach(event -> locksTakenOut.addAll(event.accept(eventVisitor)));\n         return ImmutableInvalidateSome.builder().invalidatedLocks(locksTakenOut).build();\n     }\n \n-    default void verifyReturnedEventsEnclosesTransactionVersions(Range<Long> versionRange, boolean offsetStartVersion) {\n-        // If we offset the start version, but the range is already [x..x], we throw when creating the range.\n-        if (versionRange.lowerEndpoint().equals(versionRange.upperEndpoint()) && offsetStartVersion) {\n+    default void verifyReturnedEventsEnclosesTransactionVersions(long lowerBound, long upperBound) {\n+        if (lowerBound > upperBound) {\n             return;\n         }\n \n-        Range<Long> rangeToTest;\n-        if (offsetStartVersion) {\n-            rangeToTest = Range.closed(versionRange.lowerEndpoint() + 1, versionRange.upperEndpoint());\n-        } else {\n-            rangeToTest = versionRange;\n-        }\n-\n+        Range<Long> rangeToTest = Range.closed(lowerBound, upperBound);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQxODczMg=="}, "originalCommit": {"oid": "8717a3fcfd4984552b1b821a6ad2f3b04fb26e7b"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3a2e3ed4bb9685d80106f5f1e7b76d3dd39e2d8", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/b3a2e3ed4bb9685d80106f5f1e7b76d3dd39e2d8", "committedDate": "2020-11-11T15:51:36Z", "message": "literally just change a comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78e8ee7522a05dfce2f901c34c1dc44c7fbd621b", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/78e8ee7522a05dfce2f901c34c1dc44c7fbd621b", "committedDate": "2020-11-11T15:51:46Z", "message": "Merge branch 'lw/mid-version-fix' of github.com:palantir/atlasdb into lw/mid-version-fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2495, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}