{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMzk1NDYw", "number": 4499, "title": "[Timelock Partitioning] Part 44g: Use client scoped metrics registries.", "bodyText": "Goals (and why):\nGo one level deeper for TaggedMetricRegistries. Reverts most of the new code in #4494.\nImplementation Description (bullets):\n\nHave a ClientScopedMetrics class that when given a \"parent\" registry, creates new registries keyed by the Client - or more aptly named \"namespace\" - in the parent registry.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nExisting metrics test should pass.\nWhere should we start reviewing?:\nAnywhere.\nPriority (whenever / two weeks / yesterday):\nWhenever, what's in develop is correct, this just tidies things up.", "createdAt": "2020-01-10T10:58:16Z", "url": "https://github.com/palantir/atlasdb/pull/4499", "merged": true, "mergeCommit": {"oid": "22447a4213a83710b3669ee20ee3d251d2e665b1"}, "closed": true, "closedAt": "2020-01-13T13:50:39Z", "author": {"login": "felixdesouza"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb48U_PgH2gAyMzYxMzk1NDYwOjcwYmQzYTYzNjY0ZWMyNDM0MzA0ZGY4MTY5MjEwOTM5ZTg2MTVlZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb58rXagFqTM0MTg1NTE1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "70bd3a63664ec2434304df8169210939e8615ee9", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/70bd3a63664ec2434304df8169210939e8615ee9", "committedDate": "2020-01-10T10:51:55Z", "message": "Use client scoped metrics registries."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxODUzMDYw", "url": "https://github.com/palantir/atlasdb/pull/4499#pullrequestreview-341853060", "createdAt": "2020-01-13T13:47:02Z", "commit": {"oid": "70bd3a63664ec2434304df8169210939e8615ee9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMzo0NzowMlrOFc3XFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMzo0NzowMlrOFc3XFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgxMTQ3OQ==", "bodyText": "This thing feels weird, discussed offline.", "url": "https://github.com/palantir/atlasdb/pull/4499#discussion_r365811479", "createdAt": "2020-01-13T13:47:02Z", "author": {"login": "jkozlowski"}, "path": "timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/TimelockLeadershipMetrics.java", "diffHunk": "@@ -112,14 +96,11 @@ public static AutobatchingLeadershipObserverFactory createFactory(TimelockPaxosM\n \n     private static Consumer<SetMultimap<LeadershipEvent, Client>> deregisterMetricsForPartitionedLeader(\n             TimelockPaxosMetrics metrics) {\n-        return eventsToDeregister -> {\n-            Map<LeadershipEvent, Set<String>> eventsToClients = Multimaps.asMap(KeyedStream.stream(eventsToDeregister)\n-                    .map(Client::value)\n-                    .collectToSetMultimap());\n-            eventsToClients.forEach((event, clients) -> metrics.asMetricsManager().deregisterTaggedMetrics(\n-                    withTagIsCurrentSuspectedLeader(event.isCurrentSuspectedLeader())\n-                            .and(withClientTag(clients))));\n-        };\n+        return eventsToDeregister ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70bd3a63664ec2434304df8169210939e8615ee9"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxODU1MTU1", "url": "https://github.com/palantir/atlasdb/pull/4499#pullrequestreview-341855155", "createdAt": "2020-01-13T13:50:17Z", "commit": {"oid": "70bd3a63664ec2434304df8169210939e8615ee9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2356, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}