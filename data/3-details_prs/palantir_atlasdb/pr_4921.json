{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MzE3ODQ1", "number": 4921, "title": "[PD$-110002] Part 13: Filter Resiliency", "bodyText": "Goals (and why):\n\nMetrics filters shouldn't cause metrics to broadly not be published. This may cause issues when bootstrapping a cluster of leader-block users, and also if timelock is inaccessible (though it may not be the primary concern in that case...)\n\nImplementation Description (bullets):\n\nIf testing a filter throws an exception, treat that as returning true.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nAdded tests for handling of exceptions\n\nConcerns (what feedback would you like?):\n\nWill there be log spam?\nDoing an RPC inside getMetrics() is kind of crap, but since it only happens every 5 minutes in practice (see cached composed supplier) I don't see it as an issue.\n\nWhere should we start reviewing?: MetricPublicationArbiter, or its test\nPriority (whenever / two weeks / yesterday): today - internal security product is I think unblocked, but this is a genuine bug.", "createdAt": "2020-07-29T09:38:41Z", "url": "https://github.com/palantir/atlasdb/pull/4921", "merged": true, "mergeCommit": {"oid": "7055f8df76ffe4ce6feac213896628cc40b2cb59"}, "closed": true, "closedAt": "2020-07-29T17:29:51Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5nok5gH2gAyNDU4MzE3ODQ1OjYxYzVmOTc2ZGEyYTA4YjFjNWZlNDBhNzlhOTllYTMxYzY4YTg5NGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5rBFWAH2gAyNDU4MzE3ODQ1OjY5ZTFmNGQ3YjMxZTBkZmJhZTZjMTc4ODZjMTJjMWMxOGE4NDI4ZGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "61c5f976da2a08b1c5fe40a79a99ea31c68a894d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/61c5f976da2a08b1c5fe40a79a99ea31c68a894d", "committedDate": "2020-07-29T09:30:23Z", "message": "MPA should be resilient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e440bac814df387f22428b7d4c57e906651665c1", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e440bac814df387f22428b7d4c57e906651665c1", "committedDate": "2020-07-29T09:32:47Z", "message": "Update test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "438d1f0f28cfff649a3c5b61bee547892723ca42", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/438d1f0f28cfff649a3c5b61bee547892723ca42", "committedDate": "2020-07-29T09:32:47Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09548dbc5b88bc6cf9be7e905512eaeaa3d606e6", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/09548dbc5b88bc6cf9be7e905512eaeaa3d606e6", "committedDate": "2020-07-29T10:09:10Z", "message": "baseline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9b1d2471cc22664c9608c7f923848acfad67dd5", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d9b1d2471cc22664c9608c7f923848acfad67dd5", "committedDate": "2020-07-29T10:09:20Z", "message": "t Merge branch 'jkong/resilient-filter' of github.com:palantir/atlasdb into jkong/resilient-filter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MzkxMDgx", "url": "https://github.com/palantir/atlasdb/pull/4921#pullrequestreview-457391081", "createdAt": "2020-07-29T10:24:58Z", "commit": {"oid": "d9b1d2471cc22664c9608c7f923848acfad67dd5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NDQ1OTE1", "url": "https://github.com/palantir/atlasdb/pull/4921#pullrequestreview-457445915", "createdAt": "2020-07-29T11:51:43Z", "commit": {"oid": "d9b1d2471cc22664c9608c7f923848acfad67dd5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMTo1MTo0M1rOG405-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMTo1MTo0M1rOG405-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0MDI0OA==", "bodyText": "nit: Prefer catching RuntimeException over Exception to allow the type system to help if we ever add a checked exception to shouldPublish.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                    } catch (RuntimeException e) {", "url": "https://github.com/palantir/atlasdb/pull/4921#discussion_r462240248", "createdAt": "2020-07-29T11:51:43Z", "author": {"login": "carterkozak"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/metrics/MetricPublicationArbiter.java", "diffHunk": "@@ -48,7 +54,19 @@ public void registerMetricsFilter(MetricName metricName, MetricPublicationFilter\n                 -> ImmutableList.<MetricPublicationFilter>builder().addAll(oldFilters).addAll(newFilter).build());\n     }\n \n-    private static boolean allFiltersMatch(List<MetricPublicationFilter> relevantFilters) {\n-        return relevantFilters.stream().allMatch(MetricPublicationFilter::shouldPublish);\n+    private static boolean allFiltersMatch(MetricName metricName, List<MetricPublicationFilter> relevantFilters) {\n+        return relevantFilters.stream().allMatch(filter -> safeShouldPublish(metricName, filter));\n+    }\n+\n+    private static boolean safeShouldPublish(MetricName metricName, MetricPublicationFilter filter) {\n+        try {\n+            return filter.shouldPublish();\n+        } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9b1d2471cc22664c9608c7f923848acfad67dd5"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69e1f4d7b31e0dfbae6c17886c12c1c18a8428dd", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/69e1f4d7b31e0dfbae6c17886c12c1c18a8428dd", "committedDate": "2020-07-29T13:26:52Z", "message": "Update atlasdb-api/src/main/java/com/palantir/atlasdb/metrics/MetricPublicationArbiter.java\n\nCo-authored-by: Carter Kozak <ckozak@ckozak.net>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2760, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}