{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNzY5MjQ5", "number": 4959, "title": "[LW] Fixes, 3: Additional logging towards fixing obscure bug", "bodyText": "Goals (and why):\nIn production, there were gaps here, but no logging as to why. Ideally, I'll work this out without having to keep trying on production, but may as well have this logging too.\nImplementation Description (bullets):\nAdd safearg logging\nTesting (What was existing testing like?  What have you done to improve it?):\nTests exist for this, but probably not at a full integration level.\nConcerns (what feedback would you like?):\nThese args are safe, right?\nWhere should we start reviewing?:\nLockWatchEventLog\nPriority (whenever / two weeks / yesterday):\nSoon, please!", "createdAt": "2020-08-21T18:01:30Z", "url": "https://github.com/palantir/atlasdb/pull/4959", "merged": true, "mergeCommit": {"oid": "baf80483cc75fe7a04087587af05535d1382d5d0"}, "closed": true, "closedAt": "2020-08-25T10:23:03Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBIskigH2gAyNDcxNzY5MjQ5OjBlN2JiMTg3MGZlZDU2OGU4NjBmOGYxMjRhNzJmM2MzNjM4NzJiN2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCTp34gH2gAyNDcxNzY5MjQ5OjQ3YmVmNjMyZTJiNGZkMTRhYWEzZDU4MzgzMjRjN2ViZWEyNzBhZTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0e7bb1870fed568e860f8f124a72f3c363872b7e", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/0e7bb1870fed568e860f8f124a72f3c363872b7e", "committedDate": "2020-08-21T17:59:05Z", "message": "this is most vexing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0555b3d164fddb28f37051e84119e2503879e468", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/0555b3d164fddb28f37051e84119e2503879e468", "committedDate": "2020-08-24T13:48:06Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e9eb68954a7e42e9adaf30248e2ae67ad64cd82", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/4e9eb68954a7e42e9adaf30248e2ae67ad64cd82", "committedDate": "2020-08-24T13:56:42Z", "message": "more logging for information purposes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzQ5Mzk1", "url": "https://github.com/palantir/atlasdb/pull/4959#pullrequestreview-473349395", "createdAt": "2020-08-24T10:40:45Z", "commit": {"oid": "0e7bb1870fed568e860f8f124a72f3c363872b7e"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMDo0MDo0NlrOHFe5Qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwODo0MDo0NFrOHGNxbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTUxMTEwNg==", "bodyText": "Unsafe arg for the events.", "url": "https://github.com/palantir/atlasdb/pull/4959#discussion_r475511106", "createdAt": "2020-08-24T10:40:46Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java", "diffHunk": "@@ -152,7 +153,9 @@ private void assertEventsAreContiguousAndNoEventsMissing(List<LockWatchEvent> ev\n             Preconditions.checkNotNull(firstEvent, \"First element not preset in list of events\");\n             Preconditions.checkArgument(firstEvent.sequence() < latestVersion.get().version()\n                             || latestVersion.get().version() + 1 == firstEvent.sequence(),\n-                    \"Events missing between last snapshot and this batch of events\");\n+                    \"Events missing between last snapshot and this batch of events\",\n+                    SafeArg.of(\"latestVersionSequence\", latestVersion.get().version()),\n+                    SafeArg.of(\"firstNewVersionSequence\", firstEvent.sequence()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e7bb1870fed568e860f8f124a72f3c363872b7e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3Njk4NA==", "bodyText": "I think you need the same change in CommitTimestampGetter?", "url": "https://github.com/palantir/atlasdb/pull/4959#discussion_r476276984", "createdAt": "2020-08-25T08:37:29Z", "author": {"login": "jkozlowski"}, "path": "lock-api/src/main/java/com/palantir/lock/client/TransactionStarter.java", "diffHunk": "@@ -163,12 +172,36 @@ public void close() {\n         List<StartIdentifiedAtlasDbTransactionResponse> result = new ArrayList<>();\n         while (result.size() < numberOfTransactions) {\n             try {\n+                Optional<IdentifiedVersion> requestedVersion = lockWatchEventCache.lastKnownVersion();\n                 ConjureStartTransactionsResponse response = lockLeaseService.startTransactionsWithWatches(\n-                        lockWatchEventCache.lastKnownVersion(), numberOfTransactions - result.size());\n+                        requestedVersion, numberOfTransactions - result.size());\n                 lockWatchEventCache.processStartTransactionsUpdate(\n                         response.getTimestamps().stream().boxed().collect(Collectors.toSet()),\n                         response.getLockWatchUpdate());\n                 result.addAll(split(response));\n+\n+                if (log.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e9eb68954a7e42e9adaf30248e2ae67ad64cd82"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3ODM1Ng==", "bodyText": "Same here, I think you want unsafe arg for the events?", "url": "https://github.com/palantir/atlasdb/pull/4959#discussion_r476278356", "createdAt": "2020-08-25T08:39:40Z", "author": {"login": "jkozlowski"}, "path": "lock-api/src/main/java/com/palantir/lock/client/TransactionStarter.java", "diffHunk": "@@ -163,12 +172,36 @@ public void close() {\n         List<StartIdentifiedAtlasDbTransactionResponse> result = new ArrayList<>();\n         while (result.size() < numberOfTransactions) {\n             try {\n+                Optional<IdentifiedVersion> requestedVersion = lockWatchEventCache.lastKnownVersion();\n                 ConjureStartTransactionsResponse response = lockLeaseService.startTransactionsWithWatches(\n-                        lockWatchEventCache.lastKnownVersion(), numberOfTransactions - result.size());\n+                        requestedVersion, numberOfTransactions - result.size());\n                 lockWatchEventCache.processStartTransactionsUpdate(\n                         response.getTimestamps().stream().boxed().collect(Collectors.toSet()),\n                         response.getLockWatchUpdate());\n                 result.addAll(split(response));\n+\n+                if (log.isDebugEnabled()) {\n+                    Optional<LockWatchStateUpdate.Success> successfulUpdate = response.getLockWatchUpdate()\n+                            .accept(new LockWatchStateUpdate.Visitor<Optional<LockWatchStateUpdate.Success>>() {\n+                                @Override\n+                                public Optional<LockWatchStateUpdate.Success> visit(\n+                                        LockWatchStateUpdate.Success success) {\n+                                    return Optional.of(success);\n+                                }\n+\n+                                @Override\n+                                public Optional<LockWatchStateUpdate.Success> visit(\n+                                        LockWatchStateUpdate.Snapshot snapshot) {\n+                                    return Optional.empty();\n+                                }\n+                            });\n+\n+                    successfulUpdate.ifPresent(success ->\n+                            log.debug(\"Start transaction batch request and response\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e9eb68954a7e42e9adaf30248e2ae67ad64cd82"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3OTE1MQ==", "bodyText": "And probs extract a small method?", "url": "https://github.com/palantir/atlasdb/pull/4959#discussion_r476279151", "createdAt": "2020-08-25T08:40:44Z", "author": {"login": "jkozlowski"}, "path": "lock-api/src/main/java/com/palantir/lock/client/TransactionStarter.java", "diffHunk": "@@ -163,12 +172,36 @@ public void close() {\n         List<StartIdentifiedAtlasDbTransactionResponse> result = new ArrayList<>();\n         while (result.size() < numberOfTransactions) {\n             try {\n+                Optional<IdentifiedVersion> requestedVersion = lockWatchEventCache.lastKnownVersion();\n                 ConjureStartTransactionsResponse response = lockLeaseService.startTransactionsWithWatches(\n-                        lockWatchEventCache.lastKnownVersion(), numberOfTransactions - result.size());\n+                        requestedVersion, numberOfTransactions - result.size());\n                 lockWatchEventCache.processStartTransactionsUpdate(\n                         response.getTimestamps().stream().boxed().collect(Collectors.toSet()),\n                         response.getLockWatchUpdate());\n                 result.addAll(split(response));\n+\n+                if (log.isDebugEnabled()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI3Njk4NA=="}, "originalCommit": {"oid": "4e9eb68954a7e42e9adaf30248e2ae67ad64cd82"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81fc8a3483ac4d5dd7cfb1066ed6b4de25b0981d", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/81fc8a3483ac4d5dd7cfb1066ed6b4de25b0981d", "committedDate": "2020-08-25T09:02:36Z", "message": "refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ebc33fd62e76d46cd00e977420770a6afe3c9c7", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/2ebc33fd62e76d46cd00e977420770a6afe3c9c7", "committedDate": "2020-08-25T09:03:19Z", "message": "remove imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0Mjg0NjE1", "url": "https://github.com/palantir/atlasdb/pull/4959#pullrequestreview-474284615", "createdAt": "2020-08-25T09:05:16Z", "commit": {"oid": "2ebc33fd62e76d46cd00e977420770a6afe3c9c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwOTowNToxN1rOHGO2MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwOTowNToxN1rOHGO2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjI5Njc1Mg==", "bodyText": "This should be:\nassertThatLoggableExceptionThrownBy(() -> eventCache.processStartTransactionsUpdate(TIMESTAMPS_2,\n                LockWatchStateUpdate.success(LEADER, 5L, ImmutableList.of(UNLOCK_EVENT))))\n                .isExactlyInstanceOf(SafeIllegalArgumentException.class)\n                .hasLogMessage(\"Events missing between last snapshot and this batch of events\");", "url": "https://github.com/palantir/atlasdb/pull/4959#discussion_r476296752", "createdAt": "2020-08-25T09:05:17Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventCacheIntegrationTest.java", "diffHunk": "@@ -298,7 +298,7 @@ public void missedEventThrows() {\n         assertThatThrownBy(() -> eventCache.processStartTransactionsUpdate(TIMESTAMPS_2,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ebc33fd62e76d46cd00e977420770a6afe3c9c7"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0Mjg1NTYy", "url": "https://github.com/palantir/atlasdb/pull/4959#pullrequestreview-474285562", "createdAt": "2020-08-25T09:06:31Z", "commit": {"oid": "2ebc33fd62e76d46cd00e977420770a6afe3c9c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c0f8c158f7937625542ec26e1bb6769bede9a22", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/4c0f8c158f7937625542ec26e1bb6769bede9a22", "committedDate": "2020-08-25T09:06:52Z", "message": "fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47bef632e2b4fd14aaa3d5838324c7ebea270ae4", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/47bef632e2b4fd14aaa3d5838324c7ebea270ae4", "committedDate": "2020-08-25T09:19:01Z", "message": "remove unused params"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2811, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}