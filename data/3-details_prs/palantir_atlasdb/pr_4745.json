{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExNTg5ODg3", "number": 4745, "title": "Log an error if it takes >10 seconds to close executors when shutting down STM", "bodyText": "Goals (and why):\n\nExecutors are closed when SnapshotTransactionManager is closed;\nThe shutdownExecutor method awaits termination but doesn't do anything in the case that termination is slow.\nNow log an error if the executor was not shutdown in under 10 seconds - this may indicate a leak or other error.\n\nImplementation Description (bullets):\n\nLog on slow shutdown of executors during closing\n\nTesting (What was existing testing like?  What have you done to improve it?):\nThere is no testing that these executors (specifically, the deleteExecutor and the getRangesExecutor) close when SnapshotTransactionManager is closed. I have added a test to verify that the deleteExecutor is closed (the other one is created in the constructor and therefore harder to test).\nConcerns (what feedback would you like?):\nWill this catch any meaningful information? A similar thing is done in other places throughout the codebase so I would expect so.\nWhere should we start reviewing?:\nSnapshotTransactionManager\nPriority (whenever / two weeks / yesterday):\nThis week.", "createdAt": "2020-04-30T14:50:35Z", "url": "https://github.com/palantir/atlasdb/pull/4745", "merged": true, "mergeCommit": {"oid": "a87e29fc06cb446677c8c137853058ce969072bf"}, "closed": true, "closedAt": "2020-05-05T08:42:28Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccuIrAAH2gAyNDExNTg5ODg3OjZjZDIwZTQ5NTc0ZTRjY2ZmODkzODdlMDQ1NTRjYjY0MzNkMjRiYzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcePzV-AH2gAyNDExNTg5ODg3OmFhZjY0MjhiNDBjNGRjMmMwYjllZGQ4OTllZGM0YjdlNTE0OGJhNDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6cd20e49574e4ccff89387e04554cb6433d24bc6", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/6cd20e49574e4ccff89387e04554cb6433d24bc6", "committedDate": "2020-04-30T14:41:04Z", "message": "log on slow close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8317911333bed15a50a512b305ca2dd2b65ff0a9", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/8317911333bed15a50a512b305ca2dd2b65ff0a9", "committedDate": "2020-04-30T14:41:04Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ab6be4da8186d586da822558d0a9ed2c9a7d327", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/1ab6be4da8186d586da822558d0a9ed2c9a7d327", "committedDate": "2020-04-30T14:41:04Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf525c29dc0739f8ed4018e1b286dca50d020eed", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/cf525c29dc0739f8ed4018e1b286dca50d020eed", "committedDate": "2020-04-30T14:51:48Z", "message": "add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4fb9257a483a96e3640e99ec4dbb15ca8bd01da", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/f4fb9257a483a96e3640e99ec4dbb15ca8bd01da", "committedDate": "2020-05-01T08:31:37Z", "message": "Fix whitespace around if"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0OTg1NDg1", "url": "https://github.com/palantir/atlasdb/pull/4745#pullrequestreview-404985485", "createdAt": "2020-05-04T13:27:51Z", "commit": {"oid": "f4fb9257a483a96e3640e99ec4dbb15ca8bd01da"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMzoyNzo1MVrOGQARjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxNDowMzo0N1rOGQB13A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQzNDg5NQ==", "bodyText": "nit: Could we rename this executor service to deleteExecutor (if that's what it's used for)?", "url": "https://github.com/palantir/atlasdb/pull/4745#discussion_r419434895", "createdAt": "2020-05-04T13:27:51Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/transaction/impl/SnapshotTransactionManagerTest.java", "diffHunk": "@@ -118,6 +118,12 @@ public void closesCloseableLockServiceOnClosingTransactionManager() throws IOExc\n         verify(closeableLockService, times(1)).close();\n     }\n \n+    @Test\n+    public void closesDeleteExecutorOnClosingTransactionManager() {\n+        snapshotTransactionManager.close();\n+        assertThat(executorService.isTerminated()).isTrue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4fb9257a483a96e3640e99ec4dbb15ca8bd01da"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQ2MDU3Mg==", "bodyText": "non-actionable: Your concern is valid, I'm not really sure what I would do if I saw this. Though it could be useful in identifying what might have happened in the context of a broader investigation.", "url": "https://github.com/palantir/atlasdb/pull/4745#discussion_r419460572", "createdAt": "2020-05-04T14:03:47Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransactionManager.java", "diffHunk": "@@ -353,7 +353,9 @@ public void close() {\n     private static void shutdownExecutor(ExecutorService executor) {\n         executor.shutdown();\n         try {\n-            executor.awaitTermination(10, TimeUnit.SECONDS);\n+            if (!executor.awaitTermination(10, TimeUnit.SECONDS)) {\n+                log.error(\"Failed to shutdown the executor after 10 seconds.\");\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4fb9257a483a96e3640e99ec4dbb15ca8bd01da"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaf6428b40c4dc2c0b9edd899edc4b7e5148ba40", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/aaf6428b40c4dc2c0b9edd899edc4b7e5148ba40", "committedDate": "2020-05-05T08:28:28Z", "message": "Rename executorService to deleteExecutor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3116, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}