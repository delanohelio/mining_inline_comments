{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NDc2Mzk2", "number": 5128, "title": "[Cross Client Batching LeaderTimes - 3b] | AtlasDb accepts external request batcher for LeaderTime api", "bodyText": "Goals (and why):\nAtlasDb accepts external request batcher for LeaderTime api.\nImplementation Description (bullets):\nWired BatcherProviders through TransactionManagers\nTesting (What was existing testing like?  What have you done to improve it?):\nTBD\nConcerns (what feedback would you like?):\n\nDoes the api look reasonable\n\nWhere should we start reviewing?:\nTransactionManagers.java\nPriority (whenever / two weeks / yesterday):\nToday", "createdAt": "2020-11-24T13:23:07Z", "url": "https://github.com/palantir/atlasdb/pull/5128", "merged": true, "mergeCommit": {"oid": "29eb638a9bb80d2eee2d7fcd0d3b11f7b497ea25"}, "closed": true, "closedAt": "2020-11-30T11:47:08Z", "author": {"login": "sudiksha27"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfpdQWgH2gAyNTI2NDc2Mzk2OjhhZGM5OGI0N2VlMzBhZjgwOWM5NWIyZjI0MWJjNmRkOTkwY2IzNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhjs1VgH2gAyNTI2NDc2Mzk2OjNiZDc0ZmYyYWM4YzgyODMyYTgzZTI4ZWRiODRmOWI5ZjMzNTYwNTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8adc98b47ee30af809c95b2f241bc6dd990cb377", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/8adc98b47ee30af809c95b2f241bc6dd990cb377", "committedDate": "2020-11-24T13:06:57Z", "message": "BatcherProviders - Wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "983488eaeea3b260ee44e1a3f20fbe834ea2bbb5", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/983488eaeea3b260ee44e1a3f20fbe834ea2bbb5", "committedDate": "2020-11-24T13:07:21Z", "message": "Fix build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "993513e0a75ece7747cf1e26607559233b53c0f2", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/993513e0a75ece7747cf1e26607559233b53c0f2", "committedDate": "2020-11-24T13:07:45Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0f171f143cb9dfd22397ea344b722f22c559e8b", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/d0f171f143cb9dfd22397ea344b722f22c559e8b", "committedDate": "2020-11-24T13:07:54Z", "message": "Change signature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7a8a47a57c0a60f5cfbc313f9ad2f4390cb8623", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/f7a8a47a57c0a60f5cfbc313f9ad2f4390cb8623", "committedDate": "2020-11-24T13:08:23Z", "message": "Modify batcherProvider api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1633b993975cf87116fa041359bd3c592f215b64", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/1633b993975cf87116fa041359bd3c592f215b64", "committedDate": "2020-11-24T13:12:10Z", "message": "Update service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "564abd0687718a227d586532742f8744e83ec8ec", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/564abd0687718a227d586532742f8744e83ec8ec", "committedDate": "2020-11-24T13:12:10Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a75921b2114f38755e89f80012a623d62119ed2", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/7a75921b2114f38755e89f80012a623d62119ed2", "committedDate": "2020-11-24T13:12:10Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e44794a9f0dcdaeefc490d8351ea6866effb7093", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/e44794a9f0dcdaeefc490d8351ea6866effb7093", "committedDate": "2020-11-25T12:12:25Z", "message": "Refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NDgyNTIy", "url": "https://github.com/palantir/atlasdb/pull/5128#pullrequestreview-538482522", "createdAt": "2020-11-25T13:15:12Z", "commit": {"oid": "e44794a9f0dcdaeefc490d8351ea6866effb7093"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMzoxNToxMlrOH5y7pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxMzoxODoyN1rOH5zDSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM2NTM0OQ==", "bodyText": "wow, it really needs this type hint to work? Funky", "url": "https://github.com/palantir/atlasdb/pull/5128#discussion_r530365349", "createdAt": "2020-11-25T13:15:12Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -1200,6 +1223,24 @@ private static LockAndTimestampServices getLockAndTimestampServices(\n                 .build();\n     }\n \n+    private static LeaderTimeGetter getLeaderTimeGetter(\n+            String timelockNamespace,\n+            Optional<TimeLockRequestBatcherProviders> timelockRequestBatcherProviders,\n+            AtlasDbDialogueServiceProvider serviceProvider,\n+            LeaderElectionReportingTimelockService namespacedConjureTimelockService) {\n+        return timelockRequestBatcherProviders\n+                .map(TimeLockRequestBatcherProviders::leaderTimeBatcherProvider)\n+                .map(provider -> provider.getBatcher(getMultiClientTimelockServiceSupplier(serviceProvider)))\n+                .<LeaderTimeGetter>map(batcher -> new NamespacedCoalescingLeaderTimeGetter(timelockNamespace, batcher))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e44794a9f0dcdaeefc490d8351ea6866effb7093"}, "originalPosition": 169}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM2NzMwNg==", "bodyText": "Feels a bit weird - very specific arg but generic return type. I wonder what thoughts are on making this:\nT getBatcher(Supplier<K> service);\nI can see pros and cons both ways. However, if you want to keep this param as is, maybe I'd be a bit more specific on the name (MultiClientBatchProvider? TimelockBatchProvider? idk).", "url": "https://github.com/palantir/atlasdb/pull/5128#discussion_r530367306", "createdAt": "2020-11-25T13:18:27Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/config/BatcherProvider.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.config;\n+\n+import com.palantir.lock.client.InternalMultiClientConjureTimelockService;\n+import java.util.function.Supplier;\n+\n+public interface BatcherProvider<T> {\n+    T getBatcher(Supplier<InternalMultiClientConjureTimelockService> multiClientConjureTimelockService);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e44794a9f0dcdaeefc490d8351ea6866effb7093"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "900a52846f52b2ccd110ebfd669026efe342ab28", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/900a52846f52b2ccd110ebfd669026efe342ab28", "committedDate": "2020-11-25T13:25:14Z", "message": "Rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fbb29133a5942a9395307918be66cdbb1aad0b1", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/1fbb29133a5942a9395307918be66cdbb1aad0b1", "committedDate": "2020-11-25T13:28:44Z", "message": "Spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNzYzMjA0", "url": "https://github.com/palantir/atlasdb/pull/5128#pullrequestreview-540763204", "createdAt": "2020-11-30T10:11:44Z", "commit": {"oid": "1fbb29133a5942a9395307918be66cdbb1aad0b1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMDoxMTo0NFrOH70Eqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMDoxOTowNlrOH70WfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ4MTE5NQ==", "bodyText": "This broadly makes sense. As a matter of style I'd probably write this imperatively as there is a fair bit to take in, but this is fine if you prefer.", "url": "https://github.com/palantir/atlasdb/pull/5128#discussion_r532481195", "createdAt": "2020-11-30T10:11:44Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -1200,6 +1223,24 @@ private static LockAndTimestampServices getLockAndTimestampServices(\n                 .build();\n     }\n \n+    private static LeaderTimeGetter getLeaderTimeGetter(\n+            String timelockNamespace,\n+            Optional<TimeLockRequestBatcherProviders> timelockRequestBatcherProviders,\n+            AtlasDbDialogueServiceProvider serviceProvider,\n+            LeaderElectionReportingTimelockService namespacedConjureTimelockService) {\n+        return timelockRequestBatcherProviders\n+                .map(TimeLockRequestBatcherProviders::leaderTimeBatcherProvider)\n+                .map(provider -> provider.getBatcher(getMultiClientTimelockServiceSupplier(serviceProvider)))\n+                .<LeaderTimeGetter>map(batcher -> new NamespacedCoalescingLeaderTimeGetter(timelockNamespace, batcher))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fbb29133a5942a9395307918be66cdbb1aad0b1"}, "originalPosition": 169}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ4MjI5NQ==", "bodyText": "nit: probably want articles i.e. on line 3, configured by its clients to use a custom request batcher; line 5, in the absence of a custom batcher, we fall back to a legacy leaderTime request coalescing batcher.", "url": "https://github.com/palantir/atlasdb/pull/5128#discussion_r532482295", "createdAt": "2020-11-30T10:13:32Z", "author": {"login": "jeremyk-91"}, "path": "changelog/@unreleased/pr-5128.v2.yml", "diffHunk": "@@ -0,0 +1,7 @@\n+type: feature\n+feature:\n+  description: AtlasDb can now be configured by its clients to use custom request\n+    batcher for batching requests to leaderTime api on Timelock. In the absence of\n+    custom batcher, we fall back to legacy leaderTime request coalescing batcher.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fbb29133a5942a9395307918be66cdbb1aad0b1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ4NTc1Ng==", "bodyText": "can we name this timelockRequestBatcherProviders for consistency?", "url": "https://github.com/palantir/atlasdb/pull/5128#discussion_r532485756", "createdAt": "2020-11-30T10:19:06Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -244,6 +252,8 @@ boolean allSafeForLogging() {\n \n     abstract UserAgent userAgent();\n \n+    abstract Optional<TimeLockRequestBatcherProviders> batcherProviders();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fbb29133a5942a9395307918be66cdbb1aad0b1"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09e5a927d67eeccce4b66ff3b426140720c3772c", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/09e5a927d67eeccce4b66ff3b426140720c3772c", "committedDate": "2020-11-30T10:46:52Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "271514837e3859e1faf84d1f92a79bd55347d9d6", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/271514837e3859e1faf84d1f92a79bd55347d9d6", "committedDate": "2020-11-30T10:46:52Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7781b78ddcfa79ca18979d22d7faed325b908d0c", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/7781b78ddcfa79ca18979d22d7faed325b908d0c", "committedDate": "2020-11-30T10:46:52Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwODA4MjUz", "url": "https://github.com/palantir/atlasdb/pull/5128#pullrequestreview-540808253", "createdAt": "2020-11-30T11:10:15Z", "commit": {"oid": "7781b78ddcfa79ca18979d22d7faed325b908d0c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMToxMDoxNVrOH72Tsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMToxMDoxNVrOH72Tsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjUxNzgxMQ==", "bodyText": "go to the next line :)", "url": "https://github.com/palantir/atlasdb/pull/5128#discussion_r532517811", "createdAt": "2020-11-30T11:10:15Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -1200,6 +1224,28 @@ private static LockAndTimestampServices getLockAndTimestampServices(\n                 .build();\n     }\n \n+    private static LeaderTimeGetter getLeaderTimeGetter(\n+            String timelockNamespace,\n+            Optional<TimeLockRequestBatcherProviders> timelockRequestBatcherProviders,\n+            AtlasDbDialogueServiceProvider serviceProvider,\n+            LeaderElectionReportingTimelockService namespacedConjureTimelockService) {\n+\n+        if (!timelockRequestBatcherProviders.isPresent()) {\n+            return new LegacyLeaderTimeGetter(namespacedConjureTimelockService);\n+        }\n+\n+        LeaderTimeCoalescingBatcher batcher = timelockRequestBatcherProviders.get()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7781b78ddcfa79ca18979d22d7faed325b908d0c"}, "originalPosition": 172}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bd74ff2ac8c82832a83e28edb84f9b9f3356055", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/3bd74ff2ac8c82832a83e28edb84f9b9f3356055", "committedDate": "2020-11-30T11:32:23Z", "message": "Spotless"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2517, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}