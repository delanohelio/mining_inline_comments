{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NjA4NTUw", "number": 4599, "title": "[PDS-105073] Support Specifying Service Name in Oracle Connection Config", "bodyText": "Goals (and why):\n\nSee internal ticket, internal deployment needs to specify a service name instead of SID for their Oracle database.\n\nImplementation Description (bullets):\n\nConfigure the URL to allow referencing an Oracle database by service name.\nThis is technically possible with the existing configuration by overriding the URL, but extremely fragile.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nFor various reasons the Oracle driver is only available internally. Please consult the branch of the same name on the AtlasDB interface to the Oracle driver: tests have been added there.\n\nConcerns (what feedback would you like?):\n\nDoes this actually work?\n\nWhere should we start reviewing?: OracleConnectionConfig\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-02-25T14:17:04Z", "url": "https://github.com/palantir/atlasdb/pull/4599", "merged": true, "mergeCommit": {"oid": "f0b7c764b717dec16ed7cb3e4c3d15f2cb8c411f"}, "closed": true, "closedAt": "2020-03-03T15:53:30Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHxiaIgH2gAyMzc5NjA4NTUwOjA1ZTk3NTU1OWJlMjNiNzFmNThiNzE5ZDA5M2YxYmQ5NDU0NjM4N2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKC7ejAFqTM2ODAwNzQzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "05e975559be23b71f58b719d093f1bd94546387b", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/05e975559be23b71f58b719d093f1bd94546387b", "committedDate": "2020-02-25T12:46:29Z", "message": "Allow specifying of a service name for Oracle config."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eed40cf76ab79b5ebdc60dd60be7c59d7c350b1d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/eed40cf76ab79b5ebdc60dd60be7c59d7c350b1d", "committedDate": "2020-02-25T12:47:56Z", "message": "Update docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92f86bf2e3fde48dbff38180c357367df5ce9de5", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/92f86bf2e3fde48dbff38180c357367df5ce9de5", "committedDate": "2020-02-25T14:12:29Z", "message": "Not expected because of ordering issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05ca128679498fdf6f6ec8ddd711282eddb6b42a", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/05ca128679498fdf6f6ec8ddd711282eddb6b42a", "committedDate": "2020-02-25T14:12:29Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "757f79d6bd390e31e2d1516c09da3c7ce0c73e61", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/757f79d6bd390e31e2d1516c09da3c7ce0c73e61", "committedDate": "2020-02-26T18:55:47Z", "message": "CS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40f0e74daeb1ac35e7c5272ac93adecf06bea0db", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/40f0e74daeb1ac35e7c5272ac93adecf06bea0db", "committedDate": "2020-02-27T12:00:09Z", "message": "Merge branch 'jkong/105073' of github.com:palantir/atlasdb into jkong/105073"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MjA3NjM4", "url": "https://github.com/palantir/atlasdb/pull/4599#pullrequestreview-367207638", "createdAt": "2020-03-02T13:45:33Z", "commit": {"oid": "40f0e74daeb1ac35e7c5272ac93adecf06bea0db"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMzo0NTozM1rOFwf_sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNDowMDoxMVrOFwgeNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwMDE3OQ==", "bodyText": "don't think you can ever get into this case, but I imagine this is to just satisfy the type checker", "url": "https://github.com/palantir/atlasdb/pull/4599#discussion_r386400179", "createdAt": "2020-03-02T13:45:33Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java", "diffHunk": "@@ -199,4 +207,16 @@ protected final void check() {\n                     \"a keystore password without enabling ConnectionProtocol.TCPS\");\n         }\n     }\n+\n+    private String getConnectionDataString() {\n+        if (getSid().isPresent()) {\n+            return \"SID=\" + getSid().get();\n+        }\n+\n+        if (getServiceName().isPresent()) {\n+            return \"SERVICE_NAME=\" + getServiceName().get();\n+        }\n+\n+        throw new IllegalArgumentException(\"Both the sid and service name are absent! One needs to be specified.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40f0e74daeb1ac35e7c5272ac93adecf06bea0db"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQwNzk4OQ==", "bodyText": "somewhat confused, if you've specified serviceName you can no longer specify sid meaning that you get screwed over here whenever you call namespace i.e. you go from having a namespace to not having a namespace. What are the implications of this in atlas?\nIf anything it feels like getConnectionDataString should return the service name if it is specified, otherwise it returns the sid and that sid is always provided OR that if you specify serviceName, then you need to specify namespace explicitly when migrating over.\nLet's chat about this face to face.", "url": "https://github.com/palantir/atlasdb/pull/4599#discussion_r386407989", "createdAt": "2020-03-02T14:00:11Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java", "diffHunk": "@@ -48,22 +48,25 @@ public String getUrl() {\n         if (getServerDn().isPresent()) {\n             return String.format(\"jdbc:oracle:thin:@(DESCRIPTION=\"\n                             + \"(ADDRESS=(PROTOCOL=%s)(HOST=%s)(PORT=%s))\"\n-                            + \"(CONNECT_DATA=(SID=%s))\"\n+                            + \"(CONNECT_DATA=(%s))\"\n                             + \"(SECURITY=(SSL_SERVER_CERT_DN=\\\"%s\\\")))\",\n-                    getProtocol().getUrlString(), getHost(), getPort(), getSid(), getServerDn().get());\n+                    getProtocol().getUrlString(), getHost(), getPort(), getConnectionDataString(), getServerDn().get());\n         } else {\n             return String.format(\"jdbc:oracle:thin:@(DESCRIPTION=\"\n                             + \"(ADDRESS=(PROTOCOL=%s)(HOST=%s)(PORT=%s))\"\n-                            + \"(CONNECT_DATA=(SID=%s)))\",\n-                    getProtocol().getUrlString(), getHost(), getPort(), getSid());\n+                            + \"(CONNECT_DATA=(%s)))\",\n+                    getProtocol().getUrlString(), getHost(), getPort(), getConnectionDataString());\n         }\n     }\n \n     @Override\n     @Value.Derived\n     @JsonIgnore\n     public Optional<String> namespace() {\n-        return Optional.of(getSid());\n+        // If an SID is provided, maintain it - this is needed for legacy compatibility. But if a service name\n+        // is provided, that identifies the database and we don't want to enforce consistency checks with the\n+        // TimeLock client.\n+        return getSid();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40f0e74daeb1ac35e7c5272ac93adecf06bea0db"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76e5338f02665345e5d423f53333c07dd3ae8964", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/76e5338f02665345e5d423f53333c07dd3ae8964", "committedDate": "2020-03-03T13:51:09Z", "message": "PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f143d1da95d6b7f94d045488679ecc5c6506e8fe", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/f143d1da95d6b7f94d045488679ecc5c6506e8fe", "committedDate": "2020-03-03T14:08:29Z", "message": "Docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b44b7ff9b5e3f2b85f728c603d37c35798def240", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/b44b7ff9b5e3f2b85f728c603d37c35798def240", "committedDate": "2020-03-03T14:08:36Z", "message": "DbKVS test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08b5327e407cb6c6d8bba653a5783224c140d2ed", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/08b5327e407cb6c6d8bba653a5783224c140d2ed", "committedDate": "2020-03-03T14:08:36Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MDA3NDM4", "url": "https://github.com/palantir/atlasdb/pull/4599#pullrequestreview-368007438", "createdAt": "2020-03-03T14:10:06Z", "commit": {"oid": "40f0e74daeb1ac35e7c5272ac93adecf06bea0db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2288, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}