{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4ODQxOTAw", "number": 5079, "title": "Leader Election Metrics 2a: Server side wiring ", "bodyText": "Goals (and why):\n\nAdd a new endpoint to the Timelock feedback service to allow for reporting of leader election metrics.\nAdd wiring to aggregate received metrics\n\nImplementation Description (bullets):\n\nAdded a new endpoint\nAdded a class to aggregate received metrics\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nWIP\n\nConcerns (what feedback would you like?):\n\nI'm only adding a new endpoint - no requests will be sent yet. I assume this is fine?\n\nWhere should we start reviewing?:\n\ntimelock-api.yml is probably a good start.\n\nPriority (whenever / two weeks / yesterday):\nAfter #5069 merges.", "createdAt": "2020-10-23T09:33:53Z", "url": "https://github.com/palantir/atlasdb/pull/5079", "merged": true, "mergeCommit": {"oid": "9f1e397b8693ba668cd99c102481b031a0ae1a39"}, "closed": true, "closedAt": "2020-10-28T11:52:44Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUp8N0AH2gAyNTA4ODQxOTAwOmI3OTMyNjQ2ODJiYjA3NWE3YzVhNzc5ZDVkYzMzNGE0MzAyZmFkOTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW7wxBAH2gAyNTA4ODQxOTAwOjA4NWNlYjUwMzExNDE3ODI1NmE2ZDJlZTU3MTRiZTAwZDQzOWIyOTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b793264682bb075a7c5a779d5dc334a4302fad95", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/b793264682bb075a7c5a779d5dc334a4302fad95", "committedDate": "2020-10-21T09:27:36Z", "message": "Transfer changes from other branches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee6bb046be4501552fe35f873a4fade024c877b8", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/ee6bb046be4501552fe35f873a4fade024c877b8", "committedDate": "2020-10-21T14:12:34Z", "message": "Pull in the right things"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d4669f0c72d8fb4a0fad8bc0afb94d414faa88b", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/7d4669f0c72d8fb4a0fad8bc0afb94d414faa88b", "committedDate": "2020-10-21T15:12:01Z", "message": "Merge branch 'develop' into le/client-i"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48a3db4d3a5b0bd5f05a87b9d0856c55a8d09738", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/48a3db4d3a5b0bd5f05a87b9d0856c55a8d09738", "committedDate": "2020-10-21T15:25:12Z", "message": "rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1f7fa37374952504467f157c810a015c2a507d3", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/d1f7fa37374952504467f157c810a015c2a507d3", "committedDate": "2020-10-21T22:53:36Z", "message": "Implementation and some tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a6c460b2eed97fe8352e46c0ce68694e7cafedb", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/3a6c460b2eed97fe8352e46c0ce68694e7cafedb", "committedDate": "2020-10-22T08:39:58Z", "message": "Should fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c33135c2cf946bed86c415df29eab145cf3fcf5", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/1c33135c2cf946bed86c415df29eab145cf3fcf5", "committedDate": "2020-10-22T09:37:12Z", "message": "Make tests great again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf458d26cce07fe45302d80a57a03d86bf06fd4c", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/cf458d26cce07fe45302d80a57a03d86bf06fd4c", "committedDate": "2020-10-22T14:52:48Z", "message": "Merge with develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3793e6f2fcf9257237d623e0b05b1f6be3f73a6", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/a3793e6f2fcf9257237d623e0b05b1f6be3f73a6", "committedDate": "2020-10-22T16:09:08Z", "message": "Bleh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edb7750726df1240901dc1bc41fb9ce7aaf967c1", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/edb7750726df1240901dc1bc41fb9ce7aaf967c1", "committedDate": "2020-10-23T09:28:16Z", "message": "Pull out only necessary files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a93f810c495937bdee87ac041fb00c6fe09bba50", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/a93f810c495937bdee87ac041fb00c6fe09bba50", "committedDate": "2020-10-23T09:35:22Z", "message": "address aggressive autoformat"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NTAzNDQ3", "url": "https://github.com/palantir/atlasdb/pull/5079#pullrequestreview-515503447", "createdAt": "2020-10-23T09:36:03Z", "commit": {"oid": "a93f810c495937bdee87ac041fb00c6fe09bba50"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwOTozNjowNFrOHnGYBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QwOTozNjowNFrOHnGYBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc2MDk2Nw==", "bodyText": "I'm not a huge fan, but not sure what the best way to use a gauge here is.", "url": "https://github.com/palantir/atlasdb/pull/5079#discussion_r510760967", "createdAt": "2020-10-23T09:36:04Z", "author": {"login": "Jolyon-S"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/adjudicate/LeaderElectionMetricAggregator.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.adjudicate;\n+\n+import com.codahale.metrics.Gauge;\n+import com.palantir.atlasdb.util.MetricsManager;\n+import com.palantir.atlasdb.util.SlidingWindowWeightedMeanGauge;\n+import com.palantir.conjure.java.lib.SafeLong;\n+import com.palantir.timelock.feedback.LeaderElectionStatistics;\n+\n+public final class LeaderElectionMetricAggregator {\n+    private final SlidingWindowWeightedMeanGauge weightedGaugeP99;\n+    private final SlidingWindowWeightedMeanGauge weightedGaugeP95;\n+    private final SlidingWindowWeightedMeanGauge weightedGaugeMean;\n+    private volatile long lastElectionTime = 0L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a93f810c495937bdee87ac041fb00c6fe09bba50"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a75c069358bbef81d993781a8238a9829fcddad", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/4a75c069358bbef81d993781a8238a9829fcddad", "committedDate": "2020-10-23T09:39:07Z", "message": "current value metric"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "133bfa79b08a664ddabf141187edbaa8066ccb3c", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/133bfa79b08a664ddabf141187edbaa8066ccb3c", "committedDate": "2020-10-23T09:51:07Z", "message": "Cleanup, more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c19da98f9fef5e3b8da5441f0b262b768a32e97", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/0c19da98f9fef5e3b8da5441f0b262b768a32e97", "committedDate": "2020-10-23T09:59:50Z", "message": "add testing to LERTST"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NTI0MzEz", "url": "https://github.com/palantir/atlasdb/pull/5079#pullrequestreview-515524313", "createdAt": "2020-10-23T10:05:26Z", "commit": {"oid": "0c19da98f9fef5e3b8da5441f0b262b768a32e97"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMDowNToyNlrOHnHXfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMDowNToyNlrOHnHXfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc3NzIxMg==", "bodyText": "Driveby", "url": "https://github.com/palantir/atlasdb/pull/5079#discussion_r510777212", "createdAt": "2020-10-23T10:05:26Z", "author": {"login": "Jolyon-S"}, "path": "lock-api/src/test/java/com/palantir/lock/client/LeaderElectionReportingTimelockServiceTest.java", "diffHunk": "@@ -197,13 +230,17 @@ private void assertExpectedDuration(Instant instant, Instant instant2) {\n \n     @Value.Immutable\n     interface SingleCall {\n-        @Parameter\n+        @Value.Parameter\n         long requestMillis();\n \n-        @Parameter\n+        @Value.Parameter\n         long responseMillis();\n \n-        @Parameter\n+        @Value.Parameter\n         UUID responseLeader();\n+\n+        static SingleCall of(long requestMillis, long responseMillis, UUID responseLeader) {\n+            return ImmutableSingleCall.of(requestMillis, responseMillis, responseLeader);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c19da98f9fef5e3b8da5441f0b262b768a32e97"}, "originalPosition": 149}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1NTMxMDI1", "url": "https://github.com/palantir/atlasdb/pull/5079#pullrequestreview-515531025", "createdAt": "2020-10-23T10:15:13Z", "commit": {"oid": "0c19da98f9fef5e3b8da5441f0b262b768a32e97"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMDoxNToxM1rOHnHrlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yM1QxMDoyMzo0MVrOHnH9nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc4MjM1Ng==", "bodyText": "durationEstimate?", "url": "https://github.com/palantir/atlasdb/pull/5079#discussion_r510782356", "createdAt": "2020-10-23T10:15:13Z", "author": {"login": "gmaretic"}, "path": "timelock-api/src/main/conjure/timelock-feedback.yml", "diffHunk": "@@ -17,6 +17,13 @@ types:\n           p99: double\n           oneMin: double\n           errorRate: optional<double>\n+      LeaderElectionStatistics:\n+        fields:\n+          p99: double\n+          p95: double\n+          mean: double\n+          count: safelong\n+          perceivedTime: optional<safelong>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c19da98f9fef5e3b8da5441f0b262b768a32e97"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc4MzIzMg==", "bodyText": "Might be better to just not set when empty", "url": "https://github.com/palantir/atlasdb/pull/5079#discussion_r510783232", "createdAt": "2020-10-23T10:16:47Z", "author": {"login": "gmaretic"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/adjudicate/LeaderElectionMetricAggregator.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.adjudicate;\n+\n+import com.palantir.atlasdb.util.CurrentValueMetric;\n+import com.palantir.atlasdb.util.MetricsManager;\n+import com.palantir.atlasdb.util.SlidingWindowWeightedMeanGauge;\n+import com.palantir.conjure.java.lib.SafeLong;\n+import com.palantir.timelock.feedback.LeaderElectionStatistics;\n+\n+public final class LeaderElectionMetricAggregator {\n+    private final SlidingWindowWeightedMeanGauge weightedGaugeP99;\n+    private final SlidingWindowWeightedMeanGauge weightedGaugeP95;\n+    private final SlidingWindowWeightedMeanGauge weightedGaugeMean;\n+    private final CurrentValueMetric<Long> lastElectionTime;\n+\n+    public LeaderElectionMetricAggregator(MetricsManager metricsManager) {\n+        weightedGaugeP99 = SlidingWindowWeightedMeanGauge.create();\n+        weightedGaugeP95 = SlidingWindowWeightedMeanGauge.create();\n+        weightedGaugeMean = SlidingWindowWeightedMeanGauge.create();\n+        lastElectionTime = new CurrentValueMetric<>();\n+        metricsManager.registerMetric(\n+                LeaderElectionMetricAggregator.class, \"leaderElectionImpactMean\", weightedGaugeMean);\n+        metricsManager.registerMetric(\n+                LeaderElectionMetricAggregator.class, \"leaderElectionImpactP95\", weightedGaugeP95);\n+        metricsManager.registerMetric(\n+                LeaderElectionMetricAggregator.class, \"leaderElectionImpactP99\", weightedGaugeP99);\n+        metricsManager.registerMetric(LeaderElectionMetricAggregator.class, \"leaderElectionDuration\", lastElectionTime);\n+    }\n+\n+    void report(LeaderElectionStatistics statistics) {\n+        long count = statistics.getCount().longValue();\n+        weightedGaugeMean.update(statistics.getMean(), count);\n+        weightedGaugeP95.update(statistics.getP95(), count);\n+        weightedGaugeP99.update(statistics.getP99(), count);\n+        lastElectionTime.setValue(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c19da98f9fef5e3b8da5441f0b262b768a32e97"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc4Njk1Mw==", "bodyText": "There is of course a small race condition here, but it's fine", "url": "https://github.com/palantir/atlasdb/pull/5079#discussion_r510786953", "createdAt": "2020-10-23T10:23:40Z", "author": {"login": "gmaretic"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LeaderElectionReportingTimelockService.java", "diffHunk": "@@ -115,6 +120,24 @@ public ConjureStartTransactionsResponse startTransactions(ConjureStartTransactio\n                 .logId());\n     }\n \n+    public LeaderElectionStatistics statistics() {\n+        return statisticsWithRegistry(new DefaultTaggedMetricRegistry());\n+    }\n+\n+    @VisibleForTesting\n+    LeaderElectionStatistics statisticsWithRegistry(TaggedMetricRegistry metricRegistry) {\n+        Snapshot metricsSnapshot = metrics.observedDuration().getSnapshot();\n+        LeaderElectionStatistics electionStatistics = LeaderElectionStatistics.builder()\n+                .p99(metricsSnapshot.get99thPercentile())\n+                .p95(metricsSnapshot.get95thPercentile())\n+                .mean(metricsSnapshot.getMean())\n+                .count(SafeLong.of(metrics.observedDuration().getCount()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c19da98f9fef5e3b8da5441f0b262b768a32e97"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDc4Njk3NQ==", "bodyText": "This is a bit janky, but probably fine for tests. Rename to getStatisticsAndSetRegistryTo or something such?", "url": "https://github.com/palantir/atlasdb/pull/5079#discussion_r510786975", "createdAt": "2020-10-23T10:23:41Z", "author": {"login": "gmaretic"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LeaderElectionReportingTimelockService.java", "diffHunk": "@@ -115,6 +120,24 @@ public ConjureStartTransactionsResponse startTransactions(ConjureStartTransactio\n                 .logId());\n     }\n \n+    public LeaderElectionStatistics statistics() {\n+        return statisticsWithRegistry(new DefaultTaggedMetricRegistry());\n+    }\n+\n+    @VisibleForTesting\n+    LeaderElectionStatistics statisticsWithRegistry(TaggedMetricRegistry metricRegistry) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0c19da98f9fef5e3b8da5441f0b262b768a32e97"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5f6339842ff2cff883413a576c51676803474ec", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/a5f6339842ff2cff883413a576c51676803474ec", "committedDate": "2020-10-23T12:58:04Z", "message": "Merge branch 'le/client-ii' into le/server-ia\n\n# Conflicts:\n#\tlock-api/src/main/java/com/palantir/lock/client/LeaderElectionReportingTimelockService.java\n#\tlock-api/src/test/java/com/palantir/lock/client/LeaderElectionReportingTimelockServiceTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddf2f72859208dc58405c3192d447bb6bf87f3e4", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/ddf2f72859208dc58405c3192d447bb6bf87f3e4", "committedDate": "2020-10-23T13:10:07Z", "message": "comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "debe1230b0cf305c036e6ecfea76e42e283b4939", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/debe1230b0cf305c036e6ecfea76e42e283b4939", "committedDate": "2020-10-26T13:59:52Z", "message": "Merge conflicts, modify duration estimate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0b943dfee99c57f8cc9303d26696608a56c1c5d", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/a0b943dfee99c57f8cc9303d26696608a56c1c5d", "committedDate": "2020-10-26T17:47:06Z", "message": "Separate changes into new PR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3MDMxMDk5", "url": "https://github.com/palantir/atlasdb/pull/5079#pullrequestreview-517031099", "createdAt": "2020-10-26T17:47:31Z", "commit": {"oid": "debe1230b0cf305c036e6ecfea76e42e283b4939"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5657e026f806eb83c67266ee9e137d34a4e766a0", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/5657e026f806eb83c67266ee9e137d34a4e766a0", "committedDate": "2020-10-28T11:19:35Z", "message": "very well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "085ceb503114178256a6d2ee5714be00d439b290", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/085ceb503114178256a6d2ee5714be00d439b290", "committedDate": "2020-10-28T11:21:14Z", "message": "revert"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2429, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}