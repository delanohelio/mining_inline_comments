{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MjA4MTg2", "number": 4580, "title": "[Timelock OOMs] Memoized supplier with timeout client", "bodyText": "Goals (and why):\nFrom the bisections, fairly certain that the issue lies with metrics PR #4549. The only meaningful thing that comes from that PR is the fact that we have a client that is refreshing behind the scenes via ExperimentRunningProxy etc. and in that PR we don't.\nCurrently testing the hypothesis that HTTP1 does not suffer from this issue i.e. some weird interop between okhttp and undertow when dealing with h2. Turns out that it's equal opportunity OOMs :(.\nIf this experiment works, then will defer to #4561 for the better implementation.\nother FLUPs:\n\nwhen we fail when we've gained leadership and we're trying to create the delegate, we repeatedly and aggressively try to create the delegate with no backoff (backoff isn't the issue here per se). In doing so, we also create resources that will never be used i.e. threads, may not take up processing time, but they do take up memory. In some places saw around 30k threads at one time (couldn't get a JStack as the node was unresponsive), but in other places, you can definitely see elevated thread counts (this does happen independently of the GC storm IIRC).\n\nFLUP at bottom: ensure we shutdown any auxiliary resources created as part of failed createDelegate calls\n\n\nundo old support work i.e. Targeted Sweep rate limiter, this adds threads per client, should be light, but it's resources \ud83d\ude44\n\nImplementation Description (bullets):\n\nSuppliers.memoizeWithExpiration etc.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nAbout to test on an RC.\nConcerns (what feedback would you like?):\nIs 10 minutes too frequent?\nWhere should we start reviewing?:\nEverywhere.\nPriority (whenever / two weeks / yesterday):\nI'm just talking to myself at this point.", "createdAt": "2020-02-17T15:52:56Z", "url": "https://github.com/palantir/atlasdb/pull/4580", "merged": true, "mergeCommit": {"oid": "3bcd66ec02b8fcf43cfbdf87122870ae8c033cac"}, "closed": true, "closedAt": "2020-02-17T16:58:19Z", "author": {"login": "felixdesouza"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFOfiGgH2gAyMzc2MjA4MTg2OmYwZGFhMDZhNDA0ZTdmODA3ZGFlM2RlOWE0ZDM2MzgzNmRiN2EzZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFQJL0gH2gAyMzc2MjA4MTg2Ojc2NGFlMDE4NDlhNjMwMjVjNWI3MzlkY2E4MjlmMGQ3YWMwYWM5MWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f0daa06a404e7f807dae3de9a4d363836db7a3fb", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/f0daa06a404e7f807dae3de9a4d363836db7a3fb", "committedDate": "2020-02-17T14:48:49Z", "message": "Create a new client after 10 minutes for non-failover nodes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5ODM5MDMx", "url": "https://github.com/palantir/atlasdb/pull/4580#pullrequestreview-359839031", "createdAt": "2020-02-17T16:01:55Z", "commit": {"oid": "f0daa06a404e7f807dae3de9a4d363836db7a3fb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNjowMTo1NlrOFqpanQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNjowMTo1NlrOFqpanQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2MzA2OQ==", "bodyText": "So I thought this was the first thing we tried and with 30 minutes expiration it was OOMing. Why is the 30 minutes fine on develop, but not fine here?", "url": "https://github.com/palantir/atlasdb/pull/4580#discussion_r380263069", "createdAt": "2020-02-17T16:01:56Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/http/AtlasDbHttpClients.java", "diffHunk": "@@ -41,7 +44,12 @@ private AtlasDbHttpClients() {\n             String uri,\n             Class<T> type,\n             AuxiliaryRemotingParameters parameters) {\n-        return ConjureJavaRuntimeTargetFactory.DEFAULT.createProxy(trustContext, uri, type, parameters).instance();\n+        return Suppliers.memoizeWithExpiration(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0daa06a404e7f807dae3de9a4d363836db7a3fb"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dfb72c654a89498fd71d3ff4f866911e7bd1226", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/6dfb72c654a89498fd71d3ff4f866911e7bd1226", "committedDate": "2020-02-17T16:23:06Z", "message": "Update certs again.."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d5f9a41aeb77ba8e9212453dc821b879ee6329b", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/3d5f9a41aeb77ba8e9212453dc821b879ee6329b", "committedDate": "2020-02-17T16:23:33Z", "message": "Bump to 30 minutes to get a representative test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "764ae01849a63025c5b739dca829f0d7ac0ac91f", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/764ae01849a63025c5b739dca829f0d7ac0ac91f", "committedDate": "2020-02-17T16:44:13Z", "message": "Changelog."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2260, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}