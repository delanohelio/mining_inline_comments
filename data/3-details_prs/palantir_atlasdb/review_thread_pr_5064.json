{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NTA5ODUy", "number": 5064, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0Mzo1NVrOEwQcCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0Nzo0MFrOEwQm2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDM2NDI3OnYy", "diffSide": "RIGHT", "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/util/SlidingWindowWeightedMeanGauge.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0Mzo1NVrOHls5MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0Mzo1NVrOHls5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5NDg5Ng==", "bodyText": "Rename to something just so that we know the purpose here is literally just as arbitrary keys for the cache.", "url": "https://github.com/palantir/atlasdb/pull/5064#discussion_r509294896", "createdAt": "2020-10-21T13:43:55Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/util/SlidingWindowWeightedMeanGauge.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.util;\n+\n+import com.codahale.metrics.Gauge;\n+import com.github.benmanes.caffeine.cache.Cache;\n+import com.github.benmanes.caffeine.cache.Caffeine;\n+import com.google.common.collect.ImmutableList;\n+import com.palantir.logsafe.Preconditions;\n+import com.palantir.logsafe.SafeArg;\n+import java.time.Duration;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicLong;\n+import org.immutables.value.Value;\n+\n+/**\n+ * A gauge that calculates the weighted mean of updates during a sliding window of time. Correctness is only guaranteed\n+ * as long as the sum of recorded weights and sum of weighted values do not exceed {@link Long#MAX_VALUE} and\n+ * {@link Double#MAX_VALUE}, respectively.\n+ */\n+public class SlidingWindowWeightedMeanGauge implements Gauge<Double> {\n+    private final Cache<Long, WeightedEntry> updates;\n+    private final AtomicLong counter = new AtomicLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebbc26ab11353d5fdb4e6ebcb75655a02adc99ec"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDM3Nzk4OnYy", "diffSide": "RIGHT", "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/util/SlidingWindowWeightedMeanGauge.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0NTo1M1rOHltBsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0NTo1M1rOHltBsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5NzA3NQ==", "bodyText": "Use just mapToLong", "url": "https://github.com/palantir/atlasdb/pull/5064#discussion_r509297075", "createdAt": "2020-10-21T13:45:53Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/util/SlidingWindowWeightedMeanGauge.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.util;\n+\n+import com.codahale.metrics.Gauge;\n+import com.github.benmanes.caffeine.cache.Cache;\n+import com.github.benmanes.caffeine.cache.Caffeine;\n+import com.google.common.collect.ImmutableList;\n+import com.palantir.logsafe.Preconditions;\n+import com.palantir.logsafe.SafeArg;\n+import java.time.Duration;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicLong;\n+import org.immutables.value.Value;\n+\n+/**\n+ * A gauge that calculates the weighted mean of updates during a sliding window of time. Correctness is only guaranteed\n+ * as long as the sum of recorded weights and sum of weighted values do not exceed {@link Long#MAX_VALUE} and\n+ * {@link Double#MAX_VALUE}, respectively.\n+ */\n+public class SlidingWindowWeightedMeanGauge implements Gauge<Double> {\n+    private final Cache<Long, WeightedEntry> updates;\n+    private final AtomicLong counter = new AtomicLong();\n+\n+    public SlidingWindowWeightedMeanGauge(Duration expirationDuration) {\n+        this.updates =\n+                Caffeine.newBuilder().expireAfterWrite(expirationDuration).build();\n+    }\n+\n+    public static SlidingWindowWeightedMeanGauge create() {\n+        return new SlidingWindowWeightedMeanGauge(Duration.ofMinutes(5L));\n+    }\n+\n+    @Override\n+    public Double getValue() {\n+        List<WeightedEntry> snapshot = ImmutableList.copyOf(updates.asMap().values());\n+        return summarize(snapshot);\n+    }\n+\n+    public void update(double value, long weight) {\n+        Preconditions.checkArgument(weight >= 0, \"Weight cannot be negative.\", SafeArg.of(\"weight\", weight));\n+        if (weight == 0) {\n+            return;\n+        }\n+        updates.put(counter.getAndIncrement(), ImmutableWeightedEntry.of(value, weight));\n+    }\n+\n+    private double summarize(List<WeightedEntry> snapshot) {\n+        long totalWeight =\n+                snapshot.stream().map(WeightedEntry::weight).mapToLong(x -> x).sum();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebbc26ab11353d5fdb4e6ebcb75655a02adc99ec"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDM4NzU0OnYy", "diffSide": "RIGHT", "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/util/SlidingWindowWeightedMeanGauge.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0NzowN1rOHltHtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0NzowN1rOHltHtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5ODYxNQ==", "bodyText": "same as above", "url": "https://github.com/palantir/atlasdb/pull/5064#discussion_r509298615", "createdAt": "2020-10-21T13:47:07Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/util/SlidingWindowWeightedMeanGauge.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.util;\n+\n+import com.codahale.metrics.Gauge;\n+import com.github.benmanes.caffeine.cache.Cache;\n+import com.github.benmanes.caffeine.cache.Caffeine;\n+import com.google.common.collect.ImmutableList;\n+import com.palantir.logsafe.Preconditions;\n+import com.palantir.logsafe.SafeArg;\n+import java.time.Duration;\n+import java.util.List;\n+import java.util.concurrent.atomic.AtomicLong;\n+import org.immutables.value.Value;\n+\n+/**\n+ * A gauge that calculates the weighted mean of updates during a sliding window of time. Correctness is only guaranteed\n+ * as long as the sum of recorded weights and sum of weighted values do not exceed {@link Long#MAX_VALUE} and\n+ * {@link Double#MAX_VALUE}, respectively.\n+ */\n+public class SlidingWindowWeightedMeanGauge implements Gauge<Double> {\n+    private final Cache<Long, WeightedEntry> updates;\n+    private final AtomicLong counter = new AtomicLong();\n+\n+    public SlidingWindowWeightedMeanGauge(Duration expirationDuration) {\n+        this.updates =\n+                Caffeine.newBuilder().expireAfterWrite(expirationDuration).build();\n+    }\n+\n+    public static SlidingWindowWeightedMeanGauge create() {\n+        return new SlidingWindowWeightedMeanGauge(Duration.ofMinutes(5L));\n+    }\n+\n+    @Override\n+    public Double getValue() {\n+        List<WeightedEntry> snapshot = ImmutableList.copyOf(updates.asMap().values());\n+        return summarize(snapshot);\n+    }\n+\n+    public void update(double value, long weight) {\n+        Preconditions.checkArgument(weight >= 0, \"Weight cannot be negative.\", SafeArg.of(\"weight\", weight));\n+        if (weight == 0) {\n+            return;\n+        }\n+        updates.put(counter.getAndIncrement(), ImmutableWeightedEntry.of(value, weight));\n+    }\n+\n+    private double summarize(List<WeightedEntry> snapshot) {\n+        long totalWeight =\n+                snapshot.stream().map(WeightedEntry::weight).mapToLong(x -> x).sum();\n+        if (totalWeight == 0) {\n+            return 0.0;\n+        }\n+        double valueSum = snapshot.stream()\n+                .map(entry -> entry.value() * entry.weight())\n+                .mapToDouble(x -> x)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebbc26ab11353d5fdb4e6ebcb75655a02adc99ec"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE5MDM5MTk0OnYy", "diffSide": "RIGHT", "path": "atlasdb-client/src/test/java/com/palantir/atlasdb/util/SlidingWindowWeightedMeanGaugeTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0Nzo0MFrOHltKhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMzo0ODoxM1rOHltNCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5OTMzMg==", "bodyText": "can we reduce to <1%? Just to make this a bit tighter", "url": "https://github.com/palantir/atlasdb/pull/5064#discussion_r509299332", "createdAt": "2020-10-21T13:47:40Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-client/src/test/java/com/palantir/atlasdb/util/SlidingWindowWeightedMeanGaugeTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.util;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.assertj.core.api.Assertions.withinPercentage;\n+\n+import java.time.Duration;\n+import org.junit.Test;\n+\n+public class SlidingWindowWeightedMeanGaugeTest {\n+    private SlidingWindowWeightedMeanGauge gauge = SlidingWindowWeightedMeanGauge.create();\n+\n+    @Test\n+    public void initialValueIsZero() {\n+        assertValueWithinOnePercentOf(0.0);\n+    }\n+\n+    @Test\n+    public void withEqualWeightsCalculateMeanOfValues() {\n+        gauge.update(1.2, 5L);\n+        gauge.update(1.5, 5L);\n+        gauge.update(1.8, 5L);\n+        assertValueWithinOnePercentOf(1.5);\n+    }\n+\n+    @Test\n+    public void calculateWeightedMean() {\n+        gauge.update(101.0, 1);\n+        gauge.update(1.0, 98);\n+        gauge.update(301.0, 1);\n+        assertValueWithinOnePercentOf(5.0);\n+    }\n+\n+    @Test\n+    public void testMultipleGets() {\n+        gauge.update(1.0, 1);\n+        assertValueWithinOnePercentOf(1.0);\n+        assertValueWithinOnePercentOf(1.0);\n+        gauge.update(0.5, 4);\n+        assertValueWithinOnePercentOf(0.6);\n+    }\n+\n+    @Test\n+    public void entriesWithWeightZeroAreIgnored() {\n+        gauge.update(999.0, 0);\n+        gauge.update(1.0, 1);\n+        gauge.update(123.0, 0);\n+        assertValueWithinOnePercentOf(1.0);\n+    }\n+\n+    @Test\n+    public void entriesWithNegativeWeightThrow() {\n+        gauge.update(5.0, 4);\n+        assertThatThrownBy(() -> gauge.update(2345.0, -1)).isInstanceOf(IllegalArgumentException.class);\n+        assertValueWithinOnePercentOf(5.0);\n+    }\n+\n+    @Test\n+    public void entriesExpire() {\n+        SlidingWindowWeightedMeanGauge expiringGauge = new SlidingWindowWeightedMeanGauge(Duration.ZERO);\n+        expiringGauge.update(100.0, 50);\n+        expiringGauge.update(50.0, 4);\n+        assertThat(expiringGauge.getValue()).isCloseTo(0.0, withinPercentage(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ebbc26ab11353d5fdb4e6ebcb75655a02adc99ec"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5OTk3OA==", "bodyText": "Also, use other method", "url": "https://github.com/palantir/atlasdb/pull/5064#discussion_r509299978", "createdAt": "2020-10-21T13:48:13Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-client/src/test/java/com/palantir/atlasdb/util/SlidingWindowWeightedMeanGaugeTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.util;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+import static org.assertj.core.api.Assertions.withinPercentage;\n+\n+import java.time.Duration;\n+import org.junit.Test;\n+\n+public class SlidingWindowWeightedMeanGaugeTest {\n+    private SlidingWindowWeightedMeanGauge gauge = SlidingWindowWeightedMeanGauge.create();\n+\n+    @Test\n+    public void initialValueIsZero() {\n+        assertValueWithinOnePercentOf(0.0);\n+    }\n+\n+    @Test\n+    public void withEqualWeightsCalculateMeanOfValues() {\n+        gauge.update(1.2, 5L);\n+        gauge.update(1.5, 5L);\n+        gauge.update(1.8, 5L);\n+        assertValueWithinOnePercentOf(1.5);\n+    }\n+\n+    @Test\n+    public void calculateWeightedMean() {\n+        gauge.update(101.0, 1);\n+        gauge.update(1.0, 98);\n+        gauge.update(301.0, 1);\n+        assertValueWithinOnePercentOf(5.0);\n+    }\n+\n+    @Test\n+    public void testMultipleGets() {\n+        gauge.update(1.0, 1);\n+        assertValueWithinOnePercentOf(1.0);\n+        assertValueWithinOnePercentOf(1.0);\n+        gauge.update(0.5, 4);\n+        assertValueWithinOnePercentOf(0.6);\n+    }\n+\n+    @Test\n+    public void entriesWithWeightZeroAreIgnored() {\n+        gauge.update(999.0, 0);\n+        gauge.update(1.0, 1);\n+        gauge.update(123.0, 0);\n+        assertValueWithinOnePercentOf(1.0);\n+    }\n+\n+    @Test\n+    public void entriesWithNegativeWeightThrow() {\n+        gauge.update(5.0, 4);\n+        assertThatThrownBy(() -> gauge.update(2345.0, -1)).isInstanceOf(IllegalArgumentException.class);\n+        assertValueWithinOnePercentOf(5.0);\n+    }\n+\n+    @Test\n+    public void entriesExpire() {\n+        SlidingWindowWeightedMeanGauge expiringGauge = new SlidingWindowWeightedMeanGauge(Duration.ZERO);\n+        expiringGauge.update(100.0, 50);\n+        expiringGauge.update(50.0, 4);\n+        assertThat(expiringGauge.getValue()).isCloseTo(0.0, withinPercentage(1));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI5OTMzMg=="}, "originalCommit": {"oid": "ebbc26ab11353d5fdb4e6ebcb75655a02adc99ec"}, "originalPosition": 79}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2420, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}