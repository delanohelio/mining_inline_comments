{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NzQ3NTU5", "number": 4893, "title": "[PD$-110002] Part 11: Top-N Tables | Toplist Delta Filtering Controller", "bodyText": "Goals (and why):\n\nSee #4891\n\nImplementation Description (bullets):\n\nImplement a filtering controller that filters out metrics that aren't in the top N in terms of delta since the last refresh interval.\n\nTesting (What was existing testing like?  What have you done to improve it?): Toplist code has unit tests.\nConcerns (what feedback would you like?):\n\nDoes selecting a delta make sense?\n\nWhere should we start reviewing?:\n\nTableLevelMetricsController interface, then implementations\n\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-07-09T09:47:48Z", "url": "https://github.com/palantir/atlasdb/pull/4893", "merged": true, "mergeCommit": {"oid": "94da77dc12b3f1c6db081452ad374d2dc3c1db23"}, "closed": true, "closedAt": "2020-07-16T12:49:11Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczO6AdgFqTQ0NTU0NzQ1Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1ecfCAH2gAyNDQ2NzQ3NTU5OmUzMmM2ZWQ3YzU0OWI3ZDcxNWJjZGRjMmRiYjUwOWU2ZTZhM2U3MzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NTQ3NDUz", "url": "https://github.com/palantir/atlasdb/pull/4893#pullrequestreview-445547453", "createdAt": "2020-07-09T11:59:45Z", "commit": {"oid": "71f3e5cbcefa162a21ca43d0c3188264ae2c5bec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMTo1OTo0NlrOGvN8-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMTo1OTo0NlrOGvN8-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE2NDg1Nw==", "bodyText": "Register filter before registering metric? Would it matter?", "url": "https://github.com/palantir/atlasdb/pull/4893#discussion_r452164857", "createdAt": "2020-07-09T11:59:46Z", "author": {"login": "sudiksha27"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/metrics/ToplistDeltaFilteringTableLevelMetricsController.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.transaction.impl.metrics;\n+\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.concurrent.TimeUnit;\n+\n+import com.codahale.metrics.CachedGauge;\n+import com.codahale.metrics.Clock;\n+import com.codahale.metrics.Counter;\n+import com.codahale.metrics.Gauge;\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.Maps;\n+import com.palantir.atlasdb.keyvalue.api.TableReference;\n+import com.palantir.atlasdb.metrics.MetricPublicationFilter;\n+import com.palantir.atlasdb.util.MetricsManager;\n+import com.palantir.atlasdb.util.TopNMetricPublicationController;\n+\n+/**\n+ * Makes publication decisions for a given metric, as follows: for a given String identifier, filters out all but the\n+ * highest {@code maximumNumberOfTables} values. In the event of ties (e.g. a top-list of 10 where the 10th and 11th\n+ * highest values are equal), all tying values are published.\n+ *\n+ * This controller makes decisions based on deltas (in an attempt to be able to detect load spikes) measured over the\n+ * last {@code REFRESH_INTERVAL} period.\n+ */\n+public final class ToplistDeltaFilteringTableLevelMetricsController implements TableLevelMetricsController {\n+    private static final int DEFAULT_MAX_TABLES_TO_PUBLISH_METRICS = 10;\n+    private static final String CONTROLLER_GENERATED = \"controllerGenerated\";\n+    private static final String TRUE = \"true\";\n+\n+    @VisibleForTesting\n+    static final Duration REFRESH_INTERVAL = Duration.ofSeconds(30);\n+\n+    private final Map<String, TopNMetricPublicationController<Long>> metricNameToPublicationController;\n+    private final MetricsManager metricsManager;\n+    private final int maximumNumberOfTables;\n+    private final Clock clock;\n+\n+    @VisibleForTesting\n+    ToplistDeltaFilteringTableLevelMetricsController(\n+            MetricsManager metricsManager,\n+            int maximumNumberOfTables,\n+            Clock clock) {\n+        this.metricNameToPublicationController = Maps.newConcurrentMap();\n+        this.metricsManager = metricsManager;\n+        this.maximumNumberOfTables = maximumNumberOfTables;\n+        this.clock = clock;\n+    }\n+\n+    public static TableLevelMetricsController create(MetricsManager metricsManager) {\n+        return new ToplistDeltaFilteringTableLevelMetricsController(\n+                metricsManager,\n+                DEFAULT_MAX_TABLES_TO_PUBLISH_METRICS,\n+                Clock.defaultClock());\n+    }\n+\n+    @Override\n+    public <T> Counter createAndRegisterCounter(Class<T> clazz, String metricName, TableReference tableReference) {\n+        Counter counter = metricsManager.registerOrGetTaggedCounter(\n+                clazz,\n+                metricName,\n+                getTagsForTableReference(tableReference));\n+        metricsManager.addMetricFilter(\n+                clazz,\n+                metricName,\n+                getTagsForTableReference(tableReference),\n+                MetricPublicationFilter.NEVER_PUBLISH);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "71f3e5cbcefa162a21ca43d0c3188264ae2c5bec"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MjM0OTE0", "url": "https://github.com/palantir/atlasdb/pull/4893#pullrequestreview-447234914", "createdAt": "2020-07-13T13:10:43Z", "commit": {"oid": "f0a0a007dc55b1369e8c9f5ca40c47cc4b697549"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b96c6b62a09a2388c019261556d5fca47d7c0e46", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/b96c6b62a09a2388c019261556d5fca47d7c0e46", "committedDate": "2020-07-16T10:28:18Z", "message": "Controller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "138a4313ad5799192ce9bfbe26e5224bf130b1b5", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/138a4313ad5799192ce9bfbe26e5224bf130b1b5", "committedDate": "2020-07-16T10:29:11Z", "message": "Controller test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dd352a63e011883e77e5e48913f6760005aa75e", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/9dd352a63e011883e77e5e48913f6760005aa75e", "committedDate": "2020-07-16T10:29:18Z", "message": "Delta gauge and tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7120bfcbeab9b0bd3a9cea82e03997f3a4b0acbe", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/7120bfcbeab9b0bd3a9cea82e03997f3a4b0acbe", "committedDate": "2020-07-16T10:29:32Z", "message": "Toplist Delta"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "959e672636c501bf8f467333437e9d116612291d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/959e672636c501bf8f467333437e9d116612291d", "committedDate": "2020-07-16T10:29:32Z", "message": "baseline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36d29a665a768ddc20ec68d81008adfabb17a88b", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/36d29a665a768ddc20ec68d81008adfabb17a88b", "committedDate": "2020-07-16T10:29:32Z", "message": "Register filter before creating"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0a0a007dc55b1369e8c9f5ca40c47cc4b697549", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/f0a0a007dc55b1369e8c9f5ca40c47cc4b697549", "committedDate": "2020-07-09T19:06:54Z", "message": "Register filter before creating"}, "afterCommit": {"oid": "36d29a665a768ddc20ec68d81008adfabb17a88b", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/36d29a665a768ddc20ec68d81008adfabb17a88b", "committedDate": "2020-07-16T10:29:32Z", "message": "Register filter before creating"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e32c6ed7c549b7d715bcddc2dbb509e6e6a3e730", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e32c6ed7c549b7d715bcddc2dbb509e6e6a3e730", "committedDate": "2020-07-16T12:32:20Z", "message": "Remove unusable test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2730, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}