{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2MTEyMjIz", "number": 5101, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNTowMDo0MVrOE1slAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMTozOTozM1rOE3qw_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NzQwMzU0OnYy", "diffSide": "RIGHT", "path": "timelock-api/src/main/conjure/cross-client-batched-timelock-api.yml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNTowMDo0MVrOHuHXGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjoyOTo0M1rOHuLmRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODExNzE0NA==", "bodyText": "I don't know what opinions are on just adding these endpoints / requests to the current timelock api, or creating a new one (as you have done here) - but either way, I think it's really weird to import in definitions from the other API.", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518117144", "createdAt": "2020-11-05T15:00:41Z", "author": {"login": "Jolyon-S"}, "path": "timelock-api/src/main/conjure/cross-client-batched-timelock-api.yml", "diffHunk": "@@ -0,0 +1,63 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    Long:\n+      base-type: any\n+      external:\n+        java: java.lang.Long\n+    LockWatchStateUpdate:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.watch.LockWatchStateUpdate\n+    ConjureIdentifiedVersion:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.ConjureIdentifiedVersion", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3456eb30bab2665f7def13fec9375541147a2db"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4NjU2Nw==", "bodyText": "I'd prefer we just use the existing API file. In my mind the model was that they would be placed on a different service, but in the same API.", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518186567", "createdAt": "2020-11-05T16:29:43Z", "author": {"login": "jeremyk-91"}, "path": "timelock-api/src/main/conjure/cross-client-batched-timelock-api.yml", "diffHunk": "@@ -0,0 +1,63 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    Long:\n+      base-type: any\n+      external:\n+        java: java.lang.Long\n+    LockWatchStateUpdate:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.watch.LockWatchStateUpdate\n+    ConjureIdentifiedVersion:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.ConjureIdentifiedVersion", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODExNzE0NA=="}, "originalCommit": {"oid": "a3456eb30bab2665f7def13fec9375541147a2db"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NzQ3MDQzOnYy", "diffSide": "RIGHT", "path": "timelock-api/src/main/conjure/cross-client-batched-timelock-api.yml", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNToxNToyMVrOHuIBlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjo0ODoxNFrOHuMbRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEyODAyMw==", "bodyText": "I'm not convinced this is the right approach. I'd have thought you would want a request type like NamespacedLeaderTimes, then call with a list of those. The point of that would be if you had incoming requests for leader time such as:\nnamespace1\nnamespace2\nnamespace3\nnamespace1\nsay they all get batched together - you'd likely want to further gather together all requests of the same namespace into their own requests, so that you can do clever things (coalesce / reduce overheads etc). Maybe I'm missing something - I've just looked at this briefly - but that seems like the right thing to do.", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518128023", "createdAt": "2020-11-05T15:15:21Z", "author": {"login": "Jolyon-S"}, "path": "timelock-api/src/main/conjure/cross-client-batched-timelock-api.yml", "diffHunk": "@@ -0,0 +1,63 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    Long:\n+      base-type: any\n+      external:\n+        java: java.lang.Long\n+    LockWatchStateUpdate:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.watch.LockWatchStateUpdate\n+    ConjureIdentifiedVersion:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.ConjureIdentifiedVersion\n+    GetCommitTimestampsRequest:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.GetCommitTimestampsRequest\n+    GetCommitTimestampsResponse:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.GetCommitTimestampsResponse\n+  definitions:\n+    default-package: com.palantir.atlasdb.timelock.api\n+    objects:\n+      NamespacedLeaderTime:\n+        fields:\n+          namespace: string\n+          leaderTime: LeaderTime\n+      NamespacedGetCommitTimestampsRequest:\n+        fields:\n+          namespace: string\n+          getCommitTimestampsRequest: GetCommitTimestampsRequest\n+      NamespacedGetCommitTimestampsResponse:\n+        fields:\n+          namespace: string\n+          getCommitTimestampsResponse: GetCommitTimestampsResponse\n+\n+services:\n+  CrossClientBatchedConjureTimelockService:\n+    name: Cross Client Batched Timelock Service\n+    default-auth: header\n+    package: com.palantir.atlasdb.timelock.batch.api\n+    base-path: /tl/batch\n+    endpoints:\n+      leaderTimes:\n+        http: POST /lts\n+        args:\n+          namespaces: list<string>\n+        returns: list<NamespacedLeaderTime>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3456eb30bab2665f7def13fec9375541147a2db"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4NjM1Nw==", "bodyText": "You're right, the server should be defensive against multiple queries for same namespace.", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518186357", "createdAt": "2020-11-05T16:29:28Z", "author": {"login": "sudiksha27"}, "path": "timelock-api/src/main/conjure/cross-client-batched-timelock-api.yml", "diffHunk": "@@ -0,0 +1,63 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    Long:\n+      base-type: any\n+      external:\n+        java: java.lang.Long\n+    LockWatchStateUpdate:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.watch.LockWatchStateUpdate\n+    ConjureIdentifiedVersion:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.ConjureIdentifiedVersion\n+    GetCommitTimestampsRequest:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.GetCommitTimestampsRequest\n+    GetCommitTimestampsResponse:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.GetCommitTimestampsResponse\n+  definitions:\n+    default-package: com.palantir.atlasdb.timelock.api\n+    objects:\n+      NamespacedLeaderTime:\n+        fields:\n+          namespace: string\n+          leaderTime: LeaderTime\n+      NamespacedGetCommitTimestampsRequest:\n+        fields:\n+          namespace: string\n+          getCommitTimestampsRequest: GetCommitTimestampsRequest\n+      NamespacedGetCommitTimestampsResponse:\n+        fields:\n+          namespace: string\n+          getCommitTimestampsResponse: GetCommitTimestampsResponse\n+\n+services:\n+  CrossClientBatchedConjureTimelockService:\n+    name: Cross Client Batched Timelock Service\n+    default-auth: header\n+    package: com.palantir.atlasdb.timelock.batch.api\n+    base-path: /tl/batch\n+    endpoints:\n+      leaderTimes:\n+        http: POST /lts\n+        args:\n+          namespaces: list<string>\n+        returns: list<NamespacedLeaderTime>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEyODAyMw=="}, "originalCommit": {"oid": "a3456eb30bab2665f7def13fec9375541147a2db"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE4ODMwMw==", "bodyText": "This is LeaderTime, though, which is a coalescing endpoint, and so for this one Sudiksha's API is correct (notice that namespaces is a list of strings, and any futures for those namespaces will be answered with the correct answer from the list of NamespacedLeaderTimes).", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518188303", "createdAt": "2020-11-05T16:31:58Z", "author": {"login": "jeremyk-91"}, "path": "timelock-api/src/main/conjure/cross-client-batched-timelock-api.yml", "diffHunk": "@@ -0,0 +1,63 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    Long:\n+      base-type: any\n+      external:\n+        java: java.lang.Long\n+    LockWatchStateUpdate:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.watch.LockWatchStateUpdate\n+    ConjureIdentifiedVersion:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.ConjureIdentifiedVersion\n+    GetCommitTimestampsRequest:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.GetCommitTimestampsRequest\n+    GetCommitTimestampsResponse:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.GetCommitTimestampsResponse\n+  definitions:\n+    default-package: com.palantir.atlasdb.timelock.api\n+    objects:\n+      NamespacedLeaderTime:\n+        fields:\n+          namespace: string\n+          leaderTime: LeaderTime\n+      NamespacedGetCommitTimestampsRequest:\n+        fields:\n+          namespace: string\n+          getCommitTimestampsRequest: GetCommitTimestampsRequest\n+      NamespacedGetCommitTimestampsResponse:\n+        fields:\n+          namespace: string\n+          getCommitTimestampsResponse: GetCommitTimestampsResponse\n+\n+services:\n+  CrossClientBatchedConjureTimelockService:\n+    name: Cross Client Batched Timelock Service\n+    default-auth: header\n+    package: com.palantir.atlasdb.timelock.batch.api\n+    base-path: /tl/batch\n+    endpoints:\n+      leaderTimes:\n+        http: POST /lts\n+        args:\n+          namespaces: list<string>\n+        returns: list<NamespacedLeaderTime>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEyODAyMw=="}, "originalCommit": {"oid": "a3456eb30bab2665f7def13fec9375541147a2db"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5ODAyMw==", "bodyText": "For leaderTime, I think having a set of namespaces should be okay. I am unsure if we need more than one computation for any client (even if they are making more than one query).\nResolving collision for NamespacedGetCommitTimestampsRequest might be trickier because of LockWatchVersion but, I can also not see the case where we manage to make two queries in one request with different lockWatchVersion for same client.", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518198023", "createdAt": "2020-11-05T16:45:22Z", "author": {"login": "sudiksha27"}, "path": "timelock-api/src/main/conjure/cross-client-batched-timelock-api.yml", "diffHunk": "@@ -0,0 +1,63 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    Long:\n+      base-type: any\n+      external:\n+        java: java.lang.Long\n+    LockWatchStateUpdate:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.watch.LockWatchStateUpdate\n+    ConjureIdentifiedVersion:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.ConjureIdentifiedVersion\n+    GetCommitTimestampsRequest:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.GetCommitTimestampsRequest\n+    GetCommitTimestampsResponse:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.GetCommitTimestampsResponse\n+  definitions:\n+    default-package: com.palantir.atlasdb.timelock.api\n+    objects:\n+      NamespacedLeaderTime:\n+        fields:\n+          namespace: string\n+          leaderTime: LeaderTime\n+      NamespacedGetCommitTimestampsRequest:\n+        fields:\n+          namespace: string\n+          getCommitTimestampsRequest: GetCommitTimestampsRequest\n+      NamespacedGetCommitTimestampsResponse:\n+        fields:\n+          namespace: string\n+          getCommitTimestampsResponse: GetCommitTimestampsResponse\n+\n+services:\n+  CrossClientBatchedConjureTimelockService:\n+    name: Cross Client Batched Timelock Service\n+    default-auth: header\n+    package: com.palantir.atlasdb.timelock.batch.api\n+    base-path: /tl/batch\n+    endpoints:\n+      leaderTimes:\n+        http: POST /lts\n+        args:\n+          namespaces: list<string>\n+        returns: list<NamespacedLeaderTime>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEyODAyMw=="}, "originalCommit": {"oid": "a3456eb30bab2665f7def13fec9375541147a2db"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODIwMDEzNQ==", "bodyText": "I can:\nImagine we have one service using atlasdb-proxy that has multiple nodes. They might all talk to the same node of atlasdb-proxy but with different internal lockWatchVersions, and would expect different responses (and yet would all be the same namespace in Atlas).", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518200135", "createdAt": "2020-11-05T16:48:14Z", "author": {"login": "Jolyon-S"}, "path": "timelock-api/src/main/conjure/cross-client-batched-timelock-api.yml", "diffHunk": "@@ -0,0 +1,63 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    Long:\n+      base-type: any\n+      external:\n+        java: java.lang.Long\n+    LockWatchStateUpdate:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.watch.LockWatchStateUpdate\n+    ConjureIdentifiedVersion:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.ConjureIdentifiedVersion\n+    GetCommitTimestampsRequest:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.GetCommitTimestampsRequest\n+    GetCommitTimestampsResponse:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.GetCommitTimestampsResponse\n+  definitions:\n+    default-package: com.palantir.atlasdb.timelock.api\n+    objects:\n+      NamespacedLeaderTime:\n+        fields:\n+          namespace: string\n+          leaderTime: LeaderTime\n+      NamespacedGetCommitTimestampsRequest:\n+        fields:\n+          namespace: string\n+          getCommitTimestampsRequest: GetCommitTimestampsRequest\n+      NamespacedGetCommitTimestampsResponse:\n+        fields:\n+          namespace: string\n+          getCommitTimestampsResponse: GetCommitTimestampsResponse\n+\n+services:\n+  CrossClientBatchedConjureTimelockService:\n+    name: Cross Client Batched Timelock Service\n+    default-auth: header\n+    package: com.palantir.atlasdb.timelock.batch.api\n+    base-path: /tl/batch\n+    endpoints:\n+      leaderTimes:\n+        http: POST /lts\n+        args:\n+          namespaces: list<string>\n+        returns: list<NamespacedLeaderTime>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEyODAyMw=="}, "originalCommit": {"oid": "a3456eb30bab2665f7def13fec9375541147a2db"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0NzkxOTMwOnYy", "diffSide": "RIGHT", "path": "timelock-api/src/main/conjure/cross-client-batched-timelock-api.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjo0NzowNlrOHuMYRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjo0NzowNlrOHuMYRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE5OTM2Ng==", "bodyText": "This one on the other hand is a bit messier - there's some nontrivial logic in how to reduce all of the legacy GetCommitTimestampRequests into a single one (basically you can take the oldest easily, maybe the newest if there's some clever hackery on the client side).", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518199366", "createdAt": "2020-11-05T16:47:06Z", "author": {"login": "jeremyk-91"}, "path": "timelock-api/src/main/conjure/cross-client-batched-timelock-api.yml", "diffHunk": "@@ -0,0 +1,63 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    Long:\n+      base-type: any\n+      external:\n+        java: java.lang.Long\n+    LockWatchStateUpdate:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.watch.LockWatchStateUpdate\n+    ConjureIdentifiedVersion:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.ConjureIdentifiedVersion\n+    GetCommitTimestampsRequest:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.GetCommitTimestampsRequest\n+    GetCommitTimestampsResponse:\n+      base-type: any\n+      external:\n+        java: com.palantir.atlasdb.timelock.api.GetCommitTimestampsResponse\n+  definitions:\n+    default-package: com.palantir.atlasdb.timelock.api\n+    objects:\n+      NamespacedLeaderTime:\n+        fields:\n+          namespace: string\n+          leaderTime: LeaderTime\n+      NamespacedGetCommitTimestampsRequest:\n+        fields:\n+          namespace: string\n+          getCommitTimestampsRequest: GetCommitTimestampsRequest\n+      NamespacedGetCommitTimestampsResponse:\n+        fields:\n+          namespace: string\n+          getCommitTimestampsResponse: GetCommitTimestampsResponse\n+\n+services:\n+  CrossClientBatchedConjureTimelockService:\n+    name: Cross Client Batched Timelock Service\n+    default-auth: header\n+    package: com.palantir.atlasdb.timelock.batch.api\n+    base-path: /tl/batch\n+    endpoints:\n+      leaderTimes:\n+        http: POST /lts\n+        args:\n+          namespaces: set<string>\n+        returns: list<NamespacedLeaderTime>\n+        docs: |\n+          Cross client batched version of ConjureTimelockService#leaderTime endpoint for acquiring leaderTimes.\n+      getCommitTimestamps:\n+        http: POST /gcts\n+        args:\n+          requests: list<NamespacedGetCommitTimestampsRequest>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e70a92e75e55fa665bb807821a6ac2e22e399932"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODM4NDQ3OnYy", "diffSide": "RIGHT", "path": "timelock-api/src/main/conjure/timelock-api.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODozMzowN1rOHuQ8nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODozMzowN1rOHuQ8nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3NDIwNA==", "bodyText": "missed on pass 1: I don't think CrossClientBatched should be a part of the service name as it's more of an implementation detail, it should really be something like MultiClientConjureTimelockService?", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518274204", "createdAt": "2020-11-05T18:33:07Z", "author": {"login": "jeremyk-91"}, "path": "timelock-api/src/main/conjure/timelock-api.yml", "diffHunk": "@@ -181,4 +193,24 @@ services:\n         http: POST /sw/{namespace}\n         args:\n           namespace: string\n-          request: LockWatchRequest\n\\ No newline at end of file\n+          request: LockWatchRequest\n+  CrossClientBatchedConjureTimelockService:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4febce3339d6055cd9611f8f67fd31e139c0484"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODM4NTc5OnYy", "diffSide": "RIGHT", "path": "timelock-api/src/main/conjure/timelock-api.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODozMzozMlrOHuQ9hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODozMzozMlrOHuQ9hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3NDQzNg==", "bodyText": "as above, the notion of batching should not exist at this level.", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518274436", "createdAt": "2020-11-05T18:33:32Z", "author": {"login": "jeremyk-91"}, "path": "timelock-api/src/main/conjure/timelock-api.yml", "diffHunk": "@@ -181,4 +193,24 @@ services:\n         http: POST /sw/{namespace}\n         args:\n           namespace: string\n-          request: LockWatchRequest\n\\ No newline at end of file\n+          request: LockWatchRequest\n+  CrossClientBatchedConjureTimelockService:\n+    name: Cross Client Batched Timelock Service\n+    default-auth: header\n+    package: com.palantir.atlasdb.timelock.batch.api\n+    base-path: /tl/batch\n+    endpoints:\n+      leaderTimes:\n+        http: POST /lts\n+        args:\n+          namespaces: set<string>\n+        returns: list<NamespacedLeaderTime>\n+        docs: |\n+          Cross client batched version of ConjureTimelockService#leaderTime endpoint for acquiring leaderTimes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4febce3339d6055cd9611f8f67fd31e139c0484"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODM4NjUyOnYy", "diffSide": "RIGHT", "path": "timelock-api/src/main/conjure/timelock-api.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODozMzo0NlrOHuQ9-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODozMzo0NlrOHuQ9-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3NDU1Mg==", "bodyText": "as above: don't think batching is correct. multiclient maybe - or can this just go in the same package?", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518274552", "createdAt": "2020-11-05T18:33:46Z", "author": {"login": "jeremyk-91"}, "path": "timelock-api/src/main/conjure/timelock-api.yml", "diffHunk": "@@ -181,4 +193,24 @@ services:\n         http: POST /sw/{namespace}\n         args:\n           namespace: string\n-          request: LockWatchRequest\n\\ No newline at end of file\n+          request: LockWatchRequest\n+  CrossClientBatchedConjureTimelockService:\n+    name: Cross Client Batched Timelock Service\n+    default-auth: header\n+    package: com.palantir.atlasdb.timelock.batch.api", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4febce3339d6055cd9611f8f67fd31e139c0484"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODM5MjIzOnYy", "diffSide": "RIGHT", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/batch/CrossClientBatchedConjureTimeLockResource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODozNToyMVrOHuRBhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODozNToyMVrOHuRBhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3NTQ2MQ==", "bodyText": "can we name this getServiceForNamespace or something like that?", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518275461", "createdAt": "2020-11-05T18:35:21Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/batch/CrossClientBatchedConjureTimeLockResource.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.batch;\n+\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import com.palantir.atlasdb.timelock.AsyncTimelockService;\n+import com.palantir.atlasdb.timelock.ConjureResourceExceptionHandler;\n+import com.palantir.atlasdb.timelock.api.ConjureIdentifiedVersion;\n+import com.palantir.atlasdb.timelock.api.GetCommitTimestampsResponse;\n+import com.palantir.atlasdb.timelock.api.NamespacedGetCommitTimestampsRequest;\n+import com.palantir.atlasdb.timelock.api.NamespacedGetCommitTimestampsResponse;\n+import com.palantir.atlasdb.timelock.api.NamespacedLeaderTime;\n+import com.palantir.atlasdb.timelock.batch.api.UndertowCrossClientBatchedConjureTimelockService;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.lock.watch.LockWatchVersion;\n+import com.palantir.tokens.auth.AuthHeader;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+\n+public final class CrossClientBatchedConjureTimeLockResource\n+        implements UndertowCrossClientBatchedConjureTimelockService {\n+    private final ConjureResourceExceptionHandler exceptionHandler;\n+    private final Function<String, AsyncTimelockService> timelockServices;\n+\n+    private CrossClientBatchedConjureTimeLockResource(\n+            ConjureResourceExceptionHandler exceptionHandler, Function<String, AsyncTimelockService> timelockServices) {\n+        this.exceptionHandler = exceptionHandler;\n+        this.timelockServices = timelockServices;\n+    }\n+\n+    @Override\n+    public ListenableFuture<List<NamespacedLeaderTime>> leaderTimes(AuthHeader authHeader, Set<String> namespaces) {\n+        List<ListenableFuture<NamespacedLeaderTime>> futures = namespaces.stream()\n+                .map(this::getNamespacedLeaderTimeListenableFuture)\n+                .collect(Collectors.toList());\n+\n+        return handleExceptions(() -> Futures.allAsList(futures));\n+    }\n+\n+    @Override\n+    public ListenableFuture<List<NamespacedGetCommitTimestampsResponse>> getCommitTimestamps(\n+            AuthHeader authHeader, List<NamespacedGetCommitTimestampsRequest> requests) {\n+        List<ListenableFuture<NamespacedGetCommitTimestampsResponse>> futures = requests.stream()\n+                .map(this::getNamespacedGetCommitTimestampsResponseListenableFuture)\n+                .collect(Collectors.toList());\n+\n+        return handleExceptions(() -> Futures.allAsList(futures));\n+    }\n+\n+    private ListenableFuture<NamespacedLeaderTime> getNamespacedLeaderTimeListenableFuture(String namespace) {\n+        ListenableFuture<LeaderTime> leaderTimeListenableFuture =\n+                forNamespace(namespace).leaderTime();\n+        return Futures.transform(\n+                leaderTimeListenableFuture,\n+                leaderTime -> NamespacedLeaderTime.of(namespace, leaderTime),\n+                MoreExecutors.directExecutor());\n+    }\n+\n+    private ListenableFuture<NamespacedGetCommitTimestampsResponse>\n+            getNamespacedGetCommitTimestampsResponseListenableFuture(NamespacedGetCommitTimestampsRequest request) {\n+        ListenableFuture<GetCommitTimestampsResponse> commitTimestamps = forNamespace(request.getNamespace())\n+                .getCommitTimestamps(\n+                        request.getNumTimestamps(),\n+                        request.getLastKnownVersion().map(this::toIdentifiedVersion));\n+        return Futures.transform(\n+                commitTimestamps,\n+                commitTimestampsResponse -> NamespacedGetCommitTimestampsResponse.builder()\n+                        .namespace(request.getNamespace())\n+                        .inclusiveLower(commitTimestampsResponse.getInclusiveLower())\n+                        .inclusiveUpper(commitTimestampsResponse.getInclusiveUpper())\n+                        .lockWatchUpdate(commitTimestampsResponse.getLockWatchUpdate())\n+                        .build(),\n+                MoreExecutors.directExecutor());\n+    }\n+\n+    private AsyncTimelockService forNamespace(String namespace) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4febce3339d6055cd9611f8f67fd31e139c0484"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0ODM5NjgwOnYy", "diffSide": "RIGHT", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/batch/CrossClientBatchedConjureTimeLockResource.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODozNjozNVrOHuREWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxODozNjozNVrOHuREWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODI3NjE4Nw==", "bodyText": "I think this is safe and correct; can you explain why this is the case?", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r518276187", "createdAt": "2020-11-05T18:36:35Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/batch/CrossClientBatchedConjureTimeLockResource.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.batch;\n+\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import com.palantir.atlasdb.timelock.AsyncTimelockService;\n+import com.palantir.atlasdb.timelock.ConjureResourceExceptionHandler;\n+import com.palantir.atlasdb.timelock.api.ConjureIdentifiedVersion;\n+import com.palantir.atlasdb.timelock.api.GetCommitTimestampsResponse;\n+import com.palantir.atlasdb.timelock.api.NamespacedGetCommitTimestampsRequest;\n+import com.palantir.atlasdb.timelock.api.NamespacedGetCommitTimestampsResponse;\n+import com.palantir.atlasdb.timelock.api.NamespacedLeaderTime;\n+import com.palantir.atlasdb.timelock.batch.api.UndertowCrossClientBatchedConjureTimelockService;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.lock.watch.LockWatchVersion;\n+import com.palantir.tokens.auth.AuthHeader;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+import java.util.stream.Collectors;\n+\n+public final class CrossClientBatchedConjureTimeLockResource\n+        implements UndertowCrossClientBatchedConjureTimelockService {\n+    private final ConjureResourceExceptionHandler exceptionHandler;\n+    private final Function<String, AsyncTimelockService> timelockServices;\n+\n+    private CrossClientBatchedConjureTimeLockResource(\n+            ConjureResourceExceptionHandler exceptionHandler, Function<String, AsyncTimelockService> timelockServices) {\n+        this.exceptionHandler = exceptionHandler;\n+        this.timelockServices = timelockServices;\n+    }\n+\n+    @Override\n+    public ListenableFuture<List<NamespacedLeaderTime>> leaderTimes(AuthHeader authHeader, Set<String> namespaces) {\n+        List<ListenableFuture<NamespacedLeaderTime>> futures = namespaces.stream()\n+                .map(this::getNamespacedLeaderTimeListenableFuture)\n+                .collect(Collectors.toList());\n+\n+        return handleExceptions(() -> Futures.allAsList(futures));\n+    }\n+\n+    @Override\n+    public ListenableFuture<List<NamespacedGetCommitTimestampsResponse>> getCommitTimestamps(\n+            AuthHeader authHeader, List<NamespacedGetCommitTimestampsRequest> requests) {\n+        List<ListenableFuture<NamespacedGetCommitTimestampsResponse>> futures = requests.stream()\n+                .map(this::getNamespacedGetCommitTimestampsResponseListenableFuture)\n+                .collect(Collectors.toList());\n+\n+        return handleExceptions(() -> Futures.allAsList(futures));\n+    }\n+\n+    private ListenableFuture<NamespacedLeaderTime> getNamespacedLeaderTimeListenableFuture(String namespace) {\n+        ListenableFuture<LeaderTime> leaderTimeListenableFuture =\n+                forNamespace(namespace).leaderTime();\n+        return Futures.transform(\n+                leaderTimeListenableFuture,\n+                leaderTime -> NamespacedLeaderTime.of(namespace, leaderTime),\n+                MoreExecutors.directExecutor());\n+    }\n+\n+    private ListenableFuture<NamespacedGetCommitTimestampsResponse>\n+            getNamespacedGetCommitTimestampsResponseListenableFuture(NamespacedGetCommitTimestampsRequest request) {\n+        ListenableFuture<GetCommitTimestampsResponse> commitTimestamps = forNamespace(request.getNamespace())\n+                .getCommitTimestamps(\n+                        request.getNumTimestamps(),\n+                        request.getLastKnownVersion().map(this::toIdentifiedVersion));\n+        return Futures.transform(\n+                commitTimestamps,\n+                commitTimestampsResponse -> NamespacedGetCommitTimestampsResponse.builder()\n+                        .namespace(request.getNamespace())\n+                        .inclusiveLower(commitTimestampsResponse.getInclusiveLower())\n+                        .inclusiveUpper(commitTimestampsResponse.getInclusiveUpper())\n+                        .lockWatchUpdate(commitTimestampsResponse.getLockWatchUpdate())\n+                        .build(),\n+                MoreExecutors.directExecutor());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4febce3339d6055cd9611f8f67fd31e139c0484"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2ODA3ODA3OnYy", "diffSide": "RIGHT", "path": "timelock-api/src/main/conjure/timelock-api.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMTozOTozM1rOHxJjnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxMTozOTozM1rOHxJjnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTI5ODg0Nw==", "bodyText": "change base path", "url": "https://github.com/palantir/atlasdb/pull/5101#discussion_r521298847", "createdAt": "2020-11-11T11:39:33Z", "author": {"login": "sudiksha27"}, "path": "timelock-api/src/main/conjure/timelock-api.yml", "diffHunk": "@@ -181,4 +193,24 @@ services:\n         http: POST /sw/{namespace}\n         args:\n           namespace: string\n-          request: LockWatchRequest\n\\ No newline at end of file\n+          request: LockWatchRequest\n+  MultiClientConjureTimelockService:\n+    name: Multi Client Timelock Service\n+    default-auth: header\n+    package: com.palantir.atlasdb.timelock.api\n+    base-path: /tl/batch\n+    endpoints:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3247bc7296f772e2e5958a42a2f69db26f1ddca3"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2485, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}