{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMTE1ODEw", "number": 4656, "title": "Reduce retained memory in delete executor work queue", "bodyText": "Goals (and why):\nreduce the retained size of the deleteExecutor work queue. Each runnable in deleteExecutor currently has a reference to this, which is a SnapshotTransaction and can be potentially huge.\nImplementation Description (bullets):\n\nmake deleteCells, the only method passed to deleteExecutor::execute in a lambda, be static so the lambda object will lose the SnapshotTransaction reference, reducing its retained memory size.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nConcerns (what feedback would you like?):\nWhere should we start reviewing?:\nPriority (whenever / two weeks / yesterday):", "createdAt": "2020-03-19T16:44:52Z", "url": "https://github.com/palantir/atlasdb/pull/4656", "merged": true, "mergeCommit": {"oid": "51379799f5d17516a4316d46abcd40d2cecdf8f6"}, "closed": true, "closedAt": "2020-04-17T17:30:02Z", "author": {"login": "onursatici"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPOqa0gH2gAyMzkxMTE1ODEwOjhmOTRhNzgzNDc5MjdiMGEwMWU2Y2Y0ODgxY2RjODU1NDlhYjRmYTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYkwgrAFqTM5NTY0MjYyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f94a78347927b0a01e6cf4881cdc85549ab4fa3", "author": {"user": {"login": "onursatici", "name": "Onur Satici"}}, "url": "https://github.com/palantir/atlasdb/commit/8f94a78347927b0a01e6cf4881cdc85549ab4fa3", "committedDate": "2020-03-19T16:39:57Z", "message": "fix possible leak in deleteCells"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e578efd676fd92703ff4f7cc1cab1fb24243f5e", "author": {"user": {"login": "onursatici", "name": "Onur Satici"}}, "url": "https://github.com/palantir/atlasdb/commit/3e578efd676fd92703ff4f7cc1cab1fb24243f5e", "committedDate": "2020-03-19T16:40:42Z", "message": "style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMjM0NjMw", "url": "https://github.com/palantir/atlasdb/pull/4656#pullrequestreview-380234630", "createdAt": "2020-03-24T11:51:25Z", "commit": {"oid": "3e578efd676fd92703ff4f7cc1cab1fb24243f5e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMTo1MToyNVrOF6ssnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMTo1MToyNVrOF6ssnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA5NDA0NQ==", "bodyText": "We should have a comment here as to why this method is supposed to be static", "url": "https://github.com/palantir/atlasdb/pull/4656#discussion_r397094045", "createdAt": "2020-03-24T11:51:25Z", "author": {"login": "sudiksha27"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -1928,7 +1928,7 @@ private boolean rollbackFailedTransactions(\n         return true;\n     }\n \n-    private void deleteCells(TableReference tableRef, Map<Cell, Long> keysToDelete) {\n+    private static void deleteCells(KeyValueService keyValueService, TableReference tableRef, Map<Cell, Long> keysToDelete) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e578efd676fd92703ff4f7cc1cab1fb24243f5e"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ac0ba028b44325d7660d61a3a9f215509cbe4a6", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/6ac0ba028b44325d7660d61a3a9f215509cbe4a6", "committedDate": "2020-04-07T11:59:54Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e3bd57163e74560f81cada7a59810439d0e443b", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/3e3bd57163e74560f81cada7a59810439d0e443b", "committedDate": "2020-04-07T11:59:54Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a387b4c549c31f070cb3c73cd524c5f40e9a1d98", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/a387b4c549c31f070cb3c73cd524c5f40e9a1d98", "committedDate": "2020-04-07T11:59:54Z", "message": "Add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67baaa70cc46f52fa85381b8324da566400bcc62", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/67baaa70cc46f52fa85381b8324da566400bcc62", "committedDate": "2020-04-07T11:59:54Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDcwMTgx", "url": "https://github.com/palantir/atlasdb/pull/4656#pullrequestreview-389070181", "createdAt": "2020-04-07T12:35:32Z", "commit": {"oid": "3e3bd57163e74560f81cada7a59810439d0e443b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjozNTozMlrOGCBYWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxOTozMzo1MVrOGCS_4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc3Mjk1Mg==", "bodyText": "nit: bracketing\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Map<Cell, Long> keysToDelete\n          \n          \n            \n                ) {\n          \n          \n            \n                        Map<Cell, Long> keysToDelete) {", "url": "https://github.com/palantir/atlasdb/pull/4656#discussion_r404772952", "createdAt": "2020-04-07T12:35:32Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -1928,7 +1928,15 @@ private boolean rollbackFailedTransactions(\n         return true;\n     }\n \n-    private void deleteCells(TableReference tableRef, Map<Cell, Long> keysToDelete) {\n+    /**\n+     * This method is made static so it loses reference to the SnapshotTransaction reference\n+     * when passed to deleteExecutor::execute in a lambda reducing its retained memory size.\n+     */\n+    private static void deleteCells(\n+            KeyValueService keyValueService,\n+            TableReference tableRef,\n+            Map<Cell, Long> keysToDelete\n+    ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e3bd57163e74560f81cada7a59810439d0e443b"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA2MTYwMw==", "bodyText": "minor nits/technicalities: the reference to a SnapshotTransaction can't be huge, it's just the word size. Maybe instead something like which could mean a lot of memory was unnecessarily retained?", "url": "https://github.com/palantir/atlasdb/pull/4656#discussion_r405061603", "createdAt": "2020-04-07T19:33:51Z", "author": {"login": "jeremyk-91"}, "path": "changelog/@unreleased/pr-4656.v2.yml", "diffHunk": "@@ -0,0 +1,6 @@\n+type: improvement\n+improvement:\n+  description: |\n+    The retained memory in delete executor work queue is reduced. Previously, each runnable in deleteExecutor had SnapshotTransaction reference, which can be potentially huge.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e3bd57163e74560f81cada7a59810439d0e443b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bd660937096dd2b4f4f5debd2bf1b582940d916", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/5bd660937096dd2b4f4f5debd2bf1b582940d916", "committedDate": "2020-04-07T21:56:45Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0146334a9c66dbce05bbf3938268415dc06b7b73", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/0146334a9c66dbce05bbf3938268415dc06b7b73", "committedDate": "2020-04-07T21:57:51Z", "message": "Merge branch 'os/delete-cells-possible-leak' of github.com:palantir/atlasdb into os/delete-cells-possible-leak"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NjQyNjIy", "url": "https://github.com/palantir/atlasdb/pull/4656#pullrequestreview-395642622", "createdAt": "2020-04-17T17:29:50Z", "commit": {"oid": "0146334a9c66dbce05bbf3938268415dc06b7b73"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2978, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}