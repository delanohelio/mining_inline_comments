{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5OTI0MTEy", "number": 4545, "title": "Start migrating AtlasDB to full conjure", "bodyText": "At present, we see some performance issues with timelock internally.\nThese will take some debugging, but one component is that our\nrecommendation for high-performance servers internally is not to use\nJersey (especially not jersey async, with the extra gubbins we have) but\nis to use conjure-undertow.\nWe also view not using conjure defined APIs as AtlasDB tech debt.\nMigrating Atlas in one go to conjure undertow is difficult if not\nimpossible. But there are two endpoints which represent most calls -\ngetLeaderTime and startTransactions.\nThis PR:\n\nAdds a conjure API project (timelock-api) and defines a subset of the\nAtlasDB timelock API in it.\nExposes this via the timelock service, with an Undertow and Jersey\nimplementation.\nUses the client for these new endpoints on the client side, provided\na boolean flag is set.\n\nRight now, tests are a little fiddly because I'm coding on my home\nlaptop and they don't work at all there.\nPlaces which are still potentially a little off:\n\nError handling logic in the Conjure undertow client is just\ndifferent to Jersey's. But I think I caught all the special error\nhandlers, and have tests for them.\nWe can't actually use this codepath until we can expose an internal\ntimelock dependency. So I've got a boolean flag that enables it\nconditionally so we can test the timelock server implementation.\nI think that the client might fall back to feign in some cases? And\nthis won't work if it calls the non-leader. Not sure how we'd want to\nchange that one.\nI now cache the TimeLockClients objects created by the TimelockAgent. I think this is ok.", "createdAt": "2020-02-01T18:14:27Z", "url": "https://github.com/palantir/atlasdb/pull/4545", "merged": true, "mergeCommit": {"oid": "a4f9b32b914b25cef8d8a7e9ed3006441598207d"}, "closed": true, "closedAt": "2020-02-18T18:27:36Z", "author": {"login": "j-baker"}, "timelineItems": {"totalCount": 32, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcAH2VfABqjI5OTk1MDU0NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFl-82gH2gAyMzY5OTI0MTEyOmM5MDdiYTJmMmUwMDNhYWZkMjBkMTVlNTc5NTE4MjgyNGUwODc2ZGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "864073bbfffd80b103967de19cf368c4f32e54f1", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/864073bbfffd80b103967de19cf368c4f32e54f1", "committedDate": "2020-02-01T18:12:05Z", "message": "Start migrating AtlasDB to full conjure\n\nAt present, we see some performance issues with timelock internally.\nThese will take some debugging, but one component is that our\nrecommendation for high-performance servers internally is not to use\nJersey (especially not jersey async, with the extra gubbins we have) but\nis to use conjure-undertow.\n\nWe also view not using conjure defined APIs as AtlasDB tech debt.\n\nMigrating Atlas in one go to conjure undertow is difficult if not\nimpossible. But there are two endpoints which represent most calls -\ngetLeaderTime and startTransactions.\n\nThis PR:\n\n1. Adds a conjure API project (timelock-api) and defines a subset of the\nAtlasDB timelock API in it.\n2. Exposes this via the timelock service, with an Undertow and Jersey\nimplementation.\n3. Uses the client for these new endpoints on the client side, provided\na boolean flag is set.\n\nRight now, tests are a little fiddly because I'm coding on my home\nlaptop and they don't work at all there.\n\nPlaces which are still potentially a little off:\n1. Error handling logic in the Conjure undertow client is just\n_different_ to Jersey's. But I think I caught all the special error\nhandlers.\n2. We can't actually use this codepath until we can expose an internal\ntimelock dependency. So I've got a boolean flag that enables it\nconditionally so we can test the timelock server implementation.\n3. I think that the client might fall back to feign in some cases? And\nthis won't work if it calls the non-leader. Not sure how we'd want to\nchange that one."}, "afterCommit": {"oid": "ea7dde2d292a730173857b302e8a0fb0b57f6500", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/ea7dde2d292a730173857b302e8a0fb0b57f6500", "committedDate": "2020-02-01T18:14:39Z", "message": "Start migrating AtlasDB to full conjure\n\nAt present, we see some performance issues with timelock internally.\nThese will take some debugging, but one component is that our\nrecommendation for high-performance servers internally is not to use\nJersey (especially not jersey async, with the extra gubbins we have) but\nis to use conjure-undertow.\n\nWe also view not using conjure defined APIs as AtlasDB tech debt.\n\nMigrating Atlas in one go to conjure undertow is difficult if not\nimpossible. But there are two endpoints which represent most calls -\ngetLeaderTime and startTransactions.\n\nThis PR:\n\n1. Adds a conjure API project (timelock-api) and defines a subset of the\nAtlasDB timelock API in it.\n2. Exposes this via the timelock service, with an Undertow and Jersey\nimplementation.\n3. Uses the client for these new endpoints on the client side, provided\na boolean flag is set.\n\nRight now, tests are a little fiddly because I'm coding on my home\nlaptop and they don't work at all there.\n\nPlaces which are still potentially a little off:\n1. Error handling logic in the Conjure undertow client is just\n_different_ to Jersey's. But I think I caught all the special error\nhandlers.\n2. We can't actually use this codepath until we can expose an internal\ntimelock dependency. So I've got a boolean flag that enables it\nconditionally so we can test the timelock server implementation.\n3. I think that the client might fall back to feign in some cases? And\nthis won't work if it calls the non-leader. Not sure how we'd want to\nchange that one."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42e8ea4194d90153deaa7e88460d85d355688ed2", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/42e8ea4194d90153deaa7e88460d85d355688ed2", "committedDate": "2020-02-01T14:51:49Z", "message": "Add generated changelog entries"}, "afterCommit": {"oid": "9c9852e2870bf3ff244f25cee66b7d7091ad9258", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/9c9852e2870bf3ff244f25cee66b7d7091ad9258", "committedDate": "2020-02-01T18:19:38Z", "message": "Start migrating AtlasDB to full conjure\n\nAt present, we see some performance issues with timelock internally.\nThese will take some debugging, but one component is that our\nrecommendation for high-performance servers internally is not to use\nJersey (especially not jersey async, with the extra gubbins we have) but\nis to use conjure-undertow.\n\nWe also view not using conjure defined APIs as AtlasDB tech debt.\n\nMigrating Atlas in one go to conjure undertow is difficult if not\nimpossible. But there are two endpoints which represent most calls -\ngetLeaderTime and startTransactions.\n\nThis PR:\n\n1. Adds a conjure API project (timelock-api) and defines a subset of the\nAtlasDB timelock API in it.\n2. Exposes this via the timelock service, with an Undertow and Jersey\nimplementation.\n3. Uses the client for these new endpoints on the client side, provided\na boolean flag is set.\n\nRight now, tests are a little fiddly because I'm coding on my home\nlaptop and they don't work at all there.\n\nPlaces which are still potentially a little off:\n1. Error handling logic in the Conjure undertow client is just\n_different_ to Jersey's. But I think I caught all the special error\nhandlers.\n2. We can't actually use this codepath until we can expose an internal\ntimelock dependency. So I've got a boolean flag that enables it\nconditionally so we can test the timelock server implementation.\n3. I think that the client might fall back to feign in some cases? And\nthis won't work if it calls the non-leader. Not sure how we'd want to\nchange that one."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c9852e2870bf3ff244f25cee66b7d7091ad9258", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/9c9852e2870bf3ff244f25cee66b7d7091ad9258", "committedDate": "2020-02-01T18:19:38Z", "message": "Start migrating AtlasDB to full conjure\n\nAt present, we see some performance issues with timelock internally.\nThese will take some debugging, but one component is that our\nrecommendation for high-performance servers internally is not to use\nJersey (especially not jersey async, with the extra gubbins we have) but\nis to use conjure-undertow.\n\nWe also view not using conjure defined APIs as AtlasDB tech debt.\n\nMigrating Atlas in one go to conjure undertow is difficult if not\nimpossible. But there are two endpoints which represent most calls -\ngetLeaderTime and startTransactions.\n\nThis PR:\n\n1. Adds a conjure API project (timelock-api) and defines a subset of the\nAtlasDB timelock API in it.\n2. Exposes this via the timelock service, with an Undertow and Jersey\nimplementation.\n3. Uses the client for these new endpoints on the client side, provided\na boolean flag is set.\n\nRight now, tests are a little fiddly because I'm coding on my home\nlaptop and they don't work at all there.\n\nPlaces which are still potentially a little off:\n1. Error handling logic in the Conjure undertow client is just\n_different_ to Jersey's. But I think I caught all the special error\nhandlers.\n2. We can't actually use this codepath until we can expose an internal\ntimelock dependency. So I've got a boolean flag that enables it\nconditionally so we can test the timelock server implementation.\n3. I think that the client might fall back to feign in some cases? And\nthis won't work if it calls the non-leader. Not sure how we'd want to\nchange that one."}, "afterCommit": {"oid": "ff2f5f332123c87239150dc83b510ce1ec5867d1", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/ff2f5f332123c87239150dc83b510ce1ec5867d1", "committedDate": "2020-02-01T18:22:01Z", "message": "Start migrating AtlasDB to full conjure\n\nAt present, we see some performance issues with timelock internally.\nThese will take some debugging, but one component is that our\nrecommendation for high-performance servers internally is not to use\nJersey (especially not jersey async, with the extra gubbins we have) but\nis to use conjure-undertow.\n\nWe also view not using conjure defined APIs as AtlasDB tech debt.\n\nMigrating Atlas in one go to conjure undertow is difficult if not\nimpossible. But there are two endpoints which represent most calls -\ngetLeaderTime and startTransactions.\n\nThis PR:\n\n1. Adds a conjure API project (timelock-api) and defines a subset of the\nAtlasDB timelock API in it.\n2. Exposes this via the timelock service, with an Undertow and Jersey\nimplementation.\n3. Uses the client for these new endpoints on the client side, provided\na boolean flag is set.\n\nRight now, tests are a little fiddly because I'm coding on my home\nlaptop and they don't work at all there.\n\nPlaces which are still potentially a little off:\n1. Error handling logic in the Conjure undertow client is just\n_different_ to Jersey's. But I think I caught all the special error\nhandlers.\n2. We can't actually use this codepath until we can expose an internal\ntimelock dependency. So I've got a boolean flag that enables it\nconditionally so we can test the timelock server implementation.\n3. I think that the client might fall back to feign in some cases? And\nthis won't work if it calls the non-leader. Not sure how we'd want to\nchange that one."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a049e39f25e0f769663006dec1f199a797dd382", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/3a049e39f25e0f769663006dec1f199a797dd382", "committedDate": "2020-02-01T18:23:41Z", "message": "Start migrating AtlasDB to full conjure\n\nAt present, we see some performance issues with timelock internally.\nThese will take some debugging, but one component is that our\nrecommendation for high-performance servers internally is not to use\nJersey (especially not jersey async, with the extra gubbins we have) but\nis to use conjure-undertow.\n\nWe also view not using conjure defined APIs as AtlasDB tech debt.\n\nMigrating Atlas in one go to conjure undertow is difficult if not\nimpossible. But there are two endpoints which represent most calls -\ngetLeaderTime and startTransactions.\n\nThis PR:\n\n1. Adds a conjure API project (timelock-api) and defines a subset of the\nAtlasDB timelock API in it.\n2. Exposes this via the timelock service, with an Undertow and Jersey\nimplementation.\n3. Uses the client for these new endpoints on the client side, provided\na boolean flag is set.\n\nRight now, tests are a little fiddly because I'm coding on my home\nlaptop and they don't work at all there.\n\nPlaces which are still potentially a little off:\n1. Error handling logic in the Conjure undertow client is just\n_different_ to Jersey's. But I think I caught all the special error\nhandlers.\n2. We can't actually use this codepath until we can expose an internal\ntimelock dependency. So I've got a boolean flag that enables it\nconditionally so we can test the timelock server implementation.\n3. I think that the client might fall back to feign in some cases? And\nthis won't work if it calls the non-leader. Not sure how we'd want to\nchange that one."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b76dd493cf266e096ce45c6b6c8b498304248738", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/b76dd493cf266e096ce45c6b6c8b498304248738", "committedDate": "2020-02-01T14:51:49Z", "message": "Add generated changelog entries"}, "afterCommit": {"oid": "3a049e39f25e0f769663006dec1f199a797dd382", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/3a049e39f25e0f769663006dec1f199a797dd382", "committedDate": "2020-02-01T18:23:41Z", "message": "Start migrating AtlasDB to full conjure\n\nAt present, we see some performance issues with timelock internally.\nThese will take some debugging, but one component is that our\nrecommendation for high-performance servers internally is not to use\nJersey (especially not jersey async, with the extra gubbins we have) but\nis to use conjure-undertow.\n\nWe also view not using conjure defined APIs as AtlasDB tech debt.\n\nMigrating Atlas in one go to conjure undertow is difficult if not\nimpossible. But there are two endpoints which represent most calls -\ngetLeaderTime and startTransactions.\n\nThis PR:\n\n1. Adds a conjure API project (timelock-api) and defines a subset of the\nAtlasDB timelock API in it.\n2. Exposes this via the timelock service, with an Undertow and Jersey\nimplementation.\n3. Uses the client for these new endpoints on the client side, provided\na boolean flag is set.\n\nRight now, tests are a little fiddly because I'm coding on my home\nlaptop and they don't work at all there.\n\nPlaces which are still potentially a little off:\n1. Error handling logic in the Conjure undertow client is just\n_different_ to Jersey's. But I think I caught all the special error\nhandlers.\n2. We can't actually use this codepath until we can expose an internal\ntimelock dependency. So I've got a boolean flag that enables it\nconditionally so we can test the timelock server implementation.\n3. I think that the client might fall back to feign in some cases? And\nthis won't work if it calls the non-leader. Not sure how we'd want to\nchange that one."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02d8a283f2ead8a40d50ea25dc0395c658a68e1a", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/02d8a283f2ead8a40d50ea25dc0395c658a68e1a", "committedDate": "2020-02-01T18:24:40Z", "message": "Delete redundant classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "344903e477bed325d0b0d29d928dc79a93768040", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/344903e477bed325d0b0d29d928dc79a93768040", "committedDate": "2020-02-01T18:28:50Z", "message": "Imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccd1b913333a8434c02be2bc0c9b99beca25292e", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/ccd1b913333a8434c02be2bc0c9b99beca25292e", "committedDate": "2020-02-01T18:29:35Z", "message": "Imorts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxODk3Njcw", "url": "https://github.com/palantir/atlasdb/pull/4545#pullrequestreview-351897670", "createdAt": "2020-02-01T18:31:42Z", "commit": {"oid": "ccd1b913333a8434c02be2bc0c9b99beca25292e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQxODozMTo0MlrOFkenfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wMVQxODozMTo0MlrOFkenfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzc5NDY4Nw==", "bodyText": "this test verifies that the code works in jersey... but we care more about undertow. Witchcraft is not open sourced so this test is hard to write. When we merge this, I'm going to write a similar test in our internal dist of timelock.", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r373794687", "createdAt": "2020-02-01T18:31:42Z", "author": {"login": "j-baker"}, "path": "timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java", "diffHunk": "@@ -78,6 +78,15 @@ public void nonLeadersReturn503() {\n         });\n     }\n \n+\n+    @Test\n+    public void nonLeadersReturn503_conjure() {\n+        cluster.nonLeaders(client.namespace()).forEach((namespace, server) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ccd1b913333a8434c02be2bc0c9b99beca25292e"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe1d8e488dcb65fbd6034a0a36880e55ef749d76", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/fe1d8e488dcb65fbd6034a0a36880e55ef749d76", "committedDate": "2020-02-01T18:34:16Z", "message": "Fix bug in jersey code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55c95fdf86c9c228e8e5687e10952ca813fdf5dd", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/55c95fdf86c9c228e8e5687e10952ca813fdf5dd", "committedDate": "2020-02-02T14:37:51Z", "message": "Fix compile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d23ea812d57ff37181a239e28f33ba7bbb9b0af", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/6d23ea812d57ff37181a239e28f33ba7bbb9b0af", "committedDate": "2020-02-02T14:48:22Z", "message": "Mock correctly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fb8f27347828102e6317ccdcae07220f7e0b3f3", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/3fb8f27347828102e6317ccdcae07220f7e0b3f3", "committedDate": "2020-02-02T14:48:22Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cbb29ea5e281516c35002adab2e219c8b96543c", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/1cbb29ea5e281516c35002adab2e219c8b96543c", "committedDate": "2020-02-02T15:01:46Z", "message": "Disable license checks for conjure generated code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92f988ec2486d047c40343a148bc9101b9fe7f2a", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/92f988ec2486d047c40343a148bc9101b9fe7f2a", "committedDate": "2020-02-02T15:02:07Z", "message": "Merge branch 'jbaker/conjure_undertow' of github.com:palantir/atlasdb into jbaker/conjure_undertow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b816d839f4c82918565a98cb89d1bdd01707dd3", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/3b816d839f4c82918565a98cb89d1bdd01707dd3", "committedDate": "2020-02-02T15:05:44Z", "message": "Make class public"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5204cc9b5d2940c8e7a9a9166c9c50c36b1ad3b1", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/5204cc9b5d2940c8e7a9a9166c9c50c36b1ad3b1", "committedDate": "2020-02-02T15:47:29Z", "message": "Don't let the TimelockResource own almost all strings.\n\nAs a consequence, 'tl' is no longer a valid name for an Atlas client.\nBut it's not a name at present."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8d422a520033b566549ac0e698b1753c9182bb4", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/d8d422a520033b566549ac0e698b1753c9182bb4", "committedDate": "2020-02-02T16:44:50Z", "message": "Move variable to end of line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MzMwOTg2", "url": "https://github.com/palantir/atlasdb/pull/4545#pullrequestreview-355330986", "createdAt": "2020-02-07T17:54:55Z", "commit": {"oid": "d8d422a520033b566549ac0e698b1753c9182bb4"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNzo1NDo1NVrOFnFPgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNzo0MjoyMVrOFnvXSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUyNDY3NA==", "bodyText": "Not familiar with broader Conjure usage of Java, but is this safe? Here we could get a value within the permitted bounds of Long but not in safelong. It might be the case that we don't care since anyone who deserialises this should be aware of nanotime", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r376524674", "createdAt": "2020-02-07T17:54:55Z", "author": {"login": "jeremyk-91"}, "path": "timelock-api/src/main/conjure/timelock-api.yml", "diffHunk": "@@ -0,0 +1,54 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    NanoTime:\n+      base-type: safelong", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d422a520033b566549ac0e698b1753c9182bb4"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUyNTEzMQ==", "bodyText": "Could we use more descriptive names please? I realise we can't reuse the existing names, and it's possible that adds some serialization overhead, but tl/lt/foo seems a little too terse for my taste.\nI guess we're not allowed to use any real namespace names for the first term, so that constrains us a bit.", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r376525131", "createdAt": "2020-02-07T17:56:03Z", "author": {"login": "jeremyk-91"}, "path": "timelock-api/src/main/conjure/timelock-api.yml", "diffHunk": "@@ -0,0 +1,54 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    NanoTime:\n+      base-type: safelong\n+      external:\n+        java: com.palantir.common.time.NanoTime\n+    PartitionedTimestamps:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.PartitionedTimestamps\n+    LockImmutableTimestampResponse:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LockImmutableTimestampResponse\n+    Lease:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.Lease\n+  definitions:\n+    default-package: com.palantir.atlasdb.timelock.api\n+    objects:\n+      ConjureStartTransactionsRequest:\n+        fields:\n+          requestId: uuid\n+          requestorId: uuid\n+          numTransactions: integer\n+      ConjureStartTransactionsResponse:\n+        fields:\n+          immutableTimestamp: LockImmutableTimestampResponse\n+          timestamps: PartitionedTimestamps\n+          lease: Lease\n+\n+services:\n+  ConjureTimelockService:\n+    name: Timelock service\n+    default-auth: header\n+    package: com.palantir.atlasdb.timelock.api\n+    base-path: /tl\n+    endpoints:\n+      startTransactions:\n+        http: POST /st/{namespace}\n+        args:\n+          namespace: string\n+          request: ConjureStartTransactionsRequest\n+        returns: ConjureStartTransactionsResponse\n+      leaderTime:\n+        http: POST /lt/{namespace}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d422a520033b566549ac0e698b1753c9182bb4"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk4Nzg0Mg==", "bodyText": "Sanity check that this is intentional?", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r376987842", "createdAt": "2020-02-10T10:47:03Z", "author": {"login": "jeremyk-91"}, "path": "build.gradle", "diffHunk": "@@ -33,12 +34,18 @@ plugins {\n     id 'com.google.protobuf' version '0.8.10'\n }\n \n-repositories {\n-    mavenCentral()\n-    maven {\n-        url 'https://dl.bintray.com/palantir/releases/'\n+allprojects {\n+    repositories {\n+        mavenCentral()\n+        maven {\n+            url 'http://dl.bintray.com/palantir/releases/'\n+        }\n+        maven {\n+            url 'https://dl.bintray.com/marshallpierce/maven/'\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d422a520033b566549ac0e698b1753c9182bb4"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Njk4ODM5Ng==", "bodyText": "awesome!", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r376988396", "createdAt": "2020-02-10T10:48:07Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/client/NamespacedConjureTimelockService.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client;\n+\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsRequest;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsResponse;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockService;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.tokens.auth.AuthHeader;\n+\n+public class NamespacedConjureTimelockService {\n+    private static final AuthHeader AUTH_HEADER = AuthHeader.valueOf(\"Bearer omitted\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d422a520033b566549ac0e698b1753c9182bb4"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzE5NzQ0NQ==", "bodyText": "I'm guessing the goal here is, in a separate PR, flip this to true and/or only maintain the true branch, while bumping the product dependency from 0.59.x to the version that has the needed timelock?", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377197445", "createdAt": "2020-02-10T17:10:01Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LockLeaseService.java", "diffHunk": "@@ -40,19 +42,31 @@\n import com.palantir.logsafe.Preconditions;\n \n class LockLeaseService {\n+    private static final boolean HAVE_ROLLED_OUT_CONJURE_CHANGES_INTERNALLY = false;\n     private final NamespacedTimelockRpcClient delegate;\n+    private final NamespacedConjureTimelockService conjureDelegate;\n     private final UUID clientId;\n     private final CoalescingSupplier<LeaderTime> time;\n \n     @VisibleForTesting\n-    LockLeaseService(NamespacedTimelockRpcClient timelockRpcClient, UUID clientId) {\n+    LockLeaseService(\n+            NamespacedTimelockRpcClient timelockRpcClient,\n+            NamespacedConjureTimelockService conjureDelegate,\n+            UUID clientId) {\n         this.delegate = timelockRpcClient;\n+        this.conjureDelegate = conjureDelegate;\n         this.clientId = clientId;\n-        this.time = new CoalescingSupplier<>(timelockRpcClient::getLeaderTime);\n+        if (HAVE_ROLLED_OUT_CONJURE_CHANGES_INTERNALLY) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d422a520033b566549ac0e698b1753c9182bb4"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIxNDc5NA==", "bodyText": "I validated that this behaviour is in line with the current state of the exception mappers in Jersey land. I guess the tests do enforce this parallelism to some extent.", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377214794", "createdAt": "2020-02-10T17:42:21Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/ConjureTimelockResource.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import java.time.Duration;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.FluentFuture;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import com.palantir.atlasdb.http.RedirectRetryTargeter;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsRequest;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsResponse;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockService;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockServiceEndpoints;\n+import com.palantir.atlasdb.timelock.api.UndertowConjureTimelockService;\n+import com.palantir.conjure.java.api.errors.QosException;\n+import com.palantir.conjure.java.undertow.lib.UndertowService;\n+import com.palantir.leader.NotCurrentLeaderException;\n+import com.palantir.lock.impl.TooManyRequestsException;\n+import com.palantir.lock.remoting.BlockingTimeoutException;\n+import com.palantir.lock.v2.ImmutableStartTransactionRequestV5;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.lock.v2.StartTransactionRequestV5;\n+import com.palantir.lock.v2.StartTransactionResponseV5;\n+import com.palantir.tokens.auth.AuthHeader;\n+\n+public final class ConjureTimelockResource implements UndertowConjureTimelockService {\n+    private final RedirectRetryTargeter redirectRetryTargeter;\n+    private final Function<String, AsyncTimelockService> timelockServices;\n+\n+    @VisibleForTesting\n+    ConjureTimelockResource(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        this.redirectRetryTargeter = redirectRetryTargeter;\n+        this.timelockServices = timelockServices;\n+    }\n+\n+    public static UndertowService undertow(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        return ConjureTimelockServiceEndpoints.of(new ConjureTimelockResource(redirectRetryTargeter, timelockServices));\n+    }\n+\n+    public static ConjureTimelockService jersey(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        return new JerseyAdapter(new ConjureTimelockResource(redirectRetryTargeter, timelockServices));\n+    }\n+\n+    @Override\n+    public ListenableFuture<ConjureStartTransactionsResponse> startTransactions(\n+            AuthHeader authHeader, String namespace, ConjureStartTransactionsRequest request) {\n+        return handleExceptions(() -> {\n+            StartTransactionRequestV5 legacyRequest = ImmutableStartTransactionRequestV5.builder()\n+                    .requestId(request.getRequestId())\n+                    .requestorId(request.getRequestorId())\n+                    .numTransactions(request.getNumTransactions())\n+                    .build();\n+            StartTransactionResponseV5 response = tl(namespace).startTransactionsWithWatches(legacyRequest);\n+            return ConjureStartTransactionsResponse.builder()\n+                    .immutableTimestamp(response.immutableTimestamp())\n+                    .timestamps(response.timestamps())\n+                    .lease(response.lease())\n+                    .build();\n+        });\n+    }\n+\n+    @Override\n+    public ListenableFuture<LeaderTime> leaderTime(AuthHeader authHeader, String namespace) {\n+        return handleExceptions(() -> tl(namespace).leaderTime());\n+    }\n+\n+    private AsyncTimelockService tl(String namespace) {\n+        return timelockServices.apply(namespace);\n+    }\n+\n+    private <T> ListenableFuture<T> handleExceptions(Supplier<T> supplier) {\n+        return handleExceptions(Futures.submitAsync(\n+                () -> Futures.immediateFuture(supplier.get()), MoreExecutors.directExecutor()));\n+    }\n+\n+    private <T> ListenableFuture<T> handleExceptions(ListenableFuture<T> future) {\n+        return FluentFuture.from(future)\n+                .catching(BlockingTimeoutException.class, timeout -> {\n+                    throw QosException.throttle(Duration.ZERO);\n+                }, MoreExecutors.directExecutor())\n+                .catching(NotCurrentLeaderException.class, notCurrentLeader -> {\n+                    throw redirectRetryTargeter.redirectRequest(notCurrentLeader.getServiceHint())\n+                            .<QosException>map(QosException::retryOther)\n+                            .orElseGet(QosException::unavailable);\n+                }, MoreExecutors.directExecutor())\n+                .catching(TooManyRequestsException.class, tooManyRequests -> {\n+                    throw QosException.throttle();\n+                }, MoreExecutors.directExecutor());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d422a520033b566549ac0e698b1753c9182bb4"}, "originalPosition": 115}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43cb257f8e8f140f5766b6c34b419089df9a384f", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/43cb257f8e8f140f5766b6c34b419089df9a384f", "committedDate": "2020-02-11T10:58:41Z", "message": "Remove repositories configuration from shared.gradle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/41eda4d4c00ab799a645c774860fe102cde6e69b", "committedDate": "2020-02-11T11:00:56Z", "message": "Merge branch 'develop' into jbaker/conjure_undertow"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NzIzODYy", "url": "https://github.com/palantir/atlasdb/pull/4545#pullrequestreview-356723862", "createdAt": "2020-02-11T14:56:48Z", "commit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "state": "COMMENTED", "comments": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDo1Njo0OFrOFoMJDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNjoxOToxM1rOFoPjCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4NjI4NA==", "bodyText": "So with the RemoteTimelockServiceAdapter operating as a TimelockService the idea was to separate out the RPC concerns from the \"logical\" concerns.\nWe have the same instance here but a level below.\nIt would be nice to not have to think about conjure concerns in this class and have a wrapper that can deal with the differences.", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377686284", "createdAt": "2020-02-11T14:56:48Z", "author": {"login": "felixdesouza"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LockLeaseService.java", "diffHunk": "@@ -65,8 +79,22 @@ LockImmutableTimestampResponse lockImmutableTimestamp() {\n     }\n \n     StartTransactionResponseV4 startTransactions(int batchSize) {\n-        StartTransactionRequestV4 request = StartTransactionRequestV4.createForRequestor(clientId, batchSize);\n-        StartTransactionResponseV4 response = delegate.startTransactions(request);\n+        final StartTransactionResponseV4 response;\n+        if (HAVE_ROLLED_OUT_CONJURE_CHANGES_INTERNALLY) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4NzA5Mw==", "bodyText": "Curious, what benefit do we get out of defining a conjure start transcation request object? Aren't they going to be just as big on the wire?", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377687093", "createdAt": "2020-02-11T14:57:59Z", "author": {"login": "felixdesouza"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LockLeaseService.java", "diffHunk": "@@ -65,8 +79,22 @@ LockImmutableTimestampResponse lockImmutableTimestamp() {\n     }\n \n     StartTransactionResponseV4 startTransactions(int batchSize) {\n-        StartTransactionRequestV4 request = StartTransactionRequestV4.createForRequestor(clientId, batchSize);\n-        StartTransactionResponseV4 response = delegate.startTransactions(request);\n+        final StartTransactionResponseV4 response;\n+        if (HAVE_ROLLED_OUT_CONJURE_CHANGES_INTERNALLY) {\n+            ConjureStartTransactionsRequest request = ConjureStartTransactionsRequest.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4NzQ4Mg==", "bodyText": "i.e. isn't it possible to just refer to the non-conjure start transaction request/response inside the conjure definition?", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377687482", "createdAt": "2020-02-11T14:58:28Z", "author": {"login": "felixdesouza"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LockLeaseService.java", "diffHunk": "@@ -65,8 +79,22 @@ LockImmutableTimestampResponse lockImmutableTimestamp() {\n     }\n \n     StartTransactionResponseV4 startTransactions(int batchSize) {\n-        StartTransactionRequestV4 request = StartTransactionRequestV4.createForRequestor(clientId, batchSize);\n-        StartTransactionResponseV4 response = delegate.startTransactions(request);\n+        final StartTransactionResponseV4 response;\n+        if (HAVE_ROLLED_OUT_CONJURE_CHANGES_INTERNALLY) {\n+            ConjureStartTransactionsRequest request = ConjureStartTransactionsRequest.builder()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4NzA5Mw=="}, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4ODk3OQ==", "bodyText": "based on the above comment, if this implemented a RpcBridge interface or something aptly named, then we can have the return types be in terms of generic \"atlas\" rpc objects, and declutter the usages", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377688979", "createdAt": "2020-02-11T15:00:44Z", "author": {"login": "felixdesouza"}, "path": "lock-api/src/main/java/com/palantir/lock/client/NamespacedConjureTimelockService.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client;\n+\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsRequest;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsResponse;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockService;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.tokens.auth.AuthHeader;\n+\n+public class NamespacedConjureTimelockService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4OTY3NA==", "bodyText": "it also lends itself quite easily to doing the experimental proxy suggestion I made earlier.", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377689674", "createdAt": "2020-02-11T15:01:46Z", "author": {"login": "felixdesouza"}, "path": "lock-api/src/main/java/com/palantir/lock/client/NamespacedConjureTimelockService.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client;\n+\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsRequest;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsResponse;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockService;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.tokens.auth.AuthHeader;\n+\n+public class NamespacedConjureTimelockService {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4ODk3OQ=="}, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY5NTYzNw==", "bodyText": "is there a better way of clearly delineating between the two? i.e. timelockResource and timelockService and why you'd want to pick one over the other?", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377695637", "createdAt": "2020-02-11T15:10:53Z", "author": {"login": "felixdesouza"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/TimeLockServices.java", "diffHunk": "@@ -27,21 +27,24 @@\n     static TimeLockServices create(\n             TimestampService timestampService,\n             LockService lockService,\n-            AsyncTimelockResource timelockService,\n+            AsyncTimelockService timelockService,\n+            AsyncTimelockResource timelockResource,\n             LockWatchingResource lockWatchingResource,\n             TimestampManagementService timestampManagementService) {\n         return ImmutableTimeLockServices.builder()\n                 .timestampService(timestampService)\n                 .lockService(lockService)\n                 .timestampManagementService(timestampManagementService)\n                 .timelockService(timelockService)\n+                .timelockResource(timelockResource)\n                 .lockWatchingResource(lockWatchingResource)\n                 .build();\n     }\n \n     TimestampService getTimestampService();\n     LockService getLockService();\n-    AsyncTimelockResource getTimelockService();\n+    AsyncTimelockResource getTimelockResource();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxMTQ1Nw==", "bodyText": "since this is code and not routing, we should name it properly", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377711457", "createdAt": "2020-02-11T15:33:39Z", "author": {"login": "felixdesouza"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/ConjureTimelockResource.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import java.time.Duration;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.FluentFuture;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import com.palantir.atlasdb.http.RedirectRetryTargeter;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsRequest;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsResponse;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockService;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockServiceEndpoints;\n+import com.palantir.atlasdb.timelock.api.UndertowConjureTimelockService;\n+import com.palantir.conjure.java.api.errors.QosException;\n+import com.palantir.conjure.java.undertow.lib.UndertowService;\n+import com.palantir.leader.NotCurrentLeaderException;\n+import com.palantir.lock.impl.TooManyRequestsException;\n+import com.palantir.lock.remoting.BlockingTimeoutException;\n+import com.palantir.lock.v2.ImmutableStartTransactionRequestV5;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.lock.v2.StartTransactionRequestV5;\n+import com.palantir.lock.v2.StartTransactionResponseV5;\n+import com.palantir.tokens.auth.AuthHeader;\n+\n+public final class ConjureTimelockResource implements UndertowConjureTimelockService {\n+    private final RedirectRetryTargeter redirectRetryTargeter;\n+    private final Function<String, AsyncTimelockService> timelockServices;\n+\n+    @VisibleForTesting\n+    ConjureTimelockResource(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        this.redirectRetryTargeter = redirectRetryTargeter;\n+        this.timelockServices = timelockServices;\n+    }\n+\n+    public static UndertowService undertow(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        return ConjureTimelockServiceEndpoints.of(new ConjureTimelockResource(redirectRetryTargeter, timelockServices));\n+    }\n+\n+    public static ConjureTimelockService jersey(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        return new JerseyAdapter(new ConjureTimelockResource(redirectRetryTargeter, timelockServices));\n+    }\n+\n+    @Override\n+    public ListenableFuture<ConjureStartTransactionsResponse> startTransactions(\n+            AuthHeader authHeader, String namespace, ConjureStartTransactionsRequest request) {\n+        return handleExceptions(() -> {\n+            StartTransactionRequestV5 legacyRequest = ImmutableStartTransactionRequestV5.builder()\n+                    .requestId(request.getRequestId())\n+                    .requestorId(request.getRequestorId())\n+                    .numTransactions(request.getNumTransactions())\n+                    .build();\n+            StartTransactionResponseV5 response = tl(namespace).startTransactionsWithWatches(legacyRequest);\n+            return ConjureStartTransactionsResponse.builder()\n+                    .immutableTimestamp(response.immutableTimestamp())\n+                    .timestamps(response.timestamps())\n+                    .lease(response.lease())\n+                    .build();\n+        });\n+    }\n+\n+    @Override\n+    public ListenableFuture<LeaderTime> leaderTime(AuthHeader authHeader, String namespace) {\n+        return handleExceptions(() -> tl(namespace).leaderTime());\n+    }\n+\n+    private AsyncTimelockService tl(String namespace) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxNzIyOQ==", "bodyText": "whilst this works it feels tacked on, and adds quite a bit of indirection complexity that I believe can be avoided.\nInside TimelockResource we have a map of the same signature and the same function thing.\nInstead of us passing functions everywhere, can we just create a class that deals with all of that similar to how LocalPaxosComponents does it? Then we just pass that around and we're good to go.", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377717229", "createdAt": "2020-02-11T15:42:10Z", "author": {"login": "felixdesouza"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java", "diffHunk": "@@ -159,16 +170,29 @@ private void createAndRegisterResources() {\n         registerPaxosResource();\n         registerExceptionMappers();\n \n+        Map<String, TimeLockServices> services = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcxODY5MQ==", "bodyText": "not sure how the generation works server side, but can we keep to our internal naming convention of calling it an *RpcClient?", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377718691", "createdAt": "2020-02-11T15:44:12Z", "author": {"login": "felixdesouza"}, "path": "timelock-api/src/main/conjure/timelock-api.yml", "diffHunk": "@@ -0,0 +1,54 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    NanoTime:\n+      base-type: safelong\n+      external:\n+        java: com.palantir.common.time.NanoTime\n+    PartitionedTimestamps:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.PartitionedTimestamps\n+    LockImmutableTimestampResponse:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LockImmutableTimestampResponse\n+    Lease:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.Lease\n+  definitions:\n+    default-package: com.palantir.atlasdb.timelock.api\n+    objects:\n+      ConjureStartTransactionsRequest:\n+        fields:\n+          requestId: uuid\n+          requestorId: uuid\n+          numTransactions: integer\n+      ConjureStartTransactionsResponse:\n+        fields:\n+          immutableTimestamp: LockImmutableTimestampResponse\n+          timestamps: PartitionedTimestamps\n+          lease: Lease\n+\n+services:\n+  ConjureTimelockService:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyMTQ2MQ==", "bodyText": "not sure if conjure supports this, but can this argument not also be extended to objects? i.e. having human readable method names for code, but wire is just some short form. I'm pretty sure Jackson supports aliases, so you can still add the long form version if you so pleased.\nin a sense the names aren't important, you just need a long running identifier for each of the fields like what we do with PaxosPersistence - although that's only to file - dictionary encoding and what not.\nOut of curiosity, did we ever consider trying CBOR? Does Conjure support outputting CBOR?", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377721461", "createdAt": "2020-02-11T15:48:20Z", "author": {"login": "felixdesouza"}, "path": "timelock-api/src/main/conjure/timelock-api.yml", "diffHunk": "@@ -0,0 +1,54 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    NanoTime:\n+      base-type: safelong\n+      external:\n+        java: com.palantir.common.time.NanoTime\n+    PartitionedTimestamps:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.PartitionedTimestamps\n+    LockImmutableTimestampResponse:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LockImmutableTimestampResponse\n+    Lease:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.Lease\n+  definitions:\n+    default-package: com.palantir.atlasdb.timelock.api\n+    objects:\n+      ConjureStartTransactionsRequest:\n+        fields:\n+          requestId: uuid\n+          requestorId: uuid\n+          numTransactions: integer\n+      ConjureStartTransactionsResponse:\n+        fields:\n+          immutableTimestamp: LockImmutableTimestampResponse\n+          timestamps: PartitionedTimestamps\n+          lease: Lease\n+\n+services:\n+  ConjureTimelockService:\n+    name: Timelock service\n+    default-auth: header\n+    package: com.palantir.atlasdb.timelock.api\n+    base-path: /tl\n+    endpoints:\n+      startTransactions:\n+        http: POST /st/{namespace}\n+        args:\n+          namespace: string\n+          request: ConjureStartTransactionsRequest\n+        returns: ConjureStartTransactionsResponse\n+      leaderTime:\n+        http: POST /lt/{namespace}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUyNTEzMQ=="}, "originalCommit": {"oid": "d8d422a520033b566549ac0e698b1753c9182bb4"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyNDcxNw==", "bodyText": "Took me a minute, but I think it would be useful to have a doc/comment explaining that this is there so that even if the server does not support undertow, it still responds to routes that were purposefully defined for conjure & undertow.", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377724717", "createdAt": "2020-02-11T15:53:20Z", "author": {"login": "felixdesouza"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/ConjureTimelockResource.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import java.time.Duration;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.FluentFuture;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import com.palantir.atlasdb.http.RedirectRetryTargeter;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsRequest;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsResponse;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockService;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockServiceEndpoints;\n+import com.palantir.atlasdb.timelock.api.UndertowConjureTimelockService;\n+import com.palantir.conjure.java.api.errors.QosException;\n+import com.palantir.conjure.java.undertow.lib.UndertowService;\n+import com.palantir.leader.NotCurrentLeaderException;\n+import com.palantir.lock.impl.TooManyRequestsException;\n+import com.palantir.lock.remoting.BlockingTimeoutException;\n+import com.palantir.lock.v2.ImmutableStartTransactionRequestV5;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.lock.v2.StartTransactionRequestV5;\n+import com.palantir.lock.v2.StartTransactionResponseV5;\n+import com.palantir.tokens.auth.AuthHeader;\n+\n+public final class ConjureTimelockResource implements UndertowConjureTimelockService {\n+    private final RedirectRetryTargeter redirectRetryTargeter;\n+    private final Function<String, AsyncTimelockService> timelockServices;\n+\n+    @VisibleForTesting\n+    ConjureTimelockResource(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        this.redirectRetryTargeter = redirectRetryTargeter;\n+        this.timelockServices = timelockServices;\n+    }\n+\n+    public static UndertowService undertow(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        return ConjureTimelockServiceEndpoints.of(new ConjureTimelockResource(redirectRetryTargeter, timelockServices));\n+    }\n+\n+    public static ConjureTimelockService jersey(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzcyNjM1Nw==", "bodyText": "so if I've understood correctly, for only the endpoints defined in conjure, regardless of whether they are in jersey or undertow, they will use this codepath for exception handling?\nespecially for jersey, it will never invoke the exception mappers for the below exceptions?", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377726357", "createdAt": "2020-02-11T15:55:40Z", "author": {"login": "felixdesouza"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/ConjureTimelockResource.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import java.time.Duration;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.FluentFuture;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import com.palantir.atlasdb.http.RedirectRetryTargeter;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsRequest;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsResponse;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockService;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockServiceEndpoints;\n+import com.palantir.atlasdb.timelock.api.UndertowConjureTimelockService;\n+import com.palantir.conjure.java.api.errors.QosException;\n+import com.palantir.conjure.java.undertow.lib.UndertowService;\n+import com.palantir.leader.NotCurrentLeaderException;\n+import com.palantir.lock.impl.TooManyRequestsException;\n+import com.palantir.lock.remoting.BlockingTimeoutException;\n+import com.palantir.lock.v2.ImmutableStartTransactionRequestV5;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.lock.v2.StartTransactionRequestV5;\n+import com.palantir.lock.v2.StartTransactionResponseV5;\n+import com.palantir.tokens.auth.AuthHeader;\n+\n+public final class ConjureTimelockResource implements UndertowConjureTimelockService {\n+    private final RedirectRetryTargeter redirectRetryTargeter;\n+    private final Function<String, AsyncTimelockService> timelockServices;\n+\n+    @VisibleForTesting\n+    ConjureTimelockResource(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        this.redirectRetryTargeter = redirectRetryTargeter;\n+        this.timelockServices = timelockServices;\n+    }\n+\n+    public static UndertowService undertow(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        return ConjureTimelockServiceEndpoints.of(new ConjureTimelockResource(redirectRetryTargeter, timelockServices));\n+    }\n+\n+    public static ConjureTimelockService jersey(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        return new JerseyAdapter(new ConjureTimelockResource(redirectRetryTargeter, timelockServices));\n+    }\n+\n+    @Override\n+    public ListenableFuture<ConjureStartTransactionsResponse> startTransactions(\n+            AuthHeader authHeader, String namespace, ConjureStartTransactionsRequest request) {\n+        return handleExceptions(() -> {\n+            StartTransactionRequestV5 legacyRequest = ImmutableStartTransactionRequestV5.builder()\n+                    .requestId(request.getRequestId())\n+                    .requestorId(request.getRequestorId())\n+                    .numTransactions(request.getNumTransactions())\n+                    .build();\n+            StartTransactionResponseV5 response = tl(namespace).startTransactionsWithWatches(legacyRequest);\n+            return ConjureStartTransactionsResponse.builder()\n+                    .immutableTimestamp(response.immutableTimestamp())\n+                    .timestamps(response.timestamps())\n+                    .lease(response.lease())\n+                    .build();\n+        });\n+    }\n+\n+    @Override\n+    public ListenableFuture<LeaderTime> leaderTime(AuthHeader authHeader, String namespace) {\n+        return handleExceptions(() -> tl(namespace).leaderTime());\n+    }\n+\n+    private AsyncTimelockService tl(String namespace) {\n+        return timelockServices.apply(namespace);\n+    }\n+\n+    private <T> ListenableFuture<T> handleExceptions(Supplier<T> supplier) {\n+        return handleExceptions(Futures.submitAsync(\n+                () -> Futures.immediateFuture(supplier.get()), MoreExecutors.directExecutor()));\n+    }\n+\n+    private <T> ListenableFuture<T> handleExceptions(ListenableFuture<T> future) {\n+        return FluentFuture.from(future)\n+                .catching(BlockingTimeoutException.class, timeout -> {\n+                    throw QosException.throttle(Duration.ZERO);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczMDQ4NQ==", "bodyText": "let's have the Supplier<T> be a Callable<T> which is a bit more accurate.", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377730485", "createdAt": "2020-02-11T16:01:21Z", "author": {"login": "felixdesouza"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/ConjureTimelockResource.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import java.time.Duration;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.FluentFuture;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import com.palantir.atlasdb.http.RedirectRetryTargeter;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsRequest;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsResponse;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockService;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockServiceEndpoints;\n+import com.palantir.atlasdb.timelock.api.UndertowConjureTimelockService;\n+import com.palantir.conjure.java.api.errors.QosException;\n+import com.palantir.conjure.java.undertow.lib.UndertowService;\n+import com.palantir.leader.NotCurrentLeaderException;\n+import com.palantir.lock.impl.TooManyRequestsException;\n+import com.palantir.lock.remoting.BlockingTimeoutException;\n+import com.palantir.lock.v2.ImmutableStartTransactionRequestV5;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.lock.v2.StartTransactionRequestV5;\n+import com.palantir.lock.v2.StartTransactionResponseV5;\n+import com.palantir.tokens.auth.AuthHeader;\n+\n+public final class ConjureTimelockResource implements UndertowConjureTimelockService {\n+    private final RedirectRetryTargeter redirectRetryTargeter;\n+    private final Function<String, AsyncTimelockService> timelockServices;\n+\n+    @VisibleForTesting\n+    ConjureTimelockResource(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        this.redirectRetryTargeter = redirectRetryTargeter;\n+        this.timelockServices = timelockServices;\n+    }\n+\n+    public static UndertowService undertow(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        return ConjureTimelockServiceEndpoints.of(new ConjureTimelockResource(redirectRetryTargeter, timelockServices));\n+    }\n+\n+    public static ConjureTimelockService jersey(\n+            RedirectRetryTargeter redirectRetryTargeter,\n+            Function<String, AsyncTimelockService> timelockServices) {\n+        return new JerseyAdapter(new ConjureTimelockResource(redirectRetryTargeter, timelockServices));\n+    }\n+\n+    @Override\n+    public ListenableFuture<ConjureStartTransactionsResponse> startTransactions(\n+            AuthHeader authHeader, String namespace, ConjureStartTransactionsRequest request) {\n+        return handleExceptions(() -> {\n+            StartTransactionRequestV5 legacyRequest = ImmutableStartTransactionRequestV5.builder()\n+                    .requestId(request.getRequestId())\n+                    .requestorId(request.getRequestorId())\n+                    .numTransactions(request.getNumTransactions())\n+                    .build();\n+            StartTransactionResponseV5 response = tl(namespace).startTransactionsWithWatches(legacyRequest);\n+            return ConjureStartTransactionsResponse.builder()\n+                    .immutableTimestamp(response.immutableTimestamp())\n+                    .timestamps(response.timestamps())\n+                    .lease(response.lease())\n+                    .build();\n+        });\n+    }\n+\n+    @Override\n+    public ListenableFuture<LeaderTime> leaderTime(AuthHeader authHeader, String namespace) {\n+        return handleExceptions(() -> tl(namespace).leaderTime());\n+    }\n+\n+    private AsyncTimelockService tl(String namespace) {\n+        return timelockServices.apply(namespace);\n+    }\n+\n+    private <T> ListenableFuture<T> handleExceptions(Supplier<T> supplier) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczMTQ3OA==", "bodyText": "similar vein as comment below: comment re this class represents a new set of endpoints that are defined via conjure.", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377731478", "createdAt": "2020-02-11T16:02:50Z", "author": {"login": "felixdesouza"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/ConjureTimelockResource.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import java.time.Duration;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Throwables;\n+import com.google.common.util.concurrent.FluentFuture;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import com.palantir.atlasdb.http.RedirectRetryTargeter;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsRequest;\n+import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsResponse;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockService;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockServiceEndpoints;\n+import com.palantir.atlasdb.timelock.api.UndertowConjureTimelockService;\n+import com.palantir.conjure.java.api.errors.QosException;\n+import com.palantir.conjure.java.undertow.lib.UndertowService;\n+import com.palantir.leader.NotCurrentLeaderException;\n+import com.palantir.lock.impl.TooManyRequestsException;\n+import com.palantir.lock.remoting.BlockingTimeoutException;\n+import com.palantir.lock.v2.ImmutableStartTransactionRequestV5;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.lock.v2.StartTransactionRequestV5;\n+import com.palantir.lock.v2.StartTransactionResponseV5;\n+import com.palantir.tokens.auth.AuthHeader;\n+\n+public final class ConjureTimelockResource implements UndertowConjureTimelockService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczNjI0Nw==", "bodyText": "this refuses to match against /tl? not sure how hard it would be to ensure that we never hit this path accidentally, since it's an integration test\nI imagine we want to roll out undertow across more endpoints, what if all conjure endpoints started off with ~c? Or some starting symbol that won't match against this similar to how there is .internal for the paxos stuff? Then we don't have to change this line.", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377736247", "createdAt": "2020-02-11T16:10:17Z", "author": {"login": "felixdesouza"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/TimeLockResource.java", "diffHunk": "@@ -41,7 +41,7 @@\n import com.palantir.timestamp.TimestampManagementService;\n import com.palantir.timestamp.TimestampService;\n \n-@Path(\"/{namespace: [a-zA-Z0-9_-]+}\")\n+@Path(\"/{namespace: (?!tl)[a-zA-Z0-9_-]+}\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczOTgyMA==", "bodyText": "resource.leaderTime will never throw BlockingTimeoutException right? It will always give you back a failed ListenableFuture if I've read correctly", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377739820", "createdAt": "2020-02-11T16:15:46Z", "author": {"login": "felixdesouza"}, "path": "timelock-impl/src/test/java/com/palantir/atlasdb/timelock/ConjureTimelockResourceTest.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.Assert.fail;\n+import static org.mockito.Mockito.when;\n+\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.time.Duration;\n+import java.util.concurrent.ExecutionException;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.net.HostAndPort;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import com.palantir.atlasdb.http.RedirectRetryTargeter;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockService;\n+import com.palantir.conjure.java.api.errors.QosException;\n+import com.palantir.leader.NotCurrentLeaderException;\n+import com.palantir.lock.impl.TooManyRequestsException;\n+import com.palantir.lock.remoting.BlockingTimeoutException;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.tokens.auth.AuthHeader;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class ConjureTimelockResourceTest {\n+    private static final AuthHeader AUTH_HEADER = AuthHeader.valueOf(\"Bearer test\");\n+    private static final int REMOTE_PORT = 4321;\n+    private static final URL LOCAL = url(\"https://localhost:1234\");\n+    private static final URL REMOTE = url(\"https://localhost:\" + REMOTE_PORT);\n+    private static final RedirectRetryTargeter TARGETER = RedirectRetryTargeter.create(\n+            LOCAL,\n+            ImmutableList.of(LOCAL, REMOTE));\n+\n+    private static final String NAMESPACE = \"test\";\n+\n+    @Mock private AsyncTimelockService timelockService;\n+    @Mock private LeaderTime leaderTime;\n+\n+    private ConjureTimelockResource resource;\n+    private ConjureTimelockService service;\n+\n+    @Before\n+    public void before() {\n+        resource = new ConjureTimelockResource(TARGETER, unused -> timelockService);\n+        service = ConjureTimelockResource.jersey(TARGETER, unused -> timelockService);\n+        when(timelockService.leaderTime()).thenReturn(leaderTime);\n+    }\n+\n+    @Test\n+    public void canGetLeaderTime() {\n+        assertThat(Futures.getUnchecked(resource.leaderTime(AUTH_HEADER, NAMESPACE))).isEqualTo(leaderTime);\n+    }\n+\n+    @Test\n+    public void jerseyPropagatesExceptions() {\n+        when(resource.leaderTime(AUTH_HEADER, NAMESPACE)).thenThrow(new BlockingTimeoutException(\"\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0MjA4OQ==", "bodyText": "unless there's a generated form that's calling .get on it, then fine, but still feels a bit weird", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r377742089", "createdAt": "2020-02-11T16:19:13Z", "author": {"login": "felixdesouza"}, "path": "timelock-impl/src/test/java/com/palantir/atlasdb/timelock/ConjureTimelockResourceTest.java", "diffHunk": "@@ -0,0 +1,170 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.Assert.fail;\n+import static org.mockito.Mockito.when;\n+\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.time.Duration;\n+import java.util.concurrent.ExecutionException;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.MockitoJUnitRunner;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.net.HostAndPort;\n+import com.google.common.util.concurrent.Futures;\n+import com.google.common.util.concurrent.ListenableFuture;\n+import com.google.common.util.concurrent.MoreExecutors;\n+import com.palantir.atlasdb.http.RedirectRetryTargeter;\n+import com.palantir.atlasdb.timelock.api.ConjureTimelockService;\n+import com.palantir.conjure.java.api.errors.QosException;\n+import com.palantir.leader.NotCurrentLeaderException;\n+import com.palantir.lock.impl.TooManyRequestsException;\n+import com.palantir.lock.remoting.BlockingTimeoutException;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.tokens.auth.AuthHeader;\n+\n+@RunWith(MockitoJUnitRunner.class)\n+public class ConjureTimelockResourceTest {\n+    private static final AuthHeader AUTH_HEADER = AuthHeader.valueOf(\"Bearer test\");\n+    private static final int REMOTE_PORT = 4321;\n+    private static final URL LOCAL = url(\"https://localhost:1234\");\n+    private static final URL REMOTE = url(\"https://localhost:\" + REMOTE_PORT);\n+    private static final RedirectRetryTargeter TARGETER = RedirectRetryTargeter.create(\n+            LOCAL,\n+            ImmutableList.of(LOCAL, REMOTE));\n+\n+    private static final String NAMESPACE = \"test\";\n+\n+    @Mock private AsyncTimelockService timelockService;\n+    @Mock private LeaderTime leaderTime;\n+\n+    private ConjureTimelockResource resource;\n+    private ConjureTimelockService service;\n+\n+    @Before\n+    public void before() {\n+        resource = new ConjureTimelockResource(TARGETER, unused -> timelockService);\n+        service = ConjureTimelockResource.jersey(TARGETER, unused -> timelockService);\n+        when(timelockService.leaderTime()).thenReturn(leaderTime);\n+    }\n+\n+    @Test\n+    public void canGetLeaderTime() {\n+        assertThat(Futures.getUnchecked(resource.leaderTime(AUTH_HEADER, NAMESPACE))).isEqualTo(leaderTime);\n+    }\n+\n+    @Test\n+    public void jerseyPropagatesExceptions() {\n+        when(resource.leaderTime(AUTH_HEADER, NAMESPACE)).thenThrow(new BlockingTimeoutException(\"\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczOTgyMA=="}, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDUyNTQ0", "url": "https://github.com/palantir/atlasdb/pull/4545#pullrequestreview-358052544", "createdAt": "2020-02-13T09:08:55Z", "commit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTowODo1NVrOFpL6DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOTowODo1NVrOFpL6DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODczMTAyMQ==", "bodyText": "is this for some kinda rate limiting?", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r378731021", "createdAt": "2020-02-13T09:08:55Z", "author": {"login": "jkozlowski"}, "path": "timelock-api/src/main/conjure/timelock-api.yml", "diffHunk": "@@ -0,0 +1,54 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    NanoTime:\n+      base-type: safelong\n+      external:\n+        java: com.palantir.common.time.NanoTime\n+    PartitionedTimestamps:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.PartitionedTimestamps\n+    LockImmutableTimestampResponse:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LockImmutableTimestampResponse\n+    Lease:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.Lease\n+  definitions:\n+    default-package: com.palantir.atlasdb.timelock.api\n+    objects:\n+      ConjureStartTransactionsRequest:\n+        fields:\n+          requestId: uuid\n+          requestorId: uuid", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDUzNTkx", "url": "https://github.com/palantir/atlasdb/pull/4545#pullrequestreview-358053591", "createdAt": "2020-02-13T09:10:31Z", "commit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOToxMDozMVrOFpL9VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwOToxMDozMVrOFpL9VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODczMTg2MQ==", "bodyText": "@gmaretic how easily can we retrofit lock watch pieces here? Can we do it afterwards without adding startTransactionsV2?", "url": "https://github.com/palantir/atlasdb/pull/4545#discussion_r378731861", "createdAt": "2020-02-13T09:10:31Z", "author": {"login": "jkozlowski"}, "path": "timelock-api/src/main/conjure/timelock-api.yml", "diffHunk": "@@ -0,0 +1,54 @@\n+types:\n+  imports:\n+    LeaderTime:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LeaderTime\n+    NanoTime:\n+      base-type: safelong\n+      external:\n+        java: com.palantir.common.time.NanoTime\n+    PartitionedTimestamps:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.PartitionedTimestamps\n+    LockImmutableTimestampResponse:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.LockImmutableTimestampResponse\n+    Lease:\n+      base-type: any\n+      external:\n+        java: com.palantir.lock.v2.Lease\n+  definitions:\n+    default-package: com.palantir.atlasdb.timelock.api\n+    objects:\n+      ConjureStartTransactionsRequest:\n+        fields:\n+          requestId: uuid\n+          requestorId: uuid\n+          numTransactions: integer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41eda4d4c00ab799a645c774860fe102cde6e69b"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d5a85fd6a4fd9e280746ce2cd75bc8b91830df2", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/1d5a85fd6a4fd9e280746ce2cd75bc8b91830df2", "committedDate": "2020-02-18T15:22:01Z", "message": "PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbfd327de0bf649e566d30fff86f22e265f627dd", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/dbfd327de0bf649e566d30fff86f22e265f627dd", "committedDate": "2020-02-18T17:23:32Z", "message": "factor out timelocknamespaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "520c89c26b864ff422dfd50256d4c5b476eaeb8f", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/520c89c26b864ff422dfd50256d4c5b476eaeb8f", "committedDate": "2020-02-18T17:26:13Z", "message": "Merge branch 'develop' into jbaker/conjure_undertow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eba5cb3915632e6fc88a820982b605cdb689d87f", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/eba5cb3915632e6fc88a820982b605cdb689d87f", "committedDate": "2020-02-18T17:38:52Z", "message": "Dollar sign did not help"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5e37ea6daa24847dfab17b7a8df6b2a51e1d6df", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/f5e37ea6daa24847dfab17b7a8df6b2a51e1d6df", "committedDate": "2020-02-18T17:42:14Z", "message": "Revert bogus change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe2f998e08230eeb67deb439f95305229970e0ce", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/fe2f998e08230eeb67deb439f95305229970e0ce", "committedDate": "2020-02-18T17:43:30Z", "message": "test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNTQzMzEx", "url": "https://github.com/palantir/atlasdb/pull/4545#pullrequestreview-360543311", "createdAt": "2020-02-18T17:45:30Z", "commit": {"oid": "fe2f998e08230eeb67deb439f95305229970e0ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c907ba2f2e003aafd20d15e5795182824e0876da", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/c907ba2f2e003aafd20d15e5795182824e0876da", "committedDate": "2020-02-18T18:10:57Z", "message": "Fixes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2227, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}