{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NDkwNzE2", "number": 4988, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNDo0Mjo1MFrOElsZ6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNDo0MzowNFrOElsaUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3OTYwMjk2OnYy", "diffSide": "RIGHT", "path": "atlasdb-dbkvs-hikari/src/test/java/com/palantir/nexus/db/pool/config/OracleConnectionConfigTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNDo0Mjo1MFrOHVTm1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNDo0Mjo1MFrOHVTm1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEwMzM4MQ==", "bodyText": "thanks for the detailed tests!", "url": "https://github.com/palantir/atlasdb/pull/4988#discussion_r492103381", "createdAt": "2020-09-21T14:42:50Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-dbkvs-hikari/src/test/java/com/palantir/nexus/db/pool/config/OracleConnectionConfigTest.java", "diffHunk": "@@ -85,6 +90,71 @@ public void namespaceIsNamespaceOverrideIfServiceNameConfigurationSpecified() {\n         assertThat(connectionConfig.namespace()).contains(SERVICE_NAME_CONFIGURATION.namespaceOverride());\n     }\n \n+    @Test\n+    public void settingKeyAndTrustStoresAllowedWithoutTcps() {\n+        OracleConnectionConfig connectionConfig = getBaseBuilder()\n+                .sid(SID)\n+                .truststorePath(\"truststore.jks\")\n+                .truststorePassword(\"password\")\n+                .keystorePath(\"keystore.jks\")\n+                .keystorePassword(\"password\")\n+                .build();\n+        assertThat(connectionConfig.getProtocol())\n+                .isEqualTo(ConnectionProtocol.TCP);\n+        assertThat(connectionConfig.getTruststorePath())\n+                .isEqualTo(Optional.of(\"truststore.jks\"));\n+        assertThat(connectionConfig.getKeystorePath())\n+                .isEqualTo(Optional.of(\"keystore.jks\"));\n+        assertThat(connectionConfig.getTruststorePassword())\n+                .isEqualTo(Optional.of(\"password\"));\n+        assertThat(connectionConfig.getKeystorePassword())\n+                .isEqualTo(Optional.of(\"password\"));\n+\n+        // note that even though keystore/truststore are set, none of the javax.net.ssl. properties will be set\n+        // since the protocol is TCP\n+        Properties hikariProperties = connectionConfig.getHikariProperties();\n+        assertThat(hikariProperties.stringPropertyNames())\n+                .noneMatch(prop -> prop.startsWith(\"javax.net.ssl.\"));\n+    }\n+\n+    @Test\n+    public void tcpsSetsTrustStore() throws IOException {\n+        File truststoreFile = new File(\"truststore.jks\");\n+        boolean truststoreFileCreated = truststoreFile.createNewFile();\n+        try {\n+            OracleConnectionConfig connectionConfig = getBaseBuilder()\n+                    .sid(SID)\n+                    .protocol(ConnectionProtocol.TCPS)\n+                    .truststorePath(\"truststore.jks\")\n+                    .truststorePassword(\"password\")\n+                    .keystorePath(\"keystore.jks\")\n+                    .keystorePassword(\"password\")\n+                    .build();\n+\n+            assertThat(connectionConfig.getProtocol())\n+                    .isEqualTo(ConnectionProtocol.TCPS);\n+            assertThat(connectionConfig.getTruststorePath())\n+                    .isEqualTo(Optional.of(\"truststore.jks\"));\n+            assertThat(connectionConfig.getKeystorePath())\n+                    .isEqualTo(Optional.of(\"keystore.jks\"));\n+            assertThat(connectionConfig.getTruststorePassword())\n+                    .isEqualTo(Optional.of(\"password\"));\n+            assertThat(connectionConfig.getKeystorePassword())\n+                    .isEqualTo(Optional.of(\"password\"));\n+\n+            Properties hikariProperties = connectionConfig.getHikariProperties();\n+            assertThat(hikariProperties)\n+                    .containsEntry(\"javax.net.ssl.trustStore\", truststoreFile.getAbsolutePath())\n+                    .containsEntry(\"javax.net.ssl.trustStorePassword\", \"password\")\n+                    .doesNotContainKeys(\"javax.net.ssl.keyStore\", \"javax.net.ssl.keyStorePassword\");\n+        } finally {\n+            // clean up the truststore file if we created it\n+            if (truststoreFileCreated) {\n+                truststoreFile.delete();\n+            }\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97cc2ba6e127251a8da7f490623bb93125cc0312"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3OTYwNDAxOnYy", "diffSide": "LEFT", "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNDo0MzowNFrOHVTnfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNToxODoyMFrOHVV3Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEwMzU0OQ==", "bodyText": "I'd prefer if we put a WARN log here if any of them are present? Basically it's easy to make a config error and then be really puzzled as to why the settings aren't taking effect.", "url": "https://github.com/palantir/atlasdb/pull/4988#discussion_r492103549", "createdAt": "2020-09-21T14:43:04Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java", "diffHunk": "@@ -196,16 +196,6 @@ protected final void check() {\n         } else {\n             Preconditions.checkArgument(!getTwoWaySsl(),\n                     \"two way ssl cannot be enabled without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getServerDn().isPresent(),\n-                    \"a server dn cannot be given without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getTruststorePath().isPresent(),\n-                    \"a truststore path cannot be given without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getTruststorePassword().isPresent(),\n-                    \"a truststore password cannot be given without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getKeystorePath().isPresent(),\n-                    \"a keystore file cannot be given without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getKeystorePassword().isPresent(),\n-                    \"a keystore password without enabling ConnectionProtocol.TCPS\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97cc2ba6e127251a8da7f490623bb93125cc0312"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE0MDM3NA==", "bodyText": "In this case if you set the protocol incorrectly you wouldn't be able to connect to the DB. Warning on here would just be unnecessary noise if the rest of the prefs were actually correct.", "url": "https://github.com/palantir/atlasdb/pull/4988#discussion_r492140374", "createdAt": "2020-09-21T15:18:20Z", "author": {"login": "berler"}, "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java", "diffHunk": "@@ -196,16 +196,6 @@ protected final void check() {\n         } else {\n             Preconditions.checkArgument(!getTwoWaySsl(),\n                     \"two way ssl cannot be enabled without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getServerDn().isPresent(),\n-                    \"a server dn cannot be given without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getTruststorePath().isPresent(),\n-                    \"a truststore path cannot be given without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getTruststorePassword().isPresent(),\n-                    \"a truststore password cannot be given without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getKeystorePath().isPresent(),\n-                    \"a keystore file cannot be given without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getKeystorePassword().isPresent(),\n-                    \"a keystore password without enabling ConnectionProtocol.TCPS\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEwMzU0OQ=="}, "originalCommit": {"oid": "97cc2ba6e127251a8da7f490623bb93125cc0312"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2572, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}