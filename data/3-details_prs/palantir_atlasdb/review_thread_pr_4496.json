{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwOTI0NTYy", "number": 4496, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzoyODowOVrODW7f0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxMDozOTowNVrODXHWvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MzcwMDY1OnYy", "diffSide": "RIGHT", "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/persistent/rocksdb/RocksDbPersistentTimestampStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzoyODowOVrOFb9xnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwOTozMzoyM1rOFcOmGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2Nzk5Nw==", "bodyText": "This is clever. Maybe a comment as to why the reverse comparator matters would be nice?", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r364867997", "createdAt": "2020-01-09T17:28:09Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/persistent/rocksdb/RocksDbPersistentTimestampStore.java", "diffHunk": "@@ -136,8 +144,12 @@ private void checkNamespaceExists(StoreNamespace storeNamespace) {\n     }\n \n     @Override\n-    public void close() {\n+    public void close() throws IOException {\n         rocksDB.close();\n+\n+        try (Stream<Path> stream = Files.walk(databaseFolder.toPath())) {\n+            stream.sorted(Comparator.reverseOrder()).map(Path::toFile).forEach(File::delete);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a7fe5cbcfbed93206cf06b7ca2ace8ab8b3532d"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0MzU3OA==", "bodyText": "Added comment explaining why the reverse lexicographical order is needed.", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r365143578", "createdAt": "2020-01-10T09:33:23Z", "author": {"login": "OStevan"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/persistent/rocksdb/RocksDbPersistentTimestampStore.java", "diffHunk": "@@ -136,8 +144,12 @@ private void checkNamespaceExists(StoreNamespace storeNamespace) {\n     }\n \n     @Override\n-    public void close() {\n+    public void close() throws IOException {\n         rocksDB.close();\n+\n+        try (Stream<Path> stream = Files.walk(databaseFolder.toPath())) {\n+            stream.sorted(Comparator.reverseOrder()).map(Path::toFile).forEach(File::delete);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2Nzk5Nw=="}, "originalCommit": {"oid": "1a7fe5cbcfbed93206cf06b7ca2ace8ab8b3532d"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MzcwNDQxOnYy", "diffSide": "RIGHT", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/config/PersistentStorageConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzoyOToyMFrOFb9zzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwOTozNDowN1rOFcOnUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2ODU1Ng==", "bodyText": "nit: I'd suggest including a SafeArg indicating what the value of storagePath is", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r364868556", "createdAt": "2020-01-09T17:29:20Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/config/PersistentStorageConfig.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.config;\n+\n+import java.io.File;\n+import java.nio.file.Paths;\n+\n+import org.immutables.value.Value;\n+\n+import com.fasterxml.jackson.annotation.JsonSubTypes;\n+import com.fasterxml.jackson.annotation.JsonTypeInfo;\n+import com.palantir.logsafe.Preconditions;\n+import com.palantir.logsafe.SafeArg;\n+\n+@JsonTypeInfo(use = JsonTypeInfo.Id.NAME, property = \"type\")\n+@JsonSubTypes({\n+        @JsonSubTypes.Type(\n+                value = ImmutableRocksDbPersistentStorageConfig.class,\n+                name = RocksDbPersistentStorageConfig.TYPE)})\n+public interface PersistentStorageConfig {\n+    String type();\n+\n+    /**\n+     * Path to the directory in which we want to store the data. In case the directory does not exist we create a new\n+     * one. Anything in this folder might be deleted.\n+     *\n+     * @return path to the directory\n+     */\n+    String storagePath();\n+\n+    @Value.Check\n+    default void check() {\n+        File storageFile = new File(storagePath());\n+        if (storageFile.exists()) {\n+            Preconditions.checkState(\n+                    storageFile.isDirectory(),\n+                    \"Storage path has to point to a directory\",\n+                    SafeArg.of(\"path\", storagePath()));\n+        }\n+\n+        Preconditions.checkState(!Paths.get(storagePath()).isAbsolute(), \"Storage path must be relative\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a7fe5cbcfbed93206cf06b7ca2ace8ab8b3532d"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0Mzg4OQ==", "bodyText": "Added.", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r365143889", "createdAt": "2020-01-10T09:34:07Z", "author": {"login": "OStevan"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/config/PersistentStorageConfig.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.config;\n+\n+import java.io.File;\n+import java.nio.file.Paths;\n+\n+import org.immutables.value.Value;\n+\n+import com.fasterxml.jackson.annotation.JsonSubTypes;\n+import com.fasterxml.jackson.annotation.JsonTypeInfo;\n+import com.palantir.logsafe.Preconditions;\n+import com.palantir.logsafe.SafeArg;\n+\n+@JsonTypeInfo(use = JsonTypeInfo.Id.NAME, property = \"type\")\n+@JsonSubTypes({\n+        @JsonSubTypes.Type(\n+                value = ImmutableRocksDbPersistentStorageConfig.class,\n+                name = RocksDbPersistentStorageConfig.TYPE)})\n+public interface PersistentStorageConfig {\n+    String type();\n+\n+    /**\n+     * Path to the directory in which we want to store the data. In case the directory does not exist we create a new\n+     * one. Anything in this folder might be deleted.\n+     *\n+     * @return path to the directory\n+     */\n+    String storagePath();\n+\n+    @Value.Check\n+    default void check() {\n+        File storageFile = new File(storagePath());\n+        if (storageFile.exists()) {\n+            Preconditions.checkState(\n+                    storageFile.isDirectory(),\n+                    \"Storage path has to point to a directory\",\n+                    SafeArg.of(\"path\", storagePath()));\n+        }\n+\n+        Preconditions.checkState(!Paths.get(storagePath()).isAbsolute(), \"Storage path must be relative\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2ODU1Ng=="}, "originalCommit": {"oid": "1a7fe5cbcfbed93206cf06b7ca2ace8ab8b3532d"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MzcwNDk1OnYy", "diffSide": "RIGHT", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/config/PersistentStorageConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzoyOTozM1rOFb90Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwOTozNTo0MVrOFcOqCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2ODY0Ng==", "bodyText": "We should say this must be a relative path.", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r364868646", "createdAt": "2020-01-09T17:29:33Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/config/PersistentStorageConfig.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.config;\n+\n+import java.io.File;\n+import java.nio.file.Paths;\n+\n+import org.immutables.value.Value;\n+\n+import com.fasterxml.jackson.annotation.JsonSubTypes;\n+import com.fasterxml.jackson.annotation.JsonTypeInfo;\n+import com.palantir.logsafe.Preconditions;\n+import com.palantir.logsafe.SafeArg;\n+\n+@JsonTypeInfo(use = JsonTypeInfo.Id.NAME, property = \"type\")\n+@JsonSubTypes({\n+        @JsonSubTypes.Type(\n+                value = ImmutableRocksDbPersistentStorageConfig.class,\n+                name = RocksDbPersistentStorageConfig.TYPE)})\n+public interface PersistentStorageConfig {\n+    String type();\n+\n+    /**\n+     * Path to the directory in which we want to store the data. In case the directory does not exist we create a new", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a7fe5cbcfbed93206cf06b7ca2ace8ab8b3532d"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0NDU4Ng==", "bodyText": "Comment is now in line with the implementation.", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r365144586", "createdAt": "2020-01-10T09:35:41Z", "author": {"login": "OStevan"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/config/PersistentStorageConfig.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.config;\n+\n+import java.io.File;\n+import java.nio.file.Paths;\n+\n+import org.immutables.value.Value;\n+\n+import com.fasterxml.jackson.annotation.JsonSubTypes;\n+import com.fasterxml.jackson.annotation.JsonTypeInfo;\n+import com.palantir.logsafe.Preconditions;\n+import com.palantir.logsafe.SafeArg;\n+\n+@JsonTypeInfo(use = JsonTypeInfo.Id.NAME, property = \"type\")\n+@JsonSubTypes({\n+        @JsonSubTypes.Type(\n+                value = ImmutableRocksDbPersistentStorageConfig.class,\n+                name = RocksDbPersistentStorageConfig.TYPE)})\n+public interface PersistentStorageConfig {\n+    String type();\n+\n+    /**\n+     * Path to the directory in which we want to store the data. In case the directory does not exist we create a new", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2ODY0Ng=="}, "originalCommit": {"oid": "1a7fe5cbcfbed93206cf06b7ca2ace8ab8b3532d"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MzcxMjQ3OnYy", "diffSide": "RIGHT", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/PersistentStorageFactories.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzozMjoxM1rOFb943A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwOTozNzozNlrOFcOtxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2OTg1Mg==", "bodyText": "The comment here probably needs to account for the role of SANITIZED_PATHS. Specifically, something like\n\nIf the path has been successfully sanitized before in the lifetime of this JVM, return.\nIf the path exists, checks that it is a directory.\nIf the path exists and is a directory, remove all sub-folders whose names are the string representation of an UUID.", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r364869852", "createdAt": "2020-01-09T17:32:13Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/PersistentStorageFactories.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.factory;\n+\n+import java.io.File;\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import com.google.common.base.MoreObjects;\n+import com.palantir.logsafe.Preconditions;\n+\n+public final class PersistentStorageFactories {\n+    private static final Pattern UUID_PATTERN = Pattern.compile(\n+            \"^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$\");\n+\n+    private static final Set<String> SANITIZED_PATHS = new HashSet<>();\n+\n+    private PersistentStorageFactories() {}\n+\n+    /**\n+     * For the given path does the following: 1) if it exists checks that it is a directory, 2) if it is a directory\n+     * removes all sub-folders whose names are string representation of a UUID.\n+     *", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a7fe5cbcfbed93206cf06b7ca2ace8ab8b3532d"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0NTU0MA==", "bodyText": "Added the missing comment.", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r365145540", "createdAt": "2020-01-10T09:37:36Z", "author": {"login": "OStevan"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/PersistentStorageFactories.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.factory;\n+\n+import java.io.File;\n+import java.util.HashSet;\n+import java.util.Set;\n+import java.util.regex.Pattern;\n+\n+import com.google.common.base.MoreObjects;\n+import com.palantir.logsafe.Preconditions;\n+\n+public final class PersistentStorageFactories {\n+    private static final Pattern UUID_PATTERN = Pattern.compile(\n+            \"^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$\");\n+\n+    private static final Set<String> SANITIZED_PATHS = new HashSet<>();\n+\n+    private PersistentStorageFactories() {}\n+\n+    /**\n+     * For the given path does the following: 1) if it exists checks that it is a directory, 2) if it is a directory\n+     * removes all sub-folders whose names are string representation of a UUID.\n+     *", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg2OTg1Mg=="}, "originalCommit": {"oid": "1a7fe5cbcfbed93206cf06b7ca2ace8ab8b3532d"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MzczMDA0OnYy", "diffSide": "RIGHT", "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/PersistentStorageFactoriesTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzozOToyM1rOFb-EQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzozOToyM1rOFb-EQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3Mjc3MQ==", "bodyText": "Usually for this it's reasonable to have a hasMessageContaining(...) to make sure the exception is what you want it to be.", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r364872771", "createdAt": "2020-01-09T17:39:23Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/PersistentStorageFactoriesTests.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.factory;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.UUID;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+import com.palantir.logsafe.exceptions.SafeIllegalArgumentException;\n+\n+public final class PersistentStorageFactoriesTests {\n+    @Rule\n+    public TemporaryFolder testFolder = new TemporaryFolder();\n+\n+    private String testFolderPath;\n+\n+    @Before\n+    public void setUp() {\n+        testFolderPath = testFolder.getRoot().getAbsolutePath();\n+    }\n+\n+    @Test\n+    public void emptyFolderSanitization() {\n+        PersistentStorageFactories.sanitizeStoragePath(testFolderPath);\n+    }\n+\n+    @Test\n+    public void nonExistentFolder() {\n+        File file  = new File(testFolderPath, \"nonexistent\");\n+        PersistentStorageFactories.sanitizeStoragePath(file.getPath());\n+\n+        assertThat(file).isDirectory();\n+    }\n+\n+    @Test\n+    public void sanitizingFile() throws IOException {\n+        File file = testFolder.newFile();\n+\n+        assertThatThrownBy(() -> PersistentStorageFactories.sanitizeStoragePath(file.getAbsolutePath()))\n+                .isInstanceOf(SafeIllegalArgumentException.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a7fe5cbcfbed93206cf06b7ca2ace8ab8b3532d"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MzczMjYwOnYy", "diffSide": "RIGHT", "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/PersistentStorageFactoriesTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzo0MDoxMVrOFb-FzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzo0MDoxMVrOFb-FzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3MzE2NQ==", "bodyText": "\ud83e\udd86 you mean doesNotRemoveNonUuidNamedFolder or something along those lines.", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r364873165", "createdAt": "2020-01-09T17:40:11Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/PersistentStorageFactoriesTests.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.factory;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.UUID;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+import com.palantir.logsafe.exceptions.SafeIllegalArgumentException;\n+\n+public final class PersistentStorageFactoriesTests {\n+    @Rule\n+    public TemporaryFolder testFolder = new TemporaryFolder();\n+\n+    private String testFolderPath;\n+\n+    @Before\n+    public void setUp() {\n+        testFolderPath = testFolder.getRoot().getAbsolutePath();\n+    }\n+\n+    @Test\n+    public void emptyFolderSanitization() {\n+        PersistentStorageFactories.sanitizeStoragePath(testFolderPath);\n+    }\n+\n+    @Test\n+    public void nonExistentFolder() {\n+        File file  = new File(testFolderPath, \"nonexistent\");\n+        PersistentStorageFactories.sanitizeStoragePath(file.getPath());\n+\n+        assertThat(file).isDirectory();\n+    }\n+\n+    @Test\n+    public void sanitizingFile() throws IOException {\n+        File file = testFolder.newFile();\n+\n+        assertThatThrownBy(() -> PersistentStorageFactories.sanitizeStoragePath(file.getAbsolutePath()))\n+                .isInstanceOf(SafeIllegalArgumentException.class);\n+    }\n+\n+    @Test\n+    public void removesUuidNamedFolder() throws IOException {\n+        testFolder.newFolder(UUID.randomUUID().toString());\n+\n+        PersistentStorageFactories.sanitizeStoragePath(testFolderPath);\n+        assertThat(testFolder.getRoot().listFiles()).isEmpty();\n+    }\n+\n+    @Test\n+    public void doesNotRemoveFiles() throws IOException {\n+        testFolder.newFile(UUID.randomUUID().toString());\n+        testFolder.newFile(\"testFile\");\n+\n+        PersistentStorageFactories.sanitizeStoragePath(testFolderPath);\n+        assertThat(testFolder.getRoot().listFiles()).hasSize(2);\n+    }\n+\n+    @Test\n+    public void doesNotRemoveNonFolder() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a7fe5cbcfbed93206cf06b7ca2ace8ab8b3532d"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MzczNDkyOnYy", "diffSide": "RIGHT", "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/config/PersistentStorageConfigTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzo0MTowN1rOFb-HQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQwOTo0NDozMVrOFcO7Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3MzUzOQ==", "bodyText": "nit: prefer static import. Also normally it's useful to include a hasMessageContaining to make sure it's the exception you expect", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r364873539", "createdAt": "2020-01-09T17:41:07Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/config/PersistentStorageConfigTests.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.config;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+\n+import org.assertj.core.api.Assertions;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+import com.palantir.logsafe.exceptions.SafeIllegalStateException;\n+\n+public final class PersistentStorageConfigTests {\n+    @ClassRule\n+    public static final TemporaryFolder TEST_FOLDER = new TemporaryFolder();\n+\n+    @Test\n+    public void rocksEmptyDirectory() throws IOException {\n+        ImmutableRocksDbPersistentStorageConfig.builder()\n+                .storagePath(TEST_FOLDER.newFolder().getAbsolutePath())\n+                .build();\n+    }\n+\n+    @Test\n+    public void rocksPathToFileThrowsAnException() {\n+        Assertions.assertThatThrownBy(() ->\n+                ImmutableRocksDbPersistentStorageConfig.builder()\n+                        .storagePath(TEST_FOLDER.newFile().getAbsolutePath())\n+                        .build())\n+                .isInstanceOf(SafeIllegalStateException.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b458bf74b80da9d01100b8cdf3645a419d8f6040"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE0OTAwMw==", "bodyText": "Added both.", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r365149003", "createdAt": "2020-01-10T09:44:31Z", "author": {"login": "OStevan"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/config/PersistentStorageConfigTests.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.config;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.net.URL;\n+\n+import org.assertj.core.api.Assertions;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+import com.palantir.logsafe.exceptions.SafeIllegalStateException;\n+\n+public final class PersistentStorageConfigTests {\n+    @ClassRule\n+    public static final TemporaryFolder TEST_FOLDER = new TemporaryFolder();\n+\n+    @Test\n+    public void rocksEmptyDirectory() throws IOException {\n+        ImmutableRocksDbPersistentStorageConfig.builder()\n+                .storagePath(TEST_FOLDER.newFolder().getAbsolutePath())\n+                .build();\n+    }\n+\n+    @Test\n+    public void rocksPathToFileThrowsAnException() {\n+        Assertions.assertThatThrownBy(() ->\n+                ImmutableRocksDbPersistentStorageConfig.builder()\n+                        .storagePath(TEST_FOLDER.newFile().getAbsolutePath())\n+                        .build())\n+                .isInstanceOf(SafeIllegalStateException.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3MzUzOQ=="}, "originalCommit": {"oid": "b458bf74b80da9d01100b8cdf3645a419d8f6040"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MzczNzM5OnYy", "diffSide": "RIGHT", "path": "atlasdb-config/src/test/resources/rocksdb-config.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzo0MjowNFrOFb-Ivw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNzo0MjowNFrOFb-Ivw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDg3MzkxOQ==", "bodyText": "but the storage path must be relative!", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r364873919", "createdAt": "2020-01-09T17:42:04Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/test/resources/rocksdb-config.yml", "diffHunk": "@@ -0,0 +1,2 @@\n+type: rocksdb\n+storagePath: /tmp/rocksdb", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b458bf74b80da9d01100b8cdf3645a419d8f6040"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1NTY0MzQ5OnYy", "diffSide": "RIGHT", "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/PersistentStorageFactoriesTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxMDozOTowNVrOFcQXFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxMDozOTowNVrOFcQXFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTE3MjUwMg==", "bodyText": "nit: maybe createFolderIfNotExists()?", "url": "https://github.com/palantir/atlasdb/pull/4496#discussion_r365172502", "createdAt": "2020-01-10T10:39:05Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/PersistentStorageFactoriesTests.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.factory;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.UUID;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+import com.palantir.logsafe.exceptions.SafeIllegalArgumentException;\n+\n+public final class PersistentStorageFactoriesTests {\n+    public static final String FIRST_SUBFOLDER_ROOT = \"first\";\n+    public static final String SECOND_SUBFOLDER_ROOT = \"second\";\n+    @Rule\n+    public TemporaryFolder testFolder = new TemporaryFolder();\n+\n+    private String testFolderPath;\n+\n+    @Before\n+    public void setUp() {\n+        testFolderPath = testFolder.getRoot().getAbsolutePath();\n+    }\n+\n+    @Test\n+    public void emptyFolderSanitization() {\n+        PersistentStorageFactories.sanitizeStoragePath(testFolderPath);\n+    }\n+\n+    @Test\n+    public void nonExistentFolder() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da3a49071d41c53dde3d4d4e40afff49f288969d"}, "originalPosition": 52}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2380, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}