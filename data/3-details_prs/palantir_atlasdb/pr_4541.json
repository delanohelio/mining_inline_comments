{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3OTM4ODE2", "number": 4541, "title": "Fix coalescing supplier", "bodyText": "Let's just take out a lock - and write a test that covers it. It's more\nobviously correct.", "createdAt": "2020-01-28T10:36:15Z", "url": "https://github.com/palantir/atlasdb/pull/4541", "merged": true, "mergeCommit": {"oid": "56878fa4edd89af47b22dbe13fb84c1414d6d1ee"}, "closed": true, "closedAt": "2020-01-28T11:43:21Z", "author": {"login": "j-baker"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-u4cTgH2gAyMzY3OTM4ODE2OjdlNjAwYjc1OWVlOGM0NjkxOThlMzk0ZDI5NzBjOWJiMDY1YzI4Mzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-vrb-gFqTM0OTMwMzk2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7e600b759ee8c469198e394d2970c9bb065c2837", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/7e600b759ee8c469198e394d2970c9bb065c2837", "committedDate": "2020-01-28T10:35:31Z", "message": "Fix coalescing supplier\n\nLet's just take out a lock - and write a test that covers it. It's more\nobviously correct."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MjczNTk5", "url": "https://github.com/palantir/atlasdb/pull/4541#pullrequestreview-349273599", "createdAt": "2020-01-28T10:36:29Z", "commit": {"oid": "7e600b759ee8c469198e394d2970c9bb065c2837"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMDozNjoyOVrOFigQCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMDozNjoyOVrOFigQCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcyNDI5Nw==", "bodyText": "this is an uncontended lock except in the case of the bug.", "url": "https://github.com/palantir/atlasdb/pull/4541#discussion_r371724297", "createdAt": "2020-01-28T10:36:29Z", "author": {"login": "j-baker"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/concurrent/CoalescingSupplier.java", "diffHunk": "@@ -69,13 +71,15 @@ Round awaitDone() {\n         }\n \n         void execute() {\n-            next = new Round();\n-            try {\n-                future.complete(delegate.get());\n-            } catch (Throwable t) {\n-                future.completeExceptionally(t);\n+            synchronized (lock) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e600b759ee8c469198e394d2970c9bb065c2837"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bcc3c45234d9cc59c8da2ec9b52dc4283cd764b", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/4bcc3c45234d9cc59c8da2ec9b52dc4283cd764b", "committedDate": "2020-01-28T10:39:17Z", "message": "Refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9ae98013bbda1e3e1f63c7a965cda5d86c3ed39", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/d9ae98013bbda1e3e1f63c7a965cda5d86c3ed39", "committedDate": "2020-01-28T10:48:11Z", "message": "Refactor fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e96a5014fce39b91b3f280bac29de741678fc6ec", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/e96a5014fce39b91b3f280bac29de741678fc6ec", "committedDate": "2020-01-28T10:39:17Z", "message": "Add generated changelog entries"}, "afterCommit": {"oid": "d9ae98013bbda1e3e1f63c7a965cda5d86c3ed39", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/d9ae98013bbda1e3e1f63c7a965cda5d86c3ed39", "committedDate": "2020-01-28T10:48:11Z", "message": "Refactor fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5Mjg1NDkz", "url": "https://github.com/palantir/atlasdb/pull/4541#pullrequestreview-349285493", "createdAt": "2020-01-28T10:55:36Z", "commit": {"oid": "d9ae98013bbda1e3e1f63c7a965cda5d86c3ed39"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f56939f08d85d0340d7ba5518e0f7d450b87160", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/3f56939f08d85d0340d7ba5518e0f7d450b87160", "committedDate": "2020-01-28T11:08:35Z", "message": "remove lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58e7e9cbb4dfd379425cdfe2e5c273d536cbd17b", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/58e7e9cbb4dfd379425cdfe2e5c273d536cbd17b", "committedDate": "2020-01-28T11:08:35Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9979f2c1053beef26de520a3b09e88bf87554e10", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/9979f2c1053beef26de520a3b09e88bf87554e10", "committedDate": "2020-01-28T11:08:35Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MzAzOTY5", "url": "https://github.com/palantir/atlasdb/pull/4541#pullrequestreview-349303969", "createdAt": "2020-01-28T11:29:36Z", "commit": {"oid": "9979f2c1053beef26de520a3b09e88bf87554e10"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMToyOTozNlrOFihsjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMToyOTozNlrOFihsjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc0Nzk4Mg==", "bodyText": "This is neat!", "url": "https://github.com/palantir/atlasdb/pull/4541#discussion_r371747982", "createdAt": "2020-01-28T11:29:36Z", "author": {"login": "gmaretic"}, "path": "atlasdb-commons/src/test/java/com/palantir/common/concurrent/CoalescingSupplierTest.java", "diffHunk": "@@ -114,6 +121,41 @@ public void exceptionsArePropagatedForCoalescedCalls() {\n         tasks.assertAllFailed(expected);\n     }\n \n+    @Test\n+    public void stressTest() {\n+        int poolSize = 1024;\n+        ListeningExecutorService executorService =\n+                MoreExecutors.listeningDecorator(PTExecutors.newFixedThreadPool(poolSize));\n+        AtomicLong counter = new AtomicLong(0);\n+        Supplier<Long> supplier = new CoalescingSupplier<>(() -> {\n+            sleep(2);\n+            return counter.incrementAndGet();\n+        });\n+        List<ListenableFuture<?>> futures = IntStream.range(0, poolSize)\n+                .mapToObj(index -> executorService.submit(() -> assertIncreasing(supplier)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9979f2c1053beef26de520a3b09e88bf87554e10"}, "originalPosition": 42}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2218, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}