{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3MzQzNDU5", "number": 4728, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwODo0MzozNlrOD1Kxlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNDowOTo0MlrOD2tB-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MDc3NjU1OnYy", "diffSide": "RIGHT", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwODo0MzozN1rOGKd4cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwODo0MzozN1rOGKd4cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYyODUyOA==", "bodyText": "Let's make this static, no reason to get the logger on every call", "url": "https://github.com/palantir/atlasdb/pull/4728#discussion_r413628528", "createdAt": "2020-04-23T08:43:37Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoader.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.management;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.slf4j.LoggerFactory;\n+\n+import com.palantir.atlasdb.timelock.paxos.PaxosUseCase;\n+import com.palantir.logsafe.SafeArg;\n+\n+final class DiskNamespaceLoader {\n+    private final Path rootDataDirectory;\n+\n+    DiskNamespaceLoader(Path rootDataDirectory) {\n+        this.rootDataDirectory = rootDataDirectory;\n+    }\n+\n+    Set<String> getNamespaces() {\n+        return Arrays.stream(PaxosUseCase.values())\n+                .filter(useCase -> useCase != PaxosUseCase.LEADER_FOR_ALL_CLIENTS)\n+                .map(useCase -> useCase.logDirectoryRelativeToDataDirectory(rootDataDirectory))\n+                .flatMap(DiskNamespaceLoader::getNamespacesFromUseCaseResolvedDirectory)\n+                .collect(Collectors.toSet());\n+    }\n+\n+    private static Stream<String> getNamespacesFromUseCaseResolvedDirectory(Path logDirectory) {\n+        File[] directories = logDirectory.toFile().listFiles(File::isDirectory);\n+        if (directories == null) {\n+            LoggerFactory.getLogger(DiskNamespaceLoader.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf037884589aa918b1fd92aa182180d2a4945ef2"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MDc4NDk5OnYy", "diffSide": "RIGHT", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwODo0NToyNFrOGKd9lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwODo0NToyNFrOGKd9lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzYyOTg0NQ==", "bodyText": "I'd suggest we write this as:\n\nif logDirectory does not exist, return Stream.of() without complaints, or maybe an INFO log\nif it does and we get null, log error and throw: this is a strange state", "url": "https://github.com/palantir/atlasdb/pull/4728#discussion_r413629845", "createdAt": "2020-04-23T08:45:24Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoader.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.management;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.slf4j.LoggerFactory;\n+\n+import com.palantir.atlasdb.timelock.paxos.PaxosUseCase;\n+import com.palantir.logsafe.SafeArg;\n+\n+final class DiskNamespaceLoader {\n+    private final Path rootDataDirectory;\n+\n+    DiskNamespaceLoader(Path rootDataDirectory) {\n+        this.rootDataDirectory = rootDataDirectory;\n+    }\n+\n+    Set<String> getNamespaces() {\n+        return Arrays.stream(PaxosUseCase.values())\n+                .filter(useCase -> useCase != PaxosUseCase.LEADER_FOR_ALL_CLIENTS)\n+                .map(useCase -> useCase.logDirectoryRelativeToDataDirectory(rootDataDirectory))\n+                .flatMap(DiskNamespaceLoader::getNamespacesFromUseCaseResolvedDirectory)\n+                .collect(Collectors.toSet());\n+    }\n+\n+    private static Stream<String> getNamespacesFromUseCaseResolvedDirectory(Path logDirectory) {\n+        File[] directories = logDirectory.toFile().listFiles(File::isDirectory);\n+        if (directories == null) {\n+            LoggerFactory.getLogger(DiskNamespaceLoader.class)\n+                    .error(\"Could not get file for the directory {}\", SafeArg.of(\"dirName\", logDirectory));\n+            return Stream.of();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf037884589aa918b1fd92aa182180d2a4945ef2"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4Njg2NTE1OnYy", "diffSide": "RIGHT", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNDowODowMFrOGMlFAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNDowODowMFrOGMlFAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg0MzU4Nw==", "bodyText": "nit: We normally use log rather than logger", "url": "https://github.com/palantir/atlasdb/pull/4728#discussion_r415843587", "createdAt": "2020-04-27T14:08:00Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoader.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.management;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.palantir.atlasdb.timelock.paxos.PaxosUseCase;\n+import com.palantir.logsafe.SafeArg;\n+\n+final class DiskNamespaceLoader {\n+    private static final Logger logger = LoggerFactory.getLogger(DiskNamespaceLoader.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbedca424e98e5ef8ee9bc1ade6a4f809dbf83f7"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4Njg3NDgzOnYy", "diffSide": "RIGHT", "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoader.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNDowOTo0MlrOGMlKoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNDowOTo0MlrOGMlKoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTg0NTAyNA==", "bodyText": "Probably should add an INFO log (we skipped log directory {}).", "url": "https://github.com/palantir/atlasdb/pull/4728#discussion_r415845024", "createdAt": "2020-04-27T14:09:42Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoader.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.management;\n+\n+import java.io.File;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.palantir.atlasdb.timelock.paxos.PaxosUseCase;\n+import com.palantir.logsafe.SafeArg;\n+\n+final class DiskNamespaceLoader {\n+    private static final Logger logger = LoggerFactory.getLogger(DiskNamespaceLoader.class);\n+    private final Path rootDataDirectory;\n+\n+    DiskNamespaceLoader(Path rootDataDirectory) {\n+        this.rootDataDirectory = rootDataDirectory;\n+    }\n+\n+    Set<String> getNamespaces() {\n+        return Arrays.stream(PaxosUseCase.values())\n+                .filter(useCase -> useCase != PaxosUseCase.LEADER_FOR_ALL_CLIENTS)\n+                .map(useCase -> useCase.logDirectoryRelativeToDataDirectory(rootDataDirectory))\n+                .flatMap(DiskNamespaceLoader::getNamespacesFromUseCaseResolvedDirectory)\n+                .collect(Collectors.toSet());\n+    }\n+\n+    private static Stream<String> getNamespacesFromUseCaseResolvedDirectory(Path logDirectory) {\n+        if (Files.notExists(logDirectory)) {\n+            return Stream.of();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbedca424e98e5ef8ee9bc1ade6a4f809dbf83f7"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3078, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}