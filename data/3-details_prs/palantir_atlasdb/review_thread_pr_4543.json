{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MDYwNjg2", "number": 4543, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMzo0MTozMVrODb6tHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzozOTowOVrODdxYeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNTk5OTY0OnYy", "diffSide": "RIGHT", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMzo0MTozMVrOFjrOxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMzo0MjozMVrOFjrQ0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1Mjc3NA==", "bodyText": "This will break logging again: LeasedLockToken is not loggable by our logging infra. So either get rid of the args in this logline or figure out how to collect the stuff you need in a way that's loggable.", "url": "https://github.com/palantir/atlasdb/pull/4543#discussion_r372952774", "createdAt": "2020-01-30T13:41:31Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -2260,8 +2260,7 @@ private void handleKeyAlreadyExistsException(\n                         + \" because our locks timed out. startTs: \" + getStartTimestamp() + \".  \"\n                         + getExpiredLocksErrorString(commitLocksToken, expiredLocks), ex);\n             } else {\n-                log.debug(\"Possible bug: Someone rolled back our transaction but\"\n-                        + \" our locks were still valid; Atlas code is not allowed to do this, though others can.\",\n+                log.info(\"This transaction has been rolled back by someone else.\",\n                         SafeArg.of(\"immutableTimestampLock\", immutableTimestampLock),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99a708e0e71903da3a85965b16732b72b6fbe86d"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1MzI5Ng==", "bodyText": "For this to be useful, probably startTimestamp would be pretty useful as an arg? But then again should probably be collectable by traceId", "url": "https://github.com/palantir/atlasdb/pull/4543#discussion_r372953296", "createdAt": "2020-01-30T13:42:31Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -2260,8 +2260,7 @@ private void handleKeyAlreadyExistsException(\n                         + \" because our locks timed out. startTs: \" + getStartTimestamp() + \".  \"\n                         + getExpiredLocksErrorString(commitLocksToken, expiredLocks), ex);\n             } else {\n-                log.debug(\"Possible bug: Someone rolled back our transaction but\"\n-                        + \" our locks were still valid; Atlas code is not allowed to do this, though others can.\",\n+                log.info(\"This transaction has been rolled back by someone else.\",\n                         SafeArg.of(\"immutableTimestampLock\", immutableTimestampLock),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1Mjc3NA=="}, "originalCommit": {"oid": "99a708e0e71903da3a85965b16732b72b6fbe86d"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwNjU3NDIyOnYy", "diffSide": "RIGHT", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNjoxMDo0OVrOFjwxZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNjoxMDo0OVrOFjwxZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA0MzU1Ng==", "bodyText": "@gmaretic would you be able to quickly test manually using an internal product to see that this logline works?", "url": "https://github.com/palantir/atlasdb/pull/4543#discussion_r373043556", "createdAt": "2020-01-30T16:10:49Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -2260,10 +2269,10 @@ private void handleKeyAlreadyExistsException(\n                         + \" because our locks timed out. startTs: \" + getStartTimestamp() + \".  \"\n                         + getExpiredLocksErrorString(commitLocksToken, expiredLocks), ex);\n             } else {\n-                log.debug(\"Possible bug: Someone rolled back our transaction but\"\n-                        + \" our locks were still valid; Atlas code is not allowed to do this, though others can.\",\n-                        SafeArg.of(\"immutableTimestampLock\", immutableTimestampLock),\n-                        SafeArg.of(\"commitLocksToken\", commitLocksToken));\n+                log.info(\"This transaction has been rolled back by someone else.\",\n+                        SafeArg.of(\"immutableTimestampLock\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75a0ccb66f41405bdaf52fdae10672fa310ff1e1"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMxMjg0NzkxOnYy", "diffSide": "RIGHT", "path": "lock-api/src/main/java/com/palantir/lock/client/LockTokenShare.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOTo0Mjo0M1rOFkrVAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOTo0Mjo0M1rOFkrVAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAwMjk0NA==", "bodyText": "At this point maybe we should just add something to the LockToken interface that is going to return a String that can be used for logging? Or maybe an Arg straight away? https://github.com/palantir/safe-logging/blob/develop/safe-logging/src/main/java/com/palantir/logsafe/SafeArg.java", "url": "https://github.com/palantir/atlasdb/pull/4543#discussion_r374002944", "createdAt": "2020-02-03T09:42:43Z", "author": {"login": "jkozlowski"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LockTokenShare.java", "diffHunk": "@@ -24,7 +24,7 @@\n import com.palantir.lock.v2.LockToken;\n import com.palantir.logsafe.Preconditions;\n \n-final class LockTokenShare implements LockToken {\n+public final class LockTokenShare implements LockToken {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a36366ea80a1fe1049b4dc6652e302ffbfb5c71"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNTAwODk4OnYy", "diffSide": "RIGHT", "path": "lock-api/src/main/java/com/palantir/lock/client/LockTokenShare.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNTo0NDoyOVrOFmf6kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNTo0NDoyOVrOFmf6kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTkxMzEwNA==", "bodyText": "These publics are not necessary anymore?", "url": "https://github.com/palantir/atlasdb/pull/4543#discussion_r375913104", "createdAt": "2020-02-06T15:44:29Z", "author": {"login": "jkozlowski"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LockTokenShare.java", "diffHunk": "@@ -23,8 +23,9 @@\n \n import com.palantir.lock.v2.LockToken;\n import com.palantir.logsafe.Preconditions;\n+import com.palantir.logsafe.SafeArg;\n \n-final class LockTokenShare implements LockToken {\n+public final class LockTokenShare implements LockToken {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecc53a576fa7da8ed662c58421cca887bed0adbd"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyNTQ0Mzc4OnYy", "diffSide": "RIGHT", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzozOTowOVrOFmkIKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzozOTowOVrOFmkIKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MjEyMg==", "bodyText": "We should say we still have our locks, otherwise it's not clear what the args are meant to mean.", "url": "https://github.com/palantir/atlasdb/pull/4543#discussion_r375982122", "createdAt": "2020-02-06T17:39:09Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -2260,10 +2260,11 @@ private void handleKeyAlreadyExistsException(\n                         + \" because our locks timed out. startTs: \" + getStartTimestamp() + \".  \"\n                         + getExpiredLocksErrorString(commitLocksToken, expiredLocks), ex);\n             } else {\n-                log.debug(\"Possible bug: Someone rolled back our transaction but\"\n-                        + \" our locks were still valid; Atlas code is not allowed to do this, though others can.\",\n-                        SafeArg.of(\"immutableTimestampLock\", immutableTimestampLock),\n-                        SafeArg.of(\"commitLocksToken\", commitLocksToken));\n+                log.info(\"This transaction has been rolled back by someone else.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecc53a576fa7da8ed662c58421cca887bed0adbd"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2270, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}