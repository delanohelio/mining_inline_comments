{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MjY2NjMx", "number": 4939, "title": "[PD$-110002] Part 15: MetricsFilterEvaluationContext", "bodyText": "Goals (and why):\n\nSave money\n\nImplementation Description (bullets):\n\nThe previous top-N based changes were only of limited effectiveness because on atlasdb-proxy each datastore only seems to generally use <10 tables, so they still all get published.\nIf you're a singular AtlasDB user you probably want your top 10, if you're atlasdb-proxy it may suffice to have the global top 50.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nConcerns (what feedback would you like?):\n\nIs there any accidental memory leak?\n\nWhere should we start reviewing?: MetricsFilterEvaluationContext\nPriority (whenever / two weeks / yesterday): this week? Not super urgent but would like to close this workstream.", "createdAt": "2020-08-11T18:05:18Z", "url": "https://github.com/palantir/atlasdb/pull/4939", "merged": true, "mergeCommit": {"oid": "a2af140630eb3fbbd3e7c181c64d6920f5901b41"}, "closed": true, "closedAt": "2020-08-24T14:06:27Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc91XUVAH2gAyNDY2MjY2NjMxOmY2ODNiZDY3ZTU4N2Q0OWM0ZDg4ODFjMjkwZmMwOWNhOTFjZTAyNmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCCUlvgH2gAyNDY2MjY2NjMxOjI1N2RlNjgzMmIzZGExYmExMTk2MDMyYWFkZmUyYzhjYWRkMjQ0MGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f683bd67e587d49c4d8881c290fc09ca91ce026d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/f683bd67e587d49c4d8881c290fc09ca91ce026d", "committedDate": "2020-08-11T11:45:54Z", "message": "Shared context test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d68bb4fce6a9157646d4d9a68d4c71e0bf1e6b5", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/0d68bb4fce6a9157646d4d9a68d4c71e0bf1e6b5", "committedDate": "2020-08-11T11:46:01Z", "message": "Shared contexts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eee48591db580cfd9cb2814e361e81cbca6d0336", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/eee48591db580cfd9cb2814e361e81cbca6d0336", "committedDate": "2020-08-11T15:01:24Z", "message": "Refine docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "054988e0088b1666f85b7921bf682c860722089e", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/054988e0088b1666f85b7921bf682c860722089e", "committedDate": "2020-08-11T16:53:11Z", "message": "More tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44d65810dddd6e286fb9882a09c21aa2101cbdd4", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/44d65810dddd6e286fb9882a09c21aa2101cbdd4", "committedDate": "2020-08-11T17:00:09Z", "message": "filter evaluation contexts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c50e62fa58ca7ce24878fee916e8b03a69872a55", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/c50e62fa58ca7ce24878fee916e8b03a69872a55", "committedDate": "2020-08-11T17:54:10Z", "message": "fix build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5389a9427869ac601a8c3a638c6b2e0d7f256926", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/5389a9427869ac601a8c3a638c6b2e0d7f256926", "committedDate": "2020-08-11T17:57:53Z", "message": "circles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e97f6d3a47176125fcc6d3398e662ea18f1c9ef6", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e97f6d3a47176125fcc6d3398e662ea18f1c9ef6", "committedDate": "2020-08-11T17:57:53Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab7eb976059172200ca89ee5179b5f3682b6910a", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/ab7eb976059172200ca89ee5179b5f3682b6910a", "committedDate": "2020-08-11T18:22:56Z", "message": "Checkstyles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7cbfa396437750ad34eb4fd0cf43c22d351617d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d7cbfa396437750ad34eb4fd0cf43c22d351617d", "committedDate": "2020-08-11T20:51:45Z", "message": "Merge branch 'jkong/shared-topn' of github.com:palantir/atlasdb into jkong/shared-topn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "779f8cfe4aac7c59c7b4f7c4e692c095db3c0af8", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/779f8cfe4aac7c59c7b4f7c4e692c095db3c0af8", "committedDate": "2020-08-14T18:03:23Z", "message": "Merge remote-tracking branch 'origin/develop' into jkong/shared-topn"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4Mzc5NTI2", "url": "https://github.com/palantir/atlasdb/pull/4939#pullrequestreview-468379526", "createdAt": "2020-08-17T11:24:38Z", "commit": {"oid": "779f8cfe4aac7c59c7b4f7c4e692c095db3c0af8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMToyNDozOFrOHBkzfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMToyNDozOFrOHBkzfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTQxMzYyOA==", "bodyText": "Neat!", "url": "https://github.com/palantir/atlasdb/pull/4939#discussion_r471413628", "createdAt": "2020-08-17T11:24:38Z", "author": {"login": "sudiksha27"}, "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/transaction/impl/metrics/ToplistDeltaFilteringTableLevelMetricsControllerTest.java", "diffHunk": "@@ -75,10 +79,35 @@ public void selectsOnlyHighestMetricsForPublication() {\n                 .containsOnlyKeys(getMetricName(\"table2\"), getMetricName(\"table3\"), getMetricName(\"table4\"));\n     }\n \n+    @Test\n+    public void operatesCorrectlyWithSharedContexts() {\n+        MetricsManager otherManager = MetricsManagers.createAlwaysSafeAndFilteringForTests();\n+        ToplistDeltaFilteringTableLevelMetricsController otherController\n+                = new ToplistDeltaFilteringTableLevelMetricsController(context, otherManager, mockClock);\n+\n+        Map<Integer, Counter> counters = KeyedStream.of(ImmutableList.of(1, 2, 4))\n+                .map(value -> controller.createAndRegisterCounter(\n+                        Class.class,\n+                        \"metricName\",\n+                        TableReference.create(Namespace.create(\"namespace\"), \"table\" + value)))\n+                .collectToMap();\n+        counters.forEach((value, counter) -> counter.inc(value));\n+\n+        Counter otherControllersCounter = otherController.createAndRegisterCounter(\n+                Class.class,\n+                \"metricName\",\n+                TableReference.create(Namespace.create(\"namespace\"), \"table3\"));\n+        otherControllersCounter.inc(3);\n+\n+        assertThat(metricsManager.getPublishableMetrics().getMetrics())\n+                .containsOnlyKeys(getMetricName(\"table2\"), getMetricName(\"table4\"));\n+        assertThat(otherManager.getPublishableMetrics().getMetrics())\n+                .containsOnlyKeys(getMetricName(\"table3\"));\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "779f8cfe4aac7c59c7b4f7c4e692c095db3c0af8"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2245378bb2e00cdab0b7d0ec5dc14594fc6addb", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/b2245378bb2e00cdab0b7d0ec5dc14594fc6addb", "committedDate": "2020-08-21T16:24:37Z", "message": "Autorelease 0.240.10-rc2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f742959a8f7abf89111297a64415c87fcf4c203a", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/f742959a8f7abf89111297a64415c87fcf4c203a", "committedDate": "2020-08-21T16:39:22Z", "message": "Merge branch 'develop' into jkong/shared-topn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc22bb459fa2b4cafa251529ae867850fe6f56c1", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/dc22bb459fa2b4cafa251529ae867850fe6f56c1", "committedDate": "2020-08-21T16:43:02Z", "message": "changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7765ed9b06adedfd6ee45187233e41a2b6d2db2f", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/7765ed9b06adedfd6ee45187233e41a2b6d2db2f", "committedDate": "2020-08-21T16:44:45Z", "message": "Autorelease 0.241.5-rc1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "257de6832b3da1ba1196032aadfe2c8cadd2440c", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/257de6832b3da1ba1196032aadfe2c8cadd2440c", "committedDate": "2020-08-24T13:07:23Z", "message": "changelog to develop"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2785, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}