{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwODUyMjkx", "number": 5084, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowMToxOFrOEye9dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowNDoxMFrOEyfCkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMzcxNTEwOnYy", "diffSide": "RIGHT", "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowMToxOFrOHpJwsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowMToyNFrOHpJxCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxMzU4NQ==", "bodyText": "wat", "url": "https://github.com/palantir/atlasdb/pull/5084#discussion_r512913585", "createdAt": "2020-10-27T18:01:18Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "diffHunk": "@@ -223,7 +224,7 @@ public void truncate(long toDeleteInclusive) {\n             for (File file : files) {\n                 long fileSeq = getSeqFromFilename(file);\n                 if (fileSeq <= toDeleteInclusive) {\n-                    if (file.delete()) {\n+                    if (!file.delete()) {\n                         log.warn(\"failed to delete log file {}\", file.getAbsolutePath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxMzY3Mg==", "bodyText": "good spot though!", "url": "https://github.com/palantir/atlasdb/pull/5084#discussion_r512913672", "createdAt": "2020-10-27T18:01:24Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "diffHunk": "@@ -223,7 +224,7 @@ public void truncate(long toDeleteInclusive) {\n             for (File file : files) {\n                 long fileSeq = getSeqFromFilename(file);\n                 if (fileSeq <= toDeleteInclusive) {\n-                    if (file.delete()) {\n+                    if (!file.delete()) {\n                         log.warn(\"failed to delete log file {}\", file.getAbsolutePath());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxMzU4NQ=="}, "originalCommit": {"oid": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMzcxODg4OnYy", "diffSide": "RIGHT", "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowMjowOVrOHpJzBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowMjowOVrOHpJzBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxNDE4Mg==", "bodyText": "nit: could we include, at least at Unsafe level, the directory involved?", "url": "https://github.com/palantir/atlasdb/pull/5084#discussion_r512914182", "createdAt": "2020-10-27T18:02:09Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "diffHunk": "@@ -235,10 +236,24 @@ public void truncate(long toDeleteInclusive) {\n         }\n     }\n \n+    @Override\n+    public void truncateAllRounds() {\n+        lock.writeLock().lock();\n+        try {\n+            File dir = new File(path);\n+            boolean success = getLogEntries(dir).stream().map(File::delete).reduce(true, (x, y) -> x && y);\n+            if (!success) {\n+                log.warn(\"failed to delete all log files.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIxMzcyODE2OnYy", "diffSide": "RIGHT", "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowNDoxMFrOHpJ5Jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowNDoxMFrOHpJ5Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxNTc1MQ==", "bodyText": "I realise this case is handled already above in getExtremeLogEntry, but we should clean it up.", "url": "https://github.com/palantir/atlasdb/pull/5084#discussion_r512915751", "createdAt": "2020-10-27T18:04:10Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "diffHunk": "@@ -235,10 +236,24 @@ public void truncate(long toDeleteInclusive) {\n         }\n     }\n \n+    @Override\n+    public void truncateAllRounds() {\n+        lock.writeLock().lock();\n+        try {\n+            File dir = new File(path);\n+            boolean success = getLogEntries(dir).stream().map(File::delete).reduce(true, (x, y) -> x && y);\n+            if (!success) {\n+                log.warn(\"failed to delete all log files.\");\n+            }\n+        } finally {\n+            lock.writeLock().unlock();\n+        }\n+    }\n+\n     private List<File> getLogEntries(File dir) {\n         File[] files = dir.listFiles();\n         if (files == null) {\n-            return null;\n+            return ImmutableList.of();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2451, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}