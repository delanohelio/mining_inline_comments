{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxNTQ2MTMw", "number": 4873, "title": "[PD$-110002] Part 7: Cassandra Client Pool", "bodyText": "Goals (and why):\n\n$$$\n\nImplementation Description (bullets):\n\nRemove four gauge metrics from the CassandraClientPoolingContainer. These are registered once for each Cassandra node, meaning that we would save 4 * |Cassandra cluster| * |namespaces| time series per period on AtlasDb-Proxy.\nThree of these are derived metrics: the aggregation should be done using tools rather than also reporting.\nOne more has always been zero everywhere in prod for the past year (I'm not sure that we do any meaningful validation on borrowing).\n\nTesting (What was existing testing like?  What have you done to improve it?): None\nConcerns (what feedback would you like?):\n\nAre the other metrics actually useful for debugging? I could see edge cases where they might be useful, but not wholly convinced.\n\nWhere should we start reviewing?: CassandraClientPoolingContainer.java\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-06-29T17:16:39Z", "url": "https://github.com/palantir/atlasdb/pull/4873", "merged": true, "mergeCommit": {"oid": "65b82cc14f52c38ac11ee69674dc0a4196965ac5"}, "closed": true, "closedAt": "2020-06-30T19:25:02Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwEOEXAH2gAyNDQxNTQ2MTMwOjg4ZWRhNDc2YjhjNjE5YTBkZmE1ODAyMjZhMTg2MWRiZjhhNzFmZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwZu4kgH2gAyNDQxNTQ2MTMwOmI0NDRkYjMzMzMxNWZkOThmNTVjNTRkOTlhYmI3NTgzN2EwNmM3ZWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "88eda476b8c619a0dfa580226a1861dbf8a71ff3", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/88eda476b8c619a0dfa580226a1861dbf8a71ff3", "committedDate": "2020-06-29T17:09:26Z", "message": "Low hanging fruit CCPC"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eccdc61e254af2038ecc8932edb3e36a9f64d555", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/eccdc61e254af2038ecc8932edb3e36a9f64d555", "committedDate": "2020-06-29T17:12:40Z", "message": "one more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "718c8b35f702015efe13394212e2cd11f7a01794", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/718c8b35f702015efe13394212e2cd11f7a01794", "committedDate": "2020-06-29T17:12:40Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzUzMDE1", "url": "https://github.com/palantir/atlasdb/pull/4873#pullrequestreview-439753015", "createdAt": "2020-06-30T07:45:08Z", "commit": {"oid": "718c8b35f702015efe13394212e2cd11f7a01794"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNzo0NTowOVrOGqv6qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNzo0NTowOVrOGqv6qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ3ODQ0Mw==", "bodyText": "I think this is a good change. Just wondering if we could basically keep all metrics in memory and then use your filtering infra to report outliers? but otherwise just report one set of metrics for all pools.", "url": "https://github.com/palantir/atlasdb/pull/4873#discussion_r447478443", "createdAt": "2020-06-30T07:45:09Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java", "diffHunk": "@@ -309,14 +309,8 @@ private void registerMetrics(GenericObjectPool<CassandraClient> pool) {\n         registerPoolMetric(\"meanBorrowWaitTimeMillis\", pool::getMeanBorrowWaitTimeMillis);\n         registerPoolMetric(\"numIdle\", pool::getNumIdle);\n         registerPoolMetric(\"numActive\", pool::getNumActive);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718c8b35f702015efe13394212e2cd11f7a01794"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzU0MDAz", "url": "https://github.com/palantir/atlasdb/pull/4873#pullrequestreview-439754003", "createdAt": "2020-06-30T07:46:29Z", "commit": {"oid": "718c8b35f702015efe13394212e2cd11f7a01794"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNzo0NjoyOVrOGqv9lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNzo0NjoyOVrOGqv9lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ3OTE4OA==", "bodyText": "I'm curious about this metric as well, I thought we don't wait at all, but waiting is done in the CassandraRetrier. So in effect this might be timing a memory operation of checking out a connection from the pool", "url": "https://github.com/palantir/atlasdb/pull/4873#discussion_r447479188", "createdAt": "2020-06-30T07:46:29Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java", "diffHunk": "@@ -309,14 +309,8 @@ private void registerMetrics(GenericObjectPool<CassandraClient> pool) {\n         registerPoolMetric(\"meanBorrowWaitTimeMillis\", pool::getMeanBorrowWaitTimeMillis);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718c8b35f702015efe13394212e2cd11f7a01794"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzU5NjA5", "url": "https://github.com/palantir/atlasdb/pull/4873#pullrequestreview-439759609", "createdAt": "2020-06-30T07:53:47Z", "commit": {"oid": "718c8b35f702015efe13394212e2cd11f7a01794"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNzo1Mzo0N1rOGqwPzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNzo1Mzo0N1rOGqwPzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4Mzg1NA==", "bodyText": "meanIdleTimeMillis is interesting: I guess it might tell you if your min connection pool size is too large, but I don't think anyone ever cares? Also the idle timeout is 10 minutes, so I'd vote for canning this one too, unless you can think of a purpose for it?", "url": "https://github.com/palantir/atlasdb/pull/4873#discussion_r447483854", "createdAt": "2020-06-30T07:53:47Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/CassandraClientPoolingContainer.java", "diffHunk": "@@ -309,14 +309,8 @@ private void registerMetrics(GenericObjectPool<CassandraClient> pool) {\n         registerPoolMetric(\"meanBorrowWaitTimeMillis\", pool::getMeanBorrowWaitTimeMillis);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718c8b35f702015efe13394212e2cd11f7a01794"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzYwODIw", "url": "https://github.com/palantir/atlasdb/pull/4873#pullrequestreview-439760820", "createdAt": "2020-06-30T07:55:27Z", "commit": {"oid": "718c8b35f702015efe13394212e2cd11f7a01794"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47baaa84050f58cb553bf2f36d3e84ddd0eb399a", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/47baaa84050f58cb553bf2f36d3e84ddd0eb399a", "committedDate": "2020-06-30T17:25:45Z", "message": "Two more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b444db333315fd98f55c54d99abb75837a06c7ed", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/b444db333315fd98f55c54d99abb75837a06c7ed", "committedDate": "2020-06-30T18:13:17Z", "message": "why would we pick that one"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2706, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}