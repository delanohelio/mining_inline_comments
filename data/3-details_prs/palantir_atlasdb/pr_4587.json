{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3MjM5OTUx", "number": 4587, "title": "[Timelock OOMs] Stop `PaxosQuorumChecker` cancellation", "bodyText": "Goals (and why):\nAs part of our annoyingly long running investigation into Timelock OOMs, we stopped cancelling remaining calls in the PaxosQuorumChecker. The benefit of this was two-fold:\n\nWe don't get those spurious log lines about leaked connections or at the very least the volume is significantly reduced and we only really see them when a GC happens.\n\nThis makes sense since that leak logger is implemented with Garbage collection.\nSupposedly this all changes in 3.14.x where it should be fixed, but internally timelock is using 3.13.1, a potential follow up would be to upgrade and see whether we're just better.\n\n\nWe don't OOM! \ud83c\udf89 \ud83d\udc83\n\nImplementation Description (bullets):\n\nSince we control Timelock and operate it internally, we have a bit more control over how we want change cancellations. However, the same cannot be said about big internal product and anyone on the leader block. They may be running in an environment that makes it a lot more difficult/consume more resources.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nExisting tests should pass.\nConcerns (what feedback would you like?):\nThe wiring of this sucks, and feels like the PaxosQuorumChecker should no longer be a static class, and have a bit of state. At the very least it would make code that uses it a bit clearer. It's somewhat out of scope, if someone else wants to pick it up sure, but I think it's okay to take on this tech debt, I just can't afford to pay it right now.\nWhere should we start reviewing?:\nCommit by commit, first is the refactor, the next is the config change.\nPriority (whenever / two weeks / yesterday):\nASAP. Unblocks Atlas releases on Timelock.", "createdAt": "2020-02-19T15:57:33Z", "url": "https://github.com/palantir/atlasdb/pull/4587", "merged": true, "mergeCommit": {"oid": "d61f8129014b48d41a7905fb2638adb9ff0c7eb9"}, "closed": true, "closedAt": "2020-02-19T16:59:08Z", "author": {"login": "felixdesouza"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcF3CNrAH2gAyMzc3MjM5OTUxOjRmNzRjMmZmNWYzMWI3ZjlhMzkxZWM3NDBhYWJlN2ZlYTcyYmQ4MmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcF5KgVAH2gAyMzc3MjM5OTUxOjg3MTgxZmRiODhiMTNmMzEyZGRjZjVhYWQxNDIxYTZmMDFhYmQzYTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f74c2ff5f31b7f9a391ec740aabe7fea72bd82b", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/4f74c2ff5f31b7f9a391ec740aabe7fea72bd82b", "committedDate": "2020-02-19T14:02:54Z", "message": "Pass BooleanSupplier everywhere to configure whether or not we should cancel remaining calls."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f239954a04eebfff87bd792ac8582e7841a238e0", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/f239954a04eebfff87bd792ac8582e7841a238e0", "committedDate": "2020-02-19T15:03:39Z", "message": "Wire the config through."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e1e73346ff2fdf6e5313cdc899f3746e138b506", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/7e1e73346ff2fdf6e5313cdc899f3746e138b506", "committedDate": "2020-02-19T15:21:44Z", "message": "Ensure it's fully wired through."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9bb03dd0c4098d6d98a9124f004d17b547a9379", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/b9bb03dd0c4098d6d98a9124f004d17b547a9379", "committedDate": "2020-02-19T15:21:44Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMjE4ODIx", "url": "https://github.com/palantir/atlasdb/pull/4587#pullrequestreview-361218821", "createdAt": "2020-02-19T16:06:45Z", "commit": {"oid": "b9bb03dd0c4098d6d98a9124f004d17b547a9379"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjowNjo0NVrOFrtNkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxNjowNjo0NVrOFrtNkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTM3Mzg0MA==", "bodyText": "nit: ok. I'd probably just not call this method if shouldCancel is false above, but this is fine.", "url": "https://github.com/palantir/atlasdb/pull/4587#discussion_r381373840", "createdAt": "2020-02-19T16:06:45Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosQuorumChecker.java", "diffHunk": "@@ -249,9 +243,11 @@ private static boolean timedOut(Future<?> responseFuture) {\n     }\n \n     private static <SERVICE, RESPONSE extends PaxosResponse> void cancelOutstandingRequestsAfterTimeout(\n+            boolean shouldCancel,\n             List<Future<Map.Entry<SERVICE, RESPONSE>>> responseFutures) {\n+\n         boolean areAllRequestsComplete = responseFutures.stream().allMatch(Future::isDone);\n-        if (areAllRequestsComplete) {\n+        if (!shouldCancel || areAllRequestsComplete) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9bb03dd0c4098d6d98a9124f004d17b547a9379"}, "originalPosition": 130}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c839448dc18a15d06e456a86b9025e9e40a5a60", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/0c839448dc18a15d06e456a86b9025e9e40a5a60", "committedDate": "2020-02-19T16:31:46Z", "message": "No live reloading, and if we're in timelock just introduce a constant."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87181fdb88b13f312ddcf5aad1421a6f01abd3a6", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/87181fdb88b13f312ddcf5aad1421a6f01abd3a6", "committedDate": "2020-02-19T16:31:46Z", "message": "CR comments."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2267, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}