{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYxODc5ODg2", "number": 4926, "title": "Fix duplicate registration of MetricPublicationFilters", "bodyText": "See internal ticket PG-154380\nPriority (whenever / two weeks / yesterday): ASAP", "createdAt": "2020-08-03T00:00:46Z", "url": "https://github.com/palantir/atlasdb/pull/4926", "merged": true, "mergeCommit": {"oid": "f2613753d9ad7d5075a0384bf601630eca962929"}, "closed": true, "closedAt": "2020-08-04T15:24:08Z", "author": {"login": "dxiao"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7GdXPgH2gAyNDYxODc5ODg2OjFhYTc3ZWNkNDEzYzljMjYzZWE2YjFiMmIzZDE1ZmYxOGUwZDQ4Yzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7m3cdAH2gAyNDYxODc5ODg2OjAwMTQ1YTY0YTUxN2NkODE5Njk4MmRiZDFkMzI3MjlmOWRhMDRiNzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1aa77ecd413c9c263ea6b1b2b3d15ff18e0d48c7", "author": {"user": null}, "url": "https://github.com/palantir/atlasdb/commit/1aa77ecd413c9c263ea6b1b2b3d15ff18e0d48c7", "committedDate": "2020-08-02T23:59:07Z", "message": "Fix duplicate registration of MetricPublicationFilters\n\nSee internal ticket PG-154380"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "327118def805cea867ab93558f2653c0bb858295", "author": {"user": null}, "url": "https://github.com/palantir/atlasdb/commit/327118def805cea867ab93558f2653c0bb858295", "committedDate": "2020-08-02T23:59:07Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d66e3e0ca8c6ff9bdf75602469d00a75cb2589b9", "author": {"user": null}, "url": "https://github.com/palantir/atlasdb/commit/d66e3e0ca8c6ff9bdf75602469d00a75cb2589b9", "committedDate": "2020-08-02T23:59:07Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjUxMTIy", "url": "https://github.com/palantir/atlasdb/pull/4926#pullrequestreview-460651122", "createdAt": "2020-08-04T09:32:12Z", "commit": {"oid": "327118def805cea867ab93558f2653c0bb858295"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNjU1Nzg0", "url": "https://github.com/palantir/atlasdb/pull/4926#pullrequestreview-460655784", "createdAt": "2020-08-04T09:38:42Z", "commit": {"oid": "d66e3e0ca8c6ff9bdf75602469d00a75cb2589b9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTozODo0MlrOG7Y8lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwOTozODo0MlrOG7Y8lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDkyNzg5NQ==", "bodyText": "I'll reshuffle things around a bit - this is a bit strange to keep on the API because DedupFilterHolder is private", "url": "https://github.com/palantir/atlasdb/pull/4926#discussion_r464927895", "createdAt": "2020-08-04T09:38:42Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/metrics/MetricPublicationArbiter.java", "diffHunk": "@@ -35,10 +38,10 @@\n public class MetricPublicationArbiter implements Predicate<MetricName> {\n     private static final Logger log = LoggerFactory.getLogger(MetricPublicationArbiter.class);\n \n-    private final Map<MetricName, List<MetricPublicationFilter>> singleMetricFilters;\n+    private final Map<MetricName, Set<DeduplicatingFilterHolder>> singleMetricFilters;\n \n     public MetricPublicationArbiter(\n-            Map<MetricName, List<MetricPublicationFilter>> singleMetricFilters) {\n+            Map<MetricName, Set<DeduplicatingFilterHolder>> singleMetricFilters) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d66e3e0ca8c6ff9bdf75602469d00a75cb2589b9"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b8c1f53f48190e892c4041df2367126263f0e17", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/4b8c1f53f48190e892c4041df2367126263f0e17", "committedDate": "2020-08-04T09:42:44Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45444d866b91b85ead6175ede5d31b6f2ebdec00", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/45444d866b91b85ead6175ede5d31b6f2ebdec00", "committedDate": "2020-08-04T09:42:54Z", "message": "Merge branch 'bugfix/dedup-metric-pub-filters' of github.com:palantir/atlasdb into bugfix/dedup-metric-pub-filters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42709c920c74a66733ebe092981fa74179dbccf0", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/42709c920c74a66733ebe092981fa74179dbccf0", "committedDate": "2020-08-04T10:13:17Z", "message": "baseline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5721a172a9e41f49207c79e7f60d84a551f4b8e3", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/5721a172a9e41f49207c79e7f60d84a551f4b8e3", "committedDate": "2020-08-04T12:33:01Z", "message": "rules"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9aefde2169ab7c3bac786e43b839a49604e8029", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/a9aefde2169ab7c3bac786e43b839a49604e8029", "committedDate": "2020-08-04T12:33:01Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNzc4MzEz", "url": "https://github.com/palantir/atlasdb/pull/4926#pullrequestreview-460778313", "createdAt": "2020-08-04T12:47:35Z", "commit": {"oid": "5721a172a9e41f49207c79e7f60d84a551f4b8e3"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMjo0NzozNVrOG7ezWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMjo1NDoyNFrOG7fDIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAyMzgzNQ==", "bodyText": "nit: If you're using ImmutableSet elsewhere, the ImmutableSet javadoc recommends:\nReturns an immutable set containing {@code element}. \nPreferred over {@link Collections#singleton} for code consistency, \n{@code null} rejection, and because the return type conveys the immutability guarantee.", "url": "https://github.com/palantir/atlasdb/pull/4926#discussion_r465023835", "createdAt": "2020-08-04T12:47:35Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/metrics/MetricPublicationArbiter.java", "diffHunk": "@@ -50,12 +59,14 @@ public boolean test(MetricName metricName) {\n     }\n \n     public void registerMetricsFilter(MetricName metricName, MetricPublicationFilter filter) {\n-        singleMetricFilters.merge(metricName, ImmutableList.of(filter), (oldFilters, newFilter)\n-                -> ImmutableList.<MetricPublicationFilter>builder().addAll(oldFilters).addAll(newFilter).build());\n+        singleMetricFilters.merge(metricName,\n+                Collections.singleton(new DeduplicatingFilterHolder(filter)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5721a172a9e41f49207c79e7f60d84a551f4b8e3"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAyNTY2Nw==", "bodyText": "Is there any reason why this does not use @Value.Immutable? As far as I can tell, the equality check is very similar to the Immutables one, if not exactly equivalent.", "url": "https://github.com/palantir/atlasdb/pull/4926#discussion_r465025667", "createdAt": "2020-08-04T12:50:42Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/metrics/MetricPublicationArbiter.java", "diffHunk": "@@ -69,4 +80,41 @@ private static boolean safeShouldPublish(MetricName metricName, MetricPublicatio\n             return true;\n         }\n     }\n+\n+    /**\n+     * Most users will want to define filters without having to think about deduplicating\n+     * filters across calls (similar to how MetricsRegistry methods are all registerOrGet)\n+     * so in order to keep the existing ability to define filters with lambdas,\n+     * define a default method on {@link MetricPublicationFilter} with a reasonable deduplicator\n+     * and then wrap it here.\n+     */\n+    @VisibleForTesting\n+    static class DeduplicatingFilterHolder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5721a172a9e41f49207c79e7f60d84a551f4b8e3"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAyNjU5MQ==", "bodyText": "This isn't used anywhere in AtlasDB itself - presumably it is exposed for users of Atlas?", "url": "https://github.com/palantir/atlasdb/pull/4926#discussion_r465026591", "createdAt": "2020-08-04T12:52:16Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/metrics/MetricPublicationFilter.java", "diffHunk": "@@ -23,4 +23,11 @@\n     MetricPublicationFilter NEVER_PUBLISH = () -> false;\n \n     boolean shouldPublish();\n+\n+    /**\n+     * @return A label which is used to deduplicate filters; it need only be unique across filters on a given metric.\n+     */\n+    default String getLabel() {\n+        return this.getClass().getName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5721a172a9e41f49207c79e7f60d84a551f4b8e3"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAyNjk2Nw==", "bodyText": "nit: Can we extract a constant for the () -> false and () -> true calls?", "url": "https://github.com/palantir/atlasdb/pull/4926#discussion_r465026967", "createdAt": "2020-08-04T12:52:55Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-api/src/test/java/com/palantir/atlasdb/metrics/MetricPublicationArbiterTest.java", "diffHunk": "@@ -43,18 +48,18 @@ public void metricsWithNoFilterAreAccepted() {\n \n     @Test\n     public void metricsWithOneFilterAreFiltered() {\n-        MetricPublicationArbiter arbiter = new MetricPublicationArbiter(ImmutableMap.of(\n-                METRIC_NAME_1, ImmutableList.of(() -> false),\n-                METRIC_NAME_2, ImmutableList.of(() -> true)));\n+        MetricPublicationArbiter arbiter = createArbiter(ImmutableMap.of(\n+                METRIC_NAME_1, ImmutableSet.of(() -> false),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5721a172a9e41f49207c79e7f60d84a551f4b8e3"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTAyNzg3Mg==", "bodyText": "nit: Not convinced we need or want this in the changelog.", "url": "https://github.com/palantir/atlasdb/pull/4926#discussion_r465027872", "createdAt": "2020-08-04T12:54:24Z", "author": {"login": "Jolyon-S"}, "path": "changelog/@unreleased/pr-4926.v2.yml", "diffHunk": "@@ -0,0 +1,8 @@\n+type: fix\n+fix:\n+  description: |-\n+    Fix duplicate registration of MetricPublicationFilters. Previously, the same filter could be registered multiple times leading to unnecessary evaluations.\n+\n+    See internal ticket PG-154380.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5721a172a9e41f49207c79e7f60d84a551f4b8e3"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c41e00448a7eef7dd2da9fc6284ddf8a9e8fd12", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/2c41e00448a7eef7dd2da9fc6284ddf8a9e8fd12", "committedDate": "2020-08-04T13:15:15Z", "message": "CR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f04e4dae5b59230987a9539fb70adec1c93b20a7", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/f04e4dae5b59230987a9539fb70adec1c93b20a7", "committedDate": "2020-08-04T13:25:52Z", "message": "Merge branch 'bugfix/dedup-metric-pub-filters' of github.com:palantir/atlasdb into bugfix/dedup-metric-pub-filters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00145a64a517cd8196982dbd1d32729f9da04b70", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/00145a64a517cd8196982dbd1d32729f9da04b70", "committedDate": "2020-08-04T13:44:34Z", "message": "Small changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2766, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}