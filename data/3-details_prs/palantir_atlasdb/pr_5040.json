{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0NzgyNTYy", "number": 5040, "title": "LockWatchManager#isEnabled.", "bodyText": "Goals (and why):\nImplementation Description (bullets):\nTesting (What was existing testing like?  What have you done to improve it?):\nConcerns (what feedback would you like?):\nWhere should we start reviewing?:\nPriority (whenever / two weeks / yesterday):", "createdAt": "2020-10-16T11:41:38Z", "url": "https://github.com/palantir/atlasdb/pull/5040", "merged": true, "mergeCommit": {"oid": "a344180578d11b1c6666c2e53b61f6d5f1e2f151"}, "closed": true, "closedAt": "2020-10-16T13:23:51Z", "author": {"login": "jkozlowski"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTE2jOAH2gAyNTA0NzgyNTYyOmM4YTY2NDZiYmE2MThhZDY3NWFhNzA1MTFkMTI2ZjY2ZTUyMDNmODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTGDzjgH2gAyNTA0NzgyNTYyOjdiNTNiZDg5NmI0OGIwYmUwZTAwNTM3MDk2ZTYwNTc4ZDQ1ZGQwNDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c8a6646bba618ad675aa70511d126f66e5203f88", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/c8a6646bba618ad675aa70511d126f66e5203f88", "committedDate": "2020-10-16T11:41:00Z", "message": "LockWatchManager#isEnabled."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/d56dbe8ef4f9a7acce2d5730ceee415704aa2549", "committedDate": "2020-10-16T11:41:00Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMzk5MDU4", "url": "https://github.com/palantir/atlasdb/pull/5040#pullrequestreview-510399058", "createdAt": "2020-10-16T11:54:03Z", "commit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTo1NDowNFrOHi4Ykw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTo1ODo0M1rOHi4oWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNzQyNw==", "bodyText": "Fix this changelog, please!", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506337427", "createdAt": "2020-10-16T11:54:04Z", "author": {"login": "Jolyon-S"}, "path": "changelog/@unreleased/pr-5040.v2.yml", "diffHunk": "@@ -0,0 +1,24 @@\n+type: improvement\n+improvement:\n+  description: |-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNzkyMg==", "bodyText": "This feels wrong - this should call down to LockWatchEventCacheImpl or NoOpLockWatchEventCache.", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506337922", "createdAt": "2020-10-16T11:54:40Z", "author": {"login": "Jolyon-S"}, "path": "lock-api/src/main/java/com/palantir/lock/watch/LockWatchEventCache.java", "diffHunk": "@@ -21,6 +21,11 @@\n import java.util.Set;\n \n public interface LockWatchEventCache {\n+\n+    default boolean isEnabled() {\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzODc1NA==", "bodyText": "do you mind expanding this test with hasMessage as there are a number of exceptions under that class (I know I am guilty of this too, but in an effort to make it clearer what we are testing, this should be done).", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506338754", "createdAt": "2020-10-16T11:55:31Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCacheTest.java", "diffHunk": "@@ -54,6 +56,21 @@ public void before() {\n         proxyCache = ResilientLockWatchEventCache.newProxyInstance(defaultCache, fallbackCache, metricsManager);\n     }\n \n+    @Test\n+    public void testCanDelegateIsEnabled() {\n+        assertThat(proxyCache.isEnabled()).isTrue();\n+\n+        RuntimeException runtimeException = new RuntimeException();\n+        when(defaultCache.getCommitUpdate(anyLong())).thenThrow(runtimeException);\n+        assertThatThrownBy(() -> proxyCache.getCommitUpdate(0L)).hasCause(runtimeException)\n+                .isExactlyInstanceOf(TransactionLockWatchFailedException.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzOTc3Ng==", "bodyText": "Why is this necessary? Also, if we're going to default to anything, wouldn't it be better to be false? I still think this should just be:\nboolean isEnabled;", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506339776", "createdAt": "2020-10-16T11:56:40Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManager.java", "diffHunk": "@@ -34,6 +34,10 @@\n \n     // These methods are hidden on purpose as they should not be generally available, only for brave souls!\n \n+    boolean isEnabled() {\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0MDg5OA==", "bodyText": "Oh I see - you went with an approach entirely through the proxy. I'm not sure I like that really - surely the logic is 100x cleaner just by doing what you originally said, i.e. having LWECI return true and NOLWEC return false?", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506340898", "createdAt": "2020-10-16T11:58:01Z", "author": {"login": "Jolyon-S"}, "path": "lock-api/src/main/java/com/palantir/lock/watch/LockWatchEventCache.java", "diffHunk": "@@ -21,6 +21,11 @@\n import java.util.Set;\n \n public interface LockWatchEventCache {\n+\n+    default boolean isEnabled() {\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNzkyMg=="}, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0MTQ2NA==", "bodyText": "I don't really like this - I much prefer just implementing in LWECI and NOLWEC as I feel it is less error prone, and doing this kind of proxy-wrangling is abusing the whole point of it IMO.", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506341464", "createdAt": "2020-10-16T11:58:43Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCache.java", "diffHunk": "@@ -34,6 +34,15 @@\n final class ResilientLockWatchEventCache extends AbstractInvocationHandler {\n \n     private static final Logger log = LoggerFactory.getLogger(ResilientLockWatchEventCache.class);\n+    private static final Method IS_ENABLED;\n+\n+    static {\n+        try {\n+            IS_ENABLED = LockWatchEventCache.class.getMethod(\"isEnabled\");\n+        } catch (NoSuchMethodException e) {\n+            throw new RuntimeException(\"Did someone rename this method?\", e);\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8036d9362a044912509873586ac0564257631730", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/8036d9362a044912509873586ac0564257631730", "committedDate": "2020-10-16T12:56:15Z", "message": "Revert proxy impl."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c139ffa23d096724dbcbff8b0ef6501cebf9f47", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/5c139ffa23d096724dbcbff8b0ef6501cebf9f47", "committedDate": "2020-10-16T12:56:37Z", "message": "Fix changelog."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNDQ4MTc1", "url": "https://github.com/palantir/atlasdb/pull/5040#pullrequestreview-510448175", "createdAt": "2020-10-16T13:04:38Z", "commit": {"oid": "5c139ffa23d096724dbcbff8b0ef6501cebf9f47"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b53bd896b48b0be0e00537096e60578d45dd040", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/7b53bd896b48b0be0e00537096e60578d45dd040", "committedDate": "2020-10-16T13:05:23Z", "message": "Fixup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2658, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}