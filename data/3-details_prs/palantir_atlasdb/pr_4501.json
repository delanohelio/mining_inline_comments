{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNDQ3NDAx", "number": 4501, "title": "[LW] Prequel to Part 5: VersionedLockWatchState and small fixes", "bodyText": "Goals (and why):\nIn order to simplify the currently open PRs, take out the various refactors and VersionedLockWatchState to reduce the clutter\nImplementation Description (bullets):\nAdd serialisation to the classes that need it, add the token information and request id to events that need them. Define VersionedLockWatchState and implement it.\nTesting (What was existing testing like?  What have you done to improve it?):\nExisting tests, the isn't much to test here\nConcerns (what feedback would you like?):\nThis should be pretty simple", "createdAt": "2020-01-10T13:20:56Z", "url": "https://github.com/palantir/atlasdb/pull/4501", "merged": true, "mergeCommit": {"oid": "33c49367b7b6eb370429d35e6a32b445484cd2ee"}, "closed": true, "closedAt": "2020-01-13T10:46:20Z", "author": {"login": "gmaretic"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4-HeZAH2gAyMzYxNDQ3NDAxOjM4MmFkZjQ3YjIxNGUyYmE3OTEyYjY0MmY0ZTUzMTJhODI4MGQ2ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb5CWfHgFqTM0MTMyNDk1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "382adf47b214e2ba7912b642f4e5312a8280d688", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/382adf47b214e2ba7912b642f4e5312a8280d688", "committedDate": "2020-01-10T12:56:58Z", "message": "Get the trivial stuff out of the way"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "060cefe0e90ae98736b388912e75a64f34329eb4", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/060cefe0e90ae98736b388912e75a64f34329eb4", "committedDate": "2020-01-10T13:17:16Z", "message": "Add last update to VLWS, fix matchers in tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMTcxMDU0", "url": "https://github.com/palantir/atlasdb/pull/4501#pullrequestreview-341171054", "createdAt": "2020-01-10T13:47:12Z", "commit": {"oid": "060cefe0e90ae98736b388912e75a64f34329eb4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxMzo0NzoxMlrOFcUgxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxMzo1MTowMVrOFcUnaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI0MDUxOA==", "bodyText": "I normally thought we specify the abstract rather than the concrete implementations of these as the sub-types (e.g. LockEvent as opposed to ImmutableLockEvent. Not wrong, but technically if you change the @JsonSerialize(as = Bla.class) in LockEvent it won't be respected.", "url": "https://github.com/palantir/atlasdb/pull/4501#discussion_r365240518", "createdAt": "2020-01-10T13:47:12Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/watch/LockWatchEvent.java", "diffHunk": "@@ -16,11 +16,28 @@\n \n package com.palantir.lock.watch;\n \n+import com.fasterxml.jackson.annotation.JsonSubTypes;\n+import com.fasterxml.jackson.annotation.JsonTypeInfo;\n+\n+@JsonTypeInfo(use = JsonTypeInfo.Id.NAME, property = \"type\")\n+@JsonSubTypes({\n+        @JsonSubTypes.Type(value = ImmutableLockEvent.class, name = LockEvent.TYPE),\n+        @JsonSubTypes.Type(value = ImmutableUnlockEvent.class, name = UnlockEvent.TYPE),\n+        @JsonSubTypes.Type(value = ImmutableLockWatchOpenLocksEvent.class, name = LockWatchOpenLocksEvent.TYPE),\n+        @JsonSubTypes.Type(value = ImmutableLockWatchCreatedEvent.class, name = LockWatchCreatedEvent.TYPE)})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "060cefe0e90ae98736b388912e75a64f34329eb4"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI0MjIxNg==", "bodyText": "Some JavaDoc may be useful as it's not clear what an OpenLocks operation is (compared to Lock and Unlock, which are pretty clear). Maybe something like:\n\nA LockWatchOpenLocksEvent captures the state of all lock descriptors for a given lock watch that are currently open (that is, held by clients).", "url": "https://github.com/palantir/atlasdb/pull/4501#discussion_r365242216", "createdAt": "2020-01-10T13:51:01Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/watch/LockWatchOpenLocksEvent.java", "diffHunk": "@@ -17,24 +17,40 @@\n package com.palantir.lock.watch;\n \n import java.util.Set;\n+import java.util.UUID;\n \n import org.immutables.value.Value;\n \n+import com.fasterxml.jackson.annotation.JsonTypeName;\n+import com.fasterxml.jackson.databind.annotation.JsonDeserialize;\n+import com.fasterxml.jackson.databind.annotation.JsonSerialize;\n import com.palantir.lock.LockDescriptor;\n \n @Value.Immutable\n @Value.Style(visibility = Value.Style.ImplementationVisibility.PACKAGE)\n+@JsonSerialize(as = ImmutableLockWatchOpenLocksEvent.class)\n+@JsonDeserialize(as = ImmutableLockWatchOpenLocksEvent.class)\n+@JsonTypeName(LockWatchOpenLocksEvent.TYPE)\n public abstract class LockWatchOpenLocksEvent implements LockWatchEvent {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "060cefe0e90ae98736b388912e75a64f34329eb4"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00c2e4e658b9d9931446f8922cb5129f3ab15a61", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/00c2e4e658b9d9931446f8922cb5129f3ab15a61", "committedDate": "2020-01-10T16:01:21Z", "message": "Address CR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMzI0OTUy", "url": "https://github.com/palantir/atlasdb/pull/4501#pullrequestreview-341324952", "createdAt": "2020-01-10T17:52:59Z", "commit": {"oid": "00c2e4e658b9d9931446f8922cb5129f3ab15a61"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2364, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}