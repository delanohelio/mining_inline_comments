{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyNTYyNTgy", "number": 5146, "title": "[LW] [PDS-148088] Close your eyes", "bodyText": "Goals (and why):\nNow only watch the tables we request, as opposed to a union of all tables requested to watch\nImplementation Description (bullets):\nClear, then add all.\nTesting (What was existing testing like?  What have you done to improve it?):\nTest this case. The test fails if I remove my change.\nConcerns (what feedback would you like?):\nRace condition? Should only be called within the txn manager, and since atlasdb-proxy only does that in a B/G task in a single-threaded way, should not be a concern.\nWhere should we start reviewing?:\nLockWatchManagerImpl.\nPriority (whenever / two weeks / yesterday):\nyesterday \ud83d\udd25", "createdAt": "2020-12-04T14:17:31Z", "url": "https://github.com/palantir/atlasdb/pull/5146", "merged": true, "mergeCommit": {"oid": "fbe1c0720fa08b5c33ba425536d5c0a0126a2a7b"}, "closed": true, "closedAt": "2020-12-04T14:56:39Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdi4Y-_AH2gAyNTMyNTYyNTgyOjU2NWJjNjFmNmM0MWZlNTg2MTg0NWQ5NzM5MzQ2ZmYyNDU0M2Y0NmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi4y8HgFqTU0NTAxNjI5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "565bc61f6c41fe5861845d9739346ff24543f46c", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/565bc61f6c41fe5861845d9739346ff24543f46c", "committedDate": "2020-12-04T14:12:38Z", "message": "fun fun fun and games"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90b151b6c0b764339bf3e3a6864bdc119df2ae5a", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/90b151b6c0b764339bf3e3a6864bdc119df2ae5a", "committedDate": "2020-12-04T14:14:03Z", "message": "hahah"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91703b21c45509476995f4023198fd8a48f99554", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/91703b21c45509476995f4023198fd8a48f99554", "committedDate": "2020-12-04T14:14:03Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MDAzNDE2", "url": "https://github.com/palantir/atlasdb/pull/5146#pullrequestreview-545003416", "createdAt": "2020-12-04T14:26:10Z", "commit": {"oid": "91703b21c45509476995f4023198fd8a48f99554"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDoyNjoxMFrOH_TKwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDoyODowOFrOH_TQTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEzNjM4NA==", "bodyText": "I'd probably re-phrase this in terms of what the client sees (i.e. the impl details are not needed, I think the last part is the key here - The LockWatchManager now only re-registers the latest set of requested watches when TimeLock is bounced).", "url": "https://github.com/palantir/atlasdb/pull/5146#discussion_r536136384", "createdAt": "2020-12-04T14:26:10Z", "author": {"login": "jeremyk-91"}, "path": "changelog/@unreleased/pr-5146.v2.yml", "diffHunk": "@@ -0,0 +1,9 @@\n+type: fix\n+fix:\n+  description: Calling registerWatches now tells the lockWatchManager to _only_ watch\n+    those watches, instead of adding it to the set of all registered watches so far.\n+    Note that this does not affect Timelock (which will still contain all watches\n+    registered so far), but rolling Timelock will mean that the LockWatchManager now\n+    only re-registers the latest requested watches.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91703b21c45509476995f4023198fd8a48f99554"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEzNzgwNw==", "bodyText": "the way this works in combination with the javadoc is strange (it seems like register should definitely be commutative and distributive over union based on its javadoc; that it's not is a bit weird and so needs calling out I think, at least internally). I'd suggest we either\n\nkeep this endpoint the way it is, and have a new endpoint called registerPreciselyWatches or something like that that makes it apparent that the client will no longer request previously registered things to be watched.\nor just rename this to registerPreciselyWatches, if the previous behaviour is not used anywhere", "url": "https://github.com/palantir/atlasdb/pull/5146#discussion_r536137807", "createdAt": "2020-12-04T14:28:08Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManagerImpl.java", "diffHunk": "@@ -70,6 +70,7 @@ public void close() {\n \n     @Override\n     public void registerWatches(Set<LockWatchReferences.LockWatchReference> newLockWatches) {\n+        lockWatchReferences.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91703b21c45509476995f4023198fd8a48f99554"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91def0dad097368b811e0e8998aa029aa76a91bc", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/91def0dad097368b811e0e8998aa029aa76a91bc", "committedDate": "2020-12-04T14:39:38Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a49646eb301cb0c49499bd0297bf75542fad8fb", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/4a49646eb301cb0c49499bd0297bf75542fad8fb", "committedDate": "2020-12-04T14:39:51Z", "message": "Merge branch 'not-add-all' of github.com:palantir/atlasdb into not-add-all"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7b67550606db8507975a769255815a1c1aedebb", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/f7b67550606db8507975a769255815a1c1aedebb", "committedDate": "2020-12-04T14:39:51Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MDE2Mjk1", "url": "https://github.com/palantir/atlasdb/pull/5146#pullrequestreview-545016295", "createdAt": "2020-12-04T14:40:59Z", "commit": {"oid": "91703b21c45509476995f4023198fd8a48f99554"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2537, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}