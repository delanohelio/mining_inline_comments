{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5ODQ4NzA3", "number": 4974, "title": "Leader election slos", "bodyText": "Goals (and why):\nFix bug with leader election rate health check. The health check should be analyzing the metrics per client.\nImplementation Description (bullets):\n\n\nRegister client wise metrics to leader election rate health check.\n\n\nLeader election health check performs analysis on the sum of rates of all clients\n\n\nTesting (What was existing testing like?  What have you done to improve it?):\nTested on internal testing environment\nConcerns (what feedback would you like?):\nDoes the wiring make sense?\nWhere should we start reviewing?:\nLeaderElectionHealthCheck.java, TimeLockAgent.java\nPriority (whenever / two weeks / yesterday):\nAs soon as possible \ud83d\udd25", "createdAt": "2020-09-04T16:18:38Z", "url": "https://github.com/palantir/atlasdb/pull/4974", "merged": true, "mergeCommit": {"oid": "0a6c4e138b847159a85225c08e84f73d70dd8c15"}, "closed": true, "closedAt": "2020-09-09T13:20:16Z", "author": {"login": "sudiksha27"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFgic9gH2gAyNDc5ODQ4NzA3OjQ2OTUwOTBhM2Q1NDVjMzY3Mjk0ZTk5MmNhZDI2YzQzZjYyNjEwZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHKm81AH2gAyNDc5ODQ4NzA3OjRhNjdiNTc5ZmUzMjZiYWZhMzk5ZTNkYmRhZTcyNWEwZjAwY2M3Yjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4695090a3d545c367294e992cad26c43f62610d1", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/4695090a3d545c367294e992cad26c43f62610d1", "committedDate": "2020-09-04T08:01:27Z", "message": "major bug fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eda8c7e34786ab8699ccfad797561df32625e4c", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/4eda8c7e34786ab8699ccfad797561df32625e4c", "committedDate": "2020-09-04T09:39:49Z", "message": "My experiments with TimeLock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7131447215d279c6414f916401301354f9191f68", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/7131447215d279c6414f916401301354f9191f68", "committedDate": "2020-09-04T10:02:30Z", "message": "format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "550bb1591d3c3d076b13c8761f499442b8fa2f2d", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/550bb1591d3c3d076b13c8761f499442b8fa2f2d", "committedDate": "2020-09-04T10:33:37Z", "message": "clean up 1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c711142a23a526d8b89f92581cb32ac90c707711", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/c711142a23a526d8b89f92581cb32ac90c707711", "committedDate": "2020-09-04T11:31:05Z", "message": "Refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0c95df5db1ad553d68c038b51ec9a3f6dc47e8f", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/f0c95df5db1ad553d68c038b51ec9a3f6dc47e8f", "committedDate": "2020-09-04T12:55:50Z", "message": "Wire"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9093f896f403196e0f3375c46fb20d9eab54792a", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/9093f896f403196e0f3375c46fb20d9eab54792a", "committedDate": "2020-09-04T13:35:44Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6f7ff19c6c3525ba516fe73c376fe3635d05fb2", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/a6f7ff19c6c3525ba516fe73c376fe3635d05fb2", "committedDate": "2020-09-04T13:51:35Z", "message": "Refactor + cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f388698206174f1cbfaee6cc8476013ea76266d", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/2f388698206174f1cbfaee6cc8476013ea76266d", "committedDate": "2020-09-04T13:58:50Z", "message": "Minor refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c37c6a2642babfe743b81eb84560e0375730c864", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/c37c6a2642babfe743b81eb84560e0375730c864", "committedDate": "2020-09-04T13:58:50Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f623a18ce6ec0910fee42ff2f8407de98789a049", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/f623a18ce6ec0910fee42ff2f8407de98789a049", "committedDate": "2020-09-04T13:58:50Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MDA4MDk1", "url": "https://github.com/palantir/atlasdb/pull/4974#pullrequestreview-484008095", "createdAt": "2020-09-08T10:37:15Z", "commit": {"oid": "c37c6a2642babfe743b81eb84560e0375730c864"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDozNzoxNVrOHOXCWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMDo1Nzo0NFrOHOXruA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgxOTU0NQ==", "bodyText": "nit: fix", "url": "https://github.com/palantir/atlasdb/pull/4974#discussion_r484819545", "createdAt": "2020-09-08T10:37:15Z", "author": {"login": "gmaretic"}, "path": "changelog/@unreleased/pr-4974.v2.yml", "diffHunk": "@@ -0,0 +1,6 @@\n+type: improvement", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c37c6a2642babfe743b81eb84560e0375730c864"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgxOTc2Mw==", "bodyText": "fine tuning? :D", "url": "https://github.com/palantir/atlasdb/pull/4974#discussion_r484819763", "createdAt": "2020-09-08T10:37:41Z", "author": {"login": "gmaretic"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/health/LeaderElectionHealthCheck.java", "diffHunk": "@@ -16,19 +16,33 @@\n \n package com.palantir.leader.health;\n \n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+\n import com.palantir.leader.LeaderElectionServiceMetrics;\n+import com.palantir.paxos.Client;\n \n public class LeaderElectionHealthCheck {\n-    private static final double MAX_ALLOWED_LAST_5_MINUTE_RATE = 0.016;\n+    private static final double MAX_ALLOWED_LAST_5_MINUTE_RATE = 0.015;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c37c6a2642babfe743b81eb84560e0375730c864"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyMDA0OQ==", "bodyText": "nit: one line, and extra newline", "url": "https://github.com/palantir/atlasdb/pull/4974#discussion_r484820049", "createdAt": "2020-09-08T10:38:14Z", "author": {"login": "gmaretic"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/health/LeaderElectionHealthCheck.java", "diffHunk": "@@ -16,19 +16,33 @@\n \n package com.palantir.leader.health;\n \n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+\n import com.palantir.leader.LeaderElectionServiceMetrics;\n+import com.palantir.paxos.Client;\n \n public class LeaderElectionHealthCheck {\n-    private static final double MAX_ALLOWED_LAST_5_MINUTE_RATE = 0.016;\n+    private static final double MAX_ALLOWED_LAST_5_MINUTE_RATE = 0.015;\n+    private final ConcurrentMap<Client, LeaderElectionServiceMetrics> clientWiseMetrics\n+            = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c37c6a2642babfe743b81eb84560e0375730c864"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgyMDQ2Nw==", "bodyText": "nit: one line", "url": "https://github.com/palantir/atlasdb/pull/4974#discussion_r484820467", "createdAt": "2020-09-08T10:39:03Z", "author": {"login": "gmaretic"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/health/LeaderElectionHealthCheck.java", "diffHunk": "@@ -16,19 +16,33 @@\n \n package com.palantir.leader.health;\n \n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.ConcurrentMap;\n+\n import com.palantir.leader.LeaderElectionServiceMetrics;\n+import com.palantir.paxos.Client;\n \n public class LeaderElectionHealthCheck {\n-    private static final double MAX_ALLOWED_LAST_5_MINUTE_RATE = 0.016;\n+    private static final double MAX_ALLOWED_LAST_5_MINUTE_RATE = 0.015;\n+    private final ConcurrentMap<Client, LeaderElectionServiceMetrics> clientWiseMetrics\n+            = new ConcurrentHashMap<>();\n+\n \n-    private final LeaderElectionServiceMetrics leaderElectionServiceMetrics;\n+    public void registerClient(Client namespace,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c37c6a2642babfe743b81eb84560e0375730c864"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDgzMDEzNg==", "bodyText": "Add a test with multiple clients", "url": "https://github.com/palantir/atlasdb/pull/4974#discussion_r484830136", "createdAt": "2020-09-08T10:57:44Z", "author": {"login": "gmaretic"}, "path": "leader-election-impl/src/test/java/com/palantir/leader/LeadershipElectionCheckTest.java", "diffHunk": "@@ -33,40 +33,41 @@\n import com.codahale.metrics.Meter;\n import com.palantir.leader.health.LeaderElectionHealthCheck;\n import com.palantir.leader.health.LeaderElectionHealthStatus;\n+import com.palantir.paxos.Client;\n import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n \n public class LeadershipElectionCheckTest {\n     private final FakeTimeClock fakeTimeClock = new FakeTimeClock();\n     private final TaggedMetricRegistry registry = mock(TaggedMetricRegistry.class);\n     private final LeaderElectionServiceMetrics leaderElectionServiceMetrics =\n             LeaderElectionServiceMetrics.of(registry);\n-    private final LeaderElectionHealthCheck leaderElectionHealthCheck =\n-            new LeaderElectionHealthCheck(leaderElectionServiceMetrics);\n+    private final LeaderElectionHealthCheck leaderElectionHealthCheck = new LeaderElectionHealthCheck();\n+    private static final Client CLIENT = Client.of(\"abc\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c37c6a2642babfe743b81eb84560e0375730c864"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08ebe2b8bfedd10386466e72d27de246275f697b", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/08ebe2b8bfedd10386466e72d27de246275f697b", "committedDate": "2020-09-09T11:26:27Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d2ce3c8a7768852a673bee174785fe3da642d2c", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/7d2ce3c8a7768852a673bee174785fe3da642d2c", "committedDate": "2020-09-09T11:29:48Z", "message": "Spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a67b579fe326bafa399e3dbdae725a0f00cc7b8", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/4a67b579fe326bafa399e3dbdae725a0f00cc7b8", "committedDate": "2020-09-09T11:36:18Z", "message": "Checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2559, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}