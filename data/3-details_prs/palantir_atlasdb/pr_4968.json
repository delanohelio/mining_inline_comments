{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1NjA4MjYz", "number": 4968, "title": "Transaction#markTableInvolved.", "bodyText": "Goals (and why):\nSometimes tables will be read out of bounds (LW with tracking of reads external to atlasdb). In that situation we need to be able to not skip certain checks that are ordinarily done on reads.\nImplementation Description (bullets):\nTransaction#markTableInvolved effectively does first part of a read, without doing immutable timestamp lock checks. Those are only done IFF the transaction did no reads at all, so this feature is effectively free for transactions that did any reads.\nTesting (What was existing testing like?  What have you done to improve it?):\nOnly in AbstractSerializableTransactionTest.java, because that's the test I have most experience with. I know there's SnapshotTransactionTest, which feels somewhat similar, so would be interested in feedback.\nConcerns (what feedback would you like?):\nShould I add some more testing somewhere? I did not add a test for transaction timeouts simply because transactions do System.currentTimeMillis, and I didn't feel like refactoring that.\nWhere should we start reviewing?:\nPriority (whenever / two weeks / yesterday):", "createdAt": "2020-08-28T19:38:59Z", "url": "https://github.com/palantir/atlasdb/pull/4968", "merged": true, "mergeCommit": {"oid": "899605756ef77204a05782c6757c40dcf4848c3f"}, "closed": true, "closedAt": "2020-09-17T14:30:12Z", "author": {"login": "jkozlowski"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJYmafAH2gAyNDc1NjA4MjYzOmU5OGIwM2Q4MTFkNmJhNWYzYTM0ZTVkMzk5Y2I3MWRhODM1OTcwOTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJx25kAFqTQ5MDY1NzIxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e98b03d811d6ba5f3a34e5d399cb71da83597094", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/e98b03d811d6ba5f3a34e5d399cb71da83597094", "committedDate": "2020-09-16T09:02:14Z", "message": "Add initial tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de74c0f3634e1f2da2fa65ed917ace0802e15c77", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/de74c0f3634e1f2da2fa65ed917ace0802e15c77", "committedDate": "2020-09-16T09:58:58Z", "message": "Fixup and final tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e14aa54e6e12ab26821ccddfd9a718a0ce3996f0", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/e14aa54e6e12ab26821ccddfd9a718a0ce3996f0", "committedDate": "2020-09-16T09:58:58Z", "message": "Add generated changelog entries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea47c29e07a3d4d37137971b62d3162907a33af1", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/ea47c29e07a3d4d37137971b62d3162907a33af1", "committedDate": "2020-08-28T19:35:49Z", "message": "Transaction#markTableRead."}, "afterCommit": {"oid": "de74c0f3634e1f2da2fa65ed917ace0802e15c77", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/de74c0f3634e1f2da2fa65ed917ace0802e15c77", "committedDate": "2020-09-16T09:58:58Z", "message": "Fixup and final tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NjE2Mzgy", "url": "https://github.com/palantir/atlasdb/pull/4968#pullrequestreview-489616382", "createdAt": "2020-09-16T13:20:04Z", "commit": {"oid": "e14aa54e6e12ab26821ccddfd9a718a0ce3996f0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMzoyMDowNFrOHSwenw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMzoyMDowNFrOHSwenw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQzMDY4Nw==", "bodyText": "Actually this should take into account if they're thorough or not, gimme a sec...", "url": "https://github.com/palantir/atlasdb/pull/4968#discussion_r489430687", "createdAt": "2020-09-16T13:20:04Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -1629,13 +1635,13 @@ private void checkConstraints() {\n \n     private void commitWrites(TransactionService transactionService) {\n         if (!hasWrites()) {\n-            if (hasReads()) {\n+            if (hasReads() || hasAnyInvolvedTables()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14aa54e6e12ab26821ccddfd9a718a0ce3996f0"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc6150760459d9c147a07c919b1c5840f4665092", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/fc6150760459d9c147a07c919b1c5840f4665092", "committedDate": "2020-09-16T13:43:55Z", "message": "Small tweak to account for thorough/not thorough + tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d454acfe867d283ee999ef08948e09db2857f464", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/d454acfe867d283ee999ef08948e09db2857f464", "committedDate": "2020-09-16T14:13:55Z", "message": "Fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NjU1MzYy", "url": "https://github.com/palantir/atlasdb/pull/4968#pullrequestreview-489655362", "createdAt": "2020-09-16T13:59:13Z", "commit": {"oid": "fc6150760459d9c147a07c919b1c5840f4665092"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMzo1OToxNFrOHSyQvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNDo0NjoyOVrOHS0eJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ1OTkwMw==", "bodyText": "Since this is private, do we really need the parameter? Seems like we should just call hasReads() in here", "url": "https://github.com/palantir/atlasdb/pull/4968#discussion_r489459903", "createdAt": "2020-09-16T13:59:14Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -2384,13 +2386,22 @@ public void useTable(TableReference tableRef, ConstraintCheckable table) {\n     /** The similarly-named-and-intentioned useTable method is only called on writes.\n      *  This one is more comprehensive and covers read paths as well\n      * (necessary because we wish to get the sweep strategies of tables in read-only transactions)\n+     *\n+     * A table can be involved in a transaction, even if there were no reads done on it, see #markTableInvolved.\n      */\n     private void markTableAsInvolvedInThisTransaction(TableReference tableRef) {\n         involvedTables.add(tableRef);\n     }\n \n-    private boolean validationNecessaryForInvolvedTablesOnCommit() {\n-        return involvedTables.stream().anyMatch(this::isValidationNecessaryOnCommit);\n+    private boolean hasAnyInvolvedTables() {\n+        return !involvedTables.isEmpty();\n+    }\n+\n+    private boolean validationNecessaryForInvolvedTablesOnCommit(boolean hasReads) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc6150760459d9c147a07c919b1c5840f4665092"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ4NjY5Nw==", "bodyText": "So we validate if there's an interesting table AND either there were no reads (because lock watches), or validate locks on reads was false.\nThere are potentially cases where this might behave differently from the original:\nuser reads table A, checks lock\n<loses immutable timestamp lock>\nuser reads table B via notifications, marked B as used\ntxn.commit()\n\nThis would previously throw, but now reads the value from the cache, which is fine - the goal of the immutable timestamp lock is resilience against a delete clearing the value we want out from under us by Thorough Sweep.\nIs the above understanding correct? May be good to have a quick check with @gmaretic here", "url": "https://github.com/palantir/atlasdb/pull/4968#discussion_r489486697", "createdAt": "2020-09-16T14:34:26Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -2384,13 +2386,22 @@ public void useTable(TableReference tableRef, ConstraintCheckable table) {\n     /** The similarly-named-and-intentioned useTable method is only called on writes.\n      *  This one is more comprehensive and covers read paths as well\n      * (necessary because we wish to get the sweep strategies of tables in read-only transactions)\n+     *\n+     * A table can be involved in a transaction, even if there were no reads done on it, see #markTableInvolved.\n      */\n     private void markTableAsInvolvedInThisTransaction(TableReference tableRef) {\n         involvedTables.add(tableRef);\n     }\n \n+    private boolean hasAnyInvolvedTables() {\n+        return !involvedTables.isEmpty();\n+    }\n+\n     private boolean validationNecessaryForInvolvedTablesOnCommit() {\n-        return involvedTables.stream().anyMatch(this::isValidationNecessaryOnCommit);\n+        boolean anyTableRequiresImmutableTimestampLocking = involvedTables.stream().anyMatch(\n+                this::requiresImmutableTimestampLocking);\n+        boolean needsToValidate = !validateLocksOnReads || !hasReads();\n+        return anyTableRequiresImmutableTimestampLocking && needsToValidate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d454acfe867d283ee999ef08948e09db2857f464"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ5NjEwMA==", "bodyText": "Might be good to have a bit more detail here (in particular, don't use this unless you really know what you're doing type of warnings)", "url": "https://github.com/palantir/atlasdb/pull/4968#discussion_r489496100", "createdAt": "2020-09-16T14:46:29Z", "author": {"login": "jeremyk-91"}, "path": "changelog/@unreleased/pr-4968.v2.yml", "diffHunk": "@@ -0,0 +1,5 @@\n+type: improvement\n+improvement:\n+  description: Transaction#markTableInvolved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d454acfe867d283ee999ef08948e09db2857f464"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9ea3174a7e477dc764173230f2102a6dad6c4aa", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/c9ea3174a7e477dc764173230f2102a6dad6c4aa", "committedDate": "2020-09-17T06:31:12Z", "message": "Autorelease 0.247.1-rc1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd22b0b397e7caf436db8d343d3bb430b621de6d", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/bd22b0b397e7caf436db8d343d3bb430b621de6d", "committedDate": "2020-09-17T06:33:26Z", "message": "Fixup changelog."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNjU3MjE3", "url": "https://github.com/palantir/atlasdb/pull/4968#pullrequestreview-490657217", "createdAt": "2020-09-17T14:27:52Z", "commit": {"oid": "bd22b0b397e7caf436db8d343d3bb430b621de6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2552, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}