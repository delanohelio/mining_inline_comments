{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1ODc4MjUz", "number": 4687, "title": "getRowsColumnRange always has cells grouped by row", "bodyText": "Ensure that throughout the iterator manipulation that happens\ninternally to getRowsColumnRange that we maintain the invariant\nthat all cells for a given row will be grouped together at the end.\nGoals (and why):\nAfter #4668 (though maybe before as well if the BatchSizeIncreasingIterator didn't kick in?), getRowsColumnRange could return an iterator where the cells for a given row are not always grouped together, which could break assumptions made by clients.\nImplementation Description (bullets):\nTwo potential implementation options, and I'm curious what people think is cleanest: we can sort the rows passed in, so that they're in the same order that we internally sort Cells in, or we should purely rely on the ordering provided by the KVS.\nTesting (What was existing testing like?  What have you done to improve it?):\nChanging the existing tests to shuffle the order of rows passed in, which was enough to break things somewhat. But that combined with having rows not have a cell count that's a multiple of the number of the batch size is where the test demonstrates what could could actually go bad.\nConcerns (what feedback would you like?):\nWhat option to fix this is cleanest?\nWhere should we start reviewing?:\nPriority (whenever / two weeks / yesterday):", "createdAt": "2020-03-30T20:19:33Z", "url": "https://github.com/palantir/atlasdb/pull/4687", "merged": true, "mergeCommit": {"oid": "e1ac1aca5e3795f328fa5a52face7d697a86cc81"}, "closed": true, "closedAt": "2020-04-01T17:55:54Z", "author": {"login": "mswintermeyer"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS0KrpgH2gAyMzk1ODc4MjUzOjZiOTdjNjlhMWNjOGQ0MTYyZTA2OTlhOGJmY2QzNWViYWY0OGJmOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTbYV0AH2gAyMzk1ODc4MjUzOjJjMjgwYmIwODFjNDExYzNlZDZkODBmMWQyNzUyMjNhMzFkY2YxNTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6b97c69a1cc8d4162e0699a8bfcd35ebaf48bf99", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/6b97c69a1cc8d4162e0699a8bfcd35ebaf48bf99", "committedDate": "2020-03-30T20:03:27Z", "message": "getRowsColumnRange always has cells grouped by row\n\nEnsure that throughout the iterator manipulation that happens\ninternally to getRowsColumnRange that we maintain the invariant\nthat all cells for a given row will be grouped together at the end."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9e503a192b731b17bea50c52ee3feff3c1b90ff", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/b9e503a192b731b17bea50c52ee3feff3c1b90ff", "committedDate": "2020-03-31T01:20:12Z", "message": "Preserve original row ordering"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1aedd2b1667caaf89db64e34000044e222cb22d", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/a1aedd2b1667caaf89db64e34000044e222cb22d", "committedDate": "2020-03-31T13:56:32Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb0025a69ea8d9b42267d17cf9b9a895266a7d1f", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/eb0025a69ea8d9b42267d17cf9b9a895266a7d1f", "committedDate": "2020-03-31T13:56:32Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ec084ab344940744d5d978bed28f44039c09982", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/1ec084ab344940744d5d978bed28f44039c09982", "committedDate": "2020-03-31T13:56:32Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0ODk0NzA5", "url": "https://github.com/palantir/atlasdb/pull/4687#pullrequestreview-384894709", "createdAt": "2020-03-31T16:17:10Z", "commit": {"oid": "a1aedd2b1667caaf89db64e34000044e222cb22d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjoxNzoxMFrOF-dqtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjoxNzoxMFrOF-dqtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA0MjEwMg==", "bodyText": "this refactor is unnecessary - ImmutableMap is in insertion order", "url": "https://github.com/palantir/atlasdb/pull/4687#discussion_r401042102", "createdAt": "2020-03-31T16:17:10Z", "author": {"login": "j-baker"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -476,19 +477,19 @@ public void disableReadWriteConflictChecking(TableReference tableRef) {\n     private Iterator<Map.Entry<Cell, Value>> getRowColumnRangePostFiltered(\n             TableReference tableRef, RowColumnRangeIterator iterator, int batchHint) {\n         return Iterators.concat(Iterators.transform(Iterators.partition(iterator, batchHint), batch -> {\n-            ImmutableMap.Builder<Cell, Value> rawBuilder = ImmutableMap.builder();\n-            batch.forEach(rawBuilder::put);\n-            Map<Cell, Value> raw = rawBuilder.build();\n+            // N.B. This batch could be spread across multiple rows, and those rows might extend into other\n+            // batches. We are given cells for a row grouped together, so easiest way to ensure they stay together\n+            // is to preserve the original order.\n+            Map<Cell, Value> raw = new LinkedHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1aedd2b1667caaf89db64e34000044e222cb22d"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e806c64230d736027d652f65f7f8a7cf4cc907fd", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/e806c64230d736027d652f65f7f8a7cf4cc907fd", "committedDate": "2020-03-31T17:50:04Z", "message": "also handle aborted transactions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NzgzNTA2", "url": "https://github.com/palantir/atlasdb/pull/4687#pullrequestreview-385783506", "createdAt": "2020-04-01T17:08:10Z", "commit": {"oid": "e806c64230d736027d652f65f7f8a7cf4cc907fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNzowODoxMFrOF_KU1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNzowODoxMFrOF_KU1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc3Mzc4MQ==", "bodyText": "can you comment why this test is there?", "url": "https://github.com/palantir/atlasdb/pull/4687#discussion_r401773781", "createdAt": "2020-04-01T17:08:10Z", "author": {"login": "j-baker"}, "path": "atlasdb-tests-shared/src/test/java/com/palantir/atlasdb/transaction/impl/SnapshotTransactionTest.java", "diffHunk": "@@ -1184,6 +1226,7 @@ public void testRowsColumnRangesSingleIteratorVersion() {\n         runTestForGetRowsColumnRangeSingleIteratorVersion(10, 10, 5);\n         runTestForGetRowsColumnRangeSingleIteratorVersion(10, 10, 10);\n         runTestForGetRowsColumnRangeSingleIteratorVersion(100, 100, 99);\n+        runTestForGetRowsColumnRangeSingleIteratorVersion(100, 11, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e806c64230d736027d652f65f7f8a7cf4cc907fd"}, "originalPosition": 71}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "181e45d0bc8d207cd67a41580bc121b30e2b0048", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/181e45d0bc8d207cd67a41580bc121b30e2b0048", "committedDate": "2020-04-01T17:18:31Z", "message": "comment new test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d566a7a969fc24f5ee6144f3dc41d4cb686c51d9", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/d566a7a969fc24f5ee6144f3dc41d4cb686c51d9", "committedDate": "2020-04-01T17:21:24Z", "message": "further improve comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7d2412571346a5199ed9281cfb620068edb32e5", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/c7d2412571346a5199ed9281cfb620068edb32e5", "committedDate": "2020-04-01T17:32:43Z", "message": "extract out inputRowOrder comparator"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1ODA0Njkw", "url": "https://github.com/palantir/atlasdb/pull/4687#pullrequestreview-385804690", "createdAt": "2020-04-01T17:36:01Z", "commit": {"oid": "c7d2412571346a5199ed9281cfb620068edb32e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c280bb081c411c3ed6d80f1d275223a31dcf153", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/2c280bb081c411c3ed6d80f1d275223a31dcf153", "committedDate": "2020-04-01T17:44:40Z", "message": "reorder methods to make checkstyle happy"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3033, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}