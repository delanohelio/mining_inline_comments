{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzODE3NzYz", "number": 5120, "title": "[Cross Client Batching LeaderTimes - 2a] | Refactor coalescing leaderTimeGetter", "bodyText": "Goals (and why):\nRefactor LockLeaseService so we can inject leaderTimeGetter. As of now, we are falling back on the original (coalescing) leaderTimeGetter.\nImplementation Description (bullets):\n\n\nRefactor out LeaderTimeGetter\n\n\nImplement CoalescingLeaderTimeGetter (coalescing requests for one namespace)\n\n\nImplement NamespacedLeaderTimeGetter -> it maintains the context of namespace for a client and directs requests to\ncoalescingBatcher that batches requests across clients\n\n\nAllow AutoBatcherBuilder to accept bufferSize\n\n\nTesting (What was existing testing like?  What have you done to improve it?):\nExisting tests should suffice for now\nConcerns (what feedback would you like?):\n\nDoes the refactor seem reasonable?\n\nWhere should we start reviewing?:\nLeaderTimeGetter.java,\nPriority (whenever / two weeks / yesterday):\nToday please", "createdAt": "2020-11-19T09:53:55Z", "url": "https://github.com/palantir/atlasdb/pull/5120", "merged": true, "mergeCommit": {"oid": "8ec628838d5d170c3e2a2ce7a265267aee0d711a"}, "closed": true, "closedAt": "2020-11-20T12:30:12Z", "author": {"login": "sudiksha27"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeAcfcgFqTUzNDI4MjM4Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeWS2kAH2gAyNTIzODE3NzYzOjc5MzZiOWJlMmM1NjZlYjIxZGE3OGM2MjdmZjRkYTllNzUwZDdkN2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MjgyMzgy", "url": "https://github.com/palantir/atlasdb/pull/5120#pullrequestreview-534282382", "createdAt": "2020-11-19T10:33:31Z", "commit": {"oid": "ef12650d5109e92dcc6002ce1114747950203449"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDozMzozMVrOH2WnLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMDo0NDo1OVrOH2XD6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc1NTYzMA==", "bodyText": "I think this should still be configurable - internal atlasdb-proxy probably wants more than 16384.", "url": "https://github.com/palantir/atlasdb/pull/5120#discussion_r526755630", "createdAt": "2020-11-19T10:33:31Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LeaderTimeCoalescingBatcher.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client;\n+\n+import com.palantir.atlasdb.autobatch.Autobatchers;\n+import com.palantir.atlasdb.autobatch.CoalescingRequestFunction;\n+import com.palantir.atlasdb.autobatch.DisruptorAutobatcher;\n+import com.palantir.atlasdb.futures.AtlasFutures;\n+import com.palantir.atlasdb.timelock.api.MultiClientConjureTimelockService;\n+import com.palantir.atlasdb.timelock.api.Namespace;\n+import com.palantir.lock.v2.LeaderTime;\n+import com.palantir.tokens.auth.AuthHeader;\n+import java.util.Map;\n+import java.util.Set;\n+\n+public class LeaderTimeCoalescingBatcher implements AutoCloseable {\n+    private static final int BUFFER_SIZE = 16384;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef12650d5109e92dcc6002ce1114747950203449"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc2MDk2NA==", "bodyText": "I'd name this differently - the problem here is that we have two implementations that are both logically coalescing, so this name isn't very helpful. I'd name this SingleClientLeaderTimeGetter? Not even opposed to LegacyLeaderTimeGetter at this point", "url": "https://github.com/palantir/atlasdb/pull/5120#discussion_r526760964", "createdAt": "2020-11-19T10:41:51Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/client/CoalescingLeaderTimeGetter.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client;\n+\n+import com.palantir.common.concurrent.CoalescingSupplier;\n+import com.palantir.lock.v2.LeaderTime;\n+\n+public class CoalescingLeaderTimeGetter implements LeaderTimeGetter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef12650d5109e92dcc6002ce1114747950203449"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc2MjQwMA==", "bodyText": "I would make this non-Optional actually: the setting of a default should happen at the TransactionManagers builder level, and then all usages within Atlas code should be non-optional (e.g. see how lockWatchingCache is set)", "url": "https://github.com/palantir/atlasdb/pull/5120#discussion_r526762400", "createdAt": "2020-11-19T10:44:04Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LockLeaseService.java", "diffHunk": "@@ -47,19 +46,21 @@\n class LockLeaseService {\n     private final NamespacedConjureTimelockService delegate;\n     private final UUID clientId;\n-    private final CoalescingSupplier<LeaderTime> time;\n+    private final LeaderTimeGetter leaderTimeGetter;\n     private final BlockEnforcingLockService lockService;\n \n     @VisibleForTesting\n-    LockLeaseService(NamespacedConjureTimelockService delegate, UUID clientId) {\n+    LockLeaseService(\n+            NamespacedConjureTimelockService delegate, UUID clientId, Optional<LeaderTimeGetter> leaderTimeGetter) {\n         this.delegate = delegate;\n         this.clientId = clientId;\n-        this.time = new CoalescingSupplier<>(delegate::leaderTime);\n+        this.leaderTimeGetter = leaderTimeGetter.orElseGet(() -> new CoalescingLeaderTimeGetter(delegate));\n         this.lockService = BlockEnforcingLockService.create(delegate);\n     }\n \n-    static LockLeaseService create(NamespacedConjureTimelockService conjureTimelock) {\n-        return new LockLeaseService(conjureTimelock, UUID.randomUUID());\n+    static LockLeaseService create(\n+            NamespacedConjureTimelockService conjureTimelock, Optional<LeaderTimeGetter> leaderTimeGetter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef12650d5109e92dcc6002ce1114747950203449"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjc2Mjk4Nw==", "bodyText": "I'd add some javadocs here, explaining more precisely how this works, as the difference between this and the \"obvious\" implementation is important and subtle.", "url": "https://github.com/palantir/atlasdb/pull/5120#discussion_r526762987", "createdAt": "2020-11-19T10:44:59Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/client/NamespacedCoalescingLeaderTimeGetter.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.lock.client;\n+\n+import com.palantir.atlasdb.timelock.api.Namespace;\n+import com.palantir.lock.v2.LeaderTime;\n+\n+public class NamespacedCoalescingLeaderTimeGetter implements LeaderTimeGetter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef12650d5109e92dcc6002ce1114747950203449"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97fd2737405c5e748a03d94fc5cac258361c9f5b", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/97fd2737405c5e748a03d94fc5cac258361c9f5b", "committedDate": "2020-11-19T18:21:13Z", "message": " Fix tests + remove redundant tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b29f21a48ffec3c35777b1052180f02f0aa3a47c", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/b29f21a48ffec3c35777b1052180f02f0aa3a47c", "committedDate": "2020-11-19T18:22:00Z", "message": "Refactor LeaderTimeGetter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5a9196255c30684aada5e74efe4941b8da31ef5", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/c5a9196255c30684aada5e74efe4941b8da31ef5", "committedDate": "2020-11-19T18:22:00Z", "message": "Configurable bufferSize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66831ceacc4187c2ef4bfad18bcb795343cd38f4", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/66831ceacc4187c2ef4bfad18bcb795343cd38f4", "committedDate": "2020-11-19T18:22:00Z", "message": "Implement LeaderTimeCoalescingBatcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "904a0264e0dfb04a2174a13649c4fe6d6eaafc68", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/904a0264e0dfb04a2174a13649c4fe6d6eaafc68", "committedDate": "2020-11-19T18:22:00Z", "message": "Wire LeaderTimeGetter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e777d72f96808db68a59aee9c4951164ae3b775b", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/e777d72f96808db68a59aee9c4951164ae3b775b", "committedDate": "2020-11-19T18:22:00Z", "message": "Fix build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "605cbc3619f4252951b12377397f1a949e1dd998", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/605cbc3619f4252951b12377397f1a949e1dd998", "committedDate": "2020-11-19T18:22:00Z", "message": "Address comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "42540dc2d270c1438d0c6ec45285da7d19cc4bc1", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/42540dc2d270c1438d0c6ec45285da7d19cc4bc1", "committedDate": "2020-11-19T11:31:27Z", "message": "Address comments"}, "afterCommit": {"oid": "605cbc3619f4252951b12377397f1a949e1dd998", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/605cbc3619f4252951b12377397f1a949e1dd998", "committedDate": "2020-11-19T18:22:00Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d66dec83618a44d80b189fb881c489d5f17fc4af", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/d66dec83618a44d80b189fb881c489d5f17fc4af", "committedDate": "2020-11-19T18:26:27Z", "message": "Remove redundant line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b112b32f738970dc78620ba4a2232efa2672ed84", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/b112b32f738970dc78620ba4a2232efa2672ed84", "committedDate": "2020-11-19T18:45:27Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35f74badc329dc922c01d66423fd3eeee6e6c0f3", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/35f74badc329dc922c01d66423fd3eeee6e6c0f3", "committedDate": "2020-11-19T18:45:27Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MzUwNDYz", "url": "https://github.com/palantir/atlasdb/pull/5120#pullrequestreview-535350463", "createdAt": "2020-11-20T11:32:55Z", "commit": {"oid": "35f74badc329dc922c01d66423fd3eeee6e6c0f3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMTozMjo1NVrOH3MFDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMTozMjo1NVrOH3MFDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYzMTYzMQ==", "bodyText": "nit: I'd just name this bufferSize", "url": "https://github.com/palantir/atlasdb/pull/5120#discussion_r527631631", "createdAt": "2020-11-20T11:32:55Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-autobatch/src/main/java/com/palantir/atlasdb/autobatch/Autobatchers.java", "diffHunk": "@@ -88,6 +89,7 @@ private Autobatchers() {}\n         private final ImmutableMap.Builder<String, String> safeTags = ImmutableMap.builder();\n \n         private Observability observability = Observability.UNDECIDED;\n+        private OptionalInt optionalBufferSize = OptionalInt.empty();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35f74badc329dc922c01d66423fd3eeee6e6c0f3"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7936b9be2c566eb21da78c627ff4da9e750d7d7e", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/7936b9be2c566eb21da78c627ff4da9e750d7d7e", "committedDate": "2020-11-20T12:13:28Z", "message": "Fix nits"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2505, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}