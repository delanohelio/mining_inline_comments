{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxMDAxNzA0", "number": 4610, "title": "If a method returned by AwaitingLeadershipProxy returns ListenableFuture, the leadership check is also asynchronous", "bodyText": "Checkpoint from pairing with Jeremy", "createdAt": "2020-02-27T18:22:53Z", "url": "https://github.com/palantir/atlasdb/pull/4610", "merged": true, "mergeCommit": {"oid": "23b18f93d6d33fb53bf90b67397bcb5fbc105100"}, "closed": true, "closedAt": "2020-03-02T16:56:34Z", "author": {"login": "j-baker"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIflkTAFqTM2NTg5NDQ3NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJwVXjgH2gAyMzgxMDAxNzA0OjU0ODljYmQxYjY3Y2ZiZmJlYjliOGMxMGQ4YmJmZjk1ZDM5ZTdhZWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODk0NDc0", "url": "https://github.com/palantir/atlasdb/pull/4610#pullrequestreview-365894474", "createdAt": "2020-02-27T18:25:33Z", "commit": {"oid": "f1aa29c023758a39ff11a7b9b8cac44d8ba7b89a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNTozNFrOFvcPUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxODoyNTozNFrOFvcPUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI5MDA2Ng==", "bodyText": "a consequence of this is that if the get() method is used, we will still always execute on a thread pool.", "url": "https://github.com/palantir/atlasdb/pull/4610#discussion_r385290066", "createdAt": "2020-02-27T18:25:34Z", "author": {"login": "j-baker"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/concurrent/CoalescingSupplier.java", "diffHunk": "@@ -40,16 +45,30 @@ public CoalescingSupplier(Supplier<T> delegate) {\n \n     @Override\n     public T get() {\n+        try {\n+            return getAsync().get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1aa29c023758a39ff11a7b9b8cac44d8ba7b89a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTQxNzI1", "url": "https://github.com/palantir/atlasdb/pull/4610#pullrequestreview-365941725", "createdAt": "2020-02-27T19:35:24Z", "commit": {"oid": "d47db8efa3961ef9f457e09cf65408f5c0470335"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOTozNToyNFrOFvehVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOTozNToyNFrOFvehVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMyNzQ0Ng==", "bodyText": "This class should probably do with some better unit tests, now, before this merges.", "url": "https://github.com/palantir/atlasdb/pull/4610#discussion_r385327446", "createdAt": "2020-02-27T19:35:24Z", "author": {"login": "j-baker"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/proxy/AwaitingLeadershipProxy.java", "diffHunk": "@@ -50,8 +58,12 @@\n \n     private static final Logger log = LoggerFactory.getLogger(AwaitingLeadershipProxy.class);\n \n-    private static final long MAX_NO_QUORUM_RETRIES = 10;\n+    private static final int MAX_NO_QUORUM_RETRIES = 10;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d47db8efa3961ef9f457e09cf65408f5c0470335"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d47db8efa3961ef9f457e09cf65408f5c0470335", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/d47db8efa3961ef9f457e09cf65408f5c0470335", "committedDate": "2020-02-27T19:29:52Z", "message": "refactor"}, "afterCommit": {"oid": "4e94cbb444a9f4654a908be5baade06037921f4b", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/4e94cbb444a9f4654a908be5baade06037921f4b", "committedDate": "2020-03-02T09:52:48Z", "message": "Add a benchmark for awaiting leadership proxy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88241f44c71bd05695f86e877e55262ee0c020ae", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/88241f44c71bd05695f86e877e55262ee0c020ae", "committedDate": "2020-03-02T10:57:07Z", "message": "Checkpoint with jeremy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f72f0549fb9031fe9c29b5bd1282b97aa0533ff9", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/f72f0549fb9031fe9c29b5bd1282b97aa0533ff9", "committedDate": "2020-03-02T10:57:07Z", "message": "PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "955cfcc37938715e42ca34d3f628e131b0104e20", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/955cfcc37938715e42ca34d3f628e131b0104e20", "committedDate": "2020-03-02T10:57:07Z", "message": "refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e75089bb3e4ddbb1390453d3ec0362c5baf27427", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/e75089bb3e4ddbb1390453d3ec0362c5baf27427", "committedDate": "2020-03-02T10:57:07Z", "message": "Refactor out an AsyncRetrier to allow for better testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01b032519586e9bda5bcedc4caeffbb721ea92f0", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/01b032519586e9bda5bcedc4caeffbb721ea92f0", "committedDate": "2020-03-02T10:57:08Z", "message": "Add a benchmark for awaiting leadership proxy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b347ae9939d307c6939e1d41be44ada3eeecd1d", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/6b347ae9939d307c6939e1d41be44ada3eeecd1d", "committedDate": "2020-03-02T10:57:08Z", "message": "PR test failures"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45ee5d9c7b5a8cca92ff82cf45aed08f0d52d6a2", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/45ee5d9c7b5a8cca92ff82cf45aed08f0d52d6a2", "committedDate": "2020-03-02T10:40:12Z", "message": "PR test failures"}, "afterCommit": {"oid": "6b347ae9939d307c6939e1d41be44ada3eeecd1d", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/6b347ae9939d307c6939e1d41be44ada3eeecd1d", "committedDate": "2020-03-02T10:57:08Z", "message": "PR test failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3060f79784a5466bf5650fe482c51edc287a2c6", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/c3060f79784a5466bf5650fe482c51edc287a2c6", "committedDate": "2020-03-02T11:09:33Z", "message": "Refactor coalescingsupplier"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cba7ea76d41fd231dfd3f8b7a6cd844f91dba308", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/cba7ea76d41fd231dfd3f8b7a6cd844f91dba308", "committedDate": "2020-03-02T11:10:02Z", "message": "merge conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed4b93db7e1344b8b4243bc8f4628f478b07633a", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/ed4b93db7e1344b8b4243bc8f4628f478b07633a", "committedDate": "2020-03-02T11:31:22Z", "message": "Extra test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c78b2e4c4969d40d9adf03ec8cf88167c9d540a", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/0c78b2e4c4969d40d9adf03ec8cf88167c9d540a", "committedDate": "2020-03-02T11:32:53Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "902a7dfd76aa6f8963953e3fa778d50a001e71e0", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/902a7dfd76aa6f8963953e3fa778d50a001e71e0", "committedDate": "2020-03-02T13:08:18Z", "message": "checkstyel"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MjIxOTQ0", "url": "https://github.com/palantir/atlasdb/pull/4610#pullrequestreview-367221944", "createdAt": "2020-03-02T14:05:56Z", "commit": {"oid": "902a7dfd76aa6f8963953e3fa778d50a001e71e0"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNDowNTo1N1rOFwgp2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNDozNjowMFrOFwhuNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQxMDk2OQ==", "bodyText": "Extract this to some utility class, as it's effectively duplicated from ConjureTimelockResource, and also exists in ALP", "url": "https://github.com/palantir/atlasdb/pull/4610#discussion_r386410969", "createdAt": "2020-03-02T14:05:57Z", "author": {"login": "gmaretic"}, "path": "atlasdb-commons/src/test/java/com/palantir/common/concurrent/CoalescingSupplierTest.java", "diffHunk": "@@ -35,25 +35,57 @@\n import java.util.concurrent.Future;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicLong;\n+import java.util.function.Function;\n import java.util.function.Supplier;\n import java.util.stream.Collectors;\n import java.util.stream.IntStream;\n \n import org.junit.Before;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n \n+import com.google.common.base.Throwables;\n import com.google.common.util.concurrent.Futures;\n import com.google.common.util.concurrent.ListenableFuture;\n import com.google.common.util.concurrent.ListeningExecutorService;\n import com.google.common.util.concurrent.MoreExecutors;\n import com.google.common.util.concurrent.Uninterruptibles;\n \n+@RunWith(Parameterized.class)\n public class CoalescingSupplierTest {\n     private static final int DEFAULT_VALUE = 123;\n \n     private final Supplier<Integer> delegate = mock(Supplier.class);\n     private final FreezableSupplier freezableDelegate = new FreezableSupplier(delegate);\n-    private final CoalescingSupplier<Integer> supplier = new CoalescingSupplier<>(freezableDelegate);\n+    private final CoalescingSupplier<Integer> coalescing = new CoalescingSupplier<>(freezableDelegate);\n+\n+    private final Supplier<Integer> supplier;\n+\n+    public CoalescingSupplierTest(String name, Object parameter) {\n+        Function<CoalescingSupplierTest, Integer> factory = (Function) parameter;\n+        supplier = () -> factory.apply(this);\n+    }\n+\n+    @Parameterized.Parameters(name = \"{0}\")\n+    public static Object[] getParameters() {\n+        return new Object[][] {\n+                {\"blocking\", (Function<CoalescingSupplierTest, Integer>) test -> test.coalescing.get() },\n+                {\"async\", (Function<CoalescingSupplierTest, Integer>) test -> unwrap(test.coalescing.getAsync()) }\n+        };\n+    }\n+\n+    private static <T> T unwrap(ListenableFuture<T> future) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "902a7dfd76aa6f8963953e3fa778d50a001e71e0"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQxMTA5NA==", "bodyText": "nice!", "url": "https://github.com/palantir/atlasdb/pull/4610#discussion_r386411094", "createdAt": "2020-03-02T14:06:11Z", "author": {"login": "gmaretic"}, "path": "atlasdb-commons/src/test/java/com/palantir/common/concurrent/CoalescingSupplierTest.java", "diffHunk": "@@ -35,25 +35,57 @@\n import java.util.concurrent.Future;\n import java.util.concurrent.TimeUnit;\n import java.util.concurrent.atomic.AtomicLong;\n+import java.util.function.Function;\n import java.util.function.Supplier;\n import java.util.stream.Collectors;\n import java.util.stream.IntStream;\n \n import org.junit.Before;\n import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n \n+import com.google.common.base.Throwables;\n import com.google.common.util.concurrent.Futures;\n import com.google.common.util.concurrent.ListenableFuture;\n import com.google.common.util.concurrent.ListeningExecutorService;\n import com.google.common.util.concurrent.MoreExecutors;\n import com.google.common.util.concurrent.Uninterruptibles;\n \n+@RunWith(Parameterized.class)\n public class CoalescingSupplierTest {\n     private static final int DEFAULT_VALUE = 123;\n \n     private final Supplier<Integer> delegate = mock(Supplier.class);\n     private final FreezableSupplier freezableDelegate = new FreezableSupplier(delegate);\n-    private final CoalescingSupplier<Integer> supplier = new CoalescingSupplier<>(freezableDelegate);\n+    private final CoalescingSupplier<Integer> coalescing = new CoalescingSupplier<>(freezableDelegate);\n+\n+    private final Supplier<Integer> supplier;\n+\n+    public CoalescingSupplierTest(String name, Object parameter) {\n+        Function<CoalescingSupplierTest, Integer> factory = (Function) parameter;\n+        supplier = () -> factory.apply(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "902a7dfd76aa6f8963953e3fa778d50a001e71e0"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQyODQ2OQ==", "bodyText": "Again as before (except this time we get the cause if we reach here, which doesn't seem an intentional dif)", "url": "https://github.com/palantir/atlasdb/pull/4610#discussion_r386428469", "createdAt": "2020-03-02T14:36:00Z", "author": {"login": "gmaretic"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/AsyncTimelockResource.java", "diffHunk": "@@ -128,7 +131,19 @@ public StartTransactionResponseV4 startTransactions(StartTransactionRequestV4 re\n     @POST\n     @Path(\"start-atlasdb-transaction-v5\")\n     public StartTransactionResponseV5 startTransactionsWithWatches(StartTransactionRequestV5 request) {\n-        return timelock.startTransactionsWithWatches(request);\n+        return unwrapListenableFuture(timelock.startTransactionsWithWatches(request));\n+    }\n+\n+    private static <T> T unwrapListenableFuture(ListenableFuture<T> future) {\n+        try {\n+            return future.get();\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new RuntimeException(e);\n+        } catch (ExecutionException e) {\n+            Throwables.throwIfUncheckedException(e.getCause());\n+            throw new RuntimeException(e.getCause());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "902a7dfd76aa6f8963953e3fa778d50a001e71e0"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02f08e2e99a9a503b379f3c20634b7514813d6a0", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/02f08e2e99a9a503b379f3c20634b7514813d6a0", "committedDate": "2020-03-02T15:41:21Z", "message": "PR commetns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b54b1d255f849acd61143dd351653427a187e485", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/b54b1d255f849acd61143dd351653427a187e485", "committedDate": "2020-03-02T15:41:21Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3Mjk5MTQw", "url": "https://github.com/palantir/atlasdb/pull/4610#pullrequestreview-367299140", "createdAt": "2020-03-02T15:41:28Z", "commit": {"oid": "902a7dfd76aa6f8963953e3fa778d50a001e71e0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "691cac2e53347b5b2f412b65a2a4e59299988780", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/691cac2e53347b5b2f412b65a2a4e59299988780", "committedDate": "2020-03-02T15:43:45Z", "message": "PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f95481198c90f9ceaadc248f28b1728dfe9cc5ba", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/f95481198c90f9ceaadc248f28b1728dfe9cc5ba", "committedDate": "2020-03-02T16:01:46Z", "message": "Merge branch 'jbaker/async' of github.com:palantir/atlasdb into jbaker/async"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a0ef2b54404d12eadc6727f8b2c3d289f9cc9c1", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/1a0ef2b54404d12eadc6727f8b2c3d289f9cc9c1", "committedDate": "2020-03-02T16:01:52Z", "message": "Move a bunch more stuff to async\n\nmeans our current hot codepaths stay hot even before moving them to\nconjure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "601ded66b53f0fa6283029851597139a200fd9ab", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/601ded66b53f0fa6283029851597139a200fd9ab", "committedDate": "2020-03-02T16:08:26Z", "message": "Merge branch 'develop' into jbaker/async"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d78a4d80a585929660ba0fd6aeaace7e32154593", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/d78a4d80a585929660ba0fd6aeaace7e32154593", "committedDate": "2020-03-02T16:12:49Z", "message": "Thread pool"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5489cbd1b67cfbfbeb9b8c10d8bbff95d39e7aec", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/5489cbd1b67cfbfbeb9b8c10d8bbff95d39e7aec", "committedDate": "2020-03-02T16:30:11Z", "message": "rewrapping..."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2307, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}