{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwOTM3NDA0", "number": 4549, "title": "Timelock Metric Fixes", "bodyText": "Goals (and why):\nMetrics on Timelock are somewhat hard to decipher and in some places incorrect. Small fixes to improve\nImplementation Description (bullets):\n\nWe were both instrumenting the local remotes and combination of both the local and remote Paxos{Acceptor|Learner}, meaning we had two entries for the local acceptor/learners. We only instrument the \"logical\" BatchPaxos{Acceptor|Learner} that wraps the (already instrumented) remote BatchPaxos{Acceptor|Learner}RpcClient.\nThe interface to consumers is through BatchPaxos{Acceptor|Learner}NetworkClient, however that itself isn't instrumented. This gives the true indication of how long a \"call\" took taking into account quoroms.\n\nOnly downside is that it's a result type which encapsulates errors, so an error - which isn't acceptable state - will count as a normal invocation, not entirely sure it's worth the effort to work around that\n\n\nAtlasDbHttpClients#createExperimentallyWithFallback instruments the proxy that gets returned, which is potentially further instrumented (in timelock's case, this is true). This results in double reported metrics which inflates/confuses what's actually going on. We really want to use scoped registries, but because AtlasDbHttpClients is static and has no real state, it's somewhat difficult (since we can't get scoped registries from a tagged metric registry). It's also not necessary, since we're not falling back to atlasdb-feign as the experiment is over.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nNone.\nConcerns (what feedback would you like?):\nNone.\nWhere should we start reviewing?:\nCommit \ud83d\udc4f by \ud83d\udc4f commit \ud83d\udc83\nPriority (whenever / two weeks / yesterday):\nRelatively soon pls", "createdAt": "2020-02-04T16:39:28Z", "url": "https://github.com/palantir/atlasdb/pull/4549", "merged": true, "mergeCommit": {"oid": "c4a58c5ac3b314c1f84fa93eb5db6cfefc848a16"}, "closed": true, "closedAt": "2020-02-04T19:58:17Z", "author": {"login": "felixdesouza"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9TvevAH2gAyMzcwOTM3NDA0OjdjMmE4OWM5YmI5NjhlNjA2MTI5OWY2MDljOTZlOTg3OTQxNjYxMjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBG9hTAH2gAyMzcwOTM3NDA0OjA0MzAxMTY3MDE3ZDY5ZTkzOWI4N2UwOGNjOGMzNjIzYzEyOGU5YTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7c2a89c9bb968e6061299f609c96e98794166127", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/7c2a89c9bb968e6061299f609c96e98794166127", "committedDate": "2020-01-24T00:24:22Z", "message": "Remove double reporting of metrics."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d64d65c207cabf590e80b32932671f955571619", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/3d64d65c207cabf590e80b32932671f955571619", "committedDate": "2020-01-24T00:35:59Z", "message": "Instrument individual learner/acceptor network clients"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35de7b3b09393a8c97db540622ffa03db2f0ea86", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/35de7b3b09393a8c97db540622ffa03db2f0ea86", "committedDate": "2020-01-24T01:12:51Z", "message": "Remove version selecting client to stop double reporting metrics."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8ddc99db30cb7633127a83b3294c4fb2a352bc3", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/f8ddc99db30cb7633127a83b3294c4fb2a352bc3", "committedDate": "2020-02-04T14:39:15Z", "message": "Fix compile errors."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5ac8bea4fa2f129db142a3e7788cbe6bb0dd3c1", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/c5ac8bea4fa2f129db142a3e7788cbe6bb0dd3c1", "committedDate": "2020-02-04T14:39:15Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "692bdb46cc67cceb74da1ae6e958ac524dedd97c", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/692bdb46cc67cceb74da1ae6e958ac524dedd97c", "committedDate": "2020-02-04T16:56:50Z", "message": "Fix tests to actually go through the conjure path."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMjMxMDQw", "url": "https://github.com/palantir/atlasdb/pull/4549#pullrequestreview-353231040", "createdAt": "2020-02-04T19:12:45Z", "commit": {"oid": "7c2a89c9bb968e6061299f609c96e98794166127"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOToxMjo0NVrOFlgIQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxOToxNjoxN1rOFlgPgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg2ODAzMg==", "bodyText": "enhanceRemotes?", "url": "https://github.com/palantir/atlasdb/pull/4549#discussion_r374868032", "createdAt": "2020-02-04T19:12:45Z", "author": {"login": "jeremyk-91"}, "path": "timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/SingleLeaderNetworkClientFactories.java", "diffHunk": "@@ -42,11 +42,7 @@\n                     .wrap(useCase(), remoteClients())\n                     .apply(client);\n             PaxosAcceptor localAcceptor = components().acceptor(client);\n-            LocalAndRemotes<PaxosAcceptor> allAcceptors = metrics().instrumentLocalAndRemotesFor(\n-                    PaxosAcceptor.class,\n-                    localAcceptor,\n-                    remoteAcceptors,\n-                    client);\n+            LocalAndRemotes<PaxosAcceptor> allAcceptors = LocalAndRemotes.of(localAcceptor, remoteAcceptors);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c2a89c9bb968e6061299f609c96e98794166127"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg2ODEzMA==", "bodyText": "as above, need to enhanceRemotes", "url": "https://github.com/palantir/atlasdb/pull/4549#discussion_r374868130", "createdAt": "2020-02-04T19:12:56Z", "author": {"login": "jeremyk-91"}, "path": "timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/SingleLeaderNetworkClientFactories.java", "diffHunk": "@@ -63,11 +59,8 @@\n                     .wrap(useCase(), remoteClients())\n                     .apply(client);\n             PaxosLearner localLearner = components().learner(client);\n-            LocalAndRemotes<PaxosLearner> allLearners = metrics().instrumentLocalAndRemotesFor(\n-                    PaxosLearner.class,\n-                    localLearner,\n-                    remoteLearners,\n-                    client);\n+\n+            LocalAndRemotes<PaxosLearner> allLearners = LocalAndRemotes.of(localLearner, remoteLearners);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c2a89c9bb968e6061299f609c96e98794166127"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg2OTg5MQ==", "bodyText": "(non-actionable) we verified that no-one actually is still running the experiment", "url": "https://github.com/palantir/atlasdb/pull/4549#discussion_r374869891", "createdAt": "2020-02-04T19:16:17Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/http/AtlasDbHttpClients.java", "diffHunk": "@@ -37,17 +37,11 @@ private AtlasDbHttpClients() {\n     }\n \n     public static <T> T createProxy(\n-            MetricsManager metricsManager,\n             Optional<TrustContext> trustContext,\n             String uri,\n             Class<T> type,\n             AuxiliaryRemotingParameters parameters) {\n-        return createExperimentallyWithFallback(\n-                metricsManager,\n-                () -> ConjureJavaRuntimeTargetFactory.DEFAULT.createProxy(trustContext, uri, type, parameters),\n-                () -> AtlasDbFeignTargetFactory.DEFAULT.createProxy(trustContext, uri, type, parameters),\n-                type,\n-                parameters);\n+        return ConjureJavaRuntimeTargetFactory.DEFAULT.createProxy(trustContext, uri, type, parameters).instance();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35de7b3b09393a8c97db540622ffa03db2f0ea86"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04301167017d69e939b87e08cc8c3623c128e9a0", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/04301167017d69e939b87e08cc8c3623c128e9a0", "committedDate": "2020-02-04T19:46:38Z", "message": "Ensure we're instrumenting the remote wrappers via enhanceRemotes."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2233, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}