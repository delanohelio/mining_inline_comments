{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwODUyMjkx", "number": 5084, "title": "[PSL] Better Logging and Option to Skip Validation + Truncate for PSL Migration", "bodyText": "Goals (and why):\nThis PR does two things: improves the logging on the migration and validation tasks, and adds a timelock install config that allows us to skip validation and truncate old logs when we need this to move forward if safe with failing validation\nImplementation Description (bullets):\n\nAdded toString() to PaxosAcceptorState, basically no reason not to do it this way\nWired in and added client and use case to the logs\nAdded a truncateAllRounds method to PSL interface\nIf the config is set to true, skip validation if migrated, and in any case truncate the file based log\nFunnily enough found two bugs in PaxosStateLogImpl so fixed them along the way.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nBasically added some new tests that are modified existing tests and verify that the changed behaviour makes sense.\nConcerns (what feedback would you like?):\nNot the biggest fan of adding more dangerous stuff to the interface, but the alternative was to change the behaviour of PaxosStateLogImpl to truncate everything. The JavaDoc implicitly allows this, but in the vein of being more defensive we just don't need this kind of implementation detail change to somehow kick is in the teeth.\nWhere should we start reviewing?:\nTests\nPriority (whenever / two weeks / yesterday):\n\ud83d\udd25", "createdAt": "2020-10-27T15:41:12Z", "url": "https://github.com/palantir/atlasdb/pull/5084", "merged": true, "mergeCommit": {"oid": "7f8f6bfaa0d46ad4c4fd05dfad305aab37feb3e7"}, "closed": true, "closedAt": "2020-10-28T13:23:02Z", "author": {"login": "gmaretic"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWqXpwgH2gAyNTEwODUyMjkxOjc5ODcyMjU4ZmEyYjE1NDVhOGI1NWEyM2Q5YThkOTA2NTc2NmY5NjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW72WcAH2gAyNTEwODUyMjkxOjExODk4NDk0Yzc0MDA5Mzc3OTliZmRjOGVhNjM2OTkwZmI3YWRiM2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "79872258fa2b1545a8b55a23d9a8d9065766f966", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/79872258fa2b1545a8b55a23d9a8d9065766f966", "committedDate": "2020-10-27T15:05:25Z", "message": "Commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfa2b98904d3e0dd3a5ccf51ff51ac6fea47fd4d", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/dfa2b98904d3e0dd3a5ccf51ff51ac6fea47fd4d", "committedDate": "2020-10-27T15:07:52Z", "message": "Merge with develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3455cde555dd05440891d4b4b9eae82dff08c8d", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/c3455cde555dd05440891d4b4b9eae82dff08c8d", "committedDate": "2020-10-27T15:38:56Z", "message": "Be more defensive"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb", "committedDate": "2020-10-27T16:37:21Z", "message": "Luckily have tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3OTk3MTM4", "url": "https://github.com/palantir/atlasdb/pull/5084#pullrequestreview-517997138", "createdAt": "2020-10-27T18:01:18Z", "commit": {"oid": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowMToxOFrOHpJwsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QxODowNDoxMFrOHpJ5Jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxMzU4NQ==", "bodyText": "wat", "url": "https://github.com/palantir/atlasdb/pull/5084#discussion_r512913585", "createdAt": "2020-10-27T18:01:18Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "diffHunk": "@@ -223,7 +224,7 @@ public void truncate(long toDeleteInclusive) {\n             for (File file : files) {\n                 long fileSeq = getSeqFromFilename(file);\n                 if (fileSeq <= toDeleteInclusive) {\n-                    if (file.delete()) {\n+                    if (!file.delete()) {\n                         log.warn(\"failed to delete log file {}\", file.getAbsolutePath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxMzY3Mg==", "bodyText": "good spot though!", "url": "https://github.com/palantir/atlasdb/pull/5084#discussion_r512913672", "createdAt": "2020-10-27T18:01:24Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "diffHunk": "@@ -223,7 +224,7 @@ public void truncate(long toDeleteInclusive) {\n             for (File file : files) {\n                 long fileSeq = getSeqFromFilename(file);\n                 if (fileSeq <= toDeleteInclusive) {\n-                    if (file.delete()) {\n+                    if (!file.delete()) {\n                         log.warn(\"failed to delete log file {}\", file.getAbsolutePath());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxMzU4NQ=="}, "originalCommit": {"oid": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxNDE4Mg==", "bodyText": "nit: could we include, at least at Unsafe level, the directory involved?", "url": "https://github.com/palantir/atlasdb/pull/5084#discussion_r512914182", "createdAt": "2020-10-27T18:02:09Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "diffHunk": "@@ -235,10 +236,24 @@ public void truncate(long toDeleteInclusive) {\n         }\n     }\n \n+    @Override\n+    public void truncateAllRounds() {\n+        lock.writeLock().lock();\n+        try {\n+            File dir = new File(path);\n+            boolean success = getLogEntries(dir).stream().map(File::delete).reduce(true, (x, y) -> x && y);\n+            if (!success) {\n+                log.warn(\"failed to delete all log files.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjkxNTc1MQ==", "bodyText": "I realise this case is handled already above in getExtremeLogEntry, but we should clean it up.", "url": "https://github.com/palantir/atlasdb/pull/5084#discussion_r512915751", "createdAt": "2020-10-27T18:04:10Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogImpl.java", "diffHunk": "@@ -235,10 +236,24 @@ public void truncate(long toDeleteInclusive) {\n         }\n     }\n \n+    @Override\n+    public void truncateAllRounds() {\n+        lock.writeLock().lock();\n+        try {\n+            File dir = new File(path);\n+            boolean success = getLogEntries(dir).stream().map(File::delete).reduce(true, (x, y) -> x && y);\n+            if (!success) {\n+                log.warn(\"failed to delete all log files.\");\n+            }\n+        } finally {\n+            lock.writeLock().unlock();\n+        }\n+    }\n+\n     private List<File> getLogEntries(File dir) {\n         File[] files = dir.listFiles();\n         if (files == null) {\n-            return null;\n+            return ImmutableList.of();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09128e1cc7d4a93af8f09fe33b6a5ecf9c2e3bdb"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3fabf2f607154f01161dccc07ba01837275cabc", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/f3fabf2f607154f01161dccc07ba01837275cabc", "committedDate": "2020-10-28T10:02:48Z", "message": "Add logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11898494c7400937799bfdc8ea636990fb7adb3c", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/11898494c7400937799bfdc8ea636990fb7adb3c", "committedDate": "2020-10-28T11:27:20Z", "message": "Better yet logging"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2438, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}