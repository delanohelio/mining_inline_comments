{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2OTA5ODEw", "number": 4726, "title": "[PaxosLog] Part 3: Namespacing SqlitePaxosStateLog", "bodyText": "Goals (and why):\n\nAllow multiple distinct sequences that are stored in the same SQLite instance.\n\nImplementation Description (bullets):\n\nAdd namespacing for our SQLite store: allow a string namespace to be taken in\nProvide a mapping from PaxosUseCases, clients and roles (acceptor or learner) to distinct string table identifiers for SQLite.\nPartially wire this mapping through to generate table names that would be appropriate for SQLite usage. These would be wired into log creation in PaxosAcceptor or Learner.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nNot much. Existing tests passing validate a lack of regressions here. Some extra tests around namespaces being distinct but also referenceable.\nConcerns (what feedback would you like?):\n\nLocalPaxosComponents#createComponents() is currently fragile - the mechanism we use in CentOS Migration for detecting if a client is original is whether it has a paxos data directory. We need to be careful with this.\nIs the wiring of clients correct, in that a (paxosUseCase, client, paxosRole) combination maps to a paxosUseCase!client!paxosRole table in SQLite? Could there ever be clashes?\nThis creates a fair number of tables (basically with N clients 2N tables), though it keeps each table fairly small. There are alternatives: is this a reasonable design choice? Note that we don't plan on doing joins on these tables. I don't think it's that bad since we're still looking at <300 tables in general even at large deployments.\n\nWhere should we start reviewing?: PaxosStorageParameters\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-04-21T21:08:37Z", "url": "https://github.com/palantir/atlasdb/pull/4726", "merged": true, "mergeCommit": {"oid": "c3a12c775d8b52ba8792f811e953c11551fc34b7"}, "closed": true, "closedAt": "2020-04-27T13:44:10Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZ6BCcgH2gAyNDA2OTA5ODEwOjMyMDAwNTgwZTI1MGU4NGU1ZDU1ZTBmYzA0MWNjZjFlNjhkY2RlNTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbtcw5gFqTQwMDg1NjE1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "32000580e250e84e5d55e0fc041ccf1e68dcde57", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/32000580e250e84e5d55e0fc041ccf1e68dcde57", "committedDate": "2020-04-21T20:49:49Z", "message": "Namespaced paxos state log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94948a9cdf6f488e11a2c60944469f13c70b4767", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/94948a9cdf6f488e11a2c60944469f13c70b4767", "committedDate": "2020-04-21T20:51:35Z", "message": "Add test for namespacing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "284153aa386627da7334958bc7ad33edc59f1fff", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/284153aa386627da7334958bc7ad33edc59f1fff", "committedDate": "2020-04-21T20:59:53Z", "message": "Wiring up learners to expose"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6653971fd81dff19214223b2cff390bfc893263", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/f6653971fd81dff19214223b2cff390bfc893263", "committedDate": "2020-04-21T21:12:30Z", "message": "Compile break"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NzA3ODU0", "url": "https://github.com/palantir/atlasdb/pull/4726#pullrequestreview-397707854", "createdAt": "2020-04-21T22:01:49Z", "commit": {"oid": "f6653971fd81dff19214223b2cff390bfc893263"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjowMTo0OVrOGJaWjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjowMTo0OVrOGJaWjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyMjEyNQ==", "bodyText": "Table per namespace, interesting.", "url": "https://github.com/palantir/atlasdb/pull/4726#discussion_r412522125", "createdAt": "2020-04-21T22:01:49Z", "author": {"login": "jkozlowski"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -30,26 +30,34 @@\n \n public final class SqlitePaxosStateLog<V extends Persistable & Versionable> implements PaxosStateLog<V> {\n     private final Supplier<Connection> connectionSupplier;\n+    private final String logNamespace;\n \n-    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier) {\n+    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier, String logNamespace) {\n         this.connectionSupplier = connectionSupplier;\n+        this.logNamespace = logNamespace;\n     }\n \n-    public static <V extends Persistable & Versionable> PaxosStateLog<V> createInitialized(Supplier<Connection> conn) {\n-        SqlitePaxosStateLog<V> log = new SqlitePaxosStateLog<>(conn);\n+    public static <V extends Persistable & Versionable> PaxosStateLog<V> createInitialized(\n+            Supplier<Connection> conn,\n+            String logNamespace) {\n+        SqlitePaxosStateLog<V> log = new SqlitePaxosStateLog<>(conn, logNamespace);\n         log.initialize();\n         return log;\n     }\n \n     private void initialize() {\n-        executeVoid(\"CREATE TABLE IF NOT EXISTS paxosLog (seq BIGINT, val BLOB, CONSTRAINT pk_dual PRIMARY KEY (seq))\");\n+        executeVoid(\n+                String.format(\n+                        \"CREATE TABLE IF NOT EXISTS %s (seq BIGINT, val BLOB, CONSTRAINT pk_%s PRIMARY KEY (seq))\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6653971fd81dff19214223b2cff390bfc893263"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NzA4MTU2", "url": "https://github.com/palantir/atlasdb/pull/4726#pullrequestreview-397708156", "createdAt": "2020-04-21T22:02:26Z", "commit": {"oid": "f6653971fd81dff19214223b2cff390bfc893263"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjowMjoyNlrOGJaXoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjowMjoyNlrOGJaXoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyMjQwMQ==", "bodyText": "Can you create as many sqlite instances as you want if it's backed by the filesystem? Does it maintain some on-disk locks or something?", "url": "https://github.com/palantir/atlasdb/pull/4726#discussion_r412522401", "createdAt": "2020-04-21T22:02:26Z", "author": {"login": "jkozlowski"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -30,26 +30,34 @@\n \n public final class SqlitePaxosStateLog<V extends Persistable & Versionable> implements PaxosStateLog<V> {\n     private final Supplier<Connection> connectionSupplier;\n+    private final String logNamespace;\n \n-    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier) {\n+    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier, String logNamespace) {\n         this.connectionSupplier = connectionSupplier;\n+        this.logNamespace = logNamespace;\n     }\n \n-    public static <V extends Persistable & Versionable> PaxosStateLog<V> createInitialized(Supplier<Connection> conn) {\n-        SqlitePaxosStateLog<V> log = new SqlitePaxosStateLog<>(conn);\n+    public static <V extends Persistable & Versionable> PaxosStateLog<V> createInitialized(\n+            Supplier<Connection> conn,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6653971fd81dff19214223b2cff390bfc893263"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NzA4OTE4", "url": "https://github.com/palantir/atlasdb/pull/4726#pullrequestreview-397708918", "createdAt": "2020-04-21T22:03:59Z", "commit": {"oid": "f6653971fd81dff19214223b2cff390bfc893263"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjowMzo1OVrOGJaasQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMjowMzo1OVrOGJaasQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyMzE4NQ==", "bodyText": "Do we need to enforce something about the logNamespace, I don't suspect sqlite likes any odd table names?", "url": "https://github.com/palantir/atlasdb/pull/4726#discussion_r412523185", "createdAt": "2020-04-21T22:03:59Z", "author": {"login": "jkozlowski"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -30,26 +30,34 @@\n \n public final class SqlitePaxosStateLog<V extends Persistable & Versionable> implements PaxosStateLog<V> {\n     private final Supplier<Connection> connectionSupplier;\n+    private final String logNamespace;\n \n-    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier) {\n+    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier, String logNamespace) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6653971fd81dff19214223b2cff390bfc893263"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6df56e1cf70b66c17cbccd312929fac67ac6939e", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/6df56e1cf70b66c17cbccd312929fac67ac6939e", "committedDate": "2020-04-27T11:00:14Z", "message": "Resolve merge conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwODU2MTU3", "url": "https://github.com/palantir/atlasdb/pull/4726#pullrequestreview-400856157", "createdAt": "2020-04-27T11:19:11Z", "commit": {"oid": "6df56e1cf70b66c17cbccd312929fac67ac6939e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3085, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}