{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDExNzE1OTI1", "number": 4746, "title": "[PaxosLog] Part 7b: Configuration Sketch :fire: CONTENTIOUS :fire:", "bodyText": "Goals (and why):\n\nAllow us to turn on the SQLite log.\n\nImplementation Description (bullets):\n\nConfiguration looks like (though for now it won't deserialise):\n\ninstall:\n  data-directory: var/data/paxos #file \n  sqlite-persistence: # separate block in case we want more config options\n    data-directory: var/data/meh\n\n\nBan combinations of install and sqlite data directory that are equal, or where one is a subdirectory of the other.\nThere is a minor change in the treatment of isNewService\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nAdded a good number of tests for the interactions between multiple data directories.\n\nConcerns (what feedback would you like?):\n\nDoes this design make sense?\nMy plan here was in some versions of TimeLock > X, setting SQLite characteristics enables validation mode (but will still always treat the file based record as the master). Then in some versions of TimeLock > Y > X, startup consists of executing the SQLite migration, this time for good, and then only using SQLite.\n\nWhere should we start reviewing?: PaxosInstallConfiguration.java\nPriority (whenever / two weeks / yesterday): this week.", "createdAt": "2020-04-30T16:56:56Z", "url": "https://github.com/palantir/atlasdb/pull/4746", "merged": true, "mergeCommit": {"oid": "27800ff7a61ff142959986116406e24a063ddfa8"}, "closed": true, "closedAt": "2020-05-04T17:10:09Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccu5FogH2gAyNDExNzE1OTI1OmRiYjYyOTBiMDQyNDljODA1MWU0NmRlNTMyZDM4NTI3Y2NlZWMyMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceB74HgH2gAyNDExNzE1OTI1OjdhOWRkYTA4ZWM1Yjg5OTk1YmZhZjBjY2FkMDdlN2E5NTYzYzhmYjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dbb6290b04249c8051e46de532d38527cceec204", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/dbb6290b04249c8051e46de532d38527cceec204", "committedDate": "2020-04-30T15:33:57Z", "message": "some changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0e2dc0c8c05454f70b2c5616da5a270489960ec", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/f0e2dc0c8c05454f70b2c5616da5a270489960ec", "committedDate": "2020-04-30T15:54:09Z", "message": "Testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "302c97fbf913e6f186778494631f629b6323e7c8", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/302c97fbf913e6f186778494631f629b6323e7c8", "committedDate": "2020-04-30T16:56:21Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bf4998f7e521f3a213451077e72ab777b5409c7", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/5bf4998f7e521f3a213451077e72ab777b5409c7", "committedDate": "2020-04-30T16:59:43Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzOTE1Mjkw", "url": "https://github.com/palantir/atlasdb/pull/4746#pullrequestreview-403915290", "createdAt": "2020-04-30T22:17:19Z", "commit": {"oid": "5bf4998f7e521f3a213451077e72ab777b5409c7"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMjoxNzoxOVrOGO8Ppw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMjoxODo1NlrOGO8SPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMyMDI5NQ==", "bodyText": "Is there any other config that you need here? Would it not make sense to inline this?", "url": "https://github.com/palantir/atlasdb/pull/4746#discussion_r418320295", "createdAt": "2020-04-30T22:17:19Z", "author": {"login": "jkozlowski"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/config/SqlitePaxosPersistenceConfiguration.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.timelock.config;\n+\n+import java.io.File;\n+\n+import org.immutables.value.Value;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+\n+@Value.Immutable\n+// TODO (jkong): Allow serialization/deserialization, once we want this to actually be configurable\n+public interface SqlitePaxosPersistenceConfiguration {\n+    /**\n+     * Indicates where the SQLite paxos state log files should be stored.\n+     * Should not conflict with any other data directories that may be used by TimeLock to store Paxos state logs.\n+     */\n+    @JsonProperty(\"data-directory\")\n+    File dataDirectory();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bf4998f7e521f3a213451077e72ab777b5409c7"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMyMDk1Nw==", "bodyText": "What if this was required and you actually checked state (meaning whether you already migrated or not/running validation) not just by looking if directories exist, but actually checking an internal sqlite table?", "url": "https://github.com/palantir/atlasdb/pull/4746#discussion_r418320957", "createdAt": "2020-04-30T22:18:56Z", "author": {"login": "jkozlowski"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/config/PaxosInstallConfiguration.java", "diffHunk": "@@ -39,6 +44,9 @@ default File dataDirectory() {\n         return new File(\"var/data/paxos\");\n     }\n \n+    @JsonProperty(\"sqlite-persistence\")\n+    Optional<SqlitePaxosPersistenceConfiguration> sqlitePersistence();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bf4998f7e521f3a213451077e72ab777b5409c7"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MTY3NTMy", "url": "https://github.com/palantir/atlasdb/pull/4746#pullrequestreview-404167532", "createdAt": "2020-05-01T13:48:09Z", "commit": {"oid": "5bf4998f7e521f3a213451077e72ab777b5409c7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxMzo0ODowOVrOGPKJtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxMzo1MjoxN1rOGPKQVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0ODE0OQ==", "bodyText": "This is really tedious, but necessary \ud83c\udf35", "url": "https://github.com/palantir/atlasdb/pull/4746#discussion_r418548149", "createdAt": "2020-05-01T13:48:09Z", "author": {"login": "gmaretic"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/config/PaxosInstallConfiguration.java", "diffHunk": "@@ -76,21 +84,46 @@ default void checkLeaderModeIsNotInAutoMigrationMode() {\n \n     @Value.Check\n     default void check() {\n-        if (isNewService() && dataDirectory().isDirectory()) {\n+        boolean hasExistingDirectory = doesDirectoryAlreadyExist();\n+        if (isNewService() && hasExistingDirectory) {\n             throw new SafeIllegalArgumentException(\n                     \"This timelock server has been configured as a new stack (the 'is-new-service' property is set to \"\n-                            + \"true), but the Paxos data directory already exists. Almost surely this is because it \"\n+                            + \"true), but a Paxos data directory already exists. Almost surely this is because it \"\n                             + \"has already been turned on at least once, and thus the 'is-new-service' property should \"\n                             + \"be set to false for safety reasons.\");\n         }\n \n-        if (!isNewService() && !dataDirectory().isDirectory()) {\n-            throw new SafeIllegalArgumentException(\"The timelock data directory does not appear to exist. If you are \"\n+        if (!isNewService() && !hasExistingDirectory) {\n+            throw new SafeIllegalArgumentException(\"The timelock data directories do not appear to exist. If you are \"\n                     + \"trying to move the nodes on your timelock cluster or add new nodes, you have likely already \"\n                     + \"made a mistake by this point. This is a non-trivial operation and risks service corruption, \"\n                     + \"so contact support for assistance. Otherwise, if this is a new timelock service, please \"\n                     + \"configure paxos.is-new-service to true for the first startup only of each node.\");\n         }\n     }\n+    default boolean doesDirectoryAlreadyExist() {\n+        return dataDirectory().isDirectory() || sqlitePersistence()\n+                .map(SqlitePaxosPersistenceConfiguration::dataDirectory)\n+                .map(File::isDirectory).orElse(false);\n+    }\n \n+    @Value.Check\n+    default void checkSqliteAndFileDataDirectoriesAreNotPossiblyShared() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bf4998f7e521f3a213451077e72ab777b5409c7"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0ODczMg==", "bodyText": "I't kinda funky that this is not an IllegalStateException tbh", "url": "https://github.com/palantir/atlasdb/pull/4746#discussion_r418548732", "createdAt": "2020-05-01T13:49:28Z", "author": {"login": "gmaretic"}, "path": "timelock-agent/src/test/java/com/palantir/timelock/config/PaxosInstallConfigurationIntegrationTest.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.timelock.config;\n+\n+import static org.assertj.core.api.Assertions.assertThatCode;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+public class PaxosInstallConfigurationIntegrationTest {\n+    @Rule\n+    public final TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\n+    private File fileSubdirectory;\n+    private File sqliteSubdirectory;\n+\n+    @Before\n+    public void setUp() {\n+        fileSubdirectory = temporaryFolder.getRoot().toPath().resolve(\"file\").toFile();\n+        sqliteSubdirectory = temporaryFolder.getRoot().toPath().resolve(\"sqlite\").toFile();\n+    }\n+\n+    @Test\n+    public void serviceIsNewIfNoDataDirectoriesPresent() {\n+        ImmutablePaxosInstallConfiguration.Builder partialConfiguration = createPartialConfiguration(\n+                fileSubdirectory, sqliteSubdirectory);\n+        assertThatCode(() -> partialConfiguration.isNewService(true).build()).doesNotThrowAnyException();\n+        assertThatThrownBy(() -> partialConfiguration.isNewService(false).build())\n+                .isInstanceOf(IllegalArgumentException.class)\n+                .hasMessageContaining(\"The timelock data directories do not appear to exist.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bf4998f7e521f3a213451077e72ab777b5409c7"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU0OTg0NA==", "bodyText": "Both of these tests have both base and sqlite?", "url": "https://github.com/palantir/atlasdb/pull/4746#discussion_r418549844", "createdAt": "2020-05-01T13:52:17Z", "author": {"login": "gmaretic"}, "path": "timelock-agent/src/test/java/com/palantir/timelock/config/PaxosInstallConfigurationIntegrationTest.java", "diffHunk": "@@ -0,0 +1,141 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.timelock.config;\n+\n+import static org.assertj.core.api.Assertions.assertThatCode;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+public class PaxosInstallConfigurationIntegrationTest {\n+    @Rule\n+    public final TemporaryFolder temporaryFolder = new TemporaryFolder();\n+\n+    private File fileSubdirectory;\n+    private File sqliteSubdirectory;\n+\n+    @Before\n+    public void setUp() {\n+        fileSubdirectory = temporaryFolder.getRoot().toPath().resolve(\"file\").toFile();\n+        sqliteSubdirectory = temporaryFolder.getRoot().toPath().resolve(\"sqlite\").toFile();\n+    }\n+\n+    @Test\n+    public void serviceIsNewIfNoDataDirectoriesPresent() {\n+        ImmutablePaxosInstallConfiguration.Builder partialConfiguration = createPartialConfiguration(\n+                fileSubdirectory, sqliteSubdirectory);\n+        assertThatCode(() -> partialConfiguration.isNewService(true).build()).doesNotThrowAnyException();\n+        assertThatThrownBy(() -> partialConfiguration.isNewService(false).build())\n+                .isInstanceOf(IllegalArgumentException.class)\n+                .hasMessageContaining(\"The timelock data directories do not appear to exist.\");\n+    }\n+\n+    @Test\n+    public void serviceIsNotNewIfBaseDataDirectoryIsPresent() {\n+        ImmutablePaxosInstallConfiguration.Builder partialConfiguration = createPartialConfiguration(\n+                getAndCreateRandomSubdirectory(), sqliteSubdirectory);\n+        assertIsNotNewService(partialConfiguration);\n+    }\n+\n+    @Test\n+    public void serviceIsNotNewIfSqliteDataDirectoryIsPresent() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5bf4998f7e521f3a213451077e72ab777b5409c7"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a407684c63ca827504c2f758767971d7a424d97", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/1a407684c63ca827504c2f758767971d7a424d97", "committedDate": "2020-05-01T14:41:50Z", "message": "CR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MjAwNjc5", "url": "https://github.com/palantir/atlasdb/pull/4746#pullrequestreview-404200679", "createdAt": "2020-05-01T14:49:24Z", "commit": {"oid": "1a407684c63ca827504c2f758767971d7a424d97"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "664ad13f0246edab27c256b8899f41afea9d6c61", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/664ad13f0246edab27c256b8899f41afea9d6c61", "committedDate": "2020-05-04T11:22:22Z", "message": "Fix bad mocks in test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73708c20008e5c26d06f4859ba7ad68419bb3615", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/73708c20008e5c26d06f4859ba7ad68419bb3615", "committedDate": "2020-05-04T15:51:17Z", "message": "Merge branch 'develop' into jkong/psl-config-round-2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a9dda08ec5b89995bfaf0ccad07e7a9563c8fb1", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/7a9dda08ec5b89995bfaf0ccad07e7a9563c8fb1", "committedDate": "2020-05-04T16:19:07Z", "message": "PaxosInstallConfigIntegrationTest fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3119, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}