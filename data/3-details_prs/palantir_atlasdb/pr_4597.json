{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5NTMxNDYz", "number": 4597, "title": "[LW] Synchronise Issuing Start Timestamps with Lock Event Log", "bodyText": "Goals (and why):\nWe need to have a consistent view of lock watch state as start timestamps are issued. This avoids some convoluted race conditions that could impact correctness.\nImplementation Description (bullets):\nPretty straightforward, mostly wiring: after locking the immutable timestamp lock we enter a synchronised block in the lock event log (ensuring nothing can get logged), take out the start timestamps and get the current log version. After exiting the synchronised block, we get the list of events between last known version and the version that came with the timestamps.\nTesting (What was existing testing like?  What have you done to improve it?):\nNo additional testing since it's mostly wiring\nConcerns (what feedback would you like?):\nOther than the perf concerns that we will test out, nothing really.\nWhere should we start reviewing?:\nsmall\nPriority (whenever / two weeks / yesterday):\nWednesday?", "createdAt": "2020-02-25T11:43:15Z", "url": "https://github.com/palantir/atlasdb/pull/4597", "merged": true, "mergeCommit": {"oid": "164656270d2e2fcc2282cdd6d851f30807252bcc"}, "closed": true, "closedAt": "2020-03-04T17:28:02Z", "author": {"login": "gmaretic"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGIxlvAH2gAyMzc5NTMxNDYzOjg3NDBhYjliMGViOGU4ZGFmNGQyZDgxNTIyMzE3MzhkMDdkNDI0OGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKZlrDAH2gAyMzc5NTMxNDYzOjkxOTE2YmQyNjUwYjJhYWRmYmJmZjU2ZDNhN2MyMGIwODBjNTZiM2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8740ab9b0eb8e8daf4d2d8152231738d07d4248e", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/8740ab9b0eb8e8daf4d2d8152231738d07d4248e", "committedDate": "2020-02-20T10:43:02Z", "message": "Be better, one day at a time. Also fix nasty concurrency issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c3a9d273d2ff4ec589001af51cb408ed67b14fa", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/2c3a9d273d2ff4ec589001af51cb408ed67b14fa", "committedDate": "2020-02-21T16:58:50Z", "message": "Rework lock watch updates and registration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d311fef3558808de8fa7bf90975ff50d3b7115d7", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/d311fef3558808de8fa7bf90975ff50d3b7115d7", "committedDate": "2020-02-24T10:46:42Z", "message": "Merge with develop"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "121eada2e9528cbedc9c694d7067a0d8eea5421a", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/121eada2e9528cbedc9c694d7067a0d8eea5421a", "committedDate": "2020-02-24T11:34:03Z", "message": "Do not filter unlocks for replayer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "413cc995a5ed5ff3de45629bf34f778e663e3be1", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/413cc995a5ed5ff3de45629bf34f778e663e3be1", "committedDate": "2020-02-24T11:44:02Z", "message": "Add test for snapshot reflecting events logged during open locks calculation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a12258917f0e78113097570b87fbcd5c3361e110", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/a12258917f0e78113097570b87fbcd5c3361e110", "committedDate": "2020-02-24T14:25:02Z", "message": "Implement atomic start transactions + get last known version on timelock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e1266f1bf1d4029c383707fb30ef3b24c7f9712", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/9e1266f1bf1d4029c383707fb30ef3b24c7f9712", "committedDate": "2020-02-25T11:36:57Z", "message": "Return snapshot for failure to compute exact lock watch state on start transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf6ebffcfcb11a927ec67a4c5a12c215bb1129f3", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/cf6ebffcfcb11a927ec67a4c5a12c215bb1129f3", "committedDate": "2020-02-25T11:39:24Z", "message": "Undo method rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a51389da548ef32cf664d037501b5c307e184be", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/5a51389da548ef32cf664d037501b5c307e184be", "committedDate": "2020-02-26T17:49:48Z", "message": "Fix merge conflicts with develop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NDc1OTg3", "url": "https://github.com/palantir/atlasdb/pull/4597#pullrequestreview-367475987", "createdAt": "2020-03-02T19:44:03Z", "commit": {"oid": "5a51389da548ef32cf664d037501b5c307e184be"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxOTo0NDowM1rOFwszAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQyMDowMzozMVrOFwtZ6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYwOTkyMA==", "bodyText": "nit: space", "url": "https://github.com/palantir/atlasdb/pull/4597#discussion_r386609920", "createdAt": "2020-03-02T19:44:03Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/lock/watch/ValueAndVersion.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.lock.watch;\n+\n+import org.immutables.value.Value;\n+\n+@Value.Immutable\n+@Value.Style(visibility = Value.Style.ImplementationVisibility.PACKAGE)\n+public interface ValueAndVersion<T> {\n+    @Value.Parameter\n+    long version();\n+    @Value.Parameter\n+    T value();\n+\n+    static <R> ValueAndVersion<R> of (long version, R result) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a51389da548ef32cf664d037501b5c307e184be"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYxOTg4MQ==", "bodyText": "maybe verbose, but would prefer ...WatchStateVersion perhaps given that this is on the super-interface  AsyncTimelockService", "url": "https://github.com/palantir/atlasdb/pull/4597#discussion_r386619881", "createdAt": "2020-03-02T20:03:31Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/lock/watch/LockWatchingService.java", "diffHunk": "@@ -27,7 +28,8 @@\n public interface LockWatchingService {\n     void startWatching(LockWatchRequest locksToWatch);\n     LockWatchStateUpdate getWatchStateUpdate(OptionalLong lastKnownVersion);\n-\n+    LockWatchStateUpdate getWatchStateUpdate(OptionalLong lastKnownVersion, long endVersion);\n+    <T> ValueAndVersion<T> runTaskAndAtomicallyReturnVersion(Supplier<T> task);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a51389da548ef32cf664d037501b5c307e184be"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9171c126ca2228d169db94db79dfd6e379aad149", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/9171c126ca2228d169db94db79dfd6e379aad149", "committedDate": "2020-03-04T16:27:13Z", "message": "Fix merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91916bd2650b2aadfbbff56d3a7c20b080c56b3a", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/91916bd2650b2aadfbbff56d3a7c20b080c56b3a", "committedDate": "2020-03-04T16:34:06Z", "message": "CR"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2282, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}