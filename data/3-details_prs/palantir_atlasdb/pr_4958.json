{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNTE2MDg2", "number": 4958, "title": "[LW] Fixes, 2: Stop time travelling", "bodyText": "Goals (and why):\n\nStop breaking things - in particular, if the client was on the same version as Atlas, then it would try and get events after current + 1 and up to current - this caused the error where fromKey > toKey.\n\nImplementation Description (bullets):\n\nReturn an empty list when the from version is greater than the to version - as described above, this is actually a potentially valid situation.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nAdded a test in the integration tests to catch this. I wrote the test before the fix, and the test failed then.\n\nConcerns (what feedback would you like?):\n\nSanity check that the result is the same in all cases barring fromKey > toKey.\n\nWhere should we start reviewing?:\nVersionedEventStore\nPriority (whenever / two weeks / yesterday):\nToday", "createdAt": "2020-08-21T09:17:04Z", "url": "https://github.com/palantir/atlasdb/pull/4958", "merged": true, "mergeCommit": {"oid": "c96ecfbf380b3ffc92aa050e01899c4e8231bd4a"}, "closed": true, "closedAt": "2020-08-21T10:04:30Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBBJHIgH2gAyNDcxNTE2MDg2OmJlMzg0NGI5ZDk2OWZkOTQxOTFmZmQ3NzU2OTI0OWQ4YmMxN2MxODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBBs8GgH2gAyNDcxNTE2MDg2OjE1Njk0YjUxODU4M2Y5ZWYxNDY0Mjg3YmE2MDc3MzBjNWQ5NzVlMmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "be3844b9d969fd94191ffd77569249d8bc17c188", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/be3844b9d969fd94191ffd77569249d8bc17c188", "committedDate": "2020-08-21T09:11:01Z", "message": "stop time travelling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad7330d5e22a51094546cfdf619b33f8d4b475cc", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/ad7330d5e22a51094546cfdf619b33f8d4b475cc", "committedDate": "2020-08-21T09:11:01Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ca61736440369dcd43aaeab584d9c34f94aa3f4", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/3ca61736440369dcd43aaeab584d9c34f94aa3f4", "committedDate": "2020-08-21T09:17:54Z", "message": "make test a bit tighter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afba760e72f4bb440a6eb0c139cb80c1d6c5a513", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/afba760e72f4bb440a6eb0c139cb80c1d6c5a513", "committedDate": "2020-08-21T09:18:05Z", "message": "Merge branch 'time-travel-is-dangerous' of github.com:palantir/atlasdb into time-travel-is-dangerous"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMzQxNjQ0", "url": "https://github.com/palantir/atlasdb/pull/4958#pullrequestreview-472341644", "createdAt": "2020-08-21T09:26:48Z", "commit": {"oid": "afba760e72f4bb440a6eb0c139cb80c1d6c5a513"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMzQ0NjQ5", "url": "https://github.com/palantir/atlasdb/pull/4958#pullrequestreview-472344649", "createdAt": "2020-08-21T09:31:13Z", "commit": {"oid": "afba760e72f4bb440a6eb0c139cb80c1d6c5a513"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwOTozMToxNFrOHEl3uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwOTozMToxNFrOHEl3uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDU3NjgyNw==", "bodyText": "This is a little funky, but the alternative I had in mind to avoid the optional nesting has its own messy implementation detail leaking around:\nStream.of(() -> maybeStartVersion, this::getFirstKey)\n        .map(Supplier::get)\n        .filter(version -> version <= endVersion)\n        .findFirst();", "url": "https://github.com/palantir/atlasdb/pull/4958#discussion_r474576827", "createdAt": "2020-08-21T09:31:14Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/VersionedEventStore.java", "diffHunk": "@@ -35,10 +35,14 @@\n     private final NavigableMap<Long, LockWatchEvent> eventMap = new TreeMap<>();\n \n     Collection<LockWatchEvent> getEventsBetweenVersionsInclusive(Optional<Long> maybeStartVersion, long endVersion) {\n-        return ImmutableSet.copyOf(maybeStartVersion.map(\n-                startVersion -> getValuesBetweenInclusive(endVersion, startVersion))\n-                .orElseGet(() -> getFirstKey().map(firstKey -> getValuesBetweenInclusive(endVersion, firstKey))\n-                        .orElseGet(ImmutableList::of)));\n+        Optional<Long> startVersion = maybeStartVersion\n+                .map(Optional::of)\n+                .orElseGet(this::getFirstKey)\n+                .filter(version -> version <= endVersion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afba760e72f4bb440a6eb0c139cb80c1d6c5a513"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6b7f0ed9a2e256385c294dd22d2b6a4f9f9d10a", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/e6b7f0ed9a2e256385c294dd22d2b6a4f9f9d10a", "committedDate": "2020-08-21T09:34:48Z", "message": "fix nits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15694b518583f9ef1464287ba607730c5d975e2c", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/15694b518583f9ef1464287ba607730c5d975e2c", "committedDate": "2020-08-21T09:50:09Z", "message": "I need to stop adding imports"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2809, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}