{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MDQ4MjAz", "number": 4642, "title": "Allow easy migration from/to thorough sweep", "bodyText": "This PR adds a new sweep strategy, thorough_migration.\nIt forces the lock checking of thorough sweep, whilst actually behaving\nlike conservative sweep.\nIn this way, to migrate to thorough sweep, you simply:\n\nMake sure all nodes are running code that knows about thorough_migration (via e.g. schema version bump).\nChange to thorough_migration.\nMake sure all nodes are on the new version (via e.g. schema version\nbump).\nChange to thorough.\n\nThis can also be tested on a single stack. Here, we'd add a config point for the sweep strategy, and when initializing the schema object, pass it in. Provided one guarantees that one goes through the intermediate stage (via e.g. observing), this is a safe test.\nWould also flag that the current method that we recommend for migrating to thorough is wrong. If you look at SnapshotTransaction.requiresImmutableTimestampLocking, you can see that it only applies the locking for tables that it thinks should be thoroughly swept, so the docs and internal procedures are incorrect and provide no safety guarantees #4544.", "createdAt": "2020-03-10T10:22:24Z", "url": "https://github.com/palantir/atlasdb/pull/4642", "merged": true, "mergeCommit": {"oid": "1801b5f0299b28dca33891c92bd853f23a28dda0"}, "closed": true, "closedAt": "2020-03-10T17:44:54Z", "author": {"login": "j-baker"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMP1XFAH2gAyMzg2MDQ4MjAzOjE0MTgwZjI1MTgyZmUzYTgxYjcyNDZjOWI1MmFhNWM5NGZhZmViMGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMV8sAAH2gAyMzg2MDQ4MjAzOmZhNDcxNGY2ZjFmMzcyY2ZmNTUyMDMyYTZiODlkNWUzYmFhZmU5ODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "14180f25182fe3a81b7246c9b52aa5c94fafeb0d", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/14180f25182fe3a81b7246c9b52aa5c94fafeb0d", "committedDate": "2020-03-10T10:20:02Z", "message": "Allow easy migration from/to thorough sweep\n\nThis PR adds a new sweep strategy, thorough_migration.\nIt forces the lock checking of thorough sweep, whilst actually behaving\nlike conservative sweep.\n\nIn this way, to migrate to thorough sweep, you simply:\n\n1. Change to thorough_migration.\n2. Make sure all nodes are on the new version (via e.g. schema version\nbump).\n3. Change to thorough.\n\nSame in reverse safely migrates you back to conservative."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf78b7e02ad872e884fd00f733f306e20256ba82", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/cf78b7e02ad872e884fd00f733f306e20256ba82", "committedDate": "2020-03-10T10:24:36Z", "message": "To thorough"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8048dff399ed9eddb8b800efd36d4ee9300c5ad", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/a8048dff399ed9eddb8b800efd36d4ee9300c5ad", "committedDate": "2020-03-10T10:36:12Z", "message": "Fix writeinfo partitioner"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc729cfaede9eed0b72cab1c9fa821784b155ff", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/4fc729cfaede9eed0b72cab1c9fa821784b155ff", "committedDate": "2020-03-10T10:45:06Z", "message": "Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f95ba182e66f27aa369bc5ddab66edef207b97a", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/9f95ba182e66f27aa369bc5ddab66edef207b97a", "committedDate": "2020-03-10T10:45:06Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b447f76217fb642d1121c61e54c954c4b63b67a0", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/b447f76217fb642d1121c61e54c954c4b63b67a0", "committedDate": "2020-03-10T10:54:57Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8051a690de3e01427e0b8d7dde4d923aff9937a7", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/8051a690de3e01427e0b8d7dde4d923aff9937a7", "committedDate": "2020-03-10T10:55:14Z", "message": "t push\nMerge branch 'jbaker/to_thorough' of github.com:palantir/atlasdb into jbaker/to_thorough"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27d636fb2967ef7bab814e3a2b833d9af15fa711", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/27d636fb2967ef7bab814e3a2b833d9af15fa711", "committedDate": "2020-03-10T12:46:26Z", "message": "Imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cf09d8315003c40c11c377e3b0e91260f79683a", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/5cf09d8315003c40c11c377e3b0e91260f79683a", "committedDate": "2020-03-10T12:46:26Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMDQ2ODk0", "url": "https://github.com/palantir/atlasdb/pull/4642#pullrequestreview-372046894", "createdAt": "2020-03-10T15:12:07Z", "commit": {"oid": "27d636fb2967ef7bab814e3a2b833d9af15fa711"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNToxMjowN1rOF0TcDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNToxMjowN1rOF0TcDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM4ODc1MA==", "bodyText": "Could we change the message to something like - \"Can only read from a table with a no/conservative sweep strategy in a read only transaction.\" ?", "url": "https://github.com/palantir/atlasdb/pull/4642#discussion_r390388750", "createdAt": "2020-03-10T15:12:07Z", "author": {"login": "sudiksha27"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/transaction/impl/ReadTransaction.java", "diffHunk": "@@ -127,7 +126,7 @@ public Transaction delegate() {\n \n     private void checkTableName(TableReference tableRef) {\n         SweepStrategy sweepStrategy = sweepStrategies.get(tableRef);\n-        if (sweepStrategy == SweepStrategy.THOROUGH) {\n+        if (sweepStrategy.mustCheckImmutableLockAfterReads()) {\n             throw new SafeIllegalStateException(\n                     \"Cannot read from a table with a thorough sweep strategy in a read only transaction.\");\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d636fb2967ef7bab814e3a2b833d9af15fa711"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMDg4MzIx", "url": "https://github.com/palantir/atlasdb/pull/4642#pullrequestreview-372088321", "createdAt": "2020-03-10T15:55:15Z", "commit": {"oid": "27d636fb2967ef7bab814e3a2b833d9af15fa711"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTo1NToxNlrOF0VcHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTo1NToxNlrOF0VcHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQyMTUzMg==", "bodyText": "I guess this is fine, would add a bit of caution saying please talk to the AtlasDB team before you do this (if someone forgets that you must e.g. declare an internal schema version in internal framework, then they open themselves to corruption).", "url": "https://github.com/palantir/atlasdb/pull/4642#discussion_r390421532", "createdAt": "2020-03-10T15:55:16Z", "author": {"login": "jeremyk-91"}, "path": "changelog/@unreleased/pr-4642.v2.yml", "diffHunk": "@@ -0,0 +1,5 @@\n+type: improvement\n+improvement:\n+  description: Allow easy migration from/to thorough sweep", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27d636fb2967ef7bab814e3a2b833d9af15fa711"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTYzMjEx", "url": "https://github.com/palantir/atlasdb/pull/4642#pullrequestreview-372163211", "createdAt": "2020-03-10T17:20:28Z", "commit": {"oid": "5cf09d8315003c40c11c377e3b0e91260f79683a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "382c5d78462bcceb1e76ad6937bbd8318d66cca8", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/382c5d78462bcceb1e76ad6937bbd8318d66cca8", "committedDate": "2020-03-10T17:27:05Z", "message": "Error message change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa4714f6f1f372cff552032a6b89d5e3baafe983", "author": {"user": {"login": "j-baker", "name": "James Baker"}}, "url": "https://github.com/palantir/atlasdb/commit/fa4714f6f1f372cff552032a6b89d5e3baafe983", "committedDate": "2020-03-10T17:27:28Z", "message": "Merge branch 'jbaker/to_thorough' of github.com:palantir/atlasdb into jbaker/to_thorough"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3134, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}