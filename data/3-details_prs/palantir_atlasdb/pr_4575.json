{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1MTIyNjE3", "number": 4575, "title": "[Conjure Java Runtime] Part 28: Modernisation and Recovery of Jepsen", "bodyText": "Goals (and why):\n\nGet the Jepsen tests working again. They would have been useful for an issue like PDS-109527: I haven't tested this, but am quite confident that running timestamp verification with the partition-random-halves nemesis could have exposed the split-brain scenario that we were vulnerable to.\nThis PR does NOT include ways of making the Jepsen test results more visible, though that is something I would like to do in the medium term. I think we stopped looking at it because the idea was that no one should ever touch core TimeLock again, but there are a lot of pieces in AtlasDB that we don't always realise influence core TimeLock - or we do (as in PDS-109527) but don't see awkward race conditions - this is what fuzzing is great at doing.\n\nImplementation Description (bullets):\n\nThis PR restores operation of the Jepsen infrastructure through some problematic changes for Conjure Java Runtime and other relevant breaks:\n\n\nOracle changed their policy around the use of Java 8 JDKs. To fix this, I switched to OpenJDK. Unfortunately this was not entirely trivial because the Docker image for tjake/jepsen doesn't seem to be updated to deal with this (even though Jepsen itself has), and java-8-openjdk is part of stretch (think stable) but not jessie (think super-stable) debian repositories, which is what we were on.\nConjure Java Runtime requires the use of SSL. Fair enough, but again nontrivial because the old servers weren't set up to use SSL at all, and the standard certificates we have will fail hostname verification (since the nodes are hardcoded to n1 through n5).\nThere were considerable breaks to the API endpoints to allow for namespace-agnostic clients. This was much easier to address than the first two issues.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nI ran the Jepsen tests through gradle and verified that connections were being made, actual nontrivial responses were being returned (i.e. numbers for timestamp, lock tokens for lock), and the tests passed.\n\nConcerns (what feedback would you like?):\n\nThis works on my machine, is there a reason to believe it won't on internal test stack?\n\nWhere should we start reviewing?: Follow the flow of the breaks described above.\nPriority (whenever / two weeks / yesterday): should have been 4 months ago, but this week isn't too bad \ud83d\udd25\n@j-baker for SA, we discussed this offline.\n@Jolyon-S I think you might find this one interesting, though would like to have Felix or Grgur take a pass before we merge", "createdAt": "2020-02-13T22:37:18Z", "url": "https://github.com/palantir/atlasdb/pull/4575", "merged": true, "mergeCommit": {"oid": "3ada38c52e54ada5d080e53a154cd72d4509f3b9"}, "closed": true, "closedAt": "2020-03-03T16:10:37Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcECflIgH2gAyMzc1MTIyNjE3OmI1MDU5ZWQ0MWU2NjkyYjE5ZTFhM2E0NmJiMGNjMWZkODdhYTRlMDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKDcktgH2gAyMzc1MTIyNjE3OjhhNjAwYjZmZjRiOTVkNjk2N2Y3MTZmNjFjMjExNjllMGVhMjYwMDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b5059ed41e6692b19e1a3a46bb0cc1fd87aa4e09", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/b5059ed41e6692b19e1a3a46bb0cc1fd87aa4e09", "committedDate": "2020-02-13T22:16:05Z", "message": "Use openjdk"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94a061fd723bcb0c7a416306cea58d45ee0960e3", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/94a061fd723bcb0c7a416306cea58d45ee0960e3", "committedDate": "2020-02-13T22:16:05Z", "message": "Security"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41dc5465a4c636e15a384ef4ad68665b355e394c", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/41dc5465a4c636e15a384ef4ad68665b355e394c", "committedDate": "2020-02-13T22:16:05Z", "message": "More stuff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "987daee087a3593f2b923e01cb0f31ff88bd54fd", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/987daee087a3593f2b923e01cb0f31ff88bd54fd", "committedDate": "2020-02-13T22:31:31Z", "message": "Fix bad naming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NjMzNDg0", "url": "https://github.com/palantir/atlasdb/pull/4575#pullrequestreview-359633484", "createdAt": "2020-02-17T10:31:13Z", "commit": {"oid": "987daee087a3593f2b923e01cb0f31ff88bd54fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMDozMToxM1rOFqfjwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMDozMToxM1rOFqfjwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEwMTU2OQ==", "bodyText": "Why don't we use UserAgent.Agent.DEFAULT_VERSION anymore?", "url": "https://github.com/palantir/atlasdb/pull/4575#discussion_r380101569", "createdAt": "2020-02-17T10:31:13Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java", "diffHunk": "@@ -43,21 +46,26 @@ private TimelockUtils() {\n     }\n \n     private static List<String> hostnamesToEndpointUris(List<String> hosts) {\n-        return Lists.transform(hosts, host -> String.format(\"https://%s:%d/%s\", host, PORT, NAMESPACE));\n+        return hosts.stream().map(host -> String.format(\"https://%s:%d\", host, PORT)).collect(Collectors.toList());\n     }\n \n     private static <T> T createFromUris(MetricsManager metricsManager, List<String> endpointUris, Class<T> type) {\n+        ServerListConfig serverListConfig = ImmutableServerListConfig.builder()\n+                .addAllServers(endpointUris)\n+                .sslConfiguration(SSL_CONFIGURATION)\n+                .build();\n+        // lock technically blocking, but OK to run with short timeout given the way the tests work.\n+        AuxiliaryRemotingParameters build = AuxiliaryRemotingParameters.builder()\n+                .shouldRetry(false)\n+                .shouldLimitPayload(false)\n+                .shouldSupportBlockingOperations(false)\n+                .userAgent(UserAgent.of(UserAgent.Agent.of(\"atlasdb-jepsen\", \"1.2.3\")))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987daee087a3593f2b923e01cb0f31ff88bd54fd"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NzQ4ODQx", "url": "https://github.com/palantir/atlasdb/pull/4575#pullrequestreview-359748841", "createdAt": "2020-02-17T13:52:38Z", "commit": {"oid": "987daee087a3593f2b923e01cb0f31ff88bd54fd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMzo1MjozOFrOFqlLTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxMzo1NDo0M1rOFqlPmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5MzYxMg==", "bodyText": "I imagine it's slightly more identifiable, but can't think of another reason other than that \ud83e\udd37\u200d\u2642", "url": "https://github.com/palantir/atlasdb/pull/4575#discussion_r380193612", "createdAt": "2020-02-17T13:52:38Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java", "diffHunk": "@@ -43,21 +46,26 @@ private TimelockUtils() {\n     }\n \n     private static List<String> hostnamesToEndpointUris(List<String> hosts) {\n-        return Lists.transform(hosts, host -> String.format(\"https://%s:%d/%s\", host, PORT, NAMESPACE));\n+        return hosts.stream().map(host -> String.format(\"https://%s:%d\", host, PORT)).collect(Collectors.toList());\n     }\n \n     private static <T> T createFromUris(MetricsManager metricsManager, List<String> endpointUris, Class<T> type) {\n+        ServerListConfig serverListConfig = ImmutableServerListConfig.builder()\n+                .addAllServers(endpointUris)\n+                .sslConfiguration(SSL_CONFIGURATION)\n+                .build();\n+        // lock technically blocking, but OK to run with short timeout given the way the tests work.\n+        AuxiliaryRemotingParameters build = AuxiliaryRemotingParameters.builder()\n+                .shouldRetry(false)\n+                .shouldLimitPayload(false)\n+                .shouldSupportBlockingOperations(false)\n+                .userAgent(UserAgent.of(UserAgent.Agent.of(\"atlasdb-jepsen\", \"1.2.3\")))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDEwMTU2OQ=="}, "originalCommit": {"oid": "987daee087a3593f2b923e01cb0f31ff88bd54fd"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5NDA0Mw==", "bodyText": "why is this okay? what happens if you make it the same as how it's used in prod?", "url": "https://github.com/palantir/atlasdb/pull/4575#discussion_r380194043", "createdAt": "2020-02-17T13:53:25Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java", "diffHunk": "@@ -43,21 +46,26 @@ private TimelockUtils() {\n     }\n \n     private static List<String> hostnamesToEndpointUris(List<String> hosts) {\n-        return Lists.transform(hosts, host -> String.format(\"https://%s:%d/%s\", host, PORT, NAMESPACE));\n+        return hosts.stream().map(host -> String.format(\"https://%s:%d\", host, PORT)).collect(Collectors.toList());\n     }\n \n     private static <T> T createFromUris(MetricsManager metricsManager, List<String> endpointUris, Class<T> type) {\n+        ServerListConfig serverListConfig = ImmutableServerListConfig.builder()\n+                .addAllServers(endpointUris)\n+                .sslConfiguration(SSL_CONFIGURATION)\n+                .build();\n+        // lock technically blocking, but OK to run with short timeout given the way the tests work.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987daee087a3593f2b923e01cb0f31ff88bd54fd"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDE5NDcxNQ==", "bodyText": "nit: build -> parameters", "url": "https://github.com/palantir/atlasdb/pull/4575#discussion_r380194715", "createdAt": "2020-02-17T13:54:43Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-jepsen-tests/src/main/java/com/palantir/atlasdb/http/TimelockUtils.java", "diffHunk": "@@ -43,21 +46,26 @@ private TimelockUtils() {\n     }\n \n     private static List<String> hostnamesToEndpointUris(List<String> hosts) {\n-        return Lists.transform(hosts, host -> String.format(\"https://%s:%d/%s\", host, PORT, NAMESPACE));\n+        return hosts.stream().map(host -> String.format(\"https://%s:%d\", host, PORT)).collect(Collectors.toList());\n     }\n \n     private static <T> T createFromUris(MetricsManager metricsManager, List<String> endpointUris, Class<T> type) {\n+        ServerListConfig serverListConfig = ImmutableServerListConfig.builder()\n+                .addAllServers(endpointUris)\n+                .sslConfiguration(SSL_CONFIGURATION)\n+                .build();\n+        // lock technically blocking, but OK to run with short timeout given the way the tests work.\n+        AuxiliaryRemotingParameters build = AuxiliaryRemotingParameters.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "987daee087a3593f2b923e01cb0f31ff88bd54fd"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMjA4MDk5", "url": "https://github.com/palantir/atlasdb/pull/4575#pullrequestreview-361208099", "createdAt": "2020-02-19T15:56:36Z", "commit": {"oid": "987daee087a3593f2b923e01cb0f31ff88bd54fd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc7552f3444ffedf2182a60ada34111b76a5cb6d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/fc7552f3444ffedf2182a60ada34111b76a5cb6d", "committedDate": "2020-02-24T17:06:29Z", "message": "CR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d9ed3a6eb655cc5bfb8c25e8d79b54059b480bd", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/9d9ed3a6eb655cc5bfb8c25e8d79b54059b480bd", "committedDate": "2020-02-24T17:22:38Z", "message": "Give certs expiry dates probably long after AtlasDB stops being used."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80c4d4964af0768660e49b349bf1b55d9b056de9", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/80c4d4964af0768660e49b349bf1b55d9b056de9", "committedDate": "2020-02-24T17:37:01Z", "message": "Merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "018016bfb1b1a3dfb03cf6cd4f32bc623526d4b8", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/018016bfb1b1a3dfb03cf6cd4f32bc623526d4b8", "committedDate": "2020-03-03T11:20:36Z", "message": "Fix timestamp client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a600b6ff4b95d6967f716f61c21169e0ea26001", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/8a600b6ff4b95d6967f716f61c21169e0ea26001", "committedDate": "2020-03-03T14:46:15Z", "message": "Make us assume stuff blocks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2258, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}