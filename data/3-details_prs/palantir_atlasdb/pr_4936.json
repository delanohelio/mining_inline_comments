{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1OTg4MTU4", "number": 4936, "title": "[PD$-110002] Part 14: TargetedSweepOutcomes should be protected by the TargetedSweepMetricsPublicationFilter", "bodyText": "Goals (and why):\n\nSave money\n\nImplementation Description (bullets):\n\nDon't publish targeted sweep metrics if the filter rejects them.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nTargetedSweepMetricsTest should validate I haven't broken anything.\n\nConcerns (what feedback would you like?):\n\nIf targeted sweep is broken and ERRORing then we won't know via metrics until 1,000 writes have been enqueued or we are 4 hours behind. Is this too much of a price to pay? This is still available in logs (\"Targeted sweep for {} failed and will be retried later\").\nDid I accidentally slip in a memory leak? See #4930\n\nWhere should we start reviewing?: SweepOutcomeMetrics\nPriority (whenever / two weeks / yesterday): this week: not massively high priority, but would like to close this workstream out.", "createdAt": "2020-08-11T09:34:54Z", "url": "https://github.com/palantir/atlasdb/pull/4936", "merged": true, "mergeCommit": {"oid": "962e597b5af6a976cba990aee6e3108f02b52ebd"}, "closed": true, "closedAt": "2020-08-13T10:51:59Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9za2ggH2gAyNDY1OTg4MTU4OjdkYmUwNmRmYjZiZDI5ZDkyYTdkYmNkMjM3NmE4NDJkYjE2Y2M0MjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc96l8WAFqTQ2NTI5NjEyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7dbe06dfb6bd29d92a7dbcd2376a842db16cc421", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/7dbe06dfb6bd29d92a7dbcd2376a842db16cc421", "committedDate": "2020-08-11T09:29:57Z", "message": "Guard TS outcomes by the filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0550da3b629d867113bc073d813b10cf60754a2d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/0550da3b629d867113bc073d813b10cf60754a2d", "committedDate": "2020-08-11T09:29:57Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MDE0MjIy", "url": "https://github.com/palantir/atlasdb/pull/4936#pullrequestreview-465014222", "createdAt": "2020-08-11T12:26:39Z", "commit": {"oid": "0550da3b629d867113bc073d813b10cf60754a2d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMjoyNjozOVrOG-1dUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMjoyNjozOVrOG-1dUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU0MDc1NQ==", "bodyText": "can we have tests for this change?", "url": "https://github.com/palantir/atlasdb/pull/4936#discussion_r468540755", "createdAt": "2020-08-11T12:26:39Z", "author": {"login": "sudiksha27"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/sweep/metrics/SweepOutcomeMetrics.java", "diffHunk": "@@ -71,15 +86,24 @@ public void registerOccurrenceOf(SweepOutcome outcome) {\n             MetricsManager manager,\n             List<SweepOutcome> outcomes,\n             Map<String, String> additionalTags,\n-            Class<?> forClass) {\n+            Class<?> forClass,\n+            Optional<MetricPublicationFilter> filter) {\n         return Suppliers.memoize(() -> {\n             Metrics metrics = ImmutableSweepOutcomeMetrics.Metrics.builder().build();\n-            outcomes.forEach(outcome -> manager.registerOrGet(forClass, AtlasDbMetricNames.SWEEP_OUTCOME,\n-                    () -> getOutcomeCount(metrics, outcome),\n-                    ImmutableMap.<String, String>builder()\n-                            .putAll(additionalTags)\n-                            .put(AtlasDbMetricNames.TAG_OUTCOME, outcome.name())\n-                            .build()));\n+            outcomes.forEach(outcome -> {\n+                ImmutableMap<String, String> tags = ImmutableMap.<String, String>builder()\n+                        .putAll(additionalTags)\n+                        .put(AtlasDbMetricNames.TAG_OUTCOME, outcome.name())\n+                        .build();\n+                filter.ifPresent(presentFilter -> manager.addMetricFilter(\n+                        forClass,\n+                        AtlasDbMetricNames.SWEEP_OUTCOME,\n+                        tags,\n+                        filter.get()));\n+                manager.registerOrGet(forClass, AtlasDbMetricNames.SWEEP_OUTCOME,\n+                        () -> getOutcomeCount(metrics, outcome),\n+                        tags);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0550da3b629d867113bc073d813b10cf60754a2d"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92299b00a200759e58988b62e17bf39adbd4dfd2", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/92299b00a200759e58988b62e17bf39adbd4dfd2", "committedDate": "2020-08-11T14:48:45Z", "message": "SweepOutcomeMetricsTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MTY4MjI2", "url": "https://github.com/palantir/atlasdb/pull/4936#pullrequestreview-465168226", "createdAt": "2020-08-11T15:14:09Z", "commit": {"oid": "92299b00a200759e58988b62e17bf39adbd4dfd2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNToxNDowOVrOG-8reA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNToxNDowOVrOG-8reA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODY1OTA2NA==", "bodyText": "Sorry i din't understand why you need to register on SweepOutcomeMetrics at all/ with a different metrics manager?", "url": "https://github.com/palantir/atlasdb/pull/4936#discussion_r468659064", "createdAt": "2020-08-11T15:14:09Z", "author": {"login": "sudiksha27"}, "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/sweep/metrics/SweepOutcomeMetricsTest.java", "diffHunk": "@@ -112,4 +113,23 @@ public void targetedSweepDoesNotRegisterExcludedOutcomes() {\n                 .filter(outcome -> !SweepOutcomeMetrics.TARGETED_OUTCOMES.contains(outcome))\n                 .forEach(outcome -> assertThat(metricsManager).hasNotRegisteredTargetedOutcome(THOROUGH, outcome));\n     }\n+\n+    @Test\n+    public void canFilterOutUninterestingMetrics() {\n+        MetricsManager differentManager = MetricsManagers.createAlwaysSafeAndFilteringForTests();\n+        SweepOutcomeMetrics.registerTargeted(\n+                metricsManager,\n+                ImmutableMap.of(\"strategy\", \"thorough\"),\n+                () -> false);\n+        TargetedSweepMetrics targetedMetrics = TargetedSweepMetrics", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92299b00a200759e58988b62e17bf39adbd4dfd2"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca4a35ff3ab2859734beb2d4247749eea9107124", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/ca4a35ff3ab2859734beb2d4247749eea9107124", "committedDate": "2020-08-11T16:40:39Z", "message": "Cleanup. Sigh"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1Mjk2MTI3", "url": "https://github.com/palantir/atlasdb/pull/4936#pullrequestreview-465296127", "createdAt": "2020-08-11T17:51:24Z", "commit": {"oid": "ca4a35ff3ab2859734beb2d4247749eea9107124"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2777, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}