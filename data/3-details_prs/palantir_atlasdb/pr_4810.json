{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NDI5MTA2", "number": 4810, "title": "[PaxosStateLog] Use Singlethreaded access to Sqlite", "bodyText": "Goals (and why):\nTests were flaking due to timeouts on writes in a multithreaded approach. This avoids the problem by ensuring there is always only a single connection.\nImplementation Description (bullets):\nUse just a single connection. This is ideal for writes, but makes reads somewhat slower as reads are allowed to happen in parallel.\nThis made other tests fail, revealing that we in fact instantiate LocalPaxosComponents twice. We additionally created a connection to sqlite for the namespace loader, and we were creating multiple connections in PaxosTimelockIntegration tests on every bounce.\nTesting (What was existing testing like?  What have you done to improve it?):\nExisting tests\nConcerns (what feedback would you like?):\nDiscussed implementing our own read/write locking which would allow us to have parallel reads. This would give us faster reads, but decided against it for now as it makes the implementation more difficult and does not seem necessary.\nThe fixes for the test failures / bad instantiations of connections may be cleaner so let's discuss.\nWhere should we start reviewing?:\ntiny\nPriority (whenever / two weeks / yesterday):\nASAP as fixes test flakes", "createdAt": "2020-05-28T11:37:48Z", "url": "https://github.com/palantir/atlasdb/pull/4810", "merged": true, "mergeCommit": {"oid": "a157c692f9f8ae36941f344edfbf9f65e9cf8157"}, "closed": true, "closedAt": "2020-05-28T14:20:53Z", "author": {"login": "gmaretic"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclqGGEgH2gAyNDI0NDI5MTA2Ojc4NzIyNzI5ZjA5MDkxMWZkMzhmNDBiOWEyMDk3YjFjYmI5ZDliOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcluJGPgFqTQyMDEyMzM5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "78722729f090911fd38f40b9a2097b1cbb9d9b92", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/78722729f090911fd38f40b9a2097b1cbb9d9b92", "committedDate": "2020-05-28T09:03:57Z", "message": "Reintroduce singlethreaded approach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd954686cc26b3515da0d0ed3119a3cbca6ca603", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/cd954686cc26b3515da0d0ed3119a3cbca6ca603", "committedDate": "2020-05-28T09:29:19Z", "message": "Revert accidental test change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "262a0ae8b85373f5fc38a343e6da8ac1a5a25e8a", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/262a0ae8b85373f5fc38a343e6da8ac1a5a25e8a", "committedDate": "2020-05-28T11:33:30Z", "message": "Fix things up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f610a709c1a16938f94d4de47ff11a0ef886a08a", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/f610a709c1a16938f94d4de47ff11a0ef886a08a", "committedDate": "2020-05-28T12:08:44Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMDU1NzEz", "url": "https://github.com/palantir/atlasdb/pull/4810#pullrequestreview-420055713", "createdAt": "2020-05-28T12:27:30Z", "commit": {"oid": "f610a709c1a16938f94d4de47ff11a0ef886a08a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjoyNzozMFrOGbyxeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjoyNzozMFrOGbyxeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc5NjYwMA==", "bodyText": "discussed offline: CloseableDataSource might be nicer in terms of least privilege, but this is already on the classpath everywhere and we don't really want to add another layer of delegation", "url": "https://github.com/palantir/atlasdb/pull/4810#discussion_r431796600", "createdAt": "2020-05-28T12:27:30Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqliteConnections.java", "diffHunk": "@@ -41,22 +39,22 @@ private SqliteConnections() {\n         // no\n     }\n \n-    public static DataSource getPooledDataSource(Path path) {\n+    public static HikariDataSource getPooledDataSource(Path path) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f610a709c1a16938f94d4de47ff11a0ef886a08a"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMDU4MTgw", "url": "https://github.com/palantir/atlasdb/pull/4810#pullrequestreview-420058180", "createdAt": "2020-05-28T12:30:47Z", "commit": {"oid": "f610a709c1a16938f94d4de47ff11a0ef886a08a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjozMDo0N1rOGby4zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMjozMzoxM1rOGby9-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc5ODQ3Ng==", "bodyText": "Might be better if we create it here and inject it into both", "url": "https://github.com/palantir/atlasdb/pull/4810#discussion_r431798476", "createdAt": "2020-05-28T12:30:47Z", "author": {"login": "jeremyk-91"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java", "diffHunk": "@@ -113,7 +112,7 @@ public static TimeLockAgent create(\n                 registrar,\n                 paxosResources,\n                 userAgent);\n-        agent.createAndRegisterResources();\n+        agent.createAndRegisterResources(paxosResources.leadershipContextFactory().sqliteDataSource());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f610a709c1a16938f94d4de47ff11a0ef886a08a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc5OTgwMA==", "bodyText": "let's create this inside TimeLockAgent and inject it here", "url": "https://github.com/palantir/atlasdb/pull/4810#discussion_r431799800", "createdAt": "2020-05-28T12:33:13Z", "author": {"login": "jeremyk-91"}, "path": "timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/PaxosResourcesFactory.java", "diffHunk": "@@ -60,13 +64,16 @@ public static PaxosResources create(\n             ExecutorService sharedExecutor) {\n         PaxosRemoteClients remoteClients = ImmutablePaxosRemoteClients.of(install, metrics);\n \n-        ImmutablePaxosResources.Builder resourcesBuilder =\n-                setupTimestampResources(install, metrics, paxosRuntime, sharedExecutor, remoteClients);\n+        HikariDataSource sqliteDataSource = SqliteConnections.getPooledDataSource(install.sqliteDataDirectory());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f610a709c1a16938f94d4de47ff11a0ef886a08a"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82850deeaf3afb6f43945a1b483704b0b4723fde", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/82850deeaf3afb6f43945a1b483704b0b4723fde", "committedDate": "2020-05-28T12:53:49Z", "message": "Address CR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dc9da7693b7fed1d7a13d6b13c0999ffdc28023", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/4dc9da7693b7fed1d7a13d6b13c0999ffdc28023", "committedDate": "2020-05-28T13:21:29Z", "message": "Attempt to fix flaky test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMTIzMzkx", "url": "https://github.com/palantir/atlasdb/pull/4810#pullrequestreview-420123391", "createdAt": "2020-05-28T13:46:52Z", "commit": {"oid": "4dc9da7693b7fed1d7a13d6b13c0999ffdc28023"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2902, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}