{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMjE1ODQ1", "number": 4802, "title": "Filter out leaderPaxos from list of namespaces", "bodyText": "Goals (and why):\nExtension of #4760.\nleaderPaxos is not a namespace itself and should be filtered out while loading namespaces via SqliteNamespaceLoader.\nImplementation Description (bullets):\nFilter out \"leaderPaxos\" while loading namespaces\nTesting (What was existing testing like?  What have you done to improve it?):\nExisting test modified\nPriority (whenever / two weeks / yesterday):\nToday", "createdAt": "2020-05-26T13:45:22Z", "url": "https://github.com/palantir/atlasdb/pull/4802", "merged": true, "mergeCommit": {"oid": "ac0c3160474fee60f8949cd5f55e51843e121846"}, "closed": true, "closedAt": "2020-05-27T14:09:48Z", "author": {"login": "sudiksha27"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclET2fgH2gAyNDIzMjE1ODQ1OmIzNjk0ZGQ0YzA5OTNhMTUyNTQwNTk3ZTgwMDA4OTM3Nzc5YjY2NWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclZlZKgH2gAyNDIzMjE1ODQ1OmExM2M5YTk2NDM3MTY5MDMwMWE5Mjc4YzEyZTU0OWFkNGZkOThmODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b3694dd4c0993a152540597e80008937779b665c", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/b3694dd4c0993a152540597e80008937779b665c", "committedDate": "2020-05-26T13:02:35Z", "message": "Filter out leaderPaxos from list of namespaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "122cce5ecf25206bd8f8dc03bcc0afe8996c2001", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/122cce5ecf25206bd8f8dc03bcc0afe8996c2001", "committedDate": "2020-05-26T13:24:35Z", "message": "Update test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "021b59c239d12bcdd739d8c7b1e567a858189dae", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/021b59c239d12bcdd739d8c7b1e567a858189dae", "committedDate": "2020-05-26T13:24:35Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f53caa92ed8fb1361907b31201ca03be6a92ceb", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/9f53caa92ed8fb1361907b31201ca03be6a92ceb", "committedDate": "2020-05-26T17:47:33Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95c0d8bf0c6839bba7bd0c9b7410a3a3ccf7490d", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/95c0d8bf0c6839bba7bd0c9b7410a3a3ccf7490d", "committedDate": "2020-05-26T17:47:59Z", "message": "Merge branch 'sqlite_namespace_loader_fix' of github.com:palantir/atlasdb into sqlite_namespace_loader_fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2780338d6b5b194de06d3db0030447a27d0d292", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/a2780338d6b5b194de06d3db0030447a27d0d292", "committedDate": "2020-05-26T17:47:59Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96133377d6524ec054eebde5059f09713440184f", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/96133377d6524ec054eebde5059f09713440184f", "committedDate": "2020-05-26T17:47:59Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NTQ0NTE2", "url": "https://github.com/palantir/atlasdb/pull/4802#pullrequestreview-418544516", "createdAt": "2020-05-26T17:58:08Z", "commit": {"oid": "95c0d8bf0c6839bba7bd0c9b7410a3a3ccf7490d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNzo1ODowOFrOGap2tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNzo1OTo0NVrOGap8oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYwMTkxMQ==", "bodyText": "This is fine, but I would be a bit more specific on explaining the subset of users this actually applied to (i.e. previously if, and only if, you had used SQLite, leaderPaxos would be returned as part of the set of persisted namespaces). Otherwise it sounds like it was always being returned", "url": "https://github.com/palantir/atlasdb/pull/4802#discussion_r430601911", "createdAt": "2020-05-26T17:58:08Z", "author": {"login": "jeremyk-91"}, "path": "changelog/@unreleased/pr-4802.v2.yml", "diffHunk": "@@ -0,0 +1,6 @@\n+type: fix\n+fix:\n+  description: |\n+    `leaderPaxos` is filtered out from the set of persisted namespaces.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95c0d8bf0c6839bba7bd0c9b7410a3a3ccf7490d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDYwMzQyNQ==", "bodyText": "Do we need to create the leader paxos directory somewhere before this?", "url": "https://github.com/palantir/atlasdb/pull/4802#discussion_r430603425", "createdAt": "2020-05-26T17:59:45Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/test/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoaderTest.java", "diffHunk": "@@ -17,38 +17,73 @@\n package com.palantir.atlasdb.timelock.management;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n \n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.nio.file.Path;\n import java.util.Set;\n-import java.util.stream.Collectors;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n \n import org.junit.Before;\n import org.junit.Rule;\n import org.junit.Test;\n import org.junit.rules.TemporaryFolder;\n+import org.mockito.Mock;\n \n+import com.codahale.metrics.MetricRegistry;\n+import com.google.common.collect.ImmutableList;\n+import com.palantir.atlasdb.http.RedirectRetryTargeter;\n+import com.palantir.atlasdb.timelock.TimeLockServices;\n+import com.palantir.atlasdb.timelock.TimelockNamespaces;\n import com.palantir.atlasdb.timelock.paxos.PaxosTimeLockConstants;\n-import com.palantir.paxos.Client;\n+import com.palantir.atlasdb.util.MetricsManager;\n+import com.palantir.paxos.SqliteConnections;\n+import com.palantir.tokens.auth.AuthHeader;\n+import com.palantir.tritium.metrics.registry.DefaultTaggedMetricRegistry;\n \n public class DiskNamespaceLoaderTest {\n     private static final String NAMESPACE_1 = \"namespace_1\";\n     private static final String NAMESPACE_2 = \"namespace_2\";\n+    private static final AuthHeader AUTH_HEADER = AuthHeader.valueOf(\"Bearer omitted\");\n+    @Mock private Function<String, TimeLockServices> serviceFactory;\n+    @Mock private Supplier<Integer> maxNumberOfClientsSupplier;\n+\n+    private final MetricsManager metricsManager = new MetricsManager(\n+            new MetricRegistry(),\n+            DefaultTaggedMetricRegistry.getDefault(),\n+            unused -> false);\n+    private TimeLockManagementResource timeLockManagementResource;\n \n     @Rule\n     public final TemporaryFolder tempFolder = new TemporaryFolder();\n \n-    public DiskNamespaceLoader diskNamespaceLoader;\n-\n     @Before\n-    public void setup() {\n-        diskNamespaceLoader = new DiskNamespaceLoader(tempFolder.getRoot().toPath());\n+    public void setup() throws MalformedURLException {\n+        URL testUrl = new URL(\"http\", \"host\", \"file\");\n+        RedirectRetryTargeter redirectRetryTargeter = RedirectRetryTargeter\n+                .create(testUrl, ImmutableList.of(testUrl));\n+\n+        Path rootFolderPath = tempFolder.getRoot().toPath();\n+        PersistentNamespaceContext persistentNamespaceContext = PersistentNamespaceContext.of(rootFolderPath, SqliteConnections\n+                        .createDefaultNamedSqliteDatabaseAtPath(rootFolderPath));\n+\n+        TimelockNamespaces namespaces = new TimelockNamespaces(metricsManager, serviceFactory, maxNumberOfClientsSupplier);\n+\n+        timeLockManagementResource = TimeLockManagementResource.create(persistentNamespaceContext,\n+                namespaces,\n+                redirectRetryTargeter);\n+\n         createDirectoryForLeaderForEachClientUseCase(NAMESPACE_1);\n         createDirectoryInRootDataDirectory(NAMESPACE_2);\n     }\n \n     @Test\n-    public void doesNotLoadLeaderPaxosAsNamespace() {\n-        Set<String> namespaces = diskNamespaceLoader.getAllPersistedNamespaces().stream().map(Client::value).collect(\n-                Collectors.toSet());\n+    public void doesNotLoadLeaderPaxosAsNamespace() throws ExecutionException, InterruptedException {\n+        Set<String> namespaces = timeLockManagementResource.getNamespaces(AUTH_HEADER).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "95c0d8bf0c6839bba7bd0c9b7410a3a3ccf7490d"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MjIyNTAx", "url": "https://github.com/palantir/atlasdb/pull/4802#pullrequestreview-419222501", "createdAt": "2020-05-27T13:45:37Z", "commit": {"oid": "96133377d6524ec054eebde5059f09713440184f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzo0NTozN1rOGbK3cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMzo0NTozN1rOGbK3cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE0Mjc3MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final MetricsManager metricsManager = new MetricsManager(\n          \n          \n            \n                        new MetricRegistry(),\n          \n          \n            \n                        DefaultTaggedMetricRegistry.getDefault(),\n          \n          \n            \n                        unused -> false);\n          \n          \n            \n                private final MetricsManager metricsManager = MetricsManagers.createForTests();", "url": "https://github.com/palantir/atlasdb/pull/4802#discussion_r431142770", "createdAt": "2020-05-27T13:45:37Z", "author": {"login": "jeremyk-91"}, "path": "timelock-impl/src/test/java/com/palantir/atlasdb/timelock/management/DiskNamespaceLoaderTest.java", "diffHunk": "@@ -17,38 +17,73 @@\n package com.palantir.atlasdb.timelock.management;\n \n import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n \n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.nio.file.Path;\n import java.util.Set;\n-import java.util.stream.Collectors;\n+import java.util.concurrent.ExecutionException;\n+import java.util.function.Function;\n+import java.util.function.Supplier;\n \n import org.junit.Before;\n import org.junit.Rule;\n import org.junit.Test;\n import org.junit.rules.TemporaryFolder;\n+import org.mockito.Mock;\n \n+import com.codahale.metrics.MetricRegistry;\n+import com.google.common.collect.ImmutableList;\n+import com.palantir.atlasdb.http.RedirectRetryTargeter;\n+import com.palantir.atlasdb.timelock.TimeLockServices;\n+import com.palantir.atlasdb.timelock.TimelockNamespaces;\n import com.palantir.atlasdb.timelock.paxos.PaxosTimeLockConstants;\n-import com.palantir.paxos.Client;\n+import com.palantir.atlasdb.util.MetricsManager;\n+import com.palantir.paxos.SqliteConnections;\n+import com.palantir.tokens.auth.AuthHeader;\n+import com.palantir.tritium.metrics.registry.DefaultTaggedMetricRegistry;\n \n public class DiskNamespaceLoaderTest {\n     private static final String NAMESPACE_1 = \"namespace_1\";\n     private static final String NAMESPACE_2 = \"namespace_2\";\n+    private static final AuthHeader AUTH_HEADER = AuthHeader.valueOf(\"Bearer omitted\");\n+    @Mock private Function<String, TimeLockServices> serviceFactory;\n+    @Mock private Supplier<Integer> maxNumberOfClientsSupplier;\n+\n+    private final MetricsManager metricsManager = new MetricsManager(\n+            new MetricRegistry(),\n+            DefaultTaggedMetricRegistry.getDefault(),\n+            unused -> false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "96133377d6524ec054eebde5059f09713440184f"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MjIyNjY0", "url": "https://github.com/palantir/atlasdb/pull/4802#pullrequestreview-419222664", "createdAt": "2020-05-27T13:45:46Z", "commit": {"oid": "96133377d6524ec054eebde5059f09713440184f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1194cbae83171f6231e889abfcd91cdf28cc5b9b", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/1194cbae83171f6231e889abfcd91cdf28cc5b9b", "committedDate": "2020-05-27T13:47:20Z", "message": "Address comments | test fix\n\nCo-authored-by: Jeremy Kong <jeremykong@hotmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a13c9a964371690301a9278c12e549ad4fd98f89", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/a13c9a964371690301a9278c12e549ad4fd98f89", "committedDate": "2020-05-27T13:49:45Z", "message": "Fix import"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2885, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}