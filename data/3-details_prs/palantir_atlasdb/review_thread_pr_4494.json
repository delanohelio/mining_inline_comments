{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNTE1NTMy", "number": 4494, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMzowNjo0MVrODW2Ejw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMzoxNjozNVrODW2PIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MjgxMTY3OnYy", "diffSide": "RIGHT", "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMzowNjo0MVrOFb1M0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxNDoxMzozM1rOFb3H2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcyNzUwNA==", "bodyText": "TaggedMetricRegistries are nice because of the:\nvoid addMetrics(String safeTagName, String safeTagValue, TaggedMetricSet metrics)\n\nMethod, which basically allows for establishing metric hierarchies. Using this, this class would not have to deal with tags at all, because it would be passed a TaggedMetricRegistry that is scoped to the exact thing it needs, and ALL metrics created underneath it would be tagged correctly.", "url": "https://github.com/palantir/atlasdb/pull/4494#discussion_r364727504", "createdAt": "2020-01-09T13:06:41Z", "author": {"login": "jkozlowski"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "diffHunk": "@@ -48,8 +48,11 @@\n     private final Meter leaderPingReturnedFalse;\n     private final Object[] contextArgs;\n \n-    LeadershipEvents(TaggedMetricRegistry metrics, List<SafeArg<String>> contextArgs) {\n-        Map<String, String> safeTags = safeTags(contextArgs);\n+    LeadershipEvents(\n+            TaggedMetricRegistry metrics,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a115759ae2f23469b024abf3c45adf2e8002a570"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcyOTA4Mg==", "bodyText": "Deregistration in the TimelockLeadershipMetrics should also hopefully become just a simple removal of the scoped TaggedMetricSet, so that code should be less error prone.", "url": "https://github.com/palantir/atlasdb/pull/4494#discussion_r364729082", "createdAt": "2020-01-09T13:10:38Z", "author": {"login": "jkozlowski"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "diffHunk": "@@ -48,8 +48,11 @@\n     private final Meter leaderPingReturnedFalse;\n     private final Object[] contextArgs;\n \n-    LeadershipEvents(TaggedMetricRegistry metrics, List<SafeArg<String>> contextArgs) {\n-        Map<String, String> safeTags = safeTags(contextArgs);\n+    LeadershipEvents(\n+            TaggedMetricRegistry metrics,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcyNzUwNA=="}, "originalCommit": {"oid": "a115759ae2f23469b024abf3c45adf2e8002a570"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDczOTExNQ==", "bodyText": "so I'm using that above, I didn't do another level for reasons unbeknownst to me, perhaps I was worried about perf of multi level hierarchies, but I can give it a try.", "url": "https://github.com/palantir/atlasdb/pull/4494#discussion_r364739115", "createdAt": "2020-01-09T13:33:18Z", "author": {"login": "felixdesouza"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "diffHunk": "@@ -48,8 +48,11 @@\n     private final Meter leaderPingReturnedFalse;\n     private final Object[] contextArgs;\n \n-    LeadershipEvents(TaggedMetricRegistry metrics, List<SafeArg<String>> contextArgs) {\n-        Map<String, String> safeTags = safeTags(contextArgs);\n+    LeadershipEvents(\n+            TaggedMetricRegistry metrics,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcyNzUwNA=="}, "originalCommit": {"oid": "a115759ae2f23469b024abf3c45adf2e8002a570"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDc1OTAwMQ==", "bodyText": "If it's not performant enough, we should fix this in the library and not workaround here.", "url": "https://github.com/palantir/atlasdb/pull/4494#discussion_r364759001", "createdAt": "2020-01-09T14:13:33Z", "author": {"login": "jkozlowski"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "diffHunk": "@@ -48,8 +48,11 @@\n     private final Meter leaderPingReturnedFalse;\n     private final Object[] contextArgs;\n \n-    LeadershipEvents(TaggedMetricRegistry metrics, List<SafeArg<String>> contextArgs) {\n-        Map<String, String> safeTags = safeTags(contextArgs);\n+    LeadershipEvents(\n+            TaggedMetricRegistry metrics,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDcyNzUwNA=="}, "originalCommit": {"oid": "a115759ae2f23469b024abf3c45adf2e8002a570"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1MjgzODc1OnYy", "diffSide": "RIGHT", "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMzoxNjozNVrOFb1dUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQxMzozMDozOFrOFb11Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDczMTczMQ==", "bodyText": "This logging also feels rather cumbersome: it would be great to use MDC for this. The only problem is we can't assume anything about the logging framework, safe vs unsafe arg handling... :(", "url": "https://github.com/palantir/atlasdb/pull/4494#discussion_r364731731", "createdAt": "2020-01-09T13:16:35Z", "author": {"login": "jkozlowski"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "diffHunk": "@@ -58,7 +61,7 @@\n         leaderPingFailure = metrics.meter(withName(\"leadership.ping-leader.failure\", safeTags));\n         leaderPingTimeout = metrics.meter(withName(\"leadership.ping-leader.timeout\", safeTags));\n         leaderPingReturnedFalse = metrics.meter(withName(\"leadership.ping-leader.returned-false\", safeTags));\n-        this.contextArgs = contextArgs.toArray(new Object[0]);\n+        this.contextArgs = safeLoggingArgs.toArray(new Object[0]);\n     }\n \n     void proposedLeadershipFor(long round) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a115759ae2f23469b024abf3c45adf2e8002a570"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDczNzg3OQ==", "bodyText": "yeah, it would", "url": "https://github.com/palantir/atlasdb/pull/4494#discussion_r364737879", "createdAt": "2020-01-09T13:30:38Z", "author": {"login": "felixdesouza"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "diffHunk": "@@ -58,7 +61,7 @@\n         leaderPingFailure = metrics.meter(withName(\"leadership.ping-leader.failure\", safeTags));\n         leaderPingTimeout = metrics.meter(withName(\"leadership.ping-leader.timeout\", safeTags));\n         leaderPingReturnedFalse = metrics.meter(withName(\"leadership.ping-leader.returned-false\", safeTags));\n-        this.contextArgs = contextArgs.toArray(new Object[0]);\n+        this.contextArgs = safeLoggingArgs.toArray(new Object[0]);\n     }\n \n     void proposedLeadershipFor(long round) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDczMTczMQ=="}, "originalCommit": {"oid": "a115759ae2f23469b024abf3c45adf2e8002a570"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2376, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}