{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNTMyNDc3", "number": 4962, "title": "[LW] Fixes, 5: Throw underlying exception if already on fallback cache", "bodyText": "Goals (and why):\n\nWe don't want to throw retryable exceptions if the fallback cache is throwing.\n\nImplementation Description (bullets):\n\nAdd check that fallback is equal to delegate.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nAdded new test\n\nConcerns (what feedback would you like?):\n\nThis shouldn't really happen since the fallback is no op, but I think this is correct anyway (saw this on a test in atlasdb-proxy on that one and wanted to replicate here).\n\nWhere should we start reviewing?:\nResilientLockWatchEventCache\nPriority (whenever / two weeks / yesterday):\nThis week", "createdAt": "2020-08-24T13:44:55Z", "url": "https://github.com/palantir/atlasdb/pull/4962", "merged": true, "mergeCommit": {"oid": "79e19d826b9f43ee0f0c026b7688b1cc200b7e23"}, "closed": true, "closedAt": "2020-08-25T09:06:08Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCC1MqAH2gAyNDcyNTMyNDc3Ojc3Y2E2Y2YwOTdlMzZmMTMyMTM5NGQwMjIwOTM0Njg5NDBiMTUwMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCTyeqgFqTQ3NDMwMjUwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "77ca6cf097e36f1321394d022093468940b15006", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/77ca6cf097e36f1321394d022093468940b15006", "committedDate": "2020-08-24T13:43:00Z", "message": "fix failure on fallback case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "818185eeb68b6cb2cbf07d72ba22d932fec8817b", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/818185eeb68b6cb2cbf07d72ba22d932fec8817b", "committedDate": "2020-08-24T13:43:00Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjQ2MTE5", "url": "https://github.com/palantir/atlasdb/pull/4962#pullrequestreview-473646119", "createdAt": "2020-08-24T16:07:41Z", "commit": {"oid": "818185eeb68b6cb2cbf07d72ba22d932fec8817b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjowNzo0MVrOHFsC-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjowNzo0MVrOHFsC-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTcyNjU4Nw==", "bodyText": "are you sure you want equals here and not ==?", "url": "https://github.com/palantir/atlasdb/pull/4962#discussion_r475726587", "createdAt": "2020-08-24T16:07:41Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCache.java", "diffHunk": "@@ -74,11 +74,15 @@ synchronized RuntimeException handleException(InvocationTargetException rethrow)\n         } catch (TransactionLockWatchFailedException e) {\n             throw e;\n         } catch (Throwable t) {\n-            log.warn(\"Unexpected failure occurred when trying to use the default cache. Switching to the fallback \"\n-                    + \"implementation\", t);\n-            fallbackCacheSelectedCounter.inc();\n-            delegate = fallbackCache;\n-            throw new TransactionLockWatchFailedException(\"Unexpected failure in the lock watch cache\", t);\n+            if (delegate.equals(fallbackCache)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "818185eeb68b6cb2cbf07d72ba22d932fec8817b"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35c42c1b700cc4881e45ef8c27aac79f51e91825", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/35c42c1b700cc4881e45ef8c27aac79f51e91825", "committedDate": "2020-08-25T08:53:20Z", "message": "use equals equals instead of equals"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MzAyNTAz", "url": "https://github.com/palantir/atlasdb/pull/4962#pullrequestreview-474302503", "createdAt": "2020-08-25T09:28:25Z", "commit": {"oid": "35c42c1b700cc4881e45ef8c27aac79f51e91825"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwOToyODoyNVrOHGPs_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQwOToyODoyNVrOHGPs_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMxMDc4MQ==", "bodyText": "Should've been SafeRuntimeException", "url": "https://github.com/palantir/atlasdb/pull/4962#discussion_r476310781", "createdAt": "2020-08-25T09:28:25Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCache.java", "diffHunk": "@@ -74,11 +74,15 @@ synchronized RuntimeException handleException(InvocationTargetException rethrow)\n         } catch (TransactionLockWatchFailedException e) {\n             throw e;\n         } catch (Throwable t) {\n-            log.warn(\"Unexpected failure occurred when trying to use the default cache. Switching to the fallback \"\n-                    + \"implementation\", t);\n-            fallbackCacheSelectedCounter.inc();\n-            delegate = fallbackCache;\n-            throw new TransactionLockWatchFailedException(\"Unexpected failure in the lock watch cache\", t);\n+            if (delegate == fallbackCache) {\n+                throw new RuntimeException(t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35c42c1b700cc4881e45ef8c27aac79f51e91825"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2546, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}