{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwMjQzNDM1", "number": 4867, "title": "[PD$-110002] Part 6: One-Shots and Legacies", "bodyText": "Goals (and why):\n\n$$$\n\nImplementation Description (bullets):\nThis PR contains four small metrics cuts.\n\nOnly log the background sweep batch multiplier if <1. This should save |namespaces| series in atlasdb-proxy.\nDon't instrument TimestampManagementService endpoints (used only in timelock migration). This should save 10 * |namespaces| series in atlasdb-proxy.\nDon't instrument CoordinationService endpoints (used only in transactions2 migration). This should save 10 * |namespaces| series in atlasdb-proxy.\nDon't publish timelockSuccessfulRequest and timelockFailedRequest - I'm not aware of anyone who uses these outside of the health check that we have. This should save 4 * |namespaces| series in atlasdb-proxy.\n\n(Note that meters create two series, and timers five.)\nTesting (What was existing testing like?  What have you done to improve it?):\nNothing beyond existing tests.\nConcerns (what feedback would you like?):\n\nAre any of these metrics more valuable than what I give them credit for?\n\nWhere should we start reviewing?: Commit by commit?\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-06-25T20:33:36Z", "url": "https://github.com/palantir/atlasdb/pull/4867", "merged": true, "mergeCommit": {"oid": "934207a84be4ddaa282e10da644febd466eef34e"}, "closed": true, "closedAt": "2020-06-30T19:25:54Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcurh0FgH2gAyNDQwMjQzNDM1OjllNjU5M2JmMzEyYzQzZDY1ZmJkOWQ2M2YzYzlhN2VkZTAxMDQxZDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwD68ugH2gAyNDQwMjQzNDM1OmM4MzRlZTE4NmZkYTljYTllYjI3YjNlNDllOGY5NzNhODI2YTkxMDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9e6593bf312c43d65fbd9d63f3c9a7ede01041d0", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/9e6593bf312c43d65fbd9d63f3c9a7ede01041d0", "committedDate": "2020-06-25T09:49:27Z", "message": "Only log background sweep batch size if <1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f2bf50c9c3d984f1345cf33addee082dddd6899", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/2f2bf50c9c3d984f1345cf33addee082dddd6899", "committedDate": "2020-06-25T10:03:02Z", "message": "Do not instrument TimestampManagement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7364e8668187779d0bde9383fde22a8d22b910f", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e7364e8668187779d0bde9383fde22a8d22b910f", "committedDate": "2020-06-25T20:06:04Z", "message": "Remove transactions2 migration profiling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ddc3d4d93ffe1257ddba244e0937b9379aa30f0", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/2ddc3d4d93ffe1257ddba244e0937b9379aa30f0", "committedDate": "2020-06-25T20:12:29Z", "message": "timelockSuccessful and timelockFailedRequest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f2a51db7b1787adf3ea93a678fe59e128288510", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/3f2a51db7b1787adf3ea93a678fe59e128288510", "committedDate": "2020-06-25T20:33:02Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7240ef47af7d1d4b769fd1939af1579856f5068", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e7240ef47af7d1d4b769fd1939af1579856f5068", "committedDate": "2020-06-25T20:33:02Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MjQ4MjI3", "url": "https://github.com/palantir/atlasdb/pull/4867#pullrequestreview-438248227", "createdAt": "2020-06-26T12:20:17Z", "commit": {"oid": "2ddc3d4d93ffe1257ddba244e0937b9379aa30f0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjoyMDoxN1rOGpeyLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMjoyNzo1NlrOGpfAdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE0OTE2Nw==", "bodyText": "Maybe we can extract out the always blocking filter; would be more readable.", "url": "https://github.com/palantir/atlasdb/pull/4867#discussion_r446149167", "createdAt": "2020-06-26T12:20:17Z", "author": {"login": "sudiksha27"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/InstrumentedTimelockService.java", "diffHunk": "@@ -31,16 +33,35 @@\n import com.palantir.lock.v2.WaitForLocksRequest;\n import com.palantir.lock.v2.WaitForLocksResponse;\n import com.palantir.timestamp.TimestampRange;\n+import com.palantir.tritium.metrics.registry.MetricName;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n \n public class InstrumentedTimelockService implements TimelockService {\n     private final TimelockService timelockService;\n     private final Meter success;\n     private final Meter fail;\n \n-    public InstrumentedTimelockService(TimelockService timelockService, MetricRegistry metricRegistry) {\n+    private InstrumentedTimelockService(TimelockService timelockService, MetricsManager metricsManager) {\n         this.timelockService = timelockService;\n-        this.success = metricRegistry.meter(AtlasDbMetricNames.TIMELOCK_SUCCESSFUL_REQUEST);\n-        this.fail = metricRegistry.meter(AtlasDbMetricNames.TIMELOCK_FAILED_REQUEST);\n+        this.success = metricsManager.registerOrGetTaggedMeter(\n+                InstrumentedTimelockService.class,\n+                AtlasDbMetricNames.TIMELOCK_SUCCESSFUL_REQUEST,\n+                ImmutableMap.of());\n+        this.fail = metricsManager.registerOrGetTaggedMeter(\n+                InstrumentedTimelockService.class,\n+                AtlasDbMetricNames.TIMELOCK_FAILED_REQUEST,\n+                ImmutableMap.of());\n+    }\n+\n+    public static TimelockService create(TimelockService timelockService, MetricsManager metricsManager) {\n+        // The instrumentation here is used primarily for the health check, not for external viewing.\n+        metricsManager.addMetricFilter(\n+                MetricName.builder().safeName(AtlasDbMetricNames.TIMELOCK_SUCCESSFUL_REQUEST).build(),\n+                () -> false);\n+        metricsManager.addMetricFilter(\n+                MetricName.builder().safeName(AtlasDbMetricNames.TIMELOCK_FAILED_REQUEST).build(),\n+                () -> false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ddc3d4d93ffe1257ddba244e0937b9379aa30f0"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE1MjgyMA==", "bodyText": "I am confused b/w the description and implementation of filter here.", "url": "https://github.com/palantir/atlasdb/pull/4867#discussion_r446152820", "createdAt": "2020-06-26T12:27:56Z", "author": {"login": "sudiksha27"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/sweep/AdjustableSweepBatchConfigSource.java", "diffHunk": "@@ -42,8 +46,13 @@ public static AdjustableSweepBatchConfigSource create(\n             Supplier<SweepBatchConfig> rawSweepBatchConfig) {\n         AdjustableSweepBatchConfigSource configSource = new AdjustableSweepBatchConfigSource(rawSweepBatchConfig);\n \n+        Gauge<Double> gauge = AdjustableSweepBatchConfigSource::getBatchSizeMultiplier;\n+        metricsManager.addMetricFilter(AdjustableSweepBatchConfigSource.class,\n+                \"batchSizeMultiplier\",\n+                ImmutableMap.of(),\n+                () -> gauge.getValue() != 1.0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e6593bf312c43d65fbd9d63f3c9a7ede01041d0"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebef957f3dfee0dabcb454b6acdc23ef8295fddf", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/ebef957f3dfee0dabcb454b6acdc23ef8295fddf", "committedDate": "2020-06-26T15:57:15Z", "message": "CR and checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NDEzNjIy", "url": "https://github.com/palantir/atlasdb/pull/4867#pullrequestreview-438413622", "createdAt": "2020-06-26T15:59:33Z", "commit": {"oid": "ebef957f3dfee0dabcb454b6acdc23ef8295fddf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c834ee186fda9ca9eb27b3e49e8f973a826a9102", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/c834ee186fda9ca9eb27b3e49e8f973a826a9102", "committedDate": "2020-06-29T16:48:33Z", "message": "checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2700, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}