{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyODc1NDg0", "number": 4750, "title": "Fix case when fail to register lock after starting transaction", "bodyText": "Goals (and why):\n\nFix a bug where the immutable timestamp lock is dropped if LockRefresher.registerLock throws.\n\nImplementation Description (bullets):\n\nAdd a try/catch around the call that unlocks the immutableTs lock if registerLock throws.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nAdded a test to TimeLockClientTest to test this case.\n\nConcerns (what feedback would you like?):\n\nEnsure this correctly handles the problem.\nIf the batch start txn piece is merged before this, will need to slightly rework; even so, please verify this solves the problem correctly\n\nWhere should we start reviewing?:\nTimeLockClient\nPriority (whenever / two weeks / yesterday):\nThis week", "createdAt": "2020-05-04T10:48:17Z", "url": "https://github.com/palantir/atlasdb/pull/4750", "merged": true, "mergeCommit": {"oid": "0d251eb846656a005f05c2098bee23c579a46475"}, "closed": true, "closedAt": "2020-05-05T08:31:39Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcd9IzxgH2gAyNDEyODc1NDg0OmFlZGZlOTJjZGQ0MGExODA3MzIzM2Q0MDM0ODllNTRjYTNlZmRjNjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceCwOtAFqTQwNTE4NjQ1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aedfe92cdd40a18073233d403489e54ca3efdc63", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/aedfe92cdd40a18073233d403489e54ca3efdc63", "committedDate": "2020-05-04T10:43:43Z", "message": "Fix bug when fail to register lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3f0fe2ec976c34422f2bc5ba45b1dbe85ef12a2", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/d3f0fe2ec976c34422f2bc5ba45b1dbe85ef12a2", "committedDate": "2020-05-04T10:48:14Z", "message": "Remove unnecessary diff"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41af889c56d4bfab1d2572842f1a674529b092ca", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/41af889c56d4bfab1d2572842f1a674529b092ca", "committedDate": "2020-05-04T10:48:14Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a41d88a0c81426c95862e0450c03cac6e93fc1f0", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/a41d88a0c81426c95862e0450c03cac6e93fc1f0", "committedDate": "2020-05-04T10:48:14Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e37e504a686571115f38ab46a9f824c4177df84a", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/e37e504a686571115f38ab46a9f824c4177df84a", "committedDate": "2020-05-04T10:48:14Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0OTM4NDEx", "url": "https://github.com/palantir/atlasdb/pull/4750#pullrequestreview-404938411", "createdAt": "2020-05-04T12:26:07Z", "commit": {"oid": "41af889c56d4bfab1d2572842f1a674529b092ca"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMjoyNjowN1rOGP9_DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMjozNToyMVrOGP-SMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM5NzM4OA==", "bodyText": "We should have the description in two parts - 1. what the behavior is after the fix (i.e. what the fix is/ does),  2. what used to happen previously.", "url": "https://github.com/palantir/atlasdb/pull/4750#discussion_r419397388", "createdAt": "2020-05-04T12:26:07Z", "author": {"login": "sudiksha27"}, "path": "changelog/@unreleased/pr-4750.v2.yml", "diffHunk": "@@ -0,0 +1,6 @@\n+type: fix\n+fix:\n+  description: Fix case when TimeLockClient fails to register lock after starting\n+    transaction and drops the immutableTs lock.\n+  links:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41af889c56d4bfab1d2572842f1a674529b092ca"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTQwMjI4OQ==", "bodyText": "When does LockRefresher.registerLock throw exception? Why don't we want to retry registering in that case?", "url": "https://github.com/palantir/atlasdb/pull/4750#discussion_r419402289", "createdAt": "2020-05-04T12:35:21Z", "author": {"login": "sudiksha27"}, "path": "lock-api/src/main/java/com/palantir/lock/client/TimeLockClient.java", "diffHunk": "@@ -96,7 +97,12 @@ public LockImmutableTimestampResponse lockImmutableTimestamp() {\n     public StartIdentifiedAtlasDbTransactionResponse startIdentifiedAtlasDbTransaction() {\n         StartIdentifiedAtlasDbTransactionResponse response = executeOnTimeLock(\n                 delegate::startIdentifiedAtlasDbTransaction);\n-        lockRefresher.registerLock(response.immutableTimestamp().getLock());\n+        try {\n+            lockRefresher.registerLock(response.immutableTimestamp().getLock());\n+        } catch (Throwable t) {\n+            unlock(ImmutableSet.of(response.immutableTimestamp().getLock()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41af889c56d4bfab1d2572842f1a674529b092ca"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MTg2NDUx", "url": "https://github.com/palantir/atlasdb/pull/4750#pullrequestreview-405186451", "createdAt": "2020-05-04T17:16:18Z", "commit": {"oid": "e37e504a686571115f38ab46a9f824c4177df84a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3126, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}