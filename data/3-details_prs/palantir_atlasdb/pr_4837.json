{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0Njg0ODQ1", "number": 4837, "title": "[PD$-110002] Part 2: Economising Snapshot Transaction commitWrites() Timers", "bodyText": "Goals (and why):\n\nSave money on metrics\nBut still get as much signal as possible\n\nImplementation Description (bullets):\n\nIn internal atlasdb-proxy, these are a fairly heavily hit set of timers (one per constituent database). Some are useful, but not all.\nI think the least contentious ones are the in-memory operations (tryUnlock, asyncPuncher). There is a middling group that is a bit more open for discussion: I chose them based on how valuable the signal is compared to an already existing metric (e.g. putting the commit timestamp into the database is largely reflected in TransactionService.putUnlessExists and I can believe the latter is representative of the former; but I can't say the same for transaction locks).\n\nTesting (What was existing testing like?  What have you done to improve it?): None\nConcerns (what feedback would you like?):\n\nConsider each decision on whether the timing metric was kept or not - do you agree with each one?\n\nWhere should we start reviewing?: the one file\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-06-15T17:50:26Z", "url": "https://github.com/palantir/atlasdb/pull/4837", "merged": true, "mergeCommit": {"oid": "08047dc238c3a63e27248e65c10b333b5ae595c9"}, "closed": true, "closedAt": "2020-06-17T08:55:41Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrkSvugH2gAyNDM0Njg0ODQ1OjM4ZDJlYTlmYjU5MTI3YmU4OGRlNTZiNWIwNWIyMGRjNzY1NmFlYTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcr43D3gH2gAyNDM0Njg0ODQ1OjkyYmMxMDc5YjAxODU3ZTI4Y2ZhNDNhNjc2ZWQxYjYyODdmZTliOGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "38d2ea9fb59127be88de56b5b05b20dc7656aea6", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/38d2ea9fb59127be88de56b5b05b20dc7656aea6", "committedDate": "2020-06-15T17:41:53Z", "message": "Tracing only for certain sections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "918c617f1d9aa2034dbcf3c2aa6640ee565df423", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/918c617f1d9aa2034dbcf3c2aa6640ee565df423", "committedDate": "2020-06-15T17:41:53Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMxNDYxMzY1", "url": "https://github.com/palantir/atlasdb/pull/4837#pullrequestreview-431461365", "createdAt": "2020-06-16T12:42:21Z", "commit": {"oid": "918c617f1d9aa2034dbcf3c2aa6640ee565df423"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjo0MjoyMlrOGkZb0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNlQxMjo0NTozN1rOGkZj2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgxODY0Mg==", "bodyText": "I think this comment, in isolation, is not that useful: I assume it is explaining why this is not timed, but outside of the context of this PR it doesn't really imply. Perhaps:\n// Not timed because TransactionService.putUnlessExists actually commits the transaction, and is timed", "url": "https://github.com/palantir/atlasdb/pull/4837#discussion_r440818642", "createdAt": "2020-06-16T12:42:22Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -1700,28 +1703,33 @@ private void commitWrites(TransactionService transactionService) {\n                 // We check the pre-commit conditions first since they may operate similarly to read write conflict\n                 // handling - we should check lock validity last to ensure that sweep hasn't affected the checks.\n                 timedAndTraced(\"userPreCommitCondition\", () -> throwIfPreCommitConditionInvalid(commitTimestamp));\n-                timedAndTraced(\"preCommitLockCheck\", () -> throwIfImmutableTsOrCommitLocksExpired(commitLocksToken));\n+                traced(\"preCommitLockCheck\", () -> throwIfImmutableTsOrCommitLocksExpired(commitLocksToken));\n \n-                timedAndTraced(\"commitPutCommitTs\",\n+                // TransactionService.putUnlessExists: actually commits the transaction", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "918c617f1d9aa2034dbcf3c2aa6640ee565df423"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgyMDY5Nw==", "bodyText": "You've mentioned:\n\"refreshing commit locks: consider ConjureTimelockServiceBlocking.refreshLockLeases\"\nin the changelog, but I don't see a comment here in the code (where you have for others that are no longer timed). Is it perhaps adding a comment?", "url": "https://github.com/palantir/atlasdb/pull/4837#discussion_r440820697", "createdAt": "2020-06-16T12:45:37Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -1700,28 +1703,33 @@ private void commitWrites(TransactionService transactionService) {\n                 // We check the pre-commit conditions first since they may operate similarly to read write conflict\n                 // handling - we should check lock validity last to ensure that sweep hasn't affected the checks.\n                 timedAndTraced(\"userPreCommitCondition\", () -> throwIfPreCommitConditionInvalid(commitTimestamp));\n-                timedAndTraced(\"preCommitLockCheck\", () -> throwIfImmutableTsOrCommitLocksExpired(commitLocksToken));\n+                traced(\"preCommitLockCheck\", () -> throwIfImmutableTsOrCommitLocksExpired(commitLocksToken));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "918c617f1d9aa2034dbcf3c2aa6640ee565df423"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92bc1079b01857e28cfa43a676ed1b6287fe9b8d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/92bc1079b01857e28cfa43a676ed1b6287fe9b8d", "committedDate": "2020-06-16T17:39:39Z", "message": "CR: shore up explanations"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2941, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}