{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2NzUyNzI0", "number": 4847, "title": "[PDS$-110002] Part 5 | PoC?: Threshold-Based Metric Filtering and Metric-Schema for Targeted Sweep Metrics", "bodyText": "Warning: A bit on the heavier side, could possibly be split up.\nGoals (and why):\n\nSave $$$\nAllow metrics to be filtered for publication based on a user-implemented filter that interprets their values (or, in practice, runs an arbitrary predicate)\n\nImplementation Description (bullets):\n\nImplement FilteredTaggedMetricsSet that allows filtering based on user-registered filters\nUse the set in a MetricManager and allow users to register filters\nImplement a kill switch: runtime config that forces all filters to be ignored\nRewire targeted sweep metrics to use metric-schema\nImplement a filter on targeted sweep metrics to publish if the number of reads/writes is >1000, or if the head of the queue is more than 6 hours old.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nAdded some unit tests.\nI want to do a smoke test.\n\nConcerns (what feedback would you like?):\n\nDoes it actually work?\nDoes the wiring broadly make sense?\nIs the choice of constants for Targeted Sweep reasonable?\nI don't deregister metrics until the next bounce once they leave the thresholds because it probably won't save that much money, and it is probably valuable to see how a system recovers (see discussion in internal chat channel), does this make sense?\n\nWhere should we start reviewing?: FilteredTaggedMetricsSet\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-06-18T20:42:57Z", "url": "https://github.com/palantir/atlasdb/pull/4847", "merged": true, "mergeCommit": {"oid": "3347cca284f5c1dfafe45ccab7c035e69af16a21"}, "closed": true, "closedAt": "2020-06-23T11:32:52Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsQrUmgH2gAyNDM2NzUyNzI0OjM1OGIyOGVlYmYwOTUxNGQ2MDZjMTc3MWM1YjkyMDU0NDJjZjNiMjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABct0uv8AFqTQzNTE1NDA1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "358b28eebf09514d606c1771c5b9205442cf3b22", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/358b28eebf09514d606c1771c5b9205442cf3b22", "committedDate": "2020-06-17T21:24:33Z", "message": "only used tagged MR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f081295f6385ad7e1fcce3358bbcb8ad408078f9", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/f081295f6385ad7e1fcce3358bbcb8ad408078f9", "committedDate": "2020-06-17T21:24:54Z", "message": "disjoint union set"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1088ed7f74d166c1e5a6faae6e31a8b6ba95ad9", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/b1088ed7f74d166c1e5a6faae6e31a8b6ba95ad9", "committedDate": "2020-06-17T21:35:15Z", "message": "pffty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c11b01027cde938a3fec71d32eb4f5ec7d37819a", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/c11b01027cde938a3fec71d32eb4f5ec7d37819a", "committedDate": "2020-06-18T10:07:22Z", "message": "Concept of filters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8aecd5620c61fa108930d850b883fbdf96d9fce", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e8aecd5620c61fa108930d850b883fbdf96d9fce", "committedDate": "2020-06-18T11:36:52Z", "message": "metric schema attempt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5d63f2b4454066705539c8af94f0ec8203a708d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/a5d63f2b4454066705539c8af94f0ec8203a708d", "committedDate": "2020-06-18T11:43:13Z", "message": "Change API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "539dbeaf79ec809be0ad35bd65d8f5622e6408fd", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/539dbeaf79ec809be0ad35bd65d8f5622e6408fd", "committedDate": "2020-06-18T12:01:52Z", "message": "Add kill switch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be181f8a15e21a1e3531b2c77ea119c45202353e", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/be181f8a15e21a1e3531b2c77ea119c45202353e", "committedDate": "2020-06-18T12:03:55Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5af95b59a7bfabf27b471fc29938ec136e908ba6", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/5af95b59a7bfabf27b471fc29938ec136e908ba6", "committedDate": "2020-06-18T19:22:00Z", "message": "baseline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f6bb7205f22b48f36633dc7620da49e0f6b778a", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/4f6bb7205f22b48f36633dc7620da49e0f6b778a", "committedDate": "2020-06-18T19:36:28Z", "message": "Baseline and Licenses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2ab7087ebd20419fefe45da6509b965aa65deae", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d2ab7087ebd20419fefe45da6509b965aa65deae", "committedDate": "2020-06-18T20:05:21Z", "message": "Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "274891fa564085531f41ed9b6934f72397255dd4", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/274891fa564085531f41ed9b6934f72397255dd4", "committedDate": "2020-06-18T20:28:52Z", "message": "Exclude metric schema generated stuff from license"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50e24b4b212edae0fc473b20a61149cc41bbb4cd", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/50e24b4b212edae0fc473b20a61149cc41bbb4cd", "committedDate": "2020-06-18T20:52:28Z", "message": "The relative paths are hard"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MDE4NTM0", "url": "https://github.com/palantir/atlasdb/pull/4847#pullrequestreview-434018534", "createdAt": "2020-06-19T11:56:18Z", "commit": {"oid": "50e24b4b212edae0fc473b20a61149cc41bbb4cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMTo1NjoxOFrOGmSPLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMTo1NjoxOFrOGmSPLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjc5Nzg2OA==", "bodyText": "Would it make sense for this class to just take a Predicate, and implement the filtering rules somewhere else?", "url": "https://github.com/palantir/atlasdb/pull/4847#discussion_r442797868", "createdAt": "2020-06-19T11:56:18Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/metrics/FilteredTaggedMetricSet.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.metrics;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.BiConsumer;\n+\n+import com.codahale.metrics.Metric;\n+import com.palantir.common.streams.KeyedStream;\n+import com.palantir.refreshable.Refreshable;\n+import com.palantir.tritium.metrics.registry.MetricName;\n+import com.palantir.tritium.metrics.registry.TaggedMetricSet;\n+\n+public class FilteredTaggedMetricSet implements TaggedMetricSet {\n+    private final TaggedMetricSet unfiltered;\n+    private final Map<MetricName, List<MetricPublicationFilter>> singleMetricFilters;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50e24b4b212edae0fc473b20a61149cc41bbb4cd"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MDIyNzEz", "url": "https://github.com/palantir/atlasdb/pull/4847#pullrequestreview-434022713", "createdAt": "2020-06-19T12:03:49Z", "commit": {"oid": "50e24b4b212edae0fc473b20a61149cc41bbb4cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMjowMzo0OVrOGmSalw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMjowMzo0OVrOGmSalw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgwMDc5MQ==", "bodyText": "I wonder if metric-schema should provide all of this for us? Basically the ability to specify that a metrics should be published only once a certain threshold is breached? I suspect we'll need this in a bunch of projects that are hoping to cut on spend. @ferozco", "url": "https://github.com/palantir/atlasdb/pull/4847#discussion_r442800791", "createdAt": "2020-06-19T12:03:49Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/sweep/metrics/TargetedSweepMetricPublicationFilter.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.sweep.metrics;\n+\n+import java.time.Duration;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.function.LongSupplier;\n+\n+import org.immutables.value.Value;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.palantir.atlasdb.metrics.MetricPublicationFilter;\n+\n+/**\n+ * Indicates whether targeted sweep metrics should be published.\n+ *\n+ * The criteria for publishing metrics for a given strategy, is if the number of enqueued writes or reads is in\n+ * excess of {@link #MINIMUM_READS_WRITES_TO_BE_CONSIDERED_ACTIVE}, or it is believed that targeted sweep is behind by\n+ * more than {@link #MINIMUM_STALE_DURATION}. If any of these conditions are true, then all targeted sweep metrics\n+ * will be published.\n+ */\n+public class TargetedSweepMetricPublicationFilter implements MetricPublicationFilter {\n+    @VisibleForTesting\n+    static final long MINIMUM_READS_WRITES_TO_BE_CONSIDERED_ACTIVE = 1_000;\n+    @VisibleForTesting\n+    static final Duration MINIMUM_STALE_DURATION = Duration.ofHours(4);\n+\n+    private final AtomicBoolean publicationLatch;\n+\n+    private final LongSupplier enqueuedWrites;\n+    private final LongSupplier entriesRead;\n+    private final LongSupplier millisSinceLastSweptTs;\n+\n+    public TargetedSweepMetricPublicationFilter(DecisionMetrics decisionMetrics) {\n+        this.publicationLatch = new AtomicBoolean(false);\n+        this.enqueuedWrites = decisionMetrics.enqueuedWrites();\n+        this.entriesRead = decisionMetrics.entriesRead();\n+        this.millisSinceLastSweptTs = decisionMetrics.millisSinceLastSweptTs();\n+    }\n+\n+    @Override\n+    public boolean shouldPublish() {\n+        if (publicationLatch.get()) {\n+            return true;\n+        }\n+        boolean conditionsAchieved = testConditions();\n+        if (conditionsAchieved) {\n+            publicationLatch.compareAndSet(false, true);\n+        }\n+        return conditionsAchieved;\n+    }\n+\n+    private boolean testConditions() {\n+        return enqueuedWrites.getAsLong() >= MINIMUM_READS_WRITES_TO_BE_CONSIDERED_ACTIVE", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50e24b4b212edae0fc473b20a61149cc41bbb4cd"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f139cfd6481b6cae4f02d97f79e6255ff0b82cc", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/8f139cfd6481b6cae4f02d97f79e6255ff0b82cc", "committedDate": "2020-06-19T12:30:28Z", "message": "null filter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94a114146f734c0ec0fac4fdaa7ea6cf9f8f4d62", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/94a114146f734c0ec0fac4fdaa7ea6cf9f8f4d62", "committedDate": "2020-06-19T14:49:31Z", "message": "Separate predicate and filter registration logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e02928dfef0b203aa4535f79553e62b0aa97d204", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e02928dfef0b203aa4535f79553e62b0aa97d204", "committedDate": "2020-06-19T14:49:53Z", "message": "Oops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14dffbcc54dc4681b05ce60c2c2121e08d749d8a", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/14dffbcc54dc4681b05ce60c2c2121e08d749d8a", "committedDate": "2020-06-19T14:57:26Z", "message": "Simplify MetricsManager and extract filter logic to the Arbiter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjEzNjQw", "url": "https://github.com/palantir/atlasdb/pull/4847#pullrequestreview-434213640", "createdAt": "2020-06-19T16:43:15Z", "commit": {"oid": "14dffbcc54dc4681b05ce60c2c2121e08d749d8a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNjo0MzoxNVrOGmbJQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNjo0MzoxNVrOGmbJQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0MzgxMA==", "bodyText": "Should we make this user-configurable?", "url": "https://github.com/palantir/atlasdb/pull/4847#discussion_r442943810", "createdAt": "2020-06-19T16:43:15Z", "author": {"login": "sudiksha27"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/sweep/metrics/TargetedSweepMetricPublicationFilter.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.sweep.metrics;\n+\n+import java.time.Duration;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.function.LongSupplier;\n+\n+import org.immutables.value.Value;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.palantir.atlasdb.metrics.MetricPublicationFilter;\n+\n+/**\n+ * Indicates whether targeted sweep metrics should be published.\n+ *\n+ * The criteria for publishing metrics for a given strategy, is if the number of enqueued writes or reads is in\n+ * excess of {@link #MINIMUM_READS_WRITES_TO_BE_CONSIDERED_ACTIVE}, or it is believed that targeted sweep is behind by\n+ * more than {@link #MINIMUM_STALE_DURATION}. If any of these conditions are true, then all targeted sweep metrics\n+ * will be published.\n+ */\n+public class TargetedSweepMetricPublicationFilter implements MetricPublicationFilter {\n+    @VisibleForTesting\n+    static final long MINIMUM_READS_WRITES_TO_BE_CONSIDERED_ACTIVE = 1_000;\n+    @VisibleForTesting", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14dffbcc54dc4681b05ce60c2c2121e08d749d8a"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c880a1bca9dcfaa1bc33bad3a129a9b313af56b", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/4c880a1bca9dcfaa1bc33bad3a129a9b313af56b", "committedDate": "2020-06-19T16:45:41Z", "message": "Baseline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d71efbd74b34af83e0105fa6db61419a8bc1ba0d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d71efbd74b34af83e0105fa6db61419a8bc1ba0d", "committedDate": "2020-06-22T16:56:58Z", "message": "Merge branch 'develop' into jkong/tagged-with-restrictions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fc4c24e5f52c5c7c35f91a272579c3732bcda92", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/5fc4c24e5f52c5c7c35f91a272579c3732bcda92", "committedDate": "2020-06-22T17:06:40Z", "message": "changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8968902274dbf6c92e8e0f35507ad420e6f0a7a2", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/8968902274dbf6c92e8e0f35507ad420e6f0a7a2", "committedDate": "2020-06-22T17:07:12Z", "message": "semantic merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MTU0MDUw", "url": "https://github.com/palantir/atlasdb/pull/4847#pullrequestreview-435154050", "createdAt": "2020-06-22T17:58:48Z", "commit": {"oid": "8968902274dbf6c92e8e0f35507ad420e6f0a7a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2959, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}