{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3MzkyMDE5", "number": 5062, "title": "Leader Election Metrics 1a: Client Side Wiring", "bodyText": "Goals (and why):\n\nAdd metrics to the client to monitor the perceived impact of leader elections. Note that further metrics on the actual length of leader elections will be introduced in #5069.\n\nImplementation Description (bullets):\n\nExtracted an interface for NamespacedConjureTimelockService, and created another class that delegates to the implementation.\nMonitor startTransactions and getCommitTimestamp requests, and report metrics when these perceive a leader change.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nAdded a unit test; intend on adding ETE tests later (in a followup PR).\n\nConcerns (what feedback would you like?):\n\nConfirm that this won't affect performance\n\nWhere should we start reviewing?:\n\nLeaderElectionReportingTimelockService\n\nPriority (whenever / two weeks / yesterday):\nThis week", "createdAt": "2020-10-21T09:30:48Z", "url": "https://github.com/palantir/atlasdb/pull/5062", "merged": true, "mergeCommit": {"oid": "8106ea9c4dd52cded65c5bbee63bf68ade32bffd"}, "closed": true, "closedAt": "2020-10-22T10:48:32Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUp8N0AH2gAyNTA3MzkyMDE5OmI3OTMyNjQ2ODJiYjA3NWE3YzVhNzc5ZDVkYzMzNGE0MzAyZmFkOTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdU_rGagFqTUxNDU2OTg3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b793264682bb075a7c5a779d5dc334a4302fad95", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/b793264682bb075a7c5a779d5dc334a4302fad95", "committedDate": "2020-10-21T09:27:36Z", "message": "Transfer changes from other branches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee6bb046be4501552fe35f873a4fade024c877b8", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/ee6bb046be4501552fe35f873a4fade024c877b8", "committedDate": "2020-10-21T14:12:34Z", "message": "Pull in the right things"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d4669f0c72d8fb4a0fad8bc0afb94d414faa88b", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/7d4669f0c72d8fb4a0fad8bc0afb94d414faa88b", "committedDate": "2020-10-21T15:12:01Z", "message": "Merge branch 'develop' into le/client-i"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48a3db4d3a5b0bd5f05a87b9d0856c55a8d09738", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/48a3db4d3a5b0bd5f05a87b9d0856c55a8d09738", "committedDate": "2020-10-21T15:25:12Z", "message": "rename"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzODEzMzk5", "url": "https://github.com/palantir/atlasdb/pull/5062#pullrequestreview-513813399", "createdAt": "2020-10-21T15:25:37Z", "commit": {"oid": "48a3db4d3a5b0bd5f05a87b9d0856c55a8d09738"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNToyNTozN1rOHlyUtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNToyNTozN1rOHlyUtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTM4Mzg2MQ==", "bodyText": "drive-by", "url": "https://github.com/palantir/atlasdb/pull/5062#discussion_r509383861", "createdAt": "2020-10-21T15:25:37Z", "author": {"login": "Jolyon-S"}, "path": "lock-api/src/main/java/com/palantir/lock/client/RemoteTimelockServiceAdapter.java", "diffHunk": "@@ -59,17 +57,6 @@ public static RemoteTimelockServiceAdapter create(\n         return new RemoteTimelockServiceAdapter(rpcClient, conjureClient, lockWatchEventCache);\n     }\n \n-    public static RemoteTimelockServiceAdapter create(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48a3db4d3a5b0bd5f05a87b9d0856c55a8d09738"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NTQ2MjI3", "url": "https://github.com/palantir/atlasdb/pull/5062#pullrequestreview-514546227", "createdAt": "2020-10-22T09:44:45Z", "commit": {"oid": "48a3db4d3a5b0bd5f05a87b9d0856c55a8d09738"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NTY5ODc2", "url": "https://github.com/palantir/atlasdb/pull/5062#pullrequestreview-514569876", "createdAt": "2020-10-22T10:13:49Z", "commit": {"oid": "48a3db4d3a5b0bd5f05a87b9d0856c55a8d09738"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMDoxMzo0OVrOHmaoCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxMDoxMzo0OVrOHmaoCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDA0NDE2OQ==", "bodyText": "This will have a number of downstream breaks in the internal backup product and internal timelock migration CLI tools. Overall impact is limited, but we need to ensure these get fixed.", "url": "https://github.com/palantir/atlasdb/pull/5062#discussion_r510044169", "createdAt": "2020-10-22T10:13:49Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/client/NamespacedConjureTimelockService.java", "diffHunk": "@@ -24,54 +24,27 @@\n import com.palantir.atlasdb.timelock.api.ConjureRefreshLocksResponse;\n import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsRequest;\n import com.palantir.atlasdb.timelock.api.ConjureStartTransactionsResponse;\n-import com.palantir.atlasdb.timelock.api.ConjureTimelockService;\n import com.palantir.atlasdb.timelock.api.ConjureUnlockRequest;\n import com.palantir.atlasdb.timelock.api.ConjureUnlockResponse;\n import com.palantir.atlasdb.timelock.api.ConjureWaitForLocksResponse;\n import com.palantir.atlasdb.timelock.api.GetCommitTimestampsRequest;\n import com.palantir.atlasdb.timelock.api.GetCommitTimestampsResponse;\n import com.palantir.lock.v2.LeaderTime;\n-import com.palantir.tokens.auth.AuthHeader;\n \n-public class NamespacedConjureTimelockService {\n-    private static final AuthHeader AUTH_HEADER = AuthHeader.valueOf(\"Bearer omitted\");\n-    private final String namespace;\n-    private final ConjureTimelockService conjureTimelockService;\n+public interface NamespacedConjureTimelockService {\n+    ConjureUnlockResponse unlock(ConjureUnlockRequest request);\n \n-    public NamespacedConjureTimelockService(ConjureTimelockService conjureTimelockService, String namespace) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48a3db4d3a5b0bd5f05a87b9d0856c55a8d09738"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2680, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}