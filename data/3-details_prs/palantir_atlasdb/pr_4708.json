{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMzE3NjU4", "number": 4708, "title": "[PDS-111849] Rolling in the Deep, Part 5: Only One Dedicated Executor", "bodyText": "Goals (and why):\n\nUnderstand why the number of acceptor threads on a leader at a deployment went up by >500 when a non-leader was bounced, when it should really only increase by 100.\nThe original implementation in this chain of PRs spins up dedicated executors for every time the acceptor factory is called, which is every time a new client is presented (see LeadershipComponents#createNewLeadershipContext). The previous PR thus limited thread explosion from infinite to (100 * num_clients). In practice because of autobatching and the like it generally won't be anywhere near that cap, but I think we wanted 100 in general, not 100 per client.\n\nImplementation Description (bullets):\n\nRewire things so that each remote has a canonical executor for leadership acceptor operations across clients. This is much closer to the intention of the original fix I had.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nExisting tests pass, including the stress test.\nI validated through the debugger that you only get one creation of these thread pools per remote now, while previously we would stop at multiple points to create the bounded executors.\n\nConcerns (what feedback would you like?):\n\nIs there anything wired wrongly? The existing tests passing and debugger validation give me some confidence, but always worth a check.\nWill we run into problems with rejected executions? I think rejecting is actually the desired behaviour, and if the cluster is stable we should get a response from the other node (and if it's not we shouldn't proceed).\n\nWhere should we start reviewing?: SingleLeaderNetworkClientFactories\nPriority (whenever / two weeks / yesterday): ideally earlier this week, this is part of the big issue", "createdAt": "2020-04-14T17:27:45Z", "url": "https://github.com/palantir/atlasdb/pull/4708", "merged": true, "mergeCommit": {"oid": "7b70096eac214f67572b5ae2cb300669ee66d2ee"}, "closed": true, "closedAt": "2020-04-16T11:06:04Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWPJWIAH2gAyNDAzMzE3NjU4OjQ1MDI0MzEwNzkxMGUwZTJkMWFiMjZlZDJiYTVlOGFjZTdlMTViYmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYJerRgH2gAyNDAzMzE3NjU4OmQ3ZDc0YmM2Y2NkOGY1NGFmNGRiOTUxOTg0MTVjNDdiNjgyNmYwMzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "450243107910e0e2d1ab26ed2ba5e8ace7e15bbd", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/450243107910e0e2d1ab26ed2ba5e8ace7e15bbd", "committedDate": "2020-04-10T11:11:12Z", "message": "rearchitecture"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a960ce6617a74cef7acea14cbacc05957e0c1174", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/a960ce6617a74cef7acea14cbacc05957e0c1174", "committedDate": "2020-04-14T16:04:02Z", "message": "fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2280955dae7f463f3e5d3f2d5f7fba0b18eabb11", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/2280955dae7f463f3e5d3f2d5f7fba0b18eabb11", "committedDate": "2020-04-14T16:29:55Z", "message": "Baseline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcfdd422e176b33de0abbc720c44391036211f41", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/dcfdd422e176b33de0abbc720c44391036211f41", "committedDate": "2020-04-14T16:40:29Z", "message": "timestamp paxos should be restricted too"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55fee2cfdd1a64e6c2202b8aa8005a27d29ded22", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/55fee2cfdd1a64e6c2202b8aa8005a27d29ded22", "committedDate": "2020-04-14T17:22:23Z", "message": "Revert \"timestamp paxos should be restricted too\"\n\nThis reverts commit dcfdd422e176b33de0abbc720c44391036211f41."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23f445aba7f634f24a34a76c0aeb60918031b786", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/23f445aba7f634f24a34a76c0aeb60918031b786", "committedDate": "2020-04-14T17:23:05Z", "message": "cs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e03594278ed345c77f98e1ee4a001deea4312eda", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e03594278ed345c77f98e1ee4a001deea4312eda", "committedDate": "2020-04-14T17:23:05Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNjc2NTA2", "url": "https://github.com/palantir/atlasdb/pull/4708#pullrequestreview-393676506", "createdAt": "2020-04-15T11:12:44Z", "commit": {"oid": "e03594278ed345c77f98e1ee4a001deea4312eda"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMToxMjo0NFrOGF07dQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMTozNDo0NFrOGF1nQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc2MzI1Mw==", "bodyText": "\u2764\ufe0f", "url": "https://github.com/palantir/atlasdb/pull/4708#discussion_r408763253", "createdAt": "2020-04-15T11:12:44Z", "author": {"login": "gmaretic"}, "path": "timelock-impl/src/main/java/com/palantir/atlasdb/timelock/paxos/WithDedicatedExecutor.java", "diffHunk": "@@ -0,0 +1,40 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.paxos;\n+\n+import java.util.Map;\n+import java.util.concurrent.ExecutorService;\n+import java.util.function.Function;\n+\n+import org.immutables.value.Value;\n+\n+@Value.Immutable\n+public interface WithDedicatedExecutor<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e03594278ed345c77f98e1ee4a001deea4312eda"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3NDE4Ng==", "bodyText": "we don't need this comment", "url": "https://github.com/palantir/atlasdb/pull/4708#discussion_r408774186", "createdAt": "2020-04-15T11:34:09Z", "author": {"login": "gmaretic"}, "path": "timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/PaxosRemoteClients.java", "diffHunk": "@@ -46,7 +50,23 @@\n     public abstract PaxosResourcesFactory.TimelockPaxosInstallationContext context();\n \n     @Value.Parameter\n-    public abstract TaggedMetricRegistry metrics();\n+    public abstract MetricsManager metrics();\n+\n+    @Value.Derived\n+    Map<String, ExecutorService> dedicatedExecutors() {\n+        Set<String> remoteUris = context().remoteUris();\n+        int executorIndex = 0; // Acceptable for Set, we just want to differentiate the elements", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e03594278ed345c77f98e1ee4a001deea4312eda"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODc3NDQ2NQ==", "bodyText": "Nice!", "url": "https://github.com/palantir/atlasdb/pull/4708#discussion_r408774465", "createdAt": "2020-04-15T11:34:44Z", "author": {"login": "gmaretic"}, "path": "timelock-agent/src/main/java/com/palantir/atlasdb/timelock/paxos/PaxosRemoteClients.java", "diffHunk": "@@ -113,7 +138,17 @@\n         return createInstrumentedRemoteProxies(clazz, shouldRetry).values().collect(Collectors.toList());\n     }\n \n-    private <T> KeyedStream<HostAndPort, T> createInstrumentedRemoteProxies(Class<T> clazz, boolean shouldRetry) {\n+    private <T> List<WithDedicatedExecutor<T>> createInstrumentedRemoteProxiesAndAssignDedicatedExecutors(\n+            Class<T> clazz,\n+            boolean shouldRetry) {\n+        return createInstrumentedRemoteProxies(clazz, shouldRetry)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e03594278ed345c77f98e1ee4a001deea4312eda"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6754903a812e89b25357fc2eccebdb6e4c03074b", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/6754903a812e89b25357fc2eccebdb6e4c03074b", "committedDate": "2020-04-15T17:43:01Z", "message": "Remove stray comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84d4da3fb58ddc6606c59e8e6487cbc96b1e63a6", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/84d4da3fb58ddc6606c59e8e6487cbc96b1e63a6", "committedDate": "2020-04-16T09:27:01Z", "message": "Merge branch 'develop' into jkong/rolling-5"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2fec7790c80a05bfe9a743781e5c3ef2da9926f", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/c2fec7790c80a05bfe9a743781e5c3ef2da9926f", "committedDate": "2020-04-16T09:39:43Z", "message": "Merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7d74bc6ccd8f54af4db95198415c47b6826f037", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d7d74bc6ccd8f54af4db95198415c47b6826f037", "committedDate": "2020-04-16T09:42:55Z", "message": "merge conflict"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3058, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}