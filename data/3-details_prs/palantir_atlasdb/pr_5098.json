{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1Mjc1MTcz", "number": 5098, "title": "[LE] Wire in the metrics from client to server", "bodyText": "Goals (and why):\nWe have implemented the calculation and aggregating of leader election time, but not yet wired it so that the client sends to the server.\nImplementation Description (bullets):\nTacked the sending of metrics on to the current timelock feedback background task.\nTesting (What was existing testing like?  What have you done to improve it?):\nDidn't add any testing, there was none existing.\nConcerns (what feedback would you like?):\nI think this was what we intended.\nWhere should we start reviewing?:\nTimeLockFeedbackBackgroundTask\nPriority (whenever / two weeks / yesterday):\nWant to get this through quickly.", "createdAt": "2020-11-04T10:07:20Z", "url": "https://github.com/palantir/atlasdb/pull/5098", "merged": true, "mergeCommit": {"oid": "c6ab95f14212670c4dbb3acc698f577a1fd8bb36"}, "closed": true, "closedAt": "2020-11-04T10:41:20Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZKwWMAH2gAyNTE1Mjc1MTczOjM0MGFhMWI4MTA1OGYyMzAyM2RlMzk0MzhmMWQ2OGE2Njc3ZWZhMjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZLYtMgFqTUyMzIzOTY3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "340aa1b81058f23023de39438f1d68a6677efa22", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/340aa1b81058f23023de39438f1d68a6677efa22", "committedDate": "2020-11-04T09:57:12Z", "message": "make some things static"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMjEyNjYw", "url": "https://github.com/palantir/atlasdb/pull/5098#pullrequestreview-523212660", "createdAt": "2020-11-04T10:07:49Z", "commit": {"oid": "340aa1b81058f23023de39438f1d68a6677efa22"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDowNzo1MFrOHtRQeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDowNzo1MFrOHtRQeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIzMDcxNA==", "bodyText": "Changes to this class are just cleanup (adding static, moving methods around).", "url": "https://github.com/palantir/atlasdb/pull/5098#discussion_r517230714", "createdAt": "2020-11-04T10:07:50Z", "author": {"login": "Jolyon-S"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LeaderElectionReportingTimelockService.java", "diffHunk": "@@ -63,7 +63,8 @@\n     private Map<UUID, Instant> leadershipUpperBound = new ConcurrentHashMap<>();\n     private Map<UUID, Instant> leadershipLowerBound = new ConcurrentHashMap<>();\n \n-    public LeaderElectionReportingTimelockService(\n+    @VisibleForTesting\n+    LeaderElectionReportingTimelockService(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "340aa1b81058f23023de39438f1d68a6677efa22"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc4cc95386e378bcfa3d5b61ae67427f9e9890e0", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/fc4cc95386e378bcfa3d5b61ae67427f9e9890e0", "committedDate": "2020-11-04T10:15:08Z", "message": "update build.gradle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8aa637a9a96be98a1d132550f54337bda335653", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/b8aa637a9a96be98a1d132550f54337bda335653", "committedDate": "2020-11-04T10:15:08Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMjI2NDg0", "url": "https://github.com/palantir/atlasdb/pull/5098#pullrequestreview-523226484", "createdAt": "2020-11-04T10:25:21Z", "commit": {"oid": "b8aa637a9a96be98a1d132550f54337bda335653"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDoyNToyMVrOHtR6rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDozNjoyNlrOHtSVnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0MTUxNg==", "bodyText": "This has AtlasDB 0.265.0, which is necessary.", "url": "https://github.com/palantir/atlasdb/pull/5098#discussion_r517241516", "createdAt": "2020-11-04T10:25:21Z", "author": {"login": "jeremyk-91"}, "path": "lock-api-objects/build.gradle", "diffHunk": "@@ -27,7 +27,7 @@ recommendedProductDependencies {\n     productDependency {\n         productGroup = 'com.palantir.timelock'\n         productName = 'timelock-server'\n-        minimumVersion = '0.218.0'\n+        minimumVersion = '0.313.0'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8aa637a9a96be98a1d132550f54337bda335653"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0ODQxNQ==", "bodyText": "this is a bit trippy, but correct", "url": "https://github.com/palantir/atlasdb/pull/5098#discussion_r517248415", "createdAt": "2020-11-04T10:36:26Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LeaderElectionReportingTimelockService.java", "diffHunk": "@@ -230,26 +232,30 @@ LeaderElectionStatistics getStatisticsAndSetRegistryTo(TaggedMetricRegistry metr\n         return durationToNextLeader(lowerBounds, upperBounds, leaders, secondToLastLongTermLeader);\n     }\n \n-    private Set<UUID> leadersWithBothBounds(Map<UUID, Instant> lowerBounds, Map<UUID, Instant> upperBounds) {\n+    private void clearOldLongTermLeaders(List<UUID> sortedLongTermLeaders) {\n+        for (int i = 0; i < sortedLongTermLeaders.size() - 2; i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8aa637a9a96be98a1d132550f54337bda335653"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMjM5Njcz", "url": "https://github.com/palantir/atlasdb/pull/5098#pullrequestreview-523239673", "createdAt": "2020-11-04T10:41:17Z", "commit": {"oid": "b8aa637a9a96be98a1d132550f54337bda335653"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2476, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}