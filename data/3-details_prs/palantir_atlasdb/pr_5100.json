{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1OTY2NDI0", "number": 5100, "title": "[LW] Filter out locks using the serverToken, not the fake token in LeasedLockToken", "bodyText": "Goals (and why):\n\nUsing the requestId from a lock token is not guaranteed to be the right request id - particularly for the LeasedLockToken that we actually receive in the commitWrites flow. Therefore we need to cast and filter correctly.\n\nImplementation Description (bullets):\n\nCheck if the lock token is the right type, then cast and retrieve the correct request ID.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nAdded a test to the integration tests. However, for best coverage we need ETE tests - these are coming in a subsequent PR.\n\nConcerns (what feedback would you like?):\n\nJust to make sure that this won't break anything.\nIs there a better way to test this without creating a really hacky LeasedLockTokenCreator test class?\n\nWhere should we start reviewing?:\n\nClientLogEvents\n\nPriority (whenever / two weeks / yesterday):\nASAP", "createdAt": "2020-11-05T10:42:58Z", "url": "https://github.com/palantir/atlasdb/pull/5100", "merged": true, "mergeCommit": {"oid": "78acfef31504bb21acc904bc69c122edf86fb2f6"}, "closed": true, "closedAt": "2020-11-06T13:06:06Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZf95AAH2gAyNTE1OTY2NDI0OjZiOTA4ZjIwNTI5YzQ2YjNiYzVmYTYyMjBkNmVlZTMwZTU3NGE4MzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ2cQqgH2gAyNTE1OTY2NDI0Ojk1YzI2OTZjMDQxMWIxYzVjYzM5NTk4YjA5ZjRlMjI2NWNjNDE1YTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6b908f20529c46b3bc5fa6220d6eee30e574a835", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/6b908f20529c46b3bc5fa6220d6eee30e574a835", "committedDate": "2020-11-05T10:40:00Z", "message": "actually filter out the right token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db7fe6271790c889988405a3490b5885ab2863e9", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/db7fe6271790c889988405a3490b5885ab2863e9", "committedDate": "2020-11-05T10:40:00Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MTM1MTU1", "url": "https://github.com/palantir/atlasdb/pull/5100#pullrequestreview-524135155", "createdAt": "2020-11-05T10:44:21Z", "commit": {"oid": "6b908f20529c46b3bc5fa6220d6eee30e574a835"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMDo0NDoyMVrOHt9e6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxMDo0NDoyMVrOHt9e6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzk1NTMwNA==", "bodyText": "this shows that LOCK_EVENT is filtered out, which contains DESCRIPTOR_3, whereas LOCK_EVENT_2 is present, with DESCRIPTOR present.", "url": "https://github.com/palantir/atlasdb/pull/5100#discussion_r517955304", "createdAt": "2020-11-05T10:44:21Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventCacheIntegrationTest.java", "diffHunk": "@@ -391,6 +398,28 @@ public void newEventsCauseOldEventsToBeDeleted() {\n         verifyStage();\n     }\n \n+    @Test\n+    public void commitLocksAreCorrectlyFilteredOutUsingServerToken() {\n+        setupInitialState();\n+        eventCache.processStartTransactionsUpdate(ImmutableSet.of(), SUCCESS);\n+\n+        // simulates the actual lock token that the client receives\n+        ConjureLockToken serverToken = ConjureLockToken.of(COMMIT_TOKEN.getRequestId());\n+        LockToken commitToken = LeasedLockTokenCreator.of(\n+                serverToken,\n+                Lease.of(LeaderTime.of(LeadershipId.random(), NanoTime.createForTests(1L)), Duration.ZERO));\n+        eventCache.processGetCommitTimestampsUpdate(\n+                ImmutableSet.of(ImmutableTransactionUpdate.builder()\n+                        .commitTs(5L)\n+                        .startTs(START_TS)\n+                        .writesToken(commitToken)\n+                        .build()),\n+                SUCCESS_2);\n+\n+        assertThat(eventCache.getCommitUpdate(START_TS).accept(new CommitUpdateVisitor()))\n+                .containsExactlyInAnyOrder(DESCRIPTOR);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b908f20529c46b3bc5fa6220d6eee30e574a835"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MTU4OTI1", "url": "https://github.com/palantir/atlasdb/pull/5100#pullrequestreview-524158925", "createdAt": "2020-11-05T11:15:17Z", "commit": {"oid": "db7fe6271790c889988405a3490b5885ab2863e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44980e5f9c28bcef4c3302de04c1012dc3c54998", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/44980e5f9c28bcef4c3302de04c1012dc3c54998", "committedDate": "2020-11-05T17:26:53Z", "message": "force circle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e447cbec24d32a3f06609e74e5ad1b4cf5c7f3c", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/0e447cbec24d32a3f06609e74e5ad1b4cf5c7f3c", "committedDate": "2020-11-05T17:27:38Z", "message": "revert change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6f310ef6f39068edba1086cf3817aea9e001334", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/d6f310ef6f39068edba1086cf3817aea9e001334", "committedDate": "2020-11-06T11:56:59Z", "message": "remove bad test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95c2696c0411b1c5cc39598b09f4e2265cc415a7", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/95c2696c0411b1c5cc39598b09f4e2265cc415a7", "committedDate": "2020-11-06T12:51:05Z", "message": "Merge branch 'develop' into lw/lease-lock-token"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2482, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}