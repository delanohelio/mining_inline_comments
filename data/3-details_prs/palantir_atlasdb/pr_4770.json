{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NjEwNjUy", "number": 4770, "title": "Allow invalidating SweepStrategyManager cache", "bodyText": "Goals (and why):\nUseful to change the sweep strategy on an existing table without\nbouncing the service.\nImplementation Description (bullets):\nJust expose a new method that allows cache invalidation.\nTesting (What was existing testing like?  What have you done to improve it?):\nConcerns (what feedback would you like?):\nWhere should we start reviewing?:\nPriority (whenever / two weeks / yesterday):", "createdAt": "2020-05-13T21:01:42Z", "url": "https://github.com/palantir/atlasdb/pull/4770", "merged": true, "mergeCommit": {"oid": "ffd77e087366614fee9a650af2e10c106043c493"}, "closed": true, "closedAt": "2020-05-14T17:00:04Z", "author": {"login": "mswintermeyer"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg_VqEAH2gAyNDE3NjEwNjUyOjc0NjU2YzRmNWFkNDFhZDAyZWFmODZhMjAyYWJjYWExNTE4ZDE3MmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchQgr9AFqTQxMjAwNDkxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "74656c4f5ad41ad02eaf86a202abcaa1518d172c", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/74656c4f5ad41ad02eaf86a202abcaa1518d172c", "committedDate": "2020-05-13T20:59:20Z", "message": "Allow invalidating SweepStrategyManager cache\n\nUseful to change the sweep strategy on an existing table without\nbouncing the service."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "beaaf2ec3a71738aedcd1b7df7ae4aeb94f0724d", "author": {"user": {"login": "mswintermeyer", "name": "Michael Wintermeyer"}}, "url": "https://github.com/palantir/atlasdb/commit/beaaf2ec3a71738aedcd1b7df7ae4aeb94f0724d", "committedDate": "2020-05-13T20:59:20Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExOTg0NDA3", "url": "https://github.com/palantir/atlasdb/pull/4770#pullrequestreview-411984407", "createdAt": "2020-05-14T16:34:11Z", "commit": {"oid": "beaaf2ec3a71738aedcd1b7df7ae4aeb94f0724d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExOTkzNjM1", "url": "https://github.com/palantir/atlasdb/pull/4770#pullrequestreview-411993635", "createdAt": "2020-05-14T16:45:35Z", "commit": {"oid": "beaaf2ec3a71738aedcd1b7df7ae4aeb94f0724d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjo0NTozNVrOGVlM_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjo0NTozNVrOGVlM_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4MjgxNQ==", "bodyText": "/**\n   * Discards any cached values for the {@code keys}. The behavior of this operation is undefined\n   * for an entry that is being loaded (or reloaded) and is otherwise not present.\n   *\n   * @param keys the keys whose associated values are to be removed\n   * @throws NullPointerException if the specified collection is null or contains a null element\n   */\n  void invalidateAll(@NonNull Iterable<?> keys);\n\nInvalidating something that's not there looks like it could end up either way. It's a bit nasty, but should we take a read-write lock?", "url": "https://github.com/palantir/atlasdb/pull/4770#discussion_r425282815", "createdAt": "2020-05-14T16:45:35Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/transaction/impl/SweepStrategyManagers.java", "diffHunk": "@@ -51,7 +52,17 @@ public static SweepStrategyManager createDefault(KeyValueService kvs) {\n                     return cache;\n                 });\n \n-        return tableRef -> sweepStrategySupplierLoadingCache.get().get(tableRef);\n+        return new SweepStrategyManager() {\n+            @Override\n+            public SweepStrategy get(TableReference tableRef) {\n+                return sweepStrategySupplierLoadingCache.get().get(tableRef);\n+            }\n+\n+            @Override\n+            public void invalidateCaches(Set<TableReference> tableRefs) {\n+                sweepStrategySupplierLoadingCache.get().invalidateAll(tableRefs);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "beaaf2ec3a71738aedcd1b7df7ae4aeb94f0724d"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMDA0OTE3", "url": "https://github.com/palantir/atlasdb/pull/4770#pullrequestreview-412004917", "createdAt": "2020-05-14T16:59:46Z", "commit": {"oid": "beaaf2ec3a71738aedcd1b7df7ae4aeb94f0724d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2842, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}