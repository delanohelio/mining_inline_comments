{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0MDkxMDE1", "number": 5036, "title": "[TL] Persist Schema Version in Sqlite", "bodyText": "Goals (and why):\nThis allows us to explode in the future if we go down to an unsupported version\nImplementation Description (bullets):\nStraightforward. Left the schema version at 3 because there is no real benefit to changing it at this time.\nTesting (What was existing testing like?  What have you done to improve it?):\nUnit tests\nConcerns (what feedback would you like?):\nNote that we upgrade the schema version  as the last task before the TimelockAgent is created. This means that it is done after paxos sqlite migration. In the future it may be necessary to upgrade the schema version only after some asynchronous migration has run. I added a comment about this, is this a reasonable amount of caution?\nWhere should we start reviewing?:\nSmall\nPriority (whenever / two weeks / yesterday):\nThis week", "createdAt": "2020-10-15T13:07:34Z", "url": "https://github.com/palantir/atlasdb/pull/5036", "merged": true, "mergeCommit": {"oid": "2cef3fbd0423e056ea4e9b6d14676f900f97915a"}, "closed": true, "closedAt": "2020-10-21T14:27:53Z", "author": {"login": "gmaretic"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSxNwpgH2gAyNTA0MDkxMDE1OjJkODU4MDIyYTVlNDBjMGM3NzFjYTg2MTlhMTdiNGYzYzIxODhhZWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUt-7bgH2gAyNTA0MDkxMDE1OjcwMjQ2MmZmZDM3MzNmNDAxYjliNTc2YzAwN2YyZmM1YmUxYjAwODA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2d858022a5e40c0c771ca8619a17b4f3c2188aea", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/2d858022a5e40c0c771ca8619a17b4f3c2188aea", "committedDate": "2020-10-15T12:48:15Z", "message": "Persist timelock schema version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3a611ebd581f96399aa72f48b7d9feb3ac63dfa", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/f3a611ebd581f96399aa72f48b7d9feb3ac63dfa", "committedDate": "2020-10-15T12:53:59Z", "message": "they see me rollin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ebdf110b9e5bd078174640be10960ae63ddd7ef", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/6ebdf110b9e5bd078174640be10960ae63ddd7ef", "committedDate": "2020-10-15T13:06:20Z", "message": "add warning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad885a55fa34d00d305cd25142eb8305d1b58da5", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/ad885a55fa34d00d305cd25142eb8305d1b58da5", "committedDate": "2020-10-15T13:06:20Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5MzY3OTY5", "url": "https://github.com/palantir/atlasdb/pull/5036#pullrequestreview-509367969", "createdAt": "2020-10-15T13:17:56Z", "commit": {"oid": "ad885a55fa34d00d305cd25142eb8305d1b58da5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa5790d92fee4be5e821c57482c0a7e5fd3f340b", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/aa5790d92fee4be5e821c57482c0a7e5fd3f340b", "committedDate": "2020-10-16T10:45:17Z", "message": "Throw if schema version mismatch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNzY5Njkz", "url": "https://github.com/palantir/atlasdb/pull/5036#pullrequestreview-512769693", "createdAt": "2020-10-20T14:18:20Z", "commit": {"oid": "aa5790d92fee4be5e821c57482c0a7e5fd3f340b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDoxODoyMVrOHk_XmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxNDoxODoyMVrOHk_XmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODU0OTAxNg==", "bodyText": "Doesn't this need to be before all the setting up of PaxosResources etc.? Isn't this currently where the migration happens?", "url": "https://github.com/palantir/atlasdb/pull/5036#discussion_r508549016", "createdAt": "2020-10-20T14:18:21Z", "author": {"login": "jkozlowski"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java", "diffHunk": "@@ -124,6 +126,13 @@ public static TimeLockAgent create(MetricsManager metricsManager,\n                 metricsManager,\n                 Suppliers.compose(TimeLockRuntimeConfiguration::paxos, runtime::get));\n \n+        // Upgrading the schema version should generally happen AFTER any migration has finished running. Keep this in\n+        // mind for any potential live migrations\n+        PersistedSchemaVersion persistedSchemaVersion = PersistedSchemaVersion\n+                .create(installationContext.sqliteDataSource());\n+        persistedSchemaVersion.upgradeVersion(SCHEMA_VERSION);\n+        verifySchemaVersion(persistedSchemaVersion);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa5790d92fee4be5e821c57482c0a7e5fd3f340b"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "676459b4d31f393e1b8239d2652c161f6e58305d", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/676459b4d31f393e1b8239d2652c161f6e58305d", "committedDate": "2020-10-21T13:21:51Z", "message": "Merge with develop, move the check to before the migration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "702462ffd3733f401b9b576c007f2fc5be1b0080", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/702462ffd3733f401b9b576c007f2fc5be1b0080", "committedDate": "2020-10-21T14:10:11Z", "message": "spotless"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2650, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}