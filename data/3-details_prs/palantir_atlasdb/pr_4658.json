{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMjM3NDE4", "number": 4658, "title": "[PDS-111849] Trace Parts of AwaitingLeadershipProxy", "bodyText": "Goals (and why):\nPart of PDS-111849, and also there are some perf characteristics about TimeLock I'd be interested in understanding more about - this would be a first step.\nImplementation Description (bullets):\nAdd some tracing to the leadership check and delegate execution pieces of ALP\nTesting (What was existing testing like?  What have you done to improve it?):\nNone, is there a good way of testing this?\nConcerns (what feedback would you like?):\n\nNot much testing: is there a way to test I've set this up correctly?\nFor the Async things, is the method I'm using correct? The intention is to trace how long the operation takes to get done, and not how long it takes to return the future.\n\nWhere should we start reviewing?: ALP, it's small\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-03-19T21:06:05Z", "url": "https://github.com/palantir/atlasdb/pull/4658", "merged": true, "mergeCommit": {"oid": "a95eb8a644a8f75c4fbb232ee098b0f028965d80"}, "closed": true, "closedAt": "2020-03-24T17:35:15Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPSYQgAH2gAyMzkxMjM3NDE4OjhjMDYxY2UwOWIxZDA4ZDFlY2MxYzUxMzJmYWJhNDZkODdhNGMyMmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ2EFGAFqTM4MDUyMTk4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8c061ce09b1d08d1ecc1c5132faba46d87a4c22f", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/8c061ce09b1d08d1ecc1c5132faba46d87a4c22f", "committedDate": "2020-03-19T20:59:44Z", "message": "Trace parts of AwaitingLeadershipProxy."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9892b7c057c5c3d482f2d03998c49dfb47f844d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/c9892b7c057c5c3d482f2d03998c49dfb47f844d", "committedDate": "2020-03-19T20:59:44Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7a39841e16187f1796e0cbff11fe01384c6b66d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/c7a39841e16187f1796e0cbff11fe01384c6b66d", "committedDate": "2020-03-20T15:29:51Z", "message": "Tracing tests and fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c637ccabcf128ca8149a7176eddea495caae9aa1", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/c637ccabcf128ca8149a7176eddea495caae9aa1", "committedDate": "2020-03-20T18:55:56Z", "message": "Merge branch 'jkong/tracing' of github.com:palantir/atlasdb into jkong/tracing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDU1ODM5", "url": "https://github.com/palantir/atlasdb/pull/4658#pullrequestreview-379455839", "createdAt": "2020-03-23T14:00:56Z", "commit": {"oid": "c637ccabcf128ca8149a7176eddea495caae9aa1"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDowMDo1NlrOF6GvKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNDowNzoyMFrOF6G_9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ3MjEwNQ==", "bodyText": "do we want one on each invocation that it retries?", "url": "https://github.com/palantir/atlasdb/pull/4658#discussion_r396472105", "createdAt": "2020-03-23T14:00:56Z", "author": {"login": "felixdesouza"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/proxy/AwaitingLeadershipProxy.java", "diffHunk": "@@ -214,7 +218,8 @@ protected Object handleInvocation(Object proxy, Method method, Object[] args) th\n         Object maybeValidDelegate = delegateRef.get();\n \n         ListenableFuture<StillLeadingStatus> leadingFuture =\n-                statusRetrier.execute(() -> leaderElectionService.isStillLeading(leadershipToken));\n+                Tracers.wrapListenableFuture(\"validate-leadership\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c637ccabcf128ca8149a7176eddea495caae9aa1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ3Mjk3NA==", "bodyText": "this would still remain as the overall trace for the validate-leadership portion, but I imagine that each invocation inside statusRetrier should be wrapped in one where it's like validate-leadership attempt 0 etc.", "url": "https://github.com/palantir/atlasdb/pull/4658#discussion_r396472974", "createdAt": "2020-03-23T14:02:18Z", "author": {"login": "felixdesouza"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/proxy/AwaitingLeadershipProxy.java", "diffHunk": "@@ -214,7 +218,8 @@ protected Object handleInvocation(Object proxy, Method method, Object[] args) th\n         Object maybeValidDelegate = delegateRef.get();\n \n         ListenableFuture<StillLeadingStatus> leadingFuture =\n-                statusRetrier.execute(() -> leaderElectionService.isStillLeading(leadershipToken));\n+                Tracers.wrapListenableFuture(\"validate-leadership\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ3MjEwNQ=="}, "originalCommit": {"oid": "c637ccabcf128ca8149a7176eddea495caae9aa1"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ3NDYyMA==", "bodyText": "do you think it's worth doing the golden master thing? my proposal is that it could be, because this codepath is fragile, and we want to make sure that we're not undoing any async work as a result by accident (which is quite hard to test atm). Perhaps we don't need it for this PR, but it's something I've been thinking about with all the partitioning/perf work i.e. how do we avoid regressing things that aren't easily tested?", "url": "https://github.com/palantir/atlasdb/pull/4658#discussion_r396474620", "createdAt": "2020-03-23T14:04:35Z", "author": {"login": "felixdesouza"}, "path": "leader-election-impl/src/test/java/com/palantir/leader/proxy/AwaitingLeadershipProxyTest.java", "diffHunk": "@@ -64,6 +65,9 @@\n \n     @Rule public final ExpectedException expect = ExpectedException.none();\n \n+    @Rule\n+    public final RenderTracingRule rule = new RenderTracingRule();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c637ccabcf128ca8149a7176eddea495caae9aa1"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ3NjQwNw==", "bodyText": "Do we not want to handle the IAE below? not that I think it'll come up that often, I don't think we handled it previously anyway, but seems a bit odd, and it'll come out as a 500 iirc.", "url": "https://github.com/palantir/atlasdb/pull/4658#discussion_r396476407", "createdAt": "2020-03-23T14:07:20Z", "author": {"login": "felixdesouza"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/proxy/AwaitingLeadershipProxy.java", "diffHunk": "@@ -234,14 +239,21 @@ protected Object handleInvocation(Object proxy, Method method, Object[] args) th\n \n         if (!method.getReturnType().equals(ListenableFuture.class)) {\n             Object delegate = AtlasFutures.getUnchecked(delegateFuture);\n-            try {\n+            try (CloseableTracer ignored = CloseableTracer.startSpan(\"execute-on-delegate\")) {\n                 return method.invoke(delegate, args);\n             } catch (InvocationTargetException e) {\n                 throw handleDelegateThrewException(leadershipToken, e);\n             }\n         } else {\n             return FluentFuture.from(delegateFuture)\n-                    .transformAsync(delegate -> (ListenableFuture<Object>) method.invoke(delegate, args),\n+                    .transformAsync(delegate ->\n+                                    Tracers.wrapListenableFuture(\"execute-on-delegate-async\", () -> {\n+                                        try {\n+                                            return (ListenableFuture<Object>) method.invoke(delegate, args);\n+                                        } catch (IllegalAccessException | InvocationTargetException e) {\n+                                            return Futures.immediateFailedFuture(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c637ccabcf128ca8149a7176eddea495caae9aa1"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60cfa5a850b69129dfc71d2011b60b52c55e52c8", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/60cfa5a850b69129dfc71d2011b60b52c55e52c8", "committedDate": "2020-03-23T17:21:44Z", "message": "Trace individual attempts."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a38d8118a2cf90c7bc56846272266a72c28ea1e8", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/a38d8118a2cf90c7bc56846272266a72c28ea1e8", "committedDate": "2020-03-23T17:31:22Z", "message": "baseline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "140677eaeec52c28fce04a0201a9d5b75c5d87ae", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/140677eaeec52c28fce04a0201a9d5b75c5d87ae", "committedDate": "2020-03-24T10:03:48Z", "message": "sad"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b30c9babf11c93ea96de2bdfba31e401ed2fbb89", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/b30c9babf11c93ea96de2bdfba31e401ed2fbb89", "committedDate": "2020-03-24T13:48:08Z", "message": "Test tracing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3f7386bbf32c1b89e18b0bce97f4965febac858", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d3f7386bbf32c1b89e18b0bce97f4965febac858", "committedDate": "2020-03-24T13:49:23Z", "message": "Golden traces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "384dfba64540e2000f8ab6d21ecbf0795c77a197", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/384dfba64540e2000f8ab6d21ecbf0795c77a197", "committedDate": "2020-03-24T14:26:03Z", "message": "Revert \"Golden traces\"\n\nThis reverts commit d3f7386bbf32c1b89e18b0bce97f4965febac858."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f85cdab15a3d6d8196abdfadd7794c48b361d88", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/1f85cdab15a3d6d8196abdfadd7794c48b361d88", "committedDate": "2020-03-24T14:26:09Z", "message": "Revert \"Test tracing\"\n\nThis reverts commit b30c9babf11c93ea96de2bdfba31e401ed2fbb89."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fd6cd7ebe8fd22858e7d14122971df647725d59", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/3fd6cd7ebe8fd22858e7d14122971df647725d59", "committedDate": "2020-03-24T14:26:15Z", "message": "Revert \"sad\"\n\nThis reverts commit 140677eaeec52c28fce04a0201a9d5b75c5d87ae."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNTIxOTg4", "url": "https://github.com/palantir/atlasdb/pull/4658#pullrequestreview-380521988", "createdAt": "2020-03-24T17:08:12Z", "commit": {"oid": "3fd6cd7ebe8fd22858e7d14122971df647725d59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2981, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}