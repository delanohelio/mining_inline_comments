{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMDY3ODI5", "number": 4832, "title": "Adjudication 1", "bodyText": "Goals (and why):\nCollect metrics of interest (for TimeLock Adjudication) on AtlasDB using metrics-schema.\nImplementation Description (bullets):\nInstrument leaderTime and startTransactions end points with timer metrics.\nTesting (What was existing testing like?  What have you done to improve it?):\nConcerns (what feedback would you like?):\nWhere should we start reviewing?:\nDialogueAdaptingConjureTimelockService.java\nPriority (whenever / two weeks / yesterday):\nBy end of day", "createdAt": "2020-06-11T13:14:37Z", "url": "https://github.com/palantir/atlasdb/pull/4832", "merged": true, "mergeCommit": {"oid": "eacb64bbcfff353183703a32b7baf9c175bb269c"}, "closed": true, "closedAt": "2020-06-12T12:12:30Z", "author": {"login": "sudiksha27"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqK3qYgH2gAyNDMzMDY3ODI5OjA0OWM4OTMyOGU3NWIyZTE4M2I4MWRlNTFmOTVhYTY3MmU1Yjc4YmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqhncTgH2gAyNDMzMDY3ODI5OjlmMGVlNjEyZjU2NGYxZTQ5ZDhkYTgxOGM2ZWI2ODEwOThmOTYwY2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "049c89328e75b2e183b81de51f95aa672e5b78bf", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/049c89328e75b2e183b81de51f95aa672e5b78bf", "committedDate": "2020-06-11T09:30:45Z", "message": "timeLock metrics | poc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b", "committedDate": "2020-06-11T09:35:54Z", "message": "remove redundant code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4OTExNjQx", "url": "https://github.com/palantir/atlasdb/pull/4832#pullrequestreview-428911641", "createdAt": "2020-06-11T13:31:00Z", "commit": {"oid": "62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzozMTowMFrOGidHlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMVQxMzozNTowOFrOGidWnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4MTg0Nw==", "bodyText": "this is the correct place!", "url": "https://github.com/palantir/atlasdb/pull/4832#discussion_r438781847", "createdAt": "2020-06-11T13:31:00Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/AtlasDbDialogueServiceProvider.java", "diffHunk": "@@ -101,7 +104,8 @@ ConjureTimelockService getConjureTimelockService() {\n                         taggedMetricRegistry,\n                         ConjureTimelockServiceBlocking.class,\n                         service))\n-                .map(DialogueAdaptingConjureTimelockService::new);\n+                .map(instrumentedService -> new DialogueAdaptingConjureTimelockService(instrumentedService,\n+                        conjureTimelockServiceBlockingMetrics));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4MTk4OQ==", "bodyText": "nit: please put this in alphabetical order with the others", "url": "https://github.com/palantir/atlasdb/pull/4832#discussion_r438781989", "createdAt": "2020-06-11T13:31:11Z", "author": {"login": "jeremyk-91"}, "path": "build.gradle", "diffHunk": "@@ -24,6 +24,7 @@ buildscript {\n         classpath 'com.netflix.nebula:nebula-publishing-plugin:17.2.1'\n         classpath 'gradle.plugin.com.hierynomus.gradle.plugins:license-gradle-plugin:0.15.0'\n         classpath 'gradle.plugin.org.inferred:gradle-processors:3.3.0'\n+        classpath 'com.palantir.metricschema:gradle-metric-schema:0.5.5'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4MjE4Nw==", "bodyText": "Should we also instrument leaderTime?", "url": "https://github.com/palantir/atlasdb/pull/4832#discussion_r438782187", "createdAt": "2020-06-11T13:31:27Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/client/DialogueAdaptingConjureTimelockService.java", "diffHunk": "@@ -36,15 +39,23 @@\n \n public class DialogueAdaptingConjureTimelockService implements ConjureTimelockService {\n     private final ConjureTimelockServiceBlocking dialogueDelegate;\n+    private final ConjureTimelockServiceBlockingMetrics conjureTimelockServiceBlockingMetrics;\n \n-    public DialogueAdaptingConjureTimelockService(ConjureTimelockServiceBlocking dialogueDelegate) {\n+    public DialogueAdaptingConjureTimelockService(ConjureTimelockServiceBlocking dialogueDelegate,\n+            ConjureTimelockServiceBlockingMetrics conjureTimelockServiceBlockingMetrics) {\n         this.dialogueDelegate = dialogueDelegate;\n+        this.conjureTimelockServiceBlockingMetrics = conjureTimelockServiceBlockingMetrics;\n     }\n \n     @Override\n     public ConjureStartTransactionsResponse startTransactions(AuthHeader authHeader, String namespace,\n             ConjureStartTransactionsRequest request) {\n-        return dialogueDelegate.startTransactions(authHeader, namespace, request);\n+        long timeCreated = System.currentTimeMillis();\n+        ConjureStartTransactionsResponse response = dialogueDelegate.startTransactions(authHeader, namespace, request);\n+        long microsSinceCreation = TimeUnit.MILLISECONDS.toMicros(System.currentTimeMillis() - timeCreated);\n+        this.conjureTimelockServiceBlockingMetrics.startTransactions().update(microsSinceCreation,\n+                TimeUnit.MICROSECONDS);\n+        return response;\n     }\n \n     @Override", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4MjUxMA==", "bodyText": "What happens if a request takes 3.7 ms?\nI'd suggest we use Instant.now() instead \ud83d\ude04", "url": "https://github.com/palantir/atlasdb/pull/4832#discussion_r438782510", "createdAt": "2020-06-11T13:31:48Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/client/DialogueAdaptingConjureTimelockService.java", "diffHunk": "@@ -36,15 +39,23 @@\n \n public class DialogueAdaptingConjureTimelockService implements ConjureTimelockService {\n     private final ConjureTimelockServiceBlocking dialogueDelegate;\n+    private final ConjureTimelockServiceBlockingMetrics conjureTimelockServiceBlockingMetrics;\n \n-    public DialogueAdaptingConjureTimelockService(ConjureTimelockServiceBlocking dialogueDelegate) {\n+    public DialogueAdaptingConjureTimelockService(ConjureTimelockServiceBlocking dialogueDelegate,\n+            ConjureTimelockServiceBlockingMetrics conjureTimelockServiceBlockingMetrics) {\n         this.dialogueDelegate = dialogueDelegate;\n+        this.conjureTimelockServiceBlockingMetrics = conjureTimelockServiceBlockingMetrics;\n     }\n \n     @Override\n     public ConjureStartTransactionsResponse startTransactions(AuthHeader authHeader, String namespace,\n             ConjureStartTransactionsRequest request) {\n-        return dialogueDelegate.startTransactions(authHeader, namespace, request);\n+        long timeCreated = System.currentTimeMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4NDc2MQ==", "bodyText": "nit: I'd just use com.palantir.lock.client since that's where the ConjureTimelockServiceBlocking exists", "url": "https://github.com/palantir/atlasdb/pull/4832#discussion_r438784761", "createdAt": "2020-06-11T13:34:10Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/metrics/metric-schema.yml", "diffHunk": "@@ -0,0 +1,13 @@\n+options:\n+  javaPackage: 'com.palantir.atlasdb.timelock.api'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODc4NTY5NQ==", "bodyText": "The fact that this logs a p99 and rate is encoded in the information that we have a timer. I think it's enough to say \"how long it takes to get leaderTime from timelock\" or something", "url": "https://github.com/palantir/atlasdb/pull/4832#discussion_r438785695", "createdAt": "2020-06-11T13:35:08Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/metrics/metric-schema.yml", "diffHunk": "@@ -0,0 +1,13 @@\n+options:\n+  javaPackage: 'com.palantir.atlasdb.timelock.api'\n+\n+namespaces:\n+  conjureTimelockServiceBlocking:\n+    docs: Metrics helpful for timeLock adjudication.\n+    metrics:\n+      leaderTime:\n+        type: timer\n+        docs: p99 and rate for leaderTime endpoint on timeLock", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62fe414c3a84bbe7fe42f0b2e6925ac89ddb3a3b"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2787894c74f6ed9589dc81a5b18b5a7c1914ca1", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/e2787894c74f6ed9589dc81a5b18b5a7c1914ca1", "committedDate": "2020-06-11T22:17:34Z", "message": "Address comments - 1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8baa4219e9ac82c2a7687811242b6ed4b9fa4509", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/8baa4219e9ac82c2a7687811242b6ed4b9fa4509", "committedDate": "2020-06-11T22:29:32Z", "message": "try with resource"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0425a30e76fb9453110f824f84e43886e078c36b", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/0425a30e76fb9453110f824f84e43886e078c36b", "committedDate": "2020-06-11T22:28:40Z", "message": "refactor"}, "afterCommit": {"oid": "8baa4219e9ac82c2a7687811242b6ed4b9fa4509", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/8baa4219e9ac82c2a7687811242b6ed4b9fa4509", "committedDate": "2020-06-11T22:29:32Z", "message": "try with resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a312af1bc14de5a668ec806c4747b565d6874a75", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/a312af1bc14de5a668ec806c4747b565d6874a75", "committedDate": "2020-06-11T22:31:49Z", "message": "remove redundant imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2a89cf798e3ba2453cc7b38266e218ec47c78ac", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/e2a89cf798e3ba2453cc7b38266e218ec47c78ac", "committedDate": "2020-06-11T22:35:46Z", "message": "refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "627106fec6f5fc34e3686c5b704798d6528fb1dd", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/627106fec6f5fc34e3686c5b704798d6528fb1dd", "committedDate": "2020-06-12T09:11:58Z", "message": "Merge branch 'develop' into adjudication_1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e747b93cbad3185054f09370e3d1ff81a2b94215", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/e747b93cbad3185054f09370e3d1ff81a2b94215", "committedDate": "2020-06-12T09:11:58Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47963d67251084a493ff4d7a1b68e1f8caa93708", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/47963d67251084a493ff4d7a1b68e1f8caa93708", "committedDate": "2020-06-12T10:34:49Z", "message": "liscence config update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b69f13eb3be18bb3ef2f465501503759f0ebda11", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/b69f13eb3be18bb3ef2f465501503759f0ebda11", "committedDate": "2020-06-12T10:35:01Z", "message": "Merge branch 'adjudication_1' of github.com:palantir/atlasdb into adjudication_1"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5NjI3ODcy", "url": "https://github.com/palantir/atlasdb/pull/4832#pullrequestreview-429627872", "createdAt": "2020-06-12T10:19:54Z", "commit": {"oid": "e747b93cbad3185054f09370e3d1ff81a2b94215"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxMDoxOTo1NVrOGi-2mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxMDoxOTo1NVrOGi-2mA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTMzNDU1Mg==", "bodyText": "nit: We don't normally use this when referring to fields (outside of assigning them in a constructor, or if they are needed e.g. when referencing things from a parent class outside of an inner class).", "url": "https://github.com/palantir/atlasdb/pull/4832#discussion_r439334552", "createdAt": "2020-06-12T10:19:55Z", "author": {"login": "jeremyk-91"}, "path": "lock-api/src/main/java/com/palantir/lock/client/DialogueAdaptingConjureTimelockService.java", "diffHunk": "@@ -85,4 +90,10 @@ public GetCommitTimestampsResponse getCommitTimestamps(AuthHeader authHeader, St\n             GetCommitTimestampsRequest request) {\n         return dialogueDelegate.getCommitTimestamps(authHeader, namespace, request);\n     }\n+\n+    private <T> T executeInTimerContext(Supplier<T> supplier) {\n+        try (Timer.Context timer = this.conjureTimelockServiceBlockingMetrics.startTransactions().time()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e747b93cbad3185054f09370e3d1ff81a2b94215"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ddc6fc01545ba2cbc536841995815c650e00d34", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/0ddc6fc01545ba2cbc536841995815c650e00d34", "committedDate": "2020-06-12T11:49:03Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f0ee612f564f1e49d8da818c6eb681098f960cd", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/9f0ee612f564f1e49d8da818c6eb681098f960cd", "committedDate": "2020-06-12T12:00:51Z", "message": "build fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2931, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}