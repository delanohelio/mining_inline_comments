{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NDY0MDMz", "number": 4923, "title": "Bg gain leadership", "bodyText": "Goals (and why):\n\nFor B/G upgrade to be effective, node which is on newest version of TimeLock should try to gain leadership\n\nImplementation Description (bullets):\n\n\nLeaderPingResult accommodates response - remote is the leader but on an older version of TimeLock\n\n\nThe local server treats this response as pingReturnedFalse and tries to gain leadership\n\n\nTesting (What was existing testing like?  What have you done to improve it?):\nTests modified\nConcerns (what feedback would you like?):\nShould backoff before gaining leadership reduced for this case to be more aggressive?\nWhere should we start reviewing?:\n\nSingleLeaderPinger\n\nPriority (whenever / two weeks / yesterday):\n\nTomorrow", "createdAt": "2020-07-29T14:07:18Z", "url": "https://github.com/palantir/atlasdb/pull/4923", "merged": true, "mergeCommit": {"oid": "ba941ef222ba0d074421c6fdb5700579da869904"}, "closed": true, "closedAt": "2020-08-11T18:00:50Z", "author": {"login": "sudiksha27"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc58o5CAFqTQ1ODI1ODYzMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc94BmxAFqTQ2NTE0Njk5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4MjU4NjMy", "url": "https://github.com/palantir/atlasdb/pull/4923#pullrequestreview-458258632", "createdAt": "2020-07-30T09:58:44Z", "commit": {"oid": "d606c86831695bfc222f1e08a06fc11128efb281"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMjg4MTI0", "url": "https://github.com/palantir/atlasdb/pull/4923#pullrequestreview-463288124", "createdAt": "2020-08-07T12:55:06Z", "commit": {"oid": "d081b65771e65b169575c37eb4d580599acc3132"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMjo1NTowNlrOG9YwVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMjo1NTowNlrOG9YwVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAyMTkwOA==", "bodyText": "I'd suggest we rate limit the log message to maybe once every 10 or 30 seconds - timelocks otherwise ping each other 10 times per second meaning it'll be really noisy!", "url": "https://github.com/palantir/atlasdb/pull/4923#discussion_r467021908", "createdAt": "2020-08-07T12:55:06Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/LeadershipEvents.java", "diffHunk": "@@ -88,6 +89,13 @@ void proposalFailure(PaxosRoundFailureException paxosException) {\n         leaderElectionServiceMetrics.proposalFailure().mark();\n     }\n \n+    public void leaderOnOlderTimeLockVersion(OrderableSlsVersion version) {\n+        // TODO(snanda): Kill log after few successful runs of blue-green deployment.\n+        leaderLog.info(\"We contacted the leader and it reported that it is on an older version of TimeLock - {}\",\n+                withContextArgs(SafeArg.of(\"version\", version)));\n+        leaderElectionServiceMetrics.leaderOnOlderTimeLockVersion().mark();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d081b65771e65b169575c37eb4d580599acc3132"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzMjkxNjI0", "url": "https://github.com/palantir/atlasdb/pull/4923#pullrequestreview-463291624", "createdAt": "2020-08-07T12:59:56Z", "commit": {"oid": "d081b65771e65b169575c37eb4d580599acc3132"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMjo1OTo1NlrOG9Y6sA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxMzoxMzo1NFrOG9ZXAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAyNDU2MA==", "bodyText": "Do we know what the semantics of having a product dependency on oneself are? (In particular, are we sure this restricts timelock to upgrading to this version only if it is already at least on 0.227.1, which I think is what this relies on?)", "url": "https://github.com/palantir/atlasdb/pull/4923#discussion_r467024560", "createdAt": "2020-08-07T12:59:56Z", "author": {"login": "jeremyk-91"}, "path": "lock-api-objects/build.gradle", "diffHunk": "@@ -27,7 +27,7 @@ recommendedProductDependencies {\n     productDependency {\n         productGroup = 'com.palantir.timelock'\n         productName = 'timelock-server'\n-        minimumVersion = '0.218.0'\n+        minimumVersion = '0.227.1'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d081b65771e65b169575c37eb4d580599acc3132"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAzMTgwOQ==", "bodyText": "I think we might need to use Schema Versions for this and/or have a fallback mechanism that hits pingv1 actually", "url": "https://github.com/palantir/atlasdb/pull/4923#discussion_r467031809", "createdAt": "2020-08-07T13:13:54Z", "author": {"login": "jeremyk-91"}, "path": "lock-api-objects/build.gradle", "diffHunk": "@@ -27,7 +27,7 @@ recommendedProductDependencies {\n     productDependency {\n         productGroup = 'com.palantir.timelock'\n         productName = 'timelock-server'\n-        minimumVersion = '0.218.0'\n+        minimumVersion = '0.227.1'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzAyNDU2MA=="}, "originalCommit": {"oid": "d081b65771e65b169575c37eb4d580599acc3132"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28a519caf85a33e6a432b4c585727f5c778ae0a9", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/28a519caf85a33e6a432b4c585727f5c778ae0a9", "committedDate": "2020-08-10T17:54:09Z", "message": "Merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a193ed18efd35f66881e5cbfe5a1880885ca884b", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/a193ed18efd35f66881e5cbfe5a1880885ca884b", "committedDate": "2020-08-10T17:54:09Z", "message": "Draft | Log when leader is on older version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9f76cbb90175cbcb4892b9129d4009a74596be0", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/c9f76cbb90175cbcb4892b9129d4009a74596be0", "committedDate": "2020-08-10T17:54:09Z", "message": "Old version metric"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5498fab41d7d3d0956fcc1c72670a044fe441331", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/5498fab41d7d3d0956fcc1c72670a044fe441331", "committedDate": "2020-08-10T17:54:09Z", "message": "Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c03dd13dc2455802591e01b3fb5816dc24797904", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/c03dd13dc2455802591e01b3fb5816dc24797904", "committedDate": "2020-08-10T17:54:09Z", "message": "Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9b92ad7cb72bd446deedc9553a352632c605c9e", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/f9b92ad7cb72bd446deedc9553a352632c605c9e", "committedDate": "2020-08-10T17:54:09Z", "message": "Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd6b87bd7e8082ae3d16082de546f2c024bee3ec", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/fd6b87bd7e8082ae3d16082de546f2c024bee3ec", "committedDate": "2020-08-10T17:54:09Z", "message": "TimeLock dependency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46ecc935e804c351a0615e19705fa57e5b309bd4", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/46ecc935e804c351a0615e19705fa57e5b309bd4", "committedDate": "2020-08-10T17:54:09Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb14b1ff38d5c0521d581521826d809eaa2a5ba7", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/bb14b1ff38d5c0521d581521826d809eaa2a5ba7", "committedDate": "2020-08-10T17:54:09Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06922b0ccbdb03f91dd5ecc9efa8217e4a7a784b", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/06922b0ccbdb03f91dd5ecc9efa8217e4a7a784b", "committedDate": "2020-08-10T17:54:09Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b1288b051832d4bf3eb5a4062d07da1103275b9", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/4b1288b051832d4bf3eb5a4062d07da1103275b9", "committedDate": "2020-08-10T17:54:09Z", "message": "Comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a268c5bf293c1c6a5df33db77fea157fa52dcda8", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/a268c5bf293c1c6a5df33db77fea157fa52dcda8", "committedDate": "2020-08-10T17:54:09Z", "message": "Revert \"TimeLock dependency\"\n\nThis reverts commit 8c774fa48e11996c06d126dfaf90e6c9e0b7d4ec."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b70239ca1e73564948061c557289caff61073774", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/b70239ca1e73564948061c557289caff61073774", "committedDate": "2020-08-10T17:54:09Z", "message": "Rate limited logs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf4ac100dfd4c3b6f1117a70d7d4e676a6dec518", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/cf4ac100dfd4c3b6f1117a70d7d4e676a6dec518", "committedDate": "2020-08-10T11:33:46Z", "message": "Rate limited logs"}, "afterCommit": {"oid": "b70239ca1e73564948061c557289caff61073774", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/b70239ca1e73564948061c557289caff61073774", "committedDate": "2020-08-10T17:54:09Z", "message": "Rate limited logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e027d9f78e84cf2dfd7f8afa6f73bb215a1037a7", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/e027d9f78e84cf2dfd7f8afa6f73bb215a1037a7", "committedDate": "2020-08-10T17:54:40Z", "message": "Schema update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0OTIzMDA3", "url": "https://github.com/palantir/atlasdb/pull/4923#pullrequestreview-464923007", "createdAt": "2020-08-11T10:01:37Z", "commit": {"oid": "e027d9f78e84cf2dfd7f8afa6f73bb215a1037a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMDowMTozN1rOG-w-Kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMDowMTozN1rOG-w-Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODQ2NzI0Mg==", "bodyText": "This is not required.", "url": "https://github.com/palantir/atlasdb/pull/4923#discussion_r468467242", "createdAt": "2020-08-11T10:01:37Z", "author": {"login": "jeremyk-91"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java", "diffHunk": "@@ -77,7 +77,7 @@\n @SuppressWarnings(\"checkstyle:FinalClass\") // This is mocked internally\n public class TimeLockAgent {\n     // Schema version from 2 onwards are on SQLite\n-    private static final Long SCHEMA_VERSION = 3L;\n+    private static final Long SCHEMA_VERSION = 4L;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e027d9f78e84cf2dfd7f8afa6f73bb215a1037a7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "474ac93884d76186dbf274548ce1e979c9fd0b60", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/474ac93884d76186dbf274548ce1e979c9fd0b60", "committedDate": "2020-08-11T10:44:20Z", "message": "Revert \"Schema update\"\n\nThis reverts commit e027d9f78e84cf2dfd7f8afa6f73bb215a1037a7."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MTQ2OTk2", "url": "https://github.com/palantir/atlasdb/pull/4923#pullrequestreview-465146996", "createdAt": "2020-08-11T14:51:54Z", "commit": {"oid": "474ac93884d76186dbf274548ce1e979c9fd0b60"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2763, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}