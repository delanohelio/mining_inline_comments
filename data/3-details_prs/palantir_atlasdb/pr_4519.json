{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzODMwNDk0", "number": 4519, "title": "Shorter Nonblocking Calls, Part 2: Configurable Support in Parameters", "bodyText": "Goals (and why):\n\nAllow users to specify whether a proxy should support calls that block on the server (that is, have a long read timeout). This allows for faster failure given some of the awkward remoting issues we've run into.\nNote that this PR does not change anything on the production code paths yet.\n\nImplementation Description (bullets):\n\nInstead of using two constants for (production versions of) ClientOptions, provide a function that converts AuxiliaryRemotingParameters into ClientOptions.\nAdd a shouldSupportBlockingOperations boolean parameter to AuxiliaryRemotingParameters; read timeouts vary depending on whether this is specified.\nThis is true by default, since AtlasDbHttpClients and ServiceCreator are public API and used by other services.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nAdded tests for the new functionality, and regression tests in light of the refactoring\nConcerns (what feedback would you like?):\n\nThe plan is for only the lock service to have this specified. Does this make sense?\n\nWhere should we start reviewing?: ClientOptions.java\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-01-16T20:27:02Z", "url": "https://github.com/palantir/atlasdb/pull/4519", "merged": true, "mergeCommit": {"oid": "812f83e318961318aa24ad0f9a29dc421d8bbe44"}, "closed": true, "closedAt": "2020-01-20T15:56:29Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7CooVgFqTM0NDI3NTc3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8OQfUAFqTM0NTM4Mjk1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0Mjc1Nzc1", "url": "https://github.com/palantir/atlasdb/pull/4519#pullrequestreview-344275775", "createdAt": "2020-01-16T23:07:44Z", "commit": {"oid": "236d0223ad7c917e854526c69884fa6209c65b13"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQyMzowNzo0NFrOFeqYGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQyMzoxOTowNlrOFeqlyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5NTg5Nw==", "bodyText": "\ud83d\udc83", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r367695897", "createdAt": "2020-01-16T23:07:44Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-conjure/src/main/java/com/palantir/atlasdb/http/v2/ClientOptions.java", "diffHunk": "@@ -33,28 +35,21 @@\n \n @Value.Immutable\n public abstract class ClientOptions {\n-    // TODO (jkong): Re-enable client QoS after response body leaks are handled correctly.\n-    // Throws after expected outages of 1/2 * 0.01 * (2^13 - 1) = 40.96 s\n-    public static final ClientOptions DEFAULT_RETRYING = ImmutableClientOptions.builder()\n-            .connectTimeout(Duration.ofSeconds(10))\n-            .readTimeout(Duration.ofSeconds(65))\n-            .backoffSlotSize(Duration.ofMillis(10))\n-            .failedUrlCooldown(Duration.ofMillis(100))\n-            .maxNumRetries(13)\n-            .clientQoS(ClientConfiguration.ClientQoS.DANGEROUS_DISABLE_SYMPATHETIC_CLIENT_QOS)\n-            .build();\n+    private static final Duration CONNECT_TIMEOUT = Duration.ofMillis(500);\n \n-    // TODO (jkong): Re-enable client QoS after response body leaks are handled correctly.\n-    public static final ClientOptions DEFAULT_NO_RETRYING = ImmutableClientOptions.builder()\n-            .connectTimeout(Duration.ofSeconds(10))\n-            .readTimeout(Duration.ofSeconds(65))\n-            .backoffSlotSize(Duration.ofMillis(100))\n-            .failedUrlCooldown(Duration.ofMillis(1))\n-            .maxNumRetries(0)\n-            .clientQoS(ClientConfiguration.ClientQoS.DANGEROUS_DISABLE_SYMPATHETIC_CLIENT_QOS)\n-            .build();\n+    @VisibleForTesting\n+    static final Duration NON_BLOCKING_READ_TIMEOUT = Duration.ofMillis(12566); // Odd number for debugging", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "236d0223ad7c917e854526c69884fa6209c65b13"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5Nzc4Ng==", "bodyText": "this test is kinda weird, there's no notion of default AuxiliaryRemotingParameters", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r367697786", "createdAt": "2020-01-16T23:14:15Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-conjure/src/test/java/com/palantir/atlasdb/http/v2/ClientOptionsTest.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.http.v2;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.time.Duration;\n+\n+import org.junit.Test;\n+\n+import com.palantir.atlasdb.config.AuxiliaryRemotingParameters;\n+import com.palantir.conjure.java.api.config.service.UserAgent;\n+import com.palantir.conjure.java.client.config.ClientConfiguration;\n+\n+public class ClientOptionsTest {\n+    private static final UserAgent USER_AGENT = UserAgent.of(UserAgent.Agent.of(\"tom\", \"1.2.3\"));\n+\n+    // Throws after expected outages of 1/2 * 0.01 * (2^13 - 1) = 40.96 s\n+    private static final ClientOptions DEFAULT_RETRYING = ImmutableClientOptions.builder()\n+            .connectTimeout(Duration.ofMillis(500))\n+            .readTimeout(Duration.ofSeconds(65))\n+            .backoffSlotSize(Duration.ofMillis(10))\n+            .failedUrlCooldown(Duration.ofMillis(100))\n+            .maxNumRetries(13)\n+            .clientQoS(ClientConfiguration.ClientQoS.DANGEROUS_DISABLE_SYMPATHETIC_CLIENT_QOS)\n+            .build();\n+\n+    private static final ClientOptions DEFAULT_NO_RETRYING = ImmutableClientOptions.builder()\n+            .connectTimeout(Duration.ofMillis(500))\n+            .readTimeout(Duration.ofSeconds(65))\n+            .backoffSlotSize(Duration.ofMillis(10))\n+            .failedUrlCooldown(Duration.ofMillis(1))\n+            .maxNumRetries(0)\n+            .clientQoS(ClientConfiguration.ClientQoS.DANGEROUS_DISABLE_SYMPATHETIC_CLIENT_QOS)\n+            .build();\n+\n+    @Test\n+    public void proxyShouldSupportBlockingReadTimeoutIfUnspecified() {\n+        ClientOptions clientOptions = ClientOptions.fromRemotingParameters(AuxiliaryRemotingParameters.builder()\n+                .shouldLimitPayload(true)\n+                .shouldRetry(true)\n+                .userAgent(USER_AGENT)\n+                .build());\n+\n+        assertThat(clientOptions.readTimeout()).isEqualTo(ClientOptions.BLOCKING_READ_TIMEOUT);\n+    }\n+\n+    @Test\n+    public void proxyShouldSupportBlockingReadTimeoutIfExplicitlyConfigured() {\n+        ClientOptions clientOptions = ClientOptions.fromRemotingParameters(AuxiliaryRemotingParameters.builder()\n+                .shouldLimitPayload(true)\n+                .shouldRetry(true)\n+                .shouldSupportBlockingOperations(true)\n+                .userAgent(USER_AGENT)\n+                .build());\n+\n+        assertThat(clientOptions.readTimeout()).isEqualTo(ClientOptions.BLOCKING_READ_TIMEOUT);\n+    }\n+\n+    @Test\n+    public void proxyShouldSupportNonBlockingReadTimeoutIfExplicitlyConfigured() {\n+        ClientOptions clientOptions = ClientOptions.fromRemotingParameters(AuxiliaryRemotingParameters.builder()\n+                .shouldLimitPayload(true)\n+                .shouldRetry(true)\n+                .shouldSupportBlockingOperations(false)\n+                .userAgent(USER_AGENT)\n+                .build());\n+\n+        assertThat(clientOptions.readTimeout()).isEqualTo(ClientOptions.NON_BLOCKING_READ_TIMEOUT);\n+    }\n+\n+    @Test\n+    public void defaultRetryingOptionsShouldMatchLegacyBehaviour() {\n+        ClientOptions clientOptions = ClientOptions.fromRemotingParameters(AuxiliaryRemotingParameters.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "236d0223ad7c917e854526c69884fa6209c65b13"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5ODk5OQ==", "bodyText": "I suppose for the lock service, it's only the lock endpoint that you want to be able to block no?\nYou could create an impl of the lock service which uses the \"supports blocking operations\" for the lock method, and then the standard for everything else.", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r367698999", "createdAt": "2020-01-16T23:17:46Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-remoting-api/src/main/java/com/palantir/atlasdb/config/AuxiliaryRemotingParameters.java", "diffHunk": "@@ -37,6 +37,17 @@\n      */\n     boolean shouldRetry();\n \n+    /**\n+     * Whether this client should support operations that block on the server side.\n+     * In practice, this means that read and idle connection timeouts may be longer.\n+     *\n+     * This is set to true by default, to support legacy behaviour.\n+     */\n+    @Value.Default\n+    default boolean shouldSupportBlockingOperations() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "236d0223ad7c917e854526c69884fa6209c65b13"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzY5OTQwMQ==", "bodyText": "some docs would be good, to describe what the effect each combination will have, so we don't have to do the same exercise we did today, or even if we do, it's a lot easier.\neither here or the constants above.", "url": "https://github.com/palantir/atlasdb/pull/4519#discussion_r367699401", "createdAt": "2020-01-16T23:19:06Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-conjure/src/main/java/com/palantir/atlasdb/http/v2/ClientOptions.java", "diffHunk": "@@ -129,4 +124,27 @@ public static ClientOptions of(Duration connect, Duration read, Duration backoff\n                 .maxNumRetries(retries)\n                 .build();\n     }\n+\n+    static ClientOptions fromRemotingParameters(AuxiliaryRemotingParameters parameters) {\n+        ImmutableClientOptions.Builder builder = ImmutableClientOptions.builder();\n+\n+        setupTimeouts(builder, parameters);\n+        setupRetrying(builder, parameters);\n+\n+        return builder.clientQoS(ClientConfiguration.ClientQoS.DANGEROUS_DISABLE_SYMPATHETIC_CLIENT_QOS)\n+                .build();\n+    }\n+\n+    private static void setupTimeouts(ImmutableClientOptions.Builder builder, AuxiliaryRemotingParameters parameters) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "236d0223ad7c917e854526c69884fa6209c65b13"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dd1d733c7991c02c88083074f3e3c8a14e189ba", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/4dd1d733c7991c02c88083074f3e3c8a14e189ba", "committedDate": "2020-01-20T10:13:57Z", "message": "Refactor ClientOptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afddbeb20f41135d166d363d0f22dc3220b8c8a1", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/afddbeb20f41135d166d363d0f22dc3220b8c8a1", "committedDate": "2020-01-20T10:13:57Z", "message": "Master key"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7865aad057b46d9cd3f8ca9f1650a42fe256b6a9", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/7865aad057b46d9cd3f8ca9f1650a42fe256b6a9", "committedDate": "2020-01-20T10:13:57Z", "message": "Checkstyle and test artifacts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "514c38b6bcb65487fb0d20e6d3a73197b08982d2", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/514c38b6bcb65487fb0d20e6d3a73197b08982d2", "committedDate": "2020-01-20T10:13:57Z", "message": "AtomicLong"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d34fd4d78c39fa9638610d3e8524ed9fc0f5025", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/3d34fd4d78c39fa9638610d3e8524ed9fc0f5025", "committedDate": "2020-01-20T10:13:57Z", "message": "More unusedness"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a68ed7b674cfb89b1a0a13a2ac5ae98df110f0e", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/5a68ed7b674cfb89b1a0a13a2ac5ae98df110f0e", "committedDate": "2020-01-20T10:13:57Z", "message": "Changelog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "236d0223ad7c917e854526c69884fa6209c65b13", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/236d0223ad7c917e854526c69884fa6209c65b13", "committedDate": "2020-01-16T20:31:38Z", "message": "Changelog"}, "afterCommit": {"oid": "5a68ed7b674cfb89b1a0a13a2ac5ae98df110f0e", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/5a68ed7b674cfb89b1a0a13a2ac5ae98df110f0e", "committedDate": "2020-01-20T10:13:57Z", "message": "Changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1a496aab4727881f670c825d109be02a58ab8fe", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/a1a496aab4727881f670c825d109be02a58ab8fe", "committedDate": "2020-01-20T10:58:31Z", "message": "PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eca253a7aba241fc15309cc5ef0ec43150a9da60", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/eca253a7aba241fc15309cc5ef0ec43150a9da60", "committedDate": "2020-01-20T15:26:18Z", "message": "move comments to constant"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MzgyOTU2", "url": "https://github.com/palantir/atlasdb/pull/4519#pullrequestreview-345382956", "createdAt": "2020-01-20T15:27:04Z", "commit": {"oid": "a1a496aab4727881f670c825d109be02a58ab8fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2391, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}