{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NzYzMzE1", "number": 4812, "title": "[Dialogue] Part 11: Lock V1 Client Uses >99% Pure Dialogue", "bodyText": "Note to the reviewer: This PR unfortunately depends on both Part 8 and Part 9 which were separate branches off develop. If you're @gmaretic, though, you've already reviewed both parts so just ignore the Part 9 bits \ud83d\ude04\nGoals (and why):\n\nV1 lock is still about 20% of RPCs AtlasDB makes to TimeLock, >99% is 3 endpoints\nV1 lock has an expansive API, I don't want to provide bridges for ALL endpoints.\nPrevious parts implement timelock side support, this adds client support.\n\nImplementation Description (bullets):\n\nClient side impl of pure Dialogue for the relevant lock endpoints.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nI changed the ETE resource so it uses the pure Dialogue endpoints to talk to the lock service.\n\nConcerns (what feedback would you like?):\n\nThe zipWith API is maybe too clever?\n\nWhere should we start reviewing?: AtlasDbDialogueServiceProvider.java\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-05-28T22:12:29Z", "url": "https://github.com/palantir/atlasdb/pull/4812", "merged": true, "mergeCommit": {"oid": "9be7acb93aafa5641e1acbd6191e3a4f4fff24c1"}, "closed": true, "closedAt": "2020-06-08T12:45:11Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABci5-7lAH2gAyNDI0NzYzMzE1OmY4NGMwOGMxODhjNDRjMmRiNWZjMDA1YjI5NmJjMjg5MmExYTZiNDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn6sD-gH2gAyNDI0NzYzMzE1OjhlNzc2ODUwMDk5MTRmYWJhNzQ2N2E4NzJmMjJhMjAyYjJmOTcxOTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f84c08c188c44c2db5fc005b296bc2892a1a6b46", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/f84c08c188c44c2db5fc005b296bc2892a1a6b46", "committedDate": "2020-05-19T19:52:50Z", "message": "conjurize lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e45494fd878455b41899709fa63b01ebb5ee09d1", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e45494fd878455b41899709fa63b01ebb5ee09d1", "committedDate": "2020-05-19T21:04:33Z", "message": "Gradle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00f258242935e25093bbf7838f58651030142a8d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/00f258242935e25093bbf7838f58651030142a8d", "committedDate": "2020-05-19T21:04:42Z", "message": "New resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca1b12ebadb49c303fccb7036ee0c83fb11b7642", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/ca1b12ebadb49c303fccb7036ee0c83fb11b7642", "committedDate": "2020-05-19T21:05:08Z", "message": "Git out of here"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8811b164db51e0e1325e618c2477d45487231fd", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d8811b164db51e0e1325e618c2477d45487231fd", "committedDate": "2020-05-19T21:28:20Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e97410458a4379482f6f46325cc4f309f89e9425", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e97410458a4379482f6f46325cc4f309f89e9425", "committedDate": "2020-05-19T21:43:14Z", "message": "JAXRS is tough"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78ecc2642c7b94a0b0bb2a845a311456bfad8111", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/78ecc2642c7b94a0b0bb2a845a311456bfad8111", "committedDate": "2020-05-19T21:43:09Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0260b6e17cda19f2db8ffcb233d32c38a414a694", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/0260b6e17cda19f2db8ffcb233d32c38a414a694", "committedDate": "2020-05-28T20:21:31Z", "message": "CR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "787bd291755f36234e613242d3d96b66ac1f3bad", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/787bd291755f36234e613242d3d96b66ac1f3bad", "committedDate": "2020-05-28T20:22:30Z", "message": "first version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d925155a5e74342414feac73a167a93bb7ad70f", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/7d925155a5e74342414feac73a167a93bb7ad70f", "committedDate": "2020-05-28T20:22:30Z", "message": "Add integ test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e36238684804f4a4282925232546df03130fe319", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e36238684804f4a4282925232546df03130fe319", "committedDate": "2020-05-28T20:22:30Z", "message": "Integ tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d79c275debac8222b64defd2aaa735300fc9e584", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d79c275debac8222b64defd2aaa735300fc9e584", "committedDate": "2020-05-28T20:22:30Z", "message": "simplify and add better test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "813ff4060701c5d7ad4be29e3a3bf202a8351022", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/813ff4060701c5d7ad4be29e3a3bf202a8351022", "committedDate": "2020-05-28T20:24:39Z", "message": "CR: fix misleading line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed687d6242a8f3f3de907eccf52a5ef3a55ced93", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/ed687d6242a8f3f3de907eccf52a5ef3a55ced93", "committedDate": "2020-05-28T20:38:43Z", "message": "[Dialogue] Part 9: Shims for Lesser Used Services: AtlasDB -> TimeLock (#4794)\n\n* Shims\r\n\r\n* Dialogue shim factory\r\n\r\n* More descriptive builders\r\n\r\n* Imports\r\n\r\n* Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82817c00bcfea1932d8f851a81e57702f87132d3", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/82817c00bcfea1932d8f851a81e57702f87132d3", "committedDate": "2020-05-28T20:39:01Z", "message": "Dependency setup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9084f9551dc61620eb83e44de6c3f4a72cb7d7e1", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/9084f9551dc61620eb83e44de6c3f4a72cb7d7e1", "committedDate": "2020-05-28T21:08:34Z", "message": "Dialogue composing client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1374dabd57161e06185e6a11cca534813b7efea8", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/1374dabd57161e06185e6a11cca534813b7efea8", "committedDate": "2020-05-28T21:46:20Z", "message": "Checkstyles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb4617cc89e650cd182db01a8edfbfe130a1456d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/cb4617cc89e650cd182db01a8edfbfe130a1456d", "committedDate": "2020-05-28T21:55:04Z", "message": "Change ETE test to leverage the Dialogue endpoints"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ddc0a0f92ab76bffa66f21627ef9330c6da913e", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/7ddc0a0f92ab76bffa66f21627ef9330c6da913e", "committedDate": "2020-05-28T22:04:51Z", "message": "I actually kind of like this api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa407879a13ceaa71f20da1c358022d4b363180f", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/fa407879a13ceaa71f20da1c358022d4b363180f", "committedDate": "2020-05-28T22:10:23Z", "message": "Tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e441c30681bda636f2e2ca9aea5f1305652c381", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/8e441c30681bda636f2e2ca9aea5f1305652c381", "committedDate": "2020-05-29T07:46:05Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwODUxMTgy", "url": "https://github.com/palantir/atlasdb/pull/4812#pullrequestreview-420851182", "createdAt": "2020-05-29T10:57:01Z", "commit": {"oid": "8e441c30681bda636f2e2ca9aea5f1305652c381"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMDo1NzowMVrOGcYJuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMTowNzozNFrOGcYb0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQwOTAxOQ==", "bodyText": "This is cool, but I'd name it composeWith or combineWith", "url": "https://github.com/palantir/atlasdb/pull/4812#discussion_r432409019", "createdAt": "2020-05-29T10:57:01Z", "author": {"login": "gmaretic"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/AtlasDbDialogueServiceProvider.java", "diffHunk": "@@ -100,6 +108,52 @@ ConjureTimelockService getConjureTimelockService() {\n         return new TimeoutSensitiveConjureTimelockService(shortAndLongTimeoutServices);\n     }\n \n+    TimestampManagementRpcClient getTimestampManagementRpcClient() {\n+        return createDialogueProxyWithShortTimeout(TimestampManagementRpcClient.class);\n+    }\n+\n+    LockRpcClient getLockRpcClient() {\n+        ConjureLockV1ServiceBlocking shortTimeoutDialogueService\n+                = dialogueClientFactory.get(ConjureLockV1ServiceBlocking.class, TIMELOCK_SHORT_TIMEOUT);\n+        ConjureLockV1ServiceBlocking longTimeoutDialogueService\n+                = dialogueClientFactory.get(ConjureLockV1ServiceBlocking.class, TIMELOCK_LONG_TIMEOUT);\n+\n+        ShortAndLongTimeoutServices<LockRpcClient> legacyRpcClients\n+                = ImmutableShortAndLongTimeoutServices.<LockRpcClient>builder()\n+                .shortTimeout(createDialogueProxyWithShortTimeout(LockRpcClient.class))\n+                .longTimeout(createDialogueProxyWithLongTimeout(LockRpcClient.class))\n+                .build();\n+\n+        return new TimeoutSensitiveLockRpcClient(\n+                ImmutableShortAndLongTimeoutServices.<ConjureLockV1ServiceBlocking>builder()\n+                        .shortTimeout(shortTimeoutDialogueService)\n+                        .longTimeout(longTimeoutDialogueService)\n+                        .build()\n+                        .map(proxy -> FastFailoverProxy.newProxyInstance(\n+                                ConjureLockV1ServiceBlocking.class, () -> proxy))\n+                        .map(service -> AtlasDbMetrics.instrumentWithTaggedMetrics(\n+                                taggedMetricRegistry,\n+                                ConjureLockV1ServiceBlocking.class,\n+                                service))\n+                        .zipWith(legacyRpcClients, DialogueComposingLockRpcClient::new));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e441c30681bda636f2e2ca9aea5f1305652c381"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQxMTIzMg==", "bodyText": "\ud83c\udf89", "url": "https://github.com/palantir/atlasdb/pull/4812#discussion_r432411232", "createdAt": "2020-05-29T11:01:54Z", "author": {"login": "gmaretic"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/timelock/ShortAndLongTimeoutServicesTest.java", "diffHunk": "@@ -57,4 +58,38 @@ public void mapOperatesOnCorrespondingElements() {\n         assertThat(strings.shortTimeout()).isEqualTo(\"1\");\n         assertThat(strings.longTimeout()).isEqualTo(\"3\");\n     }\n+\n+    @Test\n+    public void zipWithZipsCorrectElements() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e441c30681bda636f2e2ca9aea5f1305652c381"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQxMzY0OA==", "bodyText": "This is a behaviour change, but it should be fine for existing tests. I guess this was done to reuse existing tests to test the pure dialogue methods?", "url": "https://github.com/palantir/atlasdb/pull/4812#discussion_r432413648", "createdAt": "2020-05-29T11:07:34Z", "author": {"login": "gmaretic"}, "path": "atlasdb-ete-tests/src/main/java/com/palantir/atlasdb/lock/SimpleLockResource.java", "diffHunk": "@@ -60,9 +61,9 @@ public boolean lockUsingLegacyLockApi(int numLocks, int descriptorSize) {\n                 .builder(generateDescriptorMap(numLocks, descriptorSize))\n                 .build();\n         try {\n-            LockRefreshToken response = transactionManager.getLockService().lock(\"test\", request);\n+            HeldLocksToken response = transactionManager.getLockService().lockAndGetHeldLocks(\"test\", request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e441c30681bda636f2e2ca9aea5f1305652c381"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9127a553684baf845865dbb51d2fe97ea41991b", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/f9127a553684baf845865dbb51d2fe97ea41991b", "committedDate": "2020-06-04T09:21:10Z", "message": "Merge branch 'develop' into jkong/pure-dialogue-lock-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e77685009914faba7467a872f22a202b2f97198", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/8e77685009914faba7467a872f22a202b2f97198", "committedDate": "2020-06-04T09:31:45Z", "message": "Fix bad merge"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2909, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}