{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMzE2MTMz", "number": 4877, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMzozMToyMVrOEKgxkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNTozNToyOVrOEK80ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NDU4MTkzOnYy", "diffSide": "LEFT", "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/async/DefaultCassandraAsyncKeyValueServiceFactory.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxMzozMToyMVrOGrmBOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNToxMjowNVrOGsRPJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM2NDg1OA==", "bodyText": "This executor configuration is highly suspect. At a glance I believe it will only ever have a single thread unless we manage to fill the LinkedBlockingQueue with Integer.MAX_VALUE elements.", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r448364858", "createdAt": "2020-07-01T13:31:21Z", "author": {"login": "carterkozak"}, "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/async/DefaultCassandraAsyncKeyValueServiceFactory.java", "diffHunk": "@@ -88,10 +85,7 @@ public ExecutorService visit(CqlCapableConfig cqlCapableConfig) {\n      * @return a new dynamic thread pool with a thread keep alive time of 1 minute\n      */\n     private static ExecutorService createThreadPool(int maxPoolSize) {\n-        LinkedBlockingQueue<Runnable> workQueue = new LinkedBlockingQueue<>();\n-        NamedThreadFactory threadFactory = new NamedThreadFactory(\"Atlas Cassandra Async KVS\", false);\n-\n-        return PTExecutors.newThreadPoolExecutor(0, maxPoolSize, 1, TimeUnit.MINUTES, workQueue, threadFactory);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78c8ead4ec6569a2f30e82d8e1f2688fc0d39a62"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3MjkzNA==", "bodyText": "We looked at metrics-platform and it turns out this executor is basically unused in practice...", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r449072934", "createdAt": "2020-07-02T15:12:05Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/async/DefaultCassandraAsyncKeyValueServiceFactory.java", "diffHunk": "@@ -88,10 +85,7 @@ public ExecutorService visit(CqlCapableConfig cqlCapableConfig) {\n      * @return a new dynamic thread pool with a thread keep alive time of 1 minute\n      */\n     private static ExecutorService createThreadPool(int maxPoolSize) {\n-        LinkedBlockingQueue<Runnable> workQueue = new LinkedBlockingQueue<>();\n-        NamedThreadFactory threadFactory = new NamedThreadFactory(\"Atlas Cassandra Async KVS\", false);\n-\n-        return PTExecutors.newThreadPoolExecutor(0, maxPoolSize, 1, TimeUnit.MINUTES, workQueue, threadFactory);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODM2NDg1OA=="}, "originalCommit": {"oid": "78c8ead4ec6569a2f30e82d8e1f2688fc0d39a62"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5OTA5MTM0OnYy", "diffSide": "RIGHT", "path": "changelog/@unreleased/pr-4877.v2.yml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNToyMDo0NFrOGsRlYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNjoyNzoyMlrOGsU_1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3ODYyNQ==", "bodyText": "note: will cause breaks in large internal product. Can confirm not used by the common AtlasDB supporting libraries.", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r449078625", "createdAt": "2020-07-02T15:20:44Z", "author": {"login": "jeremyk-91"}, "path": "changelog/@unreleased/pr-4877.v2.yml", "diffHunk": "@@ -0,0 +1,14 @@\n+changes:\n+  - type: improvement\n+    improvement:\n+      description: |-\n+        PTExecutors simple cached and fixed executor factories (those which don't consume a ThreadFactory) use views\n+        over a shared executor service to reduce total thread count and promote resource reuse.\n+      links:\n+      - https://github.com/palantir/atlasdb/pull/4877\n+  - type: break\n+    break:\n+      description: |-\n+        `PTExecutors.newFixedThreadPool` overloads return `ExecutorService` instead of the concrete `ThreadPoolExecutor` type.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e42db57fbd49bffcf1d731bfa3ef16c02d8357b"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEzNDU0OA==", "bodyText": "I'm planning to fix the internal product once this is available.", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r449134548", "createdAt": "2020-07-02T16:27:22Z", "author": {"login": "carterkozak"}, "path": "changelog/@unreleased/pr-4877.v2.yml", "diffHunk": "@@ -0,0 +1,14 @@\n+changes:\n+  - type: improvement\n+    improvement:\n+      description: |-\n+        PTExecutors simple cached and fixed executor factories (those which don't consume a ThreadFactory) use views\n+        over a shared executor service to reduce total thread count and promote resource reuse.\n+      links:\n+      - https://github.com/palantir/atlasdb/pull/4877\n+  - type: break\n+    break:\n+      description: |-\n+        `PTExecutors.newFixedThreadPool` overloads return `ExecutorService` instead of the concrete `ThreadPoolExecutor` type.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3ODYyNQ=="}, "originalCommit": {"oid": "8e42db57fbd49bffcf1d731bfa3ef16c02d8357b"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5OTE3MzExOnYy", "diffSide": "RIGHT", "path": "commons-executors/src/main/java/com/palantir/common/concurrent/AtlasQueuedViewExecutor.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNTozNDo1MVrOGsScyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNjoyNjo1NVrOGsU-wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA5MjgxMQ==", "bodyText": "This PR merged, though I wouldn't block on us using the alternative there. I checked for equivalence - it seems we have a bit more interrupt handling logic here.", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r449092811", "createdAt": "2020-07-02T15:34:51Z", "author": {"login": "jeremyk-91"}, "path": "commons-executors/src/main/java/com/palantir/common/concurrent/AtlasQueuedViewExecutor.java", "diffHunk": "@@ -0,0 +1,335 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ */\n+\n+package com.palantir.common.concurrent;\n+\n+import java.util.ArrayDeque;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.locks.Condition;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Borrowed from jboss-threads. http://www.apache.org/licenses/LICENSE-2.0\n+ * https://github.com/jbossas/jboss-threads/blob/master/src/main/java/org/jboss/threads/QueuedViewExecutor.java Changes\n+ * have been contributed and merged, this may be replaced by the upstream ViewExecutor pending a release including\n+ * https://github.com/jbossas/jboss-threads/pull/85.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e42db57fbd49bffcf1d731bfa3ef16c02d8357b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEzNDI3Mg==", "bodyText": "pull/86 hasn't merged quite yet, but it's much less substantial than the others. Folks on their end are busy.", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r449134272", "createdAt": "2020-07-02T16:26:55Z", "author": {"login": "carterkozak"}, "path": "commons-executors/src/main/java/com/palantir/common/concurrent/AtlasQueuedViewExecutor.java", "diffHunk": "@@ -0,0 +1,335 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ */\n+\n+package com.palantir.common.concurrent;\n+\n+import java.util.ArrayDeque;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.ConcurrentHashMap;\n+import java.util.concurrent.Executor;\n+import java.util.concurrent.RejectedExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.locks.Condition;\n+import java.util.concurrent.locks.Lock;\n+import java.util.concurrent.locks.ReentrantLock;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Borrowed from jboss-threads. http://www.apache.org/licenses/LICENSE-2.0\n+ * https://github.com/jbossas/jboss-threads/blob/master/src/main/java/org/jboss/threads/QueuedViewExecutor.java Changes\n+ * have been contributed and merged, this may be replaced by the upstream ViewExecutor pending a release including\n+ * https://github.com/jbossas/jboss-threads/pull/85.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA5MjgxMQ=="}, "originalCommit": {"oid": "8e42db57fbd49bffcf1d731bfa3ef16c02d8357b"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5OTE3NzU0OnYy", "diffSide": "RIGHT", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/Leaders.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNTozNToyOVrOGsSfuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNjoyNDo1N1rOGsU6RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA5MzU2Mw==", "bodyText": "nit: this is private so we could probably remove the unused corepoolsize parameter.", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r449093563", "createdAt": "2020-07-02T15:35:29Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/Leaders.java", "diffHunk": "@@ -239,20 +232,7 @@ public static LocalPaxosServices createInstrumentedLocalServices(\n     // TODO (jkong): Make the limits configurable.\n     // Current use cases tend to have not more than 10 (<< 100) inflight tasks under normal circumstances.\n     private static ExecutorService createExecutor(MetricsManager metricsManager, String useCase, int corePoolSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e42db57fbd49bffcf1d731bfa3ef16c02d8357b"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTEzMzEyNQ==", "bodyText": "iirc it's passed through several methods and I wanted to keep the code churn to a minimum.", "url": "https://github.com/palantir/atlasdb/pull/4877#discussion_r449133125", "createdAt": "2020-07-02T16:24:57Z", "author": {"login": "carterkozak"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/Leaders.java", "diffHunk": "@@ -239,20 +232,7 @@ public static LocalPaxosServices createInstrumentedLocalServices(\n     // TODO (jkong): Make the limits configurable.\n     // Current use cases tend to have not more than 10 (<< 100) inflight tasks under normal circumstances.\n     private static ExecutorService createExecutor(MetricsManager metricsManager, String useCase, int corePoolSize) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA5MzU2Mw=="}, "originalCommit": {"oid": "8e42db57fbd49bffcf1d731bfa3ef16c02d8357b"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2702, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}