{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MTQwNzQ1", "number": 4809, "title": "[Dialogue] Part 10: :hot_pepper: TimeLock Internode by Shim", "bodyText": "This is a little bit beyond the scope of what we planned internally, but it wasn't very hard and should give us a decent perf win, so why not?\nDO NOT MERGE until the existing pains we have around remoting are resolved please - we don't need to introduce yet another variable to the mix. Said ticket has been resolved! (mostly, at least we're unblocked from Atlas upgrades?)\nGoals (and why):\n\nMove internode TimeLock communications to use Dialogue by shim: we should go down from piles of different clients to just six.\nUnlock the path to pure Dialogue on TimeLock communications (even if that does require jumping through quite a lot more hoops that are not addressed in this PR).\n\nImplementation Description (bullets):\n\nAllow creation of proxies with services of the form timelock-<retry?>-<host>.\nUpdate timelock code paths to use the TimeLockDialogueServiceProvider.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nAll TimeLock integration tests run with Dialogue. This isn't configurable, so TimeLock internode communication in all ETE tests that use TimeLock (independent of whether Atlas talks to TimeLock using Dialogue) also uses Dialogue.\nConcerns (what feedback would you like?):\n\nIs this too risky / should this be a config flag? I'd argue this is fine: we're confident in the lib generally speaking, the tests do run with it, and mechanisms exist to kill this if needed.\n\nWhere should we start reviewing?: TimeLockDialogueServiceProvider.java\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-05-27T22:14:50Z", "url": "https://github.com/palantir/atlasdb/pull/4809", "merged": true, "mergeCommit": {"oid": "671ef718aee0779b54df8ec366945da393c2d1ae"}, "closed": true, "closedAt": "2020-06-08T12:37:21Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclgEFNAH2gAyNDI0MTQwNzQ1OmQyODljMTQ0ZGRkYjk1Y2VmZTA1MWRhZDMxOTlhYWJlODdhY2RiMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmAimmAH2gAyNDI0MTQwNzQ1OmIyZWZjNWNlYTQ5MDBjYjdlMGYyOGFkOGE5NDk0NzEyOGExNmJhMjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d289c144dddb95cefe051dad3199aabe87acdb0c", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d289c144dddb95cefe051dad3199aabe87acdb0c", "committedDate": "2020-05-27T21:22:42Z", "message": "TLDSP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d36695203b167eea5cdc6b306f7357236f7673da", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d36695203b167eea5cdc6b306f7357236f7673da", "committedDate": "2020-05-27T21:22:42Z", "message": "checkpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a507b3688b15191f4b0128f4c0ffbeb7f9effef0", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/a507b3688b15191f4b0128f4c0ffbeb7f9effef0", "committedDate": "2020-05-27T22:06:09Z", "message": "Wire it all through"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02661f76c0d2dda8c9be1f5361f11ffd1f362d43", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/02661f76c0d2dda8c9be1f5361f11ffd1f362d43", "committedDate": "2020-05-27T22:06:09Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMTE5MjM5", "url": "https://github.com/palantir/atlasdb/pull/4809#pullrequestreview-420119239", "createdAt": "2020-05-28T13:42:43Z", "commit": {"oid": "a507b3688b15191f4b0128f4c0ffbeb7f9effef0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMzo0Mjo0M1rOGb1qnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMzo0Mjo0M1rOGb1qnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg0Mzk5Ng==", "bodyText": "We could work around this by making it Optional", "url": "https://github.com/palantir/atlasdb/pull/4809#discussion_r431843996", "createdAt": "2020-05-28T13:42:43Z", "author": {"login": "jeremyk-91"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java", "diffHunk": "@@ -117,6 +129,28 @@ public static TimeLockAgent create(\n         return agent;\n     }\n \n+    private static TimeLockDialogueServiceProvider createTimeLockDialogueServiceProvider(\n+            MetricsManager metricsManager, TimeLockInstallConfiguration install, UserAgent userAgent) {\n+        DialogueClients.ReloadingFactory baseFactory = DialogueClients.create(\n+                Refreshable.only(ServicesConfigBlock.builder().build()));\n+        ServerListConfig timeLockServerListConfig = ImmutableServerListConfig.builder()\n+                .addAllServers(PaxosRemotingUtils.getRemoteServerPaths(install))\n+                .sslConfiguration(install.cluster().cluster().security())\n+                .proxyConfiguration(install.cluster().cluster().proxyConfiguration())\n+                .build();\n+        return TimeLockDialogueServiceProvider.create(\n+                metricsManager.getTaggedRegistry(),\n+                baseFactory,\n+                timeLockServerListConfig,\n+                AuxiliaryRemotingParameters.builder()\n+                        .userAgent(userAgent)\n+                        .shouldLimitPayload(false)\n+                        .shouldRetry(false) // Is subsequently overridden.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a507b3688b15191f4b0128f4c0ffbeb7f9effef0"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMjE5ODg4", "url": "https://github.com/palantir/atlasdb/pull/4809#pullrequestreview-420219888", "createdAt": "2020-05-28T15:17:59Z", "commit": {"oid": "a507b3688b15191f4b0128f4c0ffbeb7f9effef0"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNToxNzo1OVrOGb6ObQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNToxODo0NVrOGb6Qcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxODcwMQ==", "bodyText": "nit: extract method", "url": "https://github.com/palantir/atlasdb/pull/4809#discussion_r431918701", "createdAt": "2020-05-28T15:17:59Z", "author": {"login": "gmaretic"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockDialogueServiceProvider.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.timelock.paxos;\n+\n+import java.util.Map;\n+import java.util.stream.Stream;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Maps;\n+import com.palantir.atlasdb.config.AuxiliaryRemotingParameters;\n+import com.palantir.atlasdb.config.ImmutableAuxiliaryRemotingParameters;\n+import com.palantir.atlasdb.config.ImmutableServerListConfig;\n+import com.palantir.atlasdb.config.ServerListConfig;\n+import com.palantir.atlasdb.http.AtlasDbHttpClients;\n+import com.palantir.atlasdb.http.AtlasDbRemotingConstants;\n+import com.palantir.atlasdb.http.v2.DialogueClientOptions;\n+import com.palantir.atlasdb.http.v2.ImmutableRemoteServiceConfiguration;\n+import com.palantir.atlasdb.http.v2.RemoteServiceConfiguration;\n+import com.palantir.common.streams.KeyedStream;\n+import com.palantir.conjure.java.api.config.service.UserAgent;\n+import com.palantir.conjure.java.client.config.ClientConfiguration;\n+import com.palantir.conjure.java.client.config.NodeSelectionStrategy;\n+import com.palantir.dialogue.clients.DialogueClients;\n+import com.palantir.refreshable.Refreshable;\n+import com.palantir.tritium.metrics.registry.TaggedMetricRegistry;\n+\n+public class TimeLockDialogueServiceProvider {\n+    private final DialogueClients.ReloadingFactory reloadingFactory;\n+    private final TaggedMetricRegistry taggedMetricRegistry;\n+\n+    private TimeLockDialogueServiceProvider(\n+            DialogueClients.ReloadingFactory reloadingFactory,\n+            TaggedMetricRegistry taggedMetricRegistry) {\n+        this.reloadingFactory = reloadingFactory;\n+        this.taggedMetricRegistry = taggedMetricRegistry;\n+    }\n+\n+    public static TimeLockDialogueServiceProvider create(\n+            TaggedMetricRegistry taggedMetricRegistry,\n+            DialogueClients.ReloadingFactory baseFactory,\n+            ServerListConfig serverListConfig,\n+            AuxiliaryRemotingParameters parameters) {\n+        UserAgent versionedAgent = parameters.userAgent().addAgent(AtlasDbRemotingConstants.ATLASDB_HTTP_CLIENT_AGENT);\n+        Map<String, RemoteServiceConfiguration> remoteServiceConfigurations\n+                = createRemoteServiceConfigurations(serverListConfig, versionedAgent, parameters);\n+        DialogueClients.ReloadingFactory reloadingFactory\n+                = decorate(baseFactory, Refreshable.only(remoteServiceConfigurations)).withUserAgent(versionedAgent);\n+        return new TimeLockDialogueServiceProvider(reloadingFactory, taggedMetricRegistry);\n+    }\n+\n+    private static Map<String, RemoteServiceConfiguration> createRemoteServiceConfigurations(\n+            ServerListConfig serverListConfig, UserAgent versionedAgent, AuxiliaryRemotingParameters parameters) {\n+        return KeyedStream.of(serverListConfig.servers())\n+                .map(server -> ImmutableServerListConfig.builder()\n+                        .from(serverListConfig)\n+                        .servers(ImmutableList.of(server))\n+                        .build())\n+                .flatMapEntries((uri, singleServerConfig) -> {\n+                    RemoteServiceConfiguration nonRetrying = ImmutableRemoteServiceConfiguration.builder()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a507b3688b15191f4b0128f4c0ffbeb7f9effef0"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxOTIxOQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/palantir/atlasdb/pull/4809#discussion_r431919219", "createdAt": "2020-05-28T15:18:45Z", "author": {"login": "gmaretic"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/TimeLockAgent.java", "diffHunk": "@@ -117,6 +129,28 @@ public static TimeLockAgent create(\n         return agent;\n     }\n \n+    private static TimeLockDialogueServiceProvider createTimeLockDialogueServiceProvider(\n+            MetricsManager metricsManager, TimeLockInstallConfiguration install, UserAgent userAgent) {\n+        DialogueClients.ReloadingFactory baseFactory = DialogueClients.create(\n+                Refreshable.only(ServicesConfigBlock.builder().build()));\n+        ServerListConfig timeLockServerListConfig = ImmutableServerListConfig.builder()\n+                .addAllServers(PaxosRemotingUtils.getRemoteServerPaths(install))\n+                .sslConfiguration(install.cluster().cluster().security())\n+                .proxyConfiguration(install.cluster().cluster().proxyConfiguration())\n+                .build();\n+        return TimeLockDialogueServiceProvider.create(\n+                metricsManager.getTaggedRegistry(),\n+                baseFactory,\n+                timeLockServerListConfig,\n+                AuxiliaryRemotingParameters.builder()\n+                        .userAgent(userAgent)\n+                        .shouldLimitPayload(false)\n+                        .shouldRetry(false) // Is subsequently overridden.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg0Mzk5Ng=="}, "originalCommit": {"oid": "a507b3688b15191f4b0128f4c0ffbeb7f9effef0"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84456b22898c9e1837ede5c7d8d396379dea3f95", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/84456b22898c9e1837ede5c7d8d396379dea3f95", "committedDate": "2020-05-28T19:45:57Z", "message": "Merge branch 'develop' into jkong/dialogue-shims2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c8757ca9ec51e2ba76e11a813c455d4b44054dc", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/1c8757ca9ec51e2ba76e11a813c455d4b44054dc", "committedDate": "2020-05-28T19:47:38Z", "message": "Imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18f876b1d463238e41b6a0d5f6b8431d3d79ab5e", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/18f876b1d463238e41b6a0d5f6b8431d3d79ab5e", "committedDate": "2020-05-28T20:06:48Z", "message": "Optional, and don't set useless ShouldRetry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "184f604661fd77dcb50ebd0f93dd5c9b007141d2", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/184f604661fd77dcb50ebd0f93dd5c9b007141d2", "committedDate": "2020-05-28T20:11:09Z", "message": "Extract method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "715361f29c94a7722af5d4d5e5bcbd15cb964066", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/715361f29c94a7722af5d4d5e5bcbd15cb964066", "committedDate": "2020-05-28T21:41:15Z", "message": "Silly bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5754da2372270bc725daa418e517067abc35243", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e5754da2372270bc725daa418e517067abc35243", "committedDate": "2020-05-29T10:21:49Z", "message": ":Revert \"Silly bugs\"\n\nThis reverts commit 715361f29c94a7722af5d4d5e5bcbd15cb964066."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "caf337d076510dcaf23833e260e554f97329c18e", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/caf337d076510dcaf23833e260e554f97329c18e", "committedDate": "2020-05-29T10:21:59Z", "message": "Revert \"Optional, and don't set useless ShouldRetry\"\n\nThis reverts commit 18f876b1d463238e41b6a0d5f6b8431d3d79ab5e."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c149af399d4c26a6f030e1e85a3dca24172d82a0", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/c149af399d4c26a6f030e1e85a3dca24172d82a0", "committedDate": "2020-05-29T10:41:11Z", "message": "graaaaaargh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3deb99e5c90351178c4068f844f3cf440e9bfc0", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/a3deb99e5c90351178c4068f844f3cf440e9bfc0", "committedDate": "2020-05-29T10:45:19Z", "message": "Revert \":Revert \"Silly bugs\"\"\n\nThis reverts commit e5754da2372270bc725daa418e517067abc35243."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03d01858699ffecb8e412f413809ffe977c73089", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/03d01858699ffecb8e412f413809ffe977c73089", "committedDate": "2020-05-29T10:45:41Z", "message": "Revert \"Revert \"Optional, and don't set useless ShouldRetry\"\"\n\nThis reverts commit caf337d076510dcaf23833e260e554f97329c18e."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2efc5cea4900cb7e0f28ad8a94947128a16ba25", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/b2efc5cea4900cb7e0f28ad8a94947128a16ba25", "committedDate": "2020-05-29T11:13:00Z", "message": "DCO"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2900, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}