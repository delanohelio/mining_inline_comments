{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NjU3MjU5", "number": 4680, "title": "[PDS-114184] Increase transaction read timeout in CLI to 8 hours", "bodyText": "Goals (and why):\nThe validation step of a KVS migration is performed within a single transaction for a given table. For large tables, this step will fail as the transaction will timeout after one hour.\nThe aim here is to improve this by increasing the transaction timeout for the CLI.\nImplementation Description (bullets):\n\nOverrides TransactionReadTimeoutMillis in the AtlasDBConfigs provided to the CLI\n\nTesting (What was existing testing like?  What have you done to improve it?):\nNot tested.\nConcerns (what feedback would you like?):\n\nMy approach is to hard-code the value - may be more desirable to provide the ability to config (but in reality, how often will people configure this?)\nShould there be additional logging to map progress, so that people know the validation step is running successfully (but is just taking a long time)?\n\nWhere should we start reviewing?:\nKvsMigrationCommand\nPriority (whenever / two weeks / yesterday):\nWithin a week.", "createdAt": "2020-03-27T09:58:49Z", "url": "https://github.com/palantir/atlasdb/pull/4680", "merged": true, "mergeCommit": {"oid": "42bb8f8d37e3a05dd9d74de754b600e71ab81072"}, "closed": true, "closedAt": "2020-03-27T13:51:25Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRtag6gH2gAyMzk0NjU3MjU5Ojc1ZWFkM2FlZWJmNDI0OGMwZWFhMDRmYzFhY2VmYjAyOTVlMDQyMGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRw5J8AH2gAyMzk0NjU3MjU5OjliNTk3MDI3Mzg1Y2E4MjFkYTA2MmVjNzgwYjFlMDRmOTRmZjg1Yjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "75ead3aeebf4248c0eaa04fc1acefb0295e0420b", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/75ead3aeebf4248c0eaa04fc1acefb0295e0420b", "committedDate": "2020-03-27T09:37:29Z", "message": "override transaction timeout millis in CLI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "718de56a0aca7a947dd303f93048705a51f4d165", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/718de56a0aca7a947dd303f93048705a51f4d165", "committedDate": "2020-03-27T09:37:29Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzQ3NDEz", "url": "https://github.com/palantir/atlasdb/pull/4680#pullrequestreview-382747413", "createdAt": "2020-03-27T10:41:56Z", "commit": {"oid": "718de56a0aca7a947dd303f93048705a51f4d165"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMDo0MTo1NlrOF8rvvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMDo0MTo1NlrOF8rvvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTE3NTYxNQ==", "bodyText": "Why is it hard to make the verification step use multiple transactions, same as migration.", "url": "https://github.com/palantir/atlasdb/pull/4680#discussion_r399175615", "createdAt": "2020-03-27T10:41:56Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-cli/src/main/java/com/palantir/atlasdb/cli/command/KvsMigrationCommand.java", "diffHunk": "@@ -40,6 +41,7 @@\n @Command(name = \"migrate\", description = \"Migrate your data from one key value service to another.\")\n public class KvsMigrationCommand implements Callable<Integer> {\n     private static final OutputPrinter printer = new OutputPrinter(LoggerFactory.getLogger(KvsMigrationCommand.class));\n+    private static final int TRANSACTION_READ_TIMEOUT_MILLIS_OVERRIDE = 8 * 60 * 60 * 1000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718de56a0aca7a947dd303f93048705a51f4d165"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODE3Mzg0", "url": "https://github.com/palantir/atlasdb/pull/4680#pullrequestreview-382817384", "createdAt": "2020-03-27T12:35:41Z", "commit": {"oid": "718de56a0aca7a947dd303f93048705a51f4d165"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMjozNTo0MVrOF8vOkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMjozNTo0MVrOF8vOkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIzMjY1Nw==", "bodyText": "If we're going to do it this way, we should probably also disable retries in the validator; if you hit a problem after a couple hours it doesn't really buy you much to retry, becuase nobody will sit there for that long.", "url": "https://github.com/palantir/atlasdb/pull/4680#discussion_r399232657", "createdAt": "2020-03-27T12:35:41Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-cli/src/main/java/com/palantir/atlasdb/cli/command/KvsMigrationCommand.java", "diffHunk": "@@ -150,21 +152,29 @@ private AtlasDbConfig makeOfflineIfNecessary(AtlasDbConfig atlasDbConfig) {\n     }\n \n     public AtlasDbServices connectFromServices() throws IOException {\n-        AtlasDbConfig fromConfig = AtlasDbConfigs.load(fromConfigFile, configRoot, AtlasDbConfig.class);\n+        AtlasDbConfig fromConfig = overrideTransactionTimeoutMillis(\n+                AtlasDbConfigs.load(fromConfigFile, configRoot, AtlasDbConfig.class));\n         ServicesConfigModule scm = ServicesConfigModule.create(\n                 makeOfflineIfNecessary(fromConfig), AtlasDbRuntimeConfig.withSweepDisabled());\n         return DaggerAtlasDbServices.builder().servicesConfigModule(scm).build();\n     }\n \n     public AtlasDbServices connectToServices() throws IOException {\n-        AtlasDbConfig toConfig = toConfigFile != null\n-                ? AtlasDbConfigs.load(toConfigFile, configRoot, AtlasDbConfig.class)\n-                : AtlasDbConfigs.loadFromString(inlineConfig, null, AtlasDbConfig.class);\n+        AtlasDbConfig toConfig = overrideTransactionTimeoutMillis(\n+                toConfigFile != null\n+                        ? AtlasDbConfigs.load(toConfigFile, configRoot, AtlasDbConfig.class)\n+                        : AtlasDbConfigs.loadFromString(inlineConfig, null, AtlasDbConfig.class));\n         ServicesConfigModule scm = ServicesConfigModule.create(\n                 makeOfflineIfNecessary(toConfig), AtlasDbRuntimeConfig.withSweepDisabled());\n         return DaggerAtlasDbServices.builder().servicesConfigModule(scm).build();\n     }\n \n+    private AtlasDbConfig overrideTransactionTimeoutMillis(AtlasDbConfig config) {\n+        return ImmutableAtlasDbConfig.builder().from(config)\n+                .transactionReadTimeoutMillis(TRANSACTION_READ_TIMEOUT_MILLIS_OVERRIDE)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "718de56a0aca7a947dd303f93048705a51f4d165"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c6c49e986b11df46a496bd61ab304a95c0ac5f3", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/4c6c49e986b11df46a496bd61ab304a95c0ac5f3", "committedDate": "2020-03-27T13:11:35Z", "message": "use non-retriable txns"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91fb37933a7181663534bb67861d50b097d36e55", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/91fb37933a7181663534bb67861d50b097d36e55", "committedDate": "2020-03-27T13:12:51Z", "message": "remove accidental character"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODYyMjY0", "url": "https://github.com/palantir/atlasdb/pull/4680#pullrequestreview-382862264", "createdAt": "2020-03-27T13:36:38Z", "commit": {"oid": "91fb37933a7181663534bb67861d50b097d36e55"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzozNjozOVrOF8xb-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzozNjozOVrOF8xb-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2ODg1OA==", "bodyText": "Update changelog", "url": "https://github.com/palantir/atlasdb/pull/4680#discussion_r399268858", "createdAt": "2020-03-27T13:36:39Z", "author": {"login": "jkozlowski"}, "path": "changelog/@unreleased/pr-4680.v2.yml", "diffHunk": "@@ -0,0 +1,5 @@\n+type: improvement\n+improvement:\n+  description: '[PDS-114184] Increase transaction read timeout in CLI to 8 hours'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91fb37933a7181663534bb67861d50b097d36e55"}, "originalPosition": 3}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODYyNDk2", "url": "https://github.com/palantir/atlasdb/pull/4680#pullrequestreview-382862496", "createdAt": "2020-03-27T13:36:53Z", "commit": {"oid": "91fb37933a7181663534bb67861d50b097d36e55"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzozNjo1NFrOF8xcuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzozNjo1NFrOF8xcuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2OTA1MQ==", "bodyText": "Put a comment why you don't want retryes", "url": "https://github.com/palantir/atlasdb/pull/4680#discussion_r399269051", "createdAt": "2020-03-27T13:36:54Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/schema/KeyValueServiceValidator.java", "diffHunk": "@@ -115,7 +115,7 @@ private void validateTables(Set<TableReference> tables) {\n     private void validateTable(final TableReference table) {\n         final int limit = getBatchSize(table);\n         // read only, but need to use a write tx in case the source table has SweepStrategy.THOROUGH\n-        validationFromTransactionManager.runTaskWithRetry(\n+        validationFromTransactionManager.runTaskThrowOnConflict(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91fb37933a7181663534bb67861d50b097d36e55"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODYzMTUy", "url": "https://github.com/palantir/atlasdb/pull/4680#pullrequestreview-382863152", "createdAt": "2020-03-27T13:37:43Z", "commit": {"oid": "91fb37933a7181663534bb67861d50b097d36e55"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7cb13139eec1bca3cb4aadb34856756f720d204", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/f7cb13139eec1bca3cb4aadb34856756f720d204", "committedDate": "2020-03-27T13:39:00Z", "message": "update timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5bec3396300afb88e7efd53d3220dd3c6a7b564", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/c5bec3396300afb88e7efd53d3220dd3c6a7b564", "committedDate": "2020-03-27T13:39:00Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0314b5b6008908fea7040f471546bdd37d36a353", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/0314b5b6008908fea7040f471546bdd37d36a353", "committedDate": "2020-03-27T13:40:02Z", "message": "temp remove changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b597027385ca821da062ec780b1e04f94ff85b8", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/9b597027385ca821da062ec780b1e04f94ff85b8", "committedDate": "2020-03-27T13:40:40Z", "message": "update changelog"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3018, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}