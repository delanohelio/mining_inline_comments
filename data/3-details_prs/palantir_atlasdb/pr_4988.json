{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NDkwNzE2", "number": 4988, "title": "remove unnecessary oracle config restrictions", "bodyText": "Goals (and why):\nForbidding configuring the keystore/truststore when the oracle protocol\nis not TCPS makes it a lot harder to automate configs. It is much easier\nto allow our config automation to always fill in these values even when\nthey won't be used.\nThis does not remove the validation that checks they are present when\nthey really are required.\nImplementation Description (bullets):\n\nremove precondition checks for keystore/truststore being absent when the protocol isn't TCPS\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nunit tests have been added. no existing tests were validating the current behavior\n\nConcerns (what feedback would you like?):\nWhere should we start reviewing?:\nPriority (whenever / two weeks / yesterday): high -- we'd like to make it easier to switch between TCP/TCPS on oracle in our internal products", "createdAt": "2020-09-18T19:04:07Z", "url": "https://github.com/palantir/atlasdb/pull/4988", "merged": true, "mergeCommit": {"oid": "04b327f5c8be125e45f9f202fdd4cefe99a32040"}, "closed": true, "closedAt": "2020-09-21T14:43:33Z", "author": {"login": "berler"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKKb_TABqjM3ODM4OTM1MzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLEenoAFqTQ5MjY3ODA3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "792f7ae73eeff543937365d6a02aac942373d59d", "author": {"user": {"login": "berler", "name": "Steven Berler"}}, "url": "https://github.com/palantir/atlasdb/commit/792f7ae73eeff543937365d6a02aac942373d59d", "committedDate": "2020-09-18T18:02:39Z", "message": "Add generated changelog entries"}, "afterCommit": {"oid": "6cf164ea5fd016d8a89ec421b2234fd3b8fcf5e8", "author": {"user": {"login": "berler", "name": "Steven Berler"}}, "url": "https://github.com/palantir/atlasdb/commit/6cf164ea5fd016d8a89ec421b2234fd3b8fcf5e8", "committedDate": "2020-09-18T19:05:53Z", "message": "Add generated changelog entries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6cf164ea5fd016d8a89ec421b2234fd3b8fcf5e8", "author": {"user": {"login": "berler", "name": "Steven Berler"}}, "url": "https://github.com/palantir/atlasdb/commit/6cf164ea5fd016d8a89ec421b2234fd3b8fcf5e8", "committedDate": "2020-09-18T19:05:53Z", "message": "Add generated changelog entries"}, "afterCommit": {"oid": "042365ecbcf52ffb6c40c54926cc7f3f8c496854", "author": {"user": {"login": "berler", "name": "Steven Berler"}}, "url": "https://github.com/palantir/atlasdb/commit/042365ecbcf52ffb6c40c54926cc7f3f8c496854", "committedDate": "2020-09-18T19:09:46Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "557bd8ae00d9d09404416fb549fe27a26482d1c8", "author": {"user": {"login": "berler", "name": "Steven Berler"}}, "url": "https://github.com/palantir/atlasdb/commit/557bd8ae00d9d09404416fb549fe27a26482d1c8", "committedDate": "2020-09-18T19:24:13Z", "message": "remove unnecessary oracle config restrictions\n\nForbidding configuring the keystore/truststore when the oracle protocol\nis not TCPS makes it a lot harder to automate configs. It is much easier\nto allow our config automation to always fill in these values even when\nthey won't be used.\n\nThis does not remove the validation that checks they are present when\nthey really are required."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97cc2ba6e127251a8da7f490623bb93125cc0312", "author": {"user": {"login": "berler", "name": "Steven Berler"}}, "url": "https://github.com/palantir/atlasdb/commit/97cc2ba6e127251a8da7f490623bb93125cc0312", "committedDate": "2020-09-18T19:24:16Z", "message": "Add generated changelog entries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "042365ecbcf52ffb6c40c54926cc7f3f8c496854", "author": {"user": {"login": "berler", "name": "Steven Berler"}}, "url": "https://github.com/palantir/atlasdb/commit/042365ecbcf52ffb6c40c54926cc7f3f8c496854", "committedDate": "2020-09-18T19:09:46Z", "message": "Add generated changelog entries"}, "afterCommit": {"oid": "97cc2ba6e127251a8da7f490623bb93125cc0312", "author": {"user": {"login": "berler", "name": "Steven Berler"}}, "url": "https://github.com/palantir/atlasdb/commit/97cc2ba6e127251a8da7f490623bb93125cc0312", "committedDate": "2020-09-18T19:24:16Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNjc4MDcx", "url": "https://github.com/palantir/atlasdb/pull/4988#pullrequestreview-492678071", "createdAt": "2020-09-21T14:42:49Z", "commit": {"oid": "97cc2ba6e127251a8da7f490623bb93125cc0312"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNDo0Mjo1MFrOHVTm1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNDo0MzowNFrOHVTnfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEwMzM4MQ==", "bodyText": "thanks for the detailed tests!", "url": "https://github.com/palantir/atlasdb/pull/4988#discussion_r492103381", "createdAt": "2020-09-21T14:42:50Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-dbkvs-hikari/src/test/java/com/palantir/nexus/db/pool/config/OracleConnectionConfigTest.java", "diffHunk": "@@ -85,6 +90,71 @@ public void namespaceIsNamespaceOverrideIfServiceNameConfigurationSpecified() {\n         assertThat(connectionConfig.namespace()).contains(SERVICE_NAME_CONFIGURATION.namespaceOverride());\n     }\n \n+    @Test\n+    public void settingKeyAndTrustStoresAllowedWithoutTcps() {\n+        OracleConnectionConfig connectionConfig = getBaseBuilder()\n+                .sid(SID)\n+                .truststorePath(\"truststore.jks\")\n+                .truststorePassword(\"password\")\n+                .keystorePath(\"keystore.jks\")\n+                .keystorePassword(\"password\")\n+                .build();\n+        assertThat(connectionConfig.getProtocol())\n+                .isEqualTo(ConnectionProtocol.TCP);\n+        assertThat(connectionConfig.getTruststorePath())\n+                .isEqualTo(Optional.of(\"truststore.jks\"));\n+        assertThat(connectionConfig.getKeystorePath())\n+                .isEqualTo(Optional.of(\"keystore.jks\"));\n+        assertThat(connectionConfig.getTruststorePassword())\n+                .isEqualTo(Optional.of(\"password\"));\n+        assertThat(connectionConfig.getKeystorePassword())\n+                .isEqualTo(Optional.of(\"password\"));\n+\n+        // note that even though keystore/truststore are set, none of the javax.net.ssl. properties will be set\n+        // since the protocol is TCP\n+        Properties hikariProperties = connectionConfig.getHikariProperties();\n+        assertThat(hikariProperties.stringPropertyNames())\n+                .noneMatch(prop -> prop.startsWith(\"javax.net.ssl.\"));\n+    }\n+\n+    @Test\n+    public void tcpsSetsTrustStore() throws IOException {\n+        File truststoreFile = new File(\"truststore.jks\");\n+        boolean truststoreFileCreated = truststoreFile.createNewFile();\n+        try {\n+            OracleConnectionConfig connectionConfig = getBaseBuilder()\n+                    .sid(SID)\n+                    .protocol(ConnectionProtocol.TCPS)\n+                    .truststorePath(\"truststore.jks\")\n+                    .truststorePassword(\"password\")\n+                    .keystorePath(\"keystore.jks\")\n+                    .keystorePassword(\"password\")\n+                    .build();\n+\n+            assertThat(connectionConfig.getProtocol())\n+                    .isEqualTo(ConnectionProtocol.TCPS);\n+            assertThat(connectionConfig.getTruststorePath())\n+                    .isEqualTo(Optional.of(\"truststore.jks\"));\n+            assertThat(connectionConfig.getKeystorePath())\n+                    .isEqualTo(Optional.of(\"keystore.jks\"));\n+            assertThat(connectionConfig.getTruststorePassword())\n+                    .isEqualTo(Optional.of(\"password\"));\n+            assertThat(connectionConfig.getKeystorePassword())\n+                    .isEqualTo(Optional.of(\"password\"));\n+\n+            Properties hikariProperties = connectionConfig.getHikariProperties();\n+            assertThat(hikariProperties)\n+                    .containsEntry(\"javax.net.ssl.trustStore\", truststoreFile.getAbsolutePath())\n+                    .containsEntry(\"javax.net.ssl.trustStorePassword\", \"password\")\n+                    .doesNotContainKeys(\"javax.net.ssl.keyStore\", \"javax.net.ssl.keyStorePassword\");\n+        } finally {\n+            // clean up the truststore file if we created it\n+            if (truststoreFileCreated) {\n+                truststoreFile.delete();\n+            }\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97cc2ba6e127251a8da7f490623bb93125cc0312"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjEwMzU0OQ==", "bodyText": "I'd prefer if we put a WARN log here if any of them are present? Basically it's easy to make a config error and then be really puzzled as to why the settings aren't taking effect.", "url": "https://github.com/palantir/atlasdb/pull/4988#discussion_r492103549", "createdAt": "2020-09-21T14:43:04Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-dbkvs-hikari/src/main/java/com/palantir/nexus/db/pool/config/OracleConnectionConfig.java", "diffHunk": "@@ -196,16 +196,6 @@ protected final void check() {\n         } else {\n             Preconditions.checkArgument(!getTwoWaySsl(),\n                     \"two way ssl cannot be enabled without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getServerDn().isPresent(),\n-                    \"a server dn cannot be given without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getTruststorePath().isPresent(),\n-                    \"a truststore path cannot be given without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getTruststorePassword().isPresent(),\n-                    \"a truststore password cannot be given without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getKeystorePath().isPresent(),\n-                    \"a keystore file cannot be given without enabling ConnectionProtocol.TCPS\");\n-            Preconditions.checkArgument(!getKeystorePassword().isPresent(),\n-                    \"a keystore password without enabling ConnectionProtocol.TCPS\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97cc2ba6e127251a8da7f490623bb93125cc0312"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2576, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}