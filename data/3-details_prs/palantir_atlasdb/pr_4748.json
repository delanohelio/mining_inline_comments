{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyMTc2NjQ0", "number": 4748, "title": "Fix bug in transaction starter if it fails midway through the batch", "bodyText": "Goals (and why):\n\nTransaction starter uses an autobatcher to batch start transaction requests. It continually takes batches out until it has enough requests, but if it fails midway through this process, it will drop some immutable TS locks on the floor.\nThis PR covers this case (and moves some code around in TransactionStarter).\n\nImplementation Description (bullets):\n\nAdd a try/catch around starting transactions in the batching method in TransactionStarter, and unlock all currently obtained locks if we fail.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nTransactionStarterTests focuses on successful starts, haven't added a test for this case (yet).\n\nConcerns (what feedback would you like?):\n\nDoes this catch the case we are concerned about?\n\nWhere should we start reviewing?:\n\nTransactionStarter\n\nPriority (whenever / two weeks / yesterday):\nWithin a week.", "createdAt": "2020-05-01T15:31:04Z", "url": "https://github.com/palantir/atlasdb/pull/4748", "merged": true, "mergeCommit": {"oid": "f190b0137a4877471869fa51ba4650021848bd6c"}, "closed": true, "closedAt": "2020-05-05T09:03:12Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdDX1VAH2gAyNDEyMTc2NjQ0OmQwYTVmMGIyMDFlZWUyYTEzMTIxZWJlYzU4NjJlZmYwNDJkNWI0ZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceQNLSgFqTQwNTYwNDk2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d0a5f0b201eee2a13121ebec5862eff042d5b4df", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/d0a5f0b201eee2a13121ebec5862eff042d5b4df", "committedDate": "2020-05-01T15:25:38Z", "message": "Add unlock if failing mid-way through starting txns"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MjI0OTI4", "url": "https://github.com/palantir/atlasdb/pull/4748#pullrequestreview-404224928", "createdAt": "2020-05-01T15:32:21Z", "commit": {"oid": "d0a5f0b201eee2a13121ebec5862eff042d5b4df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTozMjoyMVrOGPM8ZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTozMjoyMVrOGPM8ZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5Mzg5Mw==", "bodyText": "I don't know what doing it this way gave us, but collapsing into the constructor allows us to make the consumer non-static so that it can call the unlock method.", "url": "https://github.com/palantir/atlasdb/pull/4748#discussion_r418593893", "createdAt": "2020-05-01T15:32:21Z", "author": {"login": "Jolyon-S"}, "path": "lock-api/src/main/java/com/palantir/lock/client/TransactionStarter.java", "diffHunk": "@@ -53,20 +53,16 @@\n     private final DisruptorAutobatcher<Void, StartIdentifiedAtlasDbTransactionResponse> autobatcher;\n     private final LockLeaseService lockLeaseService;\n \n-    private TransactionStarter(\n-            DisruptorAutobatcher<Void, StartIdentifiedAtlasDbTransactionResponse> autobatcher,\n-            LockLeaseService lockLeaseService) {\n-        this.autobatcher = autobatcher;\n+    private TransactionStarter(LockLeaseService lockLeaseService, LockWatchEventCache lockWatchEventCache) {\n+        this.autobatcher = Autobatchers\n+                .independent(consumer(lockLeaseService, lockWatchEventCache))\n+                .safeLoggablePurpose(\"transaction-starter\")\n+                .build();\n         this.lockLeaseService = lockLeaseService;\n     }\n \n     static TransactionStarter create(LockLeaseService lockLeaseService, LockWatchEventCache lockWatchEventCache) {\n-        DisruptorAutobatcher<Void, StartIdentifiedAtlasDbTransactionResponse> autobatcher = Autobatchers\n-                .independent(consumer(lockLeaseService, lockWatchEventCache))\n-                .safeLoggablePurpose(\"transaction-starter\")\n-                .build();\n-        return new TransactionStarter(autobatcher,\n-                lockLeaseService);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0a5f0b201eee2a13121ebec5862eff042d5b4df"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MjI1MTY2", "url": "https://github.com/palantir/atlasdb/pull/4748#pullrequestreview-404225166", "createdAt": "2020-05-01T15:32:47Z", "commit": {"oid": "d0a5f0b201eee2a13121ebec5862eff042d5b4df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTozMjo0N1rOGPM9Lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQxNTozMjo0N1rOGPM9Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODU5NDA5NQ==", "bodyText": "Non-static to call the unlock method.", "url": "https://github.com/palantir/atlasdb/pull/4748#discussion_r418594095", "createdAt": "2020-05-01T15:32:47Z", "author": {"login": "Jolyon-S"}, "path": "lock-api/src/main/java/com/palantir/lock/client/TransactionStarter.java", "diffHunk": "@@ -152,18 +148,25 @@ public void close() {\n         };\n     }\n \n-    private static List<StartIdentifiedAtlasDbTransactionResponse> getStartTransactionResponses(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0a5f0b201eee2a13121ebec5862eff042d5b4df"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd01a34f0fd44a7b497d99dd155b7ee8b87fdf7f", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/fd01a34f0fd44a7b497d99dd155b7ee8b87fdf7f", "committedDate": "2020-05-04T08:56:51Z", "message": "Remove unused param"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9258d3b49ade78b5f409e45693f75a886db6c10c", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/9258d3b49ade78b5f409e45693f75a886db6c10c", "committedDate": "2020-05-04T09:12:40Z", "message": "Fix method args"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MDM4Mjc3", "url": "https://github.com/palantir/atlasdb/pull/4748#pullrequestreview-405038277", "createdAt": "2020-05-04T14:25:44Z", "commit": {"oid": "9258d3b49ade78b5f409e45693f75a886db6c10c"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fc45919879fd6c3bb4a90ad7f5f49aa23fac82a", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/1fc45919879fd6c3bb4a90ad7f5f49aa23fac82a", "committedDate": "2020-05-05T08:38:53Z", "message": "Revert static flow to be closer to original"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NjA0OTYz", "url": "https://github.com/palantir/atlasdb/pull/4748#pullrequestreview-405604963", "createdAt": "2020-05-05T08:56:41Z", "commit": {"oid": "1fc45919879fd6c3bb4a90ad7f5f49aa23fac82a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3123, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}