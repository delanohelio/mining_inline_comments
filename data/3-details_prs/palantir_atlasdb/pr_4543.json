{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MDYwNjg2", "number": 4543, "title": "Better log when rolled back by someone else", "bodyText": "Goals (and why):\nWe still want to log something when this occurs, but we don't want to panic users by logging at warn or saying that this cannot happen in atlas normally (as it can)", "createdAt": "2020-01-30T12:59:54Z", "url": "https://github.com/palantir/atlasdb/pull/4543", "merged": true, "mergeCommit": {"oid": "8232e1a5f92b5e316f0c8fb30f400aa28d009874"}, "closed": true, "closedAt": "2020-02-07T10:39:36Z", "author": {"login": "gmaretic"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_aGndgH2gAyMzY5MDYwNjg2Ojk5YTcwOGUwZTcxOTAzZGEzYTg1OTY1YjE2NzMyYjcyYjZmYmU4NmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB8xEBAFqTM1NTA2Mjk1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "99a708e0e71903da3a85965b16732b72b6fbe86d", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/99a708e0e71903da3a85965b16732b72b6fbe86d", "committedDate": "2020-01-30T12:56:55Z", "message": "Better log line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwODI4Njg5", "url": "https://github.com/palantir/atlasdb/pull/4543#pullrequestreview-350828689", "createdAt": "2020-01-30T13:41:31Z", "commit": {"oid": "99a708e0e71903da3a85965b16732b72b6fbe86d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMzo0MTozMVrOFjrOxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMzo0MTozMVrOFjrOxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjk1Mjc3NA==", "bodyText": "This will break logging again: LeasedLockToken is not loggable by our logging infra. So either get rid of the args in this logline or figure out how to collect the stuff you need in a way that's loggable.", "url": "https://github.com/palantir/atlasdb/pull/4543#discussion_r372952774", "createdAt": "2020-01-30T13:41:31Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -2260,8 +2260,7 @@ private void handleKeyAlreadyExistsException(\n                         + \" because our locks timed out. startTs: \" + getStartTimestamp() + \".  \"\n                         + getExpiredLocksErrorString(commitLocksToken, expiredLocks), ex);\n             } else {\n-                log.debug(\"Possible bug: Someone rolled back our transaction but\"\n-                        + \" our locks were still valid; Atlas code is not allowed to do this, though others can.\",\n+                log.info(\"This transaction has been rolled back by someone else.\",\n                         SafeArg.of(\"immutableTimestampLock\", immutableTimestampLock),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99a708e0e71903da3a85965b16732b72b6fbe86d"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75a0ccb66f41405bdaf52fdae10672fa310ff1e1", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/75a0ccb66f41405bdaf52fdae10672fa310ff1e1", "committedDate": "2020-01-30T15:27:21Z", "message": "Get server tokens"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwOTQ3NDgx", "url": "https://github.com/palantir/atlasdb/pull/4543#pullrequestreview-350947481", "createdAt": "2020-01-30T16:10:49Z", "commit": {"oid": "75a0ccb66f41405bdaf52fdae10672fa310ff1e1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNjoxMDo0OVrOFjwxZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxNjoxMDo0OVrOFjwxZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA0MzU1Ng==", "bodyText": "@gmaretic would you be able to quickly test manually using an internal product to see that this logline works?", "url": "https://github.com/palantir/atlasdb/pull/4543#discussion_r373043556", "createdAt": "2020-01-30T16:10:49Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -2260,10 +2269,10 @@ private void handleKeyAlreadyExistsException(\n                         + \" because our locks timed out. startTs: \" + getStartTimestamp() + \".  \"\n                         + getExpiredLocksErrorString(commitLocksToken, expiredLocks), ex);\n             } else {\n-                log.debug(\"Possible bug: Someone rolled back our transaction but\"\n-                        + \" our locks were still valid; Atlas code is not allowed to do this, though others can.\",\n-                        SafeArg.of(\"immutableTimestampLock\", immutableTimestampLock),\n-                        SafeArg.of(\"commitLocksToken\", commitLocksToken));\n+                log.info(\"This transaction has been rolled back by someone else.\",\n+                        SafeArg.of(\"immutableTimestampLock\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "75a0ccb66f41405bdaf52fdae10672fa310ff1e1"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a36366ea80a1fe1049b4dc6652e302ffbfb5c71", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/7a36366ea80a1fe1049b4dc6652e302ffbfb5c71", "committedDate": "2020-01-31T13:50:45Z", "message": "More unwrapping, tested using ETE tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMTI0NDgw", "url": "https://github.com/palantir/atlasdb/pull/4543#pullrequestreview-352124480", "createdAt": "2020-02-03T09:42:43Z", "commit": {"oid": "7a36366ea80a1fe1049b4dc6652e302ffbfb5c71"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOTo0Mjo0M1rOFkrVAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOTo0Mjo0M1rOFkrVAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAwMjk0NA==", "bodyText": "At this point maybe we should just add something to the LockToken interface that is going to return a String that can be used for logging? Or maybe an Arg straight away? https://github.com/palantir/safe-logging/blob/develop/safe-logging/src/main/java/com/palantir/logsafe/SafeArg.java", "url": "https://github.com/palantir/atlasdb/pull/4543#discussion_r374002944", "createdAt": "2020-02-03T09:42:43Z", "author": {"login": "jkozlowski"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LockTokenShare.java", "diffHunk": "@@ -24,7 +24,7 @@\n import com.palantir.lock.v2.LockToken;\n import com.palantir.logsafe.Preconditions;\n \n-final class LockTokenShare implements LockToken {\n+public final class LockTokenShare implements LockToken {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a36366ea80a1fe1049b4dc6652e302ffbfb5c71"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25ed7a4c8a1511a95ce090c520cd112c55c24173", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/25ed7a4c8a1511a95ce090c520cd112c55c24173", "committedDate": "2020-02-05T13:39:02Z", "message": "Add toSafeArg method to LockToken"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "729f37e7c394c685be2e9059426a7154da007842", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/729f37e7c394c685be2e9059426a7154da007842", "committedDate": "2020-02-05T13:39:11Z", "message": "Merge branch 'develop' of github.com:palantir/atlasdb into fix/rollback-log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a08186cbfa239d62d699d2aff0d6749d22bd4a76", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/a08186cbfa239d62d699d2aff0d6749d22bd4a76", "committedDate": "2020-02-05T14:00:50Z", "message": "Test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f023803ed094e1c03310a147d69c281646fa3de", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/2f023803ed094e1c03310a147d69c281646fa3de", "committedDate": "2020-02-05T16:54:53Z", "message": "Be better"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecc53a576fa7da8ed662c58421cca887bed0adbd", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/ecc53a576fa7da8ed662c58421cca887bed0adbd", "committedDate": "2020-02-06T09:18:52Z", "message": "Merge branch 'develop' of github.com:palantir/atlasdb into fix/rollback-log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NTU0MTc3", "url": "https://github.com/palantir/atlasdb/pull/4543#pullrequestreview-354554177", "createdAt": "2020-02-06T15:44:29Z", "commit": {"oid": "ecc53a576fa7da8ed662c58421cca887bed0adbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNTo0NDoyOVrOFmf6kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNTo0NDoyOVrOFmf6kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTkxMzEwNA==", "bodyText": "These publics are not necessary anymore?", "url": "https://github.com/palantir/atlasdb/pull/4543#discussion_r375913104", "createdAt": "2020-02-06T15:44:29Z", "author": {"login": "jkozlowski"}, "path": "lock-api/src/main/java/com/palantir/lock/client/LockTokenShare.java", "diffHunk": "@@ -23,8 +23,9 @@\n \n import com.palantir.lock.v2.LockToken;\n import com.palantir.logsafe.Preconditions;\n+import com.palantir.logsafe.SafeArg;\n \n-final class LockTokenShare implements LockToken {\n+public final class LockTokenShare implements LockToken {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecc53a576fa7da8ed662c58421cca887bed0adbd"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NjQzMTM0", "url": "https://github.com/palantir/atlasdb/pull/4543#pullrequestreview-354643134", "createdAt": "2020-02-06T17:39:09Z", "commit": {"oid": "ecc53a576fa7da8ed662c58421cca887bed0adbd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzozOTowOVrOFmkIKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNzozOTowOVrOFmkIKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk4MjEyMg==", "bodyText": "We should say we still have our locks, otherwise it's not clear what the args are meant to mean.", "url": "https://github.com/palantir/atlasdb/pull/4543#discussion_r375982122", "createdAt": "2020-02-06T17:39:09Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransaction.java", "diffHunk": "@@ -2260,10 +2260,11 @@ private void handleKeyAlreadyExistsException(\n                         + \" because our locks timed out. startTs: \" + getStartTimestamp() + \".  \"\n                         + getExpiredLocksErrorString(commitLocksToken, expiredLocks), ex);\n             } else {\n-                log.debug(\"Possible bug: Someone rolled back our transaction but\"\n-                        + \" our locks were still valid; Atlas code is not allowed to do this, though others can.\",\n-                        SafeArg.of(\"immutableTimestampLock\", immutableTimestampLock),\n-                        SafeArg.of(\"commitLocksToken\", commitLocksToken));\n+                log.info(\"This transaction has been rolled back by someone else.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecc53a576fa7da8ed662c58421cca887bed0adbd"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2385025966f8426b4ae8e8105c9023f4bbd39eef", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/2385025966f8426b4ae8e8105c9023f4bbd39eef", "committedDate": "2020-02-07T10:14:37Z", "message": "Improve message, make LTS package private again"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDYyOTU4", "url": "https://github.com/palantir/atlasdb/pull/4543#pullrequestreview-355062958", "createdAt": "2020-02-07T10:27:54Z", "commit": {"oid": "2385025966f8426b4ae8e8105c9023f4bbd39eef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2220, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}