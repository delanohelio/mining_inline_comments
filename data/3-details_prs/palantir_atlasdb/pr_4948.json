{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MDM3NjM0", "number": 4948, "title": "[PDS-130107] Enable Divergent KVS Namespaces and TimeLock Clients", "bodyText": "Goals (and why):\n\nUsed in some DBKVS use cases, where through the use of table mapping it is legitimate to have multiple AtlasDB users interface with the same KVS in the same way.\nMinimise the risk that anyone who does not need this use case actually tries to (this is very error prone).\n\nImplementation Description (bullets):\n\nAllow the config to accept different KVS namespaces and timelock clients, provided this is explicitly enabled AND the user is not using Cassandra.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nAdded a few new tests for new cases in the configuration\n\nConcerns (what feedback would you like?):\n\nAre there correctness issues?\n\nWhere should we start reviewing?:\npaired\nPriority (whenever / two weeks / yesterday): this week or early next", "createdAt": "2020-08-14T15:10:30Z", "url": "https://github.com/palantir/atlasdb/pull/4948", "merged": true, "mergeCommit": {"oid": "493f6c1415f3cd762e06d1bbdbe00e98df309257"}, "closed": true, "closedAt": "2020-08-17T10:40:36Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-2DCtgH2gAyNDY4MDM3NjM0OmZlNzIxNGRlMjYzNTJjZmQxZjAwOTUwYTY3NDZhZjYwYTc1YzMxNGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-3NZgAH2gAyNDY4MDM3NjM0OjFmZDgzMGNjMDdiNmY4NDliNWVmY2EzMDFkMGM5MmQ1MzZkMzBmMDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fe7214de26352cfd1f00950a6746af60a75c314e", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/fe7214de26352cfd1f00950a6746af60a75c314e", "committedDate": "2020-08-14T15:07:35Z", "message": "config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4978613621371ebe2d6e3c41f3774be728ffb133", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/4978613621371ebe2d6e3c41f3774be728ffb133", "committedDate": "2020-08-14T15:07:35Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc577250ecf3068b102e78021537dbcef2d0fb8d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/cc577250ecf3068b102e78021537dbcef2d0fb8d", "committedDate": "2020-08-14T15:12:17Z", "message": "flatmpa"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1285d70d323229c9bd270a731eabbd371b1ec0af", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/1285d70d323229c9bd270a731eabbd371b1ec0af", "committedDate": "2020-08-14T15:27:30Z", "message": "Merge branch 'jkong/aaaargh' of github.com:palantir/atlasdb into jkong/aaaargh"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NjY2NzI5", "url": "https://github.com/palantir/atlasdb/pull/4948#pullrequestreview-467666729", "createdAt": "2020-08-14T15:23:04Z", "commit": {"oid": "4978613621371ebe2d6e3c41f3774be728ffb133"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNToyMzowNFrOHA4y7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNToyMzowNFrOHA4y7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY5MjU4OA==", "bodyText": "nit: remove com.palantir.logsafe?", "url": "https://github.com/palantir/atlasdb/pull/4948#discussion_r470692588", "createdAt": "2020-08-14T15:23:04Z", "author": {"login": "sudiksha27"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/config/AtlasDbConfig.java", "diffHunk": "@@ -319,69 +333,56 @@ private static void checkServersListHasAtLeastOneServerIfPresent(Optional<Server\n                         \"Server list must have at least one server.\"));\n     }\n \n-    private String checkNamespaceConfigAndGetNamespace() {\n+    private void checkNamespaceConfigConsistent() {\n         if (namespace().isPresent()) {\n-            String namespaceConfigValue = namespace().get();\n-\n-            Preconditions.checkState(!namespaceConfigValue.contains(\"\\\"\"),\n-                    \"Namespace should not be quoted\");\n+            String presentNamespace = namespace().get();\n+            Preconditions.checkState(!presentNamespace.contains(\"\\\"\"), \"Namespace should not be quoted\");\n \n             keyValueService().namespace().ifPresent(kvsNamespace ->\n-                    com.palantir.logsafe.Preconditions.checkState(kvsNamespace.equals(namespaceConfigValue),\n+                    Preconditions.checkState(kvsNamespace.equals(presentNamespace),\n                             \"If present, keyspace/dbName/sid config should be the same as the\"\n                                     + \" atlas root-level namespace config.\"));\n \n             timelock().ifPresent(timelock -> timelock.client().ifPresent(client ->\n-                    com.palantir.logsafe.Preconditions.checkState(client.equals(namespaceConfigValue),\n+                    Preconditions.checkState(client.equals(presentNamespace),\n                             \"If present, the TimeLock client config should be the same as the\"\n                                     + \" atlas root-level namespace config.\")));\n-            return namespaceConfigValue;\n-        } else if (!(keyValueService() instanceof InMemoryAtlasDbConfig)) {\n-            com.palantir.logsafe.Preconditions.checkState(keyValueService().namespace().isPresent(),\n-                    \"Either the atlas root-level namespace\"\n-                            + \" or the keyspace/dbName/sid config needs to be set.\");\n+            return;\n+        }\n \n-            String keyValueServiceNamespace = keyValueService().namespace().get();\n+        // There is no top level namespace\n+        if (keyValueService() instanceof InMemoryAtlasDbConfig) {\n+            if (timelock().isPresent() && !timelock().get().client().isPresent()) {\n+                throw new SafeIllegalStateException(\"For InMemoryKVS, the TimeLock client should not be empty\");\n+            }\n+            return;\n+        }\n \n-            Preconditions.checkState(!keyValueServiceNamespace.contains(\"\\\"\"),\n-                    \"KeyValueService namespace should not be quoted\");\n+        // There is no top level namespace AND the config is not an in-memory config\n+        Preconditions.checkState(keyValueService().namespace().isPresent(),\n+                \"Either the atlas root-level namespace\"\n+                        + \" or the keyspace/dbName/sid config needs to be set.\");\n+        String keyValueServiceNamespace = keyValueService().namespace().get();\n+        Preconditions.checkState(!keyValueServiceNamespace.contains(\"\\\"\"),\n+                \"KeyValueService namespace should not be quoted\");\n \n-            if (timelock().isPresent()) {\n-                TimeLockClientConfig timeLockConfig = timelock().get();\n+        if (timelock().isPresent()) {\n+            TimeLockClientConfig timeLockConfig = timelock().get();\n \n-                com.palantir.logsafe.Preconditions.checkState(timeLockConfig.client().isPresent(),\n-                        \"Either the atlas root-level namespace config or the TimeLock client config\"\n-                                + \" should be present.\");\n+            com.palantir.logsafe.Preconditions.checkState(timeLockConfig.client().isPresent(),\n+                    \"Either the atlas root-level namespace config or the TimeLock client config should be present.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4978613621371ebe2d6e3c41f3774be728ffb133"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c01fbdbd6a46ebb13e34fc63b7df0e4566049ec", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/8c01fbdbd6a46ebb13e34fc63b7df0e4566049ec", "committedDate": "2020-08-14T16:27:33Z", "message": "nit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fd830cc07b6f849b5efca301d0c92d536d30f07", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/1fd830cc07b6f849b5efca301d0c92d536d30f07", "committedDate": "2020-08-14T16:28:48Z", "message": "baseline"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2799, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}