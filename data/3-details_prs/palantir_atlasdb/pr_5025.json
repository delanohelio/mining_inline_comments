{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxODMxOTY1", "number": 5025, "title": "[DB TimeLock] 3B.2 - DbTimeLockSingleLeaderPaxosSuite", "bodyText": "Goals (and why):\n\nGather confidence that db timelock works well.\n\nImplementation Description (bullets):\n\nWire up DB TimeLock to MNPTLSIT which we consider to be our benchmark for basic timelock correctness.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nThis PR is about tests!\n\nConcerns (what feedback would you like?):\n\nThis reruns a bunch of tests that are quite pointless because they test leadership code. I excluded the most egregious exceptions.\nI assumeFalse()d the namespace loader since it really doesn't make any sense until #5014\n\nWhere should we start reviewing?: DbTimelockSingleLeaderPaxosSuite\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-10-12T21:32:41Z", "url": "https://github.com/palantir/atlasdb/pull/5025", "merged": true, "mergeCommit": {"oid": "5e0fc624726cf63218d81bb3e8725c3c294cd0e5"}, "closed": true, "closedAt": "2020-10-14T16:08:05Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSEU3agFqTUwNzE3MDI1NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSdlJzABqjM4NzY3Mjk4NDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MTcwMjU0", "url": "https://github.com/palantir/atlasdb/pull/5025#pullrequestreview-507170254", "createdAt": "2020-10-13T08:05:14Z", "commit": {"oid": "a1ee1ad4bebdb294aa25da807449c5054b8dce07"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwODowNToxNFrOHgaVfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwODoyODo1OVrOHgbUKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc0Nzk2Ng==", "bodyText": "Not a big fan of having these constants in 2 places but it may be fine for this test.", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503747966", "createdAt": "2020-10-13T08:05:14Z", "author": {"login": "sudiksha27"}, "path": "timelock-server/src/testCommon/resources/dbTimeLockPaxosMultiServer.ftl", "diffHunk": "@@ -0,0 +1,76 @@\n+install:\n+  paxos:\n+    data-directory: \"${dataDirectory}\"\n+    sqlite-persistence:\n+      data-directory: \"${sqliteDataDirectory}\"\n+    is-new-service: false\n+    leader-mode: ${leaderMode}\n+  cluster:\n+    cluster:\n+      security:\n+        trustStorePath: \"var/security/trustStore.jks\"\n+        trustStoreType: \"JKS\"\n+        keyStorePath: \"var/security/keyStore.jks\"\n+        keyStorePassword: \"keystore\"\n+        keyStoreType: \"JKS\"\n+      uris:\n+<#list serverProxyPorts as serverProxyPort>\n+      - \"localhost:${serverProxyPort?c}\"\n+</#list>\n+    local-server: \"localhost:${localProxyPort?c}\"\n+  timestampBoundPersistence:\n+    type: database\n+    key-value-service:\n+      type: \"relational\"\n+      ddl:\n+        type: \"postgres\"\n+      connection:\n+        type: \"postgres\"\n+        host: \"localhost\"\n+        port: 5432\n+        dbName: \"atlas\"\n+        dbLogin: \"palantir\"\n+        dbPassword: \"palantir\"\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1ee1ad4bebdb294aa25da807449c5054b8dce07"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1MTEyMA==", "bodyText": "I wonder if this the best we can do design wise, I feel like having these layers makes code a bit harder to read.", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503751120", "createdAt": "2020-10-13T08:10:10Z", "author": {"login": "sudiksha27"}, "path": "timelock-server/src/testCommon/java/com/palantir/atlasdb/timelock/TestableTimelockServerConfiguration.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import org.immutables.value.Value;\n+\n+@Value.Immutable\n+public interface TestableTimelockServerConfiguration {\n+    TemplateVariables templateVariables();\n+\n+    @Value.Default\n+    default boolean needsPostgresDatabase() {\n+        return false;\n+    }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1ee1ad4bebdb294aa25da807449c5054b8dce07"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1OTU5Nw==", "bodyText": "I did not understand the comment, could you please elaborate on that.", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503759597", "createdAt": "2020-10-13T08:22:45Z", "author": {"login": "sudiksha27"}, "path": "timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java", "diffHunk": "@@ -469,6 +470,7 @@ private static void assertNumberOfThreadsReasonable(int startingThreads, int thr\n \n     private void abandonLeadershipPaxosModeAgnosticTestIfRunElsewhere() {\n         Assume.assumeTrue(cluster == FIRST_CLUSTER);\n+        Assume.assumeFalse(cluster.isDbTimelock()); // We will never test only DB timelock when releasing.\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1ee1ad4bebdb294aa25da807449c5054b8dce07"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc2NDAwOQ==", "bodyText": "It may be worth extracting out a utility method that takes templateVariables and needsPG as parameters? There is similar code in TestableTimelockCluster.", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503764009", "createdAt": "2020-10-13T08:28:59Z", "author": {"login": "sudiksha27"}, "path": "timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/suite/DbTimeLockSingleLeaderPaxosSuite.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock.suite;\n+\n+import static com.palantir.atlasdb.timelock.TemplateVariables.generateThreeNodeTimelockCluster;\n+\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+import java.util.stream.StreamSupport;\n+\n+import org.junit.Rule;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.Parameterized;\n+import org.junit.runners.Suite;\n+\n+import com.github.peterwippermann.junit4.parameterizedsuite.ParameterizedSuite;\n+import com.google.common.collect.ImmutableSet;\n+import com.palantir.atlasdb.timelock.ImmutableTestableTimelockServerConfiguration;\n+import com.palantir.atlasdb.timelock.MultiNodePaxosTimeLockServerIntegrationTest;\n+import com.palantir.atlasdb.timelock.TemplateVariables;\n+import com.palantir.atlasdb.timelock.TestableTimelockCluster;\n+import com.palantir.atlasdb.timelock.TestableTimelockServerConfiguration;\n+import com.palantir.timelock.config.PaxosInstallConfiguration;\n+\n+@RunWith(ParameterizedSuite.class)\n+@Suite.SuiteClasses(MultiNodePaxosTimeLockServerIntegrationTest.class)\n+public class DbTimeLockSingleLeaderPaxosSuite {\n+    private static final Iterable<TemplateVariables> TEMPLATE_VARIABLES = generateThreeNodeTimelockCluster(\n+            9086,\n+            builder -> builder.clientPaxosBuilder(builder.clientPaxosBuilder()\n+                    .isUseBatchPaxosTimestamp(false)\n+                    .isBatchSingleLeader(true))\n+                    .leaderMode(PaxosInstallConfiguration.PaxosLeaderMode.SINGLE_LEADER));\n+    private static final List<TestableTimelockServerConfiguration> TESTABLE_CONFIGURATIONS = StreamSupport.stream(\n+            TEMPLATE_VARIABLES.spliterator(), false)\n+            .map(variables -> ImmutableTestableTimelockServerConfiguration.builder()\n+                    .templateVariables(variables)\n+                    .needsPostgresDatabase(true)\n+                    .build())\n+            .collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1ee1ad4bebdb294aa25da807449c5054b8dce07"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MzMxMTY1", "url": "https://github.com/palantir/atlasdb/pull/5025#pullrequestreview-507331165", "createdAt": "2020-10-13T11:24:57Z", "commit": {"oid": "c449e504890ca2e469d4d3b9df167e3a459444a1"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMToyNDo1N1rOHgh6cA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMToyNjoyNlrOHgh94w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3MjExMg==", "bodyText": "I see, what you have now is fine.", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503872112", "createdAt": "2020-10-13T11:24:57Z", "author": {"login": "sudiksha27"}, "path": "timelock-server/src/testCommon/java/com/palantir/atlasdb/timelock/TestableTimelockServerConfiguration.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.timelock;\n+\n+import org.immutables.value.Value;\n+\n+@Value.Immutable\n+public interface TestableTimelockServerConfiguration {\n+    TemplateVariables templateVariables();\n+\n+    @Value.Default\n+    default boolean needsPostgresDatabase() {\n+        return false;\n+    }\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1MTEyMA=="}, "originalCommit": {"oid": "a1ee1ad4bebdb294aa25da807449c5054b8dce07"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3Mjk5NQ==", "bodyText": "Makes sense", "url": "https://github.com/palantir/atlasdb/pull/5025#discussion_r503872995", "createdAt": "2020-10-13T11:26:26Z", "author": {"login": "sudiksha27"}, "path": "timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java", "diffHunk": "@@ -469,6 +470,7 @@ private static void assertNumberOfThreadsReasonable(int startingThreads, int thr\n \n     private void abandonLeadershipPaxosModeAgnosticTestIfRunElsewhere() {\n         Assume.assumeTrue(cluster == FIRST_CLUSTER);\n+        Assume.assumeFalse(cluster.isDbTimelock()); // We will never test only DB timelock when releasing.\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzc1OTU5Nw=="}, "originalCommit": {"oid": "a1ee1ad4bebdb294aa25da807449c5054b8dce07"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5f2ec959c9e5364d71e0000ee7d77a86b24cac5c", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/5f2ec959c9e5364d71e0000ee7d77a86b24cac5c", "committedDate": "2020-10-13T14:38:06Z", "message": "Merge branch 'jkong/dbtltlsit' of github.com:palantir/atlasdb into jkong/dbtltlsit"}, "afterCommit": {"oid": "02b4d69b2f41c9ce57f8ba8b43a91ea0f30e5aa2", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/02b4d69b2f41c9ce57f8ba8b43a91ea0f30e5aa2", "committedDate": "2020-10-13T14:42:05Z", "message": "baseline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3b1d3aec0e6231a2202b39ed718e2c057fb7f25", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/a3b1d3aec0e6231a2202b39ed718e2c057fb7f25", "committedDate": "2020-10-14T13:54:54Z", "message": " blah39g40 3v1j24 g213"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b7468894c3164fc4c9ddf825392c51dd466fa00", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/4b7468894c3164fc4c9ddf825392c51dd466fa00", "committedDate": "2020-10-14T13:54:54Z", "message": "Reset to batched timestamp paxos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67d16f67828a1112da030df0bb1419f9b6d87317", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/67d16f67828a1112da030df0bb1419f9b6d87317", "committedDate": "2020-10-14T13:54:54Z", "message": "meep"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6a3570952ef65b02c27d09cf9189de1e3e3dc3f", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/c6a3570952ef65b02c27d09cf9189de1e3e3dc3f", "committedDate": "2020-10-14T13:54:54Z", "message": "baslein"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6872e91a61aa0b9d7659d657e3a025fe4d8daaa2", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/6872e91a61aa0b9d7659d657e3a025fe4d8daaa2", "committedDate": "2020-10-14T13:54:54Z", "message": "Immutables switch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e53173d6ebb34e8463a0d2ecb30128524e0d49f", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/9e53173d6ebb34e8463a0d2ecb30128524e0d49f", "committedDate": "2020-10-14T13:54:54Z", "message": "baseline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4faa8e894997cfd6866c6df5c4b8ce6b920d7d48", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/4faa8e894997cfd6866c6df5c4b8ce6b920d7d48", "committedDate": "2020-10-14T13:55:05Z", "message": "fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "737cb578f8beeea72c13d08845f1cac2954e2cf6", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/737cb578f8beeea72c13d08845f1cac2954e2cf6", "committedDate": "2020-10-13T15:25:17Z", "message": "fix"}, "afterCommit": {"oid": "4faa8e894997cfd6866c6df5c4b8ce6b920d7d48", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/4faa8e894997cfd6866c6df5c4b8ce6b920d7d48", "committedDate": "2020-10-14T13:55:05Z", "message": "fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2632, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}