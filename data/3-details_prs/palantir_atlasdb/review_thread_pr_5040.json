{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0NzgyNTYy", "number": 5040, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTo1NDowNFrOEudjgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTo1ODo0M1rOEuds9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MTU0MTc3OnYy", "diffSide": "RIGHT", "path": "changelog/@unreleased/pr-5040.v2.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTo1NDowNFrOHi4Ykw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjo1ODozOFrOHi7ajQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNzQyNw==", "bodyText": "Fix this changelog, please!", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506337427", "createdAt": "2020-10-16T11:54:04Z", "author": {"login": "Jolyon-S"}, "path": "changelog/@unreleased/pr-5040.v2.yml", "diffHunk": "@@ -0,0 +1,24 @@\n+type: improvement\n+improvement:\n+  description: |-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM4NzA4NQ==", "bodyText": "Done", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506387085", "createdAt": "2020-10-16T12:58:38Z", "author": {"login": "jkozlowski"}, "path": "changelog/@unreleased/pr-5040.v2.yml", "diffHunk": "@@ -0,0 +1,24 @@\n+type: improvement\n+improvement:\n+  description: |-", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNzQyNw=="}, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MTU0NDgyOnYy", "diffSide": "RIGHT", "path": "lock-api/src/main/java/com/palantir/lock/watch/LockWatchEventCache.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTo1NDo0MFrOHi4agg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjowODowM1rOHi5ELQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNzkyMg==", "bodyText": "This feels wrong - this should call down to LockWatchEventCacheImpl or NoOpLockWatchEventCache.", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506337922", "createdAt": "2020-10-16T11:54:40Z", "author": {"login": "Jolyon-S"}, "path": "lock-api/src/main/java/com/palantir/lock/watch/LockWatchEventCache.java", "diffHunk": "@@ -21,6 +21,11 @@\n import java.util.Set;\n \n public interface LockWatchEventCache {\n+\n+    default boolean isEnabled() {\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0MDg5OA==", "bodyText": "Oh I see - you went with an approach entirely through the proxy. I'm not sure I like that really - surely the logic is 100x cleaner just by doing what you originally said, i.e. having LWECI return true and NOLWEC return false?", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506340898", "createdAt": "2020-10-16T11:58:01Z", "author": {"login": "Jolyon-S"}, "path": "lock-api/src/main/java/com/palantir/lock/watch/LockWatchEventCache.java", "diffHunk": "@@ -21,6 +21,11 @@\n import java.util.Set;\n \n public interface LockWatchEventCache {\n+\n+    default boolean isEnabled() {\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNzkyMg=="}, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0ODU4OQ==", "bodyText": "Discussed offline", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506348589", "createdAt": "2020-10-16T12:08:03Z", "author": {"login": "jkozlowski"}, "path": "lock-api/src/main/java/com/palantir/lock/watch/LockWatchEventCache.java", "diffHunk": "@@ -21,6 +21,11 @@\n import java.util.Set;\n \n public interface LockWatchEventCache {\n+\n+    default boolean isEnabled() {\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzNzkyMg=="}, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MTU1MDA2OnYy", "diffSide": "RIGHT", "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCacheTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTo1NTozMVrOHi4dwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMzowMzowNFrOHi7mrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzODc1NA==", "bodyText": "do you mind expanding this test with hasMessage as there are a number of exceptions under that class (I know I am guilty of this too, but in an effort to make it clearer what we are testing, this should be done).", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506338754", "createdAt": "2020-10-16T11:55:31Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCacheTest.java", "diffHunk": "@@ -54,6 +56,21 @@ public void before() {\n         proxyCache = ResilientLockWatchEventCache.newProxyInstance(defaultCache, fallbackCache, metricsManager);\n     }\n \n+    @Test\n+    public void testCanDelegateIsEnabled() {\n+        assertThat(proxyCache.isEnabled()).isTrue();\n+\n+        RuntimeException runtimeException = new RuntimeException();\n+        when(defaultCache.getCommitUpdate(anyLong())).thenThrow(runtimeException);\n+        assertThatThrownBy(() -> proxyCache.getCommitUpdate(0L)).hasCause(runtimeException)\n+                .isExactlyInstanceOf(TransactionLockWatchFailedException.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM4NzY1Mg==", "bodyText": "Nope, ResilientLockWatchEventCache has just one from what I can see?", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506387652", "createdAt": "2020-10-16T12:59:30Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCacheTest.java", "diffHunk": "@@ -54,6 +56,21 @@ public void before() {\n         proxyCache = ResilientLockWatchEventCache.newProxyInstance(defaultCache, fallbackCache, metricsManager);\n     }\n \n+    @Test\n+    public void testCanDelegateIsEnabled() {\n+        assertThat(proxyCache.isEnabled()).isTrue();\n+\n+        RuntimeException runtimeException = new RuntimeException();\n+        when(defaultCache.getCommitUpdate(anyLong())).thenThrow(runtimeException);\n+        assertThatThrownBy(() -> proxyCache.getCommitUpdate(0L)).hasCause(runtimeException)\n+                .isExactlyInstanceOf(TransactionLockWatchFailedException.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzODc1NA=="}, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5MDE5MQ==", "bodyText": "Ah yea, I see you're just throwing a generic exception instead of actually causing a legit exception inside LWECI.", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506390191", "createdAt": "2020-10-16T13:03:04Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCacheTest.java", "diffHunk": "@@ -54,6 +56,21 @@ public void before() {\n         proxyCache = ResilientLockWatchEventCache.newProxyInstance(defaultCache, fallbackCache, metricsManager);\n     }\n \n+    @Test\n+    public void testCanDelegateIsEnabled() {\n+        assertThat(proxyCache.isEnabled()).isTrue();\n+\n+        RuntimeException runtimeException = new RuntimeException();\n+        when(defaultCache.getCommitUpdate(anyLong())).thenThrow(runtimeException);\n+        assertThatThrownBy(() -> proxyCache.getCommitUpdate(0L)).hasCause(runtimeException)\n+                .isExactlyInstanceOf(TransactionLockWatchFailedException.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzODc1NA=="}, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MTU1NjIzOnYy", "diffSide": "RIGHT", "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManager.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTo1Njo0MFrOHi4hwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMzowNTozNVrOHi7u4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzOTc3Ng==", "bodyText": "Why is this necessary? Also, if we're going to default to anything, wouldn't it be better to be false? I still think this should just be:\nboolean isEnabled;", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506339776", "createdAt": "2020-10-16T11:56:40Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManager.java", "diffHunk": "@@ -34,6 +34,10 @@\n \n     // These methods are hidden on purpose as they should not be generally available, only for brave souls!\n \n+    boolean isEnabled() {\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0OTIyNQ==", "bodyText": "I don\u2019t think it matters, I just went with this approach.", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506349225", "createdAt": "2020-10-16T12:08:51Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManager.java", "diffHunk": "@@ -34,6 +34,10 @@\n \n     // These methods are hidden on purpose as they should not be generally available, only for brave souls!\n \n+    boolean isEnabled() {\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzOTc3Ng=="}, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM4OTQzOA==", "bodyText": "I still think we should not set this - I'd rather never, ever have to debug another bug like that auto-delegate, and while I know this is very different, it's just less error-prone to not set a default.", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506389438", "createdAt": "2020-10-16T13:01:55Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManager.java", "diffHunk": "@@ -34,6 +34,10 @@\n \n     // These methods are hidden on purpose as they should not be generally available, only for brave souls!\n \n+    boolean isEnabled() {\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzOTc3Ng=="}, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM4OTc2Mg==", "bodyText": "(I know you have a test for it, but still).", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506389762", "createdAt": "2020-10-16T13:02:21Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManager.java", "diffHunk": "@@ -34,6 +34,10 @@\n \n     // These methods are hidden on purpose as they should not be generally available, only for brave souls!\n \n+    boolean isEnabled() {\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzOTc3Ng=="}, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM5MjI5MA==", "bodyText": "Done", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506392290", "createdAt": "2020-10-16T13:05:35Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-api/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchManager.java", "diffHunk": "@@ -34,6 +34,10 @@\n \n     // These methods are hidden on purpose as they should not be generally available, only for brave souls!\n \n+    boolean isEnabled() {\n+        return true;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjMzOTc3Ng=="}, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MTU2NTk5OnYy", "diffSide": "RIGHT", "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCache.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMTo1ODo0M1rOHi4oWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjowOTowNlrOHi5Hkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0MTQ2NA==", "bodyText": "I don't really like this - I much prefer just implementing in LWECI and NOLWEC as I feel it is less error prone, and doing this kind of proxy-wrangling is abusing the whole point of it IMO.", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506341464", "createdAt": "2020-10-16T11:58:43Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCache.java", "diffHunk": "@@ -34,6 +34,15 @@\n final class ResilientLockWatchEventCache extends AbstractInvocationHandler {\n \n     private static final Logger log = LoggerFactory.getLogger(ResilientLockWatchEventCache.class);\n+    private static final Method IS_ENABLED;\n+\n+    static {\n+        try {\n+            IS_ENABLED = LockWatchEventCache.class.getMethod(\"isEnabled\");\n+        } catch (NoSuchMethodException e) {\n+            throw new RuntimeException(\"Did someone rename this method?\", e);\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0OTQ1OA==", "bodyText": "Discussed offline", "url": "https://github.com/palantir/atlasdb/pull/5040#discussion_r506349458", "createdAt": "2020-10-16T12:09:06Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ResilientLockWatchEventCache.java", "diffHunk": "@@ -34,6 +34,15 @@\n final class ResilientLockWatchEventCache extends AbstractInvocationHandler {\n \n     private static final Logger log = LoggerFactory.getLogger(ResilientLockWatchEventCache.class);\n+    private static final Method IS_ENABLED;\n+\n+    static {\n+        try {\n+            IS_ENABLED = LockWatchEventCache.class.getMethod(\"isEnabled\");\n+        } catch (NoSuchMethodException e) {\n+            throw new RuntimeException(\"Did someone rename this method?\", e);\n+        }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM0MTQ2NA=="}, "originalCommit": {"oid": "d56dbe8ef4f9a7acce2d5730ceee415704aa2549"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2647, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}