{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NzYzMzE1", "number": 4812, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMDo1NzowMVrOEA2Lxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMTowNzozNFrOEA2W3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MzIzMjA3OnYy", "diffSide": "RIGHT", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/AtlasDbDialogueServiceProvider.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMDo1NzowMVrOGcYJuw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMDo1NzowMVrOGcYJuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQwOTAxOQ==", "bodyText": "This is cool, but I'd name it composeWith or combineWith", "url": "https://github.com/palantir/atlasdb/pull/4812#discussion_r432409019", "createdAt": "2020-05-29T10:57:01Z", "author": {"login": "gmaretic"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/AtlasDbDialogueServiceProvider.java", "diffHunk": "@@ -100,6 +108,52 @@ ConjureTimelockService getConjureTimelockService() {\n         return new TimeoutSensitiveConjureTimelockService(shortAndLongTimeoutServices);\n     }\n \n+    TimestampManagementRpcClient getTimestampManagementRpcClient() {\n+        return createDialogueProxyWithShortTimeout(TimestampManagementRpcClient.class);\n+    }\n+\n+    LockRpcClient getLockRpcClient() {\n+        ConjureLockV1ServiceBlocking shortTimeoutDialogueService\n+                = dialogueClientFactory.get(ConjureLockV1ServiceBlocking.class, TIMELOCK_SHORT_TIMEOUT);\n+        ConjureLockV1ServiceBlocking longTimeoutDialogueService\n+                = dialogueClientFactory.get(ConjureLockV1ServiceBlocking.class, TIMELOCK_LONG_TIMEOUT);\n+\n+        ShortAndLongTimeoutServices<LockRpcClient> legacyRpcClients\n+                = ImmutableShortAndLongTimeoutServices.<LockRpcClient>builder()\n+                .shortTimeout(createDialogueProxyWithShortTimeout(LockRpcClient.class))\n+                .longTimeout(createDialogueProxyWithLongTimeout(LockRpcClient.class))\n+                .build();\n+\n+        return new TimeoutSensitiveLockRpcClient(\n+                ImmutableShortAndLongTimeoutServices.<ConjureLockV1ServiceBlocking>builder()\n+                        .shortTimeout(shortTimeoutDialogueService)\n+                        .longTimeout(longTimeoutDialogueService)\n+                        .build()\n+                        .map(proxy -> FastFailoverProxy.newProxyInstance(\n+                                ConjureLockV1ServiceBlocking.class, () -> proxy))\n+                        .map(service -> AtlasDbMetrics.instrumentWithTaggedMetrics(\n+                                taggedMetricRegistry,\n+                                ConjureLockV1ServiceBlocking.class,\n+                                service))\n+                        .zipWith(legacyRpcClients, DialogueComposingLockRpcClient::new));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e441c30681bda636f2e2ca9aea5f1305652c381"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MzI0NTg0OnYy", "diffSide": "RIGHT", "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/timelock/ShortAndLongTimeoutServicesTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMTowMTo1NFrOGcYSYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMTowMTo1NFrOGcYSYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQxMTIzMg==", "bodyText": "\ud83c\udf89", "url": "https://github.com/palantir/atlasdb/pull/4812#discussion_r432411232", "createdAt": "2020-05-29T11:01:54Z", "author": {"login": "gmaretic"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/timelock/ShortAndLongTimeoutServicesTest.java", "diffHunk": "@@ -57,4 +58,38 @@ public void mapOperatesOnCorrespondingElements() {\n         assertThat(strings.shortTimeout()).isEqualTo(\"1\");\n         assertThat(strings.longTimeout()).isEqualTo(\"3\");\n     }\n+\n+    @Test\n+    public void zipWithZipsCorrectElements() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e441c30681bda636f2e2ca9aea5f1305652c381"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5MzI2MDQ3OnYy", "diffSide": "RIGHT", "path": "atlasdb-ete-tests/src/main/java/com/palantir/atlasdb/lock/SimpleLockResource.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMTowNzozNFrOGcYb0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQwOToxODo1NVrOGe9IGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQxMzY0OA==", "bodyText": "This is a behaviour change, but it should be fine for existing tests. I guess this was done to reuse existing tests to test the pure dialogue methods?", "url": "https://github.com/palantir/atlasdb/pull/4812#discussion_r432413648", "createdAt": "2020-05-29T11:07:34Z", "author": {"login": "gmaretic"}, "path": "atlasdb-ete-tests/src/main/java/com/palantir/atlasdb/lock/SimpleLockResource.java", "diffHunk": "@@ -60,9 +61,9 @@ public boolean lockUsingLegacyLockApi(int numLocks, int descriptorSize) {\n                 .builder(generateDescriptorMap(numLocks, descriptorSize))\n                 .build();\n         try {\n-            LockRefreshToken response = transactionManager.getLockService().lock(\"test\", request);\n+            HeldLocksToken response = transactionManager.getLockService().lockAndGetHeldLocks(\"test\", request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e441c30681bda636f2e2ca9aea5f1305652c381"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTExMTk2MA==", "bodyText": "Yep, this now goes through the Dialogue methods as you say. This is only in the ETE server, as well", "url": "https://github.com/palantir/atlasdb/pull/4812#discussion_r435111960", "createdAt": "2020-06-04T09:18:55Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-ete-tests/src/main/java/com/palantir/atlasdb/lock/SimpleLockResource.java", "diffHunk": "@@ -60,9 +61,9 @@ public boolean lockUsingLegacyLockApi(int numLocks, int descriptorSize) {\n                 .builder(generateDescriptorMap(numLocks, descriptorSize))\n                 .build();\n         try {\n-            LockRefreshToken response = transactionManager.getLockService().lock(\"test\", request);\n+            HeldLocksToken response = transactionManager.getLockService().lockAndGetHeldLocks(\"test\", request);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQxMzY0OA=="}, "originalCommit": {"oid": "8e441c30681bda636f2e2ca9aea5f1305652c381"}, "originalPosition": 17}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2916, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}