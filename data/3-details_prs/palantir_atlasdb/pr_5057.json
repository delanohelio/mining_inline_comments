{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2ODg5MTY5", "number": 5057, "title": "[TimeLock corruption detection] | Timestamp corruption checks", "bodyText": "Goals (and why):\nAdds Timestamp corruption indicating checks. The checks analyze history from local and all remotes servers and determine if there are signs of corruption.\nImplementation Description (bullets):\nImplements following (per round) corruption checks\n\n\nLearned values for any round are same across all nodes\n\n\nLearned value is accepted by quorum of nodes\n\n\nIn a round, greatest accepted value <= learned value\n\n\nAlso, refactors utils for tests.\nTesting (What was existing testing like?  What have you done to improve it?):\nAdded tests\nConcerns (what feedback would you like?):\n\n\nDo the checks seem reasonable?\n\n\nAre there more checks that can be added?\n\n\nDid I miss something that would cause false alerts?\n\n\nWhere should we start reviewing?:\nHistoryAnalyzer\n\nThe wiring is not there, so please only review the logical checks\n\nPriority (whenever / two weeks / yesterday):\nASAP \ud83c\udfc3\u200d\u2640\ufe0f", "createdAt": "2020-10-20T15:09:10Z", "url": "https://github.com/palantir/atlasdb/pull/5057", "merged": true, "mergeCommit": {"oid": "2c2cbf8effd1501e58b1fb17113d1c384c250d3c"}, "closed": true, "closedAt": "2020-10-21T19:32:06Z", "author": {"login": "sudiksha27"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUaYSjgBqjM4OTkzNDM2NzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUwJLFgFqTUxMzkyNTk0Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c6f42dfbd61f14fba33426a1310f0cb333d954ac", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/c6f42dfbd61f14fba33426a1310f0cb333d954ac", "committedDate": "2020-10-20T15:10:05Z", "message": "Minor cleanup"}, "afterCommit": {"oid": "cd3a6bc64312db14acd4de45d156a05ed82bed71", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/cd3a6bc64312db14acd4de45d156a05ed82bed71", "committedDate": "2020-10-20T15:19:27Z", "message": "Minor cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce6197e3e8e44f7000bbf8f4cbd647bd86294242", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/ce6197e3e8e44f7000bbf8f4cbd647bd86294242", "committedDate": "2020-10-21T13:10:37Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2aacd4c61abb7e955bf659b949eb69ca0e4fad6f", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/2aacd4c61abb7e955bf659b949eb69ca0e4fad6f", "committedDate": "2020-10-21T13:10:37Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa56b4c9490c001675420f46b547cbc748959718", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/aa56b4c9490c001675420f46b547cbc748959718", "committedDate": "2020-10-21T13:10:37Z", "message": "Minor cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed0360860d2a36ed5fbf9771e077508d8c8c034b", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/ed0360860d2a36ed5fbf9771e077508d8c8c034b", "committedDate": "2020-10-21T13:10:37Z", "message": "Remove redundant changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6275567d73edd1c703728409673d336d73201c00", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/6275567d73edd1c703728409673d336d73201c00", "committedDate": "2020-10-21T13:10:37Z", "message": "Minor refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfeb521e3c8671c1b078663570bedde6b5ce5f32", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/cfeb521e3c8671c1b078663570bedde6b5ce5f32", "committedDate": "2020-10-21T13:10:37Z", "message": "Refine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9625b497fed5eacb49e6bac482ab5437921a0759", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/9625b497fed5eacb49e6bac482ab5437921a0759", "committedDate": "2020-10-21T13:10:37Z", "message": "Fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f42e07c8afe1d0cffce634b3a9f24695dfcc8599", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/f42e07c8afe1d0cffce634b3a9f24695dfcc8599", "committedDate": "2020-10-20T17:09:41Z", "message": "Fix"}, "afterCommit": {"oid": "9625b497fed5eacb49e6bac482ab5437921a0759", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/9625b497fed5eacb49e6bac482ab5437921a0759", "committedDate": "2020-10-21T13:10:37Z", "message": "Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0174e6e7ca771943ba587d1f35485d98eda28f95", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/0174e6e7ca771943ba587d1f35485d98eda28f95", "committedDate": "2020-10-21T13:24:32Z", "message": "Fix test build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzODM3OTYy", "url": "https://github.com/palantir/atlasdb/pull/5057#pullrequestreview-513837962", "createdAt": "2020-10-21T15:49:30Z", "commit": {"oid": "0174e6e7ca771943ba587d1f35485d98eda28f95"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTo0OTozMVrOHlzcvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNTo1NDo0N1rOHlzsRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQwMjMwMQ==", "bodyText": "Let's not return boolean: would be good to have some kind of wrapper type", "url": "https://github.com/palantir/atlasdb/pull/5057#discussion_r509402301", "createdAt": "2020-10-21T15:49:31Z", "author": {"login": "jeremyk-91"}, "path": "timelock-corruption-detection/src/main/java/com/palantir/timelock/corruption/detection/HistoryAnalyzer.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.timelock.corruption.detection;\n+\n+\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.Iterables;\n+import com.palantir.atlasdb.encoding.PtBytes;\n+import com.palantir.paxos.PaxosValue;\n+import com.palantir.timelock.history.PaxosAcceptorData;\n+import com.palantir.timelock.history.models.CompletePaxosHistoryForNamespaceAndUseCase;\n+import com.palantir.timelock.history.models.ConsolidatedLearnerAndAcceptorRecord;\n+\n+public final class HistoryAnalyzer {\n+\n+    public static boolean runCorruptionCheckOnHistory(CompletePaxosHistoryForNamespaceAndUseCase history) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0174e6e7ca771943ba587d1f35485d98eda28f95"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQwMzY5MQ==", "bodyText": "I'd extract a method for this. Depending on taste, you could also process the stream more aggressively and/or use keyed-streams", "url": "https://github.com/palantir/atlasdb/pull/5057#discussion_r509403691", "createdAt": "2020-10-21T15:51:17Z", "author": {"login": "jeremyk-91"}, "path": "timelock-corruption-detection/src/main/java/com/palantir/timelock/corruption/detection/HistoryAnalyzer.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.timelock.corruption.detection;\n+\n+\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.Iterables;\n+import com.palantir.atlasdb.encoding.PtBytes;\n+import com.palantir.paxos.PaxosValue;\n+import com.palantir.timelock.history.PaxosAcceptorData;\n+import com.palantir.timelock.history.models.CompletePaxosHistoryForNamespaceAndUseCase;\n+import com.palantir.timelock.history.models.ConsolidatedLearnerAndAcceptorRecord;\n+\n+public final class HistoryAnalyzer {\n+\n+    public static boolean runCorruptionCheckOnHistory(CompletePaxosHistoryForNamespaceAndUseCase history) {\n+        return verifyLearnersHaveLearnedSameValues(history)\n+        && verifyLearnedValueWasAcceptedByQuorum(history)\n+        && verifyLearnedValueIsGreatestAcceptedValue(history);\n+    }\n+\n+    @VisibleForTesting\n+    static boolean verifyLearnersHaveLearnedSameValues(CompletePaxosHistoryForNamespaceAndUseCase history) {\n+        List<ConsolidatedLearnerAndAcceptorRecord> records = history.localAndRemoteLearnerAndAcceptorRecords();\n+        return history.getAllSequenceNumbers()\n+                .stream()\n+                .allMatch(seq -> {\n+                    Set<PaxosValue> learnedValuesForRound = getLearnedValuesForRound(records, seq);\n+                    return learnedValuesForRound.size() <= 1;\n+                });\n+    }\n+\n+    @VisibleForTesting\n+    static boolean verifyLearnedValueWasAcceptedByQuorum(CompletePaxosHistoryForNamespaceAndUseCase history) {\n+        List<ConsolidatedLearnerAndAcceptorRecord> records = history.localAndRemoteLearnerAndAcceptorRecords();\n+        int quorum = getQuorumSize(records);\n+\n+        return history.getAllSequenceNumbers()\n+                .stream()\n+                .allMatch(seq -> {\n+                    Optional<PaxosValue> optionalLearnedValue = getLearnedValue(records, seq);\n+                    if(!optionalLearnedValue.isPresent()) {\n+                        return true;\n+                    }\n+\n+                    PaxosValue learnedValue = optionalLearnedValue.get();\n+                    List<PaxosValue> acceptedValues = getAcceptedValues(records, seq, learnedValue);\n+                    return acceptedValues.size() >= quorum;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0174e6e7ca771943ba587d1f35485d98eda28f95"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQwMzk3OQ==", "bodyText": "if this is a bug in atlas code we should probably throw a SafeIllegalStateException", "url": "https://github.com/palantir/atlasdb/pull/5057#discussion_r509403979", "createdAt": "2020-10-21T15:51:41Z", "author": {"login": "jeremyk-91"}, "path": "timelock-corruption-detection/src/main/java/com/palantir/timelock/corruption/detection/HistoryAnalyzer.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.timelock.corruption.detection;\n+\n+\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.Iterables;\n+import com.palantir.atlasdb.encoding.PtBytes;\n+import com.palantir.paxos.PaxosValue;\n+import com.palantir.timelock.history.PaxosAcceptorData;\n+import com.palantir.timelock.history.models.CompletePaxosHistoryForNamespaceAndUseCase;\n+import com.palantir.timelock.history.models.ConsolidatedLearnerAndAcceptorRecord;\n+\n+public final class HistoryAnalyzer {\n+\n+    public static boolean runCorruptionCheckOnHistory(CompletePaxosHistoryForNamespaceAndUseCase history) {\n+        return verifyLearnersHaveLearnedSameValues(history)\n+        && verifyLearnedValueWasAcceptedByQuorum(history)\n+        && verifyLearnedValueIsGreatestAcceptedValue(history);\n+    }\n+\n+    @VisibleForTesting\n+    static boolean verifyLearnersHaveLearnedSameValues(CompletePaxosHistoryForNamespaceAndUseCase history) {\n+        List<ConsolidatedLearnerAndAcceptorRecord> records = history.localAndRemoteLearnerAndAcceptorRecords();\n+        return history.getAllSequenceNumbers()\n+                .stream()\n+                .allMatch(seq -> {\n+                    Set<PaxosValue> learnedValuesForRound = getLearnedValuesForRound(records, seq);\n+                    return learnedValuesForRound.size() <= 1;\n+                });\n+    }\n+\n+    @VisibleForTesting\n+    static boolean verifyLearnedValueWasAcceptedByQuorum(CompletePaxosHistoryForNamespaceAndUseCase history) {\n+        List<ConsolidatedLearnerAndAcceptorRecord> records = history.localAndRemoteLearnerAndAcceptorRecords();\n+        int quorum = getQuorumSize(records);\n+\n+        return history.getAllSequenceNumbers()\n+                .stream()\n+                .allMatch(seq -> {\n+                    Optional<PaxosValue> optionalLearnedValue = getLearnedValue(records, seq);\n+                    if(!optionalLearnedValue.isPresent()) {\n+                        return true;\n+                    }\n+\n+                    PaxosValue learnedValue = optionalLearnedValue.get();\n+                    List<PaxosValue> acceptedValues = getAcceptedValues(records, seq, learnedValue);\n+                    return acceptedValues.size() >= quorum;\n+                });\n+    }\n+\n+    @VisibleForTesting\n+    static boolean verifyLearnedValueIsGreatestAcceptedValue(CompletePaxosHistoryForNamespaceAndUseCase history) {\n+        List<ConsolidatedLearnerAndAcceptorRecord> records = history.localAndRemoteLearnerAndAcceptorRecords();\n+        return history.getAllSequenceNumbers()\n+                .stream()\n+                .allMatch(seq -> learnedValueIsGreatestAcceptedValue(records, seq));\n+    }\n+\n+    private static boolean learnedValueIsGreatestAcceptedValue(\n+            List<ConsolidatedLearnerAndAcceptorRecord> records, Long seq) {\n+        byte[] learnedValueData = getPaxosValueData(getLearnedValue(records, seq));\n+        if (learnedValueData == null) {\n+            return true;\n+        }\n+\n+        byte[] greatestAcceptedValueData = getPaxosValueData(getGreatestAcceptedValueAtSequence(records, seq));\n+        if (greatestAcceptedValueData == null) {\n+            // should not reach here\n+            return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0174e6e7ca771943ba587d1f35485d98eda28f95"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQwNTkyMg==", "bodyText": "Let's have a comment here that this should only be used for timestamp bound checks: this would behave strangely if we did it on leader election based checks, because there is a semantic difference between null and no agreement because paxos phase two didn't happen", "url": "https://github.com/palantir/atlasdb/pull/5057#discussion_r509405922", "createdAt": "2020-10-21T15:54:18Z", "author": {"login": "jeremyk-91"}, "path": "timelock-corruption-detection/src/main/java/com/palantir/timelock/corruption/detection/HistoryAnalyzer.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.timelock.corruption.detection;\n+\n+\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.collect.Iterables;\n+import com.palantir.atlasdb.encoding.PtBytes;\n+import com.palantir.paxos.PaxosValue;\n+import com.palantir.timelock.history.PaxosAcceptorData;\n+import com.palantir.timelock.history.models.CompletePaxosHistoryForNamespaceAndUseCase;\n+import com.palantir.timelock.history.models.ConsolidatedLearnerAndAcceptorRecord;\n+\n+public final class HistoryAnalyzer {\n+\n+    public static boolean runCorruptionCheckOnHistory(CompletePaxosHistoryForNamespaceAndUseCase history) {\n+        return verifyLearnersHaveLearnedSameValues(history)\n+        && verifyLearnedValueWasAcceptedByQuorum(history)\n+        && verifyLearnedValueIsGreatestAcceptedValue(history);\n+    }\n+\n+    @VisibleForTesting\n+    static boolean verifyLearnersHaveLearnedSameValues(CompletePaxosHistoryForNamespaceAndUseCase history) {\n+        List<ConsolidatedLearnerAndAcceptorRecord> records = history.localAndRemoteLearnerAndAcceptorRecords();\n+        return history.getAllSequenceNumbers()\n+                .stream()\n+                .allMatch(seq -> {\n+                    Set<PaxosValue> learnedValuesForRound = getLearnedValuesForRound(records, seq);\n+                    return learnedValuesForRound.size() <= 1;\n+                });\n+    }\n+\n+    @VisibleForTesting\n+    static boolean verifyLearnedValueWasAcceptedByQuorum(CompletePaxosHistoryForNamespaceAndUseCase history) {\n+        List<ConsolidatedLearnerAndAcceptorRecord> records = history.localAndRemoteLearnerAndAcceptorRecords();\n+        int quorum = getQuorumSize(records);\n+\n+        return history.getAllSequenceNumbers()\n+                .stream()\n+                .allMatch(seq -> {\n+                    Optional<PaxosValue> optionalLearnedValue = getLearnedValue(records, seq);\n+                    if(!optionalLearnedValue.isPresent()) {\n+                        return true;\n+                    }\n+\n+                    PaxosValue learnedValue = optionalLearnedValue.get();\n+                    List<PaxosValue> acceptedValues = getAcceptedValues(records, seq, learnedValue);\n+                    return acceptedValues.size() >= quorum;\n+                });\n+    }\n+\n+    @VisibleForTesting\n+    static boolean verifyLearnedValueIsGreatestAcceptedValue(CompletePaxosHistoryForNamespaceAndUseCase history) {\n+        List<ConsolidatedLearnerAndAcceptorRecord> records = history.localAndRemoteLearnerAndAcceptorRecords();\n+        return history.getAllSequenceNumbers()\n+                .stream()\n+                .allMatch(seq -> learnedValueIsGreatestAcceptedValue(records, seq));\n+    }\n+\n+    private static boolean learnedValueIsGreatestAcceptedValue(\n+            List<ConsolidatedLearnerAndAcceptorRecord> records, Long seq) {\n+        byte[] learnedValueData = getPaxosValueData(getLearnedValue(records, seq));\n+        if (learnedValueData == null) {\n+            return true;\n+        }\n+\n+        byte[] greatestAcceptedValueData = getPaxosValueData(getGreatestAcceptedValueAtSequence(records, seq));\n+        if (greatestAcceptedValueData == null) {\n+            // should not reach here\n+            return false;\n+        }\n+        return PtBytes.toLong(greatestAcceptedValueData) <= PtBytes.toLong(learnedValueData);\n+    }\n+\n+    private static Optional<PaxosValue> getLearnedValue(List<ConsolidatedLearnerAndAcceptorRecord> recordList, Long seq) {\n+        Set<PaxosValue> values = getLearnedValuesForRound(recordList, seq);\n+        return values.isEmpty() ? Optional.empty() : Optional.of(Iterables.getOnlyElement(values));\n+    }\n+\n+    private static Set<PaxosValue> getLearnedValuesForRound(List<ConsolidatedLearnerAndAcceptorRecord> recordList,\n+            Long seq) {\n+        return recordList.stream()\n+                .map(consolidatedLearnerAndAcceptorRecord ->\n+                        consolidatedLearnerAndAcceptorRecord.get(seq).learnedValue())\n+                .filter(Optional::isPresent)\n+                .map(Optional::get)\n+                .collect(Collectors.toSet());\n+    }\n+\n+    private static int getQuorumSize(List<ConsolidatedLearnerAndAcceptorRecord> records) {\n+        return records.size() / 2 + 1;\n+    }\n+\n+    private static List<PaxosValue> getAcceptedValues(List<ConsolidatedLearnerAndAcceptorRecord> records, Long seq,\n+            PaxosValue learnedValue) {\n+        return records.stream()\n+                .map(record -> record.get(seq)\n+                        .acceptedValue()\n+                        .map(PaxosAcceptorData::getLastAcceptedValue)\n+                        .orElseGet(Optional::empty))\n+                .filter(optionalPaxosValue ->\n+                        optionalPaxosValue.isPresent() && optionalPaxosValue.get().equals(learnedValue))\n+                .map(Optional::get)\n+                .collect(Collectors.toList());\n+    }\n+\n+    private static Optional<PaxosValue> getGreatestAcceptedValueAtSequence(\n+            List<ConsolidatedLearnerAndAcceptorRecord> records, long seq) {\n+        return records.stream()\n+                .map(record -> record.get(seq)\n+                        .acceptedValue()\n+                        .map(PaxosAcceptorData::getLastAcceptedValue)\n+                        .orElseGet(Optional::empty))\n+                .filter(paxosValue -> getPaxosValueData(paxosValue) != null)\n+                .map(Optional::get)\n+                .max(Comparator.comparingLong(paxosValue ->  PtBytes.toLong(paxosValue.getData())));\n+    }\n+\n+\n+    private static byte[] getPaxosValueData(Optional<PaxosValue> learnedValue) {\n+        return learnedValue.map(PaxosValue::getData).orElse(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0174e6e7ca771943ba587d1f35485d98eda28f95"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQwNjI3Nw==", "bodyText": "\ud83d\ude05", "url": "https://github.com/palantir/atlasdb/pull/5057#discussion_r509406277", "createdAt": "2020-10-21T15:54:47Z", "author": {"login": "jeremyk-91"}, "path": "timelock-corruption-detection/src/test/java/com/palantir/timelock/corruption/detection/HistoryAnalyzerTest.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.timelock.corruption.detection;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import javax.sql.DataSource;\n+\n+import org.immutables.value.Value;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.collect.Iterables;\n+import com.palantir.paxos.Client;\n+import com.palantir.paxos.ImmutableNamespaceAndUseCase;\n+import com.palantir.paxos.PaxosAcceptorState;\n+import com.palantir.paxos.PaxosStateLog;\n+import com.palantir.paxos.PaxosValue;\n+import com.palantir.paxos.SqliteConnections;\n+import com.palantir.paxos.SqlitePaxosStateLog;\n+import com.palantir.timelock.history.LocalHistoryLoader;\n+import com.palantir.timelock.history.PaxosLogHistoryProvider;\n+import com.palantir.timelock.history.TimeLockPaxosHistoryProvider;\n+import com.palantir.timelock.history.models.AcceptorUseCase;\n+import com.palantir.timelock.history.models.CompletePaxosHistoryForNamespaceAndUseCase;\n+import com.palantir.timelock.history.models.LearnerUseCase;\n+import com.palantir.timelock.history.remote.TimeLockPaxosHistoryProviderResource;\n+import com.palantir.timelock.history.sqlite.SqlitePaxosStateLogHistory;\n+import com.palantir.timelock.history.utils.PaxosSerializationTestUtils;\n+\n+public class HistoryAnalyzerTest {\n+    @Rule\n+    public TemporaryFolder tempFolder = new TemporaryFolder();\n+\n+    private static final Client CLIENT = Client.of(\"client\");\n+    private static final String USE_CASE = \"useCase\";\n+    private static final String USE_CASE_LEARNER = LearnerUseCase.createLearnerUseCase(USE_CASE).value();\n+    private static final String USE_CASE_ACCEPTOR = AcceptorUseCase.createAcceptorUseCase(USE_CASE).value();\n+\n+    private StateLogComponents localStateLogComponents;\n+    private List<StateLogComponents> remoteStateLogComponents;\n+    PaxosLogHistoryProvider paxosLogHistoryProvider;\n+\n+    @Before\n+    public void setup() throws IOException {\n+        localStateLogComponents = createShitForServer(\"randomFile1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0174e6e7ca771943ba587d1f35485d98eda28f95"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "267c859a3440507b06b3a6856f0f5cfc132f7c6d", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/267c859a3440507b06b3a6856f0f5cfc132f7c6d", "committedDate": "2020-10-21T16:07:35Z", "message": "Address comments - 1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b03c1e6872f3c859bd0cfdf3a7f71f2835370ee", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/6b03c1e6872f3c859bd0cfdf3a7f71f2835370ee", "committedDate": "2020-10-21T16:13:06Z", "message": "Fix build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzODc0MzI4", "url": "https://github.com/palantir/atlasdb/pull/5057#pullrequestreview-513874328", "createdAt": "2020-10-21T16:17:43Z", "commit": {"oid": "267c859a3440507b06b3a6856f0f5cfc132f7c6d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNjoxNzo0M1rOHl0sGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNjoxNzo0M1rOHl0sGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQyMjYxNg==", "bodyText": "This is empty if everyone is healthy. Is that by design? (If so that's fine, just make sure it is!)", "url": "https://github.com/palantir/atlasdb/pull/5057#discussion_r509422616", "createdAt": "2020-10-21T16:17:43Z", "author": {"login": "jeremyk-91"}, "path": "timelock-corruption-detection/src/main/java/com/palantir/timelock/corruption/detection/HistoryAnalyzer.java", "diffHunk": "@@ -16,65 +16,74 @@\n \n package com.palantir.timelock.corruption.detection;\n \n-\n-import java.util.Comparator;\n-import java.util.List;\n-import java.util.Optional;\n-import java.util.Set;\n-import java.util.stream.Collectors;\n-\n import com.google.common.annotations.VisibleForTesting;\n import com.google.common.collect.Iterables;\n import com.palantir.atlasdb.encoding.PtBytes;\n+import com.palantir.logsafe.Preconditions;\n import com.palantir.paxos.PaxosValue;\n import com.palantir.timelock.history.PaxosAcceptorData;\n import com.palantir.timelock.history.models.CompletePaxosHistoryForNamespaceAndUseCase;\n import com.palantir.timelock.history.models.ConsolidatedLearnerAndAcceptorRecord;\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n \n public final class HistoryAnalyzer {\n \n-    public static boolean runCorruptionCheckOnHistory(CompletePaxosHistoryForNamespaceAndUseCase history) {\n-        return verifyLearnersHaveLearnedSameValues(history)\n-        && verifyLearnedValueWasAcceptedByQuorum(history)\n-        && verifyLearnedValueIsGreatestAcceptedValue(history);\n+    public static List<CorruptionStatus> corruptionStateForNamespaceAndUseCase(\n+            CompletePaxosHistoryForNamespaceAndUseCase history) {\n+        return Stream.of(learnersHaveLearnedSameValues(history),\n+                learnedValueWasAcceptedByQuorum(history),\n+                learnedValueIsGreatestAcceptedValue(history))\n+                .filter(status -> status != CorruptionStatus.HEALTHY)\n+                .collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "267c859a3440507b06b3a6856f0f5cfc132f7c6d"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzODgwNzk0", "url": "https://github.com/palantir/atlasdb/pull/5057#pullrequestreview-513880794", "createdAt": "2020-10-21T16:20:40Z", "commit": {"oid": "267c859a3440507b06b3a6856f0f5cfc132f7c6d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNjoyMDo0MFrOHl0z4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNjoyMDo0MFrOHl0z4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQyNDYwOA==", "bodyText": "The first 4 are one layer and the bottom 2 are another. I'd suggest having maybe a CorruptionCheckStatus that is one of HEALTHY, DIVERGED_LEARNERS ... and then a CorruptionStatus (this class) just has HEALTHY and the two DEFINITIVE_CORRUPTION ones", "url": "https://github.com/palantir/atlasdb/pull/5057#discussion_r509424608", "createdAt": "2020-10-21T16:20:40Z", "author": {"login": "jeremyk-91"}, "path": "timelock-corruption-detection/src/main/java/com/palantir/timelock/corruption/detection/CorruptionStatus.java", "diffHunk": "@@ -17,16 +17,26 @@\n package com.palantir.timelock.corruption.detection;\n \n public enum CorruptionStatus {\n-    HEALTHY(false),\n-    CORRUPTION(true);\n+    HEALTHY(false, false),\n+    DIVERGED_LEARNERS(true, false), // this is false for now\n+    VALUE_LEARNED_WITHOUT_QUORUM(true, false),\n+    ACCEPTED_VALUE_GREATER_THAN_LEARNED(true, false),\n+    DEFINITIVE_CORRUPTION_DETECTED_BY_LOCAL(true, true),\n+    DEFINITIVE_CORRUPTION_DETECTED_BY_REMOTE(true, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "267c859a3440507b06b3a6856f0f5cfc132f7c6d"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e447559bd5546a17f202d0b0138227904d29878f", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/e447559bd5546a17f202d0b0138227904d29878f", "committedDate": "2020-10-21T16:32:59Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f961e5ea886a15822d0bcc47e0c940aaa1e5122", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/6f961e5ea886a15822d0bcc47e0c940aaa1e5122", "committedDate": "2020-10-21T16:36:09Z", "message": "Refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc5da81bc43d5ca56b72da5701a205538bbf58d9", "author": {"user": {"login": "sudiksha27", "name": "sudiksha nanda"}}, "url": "https://github.com/palantir/atlasdb/commit/bc5da81bc43d5ca56b72da5701a205538bbf58d9", "committedDate": "2020-10-21T16:37:17Z", "message": "Minor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzOTI1OTQ3", "url": "https://github.com/palantir/atlasdb/pull/5057#pullrequestreview-513925947", "createdAt": "2020-10-21T16:41:11Z", "commit": {"oid": "bc5da81bc43d5ca56b72da5701a205538bbf58d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2677, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}