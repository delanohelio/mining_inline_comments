{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMDk4NTQ2", "number": 4493, "title": "Add metrics for off-heap timestamp cache.", "bodyText": "Goals (and why):\nAdd metrics for off-heap cache.\nConcerns (what feedback would you like?):\n\nshould we have any other metrics?\nwould it make sense to split it to multiple classes\n\nPriority (whenever / two weeks / yesterday):\n\nby end of Wednesday", "createdAt": "2020-01-07T17:40:14Z", "url": "https://github.com/palantir/atlasdb/pull/4493", "merged": true, "mergeCommit": {"oid": "3a419bde77db2ffbe90a888f18fd3c3d22a5f547"}, "closed": true, "closedAt": "2020-01-08T14:21:18Z", "author": {"login": "OStevan"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4ETfkAH2gAyMzYwMDk4NTQ2OjI2NDkwMDNiODQ4ZjZiOWY5MzE0NWQyNjJlYTgyYmIyMmJlOWYwYmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4V1B4gFqTMzOTg4MDk3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2649003b848f6b9f93145d262ea82bb22be9f0ba", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/2649003b848f6b9f93145d262ea82bb22be9f0ba", "committedDate": "2020-01-07T17:35:36Z", "message": "Start"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0af52c7a70c99e2ca4bbdbd950e6c80086610cfd", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/0af52c7a70c99e2ca4bbdbd950e6c80086610cfd", "committedDate": "2020-01-07T17:35:36Z", "message": "Metrics."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ca2dad7c4e137d2e4ea81f11228ae8d7cd1c0a4", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/5ca2dad7c4e137d2e4ea81f11228ae8d7cd1c0a4", "committedDate": "2020-01-07T17:35:36Z", "message": "Cache size metric."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NzYwNTY0", "url": "https://github.com/palantir/atlasdb/pull/4493#pullrequestreview-339760564", "createdAt": "2020-01-08T10:07:35Z", "commit": {"oid": "5ca2dad7c4e137d2e4ea81f11228ae8d7cd1c0a4"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMDowNzozNVrOFbSHBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMDoxMDowOFrOFbSLOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE1MjU4MQ==", "bodyText": "Hmm. A meter is plausible here, but it registers a bunch of series that I'm not sure are interesting for an operation that I don't think is super common.", "url": "https://github.com/palantir/atlasdb/pull/4493#discussion_r364152581", "createdAt": "2020-01-08T10:07:35Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/cache/OffHeapTimestampCache.java", "diffHunk": "@@ -126,6 +149,7 @@ private static CacheDescriptor createNamespaceAndConstructCacheProposal(\n         @Override\n         public Map<Map.Entry<Long, Long>, Map.Entry<Long, Long>> apply(Set<Map.Entry<Long, Long>> request) {\n             if (offHeapTimestampCache.cacheDescriptor.get().currentSize().get() >= offHeapTimestampCache.maxSize) {\n+                offHeapTimestampCache.taggedMetricRegistry.meter(CACHE_NUKE).mark();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ca2dad7c4e137d2e4ea81f11228ae8d7cd1c0a4"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE1MzY1OQ==", "bodyText": "I think this needs to reset CACHE_SIZE to 0, or the metric should be something like CACHE_WRITES rather than CACHE_SIZE.", "url": "https://github.com/palantir/atlasdb/pull/4493#discussion_r364153659", "createdAt": "2020-01-08T10:10:08Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/cache/OffHeapTimestampCache.java", "diffHunk": "@@ -126,6 +149,7 @@ private static CacheDescriptor createNamespaceAndConstructCacheProposal(\n         @Override\n         public Map<Map.Entry<Long, Long>, Map.Entry<Long, Long>> apply(Set<Map.Entry<Long, Long>> request) {\n             if (offHeapTimestampCache.cacheDescriptor.get().currentSize().get() >= offHeapTimestampCache.maxSize) {\n+                offHeapTimestampCache.taggedMetricRegistry.meter(CACHE_NUKE).mark();\n                 offHeapTimestampCache.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ca2dad7c4e137d2e4ea81f11228ae8d7cd1c0a4"}, "originalPosition": 108}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7aca1d045e893ad08bae7be581bf60895751f110", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/7aca1d045e893ad08bae7be581bf60895751f110", "committedDate": "2020-01-08T11:15:28Z", "message": "Added resettable counter for cache size metric."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "112761eeb9f2f86d7dd543ce6056c9ca92ee75a4", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/112761eeb9f2f86d7dd543ce6056c9ca92ee75a4", "committedDate": "2020-01-08T11:27:14Z", "message": "Added tests for counter."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a7a7cecba92916ef02f9cea5ddba11416be4561", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/0a7a7cecba92916ef02f9cea5ddba11416be4561", "committedDate": "2020-01-08T11:45:39Z", "message": "Simplified."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5ODE0NjU2", "url": "https://github.com/palantir/atlasdb/pull/4493#pullrequestreview-339814656", "createdAt": "2020-01-08T11:52:08Z", "commit": {"oid": "0a7a7cecba92916ef02f9cea5ddba11416be4561"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMTo1MjowOFrOFbUqXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMTo1MjowOFrOFbUqXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE5NDM5OQ==", "bodyText": "this repeatedly re-registers the gauges", "url": "https://github.com/palantir/atlasdb/pull/4493#discussion_r364194399", "createdAt": "2020-01-08T11:52:08Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-client/src/main/java/com/palantir/atlasdb/cache/OffHeapTimestampCache.java", "diffHunk": "@@ -84,6 +105,7 @@ public void clear() {\n         if (previous != null) {\n             persistentTimestampStore.dropNamespace(previous.storeNamespace());\n         }\n+        taggedMetricRegistry.gauge(CACHE_SIZE, cacheSizeGauge);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a7a7cecba92916ef02f9cea5ddba11416be4561"}, "originalPosition": 83}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a20aa6d748ac0a87433204910a173d3bada27207", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/a20aa6d748ac0a87433204910a173d3bada27207", "committedDate": "2020-01-08T13:32:56Z", "message": "Single gauge register for cache."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5ODgwOTc3", "url": "https://github.com/palantir/atlasdb/pull/4493#pullrequestreview-339880977", "createdAt": "2020-01-08T14:00:37Z", "commit": {"oid": "a20aa6d748ac0a87433204910a173d3bada27207"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2344, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}