{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwOTI5OTcx", "number": 4792, "title": "[Dialogue] Part 8: Legacy Lock Service Locks", "bodyText": "Goals (and why):\n\nAdd Dialogue support for high frequency endpoints on the V1 lock service which can still account for as much as 25% of traffic at some stacks. Refresh and unlock are handled in the base PR #4790, this handles lock\n\nImplementation Description (bullets):\n\nConjurize lockAndGetHeldLocks.\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nAdded tests that validate that the same underlying service is used (e.g. I locked something in conjure and can't in legacy, vice versa)\n\nConcerns (what feedback would you like?):\nNot much\nWhere should we start reviewing?: lock-api.yml\nPriority (whenever / two weeks / yesterday): this week", "createdAt": "2020-05-20T18:06:26Z", "url": "https://github.com/palantir/atlasdb/pull/4792", "merged": true, "mergeCommit": {"oid": "e1a9c12f1823fd3f4d840fc2693285556a6e0e21"}, "closed": true, "closedAt": "2020-06-04T09:14:39Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABci5-7lAH2gAyNDIwOTI5OTcxOmY4NGMwOGMxODhjNDRjMmRiNWZjMDA1YjI5NmJjMjg5MmExYTZiNDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnt-P_gH2gAyNDIwOTI5OTcxOmVjYzk0YzdmM2RkM2I0ZWRlNWU3NTg3ZGI0MzhhODg4NjMzOGI0YWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f84c08c188c44c2db5fc005b296bc2892a1a6b46", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/f84c08c188c44c2db5fc005b296bc2892a1a6b46", "committedDate": "2020-05-19T19:52:50Z", "message": "conjurize lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e45494fd878455b41899709fa63b01ebb5ee09d1", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e45494fd878455b41899709fa63b01ebb5ee09d1", "committedDate": "2020-05-19T21:04:33Z", "message": "Gradle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00f258242935e25093bbf7838f58651030142a8d", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/00f258242935e25093bbf7838f58651030142a8d", "committedDate": "2020-05-19T21:04:42Z", "message": "New resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca1b12ebadb49c303fccb7036ee0c83fb11b7642", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/ca1b12ebadb49c303fccb7036ee0c83fb11b7642", "committedDate": "2020-05-19T21:05:08Z", "message": "Git out of here"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8811b164db51e0e1325e618c2477d45487231fd", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d8811b164db51e0e1325e618c2477d45487231fd", "committedDate": "2020-05-19T21:28:20Z", "message": "test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e97410458a4379482f6f46325cc4f309f89e9425", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e97410458a4379482f6f46325cc4f309f89e9425", "committedDate": "2020-05-19T21:43:14Z", "message": "JAXRS is tough"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78ecc2642c7b94a0b0bb2a845a311456bfad8111", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/78ecc2642c7b94a0b0bb2a845a311456bfad8111", "committedDate": "2020-05-19T21:43:09Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2781f509fd3b5581349006bf66f4e9da41802b8", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e2781f509fd3b5581349006bf66f4e9da41802b8", "committedDate": "2020-05-20T17:30:10Z", "message": "first version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58e0419e02db95d04bf857775749a5dbb1e3e783", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/58e0419e02db95d04bf857775749a5dbb1e3e783", "committedDate": "2020-05-20T17:36:46Z", "message": "Add integ test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69d7d60d83f210e81c507be0f2f74f4572e02863", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/69d7d60d83f210e81c507be0f2f74f4572e02863", "committedDate": "2020-05-20T17:37:36Z", "message": "Integ tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c9c90c01c0bd9952595741dc7663bd88f7e34f0", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/5c9c90c01c0bd9952595741dc7663bd88f7e34f0", "committedDate": "2020-05-20T18:03:13Z", "message": "simplify and add better test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MTYzNjQ4", "url": "https://github.com/palantir/atlasdb/pull/4792#pullrequestreview-418163648", "createdAt": "2020-05-26T10:21:56Z", "commit": {"oid": "5c9c90c01c0bd9952595741dc7663bd88f7e34f0"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMDoyMTo1NlrOGaX-hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMDoyNDozNVrOGaYDvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMwODk5OQ==", "bodyText": "missed an opportunity to have a /laugh endpoint", "url": "https://github.com/palantir/atlasdb/pull/4792#discussion_r430308999", "createdAt": "2020-05-26T10:21:56Z", "author": {"login": "gmaretic"}, "path": "lock-conjure-api/src/main/conjure/lock-api.yml", "diffHunk": "@@ -29,6 +40,12 @@ services:\n     package: com.palantir.lock\n     base-path: /lk\n     endpoints:\n+      lockAndGetHeldLocks:\n+        http: POST /laghl/{namespace}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c9c90c01c0bd9952595741dc7663bd88f7e34f0"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMxMDExNw==", "bodyText": "as(\"legacy impl can unlock a lock taken by conjure impl\")", "url": "https://github.com/palantir/atlasdb/pull/4792#discussion_r430310117", "createdAt": "2020-05-26T10:24:08Z", "author": {"login": "gmaretic"}, "path": "timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java", "diffHunk": "@@ -362,6 +365,41 @@ public void directLegacyAndConjureLockServicesInteractCorrectly() throws Interru\n                 .isFalse();\n     }\n \n+    @Test\n+    public void lockAcquiredByConjureLockServiceIsAlsoAcquiredInLegacy() throws InterruptedException {\n+        com.palantir.lock.LockRequest lockRequest = com.palantir.lock.LockRequest.builder(\n+                ImmutableSortedMap.<LockDescriptor, LockMode>naturalOrder()\n+                        .put(StringLockDescriptor.of(\"lock\"), LockMode.WRITE)\n+                        .build())\n+                .doNotBlock()\n+                .build();\n+        String anonymousId = LockClient.ANONYMOUS.getClientId();\n+        ConjureLockV1Request conjureLockRequest = ConjureLockV1Request.builder()\n+                .lockClient(anonymousId)\n+                .lockRequest(lockRequest)\n+                .build();\n+\n+        HeldLocksToken token = client.conjureLegacyLockService().lockAndGetHeldLocks(\n+                AuthHeader.valueOf(\"Bearer unused\"),\n+                client.namespace(),\n+                conjureLockRequest)\n+                .orElseThrow(() -> new RuntimeException(\"We should have been able to get the lock\"));\n+\n+        assertThat(client.legacyLockService().lockAndGetHeldLocks(anonymousId, lockRequest))\n+                .as(\"if the conjure impl has taken a lock, the legacy impl mustn't be able to take it\")\n+                .isNull();\n+        assertThat(client.legacyLockService().unlock(token.getLockRefreshToken())).isTrue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c9c90c01c0bd9952595741dc7663bd88f7e34f0"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDMxMDMzNQ==", "bodyText": "not unlocked by conjure impl", "url": "https://github.com/palantir/atlasdb/pull/4792#discussion_r430310335", "createdAt": "2020-05-26T10:24:35Z", "author": {"login": "gmaretic"}, "path": "timelock-server/src/suiteTest/java/com/palantir/atlasdb/timelock/MultiNodePaxosTimeLockServerIntegrationTest.java", "diffHunk": "@@ -362,6 +365,41 @@ public void directLegacyAndConjureLockServicesInteractCorrectly() throws Interru\n                 .isFalse();\n     }\n \n+    @Test\n+    public void lockAcquiredByConjureLockServiceIsAlsoAcquiredInLegacy() throws InterruptedException {\n+        com.palantir.lock.LockRequest lockRequest = com.palantir.lock.LockRequest.builder(\n+                ImmutableSortedMap.<LockDescriptor, LockMode>naturalOrder()\n+                        .put(StringLockDescriptor.of(\"lock\"), LockMode.WRITE)\n+                        .build())\n+                .doNotBlock()\n+                .build();\n+        String anonymousId = LockClient.ANONYMOUS.getClientId();\n+        ConjureLockV1Request conjureLockRequest = ConjureLockV1Request.builder()\n+                .lockClient(anonymousId)\n+                .lockRequest(lockRequest)\n+                .build();\n+\n+        HeldLocksToken token = client.conjureLegacyLockService().lockAndGetHeldLocks(\n+                AuthHeader.valueOf(\"Bearer unused\"),\n+                client.namespace(),\n+                conjureLockRequest)\n+                .orElseThrow(() -> new RuntimeException(\"We should have been able to get the lock\"));\n+\n+        assertThat(client.legacyLockService().lockAndGetHeldLocks(anonymousId, lockRequest))\n+                .as(\"if the conjure impl has taken a lock, the legacy impl mustn't be able to take it\")\n+                .isNull();\n+        assertThat(client.legacyLockService().unlock(token.getLockRefreshToken())).isTrue();\n+        assertThat(client.legacyLockService().lockAndGetHeldLocks(anonymousId, lockRequest))\n+                .as(\"a lock once unlocked by conjure impl can be acquired by legacy impl\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c9c90c01c0bd9952595741dc7663bd88f7e34f0"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0260b6e17cda19f2db8ffcb233d32c38a414a694", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/0260b6e17cda19f2db8ffcb233d32c38a414a694", "committedDate": "2020-05-28T20:21:31Z", "message": "CR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "787bd291755f36234e613242d3d96b66ac1f3bad", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/787bd291755f36234e613242d3d96b66ac1f3bad", "committedDate": "2020-05-28T20:22:30Z", "message": "first version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d925155a5e74342414feac73a167a93bb7ad70f", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/7d925155a5e74342414feac73a167a93bb7ad70f", "committedDate": "2020-05-28T20:22:30Z", "message": "Add integ test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e36238684804f4a4282925232546df03130fe319", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/e36238684804f4a4282925232546df03130fe319", "committedDate": "2020-05-28T20:22:30Z", "message": "Integ tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d79c275debac8222b64defd2aaa735300fc9e584", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d79c275debac8222b64defd2aaa735300fc9e584", "committedDate": "2020-05-28T20:22:30Z", "message": "simplify and add better test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c9c90c01c0bd9952595741dc7663bd88f7e34f0", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/5c9c90c01c0bd9952595741dc7663bd88f7e34f0", "committedDate": "2020-05-20T18:03:13Z", "message": "simplify and add better test"}, "afterCommit": {"oid": "d79c275debac8222b64defd2aaa735300fc9e584", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d79c275debac8222b64defd2aaa735300fc9e584", "committedDate": "2020-05-28T20:22:30Z", "message": "simplify and add better test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "813ff4060701c5d7ad4be29e3a3bf202a8351022", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/813ff4060701c5d7ad4be29e3a3bf202a8351022", "committedDate": "2020-05-28T20:24:39Z", "message": "CR: fix misleading line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d20c84baa1aceedf4ba641252e2a8a0071d499b9", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/d20c84baa1aceedf4ba641252e2a8a0071d499b9", "committedDate": "2020-06-03T16:53:23Z", "message": "Merge branch 'jkong/dialogue-for-locks' of github.com:palantir/atlasdb into jkong/dialogue-for-locks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94ebaca9954fab2e6fd1ec0c0197877735c88c5f", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/94ebaca9954fab2e6fd1ec0c0197877735c88c5f", "committedDate": "2020-06-03T16:55:23Z", "message": "Merge branch 'develop' into jkong/dialogue-for-locks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb5d9abda4bb456d1105baa084999b642fcef2a0", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/eb5d9abda4bb456d1105baa084999b642fcef2a0", "committedDate": "2020-06-03T16:56:46Z", "message": "CR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f6256fc83965e4d2ddb95256bbe67235b2c4b90", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/0f6256fc83965e4d2ddb95256bbe67235b2c4b90", "committedDate": "2020-06-03T17:56:30Z", "message": "bad merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecc94c7f3dd3b4ede5e7587db438a8886338b4ae", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/ecc94c7f3dd3b4ede5e7587db438a8886338b4ae", "committedDate": "2020-06-03T18:42:51Z", "message": "Merge badness"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2866, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}