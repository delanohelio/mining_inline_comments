{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMTA1MDgx", "number": 4874, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNToyNTo1N1rOEKJr3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzo0ODowOVrOEKNhAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MDc5OTAzOnYy", "diffSide": "RIGHT", "path": "commons-executors/src/main/java/com/palantir/common/concurrent/PTExecutors.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNToyNTo1N1rOGrB2_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNTozMDo1M1rOGrCGDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3MjQxNA==", "bodyText": "There's no ThreadFactory passed in.", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447772414", "createdAt": "2020-06-30T15:25:57Z", "author": {"login": "jkozlowski"}, "path": "commons-executors/src/main/java/com/palantir/common/concurrent/PTExecutors.java", "diffHunk": "@@ -196,13 +196,34 @@ public static ThreadPoolExecutor newFixedThreadPool(int numThreads) {\n      * @return the newly created thread pool\n      * @throws NullPointerException if threadFactory is null\n      * @throws IllegalArgumentException if <tt>numThreads &lt;= 0</tt>\n+     * @deprecated Prefer {@link #newFixedThreadPool(int, String)}.\n      */\n+    @Deprecated\n     public static ThreadPoolExecutor newFixedThreadPool(int numThreads, ThreadFactory threadFactory) {\n         return newThreadPoolExecutor(numThreads, numThreads,\n                 DEFAULT_THREAD_POOL_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS,\n                 new LinkedBlockingQueue<Runnable>(), threadFactory);\n     }\n \n+    /**\n+     * Creates a thread pool that reuses a fixed number of threads operating off a shared unbounded\n+     * queue, using the provided ThreadFactory to create new threads when needed.  At any point, at", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9459fae29d52f82a34b1a53d435a1e0a54539fa"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NjI3MA==", "bodyText": "updated docs.", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447776270", "createdAt": "2020-06-30T15:30:53Z", "author": {"login": "carterkozak"}, "path": "commons-executors/src/main/java/com/palantir/common/concurrent/PTExecutors.java", "diffHunk": "@@ -196,13 +196,34 @@ public static ThreadPoolExecutor newFixedThreadPool(int numThreads) {\n      * @return the newly created thread pool\n      * @throws NullPointerException if threadFactory is null\n      * @throws IllegalArgumentException if <tt>numThreads &lt;= 0</tt>\n+     * @deprecated Prefer {@link #newFixedThreadPool(int, String)}.\n      */\n+    @Deprecated\n     public static ThreadPoolExecutor newFixedThreadPool(int numThreads, ThreadFactory threadFactory) {\n         return newThreadPoolExecutor(numThreads, numThreads,\n                 DEFAULT_THREAD_POOL_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS,\n                 new LinkedBlockingQueue<Runnable>(), threadFactory);\n     }\n \n+    /**\n+     * Creates a thread pool that reuses a fixed number of threads operating off a shared unbounded\n+     * queue, using the provided ThreadFactory to create new threads when needed.  At any point, at", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3MjQxNA=="}, "originalCommit": {"oid": "d9459fae29d52f82a34b1a53d435a1e0a54539fa"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MDgxMjIyOnYy", "diffSide": "RIGHT", "path": "leader-election-impl/src/main/java/com/palantir/leader/proxy/AwaitingLeadershipProxy.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNToyODozN1rOGrB-_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNTozNDoyMlrOGrCPjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NDQ2Mw==", "bodyText": "Feels like this should have a name?", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447774463", "createdAt": "2020-06-30T15:28:37Z", "author": {"login": "jkozlowski"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/proxy/AwaitingLeadershipProxy.java", "diffHunk": "@@ -107,7 +107,7 @@ private AwaitingLeadershipProxy(\n                 \"Unable to create an AwaitingLeadershipProxy with no supplier\");\n         this.delegateSupplier = delegateSupplier;\n         this.leaderElectionService = leaderElectionService;\n-        this.executor = PTExecutors.newSingleThreadExecutor(PTExecutors.newNamedThreadFactory(true));\n+        this.executor = PTExecutors.newSingleThreadExecutor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9459fae29d52f82a34b1a53d435a1e0a54539fa"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NTQ1OQ==", "bodyText": "So this will loose daemon threading? @jeremyk-91", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447775459", "createdAt": "2020-06-30T15:29:53Z", "author": {"login": "jkozlowski"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/proxy/AwaitingLeadershipProxy.java", "diffHunk": "@@ -107,7 +107,7 @@ private AwaitingLeadershipProxy(\n                 \"Unable to create an AwaitingLeadershipProxy with no supplier\");\n         this.delegateSupplier = delegateSupplier;\n         this.leaderElectionService = leaderElectionService;\n-        this.executor = PTExecutors.newSingleThreadExecutor(PTExecutors.newNamedThreadFactory(true));\n+        this.executor = PTExecutors.newSingleThreadExecutor();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NDQ2Mw=="}, "originalCommit": {"oid": "d9459fae29d52f82a34b1a53d435a1e0a54539fa"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NjI1Nw==", "bodyText": "This uses the same logic as before, discovering a name based on the call site.", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447776257", "createdAt": "2020-06-30T15:30:53Z", "author": {"login": "carterkozak"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/proxy/AwaitingLeadershipProxy.java", "diffHunk": "@@ -107,7 +107,7 @@ private AwaitingLeadershipProxy(\n                 \"Unable to create an AwaitingLeadershipProxy with no supplier\");\n         this.delegateSupplier = delegateSupplier;\n         this.leaderElectionService = leaderElectionService;\n-        this.executor = PTExecutors.newSingleThreadExecutor(PTExecutors.newNamedThreadFactory(true));\n+        this.executor = PTExecutors.newSingleThreadExecutor();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NDQ2Mw=="}, "originalCommit": {"oid": "d9459fae29d52f82a34b1a53d435a1e0a54539fa"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3ODcwMw==", "bodyText": "This used daemon threads before, and the default is using daemon threads. This one hasn't changed, only the psl threads are changing to daemons.", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447778703", "createdAt": "2020-06-30T15:34:22Z", "author": {"login": "carterkozak"}, "path": "leader-election-impl/src/main/java/com/palantir/leader/proxy/AwaitingLeadershipProxy.java", "diffHunk": "@@ -107,7 +107,7 @@ private AwaitingLeadershipProxy(\n                 \"Unable to create an AwaitingLeadershipProxy with no supplier\");\n         this.delegateSupplier = delegateSupplier;\n         this.leaderElectionService = leaderElectionService;\n-        this.executor = PTExecutors.newSingleThreadExecutor(PTExecutors.newNamedThreadFactory(true));\n+        this.executor = PTExecutors.newSingleThreadExecutor();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NDQ2Mw=="}, "originalCommit": {"oid": "d9459fae29d52f82a34b1a53d435a1e0a54539fa"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MDgxOTk0OnYy", "diffSide": "RIGHT", "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogBatchReader.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNTozMDowOFrOGrCD0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzo1MTozMFrOGrH9RQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NTY5Nw==", "bodyText": "Again, no daemons?", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447775697", "createdAt": "2020-06-30T15:30:08Z", "author": {"login": "jkozlowski"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogBatchReader.java", "diffHunk": "@@ -40,7 +39,7 @@ public PaxosStateLogBatchReader(PaxosStateLog<V> delegate, Persistable.Hydrator<\n         this.delegate = delegate;\n         this.hydrator = hydrator;\n         this.executor = MoreExecutors.listeningDecorator(\n-                PTExecutors.newFixedThreadPool(numThreads, new NamedThreadFactory(\"psl-reader\", true)));\n+                PTExecutors.newFixedThreadPool(numThreads, \"psl-reader\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9459fae29d52f82a34b1a53d435a1e0a54539fa"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NzM2MA==", "bodyText": "Yes. this is a change to avoid daemon threads. Do you think non-daemon threads are required here?", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447777360", "createdAt": "2020-06-30T15:32:24Z", "author": {"login": "carterkozak"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogBatchReader.java", "diffHunk": "@@ -40,7 +39,7 @@ public PaxosStateLogBatchReader(PaxosStateLog<V> delegate, Persistable.Hydrator<\n         this.delegate = delegate;\n         this.hydrator = hydrator;\n         this.executor = MoreExecutors.listeningDecorator(\n-                PTExecutors.newFixedThreadPool(numThreads, new NamedThreadFactory(\"psl-reader\", true)));\n+                PTExecutors.newFixedThreadPool(numThreads, \"psl-reader\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NTY5Nw=="}, "originalCommit": {"oid": "d9459fae29d52f82a34b1a53d435a1e0a54539fa"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3MjMyNQ==", "bodyText": "This one could be either way I think, it's part of the SQLite migration so it blocks startup for timelock, and there'll always be other main threads going around.", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447872325", "createdAt": "2020-06-30T17:51:30Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/PaxosStateLogBatchReader.java", "diffHunk": "@@ -40,7 +39,7 @@ public PaxosStateLogBatchReader(PaxosStateLog<V> delegate, Persistable.Hydrator<\n         this.delegate = delegate;\n         this.hydrator = hydrator;\n         this.executor = MoreExecutors.listeningDecorator(\n-                PTExecutors.newFixedThreadPool(numThreads, new NamedThreadFactory(\"psl-reader\", true)));\n+                PTExecutors.newFixedThreadPool(numThreads, \"psl-reader\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc3NTY5Nw=="}, "originalCommit": {"oid": "d9459fae29d52f82a34b1a53d435a1e0a54539fa"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MTQyMzQ1OnYy", "diffSide": "RIGHT", "path": "commons-executors/src/main/java/com/palantir/common/concurrent/PTExecutors.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzo0NzoxNFrOGrHzkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzo0NzoxNFrOGrHzkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg2OTg0Mg==", "bodyText": "Might want to call out (method name? or at least docs) that this is non-daemon since a lot of the other methods in this class seem to use daemon threads", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447869842", "createdAt": "2020-06-30T17:47:14Z", "author": {"login": "jeremyk-91"}, "path": "commons-executors/src/main/java/com/palantir/common/concurrent/PTExecutors.java", "diffHunk": "@@ -196,13 +196,33 @@ public static ThreadPoolExecutor newFixedThreadPool(int numThreads) {\n      * @return the newly created thread pool\n      * @throws NullPointerException if threadFactory is null\n      * @throws IllegalArgumentException if <tt>numThreads &lt;= 0</tt>\n+     * @deprecated Prefer {@link #newFixedThreadPool(int, String)}.\n      */\n+    @Deprecated\n     public static ThreadPoolExecutor newFixedThreadPool(int numThreads, ThreadFactory threadFactory) {\n         return newThreadPoolExecutor(numThreads, numThreads,\n                 DEFAULT_THREAD_POOL_TIMEOUT_MILLIS, TimeUnit.MILLISECONDS,\n                 new LinkedBlockingQueue<Runnable>(), threadFactory);\n     }\n \n+    /**\n+     * Creates a thread pool that reuses a fixed number of threads operating off a shared unbounded\n+     * queue.  At any point, at most <tt>numThreads</tt> threads will be active processing tasks.  If\n+     * additional tasks are submitted when all threads are active, they will wait in the queue until\n+     * a thread is available.  If any thread terminates due to a failure during execution prior to\n+     * shutdown, a new one will take its place if needed to execute subsequent tasks.  The threads\n+     * in the pool will exist until it is explicitly {@link\n+     * ExecutorService#shutdown shutdown}.\n+     *\n+     * @param numThreads the number of threads in the pool\n+     * @param name Executor name used for thread naming and instrumentation\n+     * @return the newly created thread pool\n+     * @throws IllegalArgumentException if <tt>numThreads &lt;= 0</tt>\n+     */\n+    public static ThreadPoolExecutor newFixedThreadPool(int numThreads, String name) {\n+        return newFixedThreadPool(numThreads, new NamedThreadFactory(name));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca3377786b308cffec1507b6db1226975c508a74"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5MTQyNjU2OnYy", "diffSide": "RIGHT", "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/LeaderPingHealthCheck.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzo0ODowOVrOGrH1mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNzo1NjoyNVrOGrIIyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3MDM2MA==", "bodyText": "This one seems a bit suspicious - we're changing it to be non-daemon, and there doesn't seem to be anything that shuts down the executor service anywhere. Do we know/have we tested if timelock will shut down gracefully?", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447870360", "createdAt": "2020-06-30T17:48:09Z", "author": {"login": "jeremyk-91"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/LeaderPingHealthCheck.java", "diffHunk": "@@ -51,7 +50,7 @@ public LeaderPingHealthCheck(\n         this.pingers = pingers;\n         this.executorService = PTExecutors.newFixedThreadPool(\n                 pingers.size(),\n-                new NamedThreadFactory(\"leader-ping-healthcheck\", true));\n+                \"leader-ping-healthcheck\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca3377786b308cffec1507b6db1226975c508a74"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3NTI3Mw==", "bodyText": "Ah, I had though the default NamedThreadFactory ctor used daemon threads, but that was incorrect. I definitely want this to use daemon threads.\nI don't think we actually want any ptexecutors to use non-daemon threads since they've historically been a source of pain.", "url": "https://github.com/palantir/atlasdb/pull/4874#discussion_r447875273", "createdAt": "2020-06-30T17:56:25Z", "author": {"login": "carterkozak"}, "path": "timelock-agent/src/main/java/com/palantir/timelock/paxos/LeaderPingHealthCheck.java", "diffHunk": "@@ -51,7 +50,7 @@ public LeaderPingHealthCheck(\n         this.pingers = pingers;\n         this.executorService = PTExecutors.newFixedThreadPool(\n                 pingers.size(),\n-                new NamedThreadFactory(\"leader-ping-healthcheck\", true));\n+                \"leader-ping-healthcheck\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzg3MDM2MA=="}, "originalCommit": {"oid": "ca3377786b308cffec1507b6db1226975c508a74"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2698, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}