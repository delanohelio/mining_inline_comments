{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2NDc1OTgw", "number": 4534, "title": "Prefixed path for persistent storage", "bodyText": "Goals (and why):\nUse a magic fold to prefix all folders which will be used to store persistent storage data. The goal of this PR is to make the usage safer and to remove the static mutable state.\nImplementation Description (bullets):\n\nusing a magic keyword to prefix folders\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\ntests are updated\n\nPriority (whenever / two weeks / yesterday):\ntomorrow", "createdAt": "2020-01-23T17:20:51Z", "url": "https://github.com/palantir/atlasdb/pull/4534", "merged": true, "mergeCommit": {"oid": "0a2312a994dbb5c8a8f37b6eb021c5be8262fe86"}, "closed": true, "closedAt": "2020-01-24T16:22:35Z", "author": {"login": "OStevan"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9NnSJgH2gAyMzY2NDc1OTgwOjI4ZTY4Mjc3OTg2NTY4MTYwYmNmZjk3YzI3NGExMzgyMGMyODZkZjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9hP-3AFqTM0ODA0NzQ0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "28e68277986568160bcff97c274a13820c286df8", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/28e68277986568160bcff97c274a13820c286df8", "committedDate": "2020-01-23T17:15:59Z", "message": "Prerequisites."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebc60cf001703564fa715a515321b5a69a5e7d35", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/ebc60cf001703564fa715a515321b5a69a5e7d35", "committedDate": "2020-01-23T17:15:59Z", "message": "No more static state."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04565ab46e61ae007ec72a45085c6fc8f592b80d", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/04565ab46e61ae007ec72a45085c6fc8f592b80d", "committedDate": "2020-01-23T17:26:53Z", "message": "Fix tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NDkxNDc0", "url": "https://github.com/palantir/atlasdb/pull/4534#pullrequestreview-347491474", "createdAt": "2020-01-23T17:51:00Z", "commit": {"oid": "04565ab46e61ae007ec72a45085c6fc8f592b80d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNzo1MTowMVrOFhHN7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTo0MzoyNVrOFhbR2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDI2NTU4MQ==", "bodyText": "docs are inaccurate now", "url": "https://github.com/palantir/atlasdb/pull/4534#discussion_r370265581", "createdAt": "2020-01-23T17:51:01Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/PersistentStoragePathSanitizer.java", "diffHunk": "@@ -24,22 +24,30 @@\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n-import java.util.regex.Pattern;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n-import com.google.common.base.MoreObjects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.annotations.VisibleForTesting;\n import com.palantir.logsafe.Preconditions;\n import com.palantir.logsafe.SafeArg;\n \n-public final class PersistentStorageFactories {\n-    private static final Pattern UUID_PATTERN = Pattern.compile(\n-            \"^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$\");\n+public final class PersistentStoragePathSanitizer {\n+    private static final Logger log = LoggerFactory.getLogger(PersistentStoragePathSanitizer.class);\n+    private static final PersistentStoragePathSanitizer INSTANCE = new PersistentStoragePathSanitizer();\n+    @VisibleForTesting\n+    static final String MAGIC_SUFFIX = \"atlasdb-persistent-storage\";\n \n-    private static final Set<String> SANITIZED_PATHS = new HashSet<>();\n+    public static PersistentStoragePathSanitizer create() {\n+        return INSTANCE;\n+    }\n \n-    private PersistentStorageFactories() {}\n+    private final Set<String> sanitizedPaths = new HashSet<>();\n \n+    @VisibleForTesting\n+    PersistentStoragePathSanitizer() {}\n \n     /**\n      * For the given path does the following: 1) it is sanitized only once per VM lifetime 2) if it exists checks that", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04565ab46e61ae007ec72a45085c6fc8f592b80d"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5MzgzMQ==", "bodyText": "as discussed offline, let's just do the straightforward thing since this will be called at most once, for the places where multiple transaction managers are used without proper sync, we'd need to sort it out ourselves, but that's easy since there are not that many.", "url": "https://github.com/palantir/atlasdb/pull/4534#discussion_r370593831", "createdAt": "2020-01-24T11:42:13Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/PersistentStoragePathSanitizer.java", "diffHunk": "@@ -24,22 +24,30 @@\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n-import java.util.regex.Pattern;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n-import com.google.common.base.MoreObjects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.annotations.VisibleForTesting;\n import com.palantir.logsafe.Preconditions;\n import com.palantir.logsafe.SafeArg;\n \n-public final class PersistentStorageFactories {\n-    private static final Pattern UUID_PATTERN = Pattern.compile(\n-            \"^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$\");\n+public final class PersistentStoragePathSanitizer {\n+    private static final Logger log = LoggerFactory.getLogger(PersistentStoragePathSanitizer.class);\n+    private static final PersistentStoragePathSanitizer INSTANCE = new PersistentStoragePathSanitizer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04565ab46e61ae007ec72a45085c6fc8f592b80d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5Mzg5Ng==", "bodyText": "this can just be a static method", "url": "https://github.com/palantir/atlasdb/pull/4534#discussion_r370593896", "createdAt": "2020-01-24T11:42:24Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/PersistentStoragePathSanitizer.java", "diffHunk": "@@ -24,22 +24,30 @@\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n-import java.util.regex.Pattern;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n-import com.google.common.base.MoreObjects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.annotations.VisibleForTesting;\n import com.palantir.logsafe.Preconditions;\n import com.palantir.logsafe.SafeArg;\n \n-public final class PersistentStorageFactories {\n-    private static final Pattern UUID_PATTERN = Pattern.compile(\n-            \"^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$\");\n+public final class PersistentStoragePathSanitizer {\n+    private static final Logger log = LoggerFactory.getLogger(PersistentStoragePathSanitizer.class);\n+    private static final PersistentStoragePathSanitizer INSTANCE = new PersistentStoragePathSanitizer();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5MzgzMQ=="}, "originalCommit": {"oid": "04565ab46e61ae007ec72a45085c6fc8f592b80d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5NDI2NQ==", "bodyText": "given this is a singleton, why are we passing this in?", "url": "https://github.com/palantir/atlasdb/pull/4534#discussion_r370594265", "createdAt": "2020-01-24T11:43:25Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/DefaultPersistentStorageFactory.java", "diffHunk": "@@ -34,6 +35,11 @@\n  */\n public final class DefaultPersistentStorageFactory implements PersistentStorageFactory {\n     private static final Logger log = LoggerFactory.getLogger(DefaultPersistentStorageFactory.class);\n+    private final PersistentStoragePathSanitizer persistentStoragePathSanitizer;\n+\n+    public DefaultPersistentStorageFactory(PersistentStoragePathSanitizer persistentStoragePathSanitizer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04565ab46e61ae007ec72a45085c6fc8f592b80d"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3ODkwNjk0", "url": "https://github.com/palantir/atlasdb/pull/4534#pullrequestreview-347890694", "createdAt": "2020-01-24T11:18:45Z", "commit": {"oid": "04565ab46e61ae007ec72a45085c6fc8f592b80d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMToxODo0NVrOFhavtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxMTo0MToyN1rOFhbPEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU4NTUyNg==", "bodyText": "I'd shove this into AtlasdbConstants", "url": "https://github.com/palantir/atlasdb/pull/4534#discussion_r370585526", "createdAt": "2020-01-24T11:18:45Z", "author": {"login": "gmaretic"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/PersistentStoragePathSanitizer.java", "diffHunk": "@@ -24,22 +24,30 @@\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n-import java.util.regex.Pattern;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n-import com.google.common.base.MoreObjects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.annotations.VisibleForTesting;\n import com.palantir.logsafe.Preconditions;\n import com.palantir.logsafe.SafeArg;\n \n-public final class PersistentStorageFactories {\n-    private static final Pattern UUID_PATTERN = Pattern.compile(\n-            \"^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$\");\n+public final class PersistentStoragePathSanitizer {\n+    private static final Logger log = LoggerFactory.getLogger(PersistentStoragePathSanitizer.class);\n+    private static final PersistentStoragePathSanitizer INSTANCE = new PersistentStoragePathSanitizer();\n+    @VisibleForTesting\n+    static final String MAGIC_SUFFIX = \"atlasdb-persistent-storage\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04565ab46e61ae007ec72a45085c6fc8f592b80d"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5MzE1OA==", "bodyText": "Constructor should be the first method generally, also making it visible for testing is super sketch. We also don't seem to really need a singleton, but if you want to keep it singleton, why don't you make each test use a different storagePath instead?", "url": "https://github.com/palantir/atlasdb/pull/4534#discussion_r370593158", "createdAt": "2020-01-24T11:40:21Z", "author": {"login": "gmaretic"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/PersistentStoragePathSanitizer.java", "diffHunk": "@@ -24,22 +24,30 @@\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n-import java.util.regex.Pattern;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n-import com.google.common.base.MoreObjects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.annotations.VisibleForTesting;\n import com.palantir.logsafe.Preconditions;\n import com.palantir.logsafe.SafeArg;\n \n-public final class PersistentStorageFactories {\n-    private static final Pattern UUID_PATTERN = Pattern.compile(\n-            \"^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$\");\n+public final class PersistentStoragePathSanitizer {\n+    private static final Logger log = LoggerFactory.getLogger(PersistentStoragePathSanitizer.class);\n+    private static final PersistentStoragePathSanitizer INSTANCE = new PersistentStoragePathSanitizer();\n+    @VisibleForTesting\n+    static final String MAGIC_SUFFIX = \"atlasdb-persistent-storage\";\n \n-    private static final Set<String> SANITIZED_PATHS = new HashSet<>();\n+    public static PersistentStoragePathSanitizer create() {\n+        return INSTANCE;\n+    }\n \n-    private PersistentStorageFactories() {}\n+    private final Set<String> sanitizedPaths = new HashSet<>();\n \n+    @VisibleForTesting\n+    PersistentStoragePathSanitizer() {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04565ab46e61ae007ec72a45085c6fc8f592b80d"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDU5MzU1NQ==", "bodyText": "Create is a bit misleading, maybe getInstance?", "url": "https://github.com/palantir/atlasdb/pull/4534#discussion_r370593555", "createdAt": "2020-01-24T11:41:27Z", "author": {"login": "gmaretic"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/PersistentStoragePathSanitizer.java", "diffHunk": "@@ -24,22 +24,30 @@\n import java.util.HashSet;\n import java.util.List;\n import java.util.Set;\n-import java.util.regex.Pattern;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n-import com.google.common.base.MoreObjects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.google.common.annotations.VisibleForTesting;\n import com.palantir.logsafe.Preconditions;\n import com.palantir.logsafe.SafeArg;\n \n-public final class PersistentStorageFactories {\n-    private static final Pattern UUID_PATTERN = Pattern.compile(\n-            \"^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$\");\n+public final class PersistentStoragePathSanitizer {\n+    private static final Logger log = LoggerFactory.getLogger(PersistentStoragePathSanitizer.class);\n+    private static final PersistentStoragePathSanitizer INSTANCE = new PersistentStoragePathSanitizer();\n+    @VisibleForTesting\n+    static final String MAGIC_SUFFIX = \"atlasdb-persistent-storage\";\n \n-    private static final Set<String> SANITIZED_PATHS = new HashSet<>();\n+    public static PersistentStoragePathSanitizer create() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04565ab46e61ae007ec72a45085c6fc8f592b80d"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ded95cbd1de4449cedc61374816d319ade4b2594", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/ded95cbd1de4449cedc61374816d319ade4b2594", "committedDate": "2020-01-24T13:28:16Z", "message": "Simple fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "663f01e7b44d9b92acfe1d9558d580da26cfe43b", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/663f01e7b44d9b92acfe1d9558d580da26cfe43b", "committedDate": "2020-01-24T14:05:29Z", "message": "Fixed tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4a02e2caa83d73640568ac273cf2ebd9432447b", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/e4a02e2caa83d73640568ac273cf2ebd9432447b", "committedDate": "2020-01-24T14:32:11Z", "message": "Fix tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MDQ2MzE2", "url": "https://github.com/palantir/atlasdb/pull/4534#pullrequestreview-348046316", "createdAt": "2020-01-24T15:51:09Z", "commit": {"oid": "e4a02e2caa83d73640568ac273cf2ebd9432447b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNTo1MTowOVrOFhiAzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNTo1MTowOVrOFhiAzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwNDU5MQ==", "bodyText": "what happens if storagePath doesn't exist, does this catch it?", "url": "https://github.com/palantir/atlasdb/pull/4534#discussion_r370704591", "createdAt": "2020-01-24T15:51:09Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/PersistentStoragePathSanitizer.java", "diffHunk": "@@ -21,70 +21,63 @@\n import java.nio.file.Files;\n import java.nio.file.Path;\n import java.util.Comparator;\n-import java.util.HashSet;\n import java.util.List;\n-import java.util.Set;\n-import java.util.regex.Pattern;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n-import com.google.common.base.MoreObjects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n import com.palantir.logsafe.Preconditions;\n import com.palantir.logsafe.SafeArg;\n \n-public final class PersistentStorageFactories {\n-    private static final Pattern UUID_PATTERN = Pattern.compile(\n-            \"^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$\");\n-\n-    private static final Set<String> SANITIZED_PATHS = new HashSet<>();\n-\n-    private PersistentStorageFactories() {}\n+public final class PersistentStoragePathSanitizer {\n+    private static final Logger log = LoggerFactory.getLogger(PersistentStoragePathSanitizer.class);\n+    private static final String MAGIC_SUFFIX = \"atlasdb-persistent-storage\";\n \n+    private PersistentStoragePathSanitizer() {}\n \n     /**\n-     * For the given path does the following: 1) it is sanitized only once per VM lifetime 2) if it exists checks that\n-     * it is a directory, 3) if it is a directory removes all sub-folders whose names are string representation of a\n-     * UUID.\n+     * For the given path deletes all files and directories under the folder named {@code MAGIC_SUFFIX}.\n      *\n      * @param storagePath to the proposed storage location\n      */\n-    public static synchronized void sanitizeStoragePath(String storagePath) {\n-        if (SANITIZED_PATHS.contains(storagePath)) {\n-            return;\n-        }\n+    public static Path sanitizeStoragePath(String storagePath) {\n+        File storageDirectory = new File(storagePath, MAGIC_SUFFIX);\n+\n+        Preconditions.checkArgument(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a02e2caa83d73640568ac273cf2ebd9432447b"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8924dc12048af15a223c705196480a7b26e2f34", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/c8924dc12048af15a223c705196480a7b26e2f34", "committedDate": "2020-01-24T16:07:10Z", "message": "Fixed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MDQ3NDQ2", "url": "https://github.com/palantir/atlasdb/pull/4534#pullrequestreview-348047446", "createdAt": "2020-01-24T15:52:47Z", "commit": {"oid": "e4a02e2caa83d73640568ac273cf2ebd9432447b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNTo1Mjo0N1rOFhiEOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNTo1NToxMlrOFhiJRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwNTQ2NQ==", "bodyText": "lol magic shouldn't really be appearing inside exceptions that'll be logged. Plus isn't it the other way around? that it points to a file? i.e. if storageDirectory is not a directory, this the message that will be printed?", "url": "https://github.com/palantir/atlasdb/pull/4534#discussion_r370705465", "createdAt": "2020-01-24T15:52:47Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/PersistentStoragePathSanitizer.java", "diffHunk": "@@ -21,70 +21,63 @@\n import java.nio.file.Files;\n import java.nio.file.Path;\n import java.util.Comparator;\n-import java.util.HashSet;\n import java.util.List;\n-import java.util.Set;\n-import java.util.regex.Pattern;\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n-import com.google.common.base.MoreObjects;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n import com.palantir.logsafe.Preconditions;\n import com.palantir.logsafe.SafeArg;\n \n-public final class PersistentStorageFactories {\n-    private static final Pattern UUID_PATTERN = Pattern.compile(\n-            \"^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$\");\n-\n-    private static final Set<String> SANITIZED_PATHS = new HashSet<>();\n-\n-    private PersistentStorageFactories() {}\n+public final class PersistentStoragePathSanitizer {\n+    private static final Logger log = LoggerFactory.getLogger(PersistentStoragePathSanitizer.class);\n+    private static final String MAGIC_SUFFIX = \"atlasdb-persistent-storage\";\n \n+    private PersistentStoragePathSanitizer() {}\n \n     /**\n-     * For the given path does the following: 1) it is sanitized only once per VM lifetime 2) if it exists checks that\n-     * it is a directory, 3) if it is a directory removes all sub-folders whose names are string representation of a\n-     * UUID.\n+     * For the given path deletes all files and directories under the folder named {@code MAGIC_SUFFIX}.\n      *\n      * @param storagePath to the proposed storage location\n      */\n-    public static synchronized void sanitizeStoragePath(String storagePath) {\n-        if (SANITIZED_PATHS.contains(storagePath)) {\n-            return;\n-        }\n+    public static Path sanitizeStoragePath(String storagePath) {\n+        File storageDirectory = new File(storagePath, MAGIC_SUFFIX);\n+\n+        Preconditions.checkArgument(\n+                storageDirectory.getParentFile().isDirectory(),\n+                \"Storage path has to point to a directory\",\n+                SafeArg.of(\"storageDirectory\", storageDirectory.getParentFile().getAbsolutePath()));\n \n-        File storageDirectory = new File(storagePath);\n         if (!storageDirectory.exists()) {\n             Preconditions.checkState(\n                     storageDirectory.mkdir(),\n                     \"Not able to create a storage directory\",\n                     SafeArg.of(\"storageDirectory\", storageDirectory.getAbsolutePath()));\n-            SANITIZED_PATHS.add(storagePath);\n-            return;\n+            return storageDirectory.toPath().toAbsolutePath();\n         }\n \n-        Preconditions.checkArgument(\n+        Preconditions.checkState(\n                 storageDirectory.isDirectory(),\n-                \"Storage path has to point to a directory\",\n+                \"Persistent storage path magic atlas subfolder path points to a directory\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a02e2caa83d73640568ac273cf2ebd9432447b"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwNjc1OQ==", "bodyText": "there's no guarantee that this file exists in between, an assertion please", "url": "https://github.com/palantir/atlasdb/pull/4534#discussion_r370706759", "createdAt": "2020-01-24T15:55:12Z", "author": {"login": "felixdesouza"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/PersistentStoragePathSanitizerTests.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.factory;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatThrownBy;\n+\n+import java.io.File;\n+import java.io.IOException;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+\n+import com.palantir.logsafe.exceptions.SafeIllegalArgumentException;\n+\n+public final class PersistentStoragePathSanitizerTests {\n+    public static final String FIRST_SUBFOLDER_ROOT = \"first\";\n+    public static final String SECOND_SUBFOLDER_ROOT = \"second\";\n+    @Rule\n+    public TemporaryFolder testFolder = new TemporaryFolder();\n+\n+    private String testFolderPath;\n+\n+    @Before\n+    public void setUp() {\n+        testFolderPath = testFolder.getRoot().getAbsolutePath();\n+    }\n+\n+    @Test\n+    public void emptyFolderSanitization() {\n+        PersistentStoragePathSanitizer.sanitizeStoragePath(testFolderPath);\n+    }\n+\n+    @Test\n+    public void sanitizingFile() throws IOException {\n+        File file = testFolder.newFile();\n+\n+        assertThatThrownBy(() -> PersistentStoragePathSanitizer.sanitizeStoragePath(file.getAbsolutePath()))\n+                .isInstanceOf(SafeIllegalArgumentException.class)\n+                .hasMessageContaining(\"has to point to a directory\");\n+    }\n+\n+    @Test\n+    public void removesMagicFolder() {\n+        PersistentStoragePathSanitizer.sanitizeStoragePath(testFolderPath).toFile().mkdir();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4a02e2caa83d73640568ac273cf2ebd9432447b"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2215, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}