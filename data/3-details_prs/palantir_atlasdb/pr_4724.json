{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NzI1NTgy", "number": 4724, "title": "[PaxosLog] Sqlite implementation without namespaces", "bodyText": "Goals (and why):\nThis is the basic psqlite implementation, without namespacing which will be added in a subsequent PR.\nImplementation Description (bullets):\nRelatively straightforward, although there is some magic with how the result sets are interpreted when there are no results\nTesting (What was existing testing like?  What have you done to improve it?):\nUnit tests using in memory implementation\nConcerns (what feedback would you like?):\nI think it's fine\nWhere should we start reviewing?:\nTests?\nPriority (whenever / two weeks / yesterday):\nNow", "createdAt": "2020-04-21T14:50:49Z", "url": "https://github.com/palantir/atlasdb/pull/4724", "merged": true, "mergeCommit": {"oid": "c4669e711e97c20014059e3996ff887750a82e53"}, "closed": true, "closedAt": "2020-04-21T15:42:45Z", "author": {"login": "gmaretic"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZflKLAH2gAyNDA2NzI1NTgyOjZmNTQyMWQyZmEzZDA5MTY0MTlmYWRiZmMzYzM0YWMzZjJjMjZkNWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZ6_nVAFqTM5NzcwNTkwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6f5421d2fa3d0916419fadbfc3c34ac3f2c26d5f", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/6f5421d2fa3d0916419fadbfc3c34ac3f2c26d5f", "committedDate": "2020-04-20T14:01:50Z", "message": "sqlite"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86033f658b5d4a0f152ffc4b5ffb11acc75a401d", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/86033f658b5d4a0f152ffc4b5ffb11acc75a401d", "committedDate": "2020-04-20T16:49:50Z", "message": "Checkpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51b97332a9bd115d6493103d1a51ef7478d802ea", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/51b97332a9bd115d6493103d1a51ef7478d802ea", "committedDate": "2020-04-21T10:43:26Z", "message": "Clean up a bit and add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d1cb9a05eed2aeac89ab08fa9bdbdc20ba110a0", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/2d1cb9a05eed2aeac89ab08fa9bdbdc20ba110a0", "committedDate": "2020-04-21T12:11:25Z", "message": "Improve test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c14dd16d03376e57a4b48e88863d868ac0d1c38c", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/c14dd16d03376e57a4b48e88863d868ac0d1c38c", "committedDate": "2020-04-21T14:47:24Z", "message": "Allow overwriting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDEwOTQz", "url": "https://github.com/palantir/atlasdb/pull/4724#pullrequestreview-397410943", "createdAt": "2020-04-21T14:52:04Z", "commit": {"oid": "c14dd16d03376e57a4b48e88863d868ac0d1c38c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNDo1MjowNVrOGJKEHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNDo1MjowNVrOGJKEHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI1NTI2Mg==", "bodyText": "Not now, and we'll change this: should we enforce this?", "url": "https://github.com/palantir/atlasdb/pull/4724#discussion_r412255262", "createdAt": "2020-04-21T14:52:05Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqliteConnections.java", "diffHunk": "@@ -0,0 +1,49 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.paxos;\n+\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.sql.SQLException;\n+import java.util.function.Supplier;\n+\n+import com.google.common.base.Suppliers;\n+\n+/**\n+ * This class is responsible for creating Sqlite connections to an instance.\n+ * There should be one instance per timelock.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14dd16d03376e57a4b48e88863d868ac0d1c38c"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDExNjEw", "url": "https://github.com/palantir/atlasdb/pull/4724#pullrequestreview-397411610", "createdAt": "2020-04-21T14:52:45Z", "commit": {"oid": "c14dd16d03376e57a4b48e88863d868ac0d1c38c"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNDo1Mjo0NVrOGJKGNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNDo1NToxOVrOGJKPPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI1NTc5OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    stateLog =  SqlitePaxosStateLog.createInitialized(connectionSupplier);\n          \n          \n            \n                    stateLog = SqlitePaxosStateLog.createInitialized(connectionSupplier);", "url": "https://github.com/palantir/atlasdb/pull/4724#discussion_r412255799", "createdAt": "2020-04-21T14:52:45Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/test/java/com/palantir/paxos/SqlitePaxosStateLogTest.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.paxos;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.util.concurrent.ThreadLocalRandom;\n+import java.util.function.Supplier;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+\n+import com.google.common.base.Suppliers;\n+\n+public class SqlitePaxosStateLogTest {\n+    private PaxosStateLog<PaxosValue> stateLog;\n+\n+    @Before\n+    public void setup() {\n+        Supplier<Connection> connectionSupplier = Suppliers.memoize(SqliteConnections.createDatabaseForTest()::get);\n+        stateLog =  SqlitePaxosStateLog.createInitialized(connectionSupplier);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14dd16d03376e57a4b48e88863d868ac0d1c38c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI1NzU3Mw==", "bodyText": "will be fixed in next PR: the constraint is funky", "url": "https://github.com/palantir/atlasdb/pull/4724#discussion_r412257573", "createdAt": "2020-04-21T14:54:41Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.paxos;\n+\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import com.google.common.io.ByteStreams;\n+import com.palantir.common.base.Throwables;\n+import com.palantir.common.persist.Persistable;\n+\n+public class SqlitePaxosStateLog<V extends Persistable & Versionable> implements PaxosStateLog<V> {\n+    private final Supplier<Connection> connectionSupplier;\n+\n+    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier) {\n+        this.connectionSupplier = connectionSupplier;\n+    }\n+\n+    public static <V extends Persistable & Versionable> PaxosStateLog<V> createInitialized(Supplier<Connection> conn) {\n+        SqlitePaxosStateLog<V> log = new SqlitePaxosStateLog<>(conn);\n+        log.initialize();\n+        return log;\n+    }\n+\n+    private void initialize() {\n+        executeVoid(\"CREATE TABLE IF NOT EXISTS paxosLog (seq BIGINT, val BLOB, CONSTRAINT pk_dual PRIMARY KEY (seq))\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14dd16d03376e57a4b48e88863d868ac0d1c38c"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI1ODExMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return executeStatement(String.format(\"SELECT val FROM paxosLog WHERE seq = %s;\", seq))\n          \n          \n            \n                    return executeStatement(String.format(\"SELECT val FROM paxosLog WHERE seq = %s\", seq))", "url": "https://github.com/palantir/atlasdb/pull/4724#discussion_r412258111", "createdAt": "2020-04-21T14:55:19Z", "author": {"login": "jeremyk-91"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.paxos;\n+\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import com.google.common.io.ByteStreams;\n+import com.palantir.common.base.Throwables;\n+import com.palantir.common.persist.Persistable;\n+\n+public class SqlitePaxosStateLog<V extends Persistable & Versionable> implements PaxosStateLog<V> {\n+    private final Supplier<Connection> connectionSupplier;\n+\n+    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier) {\n+        this.connectionSupplier = connectionSupplier;\n+    }\n+\n+    public static <V extends Persistable & Versionable> PaxosStateLog<V> createInitialized(Supplier<Connection> conn) {\n+        SqlitePaxosStateLog<V> log = new SqlitePaxosStateLog<>(conn);\n+        log.initialize();\n+        return log;\n+    }\n+\n+    private void initialize() {\n+        executeVoid(\"CREATE TABLE IF NOT EXISTS paxosLog (seq BIGINT, val BLOB, CONSTRAINT pk_dual PRIMARY KEY (seq))\");\n+    }\n+\n+    @Override\n+    public void writeRound(long seq, V round) {\n+        try {\n+            PreparedStatement preparedStatement = connectionSupplier.get().prepareStatement(\n+                    \"INSERT OR REPLACE INTO paxosLog (seq, val) VALUES (?, ?)\");\n+            preparedStatement.setLong(1, seq);\n+            preparedStatement.setBytes(2, round.persistToBytes());\n+            preparedStatement.execute();\n+        } catch (SQLException e) {\n+            throw Throwables.rewrapAndThrowUncheckedException(e);\n+        }\n+    }\n+\n+    @Override\n+    public byte[] readRound(long seq) {\n+        return executeStatement(String.format(\"SELECT val FROM paxosLog WHERE seq = %s;\", seq))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14dd16d03376e57a4b48e88863d868ac0d1c38c"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94397de38099b8ffc3e8ef77b69c92c808f2db0d", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/94397de38099b8ffc3e8ef77b69c92c808f2db0d", "committedDate": "2020-04-21T15:00:05Z", "message": "Fix nits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6c35747c5fedd02b4d551a626aea0da235d889d", "author": {"user": {"login": "gmaretic", "name": null}}, "url": "https://github.com/palantir/atlasdb/commit/e6c35747c5fedd02b4d551a626aea0da235d889d", "committedDate": "2020-04-21T15:27:39Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NDk2NDg4", "url": "https://github.com/palantir/atlasdb/pull/4724#pullrequestreview-397496488", "createdAt": "2020-04-21T16:58:49Z", "commit": {"oid": "e6c35747c5fedd02b4d551a626aea0da235d889d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjo1ODo0OVrOGJOkqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNjo1ODo0OVrOGJOkqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMyOTEyOA==", "bodyText": "please can we use jooq here? Direct Java sql is kind of shitty...", "url": "https://github.com/palantir/atlasdb/pull/4724#discussion_r412329128", "createdAt": "2020-04-21T16:58:49Z", "author": {"login": "j-baker"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.paxos;\n+\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import com.google.common.io.ByteStreams;\n+import com.palantir.common.base.Throwables;\n+import com.palantir.common.persist.Persistable;\n+\n+public final class SqlitePaxosStateLog<V extends Persistable & Versionable> implements PaxosStateLog<V> {\n+    private final Supplier<Connection> connectionSupplier;\n+\n+    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier) {\n+        this.connectionSupplier = connectionSupplier;\n+    }\n+\n+    public static <V extends Persistable & Versionable> PaxosStateLog<V> createInitialized(Supplier<Connection> conn) {\n+        SqlitePaxosStateLog<V> log = new SqlitePaxosStateLog<>(conn);\n+        log.initialize();\n+        return log;\n+    }\n+\n+    private void initialize() {\n+        executeVoid(\"CREATE TABLE IF NOT EXISTS paxosLog (seq BIGINT, val BLOB, CONSTRAINT pk_dual PRIMARY KEY (seq))\");\n+    }\n+\n+    @Override\n+    public void writeRound(long seq, V round) {\n+        try {\n+            PreparedStatement preparedStatement = connectionSupplier.get().prepareStatement(\n+                    \"INSERT OR REPLACE INTO paxosLog (seq, val) VALUES (?, ?)\");\n+            preparedStatement.setLong(1, seq);\n+            preparedStatement.setBytes(2, round.persistToBytes());\n+            preparedStatement.execute();\n+        } catch (SQLException e) {\n+            throw Throwables.rewrapAndThrowUncheckedException(e);\n+        }\n+    }\n+\n+    @Override\n+    public byte[] readRound(long seq) {\n+        return executeStatement(String.format(\"SELECT val FROM paxosLog WHERE seq = %s\", seq))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6c35747c5fedd02b4d551a626aea0da235d889d"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTYxMTA0", "url": "https://github.com/palantir/atlasdb/pull/4724#pullrequestreview-397561104", "createdAt": "2020-04-21T18:20:36Z", "commit": {"oid": "e6c35747c5fedd02b4d551a626aea0da235d889d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODoyMDozN1rOGJSI4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxODoyMDozN1rOGJSI4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM4NzU1NQ==", "bodyText": "Connection is closeable :)", "url": "https://github.com/palantir/atlasdb/pull/4724#discussion_r412387555", "createdAt": "2020-04-21T18:20:37Z", "author": {"login": "j-baker"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.paxos;\n+\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import com.google.common.io.ByteStreams;\n+import com.palantir.common.base.Throwables;\n+import com.palantir.common.persist.Persistable;\n+\n+public final class SqlitePaxosStateLog<V extends Persistable & Versionable> implements PaxosStateLog<V> {\n+    private final Supplier<Connection> connectionSupplier;\n+\n+    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier) {\n+        this.connectionSupplier = connectionSupplier;\n+    }\n+\n+    public static <V extends Persistable & Versionable> PaxosStateLog<V> createInitialized(Supplier<Connection> conn) {\n+        SqlitePaxosStateLog<V> log = new SqlitePaxosStateLog<>(conn);\n+        log.initialize();\n+        return log;\n+    }\n+\n+    private void initialize() {\n+        executeVoid(\"CREATE TABLE IF NOT EXISTS paxosLog (seq BIGINT, val BLOB, CONSTRAINT pk_dual PRIMARY KEY (seq))\");\n+    }\n+\n+    @Override\n+    public void writeRound(long seq, V round) {\n+        try {\n+            PreparedStatement preparedStatement = connectionSupplier.get().prepareStatement(\n+                    \"INSERT OR REPLACE INTO paxosLog (seq, val) VALUES (?, ?)\");\n+            preparedStatement.setLong(1, seq);\n+            preparedStatement.setBytes(2, round.persistToBytes());\n+            preparedStatement.execute();\n+        } catch (SQLException e) {\n+            throw Throwables.rewrapAndThrowUncheckedException(e);\n+        }\n+    }\n+\n+    @Override\n+    public byte[] readRound(long seq) {\n+        return executeStatement(String.format(\"SELECT val FROM paxosLog WHERE seq = %s\", seq))\n+                .map(SqlitePaxosStateLog::getByteArrayUnchecked)\n+                .orElse(null);\n+    }\n+\n+    @Override\n+    public long getLeastLogEntry() {\n+        return executeStatement(\"SELECT MIN(seq) FROM paxosLog\")\n+                .map(SqlitePaxosStateLog::getLongResultUnchecked)\n+                .orElse(PaxosAcceptor.NO_LOG_ENTRY);\n+    }\n+\n+    @Override\n+    public long getGreatestLogEntry() {\n+        return executeStatement(\"SELECT MAX(seq) FROM paxosLog\")\n+                .map(SqlitePaxosStateLog::getLongResultUnchecked)\n+                .orElse(PaxosAcceptor.NO_LOG_ENTRY);\n+    }\n+\n+    @Override\n+    public void truncate(long toDeleteInclusive) {\n+        executeVoid(String.format(\"DELETE FROM paxosLog WHERE seq <= %s\", toDeleteInclusive));\n+    }\n+\n+    private void executeVoid(String statement) {\n+        try {\n+            connectionSupplier.get().prepareStatement(statement).execute();\n+        } catch (SQLException e) {\n+            throw Throwables.rewrapAndThrowUncheckedException(e);\n+        }\n+    }\n+\n+    private Optional<ResultSet> executeStatement(String statement) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6c35747c5fedd02b4d551a626aea0da235d889d"}, "originalPosition": 95}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NzA0NzU5", "url": "https://github.com/palantir/atlasdb/pull/4724#pullrequestreview-397704759", "createdAt": "2020-04-21T21:56:04Z", "commit": {"oid": "e6c35747c5fedd02b4d551a626aea0da235d889d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTo1NjowNVrOGJaKsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTo1NjowNVrOGJaKsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUxOTA4OA==", "bodyText": "Do we not need an index for these queries?", "url": "https://github.com/palantir/atlasdb/pull/4724#discussion_r412519088", "createdAt": "2020-04-21T21:56:05Z", "author": {"login": "jkozlowski"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.paxos;\n+\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import com.google.common.io.ByteStreams;\n+import com.palantir.common.base.Throwables;\n+import com.palantir.common.persist.Persistable;\n+\n+public final class SqlitePaxosStateLog<V extends Persistable & Versionable> implements PaxosStateLog<V> {\n+    private final Supplier<Connection> connectionSupplier;\n+\n+    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier) {\n+        this.connectionSupplier = connectionSupplier;\n+    }\n+\n+    public static <V extends Persistable & Versionable> PaxosStateLog<V> createInitialized(Supplier<Connection> conn) {\n+        SqlitePaxosStateLog<V> log = new SqlitePaxosStateLog<>(conn);\n+        log.initialize();\n+        return log;\n+    }\n+\n+    private void initialize() {\n+        executeVoid(\"CREATE TABLE IF NOT EXISTS paxosLog (seq BIGINT, val BLOB, CONSTRAINT pk_dual PRIMARY KEY (seq))\");\n+    }\n+\n+    @Override\n+    public void writeRound(long seq, V round) {\n+        try {\n+            PreparedStatement preparedStatement = connectionSupplier.get().prepareStatement(\n+                    \"INSERT OR REPLACE INTO paxosLog (seq, val) VALUES (?, ?)\");\n+            preparedStatement.setLong(1, seq);\n+            preparedStatement.setBytes(2, round.persistToBytes());\n+            preparedStatement.execute();\n+        } catch (SQLException e) {\n+            throw Throwables.rewrapAndThrowUncheckedException(e);\n+        }\n+    }\n+\n+    @Override\n+    public byte[] readRound(long seq) {\n+        return executeStatement(String.format(\"SELECT val FROM paxosLog WHERE seq = %s\", seq))\n+                .map(SqlitePaxosStateLog::getByteArrayUnchecked)\n+                .orElse(null);\n+    }\n+\n+    @Override\n+    public long getLeastLogEntry() {\n+        return executeStatement(\"SELECT MIN(seq) FROM paxosLog\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6c35747c5fedd02b4d551a626aea0da235d889d"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NzA1OTA5", "url": "https://github.com/palantir/atlasdb/pull/4724#pullrequestreview-397705909", "createdAt": "2020-04-21T21:58:10Z", "commit": {"oid": "e6c35747c5fedd02b4d551a626aea0da235d889d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTo1ODoxMFrOGJaO7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMTo1ODoxMFrOGJaO7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjUyMDE3Mg==", "bodyText": "Who closes the connection?", "url": "https://github.com/palantir/atlasdb/pull/4724#discussion_r412520172", "createdAt": "2020-04-21T21:58:10Z", "author": {"login": "jkozlowski"}, "path": "leader-election-impl/src/main/java/com/palantir/paxos/SqlitePaxosStateLog.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.paxos;\n+\n+import java.io.IOException;\n+import java.sql.Connection;\n+import java.sql.PreparedStatement;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import com.google.common.io.ByteStreams;\n+import com.palantir.common.base.Throwables;\n+import com.palantir.common.persist.Persistable;\n+\n+public final class SqlitePaxosStateLog<V extends Persistable & Versionable> implements PaxosStateLog<V> {\n+    private final Supplier<Connection> connectionSupplier;\n+\n+    private SqlitePaxosStateLog(Supplier<Connection> connectionSupplier) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6c35747c5fedd02b4d551a626aea0da235d889d"}, "originalPosition": 34}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3081, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}