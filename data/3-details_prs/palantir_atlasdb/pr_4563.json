{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNjQ0MDg4", "number": 4563, "title": "Make createProxy retain refreshing capabilities.", "bodyText": "Goals (and why):\nAs part of figuring out why Timelock is OOMing, rolling back potentially contentious changes that occurred between 0.185.3 and 0.185.4 of Atlas\nImplementation Description (bullets):\nRestore the client refreshing behaviour but drop the extra metrics.\nTesting (What was existing testing like?  What have you done to improve it?):\nExisting tests should pass\nConcerns (what feedback would you like?):\nis null the worst thing here?\nWhere should we start reviewing?:\nEverywhere\nPriority (whenever / two weeks / yesterday):\nASAP \ud83d\udc83", "createdAt": "2020-02-11T12:57:13Z", "url": "https://github.com/palantir/atlasdb/pull/4563", "merged": true, "mergeCommit": {"oid": "82133eced0d2a593b92d03236eb3d1aa73ba2a84"}, "closed": true, "closedAt": "2020-02-11T13:23:51Z", "author": {"login": "felixdesouza"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDRNivAH2gAyMzczNjQ0MDg4Ojg5YmQyYjg0YjFjMTBiYjJhNjZjNDVmYmM3OWE5ODk4ODNmYWI3OTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDRae3AFqTM1NjYzODE4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "89bd2b84b1c10bb2a66c45fbc79a989883fab793", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/89bd2b84b1c10bb2a66c45fbc79a989883fab793", "committedDate": "2020-02-11T12:51:02Z", "message": "Make createProxy retain refreshing capabilities."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "459cbc0bc133c352827cd92fe35c1d6fdd9a85bc", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/459cbc0bc133c352827cd92fe35c1d6fdd9a85bc", "committedDate": "2020-02-11T13:02:33Z", "message": "Add changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b01eacdc683319c099a517aa56b0f4abe7fdd01", "author": {"user": {"login": "felixdesouza", "name": "Felix de Souza"}}, "url": "https://github.com/palantir/atlasdb/commit/8b01eacdc683319c099a517aa56b0f4abe7fdd01", "committedDate": "2020-02-11T13:04:16Z", "message": "Fix up test."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NjM4MTg2", "url": "https://github.com/palantir/atlasdb/pull/4563#pullrequestreview-356638186", "createdAt": "2020-02-11T13:04:28Z", "commit": {"oid": "459cbc0bc133c352827cd92fe35c1d6fdd9a85bc"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMzowNDoyOFrOFoIISw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMzowNTowNFrOFoIJTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyMDU1NQ==", "bodyText": "Is ok, since useExperimental is true and useFallback false. Is not great, but maybe exploding if we get into this kind of state that we don't expect is possible is not the worst reaction.", "url": "https://github.com/palantir/atlasdb/pull/4563#discussion_r377620555", "createdAt": "2020-02-11T13:04:28Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/http/VersionSelectingClients.java", "diffHunk": "@@ -83,6 +84,19 @@ private VersionSelectingClients() {\n                 errorMetric::increment);\n     }\n \n+    static <T> T createRefreshingNewClient(\n+            Supplier<TargetFactory.InstanceAndVersion<T>> newClientSupplier,\n+            Class<T> clazz) {\n+\n+        return ExperimentRunningProxy.newProxyInstance(\n+                Suppliers.compose(TargetFactory.InstanceAndVersion::instance, newClientSupplier::get),\n+                null,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "459cbc0bc133c352827cd92fe35c1d6fdd9a85bc"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyMDc2MQ==", "bodyText": "wat \ud83e\udd86", "url": "https://github.com/palantir/atlasdb/pull/4563#discussion_r377620761", "createdAt": "2020-02-11T13:04:57Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/LeadersTest.java", "diffHunk": "@@ -116,7 +116,7 @@ public void createProxyAndLocalListCreatesSingletonListIfNoRemoteAddressesProvid\n         verifyNoMoreInteractions(localAcceptor);\n     }\n \n-    @Test(expected = IllegalStateException.class)\n+    @Test(expected = IllegalArgumentException.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b01eacdc683319c099a517aa56b0f4abe7fdd01"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzYyMDgxNQ==", "bodyText": "nit: fix?", "url": "https://github.com/palantir/atlasdb/pull/4563#discussion_r377620815", "createdAt": "2020-02-11T13:05:04Z", "author": {"login": "jeremyk-91"}, "path": "changelog/@unreleased/pr-4563.v2.yml", "diffHunk": "@@ -0,0 +1,6 @@\n+type: improvement\n+improvement:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b01eacdc683319c099a517aa56b0f4abe7fdd01"}, "originalPosition": 2}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2253, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}