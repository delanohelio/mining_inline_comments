{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNzkxOTA4", "number": 4827, "title": "[LW] Change TransactionLockWatchEvents interface", "bodyText": "Goals (and why):\n\nThis change is introduced in #4806, but that is taking a long time to go through and changes in atlasdb-proxy depends on this.\n\nImplementation Description (bullets):\n\nRemoved visitor pattern from TransactionLockWatchEvents; the intent is to always provide an update, even on snapshot.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nN/A\nConcerns (what feedback would you like?):\n\nIs this considered a breaking change? Do we need to do a revapi anywhere as a result of this change?\n\nWhere should we start reviewing?:\n\nTransactionLockWatchEvents\nNoOpLockWatchEventCache\n\nPriority (whenever / two weeks / yesterday):\nSoon", "createdAt": "2020-06-09T13:25:15Z", "url": "https://github.com/palantir/atlasdb/pull/4827", "merged": true, "mergeCommit": {"oid": "52f541ce46f5300716c3c335a641dbb542ab5935"}, "closed": true, "closedAt": "2020-06-09T14:05:32Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpk_b_gH2gAyNDMxNzkxOTA4OmFlNGIyM2Q2ZjM3MDU4Zjg0MjI5NmFlNjNmNDYxODdiOWNjYjU2MTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcplZWMgH2gAyNDMxNzkxOTA4OjhmMDZiYjc1ZjYxMGU5ODdmODJjZDA5ZTVkZDUwMzQ2OTlmOWZlNTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ae4b23d6f37058f842296ae63f46187b9ccb5611", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/ae4b23d6f37058f842296ae63f46187b9ccb5611", "committedDate": "2020-06-09T13:22:51Z", "message": "bring over necessary changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e4137d7eb1d4f506c3f6ab42291318280ac6320", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/5e4137d7eb1d4f506c3f6ab42291318280ac6320", "committedDate": "2020-06-09T13:22:51Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTQ5MzQ1", "url": "https://github.com/palantir/atlasdb/pull/4827#pullrequestreview-427149345", "createdAt": "2020-06-09T13:33:46Z", "commit": {"oid": "5e4137d7eb1d4f506c3f6ab42291318280ac6320"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzozMzo0NlrOGhKATw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzozNjo1OVrOGhKJiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyMDExMQ==", "bodyText": "This now needs to generate a new random UUID on each call to getEventsForTransactions - is that intentional? I thought -1 as a sequence number was enough to indicate that the Events value was meaningless.", "url": "https://github.com/palantir/atlasdb/pull/4827#discussion_r437420111", "createdAt": "2020-06-09T13:33:46Z", "author": {"login": "jeremyk-91"}, "path": "lock-api-objects/src/main/java/com/palantir/lock/watch/NoOpLockWatchEventCache.java", "diffHunk": "@@ -55,10 +52,19 @@ public CommitUpdate getCommitUpdate(long startTs) {\n     @Override\n     public TransactionsLockWatchEvents getEventsForTransactions(Set<Long> startTimestamps,\n             Optional<IdentifiedVersion> version) {\n-        return NONE;\n+        IdentifiedVersion fakeVersion = generateFakeVersion();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e4137d7eb1d4f506c3f6ab42291318280ac6320"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyMjI5Mw==", "bodyText": "I see why we'd want a boolean here, though this class feels like it should be renamed - it's quite a bit more than just the events now. Maybe TransactionsLockWatchUpdate?", "url": "https://github.com/palantir/atlasdb/pull/4827#discussion_r437422293", "createdAt": "2020-06-09T13:36:44Z", "author": {"login": "jeremyk-91"}, "path": "lock-api-objects/src/main/java/com/palantir/lock/watch/TransactionsLockWatchEvents.java", "diffHunk": "@@ -25,53 +25,9 @@\n  * Represents a condensed view of lock watch events occurring between some known version and a set of start transaction\n  * calls.\n  */\n+@Value.Immutable\n public interface TransactionsLockWatchEvents {\n-    <T> T accept(Visitor<T> visitor);\n-\n-    interface Visitor<T> {\n-        T visit(Events success);\n-        T visit(ForcedSnapshot failure);\n-    }\n-\n-    static Events success(List<LockWatchEvent> events, Map<Long, Long> startTsToSequence) {\n-        return ImmutableEvents.of(events, startTsToSequence);\n-    }\n-\n-    static ForcedSnapshot failure(LockWatchStateUpdate.Snapshot snapshot) {\n-        return ImmutableForcedSnapshot.of(snapshot);\n-    }\n-\n-    /**\n-     * A successful result contains a list of all lock watch events occurring between the last known version and the\n-     * last started transaction, and a mapping of start timestamps to their respective last occurred event.\n-     */\n-    @Value.Immutable\n-    interface Events extends TransactionsLockWatchEvents {\n-        @Value.Parameter\n-        List<LockWatchEvent> events();\n-        @Value.Parameter\n-        Map<Long, Long> startTsToSequence();\n-\n-        @Override\n-        default <T> T accept(Visitor<T> visitor) {\n-            return visitor.visit(this);\n-        }\n-    }\n-\n-    /**\n-     * A failure denotes that it was not possible to compute the result for all of the requested transactions. Since\n-     * that generally implies we will fail to get the necessary information for the commit timestamp anyway, instead of\n-     * giving partial information, we return a single snapshot that should be used to reseed the state of lock watches\n-     * for all future transactions.\n-     */\n-    @Value.Immutable\n-    interface ForcedSnapshot extends TransactionsLockWatchEvents {\n-        @Value.Parameter\n-        LockWatchStateUpdate.Snapshot snapshot();\n-\n-        @Override\n-        default <T> T accept(Visitor<T> visitor) {\n-            return visitor.visit(this);\n-        }\n-    }\n+    List<LockWatchEvent> events();\n+    Map<Long, IdentifiedVersion> startTsToSequence();\n+    boolean clearCache();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e4137d7eb1d4f506c3f6ab42291318280ac6320"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyMjQ3Mw==", "bodyText": "nit: If we want to keep this, this should be static. Though I think having a constant for the UUID would be preferable", "url": "https://github.com/palantir/atlasdb/pull/4827#discussion_r437422473", "createdAt": "2020-06-09T13:36:59Z", "author": {"login": "jeremyk-91"}, "path": "lock-api-objects/src/main/java/com/palantir/lock/watch/NoOpLockWatchEventCache.java", "diffHunk": "@@ -55,10 +52,19 @@ public CommitUpdate getCommitUpdate(long startTs) {\n     @Override\n     public TransactionsLockWatchEvents getEventsForTransactions(Set<Long> startTimestamps,\n             Optional<IdentifiedVersion> version) {\n-        return NONE;\n+        IdentifiedVersion fakeVersion = generateFakeVersion();\n+        return ImmutableTransactionsLockWatchEvents.builder()\n+                .clearCache(true)\n+                .startTsToSequence(\n+                        startTimestamps.stream().collect(Collectors.toMap(startTs -> startTs, $ -> fakeVersion)))\n+                .build();\n     }\n \n     @Override\n     public void removeTransactionStateFromCache(long startTimestamp) {\n     }\n+\n+    private IdentifiedVersion generateFakeVersion() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e4137d7eb1d4f506c3f6ab42291318280ac6320"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca01b2d4a453e6b10948173f504550562a516bd3", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/ca01b2d4a453e6b10948173f504550562a516bd3", "committedDate": "2020-06-09T13:45:09Z", "message": "rename"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTY3NzI5", "url": "https://github.com/palantir/atlasdb/pull/4827#pullrequestreview-427167729", "createdAt": "2020-06-09T13:47:28Z", "commit": {"oid": "ca01b2d4a453e6b10948173f504550562a516bd3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f06bb75f610e987f82cd09e5dd5034699f9fe51", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/8f06bb75f610e987f82cd09e5dd5034699f9fe51", "committedDate": "2020-06-09T13:51:09Z", "message": "fix annoying mistake"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2926, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}