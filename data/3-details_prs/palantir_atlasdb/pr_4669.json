{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMTk3MDQ0", "number": 4669, "title": "Lazy Initialization for ReplaceIfExceptionMatchingProxy", "bodyText": "Goals (and why):\n\nMake ReplaceIfExceptionMatchingProxy lazy. Generally AtlasDbHttpClients classes should attempt not to do eager initialisations, because this can result in ordering issues with setting up global OkHttp state (e.g. for Conscrypt in various internal servers).\n\nImplementation Description (bullets):\n\nMaybe initialise the delegate as part of each invocation, rather than doing it upfront.\nImplement this with a double-checked locking algorithm to minimise perf overhead.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nAdded 1 test for the lazy initialisation case. Existing tests still pass.\nConcerns (what feedback would you like?):\n\nIs there a concurrency bug?\nFor replaceIfNecessary, it seemed weird we did another get on the supplier. I know in the specific use case it is memoized-with-expiration, but seems like an unexpected dependency.\n\nWhere should we start reviewing?: ReplaceIfExceptionMatchingProxy\nPriority (whenever / two weeks / yesterday): Wednesday please, blocks internal rolling investigations because an important internal service cannot take AtlasDB bumps since this was introduced.", "createdAt": "2020-03-24T18:51:52Z", "url": "https://github.com/palantir/atlasdb/pull/4669", "merged": true, "mergeCommit": {"oid": "a7ef819be080c85b64edc06673095fbd084b4d01"}, "closed": true, "closedAt": "2020-03-25T13:56:07Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQ3a3yAH2gAyMzkzMTk3MDQ0OmNlOTI2YTA3M2IwMGYyOWI3YmVhNGU5OTc3ZjFlMzhhYjllNzMzOTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRHWT7AH2gAyMzkzMTk3MDQ0OmVhYTBjNjE1ZDgwMTNhZTFlMGZjMDMwNmI5Y2MxMWYzM2JkY2VhYzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ce926a073b00f29b7bea4e9977f1e38ab9e73393", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/ce926a073b00f29b7bea4e9977f1e38ab9e73393", "committedDate": "2020-03-24T18:43:00Z", "message": "Lazy initialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34e6f91de724a2722dcb335e30bc373f5f26c80e", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/34e6f91de724a2722dcb335e30bc373f5f26c80e", "committedDate": "2020-03-24T18:43:00Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d079904fb6238ec4766c75561e7438ed7bb2c66", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/3d079904fb6238ec4766c75561e7438ed7bb2c66", "committedDate": "2020-03-24T18:43:00Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d3e55b96e665c73dc4392dd8eeece4edf75be58", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/7d3e55b96e665c73dc4392dd8eeece4edf75be58", "committedDate": "2020-03-24T18:54:33Z", "message": "test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNjIyNzU3", "url": "https://github.com/palantir/atlasdb/pull/4669#pullrequestreview-380622757", "createdAt": "2020-03-24T19:16:04Z", "commit": {"oid": "7d3e55b96e665c73dc4392dd8eeece4edf75be58"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "621429ee55656e95488f296a7e7a80b5d37fbd36", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/621429ee55656e95488f296a7e7a80b5d37fbd36", "committedDate": "2020-03-25T10:58:02Z", "message": "Remove volatile read"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMDMzODgy", "url": "https://github.com/palantir/atlasdb/pull/4669#pullrequestreview-381033882", "createdAt": "2020-03-25T10:45:26Z", "commit": {"oid": "7d3e55b96e665c73dc4392dd8eeece4edf75be58"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMDo0NToyN1rOF7VU_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMDo1NjozNVrOF7VuAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc1OTc0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    T perceivedDelegate = delegate;\n          \n          \n            \n                    if (delegate == null) {\n          \n          \n            \n                        synchronized (this) {\n          \n          \n            \n                            if (delegate == null) {\n          \n          \n            \n                                delegate = delegateFactory.get();\n          \n          \n            \n                            }\n          \n          \n            \n                        }\n          \n          \n            \n                    }", "url": "https://github.com/palantir/atlasdb/pull/4669#discussion_r397759742", "createdAt": "2020-03-25T10:45:27Z", "author": {"login": "gmaretic"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -51,13 +51,25 @@ protected Object handleInvocation(Object proxy, Method method, Object[] args) th\n         }\n     }\n \n+    private void setUpDelegateIfNecessary() {\n+        T perceivedDelegate = delegate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d3e55b96e665c73dc4392dd8eeece4edf75be58"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc2NjE0NQ==", "bodyText": "This is kinda funky, because the expected behaviour depends on delegateFactory.get() being memoized both for this check to even make sense and to avoid a \"creation storm\". I think the memoization should be explicitly done in this class, maybe by having factory method that takes a non-memoized delegateFactory, and an expiration time and then memoizes it?", "url": "https://github.com/palantir/atlasdb/pull/4669#discussion_r397766145", "createdAt": "2020-03-25T10:56:35Z", "author": {"login": "gmaretic"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -51,13 +51,25 @@ protected Object handleInvocation(Object proxy, Method method, Object[] args) th\n         }\n     }\n \n+    private void setUpDelegateIfNecessary() {\n+        T perceivedDelegate = delegate;\n+        if (perceivedDelegate == null) {\n+            synchronized (this) {\n+                perceivedDelegate = delegate;\n+                if (perceivedDelegate == null) {\n+                    delegate = delegateFactory.get();\n+                }\n+            }\n+        }\n+    }\n+\n     private void replaceIfNecessary(Throwable thrown) {\n         if (shouldReplace.test(thrown)) {\n             synchronized (this) {\n                 T replacement = delegateFactory.get();\n                 if (delegate != replacement) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d3e55b96e665c73dc4392dd8eeece4edf75be58"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dba9dc1d12eae7bde375a9c4896ac5701b07912e", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/dba9dc1d12eae7bde375a9c4896ac5701b07912e", "committedDate": "2020-03-25T11:44:20Z", "message": "Refactor memoization to a factory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44937a2daa4de721c868cf9e776d46e12c4ec70a", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/44937a2daa4de721c868cf9e776d46e12c4ec70a", "committedDate": "2020-03-25T11:53:35Z", "message": "oops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMDc5Njg0", "url": "https://github.com/palantir/atlasdb/pull/4669#pullrequestreview-381079684", "createdAt": "2020-03-25T11:56:23Z", "commit": {"oid": "44937a2daa4de721c868cf9e776d46e12c4ec70a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMTo1NjoyM1rOF7XtKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxMTo1NjoyM1rOF7XtKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzc5ODY5Nw==", "bodyText": ":P", "url": "https://github.com/palantir/atlasdb/pull/4669#discussion_r397798697", "createdAt": "2020-03-25T11:56:23Z", "author": {"login": "gmaretic"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/http/AtlasDbHttpClients.java", "diffHunk": "@@ -111,7 +111,7 @@ private AtlasDbHttpClients() {\n     private static <T> T wrapWithOkHttpBugHandling(Class<T> type, Supplier<T> supplier) {\n         return ReplaceIfExceptionMatchingProxy.create(\n                 type,\n-                supplier::get,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44937a2daa4de721c868cf9e776d46e12c4ec70a"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaa0c615d8013ae1e0fc0306b9cc11f33bdceac9", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/eaa0c615d8013ae1e0fc0306b9cc11f33bdceac9", "committedDate": "2020-03-25T13:16:30Z", "message": "Fix checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2998, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}