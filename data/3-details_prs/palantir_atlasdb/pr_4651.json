{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg4MDM0MDE0", "number": 4651, "title": "Make #close safer.", "bodyText": "Goals (and why):\nCurrently any exception thrown from cleaning up TransactionManager resources will abort the running of closing callbacks.\nImplementation Description (bullets):\n\nI have removed the suppressed exception propagation, since we already log the individual exceptions.\nI made the log messages more generic.\nExtracted a small utility class to track the failure.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nConcerns (what feedback would you like?):\nWhere should we start reviewing?:\nPriority (whenever / two weeks / yesterday):", "createdAt": "2020-03-13T22:30:03Z", "url": "https://github.com/palantir/atlasdb/pull/4651", "merged": true, "mergeCommit": {"oid": "b9dcd59a1caeb5b4c78f6347e3027014c2aed05c"}, "closed": true, "closedAt": "2020-03-26T14:14:01Z", "author": {"login": "jkozlowski"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNX_95gH2gAyMzg4MDM0MDE0OjI3MDU4MzE3NjM1ODZhNjYzMmNjNTY3ODg5YmQyZGU5ZWMyOWI0NTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRcBARAFqTM4MTk5OTk3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2705831763586a6632cc567889bd2de9ec29b456", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/2705831763586a6632cc567889bd2de9ec29b456", "committedDate": "2020-03-13T22:24:47Z", "message": "Always run full cleanup."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NjY4MTYy", "url": "https://github.com/palantir/atlasdb/pull/4651#pullrequestreview-374668162", "createdAt": "2020-03-13T23:31:19Z", "commit": {"oid": "2705831763586a6632cc567889bd2de9ec29b456"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMzozMToyMFrOF2V-aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMzozMToyMFrOF2V-aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyNzQ2NQ==", "bodyText": "curious if we should just use try-with-resources\n    @Override\n    @SuppressWarnings(\"unused\") // try-with-resources closes everything\n    public void close() {\n        if (isClosed.compareAndSet(false, true)) {\n            SafeRuntimeException exception = new SafeRuntimeException(\"Close failed.\");\n            try {\n                try (AutoCloseable closeParent = super::close;\n                        AutoCloseable closeCleaner = cleaner;\n                        AutoCloseable closeKvs = keyValueService;\n                        AutoCloseable closeDelegate = () -> shutdownExecutor(deleteExecutor);\n                        AutoCloseable closeRanges = () -> shutdownExecutor(getRangesExecutor);\n                        AutoCloseable closeLockServiceIfPossible = this::closeLockServiceIfPossible;\n                        AutoCloseable closeMetrics = metricsManager::deregisterMetrics) {\n                    log.info(\"Shutting down transaction manager\");\n                    for (Runnable callback : Lists.reverse(closingCallbacks)) {\n                        try (AutoCloseable closeCallback = callback::run) {\n                            log.info(\"Closing callback\");\n                        } catch (Throwable t) {\n                            exception.addSuppressed(t);\n                        }\n                    }\n                }\n            } catch (Exception e) {\n                exception.initCause(e);\n                throw exception;\n            }\n        }\n    }", "url": "https://github.com/palantir/atlasdb/pull/4651#discussion_r392527465", "createdAt": "2020-03-13T23:31:20Z", "author": {"login": "schlosna"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransactionManager.java", "diffHunk": "@@ -327,24 +326,24 @@ public void registerClosingCallback(Runnable closingCallback) {\n     @Override\n     public void close() {\n         if (isClosed.compareAndSet(false, true)) {\n-            super.close();\n-            cleaner.close();\n-            keyValueService.close();\n-            shutdownExecutor(deleteExecutor);\n-            shutdownExecutor(getRangesExecutor);\n-            closeLockServiceIfPossible();\n-\n-            List<Throwable> suppressedExceptions = new ArrayList<>();\n+\n+            ShutdownRunner shutdownRunner = new ShutdownRunner();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2705831763586a6632cc567889bd2de9ec29b456"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ee85dfb163e2bd7fd4be28cfe54dd546a418589", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/4ee85dfb163e2bd7fd4be28cfe54dd546a418589", "committedDate": "2020-03-16T08:54:03Z", "message": "Use AutoCloseable and return early."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MTE0NDUx", "url": "https://github.com/palantir/atlasdb/pull/4651#pullrequestreview-375114451", "createdAt": "2020-03-16T11:14:24Z", "commit": {"oid": "4ee85dfb163e2bd7fd4be28cfe54dd546a418589"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMToxNDoyNFrOF2vcbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMToxNDoyNFrOF2vcbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0NDc0OQ==", "bodyText": "Given that there is a test for this class, would you be able to add any tests that verify this new behaviour (i.e. what happens when an exception is thrown during close)?", "url": "https://github.com/palantir/atlasdb/pull/4651#discussion_r392944749", "createdAt": "2020-03-16T11:14:24Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransactionManager.java", "diffHunk": "@@ -326,26 +325,23 @@ public void registerClosingCallback(Runnable closingCallback) {\n      */\n     @Override\n     public void close() {\n-        if (isClosed.compareAndSet(false, true)) {\n-            super.close();\n-            cleaner.close();\n-            keyValueService.close();\n-            shutdownExecutor(deleteExecutor);\n-            shutdownExecutor(getRangesExecutor);\n-            closeLockServiceIfPossible();\n-\n-            List<Throwable> suppressedExceptions = new ArrayList<>();\n+        if (!isClosed.compareAndSet(false, true)) {\n+            return;\n+        }\n+\n+        try (ShutdownRunner shutdownRunner = new ShutdownRunner()) {\n+            shutdownRunner.shutdownSafely(super::close);\n+            shutdownRunner.shutdownSafely(cleaner::close);\n+            shutdownRunner.shutdownSafely(keyValueService::close);\n+            shutdownRunner.shutdownSafely(() -> shutdownExecutor(deleteExecutor));\n+            shutdownRunner.shutdownSafely(() -> shutdownExecutor(getRangesExecutor));\n+            shutdownRunner.shutdownSafely(this::closeLockServiceIfPossible);\n+\n             for (Runnable callback : Lists.reverse(closingCallbacks)) {\n-                runShutdownCallbackSafely(callback).ifPresent(suppressedExceptions::add);\n+                shutdownRunner.shutdownSafely(callback);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ee85dfb163e2bd7fd4be28cfe54dd546a418589"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6a98a4f5b597054b0ad261ec26839d9e3a68bd2", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/e6a98a4f5b597054b0ad261ec26839d9e3a68bd2", "committedDate": "2020-03-26T11:44:46Z", "message": "Save."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73a22991f894d4f57ec3d9d2715dbfeff136edee", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/73a22991f894d4f57ec3d9d2715dbfeff136edee", "committedDate": "2020-03-26T11:45:07Z", "message": "Merge branch 'develop' into safe-cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34c205ff90f808ef315e1ed69271ba6a5df40ad2", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/34c205ff90f808ef315e1ed69271ba6a5df40ad2", "committedDate": "2020-03-26T11:46:18Z", "message": "Fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cd8b9c487a204304ca20ef2123b160aa0ee043a", "author": {"user": {"login": "jkozlowski", "name": "Jakub Kozlowski"}}, "url": "https://github.com/palantir/atlasdb/commit/7cd8b9c487a204304ca20ef2123b160aa0ee043a", "committedDate": "2020-03-26T12:13:13Z", "message": "More tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxOTQ5NDk0", "url": "https://github.com/palantir/atlasdb/pull/4651#pullrequestreview-381949494", "createdAt": "2020-03-26T12:14:45Z", "commit": {"oid": "7cd8b9c487a204304ca20ef2123b160aa0ee043a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjoxNDo0NVrOF8ECew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjoxNDo0NVrOF8ECew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyNTA1MQ==", "bodyText": "Diff here is much better in IntelliJ. The order should be exactly the same, just wrapped with shutdownSafely calls", "url": "https://github.com/palantir/atlasdb/pull/4651#discussion_r398525051", "createdAt": "2020-03-26T12:14:45Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/transaction/impl/SnapshotTransactionManager.java", "diffHunk": "@@ -326,26 +326,23 @@ public void registerClosingCallback(Runnable closingCallback) {\n      */\n     @Override\n     public void close() {\n-        if (isClosed.compareAndSet(false, true)) {\n-            super.close();\n-            cleaner.close();\n-            keyValueService.close();\n-            shutdownExecutor(deleteExecutor);\n-            shutdownExecutor(getRangesExecutor);\n-            closeLockServiceIfPossible();\n-\n-            List<Throwable> suppressedExceptions = new ArrayList<>();\n+        if (!isClosed.compareAndSet(false, true)) {\n+            return;\n+        }\n+\n+        try (ShutdownRunner shutdownRunner = new ShutdownRunner()) {\n+            shutdownRunner.shutdownSafely(super::close);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cd8b9c487a204304ca20ef2123b160aa0ee043a"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxOTk5OTcz", "url": "https://github.com/palantir/atlasdb/pull/4651#pullrequestreview-381999973", "createdAt": "2020-03-26T13:21:14Z", "commit": {"oid": "7cd8b9c487a204304ca20ef2123b160aa0ee043a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2972, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}