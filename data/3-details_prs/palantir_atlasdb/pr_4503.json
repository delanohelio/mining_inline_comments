{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNTA2MjE5", "number": 4503, "title": "Off-heap timestamp cache and persistent storage integration", "bodyText": "Goals (and why):\nEnable usage of off-heap persistent storage for timestamp caching.\nImplementation Description (bullets):\n\nif TimestampCache is supplied we use the supplied one\nif persistent storage is not enabled use the in-memory one\n\nTesting (What was existing testing like?  What have you done to improve it?):\n\nadded integration tests to confirm that cache is working\n\nConcerns (what feedback would you like?):\n\ndo we even need the comparing one or just parameterize\nWhere should we start reviewing?:\nTransactionManagers\n\nPriority (whenever / two weeks / yesterday):\ntoday", "createdAt": "2020-01-10T15:39:55Z", "url": "https://github.com/palantir/atlasdb/pull/4503", "merged": true, "mergeCommit": {"oid": "4971ce2cbdf5953f8199675742a8849a627c9a76"}, "closed": true, "closedAt": "2020-01-14T19:42:17Z", "author": {"login": "OStevan"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb55EfDABqjI5NDI0NDEzMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6WJyGAH2gAyMzYxNTA2MjE5OjUwM2RmYmRlODYwM2ViYmE0NWU3NjliOWYyNTNkYzVkNThmNzFkMzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "61ada1c998abc76cbcfa772deb3a74d6cda708b1", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/61ada1c998abc76cbcfa772deb3a74d6cda708b1", "committedDate": "2020-01-10T16:00:45Z", "message": "Keeping with the standard convention."}, "afterCommit": {"oid": "ad20b75ae970cbdd4662431f0903e678a6136c48", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/ad20b75ae970cbdd4662431f0903e678a6136c48", "committedDate": "2020-01-13T09:37:43Z", "message": "Keeping with the standard convention."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ad20b75ae970cbdd4662431f0903e678a6136c48", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/ad20b75ae970cbdd4662431f0903e678a6136c48", "committedDate": "2020-01-13T09:37:43Z", "message": "Keeping with the standard convention."}, "afterCommit": {"oid": "4c5fe75b740e8254cc4350cef33e939387aa466d", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/4c5fe75b740e8254cc4350cef33e939387aa466d", "committedDate": "2020-01-13T14:43:04Z", "message": "Keeping with the standard convention."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c5fe75b740e8254cc4350cef33e939387aa466d", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/4c5fe75b740e8254cc4350cef33e939387aa466d", "committedDate": "2020-01-13T14:43:04Z", "message": "Keeping with the standard convention."}, "afterCommit": {"oid": "28396260565a54b384a4f1297a8fc043488f38d2", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/28396260565a54b384a4f1297a8fc043488f38d2", "committedDate": "2020-01-13T15:21:18Z", "message": "Small refactor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ddf10adf49bc946ac4981fba55178f08f5719f7", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/8ddf10adf49bc946ac4981fba55178f08f5719f7", "committedDate": "2020-01-13T18:37:07Z", "message": "Enable persistent storage config."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "793e5882a7cc09fdbaa7ec2f2c760dbb5ed2f804", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/793e5882a7cc09fdbaa7ec2f2c760dbb5ed2f804", "committedDate": "2020-01-13T18:37:07Z", "message": "Added a more detailed check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa7716691d9a3eb667a7c9f8dbbbf17983edf845", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/fa7716691d9a3eb667a7c9f8dbbbf17983edf845", "committedDate": "2020-01-13T18:37:07Z", "message": "ComparingTimestampCache implementation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "804cf37b8e1710984b7eafca75648599c468bfb2", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/804cf37b8e1710984b7eafca75648599c468bfb2", "committedDate": "2020-01-13T18:37:07Z", "message": "Refactor creation of TestTransactionManagerImpl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e157957a33e85d616051a073fbd0fa4c4df89a7", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/6e157957a33e85d616051a073fbd0fa4c4df89a7", "committedDate": "2020-01-13T18:37:07Z", "message": "Add tests for TimestampCache integration."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e7d30832acec4be42da4b6384cb7a9f63f4cb39", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/0e7d30832acec4be42da4b6384cb7a9f63f4cb39", "committedDate": "2020-01-13T18:37:07Z", "message": "Fix the tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96210e7050422fed4658d815b43845e3b914def5", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/96210e7050422fed4658d815b43845e3b914def5", "committedDate": "2020-01-13T18:37:07Z", "message": "Keeping with the standard convention."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96cd845b24a99dc586c5766ed6db6980c6c6da2a", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/96cd845b24a99dc586c5766ed6db6980c6c6da2a", "committedDate": "2020-01-13T18:37:07Z", "message": "Small refactor."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f25387480f90b092a335771d79ed396bea6d71b", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/1f25387480f90b092a335771d79ed396bea6d71b", "committedDate": "2020-01-13T18:37:07Z", "message": "Change config and add more info."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d61e02af57f160bf18ef9a9d5bb7b09b0f774e7", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/5d61e02af57f160bf18ef9a9d5bb7b09b0f774e7", "committedDate": "2020-01-13T18:37:07Z", "message": "Update config."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5a53a09b4f826af8e7daa97dbf3e3f6450aa9b9", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/e5a53a09b4f826af8e7daa97dbf3e3f6450aa9b9", "committedDate": "2020-01-13T18:37:07Z", "message": "Better deletion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9bb3607f69b7830f66ed817b5f181dce070be0dd", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/9bb3607f69b7830f66ed817b5f181dce070be0dd", "committedDate": "2020-01-13T18:37:07Z", "message": "Test for aborting transaction."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3e2698239cf449f0658afbe62440be06ca25e61", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/c3e2698239cf449f0658afbe62440be06ca25e61", "committedDate": "2020-01-13T18:02:25Z", "message": "Test for aborting transaction."}, "afterCommit": {"oid": "9bb3607f69b7830f66ed817b5f181dce070be0dd", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/9bb3607f69b7830f66ed817b5f181dce070be0dd", "committedDate": "2020-01-13T18:37:07Z", "message": "Test for aborting transaction."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMTgxNjYz", "url": "https://github.com/palantir/atlasdb/pull/4503#pullrequestreview-342181663", "createdAt": "2020-01-13T22:25:06Z", "commit": {"oid": "9bb3607f69b7830f66ed817b5f181dce070be0dd"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMjoyNTowNlrOFdGoig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMjozNzo0NlrOFdG7UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA2MTcwNg==", "bodyText": "Some notes:\n\nshould we validate that the path is an absolute path?\nit feels this method should be private, unless I'm missing something.", "url": "https://github.com/palantir/atlasdb/pull/4503#discussion_r366061706", "createdAt": "2020-01-13T22:25:06Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/PersistentStorages.java", "diffHunk": "@@ -17,20 +17,43 @@\n package com.palantir.atlasdb.factory;\n \n import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Comparator;\n import java.util.HashSet;\n+import java.util.List;\n import java.util.Set;\n import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n \n import com.google.common.base.MoreObjects;\n import com.palantir.logsafe.Preconditions;\n+import com.palantir.logsafe.SafeArg;\n \n-public final class PersistentStorageFactories {\n+public final class PersistentStorages {\n     private static final Pattern UUID_PATTERN = Pattern.compile(\n             \"^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$\");\n \n     private static final Set<String> SANITIZED_PATHS = new HashSet<>();\n \n-    private PersistentStorageFactories() {}\n+    private PersistentStorages() {}\n+\n+    /**\n+     * Given the {@code absolutePath} deletes all sub-folders, sub-files and the folder pointed by it.\n+     *\n+     * @param absolutePath which we want to delete\n+     * @throws IOException if there is an underlying exception\n+     */\n+    public static void deletePath(Path absolutePath) throws IOException {\n+        try (Stream<Path> stream = Files.walk(absolutePath)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bb3607f69b7830f66ed817b5f181dce070be0dd"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA2MzEzNg==", "bodyText": "nit: indentation", "url": "https://github.com/palantir/atlasdb/pull/4503#discussion_r366063136", "createdAt": "2020-01-13T22:28:27Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-tests-shared/src/main/java/com/palantir/atlasdb/ComparingTimestampCache.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb;\n+\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+\n+import javax.annotation.Nullable;\n+\n+import com.palantir.atlasdb.cache.DefaultTimestampCache;\n+import com.palantir.atlasdb.cache.OffHeapTimestampCache;\n+import com.palantir.atlasdb.cache.TimestampCache;\n+import com.palantir.atlasdb.persistent.api.PersistentTimestampStore;\n+import com.palantir.atlasdb.util.MetricsManager;\n+import com.palantir.logsafe.Preconditions;\n+\n+public final class ComparingTimestampCache implements TimestampCache {\n+    private final TimestampCache first;\n+    private final TimestampCache second;\n+\n+    public static TimestampCache comparingOffHeapForTests(\n+            MetricsManager metricRegistry,\n+            PersistentTimestampStore persistentTimestampStore) {\n+        TimestampCache first = new DefaultTimestampCache(\n+                metricRegistry.getRegistry(),\n+                () -> AtlasDbConstants.DEFAULT_TIMESTAMP_CACHE_SIZE);\n+\n+        TimestampCache second = OffHeapTimestampCache.create(\n+                persistentTimestampStore,\n+                metricRegistry.getTaggedRegistry(),\n+                () -> AtlasDbConstants.DEFAULT_TIMESTAMP_CACHE_SIZE\n+        );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bb3607f69b7830f66ed817b5f181dce070be0dd"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA2MzY2OA==", "bodyText": "I would include as Args the start timestamp and commit timestamps reported by each of the services in this case, for easier debugging.", "url": "https://github.com/palantir/atlasdb/pull/4503#discussion_r366063668", "createdAt": "2020-01-13T22:29:57Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-tests-shared/src/main/java/com/palantir/atlasdb/ComparingTimestampCache.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb;\n+\n+import java.util.Objects;\n+import java.util.stream.Stream;\n+\n+import javax.annotation.Nullable;\n+\n+import com.palantir.atlasdb.cache.DefaultTimestampCache;\n+import com.palantir.atlasdb.cache.OffHeapTimestampCache;\n+import com.palantir.atlasdb.cache.TimestampCache;\n+import com.palantir.atlasdb.persistent.api.PersistentTimestampStore;\n+import com.palantir.atlasdb.util.MetricsManager;\n+import com.palantir.logsafe.Preconditions;\n+\n+public final class ComparingTimestampCache implements TimestampCache {\n+    private final TimestampCache first;\n+    private final TimestampCache second;\n+\n+    public static TimestampCache comparingOffHeapForTests(\n+            MetricsManager metricRegistry,\n+            PersistentTimestampStore persistentTimestampStore) {\n+        TimestampCache first = new DefaultTimestampCache(\n+                metricRegistry.getRegistry(),\n+                () -> AtlasDbConstants.DEFAULT_TIMESTAMP_CACHE_SIZE);\n+\n+        TimestampCache second = OffHeapTimestampCache.create(\n+                persistentTimestampStore,\n+                metricRegistry.getTaggedRegistry(),\n+                () -> AtlasDbConstants.DEFAULT_TIMESTAMP_CACHE_SIZE\n+        );\n+\n+        return new ComparingTimestampCache(first, second);\n+    }\n+\n+    private ComparingTimestampCache(TimestampCache first, TimestampCache second) {\n+        this.first = first;\n+        this.second = second;\n+    }\n+\n+\n+    @Override\n+    public synchronized void clear() {\n+        first.clear();\n+        second.clear();\n+    }\n+\n+    @Override\n+    public synchronized void putAlreadyCommittedTransaction(Long startTimestamp, Long commitTimestamp) {\n+        first.putAlreadyCommittedTransaction(startTimestamp, commitTimestamp);\n+        second.putAlreadyCommittedTransaction(startTimestamp, commitTimestamp);\n+    }\n+\n+    @Nullable\n+    @Override\n+    public synchronized Long getCommitTimestampIfPresent(Long startTimestamp) {\n+        Long firstCommitTimestamp = first.getCommitTimestampIfPresent(startTimestamp);\n+        Long secondCommitTimestamp = second.getCommitTimestampIfPresent(startTimestamp);\n+        if (firstCommitTimestamp == null || secondCommitTimestamp == null) {\n+            return Stream.of(firstCommitTimestamp, secondCommitTimestamp)\n+                    .filter(Objects::nonNull)\n+                    .findFirst()\n+                    .orElse(null);\n+        }\n+        Preconditions.checkState(firstCommitTimestamp.equals(secondCommitTimestamp),\n+                \"There is a bug in cache implementation\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bb3607f69b7830f66ed817b5f181dce070be0dd"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA2NTE3Mw==", "bodyText": "nit: maybe readThenAbortStillCaches...? A ReadTransaction is something else, and could lead to confusion", "url": "https://github.com/palantir/atlasdb/pull/4503#discussion_r366065173", "createdAt": "2020-01-13T22:34:04Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-tests-shared/src/test/java/com/palantir/atlasdb/transaction/impl/TransactionManagerTest.java", "diffHunk": "@@ -168,6 +170,74 @@ public void shouldNotConflictIfImmutableTimestampLockExpiresIfNoReadsOrWrites()\n         txnManagerWithMocks.runTaskThrowOnConflict(txn -> null);\n     }\n \n+    @Test\n+    public void writeDoesNotPopulateTimestampCache() {\n+        Transaction transaction = txMgr.runTaskWithRetry(txn -> {\n+            put(txn, TEST_TABLE, \"row\", \"column\", \"test\");\n+            return txn;\n+        });\n+\n+        assertThat(timestampCache.getCommitTimestampIfPresent(transaction.getTimestamp())).isNull();\n+    }\n+\n+    @Test\n+    public void readCachesWritersStartToCommitTimestamp() {\n+        Transaction writer = txMgr.runTaskWithRetry(txn -> {\n+            put(txn, TEST_TABLE, \"row\", \"column\", \"test\");\n+            return txn;\n+        });\n+\n+        assertThat(timestampCache.getCommitTimestampIfPresent(writer.getTimestamp())).isNull();\n+\n+        txMgr.runTaskWithRetry(txn -> {\n+            get(txn, TEST_TABLE, \"row\", \"column\");\n+            return txn;\n+        });\n+\n+        assertThat(timestampCache.getCommitTimestampIfPresent(writer.getTimestamp()))\n+                .isNotNull()\n+                .isEqualTo(transactionService.get(writer.getTimestamp()));\n+    }\n+\n+    @Test\n+    public void overwriteCachesPreviousWritersStartToCommitTimestamp() {\n+        Transaction writer = txMgr.runTaskWithRetry(txn -> {\n+            put(txn, TEST_TABLE, \"row\", \"column\", \"first\");\n+            return txn;\n+        });\n+\n+        assertThat(timestampCache.getCommitTimestampIfPresent(writer.getTimestamp())).isNull();\n+\n+        txMgr.runTaskWithRetry(txn -> {\n+            put(txn, TEST_TABLE, \"row\", \"column\", \"second\");\n+            return txn;\n+        });\n+\n+        assertThat(timestampCache.getCommitTimestampIfPresent(writer.getTimestamp()))\n+                .isNotNull()\n+                .isEqualTo(transactionService.get(writer.getTimestamp()));\n+    }\n+\n+    @Test\n+    public void abortedReadTransactionStillCachesWritersCommitTimestamp() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bb3607f69b7830f66ed817b5f181dce070be0dd"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA2NTYxNg==", "bodyText": "In general throughout this class, is isNotNull() really needed? I imagine the isEqualTo check should be good enough. Transaction#getTimestamp returns a primitive long, so non-null.", "url": "https://github.com/palantir/atlasdb/pull/4503#discussion_r366065616", "createdAt": "2020-01-13T22:35:17Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-tests-shared/src/test/java/com/palantir/atlasdb/transaction/impl/TransactionManagerTest.java", "diffHunk": "@@ -168,6 +170,74 @@ public void shouldNotConflictIfImmutableTimestampLockExpiresIfNoReadsOrWrites()\n         txnManagerWithMocks.runTaskThrowOnConflict(txn -> null);\n     }\n \n+    @Test\n+    public void writeDoesNotPopulateTimestampCache() {\n+        Transaction transaction = txMgr.runTaskWithRetry(txn -> {\n+            put(txn, TEST_TABLE, \"row\", \"column\", \"test\");\n+            return txn;\n+        });\n+\n+        assertThat(timestampCache.getCommitTimestampIfPresent(transaction.getTimestamp())).isNull();\n+    }\n+\n+    @Test\n+    public void readCachesWritersStartToCommitTimestamp() {\n+        Transaction writer = txMgr.runTaskWithRetry(txn -> {\n+            put(txn, TEST_TABLE, \"row\", \"column\", \"test\");\n+            return txn;\n+        });\n+\n+        assertThat(timestampCache.getCommitTimestampIfPresent(writer.getTimestamp())).isNull();\n+\n+        txMgr.runTaskWithRetry(txn -> {\n+            get(txn, TEST_TABLE, \"row\", \"column\");\n+            return txn;\n+        });\n+\n+        assertThat(timestampCache.getCommitTimestampIfPresent(writer.getTimestamp()))\n+                .isNotNull()\n+                .isEqualTo(transactionService.get(writer.getTimestamp()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bb3607f69b7830f66ed817b5f181dce070be0dd"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA2NTgxNQ==", "bodyText": "Might be cleaner in terms of minimum visibility to just return the timestamp from the transaction task.", "url": "https://github.com/palantir/atlasdb/pull/4503#discussion_r366065815", "createdAt": "2020-01-13T22:35:45Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-tests-shared/src/test/java/com/palantir/atlasdb/transaction/impl/TransactionManagerTest.java", "diffHunk": "@@ -168,6 +170,74 @@ public void shouldNotConflictIfImmutableTimestampLockExpiresIfNoReadsOrWrites()\n         txnManagerWithMocks.runTaskThrowOnConflict(txn -> null);\n     }\n \n+    @Test\n+    public void writeDoesNotPopulateTimestampCache() {\n+        Transaction transaction = txMgr.runTaskWithRetry(txn -> {\n+            put(txn, TEST_TABLE, \"row\", \"column\", \"test\");\n+            return txn;\n+        });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bb3607f69b7830f66ed817b5f181dce070be0dd"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA2NjUxMw==", "bodyText": "I think we should test the logic in this class in this PR, especially since it's on a live path", "url": "https://github.com/palantir/atlasdb/pull/4503#discussion_r366066513", "createdAt": "2020-01-13T22:37:46Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -495,6 +514,19 @@ private TransactionManager serializableInternal(@Output List<AutoCloseable> clos\n         return transactionManager;\n     }\n \n+    private TimestampCache getTimestampCache(\n+            MetricsManager metricsManager,\n+            Supplier<AtlasDbRuntimeConfig> runtimeConfigSupplier,\n+            Optional<PersistentTimestampStore> persistentTimestampStore) {\n+        LongSupplier cacheSize = () -> runtimeConfigSupplier.get().getTimestampCacheSize();\n+        Supplier<TimestampCache> timestampCacheSupplier = () ->\n+                persistentTimestampStore.map(store ->\n+                        OffHeapTimestampCache.create(store, metricsManager.getTaggedRegistry(), cacheSize))\n+                        .orElseGet(() -> new DefaultTimestampCache(metricsManager.getRegistry(), cacheSize));\n+\n+        return config().timestampCache().orElseGet(timestampCacheSupplier);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bb3607f69b7830f66ed817b5f181dce070be0dd"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23fb0b848b5cf890a10b122aa0f89c9aaf2201ac", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/23fb0b848b5cf890a10b122aa0f89c9aaf2201ac", "committedDate": "2020-01-14T10:10:43Z", "message": "Initial comments fixed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3966635617454f5426d2c79f6f16ac87da120ce7", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/3966635617454f5426d2c79f6f16ac87da120ce7", "committedDate": "2020-01-14T12:03:16Z", "message": "Added tests for hot path."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d744687cba4ca8290fab98c832dd69ce670b16d5", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/d744687cba4ca8290fab98c832dd69ce670b16d5", "committedDate": "2020-01-14T12:48:16Z", "message": "Fixed indentation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33a6f5397d6e8989ecb79a5ab096cefab08eef91", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/33a6f5397d6e8989ecb79a5ab096cefab08eef91", "committedDate": "2020-01-14T13:56:29Z", "message": "Test simplification."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a372ff6d385cbcba4bba9cc0210e5e3fa5df216f", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/a372ff6d385cbcba4bba9cc0210e5e3fa5df216f", "committedDate": "2020-01-14T13:58:27Z", "message": "Simplify tests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5099c89f4ebdf50fc8efe37fe77f35ab0c7bedb3", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/5099c89f4ebdf50fc8efe37fe77f35ab0c7bedb3", "committedDate": "2020-01-14T15:20:40Z", "message": "Revert rename."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ccb94af6c4bc2651b4449f4461aeef34c0f759e", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/3ccb94af6c4bc2651b4449f4461aeef34c0f759e", "committedDate": "2020-01-14T15:56:46Z", "message": "Fix absolute paths."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a43ce1c06e5e297492a4bb2778aa05a88bb81b9", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/0a43ce1c06e5e297492a4bb2778aa05a88bb81b9", "committedDate": "2020-01-14T17:04:09Z", "message": "More fixes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad865b2757050ea6ea113acdfd4f374553cd6cea", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/ad865b2757050ea6ea113acdfd4f374553cd6cea", "committedDate": "2020-01-14T17:45:09Z", "message": "Better solution for multitenancy."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNzYwMjg0", "url": "https://github.com/palantir/atlasdb/pull/4503#pullrequestreview-342760284", "createdAt": "2020-01-14T18:52:03Z", "commit": {"oid": "ad865b2757050ea6ea113acdfd4f374553cd6cea"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxODo1MjowM1rOFdiJEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxODo1NDoyNlrOFdiNsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUxMjQwMg==", "bodyText": "nit: maybe constructPersistentTimestampStoreIfConfigured?", "url": "https://github.com/palantir/atlasdb/pull/4503#discussion_r366512402", "createdAt": "2020-01-14T18:52:03Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -495,6 +509,32 @@ private TransactionManager serializableInternal(@Output List<AutoCloseable> clos\n         return transactionManager;\n     }\n \n+    @VisibleForTesting\n+    static Optional<PersistentTimestampStore> constructPersistentTimestampStore(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad865b2757050ea6ea113acdfd4f374553cd6cea"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUxMjcwMQ==", "bodyText": "I would Preconditions.checkState this for readability (instead of the class cast exception you'd get if we ship a bug here)", "url": "https://github.com/palantir/atlasdb/pull/4503#discussion_r366512701", "createdAt": "2020-01-14T18:52:38Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/factory/TransactionManagers.java", "diffHunk": "@@ -495,6 +509,32 @@ private TransactionManager serializableInternal(@Output List<AutoCloseable> clos\n         return transactionManager;\n     }\n \n+    @VisibleForTesting\n+    static Optional<PersistentTimestampStore> constructPersistentTimestampStore(\n+            AtlasDbConfig config,\n+            PersistentStorageFactory persistentStorageFactory,\n+            @Output List<AutoCloseable> closeables) {\n+        return initializeCloseable(\n+                config.persistentStorage().map(storageConfig -> persistentStorageFactory\n+                        .constructPersistentTimestampStore((RocksDbPersistentStorageConfig) storageConfig)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad865b2757050ea6ea113acdfd4f374553cd6cea"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjUxMzU4Nw==", "bodyText": "There's probably something around persistentTimestampStoreNotConstructedEvenIfConfiguredIfExplicitlyProvided, though I'm okay with passing on that if it's really hard to test.", "url": "https://github.com/palantir/atlasdb/pull/4503#discussion_r366513587", "createdAt": "2020-01-14T18:54:26Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/TransactionManagersTest.java", "diffHunk": "@@ -714,6 +722,88 @@ public void kvsDoesNotRecordSweepStatsIfSweepQueueWritesAndTargetedSweepEnabled(\n         assertThat(isSweepStatsKvsPresentInDelegatingChain(keyValueService), is(false));\n     }\n \n+    @Test\n+    public void providedTimestampCacheOverridesAnyOtherConfig() {\n+        MetricRegistry metricRegistry = metricsManager.getRegistry();\n+        TimestampCache expectedTimestampCache = new DefaultTimestampCache(metricRegistry, () -> 10000L);\n+\n+        AtlasDbConfig installConfig = ImmutableAtlasDbConfig.builder()\n+                .keyValueService(new InMemoryAtlasDbConfig())\n+                .targetedSweep(ImmutableTargetedSweepInstallConfig.builder().build())\n+                .timestampCache(expectedTimestampCache)\n+                .build();\n+\n+        TimestampCache timestampCache = constructTimestampCache(installConfig, Optional.empty());\n+\n+        assertThat(timestampCache).isSameAs(expectedTimestampCache);\n+    }\n+\n+    @Test\n+    public void usingInMemoryTimestampCache() {\n+        AtlasDbConfig installConfig = ImmutableAtlasDbConfig.builder()\n+                .keyValueService(new InMemoryAtlasDbConfig())\n+                .targetedSweep(ImmutableTargetedSweepInstallConfig.builder().build())\n+                .build();\n+\n+        TimestampCache timestampCache = constructTimestampCache(installConfig, Optional.empty());\n+\n+        assertThat(timestampCache).isInstanceOf(DefaultTimestampCache.class);\n+    }\n+\n+    @Test\n+    public void usingPersistentStorage() throws IOException {\n+        File storageFolder = temporaryFolder.newFolder();\n+        String storagePath = Files.currentFolder().toPath()\n+                .relativize(storageFolder.toPath())\n+                .toString();\n+\n+        AtlasDbConfig installConfig = ImmutableAtlasDbConfig.builder()\n+                .keyValueService(new InMemoryAtlasDbConfig())\n+                .targetedSweep(ImmutableTargetedSweepInstallConfig.builder().build())\n+                .persistentStorage(\n+                        ImmutableRocksDbPersistentStorageConfig.builder()\n+                                .storagePath(storagePath)\n+                                .build())\n+                .build();\n+\n+        Optional<PersistentTimestampStore> persistentTimestampStore =\n+                TransactionManagers.constructPersistentTimestampStore(\n+                        installConfig,\n+                        new DefaultPersistentStorageFactory(),\n+                        new LinkedList<>());\n+\n+        TimestampCache timestampCache = constructTimestampCache(installConfig, persistentTimestampStore);\n+\n+        assertThat(timestampCache).isInstanceOf(OffHeapTimestampCache.class);\n+    }\n+\n+    @Test\n+    public void persistentTimestampStoreNotConstructed() {\n+        AtlasDbConfig installConfig = ImmutableAtlasDbConfig.builder()\n+                .keyValueService(new InMemoryAtlasDbConfig())\n+                .targetedSweep(ImmutableTargetedSweepInstallConfig.builder().build())\n+                .build();\n+\n+        Optional<PersistentTimestampStore> persistentTimestampStore =\n+                TransactionManagers.constructPersistentTimestampStore(\n+                        installConfig,\n+                        new DefaultPersistentStorageFactory(),\n+                        new LinkedList<>());\n+\n+        assertThat(persistentTimestampStore)\n+                .isEmpty();\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad865b2757050ea6ea113acdfd4f374553cd6cea"}, "originalPosition": 130}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "503dfbde8603ebba45e769b9f253dc5d58f71d30", "author": {"user": {"login": "OStevan", "name": "Stevan Ognjanovic"}}, "url": "https://github.com/palantir/atlasdb/commit/503dfbde8603ebba45e769b9f253dc5d58f71d30", "committedDate": "2020-01-14T19:31:08Z", "message": "Small fixes."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2370, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}