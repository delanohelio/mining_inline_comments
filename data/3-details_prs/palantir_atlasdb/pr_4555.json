{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxOTg5NjA5", "number": 4555, "title": "[PDS-110262] Meter for Cassandra pool exhaustion events", "bodyText": "Goals (and why):\n\nAllow easy visualisation of when requests are being dropped because our connection pools are getting exhausted. See internal ticket PDS-110262, this would have helped figure things out more quickly.\n\nImplementation Description (bullets):\n\nAdd a meter from the metrics registry that is marked whenever the pool is exhausted on a request\n\nTesting (What was existing testing like?  What have you done to improve it?):\nNone, admittedly (not breaking existing tests is progress, of course)\nConcerns (what feedback would you like?):\n\nThe goal here is to add only one meter per namespace. Was this done correctly?\nAre there cases where this over or under counts the number of request failures?\nNot really a fan of passing the CassandraClientPoolMetrics objects around. Should I have passed a callback instead?\n\nWhere should we start reviewing?: CassandraClientPoolMetrics\nPriority (whenever / two weeks / yesterday): early next week?", "createdAt": "2020-02-06T16:21:08Z", "url": "https://github.com/palantir/atlasdb/pull/4555", "merged": true, "mergeCommit": {"oid": "de45f5b11f6a795eaf4129dec37cf489bc1e2677"}, "closed": true, "closedAt": "2020-02-07T10:32:51Z", "author": {"login": "jeremyk-91"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBr0i1gH2gAyMzcxOTg5NjA5Ojk3NjIwOGU5YjcxM2Y3ZTc3MjRlYzg3ZTc3YTRlYzJlZWU2YTdjYWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB80PJAFqTM1NTA2NTAyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "976208e9b713f7e7724ec87e77a4ec2eee6a7caf", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/976208e9b713f7e7724ec87e77a4ec2eee6a7caf", "committedDate": "2020-02-06T14:43:19Z", "message": "[pds-110262] Cassandra meter for pool exhaustion events"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88b13ff172c3db47d6f1bd1eebb6a992d3df624c", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/88b13ff172c3db47d6f1bd1eebb6a992d3df624c", "committedDate": "2020-02-06T16:06:49Z", "message": "Fix compile silliness"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15e13edff8d575e30d524bb0619620f21c2009aa", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/15e13edff8d575e30d524bb0619620f21c2009aa", "committedDate": "2020-02-06T16:17:00Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20afefd305c7c1e1fc187260ce155756b730cc71", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/20afefd305c7c1e1fc187260ce155756b730cc71", "committedDate": "2020-02-06T16:17:00Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDI0Njgz", "url": "https://github.com/palantir/atlasdb/pull/4555#pullrequestreview-355024683", "createdAt": "2020-02-07T09:24:28Z", "commit": {"oid": "20afefd305c7c1e1fc187260ce155756b730cc71"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOToyNDoyOFrOFm27VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOToyNDoyOFrOFm27VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5MDEzMw==", "bodyText": "Just a Counter should suffice? We can calculate everything else ourselves", "url": "https://github.com/palantir/atlasdb/pull/4555#discussion_r376290133", "createdAt": "2020-02-07T09:24:28Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/pool/CassandraClientPoolMetrics.java", "diffHunk": "@@ -28,12 +28,18 @@\n \n public class CassandraClientPoolMetrics {\n     private final MetricsManager metricsManager;\n-    private final RequestMetrics aggregateMetrics;\n+    private final RequestMetrics aggregateRequestMetrics;\n     private final Map<InetSocketAddress, RequestMetrics> metricsByHost = new HashMap<>();\n \n+    // Tracks occurrences of client pool exhaustions.\n+    // Not bundled in with request metrics, as we seek to not produce host-level metrics for economic reasons.\n+    private final Meter poolExhaustionMeter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20afefd305c7c1e1fc187260ce155756b730cc71"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDI1MDE0", "url": "https://github.com/palantir/atlasdb/pull/4555#pullrequestreview-355025014", "createdAt": "2020-02-07T09:25:00Z", "commit": {"oid": "20afefd305c7c1e1fc187260ce155756b730cc71"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOToyNTowMFrOFm28RA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOToyNTowMFrOFm28RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5MDM3Mg==", "bodyText": "Do we need to pass the CassandraClientPoolingContainer if it's unused?", "url": "https://github.com/palantir/atlasdb/pull/4555#discussion_r376290372", "createdAt": "2020-02-07T09:25:00Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-cassandra/src/main/java/com/palantir/atlasdb/keyvalue/cassandra/pool/CassandraClientPoolMetrics.java", "diffHunk": "@@ -61,10 +67,14 @@ public void recordConnectionExceptionOnHost(CassandraClientPoolingContainer host\n         updateMetricOnAggregateAndHost(hostPool, RequestMetrics::markRequestConnectionException);\n     }\n \n+    public void recordPoolExhaustion(CassandraClientPoolingContainer unused) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20afefd305c7c1e1fc187260ce155756b730cc71"}, "originalPosition": 38}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDI2MDMx", "url": "https://github.com/palantir/atlasdb/pull/4555#pullrequestreview-355026031", "createdAt": "2020-02-07T09:26:40Z", "commit": {"oid": "20afefd305c7c1e1fc187260ce155756b730cc71"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOToyNjo0MFrOFm2_cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOToyNjo0MFrOFm2_cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5MTE4Nw==", "bodyText": "I don't think connections get dropped, they still retry. Maybe \"AtlasDB now publishes a metric that can be used to monitor Cassandra connection pool exhaustion.\"", "url": "https://github.com/palantir/atlasdb/pull/4555#discussion_r376291187", "createdAt": "2020-02-07T09:26:40Z", "author": {"login": "jkozlowski"}, "path": "changelog/@unreleased/pr-4555.v2.yml", "diffHunk": "@@ -0,0 +1,6 @@\n+type: improvement\n+improvement:\n+  description: AtlasDB now publishes a metric indicating the count of requests that\n+    were dropped owing to saturated Cassandra connection pools.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "20afefd305c7c1e1fc187260ce155756b730cc71"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6fce3351e4e5be3ba491f315b29b61970781c25", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/f6fce3351e4e5be3ba491f315b29b61970781c25", "committedDate": "2020-02-07T09:59:44Z", "message": "CR code level changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15750fe13f675c837c79bf95a9e16f15f469d434", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/15750fe13f675c837c79bf95a9e16f15f469d434", "committedDate": "2020-02-07T09:59:44Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "053d369e5f27aa6bd419208d4635c23adecd76f5", "author": {"user": {"login": "jeremyk-91", "name": "Jeremy Kong"}}, "url": "https://github.com/palantir/atlasdb/commit/053d369e5f27aa6bd419208d4635c23adecd76f5", "committedDate": "2020-02-07T09:59:44Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDY1MDIw", "url": "https://github.com/palantir/atlasdb/pull/4555#pullrequestreview-355065020", "createdAt": "2020-02-07T10:31:22Z", "commit": {"oid": "053d369e5f27aa6bd419208d4635c23adecd76f5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2241, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}