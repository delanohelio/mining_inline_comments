{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3Njc5NTE0", "number": 4648, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwOTo1Mjo1NVrODnxeQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMjozODowOVrODn0SrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMDMxNjE4OnYy", "diffSide": "RIGHT", "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/http/AtlasDbHttpClients.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwOTo1Mjo1NVrOF19kQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwOTo1Mjo1NVrOF19kQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyNzU1NQ==", "bodyText": "I think you want isPossiblyOkHttpTimeoutBug(cause) otherwise it will SO.", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392127555", "createdAt": "2020-03-13T09:52:55Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-config/src/main/java/com/palantir/atlasdb/http/AtlasDbHttpClients.java", "diffHunk": "@@ -106,4 +108,24 @@ private AtlasDbHttpClients() {\n                 MetricRegistry.name(clazz),\n                 $ -> ImmutableMap.of());\n     }\n+\n+    /**\n+     * Returns a proxy which replaces the underlying proxy if:\n+     * 1. We see a SocketTimeoutException\n+     * 2. At most once every 20 minutes\n+     */\n+    private static <T> T wrapWithOkHttpBugHandling(Class<T> type, Supplier<T> supplier) {\n+        return ReplaceIfExceptionMatchingProxy.newProxyInstance(\n+                type,\n+                Suppliers.memoizeWithExpiration(supplier::get, 20, TimeUnit.MINUTES),\n+                AtlasDbHttpClients::isPossiblyOkHttpTimeoutBug);\n+    }\n+\n+    private static boolean isPossiblyOkHttpTimeoutBug(Throwable throwable) {\n+        if (throwable instanceof SocketTimeoutException) {\n+            return true;\n+        }\n+        Throwable cause = throwable.getCause();\n+        return cause != null && isPossiblyOkHttpTimeoutBug(throwable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43aa4a52f747e9e182e22b73a7ec9e62ffb6317e"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMDM0MjM5OnYy", "diffSide": "RIGHT", "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMDowMDo0MlrOF190dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMDowMDo0MlrOF190dA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzMTcwMA==", "bodyText": "Putting the log line here will basically print it for every request that fails with this, since shouldReplace will be true for all of them. So we either need to put it in the supplier or remove it. Sorry for confusing things", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392131700", "createdAt": "2020-03-13T10:00:42Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();\n+            replaceIfNecessary(cause);\n+            throw cause;\n+        } catch (IllegalAccessException e) {\n+            throw new IllegalStateException(e);\n+        }\n+    }\n+\n+    private synchronized void replaceIfNecessary(Throwable thrown) {\n+        if (shouldReplace.test(thrown)) {\n+            log.info(\"Replacing underlying proxy due to thrown exception\", thrown);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b09cd9a82f6822c6a2fc0ff8d702b4aa675ddb1"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMDM0ODE2OnYy", "diffSide": "RIGHT", "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMDowMjozOFrOF194Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMDowODoyM1rOF1-C_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzMjYzMQ==", "bodyText": "Checked that getCause is the same as getTargetException.", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392132631", "createdAt": "2020-03-13T10:02:38Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b09cd9a82f6822c6a2fc0ff8d702b4aa675ddb1"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzNTQyMA==", "bodyText": "yeah getTargetException is from the time before Java had getCause", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392135420", "createdAt": "2020-03-13T10:08:23Z", "author": {"login": "j-baker"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzMjYzMQ=="}, "originalCommit": {"oid": "3b09cd9a82f6822c6a2fc0ff8d702b4aa675ddb1"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMDM1MTkxOnYy", "diffSide": "RIGHT", "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMDowNDowMlrOF196qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMTowMzoyNVrOF1_rVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzMzI4OQ==", "bodyText": "Is handling this separately necessary?", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392133289", "createdAt": "2020-03-13T10:04:02Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();\n+            replaceIfNecessary(cause);\n+            throw cause;\n+        } catch (IllegalAccessException e) {\n+            throw new IllegalStateException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b09cd9a82f6822c6a2fc0ff8d702b4aa675ddb1"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzNDkxNg==", "bodyText": "We probably don't want to throw the cause in this case (seems like a bug in our reflection so we probably want to see it)", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392134916", "createdAt": "2020-03-13T10:07:25Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();\n+            replaceIfNecessary(cause);\n+            throw cause;\n+        } catch (IllegalAccessException e) {\n+            throw new IllegalStateException(e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzMzI4OQ=="}, "originalCommit": {"oid": "3b09cd9a82f6822c6a2fc0ff8d702b4aa675ddb1"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzNjEyMg==", "bodyText": "i fixed logging", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392136122", "createdAt": "2020-03-13T10:09:53Z", "author": {"login": "j-baker"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();\n+            replaceIfNecessary(cause);\n+            throw cause;\n+        } catch (IllegalAccessException e) {\n+            throw new IllegalStateException(e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzMzI4OQ=="}, "originalCommit": {"oid": "3b09cd9a82f6822c6a2fc0ff8d702b4aa675ddb1"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzNjYxMQ==", "bodyText": "I checked in other places in this repo, and I don't really see it being handled so I'm curious.", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392136611", "createdAt": "2020-03-13T10:10:56Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();\n+            replaceIfNecessary(cause);\n+            throw cause;\n+        } catch (IllegalAccessException e) {\n+            throw new IllegalStateException(e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzMzI4OQ=="}, "originalCommit": {"oid": "3b09cd9a82f6822c6a2fc0ff8d702b4aa675ddb1"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE0NjIxNQ==", "bodyText": "yeah, this was just an artifact of me removing 'throws Throwable', handling the cases and then realizing i needed to rethrow the cause", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392146215", "createdAt": "2020-03-13T10:30:11Z", "author": {"login": "j-baker"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();\n+            replaceIfNecessary(cause);\n+            throw cause;\n+        } catch (IllegalAccessException e) {\n+            throw new IllegalStateException(e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzMzI4OQ=="}, "originalCommit": {"oid": "3b09cd9a82f6822c6a2fc0ff8d702b4aa675ddb1"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2MjEzMg==", "bodyText": "Yeah, this is what's failing the build", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392162132", "createdAt": "2020-03-13T11:03:25Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();\n+            replaceIfNecessary(cause);\n+            throw cause;\n+        } catch (IllegalAccessException e) {\n+            throw new IllegalStateException(e);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzMzI4OQ=="}, "originalCommit": {"oid": "3b09cd9a82f6822c6a2fc0ff8d702b4aa675ddb1"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMDU2NzkxOnYy", "diffSide": "RIGHT", "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMToxNjozN1rOF2AB6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMTo0MToyMVrOF2AqLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2NzkxNQ==", "bodyText": "Should we defer synchronization until the predicate has evaluated true?", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392167915", "createdAt": "2020-03-13T11:16:37Z", "author": {"login": "carterkozak"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();\n+            replaceIfNecessary(cause);\n+            throw cause;\n+        }\n+    }\n+\n+    private synchronized void replaceIfNecessary(Throwable thrown) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fa0fcb852d5421f5f3a113104036ad7655a414d"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE3NDAxMA==", "bodyText": "Possibly, but it's probably ok to keep it simple here. @jeremyk-91", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392174010", "createdAt": "2020-03-13T11:31:03Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();\n+            replaceIfNecessary(cause);\n+            throw cause;\n+        }\n+    }\n+\n+    private synchronized void replaceIfNecessary(Throwable thrown) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2NzkxNQ=="}, "originalCommit": {"oid": "0fa0fcb852d5421f5f3a113104036ad7655a414d"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE3NDIwNQ==", "bodyText": "doesn't matter - this is only used for RPCs, and they aren't expected to ever throw", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392174205", "createdAt": "2020-03-13T11:31:32Z", "author": {"login": "j-baker"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();\n+            replaceIfNecessary(cause);\n+            throw cause;\n+        }\n+    }\n+\n+    private synchronized void replaceIfNecessary(Throwable thrown) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2NzkxNQ=="}, "originalCommit": {"oid": "0fa0fcb852d5421f5f3a113104036ad7655a414d"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE3ODIyMw==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392178223", "createdAt": "2020-03-13T11:41:21Z", "author": {"login": "carterkozak"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);\n+        } catch (InvocationTargetException e) {\n+            Throwable cause = e.getCause();\n+            replaceIfNecessary(cause);\n+            throw cause;\n+        }\n+    }\n+\n+    private synchronized void replaceIfNecessary(Throwable thrown) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2NzkxNQ=="}, "originalCommit": {"oid": "0fa0fcb852d5421f5f3a113104036ad7655a414d"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMDU3MzQ1OnYy", "diffSide": "RIGHT", "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMToxODo0MVrOF2AFVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMjoxMjozOFrOF2BcRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2ODc4OQ==", "bodyText": "I think we need to compare the delegate that we actually invoked the method on, not the value after an exception is caught. Concurrent failures could cause us to roll several times.", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392168789", "createdAt": "2020-03-13T11:18:41Z", "author": {"login": "carterkozak"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fa0fcb852d5421f5f3a113104036ad7655a414d"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE3MjA4OQ==", "bodyText": "This is handled outside of this class. The supplier given here is memoized.", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392172089", "createdAt": "2020-03-13T11:26:38Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2ODc4OQ=="}, "originalCommit": {"oid": "0fa0fcb852d5421f5f3a113104036ad7655a414d"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE4MDgwNg==", "bodyText": "I don't understand, in that case wouldn't we always replace the delegate with itself? I just rolled out of bed though, and might not be reading thoroughly as I should...\nI think we need something like:\nT localDelegate = delegate;\ntry {\n  return method.invoke(localDelegate, args);\n} catch (ITE e) {\n  Throwable cause = e.getCause();\n  replaceIfNecessary(cause, localDelegate);\n  throw cause;\n}\nThen update replaceIfNecessary\n   private synchronized void replaceIfNecessary(Throwable thrown, T invocationTarget) {\n        if (shouldReplace.test(thrown)) {\n            // cas on fail\n            if (invocationTarget != delegate) {\n                // already replaced\n                return;\n            }\n            T replacement = delegateFactory.get();\n            if (delegate != replacement) {\n                log.info(\"Replacing underlying proxy due to thrown exception\", thrown);\n                delegate = delegateFactory.get();\n            }\n        }\n    }", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392180806", "createdAt": "2020-03-13T11:47:31Z", "author": {"login": "carterkozak"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2ODc4OQ=="}, "originalCommit": {"oid": "0fa0fcb852d5421f5f3a113104036ad7655a414d"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE4ODEwMw==", "bodyText": "Ok so reasoning through this:\nThe supplier passed here is:\nSuppliers.memoizeWithExpiration(supplier::get, 20, TimeUnit.MINUTES)\n\nSo when we hit the bug, all requests will enter the synchronized block and one by one, check they hit the bug, then call the factory. Only the first one will actually refresh the client (and the supplier will memoize it for the next 20 minutes). Next one will call the factory again and get the same one and so not replace it.\nThe only thing I'm wonder is why is the delegateFactory called twice, but I don't think that matters so much.", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392188103", "createdAt": "2020-03-13T12:05:30Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2ODc4OQ=="}, "originalCommit": {"oid": "0fa0fcb852d5421f5f3a113104036ad7655a414d"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE5MTA0NA==", "bodyText": "Talked offline: the proposed code from @carterkozak is to make sure that if we ever switch the supplier passed to here, we don't shoot ourselves in the foot. I will keep as is, as we hope to remove this shortly.", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392191044", "createdAt": "2020-03-13T12:12:38Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-commons/src/main/java/com/palantir/common/proxy/ReplaceIfExceptionMatchingProxy.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.common.proxy;\n+\n+import java.lang.reflect.InvocationHandler;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import java.lang.reflect.Proxy;\n+import java.util.function.Predicate;\n+import java.util.function.Supplier;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public final class ReplaceIfExceptionMatchingProxy<T> implements InvocationHandler {\n+    private static final Logger log = LoggerFactory.getLogger(ReplaceIfExceptionMatchingProxy.class);\n+\n+    private final Supplier<T> delegateFactory;\n+    private final Predicate<Throwable> shouldReplace;\n+    private volatile T delegate;\n+\n+    private ReplaceIfExceptionMatchingProxy(Supplier<T> delegateFactory, Predicate<Throwable> shouldReplace) {\n+        this.delegateFactory = delegateFactory;\n+        this.delegate = delegateFactory.get();\n+        this.shouldReplace = shouldReplace;\n+    }\n+\n+    @Override\n+    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n+        try {\n+            return method.invoke(delegate, args);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE2ODc4OQ=="}, "originalCommit": {"oid": "0fa0fcb852d5421f5f3a113104036ad7655a414d"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMDc3ODA0OnYy", "diffSide": "LEFT", "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/LeadersTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMjozODowOVrOF2CFzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMjo1NDoyN1rOF2Ci1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwMTY3Ng==", "bodyText": "This is basically testing some code in Feign, so I'll say not worth it.", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392201676", "createdAt": "2020-03-13T12:38:09Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/LeadersTest.java", "diffHunk": "@@ -116,19 +115,6 @@ public void createProxyAndLocalListCreatesSingletonListIfNoRemoteAddressesProvid\n         verifyNoMoreInteractions(localAcceptor);\n     }\n \n-    @Test(expected = IllegalArgumentException.class)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a9455e09a6178ba70cbba11ec7284d4c1dd506f8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwODc0OA==", "bodyText": "Yes. This looks like it originally sought to test that the AtlasDbFeignTargetFactory which doesn't exist anymore wouldn't do silly things", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392208748", "createdAt": "2020-03-13T12:53:36Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/LeadersTest.java", "diffHunk": "@@ -116,19 +115,6 @@ public void createProxyAndLocalListCreatesSingletonListIfNoRemoteAddressesProvid\n         verifyNoMoreInteractions(localAcceptor);\n     }\n \n-    @Test(expected = IllegalArgumentException.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwMTY3Ng=="}, "originalCommit": {"oid": "a9455e09a6178ba70cbba11ec7284d4c1dd506f8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwOTEwOQ==", "bodyText": "(When we had a lot of custom code there, but now we don't)", "url": "https://github.com/palantir/atlasdb/pull/4648#discussion_r392209109", "createdAt": "2020-03-13T12:54:27Z", "author": {"login": "jeremyk-91"}, "path": "atlasdb-config/src/test/java/com/palantir/atlasdb/factory/LeadersTest.java", "diffHunk": "@@ -116,19 +115,6 @@ public void createProxyAndLocalListCreatesSingletonListIfNoRemoteAddressesProvid\n         verifyNoMoreInteractions(localAcceptor);\n     }\n \n-    @Test(expected = IllegalArgumentException.class)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwMTY3Ng=="}, "originalCommit": {"oid": "a9455e09a6178ba70cbba11ec7284d4c1dd506f8"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2979, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}