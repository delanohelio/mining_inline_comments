{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNDQ4MzQx", "number": 5021, "title": "[LW] Compress snapshots returned to the user", "bodyText": "Goals (and why):\n\nWith the new route of max-size retention, snapshots become costly to return - every one will also come with all of the events after the snapshot, which will always be around 1000.\nHowever, many of these events can be condensed into the snapshot instead, reducing this overhead.\n\nImplementation Description (bullets):\n\nIntroduces a new little immutable to make passing around easier (let's be honest, we don't want to pass 3 params with the same types to the same method!)\nCondenses some of the events - we cannot condense more than we do.\n\nTesting (What was existing testing like?  What have you done to improve it?):\nCurrent tests covered most of this. However, one of the tests did have to change.\nConcerns (what feedback would you like?):\n\nAs far as I can tell, every other piece should function exactly the same - please double check to make sure that is the case!\n\nWhere should we start reviewing?:\n\nLockWatchEventLog is the first place to look.\n\nPriority (whenever / two weeks / yesterday):\nThis week.", "createdAt": "2020-10-12T09:28:41Z", "url": "https://github.com/palantir/atlasdb/pull/5021", "merged": true, "mergeCommit": {"oid": "2c278121d358f29d020bbd1afa09e724b159c28f"}, "closed": true, "closedAt": "2021-02-26T11:12:58Z", "author": {"login": "Jolyon-S"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRwldBAH2gAyNTAxNDQ4MzQxOjFmZDcwNzMzMDc2OTQ1Y2M1MGM3YTI0ZGEwYjEyMTJhMjY2OWNiM2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABd93-8qgH2gAyNTAxNDQ4MzQxOmYwMTQxNGZhZWEyNThlMGMwODM4ODMyZWM3NGE4NmRkZTNlNTQ4YjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1fd70733076945cc50c7a24da0b1212a2669cb3d", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/1fd70733076945cc50c7a24da0b1212a2669cb3d", "committedDate": "2020-10-12T09:30:18Z", "message": "Initial pass on retention"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ac6f05d79664a1571055e17134892ad8329f28c", "author": {"user": {"login": "svc-excavator-bot", "name": "Excavator Bot"}}, "url": "https://github.com/palantir/atlasdb/commit/0ac6f05d79664a1571055e17134892ad8329f28c", "committedDate": "2020-10-12T09:35:47Z", "message": "squash again"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db5af4b2ec89314bac29519514d247ad72e695fd", "author": {"user": {"login": "svc-excavator-bot", "name": "Excavator Bot"}}, "url": "https://github.com/palantir/atlasdb/commit/db5af4b2ec89314bac29519514d247ad72e695fd", "committedDate": "2020-10-12T09:27:56Z", "message": "squash again"}, "afterCommit": {"oid": "0ac6f05d79664a1571055e17134892ad8329f28c", "author": {"user": {"login": "svc-excavator-bot", "name": "Excavator Bot"}}, "url": "https://github.com/palantir/atlasdb/commit/0ac6f05d79664a1571055e17134892ad8329f28c", "committedDate": "2020-10-12T09:35:47Z", "message": "squash again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b78fbe5719459df613522242cc857aa8c95b2cbc", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/b78fbe5719459df613522242cc857aa8c95b2cbc", "committedDate": "2020-10-12T09:58:47Z", "message": "Resolve strange merge issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4c102fcbb000ad444a0bb7b0b4b3fbe2cd21393", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/c4c102fcbb000ad444a0bb7b0b4b3fbe2cd21393", "committedDate": "2020-10-12T10:01:48Z", "message": "remove redundant method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8049d808375e77df9ccc97ec05fc2b208db6319", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/d8049d808375e77df9ccc97ec05fc2b208db6319", "committedDate": "2020-10-12T10:03:45Z", "message": "remove old changelog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43d006802be3d037d91f86d9e85bf0fe23a2d98e", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/43d006802be3d037d91f86d9e85bf0fe23a2d98e", "committedDate": "2020-10-12T10:03:45Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17e47712e502a48e9d0ebdc94bcc3ecd28e41b95", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/17e47712e502a48e9d0ebdc94bcc3ecd28e41b95", "committedDate": "2020-10-12T13:07:59Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MzUwMjkx", "url": "https://github.com/palantir/atlasdb/pull/5021#pullrequestreview-507350291", "createdAt": "2020-10-13T11:51:57Z", "commit": {"oid": "17e47712e502a48e9d0ebdc94bcc3ecd28e41b95"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMTo1MTo1N1rOHgi2YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMjoyMjowMlrOHgj7qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4NzQ1Nw==", "bodyText": "Feels wrong that you would allow this?", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r503887457", "createdAt": "2020-10-13T11:51:57Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/VersionedEventStore.java", "diffHunk": "@@ -77,7 +77,10 @@ VersionedEventStoreState getStateForTesting() {\n                 .build();\n     }\n \n-    private Collection<LockWatchEvent> getValuesBetweenInclusive(long endVersion, Long startVersion) {\n+    private Collection<LockWatchEvent> getValuesBetweenInclusive(long endVersion, long startVersion) {\n+        if (endVersion < startVersion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17e47712e502a48e9d0ebdc94bcc3ecd28e41b95"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg5MDA4OQ==", "bodyText": "Wouldn't you want to validate this where the parent method is called? As I understand it, it's because it simplifies the code in LockWatchEventLog#getEventsBetweenVersions, where you just snapshotVersion + 1, but I think this complexity should live there. Because in all other cases calling this method with the versions inverted is probably wrong?", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r503890089", "createdAt": "2020-10-13T11:56:35Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/VersionedEventStore.java", "diffHunk": "@@ -77,7 +77,10 @@ VersionedEventStoreState getStateForTesting() {\n                 .build();\n     }\n \n-    private Collection<LockWatchEvent> getValuesBetweenInclusive(long endVersion, Long startVersion) {\n+    private Collection<LockWatchEvent> getValuesBetweenInclusive(long endVersion, long startVersion) {\n+        if (endVersion < startVersion) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg4NzQ1Nw=="}, "originalCommit": {"oid": "17e47712e502a48e9d0ebdc94bcc3ecd28e41b95"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkwNDg2MQ==", "bodyText": "Can you also add tests here? I think there's a bunch of edge cases to cover around the snapshot computation piece? Or add unit tests, whatever works for you.", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r503904861", "createdAt": "2020-10-13T12:21:32Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventCacheIntegrationTest.java", "diffHunk": "@@ -236,25 +236,23 @@ public void cacheClearedOnSnapshotUpdate() {\n     }\n \n     @Test\n-    public void getEventsForTransactionsReturnsSnapshotWithOldEvents() {\n+    public void getEventsForTransactionsReturnsSnapshotWithCondensedEvents() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17e47712e502a48e9d0ebdc94bcc3ecd28e41b95"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkwNTE5NA==", "bodyText": "Check continuity?", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r503905194", "createdAt": "2020-10-13T12:22:02Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ClientLockWatchSnapshot.java", "diffHunk": "@@ -61,6 +61,13 @@ private ClientLockWatchSnapshot() {\n                 ImmutableSet.copyOf(watches));\n     }\n \n+    LockWatchStateUpdate.Snapshot getSnapshotWithEvents(LockWatchEvents events, UUID versionId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17e47712e502a48e9d0ebdc94bcc3ecd28e41b95"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTUxMTAy", "url": "https://github.com/palantir/atlasdb/pull/5021#pullrequestreview-508151102", "createdAt": "2020-10-14T09:16:33Z", "commit": {"oid": "17e47712e502a48e9d0ebdc94bcc3ecd28e41b95"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOToxNjozM1rOHhJ4jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOToxNjozM1rOHhJ4jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUyNjk5MA==", "bodyText": "For completeness, can you also remove the \"Preconditions.checkArgument(!startTimestamps.isEmpty(), \"Cannot get events for empty set of transactions\");\" here; it's checked in the TimestampMapping", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r504526990", "createdAt": "2020-10-14T09:16:33Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventCacheImpl.java", "diffHunk": "@@ -100,7 +105,13 @@ public TransactionsLockWatchUpdate getUpdateForTransactions(\n         lastKnownVersion.ifPresent(version -> assertTrue(version.version() <= timestampMapping.lastVersion().version(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17e47712e502a48e9d0ebdc94bcc3ecd28e41b95"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTUyOTA4", "url": "https://github.com/palantir/atlasdb/pull/5021#pullrequestreview-508152908", "createdAt": "2020-10-14T09:18:44Z", "commit": {"oid": "17e47712e502a48e9d0ebdc94bcc3ecd28e41b95"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOToxODo0NFrOHhJ-Cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOToxODo0NFrOHhJ-Cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUyODM5NQ==", "bodyText": "This comment should just live on VersionBounds, if you really care about it.", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r504528395", "createdAt": "2020-10-14T09:18:44Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java", "diffHunk": "@@ -49,31 +51,36 @@ CacheUpdate processUpdate(LockWatchStateUpdate update) {\n     }\n \n     /**\n-     * @param lastKnownVersion latest version that the client knows about; should be before timestamps in the mapping.\n-     * @param endVersion       mapping from timestamp to identified version from client-side event cache.\n-     * @return lock watch events that occurred from (exclusive) the provided version, up to the end version (inclusive)\n+     * @param versionBounds contains:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17e47712e502a48e9d0ebdc94bcc3ecd28e41b95"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63d402726b7795e805abf936a8153cf61790d8e2", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/63d402726b7795e805abf936a8153cf61790d8e2", "committedDate": "2020-10-15T15:08:29Z", "message": "some progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5add0394d0864ab56e46b79f522cd054ef9da8cb", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/5add0394d0864ab56e46b79f522cd054ef9da8cb", "committedDate": "2020-10-15T15:14:23Z", "message": "merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05714a9c54c676d587bdcf7e134670178079dbf8", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/05714a9c54c676d587bdcf7e134670178079dbf8", "committedDate": "2020-10-15T15:27:29Z", "message": "all the tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f231ea9cd1fc307094fa2673d4d329b8b9433ce", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/4f231ea9cd1fc307094fa2673d4d329b8b9433ce", "committedDate": "2020-10-15T15:29:51Z", "message": "rename and another refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fc3019d0d4d5bfb94d2a010ed19b97ed613ba20", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/9fc3019d0d4d5bfb94d2a010ed19b97ed613ba20", "committedDate": "2020-10-16T12:28:13Z", "message": "unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNTU0MzM4", "url": "https://github.com/palantir/atlasdb/pull/5021#pullrequestreview-513554338", "createdAt": "2020-10-21T11:00:42Z", "commit": {"oid": "9fc3019d0d4d5bfb94d2a010ed19b97ed613ba20"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMTowMDo0MlrOHlmNOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMTowMDo0MlrOHlmNOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NTMzOA==", "bodyText": "Would we get anything in terms of simplification of code if this was taking Long startTimestamp, instead of Set? atlas-proxy just needs one transaction pushed here.", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r509185338", "createdAt": "2020-10-21T11:00:42Z", "author": {"login": "jkozlowski"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventCacheImpl.java", "diffHunk": "@@ -86,18 +85,28 @@ public CommitUpdate getCommitUpdate(long startTs) {\n                 \"start or commit info not processed for start timestamp\");\n \n         CommitInfo commitInfo = maybeCommitInfo.get();\n-        return eventLog.getEventsBetweenVersions(startVersion, commitInfo.commitVersion())\n-                .toCommitUpdate(startVersion.get(), commitInfo);\n+\n+        VersionBounds versionBounds = new VersionBounds.Builder()\n+                .startVersion(startVersion)\n+                .endVersion(commitInfo.commitVersion())\n+                .build();\n+\n+        return eventLog.getEventsBetweenVersions(versionBounds).toCommitUpdate(startVersion.get(), commitInfo);\n     }\n \n     @Override\n     public TransactionsLockWatchUpdate getUpdateForTransactions(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fc3019d0d4d5bfb94d2a010ed19b97ed613ba20"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c9376f3a0e6a4f2295e906149cea9ec44e14860", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/4c9376f3a0e6a4f2295e906149cea9ec44e14860", "committedDate": "2021-02-15T13:27:33Z", "message": "Merge branch 'develop' into snapshot-compression-squashed-2\n\n# Conflicts:\n#\tatlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventCacheImpl.java\n#\tatlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java\n#\tatlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEvents.java\n#\tatlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventCacheIntegrationTest.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTkwNDc5NzE1", "url": "https://github.com/palantir/atlasdb/pull/5021#pullrequestreview-590479715", "createdAt": "2021-02-15T13:34:02Z", "commit": {"oid": "9fc3019d0d4d5bfb94d2a010ed19b97ed613ba20"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xNVQxMzozNDowMlrOIlgKaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xNVQxMzozNDowMlrOIlgKaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjE5NTE3Nw==", "bodyText": "This check lives in TimestampMapping", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r576195177", "createdAt": "2021-02-15T13:34:02Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventCacheImpl.java", "diffHunk": "@@ -86,18 +85,28 @@ public CommitUpdate getCommitUpdate(long startTs) {\n                 \"start or commit info not processed for start timestamp\");\n \n         CommitInfo commitInfo = maybeCommitInfo.get();\n-        return eventLog.getEventsBetweenVersions(startVersion, commitInfo.commitVersion())\n-                .toCommitUpdate(startVersion.get(), commitInfo);\n+\n+        VersionBounds versionBounds = new VersionBounds.Builder()\n+                .startVersion(startVersion)\n+                .endVersion(commitInfo.commitVersion())\n+                .build();\n+\n+        return eventLog.getEventsBetweenVersions(versionBounds).toCommitUpdate(startVersion.get(), commitInfo);\n     }\n \n     @Override\n     public TransactionsLockWatchUpdate getUpdateForTransactions(\n             Set<Long> startTimestamps,\n             Optional<LockWatchVersion> lastKnownVersion) {\n-        Preconditions.checkArgument(!startTimestamps.isEmpty(), \"Cannot get events for empty set of transactions\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9fc3019d0d4d5bfb94d2a010ed19b97ed613ba20"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89e0532001f2aa5fb9cae60f3dce58cc488611c7", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/89e0532001f2aa5fb9cae60f3dce58cc488611c7", "committedDate": "2021-02-15T13:46:30Z", "message": "tidy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTkwNDkxMDg2", "url": "https://github.com/palantir/atlasdb/pull/5021#pullrequestreview-590491086", "createdAt": "2021-02-15T13:48:26Z", "commit": {"oid": "89e0532001f2aa5fb9cae60f3dce58cc488611c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xNVQxMzo0ODoyNlrOIlgspQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0xNVQxMzo0ODoyNlrOIlgspQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjIwMzk0MQ==", "bodyText": "We want to get the events after the snapshot only", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r576203941", "createdAt": "2021-02-15T13:48:26Z", "author": {"login": "Jolyon-S"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventLog.java", "diffHunk": "@@ -49,35 +52,44 @@ CacheUpdate processUpdate(LockWatchStateUpdate update) {\n     }\n \n     /**\n-     * @param lastKnownVersion latest version that the client knows about; should be before timestamps in the mapping.\n-     * @param endVersion       mapping from timestamp to identified version from client-side event cache.\n-     * @return lock watch events that occurred from (exclusive) the provided version, up to the end version (inclusive)\n+     * @return lock watch events that occurred from (exclusive) the provided version, up to the end version (inclusive);\n+     *         this may begin with a snapshot if the latest version is too far behind, and this snapshot may be\n+     *         condensed.\n      */\n-    public ClientLogEvents getEventsBetweenVersions(\n-            Optional<LockWatchVersion> lastKnownVersion, LockWatchVersion endVersion) {\n-        Optional<LockWatchVersion> startVersion = lastKnownVersion.map(this::createStartVersion);\n-        LockWatchVersion currentVersion = getLatestVersionAndVerify(endVersion);\n+    public ClientLogEvents getEventsBetweenVersions(VersionBounds versionBounds) {\n+        Optional<LockWatchVersion> startVersion = versionBounds.startVersion().map(this::createStartVersion);\n+        LockWatchVersion currentVersion = getLatestVersionAndVerify(versionBounds.endVersion());\n \n         if (!startVersion.isPresent()\n                 || differentLeaderOrTooFarBehind(currentVersion, lastKnownVersion.get(), startVersion.get())) {\n+            long snapshotVersion = versionBounds.snapshotVersion() + 1;\n+            Collection<LockWatchEvent> afterSnapshotEvents;\n+            if (snapshotVersion > versionBounds.endVersion().version()) {\n+                afterSnapshotEvents = ImmutableList.of();\n+            } else {\n+                afterSnapshotEvents = eventStore.getEventsBetweenVersionsInclusive(\n+                        Optional.of(snapshotVersion), versionBounds.endVersion().version());\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89e0532001f2aa5fb9cae60f3dce58cc488611c7"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9720e9eb93f6d6efc6ac307195342c2df1beec62", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/9720e9eb93f6d6efc6ac307195342c2df1beec62", "committedDate": "2021-02-16T10:35:49Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a100b91f97785f3dc452c93a5c9ca16dcf547b3c", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/a100b91f97785f3dc452c93a5c9ca16dcf547b3c", "committedDate": "2021-02-16T10:53:45Z", "message": "exterminate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/a4d70d8493151597f4eb1e9ff7410d3f90fe6da5", "committedDate": "2021-02-16T11:59:08Z", "message": "maybe that fixes it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ef17b0e1dd763694f2f83d06fe62d21cbc188fe", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/6ef17b0e1dd763694f2f83d06fe62d21cbc188fe", "committedDate": "2021-02-16T11:59:08Z", "message": "Add generated changelog entries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk4ODE0ODEy", "url": "https://github.com/palantir/atlasdb/pull/5021#pullrequestreview-598814812", "createdAt": "2021-02-25T17:21:49Z", "commit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yNVQxNzoyMTo0OVrOIsAwOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0yNVQxODowNjowMFrOIsCsog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzAyMDYwMg==", "bodyText": "getSnapshot() can be private", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r583020602", "createdAt": "2021-02-25T17:21:49Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/ClientLockWatchSnapshot.java", "diffHunk": "@@ -60,11 +60,19 @@ private ClientLockWatchSnapshot() {\n                 ImmutableSet.copyOf(watches));\n     }\n \n+    LockWatchStateUpdate.Snapshot getSnapshotWithEvents(LockWatchEvents events, UUID versionId) {\n+        ClientLockWatchSnapshot freshSnapshot = create();\n+        freshSnapshot.resetWithSnapshot(getSnapshot());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzAyMzQ5NA==", "bodyText": "Oh no you don't", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r583023494", "createdAt": "2021-02-25T17:25:54Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/VersionBounds.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * (c) Copyright 2020 Palantir Technologies Inc. All rights reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.palantir.atlasdb.keyvalue.api.watch;\n+\n+import com.palantir.lock.watch.LockWatchVersion;\n+import java.util.Optional;\n+import java.util.UUID;\n+import org.immutables.value.Value;\n+\n+@Value.Immutable\n+interface VersionBounds {\n+    Optional<LockWatchVersion> startVersion();\n+\n+    LockWatchVersion endVersion();\n+\n+    /**\n+     * If the start version is too far behind and we need to take a snapshot, this field communicates how much we can\n+     * condense the events in that snapshot.\n+     */\n+    Optional<Long> earliestSnapshotVersion();\n+\n+    @Value.Derived\n+    default long snapshotVersion() {\n+        return earliestSnapshotVersion().orElseGet(() -> endVersion().version());\n+    }\n+\n+    @Value.Derived\n+    default UUID leader() {\n+        return endVersion().id();\n+    }\n+\n+    class Builder extends ImmutableVersionBounds.Builder {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzAyNzAzMQ==", "bodyText": "that versionRange() method is super overengineered, since the correctness relies on the check below it at which point you can literally just do range of first event.sequence + length of list -1 instead of fancy streams", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r583027031", "createdAt": "2021-02-25T17:30:28Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEvents.java", "diffHunk": "@@ -62,5 +64,22 @@ default void rangeOnlyPresentIffEventsAre() {\n         }\n     }\n \n+    default void assertNoEventsAreMissing(Optional<LockWatchVersion> latestVersion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzAyODU5Ng==", "bodyText": "This can never happen", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r583028596", "createdAt": "2021-02-25T17:32:38Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEvents.java", "diffHunk": "@@ -62,5 +64,22 @@ default void rangeOnlyPresentIffEventsAre() {\n         }\n     }\n \n+    default void assertNoEventsAreMissing(Optional<LockWatchVersion> latestVersion) {\n+        if (events().isEmpty()) {\n+            return;\n+        }\n+\n+        if (latestVersion.isPresent()) {\n+            Preconditions.checkArgument(versionRange().isPresent(), \"First element not preset in list of events\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzAyOTI1NQ==", "bodyText": "below: wth!!!", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r583029255", "createdAt": "2021-02-25T17:33:30Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEvents.java", "diffHunk": "@@ -62,5 +64,22 @@ default void rangeOnlyPresentIffEventsAre() {\n         }\n     }\n \n+    default void assertNoEventsAreMissing(Optional<LockWatchVersion> latestVersion) {\n+        if (events().isEmpty()) {\n+            return;\n+        }\n+\n+        if (latestVersion.isPresent()) {\n+            Preconditions.checkArgument(versionRange().isPresent(), \"First element not preset in list of events\");\n+            long firstVersion = versionRange().get().lowerEndpoint();\n+            Preconditions.checkArgument(\n+                    firstVersion <= latestVersion.get().version()\n+                            || latestVersion.get().version() + 1 == firstVersion,\n+                    \"Events missing between last snapshot and this batch of events\",\n+                    SafeArg.of(\"latestVersionSequence\", latestVersion.get().version()),\n+                    SafeArg.of(\"firstNewVersionSequence\", firstVersion));\n+        }\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzAzNDY4Ng==", "bodyText": "Maybe the invariant holds, but this is also just easier to read\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                firstVersion <= latestVersion.get().version()\n          \n          \n            \n                                versionRange().get().contains(latestVersion.get().version())", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r583034686", "createdAt": "2021-02-25T17:41:02Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/main/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEvents.java", "diffHunk": "@@ -62,5 +64,22 @@ default void rangeOnlyPresentIffEventsAre() {\n         }\n     }\n \n+    default void assertNoEventsAreMissing(Optional<LockWatchVersion> latestVersion) {\n+        if (events().isEmpty()) {\n+            return;\n+        }\n+\n+        if (latestVersion.isPresent()) {\n+            Preconditions.checkArgument(versionRange().isPresent(), \"First element not preset in list of events\");\n+            long firstVersion = versionRange().get().lowerEndpoint();\n+            Preconditions.checkArgument(\n+                    firstVersion <= latestVersion.get().version()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzAzNTc2MA==", "bodyText": "nit", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r583035760", "createdAt": "2021-02-25T17:42:36Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/test/resources/lockwatch-event-cache-output/getEventsForTransactionsNoCondensing/event-cache-1.json", "diffHunk": "@@ -0,0 +1,78 @@\n+{\n+  \"logState\" : {\n+    \"snapshotState\" : {\n+      \"watches\" : [ ],\n+      \"locked\" : [ {\n+        \"bytes\" : \"dGFibGUAAg==\"\n+      } ],\n+      \"snapshotVersion\" : {\n+        \"id\" : \"470c855e-f77b-44df-b56a-14d3df085dbc\",\n+        \"version\" : 3\n+      }\n+    },\n+    \"eventStoreState\" : {\n+      \"eventMap\" : {\n+        \"4\" : {\n+          \"type\" : \"created\",\n+          \"sequence\" : 4,\n+          \"references\" : [ {\n+            \"type\" : \"fullTable\",\n+            \"qualifiedTableRef\" : \"table\"\n+          } ],\n+          \"lockDescriptors\" : [ {\n+            \"bytes\" : \"dGFibGUAAQ==\"\n+          } ]\n+        },\n+        \"5\" : {\n+          \"type\" : \"unlock\",\n+          \"sequence\" : 5,\n+          \"lockDescriptors\" : [ {\n+            \"bytes\" : \"dGFibGUAAg==\"\n+          } ]\n+        },\n+        \"6\" : {\n+          \"type\" : \"lock\",\n+          \"sequence\" : 6,\n+          \"lockDescriptors\" : [ {\n+            \"bytes\" : \"dGFibGUAAw==\"\n+          } ],\n+          \"lockToken\" : {\n+            \"requestId\" : \"203fcd7a-b3d7-4c2a-9d2c-3d61cde1ba59\"\n+          }\n+        },\n+        \"7\" : {\n+          \"type\" : \"lock\",\n+          \"sequence\" : 7,\n+          \"lockDescriptors\" : [ {\n+            \"bytes\" : \"dGFibGUAAQ==\"\n+          } ],\n+          \"lockToken\" : {\n+            \"requestId\" : \"888fcd7a-b3d7-4d2a-9d2c-3d61cde1ba44\"\n+          }\n+        }\n+      }\n+    },\n+    \"latestVersion\" : {\n+      \"id\" : \"470c855e-f77b-44df-b56a-14d3df085dbc\",\n+      \"version\" : 7\n+    }\n+  },\n+  \"timestampStoreState\" : {\n+    \"timestampMap\" : {\n+      \"16\" : {\n+        \"version\" : {\n+          \"id\" : \"470c855e-f77b-44df-b56a-14d3df085dbc\",\n+          \"version\" : 7\n+        },\n+        \"commitInfo\" : null\n+      },\n+      \"1\" : {\n+        \"version\" : {\n+          \"id\" : \"470c855e-f77b-44df-b56a-14d3df085dbc\",\n+          \"version\" : 3\n+        },\n+        \"commitInfo\" : null\n+      }\n+    }\n+  }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzAzNTg0Mw==", "bodyText": "nit", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r583035843", "createdAt": "2021-02-25T17:42:42Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/test/resources/lockwatch-event-cache-output/getEventsForTransactionsSomeCondensing/event-cache-1.json", "diffHunk": "@@ -48,6 +48,21 @@\n     }\n   },\n   \"timestampStoreState\" : {\n-    \"timestampMap\" : { }\n+    \"timestampMap\" : {\n+      \"16\" : {\n+        \"version\" : {\n+          \"id\" : \"470c855e-f77b-44df-b56a-14d3df085dbc\",\n+          \"version\" : 6\n+        },\n+        \"commitInfo\" : null\n+      },\n+      \"1\" : {\n+        \"version\" : {\n+          \"id\" : \"470c855e-f77b-44df-b56a-14d3df085dbc\",\n+          \"version\" : 3\n+        },\n+        \"commitInfo\" : null\n+      }\n+    }\n   }\n }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzAzNTkyNg==", "bodyText": "nit", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r583035926", "createdAt": "2021-02-25T17:42:48Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/test/resources/lockwatch-event-cache-output/getEventsForTransactionsSomeCondensing/event-cache-2.json", "diffHunk": "@@ -0,0 +1,85 @@\n+{\n+  \"logState\" : {\n+    \"snapshotState\" : {\n+      \"watches\" : [ ],\n+      \"locked\" : [ {\n+        \"bytes\" : \"dGFibGUAAg==\"\n+      } ],\n+      \"snapshotVersion\" : {\n+        \"id\" : \"470c855e-f77b-44df-b56a-14d3df085dbc\",\n+        \"version\" : 3\n+      }\n+    },\n+    \"eventStoreState\" : {\n+      \"eventMap\" : {\n+        \"4\" : {\n+          \"type\" : \"created\",\n+          \"sequence\" : 4,\n+          \"references\" : [ {\n+            \"type\" : \"fullTable\",\n+            \"qualifiedTableRef\" : \"table\"\n+          } ],\n+          \"lockDescriptors\" : [ {\n+            \"bytes\" : \"dGFibGUAAQ==\"\n+          } ]\n+        },\n+        \"5\" : {\n+          \"type\" : \"unlock\",\n+          \"sequence\" : 5,\n+          \"lockDescriptors\" : [ {\n+            \"bytes\" : \"dGFibGUAAg==\"\n+          } ]\n+        },\n+        \"6\" : {\n+          \"type\" : \"lock\",\n+          \"sequence\" : 6,\n+          \"lockDescriptors\" : [ {\n+            \"bytes\" : \"dGFibGUAAw==\"\n+          } ],\n+          \"lockToken\" : {\n+            \"requestId\" : \"203fcd7a-b3d7-4c2a-9d2c-3d61cde1ba59\"\n+          }\n+        },\n+        \"7\" : {\n+          \"type\" : \"lock\",\n+          \"sequence\" : 7,\n+          \"lockDescriptors\" : [ {\n+            \"bytes\" : \"dGFibGUAAQ==\"\n+          } ],\n+          \"lockToken\" : {\n+            \"requestId\" : \"888fcd7a-b3d7-4d2a-9d2c-3d61cde1ba44\"\n+          }\n+        }\n+      }\n+    },\n+    \"latestVersion\" : {\n+      \"id\" : \"470c855e-f77b-44df-b56a-14d3df085dbc\",\n+      \"version\" : 7\n+    }\n+  },\n+  \"timestampStoreState\" : {\n+    \"timestampMap\" : {\n+      \"16\" : {\n+        \"version\" : {\n+          \"id\" : \"470c855e-f77b-44df-b56a-14d3df085dbc\",\n+          \"version\" : 6\n+        },\n+        \"commitInfo\" : null\n+      },\n+      \"1\" : {\n+        \"version\" : {\n+          \"id\" : \"470c855e-f77b-44df-b56a-14d3df085dbc\",\n+          \"version\" : 3\n+        },\n+        \"commitInfo\" : null\n+      },\n+      \"25\" : {\n+        \"version\" : {\n+          \"id\" : \"470c855e-f77b-44df-b56a-14d3df085dbc\",\n+          \"version\" : 7\n+        },\n+        \"commitInfo\" : null\n+      }\n+    }\n+  }\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzAzNjI2OQ==", "bodyText": "as much as possible? I think it's better even if you really meant as far into the past as possible", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r583036269", "createdAt": "2021-02-25T17:43:22Z", "author": {"login": "gmaretic"}, "path": "changelog/@unreleased/pr-5021.v2.yml", "diffHunk": "@@ -0,0 +1,6 @@\n+type: improvement\n+improvement:\n+  description: Lock watch snapshots returned to the user are now condensed as far", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MzA1MjQ1MA==", "bodyText": "Can we make these tests more legible by not using seemingly magic numbers?\nI.e.,\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            eventCache.getUpdateForTransactions(Sets.union(TIMESTAMPS, TIMESTAMPS_2), Optional.empty());\n          \n          \n            \n                           eventCache.getUpdateForTransactions(ImmutableSet.of(START_TS, TS_16), Optional.empty());\n          \n      \n    \n    \n  \n\nand then using those in the asserts, and similarly below not using the magic LockWatchVersion but call logId and lastKnownVersion on the relevant updates?", "url": "https://github.com/palantir/atlasdb/pull/5021#discussion_r583052450", "createdAt": "2021-02-25T18:06:00Z", "author": {"login": "gmaretic"}, "path": "atlasdb-impl-shared/src/test/java/com/palantir/atlasdb/keyvalue/api/watch/LockWatchEventCacheIntegrationTest.java", "diffHunk": "@@ -296,30 +296,72 @@ public void cacheClearedOnSnapshotUpdate() {\n     }\n \n     @Test\n-    public void getEventsForTransactionsReturnsSnapshotWithOldEvents() {\n-        createEventCache(3);\n+    public void getEventsForTransactionsNoCondensing() {\n         setupInitialState();\n-        eventCache.processGetCommitTimestampsUpdate(COMMIT_UPDATE, SUCCESS);\n-        eventCache.removeTransactionStateFromCache(START_TS);\n-        verifyStage();\n-\n+        eventCache.processStartTransactionsUpdate(ImmutableSet.of(), SUCCESS);\n         eventCache.processStartTransactionsUpdate(TIMESTAMPS_2, SUCCESS_2);\n         verifyStage();\n \n-        TransactionsLockWatchUpdate results = eventCache.getUpdateForTransactions(TIMESTAMPS_2, Optional.empty());\n+        // Client is behind and needs a snapshot, but no compression can be done as the first transaction is at the\n+        // first version\n+        TransactionsLockWatchUpdate results =\n+                eventCache.getUpdateForTransactions(Sets.union(TIMESTAMPS, TIMESTAMPS_2), Optional.empty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d70d8493151597f4eb1e9ff7410d3f90fe6da5"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32877c3bb67e24d19dca695989b9146441fa1b2b", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/32877c3bb67e24d19dca695989b9146441fa1b2b", "committedDate": "2021-02-26T10:18:07Z", "message": "booom"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTk5NDY3NjEy", "url": "https://github.com/palantir/atlasdb/pull/5021#pullrequestreview-599467612", "createdAt": "2021-02-26T10:58:47Z", "commit": {"oid": "32877c3bb67e24d19dca695989b9146441fa1b2b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f01414faea258e0c0838832ec74a86dde3e548b6", "author": {"user": {"login": "Jolyon-S", "name": "Jolyon"}}, "url": "https://github.com/palantir/atlasdb/commit/f01414faea258e0c0838832ec74a86dde3e548b6", "committedDate": "2021-02-26T11:00:09Z", "message": "rename"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2625, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}