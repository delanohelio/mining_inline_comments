{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNzA0OTIy", "number": 5329, "title": "Issue 5324: Add generations to Controller API for Consumption Based Retention", "bodyText": "Change log description\nTo ensure stale API updates from Client are not applied by Controller, we need to add a Subscriber generation field to the API and ensure Controller only executes the API if the generation value is greater than the generation stored in its metadata.\nPurpose of the change\nFixes #5324\nWhat the code does\nAdds a generation field to add and delete subscriber APIs, such that if generation provided in the API is lower than generation stored in the metadata, the operation is rejected.\nHow to verify it\nUnit and Integration Tests should pass.", "createdAt": "2020-11-13T17:04:54Z", "url": "https://github.com/pravega/pravega/pull/5329", "merged": true, "mergeCommit": {"oid": "a960bfff55f74cd2776b7cece622989d72a2bcb5"}, "closed": true, "closedAt": "2020-11-19T13:48:39Z", "author": {"login": "pbelgundi"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdcKNZgAH2gAyNTIwNzA0OTIyOjhhMmZlZTZhMzcyMjFmMjFkZGVmZTExZjc3M2M4MjIwNjM1MmI3YjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdeDDQTAFqTUzNDQ2MDg5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8a2fee6a37221f21ddefe11f773c82206352b7b0", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/8a2fee6a37221f21ddefe11f773c82206352b7b0", "committedDate": "2020-11-13T17:00:48Z", "message": "first cut\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e495bbf40f40a33cd4429b7165476c8e30182190", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/e495bbf40f40a33cd4429b7165476c8e30182190", "committedDate": "2020-11-13T17:01:06Z", "message": "Merge remote-tracking branch 'upstream/master' into issue-5324-subscriber-generations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b1ca5a4ff2bb9d3b9e53ab158956759c7064230", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/6b1ca5a4ff2bb9d3b9e53ab158956759c7064230", "committedDate": "2020-11-17T09:24:46Z", "message": "integration tests fixed\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc08e8a734f2d6a2f90a6b3589f643000ede9c37", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/bc08e8a734f2d6a2f90a6b3589f643000ede9c37", "committedDate": "2020-11-17T09:25:00Z", "message": "Merge remote-tracking branch 'upstream/master' into issue-5324-subscriber-generations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2d922c351a8306e0de709c9cedf85654f3ad2a5", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/a2d922c351a8306e0de709c9cedf85654f3ad2a5", "committedDate": "2020-11-17T11:27:20Z", "message": "bug fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de0274179d8130064c2b2e62546433d9f670ecd9", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/de0274179d8130064c2b2e62546433d9f670ecd9", "committedDate": "2020-11-17T12:47:03Z", "message": "fix removesubscriber\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b32c859201c769e90c9b76e4c283286505b2e91", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/0b32c859201c769e90c9b76e4c283286505b2e91", "committedDate": "2020-11-18T04:56:48Z", "message": "test case fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e504d9841c0c5ea29077abd5a33f656d04933aa2", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/e504d9841c0c5ea29077abd5a33f656d04933aa2", "committedDate": "2020-11-18T05:01:04Z", "message": "test case fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTE5NjY1", "url": "https://github.com/pravega/pravega/pull/5329#pullrequestreview-533119665", "createdAt": "2020-11-18T05:44:35Z", "commit": {"oid": "e504d9841c0c5ea29077abd5a33f656d04933aa2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNTo0NDozNVrOH1eAww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNTo0NDozNVrOH1eAww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyODI5MQ==", "bodyText": "this is a hanging future. this should be returned from this thenCompose call", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525828291", "createdAt": "2020-11-18T05:44:35Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/PravegaTablesStream.java", "diffHunk": "@@ -278,15 +277,32 @@ private String getWritersTableName(String id) {\n     }\n \n     @Override\n-    public CompletableFuture<Void> createSubscriber(String newSubscriber) {\n+    public CompletableFuture<Void> createSubscriber(String newSubscriber, long operationGeneration) {\n         final StreamSubscriber newSubscriberRecord = new StreamSubscriber(newSubscriber, ImmutableMap.of(), System.currentTimeMillis());\n         return getMetadataTable()\n                 .thenCompose(metadataTable -> getSubscriberSetRecord(true)\n-                        .thenCompose(subscriberSetRecord -> storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n-                                SubscriberSet.add(subscriberSetRecord.getObject(), newSubscriber).toBytes(), subscriberSetRecord.getVersion())\n-                                .thenCompose(v -> storeHelper.addNewEntryIfAbsent(metadataTable, getKeyForSubscriber(newSubscriber), newSubscriberRecord.toBytes()))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, getKeyForSubscriber(newSubscriber)))));\n+                   .thenCompose(subscriberSetRecord -> {\n+                       if (subscriberSetRecord.getObject().getSubscribers().containsKey(newSubscriber)) {\n+                           // update Subscriber generation\n+                           Long generation = subscriberSetRecord.getObject().getSubscribers().get(newSubscriber);\n+                           if (generation.longValue() < operationGeneration) {\n+                               storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e504d9841c0c5ea29077abd5a33f656d04933aa2"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTE5Nzcz", "url": "https://github.com/pravega/pravega/pull/5329#pullrequestreview-533119773", "createdAt": "2020-11-18T05:44:55Z", "commit": {"oid": "e504d9841c0c5ea29077abd5a33f656d04933aa2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNTo0NDo1NVrOH1eBLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNTo0NDo1NVrOH1eBLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyODM5Nw==", "bodyText": "we need to handle the else case and return a completed future", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525828397", "createdAt": "2020-11-18T05:44:55Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/PravegaTablesStream.java", "diffHunk": "@@ -278,15 +277,32 @@ private String getWritersTableName(String id) {\n     }\n \n     @Override\n-    public CompletableFuture<Void> createSubscriber(String newSubscriber) {\n+    public CompletableFuture<Void> createSubscriber(String newSubscriber, long operationGeneration) {\n         final StreamSubscriber newSubscriberRecord = new StreamSubscriber(newSubscriber, ImmutableMap.of(), System.currentTimeMillis());\n         return getMetadataTable()\n                 .thenCompose(metadataTable -> getSubscriberSetRecord(true)\n-                        .thenCompose(subscriberSetRecord -> storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n-                                SubscriberSet.add(subscriberSetRecord.getObject(), newSubscriber).toBytes(), subscriberSetRecord.getVersion())\n-                                .thenCompose(v -> storeHelper.addNewEntryIfAbsent(metadataTable, getKeyForSubscriber(newSubscriber), newSubscriberRecord.toBytes()))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, getKeyForSubscriber(newSubscriber)))));\n+                   .thenCompose(subscriberSetRecord -> {\n+                       if (subscriberSetRecord.getObject().getSubscribers().containsKey(newSubscriber)) {\n+                           // update Subscriber generation\n+                           Long generation = subscriberSetRecord.getObject().getSubscribers().get(newSubscriber);\n+                           if (generation.longValue() < operationGeneration) {\n+                               storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n+                                SubscriberSet.update(subscriberSetRecord.getObject(), newSubscriber, generation).toBytes(),\n+                                                                         subscriberSetRecord.getVersion())\n+                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY));\n+                           }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e504d9841c0c5ea29077abd5a33f656d04933aa2"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTE5ODg1", "url": "https://github.com/pravega/pravega/pull/5329#pullrequestreview-533119885", "createdAt": "2020-11-18T05:45:17Z", "commit": {"oid": "e504d9841c0c5ea29077abd5a33f656d04933aa2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNTo0NToxN1rOH1eBgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNTo0NToxN1rOH1eBgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyODQ4Mw==", "bodyText": "same comment.. hanging future.. should be linked to the response being sent from this callback", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525828483", "createdAt": "2020-11-18T05:45:17Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/PravegaTablesStream.java", "diffHunk": "@@ -278,15 +277,32 @@ private String getWritersTableName(String id) {\n     }\n \n     @Override\n-    public CompletableFuture<Void> createSubscriber(String newSubscriber) {\n+    public CompletableFuture<Void> createSubscriber(String newSubscriber, long operationGeneration) {\n         final StreamSubscriber newSubscriberRecord = new StreamSubscriber(newSubscriber, ImmutableMap.of(), System.currentTimeMillis());\n         return getMetadataTable()\n                 .thenCompose(metadataTable -> getSubscriberSetRecord(true)\n-                        .thenCompose(subscriberSetRecord -> storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n-                                SubscriberSet.add(subscriberSetRecord.getObject(), newSubscriber).toBytes(), subscriberSetRecord.getVersion())\n-                                .thenCompose(v -> storeHelper.addNewEntryIfAbsent(metadataTable, getKeyForSubscriber(newSubscriber), newSubscriberRecord.toBytes()))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, getKeyForSubscriber(newSubscriber)))));\n+                   .thenCompose(subscriberSetRecord -> {\n+                       if (subscriberSetRecord.getObject().getSubscribers().containsKey(newSubscriber)) {\n+                           // update Subscriber generation\n+                           Long generation = subscriberSetRecord.getObject().getSubscribers().get(newSubscriber);\n+                           if (generation.longValue() < operationGeneration) {\n+                               storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n+                                SubscriberSet.update(subscriberSetRecord.getObject(), newSubscriber, generation).toBytes(),\n+                                                                         subscriberSetRecord.getVersion())\n+                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY));\n+                           }\n+                      } else {\n+                           // add new Subscriber\n+                           storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e504d9841c0c5ea29077abd5a33f656d04933aa2"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMTIwMjcz", "url": "https://github.com/pravega/pravega/pull/5329#pullrequestreview-533120273", "createdAt": "2020-11-18T05:46:26Z", "commit": {"oid": "e504d9841c0c5ea29077abd5a33f656d04933aa2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNTo0NjoyNlrOH1eC0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQwNTo0NjoyNlrOH1eC0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgyODgxOQ==", "bodyText": "whatever computation you are doing above is done asynchronously and then you are returning a completed future which is not linked to the above computation.. this is incorrect. this method will return with a completed future and caller will assume the work is done while the work would still be happening asynchronously and could fail.. the response future should be linked to the actual processing.", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525828819", "createdAt": "2020-11-18T05:46:26Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/PravegaTablesStream.java", "diffHunk": "@@ -278,15 +277,32 @@ private String getWritersTableName(String id) {\n     }\n \n     @Override\n-    public CompletableFuture<Void> createSubscriber(String newSubscriber) {\n+    public CompletableFuture<Void> createSubscriber(String newSubscriber, long operationGeneration) {\n         final StreamSubscriber newSubscriberRecord = new StreamSubscriber(newSubscriber, ImmutableMap.of(), System.currentTimeMillis());\n         return getMetadataTable()\n                 .thenCompose(metadataTable -> getSubscriberSetRecord(true)\n-                        .thenCompose(subscriberSetRecord -> storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n-                                SubscriberSet.add(subscriberSetRecord.getObject(), newSubscriber).toBytes(), subscriberSetRecord.getVersion())\n-                                .thenCompose(v -> storeHelper.addNewEntryIfAbsent(metadataTable, getKeyForSubscriber(newSubscriber), newSubscriberRecord.toBytes()))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY))\n-                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, getKeyForSubscriber(newSubscriber)))));\n+                   .thenCompose(subscriberSetRecord -> {\n+                       if (subscriberSetRecord.getObject().getSubscribers().containsKey(newSubscriber)) {\n+                           // update Subscriber generation\n+                           Long generation = subscriberSetRecord.getObject().getSubscribers().get(newSubscriber);\n+                           if (generation.longValue() < operationGeneration) {\n+                               storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n+                                SubscriberSet.update(subscriberSetRecord.getObject(), newSubscriber, generation).toBytes(),\n+                                                                         subscriberSetRecord.getVersion())\n+                                .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY));\n+                           }\n+                      } else {\n+                           // add new Subscriber\n+                           storeHelper.updateEntry(metadataTable, SUBSCRIBER_SET_KEY,\n+                                   SubscriberSet.add(subscriberSetRecord.getObject(),\n+                                           newSubscriber, operationGeneration).toBytes(), subscriberSetRecord.getVersion())\n+                                   .thenCompose(v -> storeHelper.addNewEntryIfAbsent(metadataTable,\n+                                           getKeyForSubscriber(newSubscriber), newSubscriberRecord.toBytes()))\n+                                   .thenAccept(v -> storeHelper.invalidateCache(metadataTable, SUBSCRIBER_SET_KEY))\n+                                   .thenAccept(v -> storeHelper.invalidateCache(metadataTable, getKeyForSubscriber(newSubscriber)));\n+                       }\n+                       return CompletableFuture.completedFuture(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e504d9841c0c5ea29077abd5a33f656d04933aa2"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a4ad1a0cfcbe227be46a6bea9fcc4a861543b69", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/2a4ad1a0cfcbe227be46a6bea9fcc4a861543b69", "committedDate": "2020-11-18T06:23:22Z", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "774b2175b588a440b101dee4f206e3d1f0872a80", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/774b2175b588a440b101dee4f206e3d1f0872a80", "committedDate": "2020-11-18T09:53:53Z", "message": "code review comments fixed\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a019b20bb2897dfa3a22ec79f0c37a31d5cd3b34", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/a019b20bb2897dfa3a22ec79f0c37a31d5cd3b34", "committedDate": "2020-11-18T10:01:13Z", "message": "checkstyle fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd7d7eeb90e32f9eae7728885957c1a838e285ee", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/dd7d7eeb90e32f9eae7728885957c1a838e285ee", "committedDate": "2020-11-18T10:18:47Z", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "618b7969cd9bbe872c6171d996d4389de7baf59e", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/618b7969cd9bbe872c6171d996d4389de7baf59e", "committedDate": "2020-11-18T10:19:04Z", "message": "Merge remote-tracking branch 'upstream/master' into issue-5324-subscriber-generations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6acbbc26019ed5b81af355eebea72d2a79c69d22", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/6acbbc26019ed5b81af355eebea72d2a79c69d22", "committedDate": "2020-11-18T10:27:08Z", "message": "test case fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMzI0MTM3", "url": "https://github.com/pravega/pravega/pull/5329#pullrequestreview-533324137", "createdAt": "2020-11-18T10:53:29Z", "commit": {"oid": "6acbbc26019ed5b81af355eebea72d2a79c69d22"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDo1MzoyOVrOH1oDAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDo1MzoyOVrOH1oDAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5MjcwNw==", "bodyText": "question: does create subscriber update the entry if it already existed, but with an older generation?", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r525992707", "createdAt": "2020-11-18T10:53:29Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/task/Stream/StreamMetadataTasks.java", "diffHunk": "@@ -311,18 +312,9 @@ public void initializeStreamWriters(final EventStreamClientFactory clientFactory\n                 return CompletableFuture.completedFuture(AddSubscriberStatus.Status.STREAM_NOT_FOUND);\n             } else {\n                 // 2. get subscribers data\n-                return Futures.exceptionallyExpecting(streamMetadataStore.getSubscriber(scope, stream, newSubscriber, context, executor),\n-                     e -> Exceptions.unwrap(e) instanceof StoreException.DataNotFoundException, null)\n-                    .thenCompose(subscribersData -> {\n-                    //4. If SubscriberRecord does not exist create one...\n-                    if (subscribersData == null) {\n-                        return streamMetadataStore.createSubscriber(scope, stream, newSubscriber, context, executor)\n-                                .thenApply(v -> AddSubscriberStatus.Status.SUCCESS);\n-                    } else {\n-                        return CompletableFuture.completedFuture(AddSubscriberStatus.Status.SUBSCRIBER_EXISTS);\n-                    }\n-                    })\n-                    .exceptionally(ex -> {\n+                return streamMetadataStore.createSubscriber(scope, stream, newSubscriber, generation, context, executor)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6acbbc26019ed5b81af355eebea72d2a79c69d22"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c8618e94fae21f94d88006d26d5371c09d3b86e", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/3c8618e94fae21f94d88006d26d5371c09d3b86e", "committedDate": "2020-11-18T14:50:52Z", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDk2Mjcx", "url": "https://github.com/pravega/pravega/pull/5329#pullrequestreview-534096271", "createdAt": "2020-11-19T05:41:28Z", "commit": {"oid": "3c8618e94fae21f94d88006d26d5371c09d3b86e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNTo0MToyOVrOH2Nitw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNTo0MToyOVrOH2Nitw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwNzAzMQ==", "bodyText": "nit: misnomer set when its a map", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r526607031", "createdAt": "2020-11-19T05:41:29Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/InMemoryStream.java", "diffHunk": "@@ -116,6 +116,9 @@\n     @GuardedBy(\"subscribersLock\")\n     private final List<VersionedMetadata<StreamSubscriber>> streamSubscribers = new ArrayList<>();\n \n+    @GuardedBy(\"subscribersLock\")\n+    private final Map<String, Long> subscribersSet = new HashMap<String, Long>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c8618e94fae21f94d88006d26d5371c09d3b86e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDk5MTkw", "url": "https://github.com/pravega/pravega/pull/5329#pullrequestreview-534099190", "createdAt": "2020-11-19T05:49:38Z", "commit": {"oid": "3c8618e94fae21f94d88006d26d5371c09d3b86e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNTo0OTozOVrOH2NsVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNTo0OTozOVrOH2NsVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwOTQ5Mg==", "bodyText": "this can be improved.. its making two passes (filter and putall) over the map. we can get it down to one pass only by adding all the existing entries and for entry which already exists, we add the new subscriber.\nin fact, putall followed by put will be sufficient too. if previous map had this subscriber its value will simply get overwritten.", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r526609492", "createdAt": "2020-11-19T05:49:39Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/records/SubscriberSet.java", "diffHunk": "@@ -37,37 +37,55 @@\n     public static final SubscriberSetSerializer SERIALIZER = new SubscriberSetSerializer();\n \n     @Getter\n-    private final ImmutableList<String> subscribers;\n+    private final ImmutableMap<String, Long> subscribers;\n \n     @Builder\n-    public SubscriberSet(@NonNull ImmutableList<String> subscribers) {\n+    public SubscriberSet(@NonNull ImmutableMap<String, Long> subscribers) {\n         this.subscribers = subscribers;\n     }\n \n     /**\n      * This method adds a subscriber in the subscriberSet.\n      * @param subscriberSet Subscriber Set.\n      * @param subscriber subscriber to be added.\n+     * @param generation subscriber generation.\n      * @return updated Subscriber Set.\n      */\n-    public static SubscriberSet add(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber) {\n-            ImmutableList.Builder<String> builder = ImmutableList.builder();\n-            builder.addAll(subscriberSet.subscribers);\n-            builder.add(subscriber);\n+    public static SubscriberSet add(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber, long generation) {\n+            ImmutableMap.Builder<String, Long> builder = ImmutableMap.builder();\n+            builder.putAll(subscriberSet.subscribers);\n+            builder.put(subscriber, generation);\n             return new SubscriberSet(builder.build());\n     }\n \n+    /**\n+     * This method updates the generation of a subscriber in the subscriberSet.\n+     * @param subscriberSet Subscriber Set.\n+     * @param subscriber subscriber to be added.\n+     * @param generation subscriber generation.\n+     * @return updated Subscriber Set.\n+     */\n+    public static SubscriberSet update(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber, long generation) {\n+        ImmutableMap.Builder<String, Long> builder = ImmutableMap.builder();\n+        Map<String, Long> otherSubscribers = subscriberSet.getSubscribers().entrySet().stream().filter(e -> !e.getKey().equals(subscriber))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c8618e94fae21f94d88006d26d5371c09d3b86e"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MDk5NjE2", "url": "https://github.com/pravega/pravega/pull/5329#pullrequestreview-534099616", "createdAt": "2020-11-19T05:50:52Z", "commit": {"oid": "3c8618e94fae21f94d88006d26d5371c09d3b86e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNTo1MDo1MlrOH2Nt1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNTo1MDo1MlrOH2Nt1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYwOTg3Ng==", "bodyText": "same here. we can put all and then call remove on the builder or at least do the whole thing in one pass", "url": "https://github.com/pravega/pravega/pull/5329#discussion_r526609876", "createdAt": "2020-11-19T05:50:52Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/records/SubscriberSet.java", "diffHunk": "@@ -37,37 +37,55 @@\n     public static final SubscriberSetSerializer SERIALIZER = new SubscriberSetSerializer();\n \n     @Getter\n-    private final ImmutableList<String> subscribers;\n+    private final ImmutableMap<String, Long> subscribers;\n \n     @Builder\n-    public SubscriberSet(@NonNull ImmutableList<String> subscribers) {\n+    public SubscriberSet(@NonNull ImmutableMap<String, Long> subscribers) {\n         this.subscribers = subscribers;\n     }\n \n     /**\n      * This method adds a subscriber in the subscriberSet.\n      * @param subscriberSet Subscriber Set.\n      * @param subscriber subscriber to be added.\n+     * @param generation subscriber generation.\n      * @return updated Subscriber Set.\n      */\n-    public static SubscriberSet add(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber) {\n-            ImmutableList.Builder<String> builder = ImmutableList.builder();\n-            builder.addAll(subscriberSet.subscribers);\n-            builder.add(subscriber);\n+    public static SubscriberSet add(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber, long generation) {\n+            ImmutableMap.Builder<String, Long> builder = ImmutableMap.builder();\n+            builder.putAll(subscriberSet.subscribers);\n+            builder.put(subscriber, generation);\n             return new SubscriberSet(builder.build());\n     }\n \n+    /**\n+     * This method updates the generation of a subscriber in the subscriberSet.\n+     * @param subscriberSet Subscriber Set.\n+     * @param subscriber subscriber to be added.\n+     * @param generation subscriber generation.\n+     * @return updated Subscriber Set.\n+     */\n+    public static SubscriberSet update(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber, long generation) {\n+        ImmutableMap.Builder<String, Long> builder = ImmutableMap.builder();\n+        Map<String, Long> otherSubscribers = subscriberSet.getSubscribers().entrySet().stream().filter(e -> !e.getKey().equals(subscriber))\n+                .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));\n+        builder.putAll(otherSubscribers);\n+        builder.put(subscriber, generation);\n+        return new SubscriberSet(builder.build());\n+    }\n+\n     /**\n      * This method removes a subscriber from the subscriberSet.\n      * @param subscriberSet Subscriber Set.\n      * @param subscriber subscriber to be removed.\n      * @return updated Subscriber Set.\n      */\n     public static SubscriberSet remove(@NonNull SubscriberSet subscriberSet, @NonNull String subscriber) {\n-        ImmutableList.Builder<String> builder = ImmutableList.builder();\n-        List<String> otherSubscribers = subscriberSet.getSubscribers().stream().filter(s -> !s.equals(subscriber)).collect(Collectors.toList());\n-        builder.addAll(otherSubscribers);\n-        return new SubscriberSet(builder.build());\n+       ImmutableMap.Builder<String, Long> builder = ImmutableMap.builder();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3c8618e94fae21f94d88006d26d5371c09d3b86e"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MTAwMjE5", "url": "https://github.com/pravega/pravega/pull/5329#pullrequestreview-534100219", "createdAt": "2020-11-19T05:52:24Z", "commit": {"oid": "3c8618e94fae21f94d88006d26d5371c09d3b86e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67600b9983d36bc9a4a039cb4fcaf164997f5a30", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/67600b9983d36bc9a4a039cb4fcaf164997f5a30", "committedDate": "2020-11-19T09:09:07Z", "message": "code review comments\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac2dd14d6c243fccd23dff1e8cf567d697876804", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/ac2dd14d6c243fccd23dff1e8cf567d697876804", "committedDate": "2020-11-19T09:32:57Z", "message": "code review changes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "366fd1b373e2ba64fa38050a94a72169d6d33dda", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/366fd1b373e2ba64fa38050a94a72169d6d33dda", "committedDate": "2020-11-19T09:36:36Z", "message": "checkstyle fixes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2755f98faabb4a497f16f1a540034dee419e4486", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/2755f98faabb4a497f16f1a540034dee419e4486", "committedDate": "2020-11-19T09:37:06Z", "message": "Merge remote-tracking branch 'upstream/master' into issue-5324-subscriber-generations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NDYwODk0", "url": "https://github.com/pravega/pravega/pull/5329#pullrequestreview-534460894", "createdAt": "2020-11-19T13:48:14Z", "commit": {"oid": "2755f98faabb4a497f16f1a540034dee419e4486"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3733, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}