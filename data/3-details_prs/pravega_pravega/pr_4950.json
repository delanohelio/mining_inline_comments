{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxMjEwMzE5", "number": 4950, "title": "Issue 4751: ListScopes, CheckStreamExists and CheckScopeExists", "bodyText": "Change log description\nImplementation for listScopes, CheckScopeExists and CheckStreamExists\nPurpose of the change\nFixes #4751\nWhat the code does\nAdds grpc implementation for listScopes which is a paginated call.\nAlso provides implementation for CheckScopeExists and CheckStreamExists.\nThere is not implementation for Zookeeper based store for listScopes\nHow to verify it\nUnit test updated", "createdAt": "2020-07-17T15:37:37Z", "url": "https://github.com/pravega/pravega/pull/4950", "merged": true, "mergeCommit": {"oid": "388a91d3235e8ef5b4e996c7da6f50d953460968"}, "closed": true, "closedAt": "2020-07-22T09:42:12Z", "author": {"login": "shiveshr"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1y0FsgH2gAyNDUxMjEwMzE5OmRjZTgyM2E5YWI4MzY3ZjVmOTU5NWRhMGJlYjQzOWQ1ZjVkNTJiZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3V-Q-AH2gAyNDUxMjEwMzE5OjAzNzkxOWVmN2FiMDQ3NjgzYzVlNWFiNTZjZWNjZGE0MTQxMjllZDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dce823a9ab8367f5f9595da0beb439d5f5d52bdd", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/dce823a9ab8367f5f9595da0beb439d5f5d52bdd", "committedDate": "2020-07-17T12:16:13Z", "message": "Implementation\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ca4c8560822743ce5217f297144963e4a054ca3", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/6ca4c8560822743ce5217f297144963e4a054ca3", "committedDate": "2020-07-17T13:43:56Z", "message": "unit test\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93339a95d0d095851b81fe50e49c04bac09173dc", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/93339a95d0d095851b81fe50e49c04bac09173dc", "committedDate": "2020-07-17T13:51:33Z", "message": "merging with master\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5306bfb7f97753df7e0ec46b2f9aa230eb260234", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/5306bfb7f97753df7e0ec46b2f9aa230eb260234", "committedDate": "2020-07-17T15:11:43Z", "message": "Merge with master\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb62dbf7275bb70cf9d71ef06b2e4a33dcab2144", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/eb62dbf7275bb70cf9d71ef06b2e4a33dcab2144", "committedDate": "2020-07-17T15:30:58Z", "message": "Unit tests\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aee3d78651a5d13535e9feb6428f486f892edb75", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/aee3d78651a5d13535e9feb6428f486f892edb75", "committedDate": "2020-07-17T16:32:23Z", "message": "test fix\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e44b329f027cce0f8711c46c44e689c3a4cd023c", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/e44b329f027cce0f8711c46c44e689c3a4cd023c", "committedDate": "2020-07-18T01:39:03Z", "message": "unit test for local cotroller\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7147c43c8c74f4b13447fe486b37809003e99035", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/7147c43c8c74f4b13447fe486b37809003e99035", "committedDate": "2020-07-20T03:34:47Z", "message": "checkstyle\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "325239deea684d9614d690a1b3cfeeaeb50b2822", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/325239deea684d9614d690a1b3cfeeaeb50b2822", "committedDate": "2020-07-20T03:35:24Z", "message": "Merge branch 'master' into issue4751"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNjY2MDY0", "url": "https://github.com/pravega/pravega/pull/4950#pullrequestreview-451666064", "createdAt": "2020-07-20T14:34:40Z", "commit": {"oid": "325239deea684d9614d690a1b3cfeeaeb50b2822"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDozNDo0MFrOG0QKDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDozOTo1MFrOG0Qdww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ0Mzg1Mw==", "bodyText": "asyncIterator.asIterator() will do the same, but you won't need to explicitly use BlockingAsyncIterator. This will help in case we want to change the implementation later.", "url": "https://github.com/pravega/pravega/pull/4950#discussion_r457443853", "createdAt": "2020-07-20T14:34:40Z", "author": {"login": "andreipaduroiu"}, "path": "client/src/main/java/io/pravega/client/admin/impl/StreamManagerImpl.java", "diffHunk": "@@ -107,13 +107,26 @@ public boolean deleteStream(String scopeName, String streamName) {\n         return  Futures.getThrowingException(controller.deleteStream(scopeName, streamName));\n     }\n \n+    @Override\n+    public Iterator<String> listScopes() {\n+        log.info(\"Listing scopes\");\n+        AsyncIterator<String> asyncIterator = controller.listScopes();\n+        return new BlockingAsyncIterator<>(asyncIterator);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "325239deea684d9614d690a1b3cfeeaeb50b2822"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ0NzM1Mw==", "bodyText": "Why not use asyncIterator.asIterator?\nYour implementation below is incorrect. Both hasNext and next will invoke load which will cause the wrapped iterator to advance. This means you will be skipping over iterator items as you iterate through. Also next is supposed to throw if hasNext() == false", "url": "https://github.com/pravega/pravega/pull/4950#discussion_r457447353", "createdAt": "2020-07-20T14:38:14Z", "author": {"login": "andreipaduroiu"}, "path": "client/src/test/java/io/pravega/client/stream/mock/MockStreamManager.java", "diffHunk": "@@ -181,6 +193,30 @@ public boolean deleteStream(String scopeName, String toDelete) {\n         return Futures.getAndHandleExceptions(controller.deleteStream(scopeName, toDelete), RuntimeException::new);\n     }\n \n+    @Override\n+    public Iterator<String> listScopes() {\n+        AsyncIterator<String> asyncIterator = controller.listScopes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "325239deea684d9614d690a1b3cfeeaeb50b2822"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ0ODU1MQ==", "bodyText": "use Futures.exceptionallyExpecting to make this a one-liner.", "url": "https://github.com/pravega/pravega/pull/4950#discussion_r457448551", "createdAt": "2020-07-20T14:39:30Z", "author": {"login": "andreipaduroiu"}, "path": "controller/src/main/java/io/pravega/controller/server/eventProcessor/LocalController.java", "diffHunk": "@@ -68,6 +70,45 @@ public LocalController(ControllerService controller, boolean authorizationEnable\n         this.authorizationEnabled = authorizationEnabled;\n     }\n \n+    @Override\n+    public CompletableFuture<Boolean> checkScopeExists(String scopeName) {\n+        return this.controller.getScope(scopeName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "325239deea684d9614d690a1b3cfeeaeb50b2822"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ0ODg5OQ==", "bodyText": "Futures.exceptionallyExpecting", "url": "https://github.com/pravega/pravega/pull/4950#discussion_r457448899", "createdAt": "2020-07-20T14:39:50Z", "author": {"login": "andreipaduroiu"}, "path": "controller/src/main/java/io/pravega/controller/server/eventProcessor/LocalController.java", "diffHunk": "@@ -68,6 +70,45 @@ public LocalController(ControllerService controller, boolean authorizationEnable\n         this.authorizationEnabled = authorizationEnabled;\n     }\n \n+    @Override\n+    public CompletableFuture<Boolean> checkScopeExists(String scopeName) {\n+        return this.controller.getScope(scopeName)\n+                              .handle((r, e) -> {\n+                                  if (e != null) {\n+                                      if (Exceptions.unwrap(e) instanceof StoreException.DataNotFoundException) {\n+                                          return false;\n+                                      } else {\n+                                          throw new CompletionException(e);\n+                                      }\n+                                  }\n+                                  return true;\n+                              });\n+    }\n+\n+    @Override\n+    public AsyncIterator<String> listScopes() {\n+        final Function<String, CompletableFuture<Map.Entry<String, Collection<String>>>> function = token ->\n+                controller.listScopes(token, PAGE_LIMIT)\n+                          .thenApply(result -> new AbstractMap.SimpleEntry<>(result.getValue(), result.getKey()));\n+\n+        return new ContinuationTokenAsyncIterator<>(function, \"\");\n+    }\n+\n+    @Override\n+    public CompletableFuture<Boolean> checkStreamExists(String scopeName, String streamName) {\n+        return this.controller.getStream(scopeName, streamName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "325239deea684d9614d690a1b3cfeeaeb50b2822"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "286402c01e959a479bb995ed28f308ed153e04a6", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/286402c01e959a479bb995ed28f308ed153e04a6", "committedDate": "2020-07-21T01:32:30Z", "message": "PR comment\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c16f248428c7c105980ecc391f1bd801ed693f3f", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/c16f248428c7c105980ecc391f1bd801ed693f3f", "committedDate": "2020-07-21T01:32:53Z", "message": "Merge branch 'issue4751' of https://github.com/shiveshr/pravega-1 into issue4751"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNTI4NDkw", "url": "https://github.com/pravega/pravega/pull/4950#pullrequestreview-452528490", "createdAt": "2020-07-21T14:41:32Z", "commit": {"oid": "c16f248428c7c105980ecc391f1bd801ed693f3f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7723021acab9980f35f2d474b89e7261972596c", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/f7723021acab9980f35f2d474b89e7261972596c", "committedDate": "2020-07-21T14:41:39Z", "message": "Merge branch 'master' into issue4751"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMDA2ODE2", "url": "https://github.com/pravega/pravega/pull/4950#pullrequestreview-453006816", "createdAt": "2020-07-22T05:35:49Z", "commit": {"oid": "f7723021acab9980f35f2d474b89e7261972596c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNTozNTo0OVrOG1TYBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwNjowOTo1OFrOG1UDLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU0NTE1Ng==", "bodyText": "should be scope", "url": "https://github.com/pravega/pravega/pull/4950#discussion_r458545156", "createdAt": "2020-07-22T05:35:49Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/StreamMetadataStore.java", "diffHunk": "@@ -217,6 +217,18 @@\n      */\n     CompletableFuture<List<String>> listScopes();\n \n+    /**\n+     * List scopes with pagination. This api continues listing scopes from the supplied continuation token\n+     * and returns a count limited list of scopes and a new continuation token.\n+     *\n+     * @param continuationToken continuation token\n+     * @param limit limit on number of streams to return.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7723021acab9980f35f2d474b89e7261972596c"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU0NTQ3Mw==", "bodyText": "same here...", "url": "https://github.com/pravega/pravega/pull/4950#discussion_r458545473", "createdAt": "2020-07-22T05:36:49Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/StreamMetadataStore.java", "diffHunk": "@@ -217,6 +217,18 @@\n      */\n     CompletableFuture<List<String>> listScopes();\n \n+    /**\n+     * List scopes with pagination. This api continues listing scopes from the supplied continuation token\n+     * and returns a count limited list of scopes and a new continuation token.\n+     *\n+     * @param continuationToken continuation token\n+     * @param limit limit on number of streams to return.\n+     * @param executor executor\n+     * @return A pair of list of streams in scope with the continuation token. ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7723021acab9980f35f2d474b89e7261972596c"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU1NjIwNw==", "bodyText": "Can the auth filter out some scopes, causing us to return less number of scopes than limit?", "url": "https://github.com/pravega/pravega/pull/4950#discussion_r458556207", "createdAt": "2020-07-22T06:09:58Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/server/rpc/grpc/v1/ControllerServiceImpl.java", "diffHunk": "@@ -532,6 +532,126 @@ public void createScope(ScopeInfo request, StreamObserver<CreateScopeStatus> res\n                 responseObserver, requestTag);\n     }\n \n+    @Override\n+    public void listScopes(Controller.ScopesRequest request, StreamObserver<Controller.ScopesResponse> responseObserver) {\n+        RequestTag requestTag = requestTracker.initializeAndTrackRequestTag(requestIdGenerator.get(),\n+                \"listScopes\");\n+        log.info(requestTag.getRequestId(), \"listScope called.\");\n+\n+        final AuthContext ctx;\n+        if (this.grpcAuthHelper.isAuthEnabled()) {\n+            ctx = AuthContext.current();\n+        } else {\n+            ctx = null;\n+        }\n+\n+        Supplier<String> stringSupplier = () -> {\n+            String result = this.grpcAuthHelper.checkAuthorization(\n+                    AuthResourceRepresentation.ofScopes(),\n+                    AuthHandler.Permissions.READ,\n+                    ctx);\n+            log.debug(\"Result of authorization for [{}] and READ permission is: [{}]\",\n+                    AuthResourceRepresentation.ofScopes(), result);\n+            return result;\n+        };\n+        Function<String, CompletableFuture<Controller.ScopesResponse>> scopesFn = delegationToken -> controllerService\n+                .listScopes(request.getContinuationToken().getToken(), pageLimit)\n+                .thenApply(response -> {\n+                    log.debug(\"All scopes in scope with continuation token: {}\", response);\n+                    return Controller.ScopesResponse\n+                            .newBuilder().addAllScopes(response.getKey())\n+                            .setContinuationToken(Controller.ContinuationToken.newBuilder()\n+                                                                              .setToken(response.getValue()).build())\n+                            .build();\n+                });\n+        authenticateExecuteAndProcessResults(stringSupplier, scopesFn, responseObserver, requestTag);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7723021acab9980f35f2d474b89e7261972596c"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f041f05d847cf0988de47309ed4dcaa050f54ae4", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/f041f05d847cf0988de47309ed4dcaa050f54ae4", "committedDate": "2020-07-22T06:25:52Z", "message": "PR comments\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d423f4efd1a8cc5f4bcf16cce0051377bbe9093", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/0d423f4efd1a8cc5f4bcf16cce0051377bbe9093", "committedDate": "2020-07-22T06:26:17Z", "message": "Merge branch 'issue4751' of https://github.com/shiveshr/pravega-1 into issue4751"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMDMwMTMz", "url": "https://github.com/pravega/pravega/pull/4950#pullrequestreview-453030133", "createdAt": "2020-07-22T06:33:25Z", "commit": {"oid": "0d423f4efd1a8cc5f4bcf16cce0051377bbe9093"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "037919ef7ab047683c5e5ab56ceccda414129ed6", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/037919ef7ab047683c5e5ab56ceccda414129ed6", "committedDate": "2020-07-22T07:47:56Z", "message": "filter scopes\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3961, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}