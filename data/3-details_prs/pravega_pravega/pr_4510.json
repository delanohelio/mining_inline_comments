{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2MDIwODUz", "number": 4510, "title": "Issue 4505: Add missing metrics for ExtendedS3Storage", "bodyText": "Currently ExtendedS3Storage class does not publish any storage related metrics.\nThis change adds missing metrics for ExtendedS3.\nSigned-off-by: Sachin Joshi sachin.joshi@emc.com\nChange log description\nCurrently ExtendedS3Storage class does not publish any storage related metrics.\nThis change adds missing metrics for ExtendedS3.\nPurpose of the change\nFixes #4505\nWhat the code does\nThis change adds missing metrics for ExtendedS3.\nHow to verify it\nAll tests should pass. Manual verification of metrics reported.", "createdAt": "2020-01-22T19:20:01Z", "url": "https://github.com/pravega/pravega/pull/4510", "merged": true, "mergeCommit": {"oid": "400c1aa9910b695cc62dfa2897c4ea8f85be79d8"}, "closed": true, "closedAt": "2020-01-23T15:55:09Z", "author": {"login": "sachin-j-joshi"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb86t-pAH2gAyMzY2MDIwODUzOmZmNTlmNDM1NjY1ZDg3MGQyNGFhYjNjNjkyMzdlNTliY2ZmYzExNjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9MbR5AFqTM0NzQwNzA5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ff59f435665d870d24aab3c69237e59bcffc1166", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/ff59f435665d870d24aab3c69237e59bcffc1166", "committedDate": "2020-01-22T19:15:06Z", "message": "Issue 4505: Add missing metrics ExtendedS3.\n\nCurrently ExtendedS3Storage class does not publish any storage related metrics.\nThis change adds missing metrics for ExtendedS3.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODQ0MzI2", "url": "https://github.com/pravega/pravega/pull/4510#pullrequestreview-346844326", "createdAt": "2020-01-22T19:28:33Z", "commit": {"oid": "ff59f435665d870d24aab3c69237e59bcffc1166"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyODozM1rOFgoQQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxOToyOTo1M1rOFgoS4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODI3Mg==", "bodyText": "elapsed.toMillis. Otherwise this will print out some weird string.\nExtra space between \"Read\" and \"segment\"", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369758272", "createdAt": "2020-01-22T19:28:33Z", "author": {"login": "andreipaduroiu"}, "path": "bindings/src/main/java/io/pravega/storage/extendeds3/ExtendedS3Storage.java", "diffHunk": "@@ -228,6 +231,13 @@ private int doRead(SegmentHandle handle, long offset, byte[] buffer, int bufferO\n \n             int bytesRead = StreamHelpers.readAll(reader, buffer, bufferOffset, length);\n \n+            Duration elapsed = timer.getElapsed();\n+\n+            ExtendedS3Metrics.READ_LATENCY.reportSuccessEvent(elapsed);\n+            ExtendedS3Metrics.READ_BYTES.add(length);\n+\n+            log.debug(\"Read  segment={} offset={} bytesWritten={} latency={}.\", handle.getSegmentName(), offset, length, elapsed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff59f435665d870d24aab3c69237e59bcffc1166"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODUxMQ==", "bodyText": "here too\nPlus you are missing an arg for the segment.", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369758511", "createdAt": "2020-01-22T19:29:00Z", "author": {"login": "andreipaduroiu"}, "path": "bindings/src/main/java/io/pravega/storage/extendeds3/ExtendedS3Storage.java", "diffHunk": "@@ -310,13 +322,20 @@ private SegmentHandle doCreate(String streamSegmentName) throws StreamSegmentExi\n         }\n         client.putObject(request);\n \n+        Duration elapsed = timer.getElapsed();\n+\n+        ExtendedS3Metrics.CREATE_LATENCY.reportSuccessEvent(elapsed);\n+        ExtendedS3Metrics.CREATE_COUNT.inc();\n+\n+        log.debug(\"Create  segment={} latency={}.\", elapsed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff59f435665d870d24aab3c69237e59bcffc1166"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODYxOA==", "bodyText": "and here", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369758618", "createdAt": "2020-01-22T19:29:14Z", "author": {"login": "andreipaduroiu"}, "path": "bindings/src/main/java/io/pravega/storage/extendeds3/ExtendedS3Storage.java", "diffHunk": "@@ -331,6 +350,14 @@ private Void doWrite(SegmentHandle handle, long offset, InputStream data, int le\n \n         client.putObject(this.config.getBucket(), this.config.getRoot() + handle.getSegmentName(),\n                 Range.fromOffsetLength(offset, length), data);\n+\n+        Duration elapsed = timer.getElapsed();\n+\n+        ExtendedS3Metrics.WRITE_LATENCY.reportSuccessEvent(elapsed);\n+        ExtendedS3Metrics.WRITE_BYTES.add(length);\n+\n+        log.debug(\"Write  segment={} offset={} bytesWritten={} latency={}.\", handle.getSegmentName(), offset, length, elapsed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff59f435665d870d24aab3c69237e59bcffc1166"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODY5Mg==", "bodyText": "here too", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369758692", "createdAt": "2020-01-22T19:29:23Z", "author": {"login": "andreipaduroiu"}, "path": "bindings/src/main/java/io/pravega/storage/extendeds3/ExtendedS3Storage.java", "diffHunk": "@@ -416,13 +443,31 @@ private Void doConcat(SegmentHandle targetHandle, long offset, String sourceSegm\n                 targetPath, uploadId).withParts(partEtags));\n \n         client.deleteObject(config.getBucket(), config.getRoot() + sourceSegment);\n+        Duration elapsed = timer.getElapsed();\n+\n+        log.debug(\"Concat  target={} source={} offset={} bytesWritten={} latency={}.\", targetHandle.getSegmentName(), sourceSegment, offset, si.getLength(), elapsed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff59f435665d870d24aab3c69237e59bcffc1166"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTc1ODk0Nw==", "bodyText": "here too\n\nadd segment name.", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369758947", "createdAt": "2020-01-22T19:29:53Z", "author": {"login": "andreipaduroiu"}, "path": "bindings/src/main/java/io/pravega/storage/extendeds3/ExtendedS3Storage.java", "diffHunk": "@@ -416,13 +443,31 @@ private Void doConcat(SegmentHandle targetHandle, long offset, String sourceSegm\n                 targetPath, uploadId).withParts(partEtags));\n \n         client.deleteObject(config.getBucket(), config.getRoot() + sourceSegment);\n+        Duration elapsed = timer.getElapsed();\n+\n+        log.debug(\"Concat  target={} source={} offset={} bytesWritten={} latency={}.\", targetHandle.getSegmentName(), sourceSegment, offset, si.getLength(), elapsed);\n+\n+        ExtendedS3Metrics.CONCAT_LATENCY.reportSuccessEvent(elapsed);\n+        ExtendedS3Metrics.CONCAT_BYTES.add(si.getLength());\n+        ExtendedS3Metrics.CONCAT_COUNT.inc();\n+\n         LoggerHelpers.traceLeave(log, \"concat\", traceId);\n \n         return null;\n     }\n \n     private Void doDelete(SegmentHandle handle) {\n+        long traceId = LoggerHelpers.traceEnter(log, \"delete\", handle.getSegmentName());\n+        Timer timer = new Timer();\n         client.deleteObject(config.getBucket(), config.getRoot() + handle.getSegmentName());\n+        Duration elapsed = timer.getElapsed();\n+\n+        ExtendedS3Metrics.DELETE_LATENCY.reportSuccessEvent(elapsed);\n+        ExtendedS3Metrics.DELETE_COUNT.inc();\n+\n+        log.debug(\"Delete  segment={} latency={}.\", elapsed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff59f435665d870d24aab3c69237e59bcffc1166"}, "originalPosition": 119}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2ODQ5Mjg1", "url": "https://github.com/pravega/pravega/pull/4510#pullrequestreview-346849285", "createdAt": "2020-01-22T19:36:26Z", "commit": {"oid": "ff59f435665d870d24aab3c69237e59bcffc1166"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2eaa3b70efbaf8fe4f409d24c17b1dd1c3e475c", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/b2eaa3b70efbaf8fe4f409d24c17b1dd1c3e475c", "committedDate": "2020-01-22T19:39:39Z", "message": "Issue 4505: Address review comments.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2OTQzMTQ1", "url": "https://github.com/pravega/pravega/pull/4510#pullrequestreview-346943145", "createdAt": "2020-01-22T22:17:40Z", "commit": {"oid": "b2eaa3b70efbaf8fe4f409d24c17b1dd1c3e475c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2OTg0MjEy", "url": "https://github.com/pravega/pravega/pull/4510#pullrequestreview-346984212", "createdAt": "2020-01-22T23:53:05Z", "commit": {"oid": "b2eaa3b70efbaf8fe4f409d24c17b1dd1c3e475c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMzo1MzowNlrOFgvAjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQyMzo1MzowNlrOFgvAjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTg2ODk0MQ==", "bodyText": "Pleas do not name this ECS? This is for \"Extended S3\"", "url": "https://github.com/pravega/pravega/pull/4510#discussion_r369868941", "createdAt": "2020-01-22T23:53:06Z", "author": {"login": "andreipaduroiu"}, "path": "bindings/src/main/java/io/pravega/storage/extendeds3/ExtendedS3Metrics.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.storage.extendeds3;\n+\n+import io.pravega.shared.MetricsNames;\n+import io.pravega.shared.metrics.Counter;\n+import io.pravega.shared.metrics.MetricsProvider;\n+import io.pravega.shared.metrics.OpStatsLogger;\n+import io.pravega.shared.metrics.StatsLogger;\n+\n+/**\n+ * Defines all Metrics used by the ExtendedS3Storage class.\n+ */\n+final class ExtendedS3Metrics {\n+    private static final StatsLogger ECS_LOGGER = MetricsProvider.createStatsLogger(\"ecs\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2eaa3b70efbaf8fe4f409d24c17b1dd1c3e475c"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fbbb66f39d744f4e0669a9769c95a67f2ed3f22", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/7fbbb66f39d744f4e0669a9769c95a67f2ed3f22", "committedDate": "2020-01-23T00:22:29Z", "message": "Issue 4505: Add unit test for Extended S3 metrics.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5260ed5ee485413523d855adcb0b0dc1555b3ea3", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/5260ed5ee485413523d855adcb0b0dc1555b3ea3", "committedDate": "2020-01-23T00:26:44Z", "message": "Issue 4505: Use name ExtendedS3 for stats logger.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09dab3a51fb9dba750d6b00dd6a9f152baf68159", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/09dab3a51fb9dba750d6b00dd6a9f152baf68159", "committedDate": "2020-01-23T00:39:39Z", "message": "Issue 4505: Use name ExtendedS3 for stats logger.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8eb4b31906d3560ae0bae8a7be1c97e3007911d", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/c8eb4b31906d3560ae0bae8a7be1c97e3007911d", "committedDate": "2020-01-23T08:29:54Z", "message": "Merge branch 'master' into issue-4505-ExtendedS3-add-missing-metrics"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MTI0NTEw", "url": "https://github.com/pravega/pravega/pull/4510#pullrequestreview-347124510", "createdAt": "2020-01-23T08:30:57Z", "commit": {"oid": "c8eb4b31906d3560ae0bae8a7be1c97e3007911d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NDA3MDk2", "url": "https://github.com/pravega/pravega/pull/4510#pullrequestreview-347407096", "createdAt": "2020-01-23T15:52:58Z", "commit": {"oid": "c8eb4b31906d3560ae0bae8a7be1c97e3007911d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3559, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}