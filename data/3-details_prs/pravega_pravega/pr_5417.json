{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1NzI5MDUw", "number": 5417, "title": "Issue 5416: Transaction commit order should take 'limit' elements from ordered list", "bodyText": "Signed-off-by: Shivesh Ranjan shivesh.ranjan@gmail.com\nChange log description\nFixes transaction commit order regression introduced by #5197 where we took first n elements from an unsorted list whereby breaking the order.\nPurpose of the change\nFixes #5416\nWhat the code does\nThere were two regressions introduced by 5197.\n\nWe took the \"limit\" number of elements from an unordered list which could break the order.\nin subsequent iterations of the loop (if some elements were filtered out), we were reading from wrong index in the loop.\n\nHow to verify it\nUnit test added", "createdAt": "2020-12-10T07:36:13Z", "url": "https://github.com/pravega/pravega/pull/5417", "merged": true, "mergeCommit": {"oid": "d221d6bc8c9dbc489ef35b71ce35bf52e9ad5ac7"}, "closed": true, "closedAt": "2020-12-14T05:49:08Z", "author": {"login": "shiveshr"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkuZ-lgH2gAyNTM1NzI5MDUwOmYyYmNmYmY4NWYzMjliOGYxZmY0NDU5NzBlMzAwN2YwOGNhZDNiNmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlLZsNgH2gAyNTM1NzI5MDUwOmI5YjRhZDg3Mzc2ZGU2NTkyZDgzZDRhN2YwYjE5YzUwODIzZGMzN2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f2bcfbf85f329b8f1ff445970e3007f08cad3b6f", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/f2bcfbf85f329b8f1ff445970e3007f08cad3b6f", "committedDate": "2020-12-10T07:42:31Z", "message": "Issue 5416: Transaction Order fix\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7ce4b029349621ac4cab6918f7d8b0842edef1c6", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/7ce4b029349621ac4cab6918f7d8b0842edef1c6", "committedDate": "2020-12-10T07:33:02Z", "message": "Issue 5416: Transaction commit order regression\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}, "afterCommit": {"oid": "f2bcfbf85f329b8f1ff445970e3007f08cad3b6f", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/f2bcfbf85f329b8f1ff445970e3007f08cad3b6f", "committedDate": "2020-12-10T07:42:31Z", "message": "Issue 5416: Transaction Order fix\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4OTYzMDQ3", "url": "https://github.com/pravega/pravega/pull/5417#pullrequestreview-548963047", "createdAt": "2020-12-10T08:43:08Z", "commit": {"oid": "f2bcfbf85f329b8f1ff445970e3007f08cad3b6f"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwODo0MzowOFrOIC9pyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwODo1MjowMVrOIC-AlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk3ODE4Ng==", "bodyText": "wow, good catch \ud83d\udc4d", "url": "https://github.com/pravega/pravega/pull/5417#discussion_r539978186", "createdAt": "2020-12-10T08:43:08Z", "author": {"login": "shrids"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/PersistentStreamBase.java", "diffHunk": "@@ -1931,8 +1931,9 @@ boolean compareWriterPositions(Map<Long, Long> position1, Map<Long, Long> positi\n                 () -> getTransactionRecords(epoch, txnIds.subList(from.get(), till.get())).thenAccept(txns -> {\n             for (int i = 0; i < txns.size(); i++) {\n                 ActiveTxnRecord txnRecord = txns.get(i);\n-                UUID txnId = UUID.fromString(txnIds.get(i));\n-                long order = orders.get(i);\n+                int index = from.get() + i;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2bcfbf85f329b8f1ff445970e3007f08cad3b6f"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk4Mjg0Nw==", "bodyText": "missing parameter in line :1960", "url": "https://github.com/pravega/pravega/pull/5417#discussion_r539982847", "createdAt": "2020-12-10T08:50:18Z", "author": {"login": "shrids"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/PersistentStreamBase.java", "diffHunk": "@@ -1931,8 +1931,9 @@ boolean compareWriterPositions(Map<Long, Long> position1, Map<Long, Long> positi\n                 () -> getTransactionRecords(epoch, txnIds.subList(from.get(), till.get())).thenAccept(txns -> {\n             for (int i = 0; i < txns.size(); i++) {\n                 ActiveTxnRecord txnRecord = txns.get(i);\n-                UUID txnId = UUID.fromString(txnIds.get(i));\n-                long order = orders.get(i);\n+                int index = from.get() + i;\n+                UUID txnId = UUID.fromString(txnIds.get(index));\n+                long order = orders.get(index);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2bcfbf85f329b8f1ff445970e3007f08cad3b6f"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk4NDAyMQ==", "bodyText": "when will txnRecord.commitOrder be different from orders.get(index)?", "url": "https://github.com/pravega/pravega/pull/5417#discussion_r539984021", "createdAt": "2020-12-10T08:52:01Z", "author": {"login": "shrids"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/PersistentStreamBase.java", "diffHunk": "@@ -1931,8 +1931,9 @@ boolean compareWriterPositions(Map<Long, Long> position1, Map<Long, Long> positi\n                 () -> getTransactionRecords(epoch, txnIds.subList(from.get(), till.get())).thenAccept(txns -> {\n             for (int i = 0; i < txns.size(); i++) {\n                 ActiveTxnRecord txnRecord = txns.get(i);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2bcfbf85f329b8f1ff445970e3007f08cad3b6f"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64d95b02ce46d31d531dde8f2c47dd27c65a8e62", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/64d95b02ce46d31d531dde8f2c47dd27c65a8e62", "committedDate": "2020-12-10T09:16:57Z", "message": "PR comment\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f848912bed435b7d0d3d958a5bd15d41a7ea88cd", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/f848912bed435b7d0d3d958a5bd15d41a7ea88cd", "committedDate": "2020-12-10T15:55:17Z", "message": "Merge branch 'master' into issue5416"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b0e37e24dd4c65705892be5f4189f576d150156", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/7b0e37e24dd4c65705892be5f4189f576d150156", "committedDate": "2020-12-11T02:17:52Z", "message": "Merge branch 'master' into issue5416"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9b4ad87376de6592d83d4a7f0b19c50823dc37b", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/b9b4ad87376de6592d83d4a7f0b19c50823dc37b", "committedDate": "2020-12-11T17:29:27Z", "message": "Merge branch 'master' into issue5416"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3793, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}