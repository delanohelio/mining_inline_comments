{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4MzgyNDEz", "number": 4990, "title": "Issue 4989: Add integration and system test for size based retention policy", "bodyText": "Signed-off-by: Shivesh Ranjan shivesh.ranjan@gmail.com\nChange log description\nAdds system and integration tests for size based retention policy\nPurpose of the change\nFixes #4989\nWhat the code does\nMakes retention frequency part of ControllerServiceConfig instead of the static value in Config.java. This allows integration tests to set much smaller value than the default of 30 minutes.\nAdds new integration and system test which test size and time based retentions.\nHow to verify it\nAll tests should pass", "createdAt": "2020-07-29T11:39:01Z", "url": "https://github.com/pravega/pravega/pull/4990", "merged": true, "mergeCommit": {"oid": "4df7f9a4d8be09229b9648d0ee86f16dccecd16b"}, "closed": true, "closedAt": "2020-07-30T07:36:06Z", "author": {"login": "shiveshr"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5pXqRgH2gAyNDU4MzgyNDEzOjU3NDc0MWI2YTlhNGRkYjM1YjM4MmU5MjgwNmFiNjgwZjE0MzQ3Y2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5st0VAH2gAyNDU4MzgyNDEzOjg5ZGMxMzJjODcxOTZiNWUxYWM2NWMwYjhjNzdiYjhhZGIwMDg1ODI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "574741b6a9a4ddb35b382e92806ab680f14347cd", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/574741b6a9a4ddb35b382e92806ab680f14347cd", "committedDate": "2020-07-29T11:31:43Z", "message": "integration and system test\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NDUwMzYw", "url": "https://github.com/pravega/pravega/pull/4990#pullrequestreview-457450360", "createdAt": "2020-07-29T11:58:40Z", "commit": {"oid": "574741b6a9a4ddb35b382e92806ab680f14347cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMTo1ODo0MFrOG41IWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMTo1ODo0MFrOG41IWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI0MzkyOA==", "bodyText": "Why this change?", "url": "https://github.com/pravega/pravega/pull/4990#discussion_r462243928", "createdAt": "2020-07-29T11:58:40Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/server/ControllerServiceStarter.java", "diffHunk": "@@ -240,12 +240,13 @@ protected void startUp() {\n             streamStore = streamMetadataStoreRef.orElse(StreamStoreFactory.createStore(storeClient, segmentHelper, authHelper, controllerExecutor));\n \n             streamMetadataTasks = new StreamMetadataTasks(streamStore, bucketStore, taskMetadataStore,\n-                    segmentHelper, controllerExecutor, eventExecutor, host.getHostId(), authHelper, requestTracker);\n+                    segmentHelper, controllerExecutor, eventExecutor, host.getHostId(), authHelper, requestTracker, \n+                    serviceConfig.getRetentionFrequency().toMillis());\n             streamTransactionMetadataTasks = new StreamTransactionMetadataTasks(streamStore,\n                     segmentHelper, controllerExecutor, eventExecutor, host.getHostId(), serviceConfig.getTimeoutServiceConfig(), authHelper);\n \n             BucketServiceFactory bucketServiceFactory = new BucketServiceFactory(host.getHostId(), bucketStore, 1000);\n-            Duration executionDurationRetention = Duration.ofMinutes(Config.MINIMUM_RETENTION_FREQUENCY_IN_MINUTES);\n+            Duration executionDurationRetention = serviceConfig.getRetentionFrequency();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "574741b6a9a4ddb35b382e92806ab680f14347cd"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NDcwODI0", "url": "https://github.com/pravega/pravega/pull/4990#pullrequestreview-457470824", "createdAt": "2020-07-29T12:28:20Z", "commit": {"oid": "574741b6a9a4ddb35b382e92806ab680f14347cd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMjoyODoyMVrOG42Gtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxMjoyODoyMVrOG42Gtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjI1OTg5NA==", "bodyText": "May be good to call this method retentionTestSizeAndTime()", "url": "https://github.com/pravega/pravega/pull/4990#discussion_r462259894", "createdAt": "2020-07-29T12:28:21Z", "author": {"login": "pbelgundi"}, "path": "test/system/src/test/java/io/pravega/test/system/RetentionTest.java", "diffHunk": "@@ -98,44 +106,60 @@ public void tearDown() {\n \n     @Test\n     public void retentionTest() throws Exception {\n-        final ClientConfig clientConfig = Utils.buildClientConfig(controllerURI);\n-        @Cleanup\n-        ConnectionFactory connectionFactory = new SocketConnectionFactoryImpl(clientConfig);\n-        ControllerImpl controller = new ControllerImpl(ControllerImplConfig.builder().clientConfig(clientConfig).build(),\n-                                                       connectionFactory.getInternalExecutor());\n-        @Cleanup\n-        ClientFactoryImpl clientFactory = new ClientFactoryImpl(SCOPE, controller, connectionFactory);\n-        log.info(\"Invoking Writer test with Controller URI: {}\", controllerURI);\n-\n-        //create a writer\n-        @Cleanup\n-        EventStreamWriter<Serializable> writer = clientFactory.createEventWriter(STREAM,\n-                new JavaSerializer<>(),\n-                EventWriterConfig.builder().build());\n-\n-        //write an event\n-        String writeEvent = \"event\";\n-        writer.writeEvent(writeEvent);\n-        writer.flush();\n-        log.debug(\"Writing event: {} \", writeEvent);\n-\n-        //sleep for 5 mins\n-        Exceptions.handleInterrupted(() -> Thread.sleep(5 * 60 * 1000));\n-\n-        //create a reader\n-        ReaderGroupManager groupManager = ReaderGroupManager.withScope(SCOPE, clientConfig);\n-        groupManager.createReaderGroup(READER_GROUP, ReaderGroupConfig.builder().disableAutomaticCheckpoints().stream(Stream.of(SCOPE, STREAM)).build());\n-        EventStreamReader<String> reader = clientFactory.createReader(UUID.randomUUID().toString(),\n-                READER_GROUP,\n-                new JavaSerializer<>(),\n-                ReaderConfig.builder().build());\n-\n-        //verify reader functionality is unaffected post truncation\n-        String event = \"newEvent\";\n-        writer.writeEvent(event);\n-        log.info(\"Writing event: {}\", event);\n-        Assert.assertEquals(event, reader.readNextEvent(6000).getEvent());\n-\n-        log.debug(\"The stream is already truncated.Simple retention test passed.\");\n+        CompletableFuture.allOf(retentionTestTime(STREAM_TIME, false), retentionTestTime(STREAM_SIZE, true));\n+    }\n+    \n+    private CompletableFuture<Void> retentionTestTime(String streamName, boolean sizeBased) throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "574741b6a9a4ddb35b382e92806ab680f14347cd"}, "originalPosition": 96}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NDcxMDYy", "url": "https://github.com/pravega/pravega/pull/4990#pullrequestreview-457471062", "createdAt": "2020-07-29T12:28:38Z", "commit": {"oid": "574741b6a9a4ddb35b382e92806ab680f14347cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4af8cdf1e912d545922db9f0544bba78df525298", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/4af8cdf1e912d545922db9f0544bba78df525298", "committedDate": "2020-07-29T13:33:33Z", "message": "retention system test - use different readergroup names for the two streams\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8ede295db0694ea16a98a8a9688f9ebd7d7bc53", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/a8ede295db0694ea16a98a8a9688f9ebd7d7bc53", "committedDate": "2020-07-29T14:43:03Z", "message": "revert main.java\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89dc132c87196b5e1ac65c0b8c77bb8adb008582", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/89dc132c87196b5e1ac65c0b8c77bb8adb008582", "committedDate": "2020-07-29T15:25:38Z", "message": "Merge branch 'master' into retentiontest"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3992, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}