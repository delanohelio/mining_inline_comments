{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NTQ0Mjgx", "number": 4848, "title": "Issue 4847: Improve sealed stream handling of EventStreamWriter and ByteStreamWriter.", "bodyText": "Change log description\nImprove sealed stream handling for EventStreamWriter and ByteStreamWriter.\nPurpose of the change\nFixes #4847\nWhat the code does\n\nEnsure EventStreamWriter does not attempt to send inflight events if the Controller returns an empty successor segments since the stream is sealed.\nEnsure writes via EventStreamWriter on a sealed stream throws an exception.\nEnsure the creating a ByteStreamWriter and EventStreamWriter on a sealed stream throws an exception.\n\nHow to verify it\nAll the existing and newly added tests should pass", "createdAt": "2020-06-05T15:53:44Z", "url": "https://github.com/pravega/pravega/pull/4848", "merged": true, "mergeCommit": {"oid": "33a3ae7dfc9a3deee052473137b1c03a9c6a1aad"}, "closed": true, "closedAt": "2020-06-08T14:46:39Z", "author": {"login": "shrids"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoSLGUAH2gAyNDI4NTQ0MjgxOmNlOGNiMjIwODE2MDJkYzljMzQ1MjExZWMzMzIzMDUzNDhmZDE3MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpRlcsAFqTQyNjMxNjMxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ce8cb22081602dc9c345211ec332305348fd1701", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/ce8cb22081602dc9c345211ec332305348fd1701", "committedDate": "2020-06-05T12:53:28Z", "message": "Fix Stream Writer.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c79aadbe19f5c25456ace2e2a76a4d0f71fb82a", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/5c79aadbe19f5c25456ace2e2a76a4d0f71fb82a", "committedDate": "2020-06-05T13:01:31Z", "message": "Fix checkstyle.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d60261d9d920a30de200ce2dbbad36713ec469e6", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/d60261d9d920a30de200ce2dbbad36713ec469e6", "committedDate": "2020-06-05T13:01:46Z", "message": "fix ByteStream writer.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ea3e7aa66939005332262e4eba06e35fdc4f5e3", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/5ea3e7aa66939005332262e4eba06e35fdc4f5e3", "committedDate": "2020-06-05T13:59:39Z", "message": "Fix junits.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "865f8c79fb5dd0edbbae0c7d0b87a89a8dee6423", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/865f8c79fb5dd0edbbae0c7d0b87a89a8dee6423", "committedDate": "2020-06-05T15:23:33Z", "message": "refactor tests.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTE0NTc4", "url": "https://github.com/pravega/pravega/pull/4848#pullrequestreview-425514578", "createdAt": "2020-06-05T18:04:30Z", "commit": {"oid": "865f8c79fb5dd0edbbae0c7d0b87a89a8dee6423"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b35f5d0b6830decf92a066160a4badbeaa38c8d", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/8b35f5d0b6830decf92a066160a4badbeaa38c8d", "committedDate": "2020-06-05T23:16:25Z", "message": "Merge branch 'master' into issue-sealstream-writer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0077c28ec36d5f6a9a63214d918e791c07f5aabe", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/0077c28ec36d5f6a9a63214d918e791c07f5aabe", "committedDate": "2020-06-06T03:43:52Z", "message": "Improve coverage.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NzMxNjk3", "url": "https://github.com/pravega/pravega/pull/4848#pullrequestreview-425731697", "createdAt": "2020-06-06T10:51:31Z", "commit": {"oid": "0077c28ec36d5f6a9a63214d918e791c07f5aabe"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMDo1MTozMVrOGgDIOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNlQxMDo1MTozMVrOGgDIOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjI1ODg3NQ==", "bodyText": "This new variable looks unused", "url": "https://github.com/pravega/pravega/pull/4848#discussion_r436258875", "createdAt": "2020-06-06T10:51:31Z", "author": {"login": "eolivelli"}, "path": "client/src/test/java/io/pravega/client/stream/impl/ClientFactoryTest.java", "diffHunk": "@@ -54,8 +73,29 @@ public void testEventWriter() {\n         String scope = \"scope\";\n         String stream = \"stream1\";\n         // setup mocks\n-        ClientFactoryImpl clientFactory = new ClientFactoryImpl(scope, controllerClient, connectionFactory);\n+        ClientFactoryImpl clientFactory = new ClientFactoryImpl(scope, controllerClient, connectionFactory, inFactory, outFactory, condFactory, metaFactory);\n+        NavigableMap<Double, SegmentWithRange> segments = new TreeMap<>();\n+        Segment segment = new Segment(scope, stream, 0L);\n+        segments.put(1.0, new SegmentWithRange(segment, 0.0, 1.0));\n+        StreamSegments currentSegments = new StreamSegments(segments, \"\");\n+        SegmentOutputStream outStream = mock(SegmentOutputStream.class);\n+        when(controllerClient.getCurrentSegments(scope, stream))\n+                .thenReturn(CompletableFuture.completedFuture(currentSegments));\n+        when(outFactory.createOutputStreamForSegment(eq(segment), any(), any(), any())).thenReturn(outStream);\n+\n+        EventWriterConfig writerConfig = EventWriterConfig.builder().build();\n+        EventStreamWriter<String> writer = clientFactory.createEventWriter(stream, new JavaSerializer<String>(), writerConfig);\n+        assertEquals(writerConfig, writer.getConfig());\n+    }\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void testEventWriterSealedStream() {\n+        String scope = \"scope\";\n+        String stream = \"stream1\";\n+        // setup mocks\n+        ClientFactoryImpl clientFactory = new ClientFactoryImpl(scope, controllerClient, connectionFactory, inFactory, outFactory, condFactory, metaFactory);\n         StreamSegments currentSegments = new StreamSegments(new TreeMap<>(), \"\");\n+        SegmentOutputStream outStream = mock(SegmentOutputStream.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0077c28ec36d5f6a9a63214d918e791c07f5aabe"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "274d7e46033b8f7179d5418e7977ee5055514ddc", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/274d7e46033b8f7179d5418e7977ee5055514ddc", "committedDate": "2020-06-07T10:08:18Z", "message": "CR Change: Remove unused variable.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18f700aff542ba13ac1c41643e0144b348842797", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/18f700aff542ba13ac1c41643e0144b348842797", "committedDate": "2020-06-07T10:09:21Z", "message": "Merge branch 'master' into issue-sealstream-writer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1ODA1OTgw", "url": "https://github.com/pravega/pravega/pull/4848#pullrequestreview-425805980", "createdAt": "2020-06-07T10:15:29Z", "commit": {"oid": "18f700aff542ba13ac1c41643e0144b348842797"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbf5bff6512ee2a0cfd33cb6b47e8bd67a6f2439", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/bbf5bff6512ee2a0cfd33cb6b47e8bd67a6f2439", "committedDate": "2020-06-08T10:47:05Z", "message": "Merge branch 'master' into issue-sealstream-writer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MzE2MzE3", "url": "https://github.com/pravega/pravega/pull/4848#pullrequestreview-426316317", "createdAt": "2020-06-08T14:46:16Z", "commit": {"oid": "bbf5bff6512ee2a0cfd33cb6b47e8bd67a6f2439"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3521, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}