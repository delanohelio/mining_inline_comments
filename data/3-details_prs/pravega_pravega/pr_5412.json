{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0OTY1ODU1", "number": 5412, "title": "Issue 5390: SLTS - Improve logging. Shortcut findChunk for reading last chunk.", "bodyText": "Signed-off-by: Sachin Joshi sachin.joshi@emc.com\nChange log description\nList of small improvements  in ReadOperator and WriteOperator.\n\nFix incorrectly reported scan counting and log messages in ReadOperator\nFix incorrect/incomplete log messages.\nSkip chunk lookup when data is in last chunk.\n\nPurpose of the change\nFixes #5411\nWhat the code does\n\nFix incorrectly reported scan counting and log messages in ReadOperator\nFix incorrect/incomplete log messages.\nSkip chunk lookup when data is in last chunk.\n\nHow to verify it\nbuild should pass.", "createdAt": "2020-12-09T07:14:41Z", "url": "https://github.com/pravega/pravega/pull/5412", "merged": true, "mergeCommit": {"oid": "3a97922ca1fd18ee14ec9b2cdbdbef1d721901c7"}, "closed": true, "closedAt": "2020-12-10T14:58:52Z", "author": {"login": "sachin-j-joshi"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkZSyBgH2gAyNTM0OTY1ODU1OjVhN2FkNzdmMGIxYWZmZTc5ZWQ3NDA4MDk4OTk0MjBhZmRlN2ZkYWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdk0fZcAFqTU0OTI2OTc1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a7ad77f0b1affe79ed740809899420afde7fdab", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/5a7ad77f0b1affe79ed740809899420afde7fdab", "committedDate": "2020-12-09T07:06:39Z", "message": "Issue 5390: SLTS - Improve logging. Shortcut findChunk for reading last chunk\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4Mzk3NTMw", "url": "https://github.com/pravega/pravega/pull/5412#pullrequestreview-548397530", "createdAt": "2020-12-09T16:59:51Z", "commit": {"oid": "5a7ad77f0b1affe79ed740809899420afde7fdab"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjo1OTo1MVrOICfSbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjo1OTo1NVrOICfSpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4MDY4NA==", "bodyText": "how is this helpful to identify it? Also, what's wrong with this.hashcode()?", "url": "https://github.com/pravega/pravega/pull/5412#discussion_r539480684", "createdAt": "2020-12-09T16:59:51Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/WriteOperation.java", "diffHunk": "@@ -265,8 +265,8 @@ private void collectGarbage() {\n                     didSegmentLayoutChange = true;\n                     chunksAddedCount.incrementAndGet();\n \n-                    log.debug(\"{} write - New chunk added - segment={}, chunk={}, offset={}.\",\n-                            chunkedSegmentStorage.getLogPrefix(), handle.getSegmentName(), newChunkName, segmentMetadata.getLength());\n+                    log.debug(\"{} write - New chunk added - op={}, segment={}, chunk={}, offset={}.\",\n+                            chunkedSegmentStorage.getLogPrefix(), System.identityHashCode(this), handle.getSegmentName(), newChunkName, segmentMetadata.getLength());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a7ad77f0b1affe79ed740809899420afde7fdab"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4MDc0MA==", "bodyText": "Why async? Those operations should be quick. No need to add a new task in the executor queue.", "url": "https://github.com/pravega/pravega/pull/5412#discussion_r539480740", "createdAt": "2020-12-09T16:59:55Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/ReadOperation.java", "diffHunk": "@@ -202,14 +211,15 @@ private void logEnd() {\n                                 chunkedSegmentStorage.getReadIndexCache().addIndexEntry(handle.getSegmentName(), currentChunkName, startOffsetForCurrentChunk.get());\n                             }\n                             cntScanned.incrementAndGet();\n-                        }, chunkedSegmentStorage.getExecutor())\n-                        .thenAcceptAsync(v -> {\n-                            val elapsed = readIndexTimer.getElapsed();\n-                            SLTS_READ_INDEX_SCAN_LATENCY.reportSuccessEvent(elapsed);\n-                            log.debug(\"{} read - chunk lookup - segment={}, offset={}, scanned={}, latency={}.\",\n-                                    chunkedSegmentStorage.getLogPrefix(), handle.getSegmentName(), offset, cntScanned.get(), elapsed.toMillis());\n                         }, chunkedSegmentStorage.getExecutor()),\n-                chunkedSegmentStorage.getExecutor());\n+                chunkedSegmentStorage.getExecutor())\n+                .thenAcceptAsync(v -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a7ad77f0b1affe79ed740809899420afde7fdab"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9094932efa8e104cab16c918e7b6500e55306ce", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/e9094932efa8e104cab16c918e7b6500e55306ce", "committedDate": "2020-12-10T06:15:24Z", "message": "Issue 5390: SLTS - greater than equal to.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c758486ef0d16f5310a4a5c216796c6651baabe3", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/c758486ef0d16f5310a4a5c216796c6651baabe3", "committedDate": "2020-12-10T09:08:26Z", "message": "Merge branch 'master' into issue-5411-SLTS-better-logging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4OTg3NTAy", "url": "https://github.com/pravega/pravega/pull/5412#pullrequestreview-548987502", "createdAt": "2020-12-10T09:13:01Z", "commit": {"oid": "c758486ef0d16f5310a4a5c216796c6651baabe3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwOToxMzowMlrOIC-3yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwOTozMDozMFrOIC_pAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTk5ODE1NA==", "bodyText": "If this is an exception, why it is in debug level? In general, we want to keep track of relevant exceptions in production systems, which requires this to be at least info level, if not warn or error. As SLTS is a new piece of code, let's keep high the log level of exceptions so we can debug problems quickly without needed to repeat experiments with debug level logs.", "url": "https://github.com/pravega/pravega/pull/5412#discussion_r539998154", "createdAt": "2020-12-10T09:13:02Z", "author": {"login": "RaulGracia"}, "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/ReadOperation.java", "diffHunk": "@@ -90,7 +90,7 @@\n                                         return readData(txn);\n                                     }, chunkedSegmentStorage.getExecutor())\n                                     .exceptionally(ex -> {\n-                                        log.debug(\"{} read - started op={}, segment={}, offset={}, bytesRead={}.\",\n+                                        log.debug(\"{} read - exception op={}, segment={}, offset={}, bytesRead={}.\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c758486ef0d16f5310a4a5c216796c6651baabe3"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDAxMDc1Mw==", "bodyText": "Maybe not related to the PR, but the way chunkToReadFrom (and other variables) is set and checked here and there looks hard to track in case we face a race conditions. Even tough a variable is declared as volatile, the point is that if multiple methods (perhaps executed by different threads) are setting and reading this variable throughout the class, it increases considerably the complexity of debugging it in case of problems. Perhaps this was the only way, I don't know, but maybe in the future we can reconsider this pattern to see if there is an alternative that simplifies the code.", "url": "https://github.com/pravega/pravega/pull/5412#discussion_r540010753", "createdAt": "2020-12-10T09:30:30Z", "author": {"login": "RaulGracia"}, "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/ReadOperation.java", "diffHunk": "@@ -132,7 +133,9 @@ private void logEnd() {\n                             return txn.get(currentChunkName)\n                                     .thenAcceptAsync(storageMetadata -> {\n                                         chunkToReadFrom = (ChunkMetadata) storageMetadata;\n-                                        log.debug(\"{} read - reading from next chunk - segment={}, chunk={}\", chunkedSegmentStorage.getLogPrefix(), handle.getSegmentName(), chunkToReadFrom);\n+                                        Preconditions.checkState(null != chunkToReadFrom, \"chunkToReadFrom is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c758486ef0d16f5310a4a5c216796c6651baabe3"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MjY5NzUy", "url": "https://github.com/pravega/pravega/pull/5412#pullrequestreview-549269752", "createdAt": "2020-12-10T14:47:52Z", "commit": {"oid": "c758486ef0d16f5310a4a5c216796c6651baabe3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3789, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}