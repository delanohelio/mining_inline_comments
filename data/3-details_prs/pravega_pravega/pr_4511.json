{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2MDIxMDk2", "number": 4511, "title": "Issue 4509: Rack-aware Bookkeeper client config", "bodyText": "Change log description\nAllow the Bookkeeper client in the Segment Store to be configured with rack-aware ensemble placement policy.\nPurpose of the change\nFixes #4509.\nWhat the code does\nThis PR enables the Bookkeeper client in the Segment Store to be configured with a rack-aware ensemble placement policy. To this end, we introduce 3 new Bookkeeper client parameters:\n\nbookkeeper.enforceMinNumRacksPerWriteQuorum: This parameter defines whether we should enforce the rack-aware policy or not.\nbookkeeper.minNumRacksPerWriteQuorum: In the case we enforce rack-aware ensamble placement policy, this parameter determines the number of different physical location that a write should be replicated to.\nbookkeeper.networkTopologyScriptFileName: This is an important and environment-dependent parameter. It should point to a script that, based on a list of Bookie IPs as input, outputs a list of equal size with the physical locations of each Bookie IP (e.g. [IP1, IP2, IP3] -> [/rack1, /rack2, /rack3]). We provide a sample file that is intended to be used in test or demo situations only.\n\nHow to verify it\nWe have deployed Pravega with the changes of this branch. As can be see, the RackawareEnsemblePlacementPolicy is properly initialized:\n2020-01-22 18:29:00,845 960  [main] INFO  o.a.b.c.RackawareEnsemblePlacementPolicyImpl - Initialize rackaware ensemble placement policy @ <Bookie:172.28.13.11:0> @ /datacenter/rack-11 : org.apache.bookkeeper.net.ScriptBasedMapping.\n\nThis means that the Bookkeeper client has correctly initialized the ScriptBasedMapping, which internally invokes the topology script (networkTopologyScriptFileName).\nThen, upon each Bookie join, the network topology is updated correctly, which implies that the script is correctly invoked:\n2020-01-22 18:29:00,873 988  [BookKeeperClientScheduler-OrderedScheduler-0-0] DEBUG o.a.b.c.RackawareEnsemblePlacementPolicyImpl - Cluster changed : left bookies are [], joined bookies are [pravega-bookie-1.pravega-bookie-headless.default.svc.cluster.local:3181, pravega-bookie-2.pravega-bookie-headless.default.svc.cluster.local:3181, pravega-bookie-0.pravega-bookie-headless.default.svc.cluster.local:3181], while dead bookies are [].\n2020-01-22 18:29:00,877 992  [BookKeeperClientScheduler-OrderedScheduler-0-0] INFO  o.a.b.net.NetworkTopologyImpl - Adding a new node: /datacenter/rack-10/pravega-bookie-1.pravega-bookie-headless.default.svc.cluster.local:3181\n2020-01-22 18:29:00,877 992  [BookKeeperClientScheduler-OrderedScheduler-0-0] DEBUG o.a.b.net.NetworkTopologyImpl - NetworkTopology became:\n/datacenter/rack-10/pravega-bookie-1.pravega-bookie-headless.default.svc.cluster.local:3181\n2020-01-22 18:29:00,878 993  [BookKeeperClientScheduler-OrderedScheduler-0-0] DEBUG o.a.b.c.RackawareEnsemblePlacementPolicyImpl - Cluster changed : bookie pravega-bookie-1.pravega-bookie-headless.default.svc.cluster.local:3181 joined the cluster.\n2020-01-22 18:29:00,881 996  [BookKeeperClientScheduler-OrderedScheduler-0-0] INFO  o.a.b.net.NetworkTopologyImpl - Adding a new node: /datacenter/rack-9/pravega-bookie-2.pravega-bookie-headless.default.svc.cluster.local:3181\n2020-01-22 18:29:00,881 996  [BookKeeperClientScheduler-OrderedScheduler-0-0] DEBUG o.a.b.net.NetworkTopologyImpl - NetworkTopology became:\n/datacenter/rack-10/pravega-bookie-1.pravega-bookie-headless.default.svc.cluster.local:3181\n/datacenter/rack-9/pravega-bookie-2.pravega-bookie-headless.default.svc.cluster.local:3181\n2020-01-22 18:29:00,881 996  [BookKeeperClientScheduler-OrderedScheduler-0-0] DEBUG o.a.b.c.RackawareEnsemblePlacementPolicyImpl - Cluster changed : bookie pravega-bookie-2.pravega-bookie-headless.default.svc.cluster.local:3181 joined the cluster.\n2020-01-22 18:29:00,884 999  [BookKeeperClientScheduler-OrderedScheduler-0-0] INFO  o.a.b.net.NetworkTopologyImpl - Adding a new node: /datacenter/rack-8/pravega-bookie-0.pravega-bookie-headless.default.svc.cluster.local:3181\n2020-01-22 18:29:00,884 999  [BookKeeperClientScheduler-OrderedScheduler-0-0] DEBUG o.a.b.net.NetworkTopologyImpl - NetworkTopology became:\n/datacenter/rack-10/pravega-bookie-1.pravega-bookie-headless.default.svc.cluster.local:3181\n/datacenter/rack-9/pravega-bookie-2.pravega-bookie-headless.default.svc.cluster.local:3181\n/datacenter/rack-8/pravega-bookie-0.pravega-bookie-headless.default.svc.cluster.local:3181\n2020-01-22 18:29:00,884 999  [BookKeeperClientScheduler-OrderedScheduler-0-0] DEBUG o.a.b.c.RackawareEnsemblePlacementPolicyImpl - Cluster changed : bookie pravega-bookie-0.pravega-bookie-headless.default.svc.cluster.local:3181 joined the cluster.\n2020-01-22 18:29:00,885 1000 [BookKeeperClientScheduler-OrderedScheduler-0-0] DEBUG o.a.b.c.RackawareEnsemblePlacementPolicyImpl - Cluster changed : left bookies are [], joined bookies are [], while dead bookies are [].\n\nAs you can see, the final topology relates each Bookie to a different rack number, that corresponds to the last number of the Bookie IP (as explained in the sample Bookkeeper topology script):\npravega-bookie-0   1/1     Running   1          13m     xxx.8\npravega-bookie-1   1/1     Running   0          13m     yyy.10\npravega-bookie-2   1/1     Running   0          13m     zzz.9\n\n2020-01-22 18:29:00,884 999  [BookKeeperClientScheduler-OrderedScheduler-0-0] DEBUG o.a.b.net.NetworkTopologyImpl - NetworkTopology became:\n/datacenter/rack-10/pravega-bookie-1.pravega-bookie-headless.default.svc.cluster.local:3181\n/datacenter/rack-9/pravega-bookie-2.pravega-bookie-headless.default.svc.cluster.local:3181\n/datacenter/rack-8/pravega-bookie-0.pravega-bookie-headless.default.svc.cluster.local:3181", "createdAt": "2020-01-22T19:20:37Z", "url": "https://github.com/pravega/pravega/pull/4511", "merged": true, "mergeCommit": {"oid": "304ddb7ef558e9ab9df512098b689a693d02096b"}, "closed": true, "closedAt": "2020-02-07T15:32:44Z", "author": {"login": "RaulGracia"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8fDNigH2gAyMzY2MDIxMDk2OjE5OTUzMmRjMGMyZDFmZmY2ZjAwMGEyY2U2MDBlYWVjNjlkNTExNzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCBHVlgFqTM1NTIzODAxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "199532dc0c2d1fff6f000a2ce600eaec69d51176", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/199532dc0c2d1fff6f000a2ce600eaec69d51176", "committedDate": "2020-01-21T11:00:57Z", "message": "Try enabling RackAware policy on the Segment Store.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fcb0c9bdbcdb07991da99c7d1b57214d1f20dd8", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/9fcb0c9bdbcdb07991da99c7d1b57214d1f20dd8", "committedDate": "2020-01-21T22:19:53Z", "message": "Added test topology script.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c694ae93ee4f352ffa00ccedc4b579dde94b7a33", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/c694ae93ee4f352ffa00ccedc4b579dde94b7a33", "committedDate": "2020-01-22T11:11:18Z", "message": "Debug script failure.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9957714f80a78a3f9e70ffa7e2666cfd3334e807", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/9957714f80a78a3f9e70ffa7e2666cfd3334e807", "committedDate": "2020-01-22T11:38:39Z", "message": "Debug script failure.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38b8892078c6a5f934a0cbd8933f0c4497d492bd", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/38b8892078c6a5f934a0cbd8933f0c4497d492bd", "committedDate": "2020-01-22T12:14:40Z", "message": "Debug script failure.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11e264447531e94772a28569f80a69e2e61de172", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/11e264447531e94772a28569f80a69e2e61de172", "committedDate": "2020-01-22T14:55:23Z", "message": "Debug script failure.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2eeafa7c2cd36a355fd3799130e8bbcdccb8a173", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/2eeafa7c2cd36a355fd3799130e8bbcdccb8a173", "committedDate": "2020-01-22T15:06:47Z", "message": "Debug script failure.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "684cd993863fd4d7bc3e9bdde6e4167c59857c93", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/684cd993863fd4d7bc3e9bdde6e4167c59857c93", "committedDate": "2020-01-22T15:18:34Z", "message": "Debug script failure.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2de1f8af53e27cf572b8e1b3bfb475619d90cb31", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/2de1f8af53e27cf572b8e1b3bfb475619d90cb31", "committedDate": "2020-01-22T15:57:58Z", "message": "Debug script failure.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e48349446a0f32ffe03d23cd1e4e347c21fcb92", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/7e48349446a0f32ffe03d23cd1e4e347c21fcb92", "committedDate": "2020-01-22T18:22:33Z", "message": "Organize configuration.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e223e69933e0c2122a4eaf33839cabb289dee7c", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/8e223e69933e0c2122a4eaf33839cabb289dee7c", "committedDate": "2020-01-22T18:48:33Z", "message": "Refactor sample code.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ef003d82d71001d190fe05b2b765ccc95441912", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/0ef003d82d71001d190fe05b2b765ccc95441912", "committedDate": "2020-01-22T18:57:50Z", "message": "Added config defaults tests.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab6470ee51e3d87de7a202f363d5a0aa7ef4d6ba", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/ab6470ee51e3d87de7a202f363d5a0aa7ef4d6ba", "committedDate": "2020-01-22T19:20:48Z", "message": "Merge branch 'master' into rack-aware-client-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "972890ce3e6edf35fed5e629fe62e44b8db119fd", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/972890ce3e6edf35fed5e629fe62e44b8db119fd", "committedDate": "2020-01-23T09:19:20Z", "message": "Merge branch 'master' into rack-aware-client-config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NDEyMTEw", "url": "https://github.com/pravega/pravega/pull/4511#pullrequestreview-347412110", "createdAt": "2020-01-23T15:58:56Z", "commit": {"oid": "972890ce3e6edf35fed5e629fe62e44b8db119fd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNTo1ODo1NlrOFhDh4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNTo1OTowNVrOFhDiSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIwNTE1Mg==", "bodyText": "Please remove year.", "url": "https://github.com/pravega/pravega/pull/4511#discussion_r370205152", "createdAt": "2020-01-23T15:58:56Z", "author": {"login": "andreipaduroiu"}, "path": "docker/pravega/scripts/sample-bookkeeper-topology.sh", "diffHunk": "@@ -0,0 +1,14 @@\n+#!/usr/bin/env sh\n+#\n+# Copyright (c) 2017 Dell Inc., or its subsidiaries. All Rights Reserved.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "972890ce3e6edf35fed5e629fe62e44b8db119fd"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIwNTI1OA==", "bodyText": "I think this may be unintended", "url": "https://github.com/pravega/pravega/pull/4511#discussion_r370205258", "createdAt": "2020-01-23T15:59:05Z", "author": {"login": "andreipaduroiu"}, "path": "gradle.properties", "diffHunk": "@@ -16,7 +16,7 @@ apacheCommonsCompressVersion=1.18\n apacheCuratorVersion=4.0.1\n apacheZookeeperVersion=3.5.5\n checkstyleToolVersion=8.23\n-bookKeeperVersion=4.7.3\n+bookKeeperVersion=4.9.2", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "972890ce3e6edf35fed5e629fe62e44b8db119fd"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22fa0587336a0b5b9b46e008c520506b158bbab8", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/22fa0587336a0b5b9b46e008c520506b158bbab8", "committedDate": "2020-01-23T16:07:05Z", "message": "Merge branch 'master' into rack-aware-client-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92f627ec2fe02a2cc7bb881f8654a8a48293687c", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/92f627ec2fe02a2cc7bb881f8654a8a48293687c", "committedDate": "2020-01-27T09:11:33Z", "message": "Merge branch 'master' into rack-aware-client-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2356a37826f22656331d2ec66bb58fd795dd1ff5", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/2356a37826f22656331d2ec66bb58fd795dd1ff5", "committedDate": "2020-01-28T11:00:26Z", "message": "Merge branch 'master' into rack-aware-client-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "920839aaccba3062d26a2966a16c308e379437fc", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/920839aaccba3062d26a2966a16c308e379437fc", "committedDate": "2020-01-28T11:02:35Z", "message": "Removed copyright file.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af151b750dd2b061a6c4a6bbf7c9b8cbc56695be", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/af151b750dd2b061a6c4a6bbf7c9b8cbc56695be", "committedDate": "2020-01-30T16:26:14Z", "message": "Merge branch 'master' into rack-aware-client-config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMDEyNjYy", "url": "https://github.com/pravega/pravega/pull/4511#pullrequestreview-351012662", "createdAt": "2020-01-30T17:37:11Z", "commit": {"oid": "af151b750dd2b061a6c4a6bbf7c9b8cbc56695be"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cbe0ff4000d381c51ff20f26dba62a7cb55e412", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/2cbe0ff4000d381c51ff20f26dba62a7cb55e412", "committedDate": "2020-01-31T11:10:08Z", "message": "Merge branch 'master' into rack-aware-client-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16aea8f3c9146b825b60c2b744cc8f5b1735015c", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/16aea8f3c9146b825b60c2b744cc8f5b1735015c", "committedDate": "2020-01-31T17:58:55Z", "message": "Merge branch 'master' into rack-aware-client-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65f399fddc804a6acb8423409e0fe8c2944f5024", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/65f399fddc804a6acb8423409e0fe8c2944f5024", "committedDate": "2020-01-31T22:52:51Z", "message": "Merge branch 'master' into rack-aware-client-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "297918e6344a867e95fe9dbaefdcb5e0145efb29", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/297918e6344a867e95fe9dbaefdcb5e0145efb29", "committedDate": "2020-02-03T15:58:53Z", "message": "Merge branch 'master' into rack-aware-client-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "593989e19cc4d8b9ccd7bc3eca1cb949855484dd", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/593989e19cc4d8b9ccd7bc3eca1cb949855484dd", "committedDate": "2020-02-05T15:45:12Z", "message": "Upgrade Bookkeeper client to 4.8.2 to get the fixes of rack-aware placement.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5bded3ff94d2f78f4763e90a6827bd26937cc67", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/c5bded3ff94d2f78f4763e90a6827bd26937cc67", "committedDate": "2020-02-05T15:46:03Z", "message": "Merge branch 'master' into rack-aware-client-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9048818e5d3dc4d698b29069912947dfd24851bb", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/9048818e5d3dc4d698b29069912947dfd24851bb", "committedDate": "2020-02-06T14:52:40Z", "message": "Merge branch 'master' into rack-aware-client-config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MjM4MDE2", "url": "https://github.com/pravega/pravega/pull/4511#pullrequestreview-355238016", "createdAt": "2020-02-07T15:31:51Z", "commit": {"oid": "9048818e5d3dc4d698b29069912947dfd24851bb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3563, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}