{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MzA4MTYz", "number": 4983, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNjo1MTo1N1rOETVzUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNjo1MzozM1rOETV1hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NzE1NjAyOnYy", "diffSide": "LEFT", "path": "client/src/test/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerTest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNjo1MTo1N1rOG5BV8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wMlQyMTo0ODo0N1rOG6oFfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDAxOQ==", "bodyText": "If this test is failing something is wrong.", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r462444019", "createdAt": "2020-07-29T16:51:57Z", "author": {"login": "tkaitchuck"}, "path": "client/src/test/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerTest.java", "diffHunk": "@@ -68,7 +68,7 @@ public void testReasonableLowerBound() {\n                 tracker.recordAck(i-100);\n             }\n         }\n-        assertTrue(tracker.getAppendBlockSize() >= size * 50);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYwNDcwMQ==", "bodyText": "As the calculation has slightly changed, it looks like the append block size for this test is a bit lower than 50x, but still pretty close to it (40x or more).", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r462604701", "createdAt": "2020-07-29T21:37:54Z", "author": {"login": "RaulGracia"}, "path": "client/src/test/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerTest.java", "diffHunk": "@@ -68,7 +68,7 @@ public void testReasonableLowerBound() {\n                 tracker.recordAck(i-100);\n             }\n         }\n-        assertTrue(tracker.getAppendBlockSize() >= size * 50);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDAxOQ=="}, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY2NjQ0NQ==", "bodyText": "Does 45 work?", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r462666445", "createdAt": "2020-07-30T00:35:24Z", "author": {"login": "tkaitchuck"}, "path": "client/src/test/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerTest.java", "diffHunk": "@@ -68,7 +68,7 @@ public void testReasonableLowerBound() {\n                 tracker.recordAck(i-100);\n             }\n         }\n-        assertTrue(tracker.getAppendBlockSize() >= size * 50);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDAxOQ=="}, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDEyNzM1OA==", "bodyText": "Yes, changed.", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r464127358", "createdAt": "2020-08-02T21:48:47Z", "author": {"login": "RaulGracia"}, "path": "client/src/test/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerTest.java", "diffHunk": "@@ -68,7 +68,7 @@ public void testReasonableLowerBound() {\n                 tracker.recordAck(i-100);\n             }\n         }\n-        assertTrue(tracker.getAppendBlockSize() >= size * 50);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDAxOQ=="}, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NzE1OTYzOnYy", "diffSide": "LEFT", "path": "client/src/main/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNjo1Mjo1NVrOG5BYQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNzoyMDo1MFrOG5CbIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDYwOQ==", "bodyText": "If the problem here is the max of 1 then why not remove that rather than deleting the value which means that BASE_TIME_NANOS cannot be configured?", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r462444609", "createdAt": "2020-07-29T16:52:55Z", "author": {"login": "tkaitchuck"}, "path": "client/src/main/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerImpl.java", "diffHunk": "@@ -89,8 +89,7 @@ public int getAppendBlockSize() {\n         }\n         double nanosPerAppend = nanosBetweenAppends.getCurrentValue();\n         double appendsInMaxBatchTime = Math.max(1.0, (MAX_BATCH_TIME_MILLIS * NANOS_PER_MILLI) / nanosPerAppend);\n-        double appendsInTime = Math.max(1.0, BASE_TIME_NANOS / nanosPerAppend);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ2MTczMA==", "bodyText": "Done, I kept previous structure but changed appendsInTime to be effectively 0 by default, which should be the same as it was before.", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r462461730", "createdAt": "2020-07-29T17:20:50Z", "author": {"login": "RaulGracia"}, "path": "client/src/main/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerImpl.java", "diffHunk": "@@ -89,8 +89,7 @@ public int getAppendBlockSize() {\n         }\n         double nanosPerAppend = nanosBetweenAppends.getCurrentValue();\n         double appendsInMaxBatchTime = Math.max(1.0, (MAX_BATCH_TIME_MILLIS * NANOS_PER_MILLI) / nanosPerAppend);\n-        double appendsInTime = Math.max(1.0, BASE_TIME_NANOS / nanosPerAppend);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDYwOQ=="}, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NzE2MTY2OnYy", "diffSide": "LEFT", "path": "client/src/main/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerImpl.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNjo1MzozM1rOG5BZrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwODoxNDozN1rOG6wMwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDk3Mg==", "bodyText": "If 1 event is a problem, perhaps a batch size of 0 would be better in these cases. So maybe change this 1 to 0.", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r462444972", "createdAt": "2020-07-29T16:53:33Z", "author": {"login": "tkaitchuck"}, "path": "client/src/main/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerImpl.java", "diffHunk": "@@ -89,8 +89,7 @@ public int getAppendBlockSize() {\n         }\n         double nanosPerAppend = nanosBetweenAppends.getCurrentValue();\n         double appendsInMaxBatchTime = Math.max(1.0, (MAX_BATCH_TIME_MILLIS * NANOS_PER_MILLI) / nanosPerAppend);\n-        double appendsInTime = Math.max(1.0, BASE_TIME_NANOS / nanosPerAppend);\n-        double appendsInBatch = MathHelpers.minMax(appendsOutstanding.getCurrentValue() * OUTSTANDING_FRACTION + appendsInTime, 1.0, appendsInMaxBatchTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjYwNDAxMw==", "bodyText": "With the previous change, we do not need to touch this line.", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r462604013", "createdAt": "2020-07-29T21:36:22Z", "author": {"login": "RaulGracia"}, "path": "client/src/main/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerImpl.java", "diffHunk": "@@ -89,8 +89,7 @@ public int getAppendBlockSize() {\n         }\n         double nanosPerAppend = nanosBetweenAppends.getCurrentValue();\n         double appendsInMaxBatchTime = Math.max(1.0, (MAX_BATCH_TIME_MILLIS * NANOS_PER_MILLI) / nanosPerAppend);\n-        double appendsInTime = Math.max(1.0, BASE_TIME_NANOS / nanosPerAppend);\n-        double appendsInBatch = MathHelpers.minMax(appendsOutstanding.getCurrentValue() * OUTSTANDING_FRACTION + appendsInTime, 1.0, appendsInMaxBatchTime);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDk3Mg=="}, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjY2NjYyNQ==", "bodyText": "Yes, but only because your test sends the exact same event size every time. If there were some slight variation we would want this to be 0, otherwise we would have the same problem you observed.", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r462666625", "createdAt": "2020-07-30T00:36:11Z", "author": {"login": "tkaitchuck"}, "path": "client/src/main/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerImpl.java", "diffHunk": "@@ -89,8 +89,7 @@ public int getAppendBlockSize() {\n         }\n         double nanosPerAppend = nanosBetweenAppends.getCurrentValue();\n         double appendsInMaxBatchTime = Math.max(1.0, (MAX_BATCH_TIME_MILLIS * NANOS_PER_MILLI) / nanosPerAppend);\n-        double appendsInTime = Math.max(1.0, BASE_TIME_NANOS / nanosPerAppend);\n-        double appendsInBatch = MathHelpers.minMax(appendsOutstanding.getCurrentValue() * OUTSTANDING_FRACTION + appendsInTime, 1.0, appendsInMaxBatchTime);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDk3Mg=="}, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI2MDI4OQ==", "bodyText": "As I shown, the change you propose seems to do not have a big impact on latency, but the max throughput for small events is significantly reduced. For this reason, I would rather keep the algorithm in its current form (similar to what was before), as it has been tested as a good baseline in a variety of situations. We can address further improvements on it on separate PRs, as the purpose of this PR is only to solve the write latency problem for low event rates and multiple segments.", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r464260289", "createdAt": "2020-08-03T08:14:37Z", "author": {"login": "RaulGracia"}, "path": "client/src/main/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerImpl.java", "diffHunk": "@@ -89,8 +89,7 @@ public int getAppendBlockSize() {\n         }\n         double nanosPerAppend = nanosBetweenAppends.getCurrentValue();\n         double appendsInMaxBatchTime = Math.max(1.0, (MAX_BATCH_TIME_MILLIS * NANOS_PER_MILLI) / nanosPerAppend);\n-        double appendsInTime = Math.max(1.0, BASE_TIME_NANOS / nanosPerAppend);\n-        double appendsInBatch = MathHelpers.minMax(appendsOutstanding.getCurrentValue() * OUTSTANDING_FRACTION + appendsInTime, 1.0, appendsInMaxBatchTime);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDk3Mg=="}, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4815, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}