{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMzY0OTQ0", "number": 4853, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMDo1MDo1MFrOEDn2Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNzo0NzowN1rOEDwA2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMjM0MDI3OnYy", "diffSide": "RIGHT", "path": "test/integration/src/test/java/io/pravega/test/integration/StreamMetricsTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMDo1MDo1MFrOGgv7ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzoyOToyOFrOGgzxBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5Mjk1NA==", "bodyText": "Why don't you fail the test?", "url": "https://github.com/pravega/pravega/pull/4853#discussion_r436992954", "createdAt": "2020-06-08T20:50:50Z", "author": {"login": "eolivelli"}, "path": "test/integration/src/test/java/io/pravega/test/integration/StreamMetricsTest.java", "diffHunk": "@@ -229,4 +229,50 @@ public void testTransactionMetrics() throws Exception {\n         AssertExtensions.assertEventuallyEquals(true, () -> MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)) != null, 10000);\n         assertEquals(1, (long) MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)).count());\n     }\n+\n+    @Test(timeout = 30000)\n+    public void testRollingTxnMetrics() throws Exception {\n+        String scaleRollingTxnScopeName = \"scaleRollingTxnScope\";\n+        String scaleRollingTxnStreamName = \"scaleRollingTxnStream\";\n+\n+        controllerWrapper.getControllerService().createScope(scaleRollingTxnScopeName).get();\n+        if (!controller.createStream(scaleRollingTxnScopeName, scaleRollingTxnStreamName, config).get()) {\n+            log.error(\"Stream {} for scale testing already existed, exiting\", scaleRollingTxnScopeName + \"/\" + scaleRollingTxnStreamName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc9f01e40b5242caff16c83d7eb1246bf6115dfe"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAxNDc3Nw==", "bodyText": "Fail the test.", "url": "https://github.com/pravega/pravega/pull/4853#discussion_r437014777", "createdAt": "2020-06-08T21:35:10Z", "author": {"login": "andreipaduroiu"}, "path": "test/integration/src/test/java/io/pravega/test/integration/StreamMetricsTest.java", "diffHunk": "@@ -229,4 +229,50 @@ public void testTransactionMetrics() throws Exception {\n         AssertExtensions.assertEventuallyEquals(true, () -> MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)) != null, 10000);\n         assertEquals(1, (long) MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)).count());\n     }\n+\n+    @Test(timeout = 30000)\n+    public void testRollingTxnMetrics() throws Exception {\n+        String scaleRollingTxnScopeName = \"scaleRollingTxnScope\";\n+        String scaleRollingTxnStreamName = \"scaleRollingTxnStream\";\n+\n+        controllerWrapper.getControllerService().createScope(scaleRollingTxnScopeName).get();\n+        if (!controller.createStream(scaleRollingTxnScopeName, scaleRollingTxnStreamName, config).get()) {\n+            log.error(\"Stream {} for scale testing already existed, exiting\", scaleRollingTxnScopeName + \"/\" + scaleRollingTxnStreamName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5Mjk1NA=="}, "originalCommit": {"oid": "dc9f01e40b5242caff16c83d7eb1246bf6115dfe"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1NTc0OQ==", "bodyText": "fixed", "url": "https://github.com/pravega/pravega/pull/4853#discussion_r437055749", "createdAt": "2020-06-08T23:29:28Z", "author": {"login": "kevinhan88"}, "path": "test/integration/src/test/java/io/pravega/test/integration/StreamMetricsTest.java", "diffHunk": "@@ -229,4 +229,50 @@ public void testTransactionMetrics() throws Exception {\n         AssertExtensions.assertEventuallyEquals(true, () -> MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)) != null, 10000);\n         assertEquals(1, (long) MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)).count());\n     }\n+\n+    @Test(timeout = 30000)\n+    public void testRollingTxnMetrics() throws Exception {\n+        String scaleRollingTxnScopeName = \"scaleRollingTxnScope\";\n+        String scaleRollingTxnStreamName = \"scaleRollingTxnStream\";\n+\n+        controllerWrapper.getControllerService().createScope(scaleRollingTxnScopeName).get();\n+        if (!controller.createStream(scaleRollingTxnScopeName, scaleRollingTxnStreamName, config).get()) {\n+            log.error(\"Stream {} for scale testing already existed, exiting\", scaleRollingTxnScopeName + \"/\" + scaleRollingTxnStreamName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5Mjk1NA=="}, "originalCommit": {"oid": "dc9f01e40b5242caff16c83d7eb1246bf6115dfe"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMjM0MTA3OnYy", "diffSide": "RIGHT", "path": "test/integration/src/test/java/io/pravega/test/integration/StreamMetricsTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMDo1MTowMlrOGgv8MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzoyOTo0MFrOGgzxSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5MzA3Mg==", "bodyText": "Same here", "url": "https://github.com/pravega/pravega/pull/4853#discussion_r436993072", "createdAt": "2020-06-08T20:51:02Z", "author": {"login": "eolivelli"}, "path": "test/integration/src/test/java/io/pravega/test/integration/StreamMetricsTest.java", "diffHunk": "@@ -229,4 +229,50 @@ public void testTransactionMetrics() throws Exception {\n         AssertExtensions.assertEventuallyEquals(true, () -> MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)) != null, 10000);\n         assertEquals(1, (long) MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)).count());\n     }\n+\n+    @Test(timeout = 30000)\n+    public void testRollingTxnMetrics() throws Exception {\n+        String scaleRollingTxnScopeName = \"scaleRollingTxnScope\";\n+        String scaleRollingTxnStreamName = \"scaleRollingTxnStream\";\n+\n+        controllerWrapper.getControllerService().createScope(scaleRollingTxnScopeName).get();\n+        if (!controller.createStream(scaleRollingTxnScopeName, scaleRollingTxnStreamName, config).get()) {\n+            log.error(\"Stream {} for scale testing already existed, exiting\", scaleRollingTxnScopeName + \"/\" + scaleRollingTxnStreamName);\n+            return;\n+        }\n+\n+        @Cleanup\n+        EventStreamClientFactory clientFactory = EventStreamClientFactory.withScope(scaleRollingTxnScopeName, ClientConfig.builder()\n+                .controllerURI(URI.create(\"tcp://localhost:\" + controllerPort)).build());\n+        @Cleanup\n+        TransactionalEventStreamWriter<String> writer = clientFactory.createTransactionalEventWriter(Stream.of(scaleRollingTxnScopeName, scaleRollingTxnStreamName).getStreamName(),\n+                new JavaSerializer<>(), EventWriterConfig.builder().build());\n+        Transaction<String> transaction = writer.beginTxn();\n+        transaction.writeEvent(\"Transactional content\");\n+\n+        //split to 3 segments\n+        Map<Double, Double> keyRanges = new HashMap<>();\n+        keyRanges.put(0.0, 0.25);\n+        keyRanges.put(0.25, 0.75);\n+        keyRanges.put(0.75, 1.0);\n+\n+        Stream scaleRollingTxnStream = new StreamImpl(scaleRollingTxnScopeName, scaleRollingTxnStreamName);\n+        if (!controller.scaleStream(scaleRollingTxnStream, Collections.singletonList(0L), keyRanges, executor).getFuture().get()) {\n+            log.error(\"Scale stream: splitting segment into three failed, exiting\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc9f01e40b5242caff16c83d7eb1246bf6115dfe"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1NTgxOA==", "bodyText": "fixed", "url": "https://github.com/pravega/pravega/pull/4853#discussion_r437055818", "createdAt": "2020-06-08T23:29:40Z", "author": {"login": "kevinhan88"}, "path": "test/integration/src/test/java/io/pravega/test/integration/StreamMetricsTest.java", "diffHunk": "@@ -229,4 +229,50 @@ public void testTransactionMetrics() throws Exception {\n         AssertExtensions.assertEventuallyEquals(true, () -> MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)) != null, 10000);\n         assertEquals(1, (long) MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)).count());\n     }\n+\n+    @Test(timeout = 30000)\n+    public void testRollingTxnMetrics() throws Exception {\n+        String scaleRollingTxnScopeName = \"scaleRollingTxnScope\";\n+        String scaleRollingTxnStreamName = \"scaleRollingTxnStream\";\n+\n+        controllerWrapper.getControllerService().createScope(scaleRollingTxnScopeName).get();\n+        if (!controller.createStream(scaleRollingTxnScopeName, scaleRollingTxnStreamName, config).get()) {\n+            log.error(\"Stream {} for scale testing already existed, exiting\", scaleRollingTxnScopeName + \"/\" + scaleRollingTxnStreamName);\n+            return;\n+        }\n+\n+        @Cleanup\n+        EventStreamClientFactory clientFactory = EventStreamClientFactory.withScope(scaleRollingTxnScopeName, ClientConfig.builder()\n+                .controllerURI(URI.create(\"tcp://localhost:\" + controllerPort)).build());\n+        @Cleanup\n+        TransactionalEventStreamWriter<String> writer = clientFactory.createTransactionalEventWriter(Stream.of(scaleRollingTxnScopeName, scaleRollingTxnStreamName).getStreamName(),\n+                new JavaSerializer<>(), EventWriterConfig.builder().build());\n+        Transaction<String> transaction = writer.beginTxn();\n+        transaction.writeEvent(\"Transactional content\");\n+\n+        //split to 3 segments\n+        Map<Double, Double> keyRanges = new HashMap<>();\n+        keyRanges.put(0.0, 0.25);\n+        keyRanges.put(0.25, 0.75);\n+        keyRanges.put(0.75, 1.0);\n+\n+        Stream scaleRollingTxnStream = new StreamImpl(scaleRollingTxnScopeName, scaleRollingTxnStreamName);\n+        if (!controller.scaleStream(scaleRollingTxnStream, Collections.singletonList(0L), keyRanges, executor).getFuture().get()) {\n+            log.error(\"Scale stream: splitting segment into three failed, exiting\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5MzA3Mg=="}, "originalCommit": {"oid": "dc9f01e40b5242caff16c83d7eb1246bf6115dfe"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMjM0NDA0OnYy", "diffSide": "RIGHT", "path": "test/integration/src/test/java/io/pravega/test/integration/StreamMetricsTest.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMDo1MTo1NlrOGgv-Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQyMzozMToxMVrOGgzzFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5MzU2Mg==", "bodyText": "This sleep may turn the test into a new flaky one.\nYou could wait for the conditions below to be verified", "url": "https://github.com/pravega/pravega/pull/4853#discussion_r436993562", "createdAt": "2020-06-08T20:51:56Z", "author": {"login": "eolivelli"}, "path": "test/integration/src/test/java/io/pravega/test/integration/StreamMetricsTest.java", "diffHunk": "@@ -229,4 +229,50 @@ public void testTransactionMetrics() throws Exception {\n         AssertExtensions.assertEventuallyEquals(true, () -> MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)) != null, 10000);\n         assertEquals(1, (long) MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)).count());\n     }\n+\n+    @Test(timeout = 30000)\n+    public void testRollingTxnMetrics() throws Exception {\n+        String scaleRollingTxnScopeName = \"scaleRollingTxnScope\";\n+        String scaleRollingTxnStreamName = \"scaleRollingTxnStream\";\n+\n+        controllerWrapper.getControllerService().createScope(scaleRollingTxnScopeName).get();\n+        if (!controller.createStream(scaleRollingTxnScopeName, scaleRollingTxnStreamName, config).get()) {\n+            log.error(\"Stream {} for scale testing already existed, exiting\", scaleRollingTxnScopeName + \"/\" + scaleRollingTxnStreamName);\n+            return;\n+        }\n+\n+        @Cleanup\n+        EventStreamClientFactory clientFactory = EventStreamClientFactory.withScope(scaleRollingTxnScopeName, ClientConfig.builder()\n+                .controllerURI(URI.create(\"tcp://localhost:\" + controllerPort)).build());\n+        @Cleanup\n+        TransactionalEventStreamWriter<String> writer = clientFactory.createTransactionalEventWriter(Stream.of(scaleRollingTxnScopeName, scaleRollingTxnStreamName).getStreamName(),\n+                new JavaSerializer<>(), EventWriterConfig.builder().build());\n+        Transaction<String> transaction = writer.beginTxn();\n+        transaction.writeEvent(\"Transactional content\");\n+\n+        //split to 3 segments\n+        Map<Double, Double> keyRanges = new HashMap<>();\n+        keyRanges.put(0.0, 0.25);\n+        keyRanges.put(0.25, 0.75);\n+        keyRanges.put(0.75, 1.0);\n+\n+        Stream scaleRollingTxnStream = new StreamImpl(scaleRollingTxnScopeName, scaleRollingTxnStreamName);\n+        if (!controller.scaleStream(scaleRollingTxnStream, Collections.singletonList(0L), keyRanges, executor).getFuture().get()) {\n+            log.error(\"Scale stream: splitting segment into three failed, exiting\");\n+            return;\n+        }\n+\n+        assertEquals(3, (long) MetricRegistryUtils.getGauge(MetricsNames.SEGMENTS_COUNT, streamTags(scaleRollingTxnScopeName, scaleRollingTxnStreamName)).value());\n+        assertEquals(1, (long) MetricRegistryUtils.getGauge(MetricsNames.SEGMENTS_SPLITS, streamTags(scaleRollingTxnScopeName, scaleRollingTxnStreamName)).value());\n+        assertEquals(0, (long) MetricRegistryUtils.getGauge(MetricsNames.SEGMENTS_MERGES, streamTags(scaleRollingTxnScopeName, scaleRollingTxnStreamName)).value());\n+\n+        transaction.flush();\n+        transaction.commit();\n+\n+        Thread.sleep(1000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc9f01e40b5242caff16c83d7eb1246bf6115dfe"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAxNDA0NQ==", "bodyText": "+1. Please do not add arbitrary thread sleeps in tests", "url": "https://github.com/pravega/pravega/pull/4853#discussion_r437014045", "createdAt": "2020-06-08T21:33:34Z", "author": {"login": "andreipaduroiu"}, "path": "test/integration/src/test/java/io/pravega/test/integration/StreamMetricsTest.java", "diffHunk": "@@ -229,4 +229,50 @@ public void testTransactionMetrics() throws Exception {\n         AssertExtensions.assertEventuallyEquals(true, () -> MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)) != null, 10000);\n         assertEquals(1, (long) MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)).count());\n     }\n+\n+    @Test(timeout = 30000)\n+    public void testRollingTxnMetrics() throws Exception {\n+        String scaleRollingTxnScopeName = \"scaleRollingTxnScope\";\n+        String scaleRollingTxnStreamName = \"scaleRollingTxnStream\";\n+\n+        controllerWrapper.getControllerService().createScope(scaleRollingTxnScopeName).get();\n+        if (!controller.createStream(scaleRollingTxnScopeName, scaleRollingTxnStreamName, config).get()) {\n+            log.error(\"Stream {} for scale testing already existed, exiting\", scaleRollingTxnScopeName + \"/\" + scaleRollingTxnStreamName);\n+            return;\n+        }\n+\n+        @Cleanup\n+        EventStreamClientFactory clientFactory = EventStreamClientFactory.withScope(scaleRollingTxnScopeName, ClientConfig.builder()\n+                .controllerURI(URI.create(\"tcp://localhost:\" + controllerPort)).build());\n+        @Cleanup\n+        TransactionalEventStreamWriter<String> writer = clientFactory.createTransactionalEventWriter(Stream.of(scaleRollingTxnScopeName, scaleRollingTxnStreamName).getStreamName(),\n+                new JavaSerializer<>(), EventWriterConfig.builder().build());\n+        Transaction<String> transaction = writer.beginTxn();\n+        transaction.writeEvent(\"Transactional content\");\n+\n+        //split to 3 segments\n+        Map<Double, Double> keyRanges = new HashMap<>();\n+        keyRanges.put(0.0, 0.25);\n+        keyRanges.put(0.25, 0.75);\n+        keyRanges.put(0.75, 1.0);\n+\n+        Stream scaleRollingTxnStream = new StreamImpl(scaleRollingTxnScopeName, scaleRollingTxnStreamName);\n+        if (!controller.scaleStream(scaleRollingTxnStream, Collections.singletonList(0L), keyRanges, executor).getFuture().get()) {\n+            log.error(\"Scale stream: splitting segment into three failed, exiting\");\n+            return;\n+        }\n+\n+        assertEquals(3, (long) MetricRegistryUtils.getGauge(MetricsNames.SEGMENTS_COUNT, streamTags(scaleRollingTxnScopeName, scaleRollingTxnStreamName)).value());\n+        assertEquals(1, (long) MetricRegistryUtils.getGauge(MetricsNames.SEGMENTS_SPLITS, streamTags(scaleRollingTxnScopeName, scaleRollingTxnStreamName)).value());\n+        assertEquals(0, (long) MetricRegistryUtils.getGauge(MetricsNames.SEGMENTS_MERGES, streamTags(scaleRollingTxnScopeName, scaleRollingTxnStreamName)).value());\n+\n+        transaction.flush();\n+        transaction.commit();\n+\n+        Thread.sleep(1000);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5MzU2Mg=="}, "originalCommit": {"oid": "dc9f01e40b5242caff16c83d7eb1246bf6115dfe"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzAxNDI3Mg==", "bodyText": "Use TestUtils.await or AssertExtensions.assertEventuallyEquals", "url": "https://github.com/pravega/pravega/pull/4853#discussion_r437014272", "createdAt": "2020-06-08T21:34:04Z", "author": {"login": "andreipaduroiu"}, "path": "test/integration/src/test/java/io/pravega/test/integration/StreamMetricsTest.java", "diffHunk": "@@ -229,4 +229,50 @@ public void testTransactionMetrics() throws Exception {\n         AssertExtensions.assertEventuallyEquals(true, () -> MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)) != null, 10000);\n         assertEquals(1, (long) MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)).count());\n     }\n+\n+    @Test(timeout = 30000)\n+    public void testRollingTxnMetrics() throws Exception {\n+        String scaleRollingTxnScopeName = \"scaleRollingTxnScope\";\n+        String scaleRollingTxnStreamName = \"scaleRollingTxnStream\";\n+\n+        controllerWrapper.getControllerService().createScope(scaleRollingTxnScopeName).get();\n+        if (!controller.createStream(scaleRollingTxnScopeName, scaleRollingTxnStreamName, config).get()) {\n+            log.error(\"Stream {} for scale testing already existed, exiting\", scaleRollingTxnScopeName + \"/\" + scaleRollingTxnStreamName);\n+            return;\n+        }\n+\n+        @Cleanup\n+        EventStreamClientFactory clientFactory = EventStreamClientFactory.withScope(scaleRollingTxnScopeName, ClientConfig.builder()\n+                .controllerURI(URI.create(\"tcp://localhost:\" + controllerPort)).build());\n+        @Cleanup\n+        TransactionalEventStreamWriter<String> writer = clientFactory.createTransactionalEventWriter(Stream.of(scaleRollingTxnScopeName, scaleRollingTxnStreamName).getStreamName(),\n+                new JavaSerializer<>(), EventWriterConfig.builder().build());\n+        Transaction<String> transaction = writer.beginTxn();\n+        transaction.writeEvent(\"Transactional content\");\n+\n+        //split to 3 segments\n+        Map<Double, Double> keyRanges = new HashMap<>();\n+        keyRanges.put(0.0, 0.25);\n+        keyRanges.put(0.25, 0.75);\n+        keyRanges.put(0.75, 1.0);\n+\n+        Stream scaleRollingTxnStream = new StreamImpl(scaleRollingTxnScopeName, scaleRollingTxnStreamName);\n+        if (!controller.scaleStream(scaleRollingTxnStream, Collections.singletonList(0L), keyRanges, executor).getFuture().get()) {\n+            log.error(\"Scale stream: splitting segment into three failed, exiting\");\n+            return;\n+        }\n+\n+        assertEquals(3, (long) MetricRegistryUtils.getGauge(MetricsNames.SEGMENTS_COUNT, streamTags(scaleRollingTxnScopeName, scaleRollingTxnStreamName)).value());\n+        assertEquals(1, (long) MetricRegistryUtils.getGauge(MetricsNames.SEGMENTS_SPLITS, streamTags(scaleRollingTxnScopeName, scaleRollingTxnStreamName)).value());\n+        assertEquals(0, (long) MetricRegistryUtils.getGauge(MetricsNames.SEGMENTS_MERGES, streamTags(scaleRollingTxnScopeName, scaleRollingTxnStreamName)).value());\n+\n+        transaction.flush();\n+        transaction.commit();\n+\n+        Thread.sleep(1000);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5MzU2Mg=="}, "originalCommit": {"oid": "dc9f01e40b5242caff16c83d7eb1246bf6115dfe"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1NjI3OA==", "bodyText": "fixed, sorry for the overlooking, the extensions are being used already in the rest of the class.", "url": "https://github.com/pravega/pravega/pull/4853#discussion_r437056278", "createdAt": "2020-06-08T23:31:11Z", "author": {"login": "kevinhan88"}, "path": "test/integration/src/test/java/io/pravega/test/integration/StreamMetricsTest.java", "diffHunk": "@@ -229,4 +229,50 @@ public void testTransactionMetrics() throws Exception {\n         AssertExtensions.assertEventuallyEquals(true, () -> MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)) != null, 10000);\n         assertEquals(1, (long) MetricRegistryUtils.getCounter(MetricsNames.ABORT_TRANSACTION, streamTags(txScopeName, txStreamName)).count());\n     }\n+\n+    @Test(timeout = 30000)\n+    public void testRollingTxnMetrics() throws Exception {\n+        String scaleRollingTxnScopeName = \"scaleRollingTxnScope\";\n+        String scaleRollingTxnStreamName = \"scaleRollingTxnStream\";\n+\n+        controllerWrapper.getControllerService().createScope(scaleRollingTxnScopeName).get();\n+        if (!controller.createStream(scaleRollingTxnScopeName, scaleRollingTxnStreamName, config).get()) {\n+            log.error(\"Stream {} for scale testing already existed, exiting\", scaleRollingTxnScopeName + \"/\" + scaleRollingTxnStreamName);\n+            return;\n+        }\n+\n+        @Cleanup\n+        EventStreamClientFactory clientFactory = EventStreamClientFactory.withScope(scaleRollingTxnScopeName, ClientConfig.builder()\n+                .controllerURI(URI.create(\"tcp://localhost:\" + controllerPort)).build());\n+        @Cleanup\n+        TransactionalEventStreamWriter<String> writer = clientFactory.createTransactionalEventWriter(Stream.of(scaleRollingTxnScopeName, scaleRollingTxnStreamName).getStreamName(),\n+                new JavaSerializer<>(), EventWriterConfig.builder().build());\n+        Transaction<String> transaction = writer.beginTxn();\n+        transaction.writeEvent(\"Transactional content\");\n+\n+        //split to 3 segments\n+        Map<Double, Double> keyRanges = new HashMap<>();\n+        keyRanges.put(0.0, 0.25);\n+        keyRanges.put(0.25, 0.75);\n+        keyRanges.put(0.75, 1.0);\n+\n+        Stream scaleRollingTxnStream = new StreamImpl(scaleRollingTxnScopeName, scaleRollingTxnStreamName);\n+        if (!controller.scaleStream(scaleRollingTxnStream, Collections.singletonList(0L), keyRanges, executor).getFuture().get()) {\n+            log.error(\"Scale stream: splitting segment into three failed, exiting\");\n+            return;\n+        }\n+\n+        assertEquals(3, (long) MetricRegistryUtils.getGauge(MetricsNames.SEGMENTS_COUNT, streamTags(scaleRollingTxnScopeName, scaleRollingTxnStreamName)).value());\n+        assertEquals(1, (long) MetricRegistryUtils.getGauge(MetricsNames.SEGMENTS_SPLITS, streamTags(scaleRollingTxnScopeName, scaleRollingTxnStreamName)).value());\n+        assertEquals(0, (long) MetricRegistryUtils.getGauge(MetricsNames.SEGMENTS_MERGES, streamTags(scaleRollingTxnScopeName, scaleRollingTxnStreamName)).value());\n+\n+        transaction.flush();\n+        transaction.commit();\n+\n+        Thread.sleep(1000);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjk5MzU2Mg=="}, "originalCommit": {"oid": "dc9f01e40b5242caff16c83d7eb1246bf6115dfe"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMzY3ODMyOnYy", "diffSide": "RIGHT", "path": "controller/src/main/java/io/pravega/controller/store/stream/AbstractStreamMetadataStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwNzo0NzowN1rOGg8xww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxOTo0MzozMFrOGhZjpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIwMzM5NQ==", "bodyText": "It looks like that this code is the same as in scaleSegmentsSealed\nwhat about creating a common method ?\nI am still new with this code, maybe @shrids can give more hints", "url": "https://github.com/pravega/pravega/pull/4853#discussion_r437203395", "createdAt": "2020-06-09T07:47:07Z", "author": {"login": "eolivelli"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/AbstractStreamMetadataStore.java", "diffHunk": "@@ -494,7 +494,13 @@ public OperationContext createContext(String scope, String name) {\n     @Override\n     public CompletableFuture<Void> completeRollingTxn(String scope, String name, Map<Long, Long> sealedActiveEpochSegments,\n                                                       VersionedMetadata<CommittingTransactionsRecord> record, OperationContext context, Executor executor) {\n-        return withCompletion(getStream(scope, name, context).completeRollingTxn(sealedActiveEpochSegments, record), executor);\n+\n+        CompletableFuture<Void> future = withCompletion(getStream(scope, name, context).completeRollingTxn(sealedActiveEpochSegments, record), executor);\n+\n+        future.thenCompose(result -> findNumSplitsMerges(scope, name, context, executor).thenAccept(simpleEntry ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "787c6838e5c91717fdb51858a7b5ccfc54a65c4e"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzY3NDkxNw==", "bodyText": "No, scaleSegmentSealed updates activeSegment in addition to what rollingTxn does here.\nIf we create a common method, then we have to use if condition. In the end we may have one or two more lines of codes.", "url": "https://github.com/pravega/pravega/pull/4853#discussion_r437674917", "createdAt": "2020-06-09T19:43:30Z", "author": {"login": "kevinhan88"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/AbstractStreamMetadataStore.java", "diffHunk": "@@ -494,7 +494,13 @@ public OperationContext createContext(String scope, String name) {\n     @Override\n     public CompletableFuture<Void> completeRollingTxn(String scope, String name, Map<Long, Long> sealedActiveEpochSegments,\n                                                       VersionedMetadata<CommittingTransactionsRecord> record, OperationContext context, Executor executor) {\n-        return withCompletion(getStream(scope, name, context).completeRollingTxn(sealedActiveEpochSegments, record), executor);\n+\n+        CompletableFuture<Void> future = withCompletion(getStream(scope, name, context).completeRollingTxn(sealedActiveEpochSegments, record), executor);\n+\n+        future.thenCompose(result -> findNumSplitsMerges(scope, name, context, executor).thenAccept(simpleEntry ->", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzIwMzM5NQ=="}, "originalCommit": {"oid": "787c6838e5c91717fdb51858a7b5ccfc54a65c4e"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4374, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}