{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MzY3MDU3", "number": 4926, "title": "Issue 4925: Unit Test fix for TableMetadataTasksTest in Controller", "bodyText": "Signed-off-by: pbelgundi prajakta.belgundi@emc.com\nChange log description\n\n\nAdded implementation for test testWorkflowCompletionTimeout() in class \"controller/src/test/java/io/pravega/controller/task/KeyValueTable/TableMetadataTasksTest.java\"\nwhich tests the usecase where Create and DeleteAPI events timeout and never complete.\n\n\nChanged the handling for event timeout in CreateAPI to throw the timeout exception so it can be retried till DEADLINE_EXCEEDED. This makes Create and Delete APIs consistent with respect to their event timeout behavior.\nChanged necessary tests for this change.\n\n\nPurpose of the change\nFixes #4925", "createdAt": "2020-07-07T12:01:47Z", "url": "https://github.com/pravega/pravega/pull/4926", "merged": true, "mergeCommit": {"oid": "4afcd0bcb91abb72d86b9b4b2cb9164b461ce517"}, "closed": true, "closedAt": "2020-07-08T09:47:17Z", "author": {"login": "pbelgundi"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcykgUrgH2gAyNDQ1MzY3MDU3OmEwYjI0YjEwOGZiMzAzYjI0YjViNTBkOWE3ZGU2ODExMTg2MmNlZjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy27RzgFqTQ0NDU2NDkzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a0b24b108fb303b24b5b50d9a7de68111862cef9", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/a0b24b108fb303b24b5b50d9a7de68111862cef9", "committedDate": "2020-07-07T11:54:11Z", "message": "Unit Test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9e2ef054e2e67b6581ddf6c4c628cb6cd3f570d", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/d9e2ef054e2e67b6581ddf6c4c628cb6cd3f570d", "committedDate": "2020-07-07T12:29:02Z", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a", "committedDate": "2020-07-07T13:59:14Z", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MDU1NDgz", "url": "https://github.com/pravega/pravega/pull/4926#pullrequestreview-444055483", "createdAt": "2020-07-07T16:25:40Z", "commit": {"oid": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNjoyNTo0MVrOGuGSig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNjoyODozNlrOGuGZoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MDczMA==", "bodyText": "why is this changed?", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r450990730", "createdAt": "2020-07-07T16:25:41Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/task/KeyValueTable/TableMetadataTasks.java", "diffHunk": "@@ -143,15 +143,7 @@ public void initializeStreamWriters(final EventStreamClientFactory clientFactory\n                                        return isCreateProcessed(scope, kvtName, kvtConfig, createTimestamp, executor);\n                                  });\n                             });\n-               }, e -> Exceptions.unwrap(e) instanceof RetryableException, NUM_RETRIES, executor)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MTA2OQ==", "bodyText": "why not pass the operation context? that will avoid fetching the table names etc again from segment store", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r450991069", "createdAt": "2020-07-07T16:26:14Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/task/KeyValueTable/TableMetadataTasks.java", "diffHunk": "@@ -180,10 +172,18 @@ public void initializeStreamWriters(final EventStreamClientFactory clientFactory\n                             DeleteTableEvent deleteEvent = new DeleteTableEvent(scope, kvtName, requestId, UUID.fromString(id));\n                             return eventHelper.addIndexAndSubmitTask(deleteEvent,\n                                     () -> kvtMetadataStore.setState(scope, kvtName, KVTableState.DELETING, context, executor))\n-                                    .thenCompose(x -> eventHelper.checkDone(() -> isDeleted(scope, kvtName, context)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MTgyMA==", "bodyText": "do we want to return a failure status from here? the request may have been submitted and still ongoing in the background. right?", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r450991820", "createdAt": "2020-07-07T16:27:23Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/task/KeyValueTable/TableMetadataTasks.java", "diffHunk": "@@ -180,10 +172,18 @@ public void initializeStreamWriters(final EventStreamClientFactory clientFactory\n                             DeleteTableEvent deleteEvent = new DeleteTableEvent(scope, kvtName, requestId, UUID.fromString(id));\n                             return eventHelper.addIndexAndSubmitTask(deleteEvent,\n                                     () -> kvtMetadataStore.setState(scope, kvtName, KVTableState.DELETING, context, executor))\n-                                    .thenCompose(x -> eventHelper.checkDone(() -> isDeleted(scope, kvtName, context)))\n+                                    .thenCompose(x -> eventHelper.checkDone(() -> isDeleted(scope, kvtName)))\n                                     .thenApply(y -> DeleteKVTableStatus.Status.SUCCESS);\n                         });\n-            }), e -> Exceptions.unwrap(e) instanceof RetryableException, NUM_RETRIES, executor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MjAwMg==", "bodyText": "why is this being removed?", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r450992002", "createdAt": "2020-07-07T16:27:40Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/task/KeyValueTable/TableMetadataTasks.java", "diffHunk": "@@ -204,7 +204,7 @@ public void initializeStreamWriters(final EventStreamClientFactory clientFactory\n                                                 false, delegationToken, requestId), executor));\n     }\n \n-    private CompletableFuture<Boolean> isDeleted(String scope, String kvtName, KVTOperationContext context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk5MjU0NQ==", "bodyText": "same here -- comparing the kvt config will determine if the create was actually performed with the supplied config or a different one from a concurrent request that got executed first.", "url": "https://github.com/pravega/pravega/pull/4926#discussion_r450992545", "createdAt": "2020-07-07T16:28:36Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/task/KeyValueTable/TableMetadataTasks.java", "diffHunk": "@@ -220,7 +220,7 @@ public void initializeStreamWriters(final EventStreamClientFactory clientFactory\n                                                                                   KeyValueTableConfiguration kvtConfig,\n                                                                                   final long createTimestamp,\n                                                                                   Executor executor) {\n-        return eventHelper.checkDone(() -> isCreated(scope, kvtName, kvtConfig, executor))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3c3ca2e3c923ef4c1048fcb485892c2a5374e1a"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a93bc5ce45650adec9ed8f414211ce505dd2eff8", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/a93bc5ce45650adec9ed8f414211ce505dd2eff8", "committedDate": "2020-07-07T17:05:38Z", "message": "fix failing test\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d2e5c308d924d76467cd3e3de5f9269b0bb130a", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/7d2e5c308d924d76467cd3e3de5f9269b0bb130a", "committedDate": "2020-07-07T17:40:19Z", "message": "changed handling of timeout\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25a2ef84c1a875ab521d2f82d583e4165cb973dd", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/25a2ef84c1a875ab521d2f82d583e4165cb973dd", "committedDate": "2020-07-07T17:54:29Z", "message": "EventHelperMock test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c142634d1062a907601062a5c3c67b604f248447", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/c142634d1062a907601062a5c3c67b604f248447", "committedDate": "2020-07-08T05:36:50Z", "message": "test fix as per code review comments\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a30e91f21be76416506e9cffc839363f85199b4", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/2a30e91f21be76416506e9cffc839363f85199b4", "committedDate": "2020-07-08T06:15:32Z", "message": "minor changes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NTY0OTM5", "url": "https://github.com/pravega/pravega/pull/4926#pullrequestreview-444564939", "createdAt": "2020-07-08T09:21:55Z", "commit": {"oid": "2a30e91f21be76416506e9cffc839363f85199b4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3949, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}