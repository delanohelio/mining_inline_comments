{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwNzE2MzE0", "number": 5148, "title": "Issue 5147: Added check for service in init_kubernetes.sh script", "bodyText": "Signed-off-by: prabhaker24 prabhaker.saxena@dell.com\nChange log description\ninit_kubernetes.sh script is not handling the case where ss pod might come up before the service when External Access is enabled and that's causing a problem when domainName is specified in the pravega manifest as in that case ss pods might get the wrong publishedIPAddress.\nPurpose of the change\nFixes #5147\nWhat the code does\nScript checks for the presence of service in case we deploy pravega with external service enabled and when it finds the service then only it will set the publishedIPAddress.\nWhen a service doesn't exists segment store pod will go into CrashLoopBackOff state and will be in that state only till the External service comes up post the service starts segment store pod will also recover and will set the correct publishedIPAddress.\nHow to verify it\n\nDeploy Pravega with external access enabled and delete service continuously and delete the pod once when the new pod comes up it will go into CrashLoopBackOff state and will wait continuously for the service to be there and will have the following message in its logs\n\nFailed to get External Service. Exiting...\n\n\nnow stop deleting the service and the service will come up post that ss pod will recover and will get the correct publishedIPAddress.\nI have checked both of the above scenarios.", "createdAt": "2020-09-06T10:19:34Z", "url": "https://github.com/pravega/pravega/pull/5148", "merged": true, "mergeCommit": {"oid": "c431acd777914d89f58f356115418441df6d4107"}, "closed": true, "closedAt": "2020-09-07T12:02:37Z", "author": {"login": "Prabhaker24"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGLmrZgH2gAyNDgwNzE2MzE0OjdhMjViMmVhZTRlZWJjYzBiNDQ2YzkzYTdkZTBhODRlMGJiZDFhNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGhtt5gFqTQ4MzQ5ODgxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7a25b2eae4eebcc0b446c93a7de0a84e0bbd1a42", "author": {"user": null}, "url": "https://github.com/pravega/pravega/commit/7a25b2eae4eebcc0b446c93a7de0a84e0bbd1a42", "committedDate": "2020-09-06T10:11:59Z", "message": "added check for service in init_kubernetes.sh script\n\nSigned-off-by: prabhaker24 <prabhaker.saxena@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "183fe83d0a598a19f01f1c9ff8f916e0ccc02c2f", "author": {"user": null}, "url": "https://github.com/pravega/pravega/commit/183fe83d0a598a19f01f1c9ff8f916e0ccc02c2f", "committedDate": "2020-09-06T10:43:54Z", "message": "made service variable local\n\nSigned-off-by: prabhaker24 <prabhaker.saxena@dell.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMjAyNzg3", "url": "https://github.com/pravega/pravega/pull/5148#pullrequestreview-483202787", "createdAt": "2020-09-07T02:01:41Z", "commit": {"oid": "183fe83d0a598a19f01f1c9ff8f916e0ccc02c2f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6eea95da722eb471ecb13d0717fd5d64d6b6762", "author": {"user": null}, "url": "https://github.com/pravega/pravega/commit/b6eea95da722eb471ecb13d0717fd5d64d6b6762", "committedDate": "2020-09-07T04:19:10Z", "message": "changed indentation\n\nSigned-off-by: prabhaker24 <prabhaker.saxena@dell.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMjQ3NzEw", "url": "https://github.com/pravega/pravega/pull/5148#pullrequestreview-483247710", "createdAt": "2020-09-07T05:21:13Z", "commit": {"oid": "b6eea95da722eb471ecb13d0717fd5d64d6b6762"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNToyMToxM1rOHNwgFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNToyMToxM1rOHNwgFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE4ODE4Mg==", "bodyText": "as discussed with Ravi, I see this as a Precondition check before starting Segment store. And the startup  on k8s should not happen if the precondition fails.", "url": "https://github.com/pravega/pravega/pull/5148#discussion_r484188182", "createdAt": "2020-09-07T05:21:13Z", "author": {"login": "shrids"}, "path": "docker/pravega/scripts/init_kubernetes.sh", "diffHunk": "@@ -47,6 +47,13 @@ init_kubernetes() {\n         local podname=${POD_NAME}\n         export PUBLISHED_ADDRESS=\"\"\n         export PUBLISHED_PORT=\"\"\n+        local service=$( k8 \"${ns}\" \"services\" \"${podname}\" .kind )\n+\n+        while [[  \"$service\" != \"Service\" ]]; ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6eea95da722eb471ecb13d0717fd5d64d6b6762"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0cd9b1a8f0cdd84e5086f59758cfcaf314be905", "author": {"user": null}, "url": "https://github.com/pravega/pravega/commit/c0cd9b1a8f0cdd84e5086f59758cfcaf314be905", "committedDate": "2020-09-07T05:46:16Z", "message": "removed loop and added exit condition\n\nSigned-off-by: prabhaker24 <prabhaker.saxena@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90d4f324c7670f9472a6bf830b8e92a6eadc8b6d", "author": {"user": null}, "url": "https://github.com/pravega/pravega/commit/90d4f324c7670f9472a6bf830b8e92a6eadc8b6d", "committedDate": "2020-09-07T06:12:39Z", "message": "removed loop added exit statement\n\nSigned-off-by: prabhaker24 <prabhaker.saxena@dell.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMjc5ODMz", "url": "https://github.com/pravega/pravega/pull/5148#pullrequestreview-483279833", "createdAt": "2020-09-07T06:46:39Z", "commit": {"oid": "90d4f324c7670f9472a6bf830b8e92a6eadc8b6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDk4ODE4", "url": "https://github.com/pravega/pravega/pull/5148#pullrequestreview-483498818", "createdAt": "2020-09-07T11:57:35Z", "commit": {"oid": "90d4f324c7670f9472a6bf830b8e92a6eadc8b6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3849, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}