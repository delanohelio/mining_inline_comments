{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2Mzk5NjI4", "number": 5368, "title": "Issue 5356 : Make Consumption based retention implicit on Subscriber Stream-Cut publish.", "bodyText": "Change log description\nMake Consumption based retention implicit on Reader Groups publishing Stream-Cuts to Controller instead of an explicit Stream Retention-Policy on Controller.\nAdd maxLimit to Time/Space Retention Policies.\nPurpose of the change\nFixes #5356\nWhat the code does\n\nRemove Retention-Policy Type \"CONSUMPTION\"  and make consumption based retention implicit when Subscribers have published Stream-Cuts for truncation.\nAdd a max limit to Time and Space based retention policy.\n\nHow to verify it\nAll unit and Integration Tests should pass.", "createdAt": "2020-11-24T11:08:53Z", "url": "https://github.com/pravega/pravega/pull/5368", "merged": true, "mergeCommit": {"oid": "27f354bc611bc49566a2df22b4c5a6353d3fd530"}, "closed": true, "closedAt": "2020-12-02T08:35:54Z", "author": {"login": "pbelgundi"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfnpjFAH2gAyNTI2Mzk5NjI4OjFlYjIzZGEwNDMwNTk3NDI0NTc5NWVhZDk2ODg0OWIxNmI4MDdiZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdh6nmYgFqTU0MTkzMzMyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1eb23da04305974245795ead968849b16b807bed", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/1eb23da04305974245795ead968849b16b807bed", "committedDate": "2020-11-24T11:00:34Z", "message": "first draft\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fabaad3fba2b3907213c2558e3221c90037f5a7", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/4fabaad3fba2b3907213c2558e3221c90037f5a7", "committedDate": "2020-11-24T11:02:22Z", "message": "merge from master\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NzExMzYw", "url": "https://github.com/pravega/pravega/pull/5368#pullrequestreview-537711360", "createdAt": "2020-11-24T16:48:30Z", "commit": {"oid": "4fabaad3fba2b3907213c2558e3221c90037f5a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjo0ODozMFrOH5L2WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjo0ODozMFrOH5L2WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTcyNTAxNg==", "bodyText": "please dont change the name of the variable otherwise anyone using retention policy in their application would have to recompile their code.", "url": "https://github.com/pravega/pravega/pull/5368#discussion_r529725016", "createdAt": "2020-11-24T16:48:30Z", "author": {"login": "shiveshr"}, "path": "client/src/main/java/io/pravega/client/stream/RetentionPolicy.java", "diffHunk": "@@ -33,18 +32,13 @@\n         /**\n          * Set retention based on the total size of the data in the stream in bytes.\n          */\n-        SIZE,\n-\n-        /**\n-         * Set retention policy based on Consumption.\n-         * Also see: {@link ReaderGroupConfig.StreamDataRetention}\n-         */\n-        CONSUMPTION\n+        SIZE\n     }\n \n     private final RetentionType retentionType;\n-    private final long retentionParam;\n-    private final ConsumptionLimits consumptionLimits;\n+    private final long retentionMin;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fabaad3fba2b3907213c2558e3221c90037f5a7"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33182bf3bd881b8942132a8db3ca79e2c9e7d90a", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/33182bf3bd881b8942132a8db3ca79e2c9e7d90a", "committedDate": "2020-11-26T07:57:33Z", "message": "code review changes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f656e764fc9d1a5f333b391ca50ac264f4bff1ad", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/f656e764fc9d1a5f333b391ca50ac264f4bff1ad", "committedDate": "2020-11-26T09:01:36Z", "message": "changes for bug fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7b05ff0c3d980be864c82fd51efbe6636a6c317", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/d7b05ff0c3d980be864c82fd51efbe6636a6c317", "committedDate": "2020-11-26T09:05:03Z", "message": "spotbugsFix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad2bb1a51649ad4f0e73687c71c08007ba66cf70", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/ad2bb1a51649ad4f0e73687c71c08007ba66cf70", "committedDate": "2020-11-26T09:55:01Z", "message": "bug fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9bc46bc5860ca3f6ce950ddb8ff5bf068927803", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/b9bc46bc5860ca3f6ce950ddb8ff5bf068927803", "committedDate": "2020-11-26T09:59:41Z", "message": "code fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa436b25a0d656e9a7809592a81e4145cec251e7", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/fa436b25a0d656e9a7809592a81e4145cec251e7", "committedDate": "2020-11-26T11:42:59Z", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54842e88247f4a2cb09ad9773b60eb936859f3b9", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/54842e88247f4a2cb09ad9773b60eb936859f3b9", "committedDate": "2020-11-26T11:43:21Z", "message": "Merge remote-tracking branch 'upstream/master' into issue-5356-cbr-default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6970495636cf557ff5359020e7bb490323768f17", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/6970495636cf557ff5359020e7bb490323768f17", "committedDate": "2020-11-26T14:43:29Z", "message": "checkstyle fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee0fe6f782970c3780b6e26c94faa546ad1deb57", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/ee0fe6f782970c3780b6e26c94faa546ad1deb57", "committedDate": "2020-11-27T06:17:02Z", "message": "test fixes\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5beda6c847edd1b1e42c4cfcd00c30cf0e2055ca", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/5beda6c847edd1b1e42c4cfcd00c30cf0e2055ca", "committedDate": "2020-11-27T06:32:05Z", "message": "fix store test\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ec0077201566144038ceba5fe4858af1f4f9328", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/7ec0077201566144038ceba5fe4858af1f4f9328", "committedDate": "2020-11-27T07:53:27Z", "message": "fixed ZkStreamMetadataTasksTest\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzQxMjQ2", "url": "https://github.com/pravega/pravega/pull/5368#pullrequestreview-540341246", "createdAt": "2020-11-28T04:11:14Z", "commit": {"oid": "7ec0077201566144038ceba5fe4858af1f4f9328"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQwNDoxMToxNFrOH7M08Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQwNDoxMToxNFrOH7M08Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTgzODE5Mw==", "bodyText": "this should also take max and set it. same for size based.", "url": "https://github.com/pravega/pravega/pull/5368#discussion_r531838193", "createdAt": "2020-11-28T04:11:14Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/server/rest/ModelHelper.java", "diffHunk": "@@ -67,9 +66,6 @@ public static final StreamConfiguration getCreateStreamConfig(final CreateStream\n                     retentionPolicy = getRetentionPolicy(createStreamRequest.getRetentionPolicy().getTimeBasedRetention(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ec0077201566144038ceba5fe4858af1f4f9328"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwMzQxMzQx", "url": "https://github.com/pravega/pravega/pull/5368#pullrequestreview-540341341", "createdAt": "2020-11-28T04:13:14Z", "commit": {"oid": "7ec0077201566144038ceba5fe4858af1f4f9328"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ac6a96c1537341b66a7569a47615ef72c9891b8", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/4ac6a96c1537341b66a7569a47615ef72c9891b8", "committedDate": "2020-11-30T06:37:40Z", "message": "REST API fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51d4e1d59f6ab726613655f8617ed9ad4f204c3b", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/51d4e1d59f6ab726613655f8617ed9ad4f204c3b", "committedDate": "2020-11-30T06:37:59Z", "message": "Merge remote-tracking branch 'upstream/master' into issue-5356-cbr-default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1d9ddbedc23a273c22aef1eb1dfff71dae048c7", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/b1d9ddbedc23a273c22aef1eb1dfff71dae048c7", "committedDate": "2020-11-30T06:57:17Z", "message": "minor change\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNzAwNzk2", "url": "https://github.com/pravega/pravega/pull/5368#pullrequestreview-540700796", "createdAt": "2020-11-30T08:51:17Z", "commit": {"oid": "b1d9ddbedc23a273c22aef1eb1dfff71dae048c7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODo1MToxN1rOH7xCZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwODo1MToxN1rOH7xCZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQzMTQ2Mw==", "bodyText": "shouldnt this check simply be:\ncreateStreamRequest.getRetentionPolicy().getMaxTimeBasedRetention() != null)\n\notherwise this access attempt itself can throw NPE.\nNote: this is json derialization happening here, so the maxTimeBasedRetention will be defaulted to null if its not specified in the json payload.", "url": "https://github.com/pravega/pravega/pull/5368#discussion_r532431463", "createdAt": "2020-11-30T08:51:17Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/server/rest/ModelHelper.java", "diffHunk": "@@ -60,15 +59,29 @@ public static final StreamConfiguration getCreateStreamConfig(final CreateStream\n         if (createStreamRequest.getRetentionPolicy() != null) {\n             switch (createStreamRequest.getRetentionPolicy().getType()) {\n                 case LIMITED_SIZE_MB:\n-                    retentionPolicy = RetentionPolicy.bySizeBytes(\n-                            createStreamRequest.getRetentionPolicy().getValue() * 1024 * 1024);\n+                    if (createStreamRequest.getRetentionPolicy().getMaxValue() == 0) {\n+                        // max value is not specified\n+                        retentionPolicy = RetentionPolicy.bySizeBytes(\n+                                createStreamRequest.getRetentionPolicy().getValue() * MB_TO_BYTES);\n+                    } else {\n+                        retentionPolicy = RetentionPolicy.bySizeBytes(\n+                                createStreamRequest.getRetentionPolicy().getValue() * MB_TO_BYTES,\n+                                createStreamRequest.getRetentionPolicy().getMaxValue() * MB_TO_BYTES);\n+                    }\n                     break;\n                 case LIMITED_DAYS:\n-                    retentionPolicy = getRetentionPolicy(createStreamRequest.getRetentionPolicy().getTimeBasedRetention(),\n-                            createStreamRequest.getRetentionPolicy().getValue());\n-                    break;\n-                case CONSUMPTION:\n-                    retentionPolicy = getConsumptionRetentionPolicy(createStreamRequest.getRetentionPolicy().getConsumptionLimits());\n+                    if (createStreamRequest.getRetentionPolicy().getMaxValue() == 0\n+                        && createStreamRequest.getRetentionPolicy().getMaxTimeBasedRetention().getDays() == 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b1d9ddbedc23a273c22aef1eb1dfff71dae048c7"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83260a48edc7bec79aeb96cc061458442e99ab43", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/83260a48edc7bec79aeb96cc061458442e99ab43", "committedDate": "2020-11-30T09:54:04Z", "message": "test fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cda054510b18dee4b39bff1abb9e613fe4591073", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/cda054510b18dee4b39bff1abb9e613fe4591073", "committedDate": "2020-11-30T09:54:20Z", "message": "Merge remote-tracking branch 'upstream/master' into issue-5356-cbr-default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a81d66481a4cac13148bce7123022316b1d450ab", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/a81d66481a4cac13148bce7123022316b1d450ab", "committedDate": "2020-11-30T11:20:38Z", "message": "checkstyle fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a81c18f52787237cf379629460f6414c9189374f", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/a81c18f52787237cf379629460f6414c9189374f", "committedDate": "2020-12-01T04:06:08Z", "message": "checkstyle fix\n\nSigned-off-by: pbelgundi <prajakta.belgundi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29c9c557378f8ebff040f2c75329e00700b947ca", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/29c9c557378f8ebff040f2c75329e00700b947ca", "committedDate": "2020-12-01T04:06:28Z", "message": "Merge remote-tracking branch 'upstream/master' into issue-5356-cbr-default"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4501a6071710516632ac7e008fd4eb90ef1e783", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/b4501a6071710516632ac7e008fd4eb90ef1e783", "committedDate": "2020-12-01T09:46:15Z", "message": "Merge remote-tracking branch 'upstream/master' into issue-5356-cbr-default"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxOTMzMzIx", "url": "https://github.com/pravega/pravega/pull/5368#pullrequestreview-541933321", "createdAt": "2020-12-01T14:14:29Z", "commit": {"oid": "b4501a6071710516632ac7e008fd4eb90ef1e783"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3755, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}