{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1ODI4NzU3", "number": 4655, "title": "Issue 4653: Control rate of parallel Segment Container recoveries", "bodyText": "Change log description\nEnforces sequential start of containers to prevent multiple concurrent container recoveries from overloading the cache.\nPurpose of the change\nFixes #4653.\nWhat the code does\nUntil now, a Segment Store could start Segment Containers in parallel, which also includes the process of recovery in the case that the Segment Container to start is not new. However, if we think about a Segment Store recovering in parallel multiple Segment Containers, it may be the case that the data to process for each container is larger than the size of the cache (not to mention that the cache can still be used by other containers). This PR mainly serializes the execution of Segment Container starts with the main objective of preventing overloading the cache.\nTo this end, this PR includes the following changes:\n\nIn ZKSegmentContainerMonitor, we use the existing class OrderedItemProcessor to serialize the executions of startContainer method.\nThe behavior of OrderedItemProcessor was by default to shut down the processor in case of an exception being thrown by any of the items being processed. While the default behavior remains the same, we added to this class a flag (closeOnException) to tolerate exceptions while processing items to continue processing the remaining ones. In our case, we want to start all the containers possible, even in the case that one/few of the containers have problems (i.e., startContainer throws an exception), which could be retried.\n\nHow to verify it\nAdded a new test to OrderedItemProcessor to verify the behavior of closeOnException. The rest of tests for are passing, including system tests (build 2730).", "createdAt": "2020-03-30T18:41:36Z", "url": "https://github.com/pravega/pravega/pull/4655", "merged": true, "mergeCommit": {"oid": "d3092fa877052256b9e854af27c6683294f753de"}, "closed": true, "closedAt": "2020-04-03T10:24:11Z", "author": {"login": "RaulGracia"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTU0GTgH2gAyMzk1ODI4NzU3OmMzZjNjZDkyYjZmNmRiNzQzNmRiOGQ1MDdiZmEzNzU4MTlkNDY1ZGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcT720RgH2gAyMzk1ODI4NzU3OjI1Yzc0NDI3YjUyN2U3YTAwYTJlYzc2N2I0NWY4OGU3ZWQ4ODM5MDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c3f3cd92b6f6db7436db8d507bfa375819d465dd", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/c3f3cd92b6f6db7436db8d507bfa375819d465dd", "committedDate": "2020-04-01T10:05:39Z", "message": "Make Segment Containers to start and recover sequentially.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "174993a8c5a1b6327ec353c63f589c023b7b0121", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/174993a8c5a1b6327ec353c63f589c023b7b0121", "committedDate": "2020-04-01T10:05:39Z", "message": "Issue 4653: Remove unused import.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1966b2529adac382877c29eb307b47b4ca764776", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/1966b2529adac382877c29eb307b47b4ca764776", "committedDate": "2020-04-01T10:05:40Z", "message": "Issue 4653: Added option to the behavior of OrderedItemProcessor to enable it tolerating exceptions from processed items and continue processing without closing.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4efb70fe5d5c8a69a92b857b1f9d0bd01293ba64", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/4efb70fe5d5c8a69a92b857b1f9d0bd01293ba64", "committedDate": "2020-04-01T10:05:40Z", "message": "Issue 4653: Minor comments in test.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fba8dea7022eb5ded7b7428245f15d42a15bea39", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/fba8dea7022eb5ded7b7428245f15d42a15bea39", "committedDate": "2020-04-01T10:05:40Z", "message": "Issue 4653: Added comment on constructor.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "fba8dea7022eb5ded7b7428245f15d42a15bea39", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/fba8dea7022eb5ded7b7428245f15d42a15bea39", "committedDate": "2020-04-01T10:05:40Z", "message": "Issue 4653: Added comment on constructor.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1Nzc0ODU3", "url": "https://github.com/pravega/pravega/pull/4655#pullrequestreview-385774857", "createdAt": "2020-04-01T16:57:06Z", "commit": {"oid": "fba8dea7022eb5ded7b7428245f15d42a15bea39"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNjo1NzowNlrOF_J4jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNjo1NzowNlrOF_J4jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc2NjU0Mg==", "bodyText": "I would feel much better if we made this number configurable. Let's try to do that.", "url": "https://github.com/pravega/pravega/pull/4655#discussion_r401766542", "createdAt": "2020-04-01T16:57:06Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/ZKSegmentContainerMonitor.java", "diffHunk": "@@ -98,6 +102,9 @@\n         this.hostContainerMapNode = new NodeCache(zkClient, clusterPath);\n         this.assigmentTask = new AtomicReference<>();\n         this.lastReportTime = new AtomicLong(CURRENT_TIME_MILLIS.get());\n+        // Allow OrderedItemProcessor to throw exceptions, as they may happen while starting containers. But we want to\n+        // continue processing subsequent container starts irrespective of such failures.\n+        this.startContainerOrderedProcessor = new OrderedItemProcessor<>(1, this::startContainer, false, this.executor);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fba8dea7022eb5ded7b7428245f15d42a15bea39"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b3b13941a19613d32322e0722b9ed0b36f6d91b", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/6b3b13941a19613d32322e0722b9ed0b36f6d91b", "committedDate": "2020-04-02T10:47:41Z", "message": "Issue 4653: Make number parallel container starts configurable.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7812b923498619a1d1c5c236343ae22b2d99791b", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/7812b923498619a1d1c5c236343ae22b2d99791b", "committedDate": "2020-04-02T11:21:02Z", "message": "Issue 4653: Fixed tests.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NTIwNDkz", "url": "https://github.com/pravega/pravega/pull/4655#pullrequestreview-386520493", "createdAt": "2020-04-02T15:06:33Z", "commit": {"oid": "7812b923498619a1d1c5c236343ae22b2d99791b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25c74427b527e7a00a2ec767b45f88e7ed883901", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/25c74427b527e7a00a2ec767b45f88e7ed883901", "committedDate": "2020-04-03T07:34:55Z", "message": "Merge branch 'master' into issue-4653-sequential-container-recovery"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3651, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}