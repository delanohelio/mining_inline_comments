{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MzA4MTYz", "number": 4983, "title": "Issue 4982: Fix batch calculation in client", "bodyText": "Change log description\nReverted calculation of appendsInBatch as it was before to fix the latency problem with multiple segments and low throughput rates.\nPurpose of the change\nFixes #4982.\nWhat the code does\nThis PR addressed the comment in #4873 (comment) as it was initially validated; that is, completely reverting the calculation of appendsInBatch as it was before.\nNote that while the batching algorithm can be improved in the future, this provides us a good baseline for 0.8.\nHow to verify it\nValidated that latency now is good for multiple segments. All other tests should be passing as before.", "createdAt": "2020-07-27T17:44:01Z", "url": "https://github.com/pravega/pravega/pull/4983", "merged": true, "mergeCommit": {"oid": "1824322da9e2e38ebb797fe2e35aab9d50ff737c"}, "closed": true, "closedAt": "2020-08-05T09:48:18Z", "author": {"login": "RaulGracia"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5DJO_AH2gAyNDU3MzA4MTYzOmZjN2UzMjhhZWY5YTIyNGM0N2E0ZDkyYmYzZmE2OTNmNzQwMzUyYzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7u0BSAFqTQ2MTIzMjUyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc7e328aef9a224c47a4d92bf3fa693f740352c8", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/fc7e328aef9a224c47a4d92bf3fa693f740352c8", "committedDate": "2020-07-27T14:59:34Z", "message": "Fix calculation of appendsInBatch.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/ecf2946cb0359c0110cfa7cf348ee843eaaa90b2", "committedDate": "2020-07-28T15:42:23Z", "message": "Fixed test.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NzA5MjQ2", "url": "https://github.com/pravega/pravega/pull/4983#pullrequestreview-457709246", "createdAt": "2020-07-29T16:51:56Z", "commit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNjo1MTo1N1rOG5BV8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNjo1MzozM1rOG5BZrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDAxOQ==", "bodyText": "If this test is failing something is wrong.", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r462444019", "createdAt": "2020-07-29T16:51:57Z", "author": {"login": "tkaitchuck"}, "path": "client/src/test/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerTest.java", "diffHunk": "@@ -68,7 +68,7 @@ public void testReasonableLowerBound() {\n                 tracker.recordAck(i-100);\n             }\n         }\n-        assertTrue(tracker.getAppendBlockSize() >= size * 50);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDYwOQ==", "bodyText": "If the problem here is the max of 1 then why not remove that rather than deleting the value which means that BASE_TIME_NANOS cannot be configured?", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r462444609", "createdAt": "2020-07-29T16:52:55Z", "author": {"login": "tkaitchuck"}, "path": "client/src/main/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerImpl.java", "diffHunk": "@@ -89,8 +89,7 @@ public int getAppendBlockSize() {\n         }\n         double nanosPerAppend = nanosBetweenAppends.getCurrentValue();\n         double appendsInMaxBatchTime = Math.max(1.0, (MAX_BATCH_TIME_MILLIS * NANOS_PER_MILLI) / nanosPerAppend);\n-        double appendsInTime = Math.max(1.0, BASE_TIME_NANOS / nanosPerAppend);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjQ0NDk3Mg==", "bodyText": "If 1 event is a problem, perhaps a batch size of 0 would be better in these cases. So maybe change this 1 to 0.", "url": "https://github.com/pravega/pravega/pull/4983#discussion_r462444972", "createdAt": "2020-07-29T16:53:33Z", "author": {"login": "tkaitchuck"}, "path": "client/src/main/java/io/pravega/client/connection/impl/AppendBatchSizeTrackerImpl.java", "diffHunk": "@@ -89,8 +89,7 @@ public int getAppendBlockSize() {\n         }\n         double nanosPerAppend = nanosBetweenAppends.getCurrentValue();\n         double appendsInMaxBatchTime = Math.max(1.0, (MAX_BATCH_TIME_MILLIS * NANOS_PER_MILLI) / nanosPerAppend);\n-        double appendsInTime = Math.max(1.0, BASE_TIME_NANOS / nanosPerAppend);\n-        double appendsInBatch = MathHelpers.minMax(appendsOutstanding.getCurrentValue() * OUTSTANDING_FRACTION + appendsInTime, 1.0, appendsInMaxBatchTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecf2946cb0359c0110cfa7cf348ee843eaaa90b2"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4c4f0e3b28c5d0f481df90a332097377771024a", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/c4c4f0e3b28c5d0f481df90a332097377771024a", "committedDate": "2020-07-29T16:55:46Z", "message": "Merge branch 'master' into issue-4982-fix-batching"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c26d9e66e104cf8a1aa17fc7a1acc9e6fbe07029", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/c26d9e66e104cf8a1aa17fc7a1acc9e6fbe07029", "committedDate": "2020-07-29T17:19:11Z", "message": "Set appendsInTime effectively to 0 keeping existing structure.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d42b8fd858e7a802eb2bd107496b570f9f08a743", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/d42b8fd858e7a802eb2bd107496b570f9f08a743", "committedDate": "2020-07-30T07:53:59Z", "message": "Merge branch 'master' into issue-4982-fix-batching"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f7c6e66c7eb6871a2d74c4b14c627c531ce6e0f", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/4f7c6e66c7eb6871a2d74c4b14c627c531ce6e0f", "committedDate": "2020-08-02T15:06:43Z", "message": "Merge branch 'master' into issue-4982-fix-batching"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c461b8cfc953b6a892e4e1a333954b3374d9fa4d", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/c461b8cfc953b6a892e4e1a333954b3374d9fa4d", "committedDate": "2020-08-02T21:47:52Z", "message": "Changed assertion in test as per PR feedback\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dbcfb0f589644b4fe7b4e55455ce34377493d83", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/9dbcfb0f589644b4fe7b4e55455ce34377493d83", "committedDate": "2020-08-04T07:34:04Z", "message": "Merge branch 'master' into issue-4982-fix-batching"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5c10a91a9bf704443ef02b2693eb1b42a04bfc1", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/c5c10a91a9bf704443ef02b2693eb1b42a04bfc1", "committedDate": "2020-08-04T17:46:01Z", "message": "Merge branch 'master' into issue-4982-fix-batching"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffbb3f9391307e5f3bf6a28df8d6605706645a5d", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/ffbb3f9391307e5f3bf6a28df8d6605706645a5d", "committedDate": "2020-08-04T21:24:02Z", "message": "Merge branch 'master' into issue-4982-fix-batching"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMjMyNTIy", "url": "https://github.com/pravega/pravega/pull/4983#pullrequestreview-461232522", "createdAt": "2020-08-04T23:00:04Z", "commit": {"oid": "ffbb3f9391307e5f3bf6a28df8d6605706645a5d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3984, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}