{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNzczMzU2", "number": 5092, "title": "Issue 5058: Cache Manager Metrics Fix", "bodyText": "Change log description\n\nMake  the metric an instance field instead of a static field.\nClean up meters alongside registries during startWithoutExporting\n\nPurpose of the change\n\nFixes #5058\n\nWhat the code does\nIt addresses two problems without our metric implementation:\n\nIt does not seem static metrics can work reliably, as these metrics will often resolve to a NullStatsLogger as MetricsProvider.initialize() may not have been called before the class has been loaded. I believe that the metric defined above will also be susceptible to this issue, but is not tested against.\nAs noted in the io.micrometer.Meter comments, removing a registry from a CompositeRegistry (Metrics.globalRegistry) does not remove it from the meterMap of said CompositeRegistry. The problem is that the internal meterMap of the CompositeRegistry is what the search (Metrics.globalRegistry.find) is performed on (and will return a 0 value (in the case of a counter). This may be expected, but seemingly can be problematic as we cannot differentiate between a 'DNE' 0 and a reported 0 value.\n\nHow to verify it\n(Optional: steps to verify that the changes are effective)", "createdAt": "2020-08-21T18:10:05Z", "url": "https://github.com/pravega/pravega/pull/5092", "merged": true, "mergeCommit": {"oid": "f60ac1a1e28f7fd1082e4ded8875b7c253d886e0"}, "closed": true, "closedAt": "2020-08-28T23:05:17Z", "author": {"login": "co-jo"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBI0lPAH2gAyNDcxNzczMzU2OjE4ODIxOTU2Y2MxMmQ0MmRiMTIxOGZlYjViNzBlY2YxOTQzNjEyZDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDbCdiAFqTQ3ODAwNzc4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "18821956cc12d42db1218feb5b70ecf1943612d4", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/18821956cc12d42db1218feb5b70ecf1943612d4", "committedDate": "2020-08-21T18:07:50Z", "message": "* Fixes issue 5058.\n\nSigned-off-by: Colin Hryniowski <co-jo@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3330860ed2fe8c7f5bf6efbd12e021d7ef5761f", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/f3330860ed2fe8c7f5bf6efbd12e021d7ef5761f", "committedDate": "2020-08-21T18:10:14Z", "message": "Merge branch 'master' into issue-5058-cache-manager-metrics-patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bf8016017508da6537c09cc9f1c183d73776f2d", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/8bf8016017508da6537c09cc9f1c183d73776f2d", "committedDate": "2020-08-21T20:09:03Z", "message": "* Fix checkstyle error.\n\nSigned-off-by: Colin Hryniowski <co-jo@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "786b3804c9fb3ca50a11018bb58ab4c795fafc4d", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/786b3804c9fb3ca50a11018bb58ab4c795fafc4d", "committedDate": "2020-08-21T20:09:19Z", "message": "Merge remote-tracking branch 'origin/issue-5058-cache-manager-metrics-patch' into issue-5058-cache-manager-metrics-patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79fcfa4f3bf99f5e7ed87ecb5ec39c06bfc0ef63", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/79fcfa4f3bf99f5e7ed87ecb5ec39c06bfc0ef63", "committedDate": "2020-08-25T18:04:53Z", "message": "* Remove removal of Meters -- as it may have unforeseen side effects.\n\nSigned-off-by: Colin Hryniowski <co-jo@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a609ae5b9b817aec490eb43505f04277ce70600", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/7a609ae5b9b817aec490eb43505f04277ce70600", "committedDate": "2020-08-25T18:07:16Z", "message": "Merge branch 'master' into issue-5058-cache-manager-metrics-patch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NTkwNDk3", "url": "https://github.com/pravega/pravega/pull/5092#pullrequestreview-475590497", "createdAt": "2020-08-26T15:12:05Z", "commit": {"oid": "7a609ae5b9b817aec490eb43505f04277ce70600"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNToxMjowNlrOHHQ23w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNToxMjowNlrOHHQ23w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3ODI3MQ==", "bodyText": "Please wait sufficient time before assertion using assert utility tools, or retry a few times here, otherwise when the testing env is slow/busy, the test may fail again from time to time.", "url": "https://github.com/pravega/pravega/pull/5092#discussion_r477378271", "createdAt": "2020-08-26T15:12:06Z", "author": {"login": "kevinhan88"}, "path": "segmentstore/server/src/test/java/io/pravega/segmentstore/server/SegmentStoreMetricsTests.java", "diffHunk": "@@ -161,30 +161,30 @@ public void testThrottlerMetrics() {\n \n     @Test\n     public void testCacheManagerMetrics() {\n-        int storedBytes = 10000;\n-        int usedBytes = 1000;\n-        int allocatedBytes = 100;\n+        long storedBytes = 10000;\n+        long usedBytes = 1000;\n+        long allocatedBytes = 100;\n         int generationSpread = 10;\n-        int managerIterationDuration = 1;\n+        long managerIterationDuration = 1;\n \n         int containerId = new Random().nextInt(Integer.MAX_VALUE);\n         @Cleanup\n         SegmentStoreMetrics.CacheManager cache = new SegmentStoreMetrics.CacheManager();\n         cache.report(new CacheState(storedBytes, usedBytes, 0, allocatedBytes, storedBytes), generationSpread, managerIterationDuration);\n \n-        assertEquals(storedBytes, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_STORED_SIZE_BYTES).value());\n-        assertEquals(usedBytes, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_USED_SIZE_BYTES).value());\n-        assertEquals(allocatedBytes, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_ALLOC_SIZE_BYTES).value());\n+        assertEquals(storedBytes, (long) MetricRegistryUtils.getGauge(MetricsNames.CACHE_STORED_SIZE_BYTES).value());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a609ae5b9b817aec490eb43505f04277ce70600"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NTkxODEx", "url": "https://github.com/pravega/pravega/pull/5092#pullrequestreview-475591811", "createdAt": "2020-08-26T15:13:26Z", "commit": {"oid": "7a609ae5b9b817aec490eb43505f04277ce70600"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNToxMzoyNlrOHHQ6ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxNToxMzoyNlrOHHQ6ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM3OTI2Nw==", "bodyText": "Similarly, wait sufficient time (or retry) before the null check - this is the reason why the test always pass locally but sometimes fail in a loaded env.", "url": "https://github.com/pravega/pravega/pull/5092#discussion_r477379267", "createdAt": "2020-08-26T15:13:26Z", "author": {"login": "kevinhan88"}, "path": "segmentstore/server/src/test/java/io/pravega/segmentstore/server/SegmentStoreMetricsTests.java", "diffHunk": "@@ -161,30 +161,30 @@ public void testThrottlerMetrics() {\n \n     @Test\n     public void testCacheManagerMetrics() {\n-        int storedBytes = 10000;\n-        int usedBytes = 1000;\n-        int allocatedBytes = 100;\n+        long storedBytes = 10000;\n+        long usedBytes = 1000;\n+        long allocatedBytes = 100;\n         int generationSpread = 10;\n-        int managerIterationDuration = 1;\n+        long managerIterationDuration = 1;\n \n         int containerId = new Random().nextInt(Integer.MAX_VALUE);\n         @Cleanup\n         SegmentStoreMetrics.CacheManager cache = new SegmentStoreMetrics.CacheManager();\n         cache.report(new CacheState(storedBytes, usedBytes, 0, allocatedBytes, storedBytes), generationSpread, managerIterationDuration);\n \n-        assertEquals(storedBytes, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_STORED_SIZE_BYTES).value());\n-        assertEquals(usedBytes, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_USED_SIZE_BYTES).value());\n-        assertEquals(allocatedBytes, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_ALLOC_SIZE_BYTES).value());\n+        assertEquals(storedBytes, (long) MetricRegistryUtils.getGauge(MetricsNames.CACHE_STORED_SIZE_BYTES).value());\n+        assertEquals(usedBytes, (long) MetricRegistryUtils.getGauge(MetricsNames.CACHE_USED_SIZE_BYTES).value());\n+        assertEquals(allocatedBytes, (long) MetricRegistryUtils.getGauge(MetricsNames.CACHE_ALLOC_SIZE_BYTES).value());\n         assertEquals(generationSpread, (int) MetricRegistryUtils.getGauge(MetricsNames.CACHE_GENERATION_SPREAD).value());\n-        assertEquals(managerIterationDuration, (int) MetricRegistryUtils.getTimer(MetricsNames.CACHE_MANAGER_ITERATION_DURATION).mean(TimeUnit.MILLISECONDS));\n+        assertEquals(managerIterationDuration, (long) MetricRegistryUtils.getTimer(MetricsNames.CACHE_MANAGER_ITERATION_DURATION).mean(TimeUnit.MILLISECONDS));\n \n         cache.close();\n \n         assertNull(MetricRegistryUtils.getGauge(MetricsNames.CACHE_STORED_SIZE_BYTES));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a609ae5b9b817aec490eb43505f04277ce70600"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "266a1c375825fbd93bf0cb0a3e100ba8acad9d72", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/266a1c375825fbd93bf0cb0a3e100ba8acad9d72", "committedDate": "2020-08-26T19:05:28Z", "message": "Merge branch 'master' into issue-5058-cache-manager-metrics-patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b14c69938bf064329c8a20ed61f4088699e7c5d2", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/b14c69938bf064329c8a20ed61f4088699e7c5d2", "committedDate": "2020-08-28T16:28:05Z", "message": "Merge branch 'master' into issue-5058-cache-manager-metrics-patch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MDA3Nzgy", "url": "https://github.com/pravega/pravega/pull/5092#pullrequestreview-478007782", "createdAt": "2020-08-28T20:29:08Z", "commit": {"oid": "b14c69938bf064329c8a20ed61f4088699e7c5d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3823, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}