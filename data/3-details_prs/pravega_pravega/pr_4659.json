{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2NTc5Mjcy", "number": 4659, "title": "Issue 4333: (Key-Value Tables) Table Segment Client", "bodyText": "Change log description\nDefined the client-side contracts for Table Segments and Implemented them using the existing wire protocol.\nPurpose of the change\nFixes #4333.\nWhat the code does\nAdded the following:\n\nTableSegment: contract definitions for Table Segments (as viewed from the client-side)\nTableSegmentImpl: Implementation for TableSegment\nTableSegmentFactory: creates TableSegment\nKeyValueTableClientConfiguration: configures the Key-Value Table Client\n\nThis is not added in this PR, but this config is used by the TableSegmentImpl to perform retries.\n\n\n\nWire Protocol Changes\n\nAltered WireCommands.ReadTableKeys and WireCommands.ReadTableEntries to include an optional prefix filter (for the iteration).\n\nThis value is passed down to the Segment Store but it is not yet implemented (coming in #4656)\nThis change should be backwards compatible (it adds the extra payload at the end of the serialization).\n\n\n\nHow to verify it\nUnit tests added for new code.\nSome existing unit tests modified to account for new features.", "createdAt": "2020-03-31T20:23:48Z", "url": "https://github.com/pravega/pravega/pull/4659", "merged": true, "mergeCommit": {"oid": "2b312a7af8c28fa1d5d36c8a1e389978e440afd5"}, "closed": true, "closedAt": "2020-04-02T15:42:05Z", "author": {"login": "andreipaduroiu"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHmcifgH2gAyMzk2NTc5MjcyOmVmOTExMzQzMTk3NDQwZDE4YzMxODQ3MzFlNTZmNzhiM2I3NzUxOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTlBUJAFqTM4NjEwNzUyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ef911343197440d18c3184731e56f78b3b775192", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/ef911343197440d18c3184731e56f78b3b775192", "committedDate": "2020-02-24T23:51:07Z", "message": "Refactored TableSegment, TableEntry, TableKey in preparation for creating KeyValueTable. Moved a few classes around.\n\nRefactored SegmentHelper to make use of TableSegmentKey, TableSegmentEntry and TableSegmentKeyVersion which better map to what a Table Segment can do. Refactored upstream code and adjusted unit tests.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05ff3487b0c7e26b69c22e3ef1969823915141a2", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/05ff3487b0c7e26b69c22e3ef1969823915141a2", "committedDate": "2020-02-25T00:21:59Z", "message": "Javadoc.\nMoved IteratorItem into its own file.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65f52b7d5bc0cc86d9490957498480d151703be2", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/65f52b7d5bc0cc86d9490957498480d151703be2", "committedDate": "2020-02-25T18:03:54Z", "message": "Javadoc.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "201e5f049c5ba118018d0633463cf739ea11e7e4", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/201e5f049c5ba118018d0633463cf739ea11e7e4", "committedDate": "2020-02-25T18:21:59Z", "message": "Made IteratorState a class.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bc363a9e6025c935db640f44603b7e67359f57a", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/0bc363a9e6025c935db640f44603b7e67359f57a", "committedDate": "2020-02-25T22:30:08Z", "message": "TableSegmentImpl.\nTableSegmentIterator.\nFixed a bug in MockConnectionFactoryImpl that was closing an externally-provided Executor when it shouldn't be.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e11121b0ee12384c7bae18228bf06d87bacc3b4", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/2e11121b0ee12384c7bae18228bf06d87bacc3b4", "committedDate": "2020-02-25T22:48:52Z", "message": "Updated TableSegment.keyIterator and TableSegment.entryIterator.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50bf936a5332db202e2153701412b7bc2dc64718", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/50bf936a5332db202e2153701412b7bc2dc64718", "committedDate": "2020-02-25T22:49:16Z", "message": "Merge remote-tracking branch 'remotes/ap/issue-4568-key-value-table-contracts' into issue-4333-tables-segment-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc34a4e4d15ad134512155432fc88e525e2985c2", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/fc34a4e4d15ad134512155432fc88e525e2985c2", "committedDate": "2020-02-25T22:50:20Z", "message": "Updated TableSegment.keyIterator and TableSegment.entryIterator.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "206d4847cf8fd13c7ed69deabe9abf7f047a9589", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/206d4847cf8fd13c7ed69deabe9abf7f047a9589", "committedDate": "2020-02-26T18:14:46Z", "message": "Javadoc fixes.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e848733fbbb3a14ce48713e73a5cfa520dbaca03", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/e848733fbbb3a14ce48713e73a5cfa520dbaca03", "committedDate": "2020-03-02T18:24:40Z", "message": "Merge remote-tracking branch 'remotes/origin/master' into issue-4568-key-value-table-contracts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bec961271dd6680d2f065f11505cd618bc50e14b", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/bec961271dd6680d2f065f11505cd618bc50e14b", "committedDate": "2020-03-03T16:10:18Z", "message": "Refactored TableSegment, TableEntry, TableKey in preparation for creating KeyValueTable. Moved a few classes around.\n\nRefactored SegmentHelper to make use of TableSegmentKey, TableSegmentEntry and TableSegmentKeyVersion which better map to what a Table Segment can do. Refactored upstream code and adjusted unit tests.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc48e967cae0a052e064c0178aacde4a34f7124", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/fdc48e967cae0a052e064c0178aacde4a34f7124", "committedDate": "2020-03-03T16:10:18Z", "message": "Javadoc.\nMoved IteratorItem into its own file.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57a4ae4f6a76424ffd789947232bb426e7266cec", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/57a4ae4f6a76424ffd789947232bb426e7266cec", "committedDate": "2020-03-03T16:10:18Z", "message": "Javadoc.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a9cc3e0dbf4d34ac8d51a2e842b999dc2fc471d", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/9a9cc3e0dbf4d34ac8d51a2e842b999dc2fc471d", "committedDate": "2020-03-03T16:10:18Z", "message": "Made IteratorState a class.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c138dd219c3bed59ad5998638c3cdf28e27471f", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/2c138dd219c3bed59ad5998638c3cdf28e27471f", "committedDate": "2020-03-03T16:10:18Z", "message": "Updated TableSegment.keyIterator and TableSegment.entryIterator.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "096cdd4843a0cb3dd11893b7c66592c858b1471e", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/096cdd4843a0cb3dd11893b7c66592c858b1471e", "committedDate": "2020-03-03T16:10:18Z", "message": "Javadoc fixes.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f81fbb3aa9d099e39986a9c258da838a4e7f630", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/5f81fbb3aa9d099e39986a9c258da838a4e7f630", "committedDate": "2020-03-04T16:17:34Z", "message": "Merge branch 'issue-4568-key-value-table-contracts' of https://github.com/andreipaduroiu/pravega into issue-4568-key-value-table-contracts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8a3e9cb0186f3c390a8b500d71be299cceb8c8c", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/e8a3e9cb0186f3c390a8b500d71be299cceb8c8c", "committedDate": "2020-03-04T16:56:28Z", "message": "Unit tests ... for coverage.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cadfa9c07c323757ad24197deccd3e6fb27f577", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/1cadfa9c07c323757ad24197deccd3e6fb27f577", "committedDate": "2020-03-04T21:05:59Z", "message": "Increasing coverage.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fac12be237bb6f5053dad56b446a8e3011cb619", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/0fac12be237bb6f5053dad56b446a8e3011cb619", "committedDate": "2020-03-04T22:48:59Z", "message": "Merge remote-tracking branch 'remotes/ap/issue-4568-key-value-table-contracts' into issue-4333-tables-segment-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d0d197c9913c94f37ec6f9d15361359a70dc33f", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/6d0d197c9913c94f37ec6f9d15361359a70dc33f", "committedDate": "2020-03-04T22:58:46Z", "message": "Default methods.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3adfa77124cf1c79eac5528e8090a8f0ee3e403e", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/3adfa77124cf1c79eac5528e8090a8f0ee3e403e", "committedDate": "2020-03-04T23:59:10Z", "message": "Added Wire Protocol support for prefix-filtered iterators.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df7480352538f93c7ccb10db86216513e019faa5", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/df7480352538f93c7ccb10db86216513e019faa5", "committedDate": "2020-03-09T22:03:06Z", "message": "Fixed some Javadoc verbiage.\nSeparated IteratorState (interface) and IteratorStateImpl (class) to hide some implementation details.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afb51fed4467aa7df842b38eba434b58ade7326f", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/afb51fed4467aa7df842b38eba434b58ade7326f", "committedDate": "2020-03-09T23:28:42Z", "message": "Merge remote-tracking branch 'remotes/ap/issue-4568-key-value-table-contracts' into issue-4333-tables-segment-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4958aba6aea2fbf39df8a4e247bbe9d92ea3414c", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/4958aba6aea2fbf39df8a4e247bbe9d92ea3414c", "committedDate": "2020-03-09T23:36:56Z", "message": "Merged with parent branch. Fixed some tests.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3f2e4d22f861bc513255b0a1d26e916c66e905b", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/d3f2e4d22f861bc513255b0a1d26e916c66e905b", "committedDate": "2020-03-17T16:00:03Z", "message": "Javadoc fixes.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fa9ebfaafd25626e344949f70230ca690a41ff4", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/5fa9ebfaafd25626e344949f70230ca690a41ff4", "committedDate": "2020-03-17T18:06:19Z", "message": "KeyValueTable API variant #2\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f6c79281346819c2d1247c9ed1b265d8a761be1", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/1f6c79281346819c2d1247c9ed1b265d8a761be1", "committedDate": "2020-03-20T16:57:22Z", "message": "Merge remote-tracking branch 'remotes/ap/issue-4568-key-value-table-contracts' into issue-4333-tables-segment-client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53fd8fd07db76368d20a0e2c9b4657eb98044bba", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/53fd8fd07db76368d20a0e2c9b4657eb98044bba", "committedDate": "2020-03-30T22:39:15Z", "message": "Plumbed through key prefix filter. Not yet implemented.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d141c69b4a5fbc38f2522335de8d641da1e96e5e", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/d141c69b4a5fbc38f2522335de8d641da1e96e5e", "committedDate": "2020-03-31T20:09:12Z", "message": "Merge remote-tracking branch 'remotes/origin/feature-key-value-tables' into issue-4333-tables-segment-client\n\n# Conflicts:\n#\tclient/src/main/java/io/pravega/client/tables/IteratorState.java\n#\tclient/src/main/java/io/pravega/client/tables/KeyValueTable.java\n#\tclient/src/main/java/io/pravega/client/tables/TableKey.java\n#\tclient/src/main/java/io/pravega/client/tables/impl/TableSegment.java\n#\tclient/src/main/java/io/pravega/client/tables/impl/TableSegmentKey.java\n#\tclient/src/test/java/io/pravega/client/tables/IteratorStateTests.java\n#\tclient/src/test/java/io/pravega/client/tables/TableEntryTests.java\n#\tclient/src/test/java/io/pravega/client/tables/TableKeyTests.java\n#\tcontroller/src/main/java/io/pravega/controller/server/SegmentHelper.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "697254844d9cc037e988c4580733f69cc049a988", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/697254844d9cc037e988c4580733f69cc049a988", "committedDate": "2020-03-31T20:11:30Z", "message": "Merge conflicts.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4430020a7b406a80320fd7483322820eff7456d2", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/4430020a7b406a80320fd7483322820eff7456d2", "committedDate": "2020-03-31T20:21:31Z", "message": "Backporting some changes from downstream branches.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b56bd49973aae6995817b2d50de99821bf65f664", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/b56bd49973aae6995817b2d50de99821bf65f664", "committedDate": "2020-03-31T20:27:37Z", "message": "Reverted unintentional commit.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8670482b91fe87bd7d5bf761cec88d80a546f01", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/c8670482b91fe87bd7d5bf761cec88d80a546f01", "committedDate": "2020-03-31T22:08:07Z", "message": "Unit test coverage.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc9fe91814982b24e2300d5a2e7f29cee25e1a7", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/fdc9fe91814982b24e2300d5a2e7f29cee25e1a7", "committedDate": "2020-04-01T00:06:18Z", "message": "Added Beta annotations.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjAyMTAz", "url": "https://github.com/pravega/pravega/pull/4659#pullrequestreview-385202103", "createdAt": "2020-04-01T00:59:45Z", "commit": {"oid": "fdc9fe91814982b24e2300d5a2e7f29cee25e1a7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMDo1OTo0NlrOF-tU1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwMTo1OTo1NVrOF-uPxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTI5ODY0Nw==", "bodyText": "By default this results in only retrying for ~10s. Is this intended?", "url": "https://github.com/pravega/pravega/pull/4659#discussion_r401298647", "createdAt": "2020-04-01T00:59:46Z", "author": {"login": "tkaitchuck"}, "path": "client/src/main/java/io/pravega/client/tables/KeyValueTableClientConfiguration.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.client.tables;\n+\n+import com.google.common.annotations.Beta;\n+import com.google.common.base.Preconditions;\n+import java.io.Serializable;\n+import lombok.Builder;\n+import lombok.Data;\n+\n+/**\n+ * Configuration for the {@link KeyValueTable} client.\n+ */\n+@Beta\n+@Data\n+@Builder\n+public class KeyValueTableClientConfiguration implements Serializable {\n+    private static final long serialVersionUID = 1L;\n+    private final int initialBackoffMillis;\n+    private final int maxBackoffMillis;\n+    private final int retryAttempts;\n+    private final int backoffMultiple;\n+\n+    public static final class KeyValueTableClientConfigurationBuilder {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdc9fe91814982b24e2300d5a2e7f29cee25e1a7"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMxMjg2OQ==", "bodyText": "These two operations being non-atomic leads to a bazar possibility of passing the closed check at the top and getting an NPE on 46 if calling getNext from multiple threads concurrently.\nI am also not sure it makes sense to call getNext concurrently. It seems like the fetchNext function should not be invoked multiple times in parallel. (Though multiple times before the futures return does make sense)", "url": "https://github.com/pravega/pravega/pull/4659#discussion_r401312869", "createdAt": "2020-04-01T01:56:29Z", "author": {"login": "tkaitchuck"}, "path": "client/src/main/java/io/pravega/client/tables/impl/TableSegmentIterator.java", "diffHunk": "@@ -0,0 +1,61 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.client.tables.impl;\n+\n+import io.pravega.client.tables.IteratorItem;\n+import io.pravega.client.tables.IteratorState;\n+import io.pravega.common.ObjectClosedException;\n+import io.pravega.common.concurrent.Futures;\n+import io.pravega.common.util.AsyncIterator;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.function.Function;\n+import lombok.NonNull;\n+\n+/**\n+ * Iterator over Table Segment Keys or Values.\n+ *\n+ * @param <T> Type of item iterated over. Usually {@link TableSegmentKey} or {@link TableSegmentEntry}.\n+ */\n+class TableSegmentIterator<T> implements AsyncIterator<IteratorItem<T>> {\n+    private final Function<IteratorState, CompletableFuture<IteratorItem<T>>> fetchNext;\n+    private final AtomicReference<IteratorState> state;\n+    private final AtomicBoolean closed;\n+\n+    TableSegmentIterator(@NonNull Function<IteratorState, CompletableFuture<IteratorItem<T>>> fetchNext, IteratorState initialState) {\n+        this.fetchNext = fetchNext;\n+        this.state = new AtomicReference<>(initialState);\n+        this.closed = new AtomicBoolean(false);\n+    }\n+\n+    @Override\n+    public CompletableFuture<IteratorItem<T>> getNext() {\n+        if (this.closed.get()) {\n+            // We are done.\n+            return CompletableFuture.completedFuture(null);\n+        }\n+\n+        CompletableFuture<IteratorItem<T>> result = this.fetchNext.apply(this.state.get())\n+                .thenApply(r -> {\n+                    if (r == null) {\n+                        // We are done.\n+                        this.state.set(null);\n+                        this.closed.set(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdc9fe91814982b24e2300d5a2e7f29cee25e1a7"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMxMzczMg==", "bodyText": "This is a primitive right?", "url": "https://github.com/pravega/pravega/pull/4659#discussion_r401313732", "createdAt": "2020-04-01T01:59:55Z", "author": {"login": "tkaitchuck"}, "path": "client/src/main/java/io/pravega/client/tables/impl/TableSegmentKey.java", "diffHunk": "@@ -98,4 +98,13 @@ public static TableSegmentKey notExists(byte[] key) {\n     }\n \n     //endregion\n+\n+    /**\n+     * Gets a value indicating whether this key exists/should exist.\n+     *\n+     * @return True if the key exists/should exist, false otherwise.\n+     */\n+    boolean exists() {\n+        return getVersion().getSegmentVersion() != TableSegmentKeyVersion.NOT_EXISTS.getSegmentVersion();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdc9fe91814982b24e2300d5a2e7f29cee25e1a7"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abd83adeb0031fa0b07582c39e9c481675f730e1", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/abd83adeb0031fa0b07582c39e9c481675f730e1", "committedDate": "2020-04-01T14:56:41Z", "message": "Changed backoff multiplier.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adf4c9e87e6a7f78c555a4ab48da1a10cfe388b3", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/adf4c9e87e6a7f78c555a4ab48da1a10cfe388b3", "committedDate": "2020-04-01T16:44:56Z", "message": "Table Segment Iterators are now sequential.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MTA3NTI0", "url": "https://github.com/pravega/pravega/pull/4659#pullrequestreview-386107524", "createdAt": "2020-04-02T04:58:34Z", "commit": {"oid": "adf4c9e87e6a7f78c555a4ab48da1a10cfe388b3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3653, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}