{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NTY0NTc5", "number": 5386, "title": "Issue 5385: Upgrade Bookkeeper to last stable version (4.11.1)", "bodyText": "Change log description\nUpgrades the version of Bookkeeper in Pravega to 4.11.1 (client, documentation, dockerfile).\nPurpose of the change\nFixes #5385.\nWhat the code does\nUpgrades the versions of Bookkeeper in Pravega to 4.11.1 (client, documentation, dockerfile).\nApart from that, this PR removes an unnecessary method in entrypoint.sh called fix_bk_ipv6_check(), as the fix for which that method was intended to is already in Bookkeeper mainline.\nHow to verify it\nJUnit tests (travis/jenkins) and system tests (3/3) are passing. Longevity runs have also passed.", "createdAt": "2020-11-30T13:52:45Z", "url": "https://github.com/pravega/pravega/pull/5386", "merged": true, "mergeCommit": {"oid": "bbbbe1850aa9e941edca506da1866d7ba46c2bc5"}, "closed": true, "closedAt": "2020-12-07T20:30:03Z", "author": {"login": "RaulGracia"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhlfYZAH2gAyNTI5NTY0NTc5OmRhZTdhN2ZkNGU5ZmQ4NzM2NjE5MGIzY2Y2OTU2ZWFjOTc2NjM3Zjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj5RTCAFqTU0NjM4ODcyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dae7a7fd4e9fd87366190b3cf6956eac976637f8", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/dae7a7fd4e9fd87366190b3cf6956eac976637f8", "committedDate": "2020-11-30T13:37:30Z", "message": "Bookkeeper version upgrade\n\nSigned-off-by: Ra\u00fal <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "719dfd5b613a305987b56012adf29d3f351391d5", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/719dfd5b613a305987b56012adf29d3f351391d5", "committedDate": "2020-11-30T15:23:06Z", "message": "Switched to JDK11 and remove deprecated check for bindv6only check\n\nSigned-off-by: Ra\u00fal <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27d2842e3398f8e47a4fa47b6b80d0f57dd4db04", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/27d2842e3398f8e47a4fa47b6b80d0f57dd4db04", "committedDate": "2020-11-30T15:23:45Z", "message": "Merge branch 'master' into issue-5385-upgrade-bk-version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff6c68eea0e7af4eafa655d5831901f083f51892", "author": {"user": {"login": "anishakj", "name": null}}, "url": "https://github.com/pravega/pravega/commit/ff6c68eea0e7af4eafa655d5831901f083f51892", "committedDate": "2020-12-01T17:28:46Z", "message": "Made changes to run system tests with Java11 option in bookkeeper\n\nSigned-off-by: anishakj <anisha.kj@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac67a8e47090e5059644945f6636c1ac32344eae", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/ac67a8e47090e5059644945f6636c1ac32344eae", "committedDate": "2020-12-01T17:32:46Z", "message": "Merge branch 'master' into issue-5385-upgrade-bk-version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c37325ed7f9ba12c6f85e9968f997067968bd905", "author": {"user": {"login": "anishakj", "name": null}}, "url": "https://github.com/pravega/pravega/commit/c37325ed7f9ba12c6f85e9968f997067968bd905", "committedDate": "2020-12-01T17:39:46Z", "message": "Merge branch 'issue-5385-upgrade-bk-version' of https://github.com/RaulGracia/pravega into issue-5385-upgrade-bk-version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54c948fb94cf629f681e197340e81df43e4a06fc", "author": {"user": {"login": "anishakj", "name": null}}, "url": "https://github.com/pravega/pravega/commit/54c948fb94cf629f681e197340e81df43e4a06fc", "committedDate": "2020-12-01T17:59:47Z", "message": "Fixed chcekstyle errors\n\nSigned-off-by: anishakj <anisha.kj@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bab8e75eabe087dfcdfe874e525adb43b652fd63", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/bab8e75eabe087dfcdfe874e525adb43b652fd63", "committedDate": "2020-12-02T10:42:28Z", "message": "Merge branch 'master' into issue-5385-upgrade-bk-version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c34e14dbc450a8566653f7e0973713b820488f46", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/c34e14dbc450a8566653f7e0973713b820488f46", "committedDate": "2020-12-02T18:33:17Z", "message": "Merge branch 'master' into issue-5385-upgrade-bk-version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNzE5MzI3", "url": "https://github.com/pravega/pravega/pull/5386#pullrequestreview-543719327", "createdAt": "2020-12-03T08:43:44Z", "commit": {"oid": "c34e14dbc450a8566653f7e0973713b820488f46"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwODo0Mzo0NFrOH-Jztg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwODo1MjoxNFrOH-K1CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkzNDQ1NA==", "bodyText": "PR #4420 had added many of these functions from Apache/Bookkeeper which didn't work in stock Apache/Bookkeeper image at the time, so that they could be fixed here. The idea was that those fixes are made here, until the fixes are also made on Apache/Bookeeper side.\nLater, I had raised this PR apache/bookkeeper#2219 with the same fixes we made here in Pravega and the PR got merged there, so some of these customized functions aren't needed anymore. As such we can return back to having pravega/bookkeeper entrypoint.sh invoking apache/bookkeeper entrypoint.sh to start bookies (see how this changed in the entrypoint.sh diff in https://github.com/pravega/pravega/pull/4420/files0.\nNow, whether we do that change here while upgrading to Bookkeeper 4.11.x or do it separately in a different PR is an open question. I'd suggest doing that separately. If you agree, we should raise an issue to track that separate piece of work.", "url": "https://github.com/pravega/pravega/pull/5386#discussion_r534934454", "createdAt": "2020-12-03T08:43:44Z", "author": {"login": "ravisharda"}, "path": "docker/bookkeeper/entrypoint.sh", "diffHunk": "@@ -89,22 +89,6 @@ configure_bk() {\n     fi\n }\n \n-fix_bk_ipv6_check() {\n-\n-   # `${SCRIPTS_DIR}/common.sh` - a shell script in Bookeeper, runs this command: `/sbin/sysctl -n net.ipv6.bindv6only`.\n-   # This command can return an error exit code `255` and error message:\n-   #    `sysctl: cannot stat /proc/sys/net/ipv6/bindv6only: No such file or directory`\n-   #\n-   # If the `common.sh` file is sourced in a script that sets \"exit on error\" as true (set -e), the script shall return\n-   # an error code `255`. Since, the `bookkeeper/bin/bookeeper` shell script sources the `common.sh` file, and it sets\n-   # \"exit on error\" as true, we encounter this error when it is invoked. To avoid that error, here we modify the\n-   # `common.sh` file to execute `/sbin/sysctl -n net.ipv6.bindv6only` only if file `/proc/sys/net/ipv6/bindv6only`\n-   # is available.\n-\n-   # Replace the 22nd line with \"if [ -f /sbin/sysctl ] && [ -f /proc/sys/net/ipv6/bindv6only ]; then\".\n-   sed -i \"22s|.*|if [ -f /sbin/sysctl ] \\&\\& [ -f /proc/sys/net/ipv6/bindv6only ]; then|\" ${BK_HOME}/bin/common.sh\n-}\n-\n initialize_cluster() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c34e14dbc450a8566653f7e0973713b820488f46"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk1MTE3Ng==", "bodyText": "This base image downloads bookkeeper-server-4.11.1-bin.tar.gz (as per this layer) and then we bring in bookkeeper-all-${BK_VERSION}-bin.tar.gz and use this new file. As a result, the image has an extra bookkeeper-server-4.11.1-bin.tar.gz file, adding to the image size.  This is a preexisting issue, which is present in our older images too. Would it make sense to add a command to delete that redundant binary here?", "url": "https://github.com/pravega/pravega/pull/5386#discussion_r534951176", "createdAt": "2020-12-03T08:52:14Z", "author": {"login": "ravisharda"}, "path": "docker/bookkeeper/Dockerfile", "diffHunk": "@@ -17,9 +17,9 @@\n # - github.com/apache/bookkeeper/blob/branch-4.9/docker/Dockerfile\n #\n \n-FROM apache/bookkeeper:4.9.2\n+FROM apache/bookkeeper:4.11.1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c34e14dbc450a8566653f7e0973713b820488f46"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzODM1MTMz", "url": "https://github.com/pravega/pravega/pull/5386#pullrequestreview-543835133", "createdAt": "2020-12-03T10:56:20Z", "commit": {"oid": "c34e14dbc450a8566653f7e0973713b820488f46"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f09891a90f589f84a31b19063aecd91ec8cd94f", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/6f09891a90f589f84a31b19063aecd91ec8cd94f", "committedDate": "2020-12-07T09:39:42Z", "message": "Merge branch 'master' into issue-5385-upgrade-bk-version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MjA2NjAw", "url": "https://github.com/pravega/pravega/pull/5386#pullrequestreview-546206600", "createdAt": "2020-12-07T14:34:57Z", "commit": {"oid": "6f09891a90f589f84a31b19063aecd91ec8cd94f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2Mzg4NzI5", "url": "https://github.com/pravega/pravega/pull/5386#pullrequestreview-546388729", "createdAt": "2020-12-07T17:48:04Z", "commit": {"oid": "6f09891a90f589f84a31b19063aecd91ec8cd94f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3768, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}