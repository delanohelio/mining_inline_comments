{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2OTg1MTM4", "number": 4719, "title": "Issue-4642: load TLS certificates from /etc/secret-volume/ca-bundle", "bodyText": "Signed-off-by: kevinhan88 kevinhan88@gmail.com\nChange log description\nNow Pravega supports ECS as tier2. If an ECS internal installation is only self-signed for TLS, Pravega must trust its self-signed certificate or the signing CA in order to establish TLS connection.\nPer the discussion and agreement, ECS certificate will be mounted to /etc/secret-volume/ca-bundle, hence Pravega container script needs to find the certificates from this location and then add them into truststore.\nPurpose of the change\nCloses #4642\nWhat the code does\n(Detailed description of the code changes)\nThe container script loads certificates found under /etc/secret-volume/ca-bundle into the default Java Truststore in order to establish TLS connection with ECS\nHow to verify it\nECS certificate should show up at /etc/secret-volume/ca-bundle, and ECS TLS works.", "createdAt": "2020-04-22T01:06:41Z", "url": "https://github.com/pravega/pravega/pull/4719", "merged": true, "mergeCommit": {"oid": "e480f26dbbec21a51fa45c65abd4116a4f807b21"}, "closed": true, "closedAt": "2020-04-23T14:45:39Z", "author": {"login": "kevinhan88"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZ9mwmAH2gAyNDA2OTg1MTM4OjRmNzQyM2MzNmI0ZWQ4YWY1YWM3ZTBjZjAwZjVjOGFmNWUwODI3MmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcad1VegFqTM5OTE2MDIxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f7423c36b4ed8af5ac7e0cf00f5c8af5e08272a", "author": {"user": {"login": "kevinhan88", "name": "Kevin Han"}}, "url": "https://github.com/pravega/pravega/commit/4f7423c36b4ed8af5ac7e0cf00f5c8af5e08272a", "committedDate": "2020-04-22T01:00:44Z", "message": "Issue-4642: load TLS certificates from /etc/secret-volume/ca-bundle to be align with other TLS materials\n\nSigned-off-by: kevinhan88 <kevinhan88@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MDY1NTY5", "url": "https://github.com/pravega/pravega/pull/4719#pullrequestreview-398065569", "createdAt": "2020-04-22T10:44:11Z", "commit": {"oid": "4f7423c36b4ed8af5ac7e0cf00f5c8af5e08272a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMDo0NDoxMVrOGJvywg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMDo0NDoxMVrOGJvywg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg3MzQxMA==", "bodyText": "Curious, what is this ca-bundle directory under /etc/secret-volume? It's not clear to me from the PR description. Is it the certificate of the CA that was used to sign the ECS server certificates?\nCould we use a more specific name? Not sure what the ca-bundle represents exactly.", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r412873410", "createdAt": "2020-04-22T10:44:11Z", "author": {"login": "ravisharda"}, "path": "docker/pravega/scripts/common.sh", "diffHunk": "@@ -36,7 +36,7 @@ add_system_property_ecs_config_uri() {\n \n # Add ECS certificates into Java truststore\n add_certs_into_truststore() {\n-    CERTS=/etc/ssl/certs/java/ecs-certs/*\n+    CERTS=/etc/secret-volume/ca-bundle/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f7423c36b4ed8af5ac7e0cf00f5c8af5e08272a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MDY5NDgx", "url": "https://github.com/pravega/pravega/pull/4719#pullrequestreview-398069481", "createdAt": "2020-04-22T10:49:59Z", "commit": {"oid": "4f7423c36b4ed8af5ac7e0cf00f5c8af5e08272a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMDo0OTo1OVrOGJwAMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMDo0OTo1OVrOGJwAMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg3Njg0OA==", "bodyText": "Should we delete the certificate after successful import into the keystone?", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r412876848", "createdAt": "2020-04-22T10:49:59Z", "author": {"login": "ravisharda"}, "path": "docker/pravega/scripts/common.sh", "diffHunk": "@@ -36,7 +36,7 @@ add_system_property_ecs_config_uri() {\n \n # Add ECS certificates into Java truststore\n add_certs_into_truststore() {\n-    CERTS=/etc/ssl/certs/java/ecs-certs/*\n+    CERTS=/etc/secret-volume/ca-bundle/*\n     for cert in $CERTS\n     do\n       yes | keytool -importcert -storepass changeit -file \"${cert}\" -keystore /etc/ssl/certs/java/cacerts || true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f7423c36b4ed8af5ac7e0cf00f5c8af5e08272a"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0e4981a24b2ccd4535d793b9da0f49135e4ebcc", "author": {"user": {"login": "kevinhan88", "name": "Kevin Han"}}, "url": "https://github.com/pravega/pravega/commit/e0e4981a24b2ccd4535d793b9da0f49135e4ebcc", "committedDate": "2020-04-22T15:36:41Z", "message": "Issue-4642: per code review comment, delete certificate after having added into truststore.\n\nSigned-off-by: kevinhan88 <kevinhan88@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NDA1MDE0", "url": "https://github.com/pravega/pravega/pull/4719#pullrequestreview-398405014", "createdAt": "2020-04-22T17:15:10Z", "commit": {"oid": "e0e4981a24b2ccd4535d793b9da0f49135e4ebcc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzoxNToxMFrOGKBrQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNzoxNjoyNVrOGKBvMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE2NjQwMw==", "bodyText": "This is unrequired and potentially dangerous.  If Pravega is running bare metal then this will delete any certificates that were placed in /etc/secret-volume/ca-bundle.  If this is running in Kubernetes then it would be a secret and you can't delete the certificates from the secret.\nIs there a reason this was added?", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r413166403", "createdAt": "2020-04-22T17:15:10Z", "author": {"login": "maddisondavid"}, "path": "docker/pravega/scripts/common.sh", "diffHunk": "@@ -36,9 +36,10 @@ add_system_property_ecs_config_uri() {\n \n # Add ECS certificates into Java truststore\n add_certs_into_truststore() {\n-    CERTS=/etc/ssl/certs/java/ecs-certs/*\n+    CERTS=/etc/secret-volume/ca-bundle/*\n     for cert in $CERTS\n     do\n       yes | keytool -importcert -storepass changeit -file \"${cert}\" -keystore /etc/ssl/certs/java/cacerts || true\n     done\n+    rm -rf /etc/secret-volume/ca-bundle/* || true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0e4981a24b2ccd4535d793b9da0f49135e4ebcc"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzE2NzQxMQ==", "bodyText": "Does this work with multiple certificates?  I was under the impression from other tests I've done with keytool that you need to specify an alias otherwise the certificate gets added as <mykey> which isn't a trusted entry.", "url": "https://github.com/pravega/pravega/pull/4719#discussion_r413167411", "createdAt": "2020-04-22T17:16:25Z", "author": {"login": "maddisondavid"}, "path": "docker/pravega/scripts/common.sh", "diffHunk": "@@ -36,9 +36,10 @@ add_system_property_ecs_config_uri() {\n \n # Add ECS certificates into Java truststore\n add_certs_into_truststore() {\n-    CERTS=/etc/ssl/certs/java/ecs-certs/*\n+    CERTS=/etc/secret-volume/ca-bundle/*\n     for cert in $CERTS\n     do\n       yes | keytool -importcert -storepass changeit -file \"${cert}\" -keystore /etc/ssl/certs/java/cacerts || true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0e4981a24b2ccd4535d793b9da0f49135e4ebcc"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f5ac8034c7256338e7fbf4ddb73407e92056aad", "author": {"user": {"login": "kevinhan88", "name": "Kevin Han"}}, "url": "https://github.com/pravega/pravega/commit/5f5ac8034c7256338e7fbf4ddb73407e92056aad", "committedDate": "2020-04-22T20:29:30Z", "message": "Issue-4642: addressing code review comment: added filename as alisa to avoid potential conflicts when importing multiple certs\n\nSigned-off-by: kevinhan88 <kevinhan88@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbcc948710b12dd905fc89f760a7267f51886105", "author": {"user": {"login": "kevinhan88", "name": "Kevin Han"}}, "url": "https://github.com/pravega/pravega/commit/bbcc948710b12dd905fc89f760a7267f51886105", "committedDate": "2020-04-22T22:16:08Z", "message": "Merge branch 'master' into issue-4642"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NzQ1NTQ3", "url": "https://github.com/pravega/pravega/pull/4719#pullrequestreview-398745547", "createdAt": "2020-04-23T04:09:12Z", "commit": {"oid": "bbcc948710b12dd905fc89f760a7267f51886105"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7a93449bee8b5c2b60bb979f39abda8779d0c5d", "author": {"user": {"login": "kevinhan88", "name": "Kevin Han"}}, "url": "https://github.com/pravega/pravega/commit/a7a93449bee8b5c2b60bb979f39abda8779d0c5d", "committedDate": "2020-04-23T04:11:36Z", "message": "Issue-4642: per code review comments, removed the line to delete certificates afterwards.\n\nSigned-off-by: kevinhan88 <kevinhan88@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a55388b42419487b236e1695b4032a9d7f0ac53d", "author": {"user": {"login": "kevinhan88", "name": "Kevin Han"}}, "url": "https://github.com/pravega/pravega/commit/a55388b42419487b236e1695b4032a9d7f0ac53d", "committedDate": "2020-04-23T04:15:03Z", "message": "Merge branch 'issue-4642' of https://github.com/kevinhan88/pravega into issue-4642"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MTYwMjE2", "url": "https://github.com/pravega/pravega/pull/4719#pullrequestreview-399160216", "createdAt": "2020-04-23T14:33:37Z", "commit": {"oid": "a55388b42419487b236e1695b4032a9d7f0ac53d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3438, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}