{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMTM1MTUz", "number": 4477, "title": "Issue 4460: BookieFailover Test sporadic failure", "bodyText": "Change log description\nIncreased retry timeout in SegmentMetadataClientImpl to mitigate test failures due to slow Bookie restart and added read event assertions in BookieFailoverTest.\nPurpose of the change\nFixes #4460.\nWhat the code does\nThis PR increases the retry time for SegmentMetadataClientImpl to prevent system test failures in the case that the environment is slow on restarting the failed Bookie in BookieFailoverTest. This has been proven to remove the sporadic failures of this test in our system test environment. Apart from that, the BookieFailoverTest also checks the progress of read events.\nNote that in extremely slow environments, we may still see this test failing, but this is expected given that the test logic interprets any exception in the reader side as a test failure. Therefore, in such slow environments, we may still get RetriesExhaustedException on the reader side. But this is fine, given that it will give us a clue that the environment we are using for system tests is not suitable (e.g., lack of resources).\nHow to verify it\nWe have executed this test in isolation 8 times in a row without experiencing the original problem RetriesExhaustedException. Before, we observed BookieFailoverTest failing 30%-50% of the time.", "createdAt": "2020-01-07T19:23:23Z", "url": "https://github.com/pravega/pravega/pull/4477", "merged": true, "mergeCommit": {"oid": "6222d9618febac4032abf62747544227d5087944"}, "closed": true, "closedAt": "2020-01-08T11:56:35Z", "author": {"login": "RaulGracia"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABbw8yxJgH2gAyMzYwMTM1MTUzOjdjOTA4YzdlNjY1MWNlNjM0YzkwODgxMjliODY3NDQ0NTlmMzM3NTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4T9anAFqTMzOTgxMzE4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7c908c7e6651ce634c9088129b86744459f33752", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/7c908c7e6651ce634c9088129b86744459f33752", "committedDate": "2019-12-16T14:53:03Z", "message": "Issue 4460: Ignore non-Bookkeeper tests.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39fa82ae79eb5aaaf6b5701295bc952d0a10f601", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/39fa82ae79eb5aaaf6b5701295bc952d0a10f601", "committedDate": "2019-12-17T11:29:34Z", "message": "Issue 4460: Revert ignore annotations, shortened sleep time during BookkeeperFailover test and added reader assertions.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "061005809e246eeab6125a8ddabd222596114e17", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/061005809e246eeab6125a8ddabd222596114e17", "committedDate": "2019-12-18T16:00:45Z", "message": "Issue 4460: Shorten sleep in test.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e17e2b80e230abf129efce1c8d84558f3f245dbb", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/e17e2b80e230abf129efce1c8d84558f3f245dbb", "committedDate": "2020-01-07T14:50:45Z", "message": "Issue 4460: Increase retries in Stream Metadata client.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ada762e92923d374fd72c46713b1091ee261d2e0", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/ada762e92923d374fd72c46713b1091ee261d2e0", "committedDate": "2020-01-07T14:54:02Z", "message": "Issue 4460: Temporarily disable non-related tests.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4616bcf1389a28e4e16579e2ac1ec31ce8f6c903", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/4616bcf1389a28e4e16579e2ac1ec31ce8f6c903", "committedDate": "2020-01-07T16:04:00Z", "message": "Issue 4460: Restore previous sleep delay.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd35d6ab841679238bdfa39b686b68bd81ce3b62", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/dd35d6ab841679238bdfa39b686b68bd81ce3b62", "committedDate": "2020-01-07T16:44:26Z", "message": "Issue 4460: Wait for readers until they are able to read the new events.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ce2f36deba76c3fca4f868c72a7e04ed2810405", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/0ce2f36deba76c3fca4f868c72a7e04ed2810405", "committedDate": "2020-01-07T19:01:59Z", "message": "Issue 4460: Remove ignore from system tests.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a46ebee8fc4eafa65a19317ba45b31ba3e47e38f", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/a46ebee8fc4eafa65a19317ba45b31ba3e47e38f", "committedDate": "2020-01-07T19:05:11Z", "message": "Issue 4460: Remove unnecessary change.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4da61569f25f066cf8154a2583781b3c778a1f75", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/4da61569f25f066cf8154a2583781b3c778a1f75", "committedDate": "2020-01-07T19:23:34Z", "message": "Merge branch 'master' into issue-4460-bookie-failover-test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NTQyNTE0", "url": "https://github.com/pravega/pravega/pull/4477#pullrequestreview-339542514", "createdAt": "2020-01-07T22:15:16Z", "commit": {"oid": "4da61569f25f066cf8154a2583781b3c778a1f75"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NjI5NDg4", "url": "https://github.com/pravega/pravega/pull/4477#pullrequestreview-339629488", "createdAt": "2020-01-08T03:24:25Z", "commit": {"oid": "4da61569f25f066cf8154a2583781b3c778a1f75"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5ODEzMTg5", "url": "https://github.com/pravega/pravega/pull/4477#pullrequestreview-339813189", "createdAt": "2020-01-08T11:49:05Z", "commit": {"oid": "4da61569f25f066cf8154a2583781b3c778a1f75"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMTo0OTowNlrOFbUl6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMTo0OTowNlrOFbUl6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE5MzI1Nw==", "bodyText": "should we increase this to a larger retry count so that we reduce the chances of encountering the issue even on slower systems?", "url": "https://github.com/pravega/pravega/pull/4477#discussion_r364193257", "createdAt": "2020-01-08T11:49:06Z", "author": {"login": "shiveshr"}, "path": "client/src/main/java/io/pravega/client/segment/impl/SegmentMetadataClientImpl.java", "diffHunk": "@@ -49,7 +49,7 @@\n @RequiredArgsConstructor\n @Slf4j\n class SegmentMetadataClientImpl implements SegmentMetadataClient {\n-    private static final RetryWithBackoff RETRY_SCHEDULE = Retry.withExpBackoff(1, 10, 9, 30000);\n+    private static final RetryWithBackoff RETRY_SCHEDULE = Retry.withExpBackoff(1, 10, 10, 30000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4da61569f25f066cf8154a2583781b3c778a1f75"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3666, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}