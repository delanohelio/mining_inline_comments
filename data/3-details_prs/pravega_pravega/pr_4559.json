{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc0NDk5MzA2", "number": 4559, "title": "Issue 4558: Low single segment write performance", "bodyText": "Change log description\nAdd configuration option for Bookkeeper digest type.\nPurpose of the change\nFixes #4558.\nWhat the code does\nThis PR enables us to configure the digest type used in Bookkeeper. The type of digest has an important impact on performance, so we have also changed the default one to CRC32C (formerly, it was MAC). Note that this change is reasonable, given that the MAC digest may protect from \"byzantine Bookies\", which may not be an expected adversarial model in many environments.\nHow to verify it\nWe have observed a 2x throughput increase writing to a single ledger via the SelfTester tool on AWS just changing the digest type:\nMAC\nsudo ./gradlew clean selftest -Dtarget=BookKeeper -Dbkc=3 -Dc=1 -Ds=1 -Dp=10 -Dpp=10 -Dws=1000000 -Do=10000 -Dselftest.zkIp=10.0.0.193\n0:00:47.073 [Reporter]: 10100/10000; Ops = 227/243; Data (P/T/C/S): 9632.1/0.0/0.0/0.0 MB; TPut: 217.4/232.0 MB/s; TPools (Q/T/S): S = ?/?/?, T = 0/1/80, FJ = 0/0/0.\n0:00:47.074 [Reporter]: Operation Summary\n0:00:47.074 [Reporter]:     Operation Type |   Count |  LAvg |   L50 |   L75 |   L90 |   L99 |  L999\n0:00:47.074 [Reporter]:             Append |   10100 |   369 |   376 |   392 |   404 |   427 |   502\n0:00:47.074 [SelfTest]: Finished successfully.\n\nCRC32C\nsudo ./gradlew clean selftest -Dtarget=BookKeeper -Dbkc=3 -Dc=1 -Ds=1 -Dp=10 -Dpp=10 -Dws=1000000 -Do=10000 -Dselftest.zkIp=10.0.0.193\n0:00:28.489 [Reporter]: 10093/10000; Ops = 451/408; Data (P/T/C/S): 9625.4/0.0/0.0/0.0 MB; TPut: 430.5/389.6 MB/s; TPools (Q/T/S): S = ?/?/?, T = 0/1/80, FJ = 0/0/0.\n0:00:28.489 [Reporter]: Operation Summary\n0:00:28.489 [Reporter]:     Operation Type |   Count |  LAvg |   L50 |   L75 |   L90 |   L99 |  L999\n0:00:28.490 [Reporter]:             Append |   10093 |   211 |   210 |   218 |   231 |   271 |   289\n0:00:28.490 [SelfTest]: Finished successfully.\n\nThe rest of test should be working as before.", "createdAt": "2020-02-12T19:52:46Z", "url": "https://github.com/pravega/pravega/pull/4559", "merged": true, "mergeCommit": {"oid": "7cc2b8cb2ff3989ecf6d74e0978eb3e3c78c26e4"}, "closed": true, "closedAt": "2020-02-14T14:55:18Z", "author": {"login": "RaulGracia"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDrewZAH2gAyMzc0NDk5MzA2OjE3NGI0YzMxMTM0NTQzODIwZjdmOTNlMTk1ZDQ0MTZlZThjYzdmMzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEQd5dgFqTM1ODk4MDYzNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "174b4c31134543820f7f93e195d4416ee8cc7f36", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/174b4c31134543820f7f93e195d4416ee8cc7f36", "committedDate": "2020-02-12T19:27:22Z", "message": "Issue 4558: Add configuration option for Bookkeeper digest type.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d913652be24c82928a126609eda97194f4a3988", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/0d913652be24c82928a126609eda97194f4a3988", "committedDate": "2020-02-12T20:03:37Z", "message": "Merge branch 'master' into issue-4558-bk-write-performance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NzkxMzYz", "url": "https://github.com/pravega/pravega/pull/4559#pullrequestreview-357791363", "createdAt": "2020-02-12T21:13:56Z", "commit": {"oid": "0d913652be24c82928a126609eda97194f4a3988"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQyMToxMzo1NlrOFo-w9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQyMToxMzo1NlrOFo-w9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUxNTcwMw==", "bodyText": "Instead of using this string, can we use BookKeeper.DigestType.CRC32C.name()?", "url": "https://github.com/pravega/pravega/pull/4559#discussion_r378515703", "createdAt": "2020-02-12T21:13:56Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/impl/src/main/java/io/pravega/segmentstore/storage/impl/bookkeeper/BookKeeperConfig.java", "diffHunk": "@@ -48,6 +49,7 @@\n     public static final Property<Integer> BK_MIN_NUM_RACKS_PER_WRITE_QUORUM = Property.named(\"minNumRacksPerWriteQuorum\", 2);\n     public static final Property<String> BK_NETWORK_TOPOLOGY_SCRIPT_FILE_NAME = Property.named(\"networkTopologyScriptFileName\",\n             \"/opt/pravega/scripts/sample-bookkeeper-topology.sh\");\n+    public static final Property<String> BK_DIGEST_TYPE = Property.named(\"digestType\", \"CRC32C\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d913652be24c82928a126609eda97194f4a3988"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8230bb469e970d83319d9999b2448c7ea26add3", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/e8230bb469e970d83319d9999b2448c7ea26add3", "committedDate": "2020-02-12T22:06:29Z", "message": "Issue 4558: Use enum name to set the default digest type.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDI2MTI5", "url": "https://github.com/pravega/pravega/pull/4559#pullrequestreview-358426129", "createdAt": "2020-02-13T17:50:20Z", "commit": {"oid": "e8230bb469e970d83319d9999b2448c7ea26add3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4NDg3MjY1", "url": "https://github.com/pravega/pravega/pull/4559#pullrequestreview-358487265", "createdAt": "2020-02-13T19:23:30Z", "commit": {"oid": "e8230bb469e970d83319d9999b2448c7ea26add3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxOToyMzozMVrOFpghdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxOToyMzozMVrOFpghdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTA2ODc5MQ==", "bodyText": "I suggest to enable digestTypeAutodetection so you don't  need to care about it on the reader side and your code will be compatible with rolling upgrades", "url": "https://github.com/pravega/pravega/pull/4559#discussion_r379068791", "createdAt": "2020-02-13T19:23:31Z", "author": {"login": "eolivelli"}, "path": "segmentstore/storage/impl/src/main/java/io/pravega/segmentstore/storage/impl/bookkeeper/Ledgers.java", "diffHunk": "@@ -88,7 +88,7 @@ static LedgerHandle openFence(long ledgerId, BookKeeper bookKeeper, BookKeeperCo\n     static LedgerHandle openRead(long ledgerId, BookKeeper bookKeeper, BookKeeperConfig config) throws DurableDataLogException {\n         try {\n             return Exceptions.handleInterruptedCall(\n-                    () -> bookKeeper.openLedgerNoRecovery(ledgerId, LEDGER_DIGEST_TYPE, config.getBKPassword()));\n+                    () -> bookKeeper.openLedgerNoRecovery(ledgerId, config.getDigestType(), config.getBKPassword()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8230bb469e970d83319d9999b2448c7ea26add3"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d48dfb96d6741e9345b8515b9f3be64b08ada25", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/4d48dfb96d6741e9345b8515b9f3be64b08ada25", "committedDate": "2020-02-13T23:44:55Z", "message": "Merge branch 'master' into issue-4558-bk-write-performance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4OTgwNjM3", "url": "https://github.com/pravega/pravega/pull/4559#pullrequestreview-358980637", "createdAt": "2020-02-14T14:32:55Z", "commit": {"oid": "4d48dfb96d6741e9345b8515b9f3be64b08ada25"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3584, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}