{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNjUzMDU3", "number": 4579, "title": "Issue 4578: Early wake reader in response to server reply.", "bodyText": "Signed-off-by: Tom Kaitchuck tom.kaitchuck@emc.com\nChange log description\nUnblock a reader thread which is waiting in the event that data arrives from the server  on another segment.\nPurpose of the change\nRe-Implements the end-to-end latency optimization that had to be reverted in #4082 but without using futures to avoid the problems in the Java 8 implementation.\nWhat the code does\nUses a semephore to wake the reading thread when a reply from the server is received.\nHow to verify it\nAll existing tests should continue to pass, but lower end-to-end latency should be observed on multi-segment readers that are at the tail of the stream.", "createdAt": "2020-02-27T05:58:23Z", "url": "https://github.com/pravega/pravega/pull/4579", "merged": true, "mergeCommit": {"oid": "26d86eb6f1e13f3999b0df20d99f55950adc36d6"}, "closed": true, "closedAt": "2020-02-28T03:51:36Z", "author": {"login": "tkaitchuck"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGqN0WAH2gAyMzgwNjUzMDU3OjhlM2U2MzM0OTJiMWM0MzA3MmQ1YzY0NDNjNjFiYjAwODU4YWI1NDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcInrCdgFqTM2NjE0NzEyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8e3e633492b1c43072d5c6443c61bb00858ab541", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/8e3e633492b1c43072d5c6443c61bb00858ab541", "committedDate": "2020-02-22T01:40:44Z", "message": "Initial implementation of semephore based early wake\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69a25119f1586096a73514235928f2ca01353a83", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/69a25119f1586096a73514235928f2ca01353a83", "committedDate": "2020-02-22T01:42:03Z", "message": "Merge branch 'master' into early-wake"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bd1ea8973e1286ae7486fad1af5fdbb7f8ffc94", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/8bd1ea8973e1286ae7486fad1af5fdbb7f8ffc94", "committedDate": "2020-02-26T06:52:31Z", "message": "Fix unit tests.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff282e17153ace4a85e235e9780c1d220b24361e", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/ff282e17153ace4a85e235e9780c1d220b24361e", "committedDate": "2020-02-27T05:34:21Z", "message": "Fix unit test\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f3cf67b11cdc99d67bc947f639b245d740a8910", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/3f3cf67b11cdc99d67bc947f639b245d740a8910", "committedDate": "2020-02-27T05:40:54Z", "message": "Add timeout to fetch updates to the reader group.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31b71c6cee5b9aabb828e41f1f8c92f2119a9c54", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/31b71c6cee5b9aabb828e41f1f8c92f2119a9c54", "committedDate": "2020-02-27T06:00:08Z", "message": "Remove file meant for another branch.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "973a7ed28e0cb6541b0176cffc7fc1a14ccc675e", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/973a7ed28e0cb6541b0176cffc7fc1a14ccc675e", "committedDate": "2020-02-27T06:01:14Z", "message": "Merge branch 'master' into early-wake"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b11764f46b5865058e3e589ab840cfa5a0793ef4", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/b11764f46b5865058e3e589ab840cfa5a0793ef4", "committedDate": "2020-02-27T06:11:09Z", "message": "Remove commented out timeouts.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "b11764f46b5865058e3e589ab840cfa5a0793ef4", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/b11764f46b5865058e3e589ab840cfa5a0793ef4", "committedDate": "2020-02-27T06:11:09Z", "message": "Remove commented out timeouts.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "797960bc23b99c1859a69751db6b37aefb3a7c33", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/797960bc23b99c1859a69751db6b37aefb3a7c33", "committedDate": "2020-02-27T06:22:33Z", "message": "Suppress spotbugs error\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6", "committedDate": "2020-02-27T06:23:41Z", "message": "naming\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NDk2Mjkw", "url": "https://github.com/pravega/pravega/pull/4579#pullrequestreview-365496290", "createdAt": "2020-02-27T08:41:56Z", "commit": {"oid": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwOTo0MzowM1rOFvLUNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMDoxMDozOFrOFvMTOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAxMjc5MQ==", "bodyText": "My understanding of this change is as follows.\n\" The segment Reader is null in case all the EventSegmentReaders for the streams are not ready. In such a scenario, EventStreamReader waits for 1000ms until any one of the EventSegmentReader receives data semaphore.release() on receiving data. \"", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385012791", "createdAt": "2020-02-27T09:43:03Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java", "diffHunk": "@@ -127,7 +131,8 @@\n             }\n             EventSegmentReader segmentReader = orderer.nextSegment(readers);\n             if (segmentReader == null) {\n-                Exceptions.handleInterrupted(() -> Thread.sleep(firstByteTimeoutMillis));\n+                blockFor(firstByteTimeoutMillis);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAxNTE5NA==", "bodyText": "It can so happen that segmentWithData.release() is invoked post invocation of segmentsWithData.drainPermits(). This would cause the permit counter to increment. Wouldn't this prevent the blocking next time around ?", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385015194", "createdAt": "2020-02-27T09:47:09Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java", "diffHunk": "@@ -127,7 +131,8 @@\n             }\n             EventSegmentReader segmentReader = orderer.nextSegment(readers);\n             if (segmentReader == null) {\n-                Exceptions.handleInterrupted(() -> Thread.sleep(firstByteTimeoutMillis));\n+                blockFor(firstByteTimeoutMillis);\n+                segmentsWithData.drainPermits();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAyNjk0NA==", "bodyText": "This change would cause to complete checkpointing of all the pending silent checkpoints for this reader. In the older code the application would have to invoke readNextEvent() again to clear this, right ?", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385026944", "createdAt": "2020-02-27T10:06:54Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java", "diffHunk": "@@ -201,20 +213,19 @@ private String updateGroupStateIfNeeded() throws ReaderNotInReaderGroupException\n                     releaseSegmentsIfNeeded(position);\n                     atCheckpoint = null;\n                 }\n-                return null;\n+                checkpoint = groupState.getCheckpoint();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAyODkyMQ==", "bodyText": "The waiting time is now increased from 10ms to 1000ms .Any specific reason for this ?", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385028921", "createdAt": "2020-02-27T10:10:38Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java", "diffHunk": "@@ -59,7 +61,7 @@\n public class EventStreamReaderImpl<Type> implements EventStreamReader<Type> {\n \n     // Base waiting time for a reader on an idle segment waiting for new data to be read.\n-    private static final long BASE_READER_WAITING_TIME_MS = 10;\n+    private static final long BASE_READER_WAITING_TIME_MS = ReaderGroupStateManager.TIME_UNIT.toMillis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1Nzk5NDc3", "url": "https://github.com/pravega/pravega/pull/4579#pullrequestreview-365799477", "createdAt": "2020-02-27T16:21:23Z", "commit": {"oid": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjoyMToyM1rOFvXx4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjoyMToyM1rOFvXx4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIxNjk5NA==", "bodyText": "semaphore", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385216994", "createdAt": "2020-02-27T16:21:23Z", "author": {"login": "andreipaduroiu"}, "path": "client/src/main/java/io/pravega/client/segment/impl/SegmentInputStreamFactory.java", "diffHunk": "@@ -48,10 +49,11 @@\n      * does not exist.\n      *\n      * @param segment The segment to create an input for.\n+     * @param hasData A semephore that will have `release` called when data is available.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1ODE3NTE1", "url": "https://github.com/pravega/pravega/pull/4579#pullrequestreview-365817515", "createdAt": "2020-02-27T16:42:12Z", "commit": {"oid": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjo0MjoxMlrOFvYoKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNjo0MjoxMlrOFvYoKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIzMDg5MA==", "bodyText": "Typo", "url": "https://github.com/pravega/pravega/pull/4579#discussion_r385230890", "createdAt": "2020-02-27T16:42:12Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/stream/impl/EventStreamReaderImpl.java", "diffHunk": "@@ -155,6 +160,13 @@\n                                    new EventPointerImpl(segment, offset, length), null);\n     }\n \n+    private void blockFor(long timeoutMs) {\n+        Exceptions.handleInterrupted(() -> {\n+            @SuppressWarnings(\"unused\")\n+            boolean aquired = segmentsWithData.tryAcquire(timeoutMs, TimeUnit.MILLISECONDS);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f4b3d8a73a8f5c8af3e01b1a95bbaae136d4ae6"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9679414633d483b2ddf51249e1759fd9f0703560", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/9679414633d483b2ddf51249e1759fd9f0703560", "committedDate": "2020-02-27T19:00:24Z", "message": "Typos\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b4e8c768dfb508741a6b24dee35b5351630819f", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/3b4e8c768dfb508741a6b24dee35b5351630819f", "committedDate": "2020-02-27T22:03:38Z", "message": "Merge branch 'master' into early-wake"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDMyNTcw", "url": "https://github.com/pravega/pravega/pull/4579#pullrequestreview-366032570", "createdAt": "2020-02-27T22:04:14Z", "commit": {"oid": "3b4e8c768dfb508741a6b24dee35b5351630819f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MTQ3MTI4", "url": "https://github.com/pravega/pravega/pull/4579#pullrequestreview-366147128", "createdAt": "2020-02-28T03:50:47Z", "commit": {"oid": "3b4e8c768dfb508741a6b24dee35b5351630819f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3601, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}