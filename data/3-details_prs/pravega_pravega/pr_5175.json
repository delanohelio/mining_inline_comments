{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0NjA2NDA0", "number": 5175, "title": "Issue 5166: In deleteScope(deleteStreams) method, handle seal stream failures", "bodyText": "Signed-off-by: Shivesh Ranjan shivesh.ranjan@gmail.com\nChange log description\nHandle seal stream failures in deleteScope(deleteStreams) method which would attempt to delete the stream even if seal fails. Such attempts may fail unless the stream was stuck in creating state.\nPurpose of the change\nFixes #5166\nWhat the code does\nIn delete scope we first attempt to seal the stream and if it fails, we handle the exception and directly proceed to delete the stream. If delete stream also fails we throw delete scope failed exception\nHow to verify it\nUnit test added", "createdAt": "2020-09-11T03:45:13Z", "url": "https://github.com/pravega/pravega/pull/5175", "merged": true, "mergeCommit": {"oid": "8adf64332eaf709b2182a4681f7a44e8413da5fd"}, "closed": true, "closedAt": "2020-09-14T11:52:15Z", "author": {"login": "shiveshr"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHsSUMAH2gAyNDg0NjA2NDA0OmYyZDU2MTMzYjk1ZGUxMDM1YWIyODRiMDhmMDk4ODExYjM0ZjBkYmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH4XGMgH2gAyNDg0NjA2NDA0OmE4MjRjOTVkYTJhZWEyYmI2NmZiNmYxZjc5MGZjYTMxYzg1NmJjNzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f2d56133b95de1035ab284b08f098811b34f0dbb", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/f2d56133b95de1035ab284b08f098811b34f0dbb", "committedDate": "2020-09-11T02:50:32Z", "message": "Issue 5166: Attempt to delete stream even if seal fails\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e53dd03c028389a538185acb1ddb145ed1b8dc94", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/e53dd03c028389a538185acb1ddb145ed1b8dc94", "committedDate": "2020-09-11T03:46:16Z", "message": "DeleteScopeFailedException\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "e53dd03c028389a538185acb1ddb145ed1b8dc94", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/e53dd03c028389a538185acb1ddb145ed1b8dc94", "committedDate": "2020-09-11T03:46:16Z", "message": "DeleteScopeFailedException\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NDU1NDE1", "url": "https://github.com/pravega/pravega/pull/5175#pullrequestreview-486455415", "createdAt": "2020-09-11T03:51:42Z", "commit": {"oid": "e53dd03c028389a538185acb1ddb145ed1b8dc94"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwMzo1MTo0MlrOHQNVYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNDowNDoyMFrOHQNhDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc1NzczMA==", "bodyText": "Can we update the java doc too? The user would need to catch this exception while deleting a stream and he can choose to retry deleting the scope.", "url": "https://github.com/pravega/pravega/pull/5175#discussion_r486757730", "createdAt": "2020-09-11T03:51:42Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/admin/impl/StreamManagerImpl.java", "diffHunk": "@@ -158,8 +160,16 @@ public boolean deleteScope(String scopeName, boolean deleteStreams) {\n                 Stream stream = iterator.next();\n                 // If the stream was removed by another request while we attempted to seal it, we could get InvalidStreamException. \n                 Futures.getThrowingException(Futures.exceptionallyExpecting(controller.sealStream(stream.getScope(), stream.getStreamName()),\n-                          e -> Exceptions.unwrap(e) instanceof InvalidStreamException, null));\n-                Futures.getThrowingException(controller.deleteStream(stream.getScope(), stream.getStreamName()));\n+                        e -> {\n+                            Throwable unwrap = Exceptions.unwrap(e);\n+                            // ignore failures if the stream doesnt exist or we are unable to seal it. \n+                            return unwrap instanceof InvalidStreamException || unwrap instanceof ControllerFailureException;\n+                        }, false)\n+                        .thenCompose(sealed -> controller.deleteStream(stream.getScope(), stream.getStreamName())\n+                                                         .exceptionally(e -> {\n+                                                             String message = String.format(\"Failed to seal and delete stream %s\", stream.getStreamName());\n+                                                             throw new DeleteScopeFailedException(message, e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e53dd03c028389a538185acb1ddb145ed1b8dc94"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc2MDcxOA==", "bodyText": "A checked exception would make this more clear to the user right?", "url": "https://github.com/pravega/pravega/pull/5175#discussion_r486760718", "createdAt": "2020-09-11T04:04:20Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/stream/DeleteScopeFailedException.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/**\n+  * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.client.stream;\n+\n+/**\n+ * Delete scope failed, typically because we failed to seal and delete the streams. \n+ */\n+public class DeleteScopeFailedException extends RuntimeException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e53dd03c028389a538185acb1ddb145ed1b8dc94"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edc9f3afc7425c8294257eefeec03c09d637a17e", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/edc9f3afc7425c8294257eefeec03c09d637a17e", "committedDate": "2020-09-11T04:15:46Z", "message": "PR comment\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NDY3NDY3", "url": "https://github.com/pravega/pravega/pull/5175#pullrequestreview-486467467", "createdAt": "2020-09-11T04:36:29Z", "commit": {"oid": "edc9f3afc7425c8294257eefeec03c09d637a17e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8da751c0500d67c876e6a16fe0aafbb8ece959ef", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/8da751c0500d67c876e6a16fe0aafbb8ece959ef", "committedDate": "2020-09-11T16:52:13Z", "message": "Merge branch 'master' into issue5166"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1a58904447b58510a94436d0f44db4d6e110346", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/b1a58904447b58510a94436d0f44db4d6e110346", "committedDate": "2020-09-11T16:54:13Z", "message": "Remove unused constructors\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a824c95da2aea2bb66fb6f1f790fca31c856bc78", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/a824c95da2aea2bb66fb6f1f790fca31c856bc78", "committedDate": "2020-09-11T16:54:37Z", "message": "Merge branch 'issue5166' of https://github.com/shiveshr/pravega-1 into issue5166"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3861, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}