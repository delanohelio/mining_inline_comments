{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0NTY0NTQx", "number": 5044, "title": "Issue 4476: Truncate internal streams to reclaim storage space", "bodyText": "Signed-off-by: Shivesh Ranjan shivesh.ranjan@gmail.com\nChange log description\nTruncate internal streams used by controller periodically using the event position from the event that has been successfully processed.\nPurpose of the change\nFixes #4476\nWhat the code does\nWhen controller event processors are initialized, we also initialize a periodic loop for each of the event processor groups for truncating the stream by deriving a streamcut from the checkpointed positions of all readers in the readergroup.\nHow to verify it\nUnit tests added", "createdAt": "2020-08-07T11:58:15Z", "url": "https://github.com/pravega/pravega/pull/5044", "merged": true, "mergeCommit": {"oid": "1cd81f2e08d2f9ef49ccc25bb7ba934b852880bd"}, "closed": true, "closedAt": "2020-08-13T20:06:43Z", "author": {"login": "shiveshr"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8izy0gH2gAyNDY0NTY0NTQxOmMwNGU5NDQwZGIzYjM1MGEzMDNmYjhjZjc2N2ZlMzg2NjUzMThiYzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-jcvBgH2gAyNDY0NTY0NTQxOjJkYWMwNDFiNWZlNmQ2YTJhMzhmODY4Y2RjNzVmNWIwOWJiYzc1OGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c04e9440db3b350a303fb8cf767fe38665318bc4", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/c04e9440db3b350a303fb8cf767fe38665318bc4", "committedDate": "2020-08-07T11:34:53Z", "message": "truncate internal streams\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad3ad9e6a71b1171c4c57ddad53ae192f7e22688", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/ad3ad9e6a71b1171c4c57ddad53ae192f7e22688", "committedDate": "2020-08-07T12:00:58Z", "message": "Use 2 minute truncation interval\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1719870dc643e74c0e607182f150f3ec35213cab", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/1719870dc643e74c0e607182f150f3ec35213cab", "committedDate": "2020-08-07T12:06:26Z", "message": "checkstyle\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15e488e28800c0e0fc91ce1fb39ec04edc709f86", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/15e488e28800c0e0fc91ce1fb39ec04edc709f86", "committedDate": "2020-08-07T15:23:25Z", "message": "submit truncate stream job\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89a5442ed3c6d59cd26cd1c01326e79a6f57e669", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/89a5442ed3c6d59cd26cd1c01326e79a6f57e669", "committedDate": "2020-08-07T15:31:10Z", "message": "increase truncation interval\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6fd2a2055b9c4b1e132da1535b16a396bbd482f", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/b6fd2a2055b9c4b1e132da1535b16a396bbd482f", "committedDate": "2020-08-07T16:56:53Z", "message": "Merge branch 'master' into issue4476"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f328b14569b4024fd6ded9b02e6e4a972b59b068", "author": {"user": {"login": "pbelgundi", "name": "Prajakta Belgundi"}}, "url": "https://github.com/pravega/pravega/commit/f328b14569b4024fd6ded9b02e6e4a972b59b068", "committedDate": "2020-08-08T04:42:53Z", "message": "Merge branch 'master' into issue4476"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNzE3OTY5", "url": "https://github.com/pravega/pravega/pull/5044#pullrequestreview-463717969", "createdAt": "2020-08-08T04:43:31Z", "commit": {"oid": "b6fd2a2055b9c4b1e132da1535b16a396bbd482f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7d779b21f8179af9b71e5740718da637311b54a", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/e7d779b21f8179af9b71e5740718da637311b54a", "committedDate": "2020-08-10T04:33:00Z", "message": "coverage\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a82dc4a35c74789e854624de50cd77befcb0adbe", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/a82dc4a35c74789e854624de50cd77befcb0adbe", "committedDate": "2020-08-10T04:33:45Z", "message": "Merge branch 'issue4476' of https://github.com/shiveshr/pravega-1 into issue4476"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cd7c83488c2ae8734eb25ac024833fec48852e4", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/7cd7c83488c2ae8734eb25ac024833fec48852e4", "committedDate": "2020-08-10T06:31:15Z", "message": "checkstyle\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14ca9d91ad5526d803c06403ba42063258c9a05d", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/14ca9d91ad5526d803c06403ba42063258c9a05d", "committedDate": "2020-08-13T14:34:01Z", "message": "Merge branch 'master' into issue4476"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2ODI2MTQw", "url": "https://github.com/pravega/pravega/pull/5044#pullrequestreview-466826140", "createdAt": "2020-08-13T14:37:51Z", "commit": {"oid": "14ca9d91ad5526d803c06403ba42063258c9a05d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNDozNzo1MlrOHAOmWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNDozODoyOFrOHAOn-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwMTI0MA==", "bodyText": "You need to add a check inside truncate to verify if isRunning() == true. Otherwise we can stop this service, but since this still has a 10-second delay, it will execute one call of truncate and then cancel it. This may not be the intended behavior.", "url": "https://github.com/pravega/pravega/pull/5044#discussion_r470001240", "createdAt": "2020-08-13T14:37:52Z", "author": {"login": "andreipaduroiu"}, "path": "controller/src/main/java/io/pravega/controller/server/eventProcessor/ControllerEventProcessors.java", "diffHunk": "@@ -288,9 +300,67 @@ public boolean isReady() {\n             streamMetadataTasks.initializeStreamWriters(clientFactory, config.getRequestStreamName());\n             streamTransactionMetadataTasks.initializeStreamWriters(clientFactory, config);\n             tableMetadataTasks.initializeStreamWriters(clientFactory, config.getKvtStreamName());\n+\n+            long delay = truncationInterval.get();\n+            Futures.loop(this::isRunning, () -> Futures.delayedFuture(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14ca9d91ad5526d803c06403ba42063258c9a05d"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDAwMTY1Nw==", "bodyText": "Why don't you inherit from ThreadPoolTestBase which will manage the executor for you?", "url": "https://github.com/pravega/pravega/pull/5044#discussion_r470001657", "createdAt": "2020-08-13T14:38:28Z", "author": {"login": "andreipaduroiu"}, "path": "controller/src/test/java/io/pravega/controller/server/eventProcessor/ControllerEventProcessorsTest.java", "diffHunk": "@@ -50,18 +59,14 @@\n import static org.junit.Assert.assertTrue;\n import static org.mockito.ArgumentMatchers.any;\n import static org.mockito.ArgumentMatchers.anyString;\n-import static org.mockito.Mockito.doAnswer;\n-import static org.mockito.Mockito.mock;\n-import static org.mockito.Mockito.times;\n-import static org.mockito.Mockito.verify;\n-import static org.mockito.Mockito.when;\n+import static org.mockito.Mockito.*;\n \n public class ControllerEventProcessorsTest {\n     ScheduledExecutorService executor;\n \n     @Before\n     public void setUp() {\n-        executor = Executors.newSingleThreadScheduledExecutor();\n+        executor = Executors.newScheduledThreadPool(10);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14ca9d91ad5526d803c06403ba42063258c9a05d"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4dfacb584378cbc335169f08ca1e739f8ff0d53", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/b4dfacb584378cbc335169f08ca1e739f8ff0d53", "committedDate": "2020-08-13T15:52:43Z", "message": "Merge branch 'master' into issue4476"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "802e70b11b9071f185db5c8a88cd46f898deb00d", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/802e70b11b9071f185db5c8a88cd46f898deb00d", "committedDate": "2020-08-13T16:04:49Z", "message": "PR comments\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7385c88fe6ee52b26f48e6a4de0ac4d22f0bc4de", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/7385c88fe6ee52b26f48e6a4de0ac4d22f0bc4de", "committedDate": "2020-08-13T16:05:08Z", "message": "Merge branch 'issue4476' of https://github.com/shiveshr/pravega-1 into issue4476"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2OTEyNDg2", "url": "https://github.com/pravega/pravega/pull/5044#pullrequestreview-466912486", "createdAt": "2020-08-13T16:12:50Z", "commit": {"oid": "7385c88fe6ee52b26f48e6a4de0ac4d22f0bc4de"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dac041b5fe6d6a2a38f868cdc75f5b09bbc758b", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/2dac041b5fe6d6a2a38f868cdc75f5b09bbc758b", "committedDate": "2020-08-13T17:27:27Z", "message": "checkstyle\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4019, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}