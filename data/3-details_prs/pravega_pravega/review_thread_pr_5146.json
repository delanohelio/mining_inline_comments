{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwNTE5Mzkz", "number": 5146, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNToyODo0OFrOEgyPpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0NDowMlrOEhTsxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyODEzMDk1OnYy", "diffSide": "RIGHT", "path": "client/src/main/java/io/pravega/client/connection/impl/TcpClientConnection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNToyODo0OFrOHNwmvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNjoxNDoxOFrOHNxYoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE4OTg4Nw==", "bodyText": "Should the get and set separated out here?\n\nThis method returns if get stop returns true.\nSet is called after the callback is complete, using compareAndSet(false, true).\n\nThis might be especially useful if `callback.connectionDropped() can fail with an exception.\nOn the other hand, if the failure of connectionDropped() call can be safely discounted, the existing code'd be OK.", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484189887", "createdAt": "2020-09-07T05:28:48Z", "author": {"login": "ravisharda"}, "path": "client/src/main/java/io/pravega/client/connection/impl/TcpClientConnection.java", "diffHunk": "@@ -159,7 +159,9 @@ static WireCommand readCommand(InputStream in, IoBuffer buffer) throws IOExcepti\n         }\n         \n         public void stop() {\n-            stop.set(true);\n+            if (stop.getAndSet(true)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4035f9d989abbe87b84c1530272d974a80833f62"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwMjY1Ng==", "bodyText": "yeah, the idea is to ensure that we do not stop and already stopped/closed connection.", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484202656", "createdAt": "2020-09-07T06:14:18Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/connection/impl/TcpClientConnection.java", "diffHunk": "@@ -159,7 +159,9 @@ static WireCommand readCommand(InputStream in, IoBuffer buffer) throws IOExcepti\n         }\n         \n         public void stop() {\n-            stop.set(true);\n+            if (stop.getAndSet(true)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE4OTg4Nw=="}, "originalCommit": {"oid": "4035f9d989abbe87b84c1530272d974a80833f62"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyODEzNDY1OnYy", "diffSide": "RIGHT", "path": "client/src/main/java/io/pravega/client/connection/impl/ConnectionPoolImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNTozMTowM1rOHNwo1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNzowNzo0N1rOHNypjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5MDQyMw==", "bodyText": "Why is this change required? My reading from the code in the method is that it shouldn't be necessary to do this.", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484190423", "createdAt": "2020-09-07T05:31:03Z", "author": {"login": "ravisharda"}, "path": "client/src/main/java/io/pravega/client/connection/impl/ConnectionPoolImpl.java", "diffHunk": "@@ -186,6 +186,7 @@ public void pruneUnusedConnections() {\n     }\n \n     @Override\n+    @Synchronized", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4035f9d989abbe87b84c1530272d974a80833f62"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIyMzM3NQ==", "bodyText": "Yeah, there can be a getClientConnection() invocation which would update the map after a connection creation while this close() method is invoked.", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484223375", "createdAt": "2020-09-07T07:07:47Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/connection/impl/ConnectionPoolImpl.java", "diffHunk": "@@ -186,6 +186,7 @@ public void pruneUnusedConnections() {\n     }\n \n     @Override\n+    @Synchronized", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5MDQyMw=="}, "originalCommit": {"oid": "4035f9d989abbe87b84c1530272d974a80833f62"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyODE0MDYxOnYy", "diffSide": "RIGHT", "path": "client/src/main/java/io/pravega/client/stream/impl/ClientFactoryImpl.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNTozNDo1MlrOHNwsSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNjoxNTowN1rOHNxZ2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5MTMwNw==", "bodyText": "nit: There is no timeout duration specified, unlike what the comment suggests. This comment might be referring on the default value used in the shutdown method. If someone changes that value, this comment would go stale. It might be useful rather to say something like Wait for default timeout duration before...", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484191307", "createdAt": "2020-09-07T05:34:52Z", "author": {"login": "ravisharda"}, "path": "client/src/main/java/io/pravega/client/stream/impl/ClientFactoryImpl.java", "diffHunk": "@@ -244,8 +244,10 @@ private Segment getSegmentForRevisionedClient(String scope, String streamName) {\n \n     @Override\n     public void close() {\n-        controller.close();\n+        // wait for 5 seconds before forcibly terminating the watermarkReader threads.\n+        ExecutorServiceHelpers.shutdown(watermarkReaderThreads);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4035f9d989abbe87b84c1530272d974a80833f62"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDIwMjk3MQ==", "bodyText": "updated it.", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484202971", "createdAt": "2020-09-07T06:15:07Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/stream/impl/ClientFactoryImpl.java", "diffHunk": "@@ -244,8 +244,10 @@ private Segment getSegmentForRevisionedClient(String scope, String streamName) {\n \n     @Override\n     public void close() {\n-        controller.close();\n+        // wait for 5 seconds before forcibly terminating the watermarkReader threads.\n+        ExecutorServiceHelpers.shutdown(watermarkReaderThreads);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5MTMwNw=="}, "originalCommit": {"oid": "4035f9d989abbe87b84c1530272d974a80833f62"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMzYxMjIwOnYy", "diffSide": "RIGHT", "path": "client/src/main/java/io/pravega/client/control/impl/ControllerResolverFactory.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0NDowMlrOHOjTZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNToxMjoxMFrOHPMOTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMDUxOA==", "bodyText": "FYI, this has no effect. It is not implemented in the JRE.", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r485020518", "createdAt": "2020-09-08T15:44:02Z", "author": {"login": "andreipaduroiu"}, "path": "client/src/main/java/io/pravega/client/control/impl/ControllerResolverFactory.java", "diffHunk": "@@ -201,7 +201,7 @@ public void start(Listener listener) {\n         public void shutdown() {\n             shutdown = true;\n             if (scheduledFuture != null) {\n-                scheduledFuture.cancel(false);\n+                scheduledFuture.cancel(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58e09aef8a10b82bfb2878ee95f75609d6e65163"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTMwNTg3MA==", "bodyText": "This is a ScheduledFuture on which cancel() is invoked.\n public ScheduledFuture<?> schedule(Runnable command, long delay, TimeUnit unit);\nAs I understand your comment applies only on a CompletableFuture. let me know...", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r485305870", "createdAt": "2020-09-09T02:50:23Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/control/impl/ControllerResolverFactory.java", "diffHunk": "@@ -201,7 +201,7 @@ public void start(Listener listener) {\n         public void shutdown() {\n             shutdown = true;\n             if (scheduledFuture != null) {\n-                scheduledFuture.cancel(false);\n+                scheduledFuture.cancel(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMDUxOA=="}, "originalCommit": {"oid": "58e09aef8a10b82bfb2878ee95f75609d6e65163"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY5MDk1Ng==", "bodyText": "Ah I missed that one. Nevermind then :)", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r485690956", "createdAt": "2020-09-09T15:12:10Z", "author": {"login": "andreipaduroiu"}, "path": "client/src/main/java/io/pravega/client/control/impl/ControllerResolverFactory.java", "diffHunk": "@@ -201,7 +201,7 @@ public void start(Listener listener) {\n         public void shutdown() {\n             shutdown = true;\n             if (scheduledFuture != null) {\n-                scheduledFuture.cancel(false);\n+                scheduledFuture.cancel(true);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMDUxOA=="}, "originalCommit": {"oid": "58e09aef8a10b82bfb2878ee95f75609d6e65163"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4674, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}