{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2OTQzMjUy", "number": 4882, "title": "Issue 4875: Modify name resolution strategy of configuration properties for backward compatibility", "bodyText": "Change log description\nModify the name resolution strategy for configuration properties to use legacy names first, for backward compatibility.\nPurpose of the change\nResolves #4875.\nWhat the code does\nPreviously, the properties were resolved in a way that if a property with a new name was present, it'd override any property specified using the old name. For example, if you specified both metrics.enableStatistics=true (old name) and metrics.statistics.enable=false (new name), segment store metrics would be enabled. These properties may be specified either via properties file (config.properties) or Java system properties (say, via the deployment manifest file).\nHowever, this behavior doesn't work in some cases. For example, Segment Store loads all the properties from config.properties as well as the system properties. In the config.properties a preconfigured property metrics.statistics.enable=false is already set.  So, if you specified the above property as metrics.enableStatistics=true in the deployment manifest, the default from config.properties file would still apply. That is why segment store metrics were not showing up, as described in issue #4875.\n\n  \n    \n      pravega/segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/ServiceStarter.java\n    \n    \n        Lines 256 to 260\n      in\n      3a0164c\n    \n    \n    \n    \n\n        \n          \n           ServiceBuilderConfig config = ServiceBuilderConfig \n        \n\n        \n          \n                   .builder() \n        \n\n        \n          \n                   .include(System.getProperty(ServiceBuilderConfig.CONFIG_FILE_PROPERTY_NAME, \"config.properties\")) \n        \n\n        \n          \n                   .include(System.getProperties()) \n        \n\n        \n          \n                   .build(); \n        \n    \n  \n\n\nNote that this problem was limited to configuration properties that had default values specified in the configuration properties file.\nTo ensure that such properties can be overridden properly using old property names, this PR changes the resolution order. So, if you specify metrics.enableStatistics=true in the deployment manifest, segment store metrics would be enabled. If you specified it using the new name metrics.statistics.enable=true, then too metrics will be enabled.\nHow to verify it\nAll tests, including system tests, must pass.", "createdAt": "2020-06-19T07:38:06Z", "url": "https://github.com/pravega/pravega/pull/4882", "merged": true, "mergeCommit": {"oid": "d3799d2afec5494ab8b4c7cd30a54b0646f8427a"}, "closed": true, "closedAt": "2020-06-22T15:20:42Z", "author": {"login": "ravisharda"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcstt7xgH2gAyNDM2OTQzMjUyOjc4NmFhYWM4ODZkZTNjZTgwOGJiMzU5NGYyYzI4ZWY1YzliODFiZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABctydymAFqTQzNTAyOTc1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "786aaac886de3ce808bb3594f2c28ef5c9b81be3", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/786aaac886de3ce808bb3594f2c28ef5c9b81be3", "committedDate": "2020-06-19T07:14:39Z", "message": "Modify the strategy for property load to legacy first\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzOTAyOTM3", "url": "https://github.com/pravega/pravega/pull/4882#pullrequestreview-433902937", "createdAt": "2020-06-19T08:36:27Z", "commit": {"oid": "786aaac886de3ce808bb3594f2c28ef5c9b81be3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MDcyOTE4", "url": "https://github.com/pravega/pravega/pull/4882#pullrequestreview-434072918", "createdAt": "2020-06-19T13:22:36Z", "commit": {"oid": "786aaac886de3ce808bb3594f2c28ef5c9b81be3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjMyMjE4", "url": "https://github.com/pravega/pravega/pull/4882#pullrequestreview-434232218", "createdAt": "2020-06-19T17:16:37Z", "commit": {"oid": "786aaac886de3ce808bb3594f2c28ef5c9b81be3"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoxNjozN1rOGmcA9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzoxNjozN1rOGmcA9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk1ODA2OQ==", "bodyText": "Let's add a log.warn to this code and notify users that they are using a deprecated property name.\nmaybe something like\nDeprecated property name '{}' used. Please use '{}' instead. Support for the old property name will be removed in a future version of Pravega.", "url": "https://github.com/pravega/pravega/pull/4882#discussion_r442958069", "createdAt": "2020-06-19T17:16:37Z", "author": {"login": "andreipaduroiu"}, "path": "common/src/main/java/io/pravega/common/util/TypedProperties.java", "diffHunk": "@@ -125,27 +125,35 @@ public boolean getBoolean(Property<Boolean> property) throws ConfigurationExcept\n     }\n \n     private <T> T tryGet(Property<T> property, Function<String, T> converter) {\n-        String fullKeyName = this.keyPrefix + property.getName();\n+        String propNewName = this.keyPrefix + property.getName();\n+        String propOldName = this.keyPrefix + property.getLegacyName();\n+        String propValue = null;\n \n-        // Get value from config.\n-        String value = this.properties.getProperty(fullKeyName, null);\n+        if (property.hasLegacyName()) {\n+            // Value of property with old name\n+            propValue = this.properties.getProperty(propOldName, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "786aaac886de3ce808bb3594f2c28ef5c9b81be3"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjM5OTIx", "url": "https://github.com/pravega/pravega/pull/4882#pullrequestreview-434239921", "createdAt": "2020-06-19T17:30:35Z", "commit": {"oid": "786aaac886de3ce808bb3594f2c28ef5c9b81be3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzozMDozNVrOGmcY6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzozMDozNVrOGmcY6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2NDIwMg==", "bodyText": "Same here, please call out the exact property name being used.", "url": "https://github.com/pravega/pravega/pull/4882#discussion_r442964202", "createdAt": "2020-06-19T17:30:35Z", "author": {"login": "kevinhan88"}, "path": "common/src/main/java/io/pravega/common/util/TypedProperties.java", "diffHunk": "@@ -125,27 +125,35 @@ public boolean getBoolean(Property<Boolean> property) throws ConfigurationExcept\n     }\n \n     private <T> T tryGet(Property<T> property, Function<String, T> converter) {\n-        String fullKeyName = this.keyPrefix + property.getName();\n+        String propNewName = this.keyPrefix + property.getName();\n+        String propOldName = this.keyPrefix + property.getLegacyName();\n+        String propValue = null;\n \n-        // Get value from config.\n-        String value = this.properties.getProperty(fullKeyName, null);\n+        if (property.hasLegacyName()) {\n+            // Value of property with old name\n+            propValue = this.properties.getProperty(propOldName, null);\n+        }\n \n-        if (value == null && property.hasLegacyName()) {\n-            value = this.properties.getProperty(this.keyPrefix + property.getLegacyName(), null);\n+        if (propValue == null) {\n+            // Value of property with new name\n+            propValue = this.properties.getProperty(propNewName, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "786aaac886de3ce808bb3594f2c28ef5c9b81be3"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjQwMjEy", "url": "https://github.com/pravega/pravega/pull/4882#pullrequestreview-434240212", "createdAt": "2020-06-19T17:31:12Z", "commit": {"oid": "786aaac886de3ce808bb3594f2c28ef5c9b81be3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzozMToxMlrOGmcaCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzozMToxMlrOGmcaCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk2NDQ4OQ==", "bodyText": "Also call out in log that default value is being used.", "url": "https://github.com/pravega/pravega/pull/4882#discussion_r442964489", "createdAt": "2020-06-19T17:31:12Z", "author": {"login": "kevinhan88"}, "path": "common/src/main/java/io/pravega/common/util/TypedProperties.java", "diffHunk": "@@ -125,27 +125,35 @@ public boolean getBoolean(Property<Boolean> property) throws ConfigurationExcept\n     }\n \n     private <T> T tryGet(Property<T> property, Function<String, T> converter) {\n-        String fullKeyName = this.keyPrefix + property.getName();\n+        String propNewName = this.keyPrefix + property.getName();\n+        String propOldName = this.keyPrefix + property.getLegacyName();\n+        String propValue = null;\n \n-        // Get value from config.\n-        String value = this.properties.getProperty(fullKeyName, null);\n+        if (property.hasLegacyName()) {\n+            // Value of property with old name\n+            propValue = this.properties.getProperty(propOldName, null);\n+        }\n \n-        if (value == null && property.hasLegacyName()) {\n-            value = this.properties.getProperty(this.keyPrefix + property.getLegacyName(), null);\n+        if (propValue == null) {\n+            // Value of property with new name\n+            propValue = this.properties.getProperty(propNewName, null);\n         }\n-        if (value == null) {\n-            // 2. Nothing in the configuration for this Property.\n+\n+        // A property with neither old not new name was defined, so the property value is still null\n+        if (propValue == null) {\n             if (property.hasDefaultValue()) {\n                 return property.getDefaultValue();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "786aaac886de3ce808bb3594f2c28ef5c9b81be3"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5882daf18639ccb892faea51b9b2fe992dba2c7", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/f5882daf18639ccb892faea51b9b2fe992dba2c7", "committedDate": "2020-06-20T12:13:15Z", "message": "Add a comment\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1MDI5NzU5", "url": "https://github.com/pravega/pravega/pull/4882#pullrequestreview-435029759", "createdAt": "2020-06-22T15:20:28Z", "commit": {"oid": "f5882daf18639ccb892faea51b9b2fe992dba2c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3931, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}