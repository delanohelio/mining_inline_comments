{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIxNzc0MDM2", "number": 5337, "title": "Issue 5320: Metrics and Stats Reporting Optimizations", "bodyText": "Change log description\n\nChanged DynamicLoggerImpl to use a simplified Cache (instead of Guava Cache).\nOptimized SegmentStatsRecorderImpl to use fewer resources.\nReplaced usages of Dynamic Logger throughout the Segment Store codebase with the equivalent Counter, Metric and OpStatsLogger implementations.\n\nPurpose of the change\nFixes #5320.\nWhat the code does\n\nSimpleCache a very simple cache that supports a maximum-size and maximum-time eviction policy. This is about 4-8x faster than using Guava Cache (due to lower implementation overhead - as we do not need all features of Guava Cache).\n\nUses a HashMap to store values and a customized linked list to store order of access. If need be, entries will be evicted from the head of this queue.\nEntries are evicted upon access or upon invocation of cleanUp. There is no background thread or async job that maintains the cache (this aids in the simplicity and small resource utilization).\nAn \"expired\" entry is going to be treated as \"inexistent\" (w.r.t get, remove, put and putIfAbsent)\n\n\nChanged DynamicLoggerImpl:\n\nMaking use of SimpleCache instead of GuavaCache. This resulted in a 45-50% performance improvement.\nThis implementation is equivalent to the old one. Unit tests have been updated to verify that the behavior is consistent.\n\n\nSegmentStatsRecorderImpl\n\nMaking use of SimpleCache to cache values.\nReworked recordAppend to be async. The caller (AppendProcessor.handleAppendResult) will queue a value in a BlockingDrainingQueue (very small effort) and a background processor picks items from this queue (in batches) and reports the entire batch at once.\nReduced usages of DynamicLogger and using equivalent implementations of Counter for its metrics.\n\n\nAutoScaleProcessor\n\nMaking use of SimpleCache to cache values.\n\n\nAutoScaleMonitor\n\nReduced the dedicated thread pool priority.\n\n\nMetrics Reporting\n\nChanged SegmentStoreMetrics and CacheMetrics to not use DynamicLogger for Counters and Metrics. This is a more consistent implementation and more efficient.\n\nCannot change Gauge at this time due to significant API differences. Such a change may be done in the future.\n\n\n\n\nOther minor changes\n\nChanged MetricsConfig.DynamicCacheSize default value to 100,000 (down from 10,000,000). Previous value was excessive.\nRemoved a usage of String.format in ContainerMetadataUpdateTransaction. This was serving very little purpose, yet it's a frequently invoked code on the hot path.\n\n\n\nHow to verify it\nAll existing tests must pass. Some new unit tests were added and some existing tests got updated to cover more.\nSystem tests must pass.", "createdAt": "2020-11-16T16:24:10Z", "url": "https://github.com/pravega/pravega/pull/5337", "merged": true, "mergeCommit": {"oid": "aaf2540cd3180a49143cf0d9691ce72fdfead765"}, "closed": true, "closedAt": "2020-11-19T08:41:34Z", "author": {"login": "andreipaduroiu"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdboLV_gH2gAyNTIxNzc0MDM2OjgzNWE0MGM5NzMxNzFhNDRiYzkzNDNmMzRkOTlmODhhYTgxNWIxYzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdd-pBzAFqTUzNDE4NzYwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "835a40c973171a44bc9343f34d99f88aa815b1c1", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/835a40c973171a44bc9343f34d99f88aa815b1c1", "committedDate": "2020-11-12T01:21:47Z", "message": "Trying to optimize SegmentStatsRecorder.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a638ad41170fa03855e05fb6e5fe0505981a4ce4", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/a638ad41170fa03855e05fb6e5fe0505981a4ce4", "committedDate": "2020-11-13T02:17:05Z", "message": "SimpleCache.\nDynamicLoggerImpl rework\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a70879c02875dd8cc6f88f4049bb23c3b8c72103", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/a70879c02875dd8cc6f88f4049bb23c3b8c72103", "committedDate": "2020-11-13T16:00:54Z", "message": "Not using String.format in ContainerMetadataUpdateTransaction constructor.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18e8ec2c0302665c9b399aabe12d1aeb4c770b04", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/18e8ec2c0302665c9b399aabe12d1aeb4c770b04", "committedDate": "2020-11-14T00:18:12Z", "message": "SimpleCache: Using Duration as time in constructor.\nUnit tests for SimpleCache. Many bug fixes.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce359318655f5223e742986bc9cca12c30f71b7f", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/ce359318655f5223e742986bc9cca12c30f71b7f", "committedDate": "2020-11-14T00:48:46Z", "message": "CacheMetrics uses Counters as opposed from DynamicLogger.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f781cd3b48264d6f0b8090955dda182671ff957", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/5f781cd3b48264d6f0b8090955dda182671ff957", "committedDate": "2020-11-14T01:07:33Z", "message": "Moved some metrics over to Counters (from DynamicLoggers).\n\nFixed a bug in DynamicLoggerImpl.updateCounterValue.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed4517f14f50e544f22d91d9e8ddddabbddc557b", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/ed4517f14f50e544f22d91d9e8ddddabbddc557b", "committedDate": "2020-11-15T02:08:49Z", "message": "ContainerMetrics switched from DynamicLogger to Meter.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "238a97a99b067e5dd97ab45448150de256846a77", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/238a97a99b067e5dd97ab45448150de256846a77", "committedDate": "2020-11-15T02:32:57Z", "message": "BookKeeperMetrics and TableSegmentStatsRecorderImpl moved off DynamicLogger onto Counters and Metrics.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48464c48071cc5561a88bb9e4f5d354ff8da9877", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/48464c48071cc5561a88bb9e4f5d354ff8da9877", "committedDate": "2020-11-15T02:52:16Z", "message": "Moved some SegmentStatsRecorderImpl off DynamicLogger.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f9d05f4af8a0e98aa6b7a848c446d6937842bd8", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/8f9d05f4af8a0e98aa6b7a848c446d6937842bd8", "committedDate": "2020-11-15T03:58:09Z", "message": "Moved some SegmentStatsRecorderImpl off DynamicLogger.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa9b8aee8d9e5aed60b46328f13d624b6e519f7a", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/fa9b8aee8d9e5aed60b46328f13d624b6e519f7a", "committedDate": "2020-11-16T16:23:06Z", "message": "Merge remote-tracking branch 'origin/master' into issue-5320-optimize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81453cb1c555b3ffe0726f20a9c5210223621d46", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/81453cb1c555b3ffe0726f20a9c5210223621d46", "committedDate": "2020-11-16T16:58:49Z", "message": "Simplified SegmentStatsRecorderTest.\nReduced MetricsConfig.DYNAMIC_CACHE_SIZE to 100K (down from 10M).\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8caeffec2765693a5c4879bb190375fae645f39f", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/8caeffec2765693a5c4879bb190375fae645f39f", "committedDate": "2020-11-16T21:50:11Z", "message": "AppendProcessorAdapter executes callbacks async.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMDEyNzY1", "url": "https://github.com/pravega/pravega/pull/5337#pullrequestreview-532012765", "createdAt": "2020-11-17T04:26:06Z", "commit": {"oid": "8caeffec2765693a5c4879bb190375fae645f39f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNDoyNjowNlrOH0j6og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwNDo1NzoyMVrOH0kaPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg3NjQ1MA==", "bodyText": "Please be aware a min priority thread can be starved.", "url": "https://github.com/pravega/pravega/pull/5337#discussion_r524876450", "createdAt": "2020-11-17T04:26:06Z", "author": {"login": "tkaitchuck"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/stat/AutoScaleMonitor.java", "diffHunk": "@@ -34,14 +34,14 @@\n     @VisibleForTesting\n     public AutoScaleMonitor(@NonNull StreamSegmentStore store, @NonNull EventStreamClientFactory clientFactory,\n                             @NonNull AutoScalerConfig configuration) {\n-        this.executor = ExecutorServiceHelpers.newScheduledThreadPool(configuration.getThreadPoolSize(), \"auto-scaler\");\n+        this.executor = ExecutorServiceHelpers.newScheduledThreadPool(configuration.getThreadPoolSize(), \"auto-scaler\", Thread.MIN_PRIORITY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8caeffec2765693a5c4879bb190375fae645f39f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg4NDU0MQ==", "bodyText": "Is this being properly closed everywhere? (This is hard to check outside of an IDE)", "url": "https://github.com/pravega/pravega/pull/5337#discussion_r524884541", "createdAt": "2020-11-17T04:57:21Z", "author": {"login": "tkaitchuck"}, "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/cache/CacheMetrics.java", "diffHunk": "@@ -10,28 +10,41 @@\n package io.pravega.segmentstore.storage.cache;\n \n import io.pravega.shared.MetricsNames;\n-import io.pravega.shared.metrics.DynamicLogger;\n+import io.pravega.shared.metrics.Counter;\n import io.pravega.shared.metrics.MetricsProvider;\n+import io.pravega.shared.metrics.StatsLogger;\n \n /**\n- * Metrics for {@link CacheStorage}\n+ * Metrics for {@link DirectMemoryCache}.\n  */\n-final class CacheMetrics {\n-    private static final DynamicLogger DYNAMIC_LOGGER = MetricsProvider.getDynamicLogger();\n+final class CacheMetrics implements AutoCloseable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8caeffec2765693a5c4879bb190375fae645f39f"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de82857b287949cdd884755ee26cd3b26d9b821b", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/de82857b287949cdd884755ee26cd3b26d9b821b", "committedDate": "2020-11-17T14:57:24Z", "message": "Merge branch 'master' into issue-5320-optimize"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTk3NjM5", "url": "https://github.com/pravega/pravega/pull/5337#pullrequestreview-531597639", "createdAt": "2020-11-16T18:34:18Z", "commit": {"oid": "81453cb1c555b3ffe0726f20a9c5210223621d46"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxODozNDoxOFrOH0MJUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QxNToxMToxMFrOH05kww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4Njk5NQ==", "bodyText": "Please, add some description of this public class.", "url": "https://github.com/pravega/pravega/pull/5337#discussion_r524486995", "createdAt": "2020-11-16T18:34:18Z", "author": {"login": "RaulGracia"}, "path": "common/src/main/java/io/pravega/common/util/SimpleCache.java", "diffHunk": "@@ -0,0 +1,399 @@\n+/**\n+ * Copyright (c) Dell Inc., or its subsidiaries. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package io.pravega.common.util;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import com.google.common.base.Preconditions;\n+import java.time.Duration;\n+import java.util.AbstractMap;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.BiConsumer;\n+import java.util.function.Consumer;\n+import java.util.function.Supplier;\n+import javax.annotation.Nullable;\n+import javax.annotation.concurrent.GuardedBy;\n+import javax.annotation.concurrent.NotThreadSafe;\n+import javax.annotation.concurrent.ThreadSafe;\n+import lombok.Getter;\n+import lombok.NonNull;\n+import lombok.RequiredArgsConstructor;\n+import lombok.extern.slf4j.Slf4j;\n+import lombok.val;\n+\n+@ThreadSafe\n+@Slf4j\n+public class SimpleCache<KeyT, ValueT> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81453cb1c555b3ffe0726f20a9c5210223621d46"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ4ODcxMQ==", "bodyText": "Are we using Guava caches in other places of the Segment Store? It would be great to widespread the use of this effort within the codebase (even the Controller uses Guava cache).", "url": "https://github.com/pravega/pravega/pull/5337#discussion_r524488711", "createdAt": "2020-11-16T18:37:10Z", "author": {"login": "RaulGracia"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/stat/AutoScaleProcessor.java", "diffHunk": "@@ -60,10 +56,9 @@\n     private static final long TEN_MINUTES = Duration.ofMinutes(10).toMillis();\n     private static final long TWENTY_MINUTES = Duration.ofMinutes(20).toMillis();\n     private static final int MAX_CACHE_SIZE = 1000000;\n-    private static final int INITIAL_CAPACITY = 1000;\n \n     private final EventStreamClientFactory clientFactory;\n-    private final Cache<String, Pair<Long, Long>> cache;\n+    private final SimpleCache<String, Pair<Long, Long>> cache;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81453cb1c555b3ffe0726f20a9c5210223621d46"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTIzMTI5OQ==", "bodyText": "If we do not \"freeze\" these counters, are these metrics going to be reported even the segment is not there anymore?", "url": "https://github.com/pravega/pravega/pull/5337#discussion_r525231299", "createdAt": "2020-11-17T15:11:10Z", "author": {"login": "RaulGracia"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/stat/TableSegmentStatsRecorderImpl.java", "diffHunk": "@@ -67,57 +69,42 @@ public void close() {\n \n     @Override\n     public void createTableSegment(String tableSegmentName, Duration elapsed) {\n-        getCreateSegment().reportSuccessEvent(elapsed);\n+        this.createSegment.reportSuccessEvent(elapsed);\n     }\n \n     @Override\n     public void deleteTableSegment(String tableSegmentName, Duration elapsed) {\n-        getDeleteSegment().reportSuccessEvent(elapsed);\n-        String[] segmentTags = segmentTags(tableSegmentName);\n-        getDynamicLogger().freezeCounter(MetricsNames.TABLE_SEGMENT_UPDATE_CONDITIONAL, segmentTags);\n-        getDynamicLogger().freezeCounter(MetricsNames.TABLE_SEGMENT_UPDATE, segmentTags);\n-        getDynamicLogger().freezeCounter(MetricsNames.TABLE_SEGMENT_REMOVE_CONDITIONAL, segmentTags);\n-        getDynamicLogger().freezeCounter(MetricsNames.TABLE_SEGMENT_REMOVE, segmentTags);\n-        getDynamicLogger().freezeCounter(MetricsNames.TABLE_SEGMENT_GET, segmentTags);\n-        getDynamicLogger().freezeCounter(MetricsNames.TABLE_SEGMENT_ITERATE_KEYS, segmentTags);\n-        getDynamicLogger().freezeCounter(MetricsNames.TABLE_SEGMENT_ITERATE_ENTRIES, segmentTags);\n+        this.deleteSegment.reportSuccessEvent(elapsed);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de82857b287949cdd884755ee26cd3b26d9b821b"}, "originalPosition": 98}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1429d81c88a018849f23ca82b234efa47336032e", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/1429d81c88a018849f23ca82b234efa47336032e", "committedDate": "2020-11-17T18:26:56Z", "message": "Javadoc.\n\nSigned-off-by: Andrei Paduroiu <andrei.paduroiu@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a737e6bde7cc79b2a36a3d2335e3fed37516d9d", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/9a737e6bde7cc79b2a36a3d2335e3fed37516d9d", "committedDate": "2020-11-17T18:27:02Z", "message": "Merge remote-tracking branch 'ap/issue-5320-optimize' into issue-5320-optimize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3da8ebf2ffccfeaf184263934c9ac0f78f34c43a", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/3da8ebf2ffccfeaf184263934c9ac0f78f34c43a", "committedDate": "2020-11-18T16:44:18Z", "message": "Merge branch 'master' into issue-5320-optimize"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MTg3NjA2", "url": "https://github.com/pravega/pravega/pull/5337#pullrequestreview-534187606", "createdAt": "2020-11-19T08:39:58Z", "commit": {"oid": "3da8ebf2ffccfeaf184263934c9ac0f78f34c43a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3735, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}