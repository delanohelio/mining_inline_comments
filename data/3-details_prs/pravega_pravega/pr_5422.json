{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2MzgxNjU0", "number": 5422, "title": "Issue 5421: Avoid closing pre-existing metrics.", "bodyText": "Change log description\nIn the case a duplicate meter on a StatsLogger is ever created, it avoids inadvertently closing the very same metric we are trying to use.\nPurpose of the change\nFixes #5421\nWhat the code does\n\nThe old implementation attempted to an optimistic scheme, creating a metric in advance and removing it if it already exists. The problem with this approach is creating another metric (Meter) that already exists within the CompositeMeterRegistry returns the same instance. If one exists already, we are therefore closing this existing metric, removing it from the CompositeMeterRegistry making invisible to any sort of exporter.\n\nUnless we rework the metrics to a larger degree, it does not seem there is a way of getting around the use of computeIfAbsent. Many of the operations of MetricProxy have side effects, so the entire getOrSet operation must be atomic or we risk using invalidate objects during concurrent accesses.\nAlmost all StatsLoggerProxy method calls are either static or done during initialization of long lived objects so there should be minimal blocking through use of computeIfAbsent.", "createdAt": "2020-12-11T01:10:58Z", "url": "https://github.com/pravega/pravega/pull/5422", "merged": true, "mergeCommit": {"oid": "6e39d9ca44c01fbf59b257d934ad273c57d4a9d5"}, "closed": true, "closedAt": "2020-12-17T10:45:52Z", "author": {"login": "co-jo"}, "timelineItems": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTIK3HAH2gAyNTM2MzgxNjU0Ojc2YTgxZWU5YTc1YTBkNmI1MGQzNmUxYmUyZmEyODM2NjI0NDQ4M2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdm_6CRAFqTU1NDQwODEwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "76a81ee9a75a0d6b50d36e1be2fa28366244483a", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/76a81ee9a75a0d6b50d36e1be2fa28366244483a", "committedDate": "2020-10-16T15:32:54Z", "message": "Testing changes to fix Jenkins name resolution problem.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d773a263dcc3db971355e77116c796a15307fd6", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/7d773a263dcc3db971355e77116c796a15307fd6", "committedDate": "2020-10-16T18:20:25Z", "message": "Fix checkstyle.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d09f4947f38844ebf526dc01c572a3374b42f17", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/2d09f4947f38844ebf526dc01c572a3374b42f17", "committedDate": "2020-10-19T08:07:09Z", "message": "Try using loopback address.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "538f6b066515763bdb348e13718ab2630f4e28ea", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/538f6b066515763bdb348e13718ab2630f4e28ea", "committedDate": "2020-10-21T14:57:37Z", "message": "Use InetAddress to set Bookie advertised address.\n\nSigned-off-by: Ra\u00fal Gracia <raul.gracia@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cd5e3fa649da33121ae112c707b01ee55111076", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/3cd5e3fa649da33121ae112c707b01ee55111076", "committedDate": "2020-11-13T00:11:29Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into upstream-master\n\n\u0001 Conflicts:\n\u0001\tcli/admin/src/test/java/io/pravega/cli/admin/bookkeeper/BookkeeperCommandsTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56a89f46895e38e479f4471046ef5e973819fbb5", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/56a89f46895e38e479f4471046ef5e973819fbb5", "committedDate": "2020-12-08T20:55:13Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into upstream-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81196167cc0c3c6b23b7307c9d7736851fdf7b17", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/81196167cc0c3c6b23b7307c9d7736851fdf7b17", "committedDate": "2020-12-11T00:50:28Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into upstream-master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78b85fba4ba604d82a8b7cd34efa9c59f54dcda7", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/78b85fba4ba604d82a8b7cd34efa9c59f54dcda7", "committedDate": "2020-12-11T00:57:16Z", "message": "Fix `getOrSet` prematurely closing a valid Meter.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "153b1f42ffb40418b1bd5b8d3036aa9b6cdd65bf", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/153b1f42ffb40418b1bd5b8d3036aa9b6cdd65bf", "committedDate": "2020-12-11T00:59:02Z", "message": "Add back comment.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f50ecd1e899e5b4909656411620ba35f1769b11", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/1f50ecd1e899e5b4909656411620ba35f1769b11", "committedDate": "2020-12-11T19:33:30Z", "message": "Make `getOrSet` atomic.\nAdd exception to concurrent closure of a proxy.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bb2a5af3dfc9b019b446841974ed82231e8a4ea", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/5bb2a5af3dfc9b019b446841974ed82231e8a4ea", "committedDate": "2020-12-11T19:43:41Z", "message": "Remove concatenated string.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwNTMxNzU2", "url": "https://github.com/pravega/pravega/pull/5422#pullrequestreview-550531756", "createdAt": "2020-12-11T19:50:56Z", "commit": {"oid": "1f50ecd1e899e5b4909656411620ba35f1769b11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxOTo1MDo1N1rOIEJTeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxOTo1MDo1N1rOIEJTeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTIxNzY1Ng==", "bodyText": "The expected argument has been changed because before the expectation that was we would still create the Metric and add it to the metrics array, but just immediately mark it as closed. Now we just avoid that creation step completely (if it exists).", "url": "https://github.com/pravega/pravega/pull/5422#discussion_r541217656", "createdAt": "2020-12-11T19:50:57Z", "author": {"login": "co-jo"}, "path": "shared/metrics/src/test/java/io/pravega/shared/metrics/StatsLoggerProxyTest.java", "diffHunk": "@@ -67,23 +67,20 @@ public void testGetOrCreate() {\n         createMetrics(proxy, \"\", \"hostname\", \"localhost\");\n         Assert.assertEquals(\"Unexpected number of metrics registered initially.\", METRIC_COUNT * 2, metrics.size());\n \n-        // Re-create/request the same metrics. Verify the original ones have not been touched, but we did create (and close)\n-        // a new set.\n+        // Re-create/request the same metrics. Verify the original ones have not been touched.\n         createMetrics(proxy, \"\");\n-        Assert.assertEquals(\"Unexpected number of metrics registered after re-registering same names.\", 3 * METRIC_COUNT, metrics.size());\n+        Assert.assertEquals(\"Unexpected number of metrics registered after re-registering same names.\", 2 * METRIC_COUNT, metrics.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f50ecd1e899e5b4909656411620ba35f1769b11"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11b40e30c9cdd5500b3db16235f98cbb26423c10", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/11b40e30c9cdd5500b3db16235f98cbb26423c10", "committedDate": "2020-12-11T21:33:01Z", "message": "Merge branch 'master' into issue-5323-metrics-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f12b522374defdae870ce3ee9b98f30f1c45be1", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/2f12b522374defdae870ce3ee9b98f30f1c45be1", "committedDate": "2020-12-11T22:12:42Z", "message": "Merge remote-tracking branch 'origin/issue-5323-metrics-fix' into issue-5323-metrics-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "968aa96298956edaa5493a50b4b708beda483b8d", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/968aa96298956edaa5493a50b4b708beda483b8d", "committedDate": "2020-12-11T22:15:13Z", "message": "Use Preconditions.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80b61352d8bc781e35a9677802d9f36d0dd6aca7", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/80b61352d8bc781e35a9677802d9f36d0dd6aca7", "committedDate": "2020-12-12T01:10:44Z", "message": "Fix the close method so the protected instance request does not have to validate via preconditions.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNzQxMjM0", "url": "https://github.com/pravega/pravega/pull/5422#pullrequestreview-551741234", "createdAt": "2020-12-14T18:03:57Z", "commit": {"oid": "80b61352d8bc781e35a9677802d9f36d0dd6aca7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ddf34a5d254ce333bb7747cadc79a9bef610b57", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/3ddf34a5d254ce333bb7747cadc79a9bef610b57", "committedDate": "2020-12-14T19:19:10Z", "message": "Merge branch 'master' into issue-5323-metrics-fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxODIxOTUx", "url": "https://github.com/pravega/pravega/pull/5422#pullrequestreview-551821951", "createdAt": "2020-12-14T19:26:49Z", "commit": {"oid": "3ddf34a5d254ce333bb7747cadc79a9bef610b57"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcf9e268076b12535d103ed2fe16680b37c98464", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/bcf9e268076b12535d103ed2fe16680b37c98464", "committedDate": "2020-12-15T08:15:33Z", "message": "Merge branch 'master' into issue-5323-metrics-fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjkyNzcy", "url": "https://github.com/pravega/pravega/pull/5422#pullrequestreview-552692772", "createdAt": "2020-12-15T17:23:08Z", "commit": {"oid": "bcf9e268076b12535d103ed2fe16680b37c98464"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df2cded6afbbe6ad9b1594088c98c7a492cf2d92", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/df2cded6afbbe6ad9b1594088c98c7a492cf2d92", "committedDate": "2020-12-15T18:42:05Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5323-metrics-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4063fc6307bab68ec6bfc0739d2d074424a325b", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/a4063fc6307bab68ec6bfc0739d2d074424a325b", "committedDate": "2020-12-15T19:00:24Z", "message": "Relax the `Preconditions` check to a warning log.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39796cea559cb264acb6fd8620cbecab8b992183", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/39796cea559cb264acb6fd8620cbecab8b992183", "committedDate": "2020-12-15T19:01:54Z", "message": "Merge remote-tracking branch 'origin/issue-5323-metrics-fix' into issue-5323-metrics-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8361e0b039c30b487c37aaaa376a985c69d1fee1", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/8361e0b039c30b487c37aaaa376a985c69d1fee1", "committedDate": "2020-12-15T19:02:32Z", "message": "Remove newline.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feab3e1315f0ebc40091eddfdaef57bb65ebfcbe", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/feab3e1315f0ebc40091eddfdaef57bb65ebfcbe", "committedDate": "2020-12-16T18:24:18Z", "message": "Removed new line changed codecov?\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cdd1d50c5f621002c47f0fdcd9d2779fbba5067", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/7cdd1d50c5f621002c47f0fdcd9d2779fbba5067", "committedDate": "2020-12-16T22:13:39Z", "message": "Merge branch 'master' into issue-5323-metrics-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74da356bdeafd3c519ebb9c1ce135251c3d8254d", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/74da356bdeafd3c519ebb9c1ce135251c3d8254d", "committedDate": "2020-12-16T22:53:56Z", "message": "A MetricProxy test to ensure the close method is only executed once.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "955c55c52157becd1441206a961d5f2c77e5b75d", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/955c55c52157becd1441206a961d5f2c77e5b75d", "committedDate": "2020-12-16T22:54:08Z", "message": "Merge remote-tracking branch 'origin/issue-5323-metrics-fix' into issue-5323-metrics-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "750f22afe74d29542eb80f6003fae8ae81dec29d", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/750f22afe74d29542eb80f6003fae8ae81dec29d", "committedDate": "2020-12-17T08:24:33Z", "message": "Merge branch 'master' into issue-5323-metrics-fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NDA4MTAx", "url": "https://github.com/pravega/pravega/pull/5422#pullrequestreview-554408101", "createdAt": "2020-12-17T09:13:46Z", "commit": {"oid": "750f22afe74d29542eb80f6003fae8ae81dec29d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3795, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}