{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2OTI0MTYy", "number": 5061, "title": "Issue 5062: Handle SegmentSealedException during Append Setup", "bodyText": "Change log description\nThis change handles segment sealed on append operation.\nPurpose of the change\nFixes #5062 and an internal defect corresponding to appending a segment after it has been sealed.\nWhat the code does\ntreats the append like write\nHow to verify it\nran tests\n2020-08-12 14:10:19,472 6436 [Time-limited test] WARN i.p.c.s.i.SegmentOutputStreamImpl - Segment cannot be appended because it is already sealed for writer 9481b08e-326e-4ed6-957c-3b5c343e316c ]]", "createdAt": "2020-08-12T18:02:46Z", "url": "https://github.com/pravega/pravega/pull/5061", "merged": true, "mergeCommit": {"oid": "279ac21cdb779f7a0aaa51069a650d658ad6123a"}, "closed": true, "closedAt": "2020-08-17T22:04:48Z", "author": {"login": "ravibeta"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-PT4sgH2gAyNDY2OTI0MTYyOmVmNDE2Mzc5M2YzMTc4MTA0YTYyNzY3NjU4ODk4OThkYWVjODRmMzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_4GYhAFqTQ2ODc5NTU5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ef4163793f3178104a6276765889898daec84f37", "author": {"user": {"login": "ravibeta", "name": "Ravi Rajamani"}}, "url": "https://github.com/pravega/pravega/commit/ef4163793f3178104a6276765889898daec84f37", "committedDate": "2020-08-12T17:59:41Z", "message": "handle SegmentSealedException\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2893309e1e6d126b0695753b2094a02d95f99f2", "author": {"user": {"login": "ravibeta", "name": "Ravi Rajamani"}}, "url": "https://github.com/pravega/pravega/commit/f2893309e1e6d126b0695753b2094a02d95f99f2", "committedDate": "2020-08-12T19:47:45Z", "message": "change condition\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed6290b9b9bc5a3764013c3c7913ba302f256745", "author": {"user": {"login": "ravibeta", "name": "Ravi Rajamani"}}, "url": "https://github.com/pravega/pravega/commit/ed6290b9b9bc5a3764013c3c7913ba302f256745", "committedDate": "2020-08-12T19:49:23Z", "message": "Merge branch 'master' into issue-4351-check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e63c8b8e757fa17bb6279253d45b4978107ed8a2", "author": {"user": {"login": "ravibeta", "name": "Ravi Rajamani"}}, "url": "https://github.com/pravega/pravega/commit/e63c8b8e757fa17bb6279253d45b4978107ed8a2", "committedDate": "2020-08-12T21:16:35Z", "message": "add test: 2020-08-12 14:10:19,472 6436 [Time-limited test] WARN i.p.c.s.i.SegmentOutputStreamImpl - Segment cannot be appended because it is already sealed for writer 9481b08e-326e-4ed6-957c-3b5c343e316c ]]\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e75607dd15bee102d078f3a3c868ae0370bd21d9", "author": {"user": {"login": "ravibeta", "name": "Ravi Rajamani"}}, "url": "https://github.com/pravega/pravega/commit/e75607dd15bee102d078f3a3c868ae0370bd21d9", "committedDate": "2020-08-13T14:46:24Z", "message": "Merge branch 'master' into issue-4351-check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "730af096d587244ece0652e8b7dac35703a92201", "author": {"user": {"login": "ravibeta", "name": "Ravi Rajamani"}}, "url": "https://github.com/pravega/pravega/commit/730af096d587244ece0652e8b7dac35703a92201", "committedDate": "2020-08-14T12:26:10Z", "message": "Squashed commit of the following:\n\ncommit 9c1d4ddcb60ca010fe8ec74098cd9df55e15a09f\nAuthor: Ravi Rajamani <ravi.rajamani@emc.com>\nDate:   Wed Aug 12 16:29:41 2020 -0700\n\n    return on segment sealed in setupAppend\n\n    Signed-off-by: Ravi Rajamani <ravi.rajamani@emc.com>\n\n2020-08-14 05:24:11,519 1605 [Time-limited test] INFO  i.p.s.s.h.handler.AppendProcessor - Segment 'scope/stream/testAppendSegment' is sealed and 61919238-61ef-41e2-83b4-8af89b087e67 cannot perform append, disabling caching of attribute value...\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "033902e3ea9d2dba29d2607400b150674237d82c", "author": {"user": {"login": "ravibeta", "name": "Ravi Rajamani"}}, "url": "https://github.com/pravega/pravega/commit/033902e3ea9d2dba29d2607400b150674237d82c", "committedDate": "2020-08-14T13:13:01Z", "message": "Merge branch 'master' into issue-4351-check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NjI1MDk5", "url": "https://github.com/pravega/pravega/pull/5061#pullrequestreview-467625099", "createdAt": "2020-08-14T14:34:48Z", "commit": {"oid": "033902e3ea9d2dba29d2607400b150674237d82c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNDozNDo0OFrOHA250w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNDozOTowNlrOHA3C3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MTU4Nw==", "bodyText": "Invoking join here will eventually lead to a thread pool exhaustion.", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470661587", "createdAt": "2020-08-14T14:34:48Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -161,14 +163,32 @@ public void setupAppend(SetupAppend setupAppend) {\n                 .whenComplete((attributes, u) -> {\n                     try {\n                         if (u != null) {\n+                            if (u instanceof StreamSegmentSealedException) {\n+                                throw u;\n+                            }\n                             handleException(writer, setupAppend.getRequestId(), newSegment, \"setting up append\", u);\n                         } else {\n+                            SegmentProperties sp = this.store.getStreamSegmentInfo(newSegment, TIMEOUT).join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "033902e3ea9d2dba29d2607400b150674237d82c"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MTg0OA==", "bodyText": "Also why are you doing this for successful operations?", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470661848", "createdAt": "2020-08-14T14:35:12Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -161,14 +163,32 @@ public void setupAppend(SetupAppend setupAppend) {\n                 .whenComplete((attributes, u) -> {\n                     try {\n                         if (u != null) {\n+                            if (u instanceof StreamSegmentSealedException) {\n+                                throw u;\n+                            }\n                             handleException(writer, setupAppend.getRequestId(), newSegment, \"setting up append\", u);\n                         } else {\n+                            SegmentProperties sp = this.store.getStreamSegmentInfo(newSegment, TIMEOUT).join();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MTU4Nw=="}, "originalCommit": {"oid": "033902e3ea9d2dba29d2607400b150674237d82c"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MjU4NQ==", "bodyText": "This is an inelegant way of handling this. Please use an exceptionally clause before the whenComplete to do this.\nBetter yet, use Futures.exceptionallyComposeExpecting with StreamSegmentSealedException.class as its expected exception and add your special handling code in the callback.", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470662585", "createdAt": "2020-08-14T14:36:37Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -161,14 +163,32 @@ public void setupAppend(SetupAppend setupAppend) {\n                 .whenComplete((attributes, u) -> {\n                     try {\n                         if (u != null) {\n+                            if (u instanceof StreamSegmentSealedException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "033902e3ea9d2dba29d2607400b150674237d82c"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MzMxOA==", "bodyText": "This should not be info.\n\"disabling caching of attribute value\" is misleading. We are not disabling anything, just passing an arg to a method. Disabling may be perceived as \"disabling across the board\".\n\nI do not see the value of this log message here since the segment store logs its calls with all args.", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470663318", "createdAt": "2020-08-14T14:37:57Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -161,14 +163,32 @@ public void setupAppend(SetupAppend setupAppend) {\n                 .whenComplete((attributes, u) -> {\n                     try {\n                         if (u != null) {\n+                            if (u instanceof StreamSegmentSealedException) {\n+                                throw u;\n+                            }\n                             handleException(writer, setupAppend.getRequestId(), newSegment, \"setting up append\", u);\n                         } else {\n+                            SegmentProperties sp = this.store.getStreamSegmentInfo(newSegment, TIMEOUT).join();\n+                            if (sp.isSealed()) {\n+                                throw new StreamSegmentSealedException(newSegment);\n+                            }\n                             long eventNumber = attributes.getOrDefault(writer, Attributes.NULL_ATTRIBUTE_VALUE);\n                             this.writerStates.putIfAbsent(Pair.of(newSegment, writer), new WriterState(eventNumber));\n                             connection.send(new AppendSetup(setupAppend.getRequestId(), newSegment, writer, eventNumber));\n                         }\n                     } catch (Throwable e) {\n-                        handleException(writer, setupAppend.getRequestId(), newSegment, \"handling setupAppend result\", e);\n+                        if (e instanceof StreamSegmentSealedException || e.getCause() instanceof StreamSegmentSealedException) {\n+                            log.info(\"Segment '{}' is sealed and {} cannot perform append, disabling caching of attribute value...\", newSegment, writer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "033902e3ea9d2dba29d2607400b150674237d82c"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MzM3NA==", "bodyText": "Again, you are using join", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470663374", "createdAt": "2020-08-14T14:38:05Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -161,14 +163,32 @@ public void setupAppend(SetupAppend setupAppend) {\n                 .whenComplete((attributes, u) -> {\n                     try {\n                         if (u != null) {\n+                            if (u instanceof StreamSegmentSealedException) {\n+                                throw u;\n+                            }\n                             handleException(writer, setupAppend.getRequestId(), newSegment, \"setting up append\", u);\n                         } else {\n+                            SegmentProperties sp = this.store.getStreamSegmentInfo(newSegment, TIMEOUT).join();\n+                            if (sp.isSealed()) {\n+                                throw new StreamSegmentSealedException(newSegment);\n+                            }\n                             long eventNumber = attributes.getOrDefault(writer, Attributes.NULL_ATTRIBUTE_VALUE);\n                             this.writerStates.putIfAbsent(Pair.of(newSegment, writer), new WriterState(eventNumber));\n                             connection.send(new AppendSetup(setupAppend.getRequestId(), newSegment, writer, eventNumber));\n                         }\n                     } catch (Throwable e) {\n-                        handleException(writer, setupAppend.getRequestId(), newSegment, \"handling setupAppend result\", e);\n+                        if (e instanceof StreamSegmentSealedException || e.getCause() instanceof StreamSegmentSealedException) {\n+                            log.info(\"Segment '{}' is sealed and {} cannot perform append, disabling caching of attribute value...\", newSegment, writer);\n+                            Map<UUID, Long> newAttributes = store.getAttributes(newSegment, Collections.singleton(writer), false, TIMEOUT).join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "033902e3ea9d2dba29d2607400b150674237d82c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MzkwMQ==", "bodyText": "This code looks copy pasted from above. If you use my suggestion above, you will not need this duplication.", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r470663901", "createdAt": "2020-08-14T14:39:06Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -161,14 +163,32 @@ public void setupAppend(SetupAppend setupAppend) {\n                 .whenComplete((attributes, u) -> {\n                     try {\n                         if (u != null) {\n+                            if (u instanceof StreamSegmentSealedException) {\n+                                throw u;\n+                            }\n                             handleException(writer, setupAppend.getRequestId(), newSegment, \"setting up append\", u);\n                         } else {\n+                            SegmentProperties sp = this.store.getStreamSegmentInfo(newSegment, TIMEOUT).join();\n+                            if (sp.isSealed()) {\n+                                throw new StreamSegmentSealedException(newSegment);\n+                            }\n                             long eventNumber = attributes.getOrDefault(writer, Attributes.NULL_ATTRIBUTE_VALUE);\n                             this.writerStates.putIfAbsent(Pair.of(newSegment, writer), new WriterState(eventNumber));\n                             connection.send(new AppendSetup(setupAppend.getRequestId(), newSegment, writer, eventNumber));\n                         }\n                     } catch (Throwable e) {\n-                        handleException(writer, setupAppend.getRequestId(), newSegment, \"handling setupAppend result\", e);\n+                        if (e instanceof StreamSegmentSealedException || e.getCause() instanceof StreamSegmentSealedException) {\n+                            log.info(\"Segment '{}' is sealed and {} cannot perform append, disabling caching of attribute value...\", newSegment, writer);\n+                            Map<UUID, Long> newAttributes = store.getAttributes(newSegment, Collections.singleton(writer), false, TIMEOUT).join();\n+                            long eventNumber = Attributes.NULL_ATTRIBUTE_VALUE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "033902e3ea9d2dba29d2607400b150674237d82c"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2beb1201882fff6c3c15457be6c01d343943dbe", "author": {"user": {"login": "ravibeta", "name": "Ravi Rajamani"}}, "url": "https://github.com/pravega/pravega/commit/c2beb1201882fff6c3c15457be6c01d343943dbe", "committedDate": "2020-08-14T16:32:49Z", "message": "use Futures.exceptionallyComposeExpecting\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afa2643a46326e56792e0f0c4dbfee2f8f8a8e01", "author": {"user": {"login": "ravibeta", "name": "Ravi Rajamani"}}, "url": "https://github.com/pravega/pravega/commit/afa2643a46326e56792e0f0c4dbfee2f8f8a8e01", "committedDate": "2020-08-14T17:15:28Z", "message": "Merge branch 'master' into issue-4351-check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68a68c828bdf53ec78b708b003bff68f0dec0798", "author": {"user": {"login": "ravibeta", "name": "Ravi Rajamani"}}, "url": "https://github.com/pravega/pravega/commit/68a68c828bdf53ec78b708b003bff68f0dec0798", "committedDate": "2020-08-14T16:40:17Z", "message": "run checkstylemain again\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3ODAzOTQ5", "url": "https://github.com/pravega/pravega/pull/5061#pullrequestreview-467803949", "createdAt": "2020-08-14T18:47:57Z", "commit": {"oid": "68a68c828bdf53ec78b708b003bff68f0dec0798"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85bb2352ad4e154524658b6ff13eedc6f7a26995", "author": {"user": {"login": "ravibeta", "name": "Ravi Rajamani"}}, "url": "https://github.com/pravega/pravega/commit/85bb2352ad4e154524658b6ff13eedc6f7a26995", "committedDate": "2020-08-16T16:48:32Z", "message": "add code coverage\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NjMwNzIy", "url": "https://github.com/pravega/pravega/pull/5061#pullrequestreview-468630722", "createdAt": "2020-08-17T16:48:43Z", "commit": {"oid": "85bb2352ad4e154524658b6ff13eedc6f7a26995"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNjo0ODo0NFrOHBwqLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNjo0ODo0NFrOHBwqLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTYwNzg1NA==", "bodyText": "This looks good, however I want some way of logging that we are indeed running into some sealed segment. At the same time, I do not want to pollute the logs with useless messages. Looking through this class, it seems that a subsequent append via this connection-writer will stumble across a sealed segment which will take care of some logging and cleanup (OK - nothing to do there).\nI just took a look at the getAttributes call inside the Segment Store and it turns out we are not logging the cache argument. Would you mind editing line 933 in StreamSegmentContainer.java and add the cache parameter to that logRequest call please? That way we will be able to see the first and the second call in the logs with proper args.", "url": "https://github.com/pravega/pravega/pull/5061#discussion_r471607854", "createdAt": "2020-08-17T16:48:44Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/AppendProcessor.java", "diffHunk": "@@ -157,20 +157,22 @@ public void setupAppend(SetupAppend setupAppend) {\n \n         // Get the last Event Number for this writer from the Store. This operation (cache=true) will automatically put\n         // the value in the Store's cache so it's faster to access later.\n-        store.getAttributes(newSegment, Collections.singleton(writer), true, TIMEOUT)\n-                .whenComplete((attributes, u) -> {\n-                    try {\n-                        if (u != null) {\n-                            handleException(writer, setupAppend.getRequestId(), newSegment, \"setting up append\", u);\n-                        } else {\n-                            long eventNumber = attributes.getOrDefault(writer, Attributes.NULL_ATTRIBUTE_VALUE);\n-                            this.writerStates.putIfAbsent(Pair.of(newSegment, writer), new WriterState(eventNumber));\n-                            connection.send(new AppendSetup(setupAppend.getRequestId(), newSegment, writer, eventNumber));\n-                        }\n-                    } catch (Throwable e) {\n-                        handleException(writer, setupAppend.getRequestId(), newSegment, \"handling setupAppend result\", e);\n-                    }\n-                });\n+        Futures.exceptionallyComposeExpecting(\n+                store.getAttributes(newSegment, Collections.singleton(writer), true, TIMEOUT),\n+                e -> e instanceof StreamSegmentSealedException, () -> store.getAttributes(newSegment, Collections.singleton(writer), false, TIMEOUT))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85bb2352ad4e154524658b6ff13eedc6f7a26995"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5416f0625e192651edfe10975861d2312eaff196", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/5416f0625e192651edfe10975861d2312eaff196", "committedDate": "2020-08-17T17:32:59Z", "message": "Merge branch 'master' into issue-4351-check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdcee7fb49607bb387e1c13320b561485e65f5d9", "author": {"user": {"login": "ravibeta", "name": "Ravi Rajamani"}}, "url": "https://github.com/pravega/pravega/commit/bdcee7fb49607bb387e1c13320b561485e65f5d9", "committedDate": "2020-08-17T16:57:21Z", "message": "add cache parameter in logs\n\nSigned-off-by: Ravi Rajamani <ravi.rajamani@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4Nzk1NTky", "url": "https://github.com/pravega/pravega/pull/5061#pullrequestreview-468795592", "createdAt": "2020-08-17T20:04:58Z", "commit": {"oid": "bdcee7fb49607bb387e1c13320b561485e65f5d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4031, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}