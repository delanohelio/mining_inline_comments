{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU4NDcxNTk5", "number": 4992, "title": "Issue 4975: Replace Loading Cache with Regular Cache", "bodyText": "Signed-off-by: Shivesh Ranjan shivesh.ranjan@gmail.com\nChange log description\nReplace the cache implementation to not load the completablefuture into the cache as that can cause consistency issues.\nPurpose of the change\nFixes #4975\nWhat the code does\nChanges the cache to load the value. The store first retrieves the value for mutable records from the cache. and if not found, it calls the store and loads the value from the future.\nWe dont try to optimize on multiple concurrent invocations to the loading function because that will result in the original problem of consistency check failure.\nHow to verify it\nAll existing tests should continue to pass.", "createdAt": "2020-07-29T14:19:42Z", "url": "https://github.com/pravega/pravega/pull/4992", "merged": true, "mergeCommit": {"oid": "f6a03f501297c234ab94ace1147a8b61de30e368"}, "closed": true, "closedAt": "2020-08-05T15:04:44Z", "author": {"login": "shiveshr"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5qu_JAH2gAyNDU4NDcxNTk5OmZmMGIzYjgzNmFjYTE4ODkzNjRjNWUyZGZhMDlhOWY5MjFhZjZiNmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc75VIYgH2gAyNDU4NDcxNTk5OjEyNzYxNDZkZjFkMTdjMzA0ZDk5ODMxNmQ2NWRhNmJiNGFkNTdhZmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ff0b3b836aca1889364c5e2dfa09a9f921af6b6e", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/ff0b3b836aca1889364c5e2dfa09a9f921af6b6e", "committedDate": "2020-07-29T13:07:06Z", "message": "change cache\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b980a92be96323adfafcc7cd9815dc1d4be497a", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/6b980a92be96323adfafcc7cd9815dc1d4be497a", "committedDate": "2020-07-29T15:51:44Z", "message": "Merge branch 'master' into issue4975"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52909b7cfb3bd7e8b5c9d47037b1d41580cfa9ce", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/52909b7cfb3bd7e8b5c9d47037b1d41580cfa9ce", "committedDate": "2020-07-31T08:10:48Z", "message": "Merge branch 'master' into issue4975"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2111b31822fe674a24277f8c0ffc04e424edfa7", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/c2111b31822fe674a24277f8c0ffc04e424edfa7", "committedDate": "2020-08-03T04:45:21Z", "message": "Merge branch 'master' into issue4975"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deea8b20c80a204b9316820078fad78073eea34c", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/deea8b20c80a204b9316820078fad78073eea34c", "committedDate": "2020-08-04T05:00:51Z", "message": "Merge branch 'master' into issue4975"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzM5MjY2", "url": "https://github.com/pravega/pravega/pull/4992#pullrequestreview-461339266", "createdAt": "2020-08-05T04:55:29Z", "commit": {"oid": "deea8b20c80a204b9316820078fad78073eea34c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNDo1NToyOVrOG76LMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNDo1NToyOVrOG76LMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ3MjMwNg==", "bodyText": "We don't use LoadingCache any more...", "url": "https://github.com/pravega/pravega/pull/4992#discussion_r465472306", "createdAt": "2020-08-05T04:55:29Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/Cache.java", "diffHunk": "@@ -10,53 +10,42 @@\n package io.pravega.controller.store.stream;\n \n import com.google.common.cache.CacheBuilder;\n-import com.google.common.cache.CacheLoader;\n-import com.google.common.cache.LoadingCache;\n import io.pravega.controller.store.VersionedMetadata;\n \n-import javax.annotation.ParametersAreNonnullByDefault;\n-import java.util.concurrent.CompletableFuture;\n-import java.util.concurrent.CompletionException;\n import java.util.concurrent.TimeUnit;\n-import java.util.function.Function;\n \n /**\n  * Cache for asynchronously retrieving and loading records from underlying store using the supplied loader.\n  * This uses Guava's loading cache and takes a loader function for loading entries into the cache. ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "deea8b20c80a204b9316820078fad78073eea34c"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "073bfd97f27d90fc052df29f9622d32079e96ff2", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/073bfd97f27d90fc052df29f9622d32079e96ff2", "committedDate": "2020-08-05T06:33:10Z", "message": "PR comment\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff2ea4b08781691063bd2278d603190f3a1d1d63", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/ff2ea4b08781691063bd2278d603190f3a1d1d63", "committedDate": "2020-08-05T06:33:42Z", "message": "Merge branch 'master' into issue4975"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b79c4391d1431d564a8769c84d450549374290c8", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/b79c4391d1431d564a8769c84d450549374290c8", "committedDate": "2020-08-05T06:33:48Z", "message": "Merge branch 'issue4975' of https://github.com/shiveshr/pravega-1 into issue4975"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzU1NTc4", "url": "https://github.com/pravega/pravega/pull/4992#pullrequestreview-461355578", "createdAt": "2020-08-05T05:45:05Z", "commit": {"oid": "deea8b20c80a204b9316820078fad78073eea34c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNTo0NTowNlrOG77CtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNTo0NTowNlrOG77CtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ4NjUxNw==", "bodyText": "While I understand the reason for removing Future from the Cache Value, I don't see why we are moving away from auto loading cache entries?", "url": "https://github.com/pravega/pravega/pull/4992#discussion_r465486517", "createdAt": "2020-08-05T05:45:06Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/Cache.java", "diffHunk": "@@ -10,53 +10,42 @@\n package io.pravega.controller.store.stream;\n \n import com.google.common.cache.CacheBuilder;\n-import com.google.common.cache.CacheLoader;\n-import com.google.common.cache.LoadingCache;\n import io.pravega.controller.store.VersionedMetadata;\n \n-import javax.annotation.ParametersAreNonnullByDefault;\n-import java.util.concurrent.CompletableFuture;\n-import java.util.concurrent.CompletionException;\n import java.util.concurrent.TimeUnit;\n-import java.util.function.Function;\n \n /**\n  * Cache for asynchronously retrieving and loading records from underlying store using the supplied loader.\n  * This uses Guava's loading cache and takes a loader function for loading entries into the cache. \n- * This class caches Futures which hold the metadata record with version. The cache is untyped and the CompletableFutures\n+ * This class caches Futures which hold the metadata record with version. The cache  \n  * can hold any value under the VersionedMetadata wrapper.\n  * The values are by default held for 2 minutes after creation unless invalidated explicitly.\n  * The maximum number of records that can be held in the cache is 10000. \n  */\n public class Cache {\n     private static final int MAX_CACHE_SIZE = 10000;\n     \n-    private final LoadingCache<CacheKey, CompletableFuture<VersionedMetadata<?>>> cache;\n+    private final com.google.common.cache.Cache<CacheKey, VersionedMetadata<?>> cache;\n \n-    public Cache(final Function<CacheKey, CompletableFuture<VersionedMetadata<?>>> loader) {\n+    public Cache() {\n         cache = CacheBuilder.newBuilder()\n                             .maximumSize(MAX_CACHE_SIZE)\n                             .expireAfterAccess(2, TimeUnit.MINUTES)\n-                            .build(new CacheLoader<CacheKey, CompletableFuture<VersionedMetadata<?>>>() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "deea8b20c80a204b9316820078fad78073eea34c"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1276146df1d17c304d998316d65da6bb4ad57afc", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/1276146df1d17c304d998316d65da6bb4ad57afc", "committedDate": "2020-08-05T11:15:17Z", "message": "Merge branch 'master' into issue4975"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3996, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}