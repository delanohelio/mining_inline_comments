{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwNTE5Mzkz", "number": 5146, "title": "Issue 5140: Ensure ControllerResolverFactory ensure the scheduled task is interrupted during shutdown.", "bodyText": "Signed-off-by: Sandeep sandeep.shridhar@emc.com\nChange log description\n\nEnsure ControllerNameResolver#shutdown cancels the future the scheduled future with mayInterruptIfRunning flag as true.\nWait for upto 20 seconds for channel termination to complete.\nEnsure watermarking thread pool is shutdown with clientFactory.close().\n\nPurpose of the change\nFixes #5140\nWhat the code does\n\nEnsure ControllerNameResolver#shutdown cancels the future the scheduled future with mayInterruptIfRunning flag as true.\nWait for upto 20 seconds for channel termination to complete.\nEnsure watermarking thread pool is shutdown with clientFactory.close().\n\nHow to verify it\nAll the existing tests should pass.", "createdAt": "2020-09-05T13:25:36Z", "url": "https://github.com/pravega/pravega/pull/5146", "merged": true, "mergeCommit": {"oid": "7e191fb8b3aedf9440028d6a639cb3c084510a1b"}, "closed": true, "closedAt": "2020-09-10T05:23:48Z", "author": {"login": "shrids"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdF5uf3AH2gAyNDgwNTE5MzkzOjE2NDhlNmQwMThkYWY1NjU3ODdjOGY0MjcwN2ViZDg4ZDJlYWZlZmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHaGWDAFqTQ4NTU5NTk1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1648e6d018daf565787c8f42707ebd88d2eafefa", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/1648e6d018daf565787c8f42707ebd88d2eafefa", "committedDate": "2020-09-05T13:22:14Z", "message": "Ensure the scheduled Future is cancelled.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f44465ab46a44dc917ef2ada7339ac9cb6232dd1", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/f44465ab46a44dc917ef2ada7339ac9cb6232dd1", "committedDate": "2020-09-06T09:48:58Z", "message": "Ensure watermarking threads are not closed.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "f44465ab46a44dc917ef2ada7339ac9cb6232dd1", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/f44465ab46a44dc917ef2ada7339ac9cb6232dd1", "committedDate": "2020-09-06T09:48:58Z", "message": "Ensure watermarking threads are not closed.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4035f9d989abbe87b84c1530272d974a80833f62", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/4035f9d989abbe87b84c1530272d974a80833f62", "committedDate": "2020-09-06T15:06:45Z", "message": "fix possible race.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMjQ5ODA2", "url": "https://github.com/pravega/pravega/pull/5146#pullrequestreview-483249806", "createdAt": "2020-09-07T05:28:48Z", "commit": {"oid": "4035f9d989abbe87b84c1530272d974a80833f62"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNToyODo0OFrOHNwmvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwNTozNDo1MlrOHNwsSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE4OTg4Nw==", "bodyText": "Should the get and set separated out here?\n\nThis method returns if get stop returns true.\nSet is called after the callback is complete, using compareAndSet(false, true).\n\nThis might be especially useful if `callback.connectionDropped() can fail with an exception.\nOn the other hand, if the failure of connectionDropped() call can be safely discounted, the existing code'd be OK.", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484189887", "createdAt": "2020-09-07T05:28:48Z", "author": {"login": "ravisharda"}, "path": "client/src/main/java/io/pravega/client/connection/impl/TcpClientConnection.java", "diffHunk": "@@ -159,7 +159,9 @@ static WireCommand readCommand(InputStream in, IoBuffer buffer) throws IOExcepti\n         }\n         \n         public void stop() {\n-            stop.set(true);\n+            if (stop.getAndSet(true)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4035f9d989abbe87b84c1530272d974a80833f62"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5MDQyMw==", "bodyText": "Why is this change required? My reading from the code in the method is that it shouldn't be necessary to do this.", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484190423", "createdAt": "2020-09-07T05:31:03Z", "author": {"login": "ravisharda"}, "path": "client/src/main/java/io/pravega/client/connection/impl/ConnectionPoolImpl.java", "diffHunk": "@@ -186,6 +186,7 @@ public void pruneUnusedConnections() {\n     }\n \n     @Override\n+    @Synchronized", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4035f9d989abbe87b84c1530272d974a80833f62"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE5MTMwNw==", "bodyText": "nit: There is no timeout duration specified, unlike what the comment suggests. This comment might be referring on the default value used in the shutdown method. If someone changes that value, this comment would go stale. It might be useful rather to say something like Wait for default timeout duration before...", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r484191307", "createdAt": "2020-09-07T05:34:52Z", "author": {"login": "ravisharda"}, "path": "client/src/main/java/io/pravega/client/stream/impl/ClientFactoryImpl.java", "diffHunk": "@@ -244,8 +244,10 @@ private Segment getSegmentForRevisionedClient(String scope, String streamName) {\n \n     @Override\n     public void close() {\n-        controller.close();\n+        // wait for 5 seconds before forcibly terminating the watermarkReader threads.\n+        ExecutorServiceHelpers.shutdown(watermarkReaderThreads);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4035f9d989abbe87b84c1530272d974a80833f62"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0794f79881c54aab8395b2015eb28ac12dae9ded", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/0794f79881c54aab8395b2015eb28ac12dae9ded", "committedDate": "2020-09-07T07:08:14Z", "message": "CR CHanges: updated the comment.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMjk0MDcx", "url": "https://github.com/pravega/pravega/pull/5146#pullrequestreview-483294071", "createdAt": "2020-09-07T07:12:30Z", "commit": {"oid": "0794f79881c54aab8395b2015eb28ac12dae9ded"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d1e5133087cb630804721f615afe9beab5a7025", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/6d1e5133087cb630804721f615afe9beab5a7025", "committedDate": "2020-09-07T12:04:32Z", "message": "Merge branch 'master' into issue-5140"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58e09aef8a10b82bfb2878ee95f75609d6e65163", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/58e09aef8a10b82bfb2878ee95f75609d6e65163", "committedDate": "2020-09-08T04:08:06Z", "message": "Merge branch 'master' into issue-5140"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MjcxMDQ0", "url": "https://github.com/pravega/pravega/pull/5146#pullrequestreview-484271044", "createdAt": "2020-09-08T15:44:01Z", "commit": {"oid": "58e09aef8a10b82bfb2878ee95f75609d6e65163"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0NDowMlrOHOjTZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo0NDowMlrOHOjTZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyMDUxOA==", "bodyText": "FYI, this has no effect. It is not implemented in the JRE.", "url": "https://github.com/pravega/pravega/pull/5146#discussion_r485020518", "createdAt": "2020-09-08T15:44:02Z", "author": {"login": "andreipaduroiu"}, "path": "client/src/main/java/io/pravega/client/control/impl/ControllerResolverFactory.java", "diffHunk": "@@ -201,7 +201,7 @@ public void start(Listener listener) {\n         public void shutdown() {\n             shutdown = true;\n             if (scheduledFuture != null) {\n-                scheduledFuture.cancel(false);\n+                scheduledFuture.cancel(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58e09aef8a10b82bfb2878ee95f75609d6e65163"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fff8044ab442703e773a5b51f034712054d3d0f1", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/fff8044ab442703e773a5b51f034712054d3d0f1", "committedDate": "2020-09-08T15:48:06Z", "message": "Merge branch 'master' into issue-5140"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "425c792527bfa7bc5e98d7d4a456cf64021d84aa", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/425c792527bfa7bc5e98d7d4a456cf64021d84aa", "committedDate": "2020-09-10T03:10:59Z", "message": "Merge branch 'master' into issue-5140"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NTk1OTU0", "url": "https://github.com/pravega/pravega/pull/5146#pullrequestreview-485595954", "createdAt": "2020-09-10T05:39:10Z", "commit": {"oid": "425c792527bfa7bc5e98d7d4a456cf64021d84aa"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3847, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}