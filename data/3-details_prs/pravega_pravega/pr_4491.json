{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzNTU0NTYw", "number": 4491, "title": "Issue 4443: Use DelegationTokenProvider for BatchClient.", "bodyText": "Change log description\nUse DelegationTokenProvider for BatchClient.\nPurpose of the change\nFixes #4443\nWhat the code does\nLeverage DelegationTokenProvider to retrieve the delegation token on BatchClient.\nHow to verify it\nAll the existing and newly added tests should continue to pass.", "createdAt": "2020-01-16T09:56:18Z", "url": "https://github.com/pravega/pravega/pull/4491", "merged": true, "mergeCommit": {"oid": "06867211913cceb9481c5662eb70103a4fd40f05"}, "closed": true, "closedAt": "2020-01-17T10:46:23Z", "author": {"login": "shrids"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb63HGMAH2gAyMzYzNTU0NTYwOjJhZWNiYTdkNzQ1MmY3MmFmMDM3M2NkZWU5YWE3ZjYwNDJiOTVhYzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7KvnLgH2gAyMzYzNTU0NTYwOjczNWE2MzY4OGViYTY1YWZlZjNmNzBiZjViZjVmOWNhOTM2ZGNiZmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2aecba7d7452f72af0373cdee9aa7f6042b95ac3", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/2aecba7d7452f72af0373cdee9aa7f6042b95ac3", "committedDate": "2020-01-16T09:55:04Z", "message": "First version.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9eb7bbc7f05553a64a4e66273b7f6be8f1c1fed8", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/9eb7bbc7f05553a64a4e66273b7f6be8f1c1fed8", "committedDate": "2020-01-16T10:32:38Z", "message": "Add Junits.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTU1NDA3", "url": "https://github.com/pravega/pravega/pull/4491#pullrequestreview-343955407", "createdAt": "2020-01-16T14:34:07Z", "commit": {"oid": "9eb7bbc7f05553a64a4e66273b7f6be8f1c1fed8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDozNDowOFrOFebYxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxNDozNDowOFrOFebYxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzQ1MDMwOA==", "bodyText": "The DelegationTokenProvider implementation holds the DelegationToken under an AtomicReference. So wrapping the provider using an AtomicReference is redundant here, and should be removed.\n\n  \n    \n      pravega/client/src/main/java/io/pravega/client/security/auth/JwtTokenProviderImpl.java\n    \n    \n         Line 71\n      in\n      ad9260d\n    \n    \n    \n    \n\n        \n          \n           private final AtomicReference<DelegationToken> delegationToken = new AtomicReference<>();", "url": "https://github.com/pravega/pravega/pull/4491#discussion_r367450308", "createdAt": "2020-01-16T14:34:08Z", "author": {"login": "ravisharda"}, "path": "client/src/main/java/io/pravega/client/batch/impl/BatchClientFactoryImpl.java", "diffHunk": "@@ -46,25 +46,22 @@\n \n @Beta\n @Slf4j\n-@SuppressWarnings(\"deprecation\")\n public class BatchClientFactoryImpl implements BatchClientFactory {\n \n     private final Controller controller;\n     private final ConnectionFactory connectionFactory;\n     private final SegmentInputStreamFactory inputStreamFactory;\n     private final SegmentMetadataClientFactory segmentMetadataClientFactory;\n     private final StreamCutHelper streamCutHelper;\n-\n-    @GuardedBy(\"this\")\n-    private final AtomicReference<String> latestDelegationToken;\n+    private final AtomicReference<DelegationTokenProvider> delegationTokenProvider;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9eb7bbc7f05553a64a4e66273b7f6be8f1c1fed8"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MDg3Njc0", "url": "https://github.com/pravega/pravega/pull/4491#pullrequestreview-344087674", "createdAt": "2020-01-16T17:27:11Z", "commit": {"oid": "9eb7bbc7f05553a64a4e66273b7f6be8f1c1fed8"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc431f3b5877605bd7b2c621d38495cb1ed525c", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/fdc431f3b5877605bd7b2c621d38495cb1ed525c", "committedDate": "2020-01-17T01:59:41Z", "message": "Review comments.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MzY0NzA0", "url": "https://github.com/pravega/pravega/pull/4491#pullrequestreview-344364704", "createdAt": "2020-01-17T05:01:34Z", "commit": {"oid": "fdc431f3b5877605bd7b2c621d38495cb1ed525c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwNTowMTozNFrOFeu5yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwNTowMTozNFrOFeu5yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc3MDA1Ng==", "bodyText": "Since the passed object is not a real object, using a spy() seems unnecessary here. We can use mockController directly.", "url": "https://github.com/pravega/pravega/pull/4491#discussion_r367770056", "createdAt": "2020-01-17T05:01:34Z", "author": {"login": "ravisharda"}, "path": "client/src/test/java/io/pravega/client/batch/impl/BatchClientImplTest.java", "diffHunk": "@@ -100,6 +109,33 @@ public void testGetSegmentsWithNullStreamCut() throws Exception {\n         assertFalse(segments.hasNext());\n     }\n \n+    @Test(timeout = 5000)\n+    public void testGetSegmentsWithMultipleSegments() throws Exception {\n+\n+        PravegaNodeUri location = new PravegaNodeUri(\"localhost\", 0);\n+        MockConnectionFactoryImpl connectionFactory = getMockConnectionFactory(location);\n+        MockController mockController = new MockController(location.getEndpoint(), location\n+                .getPort(), connectionFactory, false);\n+        MockController stubbedController = spy(mockController);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdc431f3b5877605bd7b2c621d38495cb1ed525c"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1526c2e6fa2e6c7a673f8ab929ca054d2664acc9", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/1526c2e6fa2e6c7a673f8ab929ca054d2664acc9", "committedDate": "2020-01-17T06:13:50Z", "message": "Add Integration test.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MzgzMTAw", "url": "https://github.com/pravega/pravega/pull/4491#pullrequestreview-344383100", "createdAt": "2020-01-17T06:25:53Z", "commit": {"oid": "1526c2e6fa2e6c7a673f8ab929ca054d2664acc9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwNjoyNTo1NFrOFev1kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwNjoyNTo1NFrOFev1kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc4NTM2Mw==", "bodyText": "nit: timeouts", "url": "https://github.com/pravega/pravega/pull/4491#discussion_r367785363", "createdAt": "2020-01-17T06:25:54Z", "author": {"login": "ravisharda"}, "path": "test/integration/src/test/java/io/pravega/test/integration/DelegationTokenTest.java", "diffHunk": "@@ -200,4 +184,96 @@ public void testDelegationTokenGetsRenewedAfterExpiry() throws InterruptedExcept\n             pravegaCluster.close();\n         }\n     }\n+\n+    /**\n+     * This test verifies that a batch client continues to read events as a result of automatic delegation token\n+     * renewal, after the initial delegation token it uses expires.\n+     * <p>\n+     * We use an extraordinarily high test timeout and read time outs to account for any inordinate delays that may be", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1526c2e6fa2e6c7a673f8ab929ca054d2664acc9"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25e5181bd57e2498a9fab47dbb77f06dcbb69e9c", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/25e5181bd57e2498a9fab47dbb77f06dcbb69e9c", "committedDate": "2020-01-17T06:29:54Z", "message": "CR Changes: fix typo.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "735a63688eba65afef3f70bf5bf5f9ca936dcbfb", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/735a63688eba65afef3f70bf5bf5f9ca936dcbfb", "committedDate": "2020-01-17T08:47:31Z", "message": "Merge branch 'master' into issue-4443-delegationToken"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3548, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}