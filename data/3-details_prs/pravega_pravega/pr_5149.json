{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxMDAzNDgy", "number": 5149, "title": "Issue 5002: Delete scope api with delete streams flag ", "bodyText": "Signed-off-by: Shivesh Ranjan shivesh.ranjan@gmail.com\nChange log description\nImplements a new api in StreamManager for deleting a scope by internally listing all streams and attempting to delete them.\nPurpose of the change\nFixes #5002\nWhat the code does\nAdds a new Api in stream manager that lists all streams in scope and iteratively seals and deletes each stream.\nAlso adds a retry block around submission of seal stream request. Seal stream can fail if the stream is non active -- i.e. scaling or truncating or committing transaction for instance. Such errors are transient and whenever those operations complete, stream can be marked for sealing and then sealed. So we have added a retry in streammetadata tasks to handle such cases.\nHow to verify it\nUnit test added.", "createdAt": "2020-09-07T03:10:30Z", "url": "https://github.com/pravega/pravega/pull/5149", "merged": true, "mergeCommit": {"oid": "efa95967be1cc3495852f26c65891c2eae694775"}, "closed": true, "closedAt": "2020-09-08T04:07:44Z", "author": {"login": "shiveshr"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGaE01gH2gAyNDgxMDAzNDgyOmFlMmNkNGEyY2U4YjA3NjhjNmVjNDk3ZmM3NjgwYjk4OWEzZWM3Zjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGijabAH2gAyNDgxMDAzNDgyOjUwODMwNTAzMmRiZGY4MDlmYWRiNjQ2NDg0MmVlNDg5ZTM2NDEwZTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ae2cd4a2ce8b0768c6ec497fc7680b989a3ec7f7", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/ae2cd4a2ce8b0768c6ec497fc7680b989a3ec7f7", "committedDate": "2020-09-07T03:03:35Z", "message": "Issue 5002: Delete scope api with delete streams flag\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c95f498fe69343993fea7d0ffd321a74dfb6644", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/4c95f498fe69343993fea7d0ffd321a74dfb6644", "committedDate": "2020-09-07T03:09:45Z", "message": "Javadoc\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMjE5NDMz", "url": "https://github.com/pravega/pravega/pull/5149#pullrequestreview-483219433", "createdAt": "2020-09-07T03:19:35Z", "commit": {"oid": "4c95f498fe69343993fea7d0ffd321a74dfb6644"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMzoxOTozNVrOHNvALQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMzoxOTozNVrOHNvALQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2MzYyOQ==", "bodyText": "If a \"seal\" or \"deleteStream\" operation fails for a single stream should'nt we continue deleting the other streams?", "url": "https://github.com/pravega/pravega/pull/5149#discussion_r484163629", "createdAt": "2020-09-07T03:19:35Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/admin/impl/StreamManagerImpl.java", "diffHunk": "@@ -141,12 +141,27 @@ public boolean checkStreamExists(String scopeName, String streamName) {\n     }\n \n     @Override\n+    @Deprecated\n     public boolean deleteScope(String scopeName) {\n+        return deleteScope(scopeName, false);\n+    }\n+\n+    @Override\n+    public boolean deleteScope(String scopeName, boolean deleteStreams) {\n         NameUtils.validateUserScopeName(scopeName);\n         log.info(\"Deleting scope: {}\", scopeName);\n-        return  Futures.getThrowingException(controller.deleteScope(scopeName));\n+        \n+        if (deleteStreams) {\n+            Iterator<Stream> iterator = listStreams(scopeName);\n+            while (iterator.hasNext()) {\n+                Stream stream = iterator.next();\n+                Futures.getThrowingException(controller.sealStream(stream.getScope(), stream.getStreamName()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c95f498fe69343993fea7d0ffd321a74dfb6644"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fd3931311575a3e5c8b978b75b431542b62cc24", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/5fd3931311575a3e5c8b978b75b431542b62cc24", "committedDate": "2020-09-07T04:24:16Z", "message": "Add retry for seal\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5d0dec65710804f695d00ee4079f4c1313b81c3", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/c5d0dec65710804f695d00ee4079f4c1313b81c3", "committedDate": "2020-09-07T05:28:45Z", "message": "Merge branch 'master' into issue-5002"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d0386dd5a4e50d6cbc4af3ac6b455800ad4feb0", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/8d0386dd5a4e50d6cbc4af3ac6b455800ad4feb0", "committedDate": "2020-09-07T06:33:40Z", "message": "remove deprecated\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b671af8fff05c8f7de7b77378803957c0465c0a", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/2b671af8fff05c8f7de7b77378803957c0465c0a", "committedDate": "2020-09-07T06:34:07Z", "message": "Merge branch 'issue-5002' of https://github.com/shiveshr/pravega-1 into issue-5002"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f908c96dce6749f0e3c8aacd42a8dcaede0b610", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/6f908c96dce6749f0e3c8aacd42a8dcaede0b610", "committedDate": "2020-09-07T06:40:00Z", "message": "javadoc\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37e2ed8002af37edaa683b39d24ba18350f39bff", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/37e2ed8002af37edaa683b39d24ba18350f39bff", "committedDate": "2020-09-07T07:16:51Z", "message": "javadoc\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDAxNzg1", "url": "https://github.com/pravega/pravega/pull/5149#pullrequestreview-483401785", "createdAt": "2020-09-07T09:28:16Z", "commit": {"oid": "37e2ed8002af37edaa683b39d24ba18350f39bff"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "508305032dbdf809fadb6464842ee489e36410e2", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/508305032dbdf809fadb6464842ee489e36410e2", "committedDate": "2020-09-07T12:56:14Z", "message": "Merge branch 'master' into issue-5002"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3851, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}