{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM2MDEwODky", "number": 4876, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMDozNjoxNlrOEGgiYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzozNjozOFrOEMLU6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MjYwMDAyOnYy", "diffSide": "RIGHT", "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/PravegaRequestProcessor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMDozNjoxNlrOGlWeYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMDo0Mjo0MFrOGlWsrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgxODcyMQ==", "bodyText": "This offset check needs to be preformed atomically with respect to this put.\nAs is, this code will only check the length at the time the request arrived, but it could change by the time put is processed. So the value needs to be passed into tablestore to make the update atomic.", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r441818721", "createdAt": "2020-06-17T20:36:16Z", "author": {"login": "tkaitchuck"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/PravegaRequestProcessor.java", "diffHunk": "@@ -648,12 +651,19 @@ public void updateTableEntries(final WireCommands.UpdateTableEntries updateTable\n         }\n \n         val timer = new Timer();\n-        tableStore.put(segment, entries, TIMEOUT)\n-                .thenAccept(versions -> {\n-                    connection.send(new WireCommands.TableEntriesUpdated(updateTableEntries.getRequestId(), versions));\n-                    this.tableStatsRecorder.updateEntries(updateTableEntries.getSegment(), entries.size(), conditional.get(), timer.getElapsed());\n-                })\n-                .exceptionally(e -> handleException(updateTableEntries.getRequestId(), segment, operation, e));\n+        long tableSegmentOffset = updateTableEntries.getTableSegmentOffset();\n+        segmentInfo.thenCompose(properties -> {\n+            if (tableSegmentOffset == NULL_TABLE_SEGMENT_OFFSET || tableSegmentOffset == properties.getLength()) {\n+                return tableStore.put(segment, entries, TIMEOUT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d7041ee57c1d5332c3580726d10dad59426344d"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgyMjM4Mg==", "bodyText": "@co-jo You can push this check down all the way into ContainerTableExtensionImpl in the commit method. That method invokes DirectSegmentAccess.append which should have an overload that takes an offset (if it doesn't then we should add one (the plumbing underneath is already done)). That will guarantee this to be an atomic length-conditional append.", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r441822382", "createdAt": "2020-06-17T20:42:40Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/host/src/main/java/io/pravega/segmentstore/server/host/handler/PravegaRequestProcessor.java", "diffHunk": "@@ -648,12 +651,19 @@ public void updateTableEntries(final WireCommands.UpdateTableEntries updateTable\n         }\n \n         val timer = new Timer();\n-        tableStore.put(segment, entries, TIMEOUT)\n-                .thenAccept(versions -> {\n-                    connection.send(new WireCommands.TableEntriesUpdated(updateTableEntries.getRequestId(), versions));\n-                    this.tableStatsRecorder.updateEntries(updateTableEntries.getSegment(), entries.size(), conditional.get(), timer.getElapsed());\n-                })\n-                .exceptionally(e -> handleException(updateTableEntries.getRequestId(), segment, operation, e));\n+        long tableSegmentOffset = updateTableEntries.getTableSegmentOffset();\n+        segmentInfo.thenCompose(properties -> {\n+            if (tableSegmentOffset == NULL_TABLE_SEGMENT_OFFSET || tableSegmentOffset == properties.getLength()) {\n+                return tableStore.put(segment, entries, TIMEOUT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTgxODcyMQ=="}, "originalCommit": {"oid": "9d7041ee57c1d5332c3580726d10dad59426344d"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1OTYxOTI0OnYy", "diffSide": "RIGHT", "path": "shared/protocol/src/main/java/io/pravega/shared/protocol/netty/WireCommands.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNjo0MzoyM1rOGmbJbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNzoyODoyMVrOGqa9Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0Mzg1Mw==", "bodyText": "Note: I'm assuming that an offset of 0 is valid.", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r442943853", "createdAt": "2020-06-19T16:43:23Z", "author": {"login": "co-jo"}, "path": "shared/protocol/src/main/java/io/pravega/shared/protocol/netty/WireCommands.java", "diffHunk": "@@ -1662,7 +1662,7 @@ public static WireCommand readFrom(ByteBufInputStream in, int length) throws IOE\n             String segment = in.readUTF();\n             String delegationToken = in.readUTF();\n             TableEntries entries = (TableEntries) TableEntries.readFrom(in, in.available());\n-            long tableSegmentOffset = (in.available() > 0 ) ? in.readLong() : NULL_TABLE_SEGMENT_OFFSET;\n+            long tableSegmentOffset = (in.available() >= 0 ) ? in.readLong() : NULL_TABLE_SEGMENT_OFFSET;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ecebdfb271f25d0f587d3e0fb31f5802c87f94ea"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3NzI2NQ==", "bodyText": "An offset of 0 is valid, but why are you making this change? This checks for how many bytes are available for reading from the buffer stream.", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r447077265", "createdAt": "2020-06-29T15:55:01Z", "author": {"login": "andreipaduroiu"}, "path": "shared/protocol/src/main/java/io/pravega/shared/protocol/netty/WireCommands.java", "diffHunk": "@@ -1662,7 +1662,7 @@ public static WireCommand readFrom(ByteBufInputStream in, int length) throws IOE\n             String segment = in.readUTF();\n             String delegationToken = in.readUTF();\n             TableEntries entries = (TableEntries) TableEntries.readFrom(in, in.available());\n-            long tableSegmentOffset = (in.available() > 0 ) ? in.readLong() : NULL_TABLE_SEGMENT_OFFSET;\n+            long tableSegmentOffset = (in.available() >= 0 ) ? in.readLong() : NULL_TABLE_SEGMENT_OFFSET;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0Mzg1Mw=="}, "originalCommit": {"oid": "ecebdfb271f25d0f587d3e0fb31f5802c87f94ea"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEzNDk3OQ==", "bodyText": "Touche.. Had a little bit of a brain fart. Will revert.", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r447134979", "createdAt": "2020-06-29T17:28:21Z", "author": {"login": "co-jo"}, "path": "shared/protocol/src/main/java/io/pravega/shared/protocol/netty/WireCommands.java", "diffHunk": "@@ -1662,7 +1662,7 @@ public static WireCommand readFrom(ByteBufInputStream in, int length) throws IOE\n             String segment = in.readUTF();\n             String delegationToken = in.readUTF();\n             TableEntries entries = (TableEntries) TableEntries.readFrom(in, in.available());\n-            long tableSegmentOffset = (in.available() > 0 ) ? in.readLong() : NULL_TABLE_SEGMENT_OFFSET;\n+            long tableSegmentOffset = (in.available() >= 0 ) ? in.readLong() : NULL_TABLE_SEGMENT_OFFSET;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk0Mzg1Mw=="}, "originalCommit": {"oid": "ecebdfb271f25d0f587d3e0fb31f5802c87f94ea"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjI3ODQxOnYy", "diffSide": "RIGHT", "path": "segmentstore/contracts/src/main/java/io/pravega/segmentstore/contracts/tables/TableStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo0NjozOFrOGqXFdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo0NjozOFrOGqXFdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3MTYwNw==", "bodyText": "add \" conditioned on the Segment's Length matching an expected value\".\ndo this for remove too.", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r447071607", "createdAt": "2020-06-29T15:46:38Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/contracts/src/main/java/io/pravega/segmentstore/contracts/tables/TableStore.java", "diffHunk": "@@ -144,6 +145,32 @@ default int maximumValueLength() {\n      */\n     CompletableFuture<List<Long>> put(String segmentName, List<TableEntry> entries, Duration timeout);\n \n+    /**\n+     * Inserts new or updates existing Table Entries into the given Table Segment.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f07ba1461e0213b1b63f146755ea830ceb031c55"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjI4NDQwOnYy", "diffSide": "RIGHT", "path": "segmentstore/contracts/src/main/java/io/pravega/segmentstore/contracts/tables/TableStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo0Nzo1NVrOGqXJEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo0Nzo1NVrOGqXJEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3MjUzMQ==", "bodyText": "\"the actual offset\" -> \"the actual segment length\"\nchange it below too.", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r447072531", "createdAt": "2020-06-29T15:47:55Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/contracts/src/main/java/io/pravega/segmentstore/contracts/tables/TableStore.java", "diffHunk": "@@ -144,6 +145,32 @@ default int maximumValueLength() {\n      */\n     CompletableFuture<List<Long>> put(String segmentName, List<TableEntry> entries, Duration timeout);\n \n+    /**\n+     * Inserts new or updates existing Table Entries into the given Table Segment.\n+     *\n+     * @param segmentName        The name of the Table Segment to insert/update the Table Entries.\n+     * @param entries            A List of {@link TableEntry} instances to insert or update. If {@link TableEntry#key}\n+     *                           {@link TableKey#version hasVersion} returns true for at least one of the items in the list,\n+     *                           then this will perform an atomic Conditional Update. If {@link TableEntry#key}\n+     *                           {@link TableKey#version} hasVersion} returns false for ALL items in the list, then this\n+     *                           will perform an Unconditional update.\n+     * @param tableSegmentOffset The expected offset of the TableSegment used for conditional (expected matches actual) appends.\n+     * @param timeout            Timeout for the operation.\n+     * @return A CompletableFuture that, when completed, will contain a List with the current version of the each TableEntry\n+     * Key provided. The versions will be in the same order as the TableEntry instances provided. If the operation failed,\n+     * the future will be failed with the causing exception. Notable exceptions:\n+     * <ul>\n+     * <li>{@link StreamSegmentNotExistsException} If the Table Segment does not exist.</li>\n+     * <li>{@link TableKeyTooLongException} If {@link TableEntry#key} exceeds {@link #maximumKeyLength()}.</li>\n+     * <li>{@link TableValueTooLongException} If {@link TableEntry#value} exceeds {@link #maximumValueLength()}.</li>\n+     * <li>{@link ConditionalTableUpdateException} If {@link TableEntry#key} {@link TableKey#hasVersion() hasVersion() } is true and\n+     * {@link TableEntry#key} {@link TableKey#version} does not match the Table Entry's Key current Table Version. </li>\n+     * <li>{@link BadSegmentTypeException} If segmentName refers to a non-Table Segment. </li>\n+     * <li>{@link BadOffsetException} If there is a mismatch between the provided {@param tableSegmentOffset} and the actual offset.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f07ba1461e0213b1b63f146755ea830ceb031c55"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjI4OTI4OnYy", "diffSide": "RIGHT", "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/DirectSegmentAccess.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo0OToxNlrOGqXMKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo0OToxNlrOGqXMKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3MzMyMA==", "bodyText": "\"The expected length of the segment. If the current length of the Segment does not equal this value, the operation will fail with a {@link BadOffsetException}.\"", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r447073320", "createdAt": "2020-06-29T15:49:16Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/DirectSegmentAccess.java", "diffHunk": "@@ -51,14 +51,34 @@\n      */\n     CompletableFuture<Long> append(BufferView data, Collection<AttributeUpdate> attributeUpdates, Duration timeout);\n \n+    /**\n+     * Appends a range of bytes at the end of the Segment and atomically updates the given attributes. The byte range\n+     * will be appended as a contiguous block, however there is no guarantee of ordering between different calls to this\n+     * method.\n+     * @see io.pravega.segmentstore.contracts.StreamSegmentStore#append(String, BufferView, Collection, Duration)\n+     *\n+     * @param data             The data to add.\n+     * @param attributeUpdates A Collection of Attribute-Values to set or update. May be null (which indicates no updates).\n+     *                         See Notes about AttributeUpdates in the interface Javadoc.\n+     * @param offset           The expected offset that the append will occur at.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f07ba1461e0213b1b63f146755ea830ceb031c55"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjI5MTQ4OnYy", "diffSide": "RIGHT", "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/containers/StreamSegmentContainer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo0OTo0M1rOGqXNcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo0OTo0M1rOGqXNcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3MzY1MQ==", "bodyText": "tableSegmentOffset -> offset", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r447073651", "createdAt": "2020-06-29T15:49:43Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/containers/StreamSegmentContainer.java", "diffHunk": "@@ -882,6 +882,15 @@ private void shutdownWhenStopped(Service component, String componentName) {\n                     .thenApply(v -> operation.getStreamSegmentOffset());\n         }\n \n+        @Override\n+        public CompletableFuture<Long> append(BufferView data, Collection<AttributeUpdate> attributeUpdates, long tableSegmentOffset, Duration timeout) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f07ba1461e0213b1b63f146755ea830ceb031c55"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjMwNTcyOnYy", "diffSide": "RIGHT", "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/tables/ContainerTableExtensionImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo1Mjo1OFrOGqXWHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo1Mjo1OFrOGqXWHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3NTg3MA==", "bodyText": "No. Do not import this value. This code should not depend on io.pravega.shared.protocol.\nDefine an internal constant NO_OFFSET, set it to -1, and use it just in this class. Then in commit, invoke the appropriate API of DirectSegmentAccess based on whether you have this value or not. (actually you already make this check, so just change it to the internal value)", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r447075870", "createdAt": "2020-06-29T15:52:58Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/tables/ContainerTableExtensionImpl.java", "diffHunk": "@@ -53,6 +54,7 @@\n import lombok.extern.slf4j.Slf4j;\n import lombok.val;\n \n+import static io.pravega.shared.protocol.netty.WireCommands.NULL_TABLE_SEGMENT_OFFSET;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f07ba1461e0213b1b63f146755ea830ceb031c55"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjMwODA2OnYy", "diffSide": "RIGHT", "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/tables/ContainerTableExtensionImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo1MzozMlrOGqXXjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo1MzozMlrOGqXXjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3NjIzNw==", "bodyText": "Remove the second part of this check. You cannot rely on the length of the segment at this point as there may be multiple operations in flight that will affect it before your operation is processed.", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r447076237", "createdAt": "2020-06-29T15:53:32Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/tables/ContainerTableExtensionImpl.java", "diffHunk": "@@ -320,9 +332,15 @@ protected int getMaxCompactionSize() {\n     }\n \n     private <T> CompletableFuture<Long> commit(Collection<T> toCommit, Function<Collection<T>, BufferView> serializer,\n-                                               DirectSegmentAccess segment, Duration timeout) {\n-        BufferView s = serializer.apply(toCommit);\n-        return segment.append(s, null, timeout);\n+                                               DirectSegmentAccess segment, long tableSegmentOffset, Duration timeout) {\n+        if (tableSegmentOffset == NULL_TABLE_SEGMENT_OFFSET || tableSegmentOffset == segment.getInfo().getLength()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f07ba1461e0213b1b63f146755ea830ceb031c55"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjMwOTM1OnYy", "diffSide": "RIGHT", "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/tables/ContainerTableExtensionImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo1Mzo1M1rOGqXYcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTo1Mzo1M1rOGqXYcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA3NjQ2Ng==", "bodyText": "Invoke the appropriate DirectSegmentAccess.append method here instead of throwing this.", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r447076466", "createdAt": "2020-06-29T15:53:53Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/tables/ContainerTableExtensionImpl.java", "diffHunk": "@@ -320,9 +332,15 @@ protected int getMaxCompactionSize() {\n     }\n \n     private <T> CompletableFuture<Long> commit(Collection<T> toCommit, Function<Collection<T>, BufferView> serializer,\n-                                               DirectSegmentAccess segment, Duration timeout) {\n-        BufferView s = serializer.apply(toCommit);\n-        return segment.append(s, null, timeout);\n+                                               DirectSegmentAccess segment, long tableSegmentOffset, Duration timeout) {\n+        if (tableSegmentOffset == NULL_TABLE_SEGMENT_OFFSET || tableSegmentOffset == segment.getInfo().getLength()) {\n+            BufferView s = serializer.apply(toCommit);\n+            return segment.append(s, null, timeout);\n+        } else {\n+            CompletableFuture<Long> future = new CompletableFuture<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f07ba1461e0213b1b63f146755ea830ceb031c55"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTI2MTUwOnYy", "diffSide": "RIGHT", "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/tables/ContainerTableExtensionImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNjoxOTowOFrOGrsvmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNjoxOTowOFrOGrsvmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ3NTAzMg==", "bodyText": "I was only asking you to do the conditional commit for the second case. Please bring back the if-else block and only pass the explicit offset in the else case. Do not pass tableSegmentOffset in the if case as it's just a coincidence that -1 is the \"no-offset\" append that is now in the Segment Store. By using the other append (non-conditional), you shield yourself from any future change in the segment store that may affect how that works.", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r448475032", "createdAt": "2020-07-01T16:19:08Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/tables/ContainerTableExtensionImpl.java", "diffHunk": "@@ -333,14 +336,8 @@ protected int getMaxCompactionSize() {\n \n     private <T> CompletableFuture<Long> commit(Collection<T> toCommit, Function<Collection<T>, BufferView> serializer,\n                                                DirectSegmentAccess segment, long tableSegmentOffset, Duration timeout) {\n-        if (tableSegmentOffset == NULL_TABLE_SEGMENT_OFFSET || tableSegmentOffset == segment.getInfo().getLength()) {\n             BufferView s = serializer.apply(toCommit);\n-            return segment.append(s, null, timeout);\n-        } else {\n-            CompletableFuture<Long> future = new CompletableFuture<>();\n-            future.completeExceptionally(new BadOffsetException(segment.getInfo().getName(), segment.getInfo().getLength(), tableSegmentOffset));\n-            return future;\n-        }\n+            return segment.append(s, null, tableSegmentOffset, timeout);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "661146653a39a8a1d968b2a7e2c5db28e6090969"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjAyNzk1OnYy", "diffSide": "RIGHT", "path": "segmentstore/contracts/src/main/java/io/pravega/segmentstore/contracts/tables/TableStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzozMzoyMVrOGuIwTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzozMzoyMVrOGuIwTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzMTExNw==", "bodyText": "then this will perform an Unconditional update\n\nIt seems like it will still be conditional on the tableSegmentOffset", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r451031117", "createdAt": "2020-07-07T17:33:21Z", "author": {"login": "tkaitchuck"}, "path": "segmentstore/contracts/src/main/java/io/pravega/segmentstore/contracts/tables/TableStore.java", "diffHunk": "@@ -144,6 +145,33 @@ default int maximumValueLength() {\n      */\n     CompletableFuture<List<Long>> put(String segmentName, List<TableEntry> entries, Duration timeout);\n \n+    /**\n+     * Inserts new or updates existing Table Entries (conditioned on the Segment's length matching an expected value)\n+     * into the given Segment.\n+     *\n+     * @param segmentName        The name of the Table Segment to insert/update the Table Entries.\n+     * @param entries            A List of {@link TableEntry} instances to insert or update. If {@link TableEntry#key}\n+     *                           {@link TableKey#version hasVersion} returns true for at least one of the items in the list,\n+     *                           then this will perform an atomic Conditional Update. If {@link TableEntry#key}\n+     *                           {@link TableKey#version} hasVersion} returns false for ALL items in the list, then this\n+     *                           will perform an Unconditional update.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df85291b65f0108fab126d1af06b8beb5ddf12d8"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjAzMzI2OnYy", "diffSide": "RIGHT", "path": "segmentstore/contracts/src/main/java/io/pravega/segmentstore/contracts/tables/TableStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzozNDo1OVrOGuIzpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzozNDo1OVrOGuIzpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzMTk3Mw==", "bodyText": "same here", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r451031973", "createdAt": "2020-07-07T17:34:59Z", "author": {"login": "tkaitchuck"}, "path": "segmentstore/contracts/src/main/java/io/pravega/segmentstore/contracts/tables/TableStore.java", "diffHunk": "@@ -165,6 +193,29 @@ default int maximumValueLength() {\n      */\n     CompletableFuture<Void> remove(String segmentName, Collection<TableKey> keys, Duration timeout);\n \n+    /**\n+     * Removes one or more Table Keys from the given Table Segment.\n+     *\n+     * @param segmentName        The name of the Table Segment to remove the Keys from.\n+     * @param keys               A Collection of {@link TableKey} instances to remove. If {@link TableKey#hasVersion()} returns\n+     *                           true for at least one of the TableKeys in this collection, then this will perform an atomic\n+     *                           Conditional Update (Removal). If {@link TableKey#hasVersion()} returns false for ALL items in\n+     *                           the collection, then this will perform an Unconditional Update (Removal).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df85291b65f0108fab126d1af06b8beb5ddf12d8"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxMjAzOTQ2OnYy", "diffSide": "RIGHT", "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/DirectSegmentAccess.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNzozNjozOFrOGuI3jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxOTo1NzowMFrOGvft1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzMjk3Mw==", "bodyText": "May be null (which indicates no updates).\n\nWouldn't an empty list convery this more clearly?", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r451032973", "createdAt": "2020-07-07T17:36:38Z", "author": {"login": "tkaitchuck"}, "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/DirectSegmentAccess.java", "diffHunk": "@@ -51,14 +51,35 @@\n      */\n     CompletableFuture<Long> append(BufferView data, Collection<AttributeUpdate> attributeUpdates, Duration timeout);\n \n+    /**\n+     * Appends a range of bytes at the end of the Segment and atomically updates the given attributes. The byte range\n+     * will be appended as a contiguous block, however there is no guarantee of ordering between different calls to this\n+     * method.\n+     * @see io.pravega.segmentstore.contracts.StreamSegmentStore#append(String, BufferView, Collection, Duration)\n+     *\n+     * @param data             The data to add.\n+     * @param attributeUpdates A Collection of Attribute-Values to set or update. May be null (which indicates no updates).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df85291b65f0108fab126d1af06b8beb5ddf12d8"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjQ1NTg5NQ==", "bodyText": "StreamSegmentContainer handles an empty list and null equally. May need @andreipaduroiu's thoughts on this.", "url": "https://github.com/pravega/pravega/pull/4876#discussion_r452455895", "createdAt": "2020-07-09T19:57:00Z", "author": {"login": "co-jo"}, "path": "segmentstore/server/src/main/java/io/pravega/segmentstore/server/DirectSegmentAccess.java", "diffHunk": "@@ -51,14 +51,35 @@\n      */\n     CompletableFuture<Long> append(BufferView data, Collection<AttributeUpdate> attributeUpdates, Duration timeout);\n \n+    /**\n+     * Appends a range of bytes at the end of the Segment and atomically updates the given attributes. The byte range\n+     * will be appended as a contiguous block, however there is no guarantee of ordering between different calls to this\n+     * method.\n+     * @see io.pravega.segmentstore.contracts.StreamSegmentStore#append(String, BufferView, Collection, Duration)\n+     *\n+     * @param data             The data to add.\n+     * @param attributeUpdates A Collection of Attribute-Values to set or update. May be null (which indicates no updates).", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTAzMjk3Mw=="}, "originalCommit": {"oid": "df85291b65f0108fab126d1af06b8beb5ddf12d8"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4764, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}