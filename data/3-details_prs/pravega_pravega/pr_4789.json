{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NDgxMTEx", "number": 4789, "title": "Issue 4792: API stubs for supporting offset/version based TableSegment reads.", "bodyText": "Change log description\n\nStub out new APIs.\n\nPurpose of the change\nAddresses #4792 .\nWhat the code does\n(Detailed description of the code changes)\nThis code defines new (and refactors old) APIs that will allow the various teams to begin work on supporting offset/version based TableSegment reads.\nHow to verify it\n\nRun WireCommandTests.", "createdAt": "2020-05-13T16:37:53Z", "url": "https://github.com/pravega/pravega/pull/4789", "merged": true, "mergeCommit": {"oid": "560d085c0657c7e491286e77b3b5a447b9c1bd00"}, "closed": true, "closedAt": "2020-05-18T17:00:33Z", "author": {"login": "co-jo"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgoa95gH2gAyNDE3NDgxMTExOmRmNmRkYWE1OGZkZWQ2MTI4YmFkNWZjMzVkZGNkMWVjODE3YTI5ZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcigzRGAFqTQxMzY1MjUyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "df6ddaa58fded6128bad5fc35ddcd1ec817a29d5", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/df6ddaa58fded6128bad5fc35ddcd1ec817a29d5", "committedDate": "2020-05-12T18:17:19Z", "message": "Initial API proposal on offset based TableSegment reads.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e4e548363b9d4b5fd627e402fdef73d32a6693e", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/1e4e548363b9d4b5fd627e402fdef73d32a6693e", "committedDate": "2020-05-12T20:54:44Z", "message": "Fix misordered writes.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5f07d793d7b2c9ed6986cdcdd8260553f335d02", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/f5f07d793d7b2c9ed6986cdcdd8260553f335d02", "committedDate": "2020-05-12T21:33:15Z", "message": "Add basic unit tests for new WireCommands.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMzY3Nzk2", "url": "https://github.com/pravega/pravega/pull/4789#pullrequestreview-411367796", "createdAt": "2020-05-13T23:29:51Z", "commit": {"oid": "f5f07d793d7b2c9ed6986cdcdd8260553f335d02"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMzoyOTo1MVrOGVHAZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMzoyOTo1MVrOGVHAZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc4ODA2OQ==", "bodyText": "Maybe make these two different so we also check that order is preserved.", "url": "https://github.com/pravega/pravega/pull/4789#discussion_r424788069", "createdAt": "2020-05-13T23:29:51Z", "author": {"login": "tkaitchuck"}, "path": "shared/protocol/src/test/java/io/pravega/shared/protocol/netty/WireCommandsTest.java", "diffHunk": "@@ -807,6 +807,24 @@ public void testTableEntriesIteratorItem() throws IOException {\n         testCommand(cmd);\n     }\n \n+    @Test\n+    public void testReadTableEntriesDelta() throws IOException {\n+        WireCommands.ReadTableEntriesDelta cmd = new WireCommands.ReadTableEntriesDelta(l, testString1, \"\", 1L, 100);\n+        testCommand(cmd);\n+    }\n+\n+    @Test\n+    public void testtableEntriesDeltaRead() throws IOException {\n+        List<Map.Entry<WireCommands.TableKey, WireCommands.TableValue>> entries = Arrays.asList(\n+                new SimpleImmutableEntry<>(new WireCommands.TableKey(buf, l), new WireCommands.TableValue(buf)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f07d793d7b2c9ed6986cdcdd8260553f335d02"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNDQ4MDIy", "url": "https://github.com/pravega/pravega/pull/4789#pullrequestreview-411448022", "createdAt": "2020-05-14T03:56:07Z", "commit": {"oid": "f5f07d793d7b2c9ed6986cdcdd8260553f335d02"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMzo1NjowN1rOGVLMag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwMzo1NjoyN1rOGVLMwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg1NjY4Mg==", "bodyText": "we should read this value only if it available.Else the OLDEST_COMPATIBLE_VERSION will change.", "url": "https://github.com/pravega/pravega/pull/4789#discussion_r424856682", "createdAt": "2020-05-14T03:56:07Z", "author": {"login": "shrids"}, "path": "shared/protocol/src/main/java/io/pravega/shared/protocol/netty/WireCommands.java", "diffHunk": "@@ -1652,15 +1653,17 @@ public void writeFields(DataOutput out) throws IOException {\n             out.writeUTF(segment);\n             out.writeUTF(delegationToken == null ? \"\" : delegationToken);\n             tableEntries.writeFields(out);\n+            out.writeLong(tableSegmentOffset);\n         }\n \n         public static WireCommand readFrom(ByteBufInputStream in, int length) throws IOException {\n             long requestId = in.readLong();\n             String segment = in.readUTF();\n             String delegationToken = in.readUTF();\n             TableEntries entries = (TableEntries) TableEntries.readFrom(in, in.available());\n+            long tableSegmentOffset = in.readLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f07d793d7b2c9ed6986cdcdd8260553f335d02"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg1Njc2OQ==", "bodyText": "same as above.", "url": "https://github.com/pravega/pravega/pull/4789#discussion_r424856769", "createdAt": "2020-05-14T03:56:27Z", "author": {"login": "shrids"}, "path": "shared/protocol/src/main/java/io/pravega/shared/protocol/netty/WireCommands.java", "diffHunk": "@@ -1730,7 +1735,9 @@ public static WireCommand readFrom(ByteBufInputStream in, int length) throws IOE\n             for (int i = 0; i < numberOfKeys; i++) {\n                 keys.add((TableKey) TableKey.readFrom(in, in.available()));\n             }\n-            return new RemoveTableKeys(requestId, segment, delegationToken, keys);\n+            long tableSegmentOffset = in.readLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f07d793d7b2c9ed6986cdcdd8260553f335d02"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMDAxNTMz", "url": "https://github.com/pravega/pravega/pull/4789#pullrequestreview-412001533", "createdAt": "2020-05-14T16:55:42Z", "commit": {"oid": "f5f07d793d7b2c9ed6986cdcdd8260553f335d02"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjo1NTo0MlrOGVlmLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzowNTo1MFrOGVl_VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4OTI2Mw==", "bodyText": "Default this to something negative such as -1 or Long.MIN_VALUE. The contract will be that if we are provided a negative value, the update will be unconditioned (on the length of the segment). Otherwise (0 included), we'll condition the update on the table segment having the specified length.\nI would further suggest encoding this as a public constant in the wire command itself.", "url": "https://github.com/pravega/pravega/pull/4789#discussion_r425289263", "createdAt": "2020-05-14T16:55:42Z", "author": {"login": "andreipaduroiu"}, "path": "controller/src/main/java/io/pravega/controller/server/SegmentHelper.java", "diffHunk": "@@ -403,7 +403,7 @@ private String getTransactionName(String scope, String stream, long segmentId, U\n         RawClient connection = new RawClient(ModelHelper.encode(uri), connectionFactory);\n         final long requestId = connection.getFlow().asLong();\n         WireCommands.UpdateTableEntries request = new WireCommands.UpdateTableEntries(requestId, tableName, delegationToken,\n-                new WireCommands.TableEntries(wireCommandEntries));\n+                new WireCommands.TableEntries(wireCommandEntries), 0L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f07d793d7b2c9ed6986cdcdd8260553f335d02"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4OTQxMg==", "bodyText": "Same with Remove below.", "url": "https://github.com/pravega/pravega/pull/4789#discussion_r425289412", "createdAt": "2020-05-14T16:55:53Z", "author": {"login": "andreipaduroiu"}, "path": "controller/src/main/java/io/pravega/controller/server/SegmentHelper.java", "diffHunk": "@@ -403,7 +403,7 @@ private String getTransactionName(String scope, String stream, long segmentId, U\n         RawClient connection = new RawClient(ModelHelper.encode(uri), connectionFactory);\n         final long requestId = connection.getFlow().asLong();\n         WireCommands.UpdateTableEntries request = new WireCommands.UpdateTableEntries(requestId, tableName, delegationToken,\n-                new WireCommands.TableEntries(wireCommandEntries));\n+                new WireCommands.TableEntries(wireCommandEntries), 0L);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4OTI2Mw=="}, "originalCommit": {"oid": "f5f07d793d7b2c9ed6986cdcdd8260553f335d02"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI4OTk0Mg==", "bodyText": "Correct. Check out for other examples in this file; there should be a few that followed the same pattern.", "url": "https://github.com/pravega/pravega/pull/4789#discussion_r425289942", "createdAt": "2020-05-14T16:56:40Z", "author": {"login": "andreipaduroiu"}, "path": "shared/protocol/src/main/java/io/pravega/shared/protocol/netty/WireCommands.java", "diffHunk": "@@ -1652,15 +1653,17 @@ public void writeFields(DataOutput out) throws IOException {\n             out.writeUTF(segment);\n             out.writeUTF(delegationToken == null ? \"\" : delegationToken);\n             tableEntries.writeFields(out);\n+            out.writeLong(tableSegmentOffset);\n         }\n \n         public static WireCommand readFrom(ByteBufInputStream in, int length) throws IOException {\n             long requestId = in.readLong();\n             String segment = in.readUTF();\n             String delegationToken = in.readUTF();\n             TableEntries entries = (TableEntries) TableEntries.readFrom(in, in.available());\n+            long tableSegmentOffset = in.readLong();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg1NjY4Mg=="}, "originalCommit": {"oid": "f5f07d793d7b2c9ed6986cdcdd8260553f335d02"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI5MDMzNQ==", "bodyText": "And if not provided, then set it to that negative value I mentioned in the comment above.", "url": "https://github.com/pravega/pravega/pull/4789#discussion_r425290335", "createdAt": "2020-05-14T16:57:20Z", "author": {"login": "andreipaduroiu"}, "path": "shared/protocol/src/main/java/io/pravega/shared/protocol/netty/WireCommands.java", "diffHunk": "@@ -1652,15 +1653,17 @@ public void writeFields(DataOutput out) throws IOException {\n             out.writeUTF(segment);\n             out.writeUTF(delegationToken == null ? \"\" : delegationToken);\n             tableEntries.writeFields(out);\n+            out.writeLong(tableSegmentOffset);\n         }\n \n         public static WireCommand readFrom(ByteBufInputStream in, int length) throws IOException {\n             long requestId = in.readLong();\n             String segment = in.readUTF();\n             String delegationToken = in.readUTF();\n             TableEntries entries = (TableEntries) TableEntries.readFrom(in, in.available());\n+            long tableSegmentOffset = in.readLong();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDg1NjY4Mg=="}, "originalCommit": {"oid": "f5f07d793d7b2c9ed6986cdcdd8260553f335d02"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI5NTcwMQ==", "bodyText": "Have this throw UnsupportedOperationException and add a comment that it will be implemented with\n#4677", "url": "https://github.com/pravega/pravega/pull/4789#discussion_r425295701", "createdAt": "2020-05-14T17:05:50Z", "author": {"login": "andreipaduroiu"}, "path": "shared/protocol/src/main/java/io/pravega/shared/protocol/netty/WireCommands.java", "diffHunk": "@@ -2182,6 +2189,78 @@ public boolean isFailure() {\n         }\n     }\n \n+    @Data\n+    public static final class ReadTableEntriesDelta implements Request, WireCommand {\n+        final WireCommandType type = WireCommandType.READ_TABLE_ENTRIES_DELTA;\n+        final long requestId;\n+        final String segment;\n+        @ToString.Exclude\n+        final String delegationToken;\n+        final long fromVersion;\n+        final int suggestedEntryCount;\n+\n+        @Override\n+        public void process(RequestProcessor cp) {\n+\n+        }\n+\n+        @Override\n+        public void writeFields(DataOutput out) throws IOException {\n+            out.writeLong(requestId);\n+            out.writeUTF(segment);\n+            out.writeUTF(delegationToken == null ? \"\" : delegationToken);\n+            out.writeLong(fromVersion);\n+            out.writeInt(suggestedEntryCount);\n+        }\n+\n+        public static WireCommand readFrom(ByteBufInputStream in, int length) throws IOException {\n+            long requestId = in.readLong();\n+            String segment = in.readUTF();\n+            String delegationToken = in.readUTF();\n+            long fromVersion = in.readLong();\n+            int suggestedEntryCount = in.readInt();\n+\n+            return new ReadTableEntriesDelta(requestId, segment, delegationToken, fromVersion, suggestedEntryCount);\n+        }\n+    }\n+\n+    @Data\n+    public static final class TableEntriesDeltaRead implements Reply, WireCommand {\n+        final WireCommandType type = WireCommandType.TABLE_ENTRIES_DELTA_READ;\n+        final long requestId;\n+        final String segment;\n+        final TableEntries tableEntries;\n+        final boolean shouldClear;\n+        final boolean reachedEnd;\n+        final long lastVersion;\n+\n+        @Override\n+        public void process(ReplyProcessor cp) {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5f07d793d7b2c9ed6986cdcdd8260553f335d02"}, "originalPosition": 114}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "672a07692f3a654dd6d4615c914df412ccbe2d38", "author": {"user": {"login": "co-jo", "name": "Colin Hryniowski"}}, "url": "https://github.com/pravega/pravega/commit/672a07692f3a654dd6d4615c914df412ccbe2d38", "committedDate": "2020-05-14T19:34:49Z", "message": "Add checks if a tableSegmentOffset was provided.\nCreates a constant value signifying no offset was provided.\n\nSigned-off-by: co-jo <colin.hryniowski@dell.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMzI1MDg2", "url": "https://github.com/pravega/pravega/pull/4789#pullrequestreview-412325086", "createdAt": "2020-05-15T03:35:09Z", "commit": {"oid": "672a07692f3a654dd6d4615c914df412ccbe2d38"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85d2ba3d13d42ef345f72ee84d169b87f3d9b8b0", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/85d2ba3d13d42ef345f72ee84d169b87f3d9b8b0", "committedDate": "2020-05-18T14:31:13Z", "message": "Merge branch 'master' into issue-4677-offset-table-reads"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNjUyNTI0", "url": "https://github.com/pravega/pravega/pull/4789#pullrequestreview-413652524", "createdAt": "2020-05-18T14:32:28Z", "commit": {"oid": "672a07692f3a654dd6d4615c914df412ccbe2d38"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3478, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}