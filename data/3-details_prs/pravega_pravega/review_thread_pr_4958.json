{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MDc2MTMw", "number": 4958, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjoxOToxOFrOERBTkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMToyMjozM1rOEUkSSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MjgyNjQzOnYy", "diffSide": "LEFT", "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjoxOToxOFrOG1f0-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxNToyMjoxM1rOG2PoHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTE3OQ==", "bodyText": "why is this being changed? what was wrong with taking the kvt from the context?", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r458749179", "createdAt": "2020-07-22T12:19:18Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -57,20 +51,12 @@ KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n \n     @Override\n     public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2OTE5Nw==", "bodyText": "There is no benefit in taking KVT from context in case of InMemoryStore as all data is already in memory.\nWhen using KVT from context, the KVTable object is available in the context though it is removed from the scope. Besides it has State=\"Deleting\" which causes the isDeleted() method to never compete.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r458869197", "createdAt": "2020-07-22T15:13:54Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -57,20 +51,12 @@ KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n \n     @Override\n     public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTE3OQ=="}, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUxMTAwMw==", "bodyText": "what is the delete method doing? perhaps it should be implemented such that it marks the entry as deleted and removes the entry from the map.\nthat way context will be able to get the correct value as well.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r459511003", "createdAt": "2020-07-23T14:53:38Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -57,20 +51,12 @@ KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n \n     @Override\n     public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTE3OQ=="}, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMjMxNw==", "bodyText": "It should all fall in place once Scopes are implemented correctly in InMemoryKVTMetadataStore.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r459532317", "createdAt": "2020-07-23T15:22:13Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -57,20 +51,12 @@ KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n \n     @Override\n     public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTE3OQ=="}, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MjgzMDI5OnYy", "diffSide": "RIGHT", "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjoyMDoyMlrOG1f3TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOTo1NDo1MVrOG4Fa9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTc3Mw==", "bodyText": "why is the check on scopes?\nshouldnt the check be on table.. if the table doesnt exist, create it.. else return an already created table.. and this should be concurrency protected.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r458749773", "createdAt": "2020-07-22T12:20:22Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -57,20 +51,12 @@ KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n \n     @Override\n     public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n-            }\n-            InMemoryScope kvtScope = scopes.get(scope);\n-            Optional<InMemoryKVTable> kvTable = kvtScope.getKVTableFromScope(name);\n-            kvt = kvTable.orElse(new InMemoryKVTable(scope, name));\n+        if (!scopes.containsKey(scope)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1MDA5Mg==", "bodyText": "and why are we creating kvt object if the scope doesnt exist?\nthis logic seems incorrect.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r458750092", "createdAt": "2020-07-22T12:21:04Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -57,20 +51,12 @@ KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n \n     @Override\n     public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n-            }\n-            InMemoryScope kvtScope = scopes.get(scope);\n-            Optional<InMemoryKVTable> kvTable = kvtScope.getKVTableFromScope(name);\n-            kvt = kvTable.orElse(new InMemoryKVTable(scope, name));\n+        if (!scopes.containsKey(scope)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTc3Mw=="}, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ5MjIxMg==", "bodyText": "This was added because scopes created in StreamStore are not available inside KVTStore. Will fix this in the PR for issue #4960.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r459492212", "createdAt": "2020-07-23T14:28:33Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -57,20 +51,12 @@ KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n \n     @Override\n     public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n-            }\n-            InMemoryScope kvtScope = scopes.get(scope);\n-            Optional<InMemoryKVTable> kvTable = kvtScope.getKVTableFromScope(name);\n-            kvt = kvTable.orElse(new InMemoryKVTable(scope, name));\n+        if (!scopes.containsKey(scope)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTc3Mw=="}, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUxMTc5Ng==", "bodyText": "still, the condition being added here with scopes doesnt exist seems to be introducing an incorrectness. Perhaps we should fix 4960 first before we fix this.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r459511796", "createdAt": "2020-07-23T14:54:39Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -57,20 +51,12 @@ KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n \n     @Override\n     public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n-            }\n-            InMemoryScope kvtScope = scopes.get(scope);\n-            Optional<InMemoryKVTable> kvTable = kvtScope.getKVTableFromScope(name);\n-            kvt = kvTable.orElse(new InMemoryKVTable(scope, name));\n+        if (!scopes.containsKey(scope)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTc3Mw=="}, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUyNzQ2Mw==", "bodyText": "Sure. I can raise the PR for 4960 and merge this after that.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r459527463", "createdAt": "2020-07-23T15:15:36Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -57,20 +51,12 @@ KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n \n     @Override\n     public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n-            }\n-            InMemoryScope kvtScope = scopes.get(scope);\n-            Optional<InMemoryKVTable> kvTable = kvtScope.getKVTableFromScope(name);\n-            kvt = kvTable.orElse(new InMemoryKVTable(scope, name));\n+        if (!scopes.containsKey(scope)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTc3Mw=="}, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ2MjI2Mg==", "bodyText": "Fixed as part of this PR.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r461462262", "createdAt": "2020-07-28T09:54:51Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -57,20 +51,12 @@ KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n \n     @Override\n     public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n-            }\n-            InMemoryScope kvtScope = scopes.get(scope);\n-            Optional<InMemoryKVTable> kvTable = kvtScope.getKVTableFromScope(name);\n-            kvt = kvTable.orElse(new InMemoryKVTable(scope, name));\n+        if (!scopes.containsKey(scope)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTc3Mw=="}, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MzQ0OTgxOnYy", "diffSide": "RIGHT", "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNDo0NjoxNFrOG1l48g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOTo1NTowM1rOG4FbcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg0ODQ5OA==", "bodyText": "Remove executor from the argument list.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r458848498", "createdAt": "2020-07-22T14:46:14Z", "author": {"login": "andreipaduroiu"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -40,14 +39,9 @@\n     @GuardedBy(\"$lock\")\n     private Map<String, InMemoryScope> scopes = new HashMap<>();\n \n-    private final AtomicInt96 counter;\n-\n-    private final Executor executor;\n \n     public InMemoryKVTMetadataStore(Executor executor) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg2OTczNA==", "bodyText": "Ok. Sure.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r458869734", "createdAt": "2020-07-22T15:14:37Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -40,14 +39,9 @@\n     @GuardedBy(\"$lock\")\n     private Map<String, InMemoryScope> scopes = new HashMap<>();\n \n-    private final AtomicInt96 counter;\n-\n-    private final Executor executor;\n \n     public InMemoryKVTMetadataStore(Executor executor) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg0ODQ5OA=="}, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ2MjM4NQ==", "bodyText": "fixed", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r461462385", "createdAt": "2020-07-28T09:55:03Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -40,14 +39,9 @@\n     @GuardedBy(\"$lock\")\n     private Map<String, InMemoryScope> scopes = new HashMap<>();\n \n-    private final AtomicInt96 counter;\n-\n-    private final Executor executor;\n \n     public InMemoryKVTMetadataStore(Executor executor) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg0ODQ5OA=="}, "originalCommit": {"oid": "5b376c253ae7eb4edf6a5a2cff5ebcf4cfede41e"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDU2MzM0OnYy", "diffSide": "RIGHT", "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDo1MzoyMVrOG4og5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjozNjo1M1rOG5hHaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzIyMA==", "bodyText": "streamstore.getScopes is returning a map which is not synchronization protected in its access here..\ninstead expose a syncrhonized method on the stream store for getting the scope.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462037220", "createdAt": "2020-07-29T04:53:21Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -36,48 +36,44 @@\n     @GuardedBy(\"$lock\")\n     private final Map<String, Integer> deletedKVTables = new HashMap<>();\n \n-    @Setter\n-    @GuardedBy(\"$lock\")\n-    private Map<String, InMemoryScope> scopes = new HashMap<>();\n-\n-    private final AtomicInt96 counter;\n-\n-    private final Executor executor;\n+    private final InMemoryStreamMetadataStore streamStore;\n+    private final ScheduledExecutorService executor;\n \n-    public InMemoryKVTMetadataStore(Executor executor) {\n+    public InMemoryKVTMetadataStore(StreamMetadataStore streamStore, ScheduledExecutorService executor) {\n         super(new InMemoryHostIndex());\n+        this.streamStore = (InMemoryStreamMetadataStore) streamStore;\n         this.executor = executor;\n-        this.counter = new AtomicInt96();\n     }\n \n     @Override\n-    KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n+    @Synchronized\n+    KeyValueTable newKeyValueTable(String scope, String name) {\n+        if (this.streamStore.getScopes().containsKey(scope)) {\n+            InMemoryScope kvtScope = this.streamStore.getScopes().get(scope);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM3MzI3NQ==", "bodyText": "Sure.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462373275", "createdAt": "2020-07-29T15:07:55Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -36,48 +36,44 @@\n     @GuardedBy(\"$lock\")\n     private final Map<String, Integer> deletedKVTables = new HashMap<>();\n \n-    @Setter\n-    @GuardedBy(\"$lock\")\n-    private Map<String, InMemoryScope> scopes = new HashMap<>();\n-\n-    private final AtomicInt96 counter;\n-\n-    private final Executor executor;\n+    private final InMemoryStreamMetadataStore streamStore;\n+    private final ScheduledExecutorService executor;\n \n-    public InMemoryKVTMetadataStore(Executor executor) {\n+    public InMemoryKVTMetadataStore(StreamMetadataStore streamStore, ScheduledExecutorService executor) {\n         super(new InMemoryHostIndex());\n+        this.streamStore = (InMemoryStreamMetadataStore) streamStore;\n         this.executor = executor;\n-        this.counter = new AtomicInt96();\n     }\n \n     @Override\n-    KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n+    @Synchronized\n+    KeyValueTable newKeyValueTable(String scope, String name) {\n+        if (this.streamStore.getScopes().containsKey(scope)) {\n+            InMemoryScope kvtScope = this.streamStore.getScopes().get(scope);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzIyMA=="}, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg5NTU1Nw==", "bodyText": "fixed. returning an immutable map from StreamStore so there is no need for synchronization.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462895557", "createdAt": "2020-07-30T10:14:04Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -36,48 +36,44 @@\n     @GuardedBy(\"$lock\")\n     private final Map<String, Integer> deletedKVTables = new HashMap<>();\n \n-    @Setter\n-    @GuardedBy(\"$lock\")\n-    private Map<String, InMemoryScope> scopes = new HashMap<>();\n-\n-    private final AtomicInt96 counter;\n-\n-    private final Executor executor;\n+    private final InMemoryStreamMetadataStore streamStore;\n+    private final ScheduledExecutorService executor;\n \n-    public InMemoryKVTMetadataStore(Executor executor) {\n+    public InMemoryKVTMetadataStore(StreamMetadataStore streamStore, ScheduledExecutorService executor) {\n         super(new InMemoryHostIndex());\n+        this.streamStore = (InMemoryStreamMetadataStore) streamStore;\n         this.executor = executor;\n-        this.counter = new AtomicInt96();\n     }\n \n     @Override\n-    KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n+    @Synchronized\n+    KeyValueTable newKeyValueTable(String scope, String name) {\n+        if (this.streamStore.getScopes().containsKey(scope)) {\n+            InMemoryScope kvtScope = this.streamStore.getScopes().get(scope);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzIyMA=="}, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkxOTU2MQ==", "bodyText": "creating an immutable map each time its accessed here is costly as it will make a copy.\ninstead you can use Collections.unmodifiableMap which actually creates a wrapper decoration on the map which prohibits any changes to the map", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462919561", "createdAt": "2020-07-30T11:03:14Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -36,48 +36,44 @@\n     @GuardedBy(\"$lock\")\n     private final Map<String, Integer> deletedKVTables = new HashMap<>();\n \n-    @Setter\n-    @GuardedBy(\"$lock\")\n-    private Map<String, InMemoryScope> scopes = new HashMap<>();\n-\n-    private final AtomicInt96 counter;\n-\n-    private final Executor executor;\n+    private final InMemoryStreamMetadataStore streamStore;\n+    private final ScheduledExecutorService executor;\n \n-    public InMemoryKVTMetadataStore(Executor executor) {\n+    public InMemoryKVTMetadataStore(StreamMetadataStore streamStore, ScheduledExecutorService executor) {\n         super(new InMemoryHostIndex());\n+        this.streamStore = (InMemoryStreamMetadataStore) streamStore;\n         this.executor = executor;\n-        this.counter = new AtomicInt96();\n     }\n \n     @Override\n-    KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n+    @Synchronized\n+    KeyValueTable newKeyValueTable(String scope, String name) {\n+        if (this.streamStore.getScopes().containsKey(scope)) {\n+            InMemoryScope kvtScope = this.streamStore.getScopes().get(scope);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzIyMA=="}, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMjQyOA==", "bodyText": "actually i dont see you returning an immutable map.\nimmutable map is one in which you cannot add/remove/replace any entries.\nsetting the field as final doesnt make it immutable, it just means that field cannot be assigned a different value. but the object that the field refers to can still be immutable, as is the case here.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462922428", "createdAt": "2020-07-30T11:09:38Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -36,48 +36,44 @@\n     @GuardedBy(\"$lock\")\n     private final Map<String, Integer> deletedKVTables = new HashMap<>();\n \n-    @Setter\n-    @GuardedBy(\"$lock\")\n-    private Map<String, InMemoryScope> scopes = new HashMap<>();\n-\n-    private final AtomicInt96 counter;\n-\n-    private final Executor executor;\n+    private final InMemoryStreamMetadataStore streamStore;\n+    private final ScheduledExecutorService executor;\n \n-    public InMemoryKVTMetadataStore(Executor executor) {\n+    public InMemoryKVTMetadataStore(StreamMetadataStore streamStore, ScheduledExecutorService executor) {\n         super(new InMemoryHostIndex());\n+        this.streamStore = (InMemoryStreamMetadataStore) streamStore;\n         this.executor = executor;\n-        this.counter = new AtomicInt96();\n     }\n \n     @Override\n-    KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n+    @Synchronized\n+    KeyValueTable newKeyValueTable(String scope, String name) {\n+        if (this.streamStore.getScopes().containsKey(scope)) {\n+            InMemoryScope kvtScope = this.streamStore.getScopes().get(scope);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzIyMA=="}, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2NDU4NA==", "bodyText": "Changed as discussed.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462964584", "createdAt": "2020-07-30T12:36:53Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -36,48 +36,44 @@\n     @GuardedBy(\"$lock\")\n     private final Map<String, Integer> deletedKVTables = new HashMap<>();\n \n-    @Setter\n-    @GuardedBy(\"$lock\")\n-    private Map<String, InMemoryScope> scopes = new HashMap<>();\n-\n-    private final AtomicInt96 counter;\n-\n-    private final Executor executor;\n+    private final InMemoryStreamMetadataStore streamStore;\n+    private final ScheduledExecutorService executor;\n \n-    public InMemoryKVTMetadataStore(Executor executor) {\n+    public InMemoryKVTMetadataStore(StreamMetadataStore streamStore, ScheduledExecutorService executor) {\n         super(new InMemoryHostIndex());\n+        this.streamStore = (InMemoryStreamMetadataStore) streamStore;\n         this.executor = executor;\n-        this.counter = new AtomicInt96();\n     }\n \n     @Override\n-    KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n+    @Synchronized\n+    KeyValueTable newKeyValueTable(String scope, String name) {\n+        if (this.streamStore.getScopes().containsKey(scope)) {\n+            InMemoryScope kvtScope = this.streamStore.getScopes().get(scope);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzIyMA=="}, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDU2NDE3OnYy", "diffSide": "RIGHT", "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDo1Mzo0NVrOG4ohYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjozNzowMVrOG5hHrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzM0Nw==", "bodyText": "same here.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462037347", "createdAt": "2020-07-29T04:53:45Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -36,48 +36,44 @@\n     @GuardedBy(\"$lock\")\n     private final Map<String, Integer> deletedKVTables = new HashMap<>();\n \n-    @Setter\n-    @GuardedBy(\"$lock\")\n-    private Map<String, InMemoryScope> scopes = new HashMap<>();\n-\n-    private final AtomicInt96 counter;\n-\n-    private final Executor executor;\n+    private final InMemoryStreamMetadataStore streamStore;\n+    private final ScheduledExecutorService executor;\n \n-    public InMemoryKVTMetadataStore(Executor executor) {\n+    public InMemoryKVTMetadataStore(StreamMetadataStore streamStore, ScheduledExecutorService executor) {\n         super(new InMemoryHostIndex());\n+        this.streamStore = (InMemoryStreamMetadataStore) streamStore;\n         this.executor = executor;\n-        this.counter = new AtomicInt96();\n     }\n \n     @Override\n-    KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n+    @Synchronized\n+    KeyValueTable newKeyValueTable(String scope, String name) {\n+        if (this.streamStore.getScopes().containsKey(scope)) {\n+            InMemoryScope kvtScope = this.streamStore.getScopes().get(scope);\n+            if (kvtScope.checkTableExists(name)) {\n+                return kvtScope.getKeyValueTable(name);\n             }\n-            InMemoryScope kvtScope = scopes.get(scope);\n-            Optional<InMemoryKVTable> kvTable = kvtScope.getKVTableFromScope(name);\n-            kvt = kvTable.orElse(new InMemoryKVTable(scope, name));\n         }\n-        return kvt;\n+       return new InMemoryKVTable(scope, name);\n     }\n \n     @Override\n     public Scope newScope(String scopeName) {\n         return getScope(scopeName);\n     }\n \n+    @Override\n+    @Synchronized\n+    public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n+        if (this.streamStore.getScopes().containsKey(scope)) {\n+            InMemoryScope kvtScope = this.streamStore.getScopes().get(scope);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg5NjkyNg==", "bodyText": "fixed", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462896926", "createdAt": "2020-07-30T10:16:38Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -36,48 +36,44 @@\n     @GuardedBy(\"$lock\")\n     private final Map<String, Integer> deletedKVTables = new HashMap<>();\n \n-    @Setter\n-    @GuardedBy(\"$lock\")\n-    private Map<String, InMemoryScope> scopes = new HashMap<>();\n-\n-    private final AtomicInt96 counter;\n-\n-    private final Executor executor;\n+    private final InMemoryStreamMetadataStore streamStore;\n+    private final ScheduledExecutorService executor;\n \n-    public InMemoryKVTMetadataStore(Executor executor) {\n+    public InMemoryKVTMetadataStore(StreamMetadataStore streamStore, ScheduledExecutorService executor) {\n         super(new InMemoryHostIndex());\n+        this.streamStore = (InMemoryStreamMetadataStore) streamStore;\n         this.executor = executor;\n-        this.counter = new AtomicInt96();\n     }\n \n     @Override\n-    KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n+    @Synchronized\n+    KeyValueTable newKeyValueTable(String scope, String name) {\n+        if (this.streamStore.getScopes().containsKey(scope)) {\n+            InMemoryScope kvtScope = this.streamStore.getScopes().get(scope);\n+            if (kvtScope.checkTableExists(name)) {\n+                return kvtScope.getKeyValueTable(name);\n             }\n-            InMemoryScope kvtScope = scopes.get(scope);\n-            Optional<InMemoryKVTable> kvTable = kvtScope.getKVTableFromScope(name);\n-            kvt = kvTable.orElse(new InMemoryKVTable(scope, name));\n         }\n-        return kvt;\n+       return new InMemoryKVTable(scope, name);\n     }\n \n     @Override\n     public Scope newScope(String scopeName) {\n         return getScope(scopeName);\n     }\n \n+    @Override\n+    @Synchronized\n+    public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n+        if (this.streamStore.getScopes().containsKey(scope)) {\n+            InMemoryScope kvtScope = this.streamStore.getScopes().get(scope);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzM0Nw=="}, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2NDY1NQ==", "bodyText": "changed as discussed.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462964655", "createdAt": "2020-07-30T12:37:01Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -36,48 +36,44 @@\n     @GuardedBy(\"$lock\")\n     private final Map<String, Integer> deletedKVTables = new HashMap<>();\n \n-    @Setter\n-    @GuardedBy(\"$lock\")\n-    private Map<String, InMemoryScope> scopes = new HashMap<>();\n-\n-    private final AtomicInt96 counter;\n-\n-    private final Executor executor;\n+    private final InMemoryStreamMetadataStore streamStore;\n+    private final ScheduledExecutorService executor;\n \n-    public InMemoryKVTMetadataStore(Executor executor) {\n+    public InMemoryKVTMetadataStore(StreamMetadataStore streamStore, ScheduledExecutorService executor) {\n         super(new InMemoryHostIndex());\n+        this.streamStore = (InMemoryStreamMetadataStore) streamStore;\n         this.executor = executor;\n-        this.counter = new AtomicInt96();\n     }\n \n     @Override\n-    KeyValueTable newKeyValueTable(String scope, String kvTableName) {\n-        throw new UnsupportedOperationException();\n-    }\n-\n-    @Override\n-    public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n-        KeyValueTable kvt;\n-        if (context != null) {\n-            kvt = context.getKvTable();\n-            assert kvt.getScopeName().equals(scope);\n-            assert kvt.getName().equals(name);\n-        } else {\n-            if (!scopes.containsKey(scope)) {\n-                return new InMemoryKVTable(scope, name);\n+    @Synchronized\n+    KeyValueTable newKeyValueTable(String scope, String name) {\n+        if (this.streamStore.getScopes().containsKey(scope)) {\n+            InMemoryScope kvtScope = this.streamStore.getScopes().get(scope);\n+            if (kvtScope.checkTableExists(name)) {\n+                return kvtScope.getKeyValueTable(name);\n             }\n-            InMemoryScope kvtScope = scopes.get(scope);\n-            Optional<InMemoryKVTable> kvTable = kvtScope.getKVTableFromScope(name);\n-            kvt = kvTable.orElse(new InMemoryKVTable(scope, name));\n         }\n-        return kvt;\n+       return new InMemoryKVTable(scope, name);\n     }\n \n     @Override\n     public Scope newScope(String scopeName) {\n         return getScope(scopeName);\n     }\n \n+    @Override\n+    @Synchronized\n+    public KeyValueTable getKVTable(String scope, final String name, KVTOperationContext context) {\n+        if (this.streamStore.getScopes().containsKey(scope)) {\n+            InMemoryScope kvtScope = this.streamStore.getScopes().get(scope);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzM0Nw=="}, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDU2NjkyOnYy", "diffSide": "RIGHT", "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDo1NToxNFrOG4ojAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQxNTowOTo1M1rOG49HPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzc2Mg==", "bodyText": "you dont need to do CompletableFuture.completedFuture().thenApply.\nInstead you can compute the value and then do CompletableFuture.completedFuture(value)", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462037762", "createdAt": "2020-07-29T04:55:14Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -98,20 +94,26 @@ public Scope newScope(String scopeName) {\n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkScopeExists(String scope) {\n-        return CompletableFuture.completedFuture(scopes.containsKey(scope));\n+        return Futures.completeOn(CompletableFuture.completedFuture(this.streamStore.getScopes().containsKey(scope)), executor);\n     }\n \n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkTableExists(String scopeName, String kvt) {\n-        return CompletableFuture.completedFuture((InMemoryScope) getScope(scopeName)).thenApply(scope -> scope.checkTableExists(kvt));\n+        return Futures.completeOn(checkScopeExists(scopeName).thenCompose(exists -> {\n+            if (exists) {\n+                return CompletableFuture.completedFuture((InMemoryScope) getScope(scopeName))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjM3NDcxNw==", "bodyText": "sure. fixed.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462374717", "createdAt": "2020-07-29T15:09:53Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -98,20 +94,26 @@ public Scope newScope(String scopeName) {\n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkScopeExists(String scope) {\n-        return CompletableFuture.completedFuture(scopes.containsKey(scope));\n+        return Futures.completeOn(CompletableFuture.completedFuture(this.streamStore.getScopes().containsKey(scope)), executor);\n     }\n \n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkTableExists(String scopeName, String kvt) {\n-        return CompletableFuture.completedFuture((InMemoryScope) getScope(scopeName)).thenApply(scope -> scope.checkTableExists(kvt));\n+        return Futures.completeOn(checkScopeExists(scopeName).thenCompose(exists -> {\n+            if (exists) {\n+                return CompletableFuture.completedFuture((InMemoryScope) getScope(scopeName))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzc2Mg=="}, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 111}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NDU2NzgyOnYy", "diffSide": "RIGHT", "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNDo1NTo0NlrOG4ojkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMDoxODoxNlrOG5dCTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzkwNA==", "bodyText": "isnt scope.checkTableExists returning a future?\nif so, shouldnt this be thenCompose?", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462037904", "createdAt": "2020-07-29T04:55:46Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -98,20 +94,26 @@ public Scope newScope(String scopeName) {\n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkScopeExists(String scope) {\n-        return CompletableFuture.completedFuture(scopes.containsKey(scope));\n+        return Futures.completeOn(CompletableFuture.completedFuture(this.streamStore.getScopes().containsKey(scope)), executor);\n     }\n \n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkTableExists(String scopeName, String kvt) {\n-        return CompletableFuture.completedFuture((InMemoryScope) getScope(scopeName)).thenApply(scope -> scope.checkTableExists(kvt));\n+        return Futures.completeOn(checkScopeExists(scopeName).thenCompose(exists -> {\n+            if (exists) {\n+                return CompletableFuture.completedFuture((InMemoryScope) getScope(scopeName))\n+                        .thenApply(scope -> scope.checkTableExists(kvt));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjg5Nzc0MQ==", "bodyText": "fixed", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462897741", "createdAt": "2020-07-30T10:18:16Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -98,20 +94,26 @@ public Scope newScope(String scopeName) {\n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkScopeExists(String scope) {\n-        return CompletableFuture.completedFuture(scopes.containsKey(scope));\n+        return Futures.completeOn(CompletableFuture.completedFuture(this.streamStore.getScopes().containsKey(scope)), executor);\n     }\n \n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkTableExists(String scopeName, String kvt) {\n-        return CompletableFuture.completedFuture((InMemoryScope) getScope(scopeName)).thenApply(scope -> scope.checkTableExists(kvt));\n+        return Futures.completeOn(checkScopeExists(scopeName).thenCompose(exists -> {\n+            if (exists) {\n+                return CompletableFuture.completedFuture((InMemoryScope) getScope(scopeName))\n+                        .thenApply(scope -> scope.checkTableExists(kvt));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzNzkwNA=="}, "originalCommit": {"oid": "4a123a491187d8bc8ecd80a7e656653c74f4d444"}, "originalPosition": 112}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDIxNzIxOnYy", "diffSide": "RIGHT", "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMTowNDo0N1rOG5eaTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjo1MzozMVrOG64VNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMDI3MA==", "bodyText": "this can be reverted.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462920270", "createdAt": "2020-07-30T11:04:47Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -41,7 +41,7 @@\n     private HashMap<String, Integer> streamsPositionMap;\n \n     @GuardedBy(\"$lock\")\n-    private TreeMap<String, InMemoryKVTable> kvTablesMap;\n+    private final TreeMap<String, InMemoryKVTable> kvTablesMap =  new TreeMap<String, InMemoryKVTable>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2NTA2Ng==", "bodyText": "I'd prefer to have it initialized here to avoid NPEs.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462965066", "createdAt": "2020-07-30T12:37:44Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -41,7 +41,7 @@\n     private HashMap<String, Integer> streamsPositionMap;\n \n     @GuardedBy(\"$lock\")\n-    private TreeMap<String, InMemoryKVTable> kvTablesMap;\n+    private final TreeMap<String, InMemoryKVTable> kvTablesMap =  new TreeMap<String, InMemoryKVTable>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMDI3MA=="}, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE4OTc4Nw==", "bodyText": "no i mean init in constructor", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r464189787", "createdAt": "2020-08-03T04:36:00Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -41,7 +41,7 @@\n     private HashMap<String, Integer> streamsPositionMap;\n \n     @GuardedBy(\"$lock\")\n-    private TreeMap<String, InMemoryKVTable> kvTablesMap;\n+    private final TreeMap<String, InMemoryKVTable> kvTablesMap =  new TreeMap<String, InMemoryKVTable>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMDI3MA=="}, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE5OTM3Mw==", "bodyText": "Construction initialization is good for usecases where the values used in building the object need to be passed to the constructor. Initializing at the time of declaration also takes away the need to synchronize the constructor and I don't see any downsides with initializing it this way.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r464199373", "createdAt": "2020-08-03T05:21:14Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -41,7 +41,7 @@\n     private HashMap<String, Integer> streamsPositionMap;\n \n     @GuardedBy(\"$lock\")\n-    private TreeMap<String, InMemoryKVTable> kvTablesMap;\n+    private final TreeMap<String, InMemoryKVTable> kvTablesMap =  new TreeMap<String, InMemoryKVTable>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMDI3MA=="}, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDIyOTc4NA==", "bodyText": "no downside, just consistency as other objects are initialized in the constructor.\nAlso constructor is implicitly synchronized and you dont need to synchronize a constructor.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r464229784", "createdAt": "2020-08-03T07:04:44Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -41,7 +41,7 @@\n     private HashMap<String, Integer> streamsPositionMap;\n \n     @GuardedBy(\"$lock\")\n-    private TreeMap<String, InMemoryKVTable> kvTablesMap;\n+    private final TreeMap<String, InMemoryKVTable> kvTablesMap =  new TreeMap<String, InMemoryKVTable>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMDI3MA=="}, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM5MzUyNA==", "bodyText": "Ok.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r464393524", "createdAt": "2020-08-03T12:53:31Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -41,7 +41,7 @@\n     private HashMap<String, Integer> streamsPositionMap;\n \n     @GuardedBy(\"$lock\")\n-    private TreeMap<String, InMemoryKVTable> kvTablesMap;\n+    private final TreeMap<String, InMemoryKVTable> kvTablesMap =  new TreeMap<String, InMemoryKVTable>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMDI3MA=="}, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDIxODk5OnYy", "diffSide": "LEFT", "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMTowNToxNVrOG5ebVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwNToyNDowM1rOG6shGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMDUzMg==", "bodyText": "it is more consistent to initialize this in the contructor as all other fields are also initialized in the constructor.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462920532", "createdAt": "2020-07-30T11:05:15Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -57,7 +57,6 @@ public String getName() {\n     public CompletableFuture<Void> createScope() {\n         this.sortedStreamsInScope = new TreeMap<>(Integer::compare);\n         this.streamsPositionMap = new HashMap<>();\n-        this.kvTablesMap =  new TreeMap<String, InMemoryKVTable>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMTU5OQ==", "bodyText": "also, all other fields are non final. as we set them to null in deleteScope. though logically that doesnt really give us anything. but since that is the pattern being used for all other objects, i would suggest we keep the same pattern for this field too.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462921599", "createdAt": "2020-07-30T11:07:41Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -57,7 +57,6 @@ public String getName() {\n     public CompletableFuture<Void> createScope() {\n         this.sortedStreamsInScope = new TreeMap<>(Integer::compare);\n         this.streamsPositionMap = new HashMap<>();\n-        this.kvTablesMap =  new TreeMap<String, InMemoryKVTable>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMDUzMg=="}, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2NDI2OA==", "bodyText": "I don't like the idea of having data members point to null values and initializing them upfront or in the constructor helps avoid NPEs", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462964268", "createdAt": "2020-07-30T12:36:17Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -57,7 +57,6 @@ public String getName() {\n     public CompletableFuture<Void> createScope() {\n         this.sortedStreamsInScope = new TreeMap<>(Integer::compare);\n         this.streamsPositionMap = new HashMap<>();\n-        this.kvTablesMap =  new TreeMap<String, InMemoryKVTable>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMDUzMg=="}, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE5MjE0MQ==", "bodyText": "we should never be accessing a \"deleted\" scope object.\nThe purpose of setting all fields in the scope object to null should not cause NPE. And if it does, it would point to a bug that should be fixed.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r464192141", "createdAt": "2020-08-03T04:47:30Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -57,7 +57,6 @@ public String getName() {\n     public CompletableFuture<Void> createScope() {\n         this.sortedStreamsInScope = new TreeMap<>(Integer::compare);\n         this.streamsPositionMap = new HashMap<>();\n-        this.kvTablesMap =  new TreeMap<String, InMemoryKVTable>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMDUzMg=="}, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDE5OTk2Mg==", "bodyText": "Whenever possible, I'd want to avoid null references to class data members in the code, as a good coding practice...", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r464199962", "createdAt": "2020-08-03T05:24:03Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -57,7 +57,6 @@ public String getName() {\n     public CompletableFuture<Void> createScope() {\n         this.sortedStreamsInScope = new TreeMap<>(Integer::compare);\n         this.streamsPositionMap = new HashMap<>();\n-        this.kvTablesMap =  new TreeMap<String, InMemoryKVTable>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkyMDUzMg=="}, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDI4NTQ1OnYy", "diffSide": "RIGHT", "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMToyNzozMFrOG5fDiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjozODoyM1rOG5hKdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkzMDgyNw==", "bodyText": "kvTablesMap is guarded by $lock so add synchronized annotation for this method", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462930827", "createdAt": "2020-07-30T11:27:30Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -175,4 +165,7 @@ public void refresh() {\n         return CompletableFuture.completedFuture(null);\n     }\n \n+    public KeyValueTable getKeyValueTable(String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2NTM2NA==", "bodyText": "done", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462965364", "createdAt": "2020-07-30T12:38:23Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/InMemoryScope.java", "diffHunk": "@@ -175,4 +165,7 @@ public void refresh() {\n         return CompletableFuture.completedFuture(null);\n     }\n \n+    public KeyValueTable getKeyValueTable(String name) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkzMDgyNw=="}, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MDMwNjIzOnYy", "diffSide": "RIGHT", "path": "controller/src/main/java/io/pravega/controller/store/stream/InMemoryStreamMetadataStore.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMTozNDoyNVrOG5fQJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxMjozODozNVrOG5hK0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkzNDA1Mg==", "bodyText": "please add synchronized here as well as this is reading the scopes map which is concurrency protected.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462934052", "createdAt": "2020-07-30T11:34:25Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/InMemoryStreamMetadataStore.java", "diffHunk": "@@ -74,7 +75,7 @@ public InMemoryStreamMetadataStore(Executor executor) {\n     }\n \n     public Map<String, InMemoryScope> getScopes() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk2NTQ1Ng==", "bodyText": "removed this method as discussed.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r462965456", "createdAt": "2020-07-30T12:38:35Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/stream/InMemoryStreamMetadataStore.java", "diffHunk": "@@ -74,7 +75,7 @@ public InMemoryStreamMetadataStore(Executor executor) {\n     }\n \n     public Map<String, InMemoryScope> getScopes() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjkzNDA1Mg=="}, "originalCommit": {"oid": "ab57828de594eda65479e05fae1f2e82d04f04f4"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMDAxNDgzOnYy", "diffSide": "RIGHT", "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMToyMjozM1rOG61yxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQwNTozMzozOFrOG7RtgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM1MTk0MA==", "bodyText": "is there a check that ensures that \"create\" is called on the scope object before it is used.\nthis is returning the scope object, but where does it get added to the store?", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r464351940", "createdAt": "2020-08-03T11:22:33Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -98,20 +97,25 @@ public Scope newScope(String scopeName) {\n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkScopeExists(String scope) {\n-        return CompletableFuture.completedFuture(scopes.containsKey(scope));\n+        return Futures.completeOn(CompletableFuture.completedFuture(this.streamStore.scopeExists(scope)), executor);\n     }\n \n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkTableExists(String scopeName, String kvt) {\n-        return CompletableFuture.completedFuture((InMemoryScope) getScope(scopeName)).thenApply(scope -> scope.checkTableExists(kvt));\n+        return Futures.completeOn(checkScopeExists(scopeName).thenCompose(exists -> {\n+            if (exists) {\n+                return CompletableFuture.completedFuture(((InMemoryScope) getScope(scopeName)).checkTableExists(kvt));\n+            }\n+            return CompletableFuture.completedFuture(Boolean.FALSE);\n+        }), executor);\n     }\n \n     @Override\n     @Synchronized\n     public Scope getScope(final String scopeName) {\n-        if (scopes.containsKey(scopeName)) {\n-            return scopes.get(scopeName);\n+        if (this.streamStore.scopeExists(scopeName)) {\n+            return this.streamStore.getScope(scopeName);\n         } else {\n             return new InMemoryScope(scopeName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64d1c0d1ee5732346046613d742ba9c43acf942e"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM5NjY2Ng==", "bodyText": "This is implemented in same lines as similar method in InMemoryMetadataStore:\nhttps://github.com/pravega/pravega/blob/master/controller/src/main/java/io/pravega/controller/store/stream/InMemoryStreamMetadataStore.java#L117", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r464396666", "createdAt": "2020-08-03T12:59:24Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -98,20 +97,25 @@ public Scope newScope(String scopeName) {\n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkScopeExists(String scope) {\n-        return CompletableFuture.completedFuture(scopes.containsKey(scope));\n+        return Futures.completeOn(CompletableFuture.completedFuture(this.streamStore.scopeExists(scope)), executor);\n     }\n \n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkTableExists(String scopeName, String kvt) {\n-        return CompletableFuture.completedFuture((InMemoryScope) getScope(scopeName)).thenApply(scope -> scope.checkTableExists(kvt));\n+        return Futures.completeOn(checkScopeExists(scopeName).thenCompose(exists -> {\n+            if (exists) {\n+                return CompletableFuture.completedFuture(((InMemoryScope) getScope(scopeName)).checkTableExists(kvt));\n+            }\n+            return CompletableFuture.completedFuture(Boolean.FALSE);\n+        }), executor);\n     }\n \n     @Override\n     @Synchronized\n     public Scope getScope(final String scopeName) {\n-        if (scopes.containsKey(scopeName)) {\n-            return scopes.get(scopeName);\n+        if (this.streamStore.scopeExists(scopeName)) {\n+            return this.streamStore.getScope(scopeName);\n         } else {\n             return new InMemoryScope(scopeName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM1MTk0MA=="}, "originalCommit": {"oid": "64d1c0d1ee5732346046613d742ba9c43acf942e"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgwMjc2OA==", "bodyText": "yes, but it looks incorrect in both places. we need to see if getScope should return scope not found if the scope does not exist in the store.", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r464802768", "createdAt": "2020-08-04T05:10:13Z", "author": {"login": "shiveshr"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -98,20 +97,25 @@ public Scope newScope(String scopeName) {\n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkScopeExists(String scope) {\n-        return CompletableFuture.completedFuture(scopes.containsKey(scope));\n+        return Futures.completeOn(CompletableFuture.completedFuture(this.streamStore.scopeExists(scope)), executor);\n     }\n \n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkTableExists(String scopeName, String kvt) {\n-        return CompletableFuture.completedFuture((InMemoryScope) getScope(scopeName)).thenApply(scope -> scope.checkTableExists(kvt));\n+        return Futures.completeOn(checkScopeExists(scopeName).thenCompose(exists -> {\n+            if (exists) {\n+                return CompletableFuture.completedFuture(((InMemoryScope) getScope(scopeName)).checkTableExists(kvt));\n+            }\n+            return CompletableFuture.completedFuture(Boolean.FALSE);\n+        }), executor);\n     }\n \n     @Override\n     @Synchronized\n     public Scope getScope(final String scopeName) {\n-        if (scopes.containsKey(scopeName)) {\n-            return scopes.get(scopeName);\n+        if (this.streamStore.scopeExists(scopeName)) {\n+            return this.streamStore.getScope(scopeName);\n         } else {\n             return new InMemoryScope(scopeName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM1MTk0MA=="}, "originalCommit": {"oid": "64d1c0d1ee5732346046613d742ba9c43acf942e"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgwOTM0NA==", "bodyText": "I agree, but it may need significant code refactoring as there are multiple dependent methods that would break.\nFiled: #5021", "url": "https://github.com/pravega/pravega/pull/4958#discussion_r464809344", "createdAt": "2020-08-04T05:33:38Z", "author": {"login": "pbelgundi"}, "path": "controller/src/main/java/io/pravega/controller/store/kvtable/InMemoryKVTMetadataStore.java", "diffHunk": "@@ -98,20 +97,25 @@ public Scope newScope(String scopeName) {\n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkScopeExists(String scope) {\n-        return CompletableFuture.completedFuture(scopes.containsKey(scope));\n+        return Futures.completeOn(CompletableFuture.completedFuture(this.streamStore.scopeExists(scope)), executor);\n     }\n \n     @Override\n     @Synchronized\n     public CompletableFuture<Boolean> checkTableExists(String scopeName, String kvt) {\n-        return CompletableFuture.completedFuture((InMemoryScope) getScope(scopeName)).thenApply(scope -> scope.checkTableExists(kvt));\n+        return Futures.completeOn(checkScopeExists(scopeName).thenCompose(exists -> {\n+            if (exists) {\n+                return CompletableFuture.completedFuture(((InMemoryScope) getScope(scopeName)).checkTableExists(kvt));\n+            }\n+            return CompletableFuture.completedFuture(Boolean.FALSE);\n+        }), executor);\n     }\n \n     @Override\n     @Synchronized\n     public Scope getScope(final String scopeName) {\n-        if (scopes.containsKey(scopeName)) {\n-            return scopes.get(scopeName);\n+        if (this.streamStore.scopeExists(scopeName)) {\n+            return this.streamStore.getScope(scopeName);\n         } else {\n             return new InMemoryScope(scopeName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM1MTk0MA=="}, "originalCommit": {"oid": "64d1c0d1ee5732346046613d742ba9c43acf942e"}, "originalPosition": 127}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4802, "cost": 1, "resetAt": "2021-11-13T12:26:42Z"}}}