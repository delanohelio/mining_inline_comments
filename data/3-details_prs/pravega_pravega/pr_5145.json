{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5NTg4NTQ4", "number": 5145, "title": "Issue 5144: Force token refresh when segment store indicates token expiry", "bodyText": "Change log description\nForce token refresh when the Segment Store indicates token expiry.\nPurpose of the change\nFixes #5144\nWhat the code does\nImplements a signaling mechanism such that the client can signal the DelegationTokenProvider of the token expiry so that it refreshes the token upon the next call to retrieveToken().\nHow to verify it\nAll tests must pass.", "createdAt": "2020-09-04T11:15:39Z", "url": "https://github.com/pravega/pravega/pull/5145", "merged": true, "mergeCommit": {"oid": "e1f2534ec03b69f272b3a19637b863724a9560b8"}, "closed": true, "closedAt": "2020-09-08T06:28:37Z", "author": {"login": "ravisharda"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFg4YSAH2gAyNDc5NTg4NTQ4OjNhYzJjN2Q3NzBmNmM4Njk4ODRmMDZjZTRhYjc3OWI1Yjc1NjBiODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHBAV3gFqTQ4NDU3NzM4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3ac2c7d770f6c869884f06ce4ab779b5b7560b89", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/3ac2c7d770f6c869884f06ce4ab779b5b7560b89", "committedDate": "2020-09-04T08:25:24Z", "message": "Add a test\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2df59c754ab6b2e94fff06c5899c0699e0d751b", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/f2df59c754ab6b2e94fff06c5899c0699e0d751b", "committedDate": "2020-09-04T11:10:26Z", "message": "Token expiry signaling changes and tests\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a31a87be7bec4c15ccc25521bf592627510a5d9", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/4a31a87be7bec4c15ccc25521bf592627510a5d9", "committedDate": "2020-09-05T03:04:08Z", "message": "Fix tests\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1127aee9812dffa582b596bf0027462d28d6a780", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/1127aee9812dffa582b596bf0027462d28d6a780", "committedDate": "2020-09-05T03:04:32Z", "message": "Remove commented lines.\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "571c909faa27cac6c3d0ff2e7a2f01a4f8e5f095", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/571c909faa27cac6c3d0ff2e7a2f01a4f8e5f095", "committedDate": "2020-09-06T02:37:22Z", "message": "Add tests\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMjIxNDEy", "url": "https://github.com/pravega/pravega/pull/5145#pullrequestreview-483221412", "createdAt": "2020-09-07T03:28:58Z", "commit": {"oid": "571c909faa27cac6c3d0ff2e7a2f01a4f8e5f095"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMzoyODo1OFrOHNvHHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QwMzo1ODoyM1rOHNvcxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE2NTQwNw==", "bodyText": "TokenExpirySignal has a higher priority and hence should be checked before returning a token right ?", "url": "https://github.com/pravega/pravega/pull/5145#discussion_r484165407", "createdAt": "2020-09-07T03:28:58Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/security/auth/JwtTokenProviderImpl.java", "diffHunk": "@@ -132,17 +134,22 @@ private JwtTokenProviderImpl(Controller controllerClient, String scopeName, Stri\n     @Override\n     public CompletableFuture<String> retrieveToken() {\n         DelegationToken currentToken = this.delegationToken.get();\n-\n+        final CompletableFuture<String> result;\n         if (currentToken == null) {\n-            return this.refreshToken();\n+            result = this.refreshToken();\n         } else if (currentToken.getExpiryTime() == null) {\n-            return CompletableFuture.completedFuture(currentToken.getValue());\n+            result = CompletableFuture.completedFuture(currentToken.getValue());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "571c909faa27cac6c3d0ff2e7a2f01a4f8e5f095"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDE3MDk1MQ==", "bodyText": "would this cause a change to the SegmentHelper logic at \n  \n    \n      pravega/controller/src/main/java/io/pravega/controller/server/SegmentHelper.java\n    \n    \n        Lines 624 to 641\n      in\n      4f7be17\n    \n    \n    \n    \n\n        \n          \n           private <T extends Request & WireCommand> CompletableFuture<Reply> sendRequest(RawClient connection, long requestId, T request) { \n        \n\n        \n          \n               CompletableFuture<Reply> future = Futures.futureWithTimeout(() -> connection.sendRequest(requestId, request), timeout.get(), \"request\", executorService); \n        \n\n        \n          \n               return future \n        \n\n        \n          \n                       .exceptionally(e -> { \n        \n\n        \n          \n                           Throwable unwrap = Exceptions.unwrap(e); \n        \n\n        \n          \n                           if (unwrap instanceof ConnectionFailedException || unwrap instanceof ConnectionClosedException) { \n        \n\n        \n          \n                               log.warn(requestId, \"Connection dropped\"); \n        \n\n        \n          \n                               throw new WireCommandFailedException(request.getType(), WireCommandFailedException.Reason.ConnectionFailed); \n        \n\n        \n          \n                           } else if (unwrap instanceof AuthenticationException) { \n        \n\n        \n          \n                               log.warn(requestId, \"Authentication Exception\"); \n        \n\n        \n          \n                               throw new WireCommandFailedException(request.getType(), WireCommandFailedException.Reason.AuthFailed); \n        \n\n        \n          \n                           } else if (unwrap instanceof TimeoutException) { \n        \n\n        \n          \n                               log.warn(requestId, \"Request timedout.\"); \n        \n\n        \n          \n                               throw new WireCommandFailedException(request.getType(), WireCommandFailedException.Reason.ConnectionFailed); \n        \n\n        \n          \n                           } else { \n        \n\n        \n          \n                               log.error(requestId, \"Request failed\", e); \n        \n\n        \n          \n                               throw new CompletionException(e); \n        \n\n        \n          \n                           } \n        \n    \n  \n\n ?", "url": "https://github.com/pravega/pravega/pull/5145#discussion_r484170951", "createdAt": "2020-09-07T03:58:23Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/connection/impl/RawClient.java", "diffHunk": "@@ -78,7 +79,11 @@ public void processingFailure(Exception error) {\n         @Override\n         public void authTokenCheckFailed(WireCommands.AuthTokenCheckFailed authTokenCheckFailed) {\n             log.warn(\"Auth token check failed on segment {} with {}\", segmentId, authTokenCheckFailed);\n-            closeConnection(new AuthenticationException(authTokenCheckFailed.toString()));\n+            if (authTokenCheckFailed.isTokenExpired()) {\n+                closeConnection(new TokenExpiredException(authTokenCheckFailed.getServerStackTrace()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "571c909faa27cac6c3d0ff2e7a2f01a4f8e5f095"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f65b3d0d21d0a508fc9dabc11f182baf223964ea", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/f65b3d0d21d0a508fc9dabc11f182baf223964ea", "committedDate": "2020-09-07T07:55:41Z", "message": "Address review comments.\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNDEwNjM0", "url": "https://github.com/pravega/pravega/pull/5145#pullrequestreview-483410634", "createdAt": "2020-09-07T09:40:19Z", "commit": {"oid": "f65b3d0d21d0a508fc9dabc11f182baf223964ea"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2a9b13725e3d5da4469ed9736f1047e5165c84d", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/d2a9b13725e3d5da4469ed9736f1047e5165c84d", "committedDate": "2020-09-07T13:07:34Z", "message": "Merge branch 'master' into forced-token-renewal-on-expiry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74e14cfc46ae05626e0d002dad38977fb6954030", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/74e14cfc46ae05626e0d002dad38977fb6954030", "committedDate": "2020-09-07T15:18:45Z", "message": "Add tests\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77f2217501eac6c91e85e885170562c4f758beb3", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/77f2217501eac6c91e85e885170562c4f758beb3", "committedDate": "2020-09-07T15:19:10Z", "message": "Merge remote-tracking branch 'origin/forced-token-renewal-on-expiry' into forced-token-renewal-on-expiry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56828b9ede3b82fa09e5d978e6d82aafaf95d74c", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/56828b9ede3b82fa09e5d978e6d82aafaf95d74c", "committedDate": "2020-09-08T05:14:27Z", "message": "Turn repeated code into reusable\n\nSigned-off-by: Ravi Sharda <ravi.sharda@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fabaa45e29356cced9e61d0cb614236aff59aaa", "author": {"user": {"login": "ravisharda", "name": "Ravi Sharda"}}, "url": "https://github.com/pravega/pravega/commit/7fabaa45e29356cced9e61d0cb614236aff59aaa", "committedDate": "2020-09-08T05:15:24Z", "message": "Merge branch 'master' into forced-token-renewal-on-expiry"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzODI3ODIy", "url": "https://github.com/pravega/pravega/pull/5145#pullrequestreview-483827822", "createdAt": "2020-09-08T06:28:13Z", "commit": {"oid": "7fabaa45e29356cced9e61d0cb614236aff59aaa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTc3Mzg4", "url": "https://github.com/pravega/pravega/pull/5145#pullrequestreview-484577388", "createdAt": "2020-09-09T00:23:00Z", "commit": {"oid": "7fabaa45e29356cced9e61d0cb614236aff59aaa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDoyMzowMFrOHOyRRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQwMDoyMzowMFrOHOyRRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI2NTczMg==", "bodyText": "This should be done inside of refreshToken in case on of the other branches occurs right before this is set.", "url": "https://github.com/pravega/pravega/pull/5145#discussion_r485265732", "createdAt": "2020-09-09T00:23:00Z", "author": {"login": "tkaitchuck"}, "path": "client/src/main/java/io/pravega/client/security/auth/JwtTokenProviderImpl.java", "diffHunk": "@@ -132,17 +134,22 @@ private JwtTokenProviderImpl(Controller controllerClient, String scopeName, Stri\n     @Override\n     public CompletableFuture<String> retrieveToken() {\n         DelegationToken currentToken = this.delegationToken.get();\n-\n+        final CompletableFuture<String> result;\n         if (currentToken == null) {\n-            return this.refreshToken();\n+            result = this.refreshToken();\n         } else if (currentToken.getExpiryTime() == null) {\n-            return CompletableFuture.completedFuture(currentToken.getValue());\n+            result = CompletableFuture.completedFuture(currentToken.getValue());\n+        } else if (this.tokenExpirySignal.get()) {\n+            log.debug(\"Token was signaled as expired for scope/stream {}/{}\", this.scopeName, this.streamName);\n+            result = refreshToken();\n+            this.tokenExpirySignal.compareAndSet(true, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fabaa45e29356cced9e61d0cb614236aff59aaa"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3845, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}