{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2OTA0NzY3", "number": 4785, "title": "Issue 4784: Release throttle in the event an unhandled exception comes from netty.", "bodyText": "Change log description\n\nRelease throttle in the event an unhandled exception comes from netty.\n\nPurpose of the change\nFixes #4784\nWhat the code does\nAdds try/catch blocks around calls to write to ensure that unhandled exceptions are dealt with, and adds a release of the throttle in close as a secondary measure to ensure that the throttle always releases any blocked threads.\nHow to verify it\n@claudiofahey will verify.", "createdAt": "2020-05-12T18:46:49Z", "url": "https://github.com/pravega/pravega/pull/4785", "merged": true, "mergeCommit": {"oid": "3705e1e1e0c28ebc0e1c148848e1ff5c485201a8"}, "closed": true, "closedAt": "2020-05-23T02:02:55Z", "author": {"login": "tkaitchuck"}, "timelineItems": {"totalCount": 41, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgoTAIgH2gAyNDE2OTA0NzY3OmRmM2M4YjFlZjAxNTk3MjAwYjY2NGVjYWY5MTQ3YTc5Y2YzZWEwYzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcj5Jo-gH2gAyNDE2OTA0NzY3OjcwNTE1YTM2ZDcxY2M4NDg2MTdjNzMyYWJiMWIzMmYyNGM3ZjNmN2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "df3c8b1ef01597200b664ecaf9147a79cf3ea0c7", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/df3c8b1ef01597200b664ecaf9147a79cf3ea0c7", "committedDate": "2020-05-12T18:08:37Z", "message": "Release throttle upon unhandled exception.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb3b0e8ef8f9c648ed9ca80844133a7213a8bbda", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/fb3b0e8ef8f9c648ed9ca80844133a7213a8bbda", "committedDate": "2020-05-12T18:11:46Z", "message": "Also release on close.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9f3f8d8465beb1166614c384de71279a234f15d", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/a9f3f8d8465beb1166614c384de71279a234f15d", "committedDate": "2020-05-12T18:18:48Z", "message": "Add coverage for the normal write as well.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7f46faebb026d89b328fcca1ea9573d6ee59a79", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/d7f46faebb026d89b328fcca1ea9573d6ee59a79", "committedDate": "2020-05-12T18:34:34Z", "message": "Add test\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b860482e6d0d19fae03053dff6acb6f8475bac14", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/b860482e6d0d19fae03053dff6acb6f8475bac14", "committedDate": "2020-05-12T18:46:06Z", "message": "Use max int instead of max batch\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4fddeec0f4601169118d721909a8ee5cb6c21a9", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/c4fddeec0f4601169118d721909a8ee5cb6c21a9", "committedDate": "2020-05-12T18:46:58Z", "message": "Merge branch 'master' into OOM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5af14d17166782bbcf44b6e5b4e1d0c4def9e7a2", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/5af14d17166782bbcf44b6e5b4e1d0c4def9e7a2", "committedDate": "2020-05-12T22:42:41Z", "message": "Use local variable for data length.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNzk1NDk0", "url": "https://github.com/pravega/pravega/pull/4785#pullrequestreview-410795494", "createdAt": "2020-05-13T10:31:56Z", "commit": {"oid": "5af14d17166782bbcf44b6e5b4e1d0c4def9e7a2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMDozNzo1MVrOGUrqkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxMDo0MzoxM1rOGUr1Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM0MDExNQ==", "bodyText": "We can directly invoke io.pravega.client.netty.impl.ClientConnectionImpl#close here.", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r424340115", "createdAt": "2020-05-13T10:37:51Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java", "diffHunk": "@@ -89,9 +90,17 @@ public void operationComplete(ChannelFuture future) {\n         });\n         // Work around for https://github.com/netty/netty/issues/3246\n         eventLoop.execute(() -> {\n-            channel.write(cmd, promise);\n+            try {\n+                if (!closed.get()) {\n+                    channel.write(cmd, promise);\n+                }\n+            } catch (Exception e) {\n+                throttle.release(dataLength);\n+                channel.pipeline().fireExceptionCaught(e);\n+                channel.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5af14d17166782bbcf44b6e5b4e1d0c4def9e7a2"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDM0MjgwMw==", "bodyText": "same as above.", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r424342803", "createdAt": "2020-05-13T10:43:13Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java", "diffHunk": "@@ -109,7 +118,14 @@ public void operationComplete(ChannelFuture future) {\n         });\n         // Work around for https://github.com/netty/netty/issues/3246\n         eventLoop.execute(() -> {\n-            channel.write(cmd, promise);\n+            try {\n+                if (!closed.get()) {\n+                    channel.write(cmd, promise);\n+                }\n+            } catch (Exception e) {\n+                channel.pipeline().fireExceptionCaught(e);\n+                channel.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5af14d17166782bbcf44b6e5b4e1d0c4def9e7a2"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMDA2ODM1", "url": "https://github.com/pravega/pravega/pull/4785#pullrequestreview-411006835", "createdAt": "2020-05-13T14:52:15Z", "commit": {"oid": "5af14d17166782bbcf44b6e5b4e1d0c4def9e7a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNDo1MjoxNVrOGU1fWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNDo1MjoxNVrOGU1fWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDUwMTA4Mw==", "bodyText": "unblocked", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r424501083", "createdAt": "2020-05-13T14:52:15Z", "author": {"login": "andreipaduroiu"}, "path": "client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java", "diffHunk": "@@ -167,6 +183,7 @@ public void sendAsync(List<Append> appends, CompletedCallback callback) {\n     public void close() {\n         if (!closed.getAndSet(true)) {\n             nettyHandler.closeFlow(this);\n+            throttle.release(Integer.MAX_VALUE >> 1); //Makes sure that any blocked threads are unbloced.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5af14d17166782bbcf44b6e5b4e1d0c4def9e7a2"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e7ab01e8925820f7f6d5393156b78a2efcadefc", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/8e7ab01e8925820f7f6d5393156b78a2efcadefc", "committedDate": "2020-05-13T18:34:08Z", "message": "PR comments\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edc44cf6a0f3316e7af88373b6d97aa05e3420de", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/edc44cf6a0f3316e7af88373b6d97aa05e3420de", "committedDate": "2020-05-13T18:59:19Z", "message": "Call close directly\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a84fc484e46bd43d8e38f344c9321da4e190fe2", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/9a84fc484e46bd43d8e38f344c9321da4e190fe2", "committedDate": "2020-05-13T19:38:24Z", "message": "Remove call to close because exceptionCaught should handle it.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82b63db1ed491575e25af58f871e09a0a7420100", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/82b63db1ed491575e25af58f871e09a0a7420100", "committedDate": "2020-05-13T23:31:07Z", "message": "Whitespace\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "487a72237ce6c49ad1409c02bac00145782eb52f", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/487a72237ce6c49ad1409c02bac00145782eb52f", "committedDate": "2020-05-14T03:32:18Z", "message": "Switch throttling to be done by FlowHandler once per connection rather than per flow.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adda753962087b2c2cac86748df6d8e94ff25ba7", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/adda753962087b2c2cac86748df6d8e94ff25ba7", "committedDate": "2020-05-14T03:42:05Z", "message": "Checkstyle\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExOTc1NjI2", "url": "https://github.com/pravega/pravega/pull/4785#pullrequestreview-411975626", "createdAt": "2020-05-14T16:23:38Z", "commit": {"oid": "adda753962087b2c2cac86748df6d8e94ff25ba7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjoyMzozOFrOGVkQGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNjoyMzozOFrOGVkQGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTI2NzIyNA==", "bodyText": "If an Append/event is greater than MAX_BATCH_SIZE then the CommandEncoder is the one which will split it. But since the number of permits in the throttle is bounded by MAX_BATCH_SIZE the thread would indefinitely wait when the append size > MAX_BATCH_SIZE, causing the CommandEncoder in the subsequent pipeline stage to be never invoked.\nThis caused an issue with io.pravega.test.integration.ByteStreamTest#readLargeWrite", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r425267224", "createdAt": "2020-05-14T16:23:38Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java", "diffHunk": "@@ -57,6 +59,8 @@\n     private final ConcurrentHashMap<Integer, AppendBatchSizeTracker> flowIDBatchSizeTrackerMap = new ConcurrentHashMap<>();\n \n     private final AtomicBoolean disableFlow = new AtomicBoolean(false);\n+    \n+    private final Semaphore throttle = new Semaphore(AppendBatchSizeTracker.MAX_BATCH_SIZE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "adda753962087b2c2cac86748df6d8e94ff25ba7"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d3c61874f86f20931731b256957fff13e3a5b2d", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/0d3c61874f86f20931731b256957fff13e3a5b2d", "committedDate": "2020-05-14T18:50:59Z", "message": "Switch to having a fixed capacity outstanding against the broker.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a615844ed5752a90f01a1617af11977b858f20c", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/7a615844ed5752a90f01a1617af11977b858f20c", "committedDate": "2020-05-14T18:53:11Z", "message": "Checkstyle\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1574a577b9677173d71a728c2760281330030f80", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/1574a577b9677173d71a728c2760281330030f80", "committedDate": "2020-05-14T23:04:00Z", "message": "Added some logging\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b539d3753c10ebc9264d88a92d9a8b78da5f9b13", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/b539d3753c10ebc9264d88a92d9a8b78da5f9b13", "committedDate": "2020-05-15T00:06:14Z", "message": "Move update of append size throttle engagment to the writing thread.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6805fe9c1a695caa582cff34295c8459632885e0", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/6805fe9c1a695caa582cff34295c8459632885e0", "committedDate": "2020-05-15T18:43:22Z", "message": "Revert to earlier logic.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccfbd559428f32eac4b84d25ef3917f4a6680bfc", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/ccfbd559428f32eac4b84d25ef3917f4a6680bfc", "committedDate": "2020-05-15T19:03:31Z", "message": "Close connection if keepalive does not go through before next keepalive call.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d90c83d47868f6ff95d0805e6eb317a85d848c9d", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/d90c83d47868f6ff95d0805e6eb317a85d848c9d", "committedDate": "2020-05-18T21:51:27Z", "message": "Merge branch 'master' into OOM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/d44fb7fa46ec43ada173cc28074dde46e9d6bee1", "committedDate": "2020-05-18T21:57:17Z", "message": "Checkstyle fixes\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MDkzMTc2", "url": "https://github.com/pravega/pravega/pull/4785#pullrequestreview-414093176", "createdAt": "2020-05-19T04:28:57Z", "commit": {"oid": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNDoyODo1N1rOGXPbTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNDoyODo1N1rOGXPbTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAyMzE4Mg==", "bodyText": "nettyHandler.setRecentMessage(); should be set here.", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427023182", "createdAt": "2020-05-19T04:28:57Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java", "diffHunk": "@@ -103,13 +107,18 @@ private void write(WireCommand cmd) throws ConnectionFailedException {\n             public void operationComplete(ChannelFuture future) {\n                 if (!future.isSuccess()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MDk0NTgz", "url": "https://github.com/pravega/pravega/pull/4785#pullrequestreview-414094583", "createdAt": "2020-05-19T04:34:05Z", "commit": {"oid": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNDozNDowNVrOGXPf4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNTowMjo1MlrOGXP8WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAyNDM1Mg==", "bodyText": "callback.complete() below should invoke nettyHandler.setRecentMessage() right ?", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427024352", "createdAt": "2020-05-19T04:34:05Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/netty/impl/ClientConnectionImpl.java", "diffHunk": "@@ -144,7 +152,6 @@ public void sendAsync(List<Append> appends, CompletedCallback callback) {\n         Channel ch;\n         try {\n             checkClientConnectionClosed();\n-            nettyHandler.setRecentMessage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAzMTI5Nw==", "bodyText": "These are the two changes in client behavior, right?\n\nThis change implies keep-alive is sent every 20 seconds even if the connection is healthy.\nIf there is a connection stall for more than 20 seconds then the connection is closed.", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427031297", "createdAt": "2020-05-19T05:01:37Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java", "diffHunk": "@@ -313,14 +318,28 @@ public void close() {\n     }\n \n     private final class KeepAliveTask implements Runnable {\n+        \n+        private final ChannelFutureListener listener = new ChannelFutureListener() {\n+            @Override\n+            public void operationComplete(ChannelFuture future) throws Exception {\n+                recentMessage.set(true);\n+                if (!future.isSuccess()) {\n+                    future.channel().pipeline().fireExceptionCaught(future.cause());\n+                }\n+            }\n+        };\n+        \n         @Override\n         public void run() {\n-            try {\n-                if (!recentMessage.getAndSet(false)) {\n-                    getChannel().writeAndFlush(new WireCommands.KeepAlive()).addListener(ChannelFutureListener.FIRE_EXCEPTION_ON_FAILURE);\n+            if (recentMessage.getAndSet(false)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAzMTY0MA==", "bodyText": "Can we log indicating that sending a keep-alive failed here?", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427031640", "createdAt": "2020-05-19T05:02:52Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/netty/impl/FlowHandler.java", "diffHunk": "@@ -313,14 +318,28 @@ public void close() {\n     }\n \n     private final class KeepAliveTask implements Runnable {\n+        \n+        private final ChannelFutureListener listener = new ChannelFutureListener() {\n+            @Override\n+            public void operationComplete(ChannelFuture future) throws Exception {\n+                recentMessage.set(true);\n+                if (!future.isSuccess()) {\n+                    future.channel().pipeline().fireExceptionCaught(future.cause());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1"}, "originalPosition": 66}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MTc1NzE4", "url": "https://github.com/pravega/pravega/pull/4785#pullrequestreview-414175718", "createdAt": "2020-05-19T07:35:14Z", "commit": {"oid": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNzozNToxNFrOGXTfhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNzozNToxNFrOGXTfhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA4OTc5Nw==", "bodyText": "this test causes the InMemoryDurableDataLog to go OOM on my dev box...", "url": "https://github.com/pravega/pravega/pull/4785#discussion_r427089797", "createdAt": "2020-05-19T07:35:14Z", "author": {"login": "shrids"}, "path": "test/integration/src/test/java/io/pravega/test/integration/AppendTest.java", "diffHunk": "@@ -303,6 +308,35 @@ public void appendThroughStreamingClient() throws InterruptedException, Executio\n         ack.get(5, TimeUnit.SECONDS);\n     }\n     \n+    \n+    @Test(timeout = 100000)\n+    public void appendALotOfData() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1"}, "originalPosition": 43}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Njc4Njky", "url": "https://github.com/pravega/pravega/pull/4785#pullrequestreview-414678692", "createdAt": "2020-05-19T17:41:01Z", "commit": {"oid": "d44fb7fa46ec43ada173cc28074dde46e9d6bee1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b2f20adb572f4dcf418ac82d65e089c7241be7b", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/7b2f20adb572f4dcf418ac82d65e089c7241be7b", "committedDate": "2020-05-19T20:24:07Z", "message": "PR feedback\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "218634f465b425bfee8df78e1097e3fb89fe4e52", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/218634f465b425bfee8df78e1097e3fb89fe4e52", "committedDate": "2020-05-19T23:38:54Z", "message": "Truncate data more frequently to avoid memory preasure.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "801142b8d545446e2ec644e1d33d94454cc36989", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/801142b8d545446e2ec644e1d33d94454cc36989", "committedDate": "2020-05-19T23:40:22Z", "message": "Merge branch 'master' into OOM"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0OTgyODUz", "url": "https://github.com/pravega/pravega/pull/4785#pullrequestreview-414982853", "createdAt": "2020-05-20T04:24:46Z", "commit": {"oid": "801142b8d545446e2ec644e1d33d94454cc36989"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5c03c69023b32bbd2bdd2688de4cedf3ab5cdba", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/d5c03c69023b32bbd2bdd2688de4cedf3ab5cdba", "committedDate": "2020-05-20T15:13:12Z", "message": "Fix compile issue caused my master merge.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NTA1NzQz", "url": "https://github.com/pravega/pravega/pull/4785#pullrequestreview-415505743", "createdAt": "2020-05-20T16:22:35Z", "commit": {"oid": "d5c03c69023b32bbd2bdd2688de4cedf3ab5cdba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a5c788f1449f719555904b3b021fa5320f96076", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/4a5c788f1449f719555904b3b021fa5320f96076", "committedDate": "2020-05-21T16:26:01Z", "message": "Merge branch 'master' into OOM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "289169c410a67e0b409df19283809af046440361", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/289169c410a67e0b409df19283809af046440361", "committedDate": "2020-05-21T18:07:17Z", "message": "Limit message size based on heap size.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6aa87c7deb913122d3dfb4af0c9cb152f981dc4a", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/6aa87c7deb913122d3dfb4af0c9cb152f981dc4a", "committedDate": "2020-05-21T18:08:20Z", "message": "Merge branch 'OOM' of git@github.com:tkaitchuck/pravega-1.git into OOM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22abe1fe80e9cf6afa808e1008e0158c51414bf5", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/22abe1fe80e9cf6afa808e1008e0158c51414bf5", "committedDate": "2020-05-22T01:07:06Z", "message": "Reduce size of data\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bdfdf9f6b6aeb7335d8012186994994caf7c8b9", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/7bdfdf9f6b6aeb7335d8012186994994caf7c8b9", "committedDate": "2020-05-22T20:20:42Z", "message": "Ensure keepAlive tests covers failed listener.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28dc51214b70d19f4b86b01b1d18755d53fb9d1c", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/28dc51214b70d19f4b86b01b1d18755d53fb9d1c", "committedDate": "2020-05-22T21:17:14Z", "message": "Add test for failed write.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70515a36d71cc848617c732abb1b32f24c7f3f7b", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/70515a36d71cc848617c732abb1b32f24c7f3f7b", "committedDate": "2020-05-22T21:28:33Z", "message": "Add keep alive timeout test.\n\nSigned-off-by: Tom Kaitchuck <tom.kaitchuck@emc.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3471, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}