{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2NjY5MTc3", "number": 5185, "title": "Issue 5188: Improve RawClient exception handling.", "bodyText": "Change log description\n\nImprove exception handling on the RawClient to handle scenarios where a connection drop can happen just before a new Flow is created as part of the obtaining/creating a new connection.\n\nPurpose of the change\nFixes #5188\nWhat the code does\n\nThe current getClientConnection(..) API does verify and if the filters out connections that are closed. But in a scenario, where a connection drop happens right after this check and before a new Flow is created the RawClient does not wrap this exception with a ConnectionFailedException.\nThis fix ensures the RawClient handles this exception path correctly.\nEnsure ConditionalOutputStreamImpl throws a ObjectClosedException for writes once it is closed.\n\nHow to verify it\nAll the existing and newly added tests should pass.", "createdAt": "2020-09-14T14:40:48Z", "url": "https://github.com/pravega/pravega/pull/5185", "merged": true, "mergeCommit": {"oid": "05babe35ceab59ae2591e3a7d39e218b02583274"}, "closed": true, "closedAt": "2020-09-15T18:07:21Z", "author": {"login": "shrids"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdI0DbLAH2gAyNDg2NjY5MTc3OjAyODFjMWQxNzFlMGU4Yjk3YTJkMTU5YWQ2MGE4ODFlMTJkY2E5MTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJLyzaAFqTQ4ODkzNzg4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0281c1d171e0e8b97a2d159ad60a881e12dca912", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/0281c1d171e0e8b97a2d159ad60a881e12dca912", "committedDate": "2020-09-14T14:27:26Z", "message": "Improve exception handling.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3ODc5NzY3", "url": "https://github.com/pravega/pravega/pull/5185#pullrequestreview-487879767", "createdAt": "2020-09-14T15:17:15Z", "commit": {"oid": "0281c1d171e0e8b97a2d159ad60a881e12dca912"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToxNzoxNVrOHRaCfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNToxNzoxNVrOHRaCfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAxNDQ2Mg==", "bodyText": "we should al least keep a reference to e as \"cause\" of the ConnectionFailedException\notherwise we are simply \"masking\" any error with ConnectionFailedException\nNot sure how we are dealing with special exceptions like InterruptedException", "url": "https://github.com/pravega/pravega/pull/5185#discussion_r488014462", "createdAt": "2020-09-14T15:17:15Z", "author": {"login": "eolivelli"}, "path": "client/src/main/java/io/pravega/client/connection/impl/RawClient.java", "diffHunk": "@@ -87,16 +88,22 @@ public void authTokenCheckFailed(WireCommands.AuthTokenCheckFailed authTokenChec\n         }\n     }\n \n-    public RawClient(PravegaNodeUri uri, ConnectionPool connectonPool) {\n+    public RawClient(PravegaNodeUri uri, ConnectionPool connectionPool) {\n         this.segmentId = null;\n-        this.connection = connectonPool.getClientConnection(flow, uri, responseProcessor);\n+        this.connection = connectionPool.getClientConnection(flow, uri, responseProcessor)\n+        .exceptionally(e -> {\n+            throw new CompletionException(new ConnectionFailedException(\"Failed to obtain client connection to segment \" + segmentId.getScopedName()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0281c1d171e0e8b97a2d159ad60a881e12dca912"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e2328587327d6bbc508df051e2be7b0736391dc", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/0e2328587327d6bbc508df051e2be7b0736391dc", "committedDate": "2020-09-15T05:29:11Z", "message": "Improve exception handling.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4800eb7ba3c70afb0e45d7ca83ad20d3abdcf0b", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/f4800eb7ba3c70afb0e45d7ca83ad20d3abdcf0b", "committedDate": "2020-09-15T05:48:53Z", "message": "Merge branch 'master' into issue-rawclient-exceptionHandling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MzQ2ODAz", "url": "https://github.com/pravega/pravega/pull/5185#pullrequestreview-488346803", "createdAt": "2020-09-15T05:58:46Z", "commit": {"oid": "f4800eb7ba3c70afb0e45d7ca83ad20d3abdcf0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwNTo1ODo0N1rOHRx21Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwNTo1ODo0N1rOHRx21Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODQwNDY5Mw==", "bodyText": "I would add 'e' as cause", "url": "https://github.com/pravega/pravega/pull/5185#discussion_r488404693", "createdAt": "2020-09-15T05:58:47Z", "author": {"login": "eolivelli"}, "path": "client/src/main/java/io/pravega/client/connection/impl/RawClient.java", "diffHunk": "@@ -87,16 +88,24 @@ public void authTokenCheckFailed(WireCommands.AuthTokenCheckFailed authTokenChec\n         }\n     }\n \n-    public RawClient(PravegaNodeUri uri, ConnectionPool connectonPool) {\n+    public RawClient(PravegaNodeUri uri, ConnectionPool connectionPool) {\n         this.segmentId = null;\n-        this.connection = connectonPool.getClientConnection(flow, uri, responseProcessor);\n+        this.connection = connectionPool.getClientConnection(flow, uri, responseProcessor)\n+        .exceptionally(e -> {\n+            log.warn(\"Exception observed while attempting to obtain a connection to segment store {}\", uri, e);\n+            throw new CompletionException(new ConnectionFailedException(\"Failed to obtain client connection to  \" + uri));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4800eb7ba3c70afb0e45d7ca83ad20d3abdcf0b"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dc9ef3c228f58371feb56e27e530dec9937ac23", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/5dc9ef3c228f58371feb56e27e530dec9937ac23", "committedDate": "2020-09-15T06:02:18Z", "message": "pass exeption.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04b5f773fb52b1f7a83a9ac02cb06b8d31c70b1d", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/04b5f773fb52b1f7a83a9ac02cb06b8d31c70b1d", "committedDate": "2020-09-15T07:24:00Z", "message": "Improve ConditionalOutputStream\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e37c9514e9b324a554b156dbd5f688b15df29617", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/e37c9514e9b324a554b156dbd5f688b15df29617", "committedDate": "2020-09-15T11:00:04Z", "message": "Fix flaky integration test.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4OTM3ODgw", "url": "https://github.com/pravega/pravega/pull/5185#pullrequestreview-488937880", "createdAt": "2020-09-15T18:07:00Z", "commit": {"oid": "e37c9514e9b324a554b156dbd5f688b15df29617"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3868, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}