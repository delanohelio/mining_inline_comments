{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5NzA1ODkx", "number": 5244, "title": "Issue 5203: Stream-Cuts get saved as \"Checkpoints\" in Reader Group State", "bodyText": "Change log description\nStream-cuts/silent checkpoints are handled differently after all the readers have persisted their positions.\nPurpose of the change\nFixes #5203.\nWhat the code does\nAdded a new field within CheckpointState called lastStreamCutPosition.\n\nDuring checkpointing, the call made to readerCheckpointed in the CheckpointState allows for the reader to persist its positions. On the last reader's call, the field lastCheckpointPositions is updated to the positions of the completed checkpoint.\nThis is done for silent checkpoints/stream-cuts also which will cause issues when implementing CBR (#5108)\nSo, lastStreamCutPosition will hold the positions of the completed stream-cut instead so as to not mix stream-cuts with checkpoints.\n\nHow to verify it\nBuild should succeed and all tests must pass.", "createdAt": "2020-10-08T06:58:10Z", "url": "https://github.com/pravega/pravega/pull/5244", "merged": true, "mergeCommit": {"oid": "035752cecbd0917d5fc3933ab699de2f358a6668"}, "closed": true, "closedAt": "2020-10-16T18:16:52Z", "author": {"login": "anirudhkovuru"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPdaR3gH2gAyNDk5NzA1ODkxOjRiNjgwYWE3YWRjODZmMzBjZjJhOTYzM2JjNTdjMDhhZWUxMDg0NWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTKgrAAFqTUxMDcwMjA4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4b680aa7adc86f30cf2a9633bc57c08aee10845d", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/4b680aa7adc86f30cf2a9633bc57c08aee10845d", "committedDate": "2020-10-05T06:02:03Z", "message": "Changed CheckpointState for stream-cuts\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb50dcf3ea9d066dfed33cd4608458def199186f", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/cb50dcf3ea9d066dfed33cd4608458def199186f", "committedDate": "2020-10-08T06:02:42Z", "message": "updating serializer test for new CheckpointState field\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38fc16bb7167c6de2136f0b8a7cf7fc7d48d45dd", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/38fc16bb7167c6de2136f0b8a7cf7fc7d48d45dd", "committedDate": "2020-10-08T06:11:31Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5203-streamcut-fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2Mjg1NTUx", "url": "https://github.com/pravega/pravega/pull/5244#pullrequestreview-506285551", "createdAt": "2020-10-12T04:31:20Z", "commit": {"oid": "38fc16bb7167c6de2136f0b8a7cf7fc7d48d45dd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwNDozMToyMFrOHfutOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwNDozMjoyMVrOHfuuKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAzMzE0Nw==", "bodyText": "we should be backward compatible here, this line would throw exceptions when trying to read from data from an older client.", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r503033147", "createdAt": "2020-10-12T04:31:20Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/stream/impl/CheckpointState.java", "diffHunk": "@@ -246,6 +255,7 @@ private void read00(RevisionDataInput input, CheckpointStateBuilder builder) thr\n             builder.uncheckpointedHosts(input.readMap(stringDeserializer, in -> in.readCollection(stringDeserializer, ArrayList::new)));\n             builder.checkpointPositions(input.readMap(stringDeserializer, in -> in.readMap(segmentDeserializer, longDeserializer)));\n             builder.lastCheckpointPosition(input.readMap(segmentDeserializer, longDeserializer));\n+            builder.lastStreamCutPosition(input.readMap(segmentDeserializer, longDeserializer));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38fc16bb7167c6de2136f0b8a7cf7fc7d48d45dd"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzAzMzM4Ng==", "bodyText": "Please add tests to verify this change...", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r503033386", "createdAt": "2020-10-12T04:32:21Z", "author": {"login": "shrids"}, "path": "client/src/main/java/io/pravega/client/stream/impl/CheckpointState.java", "diffHunk": "@@ -256,6 +266,7 @@ private void write00(CheckpointState object, RevisionDataOutput output) throws I\n             output.writeMap(object.uncheckpointedHosts, stringSerializer, (out, hosts) -> out.writeCollection(hosts, stringSerializer));\n             output.writeMap(object.checkpointPositions, stringSerializer, (out, map) -> out.writeMap(map, segmentSerializer, longSerializer));\n             output.writeMap(object.lastCheckpointPosition, segmentSerializer, longSerializer);\n+            output.writeMap(object.lastStreamCutPosition, segmentSerializer, longSerializer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38fc16bb7167c6de2136f0b8a7cf7fc7d48d45dd"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "282c6066494e63d1ac77b8a7c707abf58c1c330c", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/282c6066494e63d1ac77b8a7c707abf58c1c330c", "committedDate": "2020-10-12T06:21:22Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5203-streamcut-fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2OTAxODY2", "url": "https://github.com/pravega/pravega/pull/5244#pullrequestreview-506901866", "createdAt": "2020-10-12T20:35:58Z", "commit": {"oid": "38fc16bb7167c6de2136f0b8a7cf7fc7d48d45dd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDozNTo1OVrOHgMaJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDozNTo1OVrOHgMaJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUxOTc4MA==", "bodyText": "This is not being used anywhere.", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r503519780", "createdAt": "2020-10-12T20:35:59Z", "author": {"login": "tkaitchuck"}, "path": "client/src/main/java/io/pravega/client/stream/impl/CheckpointState.java", "diffHunk": "@@ -64,23 +64,26 @@\n      */\n     private final Map<String, Map<Segment, Long>> checkpointPositions;\n \n+    private Map<Segment, Long> lastStreamCutPosition;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38fc16bb7167c6de2136f0b8a7cf7fc7d48d45dd"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0340deb4b41a182713de66a30b4fdbbfc0b20d4f", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/0340deb4b41a182713de66a30b4fdbbfc0b20d4f", "committedDate": "2020-10-13T08:56:38Z", "message": "Added new revision and backwards compatibility, new test for same\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08effb7fcc6520665bc792a915b2577a448e2b0e", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/08effb7fcc6520665bc792a915b2577a448e2b0e", "committedDate": "2020-10-15T06:00:35Z", "message": "Removed lastStreamCut field\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12e8bb026c8c3468f9e27f54c13e1cc1f1d77b9b", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/12e8bb026c8c3468f9e27f54c13e1cc1f1d77b9b", "committedDate": "2020-10-15T06:01:25Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5203-streamcut-fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "12e8bb026c8c3468f9e27f54c13e1cc1f1d77b9b", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/12e8bb026c8c3468f9e27f54c13e1cc1f1d77b9b", "committedDate": "2020-10-15T06:01:25Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5203-streamcut-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3006f5a7973ccfd3ce8637d566f6ad4064192504", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/3006f5a7973ccfd3ce8637d566f6ad4064192504", "committedDate": "2020-10-15T06:35:11Z", "message": "Fixed checkpointstate checkstyle\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48bc5f22997b55710d77ee65493aa62170bf9b6b", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/48bc5f22997b55710d77ee65493aa62170bf9b6b", "committedDate": "2020-10-16T05:32:56Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5203-streamcut-fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c753e265d7308392e61d6b79f79a044b6174ccf5", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/c753e265d7308392e61d6b79f79a044b6174ccf5", "committedDate": "2020-10-16T08:57:22Z", "message": "Added a new CheckpointStateTest\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "c753e265d7308392e61d6b79f79a044b6174ccf5", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/c753e265d7308392e61d6b79f79a044b6174ccf5", "committedDate": "2020-10-16T08:57:22Z", "message": "Added a new CheckpointStateTest\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c40772363a2c066a6d7b8890b3d79c359d0c9586", "author": {"user": {"login": "anirudhkovuru", "name": null}}, "url": "https://github.com/pravega/pravega/commit/c40772363a2c066a6d7b8890b3d79c359d0c9586", "committedDate": "2020-10-16T10:13:02Z", "message": "Added a test in UnreadBytesTests\n\nSigned-off-by: anirudhkovuru <anirudhkovuru@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNDM2ODY1", "url": "https://github.com/pravega/pravega/pull/5244#pullrequestreview-510436865", "createdAt": "2020-10-16T12:50:12Z", "commit": {"oid": "c40772363a2c066a6d7b8890b3d79c359d0c9586"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjo1MDoxMlrOHi67WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxMjo1MDoxMlrOHi67WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjM3OTA5Ng==", "bodyText": "nit: remove unnecessary newline addition", "url": "https://github.com/pravega/pravega/pull/5244#discussion_r506379096", "createdAt": "2020-10-16T12:50:12Z", "author": {"login": "pbelgundi"}, "path": "client/src/main/java/io/pravega/client/stream/impl/CheckpointState.java", "diffHunk": "@@ -138,8 +138,12 @@ void readerCheckpointed(String checkpointId, String readerName, Map<Segment, Lon\n             positions.putAll(position);\n             if (readers.isEmpty()) {\n                 uncheckpointedHosts.remove(checkpointId);\n-                //checkpoint operation completed for all readers, update the last checkpoint position.\n-                lastCheckpointPosition = checkpointPositions.get(checkpointId);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c40772363a2c066a6d7b8890b3d79c359d0c9586"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNDM3NDA0", "url": "https://github.com/pravega/pravega/pull/5244#pullrequestreview-510437404", "createdAt": "2020-10-16T12:50:53Z", "commit": {"oid": "c40772363a2c066a6d7b8890b3d79c359d0c9586"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNTc2NTA5", "url": "https://github.com/pravega/pravega/pull/5244#pullrequestreview-510576509", "createdAt": "2020-10-16T15:26:58Z", "commit": {"oid": "c40772363a2c066a6d7b8890b3d79c359d0c9586"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNzAyMDg5", "url": "https://github.com/pravega/pravega/pull/5244#pullrequestreview-510702089", "createdAt": "2020-10-16T18:16:32Z", "commit": {"oid": "c40772363a2c066a6d7b8890b3d79c359d0c9586"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3898, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}