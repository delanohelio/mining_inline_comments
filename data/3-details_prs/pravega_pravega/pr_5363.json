{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI1NDQwNjcz", "number": 5363, "title": "Issue 4902: (SLTS) - Implement more efficient eviction cache for ReadIndexCache", "bodyText": "Signed-off-by: Sachin Joshi sachin.joshi@emc.com\nChange log description\nUse Guava cache as underlying cache implementation for chunklayer.ReadIndexCache.\nCorrectly handle cleaning up auxiliary data structures when entries are evicted. (Eg ConcurrentSkipList based per segment index)\nGet rid of per segment limit.\nPurpose of the change\nFixes #4902\nReadIndexCache is supposed to cache the most recently used <start offset, chunk name> tuples in memory using LRU strategy.\nDuring eviction the current implementation scans all cached entries for given segment which is inefficient.\nWhat the code does\nUse Guava cache as underlying cache implementation for chunklayer.ReadIndexCache.\nIt has two caches\n\nCache that holds segment name to reverse lookup Index <start offset, chunk name> map.\nCache for tracking all chunk index entries.\n\nIt correctly handles cleaning up auxiliary data structures when entries are evicted. (Eg ConcurrentSkipList based per segment index)\nIt also gets rid of per segment limit.\nHow to verify it\nAll tests should pass.", "createdAt": "2020-11-23T04:36:41Z", "url": "https://github.com/pravega/pravega/pull/5363", "merged": true, "mergeCommit": {"oid": "ede135d5cc72aceb2add3ab6d6cef2f1ac8238fa"}, "closed": true, "closedAt": "2020-12-08T03:13:11Z", "author": {"login": "sachin-j-joshi"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfNQP2AH2gAyNTI1NDQwNjczOjZmZWI2YmU3ZDAwYTE1YjE4MmIxMjk3ODhmZDE5Njg3MzY0M2U0OTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj-VYPgH2gAyNTI1NDQwNjczOjJkZmYwODNkOGFlMmQ5YTk1MGNjNGM5YjZhZjkyZDEzNGY5NTJlZGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6feb6be7d00a15b182b129788fd196873643e498", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/6feb6be7d00a15b182b129788fd196873643e498", "committedDate": "2020-11-23T04:15:24Z", "message": "Issue 5067: (SLTS) - Implement more efficient eviction cache for ReadIndexCache.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7da2f175f53b58ae8372eab25deb63b75c04b30", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/a7da2f175f53b58ae8372eab25deb63b75c04b30", "committedDate": "2020-11-23T17:48:50Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-4902-SLTS-efficient-read-index-eviction"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2OTI5MTA0", "url": "https://github.com/pravega/pravega/pull/5363#pullrequestreview-536929104", "createdAt": "2020-11-23T23:37:58Z", "commit": {"oid": "a7da2f175f53b58ae8372eab25deb63b75c04b30"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMzozNzo1OFrOH4jpXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QyMzozNzo1OFrOH4jpXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTA2NjMzMw==", "bodyText": "Guava cache is synchronized. Why are you re-synchronizing?", "url": "https://github.com/pravega/pravega/pull/5363#discussion_r529066333", "createdAt": "2020-11-23T23:37:58Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/ReadIndexCache.java", "diffHunk": "@@ -86,59 +65,35 @@ public ReadIndexCache(int maxIndexedSegments, int maxIndexedChunksPerSegment, in\n      * @param streamSegmentName Name of the segment.\n      * @return Read index corresponding to the given segment. A new empty index is created if it doesn't already exist.\n      */\n-    private SegmentReadIndex getSegmentReadIndex(String streamSegmentName) {\n-        SegmentReadIndex readIndex = segmentsToReadIndexMap.get(streamSegmentName);\n-\n-        if (null == readIndex) {\n-            // Evict segments if required.\n-            if (maxIndexedSegments < segmentsToReadIndexMap.size() + 1 || maxIndexedChunks < totalChunkCount.get() + 1) {\n-                evictSegmentsFromOldestGeneration();\n+    private SegmentReadIndex getSegmentReadIndex(String streamSegmentName, boolean createIfNotPresent) {\n+        SegmentReadIndex readIndex = segmentsReadIndexCache.getIfPresent(streamSegmentName);\n+        if (null == readIndex && createIfNotPresent) {\n+            synchronized (segmentsReadIndexCache) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7da2f175f53b58ae8372eab25deb63b75c04b30"}, "originalPosition": 116}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ec91fa70771db79dc86af4b7282d5f83ffeb21d", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/6ec91fa70771db79dc86af4b7282d5f83ffeb21d", "committedDate": "2020-12-02T20:58:15Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-4902-SLTS-efficient-read-index-eviction"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTAwMjc4", "url": "https://github.com/pravega/pravega/pull/5363#pullrequestreview-544500278", "createdAt": "2020-12-03T22:19:24Z", "commit": {"oid": "6ec91fa70771db79dc86af4b7282d5f83ffeb21d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56ae292dd2c7f54a6b09aec92a37ffe579b7acb4", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/56ae292dd2c7f54a6b09aec92a37ffe579b7acb4", "committedDate": "2020-12-03T23:21:57Z", "message": "Merge branch 'master' into issue-4902-SLTS-efficient-read-index-eviction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f388dd93ac3ef8bde63d199195341dce5beb628", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/0f388dd93ac3ef8bde63d199195341dce5beb628", "committedDate": "2020-12-04T16:05:13Z", "message": "Merge branch 'master' into issue-4902-SLTS-efficient-read-index-eviction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dff083d8ae2d9a950cc4c9b6af92d134f952eda", "author": {"user": {"login": "andreipaduroiu", "name": "Andrei Paduroiu"}}, "url": "https://github.com/pravega/pravega/commit/2dff083d8ae2d9a950cc4c9b6af92d134f952eda", "committedDate": "2020-12-07T23:42:03Z", "message": "Merge branch 'master' into issue-4902-SLTS-efficient-read-index-eviction"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3751, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}