{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNzI0NTYw", "number": 4756, "title": "Issue 4736: Run scale workflow only if input matches the existing Epoch transition record", "bodyText": "Signed-off-by: Shivesh Ranjan shivesh.ranjan@gmail.com\nChange log description\nEnsure that scale workflow for an event is processed for that event and if the stream metadata (epoch transition record) is different from the scale event then exit the workflow.\nPurpose of the change\nFixes #4736\nWhat the code does\nScaleOperationTask runs the scale workflow by checking if the epoch transition record exists or not.\nIf it exists, it should compare the scale input and only process the event if the input is same as epoch transition record.\nFor manual scale, since the epoch transition record is written before the event is posted, so if the epoch transition record is different from the event, then the event has already been processed and it is idempotent case so complete the workflow.\nFor auto scale case, if the epoch transition record exists, it means a different scale is being processed, so throw conflict exception so that this event is postponed and retried later.\nHow to verify it\nUnit test added.", "createdAt": "2020-04-29T13:46:49Z", "url": "https://github.com/pravega/pravega/pull/4756", "merged": true, "mergeCommit": {"oid": "c4475a13cbdc0e70835b312a25cd00b88cbcd4dd"}, "closed": true, "closedAt": "2020-05-11T10:44:52Z", "author": {"login": "shiveshr"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccYlZkAH2gAyNDEwNzI0NTYwOmFkMDY5YThjMzkwNGE3OTE3YmE5ZDJmYzlkMDU1ODVhNGM3MGM5MjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgMxBiAFqTQwOTAzMzU1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ad069a8c3904a7917ba9d2fc9d05585a4c70c922", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/ad069a8c3904a7917ba9d2fc9d05585a4c70c922", "committedDate": "2020-04-29T13:34:32Z", "message": "Issue 4736\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c6f33dcc6a1059a09d1eb2eea714267bfbcab93", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/1c6f33dcc6a1059a09d1eb2eea714267bfbcab93", "committedDate": "2020-04-30T02:36:16Z", "message": "Merge branch 'master' into issue4736"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98698e6057389ce036fe052ce6402e34feb823e9", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/98698e6057389ce036fe052ce6402e34feb823e9", "committedDate": "2020-05-04T12:38:19Z", "message": "Merge branch 'master' into issue4736"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f716d0069d471014da4658cb2248124376c7040", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/1f716d0069d471014da4658cb2248124376c7040", "committedDate": "2020-05-05T05:34:34Z", "message": "Merge branch 'master' into issue4736"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "847f5fbb9d43fd8e9513cb792f7412a24e2b8643", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/847f5fbb9d43fd8e9513cb792f7412a24e2b8643", "committedDate": "2020-05-08T04:33:31Z", "message": "Merge branch 'master' into issue4736"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4ODQ0Njg0", "url": "https://github.com/pravega/pravega/pull/4756#pullrequestreview-408844684", "createdAt": "2020-05-11T04:00:08Z", "commit": {"oid": "847f5fbb9d43fd8e9513cb792f7412a24e2b8643"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNDowMDowOFrOGTLoug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQwNDowNToxMFrOGTLtIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc2Njc3OA==", "bodyText": "Throwing a ConfilictException cause the writeBackPredicate of processScaleOpRequest to be true causing the event to written back, which effectively postpones the event, right ?", "url": "https://github.com/pravega/pravega/pull/4756#discussion_r422766778", "createdAt": "2020-05-11T04:00:08Z", "author": {"login": "shrids"}, "path": "controller/src/main/java/io/pravega/controller/server/eventProcessor/requesthandlers/ScaleOperationTask.java", "diffHunk": "@@ -126,7 +127,19 @@ public ScaleOperationTask(final StreamMetadataTasks streamMetadataTasks,\n                                 future = future.thenCompose(r -> streamMetadataStore.submitScale(scope, stream, scaleInput.getSegmentsToSeal(),\n                                         new ArrayList<>(scaleInput.getNewRanges()), scaleInput.getScaleTime(), record, context, executor));\n                             }\n-                        } \n+                        } else if (!RecordHelper.verifyRecordMatchesInput(scaleInput.getSegmentsToSeal(), scaleInput.getNewRanges(), isManualScale, record.getObject())) {\n+                            // ensure that we process the event only if the input matches the epoch transition record.\n+                            // if its manual scale and the event doesnt match, it means the scale has already completed. \n+                            // for auto scale, it means another scale is on going and just throw scale conflict exception \n+                            // which will result in this event being postponed. \n+                            if (isManualScale) {\n+                                log.info(\"Scale already completed.\");\n+                                return CompletableFuture.completedFuture(null);\n+                            } else {\n+                                log.info(\"Scale conflict.\");\n+                                throw new EpochTransitionOperationExceptions.ConflictException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "847f5fbb9d43fd8e9513cb792f7412a24e2b8643"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc2NzMzNw==", "bodyText": "The log can have additional data about the scale operation.", "url": "https://github.com/pravega/pravega/pull/4756#discussion_r422767337", "createdAt": "2020-05-11T04:02:40Z", "author": {"login": "shrids"}, "path": "controller/src/main/java/io/pravega/controller/server/eventProcessor/requesthandlers/ScaleOperationTask.java", "diffHunk": "@@ -126,7 +127,19 @@ public ScaleOperationTask(final StreamMetadataTasks streamMetadataTasks,\n                                 future = future.thenCompose(r -> streamMetadataStore.submitScale(scope, stream, scaleInput.getSegmentsToSeal(),\n                                         new ArrayList<>(scaleInput.getNewRanges()), scaleInput.getScaleTime(), record, context, executor));\n                             }\n-                        } \n+                        } else if (!RecordHelper.verifyRecordMatchesInput(scaleInput.getSegmentsToSeal(), scaleInput.getNewRanges(), isManualScale, record.getObject())) {\n+                            // ensure that we process the event only if the input matches the epoch transition record.\n+                            // if its manual scale and the event doesnt match, it means the scale has already completed. \n+                            // for auto scale, it means another scale is on going and just throw scale conflict exception \n+                            // which will result in this event being postponed. \n+                            if (isManualScale) {\n+                                log.info(\"Scale already completed.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "847f5fbb9d43fd8e9513cb792f7412a24e2b8643"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjc2NzkwNg==", "bodyText": "Scale conflict already causes a WARN message to be thrown in 79 line, Can we add more details to this log line?", "url": "https://github.com/pravega/pravega/pull/4756#discussion_r422767906", "createdAt": "2020-05-11T04:05:10Z", "author": {"login": "shrids"}, "path": "controller/src/main/java/io/pravega/controller/server/eventProcessor/requesthandlers/ScaleOperationTask.java", "diffHunk": "@@ -126,7 +127,19 @@ public ScaleOperationTask(final StreamMetadataTasks streamMetadataTasks,\n                                 future = future.thenCompose(r -> streamMetadataStore.submitScale(scope, stream, scaleInput.getSegmentsToSeal(),\n                                         new ArrayList<>(scaleInput.getNewRanges()), scaleInput.getScaleTime(), record, context, executor));\n                             }\n-                        } \n+                        } else if (!RecordHelper.verifyRecordMatchesInput(scaleInput.getSegmentsToSeal(), scaleInput.getNewRanges(), isManualScale, record.getObject())) {\n+                            // ensure that we process the event only if the input matches the epoch transition record.\n+                            // if its manual scale and the event doesnt match, it means the scale has already completed. \n+                            // for auto scale, it means another scale is on going and just throw scale conflict exception \n+                            // which will result in this event being postponed. \n+                            if (isManualScale) {\n+                                log.info(\"Scale already completed.\");\n+                                return CompletableFuture.completedFuture(null);\n+                            } else {\n+                                log.info(\"Scale conflict.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "847f5fbb9d43fd8e9513cb792f7412a24e2b8643"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07ec909ee9b1ec67895febbce61420d84c3073d1", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/07ec909ee9b1ec67895febbce61420d84c3073d1", "committedDate": "2020-05-11T05:22:26Z", "message": "PR comments\n\nSigned-off-by: Shivesh Ranjan <shivesh.ranjan@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e1cd4b4e08df542462226f2f237017b99022d23", "author": {"user": {"login": "shiveshr", "name": "shivesh ranjan"}}, "url": "https://github.com/pravega/pravega/commit/6e1cd4b4e08df542462226f2f237017b99022d23", "committedDate": "2020-05-11T05:23:12Z", "message": "Merge branch 'issue4736' of https://github.com/shiveshr/pravega-1 into issue4736"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4ODczNDI2", "url": "https://github.com/pravega/pravega/pull/4756#pullrequestreview-408873426", "createdAt": "2020-05-11T05:44:52Z", "commit": {"oid": "6e1cd4b4e08df542462226f2f237017b99022d23"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MDMzNTU0", "url": "https://github.com/pravega/pravega/pull/4756#pullrequestreview-409033554", "createdAt": "2020-05-11T10:04:04Z", "commit": {"oid": "6e1cd4b4e08df542462226f2f237017b99022d23"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3446, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}