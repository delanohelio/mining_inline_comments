{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIyNzY2NzA5", "number": 5346, "title": "Issue 5330: SLTS - Handle partially written chunks and snapshots after failures.", "bodyText": "During SLTS bootstrap, correctly handle partially written snapshots (during fail over) by skipping over them.\nSigned-off-by: Sachin Joshi sachin.joshi@emc.com\nChange log description\nCorrectly handle partially written chunks and snapshots after failures by skipping over them.\nPurpose of the change\nFixes #5330\nWhat the code does\nIt fixes following failures\n\n\nIf segment store failed while it was writing system journal snapshot then that partially written data can not be deserialized and causes EOFException. Code handles it and skips over the partial snapshot.\n\n\nWhen a previous write failure leaves behind partially written chunk it will generate InvalidOffsetException, the code handles it and skips over partial chunk.\n\n\nHow to verify it\nI have added the new unit tests.\nbuild should pass", "createdAt": "2020-11-17T23:19:58Z", "url": "https://github.com/pravega/pravega/pull/5346", "merged": true, "mergeCommit": {"oid": "784d2043d72e71ba46ca2d177aab3c013784d267"}, "closed": true, "closedAt": "2020-12-10T03:44:19Z", "author": {"login": "sachin-j-joshi"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdd353EgBqjQwMTM0NDE2NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdknJHnAFqTU0ODY5Mjc3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf4cbb32519d576c705ea1591aae0361ddb80641", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/cf4cbb32519d576c705ea1591aae0361ddb80641", "committedDate": "2020-11-17T22:54:56Z", "message": "Issue 5330: SLTS - Handle partially written snapshot during fail over.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}, "afterCommit": {"oid": "ea9193999972aff6132c71e513e0c2aaa53df98b", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/ea9193999972aff6132c71e513e0c2aaa53df98b", "committedDate": "2020-11-19T00:47:50Z", "message": "Issue 5330: SLTS - Handle partially written snapshot during fail over.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8405883f9764382d7f5dee8e6153f5e9e5f24260", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/8405883f9764382d7f5dee8e6153f5e9e5f24260", "committedDate": "2020-11-19T04:16:06Z", "message": "Issue 5330: SLTS - Handle partially written snapshot during fail over.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea9193999972aff6132c71e513e0c2aaa53df98b", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/ea9193999972aff6132c71e513e0c2aaa53df98b", "committedDate": "2020-11-19T00:47:50Z", "message": "Issue 5330: SLTS - Handle partially written snapshot during fail over.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}, "afterCommit": {"oid": "8405883f9764382d7f5dee8e6153f5e9e5f24260", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/8405883f9764382d7f5dee8e6153f5e9e5f24260", "committedDate": "2020-11-19T04:16:06Z", "message": "Issue 5330: SLTS - Handle partially written snapshot during fail over.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0MjUwMjM5", "url": "https://github.com/pravega/pravega/pull/5346#pullrequestreview-534250239", "createdAt": "2020-11-19T09:54:36Z", "commit": {"oid": "8405883f9764382d7f5dee8e6153f5e9e5f24260"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NTkzNDU5", "url": "https://github.com/pravega/pravega/pull/5346#pullrequestreview-534593459", "createdAt": "2020-11-19T15:56:59Z", "commit": {"oid": "8405883f9764382d7f5dee8e6153f5e9e5f24260"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNTo1Njo1OVrOH2lgZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxNTo1OToyNlrOH2lnyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjk5OTY1NQ==", "bodyText": "Haven't we made these calls things async? Did we miss this class?", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r526999655", "createdAt": "2020-11-19T15:56:59Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/SystemJournal.java", "diffHunk": "@@ -250,9 +250,14 @@ private long applyLatestSnapshot(MetadataTransaction txn, HashMap<String, Long>\n         for (epochToCheck = epoch - 1; epochToCheck >= 0; epochToCheck--) {\n             snapshotFile = getSystemJournalChunkName(containerId, epochToCheck, 0);\n             if (chunkStorage.exists(snapshotFile).get()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8405883f9764382d7f5dee8e6153f5e9e5f24260"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzAwMTU0NA==", "bodyText": "Why do you put this condition here? Don't you have full control over your test? You use in-memory storage here, so this should always be supported.", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r527001544", "createdAt": "2020-11-19T15:59:26Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -324,6 +333,35 @@ public void testSimpleBootstrapWithMultipleFailovers() throws Exception {\n         Assert.assertEquals(expected, actual);\n     }\n \n+    @Test\n+    public void testSimpleBootstrapWithIncompleteSnapshot() throws Exception {\n+        val containerId = 42;\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        testSimpleBootstrapWithMultipleFailovers(containerId, chunkStorage, epoch -> {\n+            val snapShotFile = NameUtils.getSystemJournalFileName(containerId, epoch, 0);\n+            val size = 1;\n+            if (chunkStorage.supportsTruncation()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8405883f9764382d7f5dee8e6153f5e9e5f24260"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d43b47e8c4b5ef161e3bc3a7c3e599de760d6ba7", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/d43b47e8c4b5ef161e3bc3a7c3e599de760d6ba7", "committedDate": "2020-11-19T17:42:06Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a682e971cf99c6867fa81f85e40f28d00961d728", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/a682e971cf99c6867fa81f85e40f28d00961d728", "committedDate": "2020-11-21T04:16:59Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3000b8507f867e171a1f8a7bfb2a9a7b59210f3e", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/3000b8507f867e171a1f8a7bfb2a9a7b59210f3e", "committedDate": "2020-11-21T04:25:23Z", "message": "Issue 5330: SLTS - Correctly handle partially written chunks during write after previous failure.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b455be250e1d49297238a65b60db302d9a22fecc", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/b455be250e1d49297238a65b60db302d9a22fecc", "committedDate": "2020-11-21T16:56:58Z", "message": "Issue 5330: SLTS - Code cleanup.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0d19492b37d72c0c7e77465e911dcf2e1f7919d", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/e0d19492b37d72c0c7e77465e911dcf2e1f7919d", "committedDate": "2020-11-23T17:53:48Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd50c2bd0fa633234104a3eda52390be4db66bf6", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/bd50c2bd0fa633234104a3eda52390be4db66bf6", "committedDate": "2020-12-02T21:03:10Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTA0NDYz", "url": "https://github.com/pravega/pravega/pull/5346#pullrequestreview-544504463", "createdAt": "2020-12-03T22:26:30Z", "commit": {"oid": "bd50c2bd0fa633234104a3eda52390be4db66bf6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoyNjozMFrOH-329w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoyNzowMVrOH-338w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4ODk1MQ==", "bodyText": "Can you do this with the Retry class (in common). We have various retry utilities that can help with your syntax here.", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r535688951", "createdAt": "2020-12-03T22:26:30Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/SystemJournal.java", "diffHunk": "@@ -229,10 +230,23 @@ public void commitRecords(Collection<SystemJournalRecord> records) throws ChunkS\n         }\n         // Persist\n         synchronized (lock) {\n-            writeToJournal(bytes);\n-            // Add a new log file if required.\n-            if (!chunkStorage.supportsAppend() || !config.isAppendEnabled()) {\n-                startNewJournalFile();\n+            boolean done = false;\n+            while (!done) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd50c2bd0fa633234104a3eda52390be4db66bf6"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4OTIwMw==", "bodyText": "Why just ExecutionException? Can it be Exception, CompletionException? Exceptions.unwrap will handle all of those.", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r535689203", "createdAt": "2020-12-03T22:27:01Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/SystemJournal.java", "diffHunk": "@@ -229,10 +230,23 @@ public void commitRecords(Collection<SystemJournalRecord> records) throws ChunkS\n         }\n         // Persist\n         synchronized (lock) {\n-            writeToJournal(bytes);\n-            // Add a new log file if required.\n-            if (!chunkStorage.supportsAppend() || !config.isAppendEnabled()) {\n-                startNewJournalFile();\n+            boolean done = false;\n+            while (!done) {\n+                try {\n+                    writeToJournal(bytes);\n+                    done = true;\n+                } catch (ExecutionException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd50c2bd0fa633234104a3eda52390be4db66bf6"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ceef0564c375805d23e000069e06775f1a5c677", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/0ceef0564c375805d23e000069e06775f1a5c677", "committedDate": "2020-12-04T01:52:56Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/4dcbd5fa0230a2392758e20804f08a210ea286d2", "committedDate": "2020-12-09T06:51:30Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4Mzg5NDA4", "url": "https://github.com/pravega/pravega/pull/5346#pullrequestreview-548389408", "createdAt": "2020-12-09T16:51:44Z", "commit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjo1MTo0NVrOICe4bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNjo1NjozN1rOICfHnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NDAzMA==", "bodyText": ".retryWhen(ex -> Exceptions.unwrap(ex) instanceof xyz)", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539474030", "createdAt": "2020-12-09T16:51:45Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/SystemJournal.java", "diffHunk": "@@ -229,10 +230,23 @@ public void commitRecords(Collection<SystemJournalRecord> records) throws ChunkS\n         }\n         // Persist\n         synchronized (lock) {\n-            writeToJournal(bytes);\n-            // Add a new log file if required.\n-            if (!chunkStorage.supportsAppend() || !config.isAppendEnabled()) {\n-                startNewJournalFile();\n+            boolean done = false;\n+            while (!done) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4ODk1MQ=="}, "originalCommit": {"oid": "bd50c2bd0fa633234104a3eda52390be4db66bf6"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NDQxMg==", "bodyText": "What if that exception is wrapped in CompletionException?", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539474412", "createdAt": "2020-12-09T16:52:13Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/main/java/io/pravega/segmentstore/storage/chunklayer/SystemJournal.java", "diffHunk": "@@ -229,10 +230,23 @@ public void commitRecords(Collection<SystemJournalRecord> records) throws ChunkS\n         }\n         // Persist\n         synchronized (lock) {\n-            writeToJournal(bytes);\n-            // Add a new log file if required.\n-            if (!chunkStorage.supportsAppend() || !config.isAppendEnabled()) {\n-                startNewJournalFile();\n+            boolean done = false;\n+            while (!done) {\n+                try {\n+                    writeToJournal(bytes);\n+                    done = true;\n+                } catch (ExecutionException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4OTIwMw=="}, "originalCommit": {"oid": "bd50c2bd0fa633234104a3eda52390be4db66bf6"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NTI3Mg==", "bodyText": "Just like in the other PR, please add cleanup methods to this class.", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539475272", "createdAt": "2020-12-09T16:53:20Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/ChunkedSegmentStorageTests.java", "diffHunk": "@@ -719,6 +719,38 @@ public void testWrite() throws Exception {\n         checkDataRead(testSegmentName, testContext, 0, total);\n     }\n \n+\n+    /**\n+     * Test Write after repeated failure.\n+     *\n+     * @throws Exception Exception if any.\n+     */\n+    @Test\n+    public void testWriteAfterWriteFailure() throws Exception {\n+        String testSegmentName = \"foo\";\n+        TestContext testContext = getTestContext();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NTQ5Mw==", "bodyText": "Cleanup", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539475493", "createdAt": "2020-12-09T16:53:37Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -257,6 +258,79 @@ public void testSimpleBootstrapWithTwoFailovers() throws Exception {\n         Assert.assertEquals(\"Hello World\", new String(out));\n     }\n \n+    /**\n+     * Tests a scenario when journal chunks may be partially written during failure.\n+     *\n+     * @throws Exception Throws exception in case of any error.\n+     */\n+    @Test\n+    public void testSimpleBootstrapWithPartialDataWrite() throws Exception {\n+        ChunkStorage chunkStorage = getChunkStorage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NjM2Mg==", "bodyText": "Cleanup", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539476362", "createdAt": "2020-12-09T16:54:44Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -257,6 +258,79 @@ public void testSimpleBootstrapWithTwoFailovers() throws Exception {\n         Assert.assertEquals(\"Hello World\", new String(out));\n     }\n \n+    /**\n+     * Tests a scenario when journal chunks may be partially written during failure.\n+     *\n+     * @throws Exception Throws exception in case of any error.\n+     */\n+    @Test\n+    public void testSimpleBootstrapWithPartialDataWrite() throws Exception {\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        if (!chunkStorage.supportsAppend()) {\n+            return;\n+        }\n+\n+        ChunkMetadataStore metadataStore = getMetadataStore();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NjQ1NA==", "bodyText": "Cleanup", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539476454", "createdAt": "2020-12-09T16:54:50Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -257,6 +258,79 @@ public void testSimpleBootstrapWithTwoFailovers() throws Exception {\n         Assert.assertEquals(\"Hello World\", new String(out));\n     }\n \n+    /**\n+     * Tests a scenario when journal chunks may be partially written during failure.\n+     *\n+     * @throws Exception Throws exception in case of any error.\n+     */\n+    @Test\n+    public void testSimpleBootstrapWithPartialDataWrite() throws Exception {\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        if (!chunkStorage.supportsAppend()) {\n+            return;\n+        }\n+\n+        ChunkMetadataStore metadataStore = getMetadataStore();\n+        ChunkMetadataStore metadataStoreAfterCrash = getMetadataStore();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NjY3OQ==", "bodyText": "Cleanup", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539476679", "createdAt": "2020-12-09T16:55:07Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -257,6 +258,79 @@ public void testSimpleBootstrapWithTwoFailovers() throws Exception {\n         Assert.assertEquals(\"Hello World\", new String(out));\n     }\n \n+    /**\n+     * Tests a scenario when journal chunks may be partially written during failure.\n+     *\n+     * @throws Exception Throws exception in case of any error.\n+     */\n+    @Test\n+    public void testSimpleBootstrapWithPartialDataWrite() throws Exception {\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        if (!chunkStorage.supportsAppend()) {\n+            return;\n+        }\n+\n+        ChunkMetadataStore metadataStore = getMetadataStore();\n+        ChunkMetadataStore metadataStoreAfterCrash = getMetadataStore();\n+        int containerId = 42;\n+        String systemSegmentName = SystemJournal.getChunkStorageSystemSegments(containerId)[0];\n+        long epoch = 1;\n+        val policy = new SegmentRollingPolicy(4);\n+        val config = ChunkedSegmentStorageConfig.DEFAULT_CONFIG.toBuilder().defaultRollingPolicy(policy).build();\n+\n+        long offset = 0;\n+\n+        // Epoch 1\n+        ChunkedSegmentStorage segmentStorage1 = new ChunkedSegmentStorage(containerId, chunkStorage, metadataStore, executorService(), config);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3Njk0NQ==", "bodyText": "cleanup", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539476945", "createdAt": "2020-12-09T16:55:28Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -257,6 +258,79 @@ public void testSimpleBootstrapWithTwoFailovers() throws Exception {\n         Assert.assertEquals(\"Hello World\", new String(out));\n     }\n \n+    /**\n+     * Tests a scenario when journal chunks may be partially written during failure.\n+     *\n+     * @throws Exception Throws exception in case of any error.\n+     */\n+    @Test\n+    public void testSimpleBootstrapWithPartialDataWrite() throws Exception {\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        if (!chunkStorage.supportsAppend()) {\n+            return;\n+        }\n+\n+        ChunkMetadataStore metadataStore = getMetadataStore();\n+        ChunkMetadataStore metadataStoreAfterCrash = getMetadataStore();\n+        int containerId = 42;\n+        String systemSegmentName = SystemJournal.getChunkStorageSystemSegments(containerId)[0];\n+        long epoch = 1;\n+        val policy = new SegmentRollingPolicy(4);\n+        val config = ChunkedSegmentStorageConfig.DEFAULT_CONFIG.toBuilder().defaultRollingPolicy(policy).build();\n+\n+        long offset = 0;\n+\n+        // Epoch 1\n+        ChunkedSegmentStorage segmentStorage1 = new ChunkedSegmentStorage(containerId, chunkStorage, metadataStore, executorService(), config);\n+\n+        segmentStorage1.initialize(epoch);\n+\n+        // Bootstrap\n+        segmentStorage1.bootstrap().join();\n+        checkSystemSegmentsLayout(segmentStorage1);\n+\n+        // Simulate some writes to system segment, this should cause some new chunks being added.\n+        val h = segmentStorage1.openWrite(systemSegmentName).join();\n+        val b1 = \"Hello\".getBytes();\n+        segmentStorage1.write(h, offset, new ByteArrayInputStream(b1), b1.length, null).join();\n+        offset += b1.length;\n+\n+        // Inject a fault by adding some garbage at the end\n+        checkSystemSegmentsLayout(segmentStorage1);\n+        val chunkFileName = NameUtils.getSystemJournalFileName(segmentStorage1.getSystemJournal().getContainerId(),\n+                segmentStorage1.getSystemJournal().getEpoch(),\n+                segmentStorage1.getSystemJournal().getCurrentFileIndex());\n+        val chunkInfo = chunkStorage.getInfo(chunkFileName);\n+        chunkStorage.write(ChunkHandle.writeHandle(chunkFileName), chunkInfo.get().getLength(), 1, new ByteArrayInputStream(new byte[1])).get();\n+\n+        // This next write will encounter partially written chunk and is expected to start a new chunk.\n+        val b2 = \" World\".getBytes();\n+        segmentStorage1.write(h, offset, new ByteArrayInputStream(b2), b2.length, null).join();\n+        offset += b2.length;\n+\n+        checkSystemSegmentsLayout(segmentStorage1);\n+\n+        // Step 2\n+        // Start container with epoch 2\n+        epoch++;\n+\n+        ChunkedSegmentStorage segmentStorage2 = new ChunkedSegmentStorage(containerId, chunkStorage, metadataStoreAfterCrash, executorService(), config);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NzExMg==", "bodyText": "cleanup", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539477112", "createdAt": "2020-12-09T16:55:40Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -267,9 +341,12 @@ public void testSimpleBootstrapWithTwoFailovers() throws Exception {\n      */\n     @Test\n     public void testSimpleBootstrapWithMultipleFailovers() throws Exception {\n+        val containerId = 42;\n         ChunkStorage chunkStorage = getChunkStorage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NzMxNw==", "bodyText": "cleanup to all of these", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539477317", "createdAt": "2020-12-09T16:55:55Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -305,7 +382,12 @@ public void testSimpleBootstrapWithMultipleFailovers() throws Exception {\n             oldHandle = h;\n         }\n \n+        if (null != faultInjection) {\n+            faultInjection.accept(epoch);\n+        }\n+\n         epoch++;\n+\n         ChunkMetadataStore metadataStoreFinal = getMetadataStore();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NzM5Mw==", "bodyText": "cleanup", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539477393", "createdAt": "2020-12-09T16:56:01Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -324,6 +406,35 @@ public void testSimpleBootstrapWithMultipleFailovers() throws Exception {\n         Assert.assertEquals(expected, actual);\n     }\n \n+    @Test\n+    public void testSimpleBootstrapWithIncompleteSnapshot() throws Exception {\n+        val containerId = 42;\n+        ChunkStorage chunkStorage = getChunkStorage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "originalPosition": 122}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NzgwMw==", "bodyText": "Are you cleaning up this file anywhere? Leaving files behind is also a leak", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539477803", "createdAt": "2020-12-09T16:56:31Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -324,6 +406,35 @@ public void testSimpleBootstrapWithMultipleFailovers() throws Exception {\n         Assert.assertEquals(expected, actual);\n     }\n \n+    @Test\n+    public void testSimpleBootstrapWithIncompleteSnapshot() throws Exception {\n+        val containerId = 42;\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        testSimpleBootstrapWithMultipleFailovers(containerId, chunkStorage, epoch -> {\n+            val snapShotFile = NameUtils.getSystemJournalFileName(containerId, epoch, 0);\n+            val size = 1;\n+            if (chunkStorage.supportsTruncation()) {\n+                chunkStorage.truncate(ChunkHandle.writeHandle(snapShotFile), size).join();\n+            } else {\n+                val bytes = new byte[size];\n+                chunkStorage.read(ChunkHandle.readHandle(snapShotFile), 0, size, bytes, 0).join();\n+                chunkStorage.delete(ChunkHandle.writeHandle(snapShotFile)).join();\n+                val h = chunkStorage.create(snapShotFile).join();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NzkxNg==", "bodyText": "cleanup", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539477916", "createdAt": "2020-12-09T16:56:37Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/SystemJournalTests.java", "diffHunk": "@@ -324,6 +406,35 @@ public void testSimpleBootstrapWithMultipleFailovers() throws Exception {\n         Assert.assertEquals(expected, actual);\n     }\n \n+    @Test\n+    public void testSimpleBootstrapWithIncompleteSnapshot() throws Exception {\n+        val containerId = 42;\n+        ChunkStorage chunkStorage = getChunkStorage();\n+        testSimpleBootstrapWithMultipleFailovers(containerId, chunkStorage, epoch -> {\n+            val snapShotFile = NameUtils.getSystemJournalFileName(containerId, epoch, 0);\n+            val size = 1;\n+            if (chunkStorage.supportsTruncation()) {\n+                chunkStorage.truncate(ChunkHandle.writeHandle(snapShotFile), size).join();\n+            } else {\n+                val bytes = new byte[size];\n+                chunkStorage.read(ChunkHandle.readHandle(snapShotFile), 0, size, bytes, 0).join();\n+                chunkStorage.delete(ChunkHandle.writeHandle(snapShotFile)).join();\n+                val h = chunkStorage.create(snapShotFile).join();\n+                chunkStorage.write(h, 0, size, new ByteArrayInputStream(bytes)).join();\n+            }\n+        });\n+    }\n+\n+    @Test\n+    public void testSimpleBootstrapWithMissingSnapshot() throws Exception {\n+        val containerId = 42;\n+        ChunkStorage chunkStorage = getChunkStorage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "originalPosition": 141}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6a6a7d18bcda472d4dc01d3c2e4aac325ad75cb", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/e6a6a7d18bcda472d4dc01d3c2e4aac325ad75cb", "committedDate": "2020-12-09T22:13:41Z", "message": "Issue 5390: SLTS - Cleanup in tests.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c107db377131ade388fe9582b7aff868465864d1", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/c107db377131ade388fe9582b7aff868465864d1", "committedDate": "2020-12-09T22:27:02Z", "message": "Merge branch 'master' of https://github.com/pravega/pravega into issue-5330-SLTS-system-log-fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61c2e81a17772cb09c60a2cddd42716c8e41dad5", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/61c2e81a17772cb09c60a2cddd42716c8e41dad5", "committedDate": "2020-12-09T22:32:42Z", "message": "Issue 5390: SLTS - Cleanup in tests.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4Njc5NDQ3", "url": "https://github.com/pravega/pravega/pull/5346#pullrequestreview-548679447", "createdAt": "2020-12-09T22:50:14Z", "commit": {"oid": "61c2e81a17772cb09c60a2cddd42716c8e41dad5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMjo1MDoxNVrOICtHgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQyMjo1MDoxNVrOICtHgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcwNzI2Ng==", "bodyText": "added", "url": "https://github.com/pravega/pravega/pull/5346#discussion_r539707266", "createdAt": "2020-12-09T22:50:15Z", "author": {"login": "sachin-j-joshi"}, "path": "segmentstore/storage/src/test/java/io/pravega/segmentstore/storage/chunklayer/ChunkedSegmentStorageTests.java", "diffHunk": "@@ -719,6 +719,38 @@ public void testWrite() throws Exception {\n         checkDataRead(testSegmentName, testContext, 0, total);\n     }\n \n+\n+    /**\n+     * Test Write after repeated failure.\n+     *\n+     * @throws Exception Exception if any.\n+     */\n+    @Test\n+    public void testWriteAfterWriteFailure() throws Exception {\n+        String testSegmentName = \"foo\";\n+        TestContext testContext = getTestContext();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NTI3Mg=="}, "originalCommit": {"oid": "4dcbd5fa0230a2392758e20804f08a210ea286d2"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9261593bc3c2bcb12bbe904deee3e22b96ca00ac", "author": {"user": {"login": "sachin-j-joshi", "name": "Sachin Jayant Joshi"}}, "url": "https://github.com/pravega/pravega/commit/9261593bc3c2bcb12bbe904deee3e22b96ca00ac", "committedDate": "2020-12-09T23:09:35Z", "message": "Issue 5390: SLTS - Cleanup in tests - address review comments.\n\nSigned-off-by: Sachin Joshi <sachin.joshi@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NjkyNzc2", "url": "https://github.com/pravega/pravega/pull/5346#pullrequestreview-548692776", "createdAt": "2020-12-09T23:14:46Z", "commit": {"oid": "9261593bc3c2bcb12bbe904deee3e22b96ca00ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3743, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}