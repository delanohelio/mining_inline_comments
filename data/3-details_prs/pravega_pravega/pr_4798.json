{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5NzM2ODg5", "number": 4798, "title": "Issue 4531: Use new BookKeeper API and Upgrade to BookKeeper 4.9.2", "bodyText": "Change log description\nBookKeeper 4.8 introduced a new API (org.apache.bookkeeper.client.api).\nThe old API, LedgerHandler, is going to be deprecated officially in next upcoming release (4.11).\nThe new API is based on CompletableFuture facility of the JDK.\nThe new API allows access to the internal refcounted Netty buffer used by BK client.\nPurpose of the change\nFixes #4531.\nSwitch from using LedgerHandle to WriteHandle and ReadHandle.\nI am changing BK version to 4.9.2.\nWhat the code does\nUpgrade BookKeeper to 4.9.2 in Java code (not docker images)\nReplace  usages of LedgerHandle with WriteHandle and ReadHandle.\nUse the new CompletableFuture based API.\nHow to verify it\nTests should run without errors.", "createdAt": "2020-05-18T20:53:58Z", "url": "https://github.com/pravega/pravega/pull/4798", "merged": true, "mergeCommit": {"oid": "05c8332fa3ea5f9ae31f68b1fc78a29d4565e31e"}, "closed": true, "closedAt": "2020-06-04T15:52:10Z", "author": {"login": "eolivelli"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcimRHuABqjMzNDkwODQ4Mzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoAF30AFqTQyNDU5MDg1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "d045a0aebca1c25b7d1dcbeb360ba6349f597bd0", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/d045a0aebca1c25b7d1dcbeb360ba6349f597bd0", "committedDate": "2020-05-18T20:54:26Z", "message": "Use new BookKeeper Client API and upgrade to 4.9.2 version\n\n    Change log description:\n    BookKeeper 4.8 introduced a new API (org.apache.bookkeeper.client.api).\n    The old API, LedgerHandler, is going to be deprecated officially in next upcoming release (4.11).\n    The new API is based on CompletableFuture facility of the JDK.\n    The new API allows access to the internal refcounted Netty buffer used by BK client.\n\n    Purpose of the change:\n    Fixes #4531.\n\n    Switch from using LedgerHandle to WriteHandle and ReadHandle.\n    I am changing BK version to 4.9.2.\n\n    What the code does\n    Upgrade BookKeeper to 4.9.2 in Java code (not docker images)\n    Replace usages of LedgerHandle with WriteHandle and ReadHandle.\n    Use the new CompletableFuture based API.\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NDE1NTMy", "url": "https://github.com/pravega/pravega/pull/4798#pullrequestreview-414415532", "createdAt": "2020-05-19T12:56:05Z", "commit": {"oid": "d045a0aebca1c25b7d1dcbeb360ba6349f597bd0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NTI1OTkx", "url": "https://github.com/pravega/pravega/pull/4798#pullrequestreview-414525991", "createdAt": "2020-05-19T14:49:02Z", "commit": {"oid": "d045a0aebca1c25b7d1dcbeb360ba6349f597bd0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNDo0OTowMlrOGXkMlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxNDo0OTowMlrOGXkMlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM2MzQ3OQ==", "bodyText": "Why did you remove the try-catch here but not below (at 237)?", "url": "https://github.com/pravega/pravega/pull/4798#discussion_r427363479", "createdAt": "2020-05-19T14:49:02Z", "author": {"login": "andreipaduroiu"}, "path": "segmentstore/storage/impl/src/main/java/io/pravega/segmentstore/storage/impl/bookkeeper/LogReader.java", "diffHunk": "@@ -75,12 +77,7 @@\n     public void close() {\n         if (!this.closed.getAndSet(true)) {\n             if (this.currentLedger != null) {\n-                try {\n-                    Ledgers.close(this.currentLedger.handle);\n-                } catch (DurableDataLogException bkEx) {\n-                    log.error(\"Unable to close LedgerHandle for Ledger {}.\", this.currentLedger.handle.getId(), bkEx);\n-                }\n-\n+                this.currentLedger.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d045a0aebca1c25b7d1dcbeb360ba6349f597bd0"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NjY0ODM1", "url": "https://github.com/pravega/pravega/pull/4798#pullrequestreview-415664835", "createdAt": "2020-05-20T19:51:23Z", "commit": null, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzExNDY5", "url": "https://github.com/pravega/pravega/pull/4798#pullrequestreview-416711469", "createdAt": "2020-05-22T07:44:03Z", "commit": null, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzo0NDowNFrOGZNxYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwODoxMTozNlrOGZOhdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA5MzIxNg==", "bodyText": "I see that codecov is complaining about not all code paths here being exercised. I see a couple of options:\n1- Craft a set of candidate ledgers that force all paths here be exercised via reconcileLedgers.\n2- Increase the visibility of this method and test it in isolation by passing different handles.\n@andreipaduroiu what do you think?", "url": "https://github.com/pravega/pravega/pull/4798#discussion_r429093216", "createdAt": "2020-05-22T07:44:04Z", "author": {"login": "fpj"}, "path": "segmentstore/storage/impl/src/main/java/io/pravega/segmentstore/storage/impl/bookkeeper/DebugLogWrapper.java", "diffHunk": "@@ -243,6 +230,18 @@ public boolean reconcileLedgers(List<LedgerHandle> candidateLedgers) throws Dura\n \n         return changed;\n     }\n+    \n+    private static long getHandleLength(Handle handle) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTEwNTUyNw==", "bodyText": "According to codecov, this path is not being exercised. Could we test this handler directly to exercise all code paths?", "url": "https://github.com/pravega/pravega/pull/4798#discussion_r429105527", "createdAt": "2020-05-22T08:11:36Z", "author": {"login": "fpj"}, "path": "segmentstore/storage/impl/src/main/java/io/pravega/segmentstore/storage/impl/bookkeeper/Ledgers.java", "diffHunk": "@@ -35,13 +41,27 @@\n     static final String PROPERTY_VALUE_APPLICATION = \"Pravega\";\n     static final String PROPERTY_LOG_ID = \"BookKeeperLogId\";\n     static final int NO_LOG_ID = -1;\n-    static final long NO_LEDGER_ID = LedgerHandle.INVALID_LEDGER_ID;\n-    static final long NO_ENTRY_ID = LedgerHandle.INVALID_ENTRY_ID;\n+    static final long NO_LEDGER_ID = -1; // LedgerHandle.INVALID_LEDGER_ID\n+    static final long NO_ENTRY_ID = -1; // LedgerHandle.INVALID_ENTRY_ID\n     /**\n      * How many ledgers to fence out (from the end of the list) when acquiring lock.\n      */\n     static final int MIN_FENCE_LEDGER_COUNT = 2;\n \n+    /**\n+     * Converts exceptions to BKException. Fallback to BKUnexpectedConditionException\n+     * for non BookKeeper exceptions.\n+     */\n+    private static final Function<Throwable, BKException> BK_EXCEPTION_HANDLER = cause -> {\n+        if (cause instanceof BKException) {\n+            return (BKException) cause;\n+        } else {\n+            BKUnexpectedConditionException wrapper = new BKUnexpectedConditionException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": null, "originalPosition": 41}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": null}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5c7e64383a06b8714a7c1f5c7efe41a59f15114", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/b5c7e64383a06b8714a7c1f5c7efe41a59f15114", "committedDate": "2020-05-27T10:04:52Z", "message": "Use new BookKeeper Client API and upgrade to 4.9.2 version\n\n    Change log description:\n    BookKeeper 4.8 introduced a new API (org.apache.bookkeeper.client.api).\n    The old API, LedgerHandler, is going to be deprecated officially in next upcoming release (4.11).\n    The new API is based on CompletableFuture facility of the JDK.\n    The new API allows access to the internal refcounted Netty buffer used by BK client.\n\n    Purpose of the change:\n    Fixes #4531.\n\n    Switch from using LedgerHandle to WriteHandle and ReadHandle.\n    I am changing BK version to 4.9.2.\n\n    What the code does\n    Upgrade BookKeeper to 4.9.2 in Java code (not docker images)\n    Replace usages of LedgerHandle with WriteHandle and ReadHandle.\n    Use the new CompletableFuture based API.\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eac3522a074a2d893ef52f6669b7edc88b03e52c", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/eac3522a074a2d893ef52f6669b7edc88b03e52c", "committedDate": "2020-05-27T10:04:52Z", "message": "Address review comments\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66fc30db6268e460733928660e6f8da6848018e9", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/66fc30db6268e460733928660e6f8da6848018e9", "committedDate": "2020-05-27T10:04:52Z", "message": "Clean up code and fix checkstyle\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac483b6da812cfbced2b29aecf91fd59d439c890", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/ac483b6da812cfbced2b29aecf91fd59d439c890", "committedDate": "2020-05-27T10:04:53Z", "message": "Give 2g of DirectMemory to tests\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": null, "afterCommit": {"oid": "ac483b6da812cfbced2b29aecf91fd59d439c890", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/ac483b6da812cfbced2b29aecf91fd59d439c890", "committedDate": "2020-05-27T10:04:53Z", "message": "Give 2g of DirectMemory to tests\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72a715ad60cf0da86f1795a8230df2bbfd08eeb8", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/72a715ad60cf0da86f1795a8230df2bbfd08eeb8", "committedDate": "2020-05-27T11:13:40Z", "message": "set MaxDirectMemorySize to 4g\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5d7bda6ccd53970fb9c555ee1f21664b9535408", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/d5d7bda6ccd53970fb9c555ee1f21664b9535408", "committedDate": "2020-05-28T12:59:21Z", "message": "Merge branch 'master' into fix/upgrade-to-bk-492"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9672bed32ca32b65b675f6ea1371713953359b5", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/f9672bed32ca32b65b675f6ea1371713953359b5", "committedDate": "2020-05-29T06:51:36Z", "message": "Merge branch 'master' into fix/upgrade-to-bk-492"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ecbfe579104490b7e746c696d3073402bd174c3", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/2ecbfe579104490b7e746c696d3073402bd174c3", "committedDate": "2020-06-01T10:45:03Z", "message": "Merge branch 'master' into fix/upgrade-to-bk-492"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d98242d8865987b55a877f90c0b3d4aa03f7d457", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/d98242d8865987b55a877f90c0b3d4aa03f7d457", "committedDate": "2020-06-02T08:38:36Z", "message": "Merge branch 'master' into fix/upgrade-to-bk-492"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f50e90802d0cd523370dfd8f8ce3c0fa8419a53a", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/f50e90802d0cd523370dfd8f8ce3c0fa8419a53a", "committedDate": "2020-06-03T23:38:43Z", "message": "Merge branch 'master' into fix/upgrade-to-bk-492"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85722f26402dcb9d2999e3a03d2c671d31870c89", "author": {"user": {"login": "RaulGracia", "name": "Ra\u00fal Gracia"}}, "url": "https://github.com/pravega/pravega/commit/85722f26402dcb9d2999e3a03d2c671d31870c89", "committedDate": "2020-06-04T07:52:01Z", "message": "Merge branch 'master' into fix/upgrade-to-bk-492"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ee3cffc9b0d03b1e450c2f86a99939fe5cc7f01", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/0ee3cffc9b0d03b1e450c2f86a99939fe5cc7f01", "committedDate": "2020-06-04T08:25:36Z", "message": "Use JournalSyncData = false in tests and add more debug\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "747e4ac3415826da8cce5a7b18bb5a312aabb4d1", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/747e4ac3415826da8cce5a7b18bb5a312aabb4d1", "committedDate": "2020-06-04T09:32:43Z", "message": "Increase retry timeout and count, in order to make tests less flaky on Jenkins\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6191429999eaa0c8c042fa77fa285b5592e01ad1", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/6191429999eaa0c8c042fa77fa285b5592e01ad1", "committedDate": "2020-06-04T10:04:10Z", "message": "Revert JournalSyncData change\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f75d35b2d0aa153af4cb96786b6da4cb5e211656", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/f75d35b2d0aa153af4cb96786b6da4cb5e211656", "committedDate": "2020-06-04T13:18:52Z", "message": "Add tests\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42dc8b8d107224fd0e493a8c77719ec3a773c545", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/42dc8b8d107224fd0e493a8c77719ec3a773c545", "committedDate": "2020-06-04T13:36:07Z", "message": "remove useless file\n\nSigned-off-by: Enrico Olivelli <eolivelli@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "497c6575f17d3b594144f0d61fba30c57feedbda", "author": {"user": {"login": "eolivelli", "name": "Enrico Olivelli"}}, "url": "https://github.com/pravega/pravega/commit/497c6575f17d3b594144f0d61fba30c57feedbda", "committedDate": "2020-06-04T13:36:50Z", "message": "Merge branch 'master' into fix/upgrade-to-bk-492"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NTkwODU1", "url": "https://github.com/pravega/pravega/pull/4798#pullrequestreview-424590855", "createdAt": "2020-06-04T15:49:28Z", "commit": {"oid": "497c6575f17d3b594144f0d61fba30c57feedbda"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3487, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}