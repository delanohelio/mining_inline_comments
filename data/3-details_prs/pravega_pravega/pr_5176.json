{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0NjczMzY0", "number": 5176, "title": "Issue 5171: (Bugfix) Ensure ByteStreamReader can read from deleted and recreated streams", "bodyText": "Change log description\nEnsure ByteStreamReader can read from deleted and recreated streams\nPurpose of the change\nFixes #5171\nWhat the code does\n\nFetch the segment details from the controller instead of reading directly from segment 0.\n\nHow to verify it\nAll the existing and newly added tests should continue to pass.", "createdAt": "2020-09-11T05:46:52Z", "url": "https://github.com/pravega/pravega/pull/5176", "merged": true, "mergeCommit": {"oid": "5999c287b2dcc5306bbd3bbd4e0d51ec0ddc0667"}, "closed": true, "closedAt": "2020-09-18T04:03:11Z", "author": {"login": "shrids"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHuvUCgH2gAyNDg0NjczMzY0OmYyMTMyOTY3NWRlNjkwNWZiYjNiNWNkNTVmYTA1Y2UwM2M0NGVjNjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJdO0NgH2gAyNDg0NjczMzY0OjgwMTA5Y2U5ODkxNWI0ZmJiMGE3MzNjMGI5OGU4ZmU1NmM4NjBiNWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f21329675de6905fbb3b5cd55fa05ce03c44ec67", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/f21329675de6905fbb3b5cd55fa05ce03c44ec67", "committedDate": "2020-09-11T05:42:01Z", "message": "fix the segment fetch logic for readers.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b846cc98ed33d699a0769e9f4853541ff44e3fb", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/4b846cc98ed33d699a0769e9f4853541ff44e3fb", "committedDate": "2020-09-11T06:29:55Z", "message": "Stream recreate tests.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NTEwMDE2", "url": "https://github.com/pravega/pravega/pull/5176#pullrequestreview-486510016", "createdAt": "2020-09-11T06:36:49Z", "commit": {"oid": "4b846cc98ed33d699a0769e9f4853541ff44e3fb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNjozNjo0OVrOHQQKZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNjozNjo0OVrOHQQKZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgwNDA2OA==", "bodyText": "please use Java conventions for method names:\nverifyByteClientReadWrite", "url": "https://github.com/pravega/pravega/pull/5176#discussion_r486804068", "createdAt": "2020-09-11T06:36:49Z", "author": {"login": "eolivelli"}, "path": "test/integration/src/test/java/io/pravega/test/integration/ByteStreamTest.java", "diffHunk": "@@ -280,7 +281,47 @@ public void testBlockingRead() throws IOException {\n         writer.closeAndSeal();\n         assertEquals(-1, reader.read());\n     }\n-    \n+\n+    @Test(timeout = 30000)\n+    public void testRecreateStream() {\n+        String scope = \"ByteStreamTest\";\n+        String stream = \"stream\";\n+\n+        StreamConfiguration config = StreamConfiguration.builder().build();\n+        @Cleanup\n+        StreamManager streamManager = new StreamManagerImpl(controller, null);\n+        // create a scope\n+        assertTrue(\"Create scope failed\", streamManager.createScope(scope));\n+        // create a stream\n+        assertTrue(\"Create stream failed\", streamManager.createStream(scope, stream, config));\n+        // verify read and write.\n+        verify_byte_client_read_write(scope, stream);\n+        // delete the stream and recreate\n+        assertTrue(\"Seal stream operation failed\", streamManager.sealStream(scope, stream));\n+        assertTrue(\"Delete Stream operation failed\", streamManager.deleteStream(scope, stream));\n+        assertTrue(\"Recreate stream failed\", streamManager.createStream(scope, stream, config));\n+        // verify read and write.\n+        verify_byte_client_read_write(scope, stream);\n+    }\n+\n+    private void verify_byte_client_read_write(String scope, String stream) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b846cc98ed33d699a0769e9f4853541ff44e3fb"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03b742dc755389c157e778d91807724846ab8740", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/03b742dc755389c157e778d91807724846ab8740", "committedDate": "2020-09-11T06:53:19Z", "message": "CR Change: fix naming convention.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NTE5MDM5", "url": "https://github.com/pravega/pravega/pull/5176#pullrequestreview-486519039", "createdAt": "2020-09-11T06:54:37Z", "commit": {"oid": "03b742dc755389c157e778d91807724846ab8740"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9a21db4581c23dbe6f2d1c350c616452153d64a", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/d9a21db4581c23dbe6f2d1c350c616452153d64a", "committedDate": "2020-09-11T09:17:16Z", "message": "Merge branch 'master' into issue-5171"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a011b9592ab76c142693c9e55aac303f24b2cfcf", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/a011b9592ab76c142693c9e55aac303f24b2cfcf", "committedDate": "2020-09-11T10:00:10Z", "message": "Improve test coverage.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2ODI3OTAw", "url": "https://github.com/pravega/pravega/pull/5176#pullrequestreview-486827900", "createdAt": "2020-09-11T13:55:02Z", "commit": {"oid": "a011b9592ab76c142693c9e55aac303f24b2cfcf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo1NTowM1rOHQf3tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo1NTowM1rOHQf3tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MTQzMA==", "bodyText": "If we want a version of this fix to go into 0.7.2, we will have to use segments.getSegments().size() here.", "url": "https://github.com/pravega/pravega/pull/5176#discussion_r487061430", "createdAt": "2020-09-11T13:55:03Z", "author": {"login": "derekm"}, "path": "client/src/main/java/io/pravega/client/byteStream/impl/ByteStreamClientImpl.java", "diffHunk": "@@ -48,16 +48,11 @@\n \n     @Override\n     public ByteStreamReader createByteStreamReader(String streamName) {\n-        return createByteStreamReaders(new Segment(scope, streamName, 0));\n-    }\n-\n-    private ByteStreamReader createByteStreamReaders(Segment segment) {\n-        String delegationToken = Futures.getAndHandleExceptions(controller.getOrRefreshDelegationTokenFor(segment.getScope(),\n-                                                                                                          segment.getStream()\n-                                                                                                                 .getStreamName()),\n-                                                                RuntimeException::new);\n-\n-        DelegationTokenProvider tokenProvider = DelegationTokenProviderFactory.create(delegationToken, controller, segment);\n+        StreamSegments segments = Futures.getThrowingException(controller.getCurrentSegments(scope, streamName));\n+        Preconditions.checkState(segments.getNumberOfSegments() > 0, \"Stream is sealed\");\n+        Preconditions.checkState(segments.getNumberOfSegments() == 1, \"Stream is configured with more than one segment\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a011b9592ab76c142693c9e55aac303f24b2cfcf"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2ODI5Nzcy", "url": "https://github.com/pravega/pravega/pull/5176#pullrequestreview-486829772", "createdAt": "2020-09-11T13:57:08Z", "commit": {"oid": "a011b9592ab76c142693c9e55aac303f24b2cfcf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ceb2ae9c833d1fd55165a6878e10fb07e66177b6", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/ceb2ae9c833d1fd55165a6878e10fb07e66177b6", "committedDate": "2020-09-14T14:25:05Z", "message": "Merge branch 'master' into issue-5171"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MjM3ODA0", "url": "https://github.com/pravega/pravega/pull/5176#pullrequestreview-488237804", "createdAt": "2020-09-15T00:14:58Z", "commit": {"oid": "ceb2ae9c833d1fd55165a6878e10fb07e66177b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDoxNDo1OFrOHRr49A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQwMDoxNDo1OFrOHRr49A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMwNjkzMg==", "bodyText": "Why is it an error to create a reader on a sealed stream?", "url": "https://github.com/pravega/pravega/pull/5176#discussion_r488306932", "createdAt": "2020-09-15T00:14:58Z", "author": {"login": "tkaitchuck"}, "path": "client/src/main/java/io/pravega/client/byteStream/impl/ByteStreamClientImpl.java", "diffHunk": "@@ -48,16 +48,11 @@\n \n     @Override\n     public ByteStreamReader createByteStreamReader(String streamName) {\n-        return createByteStreamReaders(new Segment(scope, streamName, 0));\n-    }\n-\n-    private ByteStreamReader createByteStreamReaders(Segment segment) {\n-        String delegationToken = Futures.getAndHandleExceptions(controller.getOrRefreshDelegationTokenFor(segment.getScope(),\n-                                                                                                          segment.getStream()\n-                                                                                                                 .getStreamName()),\n-                                                                RuntimeException::new);\n-\n-        DelegationTokenProvider tokenProvider = DelegationTokenProviderFactory.create(delegationToken, controller, segment);\n+        StreamSegments segments = Futures.getThrowingException(controller.getCurrentSegments(scope, streamName));\n+        Preconditions.checkState(segments.getNumberOfSegments() > 0, \"Stream is sealed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceb2ae9c833d1fd55165a6878e10fb07e66177b6"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "595f1ccbe42d213ef37a999447052b6f97d13aec", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/595f1ccbe42d213ef37a999447052b6f97d13aec", "committedDate": "2020-09-15T00:16:20Z", "message": "Merge branch 'master' into issue-5171"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1ced4c2e5678c4e958aef3d34fc72a765ce9b19", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/c1ced4c2e5678c4e958aef3d34fc72a765ce9b19", "committedDate": "2020-09-15T04:12:10Z", "message": "CR Changes: Sealed stream can be read .\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "527136b8683698a0ddb8da6aa1cecb22ef73a733", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/527136b8683698a0ddb8da6aa1cecb22ef73a733", "committedDate": "2020-09-15T04:16:10Z", "message": "Improve junit.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb9a50d76b7f215f59b2a57130a16a442cefdadc", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/cb9a50d76b7f215f59b2a57130a16a442cefdadc", "committedDate": "2020-09-15T04:19:21Z", "message": "Merge branch 'master' into issue-5171"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41b8a54ed2a6782193f423ad665fffde0bdcd8b1", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/41b8a54ed2a6782193f423ad665fffde0bdcd8b1", "committedDate": "2020-09-15T05:38:14Z", "message": "Merge branch 'master' into issue-5171"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NzMwNTAw", "url": "https://github.com/pravega/pravega/pull/5176#pullrequestreview-488730500", "createdAt": "2020-09-15T14:15:11Z", "commit": {"oid": "41b8a54ed2a6782193f423ad665fffde0bdcd8b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNDoxNToxMVrOHSEC2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNDoxNToxMVrOHSEC2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODcwMjY4Mw==", "bodyText": "Will this correctly handle truncated streams? Is timestamp here the same as epoch?", "url": "https://github.com/pravega/pravega/pull/5176#discussion_r488702683", "createdAt": "2020-09-15T14:15:11Z", "author": {"login": "derekm"}, "path": "client/src/main/java/io/pravega/client/byteStream/impl/ByteStreamClientImpl.java", "diffHunk": "@@ -48,7 +51,11 @@\n \n     @Override\n     public ByteStreamReader createByteStreamReader(String streamName) {\n-        return createByteStreamReaders(new Segment(scope, streamName, 0));\n+        // Fetch the segments pointing to the current HEAD of the stream.\n+        Map<Segment, Long> segments = Futures.getThrowingException(controller.getSegmentsAtTime(Stream.of(scope, streamName), 0L));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41b8a54ed2a6782193f423ad665fffde0bdcd8b1"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4OTQzNDc4", "url": "https://github.com/pravega/pravega/pull/5176#pullrequestreview-488943478", "createdAt": "2020-09-15T18:15:03Z", "commit": {"oid": "41b8a54ed2a6782193f423ad665fffde0bdcd8b1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxODoxNTowNFrOHSOO1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxODoxNTowNFrOHSOO1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg2OTU5MQ==", "bodyText": "For debug-ability it would be good to have two different errors or include the size in the error message.", "url": "https://github.com/pravega/pravega/pull/5176#discussion_r488869591", "createdAt": "2020-09-15T18:15:04Z", "author": {"login": "tkaitchuck"}, "path": "client/src/main/java/io/pravega/client/byteStream/impl/ByteStreamClientImpl.java", "diffHunk": "@@ -48,7 +51,11 @@\n \n     @Override\n     public ByteStreamReader createByteStreamReader(String streamName) {\n-        return createByteStreamReaders(new Segment(scope, streamName, 0));\n+        // Fetch the segments pointing to the current HEAD of the stream.\n+        Map<Segment, Long> segments = Futures.getThrowingException(controller.getSegmentsAtTime(Stream.of(scope, streamName), 0L));\n+        Preconditions.checkState(segments.size() == 1, \"Stream is configured with more than one segment or has none\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41b8a54ed2a6782193f423ad665fffde0bdcd8b1"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7049e542d2bcc0f8bbb3d4e8f98d6503ab4c43e0", "author": {"user": {"login": "tkaitchuck", "name": "Tom Kaitchuck"}}, "url": "https://github.com/pravega/pravega/commit/7049e542d2bcc0f8bbb3d4e8f98d6503ab4c43e0", "committedDate": "2020-09-15T18:15:19Z", "message": "Merge branch 'master' into issue-5171"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ea73fbcf884c4e2b46caede28ee39f8dd8f12b8", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/4ea73fbcf884c4e2b46caede28ee39f8dd8f12b8", "committedDate": "2020-09-16T04:57:27Z", "message": "CR Changes: Improve error.\n\nSigned-off-by: Sandeep <sandeep.shridhar@emc.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80109ce98915b4fbb0a733c0b98e8fe56c860b5a", "author": {"user": {"login": "shrids", "name": "Sandeep"}}, "url": "https://github.com/pravega/pravega/commit/80109ce98915b4fbb0a733c0b98e8fe56c860b5a", "committedDate": "2020-09-16T14:25:59Z", "message": "Merge branch 'master' into issue-5171"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3863, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}