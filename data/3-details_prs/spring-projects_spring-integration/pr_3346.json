{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxMzUyOTIy", "number": 3346, "title": "GH-3344: Treat kotlin.Unit return as null in MMIH", "bodyText": "Fixes #3344\nWhen function lambda doesn't return anything (e.g. a void method call is the last one),\nKotlin produces a kotlin.Unit instance as a return value which is not null and produced\nas a reply message payload.\n\nFix MessagingMethodInvokerHelper to treat a kotlin.Unit as null for reply\nmaking Kotlin lambdas working the same way as Java lambdas when we don't return anything\nfrom from there\n\nCherry-pick to 5.3.x", "createdAt": "2020-07-17T18:39:33Z", "url": "https://github.com/spring-projects/spring-integration/pull/3346", "merged": true, "mergeCommit": {"oid": "6a865b55b9155a156feca0a43baf8a61a68ad0fd"}, "closed": true, "closedAt": "2020-07-20T17:51:55Z", "author": {"login": "artembilan"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc14SwFAH2gAyNDUxMzUyOTIyOmU2OWY0ZDM3NGU0MjJlZDgzZWM2NDQ5ZTFhYzAzNTk5NWUzMGE3Y2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc21P73AH2gAyNDUxMzUyOTIyOmRiNjc4NmM0NjJiNzQyNWY3Yjg2NjQ2MTUxMWY0MThhZDdjMjMzNDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e69f4d374e422ed83ec6449e1ac035995e30a7ce", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/e69f4d374e422ed83ec6449e1ac035995e30a7ce", "committedDate": "2020-07-17T18:39:14Z", "message": "GH-3344: Treat kotlin.Unit return as null in MMIH\n\nFixes https://github.com/spring-projects/spring-integration/issues/3344\n\nWhen function lambda doesn't return anything (e.g. a `void` method call is the last one),\nKotlin produces a `kotlin.Unit` instance as a return value which is not null and produced\nas a reply message payload.\n\n* Fix `MessagingMethodInvokerHelper` to treat a `kotlin.Unit` as `null` for reply\nmaking Kotlin lambdas working the same way as Java lambdas when we don't return anything\nfrom from there\n\n**Cherry-pick to `5.3.x`**"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNjg2NDAw", "url": "https://github.com/spring-projects/spring-integration/pull/3346#pullrequestreview-451686400", "createdAt": "2020-07-20T14:55:44Z", "commit": {"oid": "e69f4d374e422ed83ec6449e1ac035995e30a7ce"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDo1NTo0NFrOG0RXtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDo1NTo0NFrOG0RXtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQ2MzczNA==", "bodyText": "Can we not capture this condition as a final boolean by checking the return type in a CTOR (to avoid running this code on every non-null return)?", "url": "https://github.com/spring-projects/spring-integration/pull/3346#discussion_r457463734", "createdAt": "2020-07-20T14:55:44Z", "author": {"login": "garyrussell"}, "path": "spring-integration-core/src/main/java/org/springframework/integration/handler/support/MessagingMethodInvokerHelper.java", "diffHunk": "@@ -1093,13 +1094,18 @@ void setInvocableHandlerMethod(InvocableHandlerMethod newInvocableHandlerMethod)\n \t\t\tthis.invocableHandlerMethod = newInvocableHandlerMethod;\n \t\t}\n \n+\t\t@Nullable\n \t\tpublic Object invoke(ParametersWrapper parameters) {\n \t\t\tMessage<?> message = parameters.getMessage();\n \t\t\tif (this.canProcessMessageList) {\n \t\t\t\tmessage = new MutableMessage<>(parameters.getMessages(), parameters.getHeaders());\n \t\t\t}\n \t\t\ttry {\n-\t\t\t\treturn this.invocableHandlerMethod.invoke(message);\n+\t\t\t\tObject result = this.invocableHandlerMethod.invoke(message);\n+\t\t\t\tif (result != null && result.getClass().getName().equals(\"kotlin.Unit\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e69f4d374e422ed83ec6449e1ac035995e30a7ce"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14caf0fdf7056cc54c915f58bb1e03063186d344", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/14caf0fdf7056cc54c915f58bb1e03063186d344", "committedDate": "2020-07-20T16:53:37Z", "message": "* Introduce `ClassUtils.isKotlinUnit(Class)` API;\nuse it in the `MessagingMethodInvokerHelper` instead of\n`.getName().equals()`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxODIxNjE3", "url": "https://github.com/spring-projects/spring-integration/pull/3346#pullrequestreview-451821617", "createdAt": "2020-07-20T17:39:55Z", "commit": {"oid": "14caf0fdf7056cc54c915f58bb1e03063186d344"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzozOTo1NVrOG0Yjrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNzozOTo1NVrOG0Yjrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzU4MTQ4Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t * @since 5.4\n          \n          \n            \n            \t * @since 5.3.2", "url": "https://github.com/spring-projects/spring-integration/pull/3346#discussion_r457581487", "createdAt": "2020-07-20T17:39:55Z", "author": {"login": "artembilan"}, "path": "spring-integration-core/src/main/java/org/springframework/integration/util/ClassUtils.java", "diffHunk": "@@ -247,4 +264,14 @@ public static boolean isKotlinFaction1(Class<?> aClass) {\n \t\treturn KOTLIN_FUNCTION_1_CLASS != null && KOTLIN_FUNCTION_1_CLASS.isAssignableFrom(aClass);\n \t}\n \n+\t/**\n+\t * Check if class is {@code kotlin.Unit}.\n+\t * @param aClass the {@link Class} to check.\n+\t * @return true if class is a {@code kotlin.Unit} implementation.\n+\t * @since 5.4", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "14caf0fdf7056cc54c915f58bb1e03063186d344"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db6786c462b7425f7b866461511f418ad7c23347", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/db6786c462b7425f7b866461511f418ad7c23347", "committedDate": "2020-07-20T17:40:22Z", "message": "* Fix since on new `isKotlinUnit()` API"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 94, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}