{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzOTY4MjAw", "number": 3380, "title": "GH-3370: Remove synchronized from RemoteFileUtils", "bodyText": "Fixes #3370\nThe synchronized on the RemoteFileUtils.makeDirectories() makes an application too\nslow, especially when we deal with different paths in different sessions\n\nRemove the synchronized from that method and rework SftpSession.mkdir()\nto return false when \"A file cannot be created if it already exists\" exception\nis thrown from the server.\nEssentially make an exists() call to be sure that an exception is really related\nto \"file-already-exists\" answer from the server\n\nCherry-pick to 5.3.x, 5.2.x & 4.3.x", "createdAt": "2020-09-10T15:00:34Z", "url": "https://github.com/spring-projects/spring-integration/pull/3380", "merged": true, "mergeCommit": {"oid": "47cae4670f73fb0842e262b00ce6f73d1c5181eb"}, "closed": true, "closedAt": "2020-09-10T17:46:58Z", "author": {"login": "artembilan"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHiH6NgH2gAyNDgzOTY4MjAwOmU4ZTY0ODNmZTBlYmU5N2NhNjUyMzAyZjMwY2QyYmJhZjkxYTgwOWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHj_S1gH2gAyNDgzOTY4MjAwOjgxODcxYjU3Y2FiYThjMjk2ZDZhNzI1NzIwMTE1ODE5YmM5MGM1MGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e8e6483fe0ebe97ca652302f30cd2bbaf91a809c", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/e8e6483fe0ebe97ca652302f30cd2bbaf91a809c", "committedDate": "2020-09-10T15:00:07Z", "message": "GH-3370: Remove synchronized from RemoteFileUtils\n\nFixes https://github.com/spring-projects/spring-integration/issues/3370\n\nThe `synchronized` on the `RemoteFileUtils.makeDirectories()` makes an application too\n slow, especially when we deal with different paths in different sessions\n\n* Remove the `synchronized` from that method and rework `SftpSession.mkdir()`\nto return `false` when \"A file cannot be created if it already exists\" exception\nis thrown from the server.\nEssentially make an `exists()` call to be sure that an exception is really related\nto \"file-already-exists\" answer from the server\n\n**Cherry-pick to 5.3.x, 5.2.x & 4.3.x**"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDM2MjQx", "url": "https://github.com/spring-projects/spring-integration/pull/3380#pullrequestreview-486036241", "createdAt": "2020-09-10T15:07:50Z", "commit": {"oid": "e8e6483fe0ebe97ca652302f30cd2bbaf91a809c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNTowNzo1MFrOHP4sig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNTowNzo1MFrOHP4sig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQxOTU5NA==", "bodyText": "I think this should return true since it was a race condition. RFU currently discards the result; I think it should check it and throw an exception if false - see FtpSession where we simply delegate to the client.", "url": "https://github.com/spring-projects/spring-integration/pull/3380#discussion_r486419594", "createdAt": "2020-09-10T15:07:50Z", "author": {"login": "garyrussell"}, "path": "spring-integration-sftp/src/main/java/org/springframework/integration/sftp/session/SftpSession.java", "diffHunk": "@@ -252,8 +252,13 @@ public boolean mkdir(String remoteDirectory) throws IOException {\n \t\ttry {\n \t\t\tthis.channel.mkdir(remoteDirectory);\n \t\t}\n-\t\tcatch (SftpException e) {\n-\t\t\tthrow new NestedIOException(\"failed to create remote directory '\" + remoteDirectory + \"'.\", e);\n+\t\tcatch (SftpException ex) {\n+\t\t\tif (ex.id == ChannelSftp.SSH_FX_FAILURE && exists(remoteDirectory)) {\n+\t\t\t\treturn false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8e6483fe0ebe97ca652302f30cd2bbaf91a809c"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59e7871ace1f3b80917056761b8d08eb03adb7b7", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/59e7871ace1f3b80917056761b8d08eb03adb7b7", "committedDate": "2020-09-10T15:11:54Z", "message": "* Re-throw an exception in the `SftpSession.mkdir()`\nwhen error code is not `4` or remote dir does not exist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7ccb1324bb44e9a227971a622ea408157d9ff24", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/b7ccb1324bb44e9a227971a622ea408157d9ff24", "committedDate": "2020-09-10T15:30:54Z", "message": "* Check `session.mkdir()` result in the\n`RemoteFileUtils` to throw an `IOException` when `false`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81871b57caba8c296d6a725720115819bc90c50f", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/81871b57caba8c296d6a725720115819bc90c50f", "committedDate": "2020-09-10T17:10:31Z", "message": "* Fix mock test to return `true` for `mkdir` instead of `null`"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 116, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}