{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2ODA2MjA3", "number": 3423, "title": "Rely on `MProducerSupport.active` for `Flux`", "bodyText": "Fix MessageProducerSupport to extract an active flag and set it before\nisRunning - the Flux subscription relies on the takeWhile()\nwhere in case of autoStartup = false we will never start consume because\nit is set to true already after doStart()\nRefactor all the MessageProducerSupport implementation with similar\nactive state to use already one from the super class\n\nCherry-pick to 5.3.x", "createdAt": "2020-11-06T15:12:03Z", "url": "https://github.com/spring-projects/spring-integration/pull/3423", "merged": true, "mergeCommit": {"oid": "0331933c168f9096195999592a7f169d39f238d2"}, "closed": true, "closedAt": "2020-11-06T18:51:04Z", "author": {"login": "artembilan"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ4c6EAH2gAyNTE2ODA2MjA3OmFlOGE2ZmNlZDlkODM2M2UyYmNjMTE0NmNkYzk5Y2MwYzMwMzFkNDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ7ll0AFqTUyNTQwOTQzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ae8a6fced9d8363e2bcc1146cdc99cc0c3031d40", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/ae8a6fced9d8363e2bcc1146cdc99cc0c3031d40", "committedDate": "2020-11-06T15:11:36Z", "message": "Rely on `MProducerSupport.active` for `Flux`\n\n* Fix `MessageProducerSupport` to extract an `active` flag and set it before\n`isRunning` - the `Flux` subscription relies on the `takeWhile()`\nwhere in case of `autoStartup = false` we will never start consume because\nit is set to `true` already after `doStart()`\n* Refactor all the `MessageProducerSupport` implementation with similar\n`active` state to use already one from the super class\n\n**Cherry-pick to 5.3.x**"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75f96592885f852598b0ea5f6d7829ab14a0ee81", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/75f96592885f852598b0ea5f6d7829ab14a0ee81", "committedDate": "2020-11-06T15:25:11Z", "message": "* Remove `MessageProducerSupport.setActive()`\nto not let to mutate it from the implementations\n* Set `active` to `false` in the `destroy()`\n* Clean up and fix typos in the affected `JmsMessageDrivenEndpoint`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MjUyMTE3", "url": "https://github.com/spring-projects/spring-integration/pull/3423#pullrequestreview-525252117", "createdAt": "2020-11-06T15:22:40Z", "commit": {"oid": "ae8a6fced9d8363e2bcc1146cdc99cc0c3031d40"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNToyMjo0MFrOHuyXGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNToyOTozOVrOHuypGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgyMTY1Nw==", "bodyText": "Javadocs for these methods needs polishing. Subclasses MUST call super (which is a bit brittle I think).", "url": "https://github.com/spring-projects/spring-integration/pull/3423#discussion_r518821657", "createdAt": "2020-11-06T15:22:40Z", "author": {"login": "garyrussell"}, "path": "spring-integration-core/src/main/java/org/springframework/integration/endpoint/MessageProducerSupport.java", "diffHunk": "@@ -196,6 +207,7 @@ protected void doStart() {\n \t */\n \t@Override\n \tprotected void doStop() {\n+\t\tsetActive(false);\n \t}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae8a6fced9d8363e2bcc1146cdc99cc0c3031d40"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODgyNjI2Nw==", "bodyText": "It's not clear why this is different; both flags are set to true in start().", "url": "https://github.com/spring-projects/spring-integration/pull/3423#discussion_r518826267", "createdAt": "2020-11-06T15:29:39Z", "author": {"login": "garyrussell"}, "path": "spring-integration-core/src/main/java/org/springframework/integration/endpoint/MessageProducerSupport.java", "diffHunk": "@@ -222,7 +234,7 @@ protected void subscribeToPublisher(Publisher<? extends Message<?>> publisher) {\n \t\t\t\t\t\t.map(this::trackMessageIfAny)\n \t\t\t\t\t\t.doOnComplete(this::stop)\n \t\t\t\t\t\t.doOnCancel(this::stop)\n-\t\t\t\t\t\t.takeWhile((message) -> isRunning());\n+\t\t\t\t\t\t.takeWhile((message) -> isActive());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae8a6fced9d8363e2bcc1146cdc99cc0c3031d40"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efc9608c925eff78566cf41126dedef7f4be1693", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/efc9608c925eff78566cf41126dedef7f4be1693", "committedDate": "2020-11-06T17:13:02Z", "message": "* Pull `active` flag down to the `AbstractEndpoint`\n* Set `active = true` in the `start()` before calling `doStart()`\n* Do same for `active = false` in the `stop()`\n* Clean up `AbstractEndpoint` impls to not call `doStart/doStop` for nothing\n* Refactor endpoints to rely on the `active` state from the `AbstractEndpoint`\nnot their own"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NDA5NDM5", "url": "https://github.com/spring-projects/spring-integration/pull/3423#pullrequestreview-525409439", "createdAt": "2020-11-06T18:50:48Z", "commit": {"oid": "efc9608c925eff78566cf41126dedef7f4be1693"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 143, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}