{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3ODk0MDI1", "number": 3349, "title": "Add gauges for queue channel size", "bodyText": "The QueueChannel provides a current size and remaining capacity metrics\n\nAdd Micrometer gauges into QueueChannel to expose the current values\nof the size and remaining capacity\n\nCherry-pick to 5.3.x, 5.2.x & 5.1.x", "createdAt": "2020-07-28T15:41:46Z", "url": "https://github.com/spring-projects/spring-integration/pull/3349", "merged": true, "mergeCommit": {"oid": "f23f3ea63de0f37471b8f2f2b2d267b8ab22ceac"}, "closed": true, "closedAt": "2020-07-28T20:59:36Z", "author": {"login": "artembilan"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5YV2OgH2gAyNDU3ODk0MDI1OjU1OGRlYTQ1YWIzYWVkZmExOGFjYWI0OTViNWQ3NTVhZDc0YTc3M2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5mk-ugFqTQ1NzI5NDgxMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "558dea45ab3aedfa18acab495b5d755ad74a773c", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/558dea45ab3aedfa18acab495b5d755ad74a773c", "committedDate": "2020-07-28T15:41:21Z", "message": "Add gauges for queue channel size\n\nThe `QueueChannel` provides a current size and remaining capacity metrics\n\n* Add Micrometer gauges into `QueueChannel` to expose the current values\nof the size and remaining capacity\n\n**Cherry-pick to 5.3.x, 5.2.x & 5.1.x**"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e14ef35f101d8189dc6af37e0fefb8bf371dc579", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/e14ef35f101d8189dc6af37e0fefb8bf371dc579", "committedDate": "2020-07-28T16:21:56Z", "message": "* Revert `@SuppressWarnings(\"unchecked\")` for test\n* Document new gauges for queue channel"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "101387132c2056b3a1b3af7fa32cd000330de165", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/101387132c2056b3a1b3af7fa32cd000330de165", "committedDate": "2020-07-28T19:42:14Z", "message": "* Fix IntegrationManagementConfigurer for NPE on `metricsCaptor`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTgxMDQy", "url": "https://github.com/spring-projects/spring-integration/pull/3349#pullrequestreview-456981042", "createdAt": "2020-07-28T20:19:57Z", "commit": {"oid": "101387132c2056b3a1b3af7fa32cd000330de165"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDoxOTo1OFrOG4dVUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDoxOTo1OFrOG4dVUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg1NDAzNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\t.description(\"The remaining.capacity of queue channel\")\n          \n          \n            \n            \t\t\t\t\t\t.description(\"The remaining capacity of the queue channel\")", "url": "https://github.com/spring-projects/spring-integration/pull/3349#discussion_r461854034", "createdAt": "2020-07-28T20:19:58Z", "author": {"login": "micheljung"}, "path": "spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java", "diffHunk": "@@ -79,6 +87,26 @@ public QueueChannel() {\n \t\tthis(new LinkedBlockingQueue<>());\n \t}\n \n+\t@Override\n+\tpublic void registerMetricsCaptor(MetricsCaptor metricsCaptor) {\n+\t\tsuper.registerMetricsCaptor(metricsCaptor);\n+\t\tthis.sizeGauge =\n+\t\t\t\tmetricsCaptor.gaugeBuilder(\"spring.integration.channel.queue.size\", this,\n+\t\t\t\t\t\t(channel) -> getQueueSize())\n+\t\t\t\t\t\t.tag(\"name\", getComponentName() == null ? \"unknown\" : getComponentName())\n+\t\t\t\t\t\t.tag(\"type\", \"channel\")\n+\t\t\t\t\t\t.description(\"The size of queue channel\")\n+\t\t\t\t\t\t.build();\n+\n+\t\tthis.remainingCapacityGauge =\n+\t\t\t\tmetricsCaptor.gaugeBuilder(\"spring.integration.channel.queue.remaining.capacity\", this,\n+\t\t\t\t\t\t(channel) -> getRemainingCapacity())\n+\t\t\t\t\t\t.tag(\"name\", getComponentName() == null ? \"unknown\" : getComponentName())\n+\t\t\t\t\t\t.tag(\"type\", \"channel\")\n+\t\t\t\t\t\t.description(\"The remaining.capacity of queue channel\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "101387132c2056b3a1b3af7fa32cd000330de165"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTgyNjY1", "url": "https://github.com/spring-projects/spring-integration/pull/3349#pullrequestreview-456982665", "createdAt": "2020-07-28T20:22:30Z", "commit": {"oid": "101387132c2056b3a1b3af7fa32cd000330de165"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDoyMjozMVrOG4daZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDoyMjozMVrOG4daZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg1NTMzMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\t\t.description(\"The size of queue channel\")\n          \n          \n            \n            \t\t\t\t\t\t.description(\"The size of the queue channel\")", "url": "https://github.com/spring-projects/spring-integration/pull/3349#discussion_r461855333", "createdAt": "2020-07-28T20:22:31Z", "author": {"login": "artembilan"}, "path": "spring-integration-core/src/main/java/org/springframework/integration/channel/QueueChannel.java", "diffHunk": "@@ -79,6 +87,26 @@ public QueueChannel() {\n \t\tthis(new LinkedBlockingQueue<>());\n \t}\n \n+\t@Override\n+\tpublic void registerMetricsCaptor(MetricsCaptor metricsCaptor) {\n+\t\tsuper.registerMetricsCaptor(metricsCaptor);\n+\t\tthis.sizeGauge =\n+\t\t\t\tmetricsCaptor.gaugeBuilder(\"spring.integration.channel.queue.size\", this,\n+\t\t\t\t\t\t(channel) -> getQueueSize())\n+\t\t\t\t\t\t.tag(\"name\", getComponentName() == null ? \"unknown\" : getComponentName())\n+\t\t\t\t\t\t.tag(\"type\", \"channel\")\n+\t\t\t\t\t\t.description(\"The size of queue channel\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "101387132c2056b3a1b3af7fa32cd000330de165"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79038289ab4bc2e0baaff68b8c98def825129a30", "author": {"user": {"login": "artembilan", "name": "Artem Bilan"}}, "url": "https://github.com/spring-projects/spring-integration/commit/79038289ab4bc2e0baaff68b8c98def825129a30", "committedDate": "2020-07-28T20:23:05Z", "message": "Fix wording in meter descriptions\n\nCo-authored-by: Michel Jung <michel.jung89@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3Mjk0ODEz", "url": "https://github.com/spring-projects/spring-integration/pull/3349#pullrequestreview-457294813", "createdAt": "2020-07-29T08:16:32Z", "commit": {"oid": "79038289ab4bc2e0baaff68b8c98def825129a30"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwODoxNjozM1rOG4tpsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwODoxNjozM1rOG4tpsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEyMTM5Mg==", "bodyText": "@artembilan\nIsn't this misleading? In the 5.1.x branch this might be true but 5.2.8.RELEASE and 5.3.2.RELEASE don't have this feature.", "url": "https://github.com/spring-projects/spring-integration/pull/3349#discussion_r462121392", "createdAt": "2020-07-29T08:16:33Z", "author": {"login": "micheljung"}, "path": "src/reference/asciidoc/metrics.adoc", "diffHunk": "@@ -165,6 +165,20 @@ It is possible to customize the names and tags of `Meters` created by integratio\n The https://github.com/spring-projects/spring-integration/blob/master/spring-integration-core/src/test/java/org/springframework/integration/support/management/micrometer/MicrometerCustomMetricsTests.java[MicrometerCustomMetricsTests] test case shows a simple example of how to do that.\n You can also further customize the meters by overloading the `build()` methods on builder subclasses.\n \n+Starting with version 5.1.13, the `QueueChannel` exposes Micrometer gauges for queue size and remaining capacity:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79038289ab4bc2e0baaff68b8c98def825129a30"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 98, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}