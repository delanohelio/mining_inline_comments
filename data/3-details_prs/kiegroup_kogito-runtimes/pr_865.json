{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0NTQ5MTY5", "number": 865, "title": "KOGITO-3716 Allow automatic close of staging repo", "bodyText": "https://issues.redhat.com/browse/KOGITO-3716\nDependent PRs:\n\nkiegroup/kogito-pipelines#91\n#865\nkiegroup/optaplanner#1010\nkiegroup/kogito-examples#435\nkiegroup/jenkins-pipeline-shared-libraries#114\n\nMany thanks for submitting your Pull Request \u2764\ufe0f!\nPlease make sure that your PR meets the following requirements:\n\n You have read the contributors guide\n Pull Request title is properly formatted: KOGITO-XYZ Subject\n Pull Request title contains the target branch if not targeting master: [0.9.x] KOGITO-XYZ Subject\n Pull Request contains link to the JIRA issue\n Pull Request contains link to any dependent or related Pull Request\n Pull Request contains description of the issue\n Pull Request does not include fixes for issues other than the main ticket", "createdAt": "2020-11-03T07:46:11Z", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865", "merged": true, "mergeCommit": {"oid": "545dc5d120133bff8b5edbb85db1cc894db19425"}, "closed": true, "closedAt": "2020-12-07T07:59:32Z", "author": {"login": "radtriste"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZeelZAFqTUyNDA0NDc0OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdif2eSgH2gAyNTE0NTQ5MTY5OmQzYTIyODY5YmZiNmYwODhjZmEyMWJmM2RhYWFmM2E1MTRlODY1ZWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MDQ0NzQ5", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#pullrequestreview-524044749", "createdAt": "2020-11-05T08:55:53Z", "commit": {"oid": "2020d8585240de01fd3429f99cf34ce2bb3e626c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODo1NTo1M1rOHt5Q1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwODo1NTo1M1rOHt5Q1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzg4NjE2Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    cmd += \"--projects ${parentProjectName ?: directory}\"\n          \n          \n            \n                    cmd += \" --projects ${parentProjectName ?: directory}\"", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r517886166", "createdAt": "2020-11-05T08:55:53Z", "author": {"login": "radtriste"}, "path": "Jenkinsfile.deploy", "diffHunk": "@@ -270,9 +273,35 @@ void mavenCleanInstall(String directory, boolean skipTests = false, List profile\n     runMaven('clean install', directory, skipTests, profiles, extraArgs)\n }\n \n-void mavenDeploy(String directory) {\n-    extraArgs = params.MAVEN_DEPLOY_REPOSITORY != '' ? \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\" : ''\n-    runMaven('clean deploy', directory, true, [], extraArgs)\n+void mavenDeploy(String directory, String parentProjectName='') {\n+    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){\n+        extraArgs = ''\n+        if (params.MAVEN_DEPLOY_REPOSITORY){\n+            extraArgs += \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\"\n+        }\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+    } else {\n+        // First deploy locally\n+        extraArgs = \"-DaltDeploymentRepository=local::default::file://${env.MAVEN_DEPLOY_LOCAL_DIR}/${directory}\"\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+\n+        // Deploy to staging repository and close\n+        cmd = 'org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:deploy-staged-repository -DkeepStagingRepositoryOnCloseRuleFailure=true -DstagingProgressTimeoutMinutes=10'\n+        cmd += \"--projects ${parentProjectName ?: directory}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2020d8585240de01fd3429f99cf34ce2bb3e626c"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MDYzNTA1", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#pullrequestreview-524063505", "createdAt": "2020-11-05T09:18:26Z", "commit": {"oid": "2a6b4193614734bb85a37fff0c0d8a1f88e96673"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOToxODoyN1rOHt6JEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOToxODoyN1rOHt6JEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkwMDU2Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    cmd += \" --projects ${parentProjectName ?: directory}\"\n          \n          \n            \n                    cmd += \" --projects :${parentProjectName ?: directory}\"", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r517900562", "createdAt": "2020-11-05T09:18:27Z", "author": {"login": "radtriste"}, "path": "Jenkinsfile.deploy", "diffHunk": "@@ -270,9 +273,35 @@ void mavenCleanInstall(String directory, boolean skipTests = false, List profile\n     runMaven('clean install', directory, skipTests, profiles, extraArgs)\n }\n \n-void mavenDeploy(String directory) {\n-    extraArgs = params.MAVEN_DEPLOY_REPOSITORY != '' ? \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\" : ''\n-    runMaven('clean deploy', directory, true, [], extraArgs)\n+void mavenDeploy(String directory, String parentProjectName='') {\n+    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){\n+        extraArgs = ''\n+        if (params.MAVEN_DEPLOY_REPOSITORY){\n+            extraArgs += \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\"\n+        }\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+    } else {\n+        // First deploy locally\n+        extraArgs = \"-DaltDeploymentRepository=local::default::file://${env.MAVEN_DEPLOY_LOCAL_DIR}/${directory}\"\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+\n+        // Deploy to staging repository and close\n+        cmd = 'org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:deploy-staged-repository -DkeepStagingRepositoryOnCloseRuleFailure=true -DstagingProgressTimeoutMinutes=10'\n+        cmd += \" --projects ${parentProjectName ?: directory}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a6b4193614734bb85a37fff0c0d8a1f88e96673"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MDg5NTQ0", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#pullrequestreview-524089544", "createdAt": "2020-11-05T09:49:10Z", "commit": {"oid": "2cc6b409e9763445162ebbd15a6b36b7d0e12db5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOTo0OToxMFrOHt7Vfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOTo0OToxMFrOHt7Vfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkyMDEyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    cmd += \"--projects ${directory}\"\n          \n          \n            \n                    cmd += \" --projects :${parentProjectName ?: directory}\"", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r517920127", "createdAt": "2020-11-05T09:49:10Z", "author": {"login": "radtriste"}, "path": "Jenkinsfile.deploy", "diffHunk": "@@ -270,9 +273,35 @@ void mavenCleanInstall(String directory, boolean skipTests = false, List profile\n     runMaven('clean install', directory, skipTests, profiles, extraArgs)\n }\n \n-void mavenDeploy(String directory) {\n-    extraArgs = params.MAVEN_DEPLOY_REPOSITORY != '' ? \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\" : ''\n-    runMaven('clean deploy', directory, true, [], extraArgs)\n+void mavenDeploy(String directory, String parentProjectName='') {\n+    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){\n+        extraArgs = ''\n+        if (params.MAVEN_DEPLOY_REPOSITORY){\n+            extraArgs += \"-DaltDeploymentRepository=runtimes-artifacts::default::${params.MAVEN_DEPLOY_REPOSITORY} -Denforcer.skip=true\"\n+        }\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+    } else {\n+        // First deploy locally\n+        extraArgs = \"-DaltDeploymentRepository=local::default::file://${env.MAVEN_DEPLOY_LOCAL_DIR}/${directory}\"\n+        runMaven('clean deploy', directory, true, [], extraArgs)\n+\n+        // Deploy to staging repository and close\n+        cmd = 'org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:deploy-staged-repository -DkeepStagingRepositoryOnCloseRuleFailure=true -DstagingProgressTimeoutMinutes=10'\n+        cmd += \" --projects :${parentProjectName ?: directory}\"\n+        cmd += \" -DnexusUrl=${env.NEXUS_RELEASE_URL}\"\n+        cmd += \" -DserverId=${env.NEXUS_RELEASE_REPOSITORY_ID}\" \n+        cmd += \" -DrepositoryDirectory=${env.MAVEN_DEPLOY_LOCAL_DIR}/${directory}\"\n+        cmd += \" -DstagingProfileId=${env.NEXUS_STAGING_REPOSITORY_ID}\" \n+        cmd += \" -DstagingDescription=\\\"Kogito Runtimes ${getProjectVersion()}\\\"\"\n+        echo \"Run maven cmd $cmd\"\n+        runMaven(cmd, directory)\n+\n+        // Promote to build profile\n+        cmd = \"org.sonatype.plugins:nexus-staging-maven-plugin:1.6.5:promote -DbuildPromotionProfileId=${env.NEXUS_BUILD_PROMOTION_PROFILE_ID}\"\n+        cmd += \"--projects ${directory}\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cc6b409e9763445162ebbd15a6b36b7d0e12db5"}, "originalPosition": 71}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3c3e5b24b2c39546a8fbef72c322ac57c1eaa358", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/3c3e5b24b2c39546a8fbef72c322ac57c1eaa358", "committedDate": "2020-11-05T13:43:51Z", "message": "Merge branch 'kogito-3716' of github.com:radtriste/kogito-runtimes into kogito-3716"}, "afterCommit": {"oid": "b8544d2e1ca831bc211527bc4d1b269ddbcfd387", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/b8544d2e1ca831bc211527bc4d1b269ddbcfd387", "committedDate": "2020-11-05T13:47:33Z", "message": "KOGITO-3716 Allow automatic close of staging repo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b8544d2e1ca831bc211527bc4d1b269ddbcfd387", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/b8544d2e1ca831bc211527bc4d1b269ddbcfd387", "committedDate": "2020-11-05T13:47:33Z", "message": "KOGITO-3716 Allow automatic close of staging repo"}, "afterCommit": {"oid": "be9c7dec7e6942c030530b705b231b3c46f79f9b", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/be9c7dec7e6942c030530b705b231b3c46f79f9b", "committedDate": "2020-11-12T12:33:08Z", "message": "updated"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d70fbe2cfa9b4fc5cb49b75a1a6a91602c205885", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/d70fbe2cfa9b4fc5cb49b75a1a6a91602c205885", "committedDate": "2020-11-12T13:07:59Z", "message": "update"}, "afterCommit": {"oid": "686f2c71071895595eacbb7ac317b969580d4c9b", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/686f2c71071895595eacbb7ac317b969580d4c9b", "committedDate": "2020-11-12T13:08:38Z", "message": "KOGITO-3716 Allow automatic close of staging repo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aec04b8cbcf2ade270e4086731368a23da39b8dc", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/aec04b8cbcf2ade270e4086731368a23da39b8dc", "committedDate": "2020-11-12T16:08:25Z", "message": "correction"}, "afterCommit": {"oid": "7eec26cde1945e0136c8f7902803b098bca515d2", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/7eec26cde1945e0136c8f7902803b098bca515d2", "committedDate": "2020-11-12T16:26:05Z", "message": "KOGITO-3716 Allow automatic close of staging repo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dd9c0ce1b558fb99d287bfda4026cfee7d760e46", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/dd9c0ce1b558fb99d287bfda4026cfee7d760e46", "committedDate": "2020-11-12T16:39:51Z", "message": "test"}, "afterCommit": {"oid": "eada3f4266dc7087255a55635329a6e68dc42dd7", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/eada3f4266dc7087255a55635329a6e68dc42dd7", "committedDate": "2020-11-12T16:40:21Z", "message": "test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eada3f4266dc7087255a55635329a6e68dc42dd7", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/eada3f4266dc7087255a55635329a6e68dc42dd7", "committedDate": "2020-11-12T16:40:21Z", "message": "test"}, "afterCommit": {"oid": "a40747a7fc8d072e1ba7aeeca013c0f3db1f223d", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/a40747a7fc8d072e1ba7aeeca013c0f3db1f223d", "committedDate": "2020-11-12T16:39:38Z", "message": "update"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d3111cb9e71192549f8421832734b4d6d8c38a40", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/d3111cb9e71192549f8421832734b4d6d8c38a40", "committedDate": "2020-11-26T12:55:52Z", "message": "test"}, "afterCommit": {"oid": "3108bdecfb87112981bd9e161653deb966bd6202", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/3108bdecfb87112981bd9e161653deb966bd6202", "committedDate": "2020-11-26T13:18:26Z", "message": "KOGITO-3716 Allow automatic close of staging repo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f184ee79feea09e68b58eed53c155d26b2e421bd", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/f184ee79feea09e68b58eed53c155d26b2e421bd", "committedDate": "2020-11-30T08:17:51Z", "message": "test promote"}, "afterCommit": {"oid": "c7e813a6cda7a497fa086285ef85a03d7dfa93de", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/c7e813a6cda7a497fa086285ef85a03d7dfa93de", "committedDate": "2020-11-26T14:10:05Z", "message": "update"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c7e813a6cda7a497fa086285ef85a03d7dfa93de", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/c7e813a6cda7a497fa086285ef85a03d7dfa93de", "committedDate": "2020-11-26T14:10:05Z", "message": "update"}, "afterCommit": {"oid": "fd360e33d3b627b955490dce3af42ee36f984577", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/fd360e33d3b627b955490dce3af42ee36f984577", "committedDate": "2020-11-30T11:18:44Z", "message": "KOGITO-3716 Allow automatic close of staging repo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNjE5MTY5", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#pullrequestreview-542619169", "createdAt": "2020-12-02T09:00:03Z", "commit": {"oid": "d4a02d64368c427fa90db41a23c0e736defcbc8d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTowMDowM1rOH9QoSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTowMDowM1rOH9QoSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5NzY0Mg==", "bodyText": "what if you replace it by\ndef prBody = \"\"\"\nGenerated by build ${BUILD_TAG}: ${BUILD_URL}.\nPlease do not merge, it will be merged automatically after testing.\n\"\"\"", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r533997642", "createdAt": "2020-12-02T09:00:03Z", "author": {"login": "Ginxo"}, "path": "Jenkinsfile.deploy", "diffHunk": "@@ -203,30 +224,12 @@ void prepareForPR(String repo) {\n     }\n }\n \n-void addNotIgnoredPoms() {\n-    // based on https://stackoverflow.com/a/59888964/8811872\n-    sh '''\n-    find . -type f -name 'pom.xml' > found_poms.txt\n-    poms_to_add=\"\"\n-    while IFS= read -r pom; do\n-        if ! git check-ignore -q \"\\$pom\"; then\n-            poms_to_add=\"\\$poms_to_add \\$pom\"\n-        fi\n-    done < found_poms.txt\n-    rm found_poms.txt\n-    git add \\$poms_to_add\n-    git status\n-    '''\n-}\n-\n void commitAndCreatePR(String repo) {\n-    def commitMsg = \"Update project version to ${getProjectVersion()} for release\"\n-    def prBody = \"Generated by build ${BUILD_TAG}: ${BUILD_URL}.\\nPlease do not merge, it will be merged automatically after testing.\"\n-    // Not using githubscm.commitChanges() because globbing won't work.\n-    // See: https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449268738\n     dir(repo) {\n-        addNotIgnoredPoms()\n-        sh \"git commit -m '${commitMsg}'\"\n+        def commitMsg = \"Update project version to ${getProjectVersion()} for release\"\n+        def prBody = \"Generated by build ${BUILD_TAG}: ${BUILD_URL}.\\nPlease do not merge, it will be merged automatically after testing.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4a02d64368c427fa90db41a23c0e736defcbc8d"}, "originalPosition": 177}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNjQyMDM1", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#pullrequestreview-542642035", "createdAt": "2020-12-02T09:26:31Z", "commit": {"oid": "d4a02d64368c427fa90db41a23c0e736defcbc8d"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOToyNjozMVrOH9Rugg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozOTo0MVrOH9SSCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNTYxOA==", "bodyText": "Are these two IDs constant between releases or do we have to provide new ones per release?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534015618", "createdAt": "2020-12-02T09:26:31Z", "author": {"login": "rsynek"}, "path": "Jenkinsfile.deploy", "diffHunk": "@@ -24,13 +32,20 @@ pipeline {\n \n         // Build&test information\n         booleanParam(name: 'SKIP_TESTS', defaultValue: false, description: 'Skip tests')\n+        string(name: 'MAVEN_SETTINGS_CONFIG_FILE_ID', defaultValue: 'kogito_release_settings', description: 'Maven settings configfile to use in pipeline for Maven commands')\n \n         // Deploy information\n         string(name: 'MAVEN_DEPLOY_REPOSITORY', defaultValue: '', description: 'Specify a Maven repository to deploy the artifacts.')\n \n         // Release information\n         booleanParam(name: 'RELEASE', defaultValue: false, description: 'Is this build for a release?')\n         string(name: 'PROJECT_VERSION', defaultValue: '', description: 'Optional if not RELEASE. If RELEASE, cannot be empty.')\n+        \n+        // Nexus staging default parameters\n+        string(name: 'NEXUS_RELEASE_URL', defaultValue: 'https://repository.jboss.org/nexus', description: 'Nexus URL for release staging')\n+        string(name: 'NEXUS_RELEASE_REPOSITORY_ID', defaultValue: 'jboss-releases-repository', description: 'Nexus Release repository ID for staging')\n+        string(name: 'NEXUS_STAGING_PROFILE_ID', defaultValue: '2161b7b8da0080', description: 'Nexus staging profile ID for release process ')\n+        string(name: 'NEXUS_BUILD_PROMOTION_PROFILE_ID', defaultValue: 'ea49ccd6f174', description: 'Nexus Build Promotion profile ID for release process')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4a02d64368c427fa90db41a23c0e736defcbc8d"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNzE5Nw==", "bodyText": "Formatting:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){\n          \n          \n            \n                                if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY) {", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534017197", "createdAt": "2020-12-02T09:28:48Z", "author": {"login": "rsynek"}, "path": "Jenkinsfile.deploy", "diffHunk": "@@ -142,8 +152,19 @@ pipeline {\n         }\n         stage('Deploy artifacts') {\n             steps {\n-                mavenDeploy('kogito-runtimes')\n-                mavenDeploy('kogito-apps')\n+                script {\n+                    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4a02d64368c427fa90db41a23c0e736defcbc8d"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxOTIwNQ==", "bodyText": "If the params.MAVEN_DEPLOY_REPOSITORY is used only for testing, a comment would be nice.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534019205", "createdAt": "2020-12-02T09:31:37Z", "author": {"login": "rsynek"}, "path": "Jenkinsfile.deploy", "diffHunk": "@@ -142,8 +152,19 @@ pipeline {\n         }\n         stage('Deploy artifacts') {\n             steps {\n-                mavenDeploy('kogito-runtimes')\n-                mavenDeploy('kogito-apps')\n+                script {\n+                    if(!isRelease() || params.MAVEN_DEPLOY_REPOSITORY){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4a02d64368c427fa90db41a23c0e736defcbc8d"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNDcxMw==", "bodyText": "Nice to see this replacing the addNotIgnoredPoms().", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534024713", "createdAt": "2020-12-02T09:39:41Z", "author": {"login": "rsynek"}, "path": "Jenkinsfile.promote", "diffHunk": "@@ -284,28 +279,11 @@ void prepareForPR(String repo) {\n     githubscm.createBranch(getSnapshotBranch())\n }\n \n-void addNotIgnoredPoms() {\n-    // based on https://stackoverflow.com/a/59888964/8811872\n-    sh '''\n-    find . -type f -name 'pom.xml' > found_poms.txt\n-    poms_to_add=\"\"\n-    while IFS= read -r pom; do\n-        if ! git check-ignore -q \"\\$pom\"; then\n-            poms_to_add=\"\\$poms_to_add \\$pom\"\n-        fi\n-    done < found_poms.txt\n-    rm found_poms.txt\n-    git add \\$poms_to_add\n-    '''\n-}\n-\n void commitAndCreatePR(String repo) {\n     def commitMsg = \"Update snapshot version to ${getSnapshotVersion()}\"\n     def prBody = \"Generated by build ${BUILD_TAG}: ${BUILD_URL}.\\nPlease do not merge, it will be merged automatically after testing.\"\n-    // Not using githubscm.commitChanges() because globbing won't work.\n-    // See: https://github.com/kiegroup/kogito-runtimes/pull/570#discussion_r449268738\n-    addNotIgnoredPoms()\n-    sh \"git commit -m '${commitMsg}'\"\n+    \n+    githubscm.commitChanges(commitMsg, { githubscm.findAndStageNotIgnoredFiles('pom.xml') })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d4a02d64368c427fa90db41a23c0e736defcbc8d"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyODc3MzA3", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#pullrequestreview-542877307", "createdAt": "2020-12-02T14:17:15Z", "commit": {"oid": "a082b4e77ac6022ce20d3076ae72946811099bc4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyOTY4ODYw", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#pullrequestreview-542968860", "createdAt": "2020-12-02T15:43:31Z", "commit": {"oid": "a082b4e77ac6022ce20d3076ae72946811099bc4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed5129eca0e0178abaaff14e71818e0e871709db", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/ed5129eca0e0178abaaff14e71818e0e871709db", "committedDate": "2020-12-02T16:00:06Z", "message": "KOGITO-3716 Allow automatic close of staging repo"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a082b4e77ac6022ce20d3076ae72946811099bc4", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/a082b4e77ac6022ce20d3076ae72946811099bc4", "committedDate": "2020-12-02T13:18:14Z", "message": "updated GHAction"}, "afterCommit": {"oid": "ed5129eca0e0178abaaff14e71818e0e871709db", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/ed5129eca0e0178abaaff14e71818e0e871709db", "committedDate": "2020-12-02T16:00:06Z", "message": "KOGITO-3716 Allow automatic close of staging repo"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNzM5NTQw", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#pullrequestreview-543739540", "createdAt": "2020-12-03T09:08:02Z", "commit": {"oid": "ed5129eca0e0178abaaff14e71818e0e871709db"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTowODowMlrOH-Mi5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwOTowODowMlrOH-Mi5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDk3OTMwMg==", "bodyText": "Was this formatting change intentional?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/865#discussion_r534979302", "createdAt": "2020-12-03T09:08:02Z", "author": {"login": "rsynek"}, "path": ".jenkins/tests/src/test/vars/JenkinsfilePromote.groovy", "diffHunk": "@@ -4,8 +4,8 @@ class JenkinsfilePromote extends JenkinsPipelineSpecification {\n \tdef Jenkinsfile = null\n \n     def setup() {\n-        Jenkinsfile = loadPipelineScriptForTest('Jenkinsfile.promote')\n-        Jenkinsfile.getBinding().setVariable('PROPERTIES_FILE_NAME', 'deployment.properties')\n+\t\t\tJenkinsfile = loadPipelineScriptForTest('Jenkinsfile.promote')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed5129eca0e0178abaaff14e71818e0e871709db"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3a22869bfb6f088cfa21bf3daaaf3a514e865eb", "author": {"user": {"login": "radtriste", "name": "Tristan Radisson"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/d3a22869bfb6f088cfa21bf3daaaf3a514e865eb", "committedDate": "2020-12-03T09:37:13Z", "message": "updated tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3825, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}