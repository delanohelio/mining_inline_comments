{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MjI5NjEy", "number": 629, "title": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance f\u2026", "bodyText": "\u2026rom persistence\nMany thanks for submitting your Pull Request \u2764\ufe0f!\nPlease make sure that your PR meets the following requirements:\n\n You have read the contributors guide\n Pull Request title is properly formatted: KOGITO-XYZ Subject\n Pull Request title contains the target branch if not targeting master: [0.9.x] KOGITO-XYZ Subject\n Pull Request contains link to the JIRA issue\n Pull Request contains link to any dependent or related Pull Request\n Pull Request contains description of the issue\n Pull Request does not include fixes for issues other than the main ticket", "createdAt": "2020-07-13T12:40:19Z", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629", "merged": true, "mergeCommit": {"oid": "ccf3943d54e707696b1018988ee1da6ddc878b37"}, "closed": true, "closedAt": "2020-07-20T05:32:01Z", "author": {"login": "cristianonicolai"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0hhlvABqjM1Mzk1NTQ2ODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1ynj8AFqTQ1MDU5OTE5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f0b9efc6b877d8517c449fee73b75e247b739f0d", "author": {"user": {"login": "cristianonicolai", "name": "Cristiano Nicolai"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/f0b9efc6b877d8517c449fee73b75e247b739f0d", "committedDate": "2020-07-13T12:06:54Z", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence"}, "afterCommit": {"oid": "1096b6d97e7e7f22c289e9aa395325c6b91e9f23", "author": {"user": {"login": "cristianonicolai", "name": "Cristiano Nicolai"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/1096b6d97e7e7f22c289e9aa395325c6b91e9f23", "committedDate": "2020-07-13T13:33:31Z", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODY4OTg5", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#pullrequestreview-447868989", "createdAt": "2020-07-14T07:48:39Z", "commit": {"oid": "1096b6d97e7e7f22c289e9aa395325c6b91e9f23"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1096b6d97e7e7f22c289e9aa395325c6b91e9f23", "author": {"user": {"login": "cristianonicolai", "name": "Cristiano Nicolai"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/1096b6d97e7e7f22c289e9aa395325c6b91e9f23", "committedDate": "2020-07-13T13:33:31Z", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence"}, "afterCommit": {"oid": "086473779c28d59af7cb3d5cee9a8d68fd07465a", "author": {"user": {"login": "cristianonicolai", "name": "Cristiano Nicolai"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/086473779c28d59af7cb3d5cee9a8d68fd07465a", "committedDate": "2020-07-15T08:45:26Z", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "086473779c28d59af7cb3d5cee9a8d68fd07465a", "author": {"user": {"login": "cristianonicolai", "name": "Cristiano Nicolai"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/086473779c28d59af7cb3d5cee9a8d68fd07465a", "committedDate": "2020-07-15T08:45:26Z", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence"}, "afterCommit": {"oid": "c14f24f95114d7e3399145019f523cf1d77e050d", "author": {"user": {"login": "cristianonicolai", "name": "Cristiano Nicolai"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/c14f24f95114d7e3399145019f523cf1d77e050d", "committedDate": "2020-07-15T11:09:27Z", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MTI3NjIz", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#pullrequestreview-449127623", "createdAt": "2020-07-15T16:40:25Z", "commit": {"oid": "c14f24f95114d7e3399145019f523cf1d77e050d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNjo0MDoyNVrOGyGSfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNjo0NDoyNFrOGyGb3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NTAyMQ==", "bodyText": "why this changed?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#discussion_r455185021", "createdAt": "2020-07-15T16:40:25Z", "author": {"login": "mswiderski"}, "path": "addons/persistence/filesystem-persistence-addon/src/test/java/org/kie/persistence/filesystem/FileSystemProcessInstancesTest.java", "diffHunk": "@@ -84,13 +83,12 @@ public void testBasicFlow() {\n         assertThat(processInstance.status()).isEqualTo(STATE_COMPLETED);\n \n         fileSystemBasedStorage = (FileSystemProcessInstances) process.instances();\n-        verify(fileSystemBasedStorage, times(2)).remove(any());\n+        verify(fileSystemBasedStorage, times(3)).remove(any());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14f24f95114d7e3399145019f523cf1d77e050d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NjA3MQ==", "bodyText": "maybe make it protected so it can be adjusted by subclasses if needed", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#discussion_r455186071", "createdAt": "2020-07-15T16:42:11Z", "author": {"login": "mswiderski"}, "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java", "diffHunk": "@@ -93,25 +93,24 @@ public AbstractProcessInstance(AbstractProcess<T> process, T variables, String b\n \n         Map<String, Object> map = bind(variables);\n         String processId = process.process().getId();\n-        this.processInstance = (WorkflowProcessInstance)((CorrelationAwareProcessRuntime) rt).createProcessInstance(processId, correlationKey, map);\n-        this.description = processInstance.getDescription();\n-        this.status = ProcessInstance.STATE_PENDING;\n+        reloadProcessInstance((WorkflowProcessInstance) ((CorrelationAwareProcessRuntime) rt).createProcessInstance(processId, correlationKey, map));\n     }\n \n-    // for marshaller/persistence only\n-    public void internalSetProcessInstance(WorkflowProcessInstance processInstance) {\n-        if (this.processInstance != null && this.status != ProcessInstance.STATE_PENDING) {\n-            throw new IllegalStateException(\"Impossible to override process instance that already exists\");\n+    public AbstractProcessInstance(AbstractProcess<T> process, T variables, ProcessRuntime rt, org.kie.api.runtime.process.WorkflowProcessInstance wpi) {\n+        this.process = process;\n+        this.rt = rt;\n+        this.variables = variables;\n+        reloadProcessInstance((WorkflowProcessInstance) wpi);\n+        reconnect();\n+    }\n+\n+    private void reconnect() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14f24f95114d7e3399145019f523cf1d77e050d"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTE4NzQyMg==", "bodyText": "bit misleading method name ... maybe syncProcessInstanceState or similar so it indicates that the is no actual reloading of process instance here :)", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#discussion_r455187422", "createdAt": "2020-07-15T16:44:24Z", "author": {"login": "mswiderski"}, "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java", "diffHunk": "@@ -122,6 +121,37 @@ public void internalSetProcessInstance(WorkflowProcessInstance processInstance)\n         unbind(variables, processInstance.getVariables());\n     }\n \n+    private void addCompletionEventListener() {\n+        if (completionEventListener == null) {\n+            completionEventListener = new CompletionEventListener();\n+            processInstance.addEventListener(\"processInstanceCompleted:\" + id, completionEventListener, false);\n+        }\n+    }\n+\n+    private void removeCompletionListener() {\n+        if (completionEventListener != null) {\n+            processInstance.removeEventListener(\"processInstanceCompleted:\" + id, completionEventListener, false);\n+            completionEventListener = null;\n+        }\n+    }\n+\n+    private void disconnect() {\n+        if (processInstance == null) {\n+            return;\n+        }\n+\n+        processInstance.disconnect();\n+        processInstance.setMetaData(\"KogitoProcessInstance\", null);\n+    }\n+\n+    private void reloadProcessInstance(WorkflowProcessInstance wpi) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c14f24f95114d7e3399145019f523cf1d77e050d"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bae343ddf462510b038dd3dc26b1a2d0afa879b", "author": {"user": {"login": "cristianonicolai", "name": "Cristiano Nicolai"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/0bae343ddf462510b038dd3dc26b1a2d0afa879b", "committedDate": "2020-07-16T16:28:35Z", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c14f24f95114d7e3399145019f523cf1d77e050d", "author": {"user": {"login": "cristianonicolai", "name": "Cristiano Nicolai"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/c14f24f95114d7e3399145019f523cf1d77e050d", "committedDate": "2020-07-15T11:09:27Z", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence"}, "afterCommit": {"oid": "0bae343ddf462510b038dd3dc26b1a2d0afa879b", "author": {"user": {"login": "cristianonicolai", "name": "Cristiano Nicolai"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/0bae343ddf462510b038dd3dc26b1a2d0afa879b", "committedDate": "2020-07-16T16:28:35Z", "message": "KOGITO-2207 Avoid creating WorkflowProcessInstance to load instance from persistence"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNTgwNTAy", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#pullrequestreview-450580502", "createdAt": "2020-07-17T11:27:32Z", "commit": {"oid": "0bae343ddf462510b038dd3dc26b1a2d0afa879b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNTk5MTk3", "url": "https://github.com/kiegroup/kogito-runtimes/pull/629#pullrequestreview-450599197", "createdAt": "2020-07-17T12:02:32Z", "commit": {"oid": "0bae343ddf462510b038dd3dc26b1a2d0afa879b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4238, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}