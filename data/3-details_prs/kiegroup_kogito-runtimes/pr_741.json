{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NDkwNjQ3", "number": 741, "title": "KOGITO-3110 Refactor ofCollectedResources methods in *Codegen", "bodyText": "https://issues.redhat.com/browse/KOGITO-3110\nThe method ofCollectedResources is almost exactly the same in DecisionCodegen, PredictionCodegen, ProcessCodegen and IncrementalRuleCodegen.\nRemove all other variations of the ofPath, ofFiles etc. and use ofCollectedResources everywhere (where applicable)", "createdAt": "2020-09-03T09:24:46Z", "url": "https://github.com/kiegroup/kogito-runtimes/pull/741", "merged": true, "mergeCommit": {"oid": "7e0fabdd592befd52d1ebf781b2273ddc616fe80"}, "closed": true, "closedAt": "2020-09-09T07:24:09Z", "author": {"login": "evacchi"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFOBtuAH2gAyNDc4NDkwNjQ3Ojc2NDdlNDU1ZDliOGQ5M2FiOWRjMjBhZmU3ZjQwMzUzNTk1YWUxZDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdG5_3uAFqTQ4NDI5NzM3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7647e455d9b8d93ab9dc20afe7f40353595ae1d0", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/7647e455d9b8d93ab9dc20afe7f40353595ae1d0", "committedDate": "2020-09-03T10:27:24Z", "message": "use CollectedResources.fromPath() and deprecate ${X}Generator.fromPath everywhere"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47148aeb4a4533b408eb2b9cffa7c1fa09fae5a6", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/47148aeb4a4533b408eb2b9cffa7c1fa09fae5a6", "committedDate": "2020-09-03T10:27:48Z", "message": "wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d3be6aa48b86177b649ec274c189476ee191857", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/1d3be6aa48b86177b649ec274c189476ee191857", "committedDate": "2020-09-03T10:28:43Z", "message": "deprecate ofFiles and all oFPaths usages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34f9820e68d3e4545248a7b1ad4749a66096e243", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/34f9820e68d3e4545248a7b1ad4749a66096e243", "committedDate": "2020-09-03T10:29:03Z", "message": "fix path handling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38d66fd056e0900c2ba8f5bf07a5054cc682a8bc", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/38d66fd056e0900c2ba8f5bf07a5054cc682a8bc", "committedDate": "2020-09-03T09:19:54Z", "message": "fix path handling"}, "afterCommit": {"oid": "34f9820e68d3e4545248a7b1ad4749a66096e243", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/34f9820e68d3e4545248a7b1ad4749a66096e243", "committedDate": "2020-09-03T10:29:03Z", "message": "fix path handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9a6a2c3aee2fab68888a5a072b2b23371b4fe6f", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/b9a6a2c3aee2fab68888a5a072b2b23371b4fe6f", "committedDate": "2020-09-04T06:54:48Z", "message": "fix path handling (lost during rebase)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2b7887a3b06fed81f93ee16e00e502324d4665a", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/d2b7887a3b06fed81f93ee16e00e502324d4665a", "committedDate": "2020-09-04T12:21:34Z", "message": "clean unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b14f7220d12b7b063185541267386d3ac7913b43", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/b14f7220d12b7b063185541267386d3ac7913b43", "committedDate": "2020-09-04T12:54:21Z", "message": "relativize paths + follow symlinks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fd571329c5b8bd09d506c2824b1f6ee0e55ed75", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/8fd571329c5b8bd09d506c2824b1f6ee0e55ed75", "committedDate": "2020-09-08T07:46:08Z", "message": "remove deprecated APIs from IncrementalRuleCodegen"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b784b0803a476ca29ae58f0531172e85b7336f9", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/6b784b0803a476ca29ae58f0531172e85b7336f9", "committedDate": "2020-09-08T07:46:31Z", "message": "optimize imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzOTExNTgy", "url": "https://github.com/kiegroup/kogito-runtimes/pull/741#pullrequestreview-483911582", "createdAt": "2020-09-08T08:31:40Z", "commit": {"oid": "6b784b0803a476ca29ae58f0531172e85b7336f9"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwODozMTo0MVrOHOSe4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwODozMjozMVrOHOShQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc0NDkyOA==", "bodyText": "not sure where this method is used, but I would consider if meaningful for this method to check basePath is in fact a valid parent of each files?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/741#discussion_r484744928", "createdAt": "2020-09-08T08:31:41Z", "author": {"login": "tarilabs"}, "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/io/CollectedResource.java", "diffHunk": "@@ -102,6 +107,22 @@\n         return resources;\n     }\n \n+    /**\n+     * Returns a collection of CollectedResource from the given files\n+     */\n+    public static Collection<CollectedResource> fromFiles(Path basePath, File... files) {\n+        Collection<CollectedResource> resources = new ArrayList<>();\n+        try (Stream<File> paths = Arrays.stream(files)) {\n+            paths.filter(File::isFile)\n+                    .map(f -> new FileSystemResource(f)\n+                            .setResourceType(determineResourceType(f.getName())))\n+                    .map(f -> new CollectedResource(basePath, f))\n+                    .forEach(resources::add);\n+        }\n+        return resources;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b784b0803a476ca29ae58f0531172e85b7336f9"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDc0NTUzNg==", "bodyText": "difficult to understand why this change is required, but if all the tests are passing I guess it's super fine for me", "url": "https://github.com/kiegroup/kogito-runtimes/pull/741#discussion_r484745536", "createdAt": "2020-09-08T08:32:31Z", "author": {"login": "tarilabs"}, "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/decision/DecisionContainerGenerator.java", "diffHunk": "@@ -91,8 +93,13 @@ private String getDecisionModelJarResourcePath(CollectedResource resource) {\n \n     private String getDecisionModelRelativeResourcePath(CollectedResource resource) {\n         String source = getDecisionModelJarResourcePath(resource);\n-        Path relativizedPath = resource.basePath().relativize(Paths.get(source));\n-        return \"/\" + relativizedPath.toString().replace(File.separatorChar, '/');\n+        try {\n+            Path sourcePath = Paths.get(source).toAbsolutePath().toRealPath();\n+            Path relativizedPath = resource.basePath().toAbsolutePath().toRealPath().relativize(sourcePath);\n+            return \"/\" + relativizedPath.toString().replace(File.separatorChar, '/');\n+        } catch (IOException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b784b0803a476ca29ae58f0531172e85b7336f9"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2eb4ad1d0962b7644e51d52ed5f3f53139bb41e8", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/2eb4ad1d0962b7644e51d52ed5f3f53139bb41e8", "committedDate": "2020-09-08T08:42:35Z", "message": "add invariant check on CollectedResource constructor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9785a16f887c134d8632d027a9670e569eb0179c", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/9785a16f887c134d8632d027a9670e569eb0179c", "committedDate": "2020-09-08T10:09:09Z", "message": "disable invariant check for jars"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15cb85eb920a34146f608dbce761952eccdc4696", "author": {"user": {"login": "evacchi", "name": "Edoardo Vacchi"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/15cb85eb920a34146f608dbce761952eccdc4696", "committedDate": "2020-09-08T11:44:42Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MjI4NDY3", "url": "https://github.com/kiegroup/kogito-runtimes/pull/741#pullrequestreview-484228467", "createdAt": "2020-09-08T14:57:33Z", "commit": {"oid": "15cb85eb920a34146f608dbce761952eccdc4696"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNDo1NzozM1rOHOhTcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNDo1Nzo0M1rOHOhUUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk4Nzc2Mw==", "bodyText": "\ud83d\udc4d \ud83d\udc4d \ud83d\udc4d", "url": "https://github.com/kiegroup/kogito-runtimes/pull/741#discussion_r484987763", "createdAt": "2020-09-08T14:57:33Z", "author": {"login": "gitgabrio"}, "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/prediction/PredictionCodegen.java", "diffHunk": "@@ -96,55 +83,10 @@ public static PredictionCodegen ofCollectedResources(Collection<CollectedResourc\n         return ofPredictions(dmnResources);\n     }\n \n-    public static PredictionCodegen ofJar(Path... jarPaths) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15cb85eb920a34146f608dbce761952eccdc4696"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk4Nzk4Ng==", "bodyText": "\ud83d\udc4d \ud83d\udc4d \ud83d\udc4d", "url": "https://github.com/kiegroup/kogito-runtimes/pull/741#discussion_r484987986", "createdAt": "2020-09-08T14:57:43Z", "author": {"login": "gitgabrio"}, "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/prediction/PredictionCodegen.java", "diffHunk": "@@ -96,55 +83,10 @@ public static PredictionCodegen ofCollectedResources(Collection<CollectedResourc\n         return ofPredictions(dmnResources);\n     }\n \n-    public static PredictionCodegen ofJar(Path... jarPaths) throws IOException {\n-        List<PMMLResource> pmmlResources = new ArrayList<>();\n-        for (Path jarPath : jarPaths) {\n-            List<Resource> resources = new ArrayList<>();\n-            try (ZipFile zipFile = new ZipFile(jarPath.toFile())) {\n-                Enumeration<? extends ZipEntry> entries = zipFile.entries();\n-                while (entries.hasMoreElements()) {\n-                    ZipEntry entry = entries.nextElement();\n-                    ResourceType resourceType = determineResourceType(entry.getName());\n-                    if (resourceType == ResourceType.PMML) {\n-                        InternalResource resource =\n-                                new ByteArrayResource(readBytesFromInputStream(zipFile.getInputStream(entry)));\n-                        resource.setResourceType(resourceType);\n-                        resource.setSourcePath(entry.getName());\n-                        resources.add(resource);\n-                    }\n-                }\n-            }\n-            pmmlResources.addAll(parsePredictions(jarPath, resources));\n-        }\n-        return ofPredictions(pmmlResources);\n-    }\n-\n-    public static PredictionCodegen ofPath(Path... paths) throws IOException {\n-        List<PMMLResource> resources = new ArrayList<>();\n-        for (Path path : paths) {\n-            Path srcPath = Paths.get(path.toString());\n-            try (Stream<Path> filesStream = Files.walk(srcPath)) {\n-                List<File> files = filesStream.filter(p -> p.toString().endsWith(\".pmml\"))\n-                        .map(Path::toFile)\n-                        .collect(Collectors.toList());\n-                resources.addAll(parseFiles(srcPath, files));\n-            }\n-        }\n-        return ofPredictions(resources);\n-    }\n-\n-    public static PredictionCodegen ofFiles(Path basePath, List<File> files) {\n-        return ofPredictions(parseFiles(basePath, files));\n-    }\n-\n     private static PredictionCodegen ofPredictions(List<PMMLResource> resources) {\n         return new PredictionCodegen(resources);\n     }\n \n-    private static List<PMMLResource> parseFiles(Path path, List<File> files) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15cb85eb920a34146f608dbce761952eccdc4696"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0Mjk3Mzc3", "url": "https://github.com/kiegroup/kogito-runtimes/pull/741#pullrequestreview-484297377", "createdAt": "2020-09-08T16:15:08Z", "commit": {"oid": "15cb85eb920a34146f608dbce761952eccdc4696"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4161, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}